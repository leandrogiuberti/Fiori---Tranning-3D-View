<!DOCTYPE HTML>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
    <title>RichTextEditorTinyMCE6 - tiny_comments plugin</title>

    <script src="../../../../resources/sap-ui-core.js" type="text/javascript" charset="UTF-8" id="sap-ui-bootstrap"
        data-sap-ui-libs="sap.ui.richtexteditor, sap.m" data-sap-ui-theme="sap_fiori_3" data-sap-ui-preload="async">
        </script>

    <script>
        sap.ui.getCore().attachInit(function () {
            sap.ui.require([
                "sap/ui/richtexteditor/RichTextEditor",
                "sap/ui/richtexteditor/RTESplitButton",
                "sap/m/App",
                "sap/m/Page",
                "sap/m/Button",
                "sap/ui/core/InvisibleText"
            ], function (RTE, RTESplitButton, App, Page, Button, InvisibleText) {

                var oApp = new App("myApp", {
                    initialPage: "myPage"
                });

                let nextConversationId = 1;
                let nextCommentId = 1;

                const mockConversations = {};

                const mockUsers = [
                    { id: "user1", displayName: "Alice", avatarUrl: "https://example.com/avatar1.png" },
                    { id: "user2", displayName: "Bob", avatarUrl: "https://example.com/avatar2.png" },
                ];

                const generateUniqueId = (prefix) => `${prefix}-${nextCommentId++}`;

                const getMockUser = (userId) => mockUsers.find((u) => u.id === userId);

                const tinycomments_create = (req, done, fail) => {
                    const { content, createdAt } = req;

                    try {
                        const newConversationUid = String(nextConversationId++);

                        mockConversations[newConversationUid] = {
                            uid: newConversationUid,
                            comments: [
                                {
                                    uid: generateUniqueId("comment"),
                                    content,
                                    author: "mockAuthor",
                                    createdAt,
                                    modifiedAt: createdAt,
                                },
                            ],
                        };

                        done({
                            conversationUid: newConversationUid,
                            onError: (err) => console.error(`Error creating conversation: ${err}`),
                            onSuccess: (uid) => console.log(`Conversation created successfully with UID: ${uid}`),
                        });
                    } catch (error) {
                        fail(error);
                    }
                };

                const tinycomments_reply = (req, done, fail) => {
                    const { conversationUid, content, createdAt } = req;

                    try {
                        const conversation = mockConversations[conversationUid];
                        if (!conversation) {
                            throw new Error(`Conversation with UID ${conversationUid} not found`);
                        }

                        const newComment = {
                            uid: generateUniqueId("comment"),
                            author: "currentUser",
                            createdAt,
                            modifiedAt: createdAt,
                            content,
                        };

                        conversation.comments.push(newComment);

                        done({ commentUid: newComment.uid });
                    } catch (error) {
                        console.error(`Failed to add reply to conversation ${conversationUid}`, error);
                        fail(error);
                    }
                };

                const tinycomments_edit_comment = (req, done, fail) => {
                    const { conversationUid, commentUid, content, modifiedAt } = req;

                    try {
                        const conversation = mockConversations[conversationUid];
                        if (!conversation) throw new Error("Conversation not found");

                        const comment = conversation.comments.find(c => c.uid === commentUid);
                        if (!comment) throw new Error("Comment not found");

                        comment.content = content;
                        comment.modifiedAt = modifiedAt;

                        done({ canEdit: true });
                    } catch (error) {
                        console.error("Edit error:", error);
                        fail(error);
                    }
                };

                const tinycomments_delete = (req, done, fail) => {
                    const { conversationUid } = req;

                    try {
                        if (!mockConversations[conversationUid]) throw new Error("Conversation not found");

                        delete mockConversations[conversationUid];

                        done({ canDelete: true });
                    } catch (error) {
                        console.error("Delete conversation error:", error);
                        fail(error);
                    }
                };

                const tinycomments_delete_comment = (req, done, fail) => {
                    const { conversationUid, commentUid } = req;

                    try {
                        const conversation = mockConversations[conversationUid];
                        if (!conversation) throw new Error("Conversation not found");

                        const index = conversation.comments.findIndex(c => c.uid === commentUid);
                        if (index === -1) throw new Error("Comment not found");

                        conversation.comments.splice(index, 1);

                        done({ canDelete: true });
                    } catch (error) {
                        console.error("Delete comment error:", error);
                        fail(error);
                    }
                };

                const tinycomments_delete_all = (_req, done, fail) => {
                    try {
                        Object.keys(mockConversations).forEach(key => delete mockConversations[key]);

                        done({ canDelete: true });
                    } catch (error) {
                        console.error("Delete all conversations error:", error);
                        fail(error);
                    }
                };

                const tinycomments_lookup = ({ conversationUid }, done, fail) => {
                    const lookup = async () => {
                        const conversation = mockConversations[conversationUid];
                        if (!conversation) {
                            throw new Error(`Conversation with UID ${conversationUid} not found`);
                        }

                        const comments = conversation.comments.map((comment) => {
                            const user = mockUsers.find((u) => u.id === comment.author);
                            return {
                                ...comment,
                                authorName: user?.displayName || comment.author,
                                authorAvatar: user?.avatarUrl || null,
                            };
                        });

                        return {
                            conversation: {
                                uid: conversationUid,
                                comments,
                            },
                        };
                    };

                    lookup()
                        .then((data) => {
                            done(data);
                        })
                        .catch((err) => {
                            console.error(`Lookup failure ${conversationUid}`, err);
                            fail(err);
                        });
                };

                const tinycomments_fetch = (conversationUids, done, fail) => {
                    const requests = conversationUids.map((uid) => {
                        const conversation = mockConversations[uid];
                        if (!conversation) {
                            return Promise.reject(new Error(`Conversation with UID ${uid} not found`));
                        }
                        return Promise.resolve({
                            [uid]: {
                                uid,
                                comments: conversation.comments,
                            },
                        });
                    });

                    Promise.all(requests)
                        .then((data) => {
                            const conversations = data.reduce((conv, d) => ({
                                ...conv,
                                ...d,
                            }), {});
                            done({ conversations });
                        })
                        .catch((err) => {
                            console.error(`Fetch failure ${conversationUids}`, err);
                            fail('Fetching conversations failed');
                        });
                };

                var oRichTextEditor = new RTE("myRTE", {
                    width: "100%",
                    height: "300px",
                    plugins: [{
                        name: "tinycomments"
                    }],
                    showGroupFont: true,
                    showGroupUndo: true,
                    showGroupLink: true,
                    showGroupInsert: true,
                    customToolbar: true,
                    beforeEditorInit: function (oEvent) {
                        var oConfig = oEvent.getParameter('configuration');

                        Object.assign(oConfig, {
                            sidebar_show: 'showcomments',
                            tinycomments_create,
                            tinycomments_reply,
                            tinycomments_edit_comment,
                            tinycomments_delete,
                            tinycomments_delete_all,
                            tinycomments_delete_comment,
                            tinycomments_lookup,
                            tinycomments_fetch,
                        });
                    }
                });

                var oInvisibleText = new InvisibleText({
                    id: "textForRTE",
                    text: "RichTextEditor with a custom toolbar",
                });
                oRichTextEditor.addAriaLabelledBy(oInvisibleText);

                setTimeout(function () {
                    oRichTextEditor.addButtonGroup("styles");
                    oRichTextEditor.addButtonGroup("table");
                }, 1000);

                var oPage = new Page("myPage", {
                    title: "RichTextEditorTinyMCE6 with tiny_comments plugin",
                    contentOnlyBusy: true,
                    content: [
                        oInvisibleText,
                        oRichTextEditor
                    ]
                });

                oApp.addPage(oPage).placeAt("content");
            });
        });
    </script>

</head>

<body class="sapUiBody">
    <div id="content"></div>
</body>

</html>