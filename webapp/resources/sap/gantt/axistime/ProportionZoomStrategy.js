/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/gantt/library","sap/gantt/axistime/AxisTimeStrategyBase","sap/gantt/misc/Utility","sap/gantt/misc/Format","sap/gantt/config/TimeHorizon","sap/gantt/simple/GanttUtils","sap/gantt/axistime/ProportionTimeLineOptions"],function(t,e,o,i,a,s,n,r){"use strict";var m=o.extend("sap.gantt.axistime.ProportionZoomStrategy",{metadata:{library:"sap.gantt",properties:{enableMillisecondSupport:{type:"boolean",defaultValue:false,bindable:false}}}});m.prototype.init=function(){this._aZoomRate=new Array(10);this.setProperty("coarsestTimeLineOption",r["1month"],true);this.setProperty("finestTimeLineOption",r["5min"],true);this.setProperty("timeLineOptions",r,true);this.setProperty("timeLineOption",r["4day"],true);this.setProperty("zoomLevel",0,true);this.setProperty("zoomLevels",10,true);this._disableAutoProportion=false};m.prototype.applySettings=function(t){this._applyMissingSettings(t);o.prototype.applySettings.call(this,t);this.initialSettings=t;return this};m.prototype.setVisibleHorizon=function(t){this.setVisibleHorizonWithReason(t,"visibleHorizonUpdated");return this};m.prototype.setEnableMillisecondSupport=function(t){this.setProperty("enableMillisecondSupport",t);a._setEnableMillisecondSupport(t);return this};m.prototype._applyMissingSettings=function(){if(this.getEnableMillisecondSupport()){a._setEnableMillisecondSupport(true)}};m.prototype.setVisibleHorizonWithReason=function(t,e,i,a){if(t&&!t.getStartTime()&&!t.getEndTime()){this._bHorizontalScroll=false}else{this._bHorizontalScroll=!!(t&&(!t.getStartTime()||!t.getEndTime()))}var s=this.getVisibleHorizon();if(s){s=s.clone()}o.prototype._setVisibleHorizon.apply(this,arguments);if(s){this.fireRedrawRequest(false,e,s,i,a)}return this};m.prototype.setTotalHorizon=function(t){o.prototype._setTotalHorizon.apply(this,arguments);if(this.getAxisTime()){this.calZoomBase();this.createAxisTime(this.getAxisTime().getLocale());this.fireRedrawRequest(true,"totalHorizonUpdated")}return this};m.prototype.updateStopInfo=function(t){this.setZoomLevel(t.index);return this};m.prototype.setZoomLevel=function(t){performance.mark("ProportionZoomStrategy.setZoomLevel--start");var e=sap.gantt.simple.VisibleHorizonUpdateSubType;if(t>=0&&t!==this.getZoomLevel()){this._focusOnZoom(this.getZoomLevel(),t);var o=t>this.getZoomLevel()?e.ZoomIn:e.ZoomOut;this.setProperty("zoomLevel",t,true);if(this._aZoomRate[t]){var i=this.calVisibleHorizonByRate(this._aZoomRate[t]);this.setVisibleHorizonWithReason(i,"zoomLevelChanged",null,o)}}performance.mark("ProportionZoomStrategy.setZoomLevel--end");return this};m.prototype.setZoomLevels=function(t){this.setProperty("zoomLevels",t,true);if(t>1){this._aZoomRate=new Array(t)}else{this._aZoomRate=[1]}this._updateZoomRateOnStops();return this};m.prototype.syncContext=function(t){var e=false,o=false;var a={zoomLevel:undefined,axisTimeChanged:false};var s=this.getParent()?this.getParent()._iLastVisibleWidth:null;var n=s?s:this.getGanttVisibleWidth();if(n&&t!==n){this._updateVisibleHorizon(t)}var r=this._determineZoomBoundaryByStrategy();var m=this._determineZoomRateByChartWidth(t);if(m){this.updateGanttVisibleWidth(t);var l=this._oZoom.minRate||-1;this._oZoom.minRate=Math.max(r.minRate,m.minRate)||r.minRate;var h=this._oZoom.maxRate||-1;this._oZoom.maxRate=r.maxRate;var p=this._oZoom.rate||-1;o=!i.floatEqual(l,this._oZoom.minRate)||!i.floatEqual(h,this._oZoom.maxRate);if(o){this._updateZoomRateOnStops();this._adjustRateByBoundary()}if(m.suitableRate&&!this._bHorizontalScroll){this._oZoom.rate=m.suitableRate;this._adjustRateByBoundary()}if(!this._disableAutoProportion){this._bHorizontalScroll=false}var u=this.getZoomLevel(),g=this._calcZoomLevelFromZoomRate(this._oZoom.rate);var f=u!==g&&!this.getParent()._isDisplayTypeChanged;if(f){this.setProperty("zoomLevel",g,true)}a.zoomLevel=this.getZoomLevel();e=!i.floatEqual(p,this._oZoom.rate);if(e){this.getParent().getAxisTime().setZoomRate(this._oZoom.rate);this._updateTimeLineOption()}a.axisTimeChanged=e}return a};m.prototype.setDisableAutoProportion=function(t){this._disableAutoProportion=t};m.prototype._updateVisibleHorizon=function(t){var e=this.getVisibleHorizon();var a=this.getGanttVisibleWidth();var s=i.calculateHorizonByWidth(e,a,t);o.prototype._setVisibleHorizon.call(this,s)};m.prototype.updateInitialVisibleHorizon=function(t,e){this.getParent().getAxisTime().setZoomRate(this._aZoomRate[e]);this._updateTimeLineOption();o.prototype._setVisibleHorizon.call(this,t)};m.prototype._adjustRateByBoundary=function(){if(this._oZoom.rate){this._oZoom.rate=Math.max(this._oZoom.rate,this._oZoom.minRate);this._oZoom.rate=Math.min(this._oZoom.rate,this._oZoom.maxRate)}};m.prototype._updateZoomRateOnStops=function(){if(this._oZoom&&this._oZoom.maxRate&&this._oZoom.minRate){var t=this._oZoom.maxRate,e=this._oZoom.minRate,o=this.getZoomLevels();this._oLog={};this._oLog.fMax=Math.log(t);this._oLog.fMin=Math.log(e);this._oLog.fStep=(this._oLog.fMax-this._oLog.fMin)/o;if(o>0){for(var i=0;i<o;i++){this._aZoomRate[i]=Math.pow(Math.E,this._oLog.fMin+this._oLog.fStep*i)}}else{this._aZoomRate[0]=1}}};m.prototype._calcZoomLevelFromZoomRate=function(t){if(this._oZoom&&this._oLog&&t){return Math.round((Math.log(t)-this._oLog.fMin)/this._oLog.fStep)}};m.prototype._determineZoomBoundaryByStrategy=function(){if(this._oZoom&&this._oZoom.base){var t=this.getCoarsestTimeLineOption(),e=this.getFinestTimeLineOption();return{minRate:this._oZoom.base.scale/this.calZoomScale(t.innerInterval.unit,t.innerInterval.span,this._getTimeLineRange(t)),maxRate:this._oZoom.base.scale/this.calZoomScale(e.innerInterval.unit,e.innerInterval.span,this._getTimeLineRange(e)*4)}}};m.prototype._determineZoomRateByChartWidth=function(e){var s=this.getTotalHorizon(),n=this.getVisibleHorizon(),r={};if(!this._oZoom){return null}if(!i.judgeTimeHorizonValidity(n,s)){this.getVisibleHorizon().setStartTime(s.getStartTime(),true);this.getVisibleHorizon().setEndTime(s.getEndTime(),true);t.warning("Visible horizon is not in total horizon, so convert visible horizon to total horizon",null,"sap.gantt.axistime.ProportionZoomStrategy.syncContext()")}if(s){var m=this.calZoomScaleByDate(a.abapTimestampToDate(s.getStartTime()),a.abapTimestampToDate(s.getEndTime()),e);r.minRate=this._oZoom.base.scale/m}if(n&&n.getStartTime()&&n.getEndTime()){var l=n.getStartTime();var h=n.getEndTime();if(l===h){o.prototype._setVisibleHorizon.call(this,s);var p=this.calVisibleHorizonByRate(this._aZoomRate[this.getZoomLevel()]);o.prototype._setVisibleHorizon.call(this,p);l=p.getStartTime();h=p.getEndTime()}var u=this.calZoomScaleByDate(a.abapTimestampToDate(l),a.abapTimestampToDate(h),e);r.suitableRate=this._oZoom.base.scale/u}return r};m.prototype._updateTimeLineOption=function(){var t=a.getTimeStampFormatter().parse("20000101000000"),e,o,i=this.getTimeLineOptions(),s=this.getProperty("timeLineOption");var r=this.getAxisTime();if(r){var m=r.timeToView(t,undefined,r.continuousScale);for(o in i){var l=i[o].innerInterval;var h=r.timeToView(n.getObjectFromPath(l.unit).offset(t,l.span),undefined,r.continuousScale);var p=Math.abs(Math.ceil(h-m));var u=typeof l.selector==="function"?l.selector(p):p>=this._getTimeLineRange(i[o]);if(u){e=o;break}}s=e?i[e]:i[o];this.setProperty("timeLineOption",s,true)}};m.prototype.onSetTimeZoomRate=function(t){var e=this.calVisibleHorizonByRate(t);this.setVisibleHorizon(e)};m.prototype.getCurrentVisibleHorizon=function(){var t=this.getTotalHorizon(),e=this.getZoomLevel();if(!t||e===undefined){return undefined}var o=this._completeTimeHorizon(this.calVisibleHorizonByRate(this._aZoomRate[e]));return o};m.prototype.getRenderedVisibleHorizon=function(){var t=this.getTotalHorizon(),e=this.getZoomLevel(),o=this.getParent();if(!o||!t||e===undefined){return undefined}var i=o.getRenderedTimeRange();var a=new s({startTime:i[0],endTime:i[1]});return a};return m},true);
//# sourceMappingURL=ProportionZoomStrategy.js.map