/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/gantt/library","sap/ui/core/Element","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/core/format/DateFormat","../misc/Utility","../misc/Format","../misc/RelativeTimeFormatter","../config/TimeHorizon","../misc/AxisTime","sap/ui/core/date/CalendarUtils","sap/base/i18n/Localization","sap/base/i18n/Formatting","sap/base/i18n/date/CalendarType","sap/gantt/simple/GanttUtils","sap/base/i18n/date/CalendarWeekNumbering","sap/gantt/utils/GanttChartConfigurationUtils","sap/gantt/polyfills/lib"],function(e,t,i,a,o,n,r,s,l,m,p,g,u,T,h,f,c,d){"use strict";var v=i.extend("sap.gantt.axistime.AxisTimeStrategyBase",{metadata:{library:"sap.gantt",abstract:true,properties:{timeLineOptions:{type:"object"},timeLineOption:{type:"object"},coarsestTimeLineOption:{type:"object"},finestTimeLineOption:{type:"object"},zoomLevels:{type:"int",defaultValue:10},zoomLevel:{type:"int",defaultValue:0},calendarType:{type:"string",defaultValue:h.Gregorian},locale:{type:"object"},firstDayOfWeek:{type:"int"},mouseWheelZoomType:{type:"sap.gantt.MouseWheelZoomType",defaultValue:t.MouseWheelZoomType.FineGranular},calendarWeekNumbering:{type:"sap.base.i18n.date.CalendarWeekNumbering",defaultValue:null},_discontinuousProvider:{type:"object",multiple:false,visibility:"hidden"}},aggregations:{totalHorizon:{type:"sap.gantt.config.TimeHorizon",multiple:false},visibleHorizon:{type:"sap.gantt.config.TimeHorizon",multiple:false},skipTimePattern:{type:"sap.gantt.skipTime.SkipPattern",multiple:false},_axisTime:{type:"sap.gantt.misc.AxisTime",multiple:false,visibility:"hidden"}}}});v.prototype.applySettings=function(e){e=e||{};if(!e.visibleHorizon){e.visibleHorizon=t.config.DEFAULT_VISIBLE_HORIZON.clone()}if(!e.totalHorizon){e.totalHorizon=t.config.DEFAULT_TOTAL_HORIZON.clone()}this.checkFirstDayOfWeek(e);s._oDefaultDateTimeFormat=n.getDateTimeWithTimezoneInstance({showTimezone:false});i.prototype.applySettings.call(this,e);this.calZoomBase();return this};v.prototype.setSkipTimePattern=function(e,t){var i=this.getParent();if(i){var a=i.getLocale();if(a){e.setLocale(a)}}var o=e?e.getDiscontinuityProvider():null;this.setAggregation("skipTimePattern",e,true);delete this._nGanttVisibleWidth;this.setProperty("_discontinuousProvider",o,t)};v.prototype.clone=function(){var e=i.prototype.clone.apply(this,arguments);if(e.hasListeners("_redrawRequest")){e.mEventRegistry._redrawRequest.forEach(function(t){e.detachEvent("_redrawRequest",t.fFunction,t.oListener)})}return e};v.prototype.exit=function(){u.detachChange(this._onLocalizationChanged.bind(this));T.detachChange(this._onLocalizationChanged.bind(this))};v.prototype.setParent=function(e){i.prototype.setParent.apply(this,arguments);var t=this.getAggregation("skipTimePattern");if(t){var a=e.getLocale();if(a){t.setLocale(a)}}};v.prototype.isTimePeriodZoomEnabled=function(){return true};v.prototype._setVisibleHorizon=function(e){var t=this._completeTimeHorizon(e);var i=this.getAggregation("visibleHorizon");if(i){i.setStartTime(t.getStartTime(),true);i.setEndTime(t.getEndTime(),true)}else{this.setAggregation("visibleHorizon",t,true)}return this};v.prototype.setVisibleHorizonWithReason=function(e,t,i){this._setVisibleHorizon(e);return this};v.prototype._completeTimeHorizon=function(e){var t=this.getVisibleHorizon(),i=this.getTotalHorizon();if(t===null||i===null){return e}var a=new m({startTime:t.getStartTime(),endTime:t.getEndTime()});if(e){var o=e.getStartTime(),n=e.getEndTime(),r,l=s.abapTimestampToDate(i.getStartTime()),p=s.abapTimestampToDate(i.getEndTime());if(!o&&!n){return a}var g;if(this._oZoom&&this._oZoom.base&&this._oZoom.base.scale!==undefined&&this._nGanttVisibleWidth!==undefined&&this.getAxisTime()){var u=this.getAxisTime().getZoomRate();var T=this._oZoom.base.scale/u;g=this._nGanttVisibleWidth*T}else{g=s.abapTimestampToDate(a.getEndTime()).getTime()-s.abapTimestampToDate(a.getStartTime()).getTime()}if(!o){r=s.abapTimestampToDate(n);r.setTime(r.getTime()-g);if(r<l){r=l;n=s.dateToAbapTimestamp(new Date(l+g))}o=s.dateToAbapTimestamp(r)}else if(!n){r=s.abapTimestampToDate(o);r.setTime(r.getTime()+g);if(r>p){r=p;o=s.dateToAbapTimestamp(new Date(p-g))}n=s.dateToAbapTimestamp(r)}else{r=s.abapTimestampToDate(o);if(r<l){o=this.getTotalHorizon().getStartTime()}r=s.abapTimestampToDate(n);if(r>p){n=this.getTotalHorizon().getEndTime()}}a.setStartTime(o);a.setEndTime(n)}return a};v.prototype.createAxisTime=function(t){var i=this.getTimeLineOption(),a=this.getVisibleHorizon(),o=this.getTotalHorizon();if(!r.judgeTimeHorizonValidity(a,o)){if(this.getVisibleHorizon()){this.getVisibleHorizon().setStartTime(o.getStartTime(),true);this.getVisibleHorizon().setEndTime(o.getEndTime(),true)}else{this.setAggregation("visibleHorizon",o.clone(),true)}e.warning("Visible horizon is not in total horizon, so convert visible horizon to total horizon",null,"sap.gantt.axistime.AxisTimeStrategyBase.createAxisTime()")}var n=s.getTimeStampFormatter().parse(o.getStartTime());var l=s.getTimeStampFormatter().parse(o.getEndTime());var m=l.valueOf()-n.valueOf();var g=f.getObjectFromPath(i.innerInterval.unit).offset(n,i.innerInterval.span).valueOf()-n.valueOf();var u=[n,l];var T=this._getTimeLineRange(i);var h=[0,Math.ceil(m*T/g)];var c=this.getProperty("_discontinuousProvider");if(c){var d=c.distance(n,l);h=[0,Math.ceil(d*T/g)]}var v=new p(u,h,1,null,null,t,this);this.setAggregation("_axisTime",v,true)};v.prototype.syncContext=function(e){var t={zoomLevel:undefined,axisTimeChanged:false};return t};v.prototype.updateStopInfo=function(e){return null};v.prototype._setTotalHorizon=function(e,t){if(typeof t==="undefined"){t=true}if(e){var i=this.getAggregation("totalHorizon");if(i){i.setStartTime(e.getStartTime(),true);i.setEndTime(e.getEndTime(),true)}else{this.setAggregation("totalHorizon",e,t)}}return this};v.prototype.getUpperRowFormatter=function(){var e=this.getTimeLineOption();var t=e.largeInterval;var i;if(t.relativeTime){var o=s.abapTimestampToDate(this.getTotalHorizon().getStartTime());i=new l(o,t.unit,t.relativeTimePrefix)}else{var r=this.getCalendarType(),m=this.getCalendarWeekNumbering(),p=this.getLocale()?this.getLocale():new a(d.getLanguage().toLowerCase());i=n.getDateTimeWithTimezoneInstance({format:t.format,pattern:t.pattern,style:t.style,calendarType:e.calendarType||r,calendarWeekNumbering:m,showTimezone:false},t.locale?new a(t.locale):p)}return i};v.prototype.getLowerRowFormatter=function(){var e=this.getTimeLineOption();var t=e.smallInterval;var i;if(t.relativeTime){var o=s.abapTimestampToDate(this.getTotalHorizon().getStartTime());i=new l(o,t.unit,t.relativeTimePrefix)}else{var r=this.getCalendarType(),m=this.getCalendarWeekNumbering(),p=this.getLocale()?this.getLocale():new a(d.getLanguage().toLowerCase());i=n.getDateTimeWithTimezoneInstance({format:t.format,pattern:t.pattern,style:t.style,calendarType:r,calendarWeekNumbering:m,showTimezone:false},t.locale?new a(t.locale):p)}return i};v.prototype.getCalendarWeekNumbering=function(){var e=this.getProperty("calendarWeekNumbering");return e||d.getCalendarWeekNumbering()};v.prototype._getCalendarWeekConfig=function(){return g.getWeekConfigurationValues(this.getCalendarWeekNumbering())};v.prototype.isLowerRowTickHourSensitive=function(){var e=this.getTimeLineOption();var t=e.innerInterval.unit;var i=e.innerInterval.span;var a=s.getTimeStampFormatter().parse("20000101000000");var o=f.getObjectFromPath(t).offset(a,i);return o.getTime()-a.getTime()<=60*60*1e3};v.prototype.getAxisTime=function(){return this.getAggregation("_axisTime")};v.prototype.fireRedrawRequest=function(e,t,i,a,o){this.fireEvent("_redrawRequest",{forceUpdate:e,reasonCode:t,valueBeforeChange:i,originEvent:a,subReasonCode:o})};v.prototype.updateGanttVisibleWidth=function(e){this._nGanttVisibleWidth=e};v.prototype.getGanttVisibleWidth=function(){return this._nGanttVisibleWidth};v.prototype.calZoomScale=function(e,t,i){var a=s.getTimeStampFormatter().parse("20000101000000");var o=f.getObjectFromPath(e).offset(a,t);return this.calZoomScaleByDate(a,o,i)};v.prototype.calZoomScaleByDate=function(e,t,i){return(t.valueOf()-e.valueOf())/i};v.prototype.calZoomBase=function(){var e=this.getTimeLineOption()||this.getFinestTimeLineOption();if(e){var t=this.calZoomScale(e.innerInterval.unit,e.innerInterval.span,this._getTimeLineRange(e));this._oZoom={base:{timeLineOption:e,rate:1,scale:t}};return true}return false};v.prototype.checkFirstDayOfWeek=function(e){if(typeof e.firstDayOfWeek==="undefined"){var t=this._getCalendarWeekConfig();if(t){e.firstDayOfWeek=t.firstDayOfWeek}else{e.firstDayOfWeek=o.getInstance(d.getLanguageTag()).getFirstDayOfWeek()}u.attachChange(this._onLocalizationChanged.bind(this));T.attachChange(this._onLocalizationChanged.bind(this))}};v.prototype._getTimeLineRange=function(e){return typeof e.innerInterval.range==="function"?e.innerInterval.range():e.innerInterval.range};v.prototype.updateVisibleHorizonOnMouseWheelZoom=function(e,i,a,o){var n=i<0;var r=Math.round(Math.abs(i)/100);var s=this.getMouseWheelZoomType();if(s===t.MouseWheelZoomType.FineGranular){this.updateVisibleHorizonOnFineGranularMouseWheelZoom(e,n,r,a,o)}else if(s===t.MouseWheelZoomType.Stepwise){this.updateVisibleHorizonOnStepWiseMouseWheelZoom(e,n,r,a,o)}};v.prototype._focusOnZoom=function(e,t){var i=this.getParent();var a=i?i.getParent():null;if(a&&a.isA("sap.gantt.simple.GanttChartContainer")&&a.getEnableAutoFocusOnZoom()&&e<t){f._calculateSelectedShapeMinTime(a)}};v.prototype.updateVisibleHorizonOnFineGranularMouseWheelZoom=function(e,t,i,a,o){var n=this.getVisibleHorizon();var r=s.abapTimestampToDate(n.getStartTime());var l=this.getTimeLineOption();var m=f.getObjectFromPath(l.innerInterval.unit).offset(r,i*l.innerInterval.span).getTime()-r.getTime();var p=t?-1:1;var g=this.calVisibleHorizonByDelta(p*m,e);var u=o?"syncVisibleHorizon":"mouseWheelZoom";this.setVisibleHorizonWithReason(g,u,a)};v.prototype.updateVisibleHorizonOnStepWiseMouseWheelZoom=function(e,t,i,a,o){var n=t?-1:1;var s=this.getZoomLevel()-n*i;if(s>-1&&s<this.getZoomLevels()){if(this._aZoomRate[s]&&!r.floatEqual(this._aZoomRate[s],this._oZoom.rate)){this.setZoomLevel(s)}}};v.prototype.calVisibleHorizonByRate=function(e,t){var i=0;if(this._oZoom&&this._oZoom.base&&this._oZoom.base.scale!==undefined&&this._nGanttVisibleWidth!==undefined){var a=s.abapTimestampToDate(this.getVisibleHorizon().getStartTime());var o=s.abapTimestampToDate(this.getVisibleHorizon().getEndTime());var n=o.getTime()-a.getTime();var r=this._oZoom.base.scale/e;var l=this._nGanttVisibleWidth*r;i=l-n}return this.calVisibleHorizonByDelta(i,t)};v.prototype.calVisibleHorizonByDelta=function(e,t){var i=this.getVisibleHorizon();e=Math.round(e)||0;if(e!==0){var a=s.abapTimestampToDate(i.getStartTime()).getTime();var o=s.abapTimestampToDate(i.getEndTime()).getTime();var n=o-a;var r=0;var l;var p=s.abapTimestampToDate(this.getTotalHorizon().getStartTime()).getTime();var g=s.abapTimestampToDate(this.getTotalHorizon().getEndTime()).getTime();if(e>0&&a<=p){l=0;r=p}else if(e>0&&o>=g){l=1;r=g}else{if(!t){r=a+n/2}else{r=t.getTime()}l=(r-a)/n}var u=n+e;var T=Math.floor(r-l*u);if(T<=p){T=p}var h=T+u;if(h>=g){T=T-Math.abs(g-h);h=g;if(T<=p){T=p}}return new m({startTime:new Date(T),endTime:new Date(h)})}return i};v.prototype.calMiddleDate=function(e,t){return new Date(e.getTime()+(t.getTime()-e.getTime())/2)};v.prototype._onLocalizationChanged=function(){var e=this._getCalendarWeekConfig();if(e){this.setFirstDayOfWeek(e.firstDayOfWeek)}else{this.setFirstDayOfWeek(o.getInstance(d.getLanguageTag()).getFirstDayOfWeek())}var t=this.getParent();if(t&&t.getEnablePseudoShapes&&t.getEnablePseudoShapes()){if(!t.pseudoShapeSpecificData){t.pseudoShapeSpecificData={}}t.pseudoShapeSpecificData.needUpdateForTasksInAggr=true}s._oDefaultDateTimeFormat=n.getDateTimeWithTimezoneInstance({showTimezone:false})};v.prototype._updateZoomControlType=function(e){return null};return v},true);
//# sourceMappingURL=AxisTimeStrategyBase.js.map