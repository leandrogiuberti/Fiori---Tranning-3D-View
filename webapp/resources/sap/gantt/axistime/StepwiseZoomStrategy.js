/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/gantt/library","./AxisTimeStrategyBase","../misc/Format","sap/gantt/axistime/StepwiseTimeLineOptions","sap/gantt/simple/GanttUtils"],function(t,e,i,o,a){"use strict";var n=e.extend("sap.gantt.axistime.StepwiseZoomStrategy",{metadata:{library:"sap.gantt"}});n.prototype.init=function(){this._oTotalHorizonBeforeExtension=null;this._sZoomControlType=sap.gantt.config.ZoomControlType.Select;this._aTimeLineOptions=null;this._calculatedTotalHorizon=null;this.bAxisTimeChanged=false;this.iLastZoomLevel=-1;var t=o.DayDate;this.setProperty("timeLineOption",t,true);this.setProperty("timeLineOptions",o,true);this.setProperty("mouseWheelZoomType",sap.gantt.MouseWheelZoomType.Stepwise,true);this.setProperty("finestTimeLineOption",null,true);this.setProperty("coarsestTimeLineOption",null,true);this._aZoomRate=new Array(11)};n.prototype.applySettings=function(){e.prototype.applySettings.apply(this,arguments);this._updateZoomRateArray();this._updateTimeLineOptions();this.setInitialProperties();this.initialSettings=arguments[0];return this};n.prototype.setInitialProperties=function(){this.setProperty("zoomLevels",this._getCountOfTimeLineOptions(),true);if(this._getIndexOfTimeLineOption(this.getTimeLineOption())===-1){this.setTimeLineOption(this._aTimeLineOptions[Math.floor((this._getCountOfTimeLineOptions()-1)/2)])}};n.prototype.createAxisTime=function(t){e.prototype.createAxisTime.apply(this,arguments);this.setZoomLevel(this._getIndexOfTimeLineOption(this.getTimeLineOption(),this.getTimeLineOptions()));this._Locale=t;return this};n.prototype.setVisibleHorizon=function(t){this.setVisibleHorizonWithReason(t,"visibleHorizonUpdated");return this};n.prototype.setVisibleHorizonWithReason=function(t,i,o){var a=this.getVisibleHorizon();if(a){a=a.clone()}e.prototype._setVisibleHorizon.apply(this,arguments);this.fireRedrawRequest(false,i,a,o);return this};n.prototype.setTotalHorizon=function(t){var i=this.getTotalHorizon();if(i){this.oLastTotalHorizonStartTime=i.getStartTime();this.oLastTotalHorizonEndTime=i.getEndTime()}e.prototype._setTotalHorizon.apply(this,arguments);this._setCalculatedTotalHorizon(t);if(this.getAxisTime()){this.fireRedrawRequest(true,"totalHorizonUpdated")}return this};n.prototype._setCalculatedTotalHorizon=function(t){if(t){if(this._calculatedTotalHorizon){this._calculatedTotalHorizon.setStartTime(t.getStartTime(),true);this._calculatedTotalHorizon.setEndTime(t.getEndTime(),true)}else{this._calculatedTotalHorizon=new sap.gantt.config.TimeHorizon({startTime:t.getStartTime(),endTime:t.getEndTime()})}this._updateTimeRangeAndViewRange(t)}return this};n.prototype._updateTimeRangeAndViewRange=function(t){var e=this.getAxisTime();if(e&&t){e.setTimeRange([i.getTimeStampFormatter().parse(t.getStartTime()),i.getTimeStampFormatter().parse(t.getEndTime())]);var o=i.getTimeStampFormatter().parse(t.getStartTime());var n=i.getTimeStampFormatter().parse(t.getEndTime());var s=n.valueOf()-o.valueOf();var r=this.getTimeLineOption();var p=a.getObjectFromPath(r.innerInterval.unit).offset(o,r.innerInterval.span).valueOf()-o.valueOf();var m=e._discontinuityProviderInstance&&e._discontinuityProviderInstance.useDiscontinuousScale(r.smallInterval.unit)?e._discontinuityProviderInstance:null;if(m){s=m.distance(o,n)}e.setViewRange([0,Math.ceil(s*this._getTimeLineRange(r)/p/this._aZoomRate[this.getZoomLevel()])])}return this};n.prototype._getCalculatedTotalHorizon=function(){if(!this._calculatedTotalHorizon||!this._calculatedTotalHorizon.getStartTime()||!this._calculatedTotalHorizon.getEndTime()){this._setCalculatedTotalHorizon(this.getAggregation("totalHorizon"))}return this._calculatedTotalHorizon};n.prototype.getTotalHorizon=function(){return this._getCalculatedTotalHorizon()};n.prototype.setZoomLevels=function(t){return this};n.prototype.setZoomLevel=function(t){if(t>=0){this.iLastZoomLevel=this.getZoomLevel();this.setProperty("zoomLevel",t,true);this._focusOnZoom(this.iLastZoomLevel,t);this.setProperty("timeLineOption",this._getTimeLineOptionByIndex(t),true);if(this._aZoomRate[t]&&this.getGanttVisibleWidth()){var e=this._updateVisibleHorizon(this.getGanttVisibleWidth());this.setVisibleHorizon(e)}}return this};n.prototype.setTimeLineOption=function(t){this.setProperty("timeLineOption",t,true);this.setZoomLevel(this._getIndexOfTimeLineOption(t))};n.prototype.setCoarsestTimeLineOption=function(t){return this};n.prototype.setFinestTimeLineOption=function(t){return this};n.prototype.setTimeLineOptions=function(t){e.prototype.setTimeLineOptions.apply(this,arguments);this._updateZoomRateArray();this._updateTimeLineOptions();return this};n.prototype._updateVisibleHorizon=function(t){if(!t){var o=this._getWidthOfTotalHorizon();this._extendTotalHorizon(o)}else{this._extendTotalHorizon(t)}var a=this.getAxisTime();if(a){a.setZoomRate(this._aZoomRate[this.getZoomLevel()]);var n=this.getVisibleHorizon();var s=this.calMiddleDate(i.getTimeStampFormatter().parse(n.getStartTime()),i.getTimeStampFormatter().parse(n.getEndTime()));var r=this.calVisibleHorizonByRate(this._aZoomRate[this.getZoomLevel()],s);e.prototype._setVisibleHorizon.call(this,r);return r}};n.prototype.updateInitialVisibleHorizon=function(t,o){this.setProperty("timeLineOption",this._getTimeLineOptionByIndex(o),true);var a=this.calMiddleDate(i.getTimeStampFormatter().parse(t.getStartTime()),i.getTimeStampFormatter().parse(t.getEndTime()));var n=this.calVisibleHorizonByRate(this._aZoomRate[this.getZoomLevel()],a);e.prototype._setVisibleHorizon.call(this,n)};n.prototype.updateGanttVisibleWidth=function(t){return this};n.prototype.isTimePeriodZoomEnabled=function(){return false};n.prototype.syncContext=function(t){var o=this.getTotalHorizon();var a={zoomLevel:undefined,axisTimeChanged:false};if(this.bBirdEyeTriggered){this.bBirdEyeTriggered=false;var n=this.getAxisTime();if(n){var s=this.getVisibleHorizon();var r=this.calZoomScaleByDate(i.abapTimestampToDate(s.getStartTime()),i.getTimeStampFormatter().parse(s.getEndTime()),t);var p=this._oZoom.base.scale/r;var m=0;while(p>=this._aZoomRate[m]){m++}if(m!==0){m=m-1}e.prototype.updateGanttVisibleWidth.apply(this,arguments);if(this.iLastZoomLevel!==m){n.setZoomRate(this._aZoomRate[m]);this.setProperty("zoomLevel",m,true);this.setProperty("timeLineOption",this._getTimeLineOptionByIndex(m),true);this._updateVisibleHorizon(this.getGanttVisibleWidth());this.iLastZoomLevel=this.getZoomLevel();a.axisTimeChanged=true}}}else if(t!==this.getGanttVisibleWidth()){this._updateVisibleHorizon(t);a.axisTimeChanged=true;e.prototype.updateGanttVisibleWidth.apply(this,arguments)}else if(this.iLastZoomLevel===this.getZoomLevel()&&(!this.oLastTotalHorizonStartTime||this.oLastTotalHorizonStartTime===o.getStartTime()&&this.oLastTotalHorizonEndTime===o.getEndTime())){a.axisTimeChanged=false}else{a.axisTimeChanged=true;this.iLastZoomLevel=this.getZoomLevel();this.oLastTotalHorizonStartTime=o.getStartTime();this.oLastTotalHorizonEndTime=o.getEndTime()}a.zoomLevel=this.getZoomLevel();return a};n.prototype._updateZoomRateArray=function(){if(this._oZoom){var t=this.getTimeLineOptions();this._aZoomRate=[];if(t){var e;if(this._sZoomControlType!==sap.gantt.config.ZoomControlType.Select){e=this._getCountOfTimeLineOptions();for(var i in t){e--;this._aZoomRate[e]=this._oZoom.base.scale/this.calZoomScale(t[i].innerInterval.unit,t[i].innerInterval.span,this._getTimeLineRange(t[i]))}}else{e=0;for(var o in t){this._aZoomRate[e]=this._oZoom.base.scale/this.calZoomScale(t[o].innerInterval.unit,t[o].innerInterval.span,this._getTimeLineRange(t[o]));e++}}}else{this._aZoomRate[0]=1}}};n.prototype._updateTimeLineOptions=function(){var t=this.getTimeLineOptions();this._aTimeLineOptions=[];if(t){for(var e in t){this._aTimeLineOptions.push(t[e])}if(this._sZoomControlType!==sap.gantt.config.ZoomControlType.Select){this._aTimeLineOptions=this._aTimeLineOptions.reverse()}}};n.prototype.updateStopInfo=function(t){this.setZoomLevel(t.index);return this};n.prototype._getIndexOfTimeLineOption=function(t,e){var i=e;if(!i){i=this.getTimeLineOptions()}if(!this._aTimeLineOptions){this._updateTimeLineOptions()}for(var o=0,a=this._aTimeLineOptions.length;o<a;o++){if(this._aTimeLineOptions[o]==t){return o}}return-1};n.prototype._getTimeLineOptionByIndex=function(t){if(!this._aTimeLineOptions){this._updateTimeLineOptions()}if(t<this._aTimeLineOptions.length){return this._aTimeLineOptions[t]}else{return null}};n.prototype._getWidthOfTotalHorizon=function(){var t=this._getCalculatedTotalHorizon();var e=i.getTimeStampFormatter().parse(t.getStartTime());var o=i.getTimeStampFormatter().parse(t.getEndTime());var a=this.getAxisTime();var n=a.timeToView(e);var s=a.timeToView(o);return Math.abs(s-n)};n.prototype._extendTotalHorizon=function(t){var e=this._getCalculatedTotalHorizon();var o=0;if(this._oZoom&&this._oZoom.base&&this._oZoom.base.scale!==undefined){var a=i.abapTimestampToDate(e.getStartTime());var n=i.abapTimestampToDate(e.getEndTime());var s=n.getTime()-a.getTime();var r=this._aZoomRate[this.getZoomLevel()];var p=this._oZoom.base.scale/r;var m=t*p;o=m-s;e=this._calTotalHorizon(o,m);this._setCalculatedTotalHorizon(e)}};n.prototype._calTotalHorizon=function(t,e){var o=this._getCalculatedTotalHorizon();if(t!==0){var a=i.abapTimestampToDate(this.getAggregation("totalHorizon").getStartTime()).getTime();var n=i.abapTimestampToDate(this.getAggregation("totalHorizon").getEndTime()).getTime();var s=(a+n)/2;var r,p;if(t>0){r=s-e/2;p=s+e/2}else{r=i.abapTimestampToDate(o.getStartTime()).getTime()-t/2;p=i.abapTimestampToDate(o.getEndTime()).getTime()+t/2;if(r>a){r=a}if(p<n){p=n}}var m=new Date;m.setTime(r);var l=new Date;l.setTime(p);return new sap.gantt.config.TimeHorizon({startTime:m,endTime:l})}return o};n.prototype._updateZoomControlType=function(t){if(t){e.prototype._updateZoomControlType.apply(this,arguments);this._sZoomControlType=t;this._updateZoomRateArray();this._updateTimeLineOptions();if(this.initialSettings.zoomLevel!=null&&this.initialSettings.zoomLevel!=0){this.setZoomLevel(this.initialSettings.zoomLevel)}else{this.setZoomLevel(this._getIndexOfTimeLineOption(this.getTimeLineOption(),this.getTimeLineOptions()))}}};n.prototype._getCountOfTimeLineOptions=function(){return Object.keys(this.getTimeLineOptions()).length};return n},true);
//# sourceMappingURL=StepwiseZoomStrategy.js.map