/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/gantt/drawer/Drawer","sap/gantt/misc/Utility","sap/gantt/misc/Format","sap/ui/Device","sap/ui/core/Core","sap/ui/core/Element","sap/ui/thirdparty/d3"],function(t,e,r,a,i,n){"use strict";var s=t.extend("sap.gantt.drawer.ShapeInRow",{});s.prototype.drawSvg=function(t,e,r,a,i){this._oAxisTime=r;this._oAxisOrdinal=a;this._oStatusSet=i;var s=t.select("."+e.getId()+"-top");if(s.empty()){s=t.append("g").classed(e.getId()+"-top",true)}if(n.getElementById(e.getId()).getMetadata().getName()==="sap.gantt.shape.cal.Calendar"){s.classed("sapGanttChartCalendar",true)}var o=e.getId()+"-row";var u=s.selectAll("."+o).data(e.dataSet);u.enter().append("g").classed(o,true);u.attr("data-sap-gantt-row-id",function(t){return t.objectInfoRef.id});u.exit().remove();if(!u.empty()){this._recursiveDraw(u,e)}};s.prototype.drawResizeShadow=function(t,e,r,a,i){this._oAxisTime=r;this._oAxisOrdinal=a;this._oStatusSet=i;if(e){var n=t.select(".resizingShadow");if(n.empty()){n=t.append("g").classed("resizingShadow",true)}var s=n.select("."+e.getId()+"-resize");if(s.empty()){s=n.append("g").classed(e.getId()+"-resize",true)}var o=s.data(e.dataSet);o.exit().remove();if(!o.empty()){this._recursiveDraw(o,e)}}};s.prototype._recursiveDraw=function(t,e,r){var a=this;var i=t.selectAll("."+e.getId()).data(function(t){return a._bindRowData(t,r,this,e)});this._drawPerTag(i,e);this._drawInsertTitle(t,e)};s.prototype._bindRowData=function(t,e,r,a){var i=this._oStatusSet&&this._oStatusSet.aViewBoundary?this._oStatusSet.aViewBoundary:undefined;var n=a.getIsBulk();var s,o;if(t){var u=[];if(t.shapeData){if(!(t.shapeData instanceof Array)){u=u.concat(t.shapeData)}else{for(o=0;o<t.shapeData.length;o++){if(t.shapeData[o]){s={};s.oShape=a;s.objectInfo=t.objectInfoRef;s.dShapeData=t.shapeData[o];s.aViewRange=i;if(!n&&i!==undefined&&this._filterDataVisibleRange(s)){continue}u=u.concat(t.shapeData[o])}}}}else if(e&&t[e]){if(t[e].length){for(o=0;o<t[e].length;o++){s={};s.oShape=a;s.objectInfo=t.objectInfoRef;s.dShapeData=t[e][o];s.aViewRange=i;if(!n&&i!==undefined&&this._filterDataVisibleRange(s)){continue}u.push(t[e][o])}}else{u.push(t[e])}}else if(t){u=u.concat(t)}if(a.filterValidData&&u.length>0){u=a.filterValidData(u,t.objectInfoRef)}return u}};s.prototype._filterDataVisibleRange=function(t){var e=this._oAxisTime;var a=this._oAxisOrdinal;var i=t.aViewRange;var n=t.oShape.getIsDuration(t.dShapeData);if(n){var s=e.timeToView(r.abapTimestampToDate(t.oShape.getTime(t.dShapeData,undefined,e,a,t.objectInfo)));var o=e.timeToView(r.abapTimestampToDate(t.oShape.getEndTime(t.dShapeData,undefined,e,a,t.objectInfo)));if(this._oStatusSet.bRTL===true){return o>i[1]||s<i[0]}else{return o<i[0]||s>i[1]}}else{var u=e.timeToView(r.abapTimestampToDate(t.oShape.getTime(t.dShapeData,undefined,e,a,t.objectInfo)));return u>i[1]||u<i[0]}};s.prototype._drawPerTag=function(t,e){switch(e.getTag()){case"g":this._drawGroup(t,e);break;case"line":this._drawLine(t,e);break;case"rect":this._drawRect(t,e);break;case"text":this._drawText(t,e);break;case"path":this._drawPath(t,e);break;case"clippath":this._drawClipPath(t,e);break;case"image":this._drawImage(t,e);break;case"polygon":this._drawPolygon(t,e);break;case"polyline":this._drawPolyline(t,e);break;case"circle":this._drawCircle(t,e);break;case"defs":this._drawDefinitions(t,e);break;default:break}if(e.getParent()===null){this.addDataAttributes(t)}};s.prototype._drawGroup=function(t,e){var r=this._findObjectInfo;t.enter().append("g").classed(e.getId(),true);t.classed("hasTitle",function(t){return e.getTitle(t,r(this,e))?true:false});t.exit().remove();var a=e.getShapes();if(a&&a.length>0){for(var i=0;i<a.length;i++){this._recursiveDraw(t,a[i],a[i].mShapeConfig.getShapeDataName())}}};s.prototype._drawLine=function(t,e){var r=this._findObjectInfo;var a={};t.enter().append("line").classed(e.getId(),true);t.classed("hasTitle",function(t){return e.getTitle(t,r(this,e))?true:false}).attr("x1",function(t){return e.getX1(t,r(this,e))}).attr("y1",function(t){return e.getY1(t,r(this,e))}).attr("x2",function(t){return e.getX2(t,r(this,e))}).attr("y2",function(t){return e.getY2(t,r(this,e))}).attr("filter",function(t){return e.getFilter(t,r(this,e))}).attr("transform",function(t){return e.getTransform(t,r(this,e))}).attr("aria-label",function(t){return e.getAriaLabel(t,r(this,e))}).each(function(t){a=e.getStyle(t,r(this,e));d3.select(this).style(a)});t.exit().remove()};s.prototype._drawRect=function(t,e){var r=this._findObjectInfo;var a={};t.enter().append("rect").classed(e.getId(),true);t.classed(e.getHtmlClass(),function(t){return e.getHtmlClass(t,r(this,e))?true:false}).classed("hasTitle",function(t){return e.getTitle(t,r(this,e))?true:false}).classed("enableClone",function(t){return e.getEnableDnD(t,r(this,e))?true:false}).attr("x",function(t){return e.getX(t,r(this,e))}).attr("y",function(t){return e.getY(t,r(this,e))}).attr("width",function(t){return e.getWidth(t,r(this,e))}).attr("height",function(t){return e.getHeight(t,r(this,e))}).attr("rx",function(t){return e.getRx(t,r(this,e))}).attr("ry",function(t){return e.getRy(t,r(this,e))}).attr("filter",function(t){return e.getFilter(t,r(this,e))}).attr("transform",function(t){return e.getTransform(t,r(this,e))}).attr("clip-path",function(t){return e.getClipPath(t,r(this,e))}).attr("aria-label",function(t){return e.getAriaLabel(t,r(this,e))}).each(function(t){a=e.getStyle(t,r(this,e));d3.select(this).style(a)});t.exit().remove()};s.prototype._drawText=function(t,e){var r=this._findObjectInfo;var a={};var i=this;t.enter().append("text").classed(e.getId(),true);t.classed("sapGanttShapeSvgText",true).classed("hasTitle",function(t){return e.getTitle(t,r(this,e))?true:false}).attr("x",function(t){return e.getX(t,r(this,e))}).attr("y",function(t){return e.getY(t,r(this,e))}).attr("text-anchor",function(t){return e.getTextAnchor(t,r(this,e))}).attr("filter",function(t){return e.getFilter(t,r(this,e))}).attr("transform",function(t){return e.getTransform(t,r(this,e))}).text(function(t){return e.getText(t,r(this,e))}).each(function(t){var n=d3.select(this);n.selectAll("tspan").remove();var s=r(this,e);var o=e.getWrapWidth(t,s);var u=e.getTruncateWidth(t,s);if(u>-1){i._textTruncate(t,n,u,e.getEllipsisWidth(t,s),e.getId())}else if(o>-1){i._textWrap(t,this,o,e.getWrapDy(t,s))}a=e.getStyle(t,r(this,e));d3.select(this).style(a)});t.exit().remove()};s.prototype._textTruncate=function(t,e,r,n,s){var o=e.node().getComputedTextLength();if(o>r){var u=e.text().trim(),l,h;if(n>-1&&n<r){h=true;l=r-n}else{h=false;l=r}var f=this._getTextTruncatCountByBinarySearch(e,o,l,u);u=u.slice(0,f).trim();e.text(u);if(h){if(a.browser.name==="cr"&&a.browser.version<96){e.append("tspan").classed(s,true).text("...").attr("textLength",e.node().getComputedTextLength()).attr("lengthAdjust","spacingAndGlyphs")}else{var c=i.getConfiguration().getRTL();if(c&&(a.browser.edge||a.browser.safari)){e.text("..."+u).classed(s,true)}else{e.append("tspan").classed(s,true).text("...").attr("textLength",n).attr("lengthAdjust","spacingAndGlyphs")}}}}};s.prototype._getTextTruncatCountByBinarySearch=function(t,e,r,a){var i=0;if(r>0&&a.length>0){var n=Math.round(r/Math.ceil(e/a.length));var s,o,u;if(n<1){s=n;o=n+1;u=n+2}else if(n==a.length){s=n-2;o=n-1;u=n}else{s=n-1;o=n;u=n+1}var l=t[0][0].getSubStringLength(0,o);var h=t[0][0].getSubStringLength(0,u);var f=t[0][0].getSubStringLength(0,s);if(l==r||l<r&&h>r){i=o}else if(h==r){i=u}else if(f==r||f<r&&l>r){i=s}else{var c=1,d=a.length;if(h<r){c=u}else if(f>r){d=s-1}while(c<=d){o=Math.floor(c+(d-c)/2);l=t[0][0].getSubStringLength(0,o);h=t[0][0].getSubStringLength(0,o+1);if(l==r||l<r&&h>r){i=o;break}else if(l>r){d=o-1}else{c=o+1}}}}return i>=0&&i<=a.length?i:0};s.prototype._textWrap=function(t,e,r,a){};s.prototype._drawPath=function(t,e){var r=this._findObjectInfo;var a={};t.enter().append("path").classed(e.getId(),true);t.classed("hasTitle",function(t){return e.getTitle(t,r(this,e))?true:false}).attr("d",function(t){return e.getD(t,r(this,e))}).attr("transform",function(t){return e.getTransform(t,r(this,e))}).attr("filter",function(t){return e.getFilter(t,r(this,e))}).attr("aria-label",function(t){return e.getAriaLabel(t,r(this,e))}).each(function(t){a=e.getStyle(t,r(this,e));d3.select(this).style(a)});t.exit().remove()};s.prototype._drawClipPath=function(t,e){var r=this._findObjectInfo;t.enter().append("defs").classed(e.getId(),true);t.selectAll("clipPath").remove();t.append("clipPath").attr("id",function(t){return e.getHtmlClass(t,r(this,e))}).append("path").attr("d",function(t){return e.getPaths()[0].getD(t,r(this,e))});t.exit().remove()};s.prototype._drawImage=function(t,e){var r=this._findObjectInfo;t.enter().append("image").classed(e.getId(),true);t.classed("hasTitle",function(t){return e.getTitle(t,r(this,e))?true:false}).attr("xlink:href",function(t){return e.getImage(t,r(this,e))}).attr("x",function(t){return e.getX(t,r(this,e))}).attr("y",function(t){return e.getY(t,r(this,e))}).attr("width",function(t){return e.getWidth(t,r(this,e))}).attr("height",function(t){return e.getHeight(t,r(this,e))}).attr("filter",function(t){return e.getFilter(t,r(this,e))}).attr("transform",function(t){return e.getTransform(t,r(this,e))}).attr("aria-label",function(t){return e.getAriaLabel(t,r(this,e))});t.exit().remove()};s.prototype._drawPolygon=function(t,e){var r=this._findObjectInfo;var a={};t.enter().append("polygon").classed(e.getId(),true);t.classed("hasTitle",function(t){return e.getTitle(t,r(this,e))?true:false}).attr("points",function(t){return e.getPoints(t,r(this,e))}).attr("filter",function(t){return e.getFilter(t,r(this,e))}).attr("transform",function(t){return e.getTransform(t,r(this,e))}).attr("aria-label",function(t){return e.getAriaLabel(t,r(this,e))}).each(function(t){a=e.getStyle(t,r(this,e));d3.select(this).style(a)});t.exit().remove()};s.prototype._drawPolyline=function(t,e){var r=this._findObjectInfo;var a={};t.enter().append("polyline").classed(e.getId(),true);t.classed("hasTitle",function(t){return e.getTitle(t,r(this,e))?true:false}).attr("points",function(t){return e.getPoints(t,r(this,e))}).attr("filter",function(t){return e.getFilter(t,r(this,e))}).attr("transform",function(t){return e.getTransform(t,r(this,e))}).attr("aria-label",function(t){return e.getAriaLabel(t,r(this,e))}).each(function(t){a=e.getStyle(t,r(this,e));d3.select(this).style(a)});t.exit().remove()};s.prototype._drawCircle=function(t,e){var r=this._findObjectInfo;var a={};t.enter().append("circle").classed(e.getId(),true);t.classed("hasTitle",function(t){return e.getTitle(t,r(this,e))?true:false}).attr("filter",function(t){return e.getFilter(t,r(this,e))}).attr("transform",function(t){return e.getTransform(t,r(this,e))}).attr("aria-label",function(t){return e.getAriaLabel(t,r(this,e))}).attr("cx",function(t){return e.getCx(t,r(this,e))}).attr("cy",function(t){return e.getCy(t,r(this,e))}).attr("r",function(t){return e.getR(t,r(this,e))}).each(function(t){a=e.getStyle(t,r(this,e));d3.select(this).style(a)});t.exit().remove()};s.prototype._drawDefinitions=function(t,e){var r=this._findObjectInfo;t.enter().append("defs").classed(e.getId(),true);t.each(function(t,a){jQuery(this).empty();var i=e.getContent(t,r(this));var n="<svg xmlns='"+d3.ns.prefix.svg+"'>"+i+"</svg>";this.appendChild(jQuery(n)[0].firstChild)});t.exit().remove()};s.prototype._drawInsertTitle=function(t,e){var r=this._findObjectInfo;var a=t.selectAll("."+e.getId()+".hasTitle");a.select("title").remove();a.insert("title",":first-child").each(function(t){var a=d3.select(this);a.selectAll("tspan").remove();a.text(e.getTitle(t,r(this,e)))})};s.prototype._findObjectInfo=function(t,e,r){var a=t;while(!a.__data__.objectInfoRef){a=a.parentNode}return a.__data__.objectInfoRef};s.prototype.addDataAttributes=function(t){t.attr("data-sap-gantt-shape-id",function(t){return t.__id__})};s.prototype.destroySvg=function(t,e){};return s},true);
//# sourceMappingURL=ShapeInRow.js.map