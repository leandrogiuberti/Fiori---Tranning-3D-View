/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["./GanttUtils","sap/gantt/misc/Format","sap/gantt/misc/Utility","sap/gantt/simple/AggregationUtils","sap/ui/core/Element","sap/ui/core/Lib"],function(e,t,a,s,i,n){"use strict";var l=n.getResourceBundleFor("sap.gantt");var o={scrollToShape:function(n,l){var o=this;var h=null,r=[],g;function d(e,t,a,s){if(!e||e.isA("sap.gantt.simple.Relationship")){return}if(e.isA("sap.gantt.simple.BaseConditionalShape")){e=e._getActiveShapeElement()}if(e.isPseudoShape){var i=e.aShapeIds;var n=t.getTable().getRows();var l=e.getParentRowSettings().getParent().getIndex()-n[0].getIndex();var h=n[l];t.oOverlapShapeIds=t.oOverlapShapeIds?t.oOverlapShapeIds:{};var r=t.oOverlapShapeIds[h.getIndex()]?t.oOverlapShapeIds[h.getIndex()]:[];var g=i.length>0&&(r.length==0||r.indexOf(i[0])==-1);if(g){for(var c=0;c<i.length&&!o._oFoundShape;c++){if(i[c]===a.shapeID[0]){o._bExpandPseudoShape=true;o._oFoundShape=e}}}}if(e&&e.getShapeId&&((e.getShapeId()===a.shapeID[0]||s===a.shapeID[0])&&e.getTime())){o._oFoundShape=e;t.getParent().fireSearchSelectionChanged({shape:e,rowIndex:o.shapeInRowIndex})}else if(e instanceof sap.gantt.simple.BaseGroup&&!o._oFoundShape){if(t.getSelectOnlyGraphicalShape()){e._eachChildOfGroup(e,function(s,i){i&&i.forEach(function(s){if(!o._oFoundShape){d(s,t,a,e.getShapeId())}})})}else{e._eachChildOfGroup(e,function(s){if(!o._oFoundShape){d(s,t,a,e.getShapeId())}})}}}function c(){o._oFoundShape=null;o._bExpandPseudoShape=false;var e=i.getElementById(g.parentElement.id);if(e){o.shapeInRowIndex=e.getParent().getIndex();var t=s.getAllNonLazyAggregations(e);var a=Object.keys(t).filter(function(e){return e.indexOf("calendars")===-1&&e!=="relationships"}).map(function(t){return e.getAggregation(t)||[]});a.forEach(function(e){if(e&&e.length>0&&!o._oFoundShape){var t=0;while(t<e.length&&!o._oFoundShape){d(e[t],l,n);t++}}})}}function u(){var s=o._oFoundShape&&o._oFoundShape.getTime()||n.startTime;l.jumpToPosition(t.abapTimestampToDate(s));e.getShapeByShapeId(l.getId(),n.shapeID).forEach(function(e){if(!h){h=a.parseUid(e.getShapeUid());if(o.rowIndex!==parseInt(h.rowIndex)){o.rowIndex=parseInt(h.rowIndex);if(l&&l.getEnablePseudoShapes&&l.getEnablePseudoShapes()){if(!l.pseudoShapeSpecificData){l.pseudoShapeSpecificData={}}l.pseudoShapeSpecificData.needUpdateForTasksInAggr=true}l.getTable().setFirstVisibleRow(o.rowIndex)}}if(e.getHighlightable()){o.isShapeHighlightable=true;r.push({ShapeId:e.getShapeId(),Highlighted:true})}else{o.isShapeHighlightable=false;r.push({ShapeId:e.getShapeId(),Selected:true})}});if(o.isShapeHighlightable){l.oHighlight.clearAllHighlightedShapeIds();l.oHighlight.updateHighlightedShapes(r)}else{l.oSelection.clearAllSelectedShapeIds();l.oSelection.updateSelectedShapes(r,null,l.getId())}}var p=document.getElementById(l.getId());g=p?p.querySelector("[data-sap-gantt-row-id="+"'"+n.rowID+"'"+"]"):document.querySelector("[data-sap-gantt-row-id="+"'"+n.rowID+"'"+"]");if(g){c();if(this._bExpandPseudoShape){this._oFoundShape.onclick();l.getInnerGantt().resolveWhenReady(true).then(function(){c();u()})}else{u()}}else{var S=l.getTable(),f=S.isA("sap.ui.table.TreeTable")?S.getBinding().getNodes(0,l._iNodesLength,0):S.getBinding().getContexts(0,l._iNodesLength,0),I=function(){var e=p?p.querySelector("[data-sap-gantt-row-id='"+n.rowID+"']"):document.querySelector("[data-sap-gantt-row-id='"+n.rowID+"']");if(e){clearInterval(this.setTime);this.setTime=null;this.scrollToShape(n,l)}};for(var _=0;_<f.length;_++){var m=l._getRowIdPath();var v=(f[_].context||f[_]).getObject()[m];if(v===n.rowID){this.rowIndex=_;S.setFirstVisibleRow(_);this.setTime=setInterval(I.bind(this),100);break}}}},navigateToSearchResult:function(e,t){if(t.isA("sap.gantt.simple.GanttSearchSidePanel")){t._oSearchSidePanel.getItems()[3].getContent()[0].setSelectedItem("listItem"+this._selectedIndex);t._oSearchSidePanel.getItems()[3].getContent()[0].getSelectedItem().focus()}this.updateShapeSelectionANDHighlight(e,this.previousGanttID);var a=this._ganttSearchResults[this._selectedIndex],s=null;if(a){if(this.previousGanttID!==a.ganttID){this.previousGanttID=a.ganttID;s=e[this.previousGanttID]}else{s=e[this.previousGanttID]}if(t.isA("sap.gantt.simple.GanttSearchSidePanel")){t.setContainerHeight()}this.scrollToShape(a,s);if(!t.isA("sap.gantt.simple.GanttSearchSidePanel")){this.toggleNavigationState(t._searchFlexBox.getItems()[1],t._searchFlexBox.getItems()[3])}else{this.toggleNavigationState(t._oSearchSidePanel.getItems()[2].getContent()[0].getItems()[1].getItems()[0],t._oSearchSidePanel.getItems()[2].getContent()[0].getItems()[1].getItems()[1],true)}}},updateShapeSelectionANDHighlight:function(e,t){if(e.length>0){var a=e[t]?e[t]:e[0];if(this.isShapeHighlightable){var s=a.getHighlight();s.clearAllHighlightedShapeIds();s.updateShape(null,{highlighted:false,ctrl:false})}else{var i=a.getSelection();i.clearAllSelectedShapeIds();i.updateShape(null,{selected:false,ctrl:false})}}},triggerSearchEvent:function(e,t,a,s,i){var n=t[0].getParent();this._bEnableAutoSelectOnFind=n.getEnableAutoSelectOnFind();var h=function(){var l=[],h,r;t.forEach(function(t,a){var s=t.getFindBy(),i=t._getRowIdPath();l=t.findAll(e,s);l.forEach(function(e){e.ganttID=a;this.aSearchData.push(e)}.bind(this));var n=t.getTable().getBinding().getNodes&&t.getTable().getBinding().getNodes(0,t._iNodesLength,0)||t.getTable().getBinding().getContexts&&t.getTable().getBinding().getContexts(0,t._iNodesLength,0),o=[],g=Object.keys(t._oExpandModel.mExpanded),d=false,c=false,u=function(e,a){if(a.includes(e)){d=true;if(t._oExpandModel.mExpanded[a].length<=1){c=true}}};h=t.getTable().isA("sap.ui.table.TreeTable")?false:true;for(var p=0;p<n.length;p++){for(var S=0;S<l.length;S++){r=h||n[p].nodeState;if(r&&(n[p].context||n[p]).getObject()[i]===l[S].rowID){var f="PATH:"+l[S].rowID+"|SCHEME:"+t.getPrimaryShapeScheme().getKey();d=false;g.forEach(u.bind(null,f));if(d){if(l[S].isExpandable){if(l[S].hasOwnProperty("isParent")){if(l[S].isParent||c||t.getUseParentShapeOnExpand()){o.push(l[S])}}else if(!t.getUseParentShapeOnExpand()){o.push(l[S])}}}else if(l[S].hasOwnProperty("isParent")){o.push(l[S])}}}}this._ganttSearchResults=this._ganttSearchResults.concat(o)}.bind(this));n.setProperty("customSearchResults",this._ganttSearchResults,true);n.fireCustomGanttSearchResult({searchResults:this._ganttSearchResults});this._ganttSearchResults=n.getCustomSearchResults();if(a){if(i.list){i.list.destroyItems()}i.getParent().fireGanttSearchSidePanelList({searchResults:this._ganttSearchResults});i._updateContent()}n.setBusy(false);this._searchResultsCount=this._ganttSearchResults.length;for(var g=0;g<this._ganttSearchResults.length;g++){if(document.querySelector("[data-sap-gantt-shape-id='"+this._ganttSearchResults[g].shapeID[0]+"']")){this._selectedIndex=g;break}}if(this._selectedIndex<0){this._selectedIndex=0}var d=a&&i._oSearchSidePanel.getItems()[3].getContent()[0];if(a&&this._bEnableAutoSelectOnFind&&d.getItems().length){d.setSelectedItem("listItem"+this._selectedIndex);if(d.getSelectedItem()){setTimeout(function(){d.getSelectedItem().focus()},0)}}if(!n._bPreventShapeScroll){this.updateShapeSelectionANDHighlight(t,this.previousGanttID)}var c=this._ganttSearchResults[this._selectedIndex],u=null;if(c){s._searchFlexBox.getItems()[2].setText("("+(this._selectedIndex+1)+"/"+this._searchResultsCount+")");if(this.previousGanttID!==c.ganttID){this.previousGanttID=c.ganttID;u=t[this.previousGanttID]}else{u=t[this.previousGanttID]}if(!n._bPreventShapeScroll&&this._bEnableAutoSelectOnFind){o.scrollToShape(c,u)}this._toggleNavigationStateUtil(a,s,i,true)}else{if(a){i.setEmptyListInfo(false)}this._toggleNavigationStateUtil(a,s,i,true)}n._bPreventShapeScroll=false}.bind(this);this._ganttSearchResults=[];this._selectedIndex=0;this._searchResultsCount=0;s._searchFlexBox.getItems()[0].setValue(e);s._searchFlexBox.getItems()[2].setText(l.getText("GNT_EMPTY_RESULT_INFO_TOOLBAR"));if(e){this.aSearchData=[];n.setBusyIndicatorDelay(0);n.setBusy(true);setTimeout(function(){h()},n.getBusyIndicatorDelay())}else{if(!n._bPreventShapeScroll){this.updateShapeSelectionANDHighlight(t,this.previousGanttID)}if(a){i._updateContent();i.setEmptyListInfo(true)}this._toggleNavigationStateUtil(a,s,i,true);n._bPreventShapeScroll=false}if(!a||!this._bEnableAutoSelectOnFind){setTimeout(function(){var e=a?i._oSearchSidePanel.getItems()[2].getContent()[0].getItems()[1].getItems()[1]:s._searchFlexBox.getItems()[3];var t=a?i._oSearchSidePanel.getItems()[2].getContent()[0].getItems()[1].getItems()[0]:s._searchFlexBox.getItems()[1];if(e.getEnabled()){e.focus()}else if(t.getEnabled()){t.focus()}},0)}},_toggleNavigationStateUtil:function(e,t,a,s){if(!e){this.toggleNavigationState(t._searchFlexBox.getItems()[1],t._searchFlexBox.getItems()[3],null,null,s)}else{this.toggleNavigationState(a._oSearchSidePanel.getItems()[2].getContent()[0].getItems()[1].getItems()[0],a._oSearchSidePanel.getItems()[2].getContent()[0].getItems()[1].getItems()[1],true,null,s)}},toggleNavigationState:function(e,t,a,s,i){var n;if(this._selectedIndex===0&&this._searchResultsCount>1){e.setEnabled(false);t.setEnabled(true);if(!a||i){n=t}}else if(this._selectedIndex===this._searchResultsCount-1&&this._selectedIndex>0){t.setEnabled(false);e.setEnabled(true);if(!a||i){n=e}}else if(this._selectedIndex===0&&this._searchResultsCount===0||this._selectedIndex===this._searchResultsCount-1){e.setEnabled(false);t.setEnabled(false)}else{e.setEnabled(true);t.setEnabled(true);if(s||i){n=t}}if(n&&(!a||!this._bEnableAutoSelectOnFind)){setTimeout(function(){n.focus()},0)}},updateToolbarItems:function(e,t,a){var s=e.getAllToolbarItems(),i=false,n=-1;s.forEach(function(e,a){if(e.isA("sap.m.ToolbarSpacer")){n=a}if(e.getId().includes("findAndSelectSearchButton")){e.setVisible(!t)}if(e.getId().includes("findAndSelectFlexBox")){i=true;e.setVisible(t)}});if(!i){if(n>-1){e.insertContent(e._searchFlexBox,n+1)}else{e.insertContent(e._searchFlexBox,1)}}setTimeout(function(){var s=e._searchFlexBox.getItems()[0];if(a&&this._searchResultsCount>1){this.toggleNavigationState(e._searchFlexBox.getItems()[1],e._searchFlexBox.getItems()[3],false,true)}else if(s.getDomRef()){var i=s.getValue().length;var n=s.getDomRef().getElementsByTagName("input")[0];s.focus();var l=a?i:0;n.setSelectionRange(l,i)}else if(!t){var o=e._oSearchButton.getDomRef();if(o){o.focus()}}}.bind(this),0)}};return o});
//# sourceMappingURL=FindAndSelectUtils.js.map