/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/events/KeyCodes","sap/ui/core/Core","sap/gantt/misc/Utility","./GanttExtension","./GanttUtils","./CoordinateUtils","sap/gantt/library","sap/gantt/utils/GanttChartConfigurationUtils","sap/ui/core/Lib"],function(jQuery,t,e,o,i,n,s,r,a,p){"use strict";var v=".sapGanttPopover";var h="mousedown";var g=h+v;var f=["mousemove","mouseup","keydown"];var u=f.reduce(function(t,e){t[e]=e;return t},{});var d=f.map(function(t){return t+v});var c={dispatchEvent:function(t){var e=this._getPopoverExtension();if(t.type===u.mousemove){e.onMouseMove(t)}else if(t.type===u.mouseup){e.onMouseUp(t)}else if(t.type===u.keydown){e.onKeydown(t)}},entry:function(t){var e=this._getPopoverExtension();e.onMouseDown(t)},addEventListeners:function(t){this.removeEventListeners(t);var e=jQuery(t._getPopoverExtension().getDomRefs().ganttSvg);e.on(g,c.entry.bind(t))},removeEventListeners:function(t){var e=jQuery(t._getPopoverExtension().getDomRefs().ganttSvg);e.off(g)},addPopoverEventListeners:function(t){this.removePopoverEventListeners(t);d.forEach(function(e){jQuery(document).on(e,c.dispatchEvent.bind(t))})},removePopoverEventListeners:function(t){jQuery(document).off(v)}};var l=r.dragdrop.SnapMode;var m=i.extend("sap.gantt.simple.GanttPopoverExtension",{_init:function(t,e){this._initPopoverStates();return"PopoverExtension"},_attachEvents:function(){var t=this.getGantt();c.addEventListeners(t)},_detachEvents:function(){var t=this.getGantt();c.removeEventListeners(t)}});m.prototype._initPopoverStates=function(){this._iOffsetX=10;this._iOffsetY=32;this._bNeedReverse=false;this.snapTimer=null};m.prototype.onMouseMove=function(t){var e=this.getGantt()._getDragDropExtension();if(this.getGantt().getShowShapeTimeOnDrag()&&this.isDraggingOrResizing(t)){if(this.getGantt().getSnapMode()!==l.None){this._showPopoverOnSnap(t,true)}else{this._showPopover(t,true)}}else if(e.isDragging()&&this.bMultipleShapes){if(this.getGantt().getSnapMode()!==l.None){this._showPopoverOnSnap(t)}else{this._showPopover(t)}}};m.prototype._showPopoverOnSnap=function(t,e){if(this.snapTimer){window.clearTimeout(this.snapTimer);this.snapTimer=null}this.snapTimer=window.setTimeout(function(){this._showPopover(t,e)}.bind(this),100)};m.prototype.onMouseDown=function(t){var e=this.getGantt().getSelection();var o=e.numberOfSelectedDraggableShapes();this.bMultipleShapes=this.getGantt().getEnableMultipleGhosts()&&o>1;this.pageWidth=window.innerWidth;this.pageHeight=window.innerHeight;c.addPopoverEventListeners(this.getGantt())};m.prototype.onMouseUp=function(t){c.removePopoverEventListeners(this.getGantt());this._hidePopover(t);this._initPopoverStates()};m.prototype.onKeydown=function(e){if(e.keyCode===t.ESCAPE){c.removePopoverEventListeners(this.getGantt());this._hidePopover(e);this._initPopoverStates()}};m.prototype.isDraggingOrResizing=function(t){var e=this.getGantt()._getDragDropExtension();var o=this.getGantt()._getResizeExtension();return e.isDragging()&&!this.bMultipleShapes||o.isResizing()};m.prototype._buildPopover=function(t,e){var o=p.getResourceBundleFor("sap.gantt");var i=o.getText("GNT_CURRENT_START");var n=o.getText("GNT_CURRENT_END");var s=this.getGantt()._getDragDropExtension();var r=s.getNumberOfDragObject();var a=function(t,e){var o="<span class='sapUiTinyMarginEnd sapMLabel'>"+t+"</span>"+"<span class='sapMLabel "+e+"'></span>";return"<div class='sapUiTinyMargin'>"+o+"</div>"};var v=function(t,e){var o="<span class='sapMLabel "+e+"'>"+t+"</span>";return"<div class='sapUiTinyMargin sapGanttPopoverCountText'>"+o+"</div>"};if(e){this.oTimePopover=jQuery("<div id='sapGanttPopoverWrapper' class='sapGanttDragElementHidden'>"+a(i,"sapGanttPopoverStartTime")+a(n,"sapGanttPopoverEndTime")+"</div>")}else{this.oCountPopover=jQuery("<div id='sapGanttPopoverWrapper' class='sapGanttDragElementHidden'>"+v(r,"sapGanttPopoverObjectCount")+"</div>")}this.createAnchor();this._calcPopoverOffset();var h=jQuery(document.getElementById("sapGanttPopoverAnchor"));if(e){h.append(this.oTimePopover)}else{h.append(this.oCountPopover)}var g=this._getPopoverData(t,e);this._updateTime(g,e)};m.prototype._updateTime=function(t,e){var o=a.getRTL();var i=o?"marginRight":"marginLeft";var n={marginTop:t.offsetY+"px"};n[i]=t.offsetX+"px";var s=jQuery(document.getElementById("sapGanttPopoverWrapper")).css(n);if(e){s.find(".sapGanttPopoverStartTime").text(t.startNewDate);s.find(".sapGanttPopoverEndTime").text(t.endNewDate)}};m.prototype._getDragDropOrResizingDom=function(){var t=this.getGantt()._getDragDropExtension();var e=this.getGantt()._getResizeExtension();if(t.isDragging()){return t.dragGhost.get(0).children[0]}else if(e.isResizing()){var o=n.getShapesWithUid(this.getGantt().getId(),[e.origin.resizeFor]);if(o.length===1&&o[0]){return document.getElementById(o[0].getShapeUid()+"-selected")}}};m.prototype.createAnchor=function(t){var e=jQuery(document.getElementById("sapGanttPopoverAnchor"));if(e.length===0){e=jQuery("<div id='sapGanttPopoverAnchor'></div>");jQuery(document.body).append(e)}this._oTargetDom=e.get(0)};m.prototype.moveAnchor=function(t,e){var o=s.getEventPosition(t),i=o.pageX,n=o.pageY,r=this.pageWidth,a=this.pageHeight;if(i<-this._iOffsetX){i=-this._iOffsetX}else if(i>r+this._iOffsetX){i=r+this._iOffsetX}var p=this._iOffsetY;if(e&&this.oTimePopover){p+=this.oTimePopover.height()}else if(!e&&this.oCountPopover){p+=this.oCountPopover.height()}if(n<-this._iOffsetY){n=-this._iOffsetY}else if(n>a-p){n=a-p}var v=document.getElementById("sapGanttPopoverAnchor");if(v){v.style.left=i+"px";v.style.top=n+"px"}};m.prototype.checkIfNeedReverse=function(t,e){var o=a.getRTL();var i=s.getEventPosition(t);var n=e?this.oTimePopover.width()+10:this.oCountPopover.width()+10;if(o&&i.pageX<n||!o&&i.pageX+n>=this.pageWidth||this.getGantt().getGhostAlignment()!=="End"&&this.bMultipleShapes){this._bNeedReverse=true}else{this._bNeedReverse=false}};m.prototype._showPopover=function(t,e){this.moveAnchor(t,e);if(e&&this.oTimePopover||!e&&this.oCountPopover){document.getElementById("sapGanttPopoverWrapper").classList.remove("sapGanttDragElementHidden");this.checkIfNeedReverse(t,e);this._calcPopoverOffset();var o=this._getPopoverData(t,e);this._updateTime(o,e)}else{this._buildPopover(t,e)}};m.prototype._hidePopover=function(){var t=document.getElementById("sapGanttPopoverAnchor");if(t){t.parentNode.removeChild(t)}this.oTimePopover=null;this.oCountPopover=null};m.prototype._getPopoverData=function(t,e){var i=this._iOffsetX;if(this._bNeedReverse){i=e?-i-this.oTimePopover.width():-i-this.oCountPopover.width()}var s={offsetX:i,offsetY:this._iOffsetY};if(e){var r=this._getCurrentTime(t);if(r){var a=this.getGantt().getLocale();var p=n.getTimeFormaterBySmallInterval(this.getGantt());s.startNewDate=o.getLowerCaseLabel(a.getFormattedDate(p,r.time));s.endNewDate=o.getLowerCaseLabel(a.getFormattedDate(p,r.endTime))}}return s};m.prototype._getCurrentTime=function(t){var e=this.getGantt()._getDragDropExtension();var o=this.getGantt()._getResizeExtension();if(e.isDragging()){return e._getGhostTime(t,true)}else if(o.isResizing()){return o._getResizeTime(t)}};m.prototype._calcPopoverOffset=function(){this._iOffsetY=this._getOffsetY()};m.prototype._getOffsetY=function(){var t=this._getDragDropOrResizingDom();var e=t&&t.getBoundingClientRect();var o=32;if(e){o=e.height+2}return Math.ceil(o)};m.prototype._updatePopoverWhenAutoScroll=function(t){if(this.getGantt().getShowShapeTimeOnDrag()&&this.isDraggingOrResizing()){this._showPopover(t,true)}};return m});
//# sourceMappingURL=GanttPopoverExtension.js.map