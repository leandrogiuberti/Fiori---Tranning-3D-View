/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/events/KeyCodes","sap/ui/core/Core","sap/gantt/library","./GanttExtension","./CoordinateUtils","./GanttUtils","sap/gantt/misc/Utility","sap/gantt/utils/GanttChartConfigurationUtils"],function(jQuery,t,e,n,o,a,i,s,r){"use strict";var h=".sapGanttShapeConnect";var c=n.simple.RelationshipType;var p={addEventListeners:function(t){this.removeEventListeners(t);var e=t._getConnectExtension();e.shapeConnectDoms().shapeConnectTriggers.on("mousedown"+h,e.beforeShapeConnect.bind(e))},removeEventListeners:function(t){var e=t._getConnectExtension();e.shapeConnectDoms().shapeConnectTriggers.off(h)},addShapeConnectEventListeners:function(t){this.removeShapeConnectEventListeners(t);var e=t._getConnectExtension();var n=jQuery(document);n.on("mousemove"+h,e.onMousemove.bind(e));n.on("mouseup"+h,e.endShapeConnect.bind(e));n.on("keydown"+h,e.onKeydown.bind(e))},removeShapeConnectEventListeners:function(t){jQuery(document).off(h)}};var g=o.extend("sap.gantt.simple.GanttConnectExtension",{_init:function(t,e){this._initShapeConnectStates();return"ConnectExtension"}});g.prototype.attachShapeConnectEvents=function(){var t=this.getGantt();p.addEventListeners(t);if(this.isShapeConnecting()){p.addShapeConnectEventListeners(t)}};g.prototype._initShapeConnectStates=function(){this.mDom={};this._oStartShape={};this._bShapeConnecting=false;this._oScrollDistance={x:0,y:0};this._bElementConnectable=false};g.prototype.getRlsStartShape=function(){return this._oStartShape};g.prototype.getSvgElement=function(){return this.getDomRefs().ganttSvg};g.prototype._getShapeConnectRootNode=function(){var t=this.shapeConnectDoms().shapeConnect;return d3.select(t.get(0))};g.prototype.setDomSelector=function(){var t=this.shapeConnectDoms();this.mDom.connectLine=t.connectLine;this.mDom.ghostRect=t.shapeConnectGhost};g.prototype.createConnectLine=function(t,e){var n=this.getGantt()._getPointerExtension();var o=e.x+n._getAutoScrollStep();var a={class:"shapeConnectLine",x1:t.x+t.width/2,y1:t.y+t.width/2,x2:o,y2:e.y};if(this.getD3Doms().shapeConnectLine.empty()){var i=this._getShapeConnectRootNode();i.append("line").attr(a)}};g.prototype.createGhostRect=function(t,e){var n=this.getGantt()._getPointerExtension();var o=t.x+n._getAutoScrollStep();var a={class:"shapeConnectGhost",x:o-t.width/2,y:e.y-t.width/2,width:t.width,height:t.width};if(this.getD3Doms().shapeConnectGhost.empty()){var i=this._getShapeConnectRootNode();i.append("rect").attr(a)}};g.prototype.isShapeConnecting=function(){return this._bShapeConnecting};g.prototype.updateShapeConnectEffect=function(t){if(this.isShapeConnecting()){var e=a.getLatestCursorPosition();var n=this.getStartShapeFrame();var o=this.getSvgElement();var i=a.getEventSVGPoint(o,e);this.createConnectLine(n,i);this.createGhostRect(n,i);this.showIndicator();this.setDomSelector();this.attachShapeConnectEvents()}};g.prototype.beforeShapeConnect=function(t){var e=jQuery(t.target);var n=e.parents("g").attr(i.SELECT_FOR_DATASET_KEY);this._bElementConnectable=true;var o=r.getRTL();var a=t.target.getBBox();var s;if(o){s=e.hasClass("rightTrigger")?"Start":"Finish"}else{s=e.hasClass("leftTrigger")?"Start":"Finish"}this._oScrollDistance={x:0,y:0};this._oStartShape={startTriggerFrame:a,x:a.x+a.width/2,y:a.y+a.width/2,shapeUid:n,isRightTrigger:e.hasClass("rightTrigger"),startPoint:s};p.addShapeConnectEventListeners(this.getGantt())};g.prototype.toggleShapeConnectTrigger=function(){var t=this.getGantt();t._updateShapeSelections(t.getSelectedShapeUid(),[])};g.prototype.getStartShapeFrame=function(){var t={x:0,y:0,width:i.SHAPE_CONNECT_INDICATOR_WIDTH};if(this.isShapeConnecting()){var e=this.shapeConnectDoms().startShapeConnectTrigger;if(e&&e.length===1){return e.get(0).getBBox()}else{t.x=this._oStartShape.x-this._oScrollDistance.x;t.y=this._oStartShape.y-this._oScrollDistance.y}}return t};g.prototype._getAcceptableShapeElements=function(){var t=[];var e=this;this.shapeConnectDoms().connectableShapes.each(function(n,o){var a=jQuery(o).control(0,true);if(a&&e._oStartShape.shapeUid!==a.getShapeUid()&&a.getDomRef()){t.push(a)}});return t};g.prototype.showIndicator=function(){if(!this.isShapeConnecting()){return}var t=[];var e=this;this._getAcceptableShapeElements().forEach(function(n){t.push(e._getIndicatorData(n))});this.getD3Doms().shapeConnectContainers.data(t).enter().append("g").classed("shapeConnectContainer",true).attr("id",function(t){return t.id+"-shape-connect"}).attr(i.SHAPE_CONNECT_FOR_DATASET_KEY,function(t){return t.id}).each(function(t){var e=d3.select(this);e.append("rect").attr(t.left);e.append("rect").attr(t.right)});this.attachEventHandlerToIndicator()};g.prototype.onMousemove=function(t){if(this._bElementConnectable===false){return}if(!this.isShapeConnecting()){this._bShapeConnecting=true;var e=this.getSvgElement();var n=a.getEventSVGPoint(e,t);this.createConnectLine(this._oStartShape.startTriggerFrame,n);this.createGhostRect(this._oStartShape.startTriggerFrame,n);this.showIndicator();this.toggleShapeConnectTrigger();this.setDomSelector()}else{this.onShapeConnecting(t)}};g.prototype.onShapeConnecting=function(t){var e=this.getSvgElement();var n=a.getEventSVGPoint(e,t);var o=this.getGantt()._getPointerExtension();var s=n.x+o._getAutoScrollStep();this.mDom.connectLine.attr({x2:s,y2:n.y});var r=i.SHAPE_CONNECT_INDICATOR_WIDTH;this.mDom.ghostRect.attr({x:s-r/2,y:n.y-r/2})};g.prototype.fireEvent=function(t){var e=jQuery(t.target);var n=e.parents("g").attr(i.SHAPE_CONNECT_FOR_DATASET_KEY);var o=r.getRTL();var a=(o?e.hasClass("rightIndicator"):e.hasClass("leftIndicator"))?"Start":"Finish";var s=this._oStartShape.startPoint+"To"+a;var h={fromShapeUid:this._oStartShape.shapeUid,toShapeUid:jQuery(document.getElementById(n)).control(0).getShapeUid(),type:c[s]};var p=this.getGantt();p.fireShapeConnect(h)};g.prototype.endShapeConnect=function(t){if(this.isShapeConnecting()){var e=this._getShapeConnectRootNode();e.selectAll("*").remove()}p.removeShapeConnectEventListeners(this.getGantt());this._initShapeConnectStates();this.toggleShapeConnectTrigger()};g.prototype.onKeydown=function(e){if(this.isShapeConnecting()&&e.keyCode===t.ESCAPE){this.endShapeConnect(e)}};g.prototype.toggleGhostRect=function(t){if(this.isShapeConnecting()){this.shapeConnectDoms().shapeConnectGhost.toggleClass("hideShapeConnectGhost");jQuery(t.target).toggleClass("hoverOnShapeConnectIndicator")}};g.prototype.attachEventHandlerToIndicator=function(){var t=this.shapeConnectDoms().indicators;t.off(h);t.on("mouseup"+h,this.fireEvent.bind(this));t.on("mouseover"+h+" mouseout"+h,this.toggleGhostRect.bind(this))};g.prototype._getIndicatorData=function(t){var e=t.getId();var n=t.getDomRef("nonLabelGroup")?t.getDomRef("nonLabelGroup").getBBox():t.getDomRef().getBBox();var o=t.getLeftAnchorPosition()/100;var a=t.getRightAnchorPosition()/100;var r=n.x,h=n.y,c=n.width,p=n.height,g=false;if(t instanceof sap.gantt.simple.BaseGroup){var S=0,C;C=window.getComputedStyle(t.getDomRef()).transform.match(/matrix.*\((.+)\)/);if(C){S=C[1].split(",")[5];g=true}h=n.y+parseFloat(S)}var l=i.SHAPE_CONNECT_INDICATOR_WIDTH-2;var d=2;var v=s.getShapeBias(t);var f=r-d-l+v.x,u=g?h+p*o-l/2:h+p*o-l/2+v.y;var m=r+c+d+v.x,_=g?h+p*a-l/2:h+p*a-l/2+v.y;var E={width:l,height:l};return{id:e,left:jQuery.extend({x:f,y:u,class:"leftIndicator shapeConnectIndicator"},E),right:jQuery.extend({x:m,y:_,class:"rightIndicator shapeConnectIndicator"},E)}};g.prototype.storeScrollDistance=function(t,e){if(e){this._oScrollDistance.x+=t}else{this._oScrollDistance.y+=t}};g.prototype.shapeConnectDoms=function(){var t=jQuery(this.getSvgElement());var e="g["+i.SELECT_FOR_DATASET_KEY+'="'+this._oStartShape.shapeUid+'"]';var n=".shapeConnectTrigger."+(this._oStartShape.isRightTrigger?"rightTrigger":"leftTrigger");var o=t.find("g.sapGanttChartShapeConnect");var a=t.find("g.sapGanttChartSelection");return{shapeConnect:o,indicators:o.find(".shapeConnectContainer .shapeConnectIndicator"),shapeConnectGhost:o.find(".shapeConnectGhost"),connectLine:o.find(".shapeConnectLine"),connectableShapes:t.find("["+i.CONNECTABLE_DATASET_KEY+"=true]"),shapeConnectTriggers:a.find(".shapeConnectTrigger"),startShapeConnectTrigger:a.find(e+" "+n)}};g.prototype.getD3Doms=function(){var t=this._getShapeConnectRootNode();return{shapeConnectLine:t.selectAll(".shapeConnectLine"),shapeConnectGhost:t.selectAll(".shapeConnectGhost"),shapeConnectContainers:t.selectAll(".shapeConnectContainer")}};return g});
//# sourceMappingURL=GanttConnectExtension.js.map