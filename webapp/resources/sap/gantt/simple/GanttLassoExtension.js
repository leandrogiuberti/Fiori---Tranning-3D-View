/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/events/KeyCodes","./GanttExtension","./CoordinateUtils","sap/gantt/misc/Utility","sap/ui/core/theming/Parameters"],function(jQuery,t,e,s,a,o){"use strict";var n=".sapGanttLasso";var i={addEventListeners:function(t){this.removeEventListeners(t);var e=t._getLassoExtension();e.lassoDoms().rowArea.on("mousedown"+n,e.beforeLasso.bind(e))},removeEventListeners:function(t){var e=t._getLassoExtension();e.lassoDoms().rowArea.off(n)},addLassoEventListeners:function(t){this.removeLassoEventListeners(t);var e=t._getLassoExtension();var s=jQuery(e.getDomRefs().gantt);s.on("mousemove"+n,e.onMousemove.bind(e));s.on("mouseup"+n,e.endLasso.bind(e));s.on("mouseleave"+n,e.endLasso.bind(e));s.on("keydown"+n,e.onKeydown.bind(e))},removeLassoEventListeners:function(t){var e=t._getLassoExtension();jQuery(e.getDomRefs().gantt).off(n)}};var r=e.extend("sap.gantt.simple.GanttLassoExtension",{_init:function(t,e){this._initLassoStates();return"LassoExtension"},_attachEvents:function(){var t=this.getGantt();i.addEventListeners(t)},_detachEvents:function(){var t=this.getGantt();i.removeEventListeners(t)}});r.prototype._initLassoStates=function(){this.mDom={};this._oLassoStartPoint={};this._bLassoDrawing=false};r.prototype.getSvgElement=function(){return this.getDomRefs().ganttSvg};r.prototype._getShapeConnectRootNode=function(){var t=this.lassoDoms().lasso;return d3.select(t.get(0))};r.prototype.rect=function(t,e,s,a){return"M"+[t,e]+" l"+[s,0]+" l"+[0,a]+" l"+[-s,0]+"z"};r.prototype._getLassoData=function(t){var e=this._oLassoStartPoint.x<t.x?this._oLassoStartPoint.x:t.x;var s=this._oLassoStartPoint.x>t.x?this._oLassoStartPoint.x:t.x;var a=this._oLassoStartPoint.y<t.y?this._oLassoStartPoint.y:t.y;var n=this._oLassoStartPoint.y>t.y?this._oLassoStartPoint.y:t.y;var i=o.get({name:["sapChart_Sequence_1_Plus3","sapChart_Sequence_1_Plus1"],callback:function(t){i=t}});var r={class:"lassoRect",d:this.rect(e,a,s-e,n-a),fill:i.sapChart_Sequence_1_Plus3,stroke:i.sapChart_Sequence_1_Plus1,"fill-opacity":.5,"stroke-width":2};return r};r.prototype.createLasso=function(t){var e=this._getLassoData(t);if(this.getD3Doms().lassoRect.empty()){var s=this._getShapeConnectRootNode();s.append("path").attr(e)}};r.prototype.isLassoDrawing=function(){return this._bLassoDrawing};r.prototype.beforeLasso=function(t){var e=this.getGantt();if(t.button!==0||e.getSelection().sSelectionMode!==sap.gantt.SelectionMode.MultiWithKeyboardAndLasso&&e.getSelection().sSelectionMode!==sap.gantt.SelectionMode.MultipleWithLasso){return}var a=this.getSvgElement();var o=s.getEventSVGPoint(a,t);this._oLassoStartPoint={x:o.x,y:o.y};if(e.getSelection().sSelectionMode===sap.gantt.SelectionMode.MultiWithKeyboardAndLasso&&!(t.ctrlKey||t.metaKey)){e._bDeselectShapes=true;e.setSelectedShapeUid([])}else{e._bDeselectShapes=false}i.addLassoEventListeners(e)};r.prototype.onMousemove=function(t){if(!this.isLassoDrawing()){this._bLassoDrawing=true;var e=this.getSvgElement();var a=s.getEventSVGPoint(e,t);this.createLasso(a);this.mDom.lassoRect=this.lassoDoms().lassoRect}else{this.onLassoDrawing(t)}};r.prototype.onLassoDrawing=function(t){var e=this.getSvgElement();var a=s.getEventSVGPoint(e,t);var o=this._getLassoData(a);this.mDom.lassoRect.attr(o)};r.prototype.shapeInLasso=function(t,e,s,a,o,n,i,r){if(t>=o&&t<=n&&s>=i&&s<=r||e>=o&&e<=n&&s>=i&&s<=r||t>=o&&t<=n&&a>=i&&a<=r||e>=o&&e<=n&&a>=i&&a<=r||t<=o&&e>=n&&s>=i&&s<=r||t<=o&&e>=n&&a>=i&&a<=r||t>=o&&t<=n&&a>=r&&s<=i||e>=o&&e<=n&&a>=r&&s<=i){return true}return false};r.prototype.getShapeElementByTarget=function(t,e){return jQuery(e.getDraggableDOMElement(t)).control(0,true)};r.prototype.getDraggableDOMElement=function(t){return jQuery(t).closest("[data-sap-gantt-shape-id]").get(0)};r.prototype.endLasso=function(t){var e=this.getGantt();var o=e._getLassoExtension();if(this.isLassoDrawing()){var n=this._getShapeConnectRootNode();n.selectAll("*").remove()}i.removeLassoEventListeners(this.getGantt());var r=this.getSvgElement();var g=s.getEventSVGPoint(r,t);var h=e._getLassoExtension()._oLassoStartPoint;var p=h.x<g.x?h.x:g.x;var l=h.x>g.x?h.x:g.x;var v=h.y<g.y?h.y:g.y;var c=h.y>g.y?h.y:g.y;var f,u,d,S,L,y,m={x:0,y:0};var _=e.getEnableLassoInvert();var E=e.getSelectedShapeUid();var x=_?[]:E;var D=[];var b=jQuery(r);var P=jQuery(b.find(".sapGanttChartShapes")).find(".baseShapeSelection").toArray();var w=jQuery(b.find(".sapGanttChartRls")).find(".baseShapeSelection").toArray();var R=false;P.forEach(function(t,e){if(!t.classList.contains("sapGanttTextNoPointerEvents")){L=o.getShapeElementByTarget(t,o);if(L){R=L.getSelectable();m=a.getShapeBias(L);var s=t.getAttribute("transform");if(s){var n=s.slice(s.indexOf("(")+1,-1).split(" ");m=n&&n.length?{x:parseFloat(n[0]),y:parseFloat(n[1])}:m}y=L.getShapeUid()?L.getShapeUid():L.getParentRowSettings().getShapeUid(L)}f=t.getBBox().x+m.x;u=f+t.getBBox().width;d=t.getBBox().y+m.y;S=d+t.getBBox().height;var i=o.shapeInLasso(f,u,d,S,p,l,v,c);var r=L?E.indexOf(y):0;var g=r===-1?false:true;if(i){if(L&&R&&!g&&x.indexOf(y)===-1){x.push(y)}else if(_&&L&&R&&g){D.push(y)}}else if(_&&L&&R&&g){x.push(y)}if(L){P[e]=y}}});w.forEach(function(t,e){L=o.getShapeElementByTarget(t,o);if(L){R=L.getSelectable();y=L.getShapeUid()?L.getShapeUid():L.getParentRowSettings().getShapeUid(L)}if(_&&L&&R&&E.indexOf(y)!==-1){x.push(y)}if(L){w[e]=y}});if(_){E.forEach(function(t){if(P.indexOf(t)===-1&&w.indexOf(t)===-1){x.push(t)}})}var G=[];x.forEach(function(t){if(G.indexOf(t)===-1&&D.indexOf(t)===-1){G.push(t)}});this._initLassoStates();if(e.getSelectedShapeUid().toString()===G.toString()){e._bSupressShapeChangeEvent=true}else{e._bSupressShapeChangeEvent=false}e.setSelectedShapeUid(G)};r.prototype.onKeydown=function(e){if(this.isLassoDrawing()&&e.keyCode===t.ESCAPE){this.endLasso(e)}};r.prototype.lassoDoms=function(){var t=jQuery(this.getSvgElement());var e=t.find("g.sapGanttChartLasso");var s=t.find("rect.sapGanttBackgroundSVGRow");return{lassoRect:e.find(".lassoRect"),rowArea:s,lasso:e}};r.prototype.getD3Doms=function(){var t=this._getShapeConnectRootNode();return{lassoRect:t.selectAll(".lassoRect")}};return r});
//# sourceMappingURL=GanttLassoExtension.js.map