/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/Device","sap/ui/core/Core","sap/ui/core/IconPool","./GanttUtils","./RenderUtils","./BasePath","sap/ui/core/theming/Parameters","sap/gantt/library","./CoordinateUtils","./BaseShape","sap/gantt/utils/GanttChartConfigurationUtils","sap/ui/core/Element"],function(e,t,r,s,a,o,i,n,p,h,l,c){"use strict";var d=n.simple.connectorType;var g=6,u=20,S=15,f={FinishToFinish:0,FinishToStart:1,StartToFinish:2,StartToStart:3};var y=o.extend("sap.gantt.simple.Relationship",{metadata:{library:"sap.gantt",properties:{type:{type:"sap.gantt.simple.RelationshipType",group:"Appearance"},predecessor:{type:"string",group:"Data"},successor:{type:"string",group:"Data"},selectedStroke:{type:"sap.gantt.ValueSVGPaintServer",defaultValue:"sapContent_Selected_ForegroundColor"},selectedStrokeWidth:{type:"sap.gantt.SVGLength",defaultValue:2},lShapeForTypeFS:{type:"boolean",defaultValue:true},lShapeForTypeSF:{type:"boolean",defaultValue:true},shapeTypeStart:{type:"sap.gantt.simple.connectorType",defaultValue:d.None},shapeTypeEnd:{type:"sap.gantt.simple.connectorType",defaultValue:d.Arrow},startShapeColor:{type:"sap.gantt.ValueSVGPaintServer",group:"Appearance",defaultValue:"sapChart_Data_InteractiveColor"},endShapeColor:{type:"sap.gantt.ValueSVGPaintServer",group:"Appearance",defaultValue:"sapChart_Data_InteractiveColor"},selectedStartShapeColor:{type:"sap.gantt.ValueSVGPaintServer",group:"Appearance",defaultValue:"sapContent_Selected_ForegroundColor"},selectedEndShapeColor:{type:"sap.gantt.ValueSVGPaintServer",group:"Appearance",defaultValue:"sapContent_Selected_ForegroundColor"},enableCurvedEdge:{type:"boolean",defaultValue:false},relationshipOverDivider:{type:"boolean",defaultValue:false},_lMarker:{type:"string",visibility:"hidden"}}},renderer:{apiVersion:2}});y.prototype.applySettings=function(e){e=e||{};o.prototype.applySettings.apply(this,arguments)};y.prototype._getLMarker=function(){return this.getProperty("_lMarker")};y.prototype.setShapeTypeStart=function(e){var t=this.getGanttChartBase();var r=t&&t.getOptimiseRelationships()?d.None:e;this.setProperty("shapeTypeStart",r,true)};y.prototype.setShapeTypeEnd=function(e){var t=this.getGanttChartBase();var r=t&&t.getOptimiseRelationships()?d.Arrow:e;this.setProperty("shapeTypeEnd",r,true)};y.prototype.onclick=function(e){if(this.getGanttChartBase().getIsConnectorDetailsVisible()){var t=function(){var e=p.getLatestCursorPosition();var t=e.pageX,r=e.pageY;var s=document.elementsFromPoint(t,r),a=[],o=[];for(var i=0;i<s.length;i++){var n=s[i].parentNode;if(s[i].tagName==="path"&&n&&c.getElementById(n.id).isA("sap.gantt.simple.Relationship")&&o.indexOf(n.id)===-1){o.push(n.id);var h=c.getElementById(n.id);a.push(h)}}if(a.length>0){this.getGanttChartBase().fireShapeConnectorList({pageX:t,pageY:r,connectorList:a})}};window.setTimeout(t.bind(this),300)}else{h.prototype.onclick.call(this,e)}};y.prototype.renderElement=function(e,t,r){this.oGantt=c.getElementById(r);var a=t.getProcessedType();if(!t.mRelatedShapes&&!t.mAnchors&&!s.relationexist(this.oGantt,t)||this.oGantt.getEnablePseudoShapes()&&this.mRelatedShapes.predecessor===this.mRelatedShapes.successor){return}this.mRelatedShapes=t.mRelatedShapes;if(this.mRelatedShapes.predecessor){var o=this.mRelatedShapes.predecessor.getParentRowSettings().getParent().getDomRef();var i=o.clientHeight;this.predYTop=o.offsetTop;this.predYBottom=this.predYTop+i}if(this.mRelatedShapes.successor){var p=this.mRelatedShapes.successor.getParentRowSettings().getParent().getDomRef();var h=p.clientHeight;this.sucYTop=p.offsetTop;this.sucYBottom=this.sucYTop+h}if(this.mRelatedShapes.predecessor&&this.mRelatedShapes.successor&&this.predYTop==this.sucYTop&&this.predYBottom==this.sucYBottom){var l=this.mRelatedShapes.successor.getParentRowSettings().getParent().getAggregation("_settings").getRowUid();var d=this.oGantt._oExpandModel.isRowExpanded(l);var g=this.oGantt.getShowParentRowOnExpand()&&!this.oGantt.getUseParentShapeOnExpand();var u=this.mRelatedShapes.predecessor._level;var S=this.mRelatedShapes.successor._level;if(d&&u&&S){var f=this.oGantt._oExpandModel.getBaseRowHeight();var y=this.oGantt.getExpandedRowHeight()?this.oGantt.getExpandedRowHeight():f;var v=g?this.predYTop+f+(u-1)*y:this.predYTop+(u-1)*y;var E=g?this.predYTop+f+u*y:this.predYTop+u*y;var P=g?this.sucYTop+f+(S-1)*y:this.sucYTop+(S-1)*y;var m=g?this.sucYTop+f+S*y:this.sucYTop+S*y;this.predYTop=v;this.predYBottom=E;this.sucYTop=P;this.sucYBottom=m}}switch(this.oGantt.getRelationshipShapeSize()){case n.simple.relationshipShapeSize.Small:this.SHAPE_SIZE=6;break;case n.simple.relationshipShapeSize.Large:this.SHAPE_SIZE=10;break;default:this.SHAPE_SIZE=8;break}this.calcLinePathD(t.mAnchors,a);this.renderRelationship(e,t.mAnchors,a,r)};y.prototype.getRlsAnchors=function(e,t){var r,s,a;var o=this.getShapeAnchors(t);if(t.predecessor&&t.successor){if(e===f.FinishToFinish){r=o.predecessor.tail;s=o.successor.tail}else if(e===f.FinishToStart){r=o.predecessor.tail;s=o.successor.head}else if(e===f.StartToFinish){r=o.predecessor.head;s=o.successor.tail}else if(e===f.StartToStart){r=o.predecessor.head;s=o.successor.head}}else if(t.predecessor&&!t.successor){if(e===f.FinishToFinish||e===f.FinishToStart){r=o.predecessor.tail;s={x:r.x+u,y:r.y};a={x:s.x,y:s.y+S/2}}else if(e===f.StartToFinish||e===f.StartToStart){r=o.predecessor.head;s={x:r.x-u,y:r.y};a={x:s.x-S,y:s.y+S/2}}}else if(!t.predecessor&&t.successor){if(e===f.FinishToFinish||e===f.StartToFinish){s=o.successor.tail;r={x:s.x+u,y:s.y};a={x:r.x,y:r.y+S/2}}else if(e===f.FinishToStart||e===f.StartToStart){s=o.successor.head;r={x:s.x-u,y:s.y};a={x:r.x-S,y:r.y+S/2}}}return{predecessor:r,successor:s,prompter:a}};y.prototype.calcLinePathD=function(e,t){var r=e.predecessor.x,s=e.predecessor.y;var a=e.successor.x,o=e.successor.y;var i,n=[r,s,a,o];var p=this.oGantt._edgePoint;if(s===o){if(t==f.FinishToStart&&a>r||t==f.StartToFinish&&r>a||e.prompter){i=this.calcIRlsPathD}else{i=this.calcSRlsPathD;n.push(t,p)}}else if(s!==o){if(t===f.FinishToFinish){i=this.calcURlsPathD;n.push(false,p)}else if(t===f.FinishToStart){if(r<=a){if(l.getRTL()?this.getLShapeForTypeSF():this.getLShapeForTypeFS()){if(p==2&&this.getShapeTypeStart()=="None"||p==3&&Math.abs(r-a)>=p*g){i=this.calcLRlsPathD}else{i=this.calcSRlsPathD;n.push(t,p)}}else if(Math.abs(r-a)>=2*p*g){i=this.calcZRlsPathD;n.push(p)}else{i=this.calcSRlsPathD;n.push(t,p)}}else if(r>a){i=this.calcSRlsPathD;n.push(t,p)}}else if(t===f.StartToFinish){if(r<a){i=this.calcSRlsPathD;n.push(t,p)}else if(r>=a){if(l.getRTL()?this.getLShapeForTypeFS():this.getLShapeForTypeSF()){if(p==2&&this.getShapeTypeStart()=="None"||p==3&&Math.abs(r-a)>=p*g){i=this.calcLRlsPathD}else{i=this.calcSRlsPathD;n.push(t,p)}}else if(Math.abs(r-a)>=2*p*g){i=this.calcZRlsPathD;n.push(p)}else{i=this.calcSRlsPathD;n.push(t,p)}}}else if(t===f.StartToStart){i=this.calcURlsPathD;n.push(true,p)}}if(i===this.calcLRlsPathD){var h=e.successor.dyTop?e.successor.dyTop:e.successor.dy;var c=e.successor.dyBottom?e.successor.dyBottom:e.successor.dy;n[2]=r<a?a+e.successor.dx:a-e.successor.dx;n[3]=s<o?o-h:o+c}this.setProperty("d",i.apply(this,n),true)};y.prototype.calcIRlsPathD=function(e,t,r,s){return this.getLinePathD([[e,t],[r,s]])};y.prototype.calcLRlsPathD=function(e,t,r,s){return this.getLinePathD([[e,t],[r,t],[r,s]])};y.prototype.calcURlsPathD=function(e,t,r,s,a,o){var i=e<r?r+o*g:e+o*g;var n=e<r?e-o*g:r-o*g;var p=!a?i:n;if(this.getRelationshipOverDivider()){var h=e<r?e+o*g:r+o*g;var l=e<r?r-o*g:e-o*g;var c=!a?h:l;var d=t>s?this.predYTop:this.predYBottom;var u=t<s?this.sucYTop:this.sucYBottom;if(!a&&e<r||a&&e>r){return this.getLinePathD([[e,t],[c,t],[c,d],[p,d],[p,s],[r,s]])}else{return this.getLinePathD([[e,t],[p,t],[p,u],[c,u],[c,s],[r,s]])}}else{return this.getLinePathD([[e,t],[p,t],[p,s],[r,s]])}};y.prototype.calcSRlsPathD=function(e,t,r,s,a,o){var i=a==0||a==1?e+o*g:e-o*g;var n=t>s?this.predYTop:this.predYBottom;var p=a==0||a==2?r+o*g:r-o*g;return this.getLinePathD([[e,t],[i,t],[i,n],[p,n],[p,s],[r,s]])};y.prototype.calcZRlsPathD=function(e,t,r,s,a){var o=e<r?e+a*g:e-a*g;if(this.getRelationshipOverDivider()){var i=t<s?this.sucYTop:this.sucYBottom;var n=e<r?r-a*g:r+a*g;return this.getLinePathD([[e,t],[o,t],[o,i],[n,i],[n,s],[r,s]])}else{return this.getLinePathD([[e,t],[o,t],[o,s],[r,s]])}};y.prototype.getConnectorEndPath=function(e,t,r){var s=function(e){return Number(e)};var a=e.match(/-?\d+(\.\d+)?/g).map(s);var o=[];var i;var n=this.getEnableCurvedEdge()?a[a.length-4]:a[a.length/2-2];var p=this.getEnableCurvedEdge()?a[a.length-3]:a[a.length/2-1];var h=this.getEnableCurvedEdge()?a[a.length-2]:a[a.length/2+0];var l=this.getEnableCurvedEdge()?a[a.length-1]:a[a.length/2+1];if(n==h){if(p>l){o=this.getCoordinateUpDown(h,l,"up");i=a[0]<h?"rightUp":"leftUp"}else{o=this.getCoordinateUpDown(h,l,"down");i=a[0]<h?"rightDown":"leftDown"}}else if(n!=h){o=n<h?this.getCoordinate(h,l,"rightEnd"):this.getCoordinate(h,l,"leftEnd")}return this.renderSvg(o,"end",t,r,i)};y.prototype.getConnectorStartPath=function(e,t,r){var s=function(e){return Number(e)};var a=e.match(/-?\d+(\.\d+)?/g).map(s);var o=a[0],i=a[1];var n=r==0||r==1?this.getCoordinate(o,i,"rightStart"):this.getCoordinate(o,i,"leftStart");return this.renderSvg(n,"start",t,r)};y.prototype.renderSvg=function(e,t,r,s,a){var o=[],i;var n=this.getGanttChartBase()||c.getElementById(r);if(!n.getOptimiseRelationships()){i=this._checkConnectorOverlap(r,s,t,a)}else{i=t=="start"?this.getShapeTypeStart():this.getShapeTypeEnd()}if(i==d.Arrow){if(t=="start"){o.push(e[0],e[1],e[4],e[7])}else{o.push(e[0],e[3],e[5])}return d3.svg.line().interpolate("linear-closed")(o)}else if(i==d.Square){o.push(e[0],e[1],e[3],e[5],e[7]);return d3.svg.line().interpolate("linear-closed")(o)}else if(i==d.Diamond){o.push(e[0],e[2],e[4],e[6]);return d3.svg.line().interpolate("linear-closed")(o)}else if(i==d.Circle){o.push(e[0],e[1],e[3],e[5],e[7]);return d3.svg.line().interpolate("basis-closed")(o)}else if(i===d.HorizontalRectangle){o.push(e[0],e[15],e[9],e[10],e[16]);return d3.svg.line().interpolate("linear-closed")(o)}else if(i==d.VerticalRectangle){o.push(e[0],e[11],e[12],e[13],e[14]);return d3.svg.line().interpolate("linear-closed")(o)}else if(i==d.None){o.push(e[0]);return d3.svg.line().interpolate("linear")(o)}};y.prototype._checkConnectorOverlap=function(e,t,r,a){var o=c.getElementById(e);var i=s._getVisibleRelationships(o);var n=this.getRelatedInRowShapes(e);var p=l.getRTL();var h,g,u,S=[];var y=function(e){g=[1,2];if(n.predecessor&&n.successor){i.forEach(function(t){if(t.mProperties.successor&&t.mProperties.predecessor){if(n.successor.mProperties.shapeId===t.getSuccessor()&&g.indexOf(f[t.getType()])!==-1&&t._getLMarker()===e){S.push(t.getShapeTypeEnd())}}})}S=s.getFilteredShapeType(S);var t=S.length>1?d.HorizontalRectangle:this.getShapeTypeEnd();if(t==d.VerticalRectangle||t==d.HorizontalRectangle){t=t==d.VerticalRectangle?d.HorizontalRectangle:d.VerticalRectangle}return t}.bind(this);var v=function(e,t){return e===d.Arrow?t:e};if(r=="start"){if(p){g=t==0||t==1?[2,3]:[0,1];u=t==0||t==1?[1,3]:[0,2]}else{g=t==0||t==1?[0,1]:[2,3];u=t==0||t==1?[0,2]:[1,3]}if(n.predecessor&&n.successor){i.forEach(function(e){if(e.mProperties.successor&&e.mProperties.predecessor){if(n.predecessor.mProperties.shapeId==e.getPredecessor()&&g.indexOf(f[e.getType()])!==-1){S.push(v(e.getShapeTypeStart(),"ArrowStart"))}if(n.predecessor.mProperties.shapeId==e.getSuccessor()&&u.indexOf(f[e.getType()])!==-1&&e._getLMarker()==""){S.push(v(e.getShapeTypeEnd(),"ArrowEnd"))}}})}S=s.getFilteredShapeType(S);h=S.length>1?d.HorizontalRectangle:this.getShapeTypeStart()}else if(a=="rightUp"||a=="rightDown"||a=="leftUp"||a=="leftDown"){h=y(a)}else{if(p){g=t==1||t==3?[0,2]:[1,3];u=t==1||t==3?[0,1]:[2,3]}else{g=t==1||t==3?[1,3]:[0,2];u=t==1||t==3?[2,3]:[0,1]}if(n.predecessor&&n.successor){i.forEach(function(e){if(e.mProperties.successor&&e.mProperties.predecessor){if(n.successor.mProperties.shapeId==e.getSuccessor()&&g.indexOf(f[e.getType()])!==-1&&e._getLMarker()==""){S.push(v(e.getShapeTypeEnd(),"ArrowEnd"))}if(n.successor.mProperties.shapeId==e.getPredecessor()&&u.indexOf(f[e.getType()])!==-1){S.push(v(e.getShapeTypeStart(),"ArrowStart"))}}})}S=s.getFilteredShapeType(S);h=S.length>1?d.HorizontalRectangle:this.getShapeTypeEnd()}return h};y.prototype.getCoordinate=function(e,t,r){var s=r=="rightStart"||r=="leftEnd"?e+this.SHAPE_SIZE/2:e-this.SHAPE_SIZE/2;var a=r=="rightStart"||r=="leftEnd"?e+this.SHAPE_SIZE:e-this.SHAPE_SIZE;var o=r=="rightStart"||r=="leftEnd"?e+2*g:e-2*g;var i=r=="rightStart"||r=="leftEnd"?e+g:e-g;var n=[[e,t],[e,t-this.SHAPE_SIZE/2],[s,t-this.SHAPE_SIZE/2],[a,t-this.SHAPE_SIZE/2],[a,t],[a,t+this.SHAPE_SIZE/2],[s,t+this.SHAPE_SIZE/2],[e,t+this.SHAPE_SIZE/2],[s,t],[o,t-g/2],[o,t+g/2],[e,t-g],[i,t-g],[i,t+g],[e,t+g],[e,t-g/2],[e,t+g/2]];return n};y.prototype.getCoordinateUpDown=function(e,t,r){var s=r=="up"?t+this.SHAPE_SIZE/2:t-this.SHAPE_SIZE/2;var a=r=="up"?t+this.SHAPE_SIZE:t-this.SHAPE_SIZE;var o=r=="up"?t+2*g:t-2*g;var i=r=="up"?t+g:t-g;var n=[[e,t],[e+this.SHAPE_SIZE/2,t],[e+this.SHAPE_SIZE/2,s],[e+this.SHAPE_SIZE/2,a],[e,a],[e-this.SHAPE_SIZE/2,a],[e-this.SHAPE_SIZE/2,s],[e-this.SHAPE_SIZE/2,t],[e,s],[e+g/2,o],[e-g/2,o],[e+g,t],[e+g,i],[e-g,i],[e-g,t],[e+g/2,t],[e-g/2,t]];return n};y.prototype.getShapeAnchors=function(e){var t={predecessor:null,successor:null};Object.keys(e).forEach(function(r){var s=e[r];if(s==null){return}if(s.getShapeAnchors){t[r]=s.getShapeAnchors()}else{var a=s.getDomRef("nonLabelGroup")?s.getDomRef("nonLabelGroup").getBBox():s.getDomRef().getBBox();var o=s.getLeftAnchorPosition()/100;var i=s.getRightAnchorPosition()/100;var n,p=0;n=window.getComputedStyle(s.getDomRef()).transform.match(/matrix.*\((.+)\)/);if(n){p=n[1].split(", ")[5]}t[r]={head:{x:a.x,y:a.y+a.height*o+parseFloat(p),dx:0,dyTop:a.height*o,dyBottom:a.height*(1-o)},tail:{x:a.x+a.width,y:a.y+a.height*i+parseFloat(p),dx:0,dyTop:a.height*i,dyBottom:a.height*(1-i)}}}});return t};y.prototype.renderRelationship=function(t,o,i,n){this.writeElementData(t,"g",true);a.renderAttributes(t,this,["style"]);t.openEnd();a.renderTooltip(t,this);t.openStart("path");if(!this.getEnableCurvedEdge()||o.prompter){t.attr("d",this.getD())}else{t.style("fill","none");t.attr("d",s.getPathCorners(this.getD(),5))}t.openEnd().close("path");t.openStart("path");if(!this.getEnableCurvedEdge()||o.prompter){t.attr("d",this.getD());t.style("fill","none")}else{t.style("fill","none");t.attr("d",s.getPathCorners(this.getD(),5))}t.style("stroke-width",8);t.style("stroke","none");t.style("pointer-events","stroke");t.openEnd().close("path");t.openStart("path");t.style("fill",this.getStartShapeColor());t.style("stroke-dasharray","none");t.attr("d",this.getConnectorStartPath(this.getD(),n,i));t.openEnd().close("path");t.openStart("path");t.style("fill",this.getEndShapeColor());t.style("stroke-dasharray","none");t.attr("d",this.getConnectorEndPath(this.getD(),n,i));t.openEnd().close("path");if(o.prompter){t.openStart("text");t.attr("x",o.prompter.x);t.attr("y",o.prompter.y);t.attr("font-size",S);t.attr("font-family","SAP-icons");t.attr("text-anchor",l.getRTL()&&!e.browser.edge?"end":"start");t.attr("stroke-width",0);t.openEnd();t.text(r.getIconInfo("chain-link").content);t.close("text")}t.close("g")};y.prototype.getStyle=function(){var e=this.getStroke()||i.get({name:"sapUiBaseText",callback:function(t){e=t}});return this.getInlineStyle({fill:this.getStroke()||e,stroke:this.getStroke()||e,"stroke-width":this.getStrokeWidth()||1,"stroke-dasharray":this.getStrokeDasharray(),opacity:this.getStrokeOpacity()})};y.prototype.getLinePathD=function(e){if(this.getEnableCurvedEdge()){return d3.svg.line().interpolate("linear")(e)}else{e=e.concat(e.slice(1,-1).reverse());return d3.svg.line().interpolate("linear-closed")(e)}};y.prototype.getSelectedStyle=function(){return this.getInlineStyle({fill:this.getSelectedStroke(),stroke:this.getSelectedStroke(),"stroke-width":this.getSelectedStrokeWidth(),"stroke-dasharray":this.getStrokeDasharray(),"pointer-events":"none"})};y.prototype.getBaseRowHeight=function(e){return c.getElementById(e).getTable()._getDefaultRowHeight()};y.prototype.getProcessedType=function(){var e=this.getProperty("type");var t=l.getRTL();return t?3-f[e]:f[e]};y.prototype.getRelatedInRowShapes=function(e){var t=s.shapeElementById(this.getPredecessor(),e+"-svg");var r=s.shapeElementById(this.getSuccessor(),e+"-svg");return{predecessor:t?t:s.isRelationshipConnectedToPseudoShapes(this.getPredecessor(),e),successor:r?r:s.isRelationshipConnectedToPseudoShapes(this.getSuccessor(),e)}};y.prototype.getStartShapeColor=function(){return this.determineValueColor(this.getProperty("startShapeColor"))};y.prototype.getEndShapeColor=function(){return this.determineValueColor(this.getProperty("endShapeColor"))};y.prototype.getSelectedStroke=function(){return this.determineValueColor(this.getProperty("selectedStroke"))};y.prototype.getSelectedStartShapeColor=function(){return this.determineValueColor(this.getProperty("selectedStartShapeColor"))};y.prototype.getSelectedEndShapeColor=function(){return this.determineValueColor(this.getProperty("selectedEndShapeColor"))};return y},true);
//# sourceMappingURL=Relationship.js.map