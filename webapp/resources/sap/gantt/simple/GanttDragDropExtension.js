/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/events/KeyCodes","sap/gantt/library","./GanttExtension","./CoordinateUtils","./GanttUtils","sap/gantt/misc/Format","./RenderUtils","sap/gantt/misc/Utility","sap/gantt/utils/GanttChartConfigurationUtils","sap/ui/core/Element","sap/ui/core/Lib","sap/ui/core/theming/Parameters"],function(jQuery,t,e,a,i,r,n,s,o,g,h,l,p){"use strict";var d=".sapGanttDragDrop";var u=["mousemove","mouseup","keydown"];var f="mousedown";var v=u.reduce(function(t,e){t[e]=e;return t},{});v[f]=f;var c=u.map(function(t){return t+d});var m=f+d;var D=3;var S=e.dragdrop.GhostAlignment;var y=e.dragdrop.SnapMode;var T=sap.gantt.DragOrientation;var G=e.simple.shapeEventType;var E={dispatchEvent:function(t){var e=this._getDragDropExtension();if(t.type===v.mousedown){e.onMouseDown(t)}else if(t.type===v.mousemove){e.onMouseMove(t)}else if(t.type===v.mouseup){e.onMouseUp(t)}else if(t.type===v.keydown){e.onKeydown(t)}},addEventListeners:function(t){this.removeEventListeners(t);var e=jQuery(t._getDragDropExtension().getDomRefs().ganttSvg);e.on(m,E.dispatchEvent.bind(t));var a=jQuery(t._getDragDropExtension().getDomRefs().headerSvg);a.on(m,E.dispatchEvent.bind(t))},removeEventListeners:function(t){var e=jQuery(t._getDragDropExtension().getDomRefs().ganttSvg);e.off(d);var a=jQuery(t._getDragDropExtension().getDomRefs().headerSvg);a.off(d)},addDragDropEventListeners:function(t){this.removeDragDropEventListeners(t);c.forEach(function(e){jQuery(document).on(e,E.dispatchEvent.bind(t))})},removeDragDropEventListeners:function(t){c.forEach(function(t){jQuery(document).off(t)})}};var x=a.extend("sap.gantt.simple.GanttDragDropExtension",{_init:function(t,e){this._initDragStates();this._oGhostStyleConfigs=this._getGhostStyleConfig();return"DragDropExtension"},_attachEvents:function(){var t=this.getGantt();E.addEventListeners(t)},_detachEvents:function(){var t=this.getGantt();E.removeEventListeners(t)}});x.prototype._initDragStates=function(){this.bDragging=false;this.adhocLineDrag=false;this.deltaLineDrag=false;this.adhocLineDragStart=false;this.deltaLineDragStart=false;this.isCursorlineDisabled=false;this.bElementDraggable=false;this.oAdhocLineElmDraggable=false;this.oDeltaLineElmDraggable=false;this.oMouseDownTarget=null;this.oLastDraggedShapeData=null;this.mDragPoint={};this.bDragging=false;this.dragGhost=null;this.prevDragPoint={};this.snapTimer=null;this.snapVal=0;this.isSnapping=false;this.cursorLineSnapPoint=null};x.prototype._getGhostStyleConfig=function(){var t=this.getGantt();var e={};if(t.getAggregation&&t.getAggregation("shapeStyles")&&t.getAggregation("shapeStyles").length>0){var a=t.getAggregation("shapeStyles");a.forEach(function(t){if(t.getEventState()===G.DragDrop){e[t.getName()]=t}})}else if(t.sParentAggregationName==="ganttCharts"&&t.getParentGanttChartContainer()){var i=t.getParentGanttChartContainer();if(i.getAggregation("shapeStyles")&&i.getAggregation("shapeStyles").length>0){var a=i.getAggregation("shapeStyles");a.forEach(function(t){if(t.getEventState()===G.DragDrop){e[t.getName()]=t}})}}return e};x.prototype.onAdhocMarkerMouseDown=function(t){var e=i.getEventSVGPoint(this.getDomRefs().headerSvg,t),a=t.target.getBBox();this.oMouseDownTarget=t.target;var r=h.getElementById(this.oMouseDownTarget.id),n={x:0,y:0};if(r){n=o.getShapeBias(r)}this.mDragPoint={cursorX:e.x,cursorY:e.y,shapeX:a.x,shapeY:a.y,shapeWidth:a.width,shapeBias:n};E.addDragDropEventListeners(this.getGantt());this.adhocLineDrag=true};x.prototype.onDeltaAreaMouseDown=function(t){var e=i.getEventSVGPoint(this.getDomRefs().headerSvg,t),a=t.target.getBBox();this.oMouseDownTarget=t.target;var r=h.getElementById(this.oMouseDownTarget.id),n={x:0,y:0};if(r){n=o.getShapeBias(r)}this.mDragPoint={cursorX:e.x,cursorY:e.y,shapeX:a.x,shapeY:a.y,shapeWidth:a.width,shapeBias:n};var s=r.getParent();this.oLastDraggedShapeData={timeStamp:s.getTimeStamp(),endTimeStamp:s.getEndTimeStamp()};E.addDragDropEventListeners(this.getGantt());this.deltaLineDrag=true};x.prototype.onAdhocLineDrop=function(t){if(this.oMouseDownTarget){var e=jQuery(this.oMouseDownTarget).control(0,true).getParent();var a=this._getAdhocDropData(t);if(a){e.fireAdhoclineDrop(a)}if(this.isCursorlineDisabled){this.getGantt().setEnableCursorLine(true)}this.stopDragging()}};x.prototype.onDeltaLineDrop=function(t){if(this.oMouseDownTarget){var e=jQuery(this.oMouseDownTarget).control(0,true).getParent();var a=this._getDeltaMarkerDropEvent(t);if(a){e.fireDeltalineDrop(a)}if(this.isCursorlineDisabled){this.getGantt().setEnableCursorLine(true)}this.stopDragging()}};x.prototype.onAdhocLineMove=function(t){if(!this.adhocLineDragStart){this.dragGhost=this.createDragGhost(this.oMouseDownTarget);this._hideScrollBarOnBody(true);this.adhocLineDragStart=true;if(this.getGantt().getEnableCursorLine()){this.getGantt().setEnableCursorLine(false);this.isCursorlineDisabled=true}}else{this.onLineDrag(t)}};x.prototype.onDeltaLineMove=function(t){if(!this.deltaLineDragStart){this.dragGhost=this.createDragGhost(this.oMouseDownTarget);this._hideScrollBarOnBody(true);this.deltaLineDragStart=true;if(this.getGantt().getEnableCursorLine()){this.getGantt().setEnableCursorLine(false);this.isCursorlineDisabled=true}}else{this.onLineDrag(t)}};x.prototype.onLineDrag=function(t){if(this.isValidDropZoneForLines(t)){this.updateCursorStyle("Move");this.updateHeaderCursorStyle("Move")}else{this.updateCursorStyle("not-allowed");this.updateHeaderCursorStyle("not-allowed")}this.showGhost(t)};x.prototype.onMouseDown=function(t){if(t.button!==0){return}this._bGhostsPositioned=false;this.bMultipleGhosts=false;this._bEnableRowHighlight=false;var e;if(this.isEventTargetAdhocLine(t)){this.oAdhocLineElmDraggable=this.isAdhocLineDraggable(t);if(this.oAdhocLineElmDraggable){this.onAdhocMarkerMouseDown(t);return}}if(this.isEventTargetDeltaLine(t)){this.oDeltaLineElmDraggable=this.isDeltaLineDraggable(t);if(this.oDeltaLineElmDraggable){this.onDeltaAreaMouseDown(t);return}}if(!this.getGantt().getEnableSelectAndDrag()){e=this.getShapeElementByTarget(t.target);if(e){this.shapeSelectedOnMouseDown=true;this.initiallySelected=e.getSelected();if(!(e.isA("sap.gantt.simple.Relationship")&&this.getGantt().getIsConnectorDetailsVisible())){var a=!e.getSelectable();this.getGantt().getSelection().updateShape(e.getShapeUid(),{selected:true,ctrl:t.ctrlKey||t.metaKey,draggable:e.getDraggable(),time:e.getTime(),endTime:e.getEndTime()},a)}}}this.bElementDraggable=this.isEventTargetDraggable(t);if(this.bElementDraggable){var n=i.getEventSVGPoint(this.getDomRefs().ganttSvg,t);var s=this.getDraggableDOMElement(t.target),g=h.getElementById(s.id),l=g.getTask?g.getTask():g;if(l instanceof sap.gantt.simple.BaseConditionalShape){l=l._getActiveShapeElement()}var p=l.getDomRef("nonLabelGroup")?l.getDomRef("nonLabelGroup").getBBox():s.getBBox(),d={x:0,y:0};if(g){d=o.getShapeBias(g)}this.mDragPoint={cursorX:n.x,cursorY:n.y,shapeX:p.x,shapeY:p.y,shapeWidth:p.width,shapeBias:d};e=this.getShapeElementByTarget(s);this.oMouseDownTarget=s;this.oLastDraggedShapeData={shapeUid:e.getShapeUid(),startTime:e.getTime(),endTime:e.getEndTime()};if(this.oSourceRow){this.oSourceRow.destroy()}this.oSourceRow=this.getRowByShape(e);if(this.getGantt().getDragOrientation()===T.Horizontal){this.oCurrentRow=r.getRowInstancefromShape(e)}var u=r.getShapesWithUid(this._gantt.getId(),this._gantt.getSelectedShapeUid());this._aVisibleDraggableShapes=[];u.forEach(function(t){if(t&&t.getDraggable()&&t.sParentAggregationName!=="relationships"){this._aVisibleDraggableShapes.push(t)}}.bind(this));this.bMultipleGhosts=this.getGantt().getEnableMultipleGhosts()&&this._aVisibleDraggableShapes.length>1;this.mGhostLabelStyle={};this._bEnableRowHighlight=e.getDragHighlightRows().length>0&&this._aVisibleDraggableShapes.length==1;E.addDragDropEventListeners(this.getGantt())}else if(this.oSourceRow){this.oSourceRow.destroy();this.oSourceRow=undefined}};x.prototype.updateCursorStyle=function(t,e){document.body.style.cursor=t;this.getDomRefs().ganttSvg.style.cursor=t;if(e){this.getDomRefs().ganttChart.style.pointerEvents=e;this.getDomRefs().gantt.style.pointerEvents="auto";this._bArePointerEventsDisabled=true;if(this.getDomRefs().ganttChartContainerToolbar){this.getDomRefs().ganttChartContainerToolbar.style.pointerEvents=e}}else if(this._bArePointerEventsDisabled){this.getDomRefs().ganttChart.style.removeProperty("pointer-Events");this.getDomRefs().gantt.style.removeProperty("pointer-Events");this._bArePointerEventsDisabled=false;if(this.getDomRefs().ganttChartContainerToolbar){this.getDomRefs().ganttChartContainerToolbar.style.removeProperty("pointer-Events")}}};x.prototype.updateHeaderCursorStyle=function(t,e){this.getDomRefs().headerSvg.style.cursor=t;if(e){this.getDomRefs().ganttChart.style.pointerEvents=e;this.getDomRefs().gantt.style.pointerEvents="auto";this._bArePointerEventsDisabled=true;if(this.getDomRefs().ganttChartContainerToolbar){this.getDomRefs().ganttChartContainerToolbar.style.pointerEvents=e}}else if(this._bArePointerEventsDisabled){this.getDomRefs().ganttChart.style.removeProperty("pointer-Events");this.getDomRefs().gantt.style.removeProperty("pointer-Events");this._bArePointerEventsDisabled=false;if(this.getDomRefs().ganttChartContainerToolbar){this.getDomRefs().ganttChartContainerToolbar.style.removeProperty("pointer-Events")}}};x.prototype.onMouseMove=function(t){if(this.skipEvent(t)){return}if(this.adhocLineDrag&&this.oMouseDownTarget){this.onAdhocLineMove(t);return}if(this.deltaLineDrag&&this.oMouseDownTarget){this.onDeltaLineMove(t);return}if(this.bDragging===false){var e=this.getGantt(),a=this.getShapeElementByTarget(this.oMouseDownTarget);if(this._bEnableRowHighlight&&a){this.getShapeDndRowHighlightIndex(e,a)}var r=i.getEventSVGPoint(this.getDomRefs().ganttSvg,t),n=this.isExceedDraggingThreshold(r),s=n&&this.isAllowedVerticalOrentationDrag();this.bDragging=s;this._aShapeNodes=[];this._aGhostImages=[];if(s&&this.oMouseDownTarget){this._hideScrollBarOnBody(true);var l=h.getElementById(this.oMouseDownTarget.id);var p=l.getTask?l.getTask():l;if(p instanceof sap.gantt.simple.BaseConditionalShape){p=p._getActiveShapeElement()}this.oTargetDom=p.getDomRef("nonLabelGroup")?p.getDomRef("nonLabelGroup"):this.oMouseDownTarget;this.dragGhost=this.createDragGhost(this.oTargetDom,true);var d=this.oTargetDom.getBBox();if(this.bMultipleGhosts){var u=o.getShapeBias(l);this._coordinateDiff={};var f=g.getRTL();var v=f?d.x+u.x+d.width:d.x+u.x;var c=d.y+u.y;this._aVisibleDraggableShapes.forEach(function(t){if(t.getId()!==this.oMouseDownTarget.id){var e=t,a;if(t.getTask){e=t.getTask()}if(e instanceof sap.gantt.simple.BaseConditionalShape){e=e._getActiveShapeElement()}if(e.getDomRef("nonLabelGroup")){a=e.getDomRef("nonLabelGroup")}else{a=document.getElementById(t.getId())}this.createDragGhost(a,false);var i=f?a.getBBox().width:0;u=o.getShapeBias(t);var r={xDiff:a.getBBox().x+u.x+i-v,yDiff:a.getBBox().y+u.y-c,shape:t};this._coordinateDiff[t.getId()]=r}}.bind(this))}this._bFirstTimeDrag=true;var m=this._getDragStartEventData(t);if(m){this.getGantt().fireDragStart(m)}}else if(n){this.updateCursorStyle("not-allowed","none")}}else{var D=i.getEventSVGPoint(this.getDomRefs().ganttSvg,t);if(Object.keys(this.prevDragPoint).length===0||this.prevDragPoint.cursorX!==D.x||this.prevDragPoint.cursorY!==D.y){this.prevDragPoint={cursorX:D.x,cursorY:D.y};if(this.bMultipleGhosts&&this._bFirstTimeDrag){this.iGhostTimer=window.setTimeout(function(){this._updateGhostShapesPosition()}.bind(this),100);this._bGhostsPositioned=true}this._bFirstTimeDrag=false;this.onDragging(t)}}};x.prototype.getShapeDndRowHighlightIndex=function(t,e){var a=t.getTable(),i=a.getRows(),r=i[0].getIndex();var n=e?e.getDragHighlightRows():this.oLastDraggedShapeData._dragHighlightRows;this.oLastDraggedShapeData._highlightedRowIndex=[];if(n){n.forEach(function(t){var e=i.filter(function(e){return e.getAggregation("_settings").getRowId()===t})[0];if(e){this.oLastDraggedShapeData._highlightedRowIndex.push(e.getIndex()-r)}}.bind(this));this.oLastDraggedShapeData._dragHighlightRows=n}};x.prototype._updateGhostShapesPosition=function(){var t=document.getElementsByClassName("sapGanttDragGhost");var e=document.getElementById("sapGanttDragGhostWrapper");if(e){var a=[],i;for(i=0;i<t.length;i++){a.push(t[i].offsetHeight)}while(document.getElementsByClassName("sapGanttDragGhost").length>1){e.lastElementChild.remove()}var r=a[0];for(i=1;i<this._aShapeNodes.length;i++){var n=this._aShapeNodes[i];var s=this._coordinateDiff[n.id].xDiff;var o=this._coordinateDiff[n.id].yDiff;var g={left:s+"px",top:o-r+"px"};var h=this._getGhostLabel(this._coordinateDiff[n.id].shape,n);var l="<div class='sapGanttDragGhost'>"+"<img class='sapGanttDragGhostImg' src='"+this._aGhostImages[i]+"'>"+h+"</div>";e.insertAdjacentHTML("beforeend",l);e.lastElementChild.style.left=g.left;e.lastElementChild.style.top=g.top;if(h!==""){this._updateGhostLabelStyle()}r+=a[i]}e.classList.remove("sapGanttDragElementHidden")}};x.prototype._getGhostLabel=function(t,e){if(!this.getGantt().getShowTextOnGhost()){return""}var a="",i="",r="13px",n=p.get({name:"sapChart_Data_InteractiveColor",callback:function(t){n=t}}),s="sapFontFamily",o="normal";var h=t.getVerticalTextAlignment();var l=e.nextSibling;if(l&&l.tagName==="text"&&t.getShowTitle()&&t.getTitle()&&t.getTitle().length&&l.textContent&&l.textContent.length){i=l.textContent;r=l.style.fontSize||r;n=l.style.fill||n;s=l.style.fontFamily||s;o=l.style.fontWeight||o;if(t.mProperties.hasOwnProperty("styleName")){var d=this._oGhostStyleConfigs[t.getStyleName()];if(d&&d.mProperties.hasOwnProperty("textFill")){n=d.getTextFill()}}}else{return a}var u=g.getRTL();var f="0px",v="0px";if(u){f=e.getBBox().x-t.getXBias()+e.getBBox().width-(l.getBBox().x+l.getBBox().width)+"px"}else{v=l.getBBox().x-(e.getBBox().x+t.getXBias())+"px"}var c=e.getBBox().height-l.getBBox().height;if(h==="Top"){c=0}else if(h==="Center"){c=c/2}this.mGhostLabelStyle={fontSize:r,color:n,fontFamily:s,fontWeight:o,top:c+"px",right:f,left:v};a="<div class='sapGanttDragGhostLabel'>"+i+"</div>";return a};x.prototype._updateGhostLabelStyle=function(){var t=document.getElementsByClassName("sapGanttDragGhostLabel");var e=t[t.length-1];for(var a in this.mGhostLabelStyle){e.style[a]=this.mGhostLabelStyle[a]}};x.prototype.onMouseUp=function(t){if(this.bElementDraggable===true&&this.bDragging===false){this.stopDragging(t);this._initDragStates();return}if(this.adhocLineDragStart&&this.oMouseDownTarget){this.onAdhocLineDrop(t);this._initDragStates();return}if(this.deltaLineDragStart&&this.oMouseDownTarget){this.onDeltaLineDrop(t);this._initDragStates();return}var e=this._getShapeDropEventData(t);this.stopDragging(t);if(e){var a=this.getGantt();if(a.getEnablePseudoShapes()){var i=e.targetRow&&e.targetRow.getIndex();var n=e.draggedShapeDates;a.pseudoShapeSpecificData=a.pseudoShapeSpecificData?a.pseudoShapeSpecificData:{};a.pseudoShapeSpecificData.oDraggedShapeDates=n;n&&Object.keys(n).forEach(function(t){var e=r.getShapesWithUid(a.getId(),[t])[0];var n=e.getParentRowSettings().getParentRow().getIndex&&e.getParentRowSettings().getParentRow().getIndex();a.pseudoShapeSpecificData.draggedShapeTRowIndex=i==undefined?n:i});a.pseudoShapeSpecificData.needUpdateForTasksInAggr=true}this.getGantt().triggerShapeDrop(e)}if(this.oMouseDownTarget){var s=this.getShapeElementByTarget(this.oMouseDownTarget);if(s){r.rerenderAssociatedRelationships(this.getGantt(),s)}}this._initDragStates()};x.prototype._getDragStartEventData=function(t){return{sourceGanttChart:this.getGantt(),draggedShapeDates:this._getDraggedShapeDates(),lastDraggedShapeUid:this.oLastDraggedShapeData.shapeUid,cursorDateTime:this._getGhostTime(t).cursorTime}};x.prototype._getShapeDropEventData=function(t){var e=this.getGantt();var a=e._getPointerExtension();if(this.isValidDropZone(t)&&a.isPointerInCorrectRow()){var i;var n=this._getDraggedShapeDates();var s=this.getGanttChartByTarget(t.target);if(this.getGantt().getDragOrientation()===T.Horizontal){i=this.oCurrentRow}else{i=r.getRowInstance(t,s.getTable())}var o=this.getShapeElementByTarget(t.target);var g=this._getGhostTime(t);return{dragged:true,sourceGanttChart:e,targetGanttChart:s,draggedShapeDates:n,lastDraggedShapeUid:this.oLastDraggedShapeData.shapeUid,targetRow:i,cursorDateTime:g.cursorTime,newDateTime:g.newDateTime,targetShape:o,sourceRowData:this.oSourceRow}}else{return{dragged:false}}};x.prototype._getAdhocDropData=function(t){if(this.isValidDropZoneForLines(t)){var e=this.getGantt();var a=e.getAxisTime();var r=i.getEventSVGPoint(this.getDomRefs().headerSvg,t);var s=n.dateToAbapTimestamp(a.viewToTime(this.mDragPoint.cursorX));var o=n.dateToAbapTimestamp(a.viewToTime(r.x));return{newTimeStamp:o,oldTimeStamp:s}}};x.prototype._getGhostTime=function(t,e){var a=this.getGantt();var r=this.getGanttChartByTarget(t.target);var n=r!=null?r.getId()!==a.getId():false;var s=n?r.getAxisTime():a.getAxisTime();var o=n?window.document.getElementById(r.getId()+"-svg"):window.document.getElementById(a.getId()+"-svg");var h=this.mDragPoint.shapeBias.x;var l=e?i.getEventSVGPoint(o,t).x:i.getEventSVGPoint(o,t).x-h;if(a.getSnapMode()!==y.None){l=l-this.snapVal}var p=s.viewToTime(l);var d=p;var u=g.getRTL();var f=this.mDragPoint.shapeX+h,v=u?-this.mDragPoint.shapeWidth:this.mDragPoint.shapeWidth,c=this.mDragPoint.cursorX;var m=p;var D=p;var G=this.oLastDraggedShapeData.endTime-this.oLastDraggedShapeData.startTime;if(this.getGantt().getDragOrientation()===T.Vertical){m=this.oLastDraggedShapeData.startTime;D=this.oLastDraggedShapeData.endTime;d=m}else if(this.getGantt().getGhostAlignment()===S.Start){D=G?new Date(m.getTime()+G):s.viewToTime(l+v);d=p}else if(this.getGantt().getGhostAlignment()===S.End){m=G?new Date(D.getTime()-G):s.viewToTime(l-v);d=p}else if(this.getGantt().getGhostAlignment()===S.None){var E=u?l-v-(c-f):l-(c-f);var x=s.viewToTime(E);m=x;D=G?new Date(m.getTime()+G):s.viewToTime(E+v);d=x}return{newDateTime:d,cursorTime:p,time:m,endTime:D}};x.prototype._getDeltaMarkerDropEvent=function(t){if(this.isValidDropZoneForLines(t)){var e=jQuery(this.oMouseDownTarget).control(0,true).getParent();var a=g.getRTL();var r=this.getGantt().getGhostAlignment();var s=this.getGantt().getAxisTime();var o=i.getEventSVGPoint(this.getDomRefs().headerSvg,t);var h,l;var p=this.mDragPoint.shapeWidth,d=this.mDragPoint.shapeX,u=this.mDragPoint.cursorX;if(r===S.Start){h=a?o.x-p:o.x;l=a?o.x:o.x+p}else if(r===S.None){h=o.x+(d-u);l=h+p}else if(r===S.End){h=a?o.x:o.x-p;l=a?o.x+p:o.x}return{newStartTime:n.dateToAbapTimestamp(s.viewToTime(a?l:h)),newEndTime:n.dateToAbapTimestamp(s.viewToTime(a?h:l)),oldStartTime:e.getTimeStamp(),oldEndTime:e.getEndTimeStamp()}}};x.prototype._getDraggedShapeDates=function(){var t=this.getGantt(),e=t.getSelection();var a=e.allSelectedDraggableUid();var i={};a.forEach(function(a){var n=e.getSelectedShapeDataByUid(a),s;if(!n.time||!n.endTime){s=t.setTimeForGroupShape(r.getShapesWithUid(t.getId(),[a])[0])}i[a]={time:n.time||s&&s.getTime(),endTime:n.endTime||s&&s.getEndTime()}});return i};x.prototype.getDroppedShapeStartTime=function(t,e,a){if(this.getGantt().getGhostAlignment()===S.None){var i=this.mDragPoint.shapeX,r=this.mDragPoint.shapeWidth,s=this.mDragPoint.cursorX;var o=g.getRTL();var h=o?t+r-(s-i):t-(s-i);var l=e.viewToTime(h),p=n.abapTimestampToDate(l);return p}return a};x.prototype.isValidDropZone=function(t){return jQuery(t.target).closest("svg.sapGanttChartSvg").length===1};x.prototype.isValidDropZoneForLines=function(t){return jQuery(t.target).closest("svg.sapGanttChartHeaderSvg").length===1||jQuery(t.target).closest("svg.sapGanttChartSvg").length===1};x.prototype._hideScrollBarOnBody=function(t){jQuery(document.body).toggleClass("sapGanttDraggingOverflow",t)};x.prototype.onKeydown=function(e){if(this.skipEvent(e)){return}if(e.keyCode===t.ESCAPE){this.stopDragging(e);this.getGantt()._triggerCancelShapeDrop();this._initDragStates()}};x.prototype.stopDragging=function(t){this._enableTextSelection();this._avoidShapeSelectionAfterDragging();this.removeGhost();this.updateCursorStyle("default");this.updateHeaderCursorStyle("default");this._hideScrollBarOnBody(false);this._stopAutoScroll();E.removeDragDropEventListeners(this.getGantt())};x.prototype._avoidShapeSelectionAfterDragging=function(){if(this.bDragging&&this.oMouseDownTarget){var t=this.getShapeElementByTarget(this.oMouseDownTarget);window.setTimeout(function(){if(t){window.clearTimeout(t.iSingleClickTimer)}},100,this)}};x.prototype.isEventTargetDraggable=function(t){var e=this.getShapeElementByTarget(t.target);if(e){return e.getDraggable()&&(e.getSelected()||!this.getGantt().getEnableSelectAndDrag())}return false};x.prototype.getShapeElementByTarget=function(t){return jQuery(this.getDraggableDOMElement(t)).control(0,true)};x.prototype.getGanttChartByTarget=function(t){return jQuery(t).closest("svg.sapGanttChartSvg").control(0,true)};x.prototype.isEventTargetAdhocLine=function(t){return jQuery(t.target).control(0,true)&&jQuery(t.target).control(0,true).sParentAggregationName==="_marker"};x.prototype.isEventTargetDeltaLine=function(t){return jQuery(t.target).control(0,true)&&jQuery(t.target).control(0,true).sParentAggregationName==="_headerDeltaArea"};x.prototype.isAdhocLineDraggable=function(t){var e=jQuery(t.target).control(0,true).getParent();return e.getDraggable()&&e._getSelected()};x.prototype.isDeltaLineDraggable=function(t){var e=jQuery(t.target).control(0,true).getParent();return e.getDraggable()&&e._getIsSelected()};x.prototype.getDraggableDOMElement=function(t){return jQuery(t).closest("["+r.SHAPE_ID_DATASET_KEY+"]").get(0)};x.prototype.isExceedDraggingThreshold=function(t){return Math.abs(t.x-this.mDragPoint.cursorX)>D||Math.abs(t.y-this.mDragPoint.cursorY)>D};x.prototype.onDragging=function(t){if(this.dragGhost){this.isSnapping=false;var e=this.getGantt()._getPointerExtension();if(e.isPointerInGanttChart()===true&&e.isPointerInCorrectRow()===true){this.updateCursorStyle("move")}else{this.updateCursorStyle("not-allowed","none");this.updateHeaderCursorStyle("not-allowed","none");if(e.isPointerInGanttChart()!==true){this._stopAutoScroll()}}this.showGhost(t);this._disableTextSelection();if(this.getGantt().getSnapMode()!==y.None){this.executeSnappingEffect(t)}}};x.prototype.executeSnappingEffect=function(t){if(this.snapTimer){window.clearTimeout(this.snapTimer);this.snapTimer=null}this.snapTimer=window.setTimeout(function(){this.showGhost(t,true)}.bind(this),100)};x.prototype._stopAutoScroll=function(){var t=this.getGantt()._getPointerExtension();t._bAutoScroll=false};x.prototype.isDragging=function(){return this.bDragging};x.prototype.isAdhocLineDragging=function(){return this.adhocLineDragStart};x.prototype.isDeltaLineDragging=function(){return this.deltaLineDragStart};x.prototype.skipEvent=function(t){return this.bElementDraggable===false&&this.oAdhocLineElmDraggable===false&&this.oDeltaLineElmDraggable===false};x.prototype.showGhost=function(t,e){var a=this.getGantt().getGhostAlignment();var i=document.getElementById("sapGanttDragGhostWrapper");var n=this.adhocLineDragStart||this.deltaLineDragStart?this.calcGhostAligmentForLines(t,a):this.calcGhostOffsetByAlignment(t,a,e);if(this.adhocLineDragStart||this.deltaLineDragStart){var s=r.getTimeLabel(t,this.getGantt().getAxisTime(),this.getGantt().getLocale(),this.getDomRefs().headerSvg);document.getElementById("sapGanttDragText").innerText=s}i.style.left=n.left;i.style.top=n.top;if(!this._bGhostsPositioned){i.classList.remove("sapGanttDragElementHidden")}};x.prototype.calcGhostAligmentForLines=function(t,e){var a=g.getRTL();var r=i.xPosOfEvent(t);if(this.adhocLineDragStart){r-=this.mDragPoint.shapeWidth/2}if(this.deltaLineDragStart){var n=this.mDragPoint.shapeWidth,s=this.mDragPoint.shapeX,o=this.mDragPoint.cursorX;if(e===S.Start){r=a?r-n:r}else if(e===S.None){r=r+(s-o)}else if(e===S.End){r=a?r:r-n}}var h=i.getSvgScreenPoint(this.getDomRefs().headerSvg,{pageX:this.mDragPoint.cursorX,clientX:this.mDragPoint.cursorX,pageY:this.mDragPoint.cursorY,clientY:this.mDragPoint.cursorY});return{left:r+"px",top:h.y+"px"}};x.prototype.calcGhostOffsetByAlignment=function(t,e,a){var r=g.getRTL();var n=this.mDragPoint.shapeWidth,s=this.mDragPoint.shapeX+this.mDragPoint.shapeBias.x,o=this.mDragPoint.cursorX;var h;var l=document.getElementById("sapGanttDragGhostWrapper").offsetWidth-document.getElementsByClassName("sapGanttDragGhostImg")[0].offsetWidth;var p=i.xPosOfEvent(t);if(this.getGantt().getDragOrientation()===T.Vertical){var d=i.getSvgScreenPoint(this.getDomRefs().ganttSvg,{pageX:this.mDragPoint.shapeX,clientX:this.mDragPoint.shapeX,pageY:this.mDragPoint.shapeY,clientY:this.mDragPoint.shapeY});h=d.x+this.mDragPoint.shapeBias.x}else if(e===S.Start){h=r?p-n:p}else if(e===S.None){h=p+(s-o)}else if(e===S.End){h=r?p:p-n}var u=i.getEventPosition(t).pageY-2;if(this.getGantt().getDragOrientation()===T.Horizontal){var f=i.getSvgScreenPoint(this.getDomRefs().ganttSvg,{pageX:this.mDragPoint.shapeX,clientX:this.mDragPoint.shapeX,pageY:this.mDragPoint.shapeY,clientY:this.mDragPoint.shapeY});u=f.y+this.mDragPoint.shapeBias.y}if(a){this._generateSnapvalue(t,n);h=h-this.snapVal}if(r&&this.bMultipleGhosts){h=h-l}return{left:h+"px",top:u+"px"}};x.prototype._getSnapOffsetByAligment=function(t,e){var a={};var i=this.mDragPoint.shapeWidth;var r=g.getRTL();if(e===S.Start){a.xPosStart=t.x;a.xPosEnd=r?t.x-i:t.x+i}else if(e===S.End){a.xPosStart=r?t.x+i:t.x-i;a.xPosEnd=t.x}else if(e===S.None){a.xPosStart=t.x-(this.mDragPoint.cursorX-this.mDragPoint.shapeX-this.mDragPoint.shapeBias.x);a.xPosEnd=a.xPosStart+i}return a};x.prototype._getSnappedTime=function(t,e,a,i){var r,n;var s=t%e;if(s>e/2){n=e-s;r=new Date(a.getTime()+n*i)}else{n=s;r=new Date(a.getTime()-n*i)}return r};x.prototype._computeSnapping=function(t,e,a){var i=this.getGantt();var r=g.getRTL();var n=this.getGantt().getGhostAlignment();var s=this.mDragPoint.shapeWidth;var o,h;if(i.getSnapMode()===y.Left){o=r?e-1:t-1;h=r?a.x-o-s:a.x-o}else if(i.getSnapMode()===y.Right){o=r?t+1:e+1;h=r?a.x-o:a.x-o+s}else if(Math.abs(t)<Math.abs(e)){o=r?t-1:t-1;h=r?a.x-o:a.x-o}else{o=r?e-1:e+1;h=r?a.x-o-s:a.x-o+s}if(Math.abs(o)<Math.abs(this.snapVal)){this.snapVal=o;if(n===S.Start){this.cursorLineSnapPoint=h}else if(n===S.End){this.cursorLineSnapPoint=r?h+s:h-s}else if(n===S.None){this.cursorLineSnapPoint=r?h-this.mDragPoint.cursorX:h-(this.mDragPoint.cursorX-this.mDragPoint.shapeX)}}};x.prototype._computeSnapByTime=function(t,e,a,i){var r=g.getRTL();var n=this.getGantt();var s=n.getAxisTime();var o=i[a].timeInterval/60;var h=6e4;var l=s.viewToTime(t.xPosStart);var p=s.viewToTime(t.xPosEnd);var d=l.getMinutes();var u=p.getMinutes();if(o>60){d=l.getHours();u=p.getHours();o=o/60;if(d%o===0||u%o===0){d=l.getMinutes()%30;u=p.getMinutes()%30;l.setMinutes(d);p.setMinutes(u);o=60}else{l.setMinutes(0);p.setMinutes(0);h=36e5}}else if(o<1){d=l.getSeconds();u=p.getSeconds();h=1e3;o=o*60}else{l.setSeconds(0);p.setSeconds(0)}if(d%o!==0||u%o!==0){var f=r?this._getSnappedTime(u,o,p,h):this._getSnappedTime(d,o,l,h);var v=r?this._getSnappedTime(d,o,l,h):this._getSnappedTime(u,o,p,h);var c=s.timeToView(f);var m=s.timeToView(v);if(r){this._computeSnapping(t.xPosEnd-c-1,t.xPosStart-m+1,e)}else{this._computeSnapping(t.xPosStart-c+1,t.xPosEnd-m-1,e)}e.x=e.x-this.snapVal;n._getPointerExtension()._toggleCursorLine(true,e);this.isSnapping=true}else{this.snapVal=0}};x.prototype._generateSnapvalue=function(t){var e=g.getRTL();var a=this.getGantt().getGhostAlignment();var n=this.getDomRefs().ganttSvg;var o=i.getEventSVGPoint(n,t);var h=this._getSnapOffsetByAligment(o,a);var l=h.xPosStart;var p=h.xPosEnd;var d=o.y;var u=this.getGantt();var f=u._getPointerExtension();var v=u.getAxisTime();var c;var m=v.getZoomStrategy().getTimeLineOption(),D=v.getZoomStrategy().getTimeLineOptions();var S;var y=false;var T=Object.keys(D);var G=0;while(!y&&G<T.length){S=T[G];if(D[S]===m){c=S;y=true}G++}var E=u.getSnapTimeInterval();var x=v.getZoomStrategy();this.snapVal=Number.MAX_SAFE_INTEGER/2;if(E[c]&&E[c].timeInterval){this._computeSnapByTime(h,o,c,E);return}var b=s.getGanttRenderWidth(u);var _=v.getTickTimeIntervalLabel(x.getTimeLineOption(),null,[0,b]);var P=_[1];P.forEach(function(t){this._computeSnapping(l-t.value,p-t.value,o)}.bind(this));var w=r.getVisibleElements(n,".sapGanttChartDeltaLine",".baseShapeSelection");w.forEach(function(t){var e=t.getBBox().x;this._computeSnapping(l-e,p-e,o)}.bind(this));var L=r.getVisibleElements(n,".sapGanttChartAdhocLine",".baseShapeSelection");L.forEach(function(t){var e=t.getBBox().x;this._computeSnapping(l-e,p-e,o)}.bind(this));var B=r.getVisibleElements(n,".sapGanttChartShapes",".baseShapeSelection");B.forEach(function(t){var a=t.getBBox().x,i=a+t.getBBox().width,r=t.getBBox().y,n=r+t.getBBox().height;var s=d+t.getBBox().height;if(d>r&&d<n||s>r&&s<n){var g=e?l-a:l-i;var h=e?p-i:p-a;this._computeSnapping(g,h,o)}}.bind(this));var C=r.getVisibleElements(n,".calendarPattern","rect");C.forEach(function(t){var a=t.getBBox().x,i=a+t.getBBox().width;var r=e?l-a:l-i;var n=e?p-i:p-a;this._computeSnapping(r,n,o)}.bind(this));o.x=this.cursorLineSnapPoint;f._toggleCursorLine(true,o);this.isSnapping=true};x.prototype.removeGhost=function(){this.dragGhost=null;var t=document.getElementById("sapGanttDragGhostWrapper");if(t){t.parentNode.removeChild(t)}};x.prototype.createDragGhost=function(t,e){var a=jQuery("<div id='sapGanttDragGhostWrapper' class='sapGanttDragElementHidden'></div>");if(!this.bMultipleGhosts||e){jQuery(document.body).append(a)}var i=document.createElement("canvas");var r=t.getBBox();i.width=this.normalizeGhostImageWidth(r.width);i.height=r.height;if(this.adhocLineDrag){var n=jQuery(this.oMouseDownTarget).control(0,true).getParent()._getLine();var s=document.getElementById(n.sId);var o=jQuery(this.oMouseDownTarget).control(0,true).getParent()._getHeaderLine();var g=document.getElementById(o.sId);var h=s.getBBox();var l=g.getBBox();i.height+=h.height+l.height}if(this.deltaLineDrag){var p=jQuery(this.oMouseDownTarget).control(0,true).getParent();if(p.getVisibleDeltaStartEndLines()){var d=p._getStartLine();var u=p._getEndLine();var f=p._getHeaderStartLine();var v=p._getHeaderEndLine();var c=document.getElementById(d.sId);var m=document.getElementById(u.sId);var D=document.getElementById(f.sId);var S=document.getElementById(v.sId);var y={headerStartLine:D,startLine:c,headerEndLine:S,endLine:m};var T=D.getBBox();var G=c.getBBox();i.height+=G.height+T.height}}this.createGhostImage(t,i,g,s,y,e);return a};x.prototype.normalizeGhostImageWidth=function(t){return t};x.prototype.createGhostImage=function(t,e,a,i,r,n){var s=this.serializeClonedSvg(e,t,a,i,r);var o=this._b64EncodeUnicode(s);var g="data:image/svg+xml;base64,"+o;this.appendGhostImageToWrapper(t,g,n)};x.prototype._b64EncodeUnicode=function(t){return btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,function t(e,a){return String.fromCharCode("0x"+a)}))};x.prototype.appendGhostImageToWrapper=function(t,e,a){var i=document.getElementById("sapGanttDragGhostWrapper");var r=this._getDragTextOverlayStyle(t);var n=a?"":"<div id='sapGanttDragText' class='sapGanttDragTextOverlay "+r.css+"'>"+"</div>";var s=h.getElementById(t.id);var o=!s&&t.parentNode&&h.getElementById(t.parentNode.id)instanceof sap.gantt.simple.BaseGroup;var g=!s&&t.parentNode&&t.parentNode.parentNode&&h.getElementById(t.parentNode.parentNode.id)instanceof sap.gantt.simple.BaseGroup;var l=this.getGantt().getEnableMultipleGhosts();if(o){s=h.getElementById(t.parentNode.id)}else if(g){s=h.getElementById(t.parentNode.parentNode.id)}if(l&&a&&this.getGantt().getShowTextOnGhost()){n=this._getGhostLabel(s,t)}if(!l){var p=this.getNumberOfDragObject(t);n="<div id='sapGanttDragText' class='sapGanttDragTextOverlay "+r.css+"'>"+p+"</div>"}if(this.bMultipleGhosts){var d;if(o){d=t.parentNode}else if(g){d=t.parentNode.parentNode}else{d=t}this._aShapeNodes.push(d);this._aGhostImages.push(e);if(!a){n=""}}var u="<div class='sapGanttDragGhost'>"+"<img class='sapGanttDragGhostImg' src='"+e+"'>"+n+"</div>";i.insertAdjacentHTML("beforeend",u);if(l&&a&&this.getGantt().getShowTextOnGhost()&&n!==""){this._updateGhostLabelStyle()}};x.prototype._getDragTextOverlayStyle=function(t){var e=g.getRTL();var a=this.getGantt().getGhostAlignment();var i=this.mDragPoint.shapeWidth,r=this.mDragPoint.shapeX+this.mDragPoint.shapeBias.x,n=this.mDragPoint.cursorX;var s=n-r;var o=document.getElementById("sapGanttDragGhostWrapper");var h="";if(a===S.None){if(e){o.style.setProperty("--sapShapeDragTextOverlay-right-val",i-s+"px")}else{o.style.setProperty("--sapShapeDragTextOverlay-left-val",s+"px")}}else if(a===S.End){h="sapGanttDragTextOverlayGhostAlignEnd"}o.style.setProperty("--sapShapeDragTextOverlay-lineHeight",t.getBBox().height+"px");return{css:h}};x.prototype._updateShapeStyle=function(t){var e=h.getElementById(t.id);if(e&&e.mProperties.hasOwnProperty("styleName")){if(this._oGhostStyleConfigs[e.getStyleName()]){this._updateStyle(t,this._oGhostStyleConfigs[e.getStyleName()])}}};x.prototype._updateStyle=function(t,e){if(e.mProperties.hasOwnProperty("visible")&&!e.getVisible()){t.style.display="none"}else{if(e.mProperties.hasOwnProperty("fill")){t.style.fill=e.getFill()}if(e.mProperties.hasOwnProperty("stroke")){t.style.stroke=e.getStroke()}if(e.mProperties.hasOwnProperty("strokeWidth")){t.style.strokeWidth=e.getStrokeWidth()}if(e.mProperties.hasOwnProperty("strokeDasharray")){t.style.strokeDasharray=e.getStrokeDasharray()}}};x.prototype._updateGhostShapeStyle=function(t){if(t.tagName=="g"){Array.from(t.getElementsByClassName("baseShapeSelection")).forEach(function(t){this._updateShapeStyle(t)}.bind(this))}else{this._updateShapeStyle(t)}};x.prototype.serializeClonedSvg=function(t,e,a,i,r){var n=d3.ns.prefix.svg;var s=e.getBBox();var o=g.getRTL();var l=document.createElementNS(n,"svg");l.setAttribute("width",t.width);l.setAttribute("height",t.height);var p=e.cloneNode(true);if(!this._oGhostStyleConfigs){this._oGhostStyleConfigs=this._getGhostStyleConfig()}this._updateGhostShapeStyle(p);p.style.transform="translate(0, 0)";if(!this.getGantt().getShowTextOnGhost()){this.removeOriginalTextNode(p)}else if(o&&(p.tagName==="g"||p.tagName==="text")){this._aOriginalTextX=[];this._iCount=0;this._populateTextNodeX(e);this._repositionTextNode(p)}var d=document.createElementNS(n,"g");d.setAttribute("transform","translate("+-s.x+", "+-s.y+")");d.appendChild(p);if(this.adhocLineDrag){var u=a.cloneNode(true);var f=i.cloneNode(true);d.appendChild(u);d.appendChild(f)}if(this.deltaLineDrag){var v=h.getElementById(this.oMouseDownTarget.id).getParent();if(v.getVisibleDeltaStartEndLines()){var c=r.headerStartLine.cloneNode(true);var m=r.startLine.cloneNode(true);var D=r.headerEndLine.cloneNode(true);var S=r.endLine.cloneNode(true);d.appendChild(c);d.appendChild(m);d.appendChild(D);d.appendChild(S)}}var y=this.getGantt().getSvgDefs();if(y){var T=jQuery(document.getElementById(y.getId())).get(0).cloneNode(true);l.appendChild(T)}l.appendChild(d);return(new XMLSerializer).serializeToString(l)};x.prototype.removeOriginalTextNode=function(t){if(t.parentNode&&t.tagName==="text"){t.parentNode.removeChild(t)}var e=t.children||t.childNodes;var a=Array.prototype.slice.call(e);a.forEach(function(t){this.removeOriginalTextNode(t)}.bind(this))};x.prototype._repositionTextNode=function(t){if(t.tagName==="text"){t.setAttribute("x",this._aOriginalTextX[this._iCount]);this._iCount++}var e=t.children||t.childNodes;var a=Array.prototype.slice.call(e);a.forEach(function(t){this._repositionTextNode(t)}.bind(this))};x.prototype._populateTextNodeX=function(t){if(t.tagName==="text"){var e=0;var a=t.getAttribute("text-anchor");var i=t.getBBox();if(a==="start"){e=i.x}else if(a==="end"){e=i.x+i.width}else{e=i.x+i.width/2}this._aOriginalTextX.push(e)}var r=t.children||t.childNodes;var n=Array.prototype.slice.call(r);n.forEach(function(t){this._populateTextNodeX(t)}.bind(this))};x.prototype.getNumberOfDragObject=function(t){var e=this.getGantt().getSelection();var a=e.numberOfSelectedDraggableShapes();var i=l.getResourceBundleFor("sap.gantt");var r=i.getText("GNT_DRAGGED_OBJECT");var n=i.getText("GNT_DRAGGED_OBJECTS");var s=a>1?n:r;return a+" "+s};x.prototype._disableTextSelection=function(){jQuery(document.body).attr("unselectable","on").css({"-moz-user-select":"none","-webkit-user-select":"none","user-select":"none"}).on("selectstart",function(t){t.preventDefault();return false})};x.prototype._enableTextSelection=function(){jQuery(document.body).attr("unselectable","off").css({"-moz-user-select":"","-webkit-user-select":"","user-select":""}).off("selectstart")};x.prototype.isAllowedVerticalOrentationDrag=function(){var t=this.getGantt();if(t.getDragOrientation()===T.Vertical){return t.oSelection.numberOfSelectedDraggableShapes()<2}return true};x.prototype.getRowByShape=function(t){var e=r.getRowInstancefromShape(t);var a=e.clone();a=this._addBackOriginalGanttRowProperties(e,a);return a};x.prototype._addBackOriginalGanttRowProperties=function(t,e){e.oPropagatedProperties=t._getPropertiesToPropagate();e.propagateProperties(true);e.oParent=t.getParent();return e};return x});
//# sourceMappingURL=GanttDragDropExtension.js.map