/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/Log","sap/ui/events/KeyCodes","sap/gantt/config/TimeHorizon","./GanttExtension","./CoordinateUtils","./AggregationUtils","sap/ui/core/Core"],function(jQuery,e,t,o,i,n,r,a){"use strict";var s=["mousedown","mousemove","mouseup","wheel","MozMousePixelScroll"];var m=s.reduce(function(e,t){e[t]=t;return e},{});m.keydown="keydown";m.periodZoom="periodZoom";var g=".sapGanttZoom";var l=function(e){return e+g};s=s.map(l);var h=m.periodZoom+g;var d=m.keydown+g;var u={start:"zoomStart",zooming:"zooming",end:"zoomEnd"};var v={dispatch:function(e,t){var o=this._getZoomExtension(),i=e.originalEvent||e;if(o.isMouseWheelZoom(e)){var n=t&&t.suppressSyncEvent;o.performMouseWheelZooming(i,n);return}if(t&&t.which){i.which=t.which}o.performTimePeriodZooming(i)},addEventListeners:function(e){var o=e._getZoomExtension(),i=o.getDomRefs(),n=i.ganttSvg,r=i.gantt,a=i.headerSvg;var g=function(t,o){jQuery(o).on(t,v.dispatch.bind(e))};v.removeEventListeners(e);s.forEach(function(e){g(e,n);if(e.startsWith(m.wheel)){g(e,a)}});jQuery(r).on(h,v.dispatch.bind(e));jQuery(document).on(d,function(e){if(e.which===t.Z||e.which===t.ESCAPE){jQuery(this).find(".sapGanttChartContentBody").trigger(h,{which:e.which})}});if(n){var l=document.querySelectorAll(".sc-tooltips");if(!e.fnStockChartMouseMoveListener){e.fnStockChartMouseMoveListener=this.fnStockChartMouseMoveHandler.bind(this)}for(var u=0;u<l.length;u++){l[u].removeEventListener("mousemove",e.fnStockChartMouseMoveListener);l[u].addEventListener("mousemove",e.fnStockChartMouseMoveListener)}}},fnStockChartMouseMoveHandler:function(e){function t(e,t){var o=document.elementsFromPoint(e,t);var i="",n="";var r=new Map,s=new Map;o.forEach(function(e){if(e&&e.tagName==="rect"&&e.children&&e.children.length&&e.children[0].tagName==="title"){if(e.classList.contains("stockChartTooltip")){e.style.pointerEvents="none"}else{var t=e.children[0].innerHTML;var o=e.getAttribute("data-text");var i=a.byId(e.id)&&a.byId(e.id).isA("sap.gantt.simple.BaseCalendar");if(o&&t.trim().length>0){r.set(o,t)}else if(!(o||i)){var n=t.split("\n").reverse();n.forEach(function(e){var t=e.split(":");if(t.length>1){var o=t[0];var i=t[1];s.set(o,i)}})}if(!i){e.style.pointerEvents="none"}}}});for(const e of r.keys()){s.delete(e)}i=Array.from(s.entries()).reverse().map(function(e){return e[0]+":"+e[1]}).join("\n");n=Array.from(r.entries()).reverse().map(function(e){return e[1]}).join("\n");if(i.length&&n.length){return n+"\n"+i}else if(n.length){return n}else if(i.length){return i}return""}var o=e.currentTarget;var i=o.querySelectorAll(".sc-tooltips rect");i.forEach(function(e){e.style.pointerEvents="all"});var n=t(e.clientX,e.clientY);for(var r=0;r<o.children.length;r++){var s=o.children[r];if(s.classList.contains("stockChartTooltip")){s.getElementsByTagName("title")[0].innerHTML=n;s.style.pointerEvents="all";s.setAttribute("width",o.getBoundingClientRect().width)}}},removeEventListeners:function(e){var t=e._getZoomExtension(),o=t.getDomRefs(),i=o.ganttSvg,n=o.gantt,r=o.headerSvg;jQuery(i).off(g);jQuery(r).off(g);jQuery(n).off(g);jQuery(document).off(g)}};var c=i.extend("sap.gantt.GanttZoomExtension",{_init:function(e,t){this.bTimePeriodZoomMode=false;this.oZoomStartTime=null;this.iMouseWheelZoomDelayedCallId=undefined;this.iLastMouseWheelZoomTimeInMs=0;return"ZoomExtension"},_attachEvents:function(){var e=this.getGantt();v.removeEventListeners(e);v.addEventListeners(e)},_detachEvents:function(){var e=this.getGantt();v.removeEventListeners(e)}});c.prototype.isMouseWheelZoom=function(e){var t=e.shiftKey&&e.ctrlKey&&(e.type===m.wheel||e.type===m.MozMousePixelScroll);if(t){e.preventDefault();e.stopImmediatePropagation();e.stopPropagation()}return t};i.prototype.performMouseWheelZooming=function(e,t){var o=this._getWheelScrollDelta(e),i=this._getMousePositionX(e);this.decideMouseWheelZoom(e,o,i,t)};c.prototype._getWheelScrollDelta=function(e){var t=e.deltaY||e.deltaX;if(t===0||t===undefined){t=e.detail}var o=e.deltaMode===1?33:1;return t*o};c.prototype._getMousePositionX=function(e){return n.xPosOfSvgElement(e,jQuery(this.getDomRefs().ganttSvg))};c.prototype.decideMouseWheelZoom=function(e,t,o,i){var n=this.getGantt(),r=n.getAxisTimeStrategy();if(r.getMouseWheelZoomType()===sap.gantt.MouseWheelZoomType.None){return}var a=t<0,s=!a;var m=r.getZoomLevel(),g=r.getZoomLevels()-1;if(s&&m>0||a&&m<g){var l=!this.iMouseWheelZoomDelayedCallId&&Date.now()-this.iLastMouseWheelZoomTimeInMs>100?0:700;if(l===0){this.onMouseWheelZooming(e,r,o,t,i)}else{this.iMouseWheelZoomDelayedCallId=this.iMouseWheelZoomDelayedCallId||window.setTimeout(this.onMouseWheelZooming.bind(this),l,e,r,o,t,i)}}};c.prototype.onMouseWheelZooming=function(e,t,o,i,n){this.iLastMouseWheelZoomTimeInMs=Date.now();var r=t.getAxisTime().viewToTime(o);t.updateVisibleHorizonOnMouseWheelZoom(r,i,e,n);window.clearTimeout(this.iMouseWheelZoomDelayedCallId);delete this.iMouseWheelZoomDelayedCallId};c.prototype.performTimePeriodZooming=function(e){var o=this.getGantt()._getPointerExtension();var i=o.isPointerInGanttChart();var n=this.getGantt().getAxisTimeStrategy();if(!n.isTimePeriodZoomEnabled()){return}if(i===false){return}if(e.type===m.periodZoom){if(e.which===t.Z&&o.isPointerInGanttChart()){this.bTimePeriodZoomMode=!this.bTimePeriodZoomMode}if(e.which===t.ESCAPE){this.bTimePeriodZoomMode=false}this.updateCursorStyle(this.bTimePeriodZoomMode)}if(e.type===m.mousedown&&e.button===0){if(this.bTimePeriodZoomMode){this.handleZoomStart(e);this._fireTimePeriodZoomEvent({type:u.start,zoomStartTime:this.oZoomStartTime,zoomEndTime:null,originalEvent:e})}}if(e.type===m.mousemove&&this.bTimePeriodZoomMode){var r=this.timeFromEvent(e);this.handleZooming(e);this._fireTimePeriodZoomEvent({type:u.zooming,zoomStartTime:this.oZoomStartTime,zoomEndTime:r,originalEvent:e})}if(e.type===m.mouseup&&this.bTimePeriodZoomMode){this.bTimePeriodZoomMode=false;var r=this.timeFromEvent(e);this.handleZoomEnd(e);this._fireTimePeriodZoomEvent({type:u.end,zoomStartTime:this.oZoomStartTime,zoomEndTime:r,originalEvent:e})}};c.prototype.timeFromEvent=function(e){var t=jQuery(this.getDomRefs().ganttSvg),o=n.xPosOfSvgElement(e,t);var i=this.getGantt()._getPointerExtension();o+=i._getAutoScrollStep();return this.getGantt().getAxisTime().viewToTime(o)};c.prototype._fireTimePeriodZoomEvent=function(e){this.getGantt().fireEvent("_timePeriodZoomOperation",e)};c.prototype.syncTimePeriodZoomOperation=function(t,o,i){var n=t.getParameter("originalEvent");var r=t.getParameter("type");switch(r){case u.start:this.handleZoomStart(n);break;case u.zooming:this.handleZooming(n);break;case u.end:this.handleZoomEnd(n,true);break;default:e.debug("unknown time period zoom type")}};c.prototype.handleZoomStart=function(e){this.oZoomStartTime=this.timeFromEvent(e);var t=this.getGantt().getAxisTime().timeToView(this.oZoomStartTime);this.updateCursorStyle(this.bTimePeriodZoomMode);this.createZoomingRectangle(t)};c.prototype.handleZooming=function(e){this._isZooming=true;var t=this.oZoomStartTime;var o=this.timeFromEvent(e);var i=this.getGantt().getAxisTime(),n=i.timeToView(t),r=i.timeToView(o);this.updateCursorStyle(this.bTimePeriodZoomMode);if(r>n){this.updateZoomingRectangle(n,r)}else{this.updateZoomingRectangle(r,n)}};c.prototype.isZoomingRectangleNotExisted=function(){var e=d3.select(this.getDomRefs().ganttSvg);return e.selectAll(".sapGanttChartTimePeriodZoomRectangle").length===0};c.prototype.isTimeZooming=function(){return this._isZooming};c.prototype._handleAutoScroll=function(e){if(this.isTimeZooming()){if(this.isZoomingRectangleNotExisted()){var t=this.oZoomStartTime;var o=this.getGantt().getAxisTime(),i=o.timeToView(t);this.createZoomingRectangle(i)}this.handleZooming(e)}};c.prototype.handleZoomEnd=function(e,t){this._isZooming=false;var i=this.timeFromEvent(e);this.updateCursorStyle(this.bTimePeriodZoomMode);this.destroyZoomingRectangle();var n=this.getGantt().getAxisTime(),r=n.timeToView(this.oZoomStartTime),a=n.timeToView(i);var s=5;if(Math.abs(a-r)>s){var m=this.oZoomStartTime,g=i;if(i.getTime()<m.getTime()){var l=m;m=i;g=l}var h=new o({startTime:m,endTime:g});this.getGantt().syncVisibleHorizon(h,undefined,undefined,t?undefined:"timePeriodZooming")}};c.prototype.updateCursorStyle=function(e){var t=e?"crosshair":"auto";this.getDomRefs().ganttSvg.style.cursor=t;this.getDomRefs().headerSvg.style.cursor=t};c.prototype.createZoomingRectangle=function(e){var t=d3.select(this.getDomRefs().ganttSvg);this.destroyZoomingRectangle();t.append("rect").classed("sapGanttChartTimePeriodZoomRectangle",true).attr("x",e).attr("y",0).attr("height",jQuery(t.node()).height())};c.prototype.updateZoomingRectangle=function(e,t){var o=d3.select(this.getDomRefs().ganttSvg);o.selectAll(".sapGanttChartTimePeriodZoomRectangle").attr("x",e).attr("width",t-e)};c.prototype.destroyZoomingRectangle=function(){var e=d3.select(this.getDomRefs().ganttSvg);e.selectAll(".sapGanttChartTimePeriodZoomRectangle").remove()};c.prototype.doBirdEye=function(e){var t=this.getGantt();var i=this.calculateBirdEyeRange(e);var n=new o(i);t.getAxisTimeStrategy()._setVisibleHorizon(n)};c.prototype.calculateBirdEyeRange=function(e,t){var o=this.getGantt();var i=o.getTable();var n=i.getRows();var r;var a;var s;e=e?e-n[0].getIndex():e;var m=n[e]?true:false;if(e!=null&&e>=0&&m){r=this._getBirdEyeRangeOnRow(e);a=r.startTime;s=r.endTime}else if(e!=null&&e>=0&&!m){return null}else{for(var g=0;g<n.length;g++){r=this._getBirdEyeRangeOnRow(g,t);if(r.startTime&&r.endTime){var l=this._calculateBirdEyeTimeRange(a,s,r.startTime,r.endTime);a=l.startTime;s=l.endTime}}}var h={startTime:a,endTime:s};return h};c.prototype._getBirdEyeRangeOnRow=function(e,t){var o=this.getGantt();var i=o.getTable();var n=i.getBindingInfo("rows"),r=n&&n.model;var a=i.getRows();var s=a[e];var m=s.getBindingContext(r);var g;var l;if(m){var h=s.getAggregation("_settings");var d=[];d=this._getShapeInRow(h,d);var u=this;d.forEach(function(e){if(e instanceof sap.gantt.simple.BaseConditionalShape){e=e._getActiveShapeElement();if(e instanceof sap.gantt.simple.BaseGroup){e.getShapes().forEach(function(e){if(e.getCountInBirdEye&&e.getCountInBirdEye()){var t=e.getTime();var o=e.getEndTime();var i=u._calculateBirdEyeTimeRange(g,l,t,o);g=i.startTime;l=i.endTime}});return}}if(e instanceof sap.gantt.simple.BaseGroup&&e.isPseudoShape&&e.getCountInBirdEye&&e.getCountInBirdEye()){var t=e.groupBirdEyeRangeStartTime;var o=e.groupBirdEyeRangeEndTime;var i=u._calculateBirdEyeTimeRange(g,l,t,o);g=i.startTime;l=i.endTime;return}if(e&&e.getCountInBirdEye&&e.getCountInBirdEye()){var t=e.getTime();var o=e.getEndTime();var i=u._calculateBirdEyeTimeRange(g,l,t,o);g=i.startTime;l=i.endTime}})}if(g&&l){var v=o.getVisibleWidth();var c=(l.getTime()-g.getTime())/v;var f=o.getAxisTime();g=t?new Date(g.getTime()-c*5):f.viewToTime(f.timeToView(g)-5);l=t?new Date(l.getTime()+c*5):f.viewToTime(f.timeToView(l)+5)}var p={startTime:g,endTime:l};return p};c.prototype._getShapeInRow=function(e,t){var o=r.getAllNonLazyAggregations(e);var i=this;Object.keys(o).forEach(function(o){var n=e.getAggregation(o);if(n&&typeof n!="string"){n=Array.isArray(n)?n:[n];if(n.length>0){t=t.concat(n);n.forEach(function(e){t=i._getShapeInRow(e,t)})}}});if(e.isA("sap.gantt.simple.GanttRowSettings")){var n=e.getRowUid(),a=this.getGantt(),s=e.getParent().getIndex(),m=this.getGantt()._oExpandModel,g=m.isRowExpanded(n),l=a.oOverlapShapeIds&&a.oOverlapShapeIds[s]&&a.oOverlapShapeIds[s].length;var h=r._fetchOverlayAggregation(e,!g||l,false,m.aShapeSchemes);t=t.concat(h)}return t};c.prototype._calculateBirdEyeTimeRange=function(e,t,o,i){if(!e||o.getTime()<e.getTime()){e=o}if(!t||t.getTime()<i.getTime()){t=i}return{startTime:e,endTime:t}};return c});
//# sourceMappingURL=GanttZoomExtension.js.map