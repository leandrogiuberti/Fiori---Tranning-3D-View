/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["./MultiActivityGroup","sap/gantt/simple/BaseRectangle","./GanttUtils","sap/ui/core/theming/Parameters","sap/gantt/simple/BaseImage","sap/gantt/def/gradient/LinearGradient","sap/gantt/misc/Format","sap/gantt/def/gradient/Stop","sap/ui/core/Core","sap/gantt/library","sap/gantt/utils/GanttChartConfigurationUtils"],function(e,t,a,i,r,n,o,s,p,g,l){"use strict";var d=e.extend("sap.gantt.simple.BasePseudoShape",{metadata:{properties:{expandTitle:{type:"string",defaultValue:g.simple.pseudoShapeTitle.Expand},collapseTitle:{type:"string",defaultValue:g.simple.pseudoShapeTitle.Collapse},overlapFill:{type:"sap.gantt.ValueSVGPaintServer",defaultValue:"sapChart_Sequence_1_Minus4"},fill:{type:"sap.gantt.ValueSVGPaintServer",defaultValue:"sapChart_Sequence_1"},typeOfOverlapIndicator:{type:"string",defaultValue:g.simple.typeOfOverlapIndicator.Gradient}},aggregations:{button:{type:"sap.gantt.simple.BaseShape",sapGanttOrder:2,visibility:"hidden"}}}});d.prototype.getButton=function(){return this.getAggregation("button")};d.prototype.onclick=function(e){if(e&&e.target.getAttribute("class").indexOf("pseudoShapeIcon")==-1){return}var t=this.getGanttChartBase();var a=t.getTable();var i=a.getRowSettingsTemplate();var r=a.getRows();var n=this.getParentRowSettings().getParent().getIndex()-r[0].getIndex();var o=r[n];t.oOverlapShapeIds=t.oOverlapShapeIds?t.oOverlapShapeIds:{};var s=t.oOverlapShapeIds&&t.oOverlapShapeIds[o.getIndex()]?t.oOverlapShapeIds&&t.oOverlapShapeIds[o.getIndex()]:[];var p=this.aShapeIds.length>0&&(s.length==0||this.aShapeIds.indexOf(s[0])==-1);var g=o.getIndex();var l;if(s&&t._aExpandedIndices.length>0&&t._aExpandedIndices.indexOf(g)>-1){t._collapse(l,g,true)}if(p){var d=a.getBindingInfo("rows").model;var h=o.getAggregation("_settings");t.oOverlapShapeIds[o.getIndex()]=[];var m=t._getPossibleShapesInGantt();var f=[];m.forEach(function(e){var t=i.getBindingInfo(e);f.push(t)});this.aShapeContexts.forEach(function(e){var a=m.indexOf(e.aggrType);var i=f[a]&&f[a].template.clone();if(i){i.setBindingContext(e,d);h.addAggregation(e.aggrType,i,true);t.oOverlapShapeIds[g].push(h.getAggregation(e.aggrType)[h.getAggregation(e.aggrType).length-1].getShapeId())}});t._expand(l,g,true)}};d.prototype._timeFormatter=function(e,t){var a=e.getProperty(t.startTime);var i=e.getProperty(t.endTime);var r=e.timeFormatter?e.timeFormatter(a):a,n=e.endTimeFormatter?e.endTimeFormatter(i):i;return{time:r,endTime:n}};d.prototype._createPseudoShape=function(e,a,n,o){var s=sap.gantt.simple.horizontalTextAlignment,p;var g=new d;var l=i.get({name:["sapUiChartAxisTitleFontSize","sapUiChartTitleFontWeight","sapUiChartReferenceLineLabelColor"],callback:function(e){l=e}});var h=function(e,t){return new r({height:parseFloat(l.sapUiChartAxisTitleFontSize,100)*16,fontWeight:l.sapUiChartTitleFontWeight,src:e,fill:l.sapUiChartReferenceLineLabelColor,horizontalTextAlignment:t.getHorizontalTextAlignment(),time:t.getTime(),endTime:t.getEndTime()})};g.setAggregation("task",new t({time:e.startTime,endTime:e.endTime,horizontalTextAlignment:s.Start,fontSize:parseFloat(l.sapUiChartAxisTitleFontSize,100)*16,fontWeight:l.sapUiChartTitleFontWeight}));var m=g.getTask();e.overlaps.forEach(function(e){if(g.getTypeOfOverlapIndicator()!="Gradient"){m._iBaseRowHeight=n._oExpandModel.getBaseRowHeight()?n._oExpandModel.getBaseRowHeight():m._iBaseRowHeight;var a=m.getHeight();g.addAggregation("indicators",new t({time:e.startTime,endTime:e.endTime,yBias:a+2}).addStyleClass("sapGanttPseudoShapeOverlapIndicatorStyle"))}});if(o&&n.oOverlapShapeIds&&n.oOverlapShapeIds[a.getIndex()]&&e.aShapeIds&&e.aShapeIds.some(function(e){return n.oOverlapShapeIds[a.getIndex()].includes(e)})){p=h("sap-icon://collapse",m);m.setTitle(g.getCollapseTitle())}else{p=h("sap-icon://expand",m);m.setTitle(g.getExpandTitle())}m.setTitleColor(l.sapUiChartReferenceLineLabelColor);p.aCustomStyleClasses=["pseudoShapeIcon"];g.addAggregation("button",p);return g};d.prototype._fnCreateLinearGradient=function(e,t){var a=[],i=t.shapeFill?t.shapeFill:"sapChart_Sequence_1",r=t.overlapIndicatorFill?t.overlapIndicatorFill:"sapChart_Sequence_1_Minus4";var n=l.getRTL();if(n){for(var o=e.length-1;o>=0;o--){a.push(new s({offSet:String(100-e[o]+"%"),stopColor:o%2==0?r:i}));a.push(new s({offSet:String(100-e[o-1]+"%"),stopColor:o%2==0?r:i}))}}else{for(var o=0;o<e.length-1;o++){a.push(new s({offSet:String(e[o]+"%"),stopColor:o%2==0?i:r}));a.push(new s({offSet:String(e[o+1]+"%"),stopColor:o%2==0?i:r}))}}return a};d.prototype._createShapesFromContext=function(e,t,a,s,p,l,d){var h=t.getAggregation("_settings");var m=s.getAxisTime(),f={};var v=h.getPseudoShapeTemplate&&h.getPseudoShapeTemplate();var u=s.getTable().getBindingInfo("rows").model;var T=s._getPossibleShapesInGantt();var S=i.get({name:["sapUiChartAxisTitleFontSize","sapUiChartTitleFontWeight","sapUiChartReferenceLineLabelColor"],callback:function(e){S=e}});a.forEach(function(e,t){if(e){var a=e.template.getAggregation("shapes");var i=e.template.getBindingInfo("time")||a&&a[0]&&a[0].getBindingInfo("time"),r=e.template.getBindingInfo("endTime")||a&&a[0]&&a[0].getBindingInfo("endTime"),n=e.template.getBindingInfo("shapeId");f[t]={endTime:r.parts[0].path||r.path,startTime:i.parts[0].path||i.path,shapeId:n.parts[0].path||n.path}}});var I=function(e,t){return new r({height:parseFloat(S.sapUiChartAxisTitleFontSize,100)*16,fontWeight:S.sapUiChartTitleFontWeight,src:e,fill:S.sapUiChartReferenceLineLabelColor,horizontalTextAlignment:t.getHorizontalTextAlignment(),time:t.getTime(),endTime:t.getEndTime()})};e.sort(function(e,t){var a=e.timeFormatter;var i=t.timeFormatter;var r=e.getProperty(f[T.indexOf(e.aggrType)].startTime);var n=t.getProperty(f[T.indexOf(t.aggrType)].startTime);var o=a?a(r):r,s=i?i(n):n;return o-s});var c=this._findPseudoShapeContextArray(e,f,t,s,a);var y,x,C;t.aFinalShapeGroupArray=c;c.forEach(function(e){if(e.iShapeCount>1){var i;if(v){i=v.clone();x=i.getTask();e.shapeFill=x.getFill()?x.getFill():i.getFill();x.setTime(e.startTime);x.setEndTime(e.endTime);x.setSelectable(true);if(p&&s.oOverlapShapeIds&&s.oOverlapShapeIds[t.getIndex()]&&e.aShapeIds&&e.aShapeIds.some(function(e){return s.oOverlapShapeIds[t.getIndex()].includes(e)})){C=I("sap-icon://collapse",x);y=i.getCollapseTitle()?i.getCollapseTitle():g.simple.pseudoShapeTitle.Collapse}else{C=I("sap-icon://expand",x);y=i.getExpandTitle()?i.getExpandTitle():g.simple.pseudoShapeTitle.Expand}x.setTitle(y);e.overlaps.forEach(function(t){var a=i.getIndicators()[0].clone();a.addStyleClass("sapGanttPseudoShapeOverlapIndicatorStyle");e.overlapIndicatorFill=a.getFill()?a.getFill():i.getOverlapFill();if(i.getTypeOfOverlapIndicator()!="Gradient"){a.setTime(t.startTime);a.setEndTime(t.endTime);i.addAggregation("indicators",a)}});C.aCustomStyleClasses=["pseudoShapeIcon"];i.addAggregation("button",C)}else{i=this._createPseudoShape(e,t,s,p);x=i.getTask()}i.isPseudoShape=true;i.aShapeContexts=e.aShapeContexts;i.aShapeIds=e.aShapeIds;i.getTask().addStyleClass("sapGanttPseudoShapeColor");if(i.getTypeOfOverlapIndicator()!="Indicator"){i.getTask().setFill("url(#"+e.id+")")}h.addAggregation("pseudoShapes",i,true);i._birdEye(a,s,i,t,l>-1?s._aExpandedIndices.indexOf(t.getIndex())==-1:true,f);if(d){var r=e.startTime,S=e.endTime;var c=r.getTime(),O=S.getTime();var _=O-c,F=[0];for(var A=0;A<e.overlaps.length;A++){var E=e.overlaps[A];var B=(E.startTime.getTime()-c)/_*100;var b=(E.endTime.getTime()-c)/_*100;F.push(B);if(b-B<1){var P=m.timeToView(o.abapTimestampToDate(S)),w=m.timeToView(o.abapTimestampToDate(r));var G=Math.abs(P-w);b=B+1/G*100}F.push(b)}F.push(100);var R=this._fnCreateLinearGradient(F,e);var U=s._oSvgDefs&&s._oSvgDefs.getAggregation("defs")&&s._oSvgDefs.getAggregation("defs").find(function(t){return t.getId()==e.id});if(!U){s._oSvgDefs&&s._oSvgDefs.addAggregation("defs",new n(e.id,{x1:"0%",y1:"0%",x2:"100%",y2:"0%",stops:R}),true)}}}else{if(e.iShapeCount===1){var L=e.aShapeContexts[0].aggrType;var z=a[T.indexOf(L)].template.clone();z.setBindingContext(e.aShapeContexts[0],u);h.addAggregation(L,z,true);var V=h.getAggregation(L).length-1;var A=t.getIndex();var k=s.oOverlapShapeIds&&s.oOverlapShapeIds[A]&&s.oOverlapShapeIds[A].indexOf(h.getAggregation(L)[V].getShapeId());if(k>-1){if(s.oOverlapShapeIds[A].length>1){s.oOverlapShapeIds[A].splice(k,1)}else if(s.oOverlapShapeIds){delete s.oOverlapShapeIds[A]}}}}}.bind(this))};d.prototype._findPseudoShapeContextArray=function(e,t,a,i){var r=[],n,o=0,s=0,p=i.getId();var g=i._getPossibleShapesInGantt();if(e[0]){n=g.indexOf(e[0].aggrType);r.push({id:p+"_row-"+a.getIndex()+"group-"+o,iShapeCount:1,startTime:this._timeFormatter(e[0],t[n],i).time,endTime:this._timeFormatter(e[0],t[n],i).endTime,overlaps:[],aShapeContexts:[e[0]],aShapeIds:[e[0].getProperty(t[n].shapeId)]})}for(var l=1;l<e.length;l++){var d=e[l];n=g.indexOf(d.aggrType);var h=this._timeFormatter(d,t[n],i).time,m=this._timeFormatter(d,t[n],i).endTime,f=r[o],v=f.startTime,u=f.endTime;var T=f.overlaps[s]&&f.overlaps[s].startTime,S=f.overlaps[s]&&f.overlaps[s].endTime;if(h>=v&&m<=u){f.aShapeContexts.push(d);f.iShapeCount++;f.aShapeIds.push(d.getProperty(t[g.indexOf(d.aggrType)].shapeId));if(f.overlaps.length===0){f.overlaps.push({startTime:h,endTime:m})}else{if(h>=T&&m<=S){}else if(h>=T&&h<S&&m>S){f.overlaps[s].endTime=m}else if(h>S&&m>S){f.overlaps.push({startTime:h,endTime:m});s++}}}else if(h>=v&&h<u&&m>u){f.aShapeContexts.push(d);f.iShapeCount++;f.aShapeIds.push(d.getProperty(t[g.indexOf(d.aggrType)].shapeId));if(f.overlaps.length===0){f.overlaps.push({startTime:h,endTime:f.endTime})}else{if(h>=T&&u<=S){}else if(h>=T&&h<S&&u>S){f.overlaps[s].endTime=f.endTime}else if(h>S&&u>S){f.overlaps.push({startTime:h,endTime:f.endTime});s++}}f.endTime=m}else if(h>=u&&m>=u){o++;s=0;r.push({id:p+"_row-"+a.getIndex()+"group-"+o,iShapeCount:1,startTime:h,endTime:m,overlaps:[],aShapeContexts:[d],aShapeIds:[d.getProperty(t[g.indexOf(d.aggrType)].shapeId)]})}}return r};d.prototype._birdEye=function(e,t,a,i,r,n){var o=i.getIndex(),s=i.getAggregation("_settings");var p=t._getPossibleShapesInGantt();var g=function(i,r){var n=false,o,s;for(var g=0;g<a.aShapeContexts.length;g++){var l=a.aShapeContexts[g];var d=p.indexOf(l.aggrType);var h=e[d];var m=h.template.getBindingInfo("countInBirdEye"),f;if(m){f=m.parts[0].path||m.path}else{f=h.template.getCountInBirdEye()}if(typeof f!="boolean"&&l.getProperty(f)||f==true){n=true;var v=r._timeFormatter(l,i[d],t).time;var u=r._timeFormatter(l,i[d],t).endTime;if(!o||v<o){o=v}if(!s||s<u){s=u}}}return{startTime:o,endTime:s,pseudoCountInBirdEye:n}};if(t.oOverlapShapeIds&&t.oOverlapShapeIds[o]&&a.aShapeIds.some(function(e){return t.oOverlapShapeIds[o].includes(e)})&&r){var l=t.getTable().getBindingInfo("rows").model;var d=false,h,m;a.aShapeContexts.forEach(function(i){var r=p.indexOf(i.aggrType);var g=e[r];var f=g.template.getBindingInfo("countInBirdEye"),v;if(f){v=f.parts[0].path||f.path}else{v=g.template.getCountInBirdEye()}if(typeof v!="boolean"){if(i.getProperty(v)){d=true;var u=this._timeFormatter(i,n[r],t).time;var T=this._timeFormatter(i,n[r],t).endTime;if(!h||u<h){h=u}if(!m||m<T){m=T}}}var S;var I=e[r];if(I){S=I.template.clone();S.setBindingContext(i,l);s.addAggregation(i.aggrType,S,true)}s.getAggregation(i.aggrType)[s.getAggregation(i.aggrType).length-1].isPartOfExpandedPseudoShape=true;var c=c>-1?c:o;t.oOverlapShapeIds[c]=a.aShapeIds}.bind(this));if(typeof countInBirdEyeVal!="boolean"){a.groupBirdEyeRangeStartTime=h;a.groupBirdEyeRangeEndTime=m;a.setCountInBirdEye(d)}}else{var f=g(n,this);a.groupBirdEyeRangeStartTime=f.startTime;a.groupBirdEyeRangeEndTime=f.endTime;a.setCountInBirdEye(f.pseudoCountInBirdEye)}};return d},true);
//# sourceMappingURL=BasePseudoShape.js.map