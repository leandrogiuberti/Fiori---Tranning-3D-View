/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Core","sap/gantt/misc/Utility","./GanttExtension","../drawer/CursorLine","./CoordinateUtils","./GanttUtils","sap/ui/core/format/DateFormat","sap/m/Text","sap/gantt/utils/GanttChartConfigurationUtils","sap/gantt/library"],function(jQuery,t,e,o,i,r,n,a,l,s,g){"use strict";var u=".sapGanttPointer";var c="contextmenu"+u;var h=sap.gantt.DragOrientation;var f=g.SelectionMode;var d=["mouseenter","mouseleave","click","dblclick","mouseup","mousedown"],p=d.map(function(t){return t+u});var S="mousemove",v=S+u,m=v+" mouseup"+u;var b=d.reduce(function(t,e){t[e]=e;return t},{});b[S]=S;var w={Forward:"forward",Backward:"backward",Bottom:"bottom",Top:"top"};var A=50;var T=null;var C={addEventListeners:function(t){var e=t._getPointerExtension(),o=jQuery(e.getDomRefs().ganttSvg),i=jQuery(e.getDomRefs().headerSvg);C.removeEventListeners(t);if(T===null){T=n.adhocLinesPresentAndEnabled(t)}p.forEach(function(t){o.on(t,e.onGanttChartMouseEvent.bind(e));if(T){i.on(t,e.onGanttChartMouseEvent.bind(e))}else{i.off(t,e.onGanttChartMouseEvent.bind(e))}});o.on(m,e.onCrossSvgMouseEvent.bind(e));i.on(m,e.onCrossSvgMouseEvent.bind(e));o.on(v,e.updateGanttCursorLine.bind(e));o.on("mouseover"+u,e.onGanttChartRowHoverOn.bind(e));o.on("mouseout"+u,e.onGanttChartRowHoverOff.bind(e));o.on(c,e.onGanttChartContextMenu.bind(e));e._bIsMouseOnCorrectRow=true;e._bMouseOnSvg=true;if(T){this.bindBackgroundRowEventHeader(i,e)}else{this.unbindBackgroundRowEventHeader(i)}i.on(b.mousedown+u,function(e){var o=t._getDragDropExtension();if(!o.isEventTargetAdhocLine(e)&&!o.isEventTargetDeltaLine(e)){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();return false}});jQuery(document.getElementById(t.getId())).on(v,r.updateCursorPosition)},removeEventListeners:function(t){var e=t._getPointerExtension(),o=jQuery(e.getDomRefs().ganttSvg),i=jQuery(e.getDomRefs().headerSvg);o.off(u);if(T===null){T=n.adhocLinesPresentAndEnabled(t)}if(T){i.on(b.mousedown+u)}else{i.off(b.mousedown+u)}},doGanttAutoScroll:function(t,e,o,i){var r=t._getPointerExtension();if(r.iTableAutoScrollTimerId){window.clearTimeout(r.iTableAutoScrollTimerId);r.iTableAutoScrollTimerId=null}if(r._bAutoScroll){if(!r.allowAutoScroll()){return}if(!t._getDragDropExtension().isSnapping){r._toggleCursorLine(false)}var n=t._getResizeExtension();if(n.isResizing()){n.onResizing(o)}var a=t._getConnectExtension();if(a.isShapeConnecting()){a.onShapeConnecting(o)}var l=t._getPopoverExtension();l._updatePopoverWhenAutoScroll(o);var g=t._getZoomExtension();g._handleAutoScroll(o);var u=s.getRTL();var c=30;if(w.Backward===e||w.Top===e){c=-1*c}if(w.Backward===e||w.Forward===e){r._iStep=c}else{r._iStep=0}var h=this.getScrollArea(t,e);var f,d=false;if(e===w.Forward||e===w.Backward){f=u?"scrollLeftRTL":"scrollLeft";d=true}else{f="scrollTop";d=false}a.storeScrollDistance(c,d);var p=h[f]()+c;h[f](p);var S=h[f]();if(S!==p){a.storeScrollDistance(S-p,d)}if(!(i!==undefined&&i===S)){r.iTableAutoScrollTimerId=window.setTimeout(C.doGanttAutoScroll.bind(C),A,t,e,o,S)}}},getScrollArea:function(t,e){var o;var i=t.getTable();var r=jQuery(i.getDomRef(sap.ui.table.SharedDomRef.VerticalScrollBar));if(e===w.Forward||e===w.Backward){o=jQuery(document.getElementById(t.getId()+"-hsb"))}else{o=r}return o},bindBackgroundRowEventHeader:function(t,e){jQuery(t[0]).on(b.click+u+" "+b.dblclick+u,function(t){e.dispatchGanttClickHeader(t)})},unbindBackgroundRowEventHeader:function(t){jQuery(t[0]).off(u)}};var E=o.extend("sap.gantt.simple.GanttPointerExtension",{_init:function(t,e){this._oCursorLineDrawer=new i;this.bPreventSingleClick=false;this.iTableAutoScrollTimerId=null;this._iStep=0;this._iHoveredRowElement=null;return"PointerExtension"},_attachEvents:function(){var t=this.getGantt();C.addEventListeners(t)},_detachEvents:function(){var t=this.getGantt();C.removeEventListeners(t)},destroy:function(){if(this._oCursorLineDrawer){this._oCursorLineDrawer.destroy()}delete this.bPreventSingleClick}});E.prototype.onGanttChartContextMenu=function(t){t.preventDefault();if(this.isEventTargetOnGanttRow(t)===false){return}var e=this.getGantt();var o=this._getRowIndexFromEvent(t);var i=e.getTable().getRows()[o].getAggregation("_settings");e.fireShapeContextMenu({rowSettings:i,pageX:t.pageX,pageY:t.pageY,originEvent:t})};E.prototype.onGanttChartRowHoverOn=function(t){if(this.isEventTargetOnGanttRow(t)===false){return}this._iHoveredRowElement=t.target;var e=this._getRowIndexFromEvent(t);var o=this.getGantt();var i=o._getDragDropExtension();this._bIsMouseOnCorrectRow=true;if(i._bEnableRowHighlight&&i.isDragging()){this._bIsMouseOnCorrectRow=false;if(i.oLastDraggedShapeData._highlightedRowIndex){i.oLastDraggedShapeData._highlightedRowIndex.forEach(function(t){if(t===e){this._bIsMouseOnCorrectRow=true}}.bind(this))}}this.onMouseHover(e,true)};E.prototype.onGanttChartRowHoverOff=function(t){if(!this._iHoveredRowElement){return}var e=t.relatedTarget;while(e){if(e==this._iHoveredRowElement){return}e=e.parentNode}var o=this._getRowIndexFromEvent(t);this.onMouseHover(o,false);this._iHoveredRowElement=null};E.prototype.onGanttChartMouseEvent=function(t){this.updateGanttCursorLine(t);if(t.type===b.mousedown){this.oMousedownTargetElement=t.target}if(t.type===b.click||t.type===b.dblclick){if(this.isEventTargetOnGanttRow(t)===false){return}this.dispatchGanttClick(t)}this.onMouseEnterLeaveEvent(t)};E.prototype.onCrossSvgMouseEvent=function(t){var e=this.getGantt();if(t.type===b.mousemove){if(this.needAutoscrollInContainerIfNecessary()){this.updateCursorStyle("move");this.tableAutoScroll(t)}else{var o=e._getDragDropExtension();var i=e._getConnectExtension();var r=e._getResizeExtension();var n=e._getZoomExtension();if(o.isDeltaLineDragging()||o.isAdhocLineDragging()||o.isDragging()||r.isResizing()||i.isShapeConnecting()||n.isTimeZooming()){this.tableAutoScroll(t)}}}if(t.type===b.mouseup){this.oMouseupTargetElement=t.target;this._bAutoScroll=false}};E.prototype.needAutoscrollInContainerIfNecessary=function(){var t=this.getGantt().getParent();if(t&&t.getGanttCharts){var e=t.getGanttCharts();var o=this.getGantt();return e.some(function(t){return t!==o&&t._getDragDropExtension().isDragging()})}return false};E.prototype.updateCursorStyle=function(t){document.body.style.cursor=t;this.getDomRefs().ganttSvg.style.cursor=t};E.prototype.isPointerInGanttChart=function(t){return this._bMouseOnSvg};E.prototype.isPointerInCorrectRow=function(t){return this._bIsMouseOnCorrectRow};E.prototype.onMouseEnterLeaveEvent=function(t){this.updateCursorStyle("default");if(t.type===b.mouseenter){this._bMouseOnSvg=true}else if(t.type===b.mouseleave){this._bMouseOnSvg=false}};E.prototype.dispatchGanttClick=function(t){if(t.type===b.click){if(this.oMousedownTargetElement===this.oMouseupTargetElement){this.onGanttSingleClick(t);delete this.oMouseupTargetElement;delete this.oMousedownTargetElement}}else if(t.type===b.dblclick){this.onGanttDoubleClick(t)}};E.prototype.dispatchGanttClickHeader=function(t){if(t.type===b.click){this.onGanttSingleClick(t);delete this.oMouseupTargetElement;delete this.oMousedownTargetElement}};E.prototype.isEventTargetOnGanttRow=function(t){return jQuery(t.target).hasClass("sapGanttBackgroundSVGRow")};E.prototype._getRowIndexFromEvent=function(t){return parseInt(t.target.getAttribute("data-sap-ui-index"))};E.prototype._getRowIndexFromElement=function(t){return parseInt(t.getAttribute("data-sap-ui-index"))};E.prototype.onGanttSingleClick=function(t){if(!((t.ctrlKey||t.metaKey)&&[f.MultiWithKeyboard,f.MultiWithKeyboardAndLasso].indexOf(this.getGantt().getShapeSelectionMode())>-1)){if(this.getGantt().getSelectedShapeUid().length>0){this.getGantt()._bDeselectShapes=true;this.getGantt()._bSupressShapeChangeEvent=false}else{this.getGantt()._bDeselectShapes=false}this.getGantt().getSelection().clearAllSelectedShapeIds()}this.getGantt().getSelection().updateShape(null,{selected:false,ctrl:t.ctrlKey||t.metaKey});var e=this.getGantt();n.resetStrokeDasharray(e);var o=this._getRowIndexFromEvent(t);var i=e.getTable().getRows()[o];if(!i){return}var a=function(){if(this.bPreventSingleClick===false){this._selectTableRow(e,o);var n=r.getLatestCursorPosition();e.fireShapePress({shape:null,row:i,ctrlOrMeta:t.ctrlKey||t.metaKey,pageX:n.pageX,pageY:n.pageY,originEvent:t})}this.bPreventSingleClick=false}.bind(this);if(e.getDisableShapeDoubleClickEvent()){this.bPreventSingleClick=false;a();return}this.iSingleClickTimer=window.setTimeout(a.bind(this),300)};E.prototype.onGanttDoubleClick=function(t){var e=this.getGantt(),o=e.getDisableShapeDoubleClickEvent(),i,n;if(!o){window.clearTimeout(this.iSingleClickTimer);this.bPreventSingleClick=true}i=this._getRowIndexFromEvent(t);n=e.getTable().getRows()[i];this._selectTableRow(e,i);if(!o){var a=r.getLatestCursorPosition();e.fireShapeDoubleClick({shape:null,row:n,pageX:a.pageX,pageY:a.pageY})}};E.prototype._selectTableRow=function(t,e){var o=this.getGantt().getTable().getSelectionBehavior();var i=sap.ui.table.SelectionBehavior;if(i.Row===o||i.RowOnly===o){t.getSyncedControl().syncRowSelection(e)}};E.prototype.onMouseHover=function(t,e){this.getGantt().getSyncedControl().syncRowHover(t,e)};E.prototype._getAutoScrollStep=function(){if(this._bAutoScroll){return this._iStep}return 0};E.prototype.updateGanttCursorLine=function(t){if(this.getGantt().getEnableCursorLine()===false){return}if(this.getGantt()._getDragDropExtension().isSnapping){return}if(t.type===b.mousemove){var e=r.getEventSVGPoint(this.getDomRefs().ganttSvg,t);this._toggleCursorLine(true,e)}else if(t.type===b.mouseleave){this._toggleCursorLine(false)}};E.prototype._toggleCursorLine=function(t,e){var o=this._getCursorLineDOMs();var i=this.getGantt().getParent();var r=i.isA("sap.gantt.simple.GanttChartContainer")&&i.getEnableStatusBar();if(t){this._oCursorLineDrawer.drawSvg(o.allGanttSvg,o.allHeaderSvg,this.getGantt().getLocale(),e);if(r){this.customBar(i,true,this.getGantt().getAxisTime().viewToTime(e.x))}i._bCalcTimeStamp=true;i._timeStamp=false}else{this._oCursorLineDrawer.destroySvg(o.allGanttSvg,o.allHeaderSvg);if(r){this.customBar(i,false)}}};E.prototype.customBar=function(t,o,i){var r=new l({text:""});var n=this.getGantt().getLocale();var s=a.getDateTimeWithTimezoneInstance({pattern:t.getStatusBarDatePattern(),calendarWeekNumbering:this.getGantt().getAxisTimeStrategy().getCalendarWeekNumbering(),showTimezone:false});var g=a.getDateTimeWithTimezoneInstance({pattern:t.getStatusBarTimePattern(),showTimezone:false});t.msgText.setWidth(o?"70%":"100%");t.dateTimeText.setWidth(o?"30%":"0%");t.dateTimeText.setText(o?e.getLowerCaseLabel(n.getFormattedDate(s,i)+" "+n.getFormattedDate(g,i)):r.getText())};E.prototype._getCursorLineDOMs=function(){return{allHeaderSvg:d3.selectAll(".sapGanttChartWithSingleTable .sapGanttChartHeaderSvg"),allGanttSvg:d3.selectAll(".sapGanttChartWithSingleTable .sapGanttChartSvg")}};E.prototype.tableAutoScroll=function(t){this._bAutoScroll=false;var e=this.getGantt();var o=e._getDragDropExtension();var i=o.isDragging();var r=e.getDragOrientation();var n=i&&r===h.Horizontal;var a=i&&r===h.Vertical;if(this.ifAutoScrollToRight()&&!a){window.setTimeout(function(){C.doGanttAutoScroll(this.getGantt(),w.Forward,t)}.bind(this),A)}else if(this.ifAutoScrollToLeft()&&!a){window.setTimeout(function(){C.doGanttAutoScroll(this.getGantt(),w.Backward,t)}.bind(this),A)}else if(this.ifAutoScrollToDown()&&!n){window.setTimeout(function(){C.doGanttAutoScroll(this.getGantt(),w.Bottom,t)}.bind(this),A)}else if(this.ifAutoScrollToUp()&&!n){window.setTimeout(function(){C.doGanttAutoScroll(this.getGantt(),w.Top,t)}.bind(this),A)}else{this._bAutoScroll=false}};E.prototype.ifAutoScrollToRight=function(){var t=this.getAutoScrollPosition();this._bAutoScroll=t.iLocationX>t.oScrollAreaRect.left+t.iScrollAreaWidth-t.iScrollTriggerAreaWidth&&t.iLocationX<t.oScrollAreaRect.left+t.iScrollAreaWidth&&t.iScrollAreaScrollLeft+t.iScrollAreaWidth<t.oScrollArea.scrollWidth;return this._bAutoScroll};E.prototype.ifAutoScrollToLeft=function(){var t=this.getAutoScrollPosition();this._bAutoScroll=t.iLocationX<t.oScrollAreaRect.left+t.iScrollTriggerAreaWidth&&t.iLocationX>t.oScrollAreaRect.left&&t.iScrollAreaScrollLeft>0;return this._bAutoScroll};E.prototype.ifAutoScrollToDown=function(){var t=this.getAutoScrollPosition();this._bAutoScroll=t.iLocationY>t.oVisibleScrollAreaRect.top+t.iVisibleScrollAreaHeight-t.iScrollTriggerAreaHeight&&t.iLocationY<t.oVisibleScrollAreaRect.top+t.iVisibleScrollAreaHeight&&t.iScrollAreaScrollTop+t.iScrollAreaHeight-t.iBaseRowHeight<=t.iScrollHeight;return this._bAutoScroll};E.prototype.ifAutoScrollToUp=function(){var t=this.getAutoScrollPosition();this._bAutoScroll=t.iLocationY<t.oVisibleScrollAreaRect.top+t.iScrollTriggerAreaHeight&&t.iLocationY>t.oVisibleScrollAreaRect.top;return this._bAutoScroll};E.prototype.getAutoScrollPosition=function(){var t=s.getRTL();var e=this.getGantt().getTable();var o=20,i=20,n=document.getElementById(this.getGantt().getId()+"-gantt"),a=jQuery(n),l=n.getBoundingClientRect(),g=a.outerWidth(),u=a.outerHeight(),c=l,h=u,f=this.getGantt()._oExpandModel.getBaseRowHeight(),d=t?a.scrollLeftRTL():a.scrollLeft();var p=jQuery(e.getDomRef(sap.ui.table.SharedDomRef.VerticalScrollBar)),S=p.scrollTop(),v=p.get(0).scrollHeight;var m=r.getLatestCursorPosition().pageX,b=r.getLatestCursorPosition().pageY;return{iLocationX:m,iLocationY:b,oScrollAreaRect:l,oScrollArea:n,iScrollAreaWidth:g,iScrollTriggerAreaWidth:o,iScrollTriggerAreaHeight:i,iScrollAreaScrollLeft:d,oVisibleScrollAreaRect:c,iVisibleScrollAreaHeight:h,iScrollAreaScrollTop:S,iBaseRowHeight:f,iScrollHeight:v,iScrollAreaHeight:u}};E.prototype.allowAutoScroll=function(){return this.ifAutoScrollToRight()||this.ifAutoScrollToLeft()||this.ifAutoScrollToDown()||this.ifAutoScrollToUp()};return E});
//# sourceMappingURL=GanttPointerExtension.js.map