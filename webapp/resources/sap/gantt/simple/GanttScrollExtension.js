/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Core","sap/ui/Device","../misc/Format","../config/TimeHorizon","./GanttExtension","./RenderUtils","./GanttUtils","sap/gantt/simple/AggregationUtils","sap/gantt/utils/GanttChartConfigurationUtils"],function(jQuery,t,e,i,n,o,r,s,a,l){"use strict";var h=function(t,e){var i=l.getRTL();var n=i?"scrollLeftRTL":"scrollLeft";if(typeof e==="number"){t[n](e)}return t[n]()};var f=".sapGanttScroll";var g="scroll"+f;var c={onHSBScroll:function(t){if(this.getHorizontalLazyLoadingEnabled()||this._isLazyLoadingEnabledForSyncedChart()){if(this._iScrollTimer!==null){clearTimeout(this._iScrollTimer)}this._iScrollTimer=setTimeout(function(){this._getScrollExtension().updateVisibleHorizonIfNecessary()}.bind(this),150)}else{this._getScrollExtension().updateVisibleHorizonIfNecessary()}},onMouseWheelScrolling:function(t){if(t.shiftKey&&t.ctrlKey){return}var e=this._getScrollExtension();var i=Math.abs(t.deltaX)>Math.abs(t.deltaY),n=i||t.shiftKey;var o=i?t.deltaX:t.deltaY,r=o>0,s=false;if(o===0){return}if(n){var a=e.getGanttHsb();if(r){s=a.scrollLeft===a.scrollWidth-a.offsetWidth}else{s=a.scrollLeft===0}if(!s){a.scrollLeft=a.scrollLeft+o}t.preventDefault();t.stopPropagation()}},getEventListenerTargets:function(t){var e=[t.getDomRef("svg"),t.getDomRef("header-svg")];return e.filter(function(t){return t!=null})},onTouchStart:function(t){if(t.type==="touchstart"||t.pointerType==="touch"){var e=this._getScrollExtension(),i=e.getGanttHsb();var n=t.touches?t.touches[0]:t;e._mTouchSessionData={initialPageX:n.pageX,initialPageY:n.pageY,initialScrollLeft:i?i.scrollLeft:0,initialScrolledToEnd:null}}},onTouchMoveHorizontalScrolling:function(t){if(t.type==="touchmove"||t.pointerType==="touch"){var e=this._getScrollExtension();var i=e._mTouchSessionData;var n=t.touches?t.touches[0]:t;var o=n.pageX-i.initialPageX;var r=n.pageY-i.initialPageY;var s=false;var a=false;var l=Math.abs(o)>Math.abs(r);if(!i||!l){return}var h=e.getGanttHsb();if(o<0){s=h.scrollLeft===h.scrollWidth-h.offsetWidth}else{s=h.scrollLeft===0}if(!i.initialScrolledToEnd){i.initialScrolledToEnd=s}if(!s&&!i.initialScrolledToEnd){h.scrollLeft=i.initialScrollLeft-o;a=true}if(a){t.preventDefault()}}},addEventListeners:function(t){var e=t._getScrollExtension();this.removeEventListeners(t);jQuery(e.getGanttHsb()).on(g,this.onHSBScroll.bind(t));var i=this.getEventListenerTargets(t);e._mTouchEventListener=this.addTouchEventListener(i,t);e._mMouseWheelEventListener=this.addMouseWheelEventListener(i,t)},removeEventListeners:function(t){var e=t._getScrollExtension();jQuery(e.getGanttHsb()).off(f);c.removeScrollEventListeners(t)},addMouseWheelEventListener:function(t,e){var i=c.onMouseWheelScrolling.bind(e);for(var n=0;n<t.length;n++){t[n].addEventListener("wheel",i)}return{wheel:i}},addTouchEventListener:function(t,i){var n=c.onTouchStart.bind(i);var o=c.onTouchMoveHorizontalScrolling.bind(i);var r={};for(var s=0;s<t.length;s++){if(e.support.pointer&&e.system.desktop){t[s].addEventListener("pointerdown",n);t[s].addEventListener("pointermove",o,e.browser.chrome?{passive:true}:false)}else if(e.support.touch){t[s].addEventListener("touchstart",n);t[s].addEventListener("touchmove",o)}}if(e.support.pointer&&e.system.desktop){r={pointerdown:n,pointermove:o}}else if(e.support.touch){r={touchstart:n,touchmove:o}}return r},removeScrollEventListeners:function(t){var e=t._getScrollExtension();var i=c.getEventListenerTargets(t);function n(t,e){for(var i in e){var n=e[i];if(n){t.removeEventListener(i,n)}}}for(var o=0;o<i.length;o++){n(i[o],e._mTouchEventListener);n(i[o],e._mMouseWheelEventListener)}delete e._mTouchEventListener;delete e._mMouseWheelEventListener}};var d=o.extend("sap.gantt.GanttScrollExtension",{_init:function(t,e){this.oGanttHsb=null;this._bSuppressSetVisibleHorizon=false;this.mOffsetWidth=null;return"ScrollExtension"},_attachEvents:function(){var t=this.getGantt();c.addEventListeners(t)},_detachEvents:function(){var t=this.getGantt();c.removeEventListeners(t)},destroy:function(){this._detachEvents();this._delegate=null;this.oGanttHsb=null;this.mOffsetWidth=null;o.prototype.destroy.apply(this,arguments)}});d.prototype.updateVisibleHorizonIfNecessary=function(){performance.mark("GanttScrollExtension-updateVisibleHorizonIfNecessary--start");var t=this.getGantt();if(t){if(!this._bSuppressSetVisibleHorizon){this._updateVisibleHorizonForce()}this._bSuppressSetVisibleHorizon=false;if(t.getHorizontalLazyLoadingEnabled()){if(t._isAllDataLoadedPromiseResolved){t.getAggregation("_header").renderElement()}}else{t.getAggregation("_header").renderElement()}if(!this.scrollTimer){this.scrollTimer=window.setTimeout(function(){if(s.isDynamicText()){if(t.getEnablePseudoShapes()){t._bUpdateTriggeredDueToExpandCollapse=true}t.getTable().rerender()}var e=t._getDragDropExtension();if(e._bEnableRowHighlight&&e.isDragging()){e.getShapeDndRowHighlightIndex(t);t.toggleDnDRowHighlight(true)}this.scrollTimer=null}.bind(this),500)}}performance.mark("GanttScrollExtension-updateVisibleHorizonIfNecessary--end")};d.prototype._updateVisibleHorizonForce=function(){var t=this._scrollLeftToVisibleHorizon();this.getGantt()._updateVisibleHorizon(t,"horizontalScroll",this.getVisibleWidth())};d.prototype.jumpToVisibleHorizon=function(t){this.getGantt()._updateVisibleHorizon(this.getGantt().getAxisTimeStrategy().getVisibleHorizon(),t||"horizontalScroll",this.getVisibleWidth())};d.prototype._getGanttHsbScrollLeft=function(){return h(jQuery(this.getGanttHsb()))};d.prototype.getContentWidth=function(){var t=this.getGantt();var e=t.getAxisTime(),i=e.getViewRange();return Math.abs(Math.ceil(i[1])-Math.ceil(i[0]))};d.prototype.updateGanttScrollWidth=function(){var t=this.getGantt();t.getSyncedControl().setInnerWidth(t.getContentWidth()+"px")};d.prototype.getVisibleWidth=function(){return jQuery(document.getElementById(this.getGantt().getId()+"-gantt")).width()};d.prototype.scrollGanttChartToVisibleHorizon=function(){var t=this._visibleHorizonToScrollLeft();var e=t-this.mOffsetWidth.svgOffset;var i=this.getDomRefs(),n=jQuery(i.gantt),o=jQuery(i.header),r=this.getGantt();if(Math.abs(h(n)-e)>(r._iDiff||0)){var s=this.getGanttHsb();if(s){if(h(jQuery(s))===0){h(n,0);h(o,0)}else{h(n,e);h(o,e)}if(h(n)!==0){r._iDiff=Math.abs(h(n)-e)}}}this.getGantt()._getConnectExtension().updateShapeConnectEffect(this)};d.prototype.clearOffsetWidth=function(){this.mOffsetWidth=null;this.getGantt().getAxisTime().setViewOffset(0)};d.prototype.needRerenderGantt=function(t,e,n){if(this.mOffsetWidth===null&&!n){this.updateGanttScrollWidth()}var o=this.getGantt();if(!n&&e!=="initialRender"&&this.mOffsetWidth&&this.doesSvgScrollWithinBuffer()&&!this.getGantt().getSyncedControl().getRowsHeightChanged()){this._scrollTableToVisibleHorizon(true);this.scrollGanttChartToVisibleHorizon();o.getSyncedControl().scrollContentIfNecessary();return false}this._scrollTableToVisibleHorizon(true);this.updateSvgOffsetWidth();if((e!=="initialRender"||e==="initialRender"&&n)&&t){t.apply(o);this.scrollGanttChartToVisibleHorizon();o.getSyncedControl().scrollContentIfNecessary()}if(o._minTime&&o._minEndTime){var r=o._minTime.getTime();var s=o._minEndTime.getTime();delete o._minTime;delete o._minEndTime;var a=o.getAxisTimeStrategy().getVisibleHorizon();var l=i.abapTimestampToDate(a.getStartTime()).getTime();var h=i.abapTimestampToDate(a.getEndTime()).getTime();if(s<=l||r>=h){var f=o.getVisibleWidth();var g=(h-l)/f;var c=new Date(r-g*5);o.jumpToPosition(c)}}return true};d.prototype._scrollTableToVisibleHorizon=function(t){var e=jQuery(this.getGanttHsb()),n=this._getGanttHsbScrollLeft();var o=this._visibleHorizonToScrollLeft();var r=this.getGantt().getAxisTime();var s=i.dateToAbapTimestamp(r.viewToTime(o,true));var a=i.dateToAbapTimestamp(r.viewToTime(n,true));if(s!=a&&Math.abs(n-o)>1){this._bSuppressSetVisibleHorizon=t;h(e,o)}};d.prototype.updateSvgOffsetWidth=function(){var t=this.calcSvgLatestOffsetWidth();this.getGantt().getAxisTime().setViewOffset(t.svgOffset);this.getGantt().iGanttRenderedWidth=t.svgWidth;this.mOffsetWidth={svgWidth:t.svgWidth,svgOffset:t.svgOffset}};d.prototype.doesSvgScrollWithinBuffer=function(){var t=this.getVisibleWidth(),e=this.getContentWidth(),i=this._visibleHorizonToScrollLeft();if(this.mOffsetWidth===null){return false}var n=this.mOffsetWidth.svgOffset,o=this.mOffsetWidth.svgWidth;var r=t>=e||i-n>=0&&o>=i-n+t;return r};d.prototype.calcSvgLatestOffsetWidth=function(){var t=this.getContentWidth(),e=this.getVisibleWidth(),i=this.getGantt();var n=this._getGanttHsbScrollLeft()||0;var o=r.getGanttRenderWidth(i);var s=i.getHorizontalLazyLoadingEnabled()&&!i._isAllDataLoadedPromiseResolved?n:n-e*r.RENDER_EXTEND_FACTOR;if(s<0){o+=s;s=0}if(s+o>t){o=t-s}return{svgWidth:o,svgOffset:s}};d.prototype._visibleHorizonToScrollLeft=function(){var t=this.getGantt().getAxisTimeStrategy().getVisibleHorizon();var e=l.getRTL(),n=t.getStartTime();var o=this.getGantt().getAxisTime().timeToView(i.abapTimestampToDate(n),true);if(e){o=o-this.getVisibleWidth()}if(o<0){o=0}return o};d.prototype._scrollLeftToVisibleHorizon=function(){var t=l.getRTL(),e=this.getGantt().getAxisTime();var i=this._getGanttHsbScrollLeft();var o=e.viewToTime(i,true),r;if(t){r=e.viewToTime(i,true);o=undefined}return new n({startTime:o,endTime:r})};d.prototype.getGanttHsb=function(){var t=this.getGantt();if(t){this.oGanttHsb=t.getDomRef("hsb")}return this.oGanttHsb};return d});
//# sourceMappingURL=GanttScrollExtension.js.map