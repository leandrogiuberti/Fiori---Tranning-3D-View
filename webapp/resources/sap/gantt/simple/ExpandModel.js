/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/assert","sap/ui/base/ManagedObject","./AggregationUtils","./GanttUtils"],function(jQuery,e,t,a,n){"use strict";var r=t.extend("sap.gantt.simple.ExpandModel",{metadata:{properties:{baseRowHeight:{type:"int",group:"Appearance",defaultValue:null}}},constructor:function(){t.apply(this,arguments);this.mExpanded={}}});r.prototype.isTableRowHeightNeedChange=function(e,t,r,i,s){var o=false;this.rowMaxLevelMap={};var h=[];var p=t.getParent();Array.isArray(s)&&s.forEach(function(e){h.push(e.getKey())});this.oRowSpanMap=this.oRowSpanMap&&Object.keys(this.oRowSpanMap).length?this.oRowSpanMap:{};for(var d=0;d<r.length;d++){var l=r[d];var u=n.getSelectedTableRowSettings(t,l),g;if(u){g=a._fetchOverlayAggregation(u,false,"",h)}var m=p.getUseParentShapeOnExpand();if(!p._bExpandRows&&u==null){break}else if(u!=null){var f=u.getAllExpandableShapes(p);if(!e){this.toggle(e,u,i,s,0);o=true;return o}var c=[];var v=[];var w=[];var x=[];var R=w.length,E={};f.forEach(function(e){if(m){var t=h.indexOf(e.getScheme())>-1||h.length==0?[e]:[];v=e instanceof sap.gantt.simple.MultiActivityGroup?a.getNonLazyElementsByScheme(e,h):t;w=n._getExpandedChildArray(v,p,h,w);if(R!=w.length){w[w.length-1].setProperty("childElement",false,true);R=w.length}}else if(e.mBindingInfos.hasOwnProperty("subTasks")||typeof e.getSubTasks==="function"&&e.getSubTasks()){v=a.getLazyElementsByScheme(e,h);w=n._getExpandedChildArray(v,p,h,w);if(R!=w.length){w[w.length-1].getParent().setProperty("childElement",false,true);R=w.length}}else if(e.getScheme()&&h.indexOf(e.getScheme())>-1){v=[e];w=n._getExpandedChildArray(v,p,h,w);if(R!=w.length){w[w.length-1].setProperty("childElement",false,true);R=w.length}}else{v=a.getLazyElementsByScheme(e,h);var r=n.calculateLevelForShapes(v,"time","endTime",false,p,E);x=r.childWithLevels;E=r.internalRowWithSpan;c.push(x.maxLevel)}});if(w.length!==0){var S=n.calculateLevelForShapes(w,"time","endTime",false,p,E);x=S.childWithLevels;E=S.internalRowWithSpan;c.push(x.maxLevel)}var S=n.calculateLevelForShapes(w,"time","endTime",false,p,E);x=S.childWithLevels;E=S.internalRowWithSpan;c.push(x.maxLevel);var y=Math.max.apply(null,c);var b=a._addLevelAndUpdateMaxLength(g,y,u,E);y=b.iMaxLength;E=b.oInternalRowWithSpan;if(y>0){this.oRowSpanMap[u.getRowUid()]=E;this.toggle(e,u,i,s,y,m);this.rowMaxLevelMap["row"+l]=y;o=true}}}return o};r.prototype.refreshRowYAxis=function(e){if(this.hasExpandedRows()===false){return}var t=e.getParent();var a=e.getRows();var n=e.getParent().getTableRowHeights();var r=0;for(var i=0;i<a.length;i++){var s=a[i],o=s.getAggregation("_settings"),h=o.getRowUid();r+=n[i-1]||0;if(!this.isRowExpanded(h)){continue}var p=this.getBaseRowHeight();if(t.getExpandedRowHeight()){p=t.getExpandedRowHeight()}this.calcExpandRowYAxis({uid:o.getRowUid(),rowIndex:i,rowY:r,baseRowHeight:p,allRowHeights:n})}return this.getBaseRowHeight()};r.prototype.toggle=function(e,t,a,n,r,i){if(e){this.expand(t,a,n,r,i)}else{this.collapse(t,n)}};r.prototype.expand=function(t,a,n,r,i){e(typeof r==="number","iMaxNumberOfDetails must be a number");var s=t.getRowUid(),o=t.getParentGantt(),h=a.getKey(),p=a.getRowSpan();var d=[];Array.isArray(n)&&n.forEach(function(e){d.push(e.getKey())});var l=[];Array.isArray(n)&&n.forEach(function(e){l.push(e.getRowSpan())});var u=function(){if(i){if(o.oOverlapShapeIds&&o.oOverlapShapeIds[t.getParent().getIndex()]&&o.oOverlapShapeIds[t.getParent().getIndex()].length>0){if(!g||g.length===0){this.mExpanded[s]=[{scheme:"",metadata:{rowSpan:p,numberOfRows:r,main:true}},{expandSchemeShape:true,metadata:{numberOfRows:r,rowSpan:p,useParentOnExpand:true}}]}else{this.mExpanded[s][1].metadata.numberOfRows=r}}else{if(!g||g.length===0){this.mExpanded[s]=[{scheme:"",metadata:{rowSpan:p,numberOfRows:r,main:true}}]}if(!this.hasExpandScheme(s,d[m])){this.mExpanded[s].push({scheme:d[m],metadata:{numberOfRows:r,rowSpan:l[m]}})}if(!(!g||g.length===0)){for(var e=1;e<this.mExpanded[s].length;e++){this.mExpanded[s][e].metadata.numberOfRows=r}}}}else{if(!g||g.length===0){this.mExpanded[s]=[{scheme:h,metadata:{rowSpan:p,main:true}}]}if(!this.hasExpandScheme(s,d[m])){this.mExpanded[s].push({scheme:d[m],metadata:{numberOfRows:r,rowSpan:l[m]}})}if(!this.mExpanded[s][1]){this.mExpanded[s][0].metadata={numberOfRows:r,rowSpan:p,main:true}}}}.bind(this);var g=this.mExpanded[s];if(d.length){for(var m=0;m<d.length;m++){g=this.mExpanded[s];u()}}else{u()}this.updateVisibleRowSpan(s)};r.prototype.collapse=function(e,t){var a=e.getRowUid();if(!a&&!this.mExpanded[a]){return}var n=[];Array.isArray(t)&&t.forEach(function(e){n.push(e.getKey())});var r=this.mExpanded[a]||[],i=r.length;for(var s=i-1;s>-1;s--){var o=r[s];if(n.indexOf(o.scheme)>-1||!o.scheme&&o.expandSchemeShape){r.splice(s,1)}if(this.hasNoExpandRows(a)){delete this.mExpanded[a];break}else{this.updateVisibleRowSpan(a)}}};r.prototype.hasExpandScheme=function(e,t){return this.mExpanded[e].filter(function(e){return e.scheme===t}).length>0};r.prototype.hasExpandedRows=function(){return!jQuery.isEmptyObject(this.mExpanded)};r.prototype.isRowExpanded=function(e){return!this.hasNoExpandRows(e)};r.prototype.hasNoExpandRows=function(e){var t=this.mExpanded[e]||[];return t.every(function(e){return e.metadata.main&&!e.metadata.useParentOnExpand})};r.prototype.updateVisibleRowSpan=function(e){var t=this.mExpanded[e]||[];var a,n,r=0;for(var i=0;i<t.length;i++){var s=t[i];var o=s.scheme;var h=s.metadata;if(h.main){a=o;n=h;if(h.useParentOnExpand){r=h.rowSpan}}}for(var p=0;p<h.numberOfRows;p++){r=r+(this.oRowSpanMap[e]&&this.oRowSpanMap[e]["level"+p]||1)}n.numberOfSubRows=r||n.rowSpan*(n.numberOfRows||1);this.mExpanded[e][0]={scheme:a,metadata:n}};r.prototype.getMainRowScheme=function(e){var t=this.mExpanded[e]||[];return t.filter(function(e){return e.metadata.main}).map(function(e){return{key:e.scheme,value:e.metadata}})[0]};r.prototype.getExpandSchemeKeys=function(e){var t=this.mExpanded[e]||[];return t.filter(function(e){return!e.metadata.main}).map(function(e){return e.scheme})};r.prototype.getCalculatedRowHeight=function(e,t,a){var n=t;var r=a.getParent(),i=r.getExpandedRowHeight();var s=e.getParent().getIndex(),o=r.oOverlapShapeIds&&r.oOverlapShapeIds[s]&&r.oOverlapShapeIds[s].length>0;var h=r.getShowParentRowOnExpand()&&!r.getUseParentShapeOnExpand()||r._aExpandedIndices.indexOf(s)>-1&&o;if(this.hasExpandedRows()){var p=e.getRowUid();if(!p){return n}var d=this.mExpanded[p];if(d){var l=this.getMainRowScheme(p);if(!i){n=h?t*(l.value.rowSpan+l.value.numberOfSubRows):t*l.value.numberOfSubRows}else if(!h){if(i<t&&l.value.numberOfSubRows===1){n=l.value.numberOfSubRows*t}else{n=l.value.numberOfSubRows*i+.5}}else{n=t*l.value.rowSpan+l.value.numberOfSubRows*i+.5}}}return n};r.prototype.getRowHeightByIndex=function(e,t,a){if(e==null){return a}var n=e.getRows(),r=n[t].getAggregation("_settings");return this.getCalculatedRowHeight(r,a,e)};r.prototype.calcExpandRowYAxis=function(e){var t=e.uid,a=e.baseRowHeight;var n=e.rowY;var r,i,s=[];var o=[];var h=this.mExpanded[t];if(jQuery.isEmptyObject(h)){return}for(var p=0;p<h.length;p++){var d=h[p],l=d.scheme,u=d.metadata;if(u.main){r=u;i=l;if(u.useParentOnExpand){o.push(u);s.push(l)}}else{o.push(u);s.push(l)}}var g=r?r.rowSpan:1;this.oItem={};this.oItem[i]=[g];var m=[this.oItem];var f=[];for(var c=0;c<o.length;c++){var v=o[c],w=v.numberOfRows;if(!f.length){for(var x=0;x<w;x++){f.push(this.oRowSpanMap[t]&&this.oRowSpanMap[t]["level"+x]||1)}}this.oItem={};this.oItem[s[c]]=f;m.push(this.oItem)}var R=n;for(var E=0;E<m.length;E++){var S=m[E],y=Object.keys(S)[0],b=S[y];if(E===0){this._updateRowYAxis(t,y,{rowYAxis:[R].slice()})}else if(E===1){var O=[];if(b.length===1){O.push(R+m[E-1][Object.keys(m[E-1])[0]][0]*this.getBaseRowHeight());R+=b[E-1]*a}else{for(var A=0;A<b.length;A++){if(A===0){if(this.getBaseRowHeight()!==a){R=R+this.getBaseRowHeight()}else{R=R+a}}else{R=R+b[A-1]*a}O.push(R)}}this._updateRowYAxis(t,y,{rowYAxis:O.slice()})}else{this._updateRowYAxis(t,y,{rowYAxis:O.slice()})}}};r.prototype._updateRowYAxis=function(e,t,a){var n=a.rowYAxis;var r=this.mExpanded[e]||[];for(var i=0;i<r.length;i++){var s=r[i];if(s.scheme===t||!s.scheme&&s.expandSchemeShape){s.metadata.yAxis=n;break}}};r.prototype.getRowYCenterByUid=function(e,t,a,n,r,i){var s=this.isRowExpanded(e);if(s===false){return t}var o=this.mExpanded[e],h=a||this.getMainRowScheme(e).key;for(var p=0;p<o.length;p++){var d=o[p];if(d.scheme===h||!d.scheme&&d.expandSchemeShape){var l=this.getBaseRowHeight();var u=d.metadata.yAxis,g=r.oOverlapShapeIds&&r.oOverlapShapeIds[i]&&r.oOverlapShapeIds[i].length>0;var m=r.getShowParentRowOnExpand()&&!r.getUseParentShapeOnExpand()||r._aExpandedIndices.indexOf(i)>-1&&g,f=r.getExpandedRowHeight();if(f&&!(d.metadata.main&&!d.metadata.useParentOnExpand)){if(u.length===1&&f<l&&!m&&d.metadata.rowSpan===1){l=this.getBaseRowHeight()}else{l=f}}var c=l*(r.schemeRowSpanMap&&r.schemeRowSpanMap[a]?r.schemeRowSpanMap[a]:d.metadata.rowSpan);var v=u.map(function(e){return e+c/2});var w=n===undefined?0:n;return v[w]}}};r.prototype.getExpandShapeHeightByUid=function(e,t,a,n){var r=this.mExpanded[e];var i=r&&r.filter(function(e){return e.scheme===t||!e.scheme&&e.expandSchemeShape})[0];return i?n.schemeRowSpanMap[t]*(n.getExpandedRowHeight()?n.getExpandedRowHeight():this.getBaseRowHeight()):a};r.prototype.intersectRows=function(e,t){return jQuery.grep(e,function(e){return jQuery.inArray(e,t)>-1})};r.prototype.collectExpandedBgData=function(e,t,a){var n=this.intersectRows(e,Object.keys(this.mExpanded));if(jQuery.isEmptyObject(this.mExpanded)||jQuery.isEmptyObject(e)||jQuery.isEmptyObject(n)){return[]}var r=this.getBaseRowHeight();var i=[];for(var s=0;s<n.length;s++){var o=n[s],h=this.mExpanded[o]||[];for(var p=0;p<h.length;p++){var d=h[p],l=d.metadata.yAxis||[],u=d.metadata.main;if(!u||d.metadata.useParentOnExpand){var g=[];if(t){if(l.length===1&&!a&&t<this.getBaseRowHeight()){r=this.getBaseRowHeight()}else{r=t}}l.forEach(function(e){g.push({x:0,y:e,rowUid:o,rowHeight:r*d.metadata.rowSpan})});i.push(g)}}}return i};return r},true);
//# sourceMappingURL=ExpandModel.js.map