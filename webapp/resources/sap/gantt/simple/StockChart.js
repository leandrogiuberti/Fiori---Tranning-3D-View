/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/util/merge","./UtilizationChart","sap/ui/core/Core","sap/gantt/simple/StockChartPeriod"],function(e,t,i,r){"use strict";var o=t.extend("sap.gantt.simple.StockChart",{metadata:{library:"sap.gantt",properties:{showMiddleLine:{type:"boolean",defaultValue:true},relativeMiddleLinePoint:{type:"float",group:"Misc",defaultValue:50},minValue:{type:"float",group:"Misc",defaultValue:0},maxValue:{type:"float",group:"Misc",defaultValue:100},showCompactView:{type:"boolean",defaultValue:true}},defaultAggregation:"stockChartDimensions",aggregations:{stockChartDimensions:{type:"sap.gantt.simple.StockChartDimension",group:"Data"},customMiddleLine:{type:"sap.gantt.simple.BaseLine",multiple:false}}},renderer:{apiVersion:2}});o.prototype.applySettings=function(e,i){e=e||{};t.prototype.applySettings.call(this,e,i)};o.prototype.renderElement=function(e,t){var i=8;if(this.getStockChartDimensions().length===0){this._renderEmptyDomRefs(e,true);return}this._renderEmptyDomRefs(e,false);var r=this.getX(),o=this.getHeight(),a=this.getRowYCenter()-o/2,g=this.getWidth();var n={x:r,y:this.getShowCompactView()?a+i/2:a,width:g,height:this.getShowCompactView()?o-i:o};this._renderDefsDimensionClipPaths(e,n);this._renderMiddleLine(e,n);this._renderDimensionPaths(e,n);this._renderTooltips(e,n);e.close("g")};o.prototype._renderEmptyDomRefs=function(e,t){e.openStart("g",this);e.class("sapGanttStock");e.openEnd();if(t){e.close("g")}};o.prototype._renderDefsDimensionClipPaths=function(e,t){var i=this.getStockChartDimensions();e.openStart("defs").openEnd();for(var r=0;r<i.length;r++){e.openStart("clipPath",i[r].getId()+"-clipPath");e.openEnd();this.renderDimensionPath(e,i[r],t.y,t.height,null,i,true);e.close("clipPath")}e.close("defs")};o.prototype._createThresholdDefsPath=function(e,t){var i=e.getStockChartPeriods();var o=t.getStockChartPeriods();var a=[];var g={};for(var n=0;n<o.length;n++){var s=o[n];var h=s.getValue();if(h>t.getRelativePoint()&&e.getRelativePoint()>t.getRelativePoint()){this._createIntersectionThresholdPaths(o,i,s,t,a,n,true)}else if(h<t.getRelativePoint()&&e.getRelativePoint()<t.getRelativePoint()){this._createIntersectionThresholdPaths(o,i,s,t,a,n,false)}else if(h==t.getRelativePoint()){var l=s.getFrom();var m=s.getTo();if(o[n-1]&&o[n-1].getTo().getTime()==o[n].getFrom().getTime()){var T=this._getNearestThresholdPeriod(i,o[n].getFrom());if(T){var u=this._getCurrentThr(i,T);if(u&&u.getFrom().getTime()>l.getTime()&&T.getTo().getTime()!=u.getFrom().getTime()){var v=this._createSlantThresholdPath(T,u,o,n);g={from:s.getFrom(),to:s.getFrom(),value:v.y};a.push(new r(g))}}}if(e.getRelativePoint()>0&&o[n-1]&&o[n-1].getValue()>t.getRelativePoint()){this._createSlantPath(n,o,i,l,m,t,s,a,true)}else if(e.getRelativePoint()<0&&o[n-1]&&o[n-1].getValue()<t.getRelativePoint()){this._createSlantPath(n,o,i,l,m,t,s,a,true)}g={from:s.getFrom(),to:s.getTo(),value:s.getValue()};a.push(new r(g))}else{g={from:s.getFrom(),to:s.getTo(),value:t.getRelativePoint()};a.push(new r(g))}}return a};o.prototype._getNearestThresholdPeriod=function(e,t){var i=e.filter(function(e){return t.getTime()-e.getFrom().getTime()>0});return i[i.length-1]||null};o.prototype._getNextThresholdPeriod=function(e,t){var i=e.filter(function(e){return e.getFrom().getTime()-t.getTime()>0});return i[0]||null};o.prototype._getFilterThresholdPeriods=function(e,t,i){return e.filter(function(e,r){e._actualIndex=r;var o=t[i];var a=t[i+1];return e.getFrom().getTime()==o.getFrom().getTime()||a&&a.getFrom().getTime()!==o.getTo().getTime()&&e.getFrom().getTime()==o.getTo().getTime()||e.getFrom().getTime()>o.getFrom().getTime()&&e.getFrom().getTime()<o.getTo().getTime()})};o.prototype._getPeriodValue=function(e,t,i){var r;if(i){r=e.getValue()>t.getValue()?t.getValue():e.getValue()}else{r=e.getValue()<t.getValue()?t.getValue():e.getValue()}return r};o.prototype._createIntersectionThresholdPaths=function(e,t,i,o,a,g,n){var s=i.getFrom();var h=i.getTo();var l;var m={};var T=this._getFilterThresholdPeriods(t,e,g);this._createSlantPath(g,e,t,s,h,o,i,a,false);if(T.length>0){for(var u=0;u<T.length;u++){if(u==0&&T[u].getFrom().getTime()>s.getTime()){l=this._getNearestThresholdPeriod(t,T[u].getFrom());var v=this._getCurrentThr(t,l);if(l.getTo().getTime()===v.getFrom().getTime()){if(l.getTo().getTime()===T[u].getFrom().getTime()){m={from:i.getFrom(),to:T[u].getFrom()};m.value=this._getPeriodValue(i,l,n)}else{var p=this._createSlantThresholdPath(l,T[u],e,g);if(l.getTo().getTime()>s.getTime()){m={from:this.getAxisTime().viewToTime(p.x),to:l.getTo(),value:l.getValue()}}else{m={from:i.getFrom(),to:i.getFrom(),value:l.getValue()<o.getRelativePoint()?-p.y:p.y}}}a.push(new r(m))}}if(T[u].getFrom().getTime()==s.getTime()){if(g!=0){if(T[u].getTo().getTime()>i.getTo().getTime()){m={from:i.getFrom(),to:i.getTo()};m.value=this._getPeriodValue(i,T[u],n)}else{m={from:i.getFrom(),to:T[u].getTo()};m.value=this._getPeriodValue(i,T[u],n)}}else{m={from:i.getFrom(),to:i.getTo()};m.value=this._getPeriodValue(i,T[u],n)}a.push(new r(m))}else if(T[u].getFrom().getTime()>s.getTime()){l=this._getNearestThresholdPeriod(t,T[u].getFrom());if(l.getTo().getTime()<s.getTime()){var p=this._createSlantThresholdPath(l,T[u],e,g);var f=this.getAxisTime().viewToTime(p.x);m={value:p.y};m.from=f;m.to=f;a.push(new r(m))}if(T[u].getTo().getTime()>i.getTo().getTime()){m={from:T[u].getFrom(),to:i.getTo()};if(i.getValue()>T[u].getValue()&&e[g+1]&&e[g+1].getValue()>T[u].getValue()){m.to=T[u].getTo()}if(e[g-1]&&s.getTime()!=e[g-1].getTo().getTime()&&l.getValue()<T[u].getValue()&&l.getTo().getTime()!=T[u].getFrom().getTime()){m.from=s}}else{m={from:T[u].getFrom(),to:T[u].getTo()}}m.value=this._getPeriodValue(i,T[u],n);a.push(new r(m))}}}else if(!e[g-1]||s.getTime()>=e[g-1].getTo().getTime()){l=this._getNearestThresholdPeriod(t,i.getFrom());var d=this._getNextThresholdPeriod(t,i.getFrom());if(l.getTo().getTime()<i.getFrom().getTime()&&d&&d.getFrom().getTime()>i.getTo().getTime()){var p=this._createSlantThresholdPath(l,d,e,g);var f=this.getAxisTime().viewToTime(p.x);m={value:p.y};m.from=i.getFrom();m.to=i.getFrom();a.push(new r(m));var p=this._createSlantThresholdPath(d,l,e,g);var f=this.getAxisTime().viewToTime(p.x);m={value:p.y};m.from=i.getTo();m.to=i.getTo();a.push(new r(m))}else{if(i.getFrom().getTime()>l.getFrom().getTime()){if(l.getTo().getTime()>i.getTo().getTime()){m={from:i.getFrom(),to:i.getTo()};m.value=this._getPeriodValue(i,l,n)}else if(l.getTo().getTime()>i.getFrom().getTime()){m={from:i.getFrom(),to:l.getTo()};m.value=this._getPeriodValue(i,l,n)}}a.push(new r(m))}}};o.prototype._createSlantThresholdPath=function(e,t,i,r){var o=e.getTo().getTime();var a=t.getFrom().getTime();var g=this.getAxisTime().timeToView(o);var n=this.getAxisTime().timeToView(a);var s=e.getValue();var h=t.getValue();var l=this.getAxisTime().timeToView(i[r].getTo().getTime());var m=i[r+1]?this.getAxisTime().timeToView(i[r+1].getFrom().getTime()):l;if(i[r].getFrom().getTime()>e.getTo().getTime()&&i[r].getFrom().getTime()<t.getFrom().getTime()){l=this.getAxisTime().timeToView(i[r].getFrom().getTime());m=i[r-1]?this.getAxisTime().timeToView(i[r-1].getTo().getTime()):l}var T={x:g,y:s};var u={x:n,y:h};var v={x:l,y:h};var p={x:m,y:s};return this._getIntersect(T,u,v,p)};o.prototype._getIntersect=function(e,t,i,r){var o=(e.x-t.x)*(i.y-r.y);var a=(e.y-t.y)*(i.x-r.x);var g=o-a;if(g==0){throw new Error("Number of intersection points is zero or infinity.")}var n=e.x*t.y-e.y*t.x;var s=i.x*r.y-i.y*r.x;var h=i.x-r.x;var l=e.x-t.x;var m=i.y-r.y;var T=e.y-t.y;var u=(n*h-l*s)/g;var v=(n*m-T*s)/g;var p={x:u,y:v};return p};o.prototype._getCurrentThr=function(e,t){var i,r=Number.MAX_SAFE_INTEGER/2;e.forEach(function(e){if(t.getFrom().getTime()!=e.getFrom().getTime()&&t.getTo().getTime()!=e.getTo().getTime()){var o=Math.abs(e.getFrom().getTime()-t.getTo().getTime());if(o<r){r=o;i=e}}});return i};o.prototype._createSlantPath=function(e,t,i,o,a,g,n,s,h){if(t[e-1]&&o.getTime()!=t[e-1].getTo().getTime()){var l=this._getNearestThresholdPeriod(i,o);var m=this._getCurrentThr(i,l);var T=t[e-1].getTo();var u=this.getAxisTime().timeToView(T);var v={x:u,y:t[e-1].getValue()};var p={x:this.getAxisTime().timeToView(t[e].getFrom().getTime()),y:t[e].getValue()};var f,d;if(l.getTo().getTime()>o.getTime()){f={x:this.getAxisTime().timeToView(t[e-1].getTo().getTime()),y:l.getValue()};d={x:this.getAxisTime().timeToView(l.getTo().getTime()),y:l.getValue()}}else{f={x:this.getAxisTime().timeToView(l.getTo().getTime()),y:l.getValue()};d={x:this.getAxisTime().timeToView(m.getFrom().getTime()),y:m.getValue()}}var c=this._getIntersect(v,p,f,d);var y=this.getAxisTime().viewToTime(c.x);var P={value:c.y};P.from=y;P.to=y;s.push(new r(P))}};o.prototype._renderMiddleLine=function(e,t){if(this.getShowMiddleLine()){var i=this._getMiddleLineY(t);e.openStart("path",this.getId()+"-middleLine");e.attr("d","M "+t.x+" "+i+" h "+t.width);var r=this.getCustomMiddleLine();if(r){e.attr("stroke",r.getStroke());e.attr("stroke-width",r.getStrokeWidth());e.attr("stroke-dasharray",r.getStrokeDasharray());e.attr("shape-rendering","crispEdges")}else{e.class("sapGanttStockMiddleLine")}e.openEnd().close("path")}};o.prototype._getMiddleLineY=function(e){var t=this._createTransform(this.getRelativeMiddleLinePoint());var i=e.height*(t/100);var r=e.y+e.height-i;return r};o.prototype._getClipPathIdOfDimension=function(e){return"url(#"+e.getId()+"-clipPath)"};o.prototype._renderDimensionPaths=function(e,t){var i=t.x,r=t.y,o=t.width,a=t.height;var g=[];var n=[];var s={};var h;var l=this.getStockChartDimensions();var m=l.filter(function(e){return e.getIsThreshold()!=true});var T=l.filter(function(e){return e.getIsThreshold()==true&&e.getRelativePoint()>m[0].getRelativePoint()}).sort(function(e,t){return t.getRelativePoint()-e.getRelativePoint()});var u=l.filter(function(e){return e.getIsThreshold()==true&&e.getRelativePoint()<m[0].getRelativePoint()}).sort(function(e,t){return e.getRelativePoint()-t.getRelativePoint()});if(m){e.openStart("g").openEnd();var v=m[0];g=[];n=[];for(var p=0;p<v.getStockChartPeriods().length;p++){var f=v.getStockChartPeriods()[p];if(f.getValue()<v.getRelativePoint()){g.push(f)}else{n.push(f)}}var d=a;if(g.length>0&&n.length>0){for(var c=0;c<2;c++){var y=this._createTransform(v.getRelativePoint());var P=a*(y/100);var x=d-P;if(c==1){if(u.length>0){h=u[0].getRemainCapacityColor()}else{h=v.getRemainCapacityColorNegative()}}else if(T.length>0){h=T[0].getRemainCapacityColor()}else{h=v.getRemainCapacityColor()}s={id:v.getId()+(c==1?"-scRectNegative":"-scRect"),x:i,y:c==1?r+x:r,width:o,height:c==1?a-x:a-(a-x),fill:h,"clip-path":this._getClipPathIdOfDimension(v)};this.renderRectangleWithAttributes(e,s)}}else if(n.length>0||g.length>0){var V=n.length>0?T:u;if(V.length>0){h=V[0].getRemainCapacityColor()}else{h=n.length>0?v.getRemainCapacityColor():v.getRemainCapacityColorNegative()}s={id:v.getId()+(n.length>0?"-scRect":"-scRectNegative"),x:i,y:r,width:o,height:a,fill:h,"clip-path":this._getClipPathIdOfDimension(v)};this.renderRectangleWithAttributes(e,s)}e.close("g")}if(T.length>0){for(var F=0;F<T.length;F++){e.openStart("g").openEnd();var _=T[F];s={id:_.getId()+"-scRect",x:i,y:r,width:o,height:a,fill:T[F+1]?T[F+1].getRemainCapacityColor():m[0].getRemainCapacityColor(),"clip-path":this._getClipPathIdOfDimension(_)};this.renderRectangleWithAttributes(e,s);e.close("g")}}if(u.length>0){for(var F=0;F<u.length;F++){e.openStart("g").openEnd();var C=u[F];s={id:C.getId()+"-scRect",x:i,y:r,width:o,height:a,fill:u[F+1]?u[F+1].getRemainCapacityColor():m[0].getRemainCapacityColor(),"clip-path":this._getClipPathIdOfDimension(C)};this.renderRectangleWithAttributes(e,s);e.close("g")}}if(m){e.openStart("g").openEnd();var v=m[0];this.renderDimensionPath(e,v,r,a,"scPath");e.close("g")}if(T.length>0){for(var F=0;F<T.length;F++){e.openStart("g").openEnd();var _=T[F];this.renderDimensionPath(e,_,r,a,"scPath");e.close("g")}}if(u.length>0){for(var F=0;F<u.length;F++){e.openStart("g").openEnd();var C=u[F];this.renderDimensionPath(e,C,r,a,"scPath");e.close("g")}}};o.prototype._renderTooltips=function(t,i){var r=i.y,o=i.height,a={};t.openStart("g");t.class("sc-tooltips").openEnd();var g=this.getAllDimensionPoints();g.forEach(function(i,g,n){var s=n[g+1]||i;var h=i.tooltip;var l=i.name!==s.name;if(l){h=i.tooltip+"\n"+s.tooltip}var m=this.toX(i.from),T=n.length-1===g,u=this.toX(T?s.to:s.from),v=Math.abs(u-m);if(v>0){var p={opacity:0,fillOpacity:0,strokeOpacity:0};var f=e({x:m,y:r,width:v,height:o},p);if(i.dimensionName){f["data-text"]=i.dimensionName}this.renderRectangleWithAttributes(t,f,h);a=f}}.bind(this));if(Object.keys(a).length!=0){a.x=i.x;a.width=0;a.class="stockChartTooltip";this.renderRectangleWithAttributes(t,a,"stockChartTooltip")}t.close("g")};o.prototype.getAllDimensionPoints=function(){var e=[];this.getStockChartDimensions().forEach(function(t){var i=t.getName();t.getStockChartPeriods().forEach(function(t,r,o){var a;var g=t.getTooltip();if(!g){g=i+": "+t.getValue()}else{a=i}if(t.getFrom().getTime()!=t.getTo().getTime()){e.push({name:i,from:t.getFrom(),to:t.getFrom(),tooltip:g,dimensionName:a});e.push({name:i,from:t.getTo(),to:t.getTo(),tooltip:g,dimensionName:a})}else{e.push({name:i,from:t.getFrom(),to:t.getTo(),tooltip:g,dimensionName:a})}})});return e};o.prototype.renderDimensionPath=function(e,t,i,r,o,a,g){if(t.getIsThreshold()&&g){var n=a.filter(function(e){return e.getIsThreshold()!=true});var s=t.getStockChartPeriods().length>0?this._createThresholdDefsPath(t,n[0]):[]}var h=t.getIsThreshold()&&g?s:t.getStockChartPeriods();var l="";for(var m=0;m<h.length;m++){var T=m===0,u=m===h.length-1;var v=h[m];var p=this.toX(v.getFrom());var f=this.toX(v.getTo());var d=v.getValue();if(d>this.getMaxValue()){d=this.getMaxValue()}if(d<this.getMinValue()){d=this.getMinValue()}var c=i+r;var y=r*(this._createTransform(d)/100);var P=c-y;var x=this._createTransform(t.getIsThreshold()&&g?n[0].getRelativePoint():t.getRelativePoint());var V=r*(x/100);var F=c-V;if(g){l+=(T?" M "+p+" "+F:"")+" L "+p+" "+P+" L "+f+" "+P+(u?" L "+f+" "+F:"")}else{l+=(T?" M "+p+" "+P:"")+(T?"":" L "+p+" "+P)+" L "+f+" "+P}}if(o){e.openStart("path",t.getId()+"-"+o)}else{e.openStart("path")}e.attr("d",l);e.attr("fill","none");e.attr("stroke-width",t.getDimensionStrokeWidth());if(t.getDimensionStrokeDasharray()){e.attr("stroke-dasharray",t.getDimensionStrokeDasharray())}e.attr("stroke",t.getDimensionPathColor());e.class("sapGanttScDimensionPath");e.openEnd().close("path")};o.prototype._createTransform=function(e){var t={max:this.getMaxValue(),min:this.getMinValue()};var i={max:100,min:0};var r=(i.max-i.min)/(t.max-t.min);var o=(e-t.min)*r;return o};o.prototype.destroy=function(){t.prototype.destroy.apply(this,arguments)};return o},true);
//# sourceMappingURL=StockChart.js.map