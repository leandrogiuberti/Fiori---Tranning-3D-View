/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/util/ObjectPath","sap/ui/core/Core","sap/gantt/misc/Utility","sap/gantt/misc/Format","sap/gantt/simple/GanttUtils","sap/gantt/misc/Memoizer","sap/base/i18n/date/TimezoneUtils","sap/ui/core/date/UI5Date","sap/ui/base/Object","sap/gantt/utils/GanttChartConfigurationUtils"],function(e,t,i,o,s,a,n,r,l,f){"use strict";var h={};var g=l.extend("sap.gantt.misc.AxisTime",{constructor:function(e,t,o,s,n,r,f){l.call(this);this.timeRange=e;this.viewRange=t;this.zoomRate=i.assign(o,1);this.zoomOrigin=i.assign(s,0);this.viewOffset=i.assign(n,0);this.locale=r;this._shapeWidthValue=a.createCache();this.timeZoneOffset=0;this._oZoomStrategy=f;if(f){this._discontinuityProviderInstance=f.getProperty("_discontinuousProvider")}this.continuousScale=d3.time.scale().domain(e).range(t).clamp(false);this.discontinuousScale=null;var h=i=>window.fc.scaleDiscontinuous(d3.time.scale().domain(e).range(t).clamp(false)).discontinuityProvider(i).domain(e).range(t).clamp(false);this._useDiscontinuousScale=()=>{if(this._discontinuityProviderInstance){var e=f.getTimeLineOption();if(e&&this._discontinuityProviderInstance.useDiscontinuousScale(e.smallInterval.unit)){return true}}return false};if(this._discontinuityProviderInstance){this.discontinuousScale=h(this._discontinuityProviderInstance)}Object.defineProperty(this,"scale",{get:function(){return this._useDiscontinuousScale()?this.discontinuousScale:this.continuousScale}});Object.defineProperty(this,"axisScale",{get:function(){if(this._useDiscontinuousScale()&&this._discontinuityProviderInstance.localInstance){return h(this._discontinuityProviderInstance.localInstance)}return this.scale}});Object.defineProperty(this,"discontinuityProvider",{get:function(){return this._useDiscontinuousScale()?this._discontinuityProviderInstance:null}})}});g.prototype.CONSTANT={C_SEPARATOR:"_@@_",C_MESSAGE:{ARGUMENT_ERROR:"AxisOrdinal: Argument Error!"}};g.prototype.timeToView=function(e,t,i){var o=i||this.scale;if(f.getRTL()!==true){return(o(e)-this.zoomOrigin)*this.zoomRate-(t?0:this.viewOffset)}else{return this.viewRange[1]*this.zoomRate-((o(e)+this.zoomOrigin)*this.zoomRate+(t?0:this.viewOffset))}};g.prototype.viewToTime=function(e,t){if(f.getRTL()!==true){return this.scale.invert((e+(t?0:this.viewOffset))/this.zoomRate+this.zoomOrigin)}else{return this.scale.invert(this.viewRange[1]-(e+(t?0:this.viewOffset))/this.zoomRate-this.zoomOrigin)}};g.prototype.setTimeRange=function(e){if(this.timeRange[0].getTime()!=e[0].getTime()||this.timeRange[1].getTime()!=e[1].getTime()){this._shapeWidthValue.clearCache()}this.timeRange=e;this.continuousScale.domain(e);if(this.discontinuousScale){this.discontinuousScale.domain(e)}return this};g.prototype.getTimeRange=function(){return this.continuousScale.domain()};g.prototype.getTimeRangeSlice=function(e,t){var i=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(e),this.timeZoneOffset):this.viewToTime(e);var o=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(t),this.timeZoneOffset):this.viewToTime(t);if(f.getRTL()!==true){return[i,o]}else{return[o,i]}};g.prototype.setViewRange=function(e){this.viewRange=e;this.continuousScale.range(e);if(this.discontinuousScale){this.discontinuousScale.range(e)}return this};g.prototype.getViewRange=function(){var e=this.continuousScale.range();return[Math.round((e[0]-this.zoomOrigin)*this.zoomRate-this.viewOffset),Math.round((e[1]-this.zoomOrigin)*this.zoomRate-this.viewOffset)]};g.prototype.getZoomStrategy=function(){return this._oZoomStrategy};g.prototype.setZoomRate=function(e){this.zoomRate=i.assign(e,1);return this};g.prototype.getZoomRate=function(){return this.zoomRate};g.prototype.setZoomOrigin=function(e){if(this.zoomOrigin!=e){this._shapeWidthValue.clearCache()}this.zoomOrigin=i.assign(e,0);return this};g.prototype.getZoomOrigin=function(){return this.zoomOrigin};g.prototype.setViewOffset=function(e){this.viewOffset=i.assign(e,0);return this};g.prototype.getViewOffset=function(){return this.viewOffset};g.prototype.setLocale=function(e){this.locale=e;return this};g.prototype.getLocale=function(){return this.locale};g.prototype.clone=function(){return new g([new Date(this.timeRange[0].valueOf()),new Date(this.timeRange[1].valueOf())],this.viewRange.slice(0),this.zoomRate,this.zoomOrigin,this.viewOffset,this.locale,this._oZoomStrategy)};g.prototype._get2dContext=function(e,t){if(!h.context){h.context=document.createElement("canvas").getContext("2d")}if(h.fontSize!==e||h.fontFamily!==t){h.context.font=e+"px "+t;h.fontSize=e;h.fontFamily=t}return h.context};g.prototype._getShapeTextWidth=function(e,t,i){return this._get2dContext(t,i).measureText(e).width};g.prototype.getCurrentTickTimeIntervalLevel=function(){var e=this._oZoomStrategy.getTimeLineOption(),t=this._oZoomStrategy.getTimeLineOptions(),i=0;for(var o in t){if(t[o]===e){return i}i++}};g.prototype.getCurrentTickTimeIntervalKey=function(){var e=this._oZoomStrategy.getTimeLineOption(),t=this._oZoomStrategy.getTimeLineOptions();for(var i in t){if(t[i]===e){return i}}};g.prototype.getNowLabel=function(e){var t=new Date;if(e===undefined||e){t=this.convertToTimezone(t,"UTC");t=this.offsetTimezoneDiff(t)}var i=this.timeToView(t);return[{date:t,value:Math.round(i)}]};g.prototype.getFirstSmallIntervalIndex=function(e,t){for(var i=0;i<e.length;i++){var s=o.dateToAbapTimestamp(e[i].date);if(s>=t){return i}}};g.prototype.getTickTimeIntervalLabel=function(e,t,a){var n,r,l,h=null;var m=o.getTimeStampFormatter();var c=[];if(h){for(n=0;n<h.length;n++){c[n]={};r=h[n].getStartTime();l=h[n].getEndTime();c[n].startDate=m.parse(r);c[n].endDate=m.parse(l)}}var u=this.timeZoneOffset?[d3.time.second.offset(this.timeRange[0],this.timeZoneOffset),d3.time.second.offset(this.timeRange[1],this.timeZoneOffset)]:this.timeRange;var v=new g(u,this.viewRange,this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy);var d=null;var T=null;var p=null;var S=null;var y=null;var w=null;var O=null;var R=[];var _=[];var D=null;if(t){w=this.timeZoneOffset?d3.time.second.offset(t[0],this.timeZoneOffset):t[0];O=this.timeZoneOffset?d3.time.second.offset(t[1],this.timeZoneOffset):t[1];d=this.timeZoneOffset?[d3.time.second.offset(t[0],this.timeZoneOffset),d3.time.second.offset(t[1],this.timeZoneOffset)]:t;T=[this.timeToView(t[0]),this.timeToView(t[1])];if(c&&c.length){this._calculateTimeRange(c,w,O,R)}D=this._calculateScale(R,_,d,T,false)}else if(a){w=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(a[0]),this.timeZoneOffset):this.viewToTime(a[0]);O=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(a[1]),this.timeZoneOffset):this.viewToTime(a[1]);d=[w,O];T=a;if(c.length){this._calculateTimeRange(c,w,O,R)}D=this._calculateScale(R,_,d,T,false)}else{w=u[0];O=u[1];d=u;T=this.viewRange;if(c.length){this._calculateTimeRange(c,w,O,R)}D=this._calculateScale(R,_,d,T,u)}_=D.viewRangeSet;p=D.visibleScale;S=D.dstScale;y=D.normalScale;var z=[];var Z,b,L,P;var k={unit:this._oZoomStrategy.getTimeLineOption().largeInterval.unit,span:this._oZoomStrategy.getTimeLineOption().largeInterval.span};var I={unit:this._oZoomStrategy.getTimeLineOption().smallInterval.unit,span:this._oZoomStrategy.getTimeLineOption().smallInterval.span};var F,C;var x=this._oZoomStrategy.getUpperRowFormatter(),V=this._oZoomStrategy.getLowerRowFormatter();if(k){var M=[];var j=[];var A=[];if(!(p instanceof Array)){M[0]=this._getTimeIntervalTicks(k,p)}else{for(F=0;F<S.length;F++){j[F]=S[F].ticks(s.getObjectFromPath(k.unit).range,k.span);A[F]=y[F].ticks(s.getObjectFromPath(k.unit).range,k.span)}for(F=0;F<p.length;F++){M[F]=p[F].ticks(s.getObjectFromPath(k.unit).range,k.span)}}var U=[];if(M[0]!==null){for(F=0;F<M.length;F++){for(C=0;C<M[F].length;C++){Z=this.offsetTimezoneDiff(M[F][C]);L=v.timeToView(Z);P=i.getLowerCaseLabel(this.locale.getFormattedDate(x,Z));U.push({date:Z,value:Math.round(L),label:P})}}}if(j[0]!==null){for(F=0;F<j.length;F++){for(C=0;C<j[F].length;C++){Z=j[F][C];b=A[F][C];L=v.timeToView(d3.time.second.offset(Z.getTime(),-60*60));P=i.getLowerCaseLabel(this.locale.getFormattedDate(x,Z));U.push({date:Z,value:Math.round(L),label:P})}}}z.push(U)}else{z.push([])}if(I){var W=[];var E=[];var H=[];if(!(p instanceof Array)){H[0]=this._getTimeIntervalTicks(I,p)}else{for(F=0;F<S.length;F++){W[F]=S[F].ticks(s.getObjectFromPath(I.unit).range,I.span);E[F]=y[F].ticks(s.getObjectFromPath(I.unit).range,I.span)}for(F=0;F<p.length;F++){H[F]=p[F].ticks(s.getObjectFromPath(I.unit).range,I.span)}}var G=[];if(H[0]){for(F=0;F<H.length;F++){for(C=0;C<H[F].length;C++){Z=this.offsetTimezoneDiff(H[F][C]);var N;var q=false;if(c.length){for(var K=0;K<c.length;K++){if(Z.getTime()===c[K].startDate.getTime()){N=d3.time.second.offset(Z.getTime(),60*60);if(C===H[F].length-1&&this._oZoomStrategy.isLowerRowTickHourSensitive()){q=true}}if(C===H[F].length-1&&Z.getTime()===d3.time.second.offset(c[K].endDate.getTime(),60*60).getTime()){N=d3.time.second.offset(Z.getTime(),-60*60)}}}L=v.timeToView(Z);var Y;if(q){break}else if(N){Y=i.getLowerCaseLabel(this.locale.getFormattedDate(x,N));P=i.getLowerCaseLabel(this.locale.getFormattedDate(V,N));N=null}else{Y=i.getLowerCaseLabel(this.locale.getFormattedDate(x,Z));P=i.getLowerCaseLabel(this.locale.getFormattedDate(V,Z))}G.push({date:Z,value:Math.round(L),label:P,largeLabel:Y})}}}if(W[0]){for(F=0;F<W.length;F++){for(C=0;C<W[F].length;C++){Z=W[F][C];b=E[F][C];var B;var J=false;if(C===W[F].length-1&&this._oZoomStrategy.isLowerRowTickHourSensitive()){if(R.length>0){for(var Q=0;Q<R.length;Q++){if(!R[Q].haveDST&&b.getTime()===R[Q].range[0].getTime()){J=true}}}}if(c.length){for(var X=0;X<c.length;X++){if(Z.getTime()===c[X].startDate.getTime()){B=d3.time.second.offset(Z.getTime(),60*60)}if(C===W[F].length-1&&Z.getTime()===d3.time.second.offset(c[X].endDate.getTime(),60*60).getTime()){B=d3.time.second.offset(Z.getTime(),-60*60)}}}if(!this._oZoomStrategy.isLowerRowTickHourSensitive()){L=v.timeToView(d3.time.second.offset(Z.getTime(),-60*60))}else{L=v.timeToView(b)}if(J){break}else if(B){P=i.getLowerCaseLabel(this.locale.getFormattedDate(V,B));B=null}else{P=i.getLowerCaseLabel(this.locale.getFormattedDate(V,Z))}G.push({date:Z,value:Math.round(L),label:P})}}}z.push(G)}else{z.push([])}var $=z[0];var ee=z[1];var te=this.getZoomStrategy().getVisibleHorizon().getStartTime();this.largeIntervalLabel=true;this.largeIntervalPath=false;var ie=this.getFirstSmallIntervalIndex(ee,te);var oe,se,ae=30;var ne,re,le=0;var fe=f.getRTL();if(ee[ie]){var he=ee[ie].largeLabel;this.firstTickPosition=ee[ie].value;var ge=false;var me=document.querySelector(".sapGanttTimeHeaderSvgText")||document.querySelector(".sapGanttTimeHeaderSvgText0");if(me){var ce=getComputedStyle(me);ne=ce.fontSize;re=ce.fontFamily;le=Math.ceil(this._getShapeTextWidth(he,ne,re))+ae}oe=fe?this.firstTickPosition-le:this.firstTickPosition+le;for(n=0;n<$.length;n++){le=me?Math.ceil(this._getShapeTextWidth($[n].label,ne,re))+ae:0;se=fe?$[n].value-le:$[n].value+le;var ue=fe?$[n].value<this.firstTickPosition&&$[n].value>=oe:$[n].value>this.firstTickPosition&&$[n].value<=oe;var ve=fe?this.firstTickPosition<$[n].value&&this.firstTickPosition>=se:this.firstTickPosition>$[n].value&&this.firstTickPosition<=se;var de=$[n].label!==he;if(ue||ve&&de){this.largeIntervalLabel=false;break}}if(this.largeIntervalLabel){for(n=0;n<$.length;n++){if($[n].label===he){if($[n].value===this.firstTickPosition){this.largeIntervalPath=true}$[n].value=this.firstTickPosition;ge=true;break}}if(!ge){var Te={value:this.firstTickPosition,label:he};z[0].push(Te)}}}return z};g.prototype._getTimeIntervalTicks=function(t,i){if(t.unit!==sap.gantt.config.TimeUnit.week){return i.ticks(s.getObjectFromPath(t.unit).range,t.span)}var o=["d3.time.sunday","d3.time.monday","d3.time.tuesday","d3.time.wednesday","d3.time.thursday","d3.time.friday","d3.time.saturday"];var a=this.getZoomStrategy().getFirstDayOfWeek();var n=this.discontinuityProvider||{};var r="firstTradingDayOfWeek"in n?n.firstTradingDayOfWeek(a):a;return i.ticks(e.get(o[r]).range,t.span)};g.prototype._calculateScale=function(e,t,i,s,a){var n=null;var r=[];var l=[];if(e.length){n=[];var f=0;var h=0;for(var m=0;m<e.length;m++){t[m]=[this.timeToView(e[m].range[0]),this.timeToView(e[m].range[1])];if(e[m].haveDST){r[f]=new g(e[m].dstRange,t[m],this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale;l[f]=new g(e[m].range,t[m],this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale;f++}else{n[h]=new g(e[m].range,t[m],this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale;h++}}}else if(a){n=new g(a,this.viewRange,this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale}else{i=[this.convertToTimezone(i[0]),this.convertToTimezone(i[1])];n=new g(i,s,this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).axisScale}if(this.discontinuityProvider){var c=o.abapTimestampToDate(this._oZoomStrategy.getTotalHorizon().getStartTime());if(n.domain()[0].getTime()==this._discontinuityProviderInstance.clampUp(c).getTime()){var u=n.domain()[1];n.domain([this._discontinuityProviderInstance.clampDown(c),u])}}var v={viewRangeSet:t,visibleScale:n,dstScale:r,normalScale:l};return v};g.prototype._calculateTimeRange=function(e,t,i,o){if(e.length){var s=t;var a=i;var n=[];var r=[];var l,f;l=e[0].startDate;f=e[0].endDate;this._calculateRangeItem(l,f,s,a,n,r);if(e.length>1){for(var h=1;h<e.length;h++){if(n.length){var g=[];for(var m in n){g.push(n[m])}n=[];for(var c=0;c<g.length;c++){l=e[h].startDate;f=e[h].endDate;s=g[c].range[0];a=g[c].range[1];this._calculateRangeItem(l,f,s,a,n,r)}}}}for(var u in r){o.push(r[u])}for(var v in n){o.push(n[v])}}};g.prototype._calculateRangeItem=function(e,t,i,o,s,a){var n=null;if(i<e){if(o<t){if(o>e){n={};n.haveDST=false;n.range=[i,e];s.push(n);n={};n.haveDST=true;n.range=[e,o];n.dstRange=[d3.time.second.offset(e.getTime(),60*60),d3.time.second.offset(o,60*60)];a.push(n)}else{n={};n.haveDST=false;n.range=[i,o];s.push(n)}}else{n={};n.haveDST=false;n.range=[i,e];s.push(n);n={};n.haveDST=true;n.range=[e,t];n.dstRange=[d3.time.second.offset(e.getTime(),60*60),d3.time.second.offset(t.getTime(),60*60)];a.push(n);n={};n.haveDST=false;n.range=[t,o];s.push(n)}}else if(i>=e){if(i<t){if(o<=t){n={};n.haveDST=true;n.range=[i,o];n.dstRange=[d3.time.second.offset(i,60*60),d3.time.second.offset(o,60*60)];a.push(n)}else{n={};n.haveDST=true;n.range=[i,t];n.dstRange=[d3.time.second.offset(i,60*60),d3.time.second.offset(t.getTime(),60*60)];a.push(n);n={};n.haveDST=false;n.range=[t,o];s.push(n)}}else{n={};n.haveDST=false;n.range=[i,o];s.push(n)}}};g.prototype.convertToTimezone=function(e,t){var i=t||this.locale.getTimeZone();if(i!==n.getLocalTimezone()){var o=new r([e],i);return new Date(o.getFullYear(),o.getMonth(),o.getDate(),o.getHours(),o.getMinutes(),o.getSeconds(),o.getMilliseconds())}return e};g.prototype.offsetTimezoneDiff=function(e){var t=this.locale.getTimeZone();if(t!==n.getLocalTimezone()){if(this._useDiscontinuousScale()){var o=i.getNonDSTOffsetInfo(t,e);return new Date(e.getTime()+o.offset)}else{var s=e.getTime();var a=this.convertToTimezone(e,t);var r=a.getTime()-s;return new Date(s+r*-1)}}return e};return g},true);
//# sourceMappingURL=AxisTime.js.map