/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/Log","sap/base/util/ObjectPath","sap/ui/base/EventProvider","./Utility","sap/gantt/shape/ResizeShadowShape","sap/gantt/shape/ext/rls/SelectedRelationship","sap/gantt/shape/SelectedShape","sap/gantt/shape/Group","sap/gantt/shape/Text","sap/ui/core/Element"],function(jQuery,e,t,a,n,i){"use strict";var s=a.extend("sap.gantt.misc.ShapeManager",{constructor:function(e){a.apply(this);this.mShapeElementIds={};this.mShapeConfig={};this.mShapeInstance={};this.aShapeInstance=[];this.oGantt=e}});s.prototype.instantiateShapes=function(e){this.mShapeConfig={};for(var t=0;t<e.length;t++){this.mShapeConfig[e[t].getKey()]=e[t]}return this.recursiveInstantiateShapes(this.mShapeConfig).then(function(e){this.aShapeInstance=e;jQuery.each(this.aShapeInstance,function(e,t){this.mShapeInstance[t.mShapeConfig.getKey()]=t}.bind(this))}.bind(this))};s.prototype.getAllShapeInstances=function(){return this.aShapeInstance};s.prototype.getSelectedShapeInstance=function(e,t){if(this.bDestroyed){return Promise.reject()}var a=t.getCategory(null,this.oGantt.getAxisTime(),this.oGantt.getAxisOrdinal());var n=e.getSelectedClassName();if(!n){if(a===sap.gantt.shape.ShapeCategory.Relationship){n="sap.gantt.shape.ext.rls.SelectedRelationship"}else{n="sap.gantt.shape.SelectedShape"}}return this.instantiateShapeClass(n)};s.prototype.recursiveInstantiateShapes=function(e,t){var a=function(a){var n;var i=t?t:a;var s=t?t+"_"+a:a;var r=e[a];var h=r.getShapeClassName();if(h){return this.instantiateShapeClass(h).then(function(e){n=e;this.setSpecialProperty(n,r);this.setShapeElementId(s,i,n.getId());var a;if(!t){a=this.getSelectedShapeInstance(r,n).then(function(e){this.setSpecialProperty(e,r);n.setAggregation("selectedShape",e);s=i+"_selected"+i;this.setShapeElementId(s,undefined,e.getId());return this._createResizeShadowShape(r,n,i+"_resizeShadow"+i)}.bind(this))}else{a=Promise.resolve()}a=a.then(function(){var e=r.getGroupAggregation();if(e&&e instanceof Array){return this.recursiveInstantiateShapes(e,i).then(function(e){e.forEach(n.addShape,n)})}}.bind(this)).then(function(){var e=r.getClippathAggregation();if(e&&e instanceof Array){return this.recursiveInstantiateShapes(e,i).then(function(e){e.forEach(n.addPath,n)})}return n}.bind(this));return a}.bind(this))}else{return Promise.resolve(null)}}.bind(this);return Promise.all(Object.keys(e).map(a)).then(function(e){e=e.filter(function(e){return!!e});if(!t){this.sortByShapeLevelAccendingly(e)}return e}.bind(this))};s.prototype.setSpecialProperty=function(e,t){e.mShapeConfig=t;e.mChartInstance=this.oGantt;e.dataSet=[]};s.prototype.sortByShapeLevelAccendingly=function(e){e.sort(function(e,t){var a=e.mShapeConfig.getLevel(),n=t.mShapeConfig.getLevel();var i=Number.isFinite(Number(a))?a:99;var s=Number.isFinite(Number(n))?n:99;return s-i})};s.prototype.loadClass=function(e){return new Promise(function(a){var n=t.get(e);if(n){a(n)}else{sap.ui.require([e.replace(/\./g,"/")],function(e){a(e)})}})};s.prototype.instantiateShapeClass=function(t){return this.loadClass(t).then(function(a){var n=new a;if(!n){e.error("shapeClassName:"+t+" can't be instantiated");e.warning("shapeClassName:"+t+" fallback to sap.gantt.shape.Shape");n=new sap.gantt.shape.Shape}return n})};s.prototype.isShapeSelectable=function(e,t){return this.getShapePropertyValue("enableSelection",e,t)};s.prototype.isShapeResizable=function(e,t){return this.getShapePropertyValue("enableResize",e,t)};s.prototype.isShapeDuration=function(e,t){return this.getShapePropertyValue("isDuration",e,t)};s.prototype.isShapeHoverable=function(e,t){return this.getShapePropertyValue("enableHover",e,t)};s.prototype.getShapePropertyValue=function(e,t,a){var n,s;if(t){n=this.getShapeInstance(t,a)||i.getElementById(a);var r="get"+e.substr(0,1).toUpperCase()+e.substr(1);s=n&&n[r]?n[r](t):s}return s};s.prototype.isShapeDraggable=function(e,t){return this.getShapePropertyValue("enableDnD",e,t)};s.prototype.setShapeElementId=function(e,t,a){this.mShapeElementIds[e]={shapeElementId:a,shapeKey:t}};s.prototype.getShapeInstance=function(e,t){var a={};if(t){a=this._getShapeElementConfig(t)}else{var i=n.getShapeDataNameByUid(e.uid);for(var s in this.mShapeInstance){var r=this.mShapeInstance[s].mShapeConfig.getShapeDataName();if(i===r){a=this.mShapeElementIds[s];break}}}return this.mShapeInstance[a?a.shapeKey:null]};s.prototype._getShapeElementConfig=function(e){for(var t in this.mShapeElementIds){var a=this.mShapeElementIds[t];if(a.shapeElementId===e){return a}}return null};s.prototype.collectDataForSelectedShapes=function(e,t,a){var i=this.mShapeInstance;for(var s in i){var r=i[s];var h=r.mShapeConfig.getShapeDataName();var p=r.getAggregation("selectedShape");var o=p.getCategory(null,this.oGantt.getAxisTime(),this.oGantt._oAxisOrdinal);p.dataSet=[];if(o===sap.gantt.shape.ShapeCategory.Relationship){var S=e.getSelectedRelationships();p.dataSet.push({shapeData:S})}else{var l=e.getSelectedShapeDatum();for(var g=0;g<l.length;g++){var c=l[g];if(n.getShapeDataNameByUid(c.uid)!==h){continue}var u=n.getRowDatumByShapeUid(c.uid,this.oGantt.getId());var f=e.isSelectedShapeVisible(c.uid,this.oGantt.getId());if(u&&f&&this.isShapeSelectable(c,r.getId())&&this.isShapeDisplayableInRow(u,s,t,a)){p.dataSet.push({objectInfoRef:u,shapeData:[c]})}}}}};s.prototype.collectDataForAllShapeInstances=function(e,t,a){var n=true;var i=this.mShapeInstance;for(var s in i){var r=i[s];var h;var p=r.mShapeConfig.getShapeDataName();r.dataSet=[];if(r._attributeNameBindingMap){r._attributeNameBindingMap=undefined}for(var o=0;o<e.length;o++){var S=e[o];if(!p){r.dataSet.push({objectInfoRef:S,shapeData:S.data});continue}var l=this.isShapeDisplayableInRow(S,s,t,a);if(!l){continue}if(n){h=S.data[p]}else if(p===S.shapeName){h=S.shapeData}else{continue}if(h){r.dataSet.push({objectInfoRef:S,shapeData:h})}}}};s.prototype.isShapeDisplayableInRow=function(e,t,a,n){var i;if(e.chartScheme){i=e.chartScheme}else{i=a[e.type]?a[e.type].getMainChartSchemeKey():sap.gantt.config.DEFAULT_CHART_SCHEME_KEY}var s=n[i];if(s===undefined){return false}var r=s.getShapeKeys();var h=s.getModeKey()!==sap.gantt.config.DEFAULT_MODE_KEY?s.getModeKey():this.oGantt.getMode();var p=this.mShapeConfig;if(i!==sap.gantt.config.DEFAULT_CHART_SCHEME_KEY&&r.indexOf(t)===-1||h!==sap.gantt.config.DEFAULT_MODE_KEY&&p[t].getModeKeys()&&p[t].getModeKeys().length>0&&p[t].getModeKeys().indexOf(h)<0||!e.data){return false}return true};s.prototype.isRelationshipDisplayable=function(e){var t=this.mShapeConfig;var a=e.mShapeConfig.getKey();var n=t[a]?t[a].getModeKeys():[];if(jQuery.inArray(this.oGantt.getMode(),n)===-1&&this.oGantt.getMode()!==sap.gantt.config.DEFAULT_MODE_KEY){return false}return true};s.prototype.getResizeShadowShapeInstance=function(e,t){if(this.bDestroyed){return Promise.reject()}var a=t.getCategory(null,this.oGantt.getAxisTime(),this.oGantt.getAxisOrdinal());var n=e.getResizeShadowClassName();if(!n||n===""){if(a===sap.gantt.shape.ShapeCategory.InRowShape){n="sap.gantt.shape.ResizeShadowShape"}else{return Promise.resolve(null)}}return this.instantiateShapeClass(n)};s.prototype._createResizeShadowShape=function(e,t,a){return this.getResizeShadowShapeInstance(e,t).then(function(n){if(this.bDestroyed){return}if(n){this.setSpecialProperty(n,e);t.setAggregation("resizeShadowShape",n);this.setShapeElementId(a,undefined,n.getId())}}.bind(this))};s.prototype.destroy=function(){this.bDestroyed=true};s.prototype._createResizeShadowShapeSync=function(e,t,a){var n=this.getResizeShadowShapeInstanceSync(e,t);if(n){this.setSpecialProperty(n,e);t.setAggregation("resizeShadowShape",n);this.setShapeElementId(a,undefined,n.getId())}};s.prototype.getResizeShadowShapeInstanceSync=function(e,t){var a=null;var n=t.getCategory(null,this.oGantt.getAxisTime(),this.oGantt.getAxisOrdinal());var i=e.getResizeShadowClassName();if(!i||i===""){if(n===sap.gantt.shape.ShapeCategory.InRowShape){i="sap.gantt.shape.ResizeShadowShape"}else{return null}}a=this.instantiateShapeClassSync(i);return a};s.prototype.instantiateShapeClassSync=function(a){var n=t.get(a);if(!n){throw new Error("Class "+a+" not preloaded. Please add it to require of your"+" controller to ensure that it's initialized before this point or use Gantt 2.0.")}var i=new n;if(!i){e.error("shapeClassName:"+a+" can't be instantiated");e.warning("shapeClassName:"+a+" fallback to sap.gantt.shape.Shape");i=new sap.gantt.shape.Shape}return i};s.prototype.recursiveInstantiateShapesSync=function(e,t){var a=[],n;for(var i in e){var s=t?t:i;var r=t?t+"_"+i:i;var h=e[i];var p=h.getShapeClassName();if(p){n=this.instantiateShapeClassSync(p);this.setSpecialProperty(n,h);this.setShapeElementId(r,s,n.getId());if(!t){var o=this.getSelectedShapeInstanceSync(h,n);this.setSpecialProperty(o,h);n.setAggregation("selectedShape",o);r=s+"_selected"+s;this.setShapeElementId(r,undefined,o.getId());this._createResizeShadowShapeSync(h,n,s+"_resizeShadow"+s)}var S=h.getGroupAggregation();if(S&&S instanceof Array){var l=this.recursiveInstantiateShapesSync(S,s);for(var g=0;g<l.length;g++){n.addShape(l[g])}}var c=h.getClippathAggregation();if(c&&c instanceof Array){var u=this.recursiveInstantiateShapesSync(c,s);for(var f=0;f<u.length;f++){n.addPath(u[f])}}}a.push(n)}if(!t){this.sortByShapeLevelAccendingly(a)}return a};s.prototype.getSelectedShapeInstanceSync=function(e,t){var a=null;var n=t.getCategory(null,this.oGantt.getAxisTime(),this.oGantt.getAxisOrdinal());var i=e.getSelectedClassName();if(!i){if(n===sap.gantt.shape.ShapeCategory.Relationship){i="sap.gantt.shape.ext.rls.SelectedRelationship"}else{i="sap.gantt.shape.SelectedShape"}}a=this.instantiateShapeClassSync(i);return a};s.prototype.instantiateShapesSync=function(e){this.mShapeConfig={};for(var t=0;t<e.length;t++){this.mShapeConfig[e[t].getKey()]=e[t]}this.aShapeInstance=this.recursiveInstantiateShapesSync(this.mShapeConfig);jQuery.each(this.aShapeInstance,function(e,t){this.mShapeInstance[t.mShapeConfig.getKey()]=t}.bind(this))};return s});
//# sourceMappingURL=ShapeManager.js.map