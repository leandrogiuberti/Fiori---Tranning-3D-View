/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/Device","sap/ui/base/Object","sap/gantt/misc/ShapeManager","sap/gantt/misc/Format","sap/ui/core/Core","sap/gantt/misc/Utility","sap/gantt/drawer/ShapeInRow","sap/ui/core/Element"],function(jQuery,e,t,a,i,s,o,r,n){"use strict";var h=t.extend("sap.gantt.eventHandler.ShapeResizeHandler",{constructor:function(e){t.call(this);this._oSourceChart=e;this._bResizing=false;this._oResizingData=undefined;this._oShapeManager=e._oShapeManager;this._oSourceChartId=this._oSourceChart.getId();this._oShapeInRowDrawer=new r;this._DEFAULT_RESIZE_CURSOR_SHOWING_THRESHOLD=1;this._DEFAULT_MOUSE_MOVE_PIXEL=3;this._TIMESTAMP_START_TIME_KEY="time";this._TIMESTAMP_END_TIME_KEY="endTime"}});h.prototype.getIsResizing=function(){return this._bResizing};h.prototype.getResizingData=function(){return this._oResizingData};h.prototype.handleShapeResize=function(e){if(e.button===0){var t=d3.select(e.target).datum();if(e.target.getAttribute("class")&&t){var a=e.target.getAttribute("class").split(" ")[0];if(d3.select(e.target).classed("sapUiShapeResizingCursor")&&this._oShapeManager.isShapeResizable(t,a)&&this._oShapeManager.isShapeDuration(t,a)){this._handleShapeResizeStart(e);this._preventBubbleAndDefault(e)}}}};h.prototype._handleShapeResizeStart=function(e){var t=jQuery(this._oSourceChart.getDomSelectorById("svg"));var a=d3.select(e.target).datum();if(a){var i=o.getRowDatumByShapeUid(a.uid,this._oSourceChart.getId());if(i){i.y=this._oSourceChart._oAxisOrdinal.elementToView(i.uid);var r=e.pageX-t.offset().left||e.offsetX;var n=this._getTopShapeInstance(a,e.target.getAttribute("class").split(" ")[0]);var h,p;if(n){if(s.getConfiguration().getRTL()===true){h=n.getEndTime(a);p=n.getTime(a)}else{h=n.getTime(a);p=n.getEndTime(a)}}var g={shapeData:a,objectInfoRef:i};this._oResizingData={oShapeData:g,aOldTime:[h,p],resizeStartPointX:r,topShapeInstance:n};jQuery(document.body).off("mousemove.shapeResizing");jQuery(document.body).off("mouseup.shapeResizing");jQuery(document.body).on("mousemove.shapeResizing",this._handleShapeResizing.bind(this));jQuery(document.body).on("mouseup.shapeResizing",this._handleShapeResizeEnd.bind(this))}}};h.prototype.checkShapeResizable=function(e,t,a){if(e&&t&&a){jQuery(t).removeClass("sapUiShapeResizingCursor");var s=t.getAttribute("class")?t.getAttribute("class").split(" ")[0]:undefined;if(!s||s.indexOf("__")<0){return}if(this._oShapeManager.isShapeResizable(e,s)){var o,r,n;var h=this._getShapeInstance(e,s);if(h){var p=h.getTime(e);var g=h.getEndTime(e);r=this._oSourceChart.getAxisTime().timeToView(i.abapTimestampToDate(p));n=this._oSourceChart.getAxisTime().timeToView(i.abapTimestampToDate(g));o=Math.abs(n-a)<Math.abs(r-a)?Math.abs(n-a):Math.abs(r-a)}if(o<=this._DEFAULT_RESIZE_CURSOR_SHOWING_THRESHOLD&&!this._oSourceChart._bDragging){jQuery(t).addClass("sapUiShapeResizingCursor")}else{jQuery(t).removeClass("sapUiShapeResizingCursor")}}}};h.prototype._preventBubbleAndDefault=function(e){e.preventDefault();e.stopPropagation()};h.prototype._handleShapeResizing=function(t){if(!e.support.touch&&(t.button!==0||t.buttons===0||t.ctrlKey)){return false}var a=jQuery(this._oSourceChart.getDomSelectorById("svg"));var i=Math.abs((t.pageX-a.offset().left||t.offsetX)-this._oResizingData.resizeStartPointX);if(i>this._DEFAULT_MOUSE_MOVE_PIXEL){if(this._oResizingData!==undefined){this._updateResizingShapeData(t);this._bResizing=true;this._oSourceChart._oAutoScrollHandler.autoScroll(this._oSourceChart,t)}}};h.prototype._handleShapeResizingWhenAutoScroll=function(){if(this.getIsResizing()){this._updateResizingShapeData(this._oLastEvent)}};h.prototype._updateResizingShapeData=function(e){this._oLastEvent=e;var t=jQuery(this._oSourceChart.getDomSelectorById("svg"));var a=e.pageX-t.offset().left||e.offsetX;var i=this._calculateResizedNewTime(a);this._drawResizingShadow(i)};h.prototype._parseShapeTimeProperty=function(e,t){var a;if(e.mShapeConfig.hasShapeProperty(t)){var i=e.mShapeConfig.getShapeProperty(t);if(typeof i==="string"&&i.charAt(0)==="{"&&i.charAt(i.length-1)==="}"){a=i.substring(1,i.length-1)}}return a};h.prototype._drawResizingShadow=function(e){var t=d3.select(this._oSourceChart.getDomSelectorById("svg"));if(e){var a=jQuery.extend(true,{},this._oResizingData.oShapeData.shapeData);var i=this._oResizingData.topShapeInstance.getAggregation("resizeShadowShape");var o=this._parseShapeTimeProperty(i,this._TIMESTAMP_START_TIME_KEY);var r=this._parseShapeTimeProperty(i,this._TIMESTAMP_END_TIME_KEY);var n,h;if(s.getConfiguration().getRTL()===true){n=e[1];h=e[0]}else{n=e[0];h=e[1]}if(a[o]){a[o]=n}if(a[r]){a[r]=h}var p={objectInfoRef:this._oResizingData.oShapeData.objectInfoRef};p.shapeData=a;i.dataSet=[p];this._oShapeInRowDrawer.drawResizeShadow(t,i,this._oSourceChart.getAxisTime(),this._oSourceChart._oAxisOrdinal,this._oSourceChart._oStatusSet)}};h.prototype._calculateResizedNewTime=function(e){var t=[];var a,s;var o=this._oResizingData.aOldTime[0];var r=this._oResizingData.aOldTime[1];var n=this._oSourceChart.getAxisTime().timeToView(i.abapTimestampToDate(o));var h=this._oSourceChart.getAxisTime().timeToView(i.abapTimestampToDate(r));var p;if(this._oResizingData.isLeftSideClick!==undefined&&this._oResizingData.isLeftSideClick!==null){p=this._oResizingData.isLeftSideClick}else{p=Math.abs(this._oResizingData.resizeStartPointX-n)<Math.abs(this._oResizingData.resizeStartPointX-h)?true:false;this._oResizingData.isLeftSideClick=p}if(p){s=r;if(e>=h){a=r}else{a=i.dateToAbapTimestamp(this._oSourceChart.getAxisTime().viewToTime(e))}}else{a=o;if(e<=n){s=o}else{s=i.dateToAbapTimestamp(this._oSourceChart.getAxisTime().viewToTime(e))}}t=[a,s];return t};h.prototype._getShapeInstance=function(e,t){var a=this._oShapeManager.getShapeInstance(e,t);if(a){if(a.getId()===t){return a}else if(a.getShapes()){var i=a.getShapes();for(var s=0;s<i.length;s++){if(i[s].getId()===t){return i[s]}}}}else{var o=n.getElementById(t).getParent();if(o){return o}}return undefined};h.prototype._getTopShapeInstance=function(e,t){var a=this._oShapeManager.getShapeInstance(e,t);if(a){return a}else{var i=n.getElementById(t).getParent();if(i){return i}}return undefined};h.prototype._handleShapeResizeEnd=function(e){this._oSourceChart._oAutoScrollHandler.stop();var t=d3.selectAll(".resizingShadow");if(!t.empty()){t.remove()}if(this._bResizing&&this._oResizingData!==undefined){this._collectResizingShapeData(e);this._oSourceChart.fireShapeResizeEnd({shapeUid:this._oResizingData.oShapeData.shapeData.uid,rowObject:this._oResizingData.oShapeData.objectInfoRef,oldTime:this._oResizingData.aOldTime,newTime:this._oResizingData.aNewTime})}jQuery(document.body).off("mousemove.shapeResizing");jQuery(document.body).off("mouseup.shapeResizing");jQuery(e.target).removeClass("sapUiShapeResizingCursor");this._bResizing=false;this._oResizingData=undefined;this._oLastEvent=undefined};h.prototype._collectResizingShapeData=function(e){var t=jQuery(this._oSourceChart.getDomSelectorById("svg"));var a=e.pageX-t.offset().left||e.offsetX;var i=this._calculateResizedNewTime(a);var o,r;if(s.getConfiguration().getRTL()===true){o=i[1];r=i[0]}else{o=i[0];r=i[1]}this._oResizingData.aNewTime=[o,r]};return h},true);
//# sourceMappingURL=ShapeResizeHandler.js.map