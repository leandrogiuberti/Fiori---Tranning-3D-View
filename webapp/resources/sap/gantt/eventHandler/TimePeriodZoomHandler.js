/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/Object","sap/gantt/misc/Format","sap/gantt/config/TimeHorizon","sap/gantt/drawer/TimePeriodZoomRectangle","sap/ui/core/library","sap/gantt/misc/Utility"],function(jQuery,e,t,i,o,r,a){"use strict";var s=r.Orientation;var n=e.extend("sap.gantt.eventHandler.TimePeriodZoomHandler",{constructor:function(t){e.call(this);this._oSourceChart=t;this._oTimePeriodZoomRectangleDrawer=new o;this._bActive=false;this._bLocked=false;this._bMouseOnSvg=false;this._bEnableSetVisibleHorizon=false;this._sAutoScrollDirection=undefined;this._oLastEvent=undefined}});n.prototype.activate=function(e){this._bActive=true;var t=jQuery(this._oSourceChart.getDomSelectorById("svg"));t.css("cursor","crosshair");if(!e){this.fireActiveStatusChangeEvent(this._bActive)}};n.prototype.deactivate=function(e){this._bActive=false;var t=jQuery(this._oSourceChart.getDomSelectorById("svg"));t.css("cursor","auto");if(!e){this.fireActiveStatusChangeEvent(this._bActive)}};n.prototype.invertActiveStatus=function(){if(this._bActive){this.deactivate()}else{this.activate()}};n.prototype.fireActiveStatusChangeEvent=function(e){this._oSourceChart.fireEvent("_timePeriodZoomStatusChange",{isActive:e})};n.prototype.isTimePeriodZoomEnabled=function(){var e=this._oSourceChart.getAxisTimeStrategy();return e.isTimePeriodZoomEnabled()&&this._bMouseOnSvg};n.prototype.isActive=function(){return this._bActive};n.prototype.handleDragStart=function(e,t){var i=this._oSourceChart;this._bLocked=true;this._bEnableSetVisibleHorizon=true;this.oStartEvent=e;this.oStartTime=this._caculateEventTime(e);this.createRectangle(this.oStartTime);var o=jQuery(i.getDomSelectorById("svg"));o.off("mousemove.timePeriodZoomDragDrop");jQuery(document.body).off("mouseup.timePeriodZoomDragDrop");i.detachHorizontalScroll(this.handleAutoScroll,this);o.on("mousemove.timePeriodZoomDragDrop",this.handleDragging.bind(this));jQuery(document.body).on("mouseup.timePeriodZoomDragDrop",this.handleDragEnd.bind(this));i.attachHorizontalScroll(this.handleAutoScroll,this);if(!t){this._bMouseOnSvg=true;i.fireEvent("_timePeriodZoomOperation",{type:"dragStart",dragStartTime:this.oStartTime,originalEvent:e})}};n.prototype.createRectangle=function(e){var t=this._oSourceChart;var i=t.getAxisTime().timeToView(e);var o=d3.select(t.getDomSelectorById("svg"));this._oTimePeriodZoomRectangleDrawer.drawSvg(o,i)};n.prototype.handleDragging=function(e,t){var i=this._oSourceChart;this._oLastEvent=e;var o=this._caculateEventTime(e);this.updateRectangle(this.oStartTime,o);if(!t){var r=i._handleAutoScroll(e);if(r){this._sAutoScrollDirection=r}i.fireEvent("_timePeriodZoomOperation",{type:"dragging",dragStartTime:this.oStartTime,draggingTime:o,originalEvent:e})}};n.prototype.updateRectangle=function(e,t){var i=this._oSourceChart;var o=i.getAxisTime().timeToView(e);var r=i.getAxisTime().timeToView(t);var a=d3.select(i.getDomSelectorById("svg"));if(r>o){this._oTimePeriodZoomRectangleDrawer.updateSvg(a,o,r)}else{this._oTimePeriodZoomRectangleDrawer.updateSvg(a,r,o)}};n.prototype.handleDragEnd=function(e,t){var o=this._oSourceChart;o._oAutoScrollHandler.stop();this._bLocked=false;this.deactivate();this._sAutoScrollDirection=undefined;this.destoryRectangle();var r;if(this._bEnableSetVisibleHorizon){var a=o.getAxisTime().timeToView(this.oStartTime);var s=this._caculateXPosition(e);r=this._caculateEventTime(e);var n=r;var l=5;if(Math.abs(s-a)>l){var c=this.oStartTime;if(n.getTime()<c.getTime()){var m=c;c=n;n=m}var h=new i({startTime:c,endTime:n});o.syncVisibleHorizon(h)}}var g=jQuery(o.getDomSelectorById("svg"));g.off("mousemove.timePeriodZoomDragDrop");jQuery(document.body).off("mouseup.timePeriodZoomDragDrop");o.detachHorizontalScroll(this.handleAutoScroll,this);if(!t){var d=o.getVisibleWidth();o.fireEvent("_timePeriodZoomOperation",{type:"dragEnd",dragStartTime:this.oStartTime,dragEndTime:r,visibleWidth:d,originalEvent:e});this.fireActiveStatusChangeEvent(this._bActive)}};n.prototype.destoryRectangle=function(){var e=this._oSourceChart;var t=d3.select(e.getDomSelectorById("svg"));this._oTimePeriodZoomRectangleDrawer.destroySvg(t)};n.prototype.handleAutoScroll=function(e){if(this._bMouseOnSvg){var i=this._oSourceChart;var o=e.getParameters();var r;if(this._sAutoScrollDirection==="scrollLeft"){var a=t.abapTimestampToDate(o.startTime);r=a.getTime()-this.oStartTime.getTime()}else if(this._sAutoScrollDirection==="scrollRight"){var s=t.abapTimestampToDate(o.endTime);r=s.getTime()-this.oStartTime.getTime()}i.fireEvent("_timePeriodZoomOperation",{type:"autoScroll",timeBias:r,originalEvent:e})}};n.prototype.attachEvents=function(){var e=jQuery(this._oSourceChart.getDomSelectorById("svg"));e.on("mouseenter.timePeriodZoomDragDrop",this.handleMouseEnter.bind(this));e.on("mouseleave.timePeriodZoomDragDrop",this.handleMouseLeave.bind(this))};n.prototype.detachEvents=function(){var e=jQuery(this._oSourceChart.getDomSelectorById("svg"));e.off("mouseenter.timePeriodZoomDragDrop");e.off("mouseleave.timePeriodZoomDragDrop")};n.prototype.handleMouseEnter=function(e){this._bMouseOnSvg=true;this._bLocked=true;this.setEnableSetVisibleHorizon(true)};n.prototype.handleMouseLeave=function(e){this._bMouseOnSvg=false;this._oSourceChart._oAutoScrollHandler.stop();this._bLocked=false;this.setEnableSetVisibleHorizon(false)};n.prototype.handleAutoScrolling=function(e){if(e.getParameter("direction")==="scrollLeft"||e.getParameter("direction")==="scrollRight"){var t=this._oSourceChart;var i=this._caculateEventTime(this._oLastEvent);this.updateRectangle(this.oStartTime,i);t.fireEvent("_timePeriodZoomOperation",{type:"dragging",dragStartTime:this.oStartTime,draggingTime:i,originalEvent:this._oLastEvent})}};n.prototype.setEnableSetVisibleHorizon=function(e,t){this._bEnableSetVisibleHorizon=e;if(!t){var i=this._oSourceChart;i.fireEvent("_timePeriodZoomOperation",{type:"enableSetVisibleHorizon",enable:e})}};n.prototype.calculateTargetVisibleHorizonByTimeBias=function(e){var o;var r;if(e!==undefined){var a=this._oSourceChart;var s=a.getAxisTimeStrategy().getTotalHorizon();r=new Date;r.setTime(this.oStartTime.getTime()+e);if(e<0){var n=t.abapTimestampToDate(s.getStartTime());if(r.getTime()<n.getTime()){r=n;this.oStartTime.setTime(r.getTime()-e)}o=new i({startTime:r})}else{var l=t.abapTimestampToDate(s.getEndTime());if(r.getTime()>l.getTime()){r=l;this.oStartTime.setTime(r.getTime()-e)}o=new i({startTime:undefined,endTime:r})}}return o};n.prototype.calculateTargetVisibleHorizon=function(e,i){var o;if(e.dragEndTime){var r=this._oSourceChart;var s=r.getAxisTimeStrategy();var n=s.getVisibleHorizon();var l=r.getVisibleWidth();var c=e.dragStartTime.getTime();var m=e.dragEndTime.getTime();var h;if(i){h=c<m?e.dragStartTime:e.dragEndTime}else{h=t.abapTimestampToDate(s.getVisibleHorizon().getStartTime())}o=a.calculateHorizonByWidth(n,e.visibleWidth,l,h)}return o};n.prototype.syncTimePeriodZoomOperation=function(e,t,i){var o=this._oSourceChart;var r=e.getParameters();var a;if(i===s.Vertical){if(r.type==="dragStart"){this.handleDragStart(r.originalEvent,true)}else if(r.type==="dragging"){this.handleDragging(r.originalEvent,true)}else if(r.type==="dragEnd"){this.handleDragEnd(r.originalEvent,true)}else if(r.type==="enableSetVisibleHorizon"){this.setEnableSetVisibleHorizon(r.enable,true)}else if(r.type==="autoScroll"){if(!t){a=this.calculateTargetVisibleHorizonByTimeBias(r.timeBias);if(a){o.syncVisibleHorizon(a)}}}}else if(i===s.Horizontal){if(r.type==="dragStart"&&t){this.createRectangle(r.dragStartTime)}else if(r.type==="dragging"&&t){this.updateRectangle(r.dragStartTime,r.draggingTime)}else if(r.type==="dragEnd"){if(t){this.destoryRectangle()}a=this.calculateTargetVisibleHorizon(r,t);if(a){o.syncVisibleHorizon(a)}}}};n.prototype._caculateXPosition=function(e){var t=this._oSourceChart;var i=t._getMouseXPos(e);var o=jQuery(t.getDomSelectorById("svg"));var r=i;if(o.offset()){r=i-o.offset().left||e.offsetX}return r};n.prototype._caculateEventTime=function(e){var t=this._oSourceChart;var i=this._caculateXPosition(e);return t.getAxisTime().viewToTime(i)};return n},true);
//# sourceMappingURL=TimePeriodZoomHandler.js.map