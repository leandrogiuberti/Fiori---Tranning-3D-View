/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.ca.ui.CustomerContext");jQuery.sap.require("sap.ca.ui.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.ca.ui.CustomerContext",{metadata:{deprecated:true,library:"sap.ca.ui",properties:{personalizationPageName:{type:"string",group:"Misc",defaultValue:"AppCustomerContext"},showSalesArea:{type:"boolean",group:"Misc",defaultValue:false},path:{type:"string",group:"Misc",defaultValue:"/Customers"},customerIDProperty:{type:"string",group:"Misc",defaultValue:"CustomerID"},customerNameProperty:{type:"string",group:"Misc",defaultValue:"CustomerName"},salesOrganizationNameProperty:{type:"string",group:"Misc",defaultValue:"SalesOrganizationName"},distributionChannelNameProperty:{type:"string",group:"Misc",defaultValue:"DistributionChannelName"},divisionNameProperty:{type:"string",group:"Misc",defaultValue:"DivisionName"},dialogTitle:{type:"string",group:"Misc",defaultValue:null}},events:{customerSelected:{}}}});jQuery.sap.require("sap.m.Dialog");jQuery.sap.require("sap.m.List");jQuery.sap.require("sap.ca.ui.utils.resourcebundle");jQuery.sap.require("sap.ca.ui.CustomerControlListItem");sap.ca.ui.CustomerContext.MODE={Select:"Select",Change:"Change"};sap.ca.ui.CustomerContext.prototype.init=function(){this._oldValue="";this._oPersService=null;this._bDialogTitleOverriden=false;this._oDialog=new sap.m.Dialog(this.getId()+"-ccDialog",{type:sap.m.DialogType.Standard,contentWidth:"25%",contentHeight:"446px",enableScrolling:false}).addStyleClass("sapCaUiCCD");if(jQuery.device.is.phone){this._oDialog.setStretchOnPhone(true)}this._oButtonOk=new sap.m.Button({text:sap.ca.ui.utils.resourcebundle.getText("CustomerContext.Ok"),press:jQuery.proxy(function(){if(this._oList.getSelectedItem()){var e=this._oList.getSelectedItem().getBindingContext().getProperty();if(this._oPersService){try{var t=this._oPersService.setPersData(JSON.stringify(e));t.done(function(){jQuery.sap.log.info("CustomerContext: Customer '"+JSON.stringify(e)+"' successfully saved")});t.fail(function(e){jQuery.sap.log.error("CustomerContext: Error while saving customer info : "+e.message)})}catch(e){jQuery.sap.log.error("CustomerContext: wasn't able to saved SelectedCustomer on personalization service "+e.message)}}else{jQuery.sap.log.warning("CustomerContext: there is no service defined for saving the SelectedCustomer, did you set the personalizationPageName property? ")}this.fireCustomerSelected(e)}this._oDialog.close()},this)});this._oDialog.setLeftButton(this._oButtonOk);this._oButtonCancel=new sap.m.Button({text:sap.ca.ui.utils.resourcebundle.getText("CustomerContext.Cancel"),press:jQuery.proxy(this._onCancel,this)});this._oDialog.setRightButton(this._oButtonCancel);var e=new sap.m.Page({showHeader:false,contentHeight:"350em",enableScrolling:true});var t=new sap.m.SearchField({placeholder:sap.ca.ui.utils.resourcebundle.getText("CustomerContext.Search"),width:"100%",layoutData:new sap.m.FlexItemData({growFactor:1}),liveChange:jQuery.proxy(this._onLiveSearch,this)});var s=new sap.m.Bar(this._oDialog.getId()+"-searchField",{contentMiddle:[t]});e.setSubHeader(s);this._oList=new sap.m.List({mode:sap.m.ListMode.SingleSelectMaster,noDataText:sap.ca.ui.utils.resourcebundle.getText("CustomerContext.NoData")});this._bindListItems(this.getPath());e.addContent(this._oList);this._oDialog.addContent(e);this._oDialog.attachAfterOpen(jQuery.proxy(function(){if(!this._oList.getSelectedItem()&&this._oList.getItems().length>0){this._oList.setSelectedItem(this._oList.getItems()[0],true)}},this));this._oDialog.setInitialFocus(this._oButtonCancel)};sap.ca.ui.CustomerContext.prototype.setDialogTitle=function(e,t){this._bDialogTitleOverriden=true;this.setProperty("dialogTitle",e,t)};sap.ca.ui.CustomerContext.prototype.setPersonalizationPageName=function(e){try{var t=sap.ushell.Container.getService("Personalization");this._oPersService=t.getPersonalizer({container:e,item:"SelectedCustomerContext"})}catch(e){jQuery.sap.log.error("CustomerContext: error while loading personalization service: "+e.message)}this.setProperty("personalizationPageName",e,false)};sap.ca.ui.CustomerContext.prototype.setShowSalesArea=function(e){var t=this.getShowSalesArea();if(t!==!!e){this.setProperty("showSalesArea",e,false)}};sap.ca.ui.CustomerContext.prototype.setPath=function(e){this._bindListItems(e);this.setProperty("path",e)};sap.ca.ui.CustomerContext.prototype.setModel=function(e){if(e instanceof sap.ui.model.odata.ODataModel){e=this._prepareODataForLiveSearch(e)}else if(e instanceof sap.ui.model.json.JSONModel){e=this._prepareJSONForLiveSearch(e)}this._oList.setModel(e);this._bindListItems(this.getPath());return this};sap.ca.ui.CustomerContext.prototype.select=function(){if(!this._oDialog.isOpen()){if(this._oPersService){try{var e=this._oPersService.getPersData();e.done(jQuery.proxy(function(e){if(e!==null&&e!==""){var t=JSON.parse(e);var s=this._oList;var i=this.getCustomerIDProperty();if(this._oList&&this._oList.getItems()&&this._oList.getItems().length>0){jQuery.each(this._oList.getItems(),function(e,o){var r=o.getBindingContext();if(r.getModel().getProperty(r.getPath())[i]==t[i]){s.setSelectedItem(o,true)}})}this.fireCustomerSelected(t)}else{if(this._oList.getItems().length==1){this._oList.setSelectedItem(this._oList.getItems()[0],true);this._oButtonOk.firePress()}else{this._mode=sap.ca.ui.CustomerContext.MODE.Select;if(this._bDialogTitleOverriden){this._oDialog.setTitle(this.getDialogTitle())}else{this._oDialog.setTitle(sap.ca.ui.utils.resourcebundle.getText("CustomerContext.TitleSelect"))}this._oDialog.open()}}},this));e.fail(jQuery.proxy(function(e){jQuery.sap.log.error("CustomerContext: error while using personalization service: "+e.message);this.fireCustomerSelected(null)},this))}catch(e){jQuery.sap.log.error("CustomerContext: error while loading personalization service: "+e.message);this.fireCustomerSelected(null)}}else{jQuery.sap.log.warning("CustomerContext: there is no service defined for saving the SelectedCustomer, did you set the personalizationPageName property? ")}}};sap.ca.ui.CustomerContext.prototype.change=function(){if(!this._oDialog.isOpen()){this._mode=sap.ca.ui.CustomerContext.MODE.Change;if(this._bDialogTitleOverriden){this._oDialog.setTitle(this.getDialogTitle())}else{this._oDialog.setTitle(sap.ca.ui.utils.resourcebundle.getText("CustomerContext.TitleChange"))}this._oDialog.open()}};sap.ca.ui.CustomerContext.prototype.reset=function(){if(this._oPersService){try{var e=this._oPersService.setPersData("");e.done(function(){jQuery.sap.log.info("CustomerContext: Customer successfully reset")});e.fail(function(e){jQuery.sap.log.error("CustomerContext: Error while resetting customer context: "+e.message)})}catch(e){jQuery.sap.log.error("CustomerContext: wasn't able to reset SelectedCustomer on personalization service "+e.message)}}else{jQuery.sap.log.error("CustomerContext: there is no service defined for resetting the SelectedCustomer, did you set the personalizationPageName property? ")}};sap.ca.ui.CustomerContext.prototype._getItemTemplate=function(){var e=new sap.ca.ui.CustomerControlListItem({showSalesArea:this.getShowSalesArea(),customerID:{path:this.getCustomerIDProperty()},customerName:{path:this.getCustomerNameProperty()},salesOrganizationName:{path:this.getSalesOrganizationNameProperty()},distributionChannelName:{path:this.getDistributionChannelNameProperty()},divisionName:{path:this.getDivisionNameProperty()}});return e};sap.ca.ui.CustomerContext.prototype._onCancel=function(){if(this._mode==sap.ca.ui.CustomerContext.MODE.Select){this.fireCustomerSelected(null)}this._oDialog.close()};sap.ca.ui.CustomerContext.prototype._prepareJSONForLiveSearch=function(e){var t=this.getPath();if(t.length>1&&t[0]=="/"){t=t.substring(1)}var s=e.getData()[t];for(var i=0;i<s.length;i++){this._enrichModel(s[i])}var o={};o[t]=s;e.setData(o);return e};sap.ca.ui.CustomerContext.prototype._enrichModel=function(e){e["_searchString"]="";if(e[this.getCustomerNameProperty()]){e["_searchString"]+=e[this.getCustomerNameProperty()]}if(e[this.getCustomerIDProperty()]){e["_searchString"]+=e[this.getCustomerIDProperty()]}if(this.getShowSalesArea()){if(e[this.getSalesOrganizationNameProperty()]){e["_searchString"]+=e[this.getSalesOrganizationNameProperty()]}if(e[this.getDistributionChannelNameProperty()]){e["_searchString"]+=e[this.getDistributionChannelNameProperty()]}if(e[this.getDivisionNameProperty()]){e["_searchString"]+=e[this.getDivisionNameProperty()]}}return e};sap.ca.ui.CustomerContext.prototype._prepareODataForLiveSearch=function(e){var t=new sap.ui.model.json.JSONModel;var s=[];var i={};var o=this.getPath();if(o.length>1&&o[0]=="/"){o=o.substring(1)}e.read(this.getPath(),null,[],false,jQuery.proxy(function(r){for(var a in r.results){e.oData[o+"('"+r.results[a][this.getCustomerIDProperty()]+"')"]=r.results[a];s.push(this._enrichModel(r.results[a]))}i[o]=s;t.setData(i)},this),function(){});return t};sap.ca.ui.CustomerContext.prototype._onLiveSearch=function(e){var t=e.getParameter("newValue");var s=[];if(t!=""){s.push(new sap.ui.model.Filter("_searchString",sap.ui.model.FilterOperator.Contains,t));this._oList.getBinding("items").filter(s)}else if(this._oldValue!=""){this._oList.getBinding("items").filter([])}this._oldValue=t};sap.ca.ui.CustomerContext.prototype.exit=function(){if(this._oButtonOk){this._oButtonOk.destroy();this._oButtonOk=null}if(this._oButtonCancel){this._oButtonCancel.destroy();this._oButtonCancel=null}if(this._oDialog){this._oDialog.destroy();this._oDialog=null}};sap.ca.ui.CustomerContext.prototype._bindListItems=function(e){this._oList.bindItems({path:e,template:this._getItemTemplate()})};
//# sourceMappingURL=CustomerContext.js.map