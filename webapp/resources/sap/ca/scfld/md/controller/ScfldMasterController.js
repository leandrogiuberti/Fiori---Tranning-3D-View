/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ui.core.mvc.Controller");jQuery.sap.require("sap.ca.scfld.md.app.CommonHeaderFooterHelper");sap.ui.core.mvc.Controller.extend("sap.ca.scfld.md.controller.ScfldMasterController",{_clearSelection:function(){var t=this.getList(),e=this._oApplicationImplementation.oConfiguration.keepMultiSelection();if(t&&(t.getMode()!==sap.m.ListMode.MultiSelect||!e)){t.removeSelections(true)}},_onMasterListChanged:function(t){this._oApplicationImplementation.onMasterChanged(this);this.selectItemMatchingTheLastNavigation();var e=this.getList();if(e&&e.getMode()==="MultiSelect"&&this._oApplicationImplementation.bManualMasterRefresh===true){e.removeSelections(true)}if(e&&e.hasStyleClass("hiddenList")&&e.getBinding("items").getLength()>0){this.getList().removeStyleClass("hiddenList");this._emptyList.addStyleClass("hiddenList")}},_handleItemPress:function(t){this.setListItem(t.getSource())},_handleSelect:function(t){this.setListItem(t.getParameter("listItem"));if(!sap.ui.Device.system.phone){this._oApplicationImplementation.oSplitContainer.hideMaster()}},_onMasterListLoaded:function(t){this.onDataLoaded();this._oApplicationImplementation.onMasterRefreshed(this);t.oSource.detachChange(this._onMasterListLoaded,this);this._bListLoaded=true;this.fireEvent("_onMasterListLoaded")},constructor:function(){sap.ui.core.mvc.Controller.apply(this,arguments);this._bListLoaded=false;var t=0;var e=null;var i=jQuery.proxy(function(){this.oRouter=sap.ui.core.UIComponent.getRouterFor(this);this._oApplicationImplementation=sap.ca.scfld.md.app.Application.getImpl();this.oApplicationFacade=this._oApplicationImplementation.oConfiguration.oApplicationFacade;e=this._oApplicationImplementation.getConnectionManager();t=e.iRequestCount;this.oRouter.attachRoutePatternMatched(function(t){this._sDetailContextPath=undefined;if(this.isDetailRoute(t)){this._onDetailMatched(t)}if(this.isMasterRoute(t)){this._onMasterMatched(t)}},this);this._iRequestCount=0;var i=e.getModel(this.sModelName);if(!i){jQuery.sap.log.error("ScfldMasterController","Initialization stopped, as no model is available");return}i.attachRequestSent(null,function(){this._iRequestCount++},this);i.attachRequestCompleted(null,function(){this._iRequestCount--;if(this._iRequestCount<0){this._iRequestCount=0}if(this._iRequestCount===0){this.fireEvent("_allListModelUpdatesCompleted")}},this);this._oApplicationImplementation.setModels(this);this._emptyList=new sap.m.List;this._emptyList.addStyleClass("hiddenList");this.getPage().addContent(this._emptyList);var n=jQuery.proxy(function(){if(this._emptyList){var t=this.getPage();if(t){t.removeContent(this._emptyList)}this._emptyList.destroy();if(this._oControlStore&&this._oControlStore.oMasterSearchField){this._oControlStore.oMasterSearchField.destroy();delete this._oControlStore.oMasterSearchField}}},this);this._oApplicationImplementation.registerExitModule(n)},this);var n=jQuery.proxy(this.onInit,this);this.onInit=jQuery.proxy(function(){i();n();var s=this.getList();if(s){var o=s.getBinding("items");this._oApplicationImplementation.setMasterListBinding(this,o)}if(t==e.iRequestCount){var a=!!e.sErrorInStartMessage;this._oApplicationImplementation.oMHFHelper.defineMasterHeaderFooter(this,a);if(a){this._bListLoaded=true;if(this._oApplicationImplementation.bIsPhone){var s=this.getList();if(s){s.setNoDataText(e.sErrorInStartMessage)}}else{this.showEmptyView(this._oApplicationImplementation.oConfiguration.getDetailTitleKey(),undefined,e.sErrorInStartMessage)}}}},this)},onInit:function(){},getPage:function(){return sap.ca.scfld.md.app.CommonHeaderFooterHelper.getPageFromController(this)},getList:function(){return this.byId("list")},setListItem:function(t){this._clearSelection();t.setSelected(true);this._navToListItem(t)},isDetailRoute:function(t){var e=t.getParameter("name");return e===this.getDetailRouteName()},getDetailRouteName:function(){return"detail"},isMasterRoute:function(t){var e=t.getParameter("name");return e===this.getMasterRouteName()},getMasterRouteName:function(){return"master"},_onMasterMatched:function(t){if(sap.ui.Device.system.phone){return}if(!this._bListLoaded){this.attachEventOnce("_onMasterListLoaded",function(){this.selectFirstItem()},this)}else{this.selectFirstItem()}},_onDetailMatched:function(t){var e=this._sDetailContextPath=this.getBindingContextPathFor(t.getParameter("arguments"));if(this._iRequestCount>0){this.attachEventOnce("_allListModelUpdatesCompleted",function(){this._handleDetailMatched(e)},this);return}if(!this._bListLoaded){this.attachEventOnce("_onMasterListLoaded",function(){this._handleDetailMatched(e)},this)}else{this._handleDetailMatched(e)}},_handleDetailMatched:function(t){if(t===undefined){return}var e=this.findItemByContextPath(t);if(!e){if(!sap.ui.Device.system.phone&&this.isBackendSearch()){this.applyFilterFromContext(t);return}this.noItemFoundForContext(t);return}if(!sap.ui.Device.system.phone&&e){this._clearSelection();e.setSelected(true)}},selectItemMatchingTheLastNavigation:function(){var t=this.getList();if(t.getMode()==="MultiSelect"){return}if(this._sDetailContextPath===undefined){return}var e=t.getSelectedItem();var i=e&&e.getBindingContext(this.sModelName);if(i&&i.getPath()===this._sDetailContextPath){return}e=this.findItemByContextPath(this._sDetailContextPath);this._clearSelection();if(e){e.setSelected(true)}},noItemFoundForContext:function(t){if(this._oApplicationImplementation.bIsPhone){var e=this.getSplitContainer();e.to(this.getView(),"show")}else{this.showEmptyView(null,null,this._oApplicationImplementation.oConnectionManager.sErrorInStartMessage)}},findItemByContextPath:function(t){var e;var i=this.getList();var n=i.getItems();var s=jQuery.grep(n,function(i){e=i.getBindingContext(this.sModelName);if(i instanceof sap.m.GroupHeaderListItem){return false}if(e&&e.getPath()!==t){return false}return true});return s[0]||null},getBindingContextPathFor:function(t){if(t.contextPath===undefined){jQuery.sap.log.warning("The context path was undefined. If you are using a route without it please overwrite the function getBindingContextPathFor in your master controller.");return undefined}return"/"+t.contextPath},selectFirstItem:function(){var t=this.getList();var e=t.getItems();var i;if(e.length<1){return}i=this._oApplicationImplementation.getFirstListItem(this);if(i){this.setListItem(i)}},_navToListItem:function(t){this.oRouter.navTo(this.getDetailRouteName(),this.getDetailNavigationParameters(t),!sap.ui.Device.system.phone)},getDetailNavigationParameters:function(t){return{contextPath:t.getBindingContext(this.sModelName).getPath().substr(1)}},getHeaderFooterOptions:function(){return null},setBtnEnabled:function(t,e){if(this._oControlStore.oButtonListHelper){this._oControlStore.oButtonListHelper.setBtnEnabled(t,e)}},setBtnText:function(t,e){if(this._oControlStore.oButtonListHelper){this._oControlStore.oButtonListHelper.setBtnText(t,e)}},refreshHeaderFooterForEditToggle:function(){this._oApplicationImplementation.oMHFHelper.defineMasterHeaderFooterInner(this)},onDataLoaded:function(){},showEmptyView:function(t,e,i){this._clearSelection();var n=this.oRouter.getView(this.getNoDataViewName(),sap.ui.core.mvc.ViewType.XML);var s=this.getSplitContainer();s.addDetailPage(n);if(!t){t=this._oApplicationImplementation.oConfiguration.getDetailTitleKey()}if(!i){if(!e){e=this._oApplicationImplementation.oConfiguration.getDefaultEmptyMessageKey()}}var o=n.getController();if(o.setTitleAndMessage){o.setTitleAndMessage(t,e,i);var a={}}else{var a={viewTitle:t,languageKey:e,infoText:i}}n.getController().setTitleAndMessage(t,e,i);s.to(n.getId(),"show",a);return this},getSplitContainer:function(){return this._oApplicationImplementation.oSplitContainer},getNoDataViewName:function(){return"sap.ca.scfld.md.view.empty"},navToEmptyView:function(){this.showEmptyView()},applySearchPattern:function(t){t=t.toLowerCase();var e=this.getList().getItems();var i;var n=0;var s=null;var o=0;for(var a=0;a<e.length;a++){if(e[a]instanceof sap.m.GroupHeaderListItem){if(s){if(o==0){s.setVisible(false)}else{s.setVisible(true);s.setCount(o)}}s=e[a];o=0}else{i=this.applySearchPatternToListItem(e[a],t);e[a].setVisible(i);if(i){n++;o++}}}if(s){if(o==0){s.setVisible(false)}else{s.setVisible(true);s.setCount(o)}}if(!t){if(this._oMasterListBinding){n=this._oMasterListBinding.getLength()}}return n},applyBackendSearchPattern:function(t,e){},applyFilterFromContext:function(t){this.showEmptyView()},applySearchPatternToListItem:function(t,e){if(e==""){return true}var i=t.getBindingContext(this.sModelName).getProperty();for(var n in i){var s=i[n];if(typeof s=="string"){if(s.toLowerCase().indexOf(e)!=-1){return true}}}if(t.getIntro()&&t.getIntro().toLowerCase().indexOf(e)!=-1||t.getTitle()&&t.getTitle().toLowerCase().indexOf(e)!=-1||t.getNumber()&&t.getNumber().toLowerCase().indexOf(e)!=-1||t.getNumberUnit()&&t.getNumberUnit().toLowerCase().indexOf(e)!=-1||t.getFirstStatus()&&t.getFirstStatus().getText().toLowerCase().indexOf(e)!=-1||t.getSecondStatus()&&t.getSecondStatus().getText().toLowerCase().indexOf(e)!=-1){return true}var o=t.getAttributes();for(var a=0;a<o.length;a++){if(o[a].getText().toLowerCase().indexOf(e)!=-1){return true}}return false},_applyClientSideSearch:function(){var t=this._oControlStore.oMasterSearchField.getValue();var e=this.applySearchPattern(t);this._oApplicationImplementation.oMHFHelper.setMasterTitle(this,e);this.evaluateClientSearchResult(e,this.getList(),this._emptyList)},evaluateClientSearchResult:function(t,e,i,n){var s=n;if(t===0){if(s===null||s===undefined){s=e.getNoDataText()}i.setNoDataText(s);if(!e.hasStyleClass("hiddenList")){e.addStyleClass("hiddenList")}i.removeStyleClass("hiddenList")}else{e.removeStyleClass("hiddenList");if(!i.hasStyleClass("hiddenList")){i.addStyleClass("hiddenList")}}},isLiveSearch:function(){return!this.isBackendSearch()},isBackendSearch:function(){return false},registerMasterListBind:function(){var t=this.getList();var e=t.getBinding("items");var i=this._oApplicationImplementation.getConnectionManager();var n=i.iRequestCount;this._oApplicationImplementation.setMasterListBinding(this,e);if(n==i.iRequestCount){this._oApplicationImplementation.oMHFHelper.defineMasterHeaderFooter(this)}},registerMasterListBinding:function(t){this.sModelName=t;this.registerMasterListBind()}});
//# sourceMappingURL=ScfldMasterController.js.map