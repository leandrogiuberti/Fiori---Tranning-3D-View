/*
 * Copyright (C) 2009-2016 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.declare("sap.ca.scfld.md.app.ButtonListHelper");jQuery.sap.require("sap.ca.ui.dialog.Dialog");jQuery.sap.require("sap.ca.scfld.md.app.BarOverflow");jQuery.sap.require("sap.ca.scfld.md.app.BarOverflowLayoutData");jQuery.sap.require("sap.m.ButtonType");(function(){var t=jQuery.sap.log.isLoggable(jQuery.sap.log.Level.DEBUG),e="sap.ca.scfld.md.app.ButtonListHelper";function o(t,e){var o,i;for(o=t.length-1;o>=0;o-=1){i=t[o];if(i.oButton===e||i.oSelect===e){return i}}return null}function i(t,e){var o,i,s,n=e.id,l,r,a;for(i=0,s=t.length;i<s;i++){o=t[i];if(n===o.getId()){return o}if(e.icon===o.getIcon()){l=o.getMetadata().getName()==="sap.m.Button";a=o.getTooltip()||o._sTooltip||(l?o.getText():undefined);r=l?o.getText()||o._sTextInActionSheet:e.text;if(e.tooltip===a&&e.text===r){return o}}}}function s(t,e,o){var i,s,n,l;for(s=0,l=e.length;s<l;s++){i=e[s];if(i.getId()===t){n=i.getMetadata().getName()==="sap.m.Button";return{area:o,pos:s,controlInfo:{icon:i.getIcon(),id:i.getId(),text:(n?i.getText():"")||i._sTextInActionSheet,tooltip:i.getTooltip()||i._sTooltip||(n?i.getText():"")}}}}}function n(t){var e,o,i;for(e=t.length-1;e>=0;e-=1){o=t[e];i=o.getLayoutData();if(i instanceof sap.ca.scfld.md.app.BarOverflowLayoutData&&i.getOverflowButton()){return e}}}function l(t,e){var o=e,i=t.length,s;while(o<i){s=t[o];if(s.getVisible()){return s}o++}o=e-1;while(o>=0){s=t[o];if(s.getVisible()){return s}o--}return undefined}function r(t,e){var o;if(t.sI18nBtnTxt){var i=e.AppI18nModel.getResourceBundle();o=i.getText(t.sI18nBtnTxt)}else{o=t.sBtnTxt}return o}function a(t){var e=this.oBar,i=false,s=this.oOverflowList.oActionSheet,l,r,a,f,h;if(t===undefined){l=s.getButtons();f=n(this.oBar.getContentRight());for(r=0;r<l.length;r+=1){a=o(this.aButtons,l[r]);if(a.oSelect){h=a.oSelect;h.setVisible(true);if(a.oButton){a.oButton.setVisible(false)}s.removeButton(l[r])}else{h=a.oButton;if(h._sTextInBar!==undefined){h.setText(h._sTextInBar)}if(h._sTypeInBar!==undefined){h.setType(h._sTypeInBar)}if(h._sTooltip!==undefined){h.setTooltip(h._sTooltip)}}e.insertContentRight(h,f);f++}e.getContentRight()[f].setVisible(false);if(s.isOpen()){s.attachEventOnce("afterClose",function(){s.$().remove()})}else{s.$().remove()}}else{t.forEach(function(t){a=o(this.aButtons,t);if(!a){jQuery.sap.log.error("Unsupported control - "+t.toString())}if(a.oSelect){e.removeContentRight(a.oSelect)}if(a.oButton){t=a.oButton;if(t._sTextInActionSheet!==undefined){t.setText(t._sTextInActionSheet);if(t._sTextInActionSheet===t._sTooltip){t.setTooltip("")}}if(t._sTypeInActionSheet!==undefined){t.setType(t._sTypeInActionSheet)}t.setVisible(true);if(a.oSelect){a.oSelect.setVisible(false)}s.addButton(t);i=true}else{jQuery.sap.log.error("No button representation for control - "+t.toString())}},this);if(i){e.getContentRight()[n(this.oBar.getContentRight())].setVisible(true)}}}sap.ui.base.Object.extend("sap.ca.scfld.md.app.ButtonListHelper",{constructor:function(t,e,o,i,s){this.oApplicationImplementation=t;this.bAutomaticOverflow=i;this.sOverflowId=s;this.oOverflowButton=undefined;this.iMode=e;if(this.iMode==20){this.oBar=new sap.m.Bar}else if(this.iMode>=10){this.oActionSheet=new sap.m.ActionSheet;this.oActionSheet.setPlacement(sap.m.PlacementType.Top);this.oActionSheet.setShowCancelButton(true)}this.aButtons=[];this.bAllDisabled=o;this.startBuild();if(this.iMode==25){this.sDirection="Left"}else{this.sDirection="Right"}this.mSelections={}},addButtonListHelper:function(t){if(this.oChild){this.oChild.addButtonListHelper(t)}else{this.oChild=t;t.bAllDisabled=this.bAllDisabled;delete t.oModifications}},findFocusedElement:function(t){var e,o;if(!t){return undefined}if(t.area==="left"){e=this.oBar&&this.oBar.getContentLeft()||[];o=i(e,t.controlInfo)}else if(t.area==="right"){e=this.oBar&&this.oBar.getContentRight()||[];o=i(e,t.controlInfo)}else if(t.area==="overflow"){e=this.oBar&&this.oBar.getContentRight()||[];o=i(e,t.controlInfo);if(!o&&this.oOverflowList&&this.oOverflowList.oActionSheet){o=i(this.oOverflowList.oActionSheet.getButtons()||[],t.controlInfo)}}if(o){return o}if(e.length>0){o=l(e,Math.min(t.pos,e.length-1));if(o){return o}}if(t.area==="left"){e=this.oBar&&this.oBar.getContentRight()||[];return l(e,0)}else{e=this.oBar&&this.oBar.getContentLeft()||[];return l(e,Math.max(0,e.length-1))}},getFocusInfo:function(t){var e=this.oBar,o=sap.ui.getCore().getCurrentFocusedControlId(),i;if(this._focusInfo){i=this._focusInfo;this._focusInfo=undefined;return i}if(!o){return undefined}if(this.oOverflowList){i=this.oOverflowList.getFocusInfo();if(i){i.area="overflow";return i}}return e&&s(o,e.getContentLeft()||[],"left")||e&&s(o,e.getContentRight()||[],"right")||t&&s(o,t.getButtons()||[],"share")||this.oActionSheet&&s(o,this.oActionSheet.getButtons()||[],"action")||this.oClient&&this.oClient.getFocusInfo()},startBuild:function(t){this.mButtons={};this.aCallBacks=[];this.oPositions={iActive:0,iControlPosition:0};this.bHasOverflow=false;if(this.oChild){this.oChild.startBuild(true)}if(this.oOverflowList){this.oOverflowList.startBuild(true)}if(!t){this.oModifications={mChangedEnablements:{},mChangedTexts:{}}}this.aButtons=[];if(this.oActionSheet){this.oActionSheet.destroyButtons()}if(this.oBar){this.oBar.destroyContentRight();this.oBar.destroyContentLeft()}if(this.oBarOverflow){this.oBarOverflow.destroy();delete this.oBarOverflow}if(this.oOverflowList){this.oOverflowList.destroy();delete this.oOverflowList}},endBuild:function(){var t;for(var e=this.oPositions.iActive;e<this.aButtons.length;e++){var o=this.aButtons[e];if(o.oButton){o.oButton.setVisible(false)}if(o.oSelect){o.oSelect.setVisible(false)}}if(this.oChild){this.oChild.endBuild()}if(this.oOverflowList){this.oOverflowList.endBuild()}this.bIsOverflowReplaced=false;if(this.oModifications){for(t in this.oModifications.mChangedEnablements){this.setBtnEnabled(t,this.oModifications.mChangedEnablements[t],true)}for(t in this.oModifications.mChangedTexts){this.setBtnText(t,this.oModifications.mChangedTexts[t],true)}}if(this.oBarOverflow){this.oBarOverflow.buttonTextChanged()}},destroy:function(){for(var t=0;t<this.aButtons.length;t++){var e=this.aButtons[t];if(e.oButton){e.oButton.destroy(true)}if(e.oSelect){e.oSelect.destroy(true)}}if(this.oBar){this.oBar.destroy();delete this.oBar}if(this.oActionSheet){this.oActionSheet.destroy();delete this.oActionSheet}if(this.oChild){this.oChild.destroy();delete this.oChild}if(this.oBarOverflow){this.oBarOverflow.destroy();delete this.oBarOverflow}if(this.oOverflowList){this.oOverflowList.destroy();delete this.oOverflowList}},addOverflowButton:function(){var t,e,o=this;if(!this.oOverflowList){this.oOverflowList=new sap.ca.scfld.md.app.ButtonListHelper(this.oApplicationImplementation,10);this.oOverflowList.bAllDisabled=this.bAllDisabled;this.oOverflowList.oBarList=this}this.iOverflowPosition=this.oPositions.iActive;e=this.ensureButton(sap.ca.scfld.md.app.ButtonListHelper.getOverflowMeta(this),"b");this.oOverflowButton=e;this.oOverflowList.oOverflowButton=e;e.setEnabled(true);e.setLayoutData(new sap.ca.scfld.md.app.BarOverflowLayoutData({moveToOverflow:false,stayInOverflow:false,overflowButton:true}));t=this.oOverflowList.oActionSheet;if(this.bAutomaticOverflow&&!this.oBarOverflow){e.setVisible(false);this.oBarOverflow=new sap.ca.scfld.md.app.BarOverflow(this.oBar,t,a.bind(o))}return t},ensureButton:function(t,e,o){var i;if(o&&this.oPositions.iActive>=o){if(!this.bHasOverflow){this.addOverflowButton();this.bHasOverflow=true}return this.oOverflowList.ensureButton(t,e)}var s=this.oPositions.iActive;if(s==this.aButtons.length){this.aButtons.push({})}i=this.ensureControlAtPosition(t,e,s,this.oPositions);if(this.bAutomaticOverflow){i.setLayoutData(new sap.ca.scfld.md.app.BarOverflowLayoutData);if(!o){i.getLayoutData().setMoveToOverflow(false)}}return i},setBtnEnabled:function(t,e,i){if(this.bAllDisabled){return}var s=this.mButtons[t],n;if(s){s.setEnabled(e);if(s.getMetadata().getName()==="sap.m.Select"){n=o(this.aButtons,s);s=n.oButton;if(s){s.setEnabled(e)}}}else{if(this.oChild){this.oChild.setBtnEnabled(t,e,true)}if(this.oOverflowList){this.oOverflowList.setBtnEnabled(t,e,true)}}if(!i){this.oModifications.mChangedEnablements[t]=e}},ensureControlAtPosition:function(t,e,o,i){var s=this.aButtons[o],n,l,a,f;if(e=="b"||this.iMode<20){if(s.oSelect){i.iControlPosition=this.oBar["indexOfContent"+this.sDirection](s.oSelect);s.oSelect.setVisible(false)}if(s.oButton){s.oButton.setVisible(true);if(this.oBar){a=this.oBar["indexOfContent"+this.sDirection](s.oButton);if(a>i.iControlPosition){i.iControlPosition=a}}}else{s.oButton=new sap.m.Button({id:t.sControlId});s.oButton.attachPress(jQuery.proxy(function(t){if(this.aCallBacks[o]){this.aCallBacks[o](t)}},this));i.iControlPosition++;if(this.iMode>=20){this.oBar["insertContent"+this.sDirection](s.oButton,i.iControlPosition)}else if(this.iMode>=10){this.oActionSheet.addButton(s.oButton)}else if(this.iMode==5){this.oBar.insertContentLeft(s.oButton,i.iControlPosition)}}n=r(t,this.oApplicationImplementation);l=n;if(!(this.iMode<20||!t.sIcon)){s.oButton._sTooltip=t.sTooltip||n;s.oButton.setTooltip(s.oButton._sTooltip);n=""}else if(t.sTooltip&&t.sTooltip!==n){s.oButton._sTooltip=t.sTooltip;s.oButton.setTooltip(s.oButton._sTooltip)}s.oButton._sTextInActionSheet=l;s.oButton._sTextInBar=n;if(n!=s.oButton.getText()){s.oButton.setText(n)}s.oButton._sTypeInActionSheet=sap.m.ButtonType.Default;if(this.iMode==20){if(s.oButton.getType()!=t.style){s.oButton.setType(t.style);s.oButton._sTypeInBar=t.style}}if(e=="b"){this.aCallBacks[o]=t.onBtnPressed}else{this.aCallBacks[o]=this.getSelectReplacement(t)}f=s.oButton}else{if(s.oButton){i.iControlPosition=this.oBar["indexOfContent"+this.sDirection](s.oButton);s.oButton.setVisible(false)}if(s.oSelect){s.oSelect.setVisible(true);a=this.oBar["indexOfContent"+this.sDirection](s.oSelect);if(a>i.iControlPosition){i.iControlPosition=a}var h=s.oSelect.getSelectedKey();s.oSelect.destroyItems();s.oSelect.setSelectedKey(h)}else{s.oSelect=new sap.m.Select({id:t.sControlId?t.sControlId+"_SELECT":undefined});s.oSelect.setType(sap.m.SelectType.IconOnly);s.oSelect.setAutoAdjustWidth(true);s.oSelect.setTooltip(t.sTooltip);i.iControlPosition++;this.oBar["insertContent"+this.sDirection](s.oSelect,i.iControlPosition);s.oSelect.attachChange(jQuery.proxy(function(t){var e=t.getSource().getSelectedKey();if(this.aCallBacks[o]){this.aCallBacks[o](e)}},this));if(this.bAutomaticOverflow&&!s.oButton){s.oButton=new sap.m.Button;s.oButton.setText(r(t,this.oApplicationImplementation));if(t.sIcon){s.oButton.setIcon(t.sIcon)}s.oButton.attachPress(jQuery.proxy(function(e){var o=this.getSelectReplacement(t);if(o){o(e)}},this));s.oButton.setEnabled(!t.bDisabled&&!this.bAllDisabled)}}if(t.sSelectedItemKey){s.oSelect.setSelectedItem(t.sSelectedItemKey)}for(var u=0;u<t.aItems.length;u++){var c=t.aItems[u],d;if(!c.id&&t.sControlId){c.id=s.oSelect.getId()+"_"+u}d=new sap.ui.core.Item(c);s.oSelect.addItem(d)}if(t.sSelectedItemKey){s.oSelect.setSelectedKey(t.sSelectedItemKey)}this.aCallBacks[o]=t.onChange;f=s.oSelect}if(t.sIcon!=f.getIcon()){f.setIcon(t.sIcon)}if(t.sId){this.mButtons[t.sId]=f}f.setEnabled(!t.bDisabled&&!this.bAllDisabled);i.iActive++;return f},getSelectReplacement:function(o){var n=o.sSelectedItemKey,l=this;return function(r){var a=[];var f=0;for(var h=0;h<o.aItems.length;h++){a.push({itemContent:o.aItems[h].text});if(o.aItems[h].key==n){f=h}}n=o.aItems[f].key;sap.ca.ui.dialog.selectItem.open({title:r.getSource().getText(),items:a,defaultIndex:f},function(r){var a=l.oActionSheet&&l.oActionSheet.getButtons()||[],f,h=i(a,{icon:o.sIcon,text:o.sBtnTxt,tooltip:o.sTooltip});if(t){jQuery.sap.log.debug("Closed item selection for "+o.sBtnTxt,e)}if(l.oOverflowButton){if(h&&l.oBarList){f=s(h.getId(),a,"overflow");if(f){f.pos=1e3;l.oBarList._focusInfo=f;if(t){jQuery.sap.log.debug("Save focus information",JSON.stringify(f),e)}}}l.oOverflowButton.focus()}if(r.selectedIndex>=0){var u=o.aItems[r.selectedIndex].key;if(u!=n){n=u;o.sSelectedItemKey=n;o.onChange(n)}}})}},revertOverflowReplacement:function(){if(this.bIsOverflowReplaced){this.ensureControlAtPosition(sap.ca.scfld.md.app.ButtonListHelper.getOverflowMeta(this),"b",this.iOverflowPosition,{});this.bIsOverflowReplaced=false}},setBtnText:function(t,e,i){var s=this.mButtons[t],n;if(s){if(s.getMetadata().getName()==="sap.m.Select"){s.setTooltip(e);s._sTooltip=e;n=o(this.aButtons,s);s=n.oButton}if(s){s.setText(e);s.setTooltip("");s._sTooltip="";if(s._sTextInBar){s._sTextInBar=e}if(s._sTextInActionSheet){s._sTextInActionSheet=e}if(this.oBarOverflow){this.oBarOverflow.buttonTextChanged()}}}else{if(this.oChild){this.oChild.setBtnText(t,e,true)}if(this.oOverflowList){this.oOverflowList.setBtnText(t,e,true)}}if(!i){this.oModifications.mChangedTexts[t]=e}},_getCurrentSelection:function(t,e){if(!this.mSelections[t]){this.mSelections[t]=e}return this.mSelections[t]},_updateCurrentSelection:function(t,e){this.mSelections[t]=e}});sap.ca.scfld.md.app.ButtonListHelper.getOverflowMeta=function(t){return{sIcon:"sap-icon://overflow",sControlId:t.sOverflowId,sTooltip:t.oApplicationImplementation.UilibI18nModel.getResourceBundle().getText("MORE"),onBtnPressed:function(e){t.oOverflowList.oActionSheet.openBy(e.getSource())}}}})();
//# sourceMappingURL=ButtonListHelper.js.map