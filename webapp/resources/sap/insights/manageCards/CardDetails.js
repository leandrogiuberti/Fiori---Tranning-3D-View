/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/Control","sap/m/FlexBox","sap/m/VBox","sap/m/HBox","sap/m/ScrollContainer","sap/m/Title","sap/ui/integration/widgets/Card","sap/ui/layout/Grid","../utils/AppConstants","sap/m/Link","sap/m/Label","sap/insights/CardHelper","../utils/oDataModelProvider","sap/ui/core/CustomData","../utils/MetadataAnalyser","../utils/V4MetadataAnalyser","sap/m/Token","sap/ui/core/date/UI5Date","../utils/UrlGenerateHelper","../utils/SelectionVariantHelper","sap/fe/navigation/SelectionVariant","sap/ui/core/IconPool","sap/base/util/deepClone","sap/ui/comp/util/DateTimeUtil","sap/ui/layout/form/SimpleForm","sap/m/Toolbar","sap/m/Input","sap/m/DynamicDateRange","sap/m/Button","sap/m/Page","../utils/CardPreviewManager","sap/base/Log","sap/m/MessageToast","sap/m/MessageBox","sap/ui/mdc/MultiValueField","sap/ui/mdc/field/MultiValueFieldItem","sap/m/Text","sap/ui/model/json/JSONModel","sap/ui/core/Element","sap/ui/core/Lib","sap/ui/performance/trace/FESRHelper","../utils/InsightsUtils","sap/ui/core/InvisibleText","sap/insights/base/CacheData"],function(e,t,i,a,r,s,n,o,l,d,p,h,u,g,c,f,m,v,C,y,S,b,I,T,x,F,P,_,w,D,E,B,V,A,M,O,k,L,N,U,G,R,K,H){"use strict";var J=e.extend("sap.insights.manageCards.CardDetails",{metadata:{properties:{manifest:{type:"string",defaultValue:null,group:"Data",bindable:true,invalidate:true},editable:{type:"boolean",group:"Behavior",defaultValue:false,invalidate:true},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"}},aggregations:{_page:{type:"sap.m.Page",multiple:false,visibility:"hidden"}},events:{navigate:{allowPreventDefault:true,parameters:{}}}},renderer:{apiVersion:2,render:function(e,t){e.openStart("div",t);e.style("height",t.getHeight());e.style("width",t.getWidth());e.openEnd();e.renderControl(t.getAggregation("_page"));e.close("div");return}}});J.prototype.init=function(){h.getServiceAsync().then(function(e){this.oCardHelperServiceInstance=e;e._getUserAllCards().then(function(e){this.aCards=e}.bind(this))}.bind(this));this.parentAppUrl=null;this.oLogger=B.getLogger("sap.insights.manageCards.CardDetails");this.i18Bundle=R.getResourceBundle();this.inMemoryCacheInstance=H.getInstance();this.oFlexBox=new t(this.getId()+"idCardsPreviewFlex",{height:"100%",direction:"Column"}).addStyleClass("sapUiTinyMarginBeginEnd");this.oInvisibleText=new K(this.getId()+"--ariaText");this.oInnerDeleteButton=new sap.m.Button({text:this.i18Bundle.getText("delete"),press:this._handleCardDeleteConfirm.bind(this),ariaLabelledBy:[this.oInvisibleText]});this._createStaticControls();this.oPage=new D({id:this.getId()+"insightCardPage",headerContent:[this.oInvisibleText,this.oInnerDeleteButton],content:this.oFlexBox,showNavButton:true,navButtonPress:this._navigateToList.bind(this),titleLevel:"H3"});this.oSmartFormMap={};this.oDraftCardParams={};this.setAggregation("_page",this.oPage)};J.prototype._createStaticControls=function(){this.oPreviewTitle=new s(this.getId()+"--previewTitle",{text:this.i18Bundle.getText("preview"),titleStyle:"H4"}).addStyleClass("sapUiSmallMargin");this.oCard=new n(this.getId()+"--previewCard",{width:"17rem",height:"23.5rem",manifest:this.getManifest()?this.getManifest():"",visible:true,manifestReady:this._setCopyVisible.bind(this),manifestApplied:this._setPreviewCardAriaText.bind(this,"preview")});this.oOverflowInnerHBox=new a(this.getId()+"--insightsPreviewOverflowInnerHBox").addStyleClass("insightsCardOverflowLayer insightsCardOverflowTop insightsPreviewOverLaySize");this.oOverFlowHBox=new a(this.getId()+"insightsPreviewOverflowLayer",{height:"0",items:[this.oOverflowInnerHBox]}).addStyleClass("sapMFlexBoxJustifyCenter");this.oPreviewVBox=new i(this.getId()+"--idCardsPreviewVBox",{alignItems:"Center",justifyContent:"Center",items:[this.oCard,this.oOverFlowHBox]});this.oSmartFormFlex=new t(this.getId()+"--smartFormFlex",{justifyContent:"Center",direction:"Column",visible:false,items:[]}).addStyleClass("sapUiTinyMarginTop");this.oOtherTitle=new s(this.getId()+"--otherSectionTitle",{text:this.i18Bundle.getText("otherSectionTitle"),titleStyle:"H4"}).addStyleClass("sapUiSmallMargin");this.oTitleVBox=new i(this.getId()+"--otherSectionTitleVBox",{width:"100%",items:[this.oOtherTitle]});this.parentLink=new d(this.getId()+"--parentAppLink",{ariaLabelledBy:this.getId()+"--parentAppLabel",press:this._navigateToParentApp.bind(this),wrapping:true});this.parentAppLabel=new p(this.getId()+"--parentAppLabel",{text:this.i18Bundle.getText("parentApp")});this.parentLinkVBox=new i(this.getId()+"--parentAppLinkVBox",{width:"100%",items:[this.parentLink]}).addStyleClass("sapUiSmallMarginEnd");this.appLabelVBox=new i(this.getId()+"--parentAppLabelVBox",{width:"100%",alignItems:"End",items:[this.parentAppLabel]}).addStyleClass("sapUiSmallMarginEnd");this.parentAppGrid=new o(this.getId()+"--parentAppLinkGrid",{width:"100%",vSpacing:0,hSpacing:1,position:"Left",defaultSpan:"XL4 L4 M4 S6",defaultIndent:"XL0 L0 M0 S0",content:[this.appLabelVBox,this.parentLinkVBox]});this.otherSection=new a(this.getId()+"--otherSectionHBox",{direction:"Column",items:[this.oTitleVBox,this.parentAppGrid]});this.outerMainVBox=new i(this.getId()+"--idPreviewOuterVBox",{height:"100%",width:"100%",items:[this.oPreviewTitle,this.oPreviewVBox,this.oSmartFormFlex,this.otherSection]});this.scrollContainer=new r(this.getId()+"--idCardsPreviewContainer",{vertical:true,horizontal:false,height:"100%",content:[this.outerMainVBox]})};J.prototype._createCopyStaticControls=function(){this.oDetailsTitle=new s(this.getId()+"--detailsTitle",{text:this.i18Bundle.getText("editDetails"),titleStyle:"H5"}).addStyleClass("sapUiSmallMarginBegin sapUiSmallMarginEnd sapUiSmallMarginTop");this.oCopyTitleLabel=new p(this.getId()+"--copyCardsEditTitleLabel",{text:this.i18Bundle.getText("title"),required:true});this.oCopyTitleInput=new P(this.getId()+"--copyCardsEditTitleField",{change:this._handleCardsInputChange.bind(this)});this.oCopySubLabel=new p(this.getId()+"--copyCardsEditSubTitleLabel",{text:this.i18Bundle.getText("subTitle")});this.oCopySubInput=new P(this.getId()+"--copyCardsEditSubTitleField",{change:this._handleCardsInputChange.bind(this)});this._oCopyForm=new x(this.getId()+"--copyCardsEditDetailsForm",{layout:"ColumnLayout",backgroundDesign:"Transparent",width:"100%",editable:true,content:[this.oCopyTitleLabel,this.oCopyTitleInput,this.oCopySubLabel,this.oCopySubInput]}).addStyleClass("sapContrastPlus sapUiSmallMarginEnd sapUiSmallMarginBegin");this.outerCopyFormVBox=new i(this.getId()+"--idCopyFormVBox",{height:"100%",width:"100%",items:[this.oDetailsTitle,this._oCopyForm]});this.oDynDate=new _(this.getId()+"--hiddenDDR",{hideInput:true});this.oDynDateFilter=new _(this.getId()+"--hiddenFilterDDR",{hideInput:true});this.oCopyPreviewTitle=new s(this.getId()+"--copyCardPreviewTitle",{text:this.i18Bundle.getText("preview"),titleStyle:"H5"}).addStyleClass("sapUiSmallMarginTop sapUiSmallMarginBegin");this.oRefreshButton=new w(this.getId()+"--copyCardPreviewRefreshButton",{type:"Transparent",text:this.i18Bundle.getText("refresh"),press:this._handleCardPreviewPress.bind(this)});this.oCopyHbox=new a(this.getId()+"--copyCardPreviewHBox",{alignItems:"Center",justifyContent:"SpaceBetween",width:"100%",items:[this.oCopyPreviewTitle,this.oRefreshButton]});this.oCopyCard=new n(this.getId()+"--copyCardPreview",{manifestApplied:this._setPreviewCardAriaText.bind(this,"preview"),width:"17rem",height:"23.5rem"});this.oCopyInnerOverflow=new a(this.getId()+"--insightsCopyOverflowInnerHBox").addStyleClass("insightsCardOverflowLayer insightsCardOverflowTop insightsPreviewOverLaySize");this.oCopyOverflow=new a(this.getId()+"--insightsCopyOverflowLayer",{height:"0",items:[this.oCopyInnerOverflow]}).addStyleClass("sapMFlexBoxJustifyCenter");this.oCopyPreviewVBox=new i(this.getId()+"--copyCardsPreviewVBox",{alignItems:"Center",items:[this.oCopyCard,this.oCopyOverflow]}).addStyleClass("sapUiMediumMarginBottom");this.oCopyVBox=new i(this.getId()+"--copyCardPreviewVBoxWrapper",{backgroundDesign:"Transparent",height:"100%",width:"100%",items:[this.oCopyHbox,this.oCopyPreviewVBox]}).addStyleClass("sapUiMediumMarginTop")};J.prototype._generateCardId=function(e){function t(e){var i=e[e.length-1];var a=new Date(parseInt(i)).getTime()>0;if(a){e.pop();return t(e)}return e}var i=t(e.split("."));i.push(Date.now());return i.join(".")};J.prototype._handleCardSavePress=function(){var e=this.oSmartFormFlex,t=e&&e.getItems()[0];if(t&&!t.getSmartFields().some(function(e){return e.checkClientError({handleSuccess:true})})){if(this.oCopyCardManifest.descriptorContent["sap.card"].header.title){this.oPage.setBusy(true);var i=this.oActualManifest;var a=this.oCopyCardManifest;var r=this.oCopyCardManifest.descriptorContent["sap.app"].id;var s=this.aCards||[];this.oDraftCardParams[r]={};a=this._mergeDraftParamsIncard(a);var n=s.filter(function(e){return e.visibility});a.descriptorContent["sap.insights"].visible=n.length<10?true:false;a.visibility=n.length<10?true:false;a.descriptorContent["sap.insights"].parentAppId=i.descriptorContent["sap.insights"].parentAppId;a.descriptorContent["sap.insights"].isDtCardCopy=false;a.descriptorContent["sap.ui5"].componentName=r;var o=false;if(a.descriptorContent["sap.card"]&&a.descriptorContent["sap.card"].extension&&a.descriptorContent["sap.card"].extension==="module:sap/insights/OVPCardExtension"){o=true}h.getServiceAsync().then(function(e){e._createCard(a.descriptorContent,o).then(function(){var t=i.descriptorContent["sap.card"].header.title;var a=this.i18Bundle.getText("copyCardSuccessMsg",[t]);V.show(a);this.oPage.setShowNavButton(true);e._getUserAllCardModel().then(function(e){this.aCards=e.getProperty("/cards")}.bind(this));this._navigateToList()}.bind(this)).catch(function(e){if(e&&e.message==="/UI2/INSIGHTS_MSG/007"){A.error(this.i18Bundle.getText("INT_CARD_MAXLIMIT"))}else{V.show(e.message)}}.bind(this)).finally(function(){this.oPage.setBusy(false)}.bind(this))}.bind(this))}}else{this.oLogger.error(this.i18Bundle.getText("cardCopyErrorMsg"))}};J.prototype._setEditable=function(e){this.oFlexBox.removeAllItems();var t;var i=this.oActualManifest.descriptorContent["sap.app"];var a=i&&i.dataSources;var r=a&&a.filterService;if(r&&r.settings&&r.settings.odataVersion===l.ODATA_VERSION_4){t=true}if(e&&!t){if(!this.oCopyVBox){this._createCopyStaticControls()}this.oInnerSaveBtn.setVisible(true);this.oInnerCancelBtn.setVisible(true);this.oInnerDeleteButton.setVisible(false);this.oInnerCopyBtn.setVisible(false);this.oFlexBox.addItem(this.oCopyTitle);this.oFlexBox.addItem(this.outerCopyFormVBox);this.oFlexBox.addItem(this.oSmartFormFlex);this.oFlexBox.addItem(this.oDynDate);this.oFlexBox.addItem(this.oDynDateFilter);this.oFlexBox.addItem(this.oCopyVBox)}else{this.oInnerDeleteButton.setVisible(true);if(this.oInnerSaveBtn){this.oInnerSaveBtn.setVisible(false);this.oInnerCancelBtn.setVisible(false)}if(this.outerMainVBox.indexOfItem(this.oSmartFormFlex)=="-1"){this.outerMainVBox.insertItem(this.oSmartFormFlex,2)}if(this.oInnerCopyBtn){if(!t){this.oInnerCopyBtn.setVisible(true)}else{this.oInnerCopyBtn.setVisible(false)}}this.oFlexBox.addItem(this.scrollContainer)}};J.prototype._setManifest=function(e){if(this.getEditable()){this.oCopyPreview=E.getCardPreviewManifest(e.descriptorContent);var t=this.oCopyPreview["sap.app"].id;var i=this._generateCardId(t);this.oCopyCardManifest.descriptorContent["sap.app"].id=i;this.oCopyPreview["sap.app"].id=i;this.oCopyCard.setManifest(this.oCopyPreview);if(this.oDraftCardParams){this.oDraftCardParams[i]={}}}else{this.oPreviewManifest=E.getCardPreviewManifest(e.descriptorContent);this.oPage.setTitle(e.descriptorContent["sap.card"].header.title);this.oInvisibleText.setText(this.oPage.getTitle());this.oCard.setManifest(this.oPreviewManifest)}if(e.descriptorContent["sap.app"].id!==this.currentCardId||this.getEditable()||this.bValueUpdate||this.listRefreshed){var a=this.getEditable()?this.oCopyOverflow:this.oOverFlowHBox;if(e.descriptorContent["sap.card"]["type"]==="Analytical"){a.setVisible(false)}else{a.setVisible(true)}this.listRefreshed=false;this._setSmartFormForCardEdit();this.currentCardId=e.descriptorContent["sap.app"].id}};J.prototype._navigateToList=function(){this._navigateCancel();this.fireNavigate()};J.prototype._setCopyVisible=function(){var e=this.oPreviewManifest;this.oSmartFormFlex.setVisible(false);if(e){var t=e["sap.app"].dataSources;var i=t&&t.filterService;var a=i&&i.uri;var r=i&&i.settings;if(a&&r){this.oSmartFormFlex.setVisible(true)}if(a&&r&&e["sap.insights"].isDtCardCopy&&!e["sap.insights"].error){if(!this.oInnerCopyBtn){this.oInnerCopyBtn=new sap.m.Button({text:this.i18Bundle.getText("copy"),press:this._navigateToCopyCard.bind(this),visible:true});this.oPage.insertHeaderContent(this.oInnerCopyBtn,1);G.setSemanticStepname(this.oInnerCopyBtn,"press","copyCardPress")}this.oInnerCopyBtn.setVisible(true)}else if(this.oInnerCopyBtn){this.oInnerCopyBtn.setVisible(false)}}};J.prototype._navigateCancel=function(){var e;if(this.oSmartFormFlex.getItems()[0]&&this.oSmartFormFlex.getItems()[0].isA("sap.ui.comp.smartform.SmartForm")&&this.oSmartFormFlex.getItems()[0].getEditable()){e=this.oSmartFormFlex.getItems()[0].check().length}if(this.bValueUpdate&&e){this.oSmartFormFlex.removeAllItems();this.setProperty("editable",false)}else{this.setProperty("editable",false);if(this.oSmartFormFlex.getItems()[0]){this.oSmartFormFlex.getItems()[0].setEditable(false)}}this.oPage.setShowNavButton(true)};J.prototype.onBeforeRendering=function(){if(this.getManifest()){this.oActualManifest=JSON.parse(this.getManifest());this._setManifest(this.oActualManifest);this._updateParentDetails(this.oActualManifest)}this.oCard.refresh();if(this.getEditable()){this._setEditable(true)}else{this._setEditable(false)}};J.prototype._setPreviewCardAriaText=function(e,t){var i=t.getSource()._ariaText.getText();var a=this.i18Bundle.getText(e);t.getSource()._ariaText.setText(a+i)};J.prototype._navigateToCopyCard=function(){this.oPage.setShowNavButton(false);if(!this.oCopyVBox){this._createCopyStaticControls()}if(!this.oInnerCancelBtn&&!this.oInnerSaveBtn){this.oInnerCancelBtn=new sap.m.Button({text:this.i18Bundle.getText("cancelButton"),press:this._navigateCancel.bind(this)});this.oInnerSaveBtn=new sap.m.Button({text:this.i18Bundle.getText("save"),press:this._handleCardSavePress.bind(this)});G.setSemanticStepname(this.oInnerSaveBtn,"press","saveCopyPress");this.oPage.insertHeaderContent(this.oInnerSaveBtn,2);this.oPage.insertHeaderContent(this.oInnerCancelBtn,3)}this.setEditable(true);this.bValueUpdate=false;this.oCopyCardManifest=JSON.parse(JSON.stringify(this.oActualManifest));this.oCopyPreview=JSON.parse(JSON.stringify(this.oPreviewManifest));this.oCopyCard.setManifest(this.oCopyPreview);this.oCopyTitleInput.setValue(this.oCopyCardManifest.descriptorContent["sap.card"].header.title);this.oCopySubInput.setValue(this.oCopyCardManifest.descriptorContent["sap.card"].header.subTitle);this.oPage.setTitle(this.i18Bundle.getText("copyCard"))};J.prototype._handleCardsInputChange=function(e){var t=e.getSource(),i=t.getValue(),a=t.getId();if(a&&a.includes("copyCardsEditTitleField")){if(!i){t.setValueState("Error")}else{t.setValueState("None")}this.oCopyCardManifest.descriptorContent["sap.card"].header.title=i}else if(a&&a.includes("copyCardsEditSubTitleField")){this.oCopyCardManifest.descriptorContent["sap.card"].header.subTitle=i}};J.prototype._handleCardPreviewPress=function(){if(this.oCopyCardManifest.descriptorContent["sap.card"].header.title){var e=this._mergeDraftParamsIncard(this.oCopyCardManifest);var t=this.oCopyCardManifest.descriptorContent["sap.app"].id;this.oCopyPreview=E.getCardPreviewManifest(e.descriptorContent);this.oCopyCard.setManifest(this.oCopyPreview);this.inMemoryCacheInstance.clearCache(t);this.oCopyCard.refresh()}};J.prototype._setSmartFormForCardEdit=function(){if(this.oActualManifest.descriptorContent&&this.oActualManifest.descriptorContent&&this.oActualManifest.descriptorContent["sap.app"]){var e=this.oActualManifest.descriptorContent["sap.app"];var t=e&&e.dataSources;var i=t&&t.filterService;if(i&&i.settings&&i.settings.odataVersion===l.ODATA_VERSION_2){var a=this.oActualManifest.descriptorContent["sap.app"].id,r=this.oSmartFormMap[a]&&!this.getEditable()&&!this.bValueUpdate?Promise.resolve(this.oSmartFormMap[a]):this._createSmartFormForCardEdit(this.oActualManifest.descriptorContent,this.getEditable());r.then(function(e){if(this.getEditable()){e.setEditable(true)}else{e.setEditable(false)}var t=this.oSmartFormFlex;t.removeAllItems();var i=this.oActualManifest.descriptorContent["sap.app"].dataSources;u.getOdataModel(i).then(function(i){var a=i&&i.loaded;var r=false;if(e.getGroups()&&e.getGroups().length&&e.getGroups()[0].getGroupElements()){r=e.getGroups()[0].getGroupElements().some(function(e){return e.getElements().some(function(e){return e.getVisible()})})}if(e.getAggregation("content").getFormContainers().length&&a&&r){e.setVisible(true);setTimeout(function(){var i=e.getAggregation("content").getLayout();if(i){i.setBackgroundDesign("Transparent")}t.addItem(e)},0)}else{this._setFilterTextForNoData(e,a,true);t.addItem(e)}}.bind(this))}.bind(this))}else if(i&&i.settings&&i.settings.odataVersion===l.ODATA_VERSION_4){this._createSimpleForm(this.oActualManifest.descriptorContent)}}};J.prototype._createSimpleForm=function(e){u.getOdataModel(this._search(e,"/sap.app/dataSources")).then(function(t){var i=this.oSmartFormFlex,a=e,r=t.oData,n=this._search(a,"/sap.app/id"),o=function(e){return new k({text:e,textAlign:"Center"})};i.removeAllItems();this._oSimpleForm=this._oSimpleForm||{};var l={onAfterRendering:function(){if(this._oSimpleForm[n].getAggregation("form").getLayout()&&this._oSimpleForm[n].getAggregation("form").getLayout().setBackgroundDesign){this._oSimpleForm[n].getAggregation("form").getLayout().setBackgroundDesign("Transparent");this._oSimpleForm[n].fireEvent("Rendered")}}.bind(this)};var d=function(){this._oSimpleForm[n].removeEventDelegate(l)};if(!this._oSimpleForm[n]){this._oSimpleForm[n]=new x({layout:"ColumnLayout",editable:false,toolbar:new F({style:"Clear",content:[new s({text:this.i18Bundle.getText("filterBy"),titleStyle:"H4"})]}).addStyleClass("sapThemeBaseBG-asBackgroundColor")});this._oSimpleForm[n].addEventDelegate(l);if(t.loaded){Promise.all([this._fetchRelevantFilters(a,r),this._fetchParameterizedFilters(a,r)]).then(function(e){var t=e[0],a=e[1];if(t.length||a.length){a.concat(t).forEach(function(e){this._oSimpleForm[n].addContent(new sap.m.Label({text:e.name}));this._oSimpleForm[n].addContent(this._generateMultiValueField(e.tokens))}.bind(this))}else{this._oSimpleForm[n].addContent(o(this.i18Bundle.getText("noFilterMsg")))}this._oSimpleForm[n].attachEventOnce("Rendered",null,d.bind(this),this._oSimpleForm[n]);i.addItem(this._oSimpleForm[n])}.bind(this))}else{this._oSimpleForm[n].addContent(o(this.i18Bundle.getText("noFilterLoaded")));this._oSimpleForm[n].attachEventOnce("Rendered",null,d.bind(this),this._oSimpleForm[n]);i.addItem(this._oSimpleForm[n])}}else{this._oSimpleForm[n].addEventDelegate(l);this._oSimpleForm[n].attachEventOnce("Rendered",null,d.bind(this),this._oSimpleForm[n]);i.addItem(this._oSimpleForm[n])}}.bind(this))};J.prototype._fetchParameterizedFilters=function(e,t){var i=this._search(e,"/sap.card/configuration/parameters"),a=this._search(i,"/_relevantODataParameters/value")||[];return a.reduce(function(a,r){return a.then(function(a){return f.getAnnotations(t,e,r,["@com.sap.vocabularies.Common.v1.Label","@com.sap.vocabularies.UI.v1.Hidden"]).then(function(e){var t=e[0],s=e[1],n=i[r].value,o=i[r].label;if(n&&!s){a.push({name:t||r,tokens:[new m({key:n,text:o?o:n})]})}return Promise.resolve(a)})})},Promise.resolve([]))};J.prototype._fetchRelevantFilters=function(e,t){var i=this._search(e,"/sap.card/configuration/parameters"),a=this._search(i,"/_relevantODataFilters/value")||[];return a.reduce(function(a,r){return a.then(function(a){return f.getAnnotations(t,e,r,["@com.sap.vocabularies.Common.v1.Label","@com.sap.vocabularies.UI.v1.Hidden"]).then(function(e){var t=e[0],s=e[1],n=i[r].value,o=new S(n),l=o.getSelectOption(r);if(l.length&&!s){var d=y.getTokenFromSelectOptions(l,r);a.push({name:t||r,tokens:d})}return Promise.resolve(a)})})},Promise.resolve([]))};J.prototype._generateMultiValueField=function(e){var t=new L(e.map(function(e){return{key:e.getKey(),name:e.getText()}}));var i=new M({editMode:"Display",display:"Description",width:"100%",items:{path:"/",template:new O({description:"{name}",key:"{key}"})}});i.setModel(t);return i};J.prototype._search=function(e,t){return t?t.split("/").reduce(function(e,t){return e&&t?e[t]:e},e):undefined};J.prototype._handleCardDeleteConfirm=function(){A.show(this.i18Bundle.getText("deleteCardMsg"),{icon:A.Icon.WARNING,title:this.i18Bundle.getText("delete"),actions:[A.Action.DELETE,A.Action.CANCEL],emphasizedAction:A.Action.DELETE,onClose:function(e){if(e===A.Action.DELETE){this._handleCardDelete(this.currentCardPreviewPath)}}.bind(this)})};J.prototype._handleCardDelete=function(){this.oPage.setBusy(true);var e=this.oActualManifest;var t=e.descriptorContent["sap.app"].id;var i=e.descriptorContent["sap.card"].header.title;this.oCardHelperServiceInstance._deleteCard(t).then(function(){var e=this.aCards.filter(function(e){return e.descriptorContent["sap.app"].id!==t});this.aCards=e;this.oPage.setBusy(false);V.show(this.i18Bundle.getText("deleteCardSuccess",[i]));this.fireNavigate()}.bind(this)).catch(function(e){this.oPage.setBusy(false);V.show(e.message)}.bind(this))};J.prototype._setFilterTextForNoData=function(e,t,i){U.load({name:"sap.ui.comp"}).then(function(){sap.ui.require(["sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartform/Layout"],function(a,r,s){e.removeAllGroups();var n=new a;var o=new r;var l=new k({text:t?this.i18Bundle.getText("noFilterMsg"):this.i18Bundle.getText("noFilterLoaded"),textAlign:"Center"});o.addElement(l);n.addGroupElement(o);e.setLayout(new s);e.addGroup(n);if(i){e.getAggregation("content").getLayout().setBackgroundDesign("Transparent")}}.bind(this))}.bind(this))};J.prototype._mergeDraftParamsIncard=function(e){var t=e.descriptorContent["sap.card"].configuration.parameters;var i=e.descriptorContent["sap.app"].id;var a=this.oDraftCardParams[i];Object.keys(a).forEach(function(e){if(a[e]){if(t[e]){if(t[e].type==="datetime"&&typeof t[e].value==="string"&&t[e].value.includes("operation")){var i=JSON.parse(t[e].value);i.operation=a[e];t[e].value=JSON.stringify(i)}else{t[e].value=a[e].value?a[e].value:a[e];if(a[e].label){t[e].label=a[e].label}t[e].description=a[e].description}}else if(e.indexOf("P_")===0&&t[e.replace("P_","")]){a[e.replace("P_","")]=a[e].replace("P_","");t[e.replace("P_","")].value=a[e].replace("P_","");delete a[e]}}});C.processPrivateParams(e,a);Object.keys(t).forEach(function(e){var i=t[e].value;if(t[e].type==="datetime"&&typeof i==="string"&&i.includes("datetime")){i=i.split("datetime");i=i[i.length-1];i=i.replace(/["']/g,"");t[e].value=i}});return e};J.prototype._getOptionsForDynamicDate=function(e,t){var i;if(e[t]["sap:filter-restriction"]==="single-value"){i=l.DATE_OPTIONS.SINGLE_OPTIONS}else if(e[t]["sap:filter-restriction"]==="interval"){i=l.DATE_OPTIONS.RANGE_OPTIONS;i=i.concat(l.DATE_OPTIONS.SINGLE_OPTIONS)}if(e&&e[t].exclude){i=i.filter(function(i){return!e[t].selectedValues.includes(i)})}return i};J.prototype._attachInitialiseToGroupElement=function(e){if(e.getFields()&&e.getFields().length){e.getFields()[0].attachInitialise(function(){if(e.getFields().length&&e.getLabelControl()&&!e.getLabelControl().getText()){var t=e.getFields()[0].getBindingPath("value");if(t&&e.getFields()[0].getVisible()){e.getFields()[0].setTextLabel(t)}}})}};J.prototype._createSmartFormForCardEdit=function(e){return new Promise(function(t){Promise.all([U.load({name:"sap.ui.comp"}),U.load({name:"sap.m"})]).then(function(){sap.ui.require(["sap/ui/comp/smartmultiinput/SmartMultiInput","sap/ui/comp/smartform/SmartForm","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartform/Layout","sap/m/Title","sap/m/Toolbar"],function(i,a,r,s,n,o,l){var d=e;var p=d["sap.card"].configuration.parameters;var h=d["sap.insights"].filterEntitySet;var f=p&&p._entitySet.value;var b=d["sap.app"].dataSources;u.getOdataModel(b).then(function(e){var u=e&&e.loaded;var b={layout:new n({labelSpanS:6}),customToolbar:new l({content:[new o({text:this.i18Bundle.getText("filterBy"),titleStyle:"H4"})],style:"Clear"})};var I=new a(b);var T=new r;var x=[],F=[],P=[],_=[],w,D,E=[];if(p){x=p._mandatoryODataParameters.value||[];F=p._mandatoryODataFilters.value||[];P=p._relevantODataParameters.value||[];_=p._relevantODataFilters.value||[];D=p._semanticDateRangeSetting;if(D){w=JSON.parse(D.value);E=Object.keys(w)||[]}}I.attachEditToggled(function(e){var t=e.getParameters().editable;var i=e.getSource().getGroups()&&e.getSource().getGroups().length?e.getSource().getGroups()[0]:null;if(t&&i){i.getGroupElements().forEach(function(e){e.getFields().forEach(function(e){e.attachInnerControlsCreated(function(e){var t=e.getSource(),i=t.getBindingPath("value");if((x.includes(i)||F.includes(i))&&t.getProperty("editable")){t.setMandatory(true)}else if(t.getMandatory()){t.setMandatory(false)}t.checkClientError()})})})}});var B=function(e,t){if(t){var i=new g({key:"date",value:t});e.insertCustomData(i)}};var V=e&&c.getParameterisedEntitySetByEntitySet(e.oData,h);var A=V?c.getPropertyNamesOfEntitySet(e.oData,V):[];if(u){if(P.length){P.forEach(function(t){var a=V;var r=true;if(A.indexOf(t)===-1){a=f;r=false}var n=c.isValueListWithFixedValues(e.oData,a,t);var o=c.isDate(e.oData,a,t);var l=E.includes(t);var d=new s;var h=new i({entitySet:a,value:"{"+t+"}",editable:r,visible:r,singleTokenMode:true,supportRanges:false,innerControlsCreated:this._handleVisibilityChange.bind(this,l,true)});if(n){h.attachInnerControlsCreated(function(e){var t=e.getSource();if(t.getMode()==="edit"){var i=t.getInnerControls();if(Array.isArray(i)&&i.length){var a=t.getAggregation("initialTokens");if(t.getSingleTokenMode()){var r=i[0],s=Array.isArray(a)&&a.length?a[0]:null;if(r.setForceSelection){r.setForceSelection(false);if(s){r.setSelectedKey(s.getKey())}else{r.setSelectedItem(null)}}}else{var n=i[0];if(Array.isArray(a)&&a.length){n.setSelectedKeys(a.map(function(e){return e.getKey()}))}}if(t.getMandatory()){t.checkClientError()}}}});h.checkClientError=function(){return this._checkClientError(h)}.bind(this);h.attachSelectionChange(this._handleParameterSelectionChange.bind(this))}else{if(l){h.addStyleClass("semanticDateInsight")}h.attachTokenUpdate(this._handleParameterTokenUpdate.bind(this,null,l))}var u=p[t].value;var g=p[t].label;if(u){var y=new m({key:u,text:g?g:u});if(o){if(!E.includes(t)){B(y,v.getInstance(u))}else{if(w&&this.getEditable()){var S=this._getOptionsForDynamicDate(w,t);var b=this.oDynDate;b.setStandardOptions(S)}u=C.formatSemanticDateTime(u,"Parameter",p[t].type)[0];B(y,u)}}if(n&&h.getInnerControls().length){var I=h.getInnerControls()[0];I.setSelectedKey(y.getKey())}h.addAggregation("initialTokens",y)}if(u&&h.getVisible()){d.addElement(h);T.addGroupElement(d)}else if(this.getEditable()&&h.getVisible()){d.addElement(h);T.addGroupElement(d)}this._attachInitialiseToGroupElement(d)}.bind(this))}var M=c.getPropertyNamesOfEntitySet(e.oData,h);_.forEach(function(t){var a=t;if(!(a==="DisplayCurrency"&&P.indexOf("P_DisplayCurrency")>-1)){var r=h;var n=true;if(M.indexOf(a)===-1){var o="P_"+a;if(A.indexOf(o)>-1){r=V;a=o}else{r=f;n=false}}var l=c.isValueListWithFixedValues(e.oData,r,a);var d=c.isDate(e.oData,r,a);var u=E.includes(a);var g=new s;var m;if(a.indexOf("P_")===0){m=true}else{m=c.getPropertyFilterRestrictionByEntitySet(e.oData,r,a)}var b=new i({entitySet:r,value:"{"+a+"}",editable:n,visible:n,supportRanges:!m,singleTokenMode:m,innerControlsCreated:this._handleVisibilityChange.bind(this,u,false)});if(l){b.attachInnerControlsCreated(function(e){var t=e.getSource();if(t.getMode()==="edit"){var i=t.getInnerControls();if(Array.isArray(i)&&i.length){var a=t.getAggregation("initialTokens");if(t.getSingleTokenMode()){var r=i[0],s=Array.isArray(a)&&a.length?a[0]:null;if(r.setForceSelection){r.setForceSelection(false);if(s){r.setSelectedKey(s.getKey())}else{r.setSelectedItem(null)}}}else{var n=i[0];if(Array.isArray(a)&&a.length){n.setSelectedKeys(a.map(function(e){return e.getKey()}))}}if(t.getMandatory()){t.checkClientError()}}}});b.checkClientError=function(){return this._checkClientError(b)}.bind(this);b.attachSelectionChange(this._handleFilterSelectionChange.bind(this))}else{if(u){b.setSingleTokenMode(true);b.addStyleClass("semanticDateInsight")}b.attachTokenUpdate(this._handleFilterTokenUpdate.bind(this,null,u))}var I=new S(p[t].value);var x=I.getSelectOption(t);if(x&&x.length){var F=[],_=[];F=y.getTokenFromSelectOptions(x,t);F.forEach(function(e,i){if(d){if(!E.includes(t)){B(e,v.getInstance(e.getKey()))}else{if(w&&this.getEditable()){var a=this._getOptionsForDynamicDate(w,t);var r=this.oDynDateFilter;r.setStandardOptions(a)}_=C.formatSemanticDateTime(x[i],"Filter",p[t].type);_.forEach(function(t){B(e,t)})}}if(l&&b.getInnerControls().length){var s=b.getInnerControls()[0];s.setSelectedKey(e.getKey())}b.addAggregation("initialTokens",e)}.bind(this));g.addElement(b);T.addGroupElement(g)}else if(this.getEditable()){g.addElement(b);T.addGroupElement(g)}this._attachInitialiseToGroupElement(g)}}.bind(this))}if(T.getAggregation("formElements")&&T.getAggregation("formElements").length){I.addGroup(T)}var O=d["sap.app"].id;if(u){I.setModel(e.oData)}this.oSmartFormMap[O]=I;this.bValueUpdate=false;t(I)}.bind(this))}.bind(this))}.bind(this))}.bind(this))};J.prototype._handleParameterSelectionChange=function(e){var t=e.getParameter("selectedItem");var i=e.getSource(),a="";var r={value:"",label:"",description:""};if(t){i.setValueState("None");a=t.getText()?t.getText():t.getKey();r.value=t.getKey();r.label=a}i.removeAllAggregation("initialTokens");i.addAggregation("initialTokens",new m({key:r.value,text:r.label}));var s=e.getSource().getBinding("value").getPath();var n=this.oActualManifest.descriptorContent["sap.app"].id;this.oDraftCardParams[n][s]=r;this.bValueUpdate=true};J.prototype._checkClientError=function(e){var t=e.getSingleTokenMode()&&e.getInnerControls()[0]?!e.getInnerControls()[0].getSelectedKey():!e.getInnerControls()[0].getSelectedKeys().length,i=e.getMandatory()&&t;e.setValueState(i?"Error":"None");return i};J.prototype._refreshDTSmartForm=function(e){e.forEach(function(e){if(this.oSmartFormMap&&this.oSmartFormMap[e]){this.oSmartFormMap[e]=null}}.bind(this));this.listRefreshed=true};J.prototype._handleParameterTokenUpdate=function(e,t,i){var a=e?e:i.getSource();if(a.getMandatory()){a.checkClientError()}var r=a.getBinding("value").sPath;var s=a.getTokens();var n=this.oActualManifest.descriptorContent["sap.app"].id;var o={value:"",label:"",description:""};var d=a.getModel();var p=c.isDate(d,a.getEntitySet(),r);var h,u;if(t&&(!s.length||e)){u=this.oDynDate;this.bValueApplied=true;u.attachEventOnce("change",null,this._onSemanticParameterDateChange.bind(this,r,a),u);u.openBy(a.getDomRef())}if(s.length){o.label=s[0].getText()?s[0].getText():s[0].getKey();if(t&&!u){u=this.oDynDate}if(u&&u._parseValue){h=u._parseValue(s[0].getKey());if(h){u.setValue(h);o.value=C.getDateRangeValue(h,true);o.description=JSON.stringify(h);var g;if(r&&h){g=this._getLabelForField(e,"Parameter")}var f="";var m=h.operator==="DATE";if(g&&typeof g==="string"){f=g.substring(0,g.indexOf("(")-1);if(!f&&m){f=g}}o.label=f?f:h.operator}else{o.value=s[0].getKey();if(Date.parse(o.value)){o.value=v.getInstance(o.value)}o.description=u.getValue()?JSON.stringify(u.getValue()):"";var y=this.oActualManifest.descriptorContent["sap.card"].configuration.parameters;if(!u.getValue()&&y[r]&&y[r].description){var S;o.description=y[r].description;S=JSON.parse(o.description);if(l.DATE_OPTIONS.DATE_LIST.includes(S.operator)){S.values[0]=v.getInstance(S.values[0]);o.value=typeof s[0].getKey()==="string"?v.getInstance(s[0].getKey()):s[0].getKey()}u.setValue(S)}else{u.setValue(u.getValue())}}}else{h=a._parseValue&&a._parseValue(s[0].getKey());if(p&&h){h=a.getModel().formatValue(h,a.getDataType());o.value=h}else if(h){o.value=h}else{h=s[0].getKey();o.value=h}}}this.oDraftCardParams[n][r]=o;this.bValueUpdate=true};J.prototype._handleFilterTokenUpdate=function(e,t,i){var a=e?e:i.getSource();if(a.getMandatory()){a.checkClientError()}var r=a.getBinding("value").sPath;var s=a.getTokens();var n=this.oCopyCardManifest.descriptorContent;var o=n["sap.app"].id;var d=a.getModel();var p=c.isDate(d,a.getEntitySet(),r);var h,u="",g,f={value:"",label:"",description:""};g=n["sap.card"].configuration.parameters;if(t&&(!s.length||e)){h=this.oDynDateFilter;h.attachEventOnce("change",null,this._onSemanticFilterDateChange.bind(this,r,a),h);this.bValueApplied=true;h.openBy(a.getDomRef());if(!s.length){f.value=y.getEmptySVStringforProperty(r)}else{u=h._parseValue(s[0].getKey());if(u){h.setValue(u)}else{f.description=h.getValue()?JSON.stringify(h.getValue()):"";if(!h.getValue()&&g[r]&&g[r].description){var m;f.description=g[r].description;f.value=g[r].value;m=JSON.parse(f.description);m.values.forEach(function(e,t){if(l.DATE_OPTIONS.DATE_LIST.includes(m.operator)){var i=v.getInstance(e);if(e.match&&!(e.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3})Z$/gm)&&e.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3})Z$/gm).length)){m.values[t]=T.utcToLocal(i);if(!["DATETIMERANGE","FROMDATETIME","TODATETIME","DATETIME"].includes(m.operator)){m.values[t]=T.normalizeDate(m.values[t],true)}}else{m.values[t]=i}}});h.setValue(m)}else{h.setValue(h.getValue())}}}}else if(s.length){var C=new S;var b=[];var I="";s.forEach(function(e){I="";if(e.data("selectOption")){var t=e.data("selectOption");if(!t.Text){t.Text=e.getText?e.getText():null}b.push(t)}else if(e.data("range")){var i=e.data("range");var s=y.getSelectOptionFromRange(i,e.getText());b.push(s)}else if(p){var n=d.formatValue(e.getKey(),"Edm.DateTime");C.addSelectOption(r,"I","EQ",n,null,n)}else if(a._parseValue){var o=a._parseValue(e.getKey());I=e.getText()?e.getText():e.getKey();C.addSelectOption(r,"I","EQ",o,null,I)}else{I=e.getText()?e.getText():e.getKey();C.addSelectOption(r,"I","EQ",e.getKey(),null,I)}});C.massAddSelectOption(r,b);f.value=C.toJSONString()}else{f.value=y.getEmptySVStringforProperty(r)}this.oDraftCardParams[o][r]=f.value?f:this.oDraftCardParams[o][r];this.bValueUpdate=true};J.prototype._handleVisibilityChange=function(e,t,i){var a=i.getSource();var r=this.oSmartFormFlex;var s=r&&r.getItems()[0];var n=false;if(e&&a.getMode()==="edit"){var o=t?this.oDynDate:this.oDynDateFilter;o.setValue(null);var l=a.getBinding("value").sPath;var d=a.getInnerControls();if(d.length){var p=d[0];a.setShowValueHelp(false);a.setShowSuggestion(false);if(!N.getElementById(p.getId()+"-dynamicDateIcon")){p.addEndIcon({id:p.getId()+"-dynamicDateIcon",src:b.getIconURI("check-availability"),press:t?this._handleParameterTokenUpdate.bind(this,a,true):this._handleFilterTokenUpdate.bind(this,a,true)});p.attachLiveChange(function(){this.bValueApplied=true;p.setValue("");o.attachEventOnce("change",null,t?this._onSemanticParameterDateChange.bind(this,l,a):this._onSemanticFilterDateChange.bind(this,l,a),o);o.openBy(a.getDomRef())}.bind(this))}}}setTimeout(function(){if(s){var e=s.getGroups()&&s.getGroups().length?s.getGroups()[0]:null;var t=e&&e.getGroupElements();if(t&&t.length){t.forEach(function(t){var i=t.getFields();i.forEach(function(e){if(!this.getEditable()&&e.getId()===a.getId()&&(e.getTokens&&e.getTokens().length===0)){t.removeField(e)}if(t.getVisible()&&e.getVisible()&&e.getTokens&&e.getTokens().length){n=true}}.bind(this));if(!t.getFields().length){e.removeGroupElement(t)}}.bind(this))}}if(!n&&r&&!this.getEditable()){r.removeAllItems();this._setFilterTextForNoData(s,true,false);r.addItem(s)}}.bind(this),0)};J.prototype._handleFilterSelectionChange=function(e){var t=e.getParameters();var i=e.getSource().getBinding("value").getPath();var a=this.oActualManifest.descriptorContent;var r=a["sap.app"].id;var s=e.getSource();var n=new S;var o="",l={value:"",label:"",description:""};if(t.selectedItem){s.setValueState("None");var d=e.getParameter("selectedItem");if(d){o=d.getText()?d.getText():d.getKey();s.removeAllAggregation("initialTokens");s.addAggregation("initialTokens",new m({key:d.getKey(),text:o}));n.addSelectOption(i,"I","EQ",d.getKey(),null,o);l.value=n.toJSONString()}else{l.value=y.getEmptySVStringforProperty(i)}}else{var p=e.getSource().getInnerControls()[0].getSelectedItems();if(p.length){s.setValueState("None");s.removeAllAggregation("initialTokens");p.forEach(function(e){o=e.getText()?e.getText():e.getKey();s.addAggregation("initialTokens",new m({key:e.getKey(),text:o}));n.addSelectOption(i,"I","EQ",e.getKey(),null,o)});l.value=n.toJSONString()}else{l.value=y.getEmptySVStringforProperty(i)}}this.oDraftCardParams[r][i]=l;this.bValueUpdate=true};J.prototype._onSemanticParameterDateChange=function(e,t,i){if(this.bValueApplied){var a=i.getParameter("value");var r=t.getInnerControls()[0];var s=this.oActualManifest.descriptorContent;var n=s["sap.app"].id;var o;if(e&&a){o=this._getLabelForField(t,"Parameter")}var l="";var d=a.operator==="DATE";if(o&&typeof o==="string"){l=o.substring(0,o.indexOf("(")-1);if(!l&&d){l=o}}if(!this.oDraftCardParams[n][e]){this.oDraftCardParams[n][e]={}}this.oDraftCardParams[n][e].value=d?a.values[0]:a.operator;this.oDraftCardParams[n][e].label=d?a.values[0]:a.operator;this.oDraftCardParams[n][e].description=JSON.stringify(a);r.setTokens([]);if(l){this.oDraftCardParams[n][e].label=l}var p=new m({key:this.oDraftCardParams[n][e].value,text:this.oDraftCardParams[n][e].label});r.setTokens([p]);var h=i.getParameter("valid");t.setValueState(h?"None":"Error");this.bValueApplied=false;this.bValueUpdate=true}};J.prototype._onSemanticFilterDateChange=function(e,t,i){if(this.bValueApplied){var a=t.getInnerControls()[0];var r=i.getParameter("value");var s;if(e&&r){s=this._getLabelForField(t,"Filter")}var n=I(r);var o=C.getDateRangeValue(n,false,s);var l=this.oActualManifest.descriptorContent;var d=l["sap.app"].id;var p=new S;if(!o.High){o.High=""}if(!this.oDraftCardParams[d][e]){this.oDraftCardParams[d][e]={}}p.addSelectOption(e,"I",o.Option,o.Low,o.High,o.Text);this.oDraftCardParams[d][e].value=p.toJSONString();this.oDraftCardParams[d][e].description=JSON.stringify(n);a.setTokens([]);var h=y.getTokenFromSelectOptions(p.getSelectOption(e),e);a.setTokens(h);var u=i.getParameter("valid");t.setValueState(u?"None":"Error");this.bValueApplied=false;this.bValueUpdate=true}};J.prototype._getLabelForField=function(e,t){var i=t==="Parameter"?this.oDynDate:this.oDynDateFilter;var a=i.getIdForLabel()||"";a=a.substring(0,a.lastIndexOf("-"));if(a){var r=N.getElementById(a);return r&&r.getValue()}else if(i&&i.getProperty("value")){return i.getProperty("value")}else if(e&&typeof e.getTokens==="function"){var s=e.getTokens()||[],n=s.map(function(e){return e.getText()});return{type:"filters",value:n}}};J.prototype._updateParentDetails=function(e){return h.getServiceAsync().then(function(t){t.getParentAppDetails(e).then(function(e){if(this._getIsNavigationEnabled(e)){this.parentLink.setText(e.title);this.otherSection.setVisible(true);this.parentAppUrl=e.semanticURL}else{this.otherSection.setVisible(false)}}.bind(this))}.bind(this))};J.prototype._navigateToParentApp=function(){var e=this.parentAppUrl;const t=sap.ui.require("sap/ushell/Container");t.getServiceAsync("CrossApplicationNavigation").then(function(t){t.toExternal({target:{shellHash:e}});this.fireNavigate()}.bind(this))};J.prototype._getIsNavigationEnabled=function(e){const t=sap.ui.require("sap/ushell/Container");return t.getServiceAsync("CrossApplicationNavigation").then(function(t){return t.isNavigationSupported([{target:{semanticObject:e.semanticObject,action:e.action}}])}).then(function(e){return e[0].supported||false})};return J});
//# sourceMappingURL=CardDetails.js.map