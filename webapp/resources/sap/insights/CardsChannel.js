/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 * POC
 */
sap.ui.define(["sap/ui/base/Object"],function(e){"use strict";var s="sap-insights";var n="sap-insights";var i={available:"cardsAvailable",requested:"cardRequested",provided:"cardProvided",subscribed:"clientSubscribed",cardCreationRequested:"cardCreationRequested",cardCreated:"cardCreated"};function t(){this.subscribers={};this.onMessage=function(e){if(typeof e.data==="string"){var n=JSON.parse(e.data);if(n.type==="request"){if(n.body.channelId===s&&this.onNewMessage){this.onNewMessage(n.body.clientId,n.body.channelId,n.body.messageName,n.body.data)}else if(this.onSubscriptionChange){if(n.body.messageName==="clientSubscribed"&&!this.subscribers[n.body.clientId]){this.subscribers[n.body.clientId]=true;this.onSubscriptionChange(n.body.messageName,n.body.clientId,n.body.channels)}else if(n.body.messageName==="clientUnsubscribed"&&this.subscribers[n.body.clientId]){delete this.subscribers[n.body.clientId];this.onSubscriptionChange(n.body.messageName,n.body.clientId,n.body.channels)}}}}};this.connect=function(e){return new Promise(function(s){var n=function(e){if(typeof e.data==="string"){var i=JSON.parse(e.data);if(i.body.messageName==="connect"){window.removeEventListener("message",n);s()}}};window.addEventListener("message",n);window.parent.postMessage(JSON.stringify({type:"request",service:"sap.ushell.services.MessageBroker",request_id:Date.now().toString(),body:{channelId:"sap.ushell.MessageBroker",clientId:e,messageName:"connect"}}),"*")})};this.subscribe=function(e,s,n,i){this.onNewMessage=n;this.onSubscriptionChange=i;window.addEventListener("message",this.onMessage.bind(this));window.parent.postMessage(JSON.stringify({type:"request",service:"sap.ushell.services.MessageBroker",request_id:Date.now().toString(),body:{channelId:"sap.ushell.MessageBroker",clientId:e,messageName:"subscribe",subscribedChannels:s}}),"*");return Promise.resolve()};this.publish=function(e,s,n,i,t,r){window.parent.postMessage(JSON.stringify({type:"request",service:"sap.ushell.services.MessageBroker",request_id:n,body:{channelId:e,clientId:s,messageName:i,targetClientIds:t,data:r}}),"*");return Promise.resolve()};this.unsubscribe=function(e,s){delete this.onNewMessage;delete this.onSubscriptionChange;window.addEventListener("message",this.onMessage.bind(this));window.parent.postMessage(JSON.stringify({type:"request",service:"sap.ushell.services.MessageBroker",request_id:Date.now().toString(),body:{channelId:"sap.ushell.MessageBroker",clientId:e,messageName:"unsubscribe",subscribedChannels:s}}),"*");return Promise.resolve()};this.disconnect=function(e){window.removeEventListener("message",this.onMessage.bind(this));window.parent.postMessage(JSON.stringify({type:"request",service:"sap.ushell.services.MessageBroker",request_id:Date.now().toString(),body:{channelId:"sap.ushell.MessageBroker",clientId:e,messageName:"disconnect"}}),"*");return Promise.resolve()}.bind(this)}function r(e,n,t){this.onSubscriptionChange=function(i,t,r){if(e!==t&&r.find(function(e){return e.channelId===s})){if(i==="clientSubscribed"){n.onConsumerConnected(t)}else if(i==="clientUnsubscribed"){n.onConsumerDisconnected(t)}}};this.onNewMessage=function(r,o,a,c){if(o===s){switch(a){case i.subscribed:n.onConsumerConnected(r);break;case i.requested:n.onCardRequested(r,c);break;case i.cardCreationRequested:sap.ui.require(["sap/insights/CardHelper"],function(n){n.getServiceAsync().then(function(n){n._createCard(c.descriptorContent).then(function(o){n._getUserVisibleCardModel();t.publish(s,e,Date.now().toString(),i.cardCreated,[r],o)})})});break;default:break}}};this.register=function(){return t.connect(e).then(function(){return t.subscribe(e,[{channelId:s}],this.onNewMessage,this.onSubscriptionChange)}.bind(this))}}function o(e,n,t){this.onSubscriptionChange=function(r,o,a){if(e!==o&&a.find(function(e){return e.channelId===s})){if(r==="clientSubscribed"){t.publish(s,e,Date.now().toString(),i.subscribed,[o])}else if(r==="clientUnsubscribed"){n.onCardsAvailable(o,[])}}};this.onNewMessage=function(e,t,r,o){if(t===s){switch(r){case i.available:n.onCardsAvailable(e,o);break;case i.provided:n.onCardProvided(e,o);break;case i.cardCreated:n.onCardCreated(e,o);break;default:break}}};this.register=function(){return t.connect(e).then(function(){return t.subscribe(e,[{channelId:s}],this.onNewMessage,this.onSubscriptionChange)}.bind(this))}}var a=e.extend("sap.insights.CardsChannel",{constructor:function(){this.clients={}},isEnabled:function(){return!!this.broker},init:function(){var e;const s=sap.ui.require("sap/ushell/Container");if(s){e=s.getServiceAsync("MessageBroker")}else{e=Promise.resolve(new t)}return e.then(function(e){this.broker=e;if(s){this.registerDefaultProvider()}}.bind(this))},registerDefaultProvider:function(){const e={onConsumerConnected:function(e){},onConsumerDisconnected:function(e){}};this.registerProvider(n,e)},registerProvider:function(e,s){this.clients[e]=new r(e,s,this.broker);return this.clients[e].register()},registerConsumer:function(e,s){this.clients[e]=new o(e,s,this.broker);return this.clients[e].register()},publishAvailableCards:function(e,n,t){if(!t){t="*"}return this.broker.publish(s,e,Date.now().toString(),i.available,[t],n)},requestCard:function(e,n,t){return this.broker.publish(s,e,null,i.requested,[t],n)},requestCardCreation:function(e,n,t){return this.broker.publish(s,e,null,i.cardCreationRequested,[t],n)},publishCard:function(e,n,t){if(!t){t="*"}return this.broker.publish(s,e,null,i.provided,[t],n)},unregister:function(e){return this.broker.unsubscribe(e,[{channelId:s}]).then(function(){delete this.clients[e];return this.broker.disconnect(e)}.bind(this))},destroy:function(){var e=[];for(var s in this.clients){e.push(this.unregister(s))}return Promise.all(e).then(function(){delete this.broker}.bind(this))}});return a});
//# sourceMappingURL=CardsChannel.js.map