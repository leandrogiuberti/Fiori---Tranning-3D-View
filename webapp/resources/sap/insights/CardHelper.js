/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/ui/model/json/JSONModel","sap/insights/CardsChannel","./utils/BatchHelper","./utils/AppConstants","./utils/UrlGenerateHelper","./utils/CardDndConfig","./utils/InsightsUtils","./utils/HttpClient"],function(e,t,r,i,a,n,s,o,d){"use strict";var c=e.getLogger("sap.insights.CardHelper");const u=sap.ui.require("sap/ushell/Container");function l(e){return a.REPO_BASE_URL+a.CARD_ENTITY_NAME+"('"+e+"')"}function h(e,t){if([a.PUT,a.POST].indexOf(t)===-1){C("Method not supported.")}var r=e["sap.app"].id;var i=t===a.PUT?l(r):a.REPO_BASE_URL+a.CARD_ENTITY_NAME;e={descriptorContent:JSON.stringify(e),id:r};var n=JSON.stringify(e);const s=t===a.PUT?d.put(i,n):d.post(i,n);return s.then(function(e){if(e.error||!e.descriptorContent){C("unexpected error")}return JSON.parse(e.descriptorContent)})}function p(e){var t=e.split(".");if(t[0]!=="user"){C("sap.app.id value should start with user.<id>.")}}function f(e){return d.delete(l(e)).then(function(){return e}).catch(function(e){C("Failed to delete card")})}function g(){var e="sap.insights is not enabled for this system.";try{var t=window["sap-ushell-config"];var r=t.apps.insights.enabled;var i=t.ushell.homeApp.component.name;var a=t.ushell.spaces.enabled;if(r&&i&&a){return Promise.resolve(true)}return Promise.reject(new Error(e))}catch(t){return Promise.reject(new Error(e))}}function C(e){c.error(e);throw new Error(e)}function v(e){var t=false;if(e&&e.parameters&&e.parameters.ibnTarget&&e.parameters.ibnTarget.semanticObject&&e.parameters.ibnTarget.action){t=true}if(e&&e.ibnTarget&&e.ibnTarget.semanticObject&&e.ibnTarget.action){t=true}return t}function m(e){var t=false;if(!e["sap.app"]){c.error("Invalid card manifest. sap.app namespace do not exists.");t=true}if(!t&&!e["sap.app"].id){c.error("Invalid card manifest. sap.app.id do not exists.");t=true}if(!t){p(e["sap.app"].id,false)}if(!t&&!e["sap.app"].type){c.error("Invalid card manifest. sap.app.type do not exists.");t=true}if(!t&&e["sap.app"].type.toLowerCase()!=="card"){c.error("Invalid card manifest. invalid value for sap.app.type, expected card.");t=true}if(!t&&!e["sap.card"]){c.error("Invalid card manifest. sap.card namespace do not exists.");t=true}if(!t&&!e["sap.card"].type){c.error("Invalid card manifest. sap.card.type do not exists.");t=true}var r=["Analytical","List","Table"];if(!t&&r.indexOf(e["sap.card"].type)===-1){c.error("Invalid card manifest. Invalid value for sap.card.type. Supported types: "+r);t=true}if(!t&&!e["sap.insights"]){c.error("Invalid card manifest. sap.insights namespace do not exists.");t=true}if(!t&&!e["sap.insights"].parentAppId){c.error("Invalid card manifest. sap.insights.parentAppId do not exists.");t=true}if(!t&&!e["sap.insights"].cardType){c.error("Invalid card manifest. sap.insights.cardType do not exists.");t=true}if(!t&&e["sap.insights"].cardType!=="RT"){c.error("Invalid card manifest. Invalid value for sap.insights.cardType, supported value is RT");t=true}if(!t&&(!e["sap.insights"].versions||!e["sap.insights"].versions.ui5)){c.error("Invalid card manifest. Invalid value for sap.insights version");t=true}if(!t&&e["sap.insights"].templateName==="OVP"){var i,a,n,s=false,d=e["sap.card"].type;if(d==="Analytical"){i=e["sap.card"].content.actions||[];a=e["sap.card"].header.actions||[];i=i.filter(function(e){return e.type==="Navigation"&&e.parameters&&e.parameters.ibnTarget&&e.parameters.ibnTarget.semanticObject&&e.parameters.ibnTarget.action});a=a.filter(function(e){return e.type==="Navigation"&&e.parameters&&e.parameters.ibnTarget&&e.parameters.ibnTarget.semanticObject&&e.parameters.ibnTarget.action});if(i.length>0||a.length>0){s=true}if(e["sap.card"].configuration.parameters.state&&e["sap.card"].configuration.parameters.state.value){n=JSON.parse(e["sap.card"].configuration.parameters.state.value);s=v(n)}}if(d==="List"||d==="Table"){i=(d==="List"?e["sap.card"].content.item.actions:e["sap.card"].content.row.actions)||[];a=e["sap.card"].header.actions||[];i=i.filter(function(e){return e.type==="Navigation"});a=a.filter(function(e){return e.type==="Navigation"});if(i.length>0||a.length>0){var u={},l={};if(e["sap.card"].configuration.parameters.headerState&&e["sap.card"].configuration.parameters.headerState.value){u=JSON.parse(e["sap.card"].configuration.parameters.headerState.value)}if(e["sap.card"].configuration.parameters.lineItemState&&e["sap.card"].configuration.parameters.lineItemState.value){l=JSON.parse(e["sap.card"].configuration.parameters.lineItemState.value)}var h=v(u),f=v(l);s=h||f}}if(!s){c.error("Invalid card manifest. Card should have navigation.");t=true}}if(t){throw new Error(o.getResourceBundle().getText("invalidManifest"))}}var _;var P={localCardCache:{},userCardModel:(new t).setDefaultBindingMode("OneWay"),userVisibleCardModel:(new t).setDefaultBindingMode("OneWay"),parentAppDetailsCache:{},_oViewCache:{},_mergeCard:function(e,t,r){try{if(!r){m(e)}this.userVisibleCardModel.setProperty("/isLoading",true);return h(e,t).then(function(e){this.localCardCache={};this.userVisibleCardModel.setProperty("/isLoading",false);return e}.bind(this)).catch(function(e){this.userVisibleCardModel.setProperty("/isLoading",false);return Promise.reject(e)}.bind(this))}catch(e){return Promise.reject(e)}},_createCard:function(e,t){return this._mergeCard(e,a.POST,t)},_createCards:function(e){var t=this._getValidCardManifests(e);if(t.length>0){return this._updateMultipleCards(this._getCards(t),a.POST)}return Promise.resolve()},_getValidCardManifests:function(e){return e.filter(function(e){try{m(e);return true}catch(e){return false}})},_getCards:function(e){return e.map(function(e){var t=JSON.parse(JSON.stringify(e));return{id:t["sap.app"].id,descriptorContent:JSON.stringify(t)}})},_updateCard:function(e,t){return this._mergeCard(e,a.PUT,t)},_updateCards:function(e){var t=this._getValidCardManifests(e);if(t.length>0){this.userVisibleCardModel.setProperty("/isLoading",true);return this._updateMultipleCards(this._getCards(t),a.PUT).then(function(e){return e}).catch(function(e){return Promise.reject(e)}).finally(function(){this.userVisibleCardModel.setProperty("/isLoading",false)}.bind(this))}return Promise.resolve()},_deleteCard:function(e){try{p(e)}catch(e){return Promise.reject(e)}this.userVisibleCardModel.setProperty("/isLoading",true);return f(e).then(function(e){this.localCardCache={};this.userVisibleCardModel.setProperty("/isLoading",false);var t=this.userCardModel.getProperty("/cards");var r=t.findIndex(function(t){return t.id===e});if(r>-1){t.splice(r,1)}this.userCardModel.setProperty("/cards",t);return e}.bind(this))},_getUserAllCards:function(){if(this.localCardCache&&this.localCardCache.userCards){return Promise.resolve(this.localCardCache.userCards)}var e=a.CARD_READ_URL+"?$orderby=rank";return this._readCard(e).then(function(e){this.localCardCache.userCards=e;return e}.bind(this))},_getUserAllCardModel:function(){return this._getUserAllCards().then(function(e){var t=e.filter(function(e){return e.visibility});this.userCardModel.setProperty("/cards",e);this.userCardModel.setProperty("/cardCount",e.length);this.userCardModel.setProperty("/visibleCardCount",t.length);return this.userCardModel}.bind(this))},_getUserVisibleCards:function(e){if(this.localCardCache.userVisibleCards){return Promise.resolve(this.localCardCache.userVisibleCards)}var t="";var r="";if(e&&e.length){t=a.CARD_READ_URL+"?$filter=visibility eq true and (";var i=e.length-1;e.forEach(function(e,t){r=t!==i?r+"id eq '"+e+"' or ":r+"id eq '"+e+"'"});t=t+r+")"+a.CARD_SELECT_QUERY}else{t=a.CARD_READ_URL+"?$filter=visibility eq true"+a.CARD_SELECT_QUERY}return this._readCard(t).then(function(e){this.localCardCache.userVisibleCards=e;return e}.bind(this))},_getUserVisibleCardModel:function(e){return this._getUserVisibleCards(e).then(function(e){this.userVisibleCardModel.setProperty("/cards",e);this.userVisibleCardModel.setProperty("/cardCount",e.length);this.userVisibleCardModel.setProperty("/isLoading",false);return this.userVisibleCardModel}.bind(this))},_readCard:function(e){if(e&&(!this._fetchPromise||!this._fetchPromise[e])){this._fetchPromise=this._fetchPromise||{};this._fetchPromise[e]=d.get(e).then(function(e){if(e.error){C("Cannot read user's suggested cards.");return}e.value.forEach(function(e){if(e.descriptorContent){e.descriptorContent=JSON.parse(e.descriptorContent)}});return e.value}).catch(function(e){C("Cannot read user's suggested cards.");return Promise.reject(e)}).finally(function(){this._fetchPromise[e]=null;delete this._fetchPromise[e]}.bind(this))}return this._fetchPromise[e]},_refreshUserCards:function(e){this.userVisibleCardModel.setProperty("/isLoading",true);this.userCardModel.setProperty("/isLoading",true);var t=e?{deleteAllCards:"X"}:{};return new Promise(function(e){d.post(a.REPO_BASE_URL+a.CARD_ENTITY_NAME+"/com.sap.gateway.srvd.ui2.insights_cards_repo_srv.v0001.deleteCards?",JSON.stringify(t)).then(function(t){var r=t.value||[];this.iVisCardCount=0;r.forEach(function(e){if(e.descriptorContent){e.descriptorContent=JSON.parse(e.descriptorContent)}if(e.visibility){this.iVisCardCount++}}.bind(this));this.localCardCache={};this.localCardCache.userCards=r;this.userVisibleCardModel.setProperty("/isLoading",false);return this._getUserAllCardModel().then(function(){this.userCardModel.setProperty("/isLoading",false);e()}.bind(this))}.bind(this))}.bind(this))},getParentAppDetails:function(e){if(this.parentAppDetailsCache[e.descriptorContent["sap.app"].id]){return Promise.resolve(this.parentAppDetailsCache[e.descriptorContent["sap.app"].id])}var t={};var r=e.descriptorContent["sap.insights"].parentAppUrl;if(r){return u.getServiceAsync("URLParsing").then(function(i){var a=i.parseShellHash(r);return u.getServiceAsync("CrossApplicationNavigation").then(function(e){return e.isNavigationSupported([{target:{semanticObject:a.semanticObject,action:a.action},params:a.params}])}).then(function(i){if(i[0].supported){t.semanticObject=a.semanticObject;t.action=a.action;t.semanticURL=r;t.title=e.descriptorContent["sap.app"].title;this.parentAppDetailsCache[e.descriptorContent["sap.app"].id]=t;return Promise.resolve(t)}else{return this._getParentApp(e)}}.bind(this))}.bind(this))}else{return this._getParentApp(e)}},_getParentApp:function(e){var t={};return u.getServiceAsync("ClientSideTargetResolution").then(function(r){var i=r._oAdapter._aInbounds||[];var a=i.find(function(t){return t.resolutionResult&&t.resolutionResult.ui5ComponentName===e.descriptorContent["sap.insights"].parentAppId});if(a){t.semanticObject=a.semanticObject;t.action=a.action;t.semanticURL="#"+a.semanticObject+"-"+a.action;if(a?.signature?.parameters){var n=a.signature.parameters["sap-appvar-id"];if(n?.required&&n?.filter?.value){t.semanticURL=t.semanticURL+"?sap-appvar-id="+n.filter.value}}t.title=e.descriptorContent["sap.app"].title;this.parentAppDetailsCache[e.descriptorContent["sap.app"].id]=t}return t}.bind(this))},_updateMultipleCards:function(e,t){try{return i.createMultipartRequest(e,t).then(function(){this.localCardCache={};return Promise.resolve()}.bind(this)).catch(function(e){return Promise.reject(e)})}catch(e){return Promise.reject(e)}},processSemanticDate:function(e,t){return n.semanticDateProcess(e,t)},handleDndCardsRanking:function(e,t,r){return s.updateCardsRanking(e,t,r)},showCardPreview:function(e,t,r,i,a,n,s){return new Promise(function(o,d){try{if(!e){throw new Error("Card manifest is required for preview")}sap.ui.require(["sap/insights/ManagePreview"],function(d){if(!this._oManagePreviewDialog){this._oManagePreviewDialog=new d({transformation:t,cardMessageInfo:r,confirmButtonText:i,dialogTitle:n,manifest:e})}else{this._oManagePreviewDialog.setTransformation(t);this._oManagePreviewDialog.setCardMessageInfo(r);this._oManagePreviewDialog.setConfirmButtonText(i);this._oManagePreviewDialog.setManifest(e);this._removeAllEventListeners(this._oManagePreviewDialog,"onConfirmButtonPress");this._removeAllEventListeners(this._oManagePreviewDialog,"onCloseButtonPress")}if(a){this._oManagePreviewDialog.attachOnConfirmButtonPress(a)}if(s){this._oManagePreviewDialog.attachOnCloseButtonPress(s)}this._oManagePreviewDialog.openPreviewDialog();o(this._oManagePreviewDialog)}.bind(this))}catch(e){c.error(e.message);d(e.message)}}.bind(this))},resetAddCardInnerContent:function(){this._oManageAddInsightsCardWithSearchDialog.resetDialog(true)},fetchAddCardInnerContent:function(e){return new Promise(function(t,r){try{if(this._oManageAddInsightsCardWithSearchDialog&&this._oManageAddInsightsCardWithSearchDialog.getDialogInnerContent()){this._oManageAddInsightsCardWithSearchDialog.resetDialog();t(this._oManageAddInsightsCardWithSearchDialog.getDialogInnerContent())}else{sap.ui.require(["sap/insights/ManageAddCardWithSearch"],function(r){this._oManageAddInsightsCardWithSearchDialog=new r;const i=this._oManageAddInsightsCardWithSearchDialog.getDialogInnerContent();if(e){this._oManageAddInsightsCardWithSearchDialog.attachOnCardGenerated(e)}t(i)}.bind(this))}}catch(e){c.error(e.message);r(e.message)}}.bind(this))},showAddCardWithSearchDialog:function(e){return new Promise(function(t,r){try{sap.ui.require(["sap/insights/ManageAddCardWithSearch"],function(r){if(!this._oManageAddCardWithSearchDialog){this._oManageAddCardWithSearchDialog=new r}else{this._oManageAddCardWithSearchDialog.resetDialog()}if(e){this._oManageAddCardWithSearchDialog.attachOnAddButtonPress(e)}this._oManageAddCardWithSearchDialog.openDialog();t(this._oManageAddCardWithSearchDialog)}.bind(this))}catch(e){c.error(e.message);r(e.message)}}.bind(this))},_removeAllEventListeners:function(e,t){if(e.hasListeners(t)){e.mEventRegistry[t].forEach(function(r){e.detachEvent(t,r.fFunction,r.oListener)})}},getCardsChannel:function(){if(_){return Promise.resolve(_)}else{return new Promise(function(e){_=new r;_.init().then(function(){e(_)})})}}};return{getServiceAsync:function(){return g().then(function(){return P}).catch(function(e){return Promise.reject(e)})}}});
//# sourceMappingURL=CardHelper.js.map