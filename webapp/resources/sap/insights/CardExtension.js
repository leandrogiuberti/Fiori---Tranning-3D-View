/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 * This extension is for OVP Analytical cards delivered in 2208.
 */
sap.ui.define(["sap/ui/integration/Extension","sap/ui/core/format/NumberFormat","sap/fe/navigation/SelectionVariant","sap/base/Log","sap/ui/core/format/DateFormat","sap/ui/core/library","sap/m/library","sap/ui/integration/util/Utils","sap/m/DynamicDateUtil","sap/fe/navigation/NavError","sap/insights/utils/UrlGenerateHelper","sap/insights/utils/AppConstants","sap/ui/core/date/UI5Date","sap/ui/core/Lib","sap/insights/base/CacheData","sap/insights/utils/InsightsUtils","sap/m/MessageToast","./CardHelper"],function(e,t,r,a,i,n,s,o,f,l,c,u,p,g,m,v,d,h){"use strict";var b=n.ValueState;var S=s.ValueColor;var N={StateValues:{None:"None",Negative:"Error",Critical:"Warning",Positive:"Success"},ColorValues:{None:"Neutral",Negative:"Error",Critical:"Critical",Positive:"Good"}};var O=a.getLogger("sap.insights.CardExtension");var y=m.getInstance();const P="refreshTime";var D=function(e,t){return e&&e.indexOf(t,e.length-t.length)!==-1};var C=function(e,t){var r;if(t){r=t.None;if(e&&e.EnumMember){var a=e.EnumMember;if(D(a,"Negative")){r=t.Negative}else if(D(a,"Critical")){r=t.Critical}else if(D(a,"Positive")){r=t.Positive}}}return r};var I=function(e,t,r,a,i,n,s){var o={};o.EnumMember="None";var f=Number.NEGATIVE_INFINITY;var l=Number.POSITIVE_INFINITY;if(!i&&i!==0&&(r||r===0)){i=r}if(!n&&n!==0&&(a||a===0)){n=a}if(!r&&r!==0){r=f}if(!a&&a!==0){a=l}if(e!==undefined){e=Number(e);if(D(t,"Minimize")||D(t,"Minimizing")){if((n||n===0)&&(a||a===0)){if(e<=parseFloat(n)){o.EnumMember="Positive"}else if(e>parseFloat(a)){o.EnumMember="Negative"}else{o.EnumMember="Critical"}}}else if(D(t,"Maximize")||D(t,"Maximizing")){if((i||i===0)&&(r||r===0)){if(e>=parseFloat(i)){o.EnumMember="Positive"}else if(e<parseFloat(r)){o.EnumMember="Negative"}else{o.EnumMember="Critical"}}}else if(D(t,"Target")){if((n||n===0)&&(a||a===0)&&(i||i===0)&&(r||r===0)){if(e>=parseFloat(i)&&e<=parseFloat(n)){o.EnumMember="Positive"}else if(e<parseFloat(r)||e>parseFloat(a)){o.EnumMember="Negative"}else{o.EnumMember="Critical"}}}}return C(o,s)};var F=function(e,t,r,a){if(!e||!t){return}e=Number(e);if(!a&&e-t>=0){return"Up"}if(!r&&e-t<=0){return"Down"}if(t&&a&&e-t>=a){return"Up"}if(t&&r&&e-t<=r){return"Down"}};var w=function(e,r,a){var i=r||{},n=e;var s=t.getFloatInstance({minFractionDigits:i.NumberOfFractionalDigits,maxFractionDigits:i.NumberOfFractionalDigits,style:"short",showScale:true,shortRefNumber:n});var o=s.format(Number(n)),f=s.getScale()||"";if(!a&&o){var l=o[o.length-1];return l===f?o.slice(0,o.length-1):o}if(a&&i.percentageAvailable){return f+"%"}if(a&&!i.percentageAvailable){return f}return""};var E=function(){var e=this.getCard().getCombinedParameters();return e._headerDataUrl};var M=function(){var e=this.getCard().getCombinedParameters();return e._contentDataUrl};var T=function(e,r,a){var i,n,s;if(isNaN(+e)){return""}if(e==0){s=r}else{s=e}if(a.NumberOfFractionalDigits){n=+a.NumberOfFractionalDigits}if(r){i=r}else if(a.manifestTarget){i=a.manifestTarget}if(!n||n<0){n=0}else if(n>2){n=2}if(i){var o=t.getFloatInstance({minFractionDigits:n,maxFractionDigits:n,style:"short",showScale:true,shortRefNumber:s});return o.format(+i)}};var V=function(e,r,a){var i,n;if(isNaN(+e)){return""}e=+e;if(a.NumberOfFractionalDigits){i=+a.NumberOfFractionalDigits}if(r){n=+r}else if(a.manifestTarget){n=+a.manifestTarget}if(!i||i<0){i=0}else if(i>2){i=2}if(n){var s=(e-n)/n;var o=t.getPercentInstance({style:"short",minFractionDigits:i,maxFractionDigits:i,showScale:true});return o.format(s)}};var x=function(e){var t={};t.EnumMember="None";if(Number(e)===1){t.EnumMember="Negative"}else if(Number(e)===2){t.EnumMember="Critical"}else if(Number(e)===3){t.EnumMember="Positive"}return C(t,N.ColorValues)};var U=function(){var e=arguments[arguments.length-1];var t=1;return I(arguments[0],e.sImprovementDirection,e.bIsDeviationLowBinding?arguments[t++]:e.deviationLow,e.bIsDeviationHighBinding?arguments[t++]:e.deviationHigh,e.bIsToleranceLowBinding?arguments[t++]:e.toleranceLow,e.bIsToleranceHighBinding?arguments[t++]:e.toleranceHigh,e.oCriticalityConfigValues)};var A=function(){var e=arguments[arguments.length-1];var t=1;return F(arguments[0],e.bIsRefValBinding?arguments[t++]:e.referenceValue,e.bIsDownDiffBinding?arguments[t++]:e.downDifference,e.bIsUpDiffBinding?arguments[t++]:e.upDifference)};var R=function(e){var t;var r=arguments[arguments.length-1],a=r&&r.propertyType;switch(a){case"yearmonth":var i=parseInt(e.substr(0,4),10),n=e.substr(4),s=parseInt(n,10)-1;t=p.getInstance(Date.UTC(i,s));break;case"yearquarter":var i=parseInt(e.substr(0,4),10),o=e.substr(4),f=parseInt(o,10)*3-2,s=f-1;t=p.getInstance(Date.UTC(i,s));break;case"yearweek":var i=parseInt(e.substr(0,4),10),l=e.substr(4),c=1+(parseInt(l,10)-1)*7;t=p.getInstance(Date.UTC(i,0,c));break;default:break}return t};var L=function(e,t){if(e){var r=o.parseJsonDateTime(e);return i.getInstance(t).format(p.getInstance(r),t.bUTC)}};var _=function(e){if(e){var r=t.getIntegerInstance({minFractionDigits:0,maxFractionDigits:1,decimalSeparator:".",style:"short"});return r.format(Number(e))}};var H=function(){var e=arguments[0],r=arguments[1],a=Number(arguments[2]),i=arguments[3];var n=t.getCurrencyInstance({style:"short",showMeasure:true,shortRefNumber:e.scaleFactor,minFractionDigits:e.numberOfFractionalDigits,maxFractionDigits:e.numberOfFractionalDigits});var s=n.format(a,i);if(!r){return s}else{var o=arguments[arguments.length-1];return s+" ("+o+")"}};var J=function(e,r,a,i,n){var s;if(e){e.maxFractionDigits=e.numberOfFractionalDigits||0;e.minFractionDigits=e.numberOfFractionalDigits||0;e.style=e.style||"short";e.showScale=e.showScale||true;e.shortRefNumber=e.scaleFactor;s=t.getFloatInstance(e)}var o=[];if(!isNaN(parseFloat(a))&&s){o.push(s.format(a))}else{o.push(a)}if(!isNaN(parseFloat(i))&&s){o.push(s.format(i))}else{o.push(i)}if(!isNaN(parseFloat(n))&&s){o.push(s.format(n))}else{o.push(n)}var f="";if(r&&r.length){r.forEach(function(e){if(typeof e==="number"){f=f+o[e]}else{f=f+e}})}return f};var k=function(e,t){if(t==="state"){switch(String(e)){case"1":case"Error":return b.Error;case"2":case"Warning":return b.Warning;case"3":case"Success":return b.Success;default:return b.None}}if(t==="color"){switch(String(e)){case"1":case"Error":return S.Error;case"2":case"Critical":return S.Critical;case"3":case"Good":return S.Good;default:return S.Neutral}}};var B=function(e,t,r){var a;if(r&&r.indexOf("sap.ui.model.odata.v4.ODataModel")>-1){a=this.getCard().getModel().getProperty("/content/value")||this.getCard().getModel().getProperty("/value")||[]}else{a=this.getCard().getModel().getProperty("/content/d/results")||this.getCard().getModel().getProperty("/d/results")||[]}var i=a.map(function(t){return t[e]});if(i.indexOf("0")===-1){i.push(0)}return Math[t].apply(Math,i)};var j=function(e,t,r){var a=1;var i=2;var n=4;for(var s in e){if(e.hasOwnProperty(s)){var o=e[s];if(o instanceof Date){o=o.toJSON()}else if(Array.isArray(o)||o&&typeof o==="object"){o=JSON.stringify(o)}else if(typeof o==="number"||typeof o==="boolean"){o=o.toString()}if(o===""){if(r&a){O.info("Semantic attribute "+s+" is an empty string and due to the chosen Suppression Behiavour is being ignored.");continue}}if(o===null){if(r&i){throw new O.error("NavigationHandler.INVALID_INPUT")}else{O.warning("Semantic attribute "+s+" is null and ignored for mix in to selection variant");continue}}if(o===undefined){if(r&n){throw new O.error("NavigationHandler.INVALID_INPUT")}else{O.warning("Semantic attribute "+s+" is undefined and ignored for mix in to selection variant");continue}}if(typeof o==="string"||o instanceof String){t.addSelectOption(s,"I","EQ",o)}else{throw new O.error("NavigationHandler.INVALID_INPUT")}}}return t};var G=function(e,t,a){var i=new r(t);var n=new r;if(i.getFilterContextUrl()){n.setFilterContextUrl(i.getFilterContextUrl())}if(i.getParameterContextUrl()){n.setParameterContextUrl(i.getParameterContextUrl())}if(Array.isArray(e)){e.forEach(function(e){j(e,n,a)})}else{j(e,n,a)}var s=i.getParameterNames();var o;for(o=0;o<s.length;o++){if(!n.getSelectOption(s[o])){n.addSelectOption(s[o],"I","EQ",i.getParameter(s[o]))}}var f=i.getSelectOptionsPropertyNames();for(o=0;o<f.length;o++){var l=i.getSelectOption(f[o]);if(!n.getSelectOption(f[o])){for(var c=0;c<l.length;c++){n.addSelectOption(f[o],l[c].Sign,l[c].Option,l[c].Low,l[c].High)}}}return n};function Q(e){if(e){if(e.hasOwnProperty("SelectionVariantID")){delete e.SelectionVariantID}else if(e.hasOwnProperty("PresentationVariantID")){delete e.PresentationVariantID}delete e.Text;delete e.ODataFilterExpression;delete e.Version;delete e.FilterContextUrl;delete e.ParameterContextUrl;return e}return e}var q=function(e){try{if(JSON.parse(e)){return true}}catch(e){return false}};var z=function(e){var t=e&&e.length===1,r=e&&e[0];return t&&r["Option"]==="EQ"&&!r["High"]&&r["Low"]&&r["Sign"]==="I"};function W(e,t){var a=this.getCard().getManifestEntry("sap.card"),i=a&&a.configuration.parameters,n=new r,s=i._relevantODataFilters.value||[];e=e&&JSON.parse(e);var o=e&&e.sensitiveProps,f=a&&a.header.actions[0].parameters.ibnParams,l=a&&a.content.actions[0].parameters.ibnParams;s.forEach(function(e){var t=q(i[e].value);if(t&&!(o&&o[e])){var r=JSON.parse(i[e].value);var a=r.SelectOptions.Ranges;if(a&&a.length){var s=z(a);if(f[e]&&l[e]){if(s){f[e]=a[0].Low;l[e]=a[0].Low}else if(!s){delete l[e];delete f[e];n.massAddSelectOption(e,a)}}else{n.massAddSelectOption(e,a)}}}});if(t){var c=Object.keys(t)||[];for(var u=0;u<c.length;u++){if(o&&o[c[u]]||c[u]==="__metadata"){delete t[c[u]]}}var p=G(t,n&&n.toJSONObject());p=Q(p.toJSONObject());e.selectionVariant=p}if(e&&e.sensitiveProps){delete e.sensitiveProps}return JSON.stringify(e)}var $=function(e){if(typeof e!=="string"){return false}var t=/^(\/)?Date\(\d+\)(\/)?$/;return t.test(e)};var Y=function(e){var t=i.getDateInstance({pattern:"''yyyy-MM-dd'T'HH:mm:ss.SSS'Z'''",calendarType:"Gregorian"});if(e){var r=t.format(e,true);return String(r).replace(/'/g,"")}};var Z=function(e){var t=i.getDateInstance({pattern:"''yyyy-MM-dd'T'HH:mm:ss.SSS''",calendarType:"Gregorian"});var r=e instanceof Date?e:p.getInstance(e);var a=t.format(r);return String(a).replace(/'/g,"")};function K(e,t,r,a,i,n){var s=f.toDates(e)||[];var o=s[0]&&s[0].oDate;var l=s[1]&&s[1].oDate;var c="",u="";if(a["sap:filter-restriction"]==="single-value"){if(t==="datetime"){c=Z(o);if(c&&n&&n.ibnParams){n.ibnParams[r]=c}}else if(t==="string"){c=Y(o);if(c&&n&&n.ibnParams){n.ibnParams[r]=c}}i.massAddSelectOption(r,[{Sign:"I",Option:"EQ",Low:c,High:null}])}else if(a["sap:filter-restriction"]==="interval"){if(t==="datetime"){c=Z(o);u=Z(l);if(c&&u){i.massAddSelectOption(r,[{Sign:"I",Option:"BT",Low:c,High:u}])}}else if(t==="string"){c=Y(o);u=Y(l);if(c&&u){i.massAddSelectOption(r,[{Sign:"I",Option:"BT",Low:c,High:u}])}}}}function X(e){var t={};var a;if(typeof e==="string"){a=new r(e)}else if(typeof e==="object"){a=e}else{throw new l("NavigationHandler.INVALID_INPUT")}var i=a.getSelectOptionsPropertyNames();for(var n=0;n<i.length;n++){var s=a.getSelectOption(i[n]);if(s.length===1&&s[0].Sign==="I"&&s[0].Option==="EQ"){t[i[n]]=s[0].Low}}var o=a.getParameterNames();for(var n=0;n<o.length;n++){var f=a.getParameter(o[n]);t[o[n]]=f}return t}function ee(e,t){var a=this.getCard().getManifestEntry("sap.card"),i=a&&a.configuration.parameters,n=new r,s=i._relevantODataFilters.value||[],o=e&&JSON.parse(e)||{},f=o&&o.parameters,l=f&&f.ibnParams,c=l&&l.sensitiveProps,p=o&&o.sensitiveProps,g=i._semanticDateRangeSetting,m,v=[];if(g){m=JSON.parse(g.value);v=Object.keys(m)||[]}var d={};if(v.length){v.forEach(function(e){var t=i[e]||{};var r=q(t.value)?JSON.parse(t.value):t.value;var a=t.type;var s="";var f=t.description&&JSON.parse(t.description),l=f&&f.operator,g=c&&c[e]||p&&p.includes(e);if(u.DATE_OPTIONS.DATE_LIST.includes(l)&&!g){var v=r&&r.SelectOptions&&r.SelectOptions[0]&&r.SelectOptions[0].Ranges;if(v&&v.length){n.massAddSelectOption(e,v)}else{if(a==="datetime"){s=Z(r)}else if(a==="string"){s=r.toString()}n.massAddSelectOption(e,[{Sign:"I",Option:"EQ",Low:s,High:null}])}}else if(l&&!g){K(f,a,e,m[e],n,o)}})}i._relevantODataParameters.value.forEach(function(e){var t=c&&c[e]||p&&p.includes(e);if(i[e]&&i[e].value&&!v.includes(e)&&!t){if(l){l[e]=i[e].value}else if(o&&o.ibnParams){o.ibnParams[e]=i[e].value}n.massAddSelectOption(e,[{Sign:"I",Option:"EQ",Low:i[e].value,High:null}])}});s.forEach(function(e){var t=q(i[e].value);if(t&&v.indexOf(e)===-1&&(c&&!c[e]||p&&!p.includes(e))){var r=JSON.parse(i[e].value);var a=r.SelectOptions&&r.SelectOptions.Ranges||r.SelectOptions&&r.SelectOptions[0]&&r.SelectOptions[0].Ranges;if(a&&a.length){var s=z(a);if(s){if(l){l[e]=a[0].Low}else if(o&&o.ibnParams){o.ibnParams[e]=a[0].Low}}else{if(l&&l[e]&&!s){delete l[e]}}n.massAddSelectOption(e,a)}}});var h=t||{};var b=Object.keys(h)||[];for(var S=0;S<b.length;S++){if(c&&c[b[S]]||p&&p.includes(b[S])||b[S]==="__metadata"){delete h[b[S]]}}var N=b.filter(function(e){return v.includes(e)});N.forEach(function(e){var t=h[e];if($(t)){var r=n?.getSelectOption(e);if(r?.length&&r[0].Low){h[e]=r[0].Low}}});var O=G(h,n&&n.toJSONObject());var y=X(O);O=Q(O.toJSONObject());if(l&&l.presentationVariant){d["presentationVariant"]=l.presentationVariant}else if(o&&o.ibnParams&&o.ibnParams.presentationVariant){d["presentationVariant"]=o.ibnParams.presentationVariant}if(O.Parameters.length||O.SelectOptions.length){d["selectionVariant"]=O}if(f&&!f.ibnParams){f.ibnParams={}}if(d["selectionVariant"]||d["presentationVariant"]){if(f&&f.ibnParams){f.ibnParams["sap-xapp-state-data"]=JSON.stringify(d)}else if(o&&o.ibnParams){o.ibnParams["sap-xapp-state-data"]=JSON.stringify(d)}}if(l&&l.sensitiveProps){delete l.sensitiveProps}if(o&&o.sensitiveProps){delete o.sensitiveProps}for(var P in y){if(f&&f.ibnParams){f.ibnParams[P]=y[P]}else if(o&&o.ibnParams){o.ibnParams[P]=y[P]}}if(l){delete l.selectionVariant;delete l.presentationVariant}if(o&&o.ibnParams&&o.ibnParams.presentationVariant){delete o.ibnParams.presentationVariant}return o.parameters?o.parameters:o}function te(){var e={descriptorContent:{}};e.descriptorContent=this.getCard().getManifestEntry("/");var t=ie(e,"header");return t}function re(){var e={descriptorContent:{}};e.descriptorContent=this.getCard().getManifestEntry("/");var t=e.descriptorContent["sap.card"]["configuration"]["csrfTokens"]["token1"].data.request.url;var r=ie(e,"content");if(e.descriptorContent["sap.card"]["data"]["request"]&&e.descriptorContent["sap.card"]["data"]["request"]["batch"]){return r}return t+"/"+r}function ae(e,t){if(e&&t){return`${e} (${t})`}else{return e||t||""}}function ie(e,t){var r=c.processPrivateParams(e,null,true);if(t==="header"&&r.header){return r.header}else if(t==="content"&&r.content){return r.content}}function ne(){var e=window["sap-ushell-config"],t=e&&e.ushell,r=t&&t.homeApp;return!!r}function se(e){return e.method==="HEAD"}function oe(e,t){var r=t.getManifest();if(!r["sap.insights"].error){e.text().then(function(e){var t=JSON.parse(JSON.stringify(v.getDataFromRawValue(e)[0])||e);if(t.error&&u.ERROR_CODES.includes(t.error.code)){r["sap.insights"].visible=false;r["sap.insights"].error=true;h.getServiceAsync().then(function(e){e._updateCard(r,true).then(function(){e._getUserVisibleCardModel();d.show(v.getResourceBundle().getText("INT_CARD_RELOAD_ERROR",[r["sap.card"].header.title]))})})}})}}function fe(e,t){const r={};if(t){r["/sap.card/header/dataTimestamp"]=t}if(e.getManifestEntry("sap.card").type==="List"){r["/sap.card/content/item/actionsStrip"]=e.getManifestEntry("sap.card").content.item.actionsStrip||[]}e.setManifestChanges([r])}var le=e.extend("sap.insights.CardExtension",{init:function(){e.prototype.init.apply(this,arguments);e.prototype.setFormatters.apply(this,[{kpiformatter:w,formatHeaderUrl:E.bind(this),formatContentUrl:M.bind(this),returnPercentageChange:V,targetValueFormatter:T,kpiValueCriticality:x,formatValueColor:U,formatTrendIcon:A,formatDateValue:R,addPropertyValueToAppState:W.bind(this),getNavigationContext:ee.bind(this),formatDate:L,formatNumber:J,formatCurrency:H,formatHeaderCount:_,formatCriticality:k,getMinMax:B.bind(this),formatHeaderDataUrlForSemanticDate:te.bind(this),formatContentDataUrlForSemanticDate:re.bind(this),formatWithBrackets:ae.bind(this)}])},loadDependencies:function(){var e=this.getCard(),t=e.getManifestEntry("/sap.card/type"),r=[];if(!ne()){r.push(new Promise(function(e){sap.ui.require(["sap/insights/HandleNonS4Environment"],function(t){t.initialize(this);e()}.bind(this))}.bind(this)))}if(t==="Analytical"){r.push(g.load({name:"sap.viz"}).then(function(){return new Promise(function(e){sap.ui.require(["sap/insights/OVPChartFormatter"],function(t){t.registerCustomFormatters();e()})})}))}return Promise.all(r)}});le.prototype.addFormatters=function(e,t){if(!e||e===""){a.error("Namespace missing.");return this}var r=this.getProperty("formatters");r[e]=t;return this.setFormatters(r)};le.prototype.setFormatters=function(){a.error("Use of setFormatters is prohibited, instead use addFormatters method.");return this};le.prototype._fetchData=function(t,r,a){var i=this._oCard;var n=i.getManifestEntry("sap.app").id;return e.prototype.fetch.call(this,t,r,a).then(function(e){y.setCacheResponse(n,t,e);y.setCacheResponse(n,P,new Date);var r=y.getCacheResponse(n);fe(i,r[P]);oe(e,i);return r[t]}).catch(function(e){var r={error:e.toString()};var a=new Response(JSON.stringify(r),{headers:{"Content-Type":"application/json"}});y.setCacheResponse(n,t,a);y.setCacheResponse(n,P,new Date);var i=y.getCacheResponse(n);return i[t]})};le.prototype.fetch=function(t,r,a){var i=this._oCard;var n=i.getManifest();const s=n["sap.insights"]?.cacheType;if(s==="fetchDataFromHost"||typeof n==="string"){return e.prototype.fetch.call(this,t,r,a)}else{var o=n["sap.app"].id;if(!y){y=m.getInstance()}var f=y.getCacheResponse(o);var l=y.getTempPromise(o);if(!f){f=y.setCacheResponse(o,null,{})}if(!l){l=y.setTempPromise(o,null,{})}if(se(a)){return e.prototype.fetch.call(this,t,r,a)}else if(!f[t]&&!l[t]){l=y.setTempPromise(o,t,this._fetchData(t,r,a));return l[t]}else if(!f[t]&&l[t]){return l[t].then(function(e){oe(e,i);return e})}else{return new Promise(function(e){if(i.getManifestChanges()&&!i.getManifestChanges().length){fe(i,f[P])}oe(f[t],i);e(f[t])})}}};return le});
//# sourceMappingURL=CardExtension.js.map