/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/core/Item","sap/ui/core/Icon","sap/m/Title","sap/m/Text","sap/m/VBox","sap/m/Page","sap/m/FlexBox","sap/m/ComboBox","sap/m/ScrollContainer","sap/m/Toolbar","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/m/HBox","sap/m/Panel","sap/m/Button","sap/m/Table","sap/m/Column","sap/m/ColumnListItem","sap/m/ObjectIdentifier","sap/m/SearchField","sap/ui/Device","sap/ui/integration/widgets/Card","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","../utils/CardPreviewManager","../utils/DeviceType","../utils/AppConstants","../utils/Transformations","../utils/InsightsUtils"],function(e,t,i,o,r,a,s,n,h,l,d,c,C,p,g,_,f,u,y,v,w,T,P,m,S,H,b,x,M,B,I,D){var V=e.extend("sap.insights.manageCardPreview.HouseOfCards",{metadata:{properties:{manifest:{type:"string",group:"Behavior",defaultValue:""},dialogTitle:{type:"string",defaultValue:""}},aggregations:{_page:{type:"sap.m.Page",multiple:false,visibility:"hidden"}}},renderer:{apiVersion:2,render:function(e,t){e.openStart("div",t);e.style("height","100%");e.style("width","100%");e.openEnd();e.renderControl(t.getAggregation("_page"));e.close("div")}}});V.prototype.init=function(){this.i18Bundle=D.getResourceBundle();this._innerHocModel=new H;if(this._bDesktop){this._bShowPreview=true}else{this._bShowPreview=false}this._createHocFlex();T.resize.attachHandler(this._adjustLayoutStyles.bind(this));this.oCardColumnPageTitle=new o(this.getId()+"--insightHouseOfCardTitle",{text:this.i18Bundle.getText("INT_PREVIEW_POPOVER_BUTTON_TITLE"),level:"H1"});this._oPreviewButton=new _({text:this.i18Bundle.getText("INT_DIALOG_CardPreview"),press:this._callPreview.bind(this)});this._oHidePreviewButton=new _({text:this.i18Bundle.getText("INT_DIALOG_HidePreview"),press:this._callClosePreview.bind(this)});this.oHOCPageHeader=new c(this.getId()+"--insightHouseOfCard-header",{content:[this.oCardColumnPageTitle,new C(this.getId()+"--insightHouseOfCard-headerSpacer"),this._oPreviewButton,this._oHidePreviewButton]});var e=M.getDialogBasedDevice();this._bDesktop=e===B.DEVICE_TYPES.Desktop;this.oParentPage=new s(this.getId()+"--insightHouseOfCardPage",{showSubHeader:true,backgroundDesign:"List",enableScrolling:false,content:[new a(this.getId()+"--hocbox1",{height:"100%",width:"100%",direction:"Row",justifyContent:"SpaceBetween",items:[this._oHocflexbox1,this._oHocflexbox2]})],customHeader:[this.oHOCPageHeader]});this._innerHocModel.setData({oSelected:{},aCards:[],aPreviewCards:[1,2,3],aAllowedChartTypes:[],sOriginalChartType:"",selectedPath:""});this.oConfCard=null;this.oParentPage.setModel(this._innerHocModel,"hocModel");this.setAggregation("_page",this.oParentPage)};V.prototype.onBeforeRendering=function(){this._oManifest=this.getManifest();if(this._oManifest){this._oManifest=JSON.parse(this._oManifest)}this.oConfCard=this._oManifest;this._innerHocModel.setProperty("/oSelected",this._oManifest);this._oHocChartCombo.bindAggregation("items",{path:"hocModel>/aPreviewCards",template:new t({key:"{hocModel>sap.card/content/chartType}",text:{parts:[{path:"hocModel>sap.card/content/chartType"},{value:"title"}],formatter:this._setChartDetail}})});this._oCardsTypeTable.bindAggregation("items",{path:"hocModel>/aPreviewCards",template:new y({type:"Active",selected:"{= ${hocModel>sap.card/content/chartType} ===   ${hocModel>/oSelected/sap.card/content/chartType} ? true : false}",cells:[new p({items:[new i({src:{parts:[{path:"hocModel>sap.card/content/chartType"},{value:"icon"}],formatter:this._setChartDetail}})]}).addStyleClass("sapUiNoPadding"),new v({title:{parts:[{path:"hocModel>sap.card/content/chartType"},{value:"title"}],formatter:this._setChartDetail},tooltip:"{hocModel>sap.card/content/chartType}"}).addStyleClass("sapUiNoPadding")]})});this._oCardContainer.bindAggregation("items",{path:"hocModel>/aPreviewCards",template:new P({width:"17rem",height:"29.5rem",manifest:"{= ${hocModel>}}",host:"HouseOfCardsHost",manifestReady:this._onCardRender.bind(this)}).addStyleClass("sapUiSmallMarginBegin sapUiTinyMarginTopBottom")});this._adjustLayoutStyles()};V.prototype._createHocFlex=function(){this._oCardContainer=new a("CardContainer",{fitContainer:true,alignItems:"Start",justifyContent:"Start",renderType:"Bare",alignContent:"Start",wrap:"Wrap",width:"100%",direction:"Row"});this._oHoCScrollContainer=new l("idHoCScrollContainer",{vertical:true,horizontal:false,height:"100%",width:"100%",content:[this._oCardContainer]});this._oHocChartCombo=new h("hocChartCombo",{ariaLabelledBy:"previewChartInfoTitle previewChartInfoSubTitle hocChartCombo",maxWidth:"33%",selectionChange:this._onSelectionChange.bind(this)}).addStyleClass("sapUiSmallMarginBegin sapUiTinyMarginTopBottom");this._oCardContainerFlex=new n(this.getId()+"--cardContainerFlex",{renderType:"Bare",height:"100%",direction:"Column",items:[new a("chartSelectVBox",{direction:"Column",items:[new o("previewChartInfoTitle",{text:this.i18Bundle.getText("INT_CHART_TITLE"),level:"H4"}).addStyleClass("sapUiSmallMarginTop"),new r("previewChartInfoSubTitle",{text:this.i18Bundle.getText("INT_CHART_SUBTITLE")})]}).addStyleClass("sapUiSmallMarginBegin"),new n("hocflexbox3",{height:"calc(100% - 4rem)",width:"100%",visible:this._bDesktop,direction:"Column",renderType:"Bare",items:[this._oHocChartCombo,this._oHoCScrollContainer]})]});this._oCardsTypeTable=new f("insightsCardsTypeTable",{width:"90%",fixedLayout:true,mode:"SingleSelectMaster",itemPress:this._onChartTypePress.bind(this),columns:[new u("chartIconColumn",{hAlign:"Center",width:"10%"}),new u("chartTypeNameColumn",{width:"90%"})]}).addStyleClass("sapContrastPlus sapUiSmallMarginBeginEnd");this._oChartTypeSearch=new w("chartTypeSearch",{ariaLabelledBy:"previewChartInfoTitle previewChartInfoSubTitle chartTypeSearch",placeholder:this.i18Bundle.getText("INT_CHART_SEARCH"),width:"90%",liveChange:this._onChartTypeSearch.bind(this)}).addStyleClass("sapUiSmallMarginBegin");this._oPreviewPanelCardContainer=new n("previewPanelCardContainer",{height:"100%",width:"100%",direction:"Column",renderType:"Bare",items:[this._oChartTypeSearch,new l("insightsCardsTypeScroll",{vertical:true,horizontal:false,height:"94%",width:"100%",content:[this._oCardsTypeTable]}).addStyleClass("sapUiTinyMarginTop")]});this._oPreviewCardHoCSD=new P("previewCardHoCSD",{manifest:"{hocModel>/oSelected}",width:"19rem",height:"33rem"}).addStyleClass("sapUiTinyMarginBeginEnd");this._oPreviewCardHoCVBox=new a("previewCardHoCVBox",{height:"100%",width:"100%",alignItems:"Center",backgroundDesign:"Solid",items:[this._oPreviewCardHoCSD]}).addStyleClass("sapUiSmallMarginTop sapUiTinyMarginBottom");this._oPanelFlexHoC=new n("panelFlexHoC",{height:"100%",width:"100%",renderType:"Bare",justifyContent:"Center",items:[new l("hoCCardsScrollSD",{vertical:true,horizontal:false,height:"100%",content:[this._oPreviewCardHoCVBox]})]});this._oPanelFlexCard=new n(this.getId()+"--panelFlexCard",{width:"100%",height:"calc(100% - 3rem)",direction:"Column",renderType:"Bare",items:[this._oPreviewPanelCardContainer,this._oPanelFlexHoC]});this._oPreviewCardHoC=new P("previewCardHoC",{manifest:"{ path: 'hocModel>/oSelected', mode: 'TwoWay' }",manifestApplied:this._setPreviewCardAriaText.bind(this),host:"HouseOfCardsHost",width:"19rem",height:"33rem"});var e=new g("hocPreviewPanelContainer",{expanded:false,height:"100%",backgroundDesign:"Transparent",headerToolbar:[new d("hocPreviewToolBar",{width:"100%",height:"2.7rem",style:"Clear",design:"Auto",content:[new p("hocPreviewCardTextHBox",{width:"100%",justifyContent:"Start",backgroundDesign:"Transparent",items:[new o("hocInsightPreviewCardText",{text:this.i18Bundle.getText("INT_DIALOG_TITLE_CardPreview"),textAlign:"Left"}).addStyleClass("sapUiTinyMarginTop")]})]}).addStyleClass("sapThemeBaseBG")],content:[new a("hocCardsPreviewVBox1",{height:"calc(100% - 2.8rem)",alignItems:"Center",backgroundDesign:"Transparent",justifyContent:"SpaceAround",items:[this._oPreviewCardHoC]})]});this._oHocflexbox1=new n(this.getId()+"--hocflexbox1",{height:"100%",width:"100%",direction:"Column",justifyContent:"Center",items:[this._oCardContainerFlex,this._oPanelFlexCard]});this._oHocflexbox2=new n("hocflexbox2",{direction:"Column",width:"38%",height:"100%",renderType:"Bare",fitContainer:true,items:[new l("hoCCardsScroll",{vertical:true,horizontal:false,height:"100%",content:[e]})]}).addStyleClass("sapMPageBgStandard")};V.prototype._onChartTypeSearch=function(e){var t="";if(e){t=e.getSource().getValue()}var i=new m("sap.card/content/chartType",S.Contains,t);var o=[];o.push(i);var r=this._oCardsTypeTable.getBinding("items");if(r){r.filter(o,"Application")}};V.prototype._setChartDetail=function(e,t){var i=B.CHART_TYPE_DETAILS;if(t==="icon"&&e){return i[e]?i[e].icon:i["default"].icon}if(t==="title"&&e){return i[e]?i[e].title:e.replaceAll("_"," ")}};V.prototype._setPreviewCardAriaText=function(e){var t=e.getSource()._ariaText.getText();var i=this.i18Bundle.getText("INT_DIALOG_TITLE_CardPreview");e.getSource()._ariaText.setText(i+t)};V.prototype._onSelectionChange=function(e){var t=e.getParameters();var i=t.selectedItem;var o=i&&i.getBindingContext("hocModel").getPath();this._onClickFunction(null,o)};V.prototype._onCardLoadFailure=function(e){var t=this._oManifest["sap.card"].content.chartType;var i=e.getManifest()["sap.card"].content.chartType;if(i!==t){var o=this._oCardContainer.removeItem(e.sId);if(o){o.destroy()}}};V.prototype._onCardStateChanged=function(e){var t=e.getAggregation("_content")&&e.getAggregation("_content").getAggregation("_content");if(t&&t.attachRenderComplete){t.attachRenderComplete(function(t){var i=t.getSource()._errorType;if(i){var o=this._oCardContainer.removeItem(e.sId);if(o){o.destroy()}}}.bind(this))}var i=e.getManifest()["sap.card"].content.chartType;var o=this._innerHocModel.getProperty("/sOriginalChartType");if(!x.hasVizData(e)&&i!==o){var r=this._innerHocModel.getProperty("/aPreviewCards");var a=r.findIndex(function(e){return e["sap.card"].content.chartType===i});if(a>-1){var s=this._oCardContainer.removeItem(a);if(s){s.destroy()}r.splice(a,1);this._innerHocModel.setProperty("/aPreviewCards",r)}}};V.prototype._callPreview=function(){var e=this._bDesktop?this._oPreviewCardHoC:this._oPreviewCardHoCSD;this._bShowPreview=true;if(e){e.refresh()}this._adjustLayoutStyles()};V.prototype._callClosePreview=function(){this._bShowPreview=false;this._adjustLayoutStyles()};V.prototype._setFocusOnElement=function(){if(this._bDesktop){this._oHocChartCombo.focus()}else{this._oChartTypeSearch.focus()}};V.prototype._onCardRender=function(e){var t=e.getSource();t.attachManifestApplied(function(e){var t=e.getSource();var i=this._oCardContainer.getItems();i.forEach(function(e){if(e.getBindingContext("hocModel")){var i=e.getBindingContext("hocModel").getPath();if(this._innerHocModel.getProperty("/selectedPath")===i&&e.sId===t.sId){e.addStyleClass("sapThemeHighlight-asBorderColor");e.focus()}}}.bind(this));if(t.getCardHeader()){var o=t.getCardHeader();o.addStyleClass("sapFCardHeaderToolbarFocused")}t.attachEvent("_error",this._onCardLoadFailure.bind(this,t));t.attachEvent("stateChanged",this._onCardStateChanged.bind(this,t))}.bind(this));var i=t.getDomRef();i.removeEventListener("click",this._onClickFunction.bind(this,t));i.addEventListener("click",this._onClickFunction.bind(this,t),{capture:true})};V.prototype._onClickFunction=function(e,t){var i;var o=this._oCardContainer.getItems();var r=this._innerHocModel.getProperty("/selectedPath");o.forEach(function(o){if(o.getBindingContext("hocModel")){var a=o.getBindingContext("hocModel").getPath();if(t&&!e&&a===t){e=o}if(a===r&&r!==t){i=o}}});if(this._oCardContainer.getItems()[0].hasStyleClass("sapThemeHighlight-asBorderColor")){this._oCardContainer.getItems()[0].removeStyleClass("sapThemeHighlight-asBorderColor")}else if(i){i.removeStyleClass("sapThemeHighlight-asBorderColor")}if(e){setTimeout(function(){e.addStyleClass("sapThemeHighlight-asBorderColor")},0);this._oHoCScrollContainer.scrollToElement(e);this._oHocChartCombo.focus();var a=e.getBindingContext("hocModel").getPath();this._innerHocModel.setProperty("/selectedPath",a);var s=a.split("/");var n=s[s.length-1];var h=this._innerHocModel.getProperty("/aCards/"+n);this._innerHocModel.setProperty("/oSelected",e.getManifest());if(this.oConfCard){this.oConfCard=h;this._oPreviewCardHoC.refresh()}this._oHocChartCombo.setSelectedKey(e.getManifest()["sap.card"].content.chartType)}};V.prototype._onChartTypePress=function(e){var t=e.getParameter("listItem");if(t.getBindingContext("hocModel")){var i=t.getBindingContext("hocModel").getPath();var o=this._innerHocModel.getProperty(i);var r;var a=this._oCardContainer.getItems();var s=this._innerHocModel.getProperty("/selectedPath");a.forEach(function(e){if(e.getBindingContext("hocModel")){var t=e.getBindingContext("hocModel").getPath();if(t===s&&s!==i){r=e}}});if(r){r.removeStyleClass("sapThemeHighlight-asBorderColor")}this._innerHocModel.setProperty("/oSelected",o);this._innerHocModel.setProperty("/selectedPath",i);var n=i.split("/");var h=n[n.length-1];var l=this._innerHocModel.getProperty("/aCards/"+h);if(this.oConfCard){this.oConfCard=l;this._oPreviewCardHoCSD.refresh()}this._oHocChartCombo.setSelectedKey(o["sap.card"].content.chartType)}};V.prototype.showHouseOfCardsDialog=function(){var e=this.getManifest();if(e){e=JSON.parse(e)}this._oManifest=e;if(this._bDesktop){this._bShowPreview=true}else{this._bShowPreview=false}if(!Object.keys(this._innerHocModel.getProperty("/oSelected")).length){this._innerHocModel.setProperty("/selectedPath","");if(this._oChartTypeSearch){this._oChartTypeSearch.setValue("");this._onChartTypeSearch()}this._createHouseOfCards()}else if(this._innerHocModel.getProperty("/selectedPath")){this._setBorderStyleSelectedCard(this._innerHocModel.getProperty("/selectedPath"))}};V.prototype._setBorderStyleSelectedCard=function(e){var t=this._oCardContainer.getItems();var i;t.forEach(function(t){if(t.getBindingContext("hocModel")){var o=t.getBindingContext("hocModel").getPath();if(e&&!i&&o===e){i=t}}});if(i){setTimeout(function(){i.addStyleClass("sapThemeHighlight-asBorderColor")},0);i.focus()}};V.prototype.getChartTypeSearch=function(){return this._oChartTypeSearch};V.prototype._createHouseOfCards=function(){var e=this._oManifest;var t=e["sap.card"].content.chartType;this._innerHocModel.setProperty("/sOriginalChartType",t);this._innerHocModel.setProperty("/aCards",[]);this._innerHocModel.setProperty("/aPreviewCards",[]);var i=JSON.parse(JSON.stringify(e));var o=i["sap.card"];var r=this._oCardContainer.getMetadata().getDefaultAggregation();var a=[],s=[];var n;this._oCardContainer.removeAllAggregation(r.name);if(o.type==="Analytical"){var h=e["sap.insights"].allowedChartTypes;var l=[];if(h){this._innerHocModel.setProperty("/aAllowedChartTypes",h);l=h.map(function(e){return e.key});var d=l.filter(function(e){return!!e});if(d.length===0){l=h.map(function(e){return e.chart})}}a=I.transformAnalyticalManifest(i,l)}a=a.filter(function(e){return!!e});if(a.length===0){a.push(i)}else{var c=a.findIndex(function(e){return e["sap.card"].content.chartType===t});a.splice(c,1);a.unshift(i)}a.forEach(function(e){var t=JSON.parse(JSON.stringify(e));var i=x.getCardPreviewManifest(t);s.push(i)});this._innerHocModel.setProperty("/aCards",a);this._innerHocModel.setProperty("/aPreviewCards",s);if(!this._innerHocModel.getProperty("/selectedPath")){this._oHoCScrollContainer.scrollTo(0);this._oChartTypeSearch.setValue("");this._onChartTypeSearch()}if(!this._innerHocModel.getProperty("/oSelected")||Object.keys(this._innerHocModel.getProperty("/oSelected")).length===0){this._innerHocModel.setProperty("/oSelected",s[0]);if(this.oConfCard){this.oConfCard=a[0]}this._innerHocModel.setProperty("/selectedPath","/aPreviewCards/0")}else{n=this._innerHocModel.getProperty("/oSelected");n["sap.card"].header.title=this.oConfCard["sap.card"].header.title;n["sap.card"].header.subTitle=this.oConfCard["sap.card"].header.subTitle;this._oPreviewCardHoC.refresh()}n=this._innerHocModel.getProperty("/oSelected");this._oHocChartCombo.setSelectedKey(n["sap.card"].content.chartType)};V.prototype._adjustLayoutStyles=function(){var e=M.getDialogBasedDevice();this._bDesktop=e===B.DEVICE_TYPES.Desktop;if(this._bDesktop){this._oPreviewButton.setVisible(false);this._oHidePreviewButton.setVisible(false);this._oCardContainerFlex.setVisible(true);this._oPanelFlexCard.setVisible(false);this._oPanelFlexHoC.setVisible(false);this._oPreviewPanelCardContainer.setVisible(false);this._oPreviewPanelCardContainer.setVisible(false);this._oHocflexbox1.setWidth(this._bShowPreview?"62%":"100%");this._oPreviewCardHoCVBox.setVisible(false);this._oCardsTypeTable.getColumns()[0].setWidth("10%");this._oCardsTypeTable.getColumns()[1].setWidth("90%");this._oHocflexbox2.setVisible(true);this._oCardContainerFlex.getItems()[1].setVisible(true);this._oHoCScrollContainer.setVisible(true)}else{this._oPreviewButton.setVisible(!this._bShowPreview);this._oHidePreviewButton.setVisible(this._bShowPreview);this._oCardContainerFlex.setVisible(!this._bShowPreview);this._oCardContainerFlex.setHeight(!this._bShowPreview?"4rem":"100%");this._oPanelFlexCard.setVisible(true);this._oPanelFlexHoC.setVisible(true);this._oPreviewPanelCardContainer.setVisible(!this._bShowPreview);this._oPreviewCardHoCVBox.setVisible(this._bShowPreview);this._oHocflexbox1.setWidth("100%");this._oCardsTypeTable.getColumns()[0].setWidth("20%");this._oCardsTypeTable.getColumns()[1].setWidth("80%");this._oHocflexbox2.setVisible(false);this._oCardContainerFlex.getItems()[1].setVisible(false)}this._setFocusOnElement();this.oParentPage.setTitle(this.getDialogTitle())};return V});
//# sourceMappingURL=HouseOfCards.js.map