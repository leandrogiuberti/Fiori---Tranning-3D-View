/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/Object","sap/base/Log","./AppConstants","./InsightsUtils"],function(t,e,n,r){"use strict";var s=t.extend("sap.insights.utils.BatchHelper",{});var a=e.getLogger("sap.insights.utils.BatchHelper");var i;function o(t,e){var r="INSIGHTS_CARDS";this.url=e==="POST"?r:r+"('"+t.id+"')";this.mOptions={};this.batchRequests=[];this.payload=t;this.boundary="batch_id_"+Date.now()+"_01";this.mOptions.headers={};this.mOptions.method=e||n.PUT;this.mOptions.headers["content-type"]="multipart/mixed;boundary="+this.boundary;this.mOptions.headers["X-CSRF-Token"]=i;return this}function h(){return fetch(n.REPO_BASE_URL,{method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}).then(function(t){var e=t.headers.get("X-CSRF-Token");if(t.ok&&e){return e}var n=r.getResourceBundle().getText("tokenFetchError");a.error(n);throw new Error(n)})}o.prototype.addRequest=function(t){this.batchRequests.push(t)};o.prototype._constructBody=function(){var t="--"+this.boundary;var e="\r\n";var n="Content-Type:application/http"+e+"Content-Transfer-Encoding:binary"+e;var r="changeset_001";var s="--"+r;var a="Content-Type: multipart/mixed; boundary="+r+e;var i=t+e+a;i+=e+s;for(var o=0;o<this.batchRequests.length;o++){var h=this.batchRequests[o];i+=e+n;i+="Content-ID: "+(o+1)+e+e;i+=h.mOptions.method+" "+h.url+" HTTP/1.1 "+e;i+="sap-context-accept: header"+e+"Content-Type:application/json"+e+e;i+=JSON.stringify(this.batchRequests[o].payload)+e+e;i+=s;if(o===this.batchRequests.length-1){i+="--"+e;i+=t+"--"}}return i};s.createMultipartRequest=function(t,e){return h().then(function(n){this.url="/sap/opu/odata4/ui2/insights_srv/srvd/ui2/insights_cards_repo_srv/0001/$batch";this.batchRequests=[];var r;i=n;for(var s=0;s<t.length;s++){var a=t[s];var h=new o(a,e);if(!r){r=h}r.addRequest(h)}return this.fetchData(r)}.bind(this))};s.fetchData=function(t){t.mOptions.body=t._constructBody();t.mOptions.method="POST";return fetch(this.url,t.mOptions).then(function(t){if(t.ok===false){throw new Error}return t.text()}).then(function(t){return r.getDataFromRawValue(t)})};return s});
//# sourceMappingURL=BatchHelper.js.map