/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/Control","sap/m/NavContainer","sap/insights/CardHelper","sap/insights/manageCardPreview/Preview","sap/insights/manageCardPreview/ColumnListPreview","sap/insights/manageCardPreview/HouseOfCards","sap/m/Button","sap/m/Dialog","sap/ui/model/resource/ResourceModel","./utils/CardPreviewManager","sap/m/MessageToast","sap/m/MessageBox","./utils/DeviceType","sap/base/Log","sap/insights/utils/AppConstants","sap/ui/performance/trace/FESRHelper","sap/ui/core/InvisibleText","./utils/InsightsUtils"],function(e,t,i,s,o,a,n,r,l,h,u,g,_,C,f,d,P,v){"use strict";var T=C.getLogger("sap.insights.ManagePreview");var w=e.extend("sap.insights.ManagePreview",{renderer:null,metadata:{properties:{manifest:{type:"object",group:"Behavior",defaultValue:null},transformation:{type:"boolean",group:"Behavior",defaultValue:false},cardMessageInfo:{type:"object",group:"Appearance",defaultValue:null},confirmButtonText:{type:"string",group:"Appearance",defaultValue:""},dialogTitle:{type:"string",group:"Appearance",defaultValue:""}},aggregations:{_manageDialog:{type:"sap.m.Dialog",multiple:false,visibility:"hidden"}},events:{onConfirmButtonPress:{parameters:{manifest:{type:"string"}}},onCloseButtonPress:{}}}});w.prototype.init=function(){this.i18Bundle=v.getResourceBundle();this.oInvisibleText=new P(this.getId()+"--invisibleText");this._createStaticControls();this._oNavContainer=new t(this.getId()+"selectionNavCon");this._oManageDialog=new r(this.getId()+"--insightsListDialog",{contentHeight:"42.8rem",contentWidth:"65.6rem",verticalScrolling:false,horizontalScrolling:false,resizable:false,draggable:true,showHeader:false,afterClose:this._afterCloseDialog.bind(this),content:[this._oNavContainer,this.oInvisibleText],buttons:[this.oBackButton,this.oAddButton,this.oNextButton,this.oCancelButton],ariaLabelledBy:[this.getId()+"--invisibleText"]}).addStyleClass("sapContrastPlus dialogScrollPadding")};w.prototype._afterCloseDialog=function(){this.oManifest={};this._oPreviewPage.setManifest({});this._oPreviewPage.setCardMessageInfo(null);this._oPreviewPage.bInitialPreviewLoad=true;this.setConfirmButtonText(null);if(this.getTransformation()){if(this._oColumnListPreview){this._oColumnListPreview.bShowPreview=false;this._oColumnListPreview.bDialogOpen=false;this._oColumnListPreview.oConfCard={};this._oColumnListPreview.oOrgCard={};if(this._oColumnListPreview.oColumnSearch){this._oColumnListPreview.oColumnSearch.setValue("")}}if(this._oHouseOfCards){this._oHouseOfCards.oConfCard={};this._oHouseOfCards._innerHocModel.setData({oSelected:{},aCards:[],aPreviewCards:[1,2,3],aAllowedChartTypes:[],sOriginalChartType:"",selectedPath:""})}}};w.prototype.setConfirmButtonText=function(e){this.setProperty("confirmButtonText",e);this.oAddButton.setText(e)};w.prototype._createStaticControls=function(){this.oBackButton=new n(this.getId()+"--backButton",{text:this.i18Bundle.getText("INT_DIALOG_BACK"),press:this._onNavBack.bind(this)});this.oAddButton=new n(this.getId()+"--addButton",{text:this.getConfirmButtonText()?this.getConfirmButtonText():this.i18Bundle.getText("INT_DIALOG_Ok"),press:this._save.bind(this),type:"Emphasized",enabled:true});d.setSemanticStepname(this.oAddButton,"press",f.FESR_STEP_NAME);this.oNextBtnInvisibleText=new P(this.getId()+"--nextInvisibleText");this.oNextBtnInvisibleText=this.i18Bundle.getText("INT_DIALOG_NEXT");this.oNextButton=new n(this.getId()+"--nextButton",{text:this.i18Bundle.getText("INT_DIALOG_NEXT"),press:this._callNextPage.bind(this),type:"Emphasized",enabled:false,ariaLabelledBy:[this.getId()+"--nextInvisibleText"]});this.oCancelButton=new n(this.getId()+"--cancelButton",{text:this.i18Bundle.getText("INT_DIALOG_CANCEL"),press:this._closeDialog.bind(this)})};w.prototype._setEnableButton=function(e){if(this.getTransformation()&&!this.bColumnPage){this.oNextButton.setEnabled(e.getParameter("enableButton"))}else{this.oAddButton.setEnabled(e.getParameter("enableButton"))}};w.prototype.openPreviewDialog=function(){this.oManifest=this.getManifest();this.oBackButton.setVisible(false);var e=this.getConfirmButtonText()?this.getConfirmButtonText():this.i18Bundle.getText("INT_DIALOG_Ok");this.oAddButton.setText(e);this._showPreview(this.oManifest);if(this.getTransformation()){this.oAddButton.setVisible(false);this.oNextButton.setVisible(true)}else{this.oAddButton.setVisible(true);this.oNextButton.setVisible(false)}};w.prototype._createColumnListDialog=function(){if(!this._oColumnListPreview){this._oColumnListPreview=new o({enableAddButton:this._setEnableButton.bind(this)})}this._oColumnListPreview.setManifest(this._oPreviewPage.getManifest());if(this.getDialogTitle()){this._oColumnListPreview.setDialogTitle(this.getDialogTitle())}else{this._oColumnListPreview.setDialogTitle(this.hasListeners("onConfirmButtonPress")?this.i18Bundle.getText("INT_PREVIEW_POPOVER_BUTTON_TITLE_COLMANAGER"):this.i18Bundle.getText("INT_PREVIEW_POPOVER_BUTTON_TITLE"))}this._oNavContainer.addPage(this._oColumnListPreview);this._oNavContainer.to(this._oColumnListPreview);if(_.getDialogBasedDevice()===f.DEVICE_TYPES.Desktop){this._oColumnListPreview.oPreviewCard.setPreviewMode(this._oColumnListPreview.iVisibleColumnCount>0?"Off":"Abstract");this._oColumnListPreview._refreshShowPreview()}else{this._oColumnListPreview.oPreviewColCardSD.setPreviewMode(this._oColumnListPreview.iVisibleColumnCount>0?"Off":"Abstract")}};w.prototype._createHocDialog=function(){if(!this._oHouseOfCards){this._oHouseOfCards=new a({})}this._oHouseOfCards.setManifest(this._oPreviewPage.getManifest());if(this.getDialogTitle()){this._oHouseOfCards.setDialogTitle(this.getDialogTitle())}else{this._oHouseOfCards.setDialogTitle(this.hasListeners("onConfirmButtonPress")?this.i18Bundle.getText("INT_PREVIEW_POPOVER_BUTTON_TITLE_COLMANAGER"):this.i18Bundle.getText("INT_PREVIEW_POPOVER_BUTTON_TITLE"))}};w.prototype._save=function(e){var t=JSON.parse(this._oPreviewPage.getManifest());if(this._oColumnListPreview&&Object.entries(this._oColumnListPreview.oConfCard).length){t=this._oColumnListPreview.oConfCard}else if(this._oHouseOfCards&&Object.entries(this._oHouseOfCards.oConfCard).length){t=this._oHouseOfCards.oConfCard}var s=h.insertActionsManifest(t,this.oManifest);if(this.hasListeners("onConfirmButtonPress")){this.fireOnConfirmButtonPress({manifest:s});this._closeDialog()}else if(t["sap.card"].header.title){var o=t["sap.insights"].visible;t["sap.insights"].visible=true;this._oManageDialog.setBusy(true);i.getServiceAsync().then(function(e){e._createCard(s).then(function(e){this._oManageDialog.setBusy(false);this._closeDialog();if(o){u.show(this.i18Bundle.getText("Card_Created"))}else{g.information(this.i18Bundle.getText("INT_CARD_LIMIT_MESSAGEBOX"),{styleClass:"msgBoxAlign"})}}.bind(this)).catch(function(e){if(e&&e.message==="/UI2/INSIGHTS_MSG/007"){g.error(this.i18Bundle.getText("INT_CARD_MAXLIMIT"))}else{u.show(e.message)}this._oManageDialog.setBusy(false);this._closeDialog()}.bind(this))}.bind(this))}else{this._oNavContainer.to(this._oPreviewPage);this._oPreviewPage.oTitleTextInput.focus()}};w.prototype._callNextPage=function(){try{var e=JSON.parse(this._oPreviewPage.getManifest());if(e&&this._oPreviewPage.oTitleTextInput.getValue().trim()){var t=e["sap.card"];if(t.type==="Table"||t.type==="List"){var i=_.getDialogBasedDevice()===f.DEVICE_TYPES.Desktop;this._createColumnListDialog();var s=i?this._oColumnListPreview.oColumnSegButton:this._oColumnListPreview.oSdColumnSegButton;if(!s.getSelectedKey()){s.setSelectedKey("list")}this._oColumnListPreview.oColumnSearch.setValue("");this._oColumnListPreview._onColumnSearch();this.bColumnPage=true;this.oNextButton.setVisible(false);this.oAddButton.setVisible(true);this.oBackButton.setVisible(true);this._oColumnListPreview.oColumnSearch.focus()}else if(t.type==="Analytical"){this._createHocDialog();this._oHouseOfCards.showHouseOfCardsDialog();this._oHouseOfCards.getChartTypeSearch().setValue("");this._oHouseOfCards._onChartTypeSearch();this._oNavContainer.addPage(this._oHouseOfCards);this._oNavContainer.to(this._oHouseOfCards);this.oNextButton.setVisible(false);this.oAddButton.setVisible(true);this.oBackButton.setVisible(true);this.oAddButton.setEnabled(true)}else{this._oColumnListPreview._callPreview(e)}}}catch(e){T.error(e.message);u.show(e.message);throw new Error(e)}};w.prototype._callPreviewPage=function(e){if(this._oColumnListPreview){this._oColumnListPreview.bShowPreview=false}if(this._oNavContainer&&this._oPreviewPage){this._oPreviewPage.bShowCardPreview=false;this._oPreviewPage._adjustLayoutStyles();var t=this._oPreviewPage.oTitleTextInput;if(e){if(e["sap.card"].header.title&&e["sap.card"].header.title.trim()){this.oNextButton.setEnabled(true);t.setValueState("None");t.setValueStateText("")}else{this.oNextButton.setEnabled(false);t.setValueState("Error");t.setValueStateText(this.i18Bundle.getText("INT_Preview_Title_ValueStateText"))}}this.bColumnPage=false;this._oNavContainer.to(this._oPreviewPage);var i=_.getDialogBasedDevice()===f.DEVICE_TYPES.Desktop;var s=i?this._oPreviewPage.oDefaultPreviewCardLS:this._oPreviewPage.oDefaultPreviewCardSD;if(s&&(e["sap.card"].type==="Table"||e["sap.card"].type==="List")){if(this._oColumnListPreview&&this._oColumnListPreview.iVisibleColumnCount>0){s.setPreviewMode("Off")}else{s.setPreviewMode("Abstract")}}this._oPreviewPage.setManifest(JSON.stringify(e));this.oBackButton.setVisible(false);this.oAddButton.setVisible(false);this.oNextButton.setVisible(true)}};w.prototype._closeDialog=function(){this.fireOnCloseButtonPress();this._oColumnListPreview?.resetSelectCountData();this._oManageDialog.close()};w.prototype._onNavBack=function(){if(this._oColumnListPreview&&this._oColumnListPreview.oConfCard&&Object.entries(this._oColumnListPreview.oConfCard).length){var e=this._oColumnListPreview.oConfCard["sap.card"];if(e.type==="Table"||e.type==="List"){this._callPreviewPage(this._oColumnListPreview.oConfCard);this._oPreviewPage.oTitleTextInput.focus()}}else if(this._oHouseOfCards&&this._oHouseOfCards.oConfCard&&Object.entries(this._oHouseOfCards.oConfCard).length){this._callPreviewPage(this._oHouseOfCards.oConfCard)}};w.prototype.clearManifestChanges=function(){if(this._oPreviewPage){this._oPreviewPage.oDefaultPreviewCardSD.setManifestChanges(null);this._oPreviewPage.oDefaultPreviewCardLS.setManifestChanges(null)}if(this._oColumnListPreview){this._oColumnListPreview.oPreviewColCardSD.setManifestChanges(null);this._oColumnListPreview.oPreviewCard.setManifestChanges(null)}if(this._oHouseOfCards){this._oHouseOfCards._oPreviewCardHoCSD.setManifestChanges(null);this._oHouseOfCards._oPreviewCardHoC.setManifestChanges(null)}};w.prototype._showPreview=function(e){return i.getServiceAsync().then(function(t){return t._getUserAllCards().then(function(t){var i=t.filter(function(e){return e.visibility});if(i.length<10){e["sap.insights"].visible=true}var o=e?JSON.parse(JSON.stringify(e)):"";o=h.getCardPreviewManifest(e);if(!this._oPreviewPage){this._oPreviewPage=new s(this.getId()+"idPreviewPage",{cardMessageInfo:this.getCardMessageInfo(),transformation:this.getTransformation(),titleCheck:this._setEnableButton.bind(this)})}else{this.clearManifestChanges();this._oPreviewPage.setCardMessageInfo(this.getCardMessageInfo());this._oPreviewPage.setTransformation(this.getTransformation())}this._oPreviewPage.setManifest(JSON.stringify(o));if(this.getDialogTitle()){this._oPreviewPage.setDialogTitle(this.getDialogTitle())}else{this._oPreviewPage.setDialogTitle(this.hasListeners("onConfirmButtonPress")?this.i18Bundle.getText("INT_PREVIEW_POPOVER_BUTTON_TITLE_COLMANAGER"):this.i18Bundle.getText("INT_PREVIEW_POPOVER_BUTTON_TITLE"))}this.oInvisibleText.setText(this._oPreviewPage.getDialogTitle());this._oNavContainer.addPage(this._oPreviewPage);this._oNavContainer.to(this._oPreviewPage);this.bColumnPage=false;var a=this._oPreviewPage.oTitleTextInput;a.setValueState("None");this._oManageDialog.open();this._oPreviewPage.setPreviewModeOfCard();if(this.hasListeners("onConfirmButtonPress")){this._oPreviewPage.oDefaultSubText.setText(this.i18Bundle.getText("INT_CARD_SUBTITLE"))}else{this._oPreviewPage.oDefaultSubText.setText(this.i18Bundle.getText("INT_CARD_SUBTITLE")+"\n"+this.i18Bundle.getText("INT_CARD_LIMIT_SUBTITLE"))}return Promise.resolve()}.bind(this))}.bind(this)).catch(function(e){T.error(e.message);return Promise.reject(e)})};return w});
//# sourceMappingURL=ManagePreview.js.map