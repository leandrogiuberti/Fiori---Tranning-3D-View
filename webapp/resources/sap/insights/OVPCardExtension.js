/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 * This extension is for OVP cards delivered in 2203 onwards.
 */
sap.ui.define(["sap/ui/integration/Extension","sap/ui/core/format/NumberFormat","sap/fe/navigation/SelectionVariant","sap/base/Log","sap/ui/core/format/DateFormat","sap/ui/core/library","sap/m/library","./OVPChartFormatter","sap/ui/integration/util/Utils","sap/m/DynamicDateUtil","sap/ui/core/date/UI5Date"],function(e,t,r,a,i,n,o,s,l,f,u){"use strict";var c=o.ValueColor,g=n.ValueState;var m={StateValues:{None:"None",Negative:"Error",Critical:"Warning",Positive:"Success"},ColorValues:{None:"Neutral",Negative:"Error",Critical:"Critical",Positive:"Good"}};var v=a.getLogger("sap.insights.OVPCardExtension");var p=function(e,t){return e&&e.indexOf(t,e.length-t.length)!==-1};var d=function(e,t){var r;if(t){r=t.None;if(e&&e.EnumMember){var a=e.EnumMember;if(p(a,"Negative")){r=t.Negative}else if(p(a,"Critical")){r=t.Critical}else if(p(a,"Positive")){r=t.Positive}}}return r};var b=function(e,t,r,a,i,n,o){var s={};s.EnumMember="None";var l=Number.NEGATIVE_INFINITY;var f=Number.POSITIVE_INFINITY;if(!i&&i!==0&&(r||r===0)){i=r}if(!n&&n!==0&&(a||a===0)){n=a}if(!r&&r!==0){r=l}if(!a&&a!==0){a=f}if(e!==undefined){e=Number(e);if(p(t,"Minimize")||p(t,"Minimizing")){if((n||n===0)&&(a||a===0)){if(e<=parseFloat(n)){s.EnumMember="Positive"}else if(e>parseFloat(a)){s.EnumMember="Negative"}else{s.EnumMember="Critical"}}}else if(p(t,"Maximize")||p(t,"Maximizing")){if((i||i===0)&&(r||r===0)){if(e>=parseFloat(i)){s.EnumMember="Positive"}else if(e<parseFloat(r)){s.EnumMember="Negative"}else{s.EnumMember="Critical"}}}else if(p(t,"Target")){if((n||n===0)&&(a||a===0)&&(i||i===0)&&(r||r===0)){if(e>=parseFloat(i)&&e<=parseFloat(n)){s.EnumMember="Positive"}else if(e<parseFloat(r)||e>parseFloat(a)){s.EnumMember="Negative"}else{s.EnumMember="Critical"}}}}return d(s,o)};var h=function(e,t,r,a){if(!e||!t){return}e=Number(e);if(!a&&e-t>=0){return"Up"}if(!r&&e-t<=0){return"Down"}if(t&&a&&e-t>=a){return"Up"}if(t&&r&&e-t<=r){return"Down"}};var N=function(e,r,a){var i=r||{},n=e;var o=t.getFloatInstance({minFractionDigits:i.NumberOfFractionalDigits,maxFractionDigits:i.NumberOfFractionalDigits,style:"short",showScale:true,shortRefNumber:n});var s=o.format(Number(n)),l=o.getScale()||"";if(!a&&s){var f=s[s.length-1];return f===l?s.slice(0,s.length-1):s}if(a&&i.percentageAvailable){return l+"%"}if(a&&!i.percentageAvailable){return l}return""};var S=function(){var e=this.getCard().getCombinedParameters();return e._headerDataUrl};var D=function(){var e=this.getCard().getCombinedParameters();return e._contentDataUrl};var I=function(e,r,a){var i,n,o;if(isNaN(+e)){return""}if(e==0){o=r}else{o=e}if(a.NumberOfFractionalDigits){n=+a.NumberOfFractionalDigits}if(r){i=r}else if(a.manifestTarget){i=a.manifestTarget}if(!n||n<0){n=0}else if(n>2){n=2}if(i){var s=t.getFloatInstance({minFractionDigits:n,maxFractionDigits:n,style:"short",showScale:true,shortRefNumber:o});return s.format(+i)}};var y=function(e,r,a){var i,n;if(isNaN(+e)){return""}e=+e;if(a.NumberOfFractionalDigits){i=+a.NumberOfFractionalDigits}if(r){n=+r}else if(a.manifestTarget){n=+a.manifestTarget}if(!i||i<0){i=0}else if(i>2){i=2}if(n){var o=(e-n)/n;var s=t.getPercentInstance({style:"short",minFractionDigits:i,maxFractionDigits:i,showScale:true});return s.format(o)}};var O=function(e){var t={};t.EnumMember="None";if(Number(e)===1){t.EnumMember="Negative"}else if(Number(e)===2){t.EnumMember="Critical"}else if(Number(e)===3){t.EnumMember="Positive"}return d(t,m.ColorValues)};var F=function(){var e=arguments[arguments.length-1];var t=1;return b(arguments[0],e.sImprovementDirection,e.bIsDeviationLowBinding?arguments[t++]:e.deviationLow,e.bIsDeviationHighBinding?arguments[t++]:e.deviationHigh,e.bIsToleranceLowBinding?arguments[t++]:e.toleranceLow,e.bIsToleranceHighBinding?arguments[t++]:e.toleranceHigh,e.oCriticalityConfigValues)};var C=function(){var e=arguments[arguments.length-1];var t=1;return h(arguments[0],e.bIsRefValBinding?arguments[t++]:e.referenceValue,e.bIsDownDiffBinding?arguments[t++]:e.downDifference,e.bIsUpDiffBinding?arguments[t++]:e.upDifference)};var P=function(e){var t;var r=arguments[arguments.length-1],a=r&&r.propertyType;switch(a){case"yearmonth":var i=parseInt(e.substr(0,4),10),n=e.substr(4),o=parseInt(n,10)-1;t=u.getInstance(Date.UTC(i,o));break;case"yearquarter":var i=parseInt(e.substr(0,4),10),s=e.substr(4),l=parseInt(s,10)*3-2,o=l-1;t=u.getInstance(Date.UTC(i,o));break;case"yearweek":var i=parseInt(e.substr(0,4),10),f=e.substr(4),c=1+(parseInt(f,10)-1)*7;t=u.getInstance(Date.UTC(i,0,c));break;default:break}return t};var E=function(e,t){var r=l.parseJsonDateTime(e);return i.getInstance(t).format(u.getInstance(r),t.bUTC)};var w=function(e,r,a,i){var n;if(e){e.maxFractionDigits=e.numberOfFractionalDigits||0;e.minFractionDigits=e.numberOfFractionalDigits||0;e.style=e.style||"short";e.showScale=e.showScale||true;e.shortRefNumber=e.scaleFactor;n=t.getFloatInstance(e)}var o=[];if(!isNaN(parseFloat(a))&&n){o.push(n.format(a))}else{o.push(a)}if(!isNaN(parseFloat(i))&&n){o.push(n.format(i))}else{o.push(i)}var s="";if(r&&r.length){r.forEach(function(e){if(typeof e==="number"){s=s+o[e]}else{s=s+e}})}return s};var V=function(e,t){if(t==="state"){switch(String(e)){case"1":case"Error":return g.Error;case"2":case"Warning":return g.Warning;case"3":case"Success":return g.Success;case"4":case"Information":return g.Information;default:return g.None}}if(t==="color"){switch(String(e)){case"1":case"Error":return c.Error;case"2":case"Critical":return c.Critical;case"3":case"Good":return c.Good;case"4":case"Neutral":return c.Neutral;default:return c.None}}};var M=function(e,t){var r=this.getCard().getModel().getProperty("/content/d/results")||this.getCard().getModel().getProperty("/d/results")||[];return Math[t].apply(Math,r.map(function(t){return t[e]}))};var T=function(e,t,r){var a=1;var i=2;var n=4;for(var o in e){if(e.hasOwnProperty(o)){var s=e[o];if(s instanceof Date){s=s.toJSON()}else if(Array.isArray(s)||s&&typeof s==="object"){s=JSON.stringify(s)}else if(typeof s==="number"||typeof s==="boolean"){s=s.toString()}if(s===""){if(r&a){v.info("Semantic attribute "+o+" is an empty string and due to the chosen Suppression Behiavour is being ignored.");continue}}if(s===null){if(r&i){throw new v.error("NavigationHandler.INVALID_INPUT")}else{v.warning("Semantic attribute "+o+" is null and ignored for mix in to selection variant");continue}}if(s===undefined){if(r&n){throw new v.error("NavigationHandler.INVALID_INPUT")}else{v.warning("Semantic attribute "+o+" is undefined and ignored for mix in to selection variant");continue}}if(typeof s==="string"||s instanceof String){t.addSelectOption(o,"I","EQ",s)}else{throw new v.error("NavigationHandler.INVALID_INPUT")}}}return t};var x=function(e,t,a){var i=new r(t);var n=new r;if(i.getFilterContextUrl()){n.setFilterContextUrl(i.getFilterContextUrl())}if(i.getParameterContextUrl()){n.setParameterContextUrl(i.getParameterContextUrl())}if(Array.isArray(e)){e.forEach(function(e){T(e,n,a)})}else{T(e,n,a)}var o=i.getParameterNames();var s;for(s=0;s<o.length;s++){if(!n.getSelectOption(o[s])){n.addSelectOption(o[s],"I","EQ",i.getParameter(o[s]))}}var l=i.getSelectOptionsPropertyNames();for(s=0;s<l.length;s++){var f=i.getSelectOption(l[s]);if(!n.getSelectOption(l[s])){for(var u=0;u<f.length;u++){n.addSelectOption(l[s],f[u].Sign,f[u].Option,f[u].Low,f[u].High)}}}return n};function U(e){if(e){if(e.hasOwnProperty("SelectionVariantID")){delete e.SelectionVariantID}else if(e.hasOwnProperty("PresentationVariantID")){delete e.PresentationVariantID}delete e.Text;delete e.ODataFilterExpression;delete e.Version;delete e.FilterContextUrl;delete e.ParameterContextUrl;return e}return e}var H=function(e){try{if(JSON.parse(e)){return true}}catch(e){return false}};var A=function(e){var t=e&&e.length===1,r=e&&e[0];return t&&r["Option"]==="EQ"&&!r["High"]&&r["Low"]&&r["Sign"]==="I"};var L=function(e){var t=i.getDateInstance({pattern:"''yyyy-MM-dd'T'HH:mm:ss.SSS'Z'''",calendarType:"Gregorian"});if(e){var r=t.format(e,true);return String(r).replace(/'/g,"")}};var _=function(e){var t=i.getDateInstance({pattern:"''yyyy-MM-dd'T'HH:mm:ss.SSS''",calendarType:"Gregorian"});var r=e instanceof Date?e:u.getInstance(e);var a=t.format(r);return String(a).replace(/'/g,"")};var J=function(e,t,r){var a=[];if(e.operation==="DATE"&&e.value1){a=f.toDates({values:[e.value1],operator:e.operation})||[]}else{a=f.toDates({values:[],operator:e.operation})||[]}var i=a[0]&&a[0].oDate;var n=a[1]&&a[1].oDate;var o="",s="";if(e["sap:filter-restriction"]==="single-value"){if(e.type==="Edm.DateTime"&&i instanceof Date){o=_(i);if(o){t.massAddSelectOption(r,[{Sign:"I",Option:e.operator,Low:o,High:null}])}}else if(e.type==="Edm.String"){o=L(i);if(o){t.massAddSelectOption(r,[{Sign:"I",Option:e.operator,Low:o,High:null}])}}}else if(e["sap:filter-restriction"]==="interval"){if(e.type==="Edm.DateTime"){if(i instanceof Date){o=_(i)}if(n instanceof Date){s=_(n)}if(o&&s){t.massAddSelectOption(r,[{Sign:"I",Option:e.operator,Low:o,High:s}])}}else if(e.type==="Edm.String"){if(i instanceof Date){o=L(i)}if(n instanceof Date){s=L(n)}if(o&&s){t.massAddSelectOption(r,[{Sign:"I",Option:e.operator,Low:o,High:s}])}}}};function k(e,t){var a=this.getEventingParent().getManifest()["sap.card"],i=a&&a.configuration.parameters,n=new r,o=i._relevantODataFilters.value||[],s=i._mandatoryODataParameters.value||[],e=e&&JSON.parse(e)||{},l=e.parameters||{},f=l.ibnParams||{},u=f.sensitiveProps||{};var c={};s.forEach(function(e){var t=H(i[e].value);if(t&&!u[e]){var r=JSON.parse(i[e].value);if(r&&r.operation){J(r,n,e)}}});o.forEach(function(e){var t=H(i[e].value);if(t&&!u[e]){var r=JSON.parse(i[e].value);if(r&&r.operation){J(r,n,e)}else{var a=r.SelectOptions.Ranges||r.SelectOptions&&r.SelectOptions[0]&&r.SelectOptions[0].Ranges;if(a&&a.length){var o=A(a);if(o){f[e]=a[0].Low}else{if(f[e]&&!o){delete f[e]}n.massAddSelectOption(e,a)}}}}});var g=t||{};var m=Object.keys(g)||[];for(var v=0;v<m.length;v++){if(u&&u[m[v]]||m[v]==="__metadata"){delete g[m[v]]}}var p=x(g,n&&n.toJSONObject());p=U(p.toJSONObject());if(f.presentationVariant){c["presentationVariant"]=f.presentationVariant}if(p.Parameters.length||p.SelectOptions.length){c["selectionVariant"]=p}if(!l.ibnParams){l.ibnParams={}}if(c["selectionVariant"]||c["presentationVariant"]){l.ibnParams["sap-xapp-state-data"]=JSON.stringify(c)}if(f&&f.sensitiveProps){delete f.sensitiveProps}delete f.selectionVariant;delete f.presentationVariant;return e}return e.extend("sap.insights.CardExtension",{init:function(){e.prototype.init.apply(this,arguments);s.registerCustomFormatters();this.setFormatters({kpiformatter:N,formatHeaderUrl:S.bind(this),formatContentUrl:D.bind(this),returnPercentageChange:y,targetValueFormatter:I,kpiValueCriticality:O,formatValueColor:F,formatTrendIcon:C,formatDateValue:P,addPropertyValueToAppState:k.bind(this),formatDate:E,formatNumber:w,formatCriticality:V,getMinMax:M.bind(this)})}})});
//# sourceMappingURL=OVPCardExtension.js.map