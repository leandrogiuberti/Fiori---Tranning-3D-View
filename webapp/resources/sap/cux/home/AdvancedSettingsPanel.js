/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/insights/CardHelper","sap/m/Button","sap/m/CheckBox","sap/m/CustomListItem","sap/m/HBox","sap/m/IconTabBar","sap/m/IconTabFilter","sap/m/Input","sap/m/Label","sap/m/library","sap/m/List","sap/m/MessageStrip","sap/m/MessageToast","sap/m/ObjectStatus","sap/m/OverflowToolbar","sap/m/Panel","sap/m/Text","sap/m/Title","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/VBox","sap/ui/core/Element","sap/ui/core/EventBus","sap/ui/core/library","sap/ui/layout/form/SimpleForm","sap/ui/model/json/JSONModel","sap/ui/unified/FileUploader","sap/ushell/Container","./BaseSettingsPanel","./utils/Accessibility","./utils/AppManager","./utils/Constants","./utils/DataFormatUtils","./utils/Device","./utils/FESRUtil","./utils/HttpHelper","./utils/PageManager","./utils/PersonalisationUtils","./utils/UshellPersonalizer"],function(t,e,s,n,o,i,r,a,l,c,p,d,u,h,g,m,f,P,I,x,S,v,T,b,E,C,y,B,M,_,w,z,U,A,R,L,F,N,D,$){"use strict";function O(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}function H(t,e){try{var s=t()}catch(t){return e(t)}if(s&&s.then){return s.then(void 0,e)}return s}const k=p["FlexAlignItems"];const V=p["ToolbarStyle"];const j=E["ValueState"];const X=O(_);const J=w["checkPanelExists"];const G=O(z);const K=U["SETTINGS_PANELS_KEYS"];const q=A["recycleId"];const W=R["calculateDeviceType"];const Y=R["DeviceType"];const Z=L["addFESRSemanticStepName"];const Q=L["FESR_EVENTS"];const tt=O(F);const et=O(N);const st=O(D);const nt=O($);var ot=function(t){t["IMPORT"]="import";t["EXPORT"]="export";return t}(ot||{});const it="/sap/opu/odata4/ui2/insights_srv/srvd/ui2/";const rt=it+"insights_cards_repo_srv/0001/";const at=rt+"INSIGHTS_CARDS/com.sap.gateway.srvd.ui2.insights_cards_repo_srv.v0001.importExport?";const lt="AZHJGRIT78TG7Y65RF6EPFJ9U";const ct="sap.cux.home.NewsAndPagesContainer";const pt="sap.cux.home.AppsContainer";const dt="sap.cux.home.InsightsContainer";const ut="sap.cux.home.PagePanel";const ht="sap.cux.home.FavAppPanel";const gt="sap.cux.home.RecommendedAppPanel";const mt="sap.cux.home.TilesPanel";const ft="sap.cux.home.CardsPanel";const Pt=X.extend("sap.cux.home.AdvancedSettingsPanel",{metadata:{events:{sectionsImported:{}}},constructor:function t(e,s){X.prototype.constructor.call(this,e,s)},init:function t(){X.prototype.init.call(this);this.setProperty("key",K.ADVANCED);this.setProperty("title",this._i18nBundle.getText("advancedSettings"));this.setProperty("icon","sap-icon://grid");this.oEventBus=b.getInstance();this.oAppManagerInstance=G.getInstance();this.oSectionsImported={};this.oUserPersonalization={export:{sections:[],fileName:"MY_HOME",sectionsSelected:false,error:false},import:{sections:[],sectionsSelected:false,error:false},selectedTab:"export",showNoImport:false};this.oControlModel=new y(this.oUserPersonalization);this.addAggregation("content",this.getContent());this.addInnerContent();this.attachPanelNavigated(()=>{const t=this;void function(){try{if(!t.oPageManagerInstance){t.oPageManagerInstance=et.getInstance(st.getPersContainerId(t._getPanel()),st.getOwnerComponent(t._getPanel()))}t.oEventBus.subscribe("importChannel","tilesImported",(e,s,n)=>{const o=n.status;t.updateImportStatus("insightsTiles",!o)},t);t.oEventBus.subscribe("importChannel","appsImported",(e,s,n)=>{const o=n.status;t.updateImportStatus("favApps",!o)},t);t.oEventBus.subscribe("importChannel","favPagesImported",(e,s,n)=>{const o=n.status;t.updateImportStatus("pages",!o)},t);t.oEventBus.subscribe("importChannel","cardsImported",(e,s,n)=>{const o=n.status;t.updateImportStatus("insightsCards",!o)},t);t.oDetailPage=T.getElementById(t.getProperty("key")+"-detail-page");const e=t._getPanel();if(J(e,pt,gt)&&W()!==Y.Mobile){void t._setRecommendationSettingsPanel()}return Promise.resolve(t.loadUserPersonalizationData()).then(function(){t.oImportBtn.setEnabled(t.oUserPersonalization.import.sectionsSelected);t.enableDisableActions(t.oUserPersonalization.selectedTab);t.setImportExportList();t.oExportMessage.setText(t.oUserPersonalization.export.errorMessage?String(t.oUserPersonalization.export.errorMessage):"");t.oExportMessage.setType(t.oUserPersonalization.export.errorType);t.oExportMessage.setProperty("visible",t.oUserPersonalization.export.error,true);t.oFileNameInput.setValue(String(t.oUserPersonalization.export.fileName));t.oImportMessage.setText(t.oUserPersonalization.import.errorMessage?String(t.oUserPersonalization.import.errorMessage):"");t.oImportMessage.setType(t.oUserPersonalization.import.errorType);t.oImportMessage.setVisible(t.oUserPersonalization.import.error)})}catch(t){return Promise.reject(t)}}()})},setImportExportList:function t(){this.oExportList?.destroy();this.oExportList=this.setExportSectionList();this._importExportPanel.addContent(this.oExportList);if(!this.oImportList){this.oImportList=this.setImportSectionList();this._importExportPanel.addContent(this.oImportList)}else{this.oImportList.invalidate()}},enableDisableActions:function t(e){this.oImportExportTab?.setSelectedKey(e);this.oImportBtn?.setVisible(e===ot.IMPORT);this.oExportBtn?.setVisible(e===ot.EXPORT);if(this.oUserPersonalization.import.sectionsSelected&&e===ot.IMPORT){this.oImportBtn.setEnabled(true)}else{this.oImportBtn.setEnabled(false)}if(e===ot.EXPORT&&this.oUserPersonalization.export.fileName&&this.oUserPersonalization.export.sections?.length&&this.oUserPersonalization.export.sectionsSelected){this.oExportBtn.setEnabled(true)}else{this.oExportBtn.setEnabled(false)}},setExportImportValues:function t(e){if(e===ot.EXPORT){this.oExportMessage.setText(this.oUserPersonalization.export.errorMessage?String(this.oUserPersonalization.export.errorMessage):"");this.oExportMessage.setType(this.oUserPersonalization.export.errorType);this.oExportMessage.setProperty("visible",this.oUserPersonalization.export.error,true)}else if(e===ot.IMPORT){this.oImportMessage.setText(this.oUserPersonalization.import.errorMessage?String(this.oUserPersonalization.import.errorMessage):"");this.oImportMessage.setType(this.oUserPersonalization.import.errorType);this.oImportMessage.setProperty("visible",this.oUserPersonalization.import.error)}},getContent:function t(){if(!this.oContentVBox){this.oContentVBox=new v(this.getId()+"--idAdvancedVBox",{items:[new P(this.getId()+"--idPersonalizationSubheader",{text:this._i18nBundle.getText("advancedSettingsSubheader")}).addStyleClass("sapUiSmallMarginBegin sapUiSmallMarginTop"),this._getImportExportPanel()]})}return this.oContentVBox},_getImportExportPanel:function t(){if(!this._importExportPanel){this._importExportPanel=new f(`${this.getId()}-importExportPanel`,{headerToolbar:new m(`${this.getId()}-importExportPanelToolbar`,{style:V.Clear,content:[new I(`${this.getId()}-importExportPanelToolbarText`,{text:this._i18nBundle.getText("importAndExportPanelHeader"),level:"H3"}),new S(`${this.getId()}-importExportPanelToolbarSpacer`),this._getImportButton(),this._getExportButton()]}),headerText:this._i18nBundle.getText("importAndExportPanelHeader"),expanded:true,expandable:true,content:[]}).addStyleClass("sapUiSmallMarginTop")}return this._importExportPanel},_getImportButton:function t(){if(!this.oImportBtn){this.oImportBtn=new s({id:`${this.getId()}-importBtn`,text:this._i18nBundle.getText("import"),type:"Transparent",press:()=>{void this.onImportPress()},visible:false});Z(this._getImportButton(),Q.PRESS,"importBtn")}return this.oImportBtn},_getExportButton:function t(){if(!this.oExportBtn){this.oExportBtn=new s({id:`${this.getId()}-exportBtn`,text:this._i18nBundle.getText("export"),type:"Transparent",press:this.onExportPress.bind(this),visible:true});Z(this.oExportBtn,Q.PRESS,"exportBtn")}return this.oExportBtn},addInnerContent:function t(){if(!this.oImportExportTab){this.oImportExportTab=new r(this.getId()+"--idImportExportTab",{expandable:false,backgroundDesign:"Transparent",selectedKey:this.oSelectedTab?this.oSelectedTab:"export",select:this.onImportExportTabSelect.bind(this)});const t=new a(this.getId()+"--idExportTab",{key:"export",text:this._i18nBundle.getText("exportFile")});Z(t,Q.SELECT,"exportTab");this.oExportMessage=new u(this.getId()+"--idExportMessageStrip",{showIcon:true,visible:false}).addStyleClass("sapUiNoMarginBegin sapUiTinyMarginBottom");const e=new P(this.getId()+"--idExportText",{text:this._i18nBundle.getText("exportText")}).addStyleClass("advancePadding");const n=new i(this.getId()+"--idFileInputContainer",{alignItems:"Center"}).addStyleClass("sapUiSmallMargin");const o=new c(this.getId()+"--idFilenameLabel",{text:this._i18nBundle.getText("exportFileNameLabel"),labelFor:"idTitleFilenameInput",required:true,showColon:true}).addStyleClass("sapUiSmallMarginEnd");this.oFileNameInput=new l(this.getId()+"--idFileNameInput",{ariaLabelledBy:[`${this.getId()}--idExportText`,`${this.getId()}--idFilenameLabel`],required:true,width:"13rem",liveChange:this.onFileNameInputChange.bind(this),value:""});n.addItem(o);n.addItem(this.oFileNameInput);t.addContent(this.oExportMessage);t.addContent(e);t.addContent(n);const p=new a(this.getId()+"--idImportTab",{key:"import",text:this._i18nBundle.getText("importFile")});Z(p,Q.SELECT,"importTab");this.oImportMessage=new u(this.getId()+"--idImportMessageStrip",{text:"{advsettings>/import/errorMessage}",type:"{advsettings>/import/errorType}",showIcon:true,visible:false}).addStyleClass("sapUiNoMarginBegin sapUiTinyMarginBottom");const d=new P(this.getId()+"--idImportText",{text:this._i18nBundle.getText("importText")}).addStyleClass("advancePadding");const h=new C(this.getId()+"--idImportSimpleForm",{editable:true,layout:"ResponsiveGridLayout",labelSpanS:4,labelSpanM:4});const g=new B(this.getId()+"--idImportFileUploader",{tooltip:this._i18nBundle.getText("uploadImportFile"),fileType:["txt"],change:t=>{void this.onFileImport(t)},maximumFileSize:25,sameFilenameAllowed:true,width:"80%",ariaLabelledBy:[`${this.getId()}--idImportText`],buttonText:this._i18nBundle.getText("importFileUploaderButton")});h.addContent(g);p.addContent(this.oImportMessage);p.addContent(d);p.addContent(h);const m=new a(this.getId()+"--idClassicImportTab",{key:"classicImport",text:this._i18nBundle.getText("classicImport")});Z(m,Q.SELECT,"classicImportTab");const f=new P(this.getId()+"--idClassicImportText",{text:this._i18nBundle.getText("classicImportText")}).addStyleClass("sapUiSmallMarginBottom advancePadding");const I=new s(this.getId()+"--resetImportAppsNow",{text:this._i18nBundle.getText("resetButton"),press:this.onResetImportApps.bind(this),ariaLabelledBy:[`${this.getId()}--idClassicImportText`]}).addStyleClass("resetButtonPadding");Z(I,Q.PRESS,"resetImportApps");m.addContent(f);m.addContent(I);this.oImportExportTab.addItem(t);this.oImportExportTab.addItem(p);this.oImportExportTab.addItem(m);this._importExportPanel.addContent(this.oImportExportTab);this._importExportPanel.addContent(this.setExportSectionList())}},setExportSectionList:function t(){const e=new d(`${this.getId()}--exportSectionsList`,{width:"calc(100% - 2rem)",growingThreshold:50,includeItemInSelection:true,visible:"{= ${advsettings>/selectedTab} === 'export'}"}).addStyleClass("sapUiSmallMarginBegin");const s=new x(`${this.getId()}--exportSectionsListToolbar`,{content:[new I(this.getId()+"--idExportSectionsListHeaderText",{text:this._i18nBundle.getText("sectionExportListHeader"),level:"H4"}).addStyleClass("sectionTitle")]});e.setHeaderToolbar(s);e.setModel(this.oControlModel,"advsettings");e.bindItems({path:"advsettings>/export/sections",template:new o(`${this.getId()}--exportCustomListItem`,{visible:{path:"advsettings>panelClass",formatter:this._isPanelAvailable.bind(this)},accDescription:{parts:[{path:"advsettings>enabled"},{path:"advsettings>selected"},{path:"advsettings>title"}],formatter:this._formatAccDescription.bind(this)},content:[new i(q(`${this.getId()}--exportContentBox`),{alignItems:"Center",items:[new n(q(`${this.getId()}--exportListItemCheck`),{select:this.onSectionsSelectionChange.bind(this,false),selected:"{advsettings>selected}",enabled:"{advsettings>enabled}"}),new P(q(`${this.getId()}--exportListItemText`),{text:"{advsettings>title}"})],width:"100%"})]})});this.oExportList=e;return e},_formatAccDescription:function t(e,s,n){const o=!e?`${this._i18nBundle.getText("checkboxDisabledText")}.`:"";const i=s?this._i18nBundle.getText("checkboxCheckedText"):this._i18nBundle.getText("checkboxUnCheckedText");const r=this._i18nBundle.getText("checkboxInstructionText");return`${o}${i}. ${n}. ${r}`},_isPanelAvailable:function t(e){const s={[ht]:{containerName:pt,panelName:ht},[ut]:{containerName:ct,panelName:ut},[mt]:{containerName:dt,panelName:mt},[ft]:{containerName:dt,panelName:ft}};const n=s[e];if(!n)return false;const o=this._getPanel();return J(o,n.containerName,n.panelName)},setImportSectionList:function t(){const e=new d(this.getId()+"--idImportSectionsList",{width:"calc(100% - 2rem)",growingThreshold:50,includeItemInSelection:true,visible:"{= ${advsettings>/selectedTab} === 'import' && (${advsettings>/import/sections/length} > 0 || ${advsettings>/showNoImport})}"}).addStyleClass("sapUiSmallMarginBegin");const s=new x(this.getId()+"--idImportSectionsListToolbar",{content:[new I(`${this.getId()}--importSectionsListHeaderText`,{text:this._i18nBundle.getText("sectionImportListHeader")}).addStyleClass("sectionTitle")]});e.setHeaderToolbar(s);e.setModel(this.oControlModel,"advsettings");e.bindItems({path:"advsettings>/import/sections",template:new o(`${this.getId()}--importCustomListItem`,{accDescription:{path:"advsettings>title",formatter:this._formatAccDescription.bind(this)},content:[new i(`${this.getId()}--importListCheckBox`,{justifyContent:"SpaceBetween",items:[new i(`${this.getId()}--importListItemCheckHBox`,{items:[new n(`${this.getId()}--importListItemCheck`,{select:this.onSectionsSelectionChange.bind(this,true),selected:"{advsettings>selected}",enabled:"{advsettings>enabled}"}),new P(`${this.getId()}--importListItemText`,{text:"{advsettings>title}"}).addStyleClass("sapUiTinyMarginTop")]}),new i(`${this.getId()}--importStatusHBox`,{items:[new g(`${this.getId()}--importItemStatus`,{icon:"{= ${advsettings>status} === 'Success' ? 'sap-icon://status-positive' : 'sap-icon://status-negative' }",state:"{advsettings>status}",visible:"{= ${advsettings>status} !== 'None'}"}).addStyleClass("sapUiSmallMarginEnd sapUiTinyMarginTop")]})],width:"100%"})]})});return e},onSectionsSelectionChange:function t(e){const s=e?this.oImportList.getItems():this.oExportList.getItems();let n=false;let o,i;const r=s.some(function(t){if(!e){o=t.getAggregation("content");i=o[0].getItems()[0];n=i.getSelected()}else{o=t.getAggregation("content");const e=o[0].getItems()[0];i=e.getItems()[0];n=i.getSelected()}return n});this.oControlModel.setProperty((e?"/import":"/export")+"/sectionsSelected",r);this.enableDisableActions(e?"import":"export")},onImportPress:function e(){try{const e=this;e.attachEvent("sectionsImported",()=>{e.oDetailPage.setBusy(false);e.oControlModel.setProperty("/import/sectionsSelected",false)});e.oImportBtn.setEnabled(false);e.oDetailPage.setBusy(true);e.handleUserPersonalizationError(ot.IMPORT,false,"","");const s=e.oUserPersonalization.import.data;const n=H(function(){return Promise.resolve(e.importSections(s)).then(function(t){const s=t.some(t=>t.status===j.Error);if(s){e.handleUserPersonalizationError(ot.IMPORT,true,String(e._i18nBundle.getText("userPersonalizationImportError")),"Warning")}e.oControlModel.setProperty("/import/sections",t)})},function(s){t.error("importpress",String(s));e.handleUserPersonalizationError(ot.IMPORT,true,String(e._i18nBundle.getText("userPersonalizationImportError")),"Error")});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},importSections:function e(s){const n=[];const o=[];const i=this.oControlModel.getProperty("/import/sections");n.push(()=>this.importApps(s));n.push(()=>this.importTiles(s));n.push(()=>this.importFavPages(s));o.push(n.reduce((t,e)=>t.then(()=>e()),Promise.resolve()));o.push(this.importCards(s));return Promise.all(o).then(()=>i).catch(e=>{t.error("import failed",String(e));return[]})},importApps:function t(e){return new Promise(t=>{const s=this.oControlModel.getProperty("/import/sections");if(e?.apps&&e?.apps.length>0&&this.isSectionSelected(s,String(this._i18nBundle.getText("favApps")))){this.oSectionsImported[String(this._i18nBundle.getText("favApps"))]=false;this.oEventBus.publish("importChannel","appsImport",{apps:e.apps,groupInfo:e.groupInfo});t()}else{this.oSectionsImported[String(this._i18nBundle.getText("favApps"))]=true;this.updateImportStatus("favApps");t()}})},importTiles:function t(e){return new Promise(t=>{const s=this.oControlModel.getProperty("/import/sections");if(e?.tiles&&e.tiles.length>0&&this.isSectionSelected(s,String(this._i18nBundle.getText("insightsTiles")))){this.oSectionsImported[String(this._i18nBundle.getText("insightsTiles"))]=false;this.oEventBus.publish("importChannel","tilesImport",e.tiles);t()}else{this.oSectionsImported[String(this._i18nBundle.getText("insightsTiles"))]=true;this.updateImportStatus("insightsTiles");t()}})},importFavPages:function t(e){return new Promise(t=>{const s=this.oControlModel.getProperty("/import/sections");if(e?.favouritePages&&e.favouritePages.length>0&&this.isSectionSelected(s,String(this._i18nBundle.getText("pages")))){this.oSectionsImported[String(this._i18nBundle.getText("pages"))]=false;this.oEventBus.publish("importChannel","favPagesImport",e.favouritePages);t()}else{this.oSectionsImported[String(this._i18nBundle.getText("pages"))]=true;this.updateImportStatus("pages");t()}})},importCards:function t(e){return new Promise(t=>{const s=this.oControlModel.getProperty("/import/sections");if(e?.cards&&e.cards.length>0&&this.isSectionSelected(s,String(this._i18nBundle.getText("insightsCards")))){this.oSectionsImported[String(this._i18nBundle.getText("insightsCards"))]=false;this.oEventBus.publish("importChannel","cardsImport",e.cards);t()}else{this.oSectionsImported[String(this._i18nBundle.getText("insightsCards"))]=true;this.updateImportStatus("insightsCards");t()}})},updateImportStatus:function t(e,s){const n=String(this._i18nBundle.getText(e));const o=this.oControlModel.getProperty("/import/sections");const i=o.find(function(t){return t.title===n});if(i){if(s!==undefined){i.status=s?j.Error:j.Success}else{i.status=j.None}if(i.status===j.Success){i.enabled=false}}this.oSectionsImported[n]=true;const r=Object.keys(this.oSectionsImported);const a=r.every(t=>this.oSectionsImported[t]);if(a){this.fireEvent("sectionsImported")}},resetImportModel:function t(e){this.oControlModel.setProperty("/import/sections",[]);this.oControlModel.setProperty("/import/sectionsSelected",false);this.oControlModel.setProperty("/import/error",false);if(e){this.oControlModel.setProperty("/selectedTab","export");T.getElementById(this.getId()+"--idImportFileUploader")?.setValue("")}},getDeltaSectionViz:function e(s){try{const e=this;return Promise.resolve(H(function(){return Promise.resolve(e.oAppManagerInstance._getSections(true)).then(function(t){s.forEach(e=>{let s;if(e.default){s=t.find(t=>t.default)}else{s=t.find(t=>t.id===e.id)}if(s){const t=e.visualizations?.filter(t=>s.visualizations?.every(e=>e.isBookmark?e.targetURL!==t.targetURL:e.vizId!==t.vizId));e.visualizations=t}});s=s.filter(t=>t.visualizations&&t.visualizations.length>0);return s})},function(e){t.error("Error occurred while fetching delta section visualizations:"+String(e));return[]}))}catch(t){return Promise.reject(t)}},getDeltaAuthSectionViz:function e(s){if(s&&s.length){return this.getDeltaSectionViz(s).then(t=>this.filterAuthSectionViz(t)).catch(e=>{t.error(String(e));return[]})}return Promise.resolve([])},filterAuthSectionViz:function t(e){try{const t=function(){return M.getServiceAsync("SearchableContent").then(function(t){return t.getApps({includeAppsWithoutVisualizations:false})})};const s=function(t,e){const s=[];e?.forEach(function(e){for(let n of t){const t=n;const o=t.visualizations.find(function(t){return t.vizId===e.vizId||e.isBookmark&&t.target&&e.target?.action===t.target.action&&e.target?.semanticObject===t.target.semanticObject});if(o){o.displayFormatHint=e.displayFormatHint!=="standard"?String(e.displayFormatHint):String(o.displayFormatHint);o.id=String(e.id??o.id);s.push(e.isBookmark?e:o);break}}});return s};return Promise.resolve(t().then(function(t){return e.map(function(e){e.visualizations=s(t,e.visualizations);return e})}))}catch(t){return Promise.reject(t)}},filterAuthFavPages:function t(e){try{let s=false;const n=this;function o(t){return s?t:Promise.resolve([])}const i=function(){if(e&&e.length>0){return Promise.resolve(n.oPageManagerInstance.fetchAllAvailablePages().then(function(t){return e.filter(function(e){return t.filter(function(t){return t.pageId===e.pageId&&t.spaceId===e.spaceId}).length})})).then(function(t){s=true;return t})}}();return Promise.resolve(i&&i.then?i.then(o):o(i))}catch(r){return Promise.reject(r)}},filterAuthCards:function t(e){try{let s=false;function n(t){return s?t:Promise.resolve([])}const o=function(t,e){return t.find(function(t){return t.resolutionResult&&t.resolutionResult.applicationDependencies&&e["sap.insights"]&&t.resolutionResult.applicationDependencies.name===e["sap.insights"].parentAppId})};const i=function(t,e){if(e){return t.isNavigationSupported([{target:{semanticObject:e.semanticObject,action:e.action}}]).then(function(t){return t[0].supported||false})}return Promise.resolve(false)};const r=function(){if(e&&e.length>0){return Promise.resolve(Promise.all([M.getServiceAsync("ClientSideTargetResolution"),M.getServiceAsync("Navigation")]).then(function(t){const s=t[0];const n=t[1];const r=s._oAdapter._aInbounds||[];return e.reduce(function(t,e){return Promise.resolve(t).then(function(t){const s=o(r,e);return Promise.resolve(i(n,s)).then(function(s){if(s){t.push(e)}return t})})},Promise.resolve([]))})).then(function(t){s=true;return t})}}();return Promise.resolve(r&&r.then?r.then(n):n(r))}catch(a){return Promise.reject(a)}},onFileImport:function e(s){this.handleUserPersonalizationError(ot.IMPORT,false,"","");this.resetImportModel();this.oDetailPage.setBusy(true);const n=s.getParameter("files");const o=n&&n[0];return this.readFileContent(o).then(t=>{const e=window.btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,function(t,e){return String.fromCharCode(parseInt(e,16))}));return tt.Post(at,{fileContent:e}).then(t=>{if(t&&t.error){throw new Error(t.error)}if(t&&t.value&&t.value.length){const e=t.value[0].fileContent;const s=JSON.parse(e);if(s.host===window.location.host){const t=s.sections||[];t.push({id:lt,visualizations:s.tiles||[]});return this.filterAuthorizedImportData(t,s)}else{this.handleUserPersonalizationError(ot.IMPORT,true,String(this._i18nBundle.getText("importSourceErrorMessage")),"");return Promise.resolve()}}})}).catch(e=>{t.error(String(e));this.handleUserPersonalizationError(ot.IMPORT,true,"","")}).finally(()=>{this.oDetailPage.setBusy(false);this.enableDisableActions(ot.IMPORT)})},filterAuthorizedImportData:function t(e,s){try{const t=this;let n=[t.getDeltaAuthSectionViz(e),t.filterAuthFavPages(s.favouritePages)];return Promise.resolve(t.isInsightsEnabled()).then(function(e){if(e){n.push(t.filterAuthCards(s.cards));n.push(t.getInsightCards())}return Promise.all(n).then(function(e){try{const n=e[0];const o=e[1];const i=e[2]||[];const r=e[3]?.getProperty("/cardCount")||0;s.apps=n.filter(function(t){return t.id!==lt});s.tiles=(n.find(function(t){return t.id===lt})||{}).visualizations||[];s.favouritePages=o;s.cards=i||[];const a=r+Number(i?.length);if(a>99){t.handleUserPersonalizationError(ot.IMPORT,true,String(t._i18nBundle.getText("importCardCountErrorMessage")),"")}return Promise.resolve(t.getImportedSections(s,ot.IMPORT,r)).then(function(e){e=e.map(function(t){t.status=j.None;return t});t.oUserPersonalization.import.data=s;t.oControlModel.setProperty("/import/sections",e);t.oControlModel.setProperty("/import/sectionsSelected",t.getSelectedSections(e).length>0);t.oControlModel.setProperty("/showNoImport",e.length===0)})}catch(t){return Promise.reject(t)}})})}catch(t){return Promise.reject(t)}},readFileContent:function t(e){return new Promise(function(t,s){if(e&&window.FileReader){const s=new FileReader;s.onload=function(e){const s=e.target;t(s?.result)};const n=e;s.readAsText(n)}else{s(new Error("Error"))}})},_getPersonalizationData:function t(){try{const e=this;function s(){return Promise.resolve(e.oPersonalizerInstance.read()).then(function(t){e.persData=t||{};return e.persData})}const n=function(){if(!e.oPersonalizerInstance){return Promise.resolve(nt.getInstance(st.getPersContainerId(e._getPanel()),st.getOwnerComponent(e._getPanel()))).then(function(t){e.oPersonalizerInstance=t})}}();return Promise.resolve(n&&n.then?n.then(s):s(n))}catch(o){return Promise.reject(o)}},loadUserPersonalizationData:function t(){try{const t=this;t.oExportList.setBusy(true);return Promise.resolve(t._getPersonalizationData()).then(function(e){let s=[t.oAppManagerInstance._getSections(true)];return Promise.resolve(t.isInsightsEnabled()).then(function(n){if(n){s.push(t.getInsightCards())}return Promise.resolve(Promise.all(s)).then(function(s){const[n,o]=s;const i=n,r=i.filter(t=>t.id!==lt&&t.visualizations?.length);const a=i.find(t=>t.id===lt)?.visualizations||[];const l=o&&o.getProperty("/visibleCards")?o.getProperty("/visibleCards").map(t=>t.descriptorContent):[];const c={apps:r,tiles:a,favouritePages:e.favouritePages,cards:l,personalization:e};return Promise.resolve(t.getImportedSections(c,ot.EXPORT,0)).then(function(e){t.oUserPersonalization.export.data=c;t.oUserPersonalization.export.sections=e;t.oUserPersonalization.export.sectionsSelected=t.getSelectedSections(e).length>0;t.oControlModel.refresh();t.oExportList.setBusy(false)})})})})}catch(t){return Promise.reject(t)}},isInsightsEnabled:function s(){try{let s=false;return Promise.resolve(H(function(){let t=false;return Promise.resolve(e.getServiceAsync()).then(function(t){if(t){s=true;return true}return false})},function(e){t.error(e instanceof Error?e.message:String(e));return false}))}catch(t){return Promise.reject(t)}},getSelectedSections:function t(e){return e.filter(function(t){return t.selected&&t.enabled})||[]},isSectionSelected:function t(e,s){const n=e.find(function(t){return t.title===s});return!!(n&&n.selected&&n.enabled)},getImportedSections:function t(e,s,n){try{const o=this;function i(t){const s=e.apps&&e.apps.some(function(t){return t&&t.visualizations&&t.visualizations.length>0});const i=[{title:o._i18nBundle.getText("favApps"),selected:s,enabled:s,panelClass:ht},{title:o._i18nBundle.getText("pages"),selected:t?.length>0,enabled:t?.length>0,panelClass:ut},{title:o._i18nBundle.getText("insightsTiles"),selected:e.tiles&&e.tiles.length>0,enabled:e.tiles&&e.tiles.length>0,panelClass:mt}];return Promise.resolve(o.isInsightsEnabled()).then(function(t){if(t){i.push({title:o._i18nBundle.getText("insightsCards"),selected:e.cards&&e.cards.length>0&&e.cards.length+n<=99,enabled:e.cards&&e.cards.length>0&&e.cards.length+n<=99,panelClass:ft})}return i})}const r=s===ot.IMPORT;return Promise.resolve(r?Promise.resolve(o.getDeltaFavPages(e.favouritePages)).then(i):i(e.favouritePages))}catch(a){return Promise.reject(a)}},getDeltaFavPages:function t(e){try{const t=this;return Promise.resolve(t._getPersonalizationData()).then(function(t){const s=t.favouritePages||[];return s.length!==e.length?e:e.filter(function(t){return!s.find(function(e){return t.pageId===e.pageId&&t.spaceId===e.spaceId})})})}catch(t){return Promise.reject(t)}},getInsightCards:function t(){try{const t=this;return Promise.resolve(H(function(){return Promise.resolve(e.getServiceAsync()).then(function(e){t.cardHelperInstance=e;return Promise.resolve(t.cardHelperInstance._getUserAllCardModel()).then(function(t){const e=t.getProperty("/cards");const s=e.filter(function(t){return t.visibility});t.setProperty("/visibleCards",s);return t})})},function(t){throw t}))}catch(t){return Promise.reject(t)}},onExportPress:function e(){this.handleUserPersonalizationError(ot.EXPORT,false,"","");const s=this.oControlModel.getProperty("/export/fileName"),n=this.oControlModel.getProperty("/export/sections"),o=this.oUserPersonalization.export.data;const i=this.getExportFileContent(o,n);sap.ui.require(["sap/ui/core/util/File"],e=>{try{e.save(JSON.stringify(i),s,"txt","text/plain","utf-8");h.show(String(this._i18nBundle.getText("userPersonalizationExportSuccess")))}catch(e){t.error(e instanceof Error?e.message:String(e));if(e instanceof Error&&e?.name!==undefined&&e.name!=="AbortError"){this.handleUserPersonalizationError(ot.EXPORT,true,"","")}}})},getExportFileContent:function t(e,s){const n=e?.personalization,o={host:window.location.host,createdDate:new Date,sections:[],groupInfo:[],tiles:[],cards:[],favouritePages:[]};if(this.isSectionSelected(s,this._i18nBundle.getText("favApps"))){o.sections=e?.apps||[];o.groupInfo=n?.favoriteApps||[]}if(this.isSectionSelected(s,this._i18nBundle.getText("pages"))){o.favouritePages=n?.favouritePages||[]}if(this.isSectionSelected(s,this._i18nBundle.getText("insightsTiles"))){o.tiles=e?.tiles||[]}if(this.isSectionSelected(s,this._i18nBundle.getText("insightsCards"))){o.cards=this.filterNonSensitiveCards(e?.cards||[])}return o},filterNonSensitiveCards:function t(e){const s=[];e.forEach(t=>{if(t["sap.card"]?.configuration?.parameters){const e=t["sap.card"].configuration.parameters;let n=[];n=n.concat(this.getSensitiveProps(e.headerState)).concat(this.getSensitiveProps(e.lineItemState)).concat(this.getSensitiveProps(e.state));if(n.length===0){s.push(t)}}else{s.push(t)}});if(e.length!==s.length){this.handleUserPersonalizationError(ot.EXPORT,true,String(this._i18nBundle.getText("exportSensitiveCardsErrorMessage")),"Warning")}return s},getSensitiveProps:function t(e){let s=[];if(e?.value){const t=JSON.parse(e.value);const n=t.sensitiveProps||Object.keys(t.parameters?.ibnParams?.sensitiveProps||{});if(n.length>0){s=s.concat(n)}}return s},handleUserPersonalizationError:function t(e,s,n,o){const i=this._i18nBundle.getText(e===ot.IMPORT?"importErrorMessage":"exportErrorMessage");this.oControlModel.setProperty("/"+e+"/error",s,undefined,true);this.oControlModel.setProperty("/"+e+"/errorMessage",n||i,undefined,true);this.oControlModel.setProperty("/"+e+"/errorType",o||"Error",undefined,true);this.setExportImportValues(e)},onImportExportTabSelect:function t(e){const s=e.getParameter("selectedKey");this.oSelectedTab=s;this.oControlModel.setProperty("/selectedTab",s);this.oExportList.setVisible(s==="export");this.oImportBtn.setVisible(s==="import");this.oExportBtn.setVisible(s==="export");this.oImportBtn.setEnabled(this.oUserPersonalization.import.sectionsSelected);this.oExportBtn.setEnabled(this.oUserPersonalization.export.sectionsSelected);this.oExportBtn.setEnabled(!!(this.oUserPersonalization.export.fileName&&this.oUserPersonalization.export.sections&&this.oUserPersonalization.export.sections.length>0&&this.oUserPersonalization.export.sectionsSelected))},onFileNameInputChange:function t(e){const s=e.getParameter("value")?.trim();const n=e.getSource();let o=j.None;let i="";if(!s||!s.length){o=j.Error;i=String(this._i18nBundle.getText("invalidExportFileName"))}n.setValueState(o);n.setValueStateText(i);this.oControlModel.setProperty("/export/fileName",s);this.enableDisableActions(ot.EXPORT)},onResetImportApps:function t(){this.oEventBus.publish("importChannel","resetImported");h.show(this._i18nBundle.getText("importAppsNowBtnEnabled"))},_getRecommendationSettingsPanel:function t(){try{const t=this;return Promise.resolve(t._getPersonalizationData()).then(function(e){if(!t._recommendationSettingsPanel){const s=t.getId()+"--recommendationSettingsPanel";t._recommendationSettingsPanel=new f(s,{headerToolbar:new m(t.getId()+"--idRecommenedPanelToolbar",{content:[new I({text:t._i18nBundle.getText("recommendationSettingsHeader"),level:"H3"})]}),expanded:true,expandable:true,content:[new P({id:`${s}-container-subHeader`,text:t._i18nBundle.getText("recommendationSettingsSubHeader")}),new i({id:`${s}-container`,items:[new n({id:`${s}-container-checkBox`,selected:e.showRecommendation??true,select:e=>t.onRecommendationSettingChange(e),ariaLabelledBy:[`${s}-container-subHeader`,`${s}-container-label`]}),new P({id:`${s}-container-label`,text:t._i18nBundle.getText("recommendationSettingsCheckboxLabel")})],alignItems:k.Center}).addStyleClass("sapUiSmallMarginTop")]}).addStyleClass("sapUiSmallMarginTop")}return t._recommendationSettingsPanel})}catch(t){return Promise.reject(t)}},_setRecommendationSettingsPanel:function t(){try{const t=this;t.oDetailPage.setBusy(true);return Promise.resolve(t._getRecommendationSettingsPanel()).then(function(e){if(e){t.oContentVBox.addItem(e);t.oDetailPage.setBusy(false)}})}catch(t){return Promise.reject(t)}},onRecommendationSettingChange:function t(e){try{const t=this;const s=e.getParameter("selected");t.oEventBus.publish("importChannel","recommendationSettingChanged",{showRecommendation:s});return Promise.resolve(t._getPersonalizationData()).then(function(e){void t.oPersonalizerInstance.write({...e,showRecommendation:s})})}catch(t){return Promise.reject(t)}}});Pt.ImportExportType=ot;return Pt});
//# sourceMappingURL=AdvancedSettingsPanel.js.map