/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/m/Button","sap/m/Input","sap/m/Label","sap/m/MessageBox","sap/m/MessageStrip","sap/m/MessageToast","sap/m/RadioButton","sap/m/Toolbar","sap/m/VBox","sap/m/library","sap/ui/core/EventBus","sap/ui/core/message/MessageType","sap/ui/layout/form/SimpleForm","sap/ui/unified/FileUploader","sap/ushell/Container","./BaseSettingsPanel","./flexibility/Layout.flexibility","./library","./utils/Constants","./utils/HttpHelper"],function(e,t,s,i,n,o,a,l,r,d,h,c,g,u,w,p,N,F,m,y){"use strict";function f(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}function U(e,t){try{var s=e()}catch(e){return t(e)}if(s&&s.then){return s.then(void 0,t)}return s}const S=f(p);const C=N["CHANGE_TYPES"];const P=F["NewsType"];const b=m["DEFAULT_NEWS_URL"];const _=m["KEYUSER_SETTINGS_PANELS_KEYS"];const M=f(y);const I={NEWS_FEED_POST_API:"/sap/opu/odata4/ui2/insights_srv/srvd/ui2/"+"insights_repo_srv/0001/"+"NEWS_FEED"};const E=S.extend("sap.cux.home.KeyUserNewsSettingsPanel",{metadata:{library:"sap.cux.home"},init:function e(){S.prototype.init.call(this);this.controlMap=new Map;this.setProperty("key",_.NEWS);this.setProperty("title",this._i18nBundle.getText("editNewsFeed"));this.addAggregation("content",this.getContent());this.attachPanelNavigated(()=>this.loadSettings());this._eventBus=h.getInstance();this._eventBus.subscribe("KeyUserChanges","newsFeedLoadFailed",(e,t,s)=>{if(s?.showError){this.showMessageStrip(true,c.Warning,"invalidNewsUrl");this.validChanges=false}else{this.getMessageStrip().setVisible(false);this.validChanges=true}},this)},getCurrentKeyUserChange:function e(){const t=this.getKeyUserChanges();const s=t.find(e=>e.changeSpecificData.changeType===C.NEWS_FEED_URL);return s?.changeSpecificData.content},getContent:function e(){const t=`${this.getId()}-wrapperVBox`;const s=new r(t);this.controlMap.set(t,s);return s},checkNewsType:function e(t){if(this._getPanel().getProperty("type")===t)return true;return false},isValidChanges:function e(t){try{const s=this;function n(){return s.validChanges}s.validChanges=true;const o=s.getFileUploader();const a=s.getCurrentKeyUserChange();const l=s.customNewsVisibility??!!s.checkNewsType(P.Custom);const r=s.defaultNewsVisibility??!!s.checkNewsType(P.Default);const d=function(){if(s.getNewsFeedUploadBtn().getEnabled()){if(l){i.error(String(s._i18nBundle.getText("newsFeedSaveUploadChanges")));s.validChanges=false}else{if(o){o.setValue(a.customNewsFeedFileName||String(s._getPanel().getProperty("customFileName")))}}}else{const e=function(){if(l&&o.getValue()===""&&t){s.showMessageStrip(true,c.Error,"noNewsFileError");s.validChanges=false}else{const e=function(){if(!l&&!r&&t&&!s.getMessageStrip().getVisible()){const e=s.controlMap.get(`${s.getId()}-newsFeedURLInput`).getValue();const t=function(){if(!s.getValidURL(e)){s.showMessageStrip(true,c.Error,"invalidNewsUrl");s.validChanges=false}else{return Promise.resolve(s._getPanel().setURL(String(e))).then(function(){})}}();if(t&&t.then)return t.then(function(){})}}();if(e&&e.then)return e.then(function(){})}}();if(e&&e.then)return e.then(function(){})}}();return Promise.resolve(d&&d.then?d.then(n):n(d))}catch(h){return Promise.reject(h)}},clearNewsPanelChanges:function e(){const t=this._getPanel();this.getMessageStrip().setVisible(false);const s=this.controlMap.get(`${this.getId()}-newsFeedURLInput`);const i=String(t.getProperty("url"));s.setValue(i!==b?i:"");this.customNewsVisibility=this.checkNewsType(P.Custom);this.defaultNewsVisibility=this.checkNewsType(P.Default);this.rssNewsVisibility=this.checkNewsType(P.NewsUrl);this.controlMap.get(`${this.getId()}-customNewsUploadFileUploader`).setEnabled(this.customNewsVisibility);this.controlMap.get(`${this.getId()}-newsFeedURLInput`).setEnabled(this.rssNewsVisibility);this.controlMap.get(`${this.getId()}-customNewsFeedRadioBtn`).setSelected(this.customNewsVisibility);this.controlMap.get(`${this.getId()}-defaultNewsFeedRadioBtn`).setSelected(this.defaultNewsVisibility);this.controlMap.get(`${this.getId()}-newsUrlRadioBtn`).setSelected(this.rssNewsVisibility);this.getFileUploader().setValue(String(t.getProperty("customFileName")));this.clearKeyUserChanges()},addMessageStrip:function e(t){const s=`${this.getId()}-keyUserNewsPanelToolbar`;if(!this.controlMap.get(s)){const e=new l(s,{height:"auto"});const t=new r(`${this.getId()}-messageStripWrapper`,{width:"100%"});const i=`${this.getId()}-messageStrip`;const o=new n(i,{showIcon:true,visible:false});this.controlMap.set(i,o);t.addItem(o);e.addContent(t);this.controlMap.set(s,e)}t.addItem(this.controlMap.get(s))},handleSelectCustomNewsFeed:function e(t){this.customNewsVisibility=t.getParameter("selected");this.controlMap.get(`${this.getId()}-customNewsUploadFileUploader`).setEnabled(this.customNewsVisibility);this.controlMap.get(`${this.getId()}-newsFeedURLInput`).setEnabled(!this.customNewsVisibility);const s=this._getPanel();const i=s.getParent();const n=i.getParent();const o=this.getCurrentKeyUserChange();if(!o){this.addKeyUserChanges({selectorControl:n,changeSpecificData:{changeType:C.NEWS_FEED_URL,content:{oldNewsFeedUrl:String(this._getPanel().getProperty("url")),oldShowCustomNewsFeed:this.checkNewsType(P.Custom),oldCustomNewsFeedKey:String(this._getPanel().getProperty("customFeedKey")),oldshowDefaultNewsFeed:this.checkNewsType(P.Default),oldShowRssNewsFeed:this.checkNewsType(P.NewsUrl),newsFeedURL:String(this._getPanel().getProperty("url")),showCustomNewsFeed:this.customNewsVisibility,customNewsFeedKey:String(this._getPanel().getProperty("customFeedKey")),customNewsFeedFileName:String(this._getPanel().getProperty("customFileName")),showDefaultNewsFeed:false,showRssNewsFeed:false}}});this._eventBus.publish("KeyUserChanges","addNewsPagesChanges",{changes:this.getKeyUserChanges()})}else if(o.showCustomNewsFeed!==this.customNewsVisibility){o.showCustomNewsFeed=this.customNewsVisibility}this.removeUrlMesageStrip();this._eventBus.publish("KeyUserChanges","disabledSaveBtn",{disable:false,date:new Date})},addCustomNewsFeedRadioBtn:function e(t){const s=`${this.getId()}-customNewsFeedRadioBtn`;const i=this.checkNewsType(P.Custom);if(!this.controlMap.get(s)){const e=new a(`${this.getId()}-customNewsFeedRadioBtn`,{text:this._i18nBundle.getText("selectCustomNewsFeed"),selected:i,select:this.handleSelectCustomNewsFeed.bind(this)}).addStyleClass("sapUiTinyMargin");this.controlMap.set(s,e)}else if(!this.getCurrentKeyUserChange()){let e=this.controlMap.get(`${this.getId()}-customNewsFeedRadioBtn`);e.setSelected(i);this.controlMap.get(`${this.getId()}-customNewsUploadFileUploader`).setEnabled(i)}t.addItem(this.controlMap.get(s))},addDefaultNewsFeedRadioBtn:function e(t){const s=`${this.getId()}-defaultNewsFeedRadioBtn`;const i=this.checkNewsType(P.Default);if(!this.controlMap.get(s)){const e=new a(`${this.getId()}-defaultNewsFeedRadioBtn`,{text:this._i18nBundle.getText("selectDefaultNewsFeed"),selected:i,select:this.handleselectDefaultNewsFeed.bind(this)}).addStyleClass("sapUiTinyMargin");this.controlMap.set(s,e)}else if(!this.getCurrentKeyUserChange()){let e=this.controlMap.get(`${this.getId()}-defaultNewsFeedRadioBtn`);e.setSelected(i)}t.addItem(this.controlMap.get(s))},addNewsPaneLabel:function e(t){const i=`${this.getId()}-newsPanelLabel`;if(!this.controlMap.get(i)){const e=new s(i,{text:this._i18nBundle.getText("newsFeedOptionLabel")}).addStyleClass("sapUiTinyMargin");this.controlMap.set(i,e)}t.addItem(this.controlMap.get(i))},handleSelectRssNewsFeed:function e(t){this.rssNewsVisibility=t.getParameter("selected");this.controlMap.get(`${this.getId()}-customNewsUploadFileUploader`).setEnabled(!this.rssNewsVisibility);this.controlMap.get(`${this.getId()}-newsFeedURLInput`).setEnabled(this.rssNewsVisibility);const s=this._getPanel();const i=s.getParent();const n=i.getParent();const o=this.getCurrentKeyUserChange();if(!o){this.addKeyUserChanges({selectorControl:n,changeSpecificData:{changeType:C.NEWS_FEED_URL,content:{oldNewsFeedUrl:String(this._getPanel().getProperty("url")),oldShowCustomNewsFeed:this.checkNewsType(P.Custom),oldCustomNewsFeedKey:String(this._getPanel().getProperty("customFeedKey")),oldshowDefaultNewsFeed:this.checkNewsType(P.Default),oldShowRssNewsFeed:this.checkNewsType(P.NewsUrl),newsFeedURL:String(this._getPanel().getProperty("url")),showCustomNewsFeed:false,customNewsFeedKey:String(this._getPanel().getProperty("customFeedKey")),customNewsFeedFileName:String(this._getPanel().getProperty("customFileName")),showDefaultNewsFeed:false,showRssNewsFeed:this.rssNewsVisibility}}});this._eventBus.publish("KeyUserChanges","addNewsPagesChanges",{changes:this.getKeyUserChanges()})}else if(o.showRssNewsFeed!==this.rssNewsVisibility){o.showRssNewsFeed=this.rssNewsVisibility}this.removeUrlMesageStrip();this._eventBus.publish("KeyUserChanges","disabledSaveBtn",{disable:false,date:new Date})},addNewsUrlRadioBtn:function e(t){const s=`${this.getId()}-newsUrlRadioBtn`;const i=this.checkNewsType(P.NewsUrl);if(!this.controlMap.get(s)){const e=new a(`${this.getId()}-newsUrlRadioBtn`,{text:this._i18nBundle.getText("selectNewsFeedUrl"),selected:i,select:this.handleSelectRssNewsFeed.bind(this)}).addStyleClass("sapUiTinyMargin");this.controlMap.set(s,e)}else if(!this.getCurrentKeyUserChange()){let e=this.controlMap.get(`${this.getId()}-newsUrlRadioBtn`);e.setSelected(i);this.controlMap.get(`${this.getId()}-newsFeedURLInput`).setEnabled(i)}t.addItem(this.controlMap.get(s))},handleselectDefaultNewsFeed:function e(t){this.defaultNewsVisibility=t.getParameter("selected");this.controlMap.get(`${this.getId()}-customNewsUploadFileUploader`).setEnabled(!this.defaultNewsVisibility);this.controlMap.get(`${this.getId()}-newsFeedURLInput`).setEnabled(!this.defaultNewsVisibility);const s=this._getPanel();const i=s.getParent();const n=i.getParent();const o=this.getCurrentKeyUserChange();const a=this.controlMap.get(`${this.getId()}-newsFeedURLInput`);if(!o){this.addKeyUserChanges({selectorControl:n,changeSpecificData:{changeType:C.NEWS_FEED_URL,content:{oldNewsFeedUrl:String(this._getPanel().getProperty("url")),oldShowCustomNewsFeed:this.checkNewsType(P.Custom),oldCustomNewsFeedKey:String(this._getPanel().getProperty("customFeedKey")),oldshowDefaultNewsFeed:this.checkNewsType(P.Default),oldShowRssNewsFeed:this.checkNewsType(P.NewsUrl),newsFeedURL:String(a.getValue()),showCustomNewsFeed:false,customNewsFeedKey:String(this._getPanel().getProperty("customFeedKey")),customNewsFeedFileName:String(this._getPanel().getProperty("customFileName")),showDefaultNewsFeed:this.defaultNewsVisibility,showRssNewsFeed:false}}});this._eventBus.publish("KeyUserChanges","addNewsPagesChanges",{changes:this.getKeyUserChanges()})}else if(o.showDefaultNewsFeed!==this.defaultNewsVisibility){o.showDefaultNewsFeed=this.defaultNewsVisibility;o.showCustomNewsFeed=false}this.removeUrlMesageStrip();this._eventBus.publish("KeyUserChanges","disabledSaveBtn",{disable:false,date:new Date})},onNewsUrlChange:function e(t){const s=this._getPanel();const i=s.getParent();const n=i.getParent();let o=t.getParameter("value");const a=this.getCurrentKeyUserChange();const l=this.getValidURL(String(o));if(!l){return}else{o=l}if(!a){this.addKeyUserChanges({selectorControl:n,changeSpecificData:{changeType:C.NEWS_FEED_URL,content:{oldNewsFeedUrl:String(this._getPanel().getProperty("url")),oldShowCustomNewsFeed:this.checkNewsType(P.Custom),oldCustomNewsFeedKey:String(this._getPanel().getProperty("customFeedKey")),oldshowDefaultNewsFeed:this.checkNewsType(P.Default),oldShowRssNewsFeed:this.checkNewsType(P.NewsUrl),newsFeedURL:o,showCustomNewsFeed:false,customNewsFeedKey:String(this._getPanel().getProperty("customFeedKey")),customNewsFeedFileName:String(this._getPanel().getProperty("customFileName")),showDefaultNewsFeed:false,showRssNewsFeed:this.rssNewsVisibility}}});this._eventBus.publish("KeyUserChanges","addNewsPagesChanges",{changes:this.getKeyUserChanges()})}else if(a.newsFeedURL!==o){a.newsFeedURL=o;a.showCustomNewsFeed=false;a.showDefaultNewsFeed=false}},showMessageStrip:function e(t,s,i){this.getMessageStrip().setType(s);this.getMessageStrip().setVisible(t);this.getMessageStrip().setText(String(this._i18nBundle.getText(i)));if(s===c.Error){this._eventBus.publish("KeyUserChanges","disabledSaveBtn",{disable:t,date:new Date})}},getValidURL:function e(t){try{const e=new URL(t);return e.href}catch{return""}},removeUrlMesageStrip:function e(){this._eventBus.publish("KeyUserChanges","disabledSaveBtn",{disable:false,date:new Date});this.getMessageStrip().setVisible(false);const t=this.controlMap.get(`${this.getId()}-newsFeedURLInput`);if(!this.getValidURL(t.getValue())){t.setValue("")}},onUrlLiveChange:function e(t){const s=t.getParameter("value")||"";this.showMessageStrip(!this.getValidURL(s),c.Error,"invalidNewsUrl")},getMessageStrip:function e(){const t=`${this.getId()}-messageStrip`;return this.controlMap.get(t)},addNewsURLSimpleForm:function e(s){const i=`${this.getId()}-newsFeedURLSimpleForm`;const n=this.checkNewsType(P.NewsUrl);const o=String(this._getPanel().getProperty("url"));if(!this.controlMap.get(i)){const e=new g(`${this.getId()}-newsFeedURLSimpleForm`).addStyleClass("sapContrastPlus formCustomPadding");const s=`${this.getId()}-newsFeedURLInput`;const a=new t(s,{value:o!==b?o:"",type:d.InputType.Url,change:this.onNewsUrlChange.bind(this),liveChange:this.onUrlLiveChange.bind(this),enabled:n});this.controlMap.set(s,a);e.addContent(a);this.controlMap.set(i,e)}else if(this.getCurrentKeyUserChange()){let e=this.controlMap.get(`${this.getId()}-newsFeedURLInput`);e.setValue(o)}s.addItem(this.controlMap.get(i))},handleFileChange:function e(t){const s=t.getSource();this.getMessageStrip().setVisible(false);this._eventBus.publish("KeyUserChanges","disabledSaveBtn",{disable:false,date:new Date});this.setNewsFeedEnabled(s.getValue()!=="")},setNewsFeedEnabled:function e(t){const s=this.getNewsFeedUploadBtn();if(s){s.setEnabled(t)}},getNewsFeedUploadBtn:function e(){const t=`${this.getId()}-customNewsUploadFileUploaderButton`;return this.controlMap.get(t)},handleFileUploadError:function e(t){const s=t.getSource();const n=s.getMaximumFileSize();this.setNewsFeedEnabled(false);i.error(String(this._i18nBundle.getText("newsFeedMaxFileSizeError",[n])))},handleFileDialogClose:function e(t){const s=t.getSource();let i=s.getValue();if(i===""){i=this.getCurrentKeyUserChange()?.customNewsFeedFileName||String(this._getPanel().getProperty("customFileName"));this.setNewsFeedEnabled(false)}s.setValue(i)},handleNewsFeedFileUpload:function e(){try{const e=this;let t=e._i18nBundle.getText("newsFeedFileUploadError");return Promise.resolve(U(function(){return Promise.resolve(Promise.all([e.getUploadedFile(),w.getServiceAsync("UserInfo")])).then(function(s){const i=s[0];const n=s[1];const a=n&&n.getId();const l={changeId:a+"_"+Date.now().toString(),attachment:i.content};if(i.type){l.documentType=i.type}return Promise.resolve(M.Post(I.NEWS_FEED_POST_API,l)).then(function(s){const i=e.getCurrentKeyUserChange();const n=e._getPanel();const a=n.getParent();const l=a.getParent();if(s&&s.error){e.getFileUploader().setValue("");if(i){i.customNewsFeedFileName=""}else{e.addKeyUserChanges({selectorControl:l,changeSpecificData:{changeType:C.NEWS_FEED_URL,content:{oldNewsFeedUrl:String(e._getPanel().getProperty("url")),oldShowCustomNewsFeed:e.checkNewsType(P.Custom),oldCustomNewsFeedKey:String(e._getPanel().getProperty("customFeedKey")),oldshowDefaultNewsFeed:e.checkNewsType(P.Default),oldShowRssNewsFeed:e.checkNewsType(P.NewsUrl),newsFeedURL:String(e._getPanel().getProperty("url")),showCustomNewsFeed:true,customNewsFeedKey:String(e._getPanel().getProperty("customFeedKey")),customNewsFeedFileName:String(e._getPanel().getProperty("customFileName")),showDefaultNewsFeed:false,showRssNewsFeed:false}}})}t=s.error.message.includes("NODATA")?e._i18nBundle.getText("newsFeedEmptyFileError"):t;throw new Error(t)}const r=s.changeId;if(i){i.customNewsFeedKey=r;i.customNewsFeedFileName=e.getFileUploader().getValue()}else{e.addKeyUserChanges({selectorControl:l,changeSpecificData:{changeType:C.NEWS_FEED_URL,content:{oldNewsFeedUrl:String(e._getPanel().getProperty("url")),oldShowCustomNewsFeed:e.checkNewsType(P.Custom),oldCustomNewsFeedKey:String(e._getPanel().getProperty("customFeedKey")),oldshowDefaultNewsFeed:e.checkNewsType(P.Default),oldShowRssNewsFeed:e.checkNewsType(P.NewsUrl),newsFeedURL:String(e._getPanel().getProperty("url")),showCustomNewsFeed:true,customNewsFeedKey:r,customNewsFeedFileName:e.getFileUploader().getValue(),showDefaultNewsFeed:false,showRssNewsFeed:false}}});e._eventBus.publish("KeyUserChanges","addNewsPagesChanges",{changes:e.getKeyUserChanges()})}o.show(String(e._i18nBundle.getText("customNewsFeedUploaded")));e.setNewsFeedEnabled(false)})})},function(t){i.error(t.message);e.setNewsFeedEnabled(false)}))}catch(e){return Promise.reject(e)}},getUploadedFile:function e(){return new Promise((e,t)=>{const s=this.getFileUploader();let i=this._i18nBundle.getText("newsFeedFileUploadError");if(s&&!s.getValue()){i=this._i18nBundle.getText("noNewsFileError");t(new Error(i))}const n=s.oFileUpload.files[0];const o=new FileReader;o.onload=function(){try{const t=o.result;let s;const i={type:"",content:""};if(n.type==="text/csv"){s=window.btoa(encodeURIComponent(String(t)).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode(parseInt(t,16))}));i.type="CSV"}else{s=t.replace("data:","").replace(/^.+,/,"")}i.content=s;e(i)}catch{t(new Error(i))}};if(n.type==="text/csv"){o.readAsText(n)}else{o.readAsDataURL(n)}})},getFileUploader:function e(){const t=`${this.getId()}-customNewsUploadFileUploader`;return this.controlMap.get(t)},addCustomNewsUploadSimpleForm:function t(s){const i=`${this.getId()}-customNewsUploadSimpleForm`;if(!this.controlMap.get(i)){const t=new g(`${this.getId()}-customNewsUploadSimpleForm`).addStyleClass("sapContrastPlus formCustomPadding");const s=new r(`${this.getId()}-customNewsUploadVBox`);const n=`${this.getId()}-customNewsUploadFileUploader`;const o=this._getPanel();const a=new u(n,{name:"newsFeedFileUploader",tooltip:this._i18nBundle.getText("uploadNewsFeedFile"),fileType:o?.getProperty("supportedFileFormats"),width:"100%",change:this.handleFileChange.bind(this),maximumFileSize:25,fileSizeExceed:this.handleFileUploadError.bind(this),sameFilenameAllowed:true,afterDialogClose:this.handleFileDialogClose.bind(this),value:String(this._getPanel().getProperty("customFileName")),enabled:this.checkNewsType(P.Custom)});this.controlMap.set(n,a);const l=`${this.getId()}-customNewsUploadFileUploaderButton`;const d=new e(l,{text:this._i18nBundle.getText("uploadNewsFeedBtn"),press:this.handleNewsFeedFileUpload.bind(this),type:"Emphasized",enabled:false});this.controlMap.set(l,d);s.addItem(a);s.addItem(d);t.addContent(s);this.controlMap.set(i,t)}s.addItem(this.controlMap.get(i))},loadSettings:function e(){const t=`${this.getId()}-wrapperVBox`;const s=this.controlMap.get(t);s.removeAllItems();this.addMessageStrip(s);this.addNewsPaneLabel(s);this.addDefaultNewsFeedRadioBtn(s);this.addNewsUrlRadioBtn(s);this.addNewsURLSimpleForm(s);this.addCustomNewsFeedRadioBtn(s);this.addCustomNewsUploadSimpleForm(s)}});return E});
//# sourceMappingURL=KeyUserNewsSettingsPanel.js.map