/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/m/MessageBox","sap/m/library","sap/ui/base/Object","sap/ui/core/Element","sap/ui/core/Fragment","sap/ui/core/library","sap/ui/model/json/JSONModel","sap/ui/model/odata/v2/ODataModel","sap/ui/model/resource/ResourceModel","./DataFormatUtils","./TaskUtils"],function(e,t,n,o,i,s,r,a,c,l,d,u){"use strict";function g(e,t){try{var n=e()}catch(e){return t(e)}if(n&&n.then){return n.then(void 0,t)}return n}const f=n["ButtonType"];const h=r["ValueState"];const p=d["toTaskPriorityText"];const m=u["TaskPriority"];var S=function(e){e["Required"]="REQUIRED";e["Optional"]="OPTIONAL";return e}(S||{});const D=e=>{switch(e.Nature?.toUpperCase()){case"POSITIVE":return f.Accept;case"NEGATIVE":return f.Reject;case"NEUTRAL":return f.Neutral;default:return f.Default}};const O=(e,t,n,o)=>({text:e.DecisionText,type:D(e)||f.Default,pressHandler:I.decisionDialogMethod.bind(null,e,t,n,o)});function y(e){let t="";if(e===m.VERY_HIGH||e===m.HIGH){t="sap-icon://high-priority"}return t}function M(e){return e===m.VERY_HIGH||e===m.HIGH?h.Error:h.None}const I=o.extend("sap.cux.home.utils.DecisionDialog",{constructor:function e(t,n,i,s,r){o.prototype.constructor.call(this);this.decisionOption=t;this.i18nBundle=n;this.baseUrl=s;this.refreshView=r;this.task=i},handleReasonOptionChange:function t(n){const o=n.getSource();const i=o.getValue();const s=o.getSelectedItem();this.confirmationDialogPromise.then(e=>{const t=this.confirmationDialogModel.getData().dialogSettings.reasonOptionsSettings.required;o.setTooltip(i);o.setValueState(s===null?h.Error:h.None);if(!t&&i===""){o.setValueState(h.None)}if(!t&&i!==""&&s===null){e.getBeginButton().setEnabled(false);return}this._toggleSubmitButtonState()}).catch(t=>{e.error(t instanceof Error?t.message:String(t))})},_toggleSubmitButtonState:function e(){const t=this.confirmationDialogModel.getData();const n=t.dialogSettings.noteMandatory;const o=i.getElementById("confirmDialogTextarea").getValue().trim().length>0;const s=t.dialogSettings.reasonOptionsSettings.required;const r=i.getElementById("reasonOptionsSelect").getSelectedItem()!==null;const a=n&&o||!n;const c=s&&r||!s;this.confirmationDialogModel.setProperty("/submitButtonEnabled",a&&c)},readReasonOptions:function e(t,n,o,i,s){const r="/ReasonOptions";const a={SAP__Origin:`'${t}'`,InstanceID:`'${n}'`,DecisionKey:`'${o}'`};const c=e=>{if(e&&e.results){if(i){i(e.results)}}};const l=e=>{if(s){s(e)}};this.dataServiceModel.read(r,{urlParameters:a,success:c,error:l,groupId:"reasonOptions"})},loadReasonOptions:function e(){try{const e=this;const t=e.dataServiceModel.getMetaModel();return Promise.resolve(t.loaded()).then(function(){if(t.getODataFunctionImport("ReasonOptions")){return new Promise((t,n)=>{e.readReasonOptions(e.decisionOption.SAP__Origin,e.decisionOption.InstanceID,e.decisionOption.DecisionKey,n=>{const o={show:(e.decisionOption.ReasonRequired===S.Required||e.decisionOption.ReasonRequired===S.Optional)&&n.length>0,required:e.decisionOption.ReasonRequired===S.Required,reasonOptions:n};t(o)},e=>{n(e)})})}else{return null}})}catch(e){return Promise.reject(e)}},openDecisionDialog:function t(n){this.confirmationDialogModel=new a({submitButtonEnabled:!n?.noteMandatory&&!n?.reasonOptionsSettings?.required,dialogSettings:n});this.confirmationDialogPromise=s.load({type:"XML",name:"sap.cux.home.utils.fragment.showDecisionDialog",controller:this}).then(e=>{const t=e;const n=new l({bundle:this.i18nBundle});const o=i.getElementById("task-priority-text");o.addStyleClass(this.task.Priority);t.setModel(this.confirmationDialogModel);t.setModel(n,"i18n");t.open();return t}).catch(t=>{e.error(t instanceof Error?t.message:String(t))})},confirmActionHandler:function t(){this.confirmationDialogPromise.then(e=>{const t=(e.getModel()?.getProperty("/")).dialogSettings;const n=t.reasonOptionsSettings;const o=n.show?i.getElementById("reasonOptionsSelect")?.getSelectedItem():null;const s=o!==null&&o?.getKey()!=="defaultSelectedKey"?o.getKey():null;const r=t.showNote?i.getElementById("confirmDialogTextarea")?.getValue():null;t.confirmActionHandler(r,s)}).catch(t=>{e.error(t instanceof Error?t.message:String(t))})},handleCancel:function t(){this.confirmationDialogPromise.then(e=>{const t=(e.getModel()?.getProperty("/")).dialogSettings;e._bClosedViaButton=true;e.close();t.cancelActionHandler();if(this.confirmationDialogModel.getProperty("/dialogSettings/showFeedbackMessage")){this.dataServiceModel.refresh();this.refreshView(true)}}).catch(t=>{e.error(t instanceof Error?t.message:String(t))})},handleAfterClose:function t(){this.confirmationDialogPromise.then(e=>{if(e._bClosedViaButton){e._bClosedViaButton=false}else{const t=(e.getModel()?.getProperty("/")).dialogSettings;t.cancelActionHandler()}e.destroy()}).catch(t=>{e.error(t instanceof Error?t.message:String(t))})},createODataRequest:function t(n,o,i,s){const r={success:(t,n)=>{e.info("successful action");i?.(t,n)},error:e=>{const t=this.i18nBundle.getText("DataManager.HTTPRequestFailed");const n=e.response?e.response.body:null;const o={message:t,responseText:n};this.dataServiceModel.fireRequestFailed(o);s(e)},urlParameters:o};this.dataServiceModel.create(n,{},r)},sendAction:function n(o,i,s,r,a){const c={SAP__Origin:`'${a.SAP__Origin}'`,InstanceID:`'${a.InstanceID}'`};if(i.DecisionKey){c.DecisionKey=`'${i.DecisionKey}'`}if(s?.length>0){c.Comments=`'${s}'`}if(r){c.ReasonCode=`'${r}'`}const l=()=>{this.confirmationDialogPromise.then(e=>{e.setBusy(false);this.confirmationDialogModel.setProperty("/dialogSettings/showFeedbackMessage",true)}).catch(t=>{e.error(t instanceof Error?t.message:String(t))})};const d=e=>{if(e.responseText){const n=JSON.parse(e.responseText);t.error(n?.error?.message?.value)}this.handleCancel()};this.createODataRequest(`/${o}`,c,l,d)},showDecisionDialog:function t(){try{const t=this;t.dataServiceModel=t.dataServiceModel||new c(t.baseUrl);const{TaskTitle:n,Priority:o}=t.task;const i={noteMandatory:t.decisionOption.CommentMandatory,question:t.i18nBundle.getText("XMSG_DECISION_QUESTION",[t.decisionOption.DecisionText]),title:n,badgeIcon:y(o),badgeValueState:M(o),priorityText:t.i18nBundle.getText(p(o)),confirmButtonLabel:t.i18nBundle.getText("XBUT_SUBMIT"),showNote:true,showFeedbackMessage:false,reasonOptionsSettings:{show:false,required:false},textAreaLabel:t.i18nBundle.getText("XFLD_TextArea_Decision"),confirmActionHandler:(e,n)=>{t.sendAction("Decision",t.decisionOption,e,n,t.task)},cancelActionHandler:()=>{}};const s=g(function(){return Promise.resolve(t.dataServiceModel.metadataLoaded()).then(function(){const n=t.decisionOption?.ReasonRequired===S.Required||t.decisionOption?.ReasonRequired===S.Optional?t.loadReasonOptions():null;if(!n){t.openDecisionDialog(i)}else{n.then(e=>{if(e!==null){i.reasonOptionsSettings=e;if(i.reasonOptionsSettings?.reasonOptions&&!i.reasonOptionsSettings?.required){const e=`(${t.i18nBundle.getText("XSEL_DECISION_REASON_NONE_OPTION")})`;i.reasonOptionsSettings.reasonOptions.unshift({Name:e,Code:"defaultSelectedKey"})}t.openDecisionDialog(i)}}).catch(()=>{e.error("Could not load the reason options properly")})}})},function(){e.error("Could not load metadata model for inbox")});return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}});I.decisionDialogMethod=function e(t,n,o,i,s){const r=new I(t,n,o,i,s);return r.showDecisionDialog()};I.getTaskActions=function e(t,n,o,i){const s=[];const r=new Set;const a=o[t.SAP__Origin+t.TaskDefinitionID];if(a){for(const e of a){if(!r.has(e.Nature)||!e.Nature){s.push(O(e,i,t,n));r.add(e.Nature)}else{const o=O(e,i,t,n);o.type=f.Default;s.push(o)}}}return s};I.getIconFrameBadge=y;I.getIconFrameBadgeValueState=M;return I});
//# sourceMappingURL=DecisionDialog.js.map