/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/i18n/ResourceBundle","sap/ui/VersionInfo","sap/ui/base/Object","sap/ui/model/odata/v2/ODataModel","sap/ushell/Config","sap/ushell/Container","./AnalyticalCardSkeleton","./Constants","./DataFormatUtils","./HttpHelper","./RecommendedCardUtil"],function(e,t,n,r,i,s,o,a,c,u,l,f){"use strict";function d(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}const h=typeof Symbol!=="undefined"?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function p(e,t,n){if(!e.s){if(n instanceof m){if(n.s){if(t&1){t=n.s}n=n.v}else{n.o=p.bind(null,e,t);return}}if(n&&n.then){n.then(p.bind(null,e,t),p.bind(null,e,2));return}e.s=t;e.v=n;const r=e.o;if(r){r(e)}}}const m=function(){function e(){}e.prototype.then=function(t,n){const r=new e;const i=this.s;if(i){const e=i&1?t:n;if(e){try{p(r,1,e(this.v))}catch(e){p(r,2,e)}return r}else{return this}}this.o=function(e){try{const i=e.v;if(e.s&1){p(r,1,t?t(i):i)}else if(n){p(r,1,n(i))}else{p(r,2,i)}}catch(e){p(r,2,e)}};return r};return e}();function g(e){return e instanceof m&&e.s&1}function P(e,t,n){var r=-1,i,s;function o(a){try{while(++r<e.length&&(!n||!n())){a=t(r);if(a&&a.then){if(g(a)){a=a.v}else{a.then(o,s||(s=p.bind(null,i=new m,2)));return}}}if(i){p(i,1,a)}else{i=a}}catch(e){p(i||(i=new m),2,e)}}o();return i}const v=a["AnalyticalCardSkeleton"];function I(e,t,n){if(typeof e[h]==="function"){var r=e[h](),i,s,o;function l(e){try{while(!(i=r.next()).done&&(!n||!n())){e=t(i.value);if(e&&e.then){if(g(e)){e=e.v}else{e.then(l,o||(o=p.bind(null,s=new m,2)));return}}}if(s){p(s,1,e)}else{s=e}}catch(e){p(s||(s=new m),2,e)}}l();if(r.return){var a=function(e){try{if(!i.done){r.return()}}catch(e){}return e};if(s&&s.then){return s.then(a,function(e){throw a(e)})}a()}return s}if(!("length"in e)){throw new TypeError("Object is not iterable")}var c=[];for(var u=0;u<e.length;u++){c.push(e[u])}return P(c,function(e){return t(c[e])},n)}const S=c["COLUMN_LENGTH"];function _(e,t){try{var n=e()}catch(e){return t(e)}if(n&&n.then){return n.then(void 0,t)}return n}const y=c["DEFAULT_BG_COLOR"];const z=c["FALLBACK_ICON"];const C=c["MYHOME_PAGE_ID"];const b=c["MYHOME_SPACE_ID"];const D=c["MYINSIGHT_SECTION_ID"];const A=c["RECOMMENDATION_SRVC_URL"];const M=c["RECOMMENDED_CARD_LIMIT"];const V=u["createBookMarkData"];const E=u["getLeanURL"];const j=d(l);const R=d(f);const O={MUST_INCLUDE_RECOMMEDED_APPS:["F0862","F1823"]};const U=t=>{let n={};if(t){if(typeof t==="object"){n=t}else{try{n=JSON.parse(t)}catch(t){e.error(t instanceof Error?t.message:String(t));n=undefined}}}return n};const L=e=>{let t={};if(e?._instantiationData?.chip?.configuration){const n=U(e._instantiationData.chip.configuration);if(n?.tileConfiguration){const e=U(n.tileConfiguration);if(e){t=U(e.TILE_PROPERTIES)}}}return t};const T=e=>{let t="";let n={};if(e?.target?.semanticObject&&e?.target?.action){t=`#${e.target.semanticObject}-${e.target.action}`}else if(e?._instantiationData?.chip?.configuration){n=L(e);if(n?.semanticObject&&n?.semanticAction){t=`#${n?.semanticObject}-${n?.semanticAction}`}}return t};const w=e=>{let t=T(e)||"";const n=L(e);if(n?.evaluationId){t+="?EvaluationId="+n.evaluationId}return t};const x=e=>e.vizType?.startsWith("X-SAP-UI2-CHIP:SSB");const F=(e,t)=>{const n=t?._instantiationData?.chip?.bags?.sb_tileProperties?.texts;return{title:e.title?e.title:n?.title||"",subtitle:e.subtitle?e.subtitle:n?.description||""}};const B=e=>{e.forEach(t=>{e.filter(e=>e.appId===t.appId&&e?.visualization?.id!==t?.visualization?.id&&e.persConfig?.sectionIndex===t.persConfig?.sectionIndex).forEach(e=>{e?.persConfig?.duplicateApps?.push(t)})});return e};const N=e=>e?.target?.parameters?.["sap-ui-tech-hint"]?.value?.value==="GUI";const k=e=>e.fioriId&&O.MUST_INCLUDE_RECOMMEDED_APPS.includes(e.fioriId);const G=(e,t)=>!t.some(t=>t.visualization?.target?.semanticObject===e.visualization?.target?.semanticObject&&t.visualization?.target?.action===e.visualization?.target?.action);class H extends r{aRequestQueue=[];bInsightsSectionPresent=false;vizDataModified=false;_oVizCacheData={};_favPageVisualizations=[];componentData={};fioriAppData={};constructor(){super();this.recommendedUtilInstance=R.getInstance()}static getInstance(){if(!H.Instance){H.Instance=new H}return H.Instance}_fetchRequestFromQueue(e,t=C){try{const n=this;return Promise.resolve(o.getServiceAsync("SpaceContent")).then(function(r){let i;n.aRequestQueue=n.aRequestQueue||[];const s=n.aRequestQueue.find(e=>e.pageId===t);if(!s||e===true||n.vizDataModified===true){n.vizDataModified=false;i=r.getPage(t);if(s){s.pageLoadPromise=i}else{n.aRequestQueue.push({pageId:t,pageLoadPromise:i})}}else{i=s.pageLoadPromise}return i})}catch(e){return Promise.reject(e)}}_fetchDynamicVizs(e){return this.fetchFavVizs(e,true).then(e=>e.filter(e=>e.isCount||e.isSmartBusinessTile))}_getSections(e=false,t=C){try{const n=this;return Promise.resolve(n._fetchRequestFromQueue(e,t)).then(function(e){const t=e&&e.sections||[],r=t.findIndex(e=>e.default);if(r>0){function i(){return n._getSections(true)}const s=function(){if(n._oMoveAppsPromise===undefined){n._oMoveAppsPromise=n.moveSection(r,0);return Promise.resolve(n._oMoveAppsPromise).then(function(){})}}();return s&&s.then?s.then(i):i(s)}else{return t}})}catch(e){return Promise.reject(e)}}_fetchPageVizs(e,t=C){try{const n=this;const r=[];n._oVizCacheData=n._oVizCacheData||{};return Promise.resolve(n._getSections(e,t)).then(function(e){return Promise.resolve(o.getServiceAsync("VisualizationInstantiation")).then(function(i){e.forEach((e,s)=>{e?.visualizations?.forEach((o,a)=>{const c=o.vizConfig,u=c?.["sap.app"]||{title:"?"},l={};l.oldAppId=T(c?.["sap.flp"]);l.appId=o?.targetURL;l.url=o?.targetURL;if(!l.url&&x(o)){l.url=w(c?.["sap.flp"])}l.leanURL=E(l.url);l.title=o?.title||F(u,o)?.title;l.subtitle=o.subtitle||F(u,o).subtitle;l.BGColor=y().key;l.isFav=true;l.isSection=false;l.pageId=t;l.icon=c?.["sap.ui"]?.icons?.icon||z;if(o?.indicatorDataSource){l.isCount=true;l.indicatorDataSource=o.indicatorDataSource.path;l.contentProviderId=o.contentProviderId}l.isSmartBusinessTile=x(o);if(l.isSmartBusinessTile){if(!n._oVizCacheData[l.appId]){n._oVizCacheData[l.appId]=i.instantiateVisualization(o);n._oVizCacheData[l.appId].setActive(true)}l.vizInstance=n._oVizCacheData[l.appId]}l.persConfig={pageId:C,sectionTitle:e.title,sectionId:e.id,sectionIndex:s,visualizationIndex:a,isDefaultSection:e.default,isPresetSection:e.preset,duplicateApps:[]};l.visualization=o;l.visualization.title=l.title;l.visualization.subtitle=l.subtitle;r.push(l)})});return r})})}catch(e){return Promise.reject(e)}}_copyDynamicVizs(){try{const e=this;return Promise.resolve(e._fetchDynamicVizs(true)).then(function(t){return Promise.all(t.map(t=>e.addVisualization(t.visualization.vizId,D)))})}catch(e){return Promise.reject(e)}}fetchFavVizs(e,t,n=C){try{const r=this;return Promise.resolve(r._fetchPageVizs(e,n)).then(function(e){const n=e.filter(e=>e.persConfig&&e.persConfig.sectionId!==D&&e.url&&e.title);if(t){return r._filterDuplicateVizs(B(n),false)}else{return r._addGroupInformation(n)}})}catch(e){return Promise.reject(e)}}fetchInsightApps(e,t){try{const n=this;function r(){return Promise.resolve(i())}const i=function(){try{return Promise.resolve(n._fetchPageVizs(e)).then(function(e){return e.filter(e=>e.persConfig?.sectionId===D&&e.url&&e.title)})}catch(e){return Promise.reject(e)}};const o=function(){if(!n.bInsightsSectionPresent){return Promise.resolve(n._getSections(e)).then(function(e){n.insightsSectionIndex=e.findIndex(function(e){return e.id===D});const r=function(){if(n.insightsSectionIndex===-1&&(s.last("/core/shell/enablePersonalization")||s.last("/core/catalog/enabled"))&&n.bInsightsSectionPresent===false){n.bInsightsSectionPresent=true;return Promise.resolve(n.addSection({sectionIndex:e?.length,sectionProperties:{id:D,title:t}})).then(function(){return Promise.resolve(n._copyDynamicVizs()).then(function(){})})}else{n.bInsightsSectionPresent=true}}();if(r&&r.then)return r.then(function(){})})}}();return Promise.resolve(o&&o.then?o.then(r):r(o))}catch(a){return Promise.reject(a)}}addVisualization(e,t=undefined){try{return Promise.resolve(o.getServiceAsync("SpaceContent")).then(function(n){return Promise.resolve(n.addVisualization(C,t,e)).then(function(){})})}catch(e){return Promise.reject(e)}}removeVisualizations({sectionId:e,vizIds:t}){try{const n=this;return Promise.resolve(o.getServiceAsync("SpaceContent")).then(function(r){const i=I(t,function(t){return Promise.resolve(n._getSections(true)).then(function(n){const i=n.findIndex(t=>t.id===e);const s=i>-1?n[i]:null;const o=s?.visualizations?.findIndex(e=>e.id===t)??-1;const a=function(){if(o>-1){return Promise.resolve(r.deleteVisualization(C,i,o)).then(function(){})}}();if(a&&a.then)return a.then(function(){})})});if(i&&i.then)return i.then(function(){})})}catch(e){return Promise.reject(e)}}updateVisualizations({pageId:e,sourceSectionIndex:t,sourceVisualizationIndex:n,oVisualizationData:r}){try{return Promise.resolve(o.getServiceAsync("SpaceContent")).then(function(i){return i.updateVisualization(e,t,n,r)})}catch(e){return Promise.reject(e)}}createInsightSection(e){try{let t=false;const n=this;function r(e){return t?e:Promise.resolve()}const i=function(){if(!n.bInsightsSectionPresent){return Promise.resolve(n._getSections()).then(function(r){const i=r.findIndex(function(e){return e.id===D});if(i===-1&&(s.last("/core/shell/enablePersonalization")||s.last("/core/catalog/enabled"))){const i=n.addSection({sectionIndex:r.length,sectionProperties:{id:D,title:e,visible:true}});t=true;return i}})}}();return Promise.resolve(i&&i.then?i.then(r):r(i))}catch(o){return Promise.reject(o)}}addSection(e){try{const{sectionIndex:t,sectionProperties:n}=e;return Promise.resolve(o.getServiceAsync("SpaceContent")).then(function(e){return Promise.resolve(e.addSection(C,t,{...n,visible:true})).then(function(){})})}catch(e){return Promise.reject(e)}}getSectionVisualizations(e,t=false,n=C){try{const r=this;return Promise.resolve(r.fetchFavVizs(t,false,n)).then(function(t){if(e){return t.find(t=>t.isSection&&t.id===e)?.apps||[]}else{return t.filter(e=>!e.isSection)}})}catch(e){return Promise.reject(e)}}addBookMark(e,t){try{const n=this;return Promise.resolve(o.getServiceAsync("BookmarkV2")).then(function(r){return Promise.resolve(r.getContentNodes()).then(function(i){const s=i.find(e=>e.id===b);const o=s?.children?.find(e=>e.id===C);return Promise.resolve(r.addBookmark(V(e),o)).then(function(){return t?n.moveVisualization(t):Promise.resolve()})})})}catch(e){return Promise.reject(e)}}getVisualization(e,t,n=false){try{const r=this;return Promise.resolve(r.getSectionVisualizations(t,n)).then(function(t){return t.find(t=>t.appId===e)})}catch(e){return Promise.reject(e)}}moveVisualization(e){try{const t=this;return Promise.resolve(o.getServiceAsync("SpaceContent")).then(function(n){t.vizDataModified=true;return n.moveVisualization(C,e.sourceSectionIndex,e.sourceVisualizationIndex,e.targetSectionIndex,e.targetVisualizationIndex)})}catch(e){return Promise.reject(e)}}_filterDuplicateVizs(e,t){return e.filter((e,n,r)=>{const i=r.findIndex(t=>t.appId===e.appId);return t?i!==n:i===n})}_addGroupInformation(e){const t=[],n=[];let r;B(e).forEach(e=>{if(e.persConfig?.isDefaultSection){t.push(e)}else{r=n.find(t=>t.isSection&&t.id===e.persConfig?.sectionId);if(!r){n.push({id:e.persConfig?.sectionId,index:e.persConfig?.sectionIndex,title:e.persConfig?.sectionTitle||"",badge:"1",BGColor:y().key,icon:"sap-icon://folder-full",isSection:true,pageId:e.pageId,isPresetSection:e.persConfig?.isPresetSection,apps:[e]})}else{r.apps?.push(e);r.badge=r.apps?.length.toString()}}});return[...n,...this._filterDuplicateVizs(t,false)]}moveSection(e,t){try{return Promise.resolve(o.getServiceAsync("Pages").then(function(n){const r=n.getPageIndex(C);return n.moveSection(r,e,t)}))}catch(e){return Promise.reject(e)}}isURLParamEnabled(e){const t=new URLSearchParams(window.location.search);return t?.get(e)?.toLowerCase()==="true"||false}_getRecommenedFioriIds(t=false){try{let n=false;const r=this;function i(e){return n?e:r.recommendedFioriIds}const s=function(){if(!r.recommendedFioriIds||t){return _(function(){return Promise.resolve(j.GetJSON(A)).then(function(e){const t=e;r.recommendedFioriIds=t?.value?.map(e=>e.app_id)||[]})},function(t){e.error("Unable to load recommendations: "+t.message);const r=Promise.resolve([]);n=true;return r})}}();return Promise.resolve(s&&s.then?s.then(i):i(s))}catch(o){return Promise.reject(o)}}_getCatalogApps(){try{let t=false;const n=this;function r(e){return t?e:Promise.resolve(n.catalogAppData)}const i=function(){if(!n.catalogAppData){return _(function(){return Promise.resolve(o.getServiceAsync("SearchableContent")).then(function(e){n.catalogAppData=e.getApps({includeAppsWithoutVisualizations:false});const r=n.catalogAppData;t=true;return r})},function(r){n.catalogAppData=undefined;e.error(r instanceof Error?"Error while fetching catalog apps:"+r.message:String(r));const i=[];t=true;return i})}}();return Promise.resolve(i&&i.then?i.then(r):r(i))}catch(s){return Promise.reject(s)}}isAddCardToInsightsHidden(e){return e?.component?.settings?.tableSettings?.addCardtoInsightsHidden}_checkValidManifests(e){const t=e["sap.app"]?.dataSources;const n=e["sap.ui.generic.app"]&&t?.mainService;if(!n){return false}const r=e["sap.ui.generic.app"]?.pages;if(Array.isArray(r)){return this.recommendedUtilInstance._isListReport(r[0])&&!this.isAddCardToInsightsHidden(r[0])}const i=Object.values(r);if(i.length>0){return i.some(e=>typeof e==="object"&&this.recommendedUtilInstance._isListReport(e)&&!this.isAddCardToInsightsHidden(e))}return false}_getOdataModel(e){return new Promise(function(t){const n=e?.["sap.app"]?.dataSources;const r=n?.mainService;let s=(r?.settings?.annotations||[]).map(e=>n?.[e]?.uri||"").filter(Boolean);const o=new i(r?.uri,{annotationURI:s,loadAnnotationsJoined:true});o.attachMetadataLoaded(()=>{t(o)});o.attachMetadataFailed(()=>{t(o)})})}_getEntitySet(e){const t=e["sap.ui.generic.app"]?.pages;if(Array.isArray(t)){return t[0].entitySet}else if(t){for(const e in t){const n=t[e];if(this.recommendedUtilInstance._isListReport(n)){return n.entitySet}}}return undefined}loadI18n(e,n){try{const r=this;function i(){return r._RBManifestMap[o]}const s=e?.["sap.app"]?.["i18n"]?.["bundleUrl"];const o=new URL(s,n).href;r._RBManifestMap=r._RBManifestMap||{};const a=function(){if(!r._RBManifestMap[o]){return Promise.resolve(t.create({bundleUrl:o,async:true,terminologies:e["sap.app"]?.["i18n"]?.["terminologies"]})).then(function(e){r._RBManifestMap[o]=e})}}();return Promise.resolve(a&&a.then?a.then(i):i(a))}catch(c){return Promise.reject(c)}}getI18nValueOrDefaultString(e,t){let n="";if(e&&e.startsWith("{{")){n=e.substring(2,e.length-2)}else if(e&&e.startsWith("{")){n=e.substring(1,e.length-1)}return n?t.getText(n):e}_getAnalyticalCardManifest(){return JSON.parse(JSON.stringify(v))}getProcessedManifest(t,n,r,i){try{const s=this;return Promise.resolve(_(function(){function e(){return s.recommendedUtilInstance._createCardManifest(m,i,o,h)}const o=n.manifest;const a=s._getEntitySet(o);if(!a){return undefined}const c=t.getODataEntitySet(a);const u=s.recommendedUtilInstance.getLineItemDetails(t,o,a);if(!u?.lineItem){return undefined}const l=u.entitySet||a;const f=l===a?c:t.getODataEntitySet(l);const d=t.getODataEntityType(f.entityType);const h=u?.lrSettings?.["bSupressCardRowNavigation"];if(s.recommendedUtilInstance.hasMandatoryProperties(f,d?.property)){return undefined}const p=s.recommendedUtilInstance._getParametersisedEntitySetParams(t,l,true);if(p?.entitySetName&&p?.parameters?.length){const e=t.getODataEntitySet(p.entitySetName);if(s.recommendedUtilInstance.hasMandatoryProperties(e,p.parameters)){return undefined}}const m=s.recommendedUtilInstance._getManifestCardData(o,u,r,t);if(m.columns.length<S){return undefined}const g=u?.headerInfo;const P=g.TypeNamePlural?.String||"";m.cardTitle=P||m.cardTitle;const v=function(){if(!P&&o["sap.app"]?.i18n){const e=o["sap.app"].i18n.bundleUrl;const t=o["sap.app"].title;const r=function(){if(e&&(t.startsWith("i18n>")||t.startsWith("{"))){return Promise.resolve(s.loadI18n(o,n.url)).then(function(e){m.cardTitle=s.getI18nValueOrDefaultString(m.cardTitle,e)})}}();if(r&&r.then)return r.then(function(){})}}();return v&&v.then?v.then(e):e(v)},function(t){e.error("Error while processing manifest",t instanceof Error?t.message:String(t));return undefined}))}catch(e){return Promise.reject(e)}}fetchMetaModels(t){try{const n=this;const r=t.map(function(t){try{return Promise.resolve(_(function(){return Promise.resolve(n._getOdataModel(t.manifest)).then(function(e){return e?.getMetaModel()})},function(t){e.error("Error while fetching metamodel",t instanceof Error?t.message:String(t));return undefined}))}catch(e){return Promise.reject(e)}});return Promise.resolve(Promise.all(r))}catch(e){return Promise.reject(e)}}combineManifestsAndMetaModels(e,t){return e.reduce((e,n,r)=>{const i=t[r];if(i){e.push({manifest:n,metaModel:i})}return e},[])}processManifests(e,t){try{const n=this;return Promise.all(e.map(e=>{const r=t.find(t=>t.resolutionResult?.ui5ComponentName===e.manifest.manifest?.["sap.app"]?.id);return n.getProcessedManifest(e.metaModel,e.manifest,r,n.versionInfo)}))}catch(e){return Promise.reject(e)}}processAppList(e,t,n){if(!e&&t&&t.length){return t.reduce((e,t)=>{const r=n?.[t.id]||[];const i=r.find(e=>e.semanticObject===t.target?.semanticObject&&e.action===t.target?.action);return i?[...e,i.fioriId]:e},[])}return e||[]}_getCardManifest(t,r){try{const i=this;return Promise.resolve(_(function(){return Promise.resolve(Promise.all([i._getCatalogApps(),i.getFioriAppData()])).then(function([e,s]){return Promise.resolve(n.load()).then(function(n){i.versionInfo=n;const o=Object.values(s).flat();const a=i.componentData;const c=i.processAppList(t,r,a);return Promise.resolve(i.fetchManifests(c,s,e)).then(function(e){const t=e.filter(e=>i._checkValidManifests(e.manifest));return Promise.resolve(i.fetchMetaModels(t)).then(function(e){const n=i.combineManifestsAndMetaModels(t,e);return Promise.resolve(i.processManifests(n,o)).then(function(e){return e.filter(e=>e!==undefined)})})})})})},function(t){e.error("Error while fetching card manifest",t instanceof Error?t.message:String(t));return[]}))}catch(e){return Promise.reject(e)}}fetchManifests(t,n,r){try{return Promise.resolve(_(function(){const i=t.map(function(t){try{let i=false;const s=n[t]||[];const o=I(s,function(t){const n=r.find(e=>t.semanticObject===e.target?.semanticObject&&t.action===e.target?.action);const s=t?.resolutionResult?.applicationDependencies?.manifest;return function(){if(n&&s){return _(function(){return Promise.resolve(fetch(s)).then(function(e){return Promise.resolve(e.json()).then(function(t){const n=t;const r={url:e.url,manifest:n};i=true;return r})})},function(t){e.error("Error while fetching manifest",t instanceof Error?t.message:String(t));i=true;return undefined})}}()},function(){return i});return Promise.resolve(o&&o.then?o.then(function(e){return i?e:undefined}):i?o:undefined)}catch(e){return Promise.reject(e)}});return Promise.resolve(Promise.all(i)).then(function(e){return e.filter(e=>e!==undefined)})},function(t){e.error("Error while processing manifests",t instanceof Error?t.message:String(t));return[]}))}catch(e){return Promise.reject(e)}}_removeDuplicateCards(e){const t={};const n=[];e.forEach(e=>{const r=e?.descriptorContent?.["sap.card"]?.header?.title||"";if(!t[r]){n.push(e);t[r]=true}});return n}getRecommenedCards(){try{const t=this;return Promise.resolve(_(function(){return Promise.resolve(t._getRecommenedFioriIds()).then(function(e){return Promise.resolve(t._getCardManifest(e)).then(function(e){const n=e?.slice(0,M);const r=n?.map(e=>{let t;if(e?.["sap.card"]){e["sap.card"].rec=true;t=e["sap.app"]?.id}return{id:t,descriptorContent:e}});return t._removeDuplicateCards(r)})})},function(t){e.error("Error while fetching recommended cards:",t instanceof Error?t.message:String(t));return[]}))}catch(e){return Promise.reject(e)}}getRecommendedVisualizations(e=false){try{const t=this;function n(){return t._recommendedVisualizations}const r=function(){if(!t._recommendedVisualizations||e){return Promise.resolve(t._getRecommenedFioriIds(e)).then(function(n){const r=function(){if(n.length){let r=[];let i=[];return Promise.resolve(Promise.all([t._getVisualizationsByFioriIds(n),t._fetchPageVizs(e)])).then(function([e,n]){e=e.filter(e=>G(e,n));e.forEach(e=>{if(k(e)){i.push(e)}else{r.push(e)}});t._recommendedVisualizations=r.slice(0,10-i.length).concat(i)})}else{t._recommendedVisualizations=[]}}();if(r&&r.then)return r.then(function(){})})}}();return Promise.resolve(r&&r.then?r.then(n):n(r))}catch(i){return Promise.reject(i)}}_getInboundApps(){try{return Promise.resolve(_(function(){return Promise.resolve(o.getServiceAsync("ClientSideTargetResolution")).then(function(e){return e?._oAdapter?._aInbounds||[]})},function(t){e.error("Error while fetching inbound apps: "+t.message);return[]}))}catch(e){return Promise.reject(e)}}getFioriAppData(){try{const t=this;return Promise.resolve(_(function(){function e(){return t.fioriAppData}const n=function(){if(!Object.keys(t.componentData).length){t.componentData={};t.fioriAppData={};return Promise.resolve(t._getInboundApps()).then(function(e){e.forEach(e=>{const n=e?.signature?.parameters?.["sap-fiori-id"]?.defaultValue?.value;const r=e?.resolutionResult?.ui5ComponentName;if(n){const i={action:e.action,semanticObject:e.semanticObject,resolutionResult:e.resolutionResult};t.fioriAppData[n]=t.fioriAppData[n]||[];t.fioriAppData[n].push(i);if(r){const e={...i,fioriId:n};t.componentData[r]=t.componentData[r]||[];t.componentData[r].push(e)}}})})}}();return n&&n.then?n.then(e):e(n)},function(t){e.error(t instanceof Error?t.message:String(t));return{}}))}catch(e){return Promise.reject(e)}}_getVisualizationsByFioriIds(e){try{const t=this;const n=[];const r=new Map;return Promise.resolve(Promise.all([t._getInboundApps(),t._getCatalogApps()])).then(function([t,i]){e.forEach(e=>{const s=t.filter(function(t){return t?.signature.parameters["sap-fiori-id"]?.defaultValue?.value===e});s.forEach(t=>{let s=i.filter(e=>e?.target?.semanticObject===t.semanticObject&&e.target.action===t.action);const o=s.filter(e=>N(e));const a=s.filter(e=>!N(e));if(o.length>0&&a.length>0){s=[...a]}s.forEach(t=>{let i=t.visualizations[0];let s={title:i.title,subtitle:i.subtitle,icon:i.icon,url:i.targetURL,vizId:i.vizId,fioriId:e,visualization:i};if(!r.has(s.url)||!r.has(s.title)){r.set(s.url,true);r.set(s.title,true);n.push(s)}})})});return n})}catch(e){return Promise.reject(e)}}_getAllFavPageApps(t,n){try{let r=false;const i=this;return Promise.resolve(_(function(){function e(e){return r?e:[]}const s=function(){if(t){i._favPageVisualizations=i._favPageVisualizations||[];const e=i._favPageVisualizations.reduce((e,t)=>{if(t.pageId&&!e.includes(t.pageId)){e.push(t.pageId)}return e},[]);const s=t.map(e=>e.pageId);const o=e.length===0||!e.every(e=>s.includes(e));if(!n&&!o){const e=i._favPageVisualizations;r=true;return e}else{return Promise.resolve(i._loadAllPageVisualizations(t,n)).then(function(e){i._favPageVisualizations=e;const t=i._favPageVisualizations;r=true;return t})}}}();return s&&s.then?s.then(e):e(s)},function(t){e.error(t);return[]}))}catch(e){return Promise.reject(e)}}_loadAllPageVisualizations(t,n=false,r=false){try{const i=this;const s=e=>t.find(t=>t.pageId===e)?.BGColor??y().key;return Promise.resolve(_(function(){const e=[];return Promise.resolve(i.loadPages(t,n)).then(function(t){for(const n of t){const t=n?.sections||[];for(const i of t){const t=i.visualizations||[];for(const i of t){const t={appId:i.targetURL,vizId:i.vizId,icon:i.icon,BGColor:s(n.id),pageId:n.id};if(!r||!e.some(e=>e.appId===t.appId)){e.push(t)}}}}return e})},function(t){e.error(t);return[]}))}catch(e){return Promise.reject(e)}}loadPages(e,t=false){try{const n=this;return Promise.resolve(Promise.all(e.map(e=>n._fetchRequestFromQueue(t,e.pageId))))}catch(e){return Promise.reject(e)}}}return H});
//# sourceMappingURL=AppManager.js.map