/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/m/ActionTile","sap/m/ActionTileContent","sap/m/Button","sap/m/ContentConfig","sap/m/Link","sap/m/List","sap/m/MessageBox","sap/m/Popover","sap/m/StandardListItem","sap/m/TileAttribute","sap/m/library","sap/ui/core/format/NumberFormat","./MenuItem","./ToDoPanel","./utils/DecisionDialog","./utils/Device","./utils/FESRUtil","./utils/TaskUtils"],function(t,e,n,o,i,s,r,a,c,u,l,p,f,d,h,_,g,m,y){"use strict";function T(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}function b(t,e){try{var n=t()}catch(t){return e(t)}if(n&&n.then){return n.then(void 0,e)}return n}const P=p["ButtonType"];const D=p["ContentConfigType"];const A=p["LoadState"];const I=p["PlacementType"];const C=p["URLHelper"];const v=T(d);const k=T(h);const x=T(_);const w=_["getIconFrameBadge"];const E=_["getIconFrameBadgeValueState"];const R=g["calculateDeviceType"];const S=g["DeviceType"];const B=g["fetchElementProperties"];const O=m["addFESRId"];const L=m["addFESRSemanticStepName"];const M=m["FESR_EVENTS"];const U=y["fetchUserDetails"];const V=y["formatDate"];const $=y["getPriority"];const W=y["getTaskUrl"];var N=function(t){t["CURRENCYVALUE"]="CURRENCYVALUE";t["CURRENCYCODE"]="CURRENCYCODE";t["USER"]="USER";return t}(N||{});var H=function(t){t["TextFirst"]="TextFirst";t["TextLast"]="TextLast";t["TextOnly"]="TextOnly";t["TextSeparate"]="TextSeparate";return t}(H||{});const G={GRID_VIEW_MIN_ROWS:1,GRID_VIEW_MAX_ROWS:2,GRID_VIEW_MIN_WIDTH:304,GRID_VIEW_TWO_COL_MIN_WIDTH:374,GRID_VIEW_MAX_WIDTH:583,CARD_HEIGHT:{1:220,2:272,3:324,4:376}};function j(t,e){const n=[];for(let o=0;o<t.length;o+=e){n.push(t.slice(o,o+e))}return n}const F=k.extend("sap.cux.home.TaskPanel",{metadata:{library:"sap.cux.home",properties:{enableActions:{type:"boolean",group:"Data",defaultValue:false,visibility:"public"},customAttributeUrl:{type:"string",group:"Data",defaultValue:"",visibility:"public"}}},constructor:function t(e,n){k.prototype.constructor.call(this,e,n)},init:function t(){k.prototype.init.call(this);this._customAttributeMap={};this._taskDefinitionMap={};this.setProperty("key","tasks");this.setProperty("title",this._i18nBundle.getText("tasksTabTitle"));this._viewAllTasksMenuItem=new v(`${this.getId()}-view-tasks-btn`,{title:this._i18nBundle.getText("viewAllTasksTitle"),icon:"sap-icon://inbox",visible:false,press:this._onPressViewAll.bind(this)});this.insertAggregation("menuItems",this._viewAllTasksMenuItem,0);O(this._viewAllTasksMenuItem,"goToTaskSitution");const[e]=this.getContent()||[];e?.addStyleClass("sapUiGridTaskLayout")},generateRequestUrls:function t(e){const n=[this.getCountUrl(),`${this.getDataUrl()},CustomAttributeData&$expand=CustomAttributeData&$skip=0&$top=${e}`];const o=this.getCustomAttributeUrl();if(o){n.push(o)}return n},generateCardTemplate:function t(r,a){const c=a.getObject().attributes?.map((t,e)=>new l(`${r}-${e}-attribute`,{label:t.label,contentConfig:new i(`${r}-${e}-contentConfig`,{type:t.type,text:t.text,href:t.href})}));return new e(`${r}-actionTile`,{mode:"ActionMode",frameType:"TwoByOne",pressEnabled:true,enableIconFrame:true,enableDynamicHeight:true,enableNavigationButton:true,headerImage:"sap-icon://workflow-tasks",badgeIcon:w(a.getProperty("Priority")),badgeValueState:E(a.getProperty("Priority")),header:a.getProperty("TaskTitle"),state:a.getProperty("loadState"),priority:$(a.getProperty("Priority")),priorityText:this._toPriorityText($(a.getProperty("Priority"))),press:t=>this._onPressTask(t),tileContent:[new n(`${r}-actionTileContent`,{headerLink:new s({text:a.getProperty("CreatedByName"),press:t=>{void this._onClickCreatedBy(t)}}),attributes:c})],actionButtons:[(()=>{const t=new o(`${r}-view-btn`,{text:this._i18nBundle.getText("viewButton"),press:t=>t.getSource().getParent().firePress(),visible:a.getProperty("actions/length")===0});L(t,M.PRESS,"todoActionViewBtn");return t})(),(()=>{const t=new o(`${r}-approve-btn`,{text:a.getProperty("actions/0/text"),type:a.getProperty("actions/0/type"),press:()=>this._onActionButtonPress(a.getProperty("actions/0/pressHandler")),visible:a.getProperty("actions/0")!==undefined});L(t,M.PRESS,"todoActionBtn");return t})(),(()=>{const t=new o(`${r}-reject-btn`,{text:a.getProperty("actions/1/text"),type:a.getProperty("actions/1/type"),press:()=>this._onActionButtonPress(a.getProperty("actions/1/pressHandler")),visible:a.getProperty("actions/1")!==undefined});L(t,M.PRESS,"todoActionBtn");return t})(),(()=>{const t=new o(`${r}-overflow-btn`,{icon:"sap-icon://overflow",type:P.Transparent,press:t=>this._onOverflowButtonPress(t,a),visible:a.getProperty("actions/length")>=3});L(t,M.PRESS,"todoActBtnOverflow");return t})()]})},_onOverflowButtonPress:function t(e,n){const o=n.getProperty("actions").slice(2);this._getOverflowButtonPopover(o).openBy(e.getSource())},_getOverflowButtonPopover:function t(e){if(!this._overflowPopover){this._overflowList=new r(`${this.getId()}-overflowList`);this._overflowPopover=new c(`${this.getId()}-overflowPopover`,{showHeader:false,content:this._overflowList,placement:I.VerticalPreferredBottom})}this._setupOverflowList(e);return this._overflowPopover},_setupOverflowList:function t(e){this._overflowList.destroyItems();e.forEach((t,e)=>{const n=new u(`action-${e}`,{title:t.text,type:"Active",press:()=>this._onActionButtonPress(t.pressHandler)});L(n,M.PRESS,"todoActionBtn");this._overflowList.addItem(n)})},_onActionButtonPress:function t(e){e(this._loadCards.bind(this))},_getCustomAttributes:function t(e){const n=[];const o=4;const i=this._customAttributeMap[e.TaskDefinitionID]||[];for(let t of i){const o=t;const i=e.CustomAttributeData?.results;const s=i.find(t=>t.Name===o.name);let r="";if(s&&!o.referenced){const t={label:o.label+":",type:D.Text};if(o.format){r=this._formatCustomAttribute(o,i)}else if(o.textArrangement){r=this._arrangeText(s,o.textArrangement)}else{r=o.type==="Edm.DateTime"?V(s.Value):s.Value}t.text=r||"-";n.push(t)}}this._addCommonAttributes(n,e);return n.slice(0,o)},_arrangeText:function t(e,n){const o=e.Value.trim();const i=e.ValueText.trim();let s="";switch(n){case H.TextFirst:s=`${i} (${o})`;break;case H.TextLast:s=`${o} (${i})`;break;case H.TextOnly:s=`${i}`;break;case H.TextSeparate:s=`${o}`;break;default:s=`${i} ${o})`;break}return s},_formatCustomAttribute:function t(e,n=[]){const o=t=>n.find(e=>e.Name===t);const i=e.format?.toUpperCase();const s=o(e.name);let r=s?.Value;if(i===N.CURRENCYVALUE&&e.reference){const t=o(e.reference);if(t){const e=f.getCurrencyInstance();r=e.format(parseFloat(s?.Value),t.Value)}}else if(i===N.USER){r=s?.FormattedValue||s?.Value}return r},_addCommonAttributes:function t(e,n){if(n.CompletionDeadline){e.push({label:this._i18nBundle.getText("dueDate")+":",text:V(n.CompletionDeadline,"MMM dd, YYYY hh:mm a"),type:D.Text})}if(n.CreatedOn){e.push({label:this._i18nBundle.getText("createdOn")+":",text:V(n.CreatedOn),type:D.Text})}},_onPressTask:function t(e){if(this.getTargetAppUrl()){const t=e.getSource();const n=t.getBindingContext();const o=n?.getProperty("loadState");const i=W(n?.getProperty("SAP__Origin"),n?.getProperty("InstanceID"),this.getTargetAppUrl());if(o!==A.Loading){C.redirect(i,false)}}},_onClickCreatedBy:function e(n){try{const e=this;const o=n.getSource();const{SAP__Origin:i,CreatedBy:s,TaskTitle:r,CreatedByName:c,InstanceID:u}=n.getSource().getBindingContext()?.getObject();const l=W(i,u,e.getTargetAppUrl());const p=(t,{subject:e,body:n})=>{C.triggerEmail(t,e,n)};const f=new URL(window.location.href);f.hash=l;const d=f.toString();return Promise.resolve(U(i,s)).then(function(n){if(n.Email){sap.ui.require(["sap/suite/ui/commons/collaboration/ServiceContainer"],function(e){try{return Promise.resolve(e.getServiceAsync()).then(function(e){const i=function(){if(e.enableContactsCollaboration){const i=b(function(){return Promise.resolve(e.enableContactsCollaboration(n.Email,{subject:r,body:encodeURIComponent(d)})).then(function(t){const e=t;e.openBy(o)})},function(e){t.error(e instanceof Error?e.message:String(e));p(n.Email,{subject:r,body:d})});if(i&&i.then)return i.then(function(){})}else{p(n.Email,{subject:r,body:d})}}();if(i&&i.then)return i.then(function(){})})}catch(t){return Promise.reject(t)}})}else{a.warning(e._i18nBundle.getText("noEmail",[c]))}})}catch(t){return Promise.reject(t)}},onDataReceived:function t(e,n){try{const t=this;const[o,i]=e;t._extractCustomAttributes(i);const s=function(){if(!n||n&&!n.onlyCount){return Promise.resolve(t._updateTasks(o)).then(function(e){t._oData.displayTiles=t._oData.tiles=e})}}();return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},_updateTasks:function t(e=[]){try{const t=this;let n=t._addCustomAttributes(e);const o=function(){if(t.getEnableActions()){const e=t._getTaskDefintions(n);return Promise.resolve(t._downloadDecisionOptions(e)).then(function(){n=t._addActions(n)})}}();return Promise.resolve(o&&o.then?o.then(function(){return n}):n)}catch(t){return Promise.reject(t)}},_addCustomAttributes:function t(e){return e.map(t=>({...t,attributes:this._getCustomAttributes(t)}))},_addActions:function t(e){return e.map(t=>{const e=t.SAP__Origin+t.TaskDefinitionID;return{...t,actions:this._taskDefinitionMap[e]?x.getTaskActions(t,this.getBaseUrl(),this._taskDefinitionMap,this._i18nBundle):[]}})},_downloadDecisionOptions:function t(e){try{const t=this;const n=[];const o=Object.keys(e).reduce((o,i)=>{if(!Object.keys(t._taskDefinitionMap).includes(i)){n.push(i);t._taskDefinitionMap[i]=[];const{SAP__Origin:s,InstanceID:r}=e[i];o.push(`DecisionOptions?SAP__Origin='${s}'&InstanceID='${r}'`)}return o},[]);const i=function(){if(o.length){t._clearRequests();t.requests.push({baseURL:t.getBaseUrl(),requestURLs:o,success:e=>{e.forEach((e,o)=>{t._taskDefinitionMap[n[o]]=e});return Promise.resolve()}});return Promise.resolve(t._submitBatch()).then(function(){})}}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},_getTaskDefintions:function t(e=[]){const n={};e.forEach(t=>{const e=t.SAP__Origin+t.TaskDefinitionID;if(!n[e]){n[e]={SAP__Origin:t.SAP__Origin,InstanceID:t.InstanceID,TaskDefinitionID:t.TaskDefinitionID}}});return n},_extractCustomAttributes:function t(e=[]){e.forEach(t=>{const e=t.CustomAttributeDefinitionData?.results||[];this._customAttributeMap[t.TaskDefinitionID]=e.filter(t=>t.Rank>0).sort((t,e)=>e.Rank-t.Rank).map(t=>({name:t.Name,label:t.Label,type:t.Type,format:t.Format,reference:t.Reference,referenced:t.Referenced,textArrangement:t.TextArrangement}))})},getNoDataText:function t(){return this._i18nBundle.getText("noTaskTitle")},getVerticalCardCount:function t(e,n){const o=B(e,["padding-top"]);const i=B(e.parentElement,["height"]);const s=this.calculateTitleHeight();const r=i.height-o["padding-top"]*2-s;const a=this.getHorizontalCardCount(e);const c=n?.isPlaceholder;const u=16;let l=0;let p=0;if(this._isLoaded()){const t=j(this._oData.tiles,a);const e=t.map(t=>{const e=t.reduce(function(t,e){e.attributes=e.attributes||[];return e.attributes.length>t?e.attributes.length:t},1);let n=Math.min(e,4);if(this._isGridLayoutAllowed()){n=n>G.GRID_VIEW_MAX_ROWS?G.GRID_VIEW_MAX_ROWS:G.GRID_VIEW_MIN_ROWS}return G.CARD_HEIGHT[n]+u});for(let t of e){if(l+t<r){l+=t;p++}else{break}}}else{p=Math.floor(r/G.CARD_HEIGHT[c?"4":"1"])}return Math.max(p,2)},_adjustLayout:function t(){k.prototype._adjustLayout.call(this);this.setProperty("minCardWidth",this._isGridLayoutAllowed()?G.GRID_VIEW_TWO_COL_MIN_WIDTH:G.GRID_VIEW_MIN_WIDTH);this.setProperty("maxCardWidth",G.GRID_VIEW_MAX_WIDTH)},_isGridLayoutAllowed:function t(){const e=R();return e===S.LargeDesktop||e===S.XLargeDesktop},setTargetAppUrl:function t(e){this._viewAllTasksMenuItem.setVisible(!!e);this.setProperty("targetAppUrl",e);return this}});return F});
//# sourceMappingURL=TaskPanel.js.map