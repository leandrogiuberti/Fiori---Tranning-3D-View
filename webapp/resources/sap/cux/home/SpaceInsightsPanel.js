/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/f/GridContainer","sap/f/GridContainerItemLayoutData","sap/m/GenericTile","sap/m/HeaderContainer","sap/m/VBox","sap/m/library","sap/ui/core/Lib","sap/ui/model/json/JSONModel","sap/ushell/Container","sap/ushell/api/S4MyHome","./BasePanel","./utils/AppManager","./utils/CommonUtils","./utils/DataFormatUtils","./utils/Device","./utils/InsightsUtils"],function(t,e,n,i,s,r,o,a,l,c,h,u,g,d,p,f,m){"use strict";function _(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}function y(t,e){try{var n=t()}catch(t){return e(t)}if(n&&n.then){return n.then(void 0,e)}return n}const I=o["LoadState"];function M(t,e){try{var n=t()}catch(t){return e(true,t)}if(n&&n.then){return n.then(e.bind(null,false),e.bind(null,true))}return e(false,n)}const v=_(u);const S=typeof Symbol!=="undefined"?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function A(t,e,n){if(!t.s){if(n instanceof T){if(n.s){if(e&1){e=n.s}n=n.v}else{n.o=A.bind(null,t,e);return}}if(n&&n.then){n.then(A.bind(null,t,e),A.bind(null,t,2));return}t.s=e;t.v=n;const i=t.o;if(i){i(t)}}}const T=function(){function t(){}t.prototype.then=function(e,n){const i=new t;const s=this.s;if(s){const t=s&1?e:n;if(t){try{A(i,1,t(this.v))}catch(t){A(i,2,t)}return i}else{return this}}this.o=function(t){try{const s=t.v;if(t.s&1){A(i,1,e?e(s):s)}else if(n){A(i,1,n(s))}else{A(i,2,s)}}catch(t){A(i,2,t)}};return i};return t}();function P(t){return t instanceof T&&t.s&1}function C(t,e,n){var i=-1,s,r;function o(a){try{while(++i<t.length&&(!n||!n())){a=e(i);if(a&&a.then){if(P(a)){a=a.v}else{a.then(o,r||(r=A.bind(null,s=new T,2)));return}}}if(s){A(s,1,a)}else{s=a}}catch(t){A(s||(s=new T),2,t)}}o();return s}const b=_(g);function D(t,e,n){if(typeof t[S]==="function"){var i=t[S](),s,r,o;function h(t){try{while(!(s=i.next()).done&&(!n||!n())){t=e(s.value);if(t&&t.then){if(P(t)){t=t.v}else{t.then(h,o||(o=A.bind(null,r=new T,2)));return}}}if(r){A(r,1,t)}else{r=t}}catch(t){A(r||(r=new T),2,t)}}h();if(i.return){var a=function(t){try{if(!s.done){i.return()}}catch(t){}return t};if(r&&r.then){return r.then(a,function(t){throw a(t)})}a()}return r}if(!("length"in t)){throw new TypeError("Object is not iterable")}var l=[];for(var c=0;c<t.length;c++){l.push(t[c])}return C(l,function(t){return e(l[t])},n)}const w=d["filterVisualizations"];const H=d["getPageManagerInstance"];const E=p["recycleId"];const O=f["DeviceType"];const B=f["fetchElementProperties"];const W=m["createShowMoreActionButton"];const $=m["createShowMoreMenuItem"];const L=m["getAssociatedFullScreenMenuItem"];var F=function(t){t["REFRESH"]="tiles-refresh";t["ADD_APPS"]="tiles-addSmartApps";t["EDIT_TILES"]="tiles-editTiles";return t}(F||{});var R=function(t){t["REFRESH"]="container-tiles-refresh";t["ADD_APPS"]="container-tiles-addSmartApps";t["EDIT_TILES"]="container-tiles-editTiles";t["SHOW_MORE"]="tilesContainerFullScreenMenuItem";return t}(R||{});var V=function(t){t["ADD_TILES"]="tiles-addTilesButton";return t}(V||{});var x=function(t){t["ADD_TILES"]="container-tiles-addTilesButton";t["SHOW_MORE"]="tilesContanerFullScreenActionButton";return t}(x||{});var z=function(t){t["Standard"]="standard";t["StandardWide"]="standardWide";return t}(z||{});const N=176;const j=368;const U=16;const k=v.extend("sap.cux.home.SpaceInsightsPanel",{metadata:{library:"sap.cux.home",properties:{spaceId:{type:"string",group:"Data",defaultValue:""},title:{type:"string",group:"Misc",defaultValue:""},fullScreenName:{type:"string",group:"Misc",defaultValue:"SI3",visibility:"hidden"}},defaultAggregation:"tiles",aggregations:{content:{multiple:true,singularName:"content",visibility:"hidden"},tiles:{type:"sap.cux.home.App",multiple:true,singularName:"tile",visibility:"hidden"}},events:{handleHidePanel:{parameters:{}},handleUnhidePanel:{parameters:{}}}},constructor:function t(e,n){v.prototype.constructor.call(this,e,n);this._headerVisible=false},init:function e(){v.prototype.init.call(this);this._controlMap=new Map;this._oData={tiles:[],activateInsightsTiles:true,activateInsightsTilesOnPhone:false,activateInsightsTilesOnDesktop:false};this._controlModel=new l(this._oData);this.appManagerInstance=b.getInstance();this.pageManager=H(this);this.setProperty("enableFullScreen",true);this._createTilesFlexWrapper();c.getServiceAsync("VisualizationInstantiation").then(t=>{this.VizInstantiationService=t}).catch(e=>{t.error(e instanceof Error?e.message:String(e))});this._toggleTileActivity()},setTitle:function t(e){if(!this.spaceTitle)this.spaceTitle=e;return this.setProperty("title",e)},getTitle:function t(){if(this.spaceTitle)return this.spaceTitle;return this.getProperty("title")},_toggleTileActivity:function e(){const n=this;const i=function(t){try{const e=t.getParameter("isMyHomeRoute");n._controlModel.setProperty("/activateInsightsTiles",e);const i=function(){if(e){const t=function(){if(n._appSwitched){return Promise.resolve(n.refreshData(true)).then(function(){n._appSwitched=false})}}();if(t&&t.then)return t.then(function(){})}else{n._appSwitched=true}}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(t){return Promise.reject(t)}};try{h.attachRouteMatched({},i,this)}catch(e){t.warning(e instanceof Error?e.message:String(e))}},_showPlaceHolders:function t(){const e=new Array(this._calculatePlaceholderTileCount()).fill(I.Loading);this.aInsightsApps=e.map((t,e)=>new i(E(`${this.getId()}--placeHolderTile--${e}`),{sizeBehavior:"Responsive",state:t,frameType:"OneByOne",mode:"IconMode",visible:true,renderOnThemeChange:true,ariaRole:"listitem",dropAreaOffset:8}).setLayoutData?.(new n(E(`${this.getId()}--placeHolderTileLayoutData--${e}`),{columns:2})));this._controlModel.setProperty("/tiles",this.aInsightsApps)},_clearPlaceHolders:function t(){this._controlModel.setProperty("/tiles",[])},renderPanel:function t(){try{let e=false;const n=this;function i(t){return e?t:Promise.resolve()}const s=M(function(){return y(function(){return Promise.resolve(n.refreshData()).then(function(t){e=true;return t})},function(t){n.fireHandleHidePanel()})},function(t,e){n.fireEvent("loaded");if(t)throw e;return e});return Promise.resolve(s&&s.then?s.then(i):i(s))}catch(r){return Promise.reject(r)}},fetchDynamicAppInSpace:function t(){try{const e=this;function n(t){function n(){r=w(r,true);r=e.appManagerInstance._filterDuplicateVizs(r,false);return r}e.allSpaces=t;const s=e.allSpaces.find(t=>t.id===i);if(!s||s.children.length===0)return[];let r=[];const o=function(){if(s&&s.children.length>0){const t=D(s.children,function(t){return Promise.resolve(e.appManagerInstance.fetchFavVizs(true,true,t.id)).then(function(t){r.push(...t)})});if(t&&t.then)return t.then(function(){})}}();return o&&o.then?o.then(n):n(o)}const i=e.getProperty("spaceId");const s=e.allSpaces;return Promise.resolve(s?n(s):Promise.resolve(e.pageManager.fetchAllAvailableSpaces()).then(n))}catch(r){return Promise.reject(r)}},refreshData:function t(e=false){try{const t=this;const n=t.getMetadata().getName();return Promise.resolve(t.fetchDynamicAppInSpace()).then(function(i){function s(){t._clearPlaceHolders();t._controlModel.setProperty("/tiles",t.aInsightsApps);if(t.aInsightsApps?.length){t.fireHandleUnhidePanel();if(e){const e=t.getDeviceType()===O.Mobile;const n=e?t.tilesMobileContainer:t.tilesContainer;const i=n.getMetadata().getDefaultAggregationName();const s=n.getAggregation(i)||[];s.forEach(t=>t.refresh?.())}t._getInsightsContainer().updatePanelsItemCount(t.aInsightsApps.length,n);if(t._headerVisible){t.setProperty("title",`${t.spaceTitle} (${t.aInsightsApps.length})`)}}else{t.fireHandleHidePanel()}}t.aInsightsApps=i;const r=t.aInsightsApps.some(t=>t.isSmartBusinessTile);const o=function(){if(r){return Promise.resolve(a.load({name:"sap.cloudfnd.smartbusiness.lib.reusetiles"})).then(function(){})}}();return o&&o.then?o.then(s):s(o)})}catch(t){return Promise.reject(t)}},_createTilesFlexWrapper:function t(){if(!this._tilesWrapper){this._tilesWrapper=new r(`${this.getId()}-tilesWrapper`,{renderType:"Bare",width:"100%",items:[this._createMobileFlexWrapper(),this._createWrapperFlexBox()]});this._showPlaceHolders();this._tilesWrapper.setModel(this._controlModel);this.addContent(this._tilesWrapper)}},_createMobileFlexWrapper:function t(){if(!this.tilesMobileContainer){this.tilesMobileContainer=new s(`${this.getId()}-insightsTilesMobileContainer`,{scrollStep:0,scrollStepByItem:1,gridLayout:true,scrollTime:1e3,showDividers:false,visible:"{/isPhone}"}).addStyleClass("sectionMarginTopTilesInsight sapMHeaderContainerMarginBottom");this._attachAggregationToContainer(this.tilesMobileContainer)}return this.tilesMobileContainer},_createWrapperFlexBox:function t(){if(!this.tilesContainer){this.tilesContainer=new e(`${this.getId()}-insightsTilesContainer`,{visible:"{= !${/isPhone}}"}).addStyleClass("insightTiles sapUiSmallMarginTop sapUiSmallMarginBottom");this._attachAggregationToContainer(this.tilesContainer)}return this.tilesContainer},_updateTilesActivity:function t(){const e=this.getDeviceType()===O.Mobile;const n=Boolean(this._controlModel.getProperty("/activateInsightsTiles"));this._controlModel.setProperty("/activateInsightsTilesOnPhone",n&&e);this._controlModel.setProperty("/activateInsightsTilesOnDesktop",n&&!e)},_attachAggregationToContainer:function t(e){e.setModel(this._controlModel);const s=e.getMetadata().getDefaultAggregationName();const r=this.getDeviceType()===O.Mobile;e.bindAggregation(s,{path:"/tiles",factory:(t,e)=>{const s=e.getObject();if(s instanceof i){return s}const o=this.VizInstantiationService.instantiateVisualization(s.visualization);o.setLayoutData?.(new n(`${this.getId()}-itemLayoutData-${t}`,{minRows:2,columns:o.getDisplayFormat?.()===z.Standard?2:4}));o?.bindProperty?.("active",r?"/activateInsightsTilesOnPhone":"/activateInsightsTilesOnDesktop");return o}})},handleHideHeader:function t(){this._headerVisible=false;this.setProperty("title","");this._toggleHeaderActions(false)},handleAddHeader:function t(){this._headerVisible=true;this.setProperty("title",`${this.spaceTitle} (${this.aInsightsApps.length})`);this._toggleHeaderActions(true)},_calculateVisibleTileCount:function t(e){const n=this._getInsightsContainer()?._getLayout();const i=n?.getDomRef();const s=e||[];let r=0;if(i&&s.length){const t=n.getProperty("showHeader");const e=t?1:0;const o=i.childNodes[e];const a=B(o,["width","padding-left","padding-right"]);let l=a.width-a["padding-left"]-a["padding-right"];const c={};c[z.Standard]=N+U;c[z.StandardWide]=j+U;let h=c[s[r].visualization?.displayFormatHint??z.Standard];do{l-=h;++r;h=c[s[r]?.visualization?.displayFormatHint??z.Standard]}while(l>h)}return r||1},_calculatePlaceholderTileCount:function t(){const e=this._getInsightsContainer()?._getLayout()?.getDomRef();let n=0;if(e){const t=e.childNodes[0];const i=B(t,["width","padding-left","padding-right"]);let s=i.width-i["padding-left"]-i["padding-right"];const r=N+U;n=Math.floor(s/r)}return n||1},_adjustLayout:function t(){const e=this._getInsightsContainer()?._getLayout();const n=this.getDeviceType()===O.Mobile;if(e){const t=n?this.aInsightsApps?.length:this._calculateVisibleTileCount(this.aInsightsApps);const i=e._getCurrentExpandedElementName()===this.getProperty("fullScreenName");this._controlModel.setProperty("/tiles",i?this.aInsightsApps:this.aInsightsApps?.slice(0,t));this._controlModel.setProperty("/isPhone",n);this._updateTilesActivity();const s=i||this.aInsightsApps.length>t;if(this._headerVisible){if(!n){this.getAggregation("actionButtons")?.forEach(t=>{if(t.getId().includes(V.ADD_TILES)){this._getInsightsContainer().toggleActionButton(t,true)}})}this._getInsightsContainer()?.toggleFullScreenElements(this,s)}else{const t=L(this);const e=t?.getTitle()??"";this._getInsightsContainer()?.updateMenuItem(this._controlMap.get(`${this.getId()}-${R.SHOW_MORE}`),s,e);this._getInsightsContainer()?.updateActionButton(this._controlMap.get(`${this.getId()}-${x.SHOW_MORE}`),s,e)}}},_getInsightsContainer:function t(){if(!this.insightsContainer){this.insightsContainer=this.getParent()}return this.insightsContainer},getContainerMenuItems:function t(){if(!this._containerMenuItems){const t=$(this,R.SHOW_MORE,"containerTilesShowMore");this._controlMap.set(`${this.getId()}-${R.SHOW_MORE}`,t);this._containerMenuItems=[t]}return this._containerMenuItems},getContainerActionButtons:function t(){if(!this._containerActionButtons){this._containerActionButtons=[];const t=W(this,x.SHOW_MORE,"containerTilesShowMore");if(t){this._controlMap.set(`${this.getId()}-${x.SHOW_MORE}`,t);this._containerActionButtons.push(t)}}return this._containerActionButtons},_toggleHeaderActions:function t(e){this.getAggregation("menuItems")?.forEach(t=>{this._getInsightsContainer()?.toggleMenuListItem(t,e)});this.getAggregation("actionButtons")?.forEach(t=>this._getInsightsContainer()?.toggleActionButton(t,e))}});k.tilesMenuItems=F;k.tilesContainerMenuItems=R;k.tilesActionButtons=V;k.tilesContainerActionButtons=x;k.DisplayFormat=z;return k});
//# sourceMappingURL=SpaceInsightsPanel.js.map