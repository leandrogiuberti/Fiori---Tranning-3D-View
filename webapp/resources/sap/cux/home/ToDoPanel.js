/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/f/Card","sap/f/GridContainer","sap/f/GridContainerSettings","sap/m/Button","sap/m/GenericTile","sap/m/HeaderContainer","sap/m/IllustratedMessage","sap/m/IllustratedMessageSize","sap/m/Text","sap/m/TileContent","sap/m/VBox","sap/m/library","sap/ui/Device","sap/ui/core/Element","sap/ui/core/InvisibleText","sap/ui/core/format/DateFormat","sap/ui/model/json/JSONModel","./BasePanel","./MenuItem","./ToDosContainer","./utils/BatchHelper","./utils/Device","./utils/FESRUtil","./utils/HttpHelper"],function(t,e,n,r,i,o,s,a,l,u,c,h,d,f,_,p,g,D,y,m,T,C,P,E,I){"use strict";function v(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}function R(t,e){try{var n=t()}catch(t){return e(t)}if(n&&n.then){return n.then(void 0,e)}return n}const b=d["Priority"];function L(t,e){try{var n=t()}catch(t){return e(true,t)}if(n&&n.then){return n.then(e.bind(null,false),e.bind(null,true))}return e(false,n)}const w=d["URLHelper"];const x=typeof Symbol!=="undefined"?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function M(t,e,n){if(!t.s){if(n instanceof S){if(n.s){if(e&1){e=n.s}n=n.v}else{n.o=M.bind(null,t,e);return}}if(n&&n.then){n.then(M.bind(null,t,e),M.bind(null,t,2));return}t.s=e;t.v=n;const r=t.o;if(r){r(t)}}}const S=function(){function t(){}t.prototype.then=function(e,n){const r=new t;const i=this.s;if(i){const t=i&1?e:n;if(t){try{M(r,1,t(this.v))}catch(t){M(r,2,t)}return r}else{return this}}this.o=function(t){try{const i=t.v;if(t.s&1){M(r,1,e?e(i):i)}else if(n){M(r,1,n(i))}else{M(r,2,i)}}catch(t){M(r,2,t)}};return r};return t}();function O(t){return t instanceof S&&t.s&1}function A(t,e,n){var r=-1,i,o;function s(a){try{while(++r<t.length&&(!n||!n())){a=e(r);if(a&&a.then){if(O(a)){a=a.v}else{a.then(s,o||(o=M.bind(null,i=new S,2)));return}}}if(i){M(i,1,a)}else{i=a}}catch(t){M(i||(i=new S),2,t)}}s();return i}const H=v(y);function B(t,e,n){if(typeof t[x]==="function"){var r=t[x](),i,o,s;function c(t){try{while(!(i=r.next()).done&&(!n||!n())){t=e(i.value);if(t&&t.then){if(O(t)){t=t.v}else{t.then(c,s||(s=M.bind(null,o=new S,2)));return}}}if(o){M(o,1,t)}else{o=t}}catch(t){M(o||(o=new S),2,t)}}c();if(r.return){var a=function(t){try{if(!i.done){r.return()}}catch(t){}return t};if(o&&o.then){return o.then(a,function(t){throw a(t)})}a()}return o}if(!("length"in t)){throw new TypeError("Object is not iterable")}var l=[];for(var u=0;u<t.length;u++){l.push(t[u])}return A(l,function(t){return e(l[t])},n)}const N=v(m);const U=v(T);const $=v(C);const F=P["calculateCardWidth"];const W=P["DeviceType"];const V=P["fetchElementProperties"];const q=E["addFESRId"];const j=v(I);const G={SITUATION_ICON:"sap-icon://message-warning",PLACEHOLDER_ITEMS_COUNT:5,TODO_CARDS_LIMIT:100,TODO_SECTION_LIMIT:6,TODOS_REFRESH_INTERVAL:65e3,MOBILE_DEVICE_MAX_WIDTH:600,DEFAULT_TITLE_HEIGHT:33,DEFAULT_CARD_HEIGHT:168,DEFAULT_TAB_HEADER_HEIGHT:44,GAP:16};const z=H.extend("sap.cux.home.ToDoPanel",{metadata:{library:"sap.cux.home",properties:{baseUrl:{type:"string",group:"Misc",defaultValue:"",visibility:"public"},countUrl:{type:"string",group:"Misc",defaultValue:"",visibility:"public"},dataUrl:{type:"string",group:"Misc",defaultValue:"",visibility:"public"},targetAppUrl:{type:"string",group:"Misc",defaultValue:"",visibility:"public"},minCardWidth:{type:"int",group:"Misc",defaultValue:304,visibility:"hidden"},maxCardWidth:{type:"int",group:"Misc",defaultValue:583,visibility:"hidden"},useBatch:{type:"boolean",group:"Misc",defaultValue:true,visibility:"hidden"}},aggregations:{content:{multiple:true,singularName:"content",visibility:"hidden"}}},constructor:function t(e,n){H.prototype.constructor.call(this,e,n);this.batchHelper=new $},init:function t(){const e=this;H.prototype.init.call(this);this._oData={length:0,isLoaded:false,hasError:false,cardWidth:"20rem",getSupported:false,isExpandedOnce:false,isCountCalledOnce:false,illustrationType:"sapIllus-NoTasks",refreshInfo:this._toRelativeDateTime(new Date),fullRefreshInfo:this._toFullRelativeDateTime(new Date),horizontalCardCount:G.PLACEHOLDER_ITEMS_COUNT,illustrationTitle:this._i18nBundle.getText("noToDoTitle"),illustrationDescription:this._i18nBundle.getText("noToDoDesc"),isPhone:f.resize.width<G.MOBILE_DEVICE_MAX_WIDTH||f.system.phone,tiles:new Array(G.PLACEHOLDER_ITEMS_COUNT).fill({loadState:"Loading"}),displayTiles:new Array(G.PLACEHOLDER_ITEMS_COUNT).fill({loadState:"Loading"})};this._controlModel=new D(this._oData);this.requests=[];this._toDoWrapper=new h(`${this.getId()}-toDosWrapper`,{renderType:"Bare",items:[this._generateCardContainer(),this._generateMobileCardContainer(),this._generateErrorMessage()]});this._toDoWrapper.setModel(this._controlModel);this.addContent(this._toDoWrapper);const n=new N(`${this.getId()}-refresh`,{title:this._i18nBundle.getText("refresh"),icon:"sap-icon://refresh",press:()=>this._onPressRefresh()});this.addAggregation("menuItems",n);q(n,"todosRefresh");this._accRefreshLabel=new p(`${this.getId()}-refreshAccText`,{text:this._toFullRelativeDateTime(new Date)});this.addDependent(this._accRefreshLabel);this._refreshBtn=new i(`${this.getId()}-refreshBtn`,{icon:"sap-icon://refresh",text:this._toRelativeDateTime(new Date),press:()=>this._onPressRefresh()});this._refreshBtn.addAriaLabelledBy(this._accRefreshLabel);q(this._refreshBtn,"manualTodoRefresh");this.addAggregation("actionButtons",this._refreshBtn);this.setProperty("enableFullScreen",true);this.attachEvent("onExpand",function(){try{return Promise.resolve(e._beforePanelExpand()).then(function(){})}catch(t){return Promise.reject(t)}})},_generateCardContainer:function t(){if(!this._cardContainer){this._cardContainer=new n(`${this.getId()}-flexContainer`,{inlineBlockLayout:true,snapToRow:true,visible:"{= !${/isPhone} && !${/hasError} && (!${/isLoaded} || ${/length} > 0) }",layout:new r(`${this.getId()}-layout`,{columns:"{/horizontalCardCount}",columnSize:"{/cardWidth}",gap:"1rem"})}).addStyleClass("sapCuxToDoCardsContainer")}return this._cardContainer},_generateMobileCardContainer:function t(){if(!this._mobileCardContainer){this._mobileCardContainer=new s(`${this.getId()}-headerContainer`,{visible:"{/isPhone}",scrollStep:0,gridLayout:true,scrollTime:1e3,showDividers:false,snapToRow:true}).addStyleClass("sapCuxToDoMobileCardsContainer")}return this._mobileCardContainer},_generateErrorMessage:function t(){if(!this._errorCard){this._errorMessage=new a(`${this.getId()}-errorMessage`,{illustrationSize:l.Base,title:"{/illustrationTitle}",description:"{/illustrationDescription}",illustrationType:"{/illustrationType}"});this._errorCard=new e(`${this.getId()}-errorCard`,{content:this._errorMessage,visible:"{= ${/tiles/length} === 0 || ${/hasError} === true }"})}return this._errorCard},_onPressRefresh:function t(){void this.getParent()?._getSelectedPanel()?._loadCards(true)},_loadCards:function e(n){try{const e=this;if(e._loadToDos!==undefined&&!n){return Promise.resolve(e._loadToDos)}else{e._bindInnerControls();e._loadToDos=new Promise(n=>{const r=e.getParent()?._getSelectedPanel()?.getProperty("key");const i=[];e._oData.isLoaded=false;e._oData.isCountCalledOnce=false;e._oData.isExpandedOnce=e._isElementExpanded();e._setCount();if(e._getSupported()){setTimeout(()=>{e._generatePlaceHolderTiles();i.push(e._generateRequestObject({type:r,onlyCount:r!==e.getProperty("key")}));e.requests=e.requests.concat(i);e._submitBatch().then(function(){try{e._oData.isLoaded=r===e.getProperty("key");e.fireEvent("loaded");e._oData.isCountCalledOnce=true;e._setCount(e._oData.length);e._setSectionRefreshInterval();e._oData.refreshInfo=e._toRelativeDateTime(new Date);e._oData.fullRefreshInfo=e._toFullRelativeDateTime(new Date);e._oData.lastRefreshedTime=new Date;e._updateRefreshInformation();return Promise.resolve(e._switchTabIfRequired()).then(function(){e._updateHeaderIfExclusive()})}catch(t){return Promise.reject(t)}}).catch(e=>{t.error(e instanceof Error?e.message:"")}).finally(()=>{e._controlModel.refresh();e._adjustLayout();n()})})}else{e._handleError(`User not authorized to access: + ${e.getTargetAppUrl()}`);e.getParent()?.removeContent(e);n()}})}return Promise.resolve(e._loadToDos)}catch(t){return Promise.reject(t)}},_updateHeaderIfExclusive:function t(){if(this._isExclusivePanel()){this.getParent()._setTitle(`${this._i18nBundle.getText("toDosTitle")} (${String(this._oData.length)})`)}},_bindInnerControls:function t(){if(!this._innerControlsBound){this._cardContainer.bindAggregation("items",{path:"/displayTiles",length:G.TODO_CARDS_LIMIT,factory:(t,e)=>this.generateCardTemplate(t,e)?.bindProperty?.("width",{path:"/cardWidth"})});this._mobileCardContainer.bindAggregation("content",{path:"/displayTiles",length:G.TODO_CARDS_LIMIT,factory:(t,e)=>this.generateCardTemplate(t,e)?.bindProperty?.("width",{path:"/cardWidth"})});this._innerControlsBound=true}},generateCardTemplate:function t(e,n){return new o(`${e}-tile`,{mode:"ActionMode",frameType:"TwoByOne",pressEnabled:true,header:n.getProperty("title"),width:n.getProperty("/cardWidth"),state:n.getProperty("loadState"),tileContent:[new c(`${e}-tileContent`,{priority:n.getProperty("priority"),priorityText:this._toPriorityText(n.getProperty("priority")),footer:n.getProperty("footerText"),content:new u(`${e}-situationContent`,{text:n.getProperty("message")})})]})},_toPriorityText:function t(e){let n;if(e===b.VeryHigh){n="veryHighPriority"}else if(e===b.High){n="highPriority"}else if(e===b.Medium){n="mediumPriority"}else if(e===b.Low){n="lowPriority"}else{n="nonePriority"}return this._i18nBundle.getText(n)},_generatePlaceHolderTiles:function t(){this._cardCount=this._getVisibleCardCount({isPlaceholder:true});this._oData.displayTiles=this._oData.tiles=new Array(this._cardCount).fill({loadState:"Loading"});this._oData.isLoaded=this._oData.hasError=false;this._controlModel.refresh()},_getVisibleCardCount:function t(e){const n=this.getParent()?._getLayout();let r=false;let i=this._toDoWrapper?.getDomRef();if(n){r=this._isElementExpanded();const t=n.getProperty("showHeader");const e=(r?n._getFullScreenContainer():n).getDomRef();const o=t&&!r?1:0;i=e?.childNodes[o]}const o=this._controlModel.getProperty("/isPhone");let s=o?G.TODO_SECTION_LIMIT:1;if(i){s=this.getHorizontalCardCount(i,e);if(r){s*=this.getVerticalCardCount(i,e)}s=s>G.TODO_CARDS_LIMIT?G.TODO_CARDS_LIMIT:s}return s},_isElementExpanded:function t(){const e=this.getParent();const n=e._getLayout();return n?._getCurrentExpandedElementName()===e.getProperty("fullScreenName")},getHorizontalCardCount:function t(e){const n=V(e,["width","padding-left","padding-right","margin-left","margin-right"]);const r=Object.values(n).slice(1).reduce((t,e)=>t-e,n["width"]);const i=this._oData.length;const o=this._controlModel.getProperty("/isPhone");let s;const a=this.getProperty("minCardWidth");const l=this.getProperty("maxCardWidth");const u={containerWidth:r,totalCards:i,minWidth:a,maxWidth:l,gap:G.GAP};const c=F(u);if(o){s=G.TODO_SECTION_LIMIT}else{s=Math.max(Math.floor(r/c),1)}this._controlModel.setProperty("/cardWidth",`${c/16}rem`);this._controlModel.setProperty("/horizontalCardCount",s);return s},getVerticalCardCount:function t(e){const n=V(e,["padding-top"]);const r=V(e.parentElement,["height"]);const i=this.calculateTitleHeight();const o=r.height-n["padding-top"]*2-i;const s=14;const a=G.DEFAULT_CARD_HEIGHT+s;const l=Math.max(Math.floor(o/a),2);return l},calculateTitleHeight:function t(){const e=this.getParent();const n=_.getElementById(`${e.getId()}-header`)?.getDomRef();const r=_.getElementById(`${e._getInnerControl().getId()}--header`)?.getDomRef();const i=G.DEFAULT_TITLE_HEIGHT+G.DEFAULT_TAB_HEADER_HEIGHT;let o=0;if(n&&r){o=n.clientHeight+r.clientHeight}return Math.max(o,i)},_generateRequestObject:function t(e){const n=this;const r=this._getVisibleCardCount();const i=this.getCountUrl();const o=this.generateRequestUrls?.(r);if(i&&e?.onlyCount){o.splice(1)}return{baseURL:this.getBaseUrl(),requestURLs:o,success:function(t){try{return Promise.resolve(n.onDataReceived(i?t.splice(1):t,e)).then(function(){n._oData.length=i?Number(t[0]):n._oData.tiles.length;n._handleEmptyCards()})}catch(t){return Promise.reject(t)}}}},generateRequestUrls:function t(e){const n=[];const r=this.getCountUrl();if(r){n.push(r)}let i=this.getDataUrl();if(this.getProperty("useBatch")){const t=`$skip=0&$top=${e}`;i=i.includes("?")?`${i}&${t}`:`${i}?${t}`}n.push(i);return n},onDataReceived:function t(e=[],n){try{const t=this;if(!n||n&&!n.onlyCount){t._oData.displayTiles=t._oData.tiles=e[0]||[]}return Promise.resolve(Promise.resolve()).then(function(){})}catch(t){return Promise.reject(t)}},_handleEmptyCards:function t(){if(Number(this._oData.length)===0){this._oData.illustrationType="sapIllus-EmptyPlanningCalendar";this._oData.illustrationTitle=this._isExclusivePanel()?this._i18nBundle.getText("noToDoTitle"):this.getNoDataText();this._oData.illustrationDescription=this._isExclusivePanel()?this._i18nBundle.getText("noToDoDesc"):this._i18nBundle.getText("emptyToDoDesc")}},_isExclusivePanel:function t(){const e=this.getParent().getContent();const n=e.filter(t=>t._getSupported());return n.length===1||e.length===1&&this._getSupported()},_setSectionRefreshInterval:function t(){clearInterval(this._oData.refreshFn);this._oData.refreshFn=setInterval(()=>{this._oData.lastRefreshedTime=this._oData.lastRefreshedTime||new Date;this._oData.refreshInfo=this._toRelativeDateTime(this._oData.lastRefreshedTime);this._oData.fullRefreshInfo=this._toFullRelativeDateTime(this._oData.lastRefreshedTime);this._updateRefreshInformation()},G.TODOS_REFRESH_INTERVAL)},_updateRefreshInformation:function t(){const e=this.getParent();if(e.getProperty("selectedKey")===this.getProperty("key")){this._refreshBtn.setProperty("text",this._oData.refreshInfo,true);this._accRefreshLabel.setProperty("text",this._oData.fullRefreshInfo,true);this._refreshBtn.setAggregation("tooltip",this._oData.fullRefreshInfo,true);e._updateContainerHeader(this)}this._adjustLayout()},_adjustLayout:function t(){const e=this._getVisibleCardCount();if(this._oData.tiles.length&&!this._oData.hasError){const t=this._oData.tiles.slice(0,e);this._controlModel.setProperty("/displayTiles",t)}this._controlModel.setProperty("/isPhone",this.getDeviceType()===W.Mobile);this.getParent()?.toggleFullScreenElements(this,this._isElementExpanded()||Number(this._oData.length)>e)},_toRelativeDateTime:function t(e){const n=new Date(e);return isNaN(Number(n))?"":z.relativeDateFormatter.format(n)},_toFullRelativeDateTime:function t(e){const n=new Date(e);return isNaN(Number(n))?"":z.fullRelativeDateFormatter.format(n)},getNoDataText:function t(){return this._i18nBundle.getText("noData")},_parseResponse:function t(e){const{d:n={},value:r}=e||{};const i=n?.results;const o=!isNaN(+n)&&+n;const s=!isNaN(+e)&&+e;return i||o||s||r||e||0},_submitBatch:function t(){const e=this;return Promise.all(this.requests.map(function(t){try{return Promise.resolve(L(function(){return R(function(){const n=e.getProperty("useBatch");return Promise.resolve(n?e.batchHelper.createMultipartRequest(t.baseURL,t.requestURLs):j.GetMultipleRequests(t.requestURLs)).then(function(n){if(n.length){const r=n.map(t=>{if(typeof t==="string"){t=JSON.parse(t)}return e._parseResponse(t)});const i=function(){if(t.success&&typeof t.success==="function"){return Promise.resolve(t.success(r)).then(function(){})}}();return i&&i.then?i.then(function(){return r}):r}else{throw new Error("Invalid response")}})},function(t){e._handleError(t)})},function(t,n){e._clearRequests();if(t)throw n;return n}))}catch(t){return Promise.reject(t)}}))},_handleError:function e(n){this._oData.displayTiles=this._oData.tiles=[];this._oData.getSupported=this._oData.isLoaded=this._oData.hasError=true;this._oData.illustrationType="sapIllus-UnableToLoad";this._oData.illustrationTitle=this._oData.illustrationDescription="";t.error(n);this._controlModel.refresh()},_clearRequests:function t(){this.requests=[]},_isLoaded:function t(){const e=this.getParent();const n=e?._getLayout()?.getProperty("expanded");const{isLoaded:r,isExpandedOnce:i}=this._oData;if(!n){return r}return i&&r},_setLoaded:function t(e){this._oData.isLoaded=e},_getSupported:function t(){return this._oData.getSupported},_setSupported:function t(e){this._oData.getSupported=e},_getAppIntent:function t(){const e=/#([^?-]+)-([^?#]+)(?:\?([^#]+))?(?:#.*)?/;const n=this.getTargetAppUrl().match(e);if(n){const t={semanticObject:n[1],action:n[2]};const e={};if(n[3]){const t=n[3].split("&");for(const n of t){const[t,r]=n.split("=");e[t]=r}}return{target:t,params:e}}else{return null}},_switchTabIfRequired:function t(){try{const t=this;const e=t.getParent();const n=e?.getProperty("selectedKey");return Promise.resolve(function(){if(n===t.getProperty("key")&&(t._oData.length===0||t._oData.hasError)){let r=false;function i(){const n=function(){if(o){e?.setProperty("selectedKey",o.getProperty("key"));U.cardCount=t._cardCount;return Promise.resolve(o._loadCards(true)).then(function(){U.cardCount=undefined})}}();if(n&&n.then)return n.then(function(){})}let o;const s=e?.getAggregation("content");const a=B(s,function(e){const n=function(){if(e!==t){return Promise.resolve(e._loadCards()).then(function(){if(e._getSupported()&&!e._isLoaded()&&e._getCardCount()>0){o=e;r=true}})}}();if(n&&n.then)return n.then(function(){})},function(){return r});return a&&a.then?a.then(i):i(a)}}())}catch(t){return Promise.reject(t)}},_onPressViewAll:function t(){w.redirect(this.getTargetAppUrl(),false)},_getCardCount:function t(){return Number(this._oData.length)},_beforePanelExpand:function t(){try{const t=this;const e=function(){if(!t._oData.isExpandedOnce){t._oData.isExpandedOnce=true;return Promise.resolve(t._loadCards(true)).then(function(){})}}();return Promise.resolve(e&&e.then?e.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},exit:function t(){clearInterval(this._oData.refreshFn)}});z.fullRelativeDateFormatter=g.getDateTimeInstance({style:"long",relative:true,relativeStyle:"wide"});z.relativeDateFormatter=g.getDateTimeInstance({style:"medium",relative:true,relativeStyle:"short"});return z});
//# sourceMappingURL=ToDoPanel.js.map