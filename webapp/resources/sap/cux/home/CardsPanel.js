/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/f/GridContainer","sap/f/GridContainerSettings","sap/fe/navigation/SelectionVariant","sap/insights/CardHelper","sap/insights/base/InMemoryCachingHost","sap/m/HBox","sap/m/HeaderContainer","sap/m/VBox","sap/ui/core/EventBus","sap/ui/integration/widgets/Card","sap/ui/model/json/JSONModel","sap/ushell/Container","sap/ushell/api/S4MyHome","./BasePanel","./MenuItem","./utils/AppManager","./utils/CommonUtils","./utils/Constants","./utils/DataFormatUtils","./utils/Device","./utils/DragDropUtils","./utils/FESRUtil","./utils/InsightsUtils","./utils/PersonalisationUtils","./utils/UshellPersonalizer"],function(e,t,n,r,s,i,a,o,c,d,h,l,u,g,f,p,m,C,_,P,y,I,v,M,S,b){"use strict";function A(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}function E(e,t){try{var n=e()}catch(e){return t(e)}if(n&&n.then){return n.then(void 0,t)}return n}const w=A(f);function D(e,t){try{var n=e()}catch(e){return t(true,e)}if(n&&n.then){return n.then(t.bind(null,false),t.bind(null,true))}return t(false,n)}const R=A(p);const H=A(m);const O=C["getPageManagerInstance"];const x=_["PREFERED_CARDS"];const T=_["SETTINGS_PANELS_KEYS"];const V=P["recycleId"];const N=y["calculateCardWidth"];const B=y["DeviceType"];const j=y["fetchElementProperties"];const W=I["focusDraggedItem"];const $=v["addFESRId"];const F=M["createShowMoreActionButton"];const L=M["createShowMoreMenuItem"];const k=M["getAssociatedFullScreenMenuItem"];const U=M["sortMenuItems"];const J=M["targetsAreEqual"];const z=A(S);const G=A(b);var q=function(e){e["REFRESH"]="cards-refresh";e["EDIT_CARDS"]="cards-editCards";e["AI_INSIGHT_CARD"]="cards-addAIInsightCard";return e}(q||{});var K=function(e){e["REFRESH"]="container-cards-refresh";e["EDIT_CARDS"]="container-cards-editCards";e["SHOW_MORE"]="cardsContainerFullScreenMenuItem";e["AI_INSIGHT_CARD"]="container-cards-addAIInsightCard";return e}(K||{});var Q=function(e){e["SHOW_MORE"]="cardsContanerFullScreenActionButton";return e}(Q||{});const Y=[q.REFRESH,q.EDIT_CARDS,q.AI_INSIGHT_CARD,"showMore","settings"];const X={PLACEHOLDER_CARD_COUNT:10,CARDS_GAP:16};const Z="showRecommendation";let ee=false;const te=w.extend("sap.cux.home.CardsPanel",{metadata:{library:"sap.cux.home",properties:{title:{type:"string",group:"Misc",defaultValue:"",visibility:"hidden"},key:{type:"string",group:"Misc",defaultValue:"",visibility:"hidden"},fullScreenName:{type:"string",group:"Misc",defaultValue:"SI2",visibility:"hidden"}},defaultAggregation:"cards",aggregations:{content:{multiple:true,singularName:"content",visibility:"hidden"},cards:{type:"sap.ui.integration.widgets.Card",multiple:true,singularName:"card",visibility:"hidden"},host:{type:"sap.ui.integration.Host",multiple:false,singularName:"host",visibility:"hidden"}},events:{handleHidePanel:{parameters:{}},handleUnhidePanel:{parameters:{}},visibleCardsUpdated:{parameters:{cards:{type:"sap.ui.integration.widgets.Card[]"}}}}},constructor:function e(t,n){w.prototype.constructor.call(this,t,n);this.aVisibleCardInstances=[];this.cardsInViewport=[];this._appSwitched=false;this._headerVisible=false},init:function e(){const t=this;w.prototype.init.call(this);this.setProperty("key","cards");this.setProperty("enableFullScreen",true);this.cardWidth="19rem";this.cardHeight=this.getDeviceType()===B.Mobile?"25.5rem":"33rem";this._oData={userVisibleCards:[],userAllCards:[],isPhone:this.getDeviceType()===B.Mobile};this._controlModel=new l(this._oData);this.appManagerInstance=H.getInstance();this._controlMap=new Map;const n=this._createRefreshMenuItem(q.REFRESH,"cardsRefresh");const r=this._createEditCardsMenuItem(q.EDIT_CARDS,"manageCards");const s=[n,r];s.forEach(e=>this.addAggregation("menuItems",e));this._sortMenuItems(Y);this.oEventBus=d.getInstance();this.oEventBus.subscribe("importChannel","cardsImport",function(e,n,r){try{return Promise.resolve(t._createCards(r)).then(function(){return Promise.resolve(t.rerenderCards()).then(function(){t._importdone()})})}catch(e){return Promise.reject(e)}},this);this._setupWrapper();this._toggleCardActivity()},_toggleCardActivity:function t(){const n=this;const r=function(e){try{const t=e.getParameter("isMyHomeRoute");const r=function(){if(t){const e=function(){if(n._appSwitched){return Promise.resolve(n.rerenderCards()).then(function(){n._appSwitched=false})}}();if(e&&e.then)return e.then(function(){})}else{n._appSwitched=true}}();return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};try{g.attachRouteMatched({},r,this)}catch(t){e.warning(t instanceof Error?t.message:String(t))}},_createCards:function e(t){try{const e=this;return Promise.resolve(e.cardHelperInstance?._createCards(t)).then(function(){return e.rerenderCards()})}catch(e){return Promise.reject(e)}},_getManifestEntryFromCard:function e(t,n){const r=t;const s=t.getManifestEntry(n);if(s){return Promise.resolve(s)}else{if(!r._pManifestReady){r._pManifestReady=new Promise(e=>{t.attachManifestReady(()=>{e(t.getManifestEntry(n))})})}return r._pManifestReady}},_addRuntimeHost:function e(){const t=this,n=this,r=this,s=this,a=this;const o=this.getAggregation("host")||new i("runtimeHost");const c=function(e){try{const n=e.getParameter("type");let r=e.getParameter("parameters")||{};const s=function(){if(n==="Navigation"&&r.ibnTarget){e.preventDefault();const n=e.getParameter("card")||{},s=n?.getManifestEntry("sap.card")||{},i=s?.header?.actions||[];let a;if(s?.configuration?.parameters?._semanticDateRangeSetting?.value){a=JSON.parse(s.configuration.parameters._semanticDateRangeSetting.value)}if(a&&Object.keys(a).length){r=t.cardHelperInstance.processSemanticDate(r,s)}let o=t.getContentActions(s);const c=i[0]||{},d=o[0]||{};const h=!!(c?.parameters&&typeof c.parameters==="string"&&c.parameters.indexOf("{= extension.formatters.addPropertyValueToAppState")>-1||d?.parameters&&typeof d.parameters==="string"&&d.parameters.indexOf("{= extension.formatters.addPropertyValueToAppState")>-1);t._manageOldCardExtension(h,e,r);return Promise.resolve(u.getServiceAsync("Navigation")).then(function(e){return Promise.resolve(e.navigate({target:r.ibnTarget,params:r.ibnParams})).then(function(){})})}}();return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};const d=[{type:"Custom",text:this._i18nBundle?.getText("refresh"),icon:"sap-icon://refresh",action:e=>{this._refreshCardData(e)},visible:function(e){try{return Promise.resolve(n._getManifestEntryFromCard(e,"sap.insights")).then(function(e){return e&&!e.cacheType})}catch(e){return Promise.reject(e)}}},{type:"Custom",text:this._i18nBundle?.getText("viewFilteredBy"),icon:"sap-icon://filter",action:e=>{const t=e.getManifestEntry("sap.app").id;this.getParent()?._getLayout().openSettingsDialog(T.INSIGHTS_CARDS,{cardId:t})},visible:function(e){try{return Promise.resolve(r._getManifestEntryFromCard(e,"sap.insights")).then(function(t){if(t){const t=e.getManifestEntry("sap.card")?.configuration?.parameters;const n=t?._relevantODataFilters?.value||[];const r=n?.length;const s=t?._relevantODataParameters?.value||[];const i=s?.length;const a=e.getManifestEntry("sap.app").dataSources;const o=a?.filterService;const c=o?.settings;return!!((r||i)&&c&&c.odataVersion==="2.0")}else{return false}})}catch(e){return Promise.reject(e)}}},{type:"Custom",text:this._i18nBundle?.getText("navigateToParent"),icon:"sap-icon://display-more",visible:function(e){try{return Promise.resolve(s._getManifestEntryFromCard(e,"sap.insights").then(function(t){try{if(t){return Promise.resolve(s.cardHelperInstance.getParentAppDetails({descriptorContent:e.getManifestEntry("/")})).then(function(e){if(e.semanticObject&&e.action){return Promise.resolve(u.getServiceAsync("Navigation")).then(function(t){const n=[{target:{semanticObject:e.semanticObject,action:e.action}}];return Promise.resolve(t.isNavigationSupported(n)).then(function(e){const t=e;return t[0].supported||false})})}else{return true}})}else{return Promise.resolve(false)}}catch(e){return Promise.reject(e)}}))}catch(e){return Promise.reject(e)}},action:function(e){try{return Promise.resolve(a.cardHelperInstance.getParentAppDetails({descriptorContent:e.getManifestEntry("/")})).then(function(e){const t=e.semanticURL||e.semanticObject;return Promise.resolve(u.getServiceAsync("Navigation")).then(function(e){return Promise.resolve(e.navigate({target:{shellHash:t}})).then(function(){})})})}catch(e){return Promise.reject(e)}}}];o.attachAction(c);o.setProperty("actions",d);this.setAggregation("host",o)},_manageOldCardExtension:function e(t,n,s){if(t){const e=new r;const t=n.getParameter("card").getCombinedParameters();(t?._relevantODataParameters).forEach(e=>{if(s.ibnParams){s.ibnParams[e]=t[e]}});(t?._relevantODataFilters).forEach(n=>{const r=JSON.parse(t[n]);const i=r.SelectOptions[0];const a=i.Ranges;if(a?.length===1&&a[0].Sign==="I"&&a[0].Option==="EQ"){if(s.ibnParams){s.ibnParams[n]=a[0].Low}}else if(a?.length>0){e.massAddSelectOption(n,a)}});const i=JSON.parse(s?.ibnParams?.["sap-xapp-state-data"]);i.selectionVariant=e.toJSONObject();if(s.ibnParams){s.ibnParams["sap-xapp-state-data"]=JSON.stringify(i)}}},getContentActions:function e(t){let n;if(t.type==="List"){n=t?.content?.item?.actions}else if(t.type==="Table"){n=t?.content?.row?.actions}else{n=t?.content?.actions}return n||[]},_importdone:function e(){const t={status:true};this.oEventBus.publish("importChannel","cardsImported",t)},_refreshCardData:function e(t){sap.ui.require(["sap/insights/base/CacheData"],e=>{const n=t.getManifestEntry("sap.app")?.id;const r=e.getInstance();r.clearCache(n);t.refreshData()})},refreshData:function t(){try{const t=this;const n=E(function(){return Promise.resolve(s.getServiceAsync()).then(function(e){t.cardHelperInstance=e;return Promise.resolve(t.cardHelperInstance._refreshUserCards(false)).then(function(){return Promise.resolve(t.renderPanel()).then(function(){})})})},function(t){e.error("Failed to refresh cards: ",t instanceof Error?t.message:t)});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},renderPanel:function e(){try{const t=this;function n(){return Promise.resolve(t.rerenderCards()).then(function(){t.fireEvent("loaded")})}const r=function(){if(!t.cardHelperInstance){t.pageManagerInstance=t.pageManagerInstance||O(t);return Promise.resolve(Promise.all([s.getServiceAsync(),t.pageManagerInstance.hasCustomSpace()])).then(function([e,n]){t.cardHelperInstance=e;t.hasCustomSpace=n})}}();return Promise.resolve(r&&r.then?r.then(n):n(r))}catch(i){return Promise.reject(i)}},rerenderCards:function t(n=false){try{const t=this;if(!t._cardsRendered){t._cardsRendered=new Promise((r,s)=>{void function(){try{const i=E(function(){const e=t._getCardContainer().getMetadata().getDefaultAggregationName();t._getCardContainer().removeAllAggregation(e);t._showPlaceHolders();const s=t.hasCustomSpace?x:[];return Promise.resolve(t.cardHelperInstance?._getUserVisibleCardModel(s)).then(function(e){const s=e.getProperty("/cards");const i=e?.bindList("/cards");if(!i.hasListeners("change")){i?.enableExtendedChangeDetection(true,"/cards",{});i?.attachChange(function(){try{return Promise.resolve(t._cardsRendered??Promise.resolve()).then(function(){const n=e.getProperty("/cards");if(n.length!==t.aVisibleCardInstances.length&&n.length>0){t._showCards(n)}else if(!n.length){t.fireHandleHidePanel()}})}catch(e){return Promise.reject(e)}})}t._controlModel.setProperty("/userVisibleCards",s);return Promise.resolve(t.getPersonalisationProperty(Z)).then(function(e){function i(){t._cardsRendered=undefined;r()}const a=function(){if(s.length===0&&e===undefined&&!n){return Promise.resolve(t._getRecommendationCards()).then(function(){})}else{const n=function(){if(s.length){function n(){return Promise.resolve(t.checkForRecommendedCards(s)).then(function(){})}const r=function(){if(e===undefined){return Promise.resolve(t._updateRecommendationStatus()).then(function(){})}}();return r&&r.then?r.then(n):n(r)}else{t.fireHandleHidePanel()}}();if(n&&n.then)return n.then(function(){})}}();return a&&a.then?a.then(i):i(a)})})},function(n){t.fireHandleHidePanel();t._cardsRendered=undefined;if(n instanceof Error){e.error(n.message);s(n)}});return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}()})}return Promise.resolve(t._cardsRendered)}catch(e){return Promise.reject(e)}},setNewVisibleCards:function e(){try{const e=this;const t=e.hasCustomSpace?x:[];return Promise.resolve(e.cardHelperInstance._getUserVisibleCardModel(t)).then(function(t){const n=t.getProperty("/cards");e._controlModel.setProperty("/userVisibleCards",n);e._showCards(n)})}catch(e){return Promise.reject(e)}},checkForRecommendedCards:function e(t){try{const e=this;let n=[];t.forEach((e,t)=>{let r=e.descriptorContent;if(r["sap.card"]?.rec===true&&(!r["sap.card"]["configuration"]||!r["sap.card"]["configuration"]["csrfTokens"])){n.push({cardId:r?.["sap.app"]?.id,rank:r?.["sap.insights"]?.ranking||e?.rank,id:r?.["sap.insights"]?.["parentAppId"]||"",target:r?.["sap.card"]?.["header"]?.["actions"]?.length?r["sap.card"]["header"]["actions"][0]?.["parameters"]?.ibnTarget:undefined,index:t})}});return Promise.resolve(function(){if(n.length){const t=e.getUniqueManifestDetails(n);return Promise.resolve(e.regenerateCards(t,n)).then(function(t){let n=false;function r(t){return n?t:Promise.resolve(e.setNewVisibleCards()).then(function(){})}const s=function(){if(t?.length){return Promise.resolve(e.cardHelperInstance._updateCards(t.map(e=>e?.newManifest?.descriptorContent))).then(function(){})}else{n=true}}();return s&&s.then?s.then(r):r(s)})}else{e._showCards(t)}}())}catch(e){return Promise.reject(e)}},getUniqueManifestDetails:function e(t){const n=[];t.forEach(e=>{const t=n.some(t=>t.id===e.id&&J(t.target,e.target));if(!t){n.push(JSON.parse(JSON.stringify(e)))}});return n},_getManifests:function e(t){try{const e=this;return Promise.resolve(e.appManagerInstance._getCardManifest(undefined,t)).then(function(n){if(n?.length){let r=n.map(function(e){if(e?.["sap.card"]){e["sap.card"].rec=true}return{id:e["sap.app"]?.id,descriptorContent:e}});let s=e._removeDuplicateRegeneratedCards(r,t);return s}else{return[]}})}catch(e){return Promise.reject(e)}},regenerateCards:function t(n,r){try{const t=this;return Promise.resolve(E(function(){return Promise.resolve(t._getManifests(n)).then(function(e){const t=e=>{if(e?.target?.semanticObject&&e?.target?.action){return e.id+"|"+e.target.semanticObject+"|"+e.target.action}return e.id};let n={};e.forEach(function(e){let r=t(e);if(e.newManifest){n[r]=e.newManifest}});let s=[];if(e.length){r.forEach(function(e){let r=t(e);if(n[r]){e.newManifest=n[r]}const i=e["newManifest"];const a=i?.descriptorContent;if(a){a["sap.insights"]={...a["sap.insights"],ranking:e.rank};if(a["sap.app"]){a["sap.app"].id=e.cardId}i.id=e.cardId;s.push(JSON.parse(JSON.stringify(e)))}})}return s})},function(t){e.error(t instanceof Error?t.message:String(t));return undefined}))}catch(e){return Promise.reject(e)}},_removeDuplicateRegeneratedCards:function e(t,n){const r={};n.forEach(e=>{if(e.id){r[e.id]=JSON.parse(JSON.stringify(e))}});t.forEach(function(e){const t=e?.descriptorContent?.["sap.insights"]?.parentAppId;if(t&&r[t]){const n=r[t];if(!n["newManifest"]){n["newManifest"]=e}}});return Object.values(r)},_getPersonalizationData:function e(){try{const t=this;function n(){return Promise.resolve(t.oPersonalizer.read()).then(function(e){return e||{}})}const r=function(){if(!t.oPersonalizer){return Promise.resolve(t._getPersonalization()).then(function(e){t.oPersonalizer=e})}}();return Promise.resolve(r&&r.then?r.then(n):n(r))}catch(s){return Promise.reject(s)}},getPersonalisationProperty:function e(t){try{const e=this;return Promise.resolve(e._getPersonalizationData()).then(function(e){return e?.[t]})}catch(e){return Promise.reject(e)}},_getRecommendationCards:function e(){try{const e=this;return Promise.resolve(e.appManagerInstance.getRecommenedCards()).then(function(t){if(t?.length){return e._handleRecommendationCards(t)}e.fireHandleHidePanel()})}catch(e){return Promise.reject(e)}},_handleRecommendationCards:function e(t){try{const e=this;const n=t.map(e=>e.descriptorContent);return Promise.resolve(e.cardHelperInstance?._createCards(n)).then(function(){return Promise.resolve(e._updateRecommendationStatus()).then(function(){return e.setNewVisibleCards()})})}catch(e){return Promise.reject(e)}},_setupWrapper:function e(){if(!this._cardsFlexWrapper){this._cardsFlexWrapper=new c(`${this.getId()}-cardsFlexWrapper`,{renderType:"Bare",width:"100%",items:[this._createCardContainer(),this._createMobileCardContainer()]});this._cardsFlexWrapper.setModel(this._controlModel);this.addContent(this._cardsFlexWrapper)}},_createCardContainer:function e(){this.cardsContainerSettings=new n(`${this.getId()}-insightsCardsContainerSettings`,{columnSize:this.cardWidth,rowSize:this.cardHeight,gap:"1rem"});this.cardsContainer=new t(`${this.getId()}-insightsCardsFlexBox`,{visible:"{= !${/isPhone}}"}).addStyleClass("sapUiSmallMarginTop").setLayout(this.cardsContainerSettings);this.cardsContainer.setModel(this._controlModel);this.addDragDropConfigTo(this.cardsContainer,e=>this._handleCardsDnd(e));return this.cardsContainer},_createMobileCardContainer:function e(){this.cardsMobileContainer=new o(`${this.getId()}-insightsCardsMobileFlexBox`,{scrollStep:0,scrollStepByItem:1,gridLayout:true,scrollTime:1e3,showDividers:false,visible:"{/isPhone}"});this.cardsMobileContainer.setModel(this._controlModel);this.addDragDropConfigTo(this.cardsMobileContainer,e=>this._handleCardsDnd(e));return this.cardsMobileContainer},_showPlaceHolders:function e(){const t=this.appManagerInstance._getAnalyticalCardManifest();const n=new Array(this._calculatePlaceholderCardCount()).fill(null);const r=n.map((e,n)=>{const r=new h(V(`${this.getId()}--placeHolderCard--${n}`),{width:this.cardWidth,height:this.cardHeight,previewMode:"Abstract",manifest:t,host:this.getAggregation("host")}).addStyleClass("sapUiSmallMarginEnd");return r});const s=new a(V(`${this.getId()}--wrapperBox`),{justifyContent:"SpaceBetween",items:r});const i=this._getCardContainer().getMetadata().getDefaultAggregationName();if(i){this._getCardContainer().addAggregation(i,s)}},_calculatePlaceholderCardCount:function e(){const t=this._getInsightsContainer()?._getLayout()?.getDomRef();let n=0;if(t){const e=t.childNodes[0];const r=j(e,["width","padding-left","padding-right"]);let s=r.width-r["padding-left"]-r["padding-right"];const i={containerWidth:s,totalCards:X.PLACEHOLDER_CARD_COUNT,minWidth:304,maxWidth:583,gap:16};const a=this.getDeviceType()===B.Mobile?19:N(i);n=this.getDeviceType()===B.Mobile?this.aVisibleCardInstances.length:Math.floor(s/(a+X.CARDS_GAP));this.cardWidth=`${a/16}rem`}return n||1},_showCards:function e(t){const n=this.getMetadata().getName();this.fireHandleUnhidePanel();this._getInsightsContainer()?.updatePanelsItemCount(t.length,n);if(this._headerVisible){this.setProperty("title",`${this._i18nBundle?.getText("insightsCards")} (${t.length})`)}const r=this._getCardContainer().getMetadata().getDefaultAggregationName();this._getCardContainer().removeAllAggregation(r);this.aVisibleCardInstances=[];this.cardsInViewport=[];if(!ee){this._addRuntimeHost();ee=true}t.forEach((e,t)=>{const n=e.descriptorContent;const r=new h(V(`${this.getId()}--userCard--${t}`),{width:this.cardWidth,height:this.cardHeight,manifest:n,host:this.getAggregation("host")});this.aVisibleCardInstances.push(r);this.addAggregation("cards",r,true);const s=[r];const i=n["sap.card"]?.type;if(i==="Table"||i==="List"){const e=new a(V(`${this.getId()}--overlay--${t}`),{width:this.cardWidth,height:"2rem"}).addStyleClass("insightsCardOverflowTop");const n=new a(V(`${this.getId()}--overlayHBoxId--${t}`),{height:"0"}).addStyleClass("sapMFlexBoxJustifyCenter");n.addItem(e);s.push(n)}const o=new c(V(`${this.getId()}--previewBoxId--${t}`),{direction:"Column",justifyContent:"Center",items:s});const d=this._getCardContainer().getMetadata().getDefaultAggregationName();this._getCardContainer().addAggregation(d,o)})},_handleEditCards:function e(t){let n=t.getSource().getParent()||this;if(n instanceof te){n=n.getParent()}n?._getLayout().openSettingsDialog(T.INSIGHTS_CARDS)},handleHideHeader:function e(){this._headerVisible=false;this.setProperty("title","");this._toggleHeaderActions(false)},handleAddHeader:function e(){this._headerVisible=true;this.setProperty("title",`${this._i18nBundle?.getText("insightsCards")} (${this._controlModel.getProperty("/userVisibleCards")?.length})`);this._toggleHeaderActions(true)},refreshCards:function e(){this.aVisibleCardInstances.forEach(e=>this._refreshCardData(e))},_handleCardsDnd:function t(n){try{const t=this;const r=n.getParameter("dropPosition"),s=n.getParameter("draggedControl"),i=s.getParent()?.indexOfItem(s),a=n.getParameter("droppedControl"),o=s.getParent().indexOfItem(a);t._cardsFlexWrapper?.setBusy(true);const c=D(function(){return E(function(){function e(){setTimeout(()=>{W(t._getCardContainer(),o)},0)}const n=function(){if(!t._controlModel.getProperty("/userAllCards").length){return Promise.resolve(t.cardHelperInstance._getUserAllCardModel()).then(function(e){t._controlModel.setProperty("/userAllCards",e.getProperty("/cards"));return Promise.resolve(t.updateCardList(r,o,i)).then(function(){})})}else{return Promise.resolve(t.updateCardList(r,o,i)).then(function(){})}}();return n&&n.then?n.then(e):e(n)},function(t){if(t instanceof Error){e.error(t.message)}})},function(e,n){t._cardsFlexWrapper?.setBusy(false);if(e)throw n;return n});return Promise.resolve(c&&c.then?c.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},updateCardList:function e(t,n,r){try{const e=this;const s=e._controlModel.getProperty("/userVisibleCards"),i=e._controlModel.getProperty("/userAllCards"),a=s[r]?.rank,o=s[n]?.rank;let c=i.findIndex(e=>e.rank===a),d=i.findIndex(e=>e.rank===o);if(t==="Before"&&r===n-1||t==="After"&&r===n+1||r===n){return Promise.resolve()}if(t==="Before"&&c<d){d--}else if(t==="After"&&c>d){d++}const h=function(){if(c!==d){const t=e.cardHelperInstance.handleDndCardsRanking(c,d,i);return Promise.resolve(e.cardHelperInstance._updateMultipleCards(t,"PUT")).then(function(){e._sortCardsOnRank(i);e._controlModel.setProperty("/userAllCards",i);e._controlModel.setProperty("/userVisibleCards",i.filter(e=>e.visibility));return Promise.resolve(e.rerenderCards()).then(function(){})})}}();return Promise.resolve(h&&h.then?h.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},_sortCardsOnRank:function e(t){t.sort((e,t)=>{if(e.rank&&t.rank){if(e.rank<t.rank){return-1}else if(e.rank>t.rank){return 1}}return 0})},_getPersonalization:function e(){const t=z.getPersContainerId(this);const n=z.getOwnerComponent(this);return G.getInstance(t,n)},_updateRecommendationStatus:function e(){try{const e=this;return Promise.resolve(e._getPersonalizationData()).then(function(t){t[Z]=true;return e.oPersonalizer.write(t)})}catch(e){return Promise.reject(e)}},_calculateVisibleCardCount:function e(){const t=this._getInsightsContainer()._getLayout();const n=t.getDomRef();const r=this.getDeviceType();let s=1;if(n){const e=t.getProperty("showHeader");const i=e?1:0;const a=n.childNodes[i];const o=j(a,["width","padding-left","padding-right"]);const c=o.width-o["padding-left"]-o["padding-right"];const d=this.aVisibleCardInstances.length;const h={containerWidth:c,totalCards:d,minWidth:304,maxWidth:583,gap:16};const l=N(h);this.cardWidth=`${l/16}rem`;if(r===B.Mobile){s=d}else{s=Math.max(Math.floor(c/l),1)}}return s},_adjustLayout:function e(){const t=this._getInsightsContainer()?._getLayout();let n=this.cardWidth;const r=this.getDeviceType()===B.Mobile;if(t&&this.aVisibleCardInstances?.length>0){const e=t._getCurrentExpandedElementName()===this.getProperty("fullScreenName");let n=this._calculateVisibleCardCount();if(e){n=this.aVisibleCardInstances.length}this._controlModel.setProperty("/isPhone",r);if(n!==this.cardsInViewport.length){this.cardsInViewport=this.aVisibleCardInstances.slice(0,n);const e=this._getCardContainer().getMetadata().getDefaultAggregationName();this._getCardContainer().removeAllAggregation(e);this.cardsInViewport.forEach(e=>{const t=e.getManifest();const n=t["sap.card"]?.type;let r;if(n==="Table"||n==="List"){const e=new a({width:this.cardWidth,height:"2rem"}).addStyleClass("insightsCardOverflowLayer insightsCardOverflowTop");r=new a({height:"0"}).addStyleClass("sapMFlexBoxJustifyCenter");r.addItem(e)}const s=new c({direction:"Column",justifyContent:"Center",items:[e]});if(r){s.addItem(r)}const i=this._getCardContainer().getMetadata().getDefaultAggregationName();this._getCardContainer().addAggregation(i,s)});this.shareCardsInViewport()}const s=e||this.aVisibleCardInstances.length>n;if(this._headerVisible){this._getInsightsContainer()?.toggleFullScreenElements(this,s)}else{const e=k(this);const t=e?.getTitle();this._getInsightsContainer()?.updateMenuItem(this._controlMap.get(`${this.getId()}-${K.SHOW_MORE}`),s,t);this._getInsightsContainer()?.updateActionButton(this._controlMap.get(`${this.getId()}-${Q.SHOW_MORE}`),s,t)}}else{this.cardWidth=this.getDeviceType()===B.Mobile?"19rem":"22rem"}if(n!==this.cardWidth){this.aVisibleCardInstances.forEach(e=>e.setWidth(this.cardWidth));this.cardsContainerSettings?.setColumnSize(this.cardWidth)}},getContainerMenuItems:function e(){if(!this._containerMenuItems){const e=this._createRefreshMenuItem(K.REFRESH,"containerCardsRefresh");const t=this._createEditCardsMenuItem(K.EDIT_CARDS,"containerManageCards");const n=L(this,K.SHOW_MORE,"containerCardsShowMore");this._controlMap.set(`${this.getId()}-${K.SHOW_MORE}`,n);this._containerMenuItems=[e,t,n]}return this._containerMenuItems},getContainerActionButtons:function e(){if(!this._containerActionButtons){this._containerActionButtons=[];const e=F(this,Q.SHOW_MORE,"containerCardsShowMore");if(e){this._controlMap.set(`${this.getId()}-${Q.SHOW_MORE}`,e);this._containerActionButtons.push(e)}}return this._containerActionButtons},_getInsightsContainer:function e(){if(!this.insightsContainer){this.insightsContainer=this.getParent()}return this.insightsContainer},_createRefreshMenuItem:function e(t,n){const r=new R(`${this.getId()}-${t}`,{title:this._i18nBundle.getText("refresh"),icon:"sap-icon://refresh",visible:false,press:()=>this.refreshCards()});this._controlMap.set(`${this.getId()}-${t}`,r);if(n){$(r,n)}return r},_createEditCardsMenuItem:function e(t,n){const r=new R(`${this.getId()}-${t}`,{title:this._i18nBundle.getText("manageCards"),icon:"sap-icon://edit",visible:false,press:e=>this._handleEditCards(e)});this._controlMap.set(`${this.getId()}-${t}`,r);if(n){$(r,n)}return r},_toggleHeaderActions:function e(t){this.getAggregation("menuItems")?.forEach(e=>{this._getInsightsContainer()?.toggleMenuListItem(e,t)});this.getAggregation("actionButtons")?.forEach(e=>this._getInsightsContainer()?.toggleActionButton(e,t))},_getCardContainer:function e(){if(this.getDeviceType()===B.Mobile){return this.cardsMobileContainer}return this.cardsContainer},_sortMenuItems:function e(t){const n=this.getAggregation("menuItems");let r=U(t,n);this.removeAllAggregation("menuItems");r?.forEach(e=>this.addAggregation("menuItems",e))},shareCardsInViewport:function e(){const t=this._calculateVisibleCardCount();const n=this._controlModel.getProperty("/userVisibleCards");const r=n?.slice(0,t);if(r?.length){this.fireEvent("visibleCardsUpdated",{cards:r})}},exit:function e(){ee=false;this.getAggregation("host")?.destroy()}});te.cardsMenuItems=q;te.cardsContainerMenuItems=K;te.cardsContainerActionButtons=Q;return te});
//# sourceMappingURL=CardsPanel.js.map