/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/m/Button","sap/m/CustomListItem","sap/m/ExpandableText","sap/m/FlexBox","sap/m/GenericTile","sap/m/HBox","sap/m/Label","sap/m/library","sap/m/MessageToast","sap/m/Text","sap/m/VBox","sap/ui/core/Fragment","sap/ui/core/library","sap/ui/model/ChangeReason","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/model/Sorter","sap/ushell/Container","./AppsContainer","./BaseSettingsPanel","./FavAppPanel","./InsightsContainer","./utils/AppManager","./utils/Constants","./utils/DataFormatUtils","./utils/FeatureUtils","./utils/FESRUtil"],function(e,t,n,r,s,i,o,a,u,c,l,p,d,h,g,f,m,P,y,S,A,v,_,T,x,C,I,b){"use strict";function B(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}function w(e,t){try{var n=e()}catch(e){return t(e)}if(n&&n.then){return n.then(void 0,t)}return n}const D=u["ButtonType"];function E(e,t){try{var n=e()}catch(e){return t(true,e)}if(n&&n.then){return n.then(t.bind(null,false),t.bind(null,true))}return t(false,n)}const F=u["URLHelper"];const L=typeof Symbol!=="undefined"?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function R(e,t,n){if(!e.s){if(n instanceof N){if(n.s){if(t&1){t=n.s}n=n.v}else{n.o=R.bind(null,e,t);return}}if(n&&n.then){n.then(R.bind(null,e,t),R.bind(null,e,2));return}e.s=t;e.v=n;const r=e.o;if(r){r(e)}}}const N=function(){function e(){}e.prototype.then=function(t,n){const r=new e;const s=this.s;if(s){const e=s&1?t:n;if(e){try{R(r,1,e(this.v))}catch(e){R(r,2,e)}return r}else{return this}}this.o=function(e){try{const s=e.v;if(e.s&1){R(r,1,t?t(s):s)}else if(n){R(r,1,n(s))}else{R(r,2,s)}}catch(e){R(r,2,e)}};return r};return e}();function M(e){return e instanceof N&&e.s&1}function k(e,t,n){var r=-1,s,i;function o(a){try{while(++r<e.length&&(!n||!n())){a=t(r);if(a&&a.then){if(M(a)){a=a.v}else{a.then(o,i||(i=R.bind(null,s=new N,2)));return}}}if(s){R(s,1,a)}else{s=a}}catch(e){R(s||(s=new N),2,e)}}o();return s}const V=h["ValueState"];function z(e,t,n){if(typeof e[L]==="function"){var r=e[L](),s,i,o;function l(e){try{while(!(s=r.next()).done&&(!n||!n())){e=t(s.value);if(e&&e.then){if(M(e)){e=e.v}else{e.then(l,o||(o=R.bind(null,i=new N,2)));return}}}if(i){R(i,1,e)}else{i=e}}catch(e){R(i||(i=new N),2,e)}}l();if(r.return){var a=function(e){try{if(!s.done){r.return()}}catch(e){}return e};if(i&&i.then){return i.then(a,function(e){throw a(e)})}a()}return i}if(!("length"in e)){throw new TypeError("Object is not iterable")}var u=[];for(var c=0;c<e.length;c++){u.push(e[c])}return k(u,function(e){return t(u[e])},n)}const U=B(S);const $=B(A);const j=B(v);const O=B(_);const Q=B(T);const G=x["AI_APP_FINDER_API"];const H=x["AI_APP_FINDER_BASE_URL"];const q=x["CONTENT_ADDITION_PANEL_TYPES"];const J=x["DEFAULT_APP_ICON"];const X=x["FEATURE_TOGGLES"];const W=x["FESR_IDS"];const Y=x["MYINSIGHT_SECTION_ID"];const K=C["recycleId"];const Z=I["isNavigationSupportedForFeature"];const ee=b["addFESRSemanticStepName"];const te=b["FESR_EVENTS"];const ne={DeprecatedInfoText:"deprecated",MinQueryLength:2,MaxDescriptionLength:500};var re=function(e){e["Idle"]="idle";e["Searching"]="searching";e["Complete"]="complete";return e}(re||{});var se=function(e){e["NoResultsFound"]="noResultsFound";e["ServiceError"]="serviceError";return e}(se||{});var ie=function(e){e["Static"]="STATIC";return e}(ie||{});const oe=$.extend("sap.cux.home.AppsAdditionPanel",{constructor:function e(){$.prototype.constructor.apply(this,arguments);this.appManagerInstance=Q.getInstance();this.resetSearch=()=>{this.userSelectedApps.clear();this.model.setProperty("/hasError",false);this.model.setProperty("/suggestedApps",[]);this.model.setProperty("/suggestedAppsCount",0);this.model.setProperty("/searchStatus",re.Searching);this.model.setProperty("/userSelectedApps",[]);this.appSuggestionList.removeSelections(true);this.resetFeedback()}},init:function e(){$.prototype.init.call(this);this.userSelectedApps=new Set;this.setProperty("key",q.AI_APP_FINDER);this.setProperty("title",this._i18nBundle.getText("addAppsAndTile"));this._setupActions();void this._setupContent();this.attachEvent("onDialogClose",()=>{if(!this._isDialogPersisted(this.getParent())){this.resetPanel()}})},_setupActions:function e(){this.addAppsButton=new t(K(`${this.getId()}-add-app-btn`),{text:this._i18nBundle.getText("addFromInsightsDialogBtn"),type:D.Emphasized,press:()=>{void this.onPressAddApps()}});this.addAppsButton.bindProperty("enabled",{parts:["/hasError","/searchStatus","/userSelectedApps"],formatter:(e,t,n)=>!e&&t===re.Complete&&n.length>0});ee(this.addAppsButton,te.PRESS,W.ADD_AI_APP);this.addActionButton(this.addAppsButton)},_setupContent:function e(){try{const e=this;return Promise.resolve(y.getServiceAsync("VisualizationInstantiation")).then(function(t){e.vizInstantiationService=t;return Promise.resolve(d.load({id:`${e.getId()}-content`,name:"sap.cux.home.utils.fragment.appsAdditionContent",controller:e})).then(function(t){const n=t;e.addAggregation("content",n);e.model=new f({query:"",hasError:false,errorType:se.NoResultsFound,errorDescription:"",searchStatus:re.Idle,loadingAnimations:e._generateSearchingAnimations(),suggestedAppsCount:0,userSelectedApps:[],suggestedApps:[],aiPolicyText:e._generateAIPolicyText(),invalidQuery:true,feedback:{thumbsUp:false,thumbsDown:false},sampleQueries:[{index:1,query:e._i18nBundle.getText("sampleQuery_1")},{index:2,query:e._i18nBundle.getText("sampleQuery_2")},{index:3,query:e._i18nBundle.getText("sampleQuery_3")}]});n.setModel(e.model);n.setModel(new m({bundleName:"sap.cux.home.i18n.messagebundle"}),"i18n");e.addAppsButton.setModel(e.model);e.appSuggestionList=d.byId(`${e.getId()}-content`,"appsList");e.appSuggestionList.bindAggregation("items",{path:"/suggestedApps",factory:e._generateListItem.bind(e),sorter:new P({path:"status",comparator:(t,n)=>{const r=t=>{if(t.length===0)return 0;const n=t.includes(e._i18nBundle.getText("alreadyAddedApp"));const r=t.includes(e._i18nBundle.getText("deprecatedApp"));if(n&&r)return 3;if(n)return 1;if(r)return 2;return 4};const s=r(t);const i=r(n);return s-i}})});e.appSuggestionList.attachUpdateFinished(()=>{if(e.model.getProperty("/suggestedAppsCount")>0&&e.model.getProperty("/searchStatus")===re.Complete){e.appSuggestionList.getItems()?.[0]?.focus()}});const r=d.byId(`${e.getId()}-content`,"searchTextArea");r.onsapenter=e.onPressGo.bind(e)})})}catch(e){return Promise.reject(e)}},_generateListItem:function e(t,r){const i=new n(t,{selected:r.getProperty("addedToHomePage"),content:[new s(K(`${t}-result-container`),{renderType:"Bare",direction:r.getProperty("isStaticApp")?"Column":"Row",alignItems:r.getProperty("isStaticApp")?"Start":"Center",items:[this._getAppPreviewContainer(t,r),this._getAppDetailsContainer(t,r)]}).addStyleClass("sapUiSmallMargin")]});i.getMultiSelectControl(true).setEnabled(!r.getProperty("addedToHomePage"));return i},_getAppPreviewContainer:function e(t,n){const r=new o(K(`${t}-suggestedAppContainer`),{renderType:"Bare"});if(n.getProperty("isStaticApp")){r.addItem(new i(K(`${t}-staticApp`),{mode:"IconMode",frameType:"TwoByHalf",width:"19rem",header:n.getProperty("title"),subheader:n.getProperty("subTitle"),tileIcon:n.getProperty("icon")||J,visible:n.getProperty("isStaticApp"),url:n.getProperty("url"),press:e=>{this._persistDialog(this.getParent());F.redirect(e.getSource()?.getUrl(),false)}}).addStyleClass("suggestedTile"))}else{const e=n.getProperty("vizData");const t=this.vizInstantiationService.instantiateVisualization(e);t?.setActive(true);t?.attachPress(()=>this._persistDialog(this.getParent()));r.addItem(t)}return r},_getAppDetailsContainer:function e(t,n){return new p(K(`${t}-app-details-container`),{renderType:"Bare",gap:"0.5rem",items:[new r(K(`${t}-description`),{text:n.getProperty("description"),maxCharacters:ne.MaxDescriptionLength}),new o(K(`${t}-app-status-container`),{renderType:"Bare",visible:n.getProperty("status").length>0,items:[new a(K(`${t}-appStatusLabel`),{text:this._i18nBundle.getText("appStatus"),showColon:true}),new o(K(`${t}-app-status-texts`),{renderType:"Bare",items:this._generateStatusTexts(t,n.getProperty("status"))}).addStyleClass("sapUiTinyMarginBegin statusTextsContainer")]})]}).addStyleClass(n.getProperty("isStaticApp")?"sapUiSmallMarginTop":"sapUiSmallMarginBegin")},isSupported:function e(){try{const t=this;function n(){if(!t.isPanelSupported){t.removeActionButton(t.addAppsButton);const e=t.getParent();e.removePanel(t);e.updateActionButtons()}return t.isPanelSupported}const r={target:{semanticObject:"IntelligentPrompt",action:"propose"}};const s=function(){if(t.isPanelSupported===undefined){t.isPanelSupported=false;const e=function(){if(t.getFavAppPanel()){return Promise.resolve(Z(X.AI_SMART_APPFINDER,r)).then(function(e){t.isPanelSupported=e})}}();if(e&&e.then)return e.then(function(){})}}();return Promise.resolve(s&&s.then?s.then(n):n(s))}catch(i){return Promise.reject(i)}},_generateSearchingAnimations:function e(){const t=`<defs>\n\t\t\t<linearGradient id="loadingShimmer" x1="0" y1="0" x2="1" y2="0">\n\t\t\t\t<stop offset="0%" stop-color="var(--sapContent_Placeholderloading_Background)" />\n\t\t\t\t<stop offset="20%" stop-color="var(--sapContent_Placeholderloading_Background)" />\n\t\t\t\t<stop offset="50%" stop-color="var(--sapContent_Placeholderloading_Background_Dark)" />\n\t\t\t\t<stop offset="80%" stop-color="var(--sapContent_Placeholderloading_Background)" />\n\t\t\t\t<stop offset="100%" stop-color="var(--sapContent_Placeholderloading_Background)" />\n\n\t\t\t\t<animate\n\t\t\t\t\tattributeName="x1"\n\t\t\t\t\tvalues="-0.6;0.6"\n\t\t\t\t\tdur="2.5s"\n\t\t\t\t\trepeatCount="indefinite" />\n\t\t\t\t<animate\n\t\t\t\t\tattributeName="x2"\n\t\t\t\t\tvalues="0.4;1.6"\n\t\t\t\t\tdur="2.5s"\n\t\t\t\t\trepeatCount="indefinite" />\n\t\t\t</linearGradient>\n\t\t</defs>`;return[`<svg height="167" fill="none">\n\t\t\t\t${t}\n\t\t\t\t<rect x="16" y="75" width="16" height="16" rx="4" fill="var(--sapContent_Placeholderloading_Background)"/>\n\t\t\t\t<rect x="48" y="16" width="37%" height="70" rx="16" fill="url(#loadingShimmer)"/>\n\t\t\t\t<rect x="48" y="102" width="93%" height="48" rx="4" fill="url(#loadingShimmer)"/>\n\t\t\t</svg>`,`<svg height="180" fill="none">\n\t\t\t\t${t}\n\t\t\t\t<rect x="16" y="82" width="16" height="16" rx="4" fill="var(--sapContent_Placeholderloading_Background)"/>\n\t\t\t\t<rect x="48" y="16" width="148" height="148" rx="16" fill="url(#loadingShimmer)"/>\n\t\t\t\t<rect x="212" y="54" width="75%" height="48" rx="4" fill="url(#loadingShimmer)"/>\n\t\t\t\t<rect x="212" y="110" width="13%" height="16" rx="4" fill="url(#loadingShimmer)"/>\n\t\t\t</svg>`]},resetPanel:function e(){const t={query:"",hasError:false,searchStatus:re.Idle,suggestedAppsCount:0,userSelectedApps:[],suggestedApps:[],feedback:{thumbsUp:false,thumbsDown:false},invalidQuery:true};this.model?.setData({...this.model.getData(),...t});this.userSelectedApps?.clear()},onPressGo:function t(){try{const t=this;const n=t.model.getProperty("/query");if(!t.isValidQuery(n))return Promise.resolve();const r=E(function(){return w(function(){t.resetSearch();return Promise.resolve(t.fetchAppsFromSearch(n)).then(function(e){const n=function(){if(t.model.getProperty("/searchStatus")===re.Searching){return Promise.resolve(t.fetchAllAvailableVisualizations()).then(function(n){return Promise.resolve(t.appManagerInstance.fetchFavVizs(true,true)).then(function(r){return Promise.resolve(t.appManagerInstance.fetchInsightApps(true,t._i18nBundle.getText("insights"))).then(function(s){const i=t._generateApps(e,n,[...r,...s]);return Promise.resolve(t._filterUnsupportedApps(i)).then(function(e){if(e.length===0&&!t.model.getProperty("/hasError")){t._handleError("",e.length)}else{t.model.setProperty("/suggestedApps",e);t.model.setProperty("/suggestedAppsCount",e.length);t.appSuggestionList.updateAggregation("items",g.Refresh,{detailedReason:g.Refresh})}})})})})}}();if(n&&n.then)return n.then(function(){})})},function(n){e.error(n.message);t._handleError()})},function(e,n){if(t.model.getProperty("/searchStatus")===re.Searching){t.model.setProperty("/searchStatus",re.Complete)}if(e)throw n;return n});return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},_filterUnsupportedApps:function e(t){try{const e=t.filter(e=>e.isStaticApp?true:e.vizData??false);const n=e.map(e=>e.vizData?.target)||[];return Promise.resolve(y.getServiceAsync("Navigation")).then(function(t){return Promise.resolve(t.isNavigationSupported(n)).then(function(t){return e.filter((e,n)=>t[n])})})}catch(e){return Promise.reject(e)}},_generateApps:function e(t,n,r){return t.map(e=>{const t=n.find(t=>t.vizId===e.chipID);const s=r.some(t=>t.visualization?.vizId===e.chipID);return{title:e.title,chipID:e.chipID,subTitle:e.subTitle,description:e.appDescription,icon:e.iconUrl,vizData:t,addedToHomePage:s,isStaticApp:e.tileType===ie.Static,status:this.getAppStatusTexts(e.configuration,s),url:t?.targetURL||""}})},isValidQuery:function e(t=""){t=t?.trim();return t.length>=ne.MinQueryLength&&t.length<=ne.MaxDescriptionLength},fetchAllAvailableVisualizations:function e(){try{const t=this;function n(){return t.allAvailableVisualizations}const r=function(){if(!t.allAvailableVisualizations){return Promise.resolve(y.getServiceAsync("SearchableContent")).then(function(e){return Promise.resolve(e.getApps({enableVisualizationPreview:false})).then(function(e){t.allAvailableVisualizations=e.reduce((e,t)=>e.concat(t.visualizations),[])})})}}();return Promise.resolve(r&&r.then?r.then(n):n(r))}catch(s){return Promise.reject(s)}},_fetchCSRFToken:function t(){try{return Promise.resolve(w(function(){return Promise.resolve(fetch(H,{method:"GET",headers:{"X-CSRF-Token":"Fetch"}})).then(function(e){return e.headers.get("X-CSRF-Token")})},function(t){e.error("Failed to fetch CSRF token",t);return null}))}catch(e){return Promise.reject(e)}},fetchAppsFromSearch:function t(n){try{const t=this;return Promise.resolve(w(function(){return Promise.resolve(t._fetchCSRFToken()).then(function(e){const r={"Content-Type":"application/json",...e&&{"X-CSRF-Token":e}};return Promise.resolve(fetch(G,{method:"POST",headers:r,body:JSON.stringify({UserInput:n})})).then(function(e){let n=false;function r(t){return n?t:Promise.resolve(e.json()).then(function(e){const t=e;return t.value||[]})}const s=function(){if(!e.ok){return Promise.resolve(e.json()).then(function(e){const r=e;t._handleError(r.error?.message||"");const s=[];n=true;return s})}}();return s&&s.then?s.then(r):r(s)})})},function(n){e.error(n.message);t._handleError();return[]}))}catch(e){return Promise.reject(e)}},getAppStatusTexts:function t(n,r){let s=[];if(n){try{const e=JSON.parse(n);const t=JSON.parse(e?.tileConfiguration);const r=(t?.display_info_text||"").toLowerCase();if(r===ne.DeprecatedInfoText){s.push(this._i18nBundle.getText("deprecatedApp"))}}catch(t){e.warning(t.message)}}if(r){s.push(this._i18nBundle.getText("alreadyAddedApp"))}return s},_generateStatusTexts:function e(t,n){return n.map((e,n)=>new l(K(`${t}-statusText-${n}`),{text:e}).addStyleClass(this.applyStatusClass(e)))},applyStatusClass:function e(t){if(t===this._i18nBundle.getText("alreadyAddedApp")){return"addedAppStatusText"}else if(t===this._i18nBundle.getText("deprecatedApp")){return"deprecatedAppStatusText"}else{return""}},onPressAddApps:function e(){try{const t=this;function n(){function e(){function e(){t.getParent()?.close();if(r.length>1){c.show(t._i18nBundle.getText("contentAddedToMyhome"))}else{const e=r?.[0];const n=e?.getBindingContext?.()?.getProperty?.("title")??"";const i=s?"appAddedToFavorites":"tileAddedToInsights";c.show(t._i18nBundle.getText(i,[n]))}t.resetPanel()}const n=function(){if(i){return Promise.resolve(t.refreshInsightsApps()).then(function(){})}}();return n&&n.then?n.then(e):e(n)}const n=function(){if(s){return Promise.resolve(t.refreshFavoriteApps()).then(function(){})}}();return n&&n.then?n.then(e):e(n)}const r=t.model.getProperty("/userSelectedApps");let s=false;let i=false;const o=z(r,function(e){const n=e.getBindingContext()?.getProperty("isStaticApp");if(n)s=true;else i=true;const r=e.getBindingContext()?.getProperty("chipID");return Promise.resolve(t.appManagerInstance.addVisualization(r,n?undefined:Y)).then(function(){})});return Promise.resolve(o&&o.then?o.then(n):n(o))}catch(a){return Promise.reject(a)}},getLayout:function e(){return this.getParent()?.getParent()},getAppsContainer:function e(){return this.getLayout()?.getItems().find(e=>e instanceof U)},getFavAppPanel:function e(){return this.getAppsContainer()?.getContent().find(e=>e instanceof j)},refreshFavoriteApps:function e(){try{const e=this;return Promise.resolve(e.getAppsContainer()?.refreshPanel(e.getFavAppPanel())).then(function(){})}catch(e){return Promise.reject(e)}},getInsightsContainer:function e(){return this.getLayout()?.getItems().find(e=>e instanceof O)},refreshInsightsApps:function e(){try{const e=this;return Promise.resolve(e.getInsightsContainer()?.refreshData("tiles")).then(function(){})}catch(e){return Promise.reject(e)}},onListSelectionChange:function e(t){const n=t.getParameter("listItem");const r=t.getParameter("selected");if(!r)this.userSelectedApps.delete(n);else{const e=n.getBindingContext();const t=e?.getProperty("addedToHomePage");if(!t)this.userSelectedApps.add(n)}this.model.setProperty("/userSelectedApps",Array.from(this.userSelectedApps))},_handleError:function e(t="",n){const[,r]=t.match(/\((\d{2})\d*\)\s*(.*)/)||[];if(n===0||t.length===0){t=this._i18nBundle.getText("NoResultErrorDescription")||""}this.model.setProperty("/hasError",true);this.model.setProperty("/errorType",this._getErrorType(r));this.model.setProperty("/errorDescription",t)},_getErrorType:function e(t=""){if(t==="10"){return se.ServiceError}else{return se.NoResultsFound}},onSearchTextAreaLiveChange:function e(t){const n=t.getSource();const r=n.getValue().trim();if(r.length!==0&&r.length<ne.MinQueryLength){n.setValueState(V.Information);n.setValueStateText(this._i18nBundle.getText("minLengthRequired"))}else if(r.length>ne.MaxDescriptionLength){n.setValueState(V.Warning);n.setValueStateText(this._i18nBundle.getText("maxLengthExceeded"))}else{n.setValueState(V.None);n.setValueStateText("")}this.model.setProperty("/invalidQuery",r.length===0||n.getValueState()!==V.None)},_generateAIPolicyText:function e(){const t=this._i18nBundle.getText("createdWithAI");return this._i18nBundle.getText("aiPolicyText",[t])},resetFeedback:function e(){this.model.setProperty("/feedback",{thumbsUp:false,thumbsDown:false})},sendFeedback:function e(t){this.resetFeedback();this.model.setProperty(`/feedback/${t}`,true);c.show(this._i18nBundle.getText("feedBackSent"),{width:"20em"})}});return oe});
//# sourceMappingURL=AppsAdditionPanel.js.map