/*
* ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
*/
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/util/isEmptyObject","../utils/LanguageBundle","sap/ui/Device","sap/ui/core/Control","sap/ui/core/library","sap/ui/core/mvc/View","sap/ui/dom/includeStylesheet","sap/ui/model/json/JSONModel","sap/m/App","sap/m/Bar","sap/m/Button","sap/m/FeedListItem","sap/m/Label","sap/m/library","sap/m/Link","sap/m/List","sap/m/Page","sap/m/ResponsivePopover"],function(jQuery,e,t,o,s,i,r,a,l,p,n,h,_,y,u,c,R,d,f){"use strict";var T=i.mvc.ViewType;var g=u.ListSeparators;var P=u.PlacementType;a(sap.ui.require.toUrl("sap/collaboration/components/resources/css/SocialProfile.css"));a(sap.ui.require.toUrl("sap/collaboration/components/resources/css/ReplyPopover.css"));var v=s.extend("sap.collaboration.components.controls.ReplyPopover",{metadata:{library:"sap.collaboration",events:{postReplyPress:{parameters:{value:{type:"string"}}},moreRepliesPress:{},afterClose:{}},aggregations:{socialTextArea:{type:"sap.collaboration.components.controls.SocialTextArea",multiple:false}}},renderer:null});v.prototype.init=function(){this._oLangBundle=new t;this._oJSONModelData=[];this._oJSONModel=new l(this._oJSONModelData);this._oControlToReceiveFocus;this._oSocialProfileView;this._oReplyApp;this._oReplyPage;this._oReplyTextArea;this._oReplyList;this._oReplyButton;this._oReplyHeaderBar;this._pReplyPopover=this._createReplyPopover();this._pReplyPopover.then(e=>{this._oReplyPopover=e})};v.prototype.fullyCreated=function(){return this._pReplyPopover};v.prototype.exit=function(){if(this._oReplyPopover){this._oReplyPopover.destroy()}else if(this._pReplyPopover){this._pReplyPopover.then(()=>{this._oReplyPopover.destroy()})}};v.prototype.addReply=function(t){if(!e(t)){if(t.Text){t.Text=this._replaceCarriageReturnWithBRTag(t.Text)}this._oJSONModelData.push(t);this._oJSONModel.setData(this._oJSONModelData,true)}else{this._oReplyTextArea.focus()}};v.prototype.addReplies=function(e){var t=e&&e.data;if(t&&t.length!==0){var o=this._oReplyList.getItems().length;var s=t.length;for(var i=0;i<t.length;i++){if(t[i].Text){t[i].Text=this._replaceCarriageReturnWithBRTag(t[i].Text);t[i].Text="‎"+t[i].Text+"‎"}}this._oJSONModelData=t.concat(this._oJSONModelData);this._oJSONModel.setData(this._oJSONModelData,true);if(o!==0){this._oControlToReceiveFocus=this._oReplyList.getItems()[s]}if(e.more){this._oShowMoreBar.setVisible(true)}else{this._oShowMoreBar.setVisible(false)}}};v.prototype.openBy=function(e){if(!this._oReplyTextArea){this._oReplyTextArea=this.getSocialTextArea();this._oReplyTextArea.addStyleClass("replyTextAreaToBottom").addStyleClass("replyTextArea");this._oControlToReceiveFocus=this._oReplyTextArea;this._oReplyPage.addContent(this._oShowMoreBar).addContent(this._addList()).addContent(this._oReplyTextArea);this._oReplyPopover.setInitialFocus(this._oReplyTextArea)}this._oReplyPopover.openBy(e);return this};v.prototype.setBusyIndicatorDelay=function(e){this._oReplyPage.setBusyIndicatorDelay(e);return this};v.prototype.setBusy=function(e){this._oReplyPage.setBusy(e);return this};v.prototype.getTextArea=function(){return this._oReplyTextArea};v.prototype._createReplyPopover=async function(){var e=new f({showHeader:false,placement:P.Vertical,contentWidth:"25rem",contentHeight:"455px",content:await this._addApp(),afterClose:[function(){this._oReplyApp.backToTop();this._oReplyList.destroyItems();this._oJSONModelData=[];this._oJSONModel.setData(this._oJSONModelData);this._oShowMoreBar.setVisible(false);this._oControlToReceiveFocus=this._oReplyTextArea;this.fireAfterClose()},this]});return e};v.prototype._addList=function(){var e=this;var t=new _({text:"{Text}",icon:"{Creator/ThumbnailImage}",sender:"{Creator/FullName}",timestamp:"{CreatedAt}",iconActive:false,senderPress:function(t){var o=t.getSource().getBindingContext().getObject();var s=o.Creator.Email;e._oSocialProfileView.getViewData().memberId=s;e._oSocialProfileView.rerender();e._oReplyApp.to(e._oSocialProfilePage)}}).addStyleClass("replyFeedListItem");if(!this._oReplyList){this._oReplyList=new R({width:"100%",items:[],noDataText:this._oLangBundle.getText("ST_REPLY_LIST_AREA"),showNoData:true,showSeparators:g.None,updateFinished:function(t){var o=e._oReplyList.getItems().length;if(o!==0&&e._oControlToReceiveFocus===e._oReplyTextArea){e._oReplyList.getItems()[o-1].focus()}if(e._oReplyList.getItems().length===0){e._oReplyTextArea.addStyleClass("replyTextAreaToBottom");e._oReplyTextArea._oPop.setOffsetX(0)}else{var s=jQuery(e._oReplyList.getDomRef()).height();var i=jQuery(e._oReplyPopover.getDomRef("cont")).height();var r=jQuery(e._oReplyPage.getCustomHeader().getDomRef()).height();var a=parseInt(e._oReplyTextArea.getHeight());var l=jQuery(e._oReplyPage.getFooter().getDomRef()).height();if(s>i-r-a-l){e._oReplyTextArea.removeStyleClass("replyTextAreaToBottom");e._oReplyTextArea._oPop.setOffsetX(9)}else{e._oReplyTextArea.addStyleClass("replyTextAreaToBottom");e._oReplyTextArea._oPop.setOffsetX(0)}}e._oControlToReceiveFocus.focus()}})}this._oReplyList.setModel(this._oJSONModel);this._oReplyList.bindItems({path:"/",template:t});return this._oReplyList};v.prototype.enableButton=function(e){this._oReplyButton.setEnabled(e)};v.prototype._addApp=async function(){var e=this;if(this._oReplyApp){return this._oReplyApp}this._oReplyButton=new h({text:this._oLangBundle.getText("ST_REPLY_POST"),enabled:false,press:this._postReply.bind(e)});this._oShowMoreLink=new c({text:this._oLangBundle.getText("ST_SHOW_MORE_REPLIES"),press:this._showMoreReplies.bind(e)});this._oShowMoreBar=new n({contentMiddle:[this._oShowMoreLink],visible:false}).addStyleClass("showMoreReplies");this._oReplyPage=new d({showHeader:true,showSubHeader:false,showFooter:true,customHeader:new n({contentMiddle:[new y({text:this._oLangBundle.getText("ST_REPLY_TITLE")})]}),footer:new n({contentRight:[this._createMentionButton(),this._oReplyButton]})});this._oSocialProfileButton=new h({text:this._oLangBundle.getText("SP_OPEN_JAM_BUTTON"),press:function(){window.open(e._sUserProfileURL,"_blank")}});this._oSocialProfileView=await r.create({viewData:{langBundle:this._oLangBundle,popoverPrefix:this.getId(),afterUserInfoRetrieved:function(e){if(e){this._sUserProfileURL=e.WebURL}}},viewName:"module:sap/collaboration/components/socialprofile/SocialProfileView"});this._oSocialProfilePage=new d({title:this._oLangBundle.getText("SP_TITLE"),showNavButton:true,showHeader:true,showSubHeader:false,showFooter:true,navButtonPress:function(t){e._oReplyApp.back()},footer:new n({contentRight:[this._oSocialProfileButton]}),content:[this._oSocialProfileView]});this._oReplyApp=new p({backgroundColor:"#ffffff",pages:[this._oReplyPage,this._oSocialProfilePage]});return this._oReplyApp};v.prototype._createMentionButton=function(){if(o.system.phone){return}var e=new h({text:"@",tooltip:this._oLangBundle.getText("ST_MENTION_TOOLTIP"),press:[function(){this._oReplyTextArea.atMentionsButtonPressed()},this]});return e};v.prototype._replaceCarriageReturnWithBRTag=function(e){var t;if(typeof e==="string"){t=e.replace(/[\n\r]/g,"<br>")}return t};v.prototype._postReply=function(){var e=this._oReplyTextArea.convertTextWithFullNamesToEmailAliases();this.firePostReplyPress({value:e});this._oControlToReceiveFocus=this._oReplyTextArea};v.prototype._showMoreReplies=function(){this.fireMoreRepliesPress()};return v});
//# sourceMappingURL=ReplyPopover.js.map