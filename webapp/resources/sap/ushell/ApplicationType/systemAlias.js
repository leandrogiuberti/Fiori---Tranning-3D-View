// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/URI","sap/ushell/utils","sap/base/util/isPlainObject","sap/base/Log","sap/ushell/Container"],(e,t,n,r,s)=>{"use strict";const i="";const o={apply:"apply",applied:"applied"};function a(e){return(e.protocol()||"").length>0}async function l(e,n,r){const s=typeof n==="string";const i=[e];if(s){i.unshift(n)}const o=t.generateLocalStorageKey("sap-system-data",i);const a=t.getLocalStorage();const l=a.getItem(o);let p={};if(l){try{p=JSON.parse(l)}catch(e){throw new Error(`Cannot parse system data from local storage at key '${o}'. Data: ${l}`)}return p}else if(s){throw new Error(`Cannot find data for system '${e}' in local storage using key '${o}'`)}if(!r){throw new Error("fallback: the adapter does not implement resolveSystemAlias")}return new Promise((t,n)=>{r(e).done(e=>{t(e)}).fail(e=>{n(e)})})}function p(e){r.error(`Invalid system alias definition: ${e.debug}`,`ERRORS:${e.errors.map(e=>`\n - ${e}`).join("")}`,"sap.ushell.ApplicationType")}function c(e){function t(e){const t=[];if(typeof e.host!=="string"){t.push("host field must be a string")}if(typeof e.port!=="number"&&typeof e.port!=="string"){t.push("port field must be a number or a string")}if(typeof e.pathPrefix!=="string"){t.push("pathPrefix field must be a string")}return t}const n=[];const r=e.hasOwnProperty("https");const s=e.hasOwnProperty("http");if(!s&&!r){n.push("at least one of 'http' or 'https' fields must be defined")}if(r){t(e.https).forEach(e=>{n.push(`https>${e}`)})}if(s){t(e.http).forEach(e=>{n.push(`http>${e}`)})}if(n.length>0){return{isValid:false,errors:n,debug:JSON.stringify(e,null,3)}}return{isValid:true}}function f(e,t){if(e.hasOwnProperty("https")){return"https"}if(e.hasOwnProperty("http")){return"http"}r.error("Cannot select which system alias to pick between http/https","make sure they are provided in the given system alias collection","sap.ushell.services.ClientSideTargetResolution");return undefined}function u(t,n,r,s){let i;const o=new Promise(o=>{if(n==="URL"&&r.length===0){o(t);return}o(l("",undefined,s).then(s=>{const o=f(s,new e(window.location.toString()).protocol());const a=s[o].pathPrefix;const l=r===a;if(r.length>0&&!l){if((n==="WDA"||n==="WEBGUI")&&t.path().indexOf("~canvas")>=0){i=t.path();i=`/~canvas${i.split("~canvas")[1]}`;t.path(i)}}function p(e){const n=e+t.path();t.path(n.replace(/\/+/g,"/"));return t}if(r.length===0){if(n==="WCF"&&a==="/sap/bc/"){return p("/sap(====)/bc/")}return p(a)}return p(r)}))});return o}function h(e,t){let n;let s;let i;let o;const a=!!e.loginGroup;if(a){i=[e.systemId&&`~sysid=${e.systemId}`,e.loginGroup&&`~loginGroup=${e.loginGroup}`,e.sncNameR3&&`~messageServer=${encodeURIComponent(e.sncNameR3)}`,e.sncNameR3&&`~sncNameR3=${encodeURIComponent(e.sncNameR3)}`,e.sncQoPR3&&`~sncQoPR3=${e.sncQoPR3}`].filter(e=>typeof e==="string"&&e!=="")}else{o=e.host||"";s=o.toLowerCase()===t.toLowerCase();n=/^[/][HGMR][/].*/.test(o);if(o.length>0&&!s&&!n){r.error("Invalid connect string provided in 'host' field of system alias",`Data for rfc destination provided are: ${JSON.stringify(e,null,3)}`,"sap.ushell.services.ClientSideTargetResolution")}i=[o&&!n&&!s&&`~rfcHostName=${o}`,n&&`~connectString=${encodeURIComponent(o)}`,e.service&&`~service=${e.service}`,e.sncNameR3&&`~sncNameR3=${encodeURIComponent(e.sncNameR3)}`,e.sncQoPR3&&`~sncQoPR3=${e.sncQoPR3}`].filter(e=>typeof e==="string"&&e!=="")}return i.join(";").replace(/(%[A-F0-9]{2})/g,e=>e.toLowerCase())}function d(t,n,o,a,d){const g=o;const m=new Promise((m,y)=>{l(t,n,d).then(n=>{const l=c(n);if(!l.isValid){p(l);throw new Error("Invalid system alias definition")}let y=f(n,new e(window.location.toString()).protocol());const w=n[y];let S;let P;let R;if(t===i&&w.host===""&&(w.port===0||w.port==="")){y=""}g.protocol(y);g.hostname(w.host);g.port(w.port);return u(g,a,w.pathPrefix,d).then(e=>{S=e.query();if(typeof n.client==="string"&&n.client!==""){S=`${S+(S.length>0?"&":"")}sap-client=${n.client}`}if(typeof n.language==="string"&&n.language!==""){P=n.language}else{R=s.getUser();if(!R){r.error("Cannot retieve the User object via sap.ushell.Container while determining sap-language","will default to 'en' language","sap.ushell.services.ClientSideTargetResolution");P="en"}else{P=R.getLanguage()}}S=`${S+(S.length>0?"&":"")}sap-language=${P}`;e.query(S);if(n.hasOwnProperty("rfc")&&a==="NATIVEWEBGUI"){const t=h(n.rfc,w.host);const r=`${e.path()};${t}`;e.path(r);o._parts.path=r}m(e)})}).catch(e=>{y(e)})});return m}function g(e,t){const n={};let r;t.forEach(e=>{n[e]=true});r=e.query();r=r.split("&").filter(e=>{const t=(e.split("=")[0]||"").toLowerCase();return!n.hasOwnProperty(t)}).join("&");e.query(r)}function m(t,n,r,s,o){const p=new Promise((p,c)=>{if(n===i||typeof n==="undefined"){if(a(t)){p(t);return}p(d(r,s,t,"URL",o).then(e=>e))}p(l(n,s,o).then(n=>{const i=f(n,new e(window.location.toString()).protocol());const a=n[i];let l;if((t.protocol()||"").toLowerCase()===i&&(t.hostname()||"")===a.host&&t.path().indexOf(a.pathPrefix)===0){t.protocol("");t.hostname("");l=t.path().replace(a.pathPrefix,"");t.path(l);g(t,["sap-language","sap-client"]);return d(r,s,t,"URL",o).then(e=>e)}return t}).catch(e=>{c(e)}))});return p}function y(t,r,s,i,o){t.protocol("");t.hostname("");t.port("");const a=new Promise(a=>{g(t,["sap-client","sap-language"]);if(!n(i)||typeof r!=="string"){a(t)}const p=f(i,new e(window.location.toString()).protocol());const c=i[p];const u=new Promise((e,t)=>{const n=typeof c.pathPrefix==="string"&&c.pathPrefix;if(n!==""){e(n)}else{l("",undefined,o).then(t=>{const n=t[p];e(n.pathPrefix)}).catch(e=>{t(e)})}}).then(e=>{let n;if(e&&e.length>0){n=t.path();n=n.replace(e,"");if(e==="/sap/bc/"){n=n.replace("/sap(====)/bc/","")}if(n.indexOf("/")!==0){n=`/${n}`}t.path(n)}if(s==="NATIVEWEBGUI"&&i.hasOwnProperty("rfc")){n=t.path();n=n.split(";").filter(e=>e.indexOf("~sysid=")!==0&&e.indexOf("~service=")!==0&&e.indexOf("~loginGroup=")!==0&&e.indexOf("~messageServer=")!==0&&e.indexOf("~sncNameR3=")!==0&&e.indexOf("~sncQoPR3=")!==0).join(";");t.path(n)}return t});a(u)});return a}function w(e,t,n,r,s){const i=new Promise((i,o)=>{if(typeof t==="undefined"){i(y(e,t,r,undefined,s));return}i(l(t,n,s).then(n=>y(e,t,r,n,s)))});return i}function S(e,t,n,r,s,i,a){if(i!==o.apply&&i!==o.applied){throw new Error(`Invalid system alias semantic was provided: '${i}'`)}if(i===o.applied&&(typeof n==="undefined"||t===n)){return Promise.resolve(e)}if(i===o.apply&&typeof t==="undefined"&&typeof n==="undefined"){return Promise.resolve(e)}if(s==="URL"&&i===o.applied){return m(e,t,n,r,a)}const l=new Promise((l,p)=>{if(i===o.apply){l({targetUri:e,alias:n||t,sapSystemSrc:n?r:undefined});return}w(e,t,undefined,s,a).then(e=>{l({targetUri:e,alias:n})}).catch(e=>{p(e)})}).then(e=>d(e.alias,e.sapSystemSrc,e.targetUri,s,a));return l}function P(t,n){const r=n.getCurrentAppTargetResolution()||{};if(n.getFrameworkId()==="WDA"||r?.applicationType==="WDA"){const r=n.getSystemAlias();return new e(t).removeSearch("sap-system").addSearch("sap-system",r===""?"''":r).toString()}return t}function R(e="",t=""){const n=e.split("_");let r="";let s="";while(n.length>0){r+=n.shift();if(r===t){s=n.shift()||"";while(n.length>0){s=`${s}_${n.shift()}`}return s}r+="_"}if(t===""){return e}if(e.startsWith(t)){throw new Error(`Unexpected format for fully qualified systemAlias"${e}": missing underscore delimiter while content provider id is "${t}".`)}return e}return{LOCAL_SYSTEM_ALIAS:i,SYSTEM_ALIAS_SEMANTICS:o,spliceSapSystemIntoURI:S,isAbsoluteURI:a,getSystemAliasInProvider:R,addSystemAlias:P,_stripURI:w,_selectSystemAliasDataName:f,_constructNativeWebguiParameters:h}});
//# sourceMappingURL=systemAlias.js.map