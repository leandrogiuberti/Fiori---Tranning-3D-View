// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/i18n/Localization","sap/base/util/ObjectPath","sap/ushell/utils","sap/ushell/User","sap/ushell/Config","sap/ui/thirdparty/URI","sap/ui/core/routing/History","sap/ushell/ApplicationType/utils","sap/base/util/deepClone","sap/base/util/isPlainObject","sap/ushell/Container","sap/ushell/ApplicationType/guiResolution","sap/ushell/utils/UrlParsing","sap/ushell/ApplicationType/systemAlias","sap/ushell/appIntegration/ApplicationContainerCache","sap/ushell/URLTemplateProcessor"],(e,t,a,n,r,s,i,p,o,l,u,c,d,m,f,g,h)=>{"use strict";function P(t,a){const n=t.payload;const r=a.indexOf("&/");const s=t.siteAppSection?.["sap.integration"]?.urlTemplateId==="urltemplate.jam";let i=1;let p;if(r>0){if(n?.capabilities?.appFrameworkId==="UI5"){i=2}p=a.substring(r+i);try{if(!s&&p?.length>0){p=decodeURIComponent(p)}}catch(t){e.warning("inner route should be double encoded",t,"sap.ushell.ApplicationType.getInnerAppRoute")}}return p}function A(e){let t=e.targetNavigationMode;if(t===undefined||t===""){if(n.isColdStart()){t="explace"}else{t="inplace"}}return t}function y(e){let t="";if(e.length>0&&e.indexOf("sap-iapp-state=")>0){const a=/(?:sap-iapp-state=)([^&/\\]+)/.exec(e);if(a&&a.length===2){t=a[1]}}return t}function b(e){return Promise.all([c.getServiceAsync("UserInfo"),c.getServiceAsync("PluginManager"),n.getUi5Version()]).then(a=>{const n=a[0];const i=a[1];const o=a[2];const l=n.getUser();const u=l.getContentDensity()||(document.body.classList.contains("sapUiSizeCompact")?"compact":"cozy");let c=l.getTheme();if(c.indexOf("sap_")!==0){const e=r.prototype.constants.themeFormat.THEME_NAME_PLUS_URL;c=l.getTheme(e)}const d=t.getLanguage();const m=t.getSAPLogonLanguage();const f=`${window.location.protocol}//${window.location.host}/comsapuitheming.runtime/themeroot/v1`;let g=0;if(s.last("/core/shell/sessionTimeoutIntervalInMinutes")>0){g=s.last("/core/shell/sessionTimeoutIntervalInMinutes")}let h=false;if(window["sap-ui-debug"]!==false&&window["sap-ui-debug"]!==undefined){h=window["sap-ui-debug"]}const P=s.last("/core/shell/enablePersonalization");return{language:d,logonLanguage:m,theme:c,themeServiceRoot:f,isDebugMode:h,ui5Version:o,contentDensity:u,sapPlugins:i._getNamesOfPluginsWithAgents(),innerAppState:y(e),sessionTimeout:g,historyDirection:p.getInstance().getDirection()||"",enableShellPersonalization:P}})}function S(e,t,a){if(u(t.startupParameter)&&Object.keys(t.startupParameter).length>0){t.startupParameter=l(t.startupParameter);const n={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true};Object.keys(t.startupParameter).forEach(e=>{if(n[e.toLowerCase()]){delete t.startupParameter[e]}});const r=d.getUnnecessaryWebguiParameters(t.startupParameter,a||{});d.removeObjectKey(t.startupParameter,r);const s=d.getWebguiNonBusinessParameters(t.startupParameter);d.removeObjectKey(t.startupParameter,Object.keys(s));const i=d.getExplicitSkipSelectionScreenParameter(t.startupParameter);if(e?.parameters?.names?.skipScreenChar.length>0){e.parameters.names.skipScreenChar=Object.keys(t.startupParameter).length>0&&(i===""||i==="1")?"*":""}}}function w(e,t,a){try{if(e==="urltemplate.url"&&a.hasOwnProperty("sapit-external-ui5app")){const e=l(t,20);e.urlTemplate=e.urlTemplate.replace(",paramSapLocale",",appStartupParameters,paramSapLocale");e.parameters.names={...e.parameters.names};e.parameters.names.appStartupParameters={renameTo:"sap-startup-params",value:"{*|match(^(?!sap-ushell(-innerAppRoute\\|-navmode)$))|join(&,=)}"};return e}}catch{}return t}function v(e){if(e.url&&typeof e.url==="string"){const t=e.url;const a=s.last("/core/spaces/enabled");const n=t.indexOf("ui5appruntime.html")>-1;const r=t.indexOf("ui5appruntimescube.html")>-1;if(a===true&&(n||r)){o.appParameterToUrl(e,"sap-spaces",a)}}}function T(e,t,n){const r=a.get(["sap.integration","urlTemplateId"],t);if(r==="urltemplate.url-dynamic"&&e.url.includes("sap/bc/bsp/sap/crm_ui_start/")&&!e.url.includes("sap-language=")){o.appParameterToUrl(e,"sap-language",n.env.language)}}function I(e,t,a){return new Promise((n,r)=>{const s=new i(e);const p=s.query(true);let o=true;let l=["sap-language","sap-theme","sap-shell","sap-ui-app-id","transaction","sap-iframe-hint","sap-keep-alive","sap-ui-versionedLibCss","sap-wd-configId","wcf-target-id","sap-ui-version"];if(a&&a.mandatoryUrlParams){l=l.concat(a.mandatoryUrlParams.split(","));l=l.filter((e,t)=>l.indexOf(e)===t)}if(t==="explace"){o=false}c.getServiceAsync("ShellNavigationInternal").then(t=>{t.compactParams(p,l,undefined,o).done(t=>{if(!t.hasOwnProperty("sap-intent-param")){n(e);return}let a;if(t["sap-theme"]){const e=`sap-theme=${t["sap-theme"]}`;t["sap-theme"]="sap-theme-temp-placeholder";s.query(t);a=s.toString();a=a.replace("sap-theme=sap-theme-temp-placeholder",e)}else{s.query(t);a=s.toString()}n(a)}).fail(e=>{r(e)})})})}function R(e,t){if(typeof e.enabled==="boolean"){return e.enabled}const a=h.prepareExpandData({urlTemplate:"",parameters:{names:{enabled:e.enabled}}},{},{},t.siteAppSection,"");return typeof a.oResolvedParameters.enabled==="boolean"?a.oResolvedParameters.enabled:false}function U(t,n,r){return new Promise(s=>{const p=n.urlTransformation||{enabled:false};if(R(p,r)){const n=new i(t);const o=p.transformations[0];const l=o.service.uri;const u=h.prepareExpandData({urlTemplate:"",parameters:{names:l.queryOptions}},{},{urlComponent:{query:n.query(),fragment:n.fragment()}},r.siteAppSection,"");const c=i.expand("{+rootPath}/{+resourcePath}{?queryParams*}",{rootPath:l.rootPath,resourcePath:l.resourcePath,queryParams:u.oResolvedParameters}).toString();sap.ui.require(["sap/ui/thirdparty/datajs"],r=>{r.read({requestUri:c,headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}},r=>{let i=a.get("transformAppLaunchQueryString.value",r);if(i===undefined){i=a.get("transformAppLaunchIntent.value",r)}if(i===undefined){i=a.get("transformAppLaunchQueryString.queryString",r)}e.info("URL Transformation Succeeded",JSON.stringify({URLBeforeTransformation:t,URLAfterTransformation:i}),"sap.ushell.ApplicationType");let p=o.sourceURLComponent;if(p===undefined){p="query"}if(p==="query"||p==="fragment"){t=n[p](i).toString()}else{e.error(`The ${p} component of the URL in URI.js is not transformed`,"","sap.ushell.ApplicationType")}s(t)},a=>{e.error("URL Transformation Failed",JSON.stringify(a.message),"sap.ushell.ApplicationType");s(t)})})}else{s(t)}})}function L(t,a){const r=n.getMember(a,"sap|integration.navMode");switch(r){case"inplace":if(["embedded","inplace","newWindowThenEmbedded"].includes(t)){return"embedded"}e.error("App-defined navigation mode was ignored","Application requests to be opened inplace, but the template's navigation mode doesn't allow it.","sap.ushell.ApplicationType");break;case"explace":if(["embedded","inplace","newWindowThenEmbedded"].includes(t)){return"newWindowThenEmbedded"}if(["standalone","explace","newWindow"].includes(t)){return"newWindow"}e.error("App-defined navigation mode was ignored","Application requests to be opened explace, but the template's navigation mode doesn't allow it.","sap.ushell.ApplicationType");break;default:if(r){e.error("App-defined navigation mode is not valid",r,"Fallback to URL Template's capability","sap.ushell.ApplicationType")}if(["embedded","inplace","newWindowThenEmbedded"].includes(t)){return"embedded"}break}return"newWindow"}function x(e){if(["embedded","inplace","newWindowThenEmbedded"].includes(e)){return"embedded"}if(["standalone","explace","newWindow"].includes(e)){return"standalone"}}function C(e,t,a){const n=l(e);n.navigationMode=L(e.navigationMode,t);n.templateNavigationMode=x(e.navigationMode);n.appId=a(e.appId||"");n.technicalAppComponentId=a(e.technicalAppComponentId||"");n.appSupportInfo=t["sap.app"]&&t["sap.app"].ach;n.appFrameworkId=e.appFrameworkId;delete n.urlTransformation;return n}async function O(t,r,s){const i=t.inbound;const p=i.templateContext;const u=p.payload.capabilities||{};let d=t.fullHash;let y;if(sap?.cf?.config?.siteId!==undefined&&p?.siteAppSection["sap.integration"]?.navMode==="inplace"){e.warning("URL template's navigationMode capability is ignored! navigationMode is forced to 'embedded'.");u.navigationMode="embedded"}if(t.mappedIntentParamsPlusSimpleDefaults&&t.mappedIntentParamsPlusSimpleDefaults.hasOwnProperty("sap-ushell-innerAppRoute")){if(t.mappedIntentParamsPlusSimpleDefaults["sap-ushell-innerAppRoute"].length>0&&d.indexOf("&/")===-1){d+=`&/${t.mappedIntentParamsPlusSimpleDefaults["sap-ushell-innerAppRoute"]}`;y=d}}m.removeParametersWithEmptyValue(t.mappedIntentParamsPlusSimpleDefaults,["sap-system"]);const R={innerAppRoute:P(p,d)||t.parsedIntent.appSpecificRoute,targetNavMode:A(t),defaultParameterNames:t.mappedDefaultedParamNames,startupParameter:t.mappedIntentParamsPlusSimpleDefaults,remoteApplication:{remoteSO:undefined,remoteAction:undefined}};const L=await b(d);R.env=L;const x=a.get(["sap.integration","urlTemplateParams","query"],p.siteAppSection)||{};if(x.hasOwnProperty("sap-cssurl")){R.env.themeServiceRoot=undefined;R.env.theme=undefined}if(u.appFrameworkId==="UI5"&&R.startupParameter){for(const e in R.startupParameter){if(e!=="sap-ushell-innerAppRoute"){R.startupParameter[e][0]=encodeURIComponent(R.startupParameter[e][0])}if(e==="sap-shell-so"){R.remoteApplication.remoteSO=R.startupParameter[e][0]}if(e==="sap-shell-action"){R.remoteApplication.remoteAction=R.startupParameter[e][0]}}if(t.mappedDefaultedParamNames&&t.mappedDefaultedParamNames.length>0){const e=t.mappedDefaultedParamNames.filter(e=>e!=="sap-shell-so"&&e!=="sap-shell-action"&&e!=="sap-system");R.startupParameter["sap-ushell-defaultedParameterNames"]=[JSON.stringify(e)]}delete R.startupParameter["sap-shell-so"];delete R.startupParameter["sap-shell-action"]}const O="/universal_search/search";const E=R.innerAppRoute&&R.innerAppRoute.indexOf(O);let M;if(E===0){M=R.innerAppRoute.substring(1);R.innerAppRoute="/JAMSEARCHPATHH?JAMSEARCHVALUEE=VALUEE"}const k=n.getMember(p.siteAppSection,"sap|integration.urlTemplateId");let D=p.payload;if(k==="urltemplate.gui"){D=l(p.payload,20);S(D,R,i)}D=w(k,D,x);let N=h.expand(D,p.site,R,p.siteAppSection,"startupParameter",d);if(E===0){N=N.replace("/JAMSEARCHPATHH?JAMSEARCHVALUEE=VALUEE",`/${M}`)}if(R.env.theme===undefined){N=N.replace("&sap-theme=","")}if(u.appFrameworkId==="UI5"&&d.length>1){N=N.split("#")[0]+d;e.debug(`- created URL with fixed hash: ${N}`,"sap.ushell.ApplicationType")}function q(e){const t=l(p.payload,20);t.urlTemplate=e;return h.expand(t,p.site,R,p.siteAppSection,"startupParameter",d)}const H=p.siteAppSection["sap.app"]&&p.siteAppSection["sap.app"].destination||p.siteAppSection.destination||"";const W=p?.siteAppSection["sap.app"]?.contentProviderId||"";const j=f.getSystemAliasInProvider(H,W);const F={applicationType:"URL",text:i.title,appCapabilities:C(u,p.siteAppSection,q),url:N,extendedInfo:o.getExtendedInfo(t,p.siteAppSection,p.site),contentProviderId:i.contentProviderId||"",systemAlias:j,replaceHashBeforeOpenAppInplace:y};o.addIframeCacheHintToURL(F,F.appCapabilities.appFrameworkId);o.addKeepAliveToURLTemplateResult(F);v(F);T(F,p.siteAppSection,R);const _=await c.getServiceAsync("URLTemplate");const $=!g.findFreeContainerByUrl(F.url);F.url=await _.handlePostTemplateProcessing(F.url,p.siteAppSection,$);const J=await U(F.url,u,p);F.url=J;if(F.url&&typeof F.url==="string"&&F.url.indexOf("sap-iframe-hint=GUI")>0){return F}try{const e=await I(F.url,R.targetNavMode,u);F.url=e}catch{}return F}const E={generateURLTemplateResolutionResult:O,handleURLTransformation:U,_createEnv:b,_addLanguageToURLTemplateResult:T,compactURLParameters:I};return E});
//# sourceMappingURL=urlTemplateResolution.js.map