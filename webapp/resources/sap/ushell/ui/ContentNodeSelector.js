// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["./ContentNodeSelectorRenderer","sap/base/util/deepClone","sap/m/Column","sap/m/ColumnListItem","sap/m/Label","sap/m/MultiInput","sap/m/Token","sap/ui/core/Element","sap/ui/core/Fragment","sap/ui/core/Control","sap/ui/Device","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ushell/Config","sap/ushell/Container","sap/ushell/library","sap/ushell/resources"],(e,t,n,o,s,i,l,a,r,c,d,p,u,g,h,_,y,f)=>{"use strict";const m=y.ContentNodeType;const b=c.extend("sap.ushell.ui.ContentNodeSelector",{metadata:{library:"sap.ushell",aggregations:{content:{type:"sap.m.MultiInput",multiple:false,visibility:"hidden"}},associations:{labelId:{type:"sap.ui.core.Control",multiple:false}},events:{selectionChanged:{},valueHelpEndButtonPressed:{}}},renderer:e});b.prototype.init=function(){this._oModel=new g({items:[],suggestions:[],isSpaces:h.last("/core/spaces/enabled")});this._oDeviceModel=new g(d);this.setModel(this._oModel,"_internal");this.setModel(this._oDeviceModel,"_device");this.setModel(f.i18nModel,"_i18n");if(!this.getAggregation("content")){const e=this._createMultiInput();this.setAggregation("content",e)}this.setBusyIndicatorDelay(0);this._loadContentNodes().then(this._overwriteLabel.bind(this))};b.prototype._createMultiInput=function(){const e=new i({ariaLabelledBy:this.getLabelId(),valueHelpRequest:this._showValueHelp.bind(this),tokenUpdate:this._onTokenUpdate.bind(this),required:true,suggestionColumns:[new n({header:new s({text:"{= ${_internal>/isSpaces} ? ${_i18n>contentNodeSelectorPage} : ${_i18n>contentNodeSelectorHomepageGroup}}"})}),new n({visible:"{= ${_internal>/isSpaces}}",header:new s({text:"{_i18n>contentNodeSelectorSpace}"})})],suggestionRows:{path:"_internal>/suggestions",template:new o({cells:[new s({text:"{_internal>label}"}),new s({visible:"{_internal>/isSpaces}",text:"{= ${_internal>spaceTitles}.join(', ')}"})]}),templateShareable:false}});e.addValidator(this._validateItem.bind(this));return e};b.prototype._overwriteLabel=function(){const e=this.getLabelId();const t=a.getElementById(e);if(t&&typeof t.setText==="function"){if(this._oModel.getProperty("/isSpaces")){t.setText(f.i18n.getText("contentNodeSelectorHomepagePages"))}else{t.setText(f.i18n.getText("contentNodeSelectorHomepageGroups"))}}if(t&&typeof t.setRequired==="function"&&t.isPropertyInitial("required")){t.setRequired(true)}};b.prototype.exit=function(){this._oModel.destroy();this._oDeviceModel.destroy()};b.prototype.setLabelId=function(e){this.setAssociation("labelId",e);this._overwriteLabel();const t=this.getAggregation("content");if(t){t.addAriaLabelledBy(e)}return this};b.prototype.getSelectedContentNodes=function(){const e=this.getAggregation("content");const n=e.getTokens();return n.map(e=>{const n=e.getBindingContext("_internal").getObject();const o=t(n);delete o.selected;delete o.spaceTitles;return o})};b.prototype._getMyHomeEnablement=function(){return new Promise((e,t)=>{const n=h.last("/core/spaces/myHome/enabled");const o=_.getUser().getShowMyHome();e(n&&o)})};b.prototype._filterPersonalizableContentNodes=function(e){if(!Array.isArray(e)){return[]}return e.reduce((e,t)=>{if(this._bShowOnlyMyHome&&t.id!==this._sMyHomeSpaceId&&t.id!==this._sMyHomePageId){return e}t.children=this._filterPersonalizableContentNodes(t.children);if(t.type===m.HomepageGroup||t.type===m.Space&&t.children.length||t.type===m.Page&&t.isContainer){e.push(t)}return e},[])};b.prototype._loadContentNodes=function(){this.setBusy(true);return Promise.all([_.getServiceAsync("BookmarkV2"),this._getMyHomeEnablement()]).then(e=>{const n=e[0];const o=e[1];const s=h.last("/core/shell/enablePersonalization");this._bShowOnlyMyHome=!s&&o;this._sMyHomeSpaceId=h.last("/core/spaces/myHome/myHomeSpaceId");this._sMyHomePageId=h.last("/core/spaces/myHome/myHomePageId");return n.getContentNodes().then(e=>{e=t(e);e=this._filterPersonalizableContentNodes(e);b._normalizeContentNodes(e);this._oModel.setProperty("/items",e);const n=b._getSuggestions(e);for(let e=0;e<n.length;e++){n[e].selected=false}this._oModel.setProperty("/suggestions",n);this.setBusy(false)})})};b.prototype._showValueHelp=function(e){const t=e.getSource();const n=t.getValue();if(!this._oValueHelpDialog){r.load({id:`${this.getId()}-ValueHelpDialog`,name:"sap.ushell.ui.ContentNodeSelectorValueHelp",controller:this}).then(e=>{this.addDependent(e);this._oValueHelpDialog=e;this._openValueHelpDialog(n)})}else{this._openValueHelpDialog(n)}};b.prototype._openValueHelpDialog=function(e){const t=r.byId(`${this.getId()}-ValueHelpDialog`,"ContentNodesTree");t.expandToLevel(1);this._oValueHelpDialog.open();const n=r.byId(`${this.getId()}-ValueHelpDialog`,"ContentNodesSearch");n.setValue(e);this._onValueHelpSearch()};b.prototype._onValueHelpSearch=function(){const e=r.byId(`${this.getId()}-ValueHelpDialog`,"ContentNodesSearch");const t=e.getValue();const n=r.byId(`${this.getId()}-ValueHelpDialog`,"ContentNodesTree");const o=n.getBinding("items");o.filter(new p({path:"label",operator:u.Contains,value1:t}))};b.prototype._onValueHelpBeginButtonPressed=function(){const e=r.byId(`${this.getId()}-ValueHelpDialog`,"ContentNodesTree");const t=e.getSelectedContextPaths();const n=this.getAggregation("content");n.destroyTokens();let o;let s;for(let e=0;e<t.length;e++){s=t[e];const i=this.getModel("_internal");const l=n.getAggregation("tokens").map(e=>e.getProperty("key")).indexOf(i.getProperty(s).id);if(l<0){o=this._createToken(s);n.addValidateToken({token:o})}}n.setValue("");this._oValueHelpDialog.close()};b.prototype._onValueHelpEndButtonPressed=function(){this.fireValueHelpEndButtonPressed();this._oValueHelpDialog.close()};b.prototype._onTokenUpdate=function(e){const t=e.getParameter("addedTokens");const n=e.getParameter("removedTokens");this._setTokensSelected(t,true);this._setTokensSelected(n,false);setTimeout(this.fireSelectionChanged.bind(this),0)};b.prototype._setTokensSelected=function(e,t){let n;for(let o=0;o<e.length;o++){n=e[o].getBindingContext("_internal");n.getModel().setProperty(n.getPath("selected"),t)}};b.prototype._validateItem=function(e){if(e.suggestedToken){return e.suggestedToken}const t=e.suggestionObject;if(!t){return null}const n=t.getBindingContext("_internal");return this._createToken(n.getPath())};b.prototype._createToken=function(e){const t=new l({key:"{_internal>id}",text:"{_internal>label}"});t.bindObject({path:e,model:"_internal"});return t};b._getSuggestions=function(e){const t=[];b._getChildren(e,t);return t};b._getChildren=function(e,t){let n;for(let o=0;o<e.length;o++){n=e[o];if(n.isContainer&&t.indexOf(n)===-1){t.push(n)}if(n.children){b._getChildren(n.children,t)}}};b._normalizeContentNodes=function(e){const t={};b._visitPages(e,(e,n)=>{n.spaceTitles=n.spaceTitles||[];if(t[n.id]){t[n.id].spaceTitles.push(e.label);return t[n.id]}n.spaceTitles.push(e.label);t[n.id]=n;return n})};b._visitPages=function(e,t){if(e===undefined||e===null){return}for(let n=0;n<e.length;n++){const o=e[n];if(o.type!==m.Space){return}if(o.children){for(let e=0;e<o.children.length;e++){const n=o.children[e];o.children[e]=t(o,n)}}}};b.prototype.clearSelection=function(){const e=this.getAggregation("content");const t=e.getTokens();t.forEach(e=>{const t=e.getBindingContext("_internal");this._oModel.setProperty(t.getPath("selected"),false)});e.destroyTokens()};b.prototype.setValueState=function(e){const t=this.getAggregation("content");t.setValueState(e)};b.prototype.setValueStateText=function(e){const t=this.getAggregation("content");t.setValueStateText(e)};return b});
//# sourceMappingURL=ContentNodeSelector.js.map