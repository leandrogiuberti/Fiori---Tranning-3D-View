// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/extend","sap/ui/core/Element","sap/ui/core/EventBus","sap/ui/thirdparty/hasher","sap/ushell/EventHub","sap/ushell/ui/launchpad/Tile","sap/ushell/utils","sap/ushell/utils/UrlParsing","sap/ushell/Container","sap/ushell/state/StateManager"],(e,t,s,i,a,n,o,r,l,g,u)=>{"use strict";function c(){}c.prototype={_maxLoggedMessages:50,_maxMessageByteSize:2048,_maxQueueByteSize:30720,_isActive:false,_observedLaunchpadActions:["createGroupAt","deleteGroup","resetGroup","changeGroupTitle","moveGroup","addTile","deleteTile","movetile","externalSearch","addBookmarkTile"],_observedGeneralActions:["openApp"],_observedEventHubEvents:["showCatalog"],_aDoables:[],messageType:{ACTION:0,ERROR:1},_tileOntapOrigFunc:undefined,activate:function(){if(this._isActive){return}this._isActive=true;const t=i.getInstance();this._observedLaunchpadActions.forEach(e=>{t.subscribe("launchpad",e,this._handleAction,this)});t.subscribe("sap.ushell","appOpened",this._handleAction,this);this._observedGeneralActions.forEach(e=>{t.subscribe(e,this._handleAction,this)});this._observedEventHubEvents.forEach(e=>{this._aDoables.push(n.on(e).do(this._handleActionEventHub.bind(this)))});e.addLogListener(this);this._tileOntapOrigFunc=o.prototype.ontap;o.prototype.ontap=this._tileOnTapDecorator(this._tileOntapOrigFunc)},deactivate:function(){if(!this._isActive){return}this._isActive=false;const t=i.getInstance();this._observedLaunchpadActions.forEach((e,s,i)=>{t.unsubscribe("launchpad",e,this._handleAction,this)});t.unsubscribe("sap.ushell","appOpened",this._handleAction,this);this._observedGeneralActions.forEach((e,s,i)=>{t.unsubscribe(e,this._handleAction,this)});this._aDoables.forEach(e=>{e.off()});this._aDoables=[];e.removeLogListener(this);o.prototype.ontap=this._tileOntapOrigFunc},addMessage:function(e,t,s){if(this._isActive){this._addMessageInternal(e,t,s)}},getLog:function(){return this._getLoggingQueueFromStorage()},getMessageInfo:function(){return{userDetails:this._getUserDetails(),shellState:this._getShellState(),navigationData:this._getLastNavActionFromStorage(),userLog:this.getLog(),formFactor:r.getFormFactor()}},getMessageInfoAsString:function(e){return JSON.stringify(this.getMessageInfo(e))},onLogEntry:function(e){if(e.level<=2){let t=e.message;if(typeof e.details!=="undefined"&&e.details!==""){t=`${t}, ${e.details}`}this.addMessage(this.messageType.ERROR,t)}},onAttachToLog:function(){},onDetachFromLog:function(){},_tileOnTapDecorator:function(e){const t=this;return function(){if(this.isA("sap.ushell.ui.launchpad.PlusTile")){t.addMessage(t.messageType.ACTION,`Open Catalog for empty group ${this.getGroupId()}`)}else if(this.isA("sap.ushell.ui.launchpad.Tile")){let e=a.getHash();if(e){const t=l.parseShellHash(e);e=`#${l.constructShellHash({target:{semanticObject:t.semanticObject,action:t.action}})}`}const i=t._getLastNavActionFromStorage();i.time=new Date;i.navigationHash=e;i.tileDebugInfo=this.getDebugInfo();const n=s.getElementById(this.getId());const o=n.getModel();const r=this.getBindingContext();const g=r.getPath();i.tileTitle=r.getModel().getProperty(g).title;t._putInSessionStorage("sap.ushell.UserActivityLog.lastNavigationActionData",JSON.stringify(i));t.addMessage(t.messageType.ACTION,`Click on Tile: ${o.getData().title} Tile debugInfo: ${this.getDebugInfo()}`)}e.apply(this,arguments)}},_addMessageInternal:function(e,s,i){const a=this._getLoggingQueueFromStorage();const n={type:null};for(const t in this.messageType){if(e===this.messageType[t]){n.type=t;break}}if(n.type===null){return}t(n,{messageID:i,messageText:s,time:new Date,toString:function(){const e=[this.type,this.time];if(typeof this.messageID!=="undefined"){e.push(this.messageID)}e.push(this.messageText);return e.join(" :: ")}});a.push(n);if(a.length>this._maxLoggedMessages){a.shift()}this._putInSessionStorage("sap.ushell.UserActivityLog.loggingQueue",JSON.stringify(a))},_handleActionEventHub:function(e){this._handleAction("",e.sId,e.oData)},_handleAction:function(e,t,s){let i;switch(t){case"deleteTile":i=`Delete Tile ${s.tileId||""}`;break;case"moveTile":i=`Move Tile ${s.sTileId||""} to Group ${s.toGroupId||""}`;break;case"createGroupAt":i="Create Group";break;case"changeGroupTitle":i=`Change Group Title of ${s.groupId||""} to ${s.newTitle||""}`;break;case"deleteGroup":i=`Delete Group ${s.groupId||""}`;break;case"addTile":const e=s.catalogTileContext.oModel;const t=s.catalogTileContext.sPath;const a=e.getProperty(t);const n=a&&a.id||"";const o=s.groupContext.getObject();const r=o&&o.id||"";i=`Add Tile ${n} to Group ${r}`;break;case"moveGroup":i=`Move Group from index ${s.fromIndex||""} to index ${s.toIndex||""}`;break;case"appOpened":i=`Open application ${s.action}`;const l=this._getLastNavActionFromStorage();l.applicationInformation={};["applicationType","ui5ComponentName","url","additionalInformation","text"].forEach(e=>{l.applicationInformation[e]=s[e]});if(!this._hashSegmentsEqual(l.navigationHash,s.sShellHash)){l.tileDebugInfo=""}l.navigationHash=s.sShellHash;this._putInSessionStorage("sap.ushell.UserActivityLog.lastNavigationActionData",JSON.stringify(l));break;case"addBookmarkTile":i=`Add Bookmark ${s.title||""} ${s.subtitle||""} for URL: ${s.url||""}`;break;case"showCatalog":i="Show Catalog";break;default:break}this.addMessage(this.messageType.ACTION,i)},_getUserDetails:function(){const e=g.getUser();return{fullName:e.getFullName()||"",userId:e.getId()||"",eMail:e.getEmail()||"",Language:e.getLanguage()||""}},_getShellState:function(){const e=u.getShellMode()||"default";return`${e}-${u.getLaunchpadState()}`},_getLoggingQueueFromStorage:function(){const e=this._getFromSessionStorage("sap.ushell.UserActivityLog.loggingQueue");let t=[];if(e){try{t=JSON.parse(e)}catch{}}return t},_getLastNavActionFromStorage:function(){const e=this._getFromSessionStorage("sap.ushell.UserActivityLog.lastNavigationActionData");return e?JSON.parse(e):{}},_hashSegmentsEqual:function(e,t){if(!e||!t){return false}return this._getHashSegment(e)===this._getHashSegment(t)},_getHashSegment:function(e){let t=e.split("~");if(t.length>1){return t[0]}t=e.split("?");if(t.length>1){return t[0]}return e},_getFromSessionStorage:function(e){let t=null;try{t=sessionStorage.getItem(e)}catch{}return t},_putInSessionStorage:function(e,t){try{sessionStorage.setItem(e,t)}catch{}}};const h=new c;return h});
//# sourceMappingURL=UserActivityLog.js.map