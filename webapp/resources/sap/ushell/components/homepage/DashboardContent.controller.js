// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/core/Core","sap/ui/core/mvc/Controller","sap/ui/Device","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/thirdparty/jquery","sap/ushell/components/homepage/DashboardUIActions","sap/ushell/components/HomepageManager","sap/ushell/EventHub","sap/ushell/Layout","sap/ushell/resources","sap/ushell/utils"],(e,t,o,s,i,r,jQuery,n,a,l,u,d,p)=>{"use strict";return o.extend("sap.ushell.components.homepage.DashboardContent",{onInit:function(){const e=t.getEventBus();this.handleDashboardScroll=function(){window.setTimeout(this._handleDashboardScroll.bind(this),0)}.bind(this);e.subscribe("sap.ushell","appOpened",this._appOpenedHandler,this);e.subscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);e.subscribe("launchpad","actionModeInactive",this._handleGroupVisibilityChanges,this);e.subscribe("launchpad","switchTabBarItem",this._handleTabBarItemPressEventHandler,this);window.document.addEventListener("visibilitychange",p.handleTilesVisibility,false)},onExit:function(){const e=t.getEventBus();e.unsubscribe("sap.ushell","appOpened",this._appOpenedHandler,this);e.unsubscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);e.unsubscribe("launchpad","actionModeInactive",this._handleGroupVisibilityChanges,this);e.unsubscribe("launchpad","switchTabBarItem",this._handleTabBarItemPressEventHandler,this);window.document.removeEventListener("visibilitychange",p.handleTilesVisibility,false);if(this.oDashboardUIActionsModule){this.oDashboardUIActionsModule.destroy();delete this.oDashboardUIActionsModule}window.removeEventListener("resize",this._resizeHandler.bind(this))},onAfterRendering:function(){p.setPerformanceMark("FLP - dashboard after rendering");const e=a.prototype.getInstance();if(!e.getPreparedGroupModel()){e.loadPersonalizedGroups()}else{l.once("firstSegmentCompleteLoaded").do(e.handleFirstSegmentLoaded.bind(e))}const o=t.getEventBus();let i;let r;let n;let u;o.unsubscribe("launchpad","scrollToGroup",this._scrollToGroup,this);o.unsubscribe("launchpad","scrollToGroupByName",this._scrollToGroupByName,this);o.subscribe("launchpad","scrollToGroup",this._scrollToGroup,this);o.subscribe("launchpad","scrollToGroupByName",this._scrollToGroupByName,this);s.orientation.attachHandler(function(){const e=jQuery("#dashboardGroups").find(".sapUshellTileContainer").filter(":visible");if(e.length){i=this.getView().getModel();r=i.getProperty("/topGroupInViewPortIndex");if(e.get(r)){n=t.byId(e.get(r).id);u=i.getProperty("/editTitle");this._publishAsync("launchpad","scrollToGroup",{group:n,isInEditTitle:u})}}},this);window.addEventListener("resize",this._resizeHandler.bind(this));this._updateTopGroupInModel()},_resizeHandler:function(){clearTimeout(this._resizeTimer);this._resizeTimer=setTimeout(this.resizeHandler.bind(this),300)},_dashboardDeleteTileHandler:function(e){const o=e.getSource().getBindingContext().getObject();t.getEventBus().publish("launchpad","deleteTile",{tileId:o.uuid,items:"tiles"},this)},dashboardTilePress:function(e){const o=e.getSource();if(!o){return}t.getEventBus().publish("launchpad","dashboardTileClick",{uuid:o.getUuid()});if(s.system.desktop){const e=sap.ushell.Container.getRendererInternal();const t=e.getRouter().getRoute("home");if(this._fnSetFocusOnLastVisitedTile){t.detachBeforeMatched(this._fnSetFocusOnLastVisitedTile)}this._fnSetFocusOnLastVisitedTile=this._setFocusOnLastVisitedTile.bind(this,o,t);t.attachBeforeMatched(this._fnSetFocusOnLastVisitedTile)}},_setFocusOnLastVisitedTile:function(e,t){sap.ui.require(["sap/ushell/components/ComponentKeysHandler"],o=>{o.getInstance().then(o=>{o.moveScrollDashboard(e.$());t.detachBeforeMatched(this._fnSetFocusOnLastVisitedTile);delete this._fnSetFocusOnLastVisitedTile})})},_updateTopGroupInModel:function(){const e=this.getView().getModel();const t=this._getIndexOfTopGroupInViewPort();const o=this._getModelGroupFromVisibleIndex(t);e.setProperty("/iSelectedGroup",o);e.setProperty("/topGroupInViewPortIndex",t)},_getIndexOfTopGroupInViewPort:function(){const e=this.getView().getDomRef();if(!e){return 0}const t=e.getElementsByTagName("section")[0];const o=jQuery(t).find(".sapUshellTileContainer").not(".sapUshellHidden");if(!o){return 0}for(let e=0;e<o.length;e++){const s=o[e].parentElement;if(t.scrollTop<=s.offsetTop+s.offsetHeight){return e}}return o.length?o.length-1:0},_handleDashboardScroll:function(){const e=this.getView();const t=e.getModel();const o=100;const i=t.getProperty("/homePageGroupDisplay");const r=i!=="tabs";const n=t.getProperty("/tileActionModeActive");function a(){p.handleTilesVisibility()}clearTimeout(this.timeoutId);this.timeoutId=setTimeout(a,o);if(!s.system.phone){e.oAnchorNavigationBar.closeOverflowPopup()}if(r||n){this._updateTopGroupInModel()}e.oAnchorNavigationBar.reArrangeNavigationBarElements()},_handleGroupDeletion:function(e){sap.ui.require(["sap/m/MessageBox"],o=>{const s=t.getEventBus();const i=e.getObject();const r=i.removable;const n=i.title;const a=i.groupId;const l=d.i18n;const u=o.Action;const p=r?u.DELETE:l.getText("ResetGroupBtn");sap.ushell.Container.getServiceAsync("MessageInternal").then(e=>{e.confirm(l.getText(r?"delete_group_msg":"reset_group_msg",[n]),e=>{if(e===p){s.publish("launchpad",r?"deleteGroup":"resetGroup",{groupId:a})}},l.getText(r?"delete_group":"reset_group"),[p,u.CANCEL])})})},_modelLoaded:function(){this.bModelInitialized=true;u.getInitPromise().then(()=>{this._initializeUIActions()})},_initializeUIActions:function(){if(!this.oDashboardUIActionsModule){this.oDashboardUIActionsModule=new n}this.oDashboardUIActionsModule.initializeUIActions(this)},resizeHandler:function(){p.recalculateBottomSpace();p.handleTilesVisibility();if(u&&jQuery("#dashboardGroups").is(":visible")&&this.bModelInitialized){u.reRenderGroupsLayout(null);this._initializeUIActions()}},_appOpenedHandler:function(e,t,o){const s=this.getView().getModel();const i=o.additionalInformation||"";const r=this.getOwnerComponent();const n=r.getMetadata().getComponentName();if(i.indexOf(n)===-1){p.setTilesNoVisibility()}const a=sap.ui.require("sap/ushell/components/homepage/ActionMode");if(s.getProperty("/tileActionModeActive")&&a){a.toggleActionMode(s,"Menu Item");if(s.getProperty("/homePageGroupDisplay")==="tabs"){this._deactivateActionModeInTabsState();this.getView().oAnchorNavigationBar.reArrangeNavigationBarElements()}}if(this.oDashboardUIActionsModule){this.oDashboardUIActionsModule.disableAllDashboardUiAction()}},_scrollToGroupByName:function(e,t,o){const s=this.getView().getModel().getProperty("/groups");const i=o.groupName;sap.ushell.Container.getServiceAsync("FlpLaunchPage").then(o=>{s.forEach(s=>{if(o.getGroupTitle(s.object)===i){this._scrollToGroup(e,t,{groupId:s.groupId})}})})},_scrollToGroup:function(t,o,i){const r=i.group?i.group.getGroupId():i.groupId;let n;if(this.oView.oDashboardGroupsBox.getGroups()){n=this.oView.oDashboardGroupsBox.getGroups().reduce((e,t)=>t&&t.getGroupId()===r?t:e,null)}const a=n&&n.getDomRef();if(!a){return e.warning("Could not scroll to group: Group is not rendered!")}const l=a.querySelector(".sapUshellTileContainerContent");if(!l){return e.warning("Could not scroll to group: Group Content is not rendered!")}const u=document.getElementById("dashboardGroups");const d=l.getBoundingClientRect();const c=u.getBoundingClientRect();if(d.top===c.top){u.parentElement.scrollTop=0}else{l.scrollIntoView()}const g=new Promise(e=>{if(s.system.desktop&&(i.restoreLastFocusedTile||i.groupChanged)){sap.ui.require(["sap/ushell/components/ComponentKeysHandler"],t=>{t.getInstance().then(e=>{let t=n.$();if(i.restoreLastFocusedTile){let o=false;if(i.restoreLastFocusedTileContainerById){t=jQuery(`#${i.restoreLastFocusedTileContainerById}`);o=true}e.goToLastVisitedTile(t,o)}else if(i.groupChanged){const o=t.find(".sapUshellTile, .sapMGTLineMode, .sapFCard").filter(":visible").eq(0);if(o.length){e.moveScrollDashboard(o)}}}).then(e)})}else{e()}});g.then(()=>{if(i.isInEditTitle){n.setEditMode(true)}p.handleTilesVisibility()});return g},_handleDrop:function(e,o){const s=u.getLayoutEngine();const i=s.layoutEndCallback();const r=!i.dstArea;const n=t.getEventBus();let a;let l;let d=jQuery.Deferred();const p=this.getView();const c=p.getModel();const g=c.getProperty("/homePageGroupDisplay")&&c.getProperty("/homePageGroupDisplay")==="tabs";const h=c.getProperty("/tileActionModeActive");let f=true;if(!i.tile){n.publish("launchpad","sortableStop");return null}u.getLayoutEngine()._toggleAnchorItemHighlighting(false);if(i.dstGroup){const e=i.dstGroup.getBindingContext();const t=e.getProperty(e.sPath).isGroupLocked;f=r&&t}const b=i.tile.getBindingContext().getObject().isLinkPersonalizationSupported;if(!i.tileMovedFlag||f||!b&&i.dstArea==="links"){n.publish("launchpad","sortableStop");return null}if(!h&&!g&&i.dstArea==="links"&&!i.dstGroupData.getLinks().length){n.publish("launchpad","sortableStop");return null}a=true;l=true;if(i.srcGroup!==i.dstGroup){a=l=false}else if(i.tile!==i.dstGroup.getTiles()[i.dstTileIndex]){l=false}const G=this._getTileUuid(i.tile);if(i.srcGroup&&i.srcGroup.removeAggregation&&i.srcArea){i.srcGroup.removeAggregation("tiles",i.tile,a)}const m=i.dstGroupData&&i.dstGroupData.insertAggregation&&i.dstArea===i.srcArea;if(m){i.tile.sParentAggregationName=i.dstArea;i.dstGroupData.insertAggregation(i.dstArea,i.tile,i.dstTileIndex,l);d=this._handleSameTypeDrop(i,G,m)}else if(r){d=this._handleShortDrop(i,G,m)}else{d=this._handleConvertDrop(i,m,o)}if(this.getView().getModel()){this.getView().getModel().setProperty("/draggedTileLinkPersonalizationSupported",true)}n.publish("launchpad","sortableStop");return d.promise()},_handleSameTypeDrop:function(e,o,s){const i=t.getEventBus();const r=jQuery.Deferred();e.tile._getBindingContext().oModel.setProperty(`${e.tile._getBindingContext().sPath}/draggedInTabBarToSourceGroup`,false);i.publish("launchpad","movetile",{sTileId:o,sToItems:e.dstArea?e.dstArea:"tiles",sFromItems:e.srcArea?e.srcArea:"tiles",sTileType:e.dstArea?e.dstArea.substr(0,e.dstArea.length-1):undefined,toGroupId:e.dstGroupData.getGroupId?e.dstGroupData.getGroupId():e.dstGroupData.groupId,toIndex:e.dstTileIndex,longDrop:s,callBack:function(){r.resolve()}});return r.promise()},_handleShortDrop:function(e,o,s){const i=t.getEventBus();const r=jQuery.Deferred();i.publish("launchpad","movetile",{sTileId:o,sToItems:e.srcArea||"tiles",sFromItems:e.srcArea||"tiles",sTileType:e.srcArea?e.srcArea.substr(0,e.srcArea.length-1):undefined,toGroupId:e.dstGroupData.getGroupId?e.dstGroupData.getGroupId():e.dstGroupData.groupId,toIndex:e.dstTileIndex,longDrop:s,callBack:function(){r.resolve()}});return r.promise()},_handleConvertDrop:function(e,o,s){const i=t.getEventBus();const r=jQuery.Deferred();i.publish("launchpad","convertTile",{toGroupId:e.dstGroupData.getGroupId?e.dstGroupData.getGroupId():e.dstGroupData.groupId,toIndex:e.dstTileIndex,tile:t.byId(s.id),srcGroupId:e.srcGroup.getGroupId?e.srcGroup.getGroupId():e.srcGroup.groupId,longDrop:o,callBack:function(){r.resolve()}});return r.promise()},_getTileUuid:function(e){if(e.getUuid){return e.getUuid()}const t=e.getBindingContext().getObject();if(t.getParent){return t.getParent().getUuid()}return t.uuid},_handleDrag:function(e,t){const o=u.getLayoutEngine().layoutEndCallback();const s=o.tile.getBindingContext().getObject();const i=this.getView().getModel();if(i){i.setProperty("/draggedTileLinkPersonalizationSupported",s.isLinkPersonalizationSupported)}},_handleTabBarItemPressEventHandler:function(e,t,o){const s=this.getView();const i=s.getModel();const r=i.getProperty("/groups");const n=o.iGroupIndex;for(let e=0;e<r.length;e++){i.setProperty(`/groups/${e}/isGroupSelected`,false)}i.setProperty(`/groups/${n}/isGroupSelected`,true);this._handleTabBarItemPress(e,t,n)},_handleTabBarItemPress:function(e,o,s,i){const r=this.getView();let n;if(i){n=i.getParameter("group").getIndex()}else{n=s}t.getEventBus().publish("launchpad","tabSelected",{iSelectedGroup:n});const a=this._getVisibleGroupIndex(n);r.oDashboardGroupsBox.removeLinksFromUnselectedGroups();r.oDashboardGroupsBox.getBinding("groups").filter([r.oFilterSelectedGroup]);r.oAnchorNavigationBar.setSelectedItemIndex(a);r.oAnchorNavigationBar.reArrangeNavigationBarElements();setTimeout(()=>{p.handleTilesVisibility()},0)},_getVisibleGroupIndex:function(e){const t=this.getView().getModel().getProperty("/groups");let o=0;for(let s=0;s<e;s++){if(!t[s].isGroupVisible||!t[s].visibilityModes[0]){o++}}return e-o},_getModelGroupFromVisibleIndex:function(e){const t=this.getView().getModel().getProperty("/groups");let o=0;for(let s=0;s<t.length;s++){if(t[s].isGroupVisible&&t[s].visibilityModes[0]){o++;if(o>e){return s}}}return 0},_handleAnchorItemPress:function(e){const t=this.getView();const o=t.getModel();const n=o.getProperty("/groups");if(s.system.phone&&e.getParameter("manualPress")){e.oSource.openOverflowPopup()}for(let e=0;e<n.length;e++){if(o.getProperty(`/groups/${e}/isGroupSelected`)===true){o.setProperty(`/groups/${e}/isGroupSelected`,false)}}o.setProperty(`/groups/${e.getParameter("group").getIndex()}/isGroupSelected`,true);o.setProperty("/iSelectedGroup",e.getParameter("group").getIndex());if(o.getProperty("/homePageGroupDisplay")&&o.getProperty("/homePageGroupDisplay")==="tabs"&&!o.getProperty("/tileActionModeActive")){this._handleTabBarItemPress(undefined,undefined,undefined,e)}else{if(!o.getProperty("/tileActionModeActive")){t.oDashboardGroupsBox.getBinding("groups").filter([new i("isGroupVisible",r.EQ,true)])}else{t.oDashboardGroupsBox.getBinding("groups").filter([])}this._scrollToGroup("launchpad","scrollToGroup",{group:e.getParameter("group"),groupChanged:true,focus:e.getParameter("action")==="sapenter"})}},_addGroupHandler:function(e){const o=e.getSource().getBindingContext().getPath();const s=o.split("/");let i=window.parseInt(s[s.length-1],10);if(e.getSource().sParentAggregationName==="afterContent"){i++}t.getEventBus().publish("launchpad","createGroupAt",{title:"",location:i,isRendered:true})},_publishAsync:function(e,o,s){const i=t.getEventBus();window.setTimeout(i.publish.bind(i,e,o,s),1)},_changeGroupVisibility:function(e){const t=e.getPath();const o=e.getModel();const s=o.getProperty(`${t}/isGroupVisible`);if(o.getProperty(`${t}/isDefaultGroup`)||o.getProperty(`${t}/isGroupLocked`)){return}o.setProperty(`${t}/isGroupVisible`,!s)},_handleGroupVisibilityChanges:function(e,t,o){const s=this.getView().getModel();const i=a.prototype.getInstance();const r=i.getCurrentHiddenGroupIds(s);const n=r.length===o.length;let l=n;let u;r.some((e,t)=>{if(!l){return true}l=o&&Array.prototype.indexOf.call(o,e)!==-1;return!l});if(!l){sap.ushell.Container.getServiceAsync("FlpLaunchPage").then(e=>{u=e.hideGroups(r);u.done(()=>{s.updateBindings("groups")});u.fail(()=>{sap.ushell.Container.getServiceAsync("MessageInternal").then(e=>{e.error(d.i18n.getText("hideGroups_error"))})})})}window.setTimeout(()=>{p.recalculateBottomSpace()},0)},_deactivateActionModeInTabsState:function(){const e=this.getView();const t=e.getModel();let o;const s=t.getProperty("/groups");for(o=0;o<s.length;o++){t.setProperty(`/groups/${o}/isGroupSelected`,false)}let i=e.oAnchorNavigationBar.getSelectedItemIndex();let r=0;if(!this._isGroupVisible(i)){for(o=0;o<s.length;o++){if(!this._isGroupVisible(o)){r++}else{i=o;break}}}else{for(o=0;o<i;o++){if(!this._isGroupVisible(o)){r++}}}const n=i-r;e.oAnchorNavigationBar.setSelectedItemIndex(n);e.oAnchorNavigationBar.adjustItemSelection();t.setProperty(`/groups/${i}/isGroupSelected`,true);e.oDashboardGroupsBox.removeLinksFromAllGroups();const a=t.getProperty("/homePageGroupDisplay");if(a&&a==="tabs"){e.oDashboardGroupsBox.getBinding("groups").filter([e.oFilterSelectedGroup]);const t=e.oDashboardGroupsBox.getGroups&&e.oDashboardGroupsBox.getGroups();const o=Array.isArray(t)&&t[0];if(o&&o.updateLinks){o.updateLinks()}}},_isGroupVisible:function(e){const t=this.getView().getModel().getProperty("/groups");return t[e].isGroupVisible&&t[e].visibilityModes[0]}})});
//# sourceMappingURL=DashboardContent.controller.js.map