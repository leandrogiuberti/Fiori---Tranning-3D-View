// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/tiles/indicatorTileUtils/smartBusinessUtil","sap/m/library","sap/ui/thirdparty/jquery","sap/base/Log"],(e,i,jQuery,t)=>{"use strict";const l=i.Size;const o=i.DeviationIndicator;const s=i.ValueColor;const a=i.LoadState;sap.ui.controller("tiles.indicatorDualComparison.DualComparison",{getTile:function(){return this.oDualComparisonView.oGenericTile},_updateTileModel:function(e){const i=this.getTile().getModel().getData();jQuery.extend(i,e);this.getTile().getModel().setData(i)},setTitle:function(){const e=this;const i=sap.ushell.components.tiles.indicatorTileUtils.util.getTileTitleSubtitle(this.oChip);this._updateTileModel({header:i.title||sap.ushell.components.tiles.indicatorTileUtils.util.getChipTitle(e.oConfig),subheader:i.subTitle||sap.ushell.components.tiles.indicatorTileUtils.util.getChipSubTitle(e.oConfig)})},logError:function(e){this.oDualComparisonView.oGenericTile.setState(a.Failed);this.oDualComparisonView.oGenericTile.setState(a.Failed);sap.ushell.components.tiles.indicatorTileUtils.util.logError(e)},formSelectStatement:function(e){const i=Object.keys(e);let t="";for(let l=0;l<i.length;l++){if(e[i[l]]!==undefined&&e.fullyFormedMeasure){t+=`,${e[i[l]]}`}}return t},setThresholdValues:function(){const e=this;try{const i={};i.fullyFormedMeasure=this.DEFINITION_DATA.EVALUATION.COLUMN_NAME;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){switch(this.DEFINITION_DATA.EVALUATION.GOAL_TYPE){case"MI":i.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WH","MEASURE");i.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CH","MEASURE");i.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TA","MEASURE");i.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TC","MEASURE");i.fullyFormedMeasure+=e.formSelectStatement(i);break;case"MA":i.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WL","MEASURE");i.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CL","MEASURE");i.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TA","MEASURE");i.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TC","MEASURE");i.fullyFormedMeasure+=e.formSelectStatement(i);break;case"RA":i.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WH","MEASURE");i.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CH","MEASURE");i.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TA","MEASURE");i.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TC","MEASURE");i.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WL","MEASURE");i.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CL","MEASURE");i.fullyFormedMeasure+=e.formSelectStatement(i);break}}else{i.criticalHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CH","FIXED");i.criticalLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CL","FIXED");i.warningHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WH","FIXED");i.warningLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WL","FIXED");i.targetValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TA","FIXED");i.trendValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TC","FIXED")}return i}catch(i){e.logError(i)}},getTrendColor:function(e){const i=this;let t;let l;let o;let a;try{const i=this.DEFINITION_DATA.EVALUATION.GOAL_TYPE;let n=s.Neutral;if(i==="MI"){if(e.criticalHighValue&&e.warningHighValue){t=Number(e.criticalHighValue);l=Number(e.warningHighValue);if(this.CALCULATED_KPI_VALUE<l){n=s.Good}else if(this.CALCULATED_KPI_VALUE<=t){n=s.Critical}else{n=s.Error}}}else if(i==="MA"){if(e.criticalLowValue&&e.warningLowValue){o=Number(e.criticalLowValue);a=Number(e.warningLowValue);if(this.CALCULATED_KPI_VALUE<o){n=s.Error}else if(this.CALCULATED_KPI_VALUE<=a){n=s.Critical}else{n=s.Good}}}else if(e.warningLowValue&&e.warningHighValue&&e.criticalLowValue&&e.criticalHighValue){t=Number(e.criticalHighValue);l=Number(e.warningHighValue);a=Number(e.warningLowValue);o=Number(e.criticalLowValue);if(this.CALCULATED_KPI_VALUE<o||this.CALCULATED_KPI_VALUE>t){n=s.Error}else if(this.CALCULATED_KPI_VALUE>=o&&this.CALCULATED_KPI_VALUE<=a||this.CALCULATED_KPI_VALUE>=l&&this.CALCULATED_KPI_VALUE<=t){n=s.Critical}else{n=s.Good}}return n}catch(e){i.logError(e)}},_processDataForComparisonChart:function(e,i,t){const l=[];const o={};let s;let a;let n;let r;let u=[];const c=this;let E;for(s=0;s<e.results.length;s++){E=e.results[s]}u=sap.ushell.components.tiles.indicatorTileUtils.util.getAllMeasuresWithLabelText(this.oConfig.EVALUATION.ODATA_URL,this.oConfig.EVALUATION.ODATA_ENTITYSET);for(s=0,n=u.length;s<n;s++){a=u[s];o[a.key]=a.value}const T=c.oConfig.TILE_PROPERTIES.COLUMN_NAMES||c.oConfig.EVALUATION.COLUMN_NAMES;for(s=0;s<T.length;s++){const e={};const i=T[s];e.value=Number(E[i.COLUMN_NAME]);let a=Number(E[i.COLUMN_NAME]);if(c.oConfig.EVALUATION.SCALING==-2){a*=100}r=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(a,c.oConfig.EVALUATION.SCALING,c.oConfig.EVALUATION.DECIMAL_PRECISION);if(c.oConfig.EVALUATION.SCALING==-2){r+=" %"}e.displayValue=r.toString();if(t[s]&&E[t[s].name]){e.displayValue+=` ${E[t[s].name]}`}e.color=i.semanticColor;e.title=o[i.COLUMN_NAME]||i.COLUMN_NAME;l.push(e)}return l},getTrendIndicator:function(e,i){const t=this;e=Number(e);try{let t=o.None;if(e>i){t=o.Down}else if(e<i){t=o.Up}return t}catch(e){t.logError(e)}},fetchKpiValue:function(e,i){const l=this;try{const o=this.oConfig.EVALUATION.ODATA_URL;const s=this.oConfig.EVALUATION.ODATA_ENTITYSET;let a;let n;if(this.oConfig.TILE_PROPERTIES.semanticMeasure){a=`${this.oConfig.EVALUATION.COLUMN_NAME},${this.oConfig.TILE_PROPERTIES.semanticMeasure}`}else{a=this.oConfig.EVALUATION.COLUMN_NAME;n=a;if(this.oConfig.TILE_PROPERTIES.COLUMN_NAMES){for(let e=0;e<this.oConfig.TILE_PROPERTIES.COLUMN_NAMES.length;e++){if(this.oConfig.TILE_PROPERTIES.COLUMN_NAMES[e].COLUMN_NAME!=this.oConfig.EVALUATION.COLUMN_NAME){n=`${n},${this.oConfig.TILE_PROPERTIES.COLUMN_NAMES[e].COLUMN_NAME}`}}}}const r=this.oConfig.EVALUATION_VALUES;const u=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(l.oConfig.TILE_PROPERTIES.id);if(!u){const r=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.oConfig.EVALUATION_FILTERS,this.oConfig.ADDITIONAL_FILTERS);const u={};u["0"]=`${a},asc`;u["1"]=`${a},desc`;const c=u[this.oConfig.TILE_PROPERTIES.sortOrder||"0"].split(",");const E=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(l.oChip.url.addSystemToServiceUrl(o),s,n,null,r,3);if(this.oConfig.TILE_PROPERTIES.semanticMeasure){E.uri+=`&$orderby=${c[0]} ${c[2]}`}else{E.uri+=`&$orderby=${c[0]} ${c[1]}`}this.writeData={};this.comparisionChartODataRef=E.model.read(E.uri,null,null,true,t=>{if(t&&t.results&&t.results.length){if(E.unit){l.writeData.unit=E.unit}l.oConfig.TILE_PROPERTIES.FINALVALUE=t;l.oConfig.TILE_PROPERTIES.FINALVALUE=l._processDataForComparisonChart(l.oConfig.TILE_PROPERTIES.FINALVALUE,n.split(",")[0],E.unit);l.writeData.data=t;let i;for(let e=0;e<l.oConfig.TILE_PROPERTIES.FINALVALUE.length;e++){if(l.oConfig.TILE_PROPERTIES.FINALVALUE[e].title==l.DEFINITION_DATA.EVALUATION.COLUMN_NAME){l.writeData.numericData=l.oConfig.TILE_PROPERTIES.FINALVALUE[e];calculatedValueforScaling=l.oConfig.TILE_PROPERTIES.FINALVALUE[e].value;l.getTrendIndicator(l.setThresholdValues().trendValue,calculatedValueforScaling);l._updateTileModel({valueColor:l.oConfig.TILE_PROPERTIES.FINALVALUE[e].color,value:sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(i),l.oConfig.EVALUATION.SCALING,l.oConfig.EVALUATION.DECIMAL_PRECISION).toString()});break}}sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(l.oConfig.TILE_PROPERTIES.id,l.writeData);e.call(l,l.oConfig.TILE_PROPERTIES.FINALVALUE)}else if(t.results.length==0){l.oConfig.TILE_PROPERTIES.FINALVALUE=t;l.writeData.data=t;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(l.oConfig.TILE_PROPERTIES.id,l.writeData);e.call(l,l.oConfig.TILE_PROPERTIES.FINALVALUE)}else{i.call(l,"no Response from QueryServiceUri")}},e=>{if(e&&e.response){t.error(`${e.message} : ${e.request.requestUri}`);i.call(l,e)}});if(!l.writeData.numericData){const e=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(l.DEFINITION_DATA.EVALUATION_FILTERS,l.DEFINITION_DATA.ADDITIONAL_FILTERS);const t=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(l.oChip.url.addSystemToServiceUrl(o),s,a,null,e);if(t){l.QUERY_SERVICE_MODEL=t.model;l.queryUriForKpiValue=t.uri;l.numericODataReadRef=l.QUERY_SERVICE_MODEL.read(t.uri,null,null,true,e=>{if(e&&e.results&&e.results.length){if(t.unit){l._updateTileModel({unitNumeric:e.results[0][t.unit.name]});l.writeData.unitNumeric=t.unit;l.writeData.unitNumeric.name=t.unit.name}l.writeData.numericData=e.results[0];l.DEFINITION_DATA.value=l.writeData.numericData[l.DEFINITION_DATA.EVALUATION.COLUMN_NAME];l.writeData.numericData.color=l.getTrendColor(l.setThresholdValues());l.DEFINITION_DATA.valueColor=l.writeData.numericData.color;let i="";let o=e.results[0][l.DEFINITION_DATA.EVALUATION.COLUMN_NAME];const s=l.getTrendIndicator(l.setThresholdValues().trendValue,o);if(l.oConfig.EVALUATION.SCALING==-2){o*=100;l.getView().oNumericContent.setFormatterValue(false)}i=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(o),l.oConfig.EVALUATION.SCALING,l.oConfig.EVALUATION.DECIMAL_PRECISION);if(l.oConfig.EVALUATION.SCALING==-2){l._updateTileModel({scale:"%"})}l._updateTileModel({value:i.toString(),valueColor:l.writeData.numericData.color,indicator:s})}else{i.call(l,"no Response from QueryServiceUri")}})}}}else{if(u.unit){l._updateTileModel({unit:u.data.results[0][u.unit.name]})}if(u.data&&u.data.results&&u.data.results.length){l.oConfig.TILE_PROPERTIES.FINALVALUE=u.data;l._updateTileModel({value:u.data.results[0][l.DEFINITION_DATA.EVALUATION.COLUMN_NAME]});l.oConfig.TILE_PROPERTIES.FINALVALUE=l._processDataForComparisonChart(l.oConfig.TILE_PROPERTIES.FINALVALUE,n,l.writeData.unit);e.call(l,l.oConfig.TILE_PROPERTIES.FINALVALUE)}else if(r.results.length==0){l.oConfig.TILE_PROPERTIES.FINALVALUE=u.data;e.call(l,l.oConfig.TILE_PROPERTIES.FINALVALUE)}else{i.call(l,"no Response from QueryServiceUri")}}}catch(e){i.call(l,e)}},flowWithoutDesignTimeCall:function(){const e=this;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);if(this.oChip.visible.isVisible()&&!this.firstTimeVisible){this.firstTimeVisible=true;this.fetchKpiValue(function(i){this.CALCULATED_KPI_VALUE=i;e.oDualComparisonView.oGenericTile.setFrameType("TwoByOne");e.oDualComparisonView.oGenericTile.removeAllTileContent();e.oDualComparisonView.oGenericTile.addTileContent(e.oDualComparisonView.oNumericTile);e.oDualComparisonView.oGenericTile.addTileContent(e.oDualComparisonView.oComparisonTile);const t=this.CALCULATED_KPI_VALUE;let l;let o;for(let i=0;i<t.length;i++){if(t[i].title==e.DEFINITION_DATA.EVALUATION.COLUMN_NAME){o=t[i].value;l=t[i].color||"Neutral";e._updateTileModel({value:sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(o),e.oConfig.EVALUATION.SCALING,e.oConfig.EVALUATION.DECIMAL_PRECISION).toString(),valueColor:l});break}}if(!l&&!o){l=e.DEFINITION_DATA.valueColor;o=e.DEFINITION_DATA.value}this._updateTileModel({value:sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(o),e.oConfig.EVALUATION.SCALING,e.oConfig.EVALUATION.DECIMAL_PRECISION).toString(),data:this.CALCULATED_KPI_VALUE});const s=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(e.oConfig,e.system);e.oDualComparisonView.oGenericTile.$().wrap(`<a href ='${s}'></a>`);this.oDualComparisonView.oGenericTile.setState(a.Loaded);let n="";if(l=="Error"){n="sb.error"}if(l=="Neutral"){n="sb.neutral"}if(l=="Critical"){n="sb.critical"}if(l=="Good"){n="sb.good"}const r=e.setThresholdValues();let u;let c;let E;let T;let A;let C;let L;let I;let h;if(this.CALCULATED_KPI_VALUE&&this.CALCULATED_KPI_VALUE[0]){u=this.CALCULATED_KPI_VALUE[0].title;T=this.CALCULATED_KPI_VALUE[0].value;L=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(this.CALCULATED_KPI_VALUE[0].color)}if(this.CALCULATED_KPI_VALUE&&this.CALCULATED_KPI_VALUE[1]){c=this.CALCULATED_KPI_VALUE[1].title;A=this.CALCULATED_KPI_VALUE[1].value;I=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(this.CALCULATED_KPI_VALUE[1].color)}if(this.CALCULATED_KPI_VALUE&&this.CALCULATED_KPI_VALUE[2]){E=this.CALCULATED_KPI_VALUE[2].title;C=this.CALCULATED_KPI_VALUE[2].value;h=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(this.CALCULATED_KPI_VALUE[2].color)}const g={status:n,actual:o,target:r.targetValue,cH:r.criticalHighValue,wH:r.warningHighValue,wL:r.warningLowValue,cL:r.criticalLowValue};const f={m1:u,v1:T,c1:L,m2:c,v2:A,c2:I,m3:E,v3:C,c3:h};const U=e.oDualComparisonView.oGenericTile.getTileContent()[0].getContent();const p=e.oDualComparisonView.oGenericTile.getTileContent()[1].getContent();sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(U,"NT",g);sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(p,"COMP",f)},this.logError)}},flowWithDesignTimeCall:function(){const e=this;try{const i=sap.ushell.components.tiles.indicatorTileUtils.cache.getEvaluationById(this.oConfig.EVALUATION.ID);if(i){e.oConfig.EVALUATION_FILTERS=i.EVALUATION_FILTERS;e.flowWithoutDesignTimeCall()}else{sap.ushell.components.tiles.indicatorTileUtils.util.getFilterFromRunTimeService(this.oConfig,i=>{e.oConfig.EVALUATION_FILTERS=i;sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(e.oConfig.TILE_PROPERTIES.id,e.oConfig);e.flowWithoutDesignTimeCall()})}}catch(e){this.logError(e)}},refreshHandler:function(e){if(!e.firstTimeVisible){if(Number(this.oChip.configuration.getParameterValueAsString("isSufficient"))){e.flowWithoutDesignTimeCall()}else{e.flowWithDesignTimeCall()}}},visibleHandler:function(e){if(!e){this.firstTimeVisible=false;sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.comparisionChartODataRef)}if(e){this.refreshHandler(this)}},onInit:function(){const e=this;this.firstTimeVisible=false;this.oDualComparisonView=this.getView();this.oChip=this.oDualComparisonView.getViewData().chip;if(this.oChip.visible){this.oChip.visible.attachVisible(this.visibleHandler.bind(this))}this.system=this.oChip.url.getApplicationSystem();this.oDualComparisonView.oGenericTile.setState(a.Loading);try{sap.ushell.components.tiles.indicatorTileUtils.util.getParsedChip(this.oChip.configuration.getParameterValueAsString("tileConfiguration"),this.oChip.preview.isEnabled(),i=>{e.oConfig=i;if(e.oChip.preview){e.oChip.preview.setTargetUrl(sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(e.oConfig,e.system))}if(e.oChip.preview.isEnabled()){e.setTitle();e._updateTileModel({value:1,size:l.Auto,frameType:"TwoByOne",state:a.Loading,valueColor:s.Good,indicator:o.None,title:"Liquidity Structure",footer:"Current Quarter",description:"Apr 1st 2013 (B$)",data:[{title:"Measure 1",value:1,color:"Good"},{title:"Measure 2",value:2,color:"Good"},{title:"Measure 3",value:3,color:"Good"}]});e.oDualComparisonView.oGenericTile.setState(a.Loaded)}else{e.setTitle();e.oDualComparisonView.oGenericTile.attachPress(()=>{sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(e.comparisionChartODataRef);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(e.oConfig.TILE_PROPERTIES.id,null);window.location.hash=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(e.oConfig,e.system)});if(Number(e.oChip.configuration.getParameterValueAsString("isSufficient"))){sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(e.oConfig.TILE_PROPERTIES.id,e.oConfig);e.flowWithoutDesignTimeCall()}else{e.flowWithDesignTimeCall()}}})}catch(e){this.logError(e)}},onExit:function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.comparisionChartODataRef)}})},true);
//# sourceMappingURL=DualComparison.controller.js.map