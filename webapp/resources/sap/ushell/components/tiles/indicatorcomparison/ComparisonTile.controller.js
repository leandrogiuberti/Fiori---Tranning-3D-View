// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/tiles/generic","sap/m/library","sap/base/Log"],(e,i,t)=>{"use strict";const o=i.DeviationIndicator;const l=i.ValueColor;const s=i.Size;const a=i.LoadState;const n=i.FrameType;const c=e.extend("sap.ushell.components.tiles.indicatorcomparison.ComparisonTile",{onInit:function(){this.KPI_VALUE_REQUIRED=false},_processDataForComparisonChart:function(e,i,t){const o=[];const l={};let s;let a;let n;let c;let T=[];const r=this;let E=null;let u;for(s=0;s<e.results.length;s++){u=e.results[s]}T=sap.ushell.components.tiles.indicatorTileUtils.util.getAllMeasuresWithLabelText(this.oTileApi.url.addSystemToServiceUrl(this.oConfig.EVALUATION.ODATA_URL),this.oConfig.EVALUATION.ODATA_ENTITYSET);for(s=0,n=T.length;s<n;s++){a=T[s];l[a.key]=a.value}const h=r.oConfig.TILE_PROPERTIES.COLUMN_NAMES||r.oConfig.EVALUATION.COLUMN_NAMES;for(s=0;s<h.length;s++){const e={};const i=h[s];e.value=Number(u[i.COLUMN_NAME]);let a=Number(u[i.COLUMN_NAME]);let n=false;const T=r._getEvaluationThresholdMeasures();const p=T?Array.prototype.indexOf.call(T,i.COLUMN_NAME):-1;if(p>-1){n=true}if(r.oConfig.EVALUATION.SCALING==-2&&n){a*=100}const C=r.isCurrencyMeasure(i.COLUMN_NAME);if(t&&t[s]&&u[t[s].name]){E=u[t[s].name]}c=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(a,r.oConfig.EVALUATION.SCALING,r.oConfig.EVALUATION.DECIMAL_PRECISION,C,E);if(r.oConfig.EVALUATION.SCALING==-2&&n){c+=" %"}e.displayValue=c.toString();if(t){if(t[s]&&u[t[s].name]){e.displayValue+=` ${u[t[s].name]}`}}e.color=i.semanticColor;e.title=l[i.COLUMN_NAME]||i.COLUMN_NAME;e.measure=i.COLUMN_NAME;e.isCurM=C;o.push(e)}return o},fetchChartData:function(e,i,o,l){function s(e,i){let t=false;if(e&&e.results&&e.results.length){for(let o=0,l=i.length;o<l&&!t;o++){t=e.results[0][i[o].COLUMN_NAME]!==null}}return t}const a=this;try{const n=this.oConfig.EVALUATION.ODATA_ENTITYSET;const c=this.oConfig.EVALUATION.COLUMN_NAME;let T=c;let r;if(this.oConfig.TILE_PROPERTIES.COLUMN_NAMES){for(r=0;r<this.oConfig.TILE_PROPERTIES.COLUMN_NAMES.length;r++){if(this.oConfig.TILE_PROPERTIES.COLUMN_NAMES[r].COLUMN_NAME!=this.oConfig.EVALUATION.COLUMN_NAME){T=`${T},${this.oConfig.TILE_PROPERTIES.COLUMN_NAMES[r].COLUMN_NAME}`}}}else{for(r=0;r<this.oConfig.EVALUATION.COLUMN_NAMES.length;r++){if(this.oConfig.EVALUATION.COLUMN_NAMES[r].COLUMN_NAME!=this.oConfig.EVALUATION.COLUMN_NAME){T=`${T},${this.oConfig.EVALUATION.COLUMN_NAMES[r].COLUMN_NAME}`}}}const E=sap.ushell.components.tiles.indicatorTileUtils.util.getBoolValue(e);const u=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(a.oConfig.TILE_PROPERTIES.id);let h;if(sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(a.oConfig)){if(u){h=u.Data&&JSON.parse(u.Data)}}const p=a.oTileApi.configuration.getParameterValueAsString("timeStamp");const C=sap.ushell.components.tiles.indicatorTileUtils.util.isCacheValid(a.oConfig.TILE_PROPERTIES.id,p,a.chipCacheTime,a.chipCacheTimeUnit,a.tilePressed);if(h&&!h.rightData||!u||!C&&a.oTileApi.visible.isVisible()||E||i&&a.oTileApi.visible.isVisible()||a.getView().getViewData().refresh){if(a.kpiValueFetchDeferred){a.kpiValueFetchDeferred=false;const e=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.oConfig.EVALUATION_FILTERS,this.oConfig.ADDITIONAL_FILTERS);const i=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(a.oRunTimeODataModel,n,T,null,e,3);this.comparisionChartODataRef=i.model.read(i.uri,null,null,true,e=>{a.kpiValueFetchDeferred=true;let t={};if(i.unit){t.unit=i.unit}if(s(e,a.oConfig.TILE_PROPERTIES.COLUMN_NAMES||a.oConfig.EVALUATION.COLUMN_NAMES)){a.oConfig.TILE_PROPERTIES.FINALVALUE=e;a.oConfig.TILE_PROPERTIES.FINALVALUE=a._processDataForComparisonChart(a.oConfig.TILE_PROPERTIES.FINALVALUE,T.split(",")[0],i.unit);t.data=a.oConfig.TILE_PROPERTIES.FINALVALUE;const l={};a.cacheTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();l.ChipId=a.oConfig.TILE_PROPERTIES.id;l.Data=JSON.stringify(t);l.CacheMaxAge=Number(a.chipCacheTime);l.CacheMaxAgeUnit=a.chipCacheTimeUnit;l.CacheType=1;const s=a.getLocalCache(l);a.updateDatajobScheduled=false;const n=`${a.oConfig.TILE_PROPERTIES.id}data`;let c=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(n);if(c){clearTimeout(c);c=undefined}if(!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(a.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(a.oConfig.TILE_PROPERTIES.id,s);let e=false;if(u){e=true}if(a.chipCacheTime){sap.ushell.components.tiles.indicatorTileUtils.util.writeFrontendCacheByChipAndUserId(a.oTileApi,a.oConfig.TILE_PROPERTIES.id,l,e,e=>{if(e){a.cacheTime=e&&e.CachedTime;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(a.oConfig.TILE_PROPERTIES.id,e);a.setTimeStamp()}if(a.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(a.oConfig)){a.setTimeStamp(a.cacheTime)}})}}else{const e=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(a.oConfig.TILE_PROPERTIES.id);let i;if(e){if(!e.CachedTime){e.CachedTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate()}i=e.Data;if(i){i=JSON.parse(i);i.rightData=t}e.Data=JSON.stringify(i);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(a.oConfig.TILE_PROPERTIES.id,e)}else{i={};i.rightData=t;s.Data=JSON.stringify(i);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(a.oConfig.TILE_PROPERTIES.id,s)}a.cacheWriteData=t}o.call(a,a.oConfig.TILE_PROPERTIES.FINALVALUE)}else if(e.results.length==0){a.oConfig.TILE_PROPERTIES.FINALVALUE=e;if(sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(a.oConfig.TILE_PROPERTIES.id)){t=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(a.oConfig.TILE_PROPERTIES.id);t.data=e}else{t.data=e}sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(a.oConfig.TILE_PROPERTIES.id,t);o.call(a,a.oConfig.TILE_PROPERTIES.FINALVALUE);a.setNoData()}else{sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(a.oConfig.TILE_PROPERTIES.id,{empty:"empty"});a.setNoData()}},e=>{a.kpiValueFetchDeferred=true;if(e&&e.response){t.error(`${e.message} : ${e.request.requestUri}`);l.call(a,e)}})}}else if(u&&u.Data){let e;const i=a.oConfig&&a.oConfig.TILE_PROPERTIES&&a.oConfig.TILE_PROPERTIES.tileType;if(i.indexOf("DT-")==-1){e=u.Data&&JSON.parse(u.Data)}else{e=u.Data&&JSON.parse(u.Data);e=e.rightData}a.cacheTime=u.CachedTime;if(a.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(a.oConfig)){a.setTimeStamp(a.cacheTime)}if(e.data&&e.data.length){a.oConfig.TILE_PROPERTIES.FINALVALUE=e.data;o.call(a,a.oConfig.TILE_PROPERTIES.FINALVALUE)}else{a.oConfig.TILE_PROPERTIES.FINALVALUE=e.data;o.call(a,a.oConfig.TILE_PROPERTIES.FINALVALUE);a.setNoData()}}else{a.setNoData()}}catch(e){a.kpiValueFetchDeferred=true;l.call(a,e)}},doProcess:function(e,i){const t=this;this.setTextInTile();this.fetchChartData(e,i,function(e){this.CALCULATED_KPI_VALUE=e;this._updateTileModel({data:this.CALCULATED_KPI_VALUE});if(t.oConfig.TILE_PROPERTIES.frameType==n.TwoByOne){t.oKpiTileView.oGenericTile.setFrameType(n.TwoByOne);t.getView().getViewData().parentController._updateTileModel(this.getTile().getModel().getData());const e={};e.data=this.CALCULATED_KPI_VALUE;t.getView().getViewData().deferredObj.resolve()}else{t.oKpiTileView.oGenericTile.setFrameType(n.OneByOne);t.oKpiTileView.oGenericTile.removeAllTileContent();t.oKpiTileView.oGenericTile.addTileContent(t.oKpiTileView.oNVConfS);this.oKpiTileView.oGenericTile.setState(a.Loaded)}this.setToolTip(null,this.CALCULATED_KPI_VALUE,"COMP");if(this.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(this.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.util.scheduleFetchDataJob.call(this,this.oTileApi.visible.isVisible())}},this.logError)},doDummyProcess:function(){const e=this;this.setTextInTile();e._updateTileModel({value:8888,size:s.Auto,frameType:n.OneByOne,state:a.Loading,valueColor:l.Error,indicator:o.None,title:"Liquidity Structure",footer:"Current Quarter",description:"Apr 1st 2013 (B$)",data:[{title:"Measure 1",value:1.2,color:"Good"},{title:"Measure 2",value:.78,color:"Good"},{title:"Measure 3",value:1.4,color:"Error"}]});this.oKpiTileView.oGenericTile.setState(a.Loaded)}});return c});
//# sourceMappingURL=ComparisonTile.controller.js.map