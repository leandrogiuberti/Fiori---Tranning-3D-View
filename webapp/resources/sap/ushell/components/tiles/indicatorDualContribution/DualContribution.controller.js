// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/library","sap/ui/thirdparty/jquery","sap/base/Log"],(e,jQuery,i)=>{"use strict";const t=e.ValueColor;const l=e.Size;const o=e.DeviationIndicator;const s=e.LoadState;sap.ui.controller("tiles.indicatorDualContribution.DualContribution",{getTile:function(){return this.oDualContributionView.oGenericTile},_updateTileModel:function(e){const i=this.getTile().getModel().getData();jQuery.extend(i,e);this.getTile().getModel().setData(i);this.getTile().getModel().updateBindings()},setTitle:function(){const e=this;const i=sap.ushell.components.tiles.indicatorTileUtils.util.getTileTitleSubtitle(this.oChip);this._updateTileModel({header:i.title||sap.ushell.components.tiles.indicatorTileUtils.util.getChipTitle(e.oConfig),subheader:i.subTitle||sap.ushell.components.tiles.indicatorTileUtils.util.getChipSubTitle(e.oConfig)})},formSelectStatement:function(e){const i=Object.keys(e);let t="";for(let l=0;l<i.length;l++){if(e[i[l]]!==undefined&&e.fullyFormedMeasure){t+=`,${e[i[l]]}`}}return t},logError:function(e){this.oDualContributionView.oGenericTile.setState(s.Failed);this.oDualContributionView.oGenericTile.setState(s.Failed);sap.ushell.components.tiles.indicatorTileUtils.util.logError(e)},setThresholdValues:function(){const e=this;try{const i={};i.fullyFormedMeasure=this.DEFINITION_DATA.EVALUATION.COLUMN_NAME;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){switch(this.DEFINITION_DATA.EVALUATION.GOAL_TYPE){case"MI":i.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WH","MEASURE");i.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CH","MEASURE");i.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TA","MEASURE");i.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TC","MEASURE");i.fullyFormedMeasure+=e.formSelectStatement(i);break;case"MA":i.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WL","MEASURE");i.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CL","MEASURE");i.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TA","MEASURE");i.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TC","MEASURE");i.fullyFormedMeasure+=e.formSelectStatement(i);break;case"RA":i.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WH","MEASURE");i.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CH","MEASURE");i.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TA","MEASURE");i.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TC","MEASURE");i.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WL","MEASURE");i.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CL","MEASURE");i.fullyFormedMeasure+=e.formSelectStatement(i);break}}else{i.criticalHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CH","FIXED");i.criticalLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CL","FIXED");i.warningHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WH","FIXED");i.warningLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WL","FIXED");i.targetValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TA","FIXED");i.trendValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TC","FIXED")}return i}catch(i){e.logError(i)}},getTrendIndicator:function(e,i){const t=this;e=Number(e);try{let t=o.None;if(e>i){t=o.Down}else if(e<i){t=o.Up}return t}catch(e){t.logError(e)}},_processDataForComparisonChart:function(e,i,t){const l=this.oConfig.TILE_PROPERTIES.semanticMeasure;const o=[];let s;for(let n=0;n<e.results.length;n++){const a=e.results[n];const r={};try{r.title=a[t].toString()}catch(e){r.title=""}r.value=Number(a[i]);let u=Number(a[i]);if(this.oConfig.EVALUATION.SCALING==-2){u*=100}s=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(u,this.oConfig.EVALUATION.SCALING,this.oConfig.EVALUATION.DECIMAL_PRECISION);r.displayValue=s.toString();if(typeof l==="undefined"){r.color="Neutral"}else if(this.oConfig.EVALUATION.GOAL_TYPE==="MA"){if(r.value>a[l]){r.color="Good"}else{r.color="Error"}}else if(this.oConfig.EVALUATION.GOAL_TYPE==="MI"){if(r.value<a[l]){r.color="Good"}else{r.color="Error"}}else{r.color="Neutral"}o.push(r)}return o},fetchKpiValue:function(e,t){const l=this;try{const o=this.oConfig.EVALUATION.ODATA_URL;const s=this.oConfig.EVALUATION.ODATA_ENTITYSET;let n;if(this.oConfig.TILE_PROPERTIES.semanticMeasure){n=`${this.oConfig.EVALUATION.COLUMN_NAME},${this.oConfig.TILE_PROPERTIES.semanticMeasure}`}else{n=this.oConfig.EVALUATION.COLUMN_NAME}let a=this.oConfig.TILE_PROPERTIES.dimension;const r=this.oConfig.EVALUATION_VALUES;const u=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(l.oConfig.TILE_PROPERTIES.id);if(!u){const r=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.oConfig.EVALUATION_FILTERS,this.oConfig.ADDITIONAL_FILTERS);const u={};u["0"]=`${n},asc`;u["1"]=`${n},desc`;u["2"]=`${a},asc`;u["3"]=`${a},desc`;const c=u[this.oConfig.TILE_PROPERTIES.sortOrder||"0"].split(",");const T=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(l.oChip.url.addSystemToServiceUrl(o),s,n,a,r,3);if(this.oConfig.TILE_PROPERTIES.semanticMeasure){T.uri+=`&$top=3&$orderby=${c[0]} ${c[2]}`}else{T.uri+=`&$top=3&$orderby=${c[0]} ${c[1]}`}this.comparisionChartODataRef=T.model.read(T.uri,null,null,true,i=>{if(T.unit[0]){l._updateTileModel({unitContribution:i.results[0][T.unit[0].name]});l.writeData.unitContribution=T.unit[0];l.writeData.unitContribution.name=T.unit[0].name}if(i&&i.results&&i.results.length){a=sap.ushell.components.tiles.indicatorTileUtils.util.findTextPropertyForDimension(l.oChip.url.addSystemToServiceUrl(o),s,a);l.writeData.dimension=a;l.oConfig.TILE_PROPERTIES.FINALVALUE=i;l.oConfig.TILE_PROPERTIES.FINALVALUE=l._processDataForComparisonChart(l.oConfig.TILE_PROPERTIES.FINALVALUE,n.split(",")[0],a);l.writeData.data=i;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(l.oConfig.TILE_PROPERTIES.id,l.writeData);e.call(l,l.oConfig.TILE_PROPERTIES.FINALVALUE)}else if(i.results.length==0){l.oConfig.TILE_PROPERTIES.FINALVALUE=i;l.writeData.data=i;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(l.oConfig.TILE_PROPERTIES.id,l.writeData)}else{t.call(l,"no Response from QueryServiceUri")}},e=>{if(e&&e.response){i.error(`${e.message} : ${e.request.requestUri}`);t.call(l,e)}});const E=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(l.DEFINITION_DATA.EVALUATION_FILTERS,l.DEFINITION_DATA.ADDITIONAL_FILTERS);const C=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(l.oChip.url.addSystemToServiceUrl(o),s,n,null,E);if(C){l.QUERY_SERVICE_MODEL=C.model;l.queryUriForKpiValue=C.uri;l.numericODataReadRef=l.QUERY_SERVICE_MODEL.read(C.uri,null,null,true,i=>{if(i&&i.results&&i.results.length){if(C.unit){l._updateTileModel({unitNumeric:i.results[0][C.unit.name]});l.writeData.unitNumeric=C.unit;l.writeData.unitNumeric.name=C.unit.name}l.writeData.numericData=i;let t="";let o=i.results[0][l.DEFINITION_DATA.EVALUATION.COLUMN_NAME];const s=l.getTrendIndicator(l.setThresholdValues().trendValue,o);if(l.oConfig.EVALUATION.SCALING==-2){o*=100;l.getView().oNumericContent.setFormatterValue(false)}l.DEFINITION_DATA.value=o;t=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(o),l.oConfig.EVALUATION.SCALING,l.oConfig.EVALUATION.DECIMAL_PRECISION);if(l.oConfig.EVALUATION.SCALING==-2){l._updateTileModel({scale:"%"})}l._updateTileModel({value:t.toString(),valueColor:l.DEFINITION_DATA.TILE_PROPERTIES.semanticColorContribution,indicator:s});e.call(l,l.oConfig.TILE_PROPERTIES.FINALVALUE,o)}else{t.call(l,"no Response from QueryServiceUri")}})}}else{const i=l.setThresholdValues();let o;if(u.unitContribution){l._updateTileModel({unitContribution:u.data.results[0][u.unitContribution.name]})}if(u.unitNumeric){l._updateTileModel({unitNumeric:u.numericData.results[0][u.unitNumeric.name]})}if(u.data&&u.data.results&&u.data.results.length){a=u.dimension;l.oConfig.TILE_PROPERTIES.FINALVALUE=u.data;l.oConfig.TILE_PROPERTIES.FINALVALUE=l._processDataForComparisonChart(l.oConfig.TILE_PROPERTIES.FINALVALUE,n.split(",")[0],a);e.call(l,l.oConfig.TILE_PROPERTIES.FINALVALUE)}else if(r.results.length==0){l.oConfig.TILE_PROPERTIES.FINALVALUE=u.data}else{t.call(l,"no Response from QueryServiceUri")}if(u.numericData&&u.numericData.results&&u.numericData.results.length){o=u.numericData.results[0][l.DEFINITION_DATA.EVALUATION.COLUMN_NAME];if(l.oConfig.EVALUATION.SCALING==-2){o*=100;l.getView().oNumericContent.setFormatterValue(false)}const t=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(o),l.oConfig.EVALUATION.SCALING,l.oConfig.EVALUATION.DECIMAL_PRECISION);if(l.oConfig.EVALUATION.SCALING==-2){l._updateTileModel({scale:"%"})}const s=l.getTrendIndicator(i.trendValue,o);l._updateTileModel({value:t.toString(),indicator:s,valueColor:l.DEFINITION_DATA.TILE_PROPERTIES.semanticColorContribution});e.call(l,l.oConfig.TILE_PROPERTIES.FINALVALUE,o)}else{t.call(l,"no Response from QueryServiceUri")}}}catch(e){t.call(l,e)}},flowWithoutDesignTimeCall:function(){const e=this;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);if(this.oChip.visible.isVisible()&&!this.firstTimeVisible){this.firstTimeVisible=true;this.fetchKpiValue(function(i,t){this.CALCULATED_KPI_VALUE=i;if(e.oConfig.TILE_PROPERTIES.frameType=="TwoByOne"){e.oDualContributionView.oGenericTile.setFrameType("TwoByOne");e.oDualContributionView.oGenericTile.removeAllTileContent();e.oDualContributionView.oGenericTile.addTileContent(e.oDualContributionView.oNumericTile);e.oDualContributionView.oGenericTile.addTileContent(e.oDualContributionView.oComparisonTile)}else{e.oDualContributionView.oGenericTile.setFrameType("OneByOne");e.oDualContributionView.oGenericTile.removeAllTileContent();e.oDualContributionView.oGenericTile.addTileContent(e.oDualContributionView.oComparisonTile)}const l=this.CALCULATED_KPI_VALUE;const o=this.DEFINITION_DATA.TILE_PROPERTIES.semanticColorContribution;for(let e=0;e<this.CALCULATED_KPI_VALUE.length;e++){l[e].color=o}this._updateTileModel({data:l});let n=e.setThresholdValues();const a=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(e.oConfig,e.system);e.oDualContributionView.oGenericTile.$().wrap(`<a href ='${a}'></a>`);this.oDualContributionView.oGenericTile.setState(s.Loaded);let r="";if(o=="Error"){r="sb.error"}if(o=="Neutral"){r="sb.neutral"}if(o=="Critical"){r="sb.critical"}if(o=="Good"){r="sb.good"}n=e.setThresholdValues();let u;let c;let T;let E;let C;let h;let A;let g;let I;if(this.CALCULATED_KPI_VALUE&&this.CALCULATED_KPI_VALUE[0]){u=this.CALCULATED_KPI_VALUE[0].title;E=this.CALCULATED_KPI_VALUE[0].value;A=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(this.CALCULATED_KPI_VALUE[0].color)}if(this.CALCULATED_KPI_VALUE&&this.CALCULATED_KPI_VALUE[1]){c=this.CALCULATED_KPI_VALUE[1].title;C=this.CALCULATED_KPI_VALUE[1].value;g=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(this.CALCULATED_KPI_VALUE[1].color)}if(this.CALCULATED_KPI_VALUE&&this.CALCULATED_KPI_VALUE[2]){T=this.CALCULATED_KPI_VALUE[2].title;h=this.CALCULATED_KPI_VALUE[2].value;I=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(this.CALCULATED_KPI_VALUE[2].color)}const p={status:r,actual:t,target:n.targetValue,cH:n.criticalHighValue,wH:n.warningHighValue,wL:n.warningLowValue,cL:n.criticalLowValue};const d={m1:u,v1:E,c1:A,m2:c,v2:C,c2:g,m3:T,v3:h,c3:I};const f=e.oDualContributionView.oGenericTile.getTileContent()[0].getContent();const m=e.oDualContributionView.oGenericTile.getTileContent()[1].getContent();sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(f,"NT",p);sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(m,"CONT",d)},this.logError)}},flowWithDesignTimeCall:function(){const e=this;try{const i=sap.ushell.components.tiles.indicatorTileUtils.cache.getEvaluationById(this.oConfig.EVALUATION.ID);if(i){e.oConfig.EVALUATION_FILTERS=i.EVALUATION_FILTERS;e.flowWithoutDesignTimeCall()}else{sap.ushell.components.tiles.indicatorTileUtils.util.getFilterFromRunTimeService(this.oConfig,i=>{e.oConfig.EVALUATION_FILTERS=i;sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(e.oConfig.TILE_PROPERTIES.id,e.oConfig);e.flowWithoutDesignTimeCall()})}}catch(e){this.logError(e)}},refreshHandler:function(e){if(!e.firstTimeVisible){if(Number(this.oChip.configuration.getParameterValueAsString("isSufficient"))){e.flowWithoutDesignTimeCall()}else{e.flowWithDesignTimeCall()}}},visibleHandler:function(e){if(!e){this.firstTimeVisible=false;sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.comparisionChartODataRef)}if(e){this.refreshHandler(this)}},onInit:function(){const e=this;e.writeData={};this.firstTimeVisible=false;this.oDualContributionView=this.getView();this.oChip=this.oDualContributionView.getViewData().chip;if(this.oChip.visible){this.oChip.visible.attachVisible(this.visibleHandler.bind(this))}this.system=this.oChip.url.getApplicationSystem();this.oDualContributionView.oGenericTile.setState(s.Loading);try{sap.ushell.components.tiles.indicatorTileUtils.util.getParsedChip(this.oChip.configuration.getParameterValueAsString("tileConfiguration"),this.oChip.preview.isEnabled(),i=>{e.oConfig=i;if(e.oChip.preview){e.oChip.preview.setTargetUrl(sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(e.oConfig,e.system))}if(e.oChip.preview.isEnabled()){e.setTitle();e._updateTileModel({value:8888,size:l.Auto,frameType:"TwoByOne",state:s.Loading,valueColor:t.Error,indicator:o.None,title:"US Profit Margin",footer:"Current Quarter",description:"Maximum deviation",data:[{title:"Americas",value:10,color:"Neutral",displayValue:""},{title:"EMEA",value:50,color:"Neutral",displayValue:""},{title:"APAC",value:-20,color:"Neutral",displayValue:""}]});e.oDualContributionView.oGenericTile.setState(s.Loaded)}else{e.setTitle();e.oDualContributionView.oGenericTile.attachPress(()=>{sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(e.comparisionChartODataRef);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(e.oConfig.TILE_PROPERTIES.id,null);window.location.hash=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(e.oConfig,e.system)});if(Number(e.oChip.configuration.getParameterValueAsString("isSufficient"))){sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(e.oConfig.TILE_PROPERTIES.id,e.oConfig);e.flowWithoutDesignTimeCall()}else{e.flowWithDesignTimeCall()}}})}catch(e){this.logError(e)}},onExit:function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.comparisionChartODataRef)}})},true);
//# sourceMappingURL=DualContribution.controller.js.map