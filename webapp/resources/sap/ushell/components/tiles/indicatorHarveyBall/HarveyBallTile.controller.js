// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/model/json/JSONModel","sap/suite/ui/commons/library"],(e,t)=>{"use strict";const i=t.InfoTileValueColor;const a=t.InfoTileSize;const s=t.LoadState;sap.ui.controller("tiles.indicatorHarveyBall.HarveyBallTile",{onInit:function(){this.getView().setModel(new e);this.initializeVariables();this.attachHandlers();this.getVariable("tile").setState(s.Loading);this.readChipConfiguration()},attachHandlers:function(){const e=this;const t=this.getVariable("chip");if(t.visible){t.visible.attachVisible(t=>{if(t){e.onVisible()}else{e.abortAllOpenODataRequests()}})}this.getVariable("tile").attachPress(()=>{e.abortAllOpenODataRequests();const t=e.getVariable("indicatorUtils");e.getVariable("cache").setKpivalueById(e.getVariable("chipId"),null);window.location.hash=t.getNavigationTarget(e.getVariable("evalData"),e.getVariable("system"))})},initializeVariables:function(){this._variables={};this._oDataRequests={};const e=this.getView();const t=e.getViewData();const i=e.oTile;const a=t.chip;this.setVariable("indicatorUtils",sap.ushell.components.tiles.indicatorTileUtils.util);this.setVariable("cache",sap.ushell.components.tiles.indicatorTileUtils.cache);this.setVariable("hasAppeared",false);this.setVariable("chip",a);this.setVariable("tile",i);this.setVariable("tileControl",i.getTileContent()[0].getContent());this.setVariable("configurationString",a.configuration.getParameterValueAsString("tileConfiguration"));this.setVariable("system",a.url.getApplicationSystem())},getVariable:function(e){return this._variables[e]},setVariable:function(e,t){this._variables[e]=t},readChipConfiguration:function(){const e=this;const t=this.getVariable("chip");const i=this.getVariable("indicatorUtils");i.getParsedChip(this.getVariable("configurationString"),a=>{e.setVariable("evalData",a);e.setVariable("chipId",a.TILE_PROPERTIES.id);e.setVariable("tileProperties",a.TILE_PROPERTIES);if(t.preview){t.preview.setTargetUrl(i.getNavigationTarget(a,e.getVariable("system")));e.loadPreviewData();if(t.preview.isEnabled()){e.getVariable("tile").setState(s.Loaded)}else{e.loadActualData()}}})},loadPreviewData:function(){const e=this.getVariable("indicatorUtils").getTileTitleSubtitle(this.getVariable("chip"));this.getView().getModel().setData({fractionValue:34,value:100,size:a.Auto,frameType:"OneByOne",color:"Good",state:s.Loading,header:e.title||this.getVariable("indicatorUtils").getChipTitle(this.getVariable("evalData")),subheader:e.subTitle||this.getVariable("indicatorUtils").getChipSubTitle(this.getVariable("evalData"))})},loadActualData:function(){if(Number(this.getVariable("chip").configuration.getParameterValueAsString("isSufficient"))){this.getVariable("cache").setEvaluationById(this.getVariable("chipId"),this.getVariable("evalData"));this.onEvalFiltersFetched()}else{this.fetchEvalFilters(this.onEvalFiltersFetched)}},registerOpenODataRequest:function(e,t){this._oDataRequests[e]=t},deregisterOpenODataRequest:function(e){delete this._oDataRequests[e]},abortAllOpenODataRequests:function(){for(const e in this._oDataRequests){try{this.getVariable("indicatorUtils").abortPendingODataCalls(this._oDataRequests[e]);delete this._oDataRequests[e]}catch(e){}}},fetchKpiValue:function(e){const t=this;let i;let a;function s(e,s,l,r,o){const n=e.read(s,null,null,true,e=>{t.deregisterOpenODataRequest(l.type);if(e&&e.results&&e.results.length){try{if(l.thresholds&&l.thresholds.length){t._setThresholdValues(e.results[0])}i[l.type]=e.results[0][l.measure];i.unit=i.unit||e.results[0][l.unit]||"";if(--a==0){t.getVariable("cache").setKpivalueById(t.getVariable("chipId"),i);r.call(t,i)}}catch(e){t.logError(e)}}else{o.call(t,"no data")}},e=>{t.deregisterOpenODataRequest(l.type);if(e&&e.response){o.call(t,e.message)}});t.registerOpenODataRequest(l.type,n)}const l=this.getVariable("indicatorUtils");const r=this.getVariable("cache").getKpivalueById(this.getVariable("chipId"));if(r){e.fnS.call(t,r)}else{const r=e.measure1;const o=e.measure2;const n=e.url;const h=e.entitySet;const c=e.filters;const u=e.fractionFilters.concat(c);let V;a=2;u.forEach(e=>{e.value=`${e.value}`;e.valueTo=`${e.valueTo}`});if(e.thresholds&&e.thresholds.length){V=l.prepareQueryServiceUri(this.getVariable("chip").url.addSystemToServiceUrl(n),h,`${r},${e.thresholds}`,null,c)}else{V=l.prepareQueryServiceUri(this.getVariable("chip").url.addSystemToServiceUrl(n),h,r,null,c)}const g=l.prepareQueryServiceUri(this.getVariable("chip").url.addSystemToServiceUrl(n),h,o,null,u);const f=V.unit[0];const b=g.unit[0];i={kpiValue:null,fractionValue:null,unit:""};if(V){s(V.model,V.uri,{measure:r,type:"kpiValue",unit:f,thresholds:e.thresholds},e.fnS,e.fnE)}if(g){s(g.model,g.uri,{measure:o,type:"fractionValue",unit:b},e.fnS,e.fnE)}if(!(V&&g)){e.fnE.call(t,"Error Preparing Query Service URI")}}},_setThresholdValues:function(e){const t=this.getVariable("oThreshold");let i;if(t){if(this.getVariable("evalData").EVALUATION.VALUES_SOURCE=="RELATIVE"){if(t.TA.COLUMN_NAME){t.TA.VALUE=parseFloat(e[t.TA.COLUMN_NAME]);for(i in t){if(!t[i].COLUMN_NAME){t[i].VALUE=t.TA.VALUE*t[i].VALUE/100}}}}else{for(i in t){if(t[i].COLUMN_NAME){t[i].VALUE=parseFloat(e[t[i].COLUMN_NAME])}}}}this.setVariable("oThreshold",t)},getThresholdObject:function(){let e=this.getVariable("oThreshold");if(!e){const t=this.getVariable("evalData").EVALUATION_VALUES;e={};for(let i=0,a=t.length;i<a;i++){e[t[i].TYPE]={VALUE:parseFloat(t[i].FIXED),COLUMN_NAME:t[i].COLUMN_NAME}}this.setVariable("oThreshold",e)}return e},hasSomeValue:function(){let e=true;if(arguments.length){for(let t=0,i=arguments.length;t<i;t++){if(!(arguments[t]||arguments[t]=="0")){e=false;break}}}else{e=false}return e},getTrendColor:function(e){let t="Neutral";let a;let s;let l;let r;let o;let n;if(this.getVariable("tileProperties").isFractionMeasure){a=this.getThresholdObject();s=this.getVariable("evalData").EVALUATION.GOAL_TYPE;if(s=="MA"){l=a.WL;o=a.CL;if(this.hasSomeValue(l,o)){t="Good";if(e<o.VALUE){t="Error"}else if(e<=l.VALUE){t="Critical"}}}else if(s=="MI"){r=a.WH;n=a.CH;if(this.hasSomeValue(r,n)){t="Error";if(e<r.VALUE){t="Good"}else if(e<=n.VALUE){t="Critical"}}}else{l=a.WL;o=a.CL;r=a.WH;n=a.CH;if(this.hasSomeValue(r,n,o,l)){if(e<=o.VALUE||e>=r.VALUE){t="Error"}else if(l.VALUE>=e&&e>=o.VALUE||n.VALUE>=e&&e>=r.VALUE){t="Critical"}else{t="Good"}}}}return i[t]},_getThresholdMeasures:function(){const e=[];const t=this.getThresholdObject();for(const i in t){if(t[i].COLUMN_NAME){e.push(t[i].COLUMN_NAME)}}return e},onEvalFiltersFetched:function(){const e=this;if(this.getVariable("chip").visible.isVisible()&&!this.getVariable("hasAppeared")){try{const t=this.getVariable("evalData");const i=t.EVALUATION.ODATA_URL;const a=t.EVALUATION.ODATA_ENTITYSET;const s=this.getVariable("tileProperties");let l=[];const r=this.getVariable("indicatorUtils").prepareFilterStructure(t.EVALUATION_FILTERS,t.ADDITIONAL_FILTERS);const o=t.EVALUATION.COLUMN_NAME;let n=o;let h=[];if(s.isFractionMeasure){n=s.harveyTotalMeasure;h=this._getThresholdMeasures()}else{l=this.getVariable("indicatorUtils").prepareFilterStructure(s.harveyFilters||l)}this.setVariable("totalMeasure",n);this.setVariable("fractionMeasure",o);this.fetchKpiValue({measure1:n,measure2:o,entitySet:a,thresholds:h,url:i,filters:r,fractionFilters:l,fnS:function(t){t.kpiValue=Number(t.kpiValue);t.fractionValue=Number(t.fractionValue);e.setVariable("kpiValue",t.kpiValue);e.setVariable("fractionValue",t.fractionValue);e.onKpiValueFetched(t.kpiValue,t.unit,t.fractionValue)},fnE:this.logError});e.setVariable("hasAppeared",true)}catch(e){this.logError(e)}}},fetchEvalFilters:function(e){const t=this;try{const i=this.getVariable("cache").getEvaluationById(this.getVariable("chipId"));if(i){this.getVariable("evalData").EVALUATION_FILTERS=i.EVALUATION_FILTERS;e()}else{const i=this.getVariable("indicatorUtils").getFilterFromRunTimeService(this.getVariable("evalData"),i=>{t.deregisterOpenODataRequest("kpiFilterRequest");t.getVariable("evalData").EVALUATION_FILTERS=i;t.getVariable("cache").setEvaluationById(t.getVariable("chipId"),t.getVariable("evalData"));e.call(t)},function(e){this.logError(e);t.deregisterOpenODataRequest("kpiFilterRequest")});this.registerOpenODataRequest("kpiFilterRequest",i)}}catch(e){this.logError(e)}},onKpiValueFetched:function(e,t,i,a){const l=this.getVariable("indicatorUtils");let r=e;let o=i;const n=this.getVariable("evalData");const h=n.EVALUATION.SCALING;if(h==-2){r*=100;o*=100}let c=this.isACurrencyMeasure(this.getVariable("totalMeasure"));r=l.getLocaleFormattedValue(Number(r),h,null,c,t);c=this.isACurrencyMeasure(this.getVariable("fractionMeasure"));o=l.getLocaleFormattedValue(Number(o),h,null,c,t);this.getView().getModel().setProperty("/totalLabel",`${r} ${t}`);this.getView().getModel().setProperty("/fractionLabel",`${o} ${a}`);this.getView().getModel().setProperty("/color",this.getTrendColor(i));this.getView().getModel().setProperty("/value",e);this.getView().getModel().setProperty("/fractionValue",i);const u=l.getNavigationTarget(this.getVariable("evalData"),this.getVariable("system"));this.getVariable("tile").$().wrap(`<a href ='${u}'></a>`);this.getVariable("tile").setState(s.Loaded)},logError:function(e){this.getVariable("tile").setState(s.Failed);this.getVariable("indicatorUtils").logError(e,this.getVariable("tile"))},onVisible:function(){if(!this.getVariable("hasAppeared")){if(Number(this.getVariable("chip").configuration.getParameterValueAsString("isSufficient"))){this.onEvalFiltersFetched()}else{this.fetchEvalFilters(this.onEvalFiltersFetched)}}},onExit:function(){this.abortAllOpenODataRequests()}})});
//# sourceMappingURL=HarveyBallTile.controller.js.map