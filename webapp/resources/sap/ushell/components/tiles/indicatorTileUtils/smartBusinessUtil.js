// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/model/FilterOperator","sap/ui/model/analytics/odata4analytics","sap/ui/core/format/NumberFormat","sap/ui/model/odata/ODataModel","sap/base/Log","sap/ui/thirdparty/jquery","sap/base/util/UriParameters","sap/ushell/utils/UrlParsing","sap/ushell/services/CrossApplicationNavigation"],(e,t,i,n,s,jQuery,r,a,l)=>{"use strict";const o=t.ParameterizationRequest;const c=t.QueryResultRequest;const u=t.Model.ReferenceByModel;const f=t.Model;sap=sap||{};sap.ushell=sap.ushell||{};sap.ushell.components=sap.ushell.components||{};sap.ushell.components.tiles.indicatorTileUtils=sap.ushell.components.tiles.indicatorTileUtils||{};sap.ushell.components.tiles.indicatorTileUtils.util=sap.ushell.components.tiles.indicatorTileUtils.util||{};sap.ushell.components.tiles.indicatorTileUtils.util=function(t,a){const g={};const T={ANN:"years",WEE:"weeks",DAY:"days",HUR:"hours",MIN:"minutes"};const h={};const m={};return{getScheduledJob:function(e){return h[e]},setScheduledJob:function(e,t){h[e]=t},isCallInProgress:function(e){return m[e]},setUnsetCallInProgress:function(e,t){m[e]=t},getTimeUnitMap:function(){return T},getHanaUser:function(){return authObject.userName},addSystemToServiceUrl:function(e,t){s.info("Hana Adapter --\x3e Add System to Service Url");if(sap.ushell&&sap.ushell.Container){if(t){sap.ushell.Container.getServiceAsync("URLParsing").then(i=>{sap.ui.model.odata.ODataUtils.setOrigin(e,{alias:t})})}else{sap.ushell.Container.getServiceAsync("URLParsing").then(t=>{sap.ui.model.odata.ODataUtils.setOrigin(e)})}}return e},getODataModelByServiceUri:function(e){e=this.addSystemToServiceUrl(e);if(!g[e]){const t=new n(e,{loadMetadataAsync:true,json:true});g[e]=t}return g[e]},getEdmType:function(e,t){let i=null;if(e instanceof n){i=e}else{i=this.getODataModelByServiceUri(e)}if(i&&i.getServiceMetadata()){const e=i.getServiceMetadata();const n=e.dataServices.schema[0].entityType;if(n){for(let e=0;e<n.length;e++){const i=n[e];const s=i.property;for(let e=0;e<s.length;e++){const i=s[e];if(i.name==t){return i.type}}}}}return null},getMillisecond:function(e,t){let i;switch(t){case"seconds":i=e*1e3;break;case"minutes":i=e*60*1e3;break;case"hours":i=e*60*60*1e3;break;case"days":i=e*24*60*60*1e3;break;case"weeks":i=e*7*24*60*60*1e3;break;case"months":i=e*4*7*24*60*60*1e3;break;case"years":i=e*12*4*7*24*60*60*1e3;break}return i},getUTCDate:function(){const e=new Date;return e},isCacheValid:function(e,t,i,n,s){const r=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(e);if(!r){return false}else if(!(i&&Number(i))){return true}const a=this.getMillisecond(i,T[n]);let l;if(r.CachedTime instanceof Date){l=r.CachedTime&&r.CachedTime.getTime()}else{l=r.CachedTime&&parseInt(r.CachedTime.substr(6),10)}const o=this.getUTCDate();return l>=t&&a>=o-l&&!s},getMantissaLength:function(e){const t=e.toString();let i=0;if(e<0){i=1}if(t.indexOf(".")===-1){return e<0?t.length-1:t.length}return t.substring(i,t.indexOf(".")).length},getLocaleFormattedValue:function(e,t,n,s,r){sap.ui.require("sap.ui.core.format.NumberFormat");s=s||false;r=r||null;if(s){return i.getCurrencyInstance({style:"short",showMeasure:false}).format(e,r)}let a=2;const l={style:"short"};let o;if(!(n==-1||n==null)){l.shortDecimals=Number(n);l.minFractionDigits=Number(n);l.maxFractionDigits=Number(n)}let c=i.getInstance(l);if(t==-2){if(e>9999){o="????"}else if(e>-.001&&e<0||e<.001&&e>0){o="0"}else{if(e.toString().indexOf(".")!=-1){o=Number(e).toFixed(4-e.toString().indexOf("."))}else{o=Number(e)}o=c.format(o)}}else if(n==-1||n==null){const t=this.getMantissaLength(e);if(!(t%3)){a=1}if(t%3===1){a=3}if(t%3===2){a=2}if(Math.abs(e)%Math.pow(10,t-1)==0){a=0}else if(Math.abs(e)%Math.pow(10,t-1)<6*Math.pow(10,t-4)){a=0}c=i.getInstance({style:"short",shortDecimals:a});o=c.format(e)}else{o=c.format(e)}return o},getPlatform:function(e){return(new r(window.location.href).get("sb_metadata")||e||"HANA").toUpperCase()},getTileTitleSubtitle:function(e){const t={};if(e.bag&&e.bag.getBagIds()&&e.bag.getBagIds().length){t.title=e.bag.getBag("sb_tileProperties").getText("title")||e.bag.getBag("sb_tileProperties").getProperty("title")||e.preview.getTitle();t.subTitle=e.bag.getBag("sb_tileProperties").getText("description")||e.bag.getBag("sb_tileProperties").getProperty("description")||e.preview.getDescription()}else{t.title=e.preview.getTitle();t.subTitle=e.preview.getDescription()}return t},scheduleFetchDataJob:function(e){let t;if(this.getView().getViewName().indexOf("DualTile")!==-1){t=this.oKpiTileView.oConfig}else{t=this.oConfig}const i=`${t.TILE_PROPERTIES.id}data`;let n=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(i);if(n){clearTimeout(n);n=undefined}const s=sap.ushell.components.tiles.indicatorTileUtils.util.getTimeUnitMap();const r=sap.ushell.components.tiles.indicatorTileUtils.util.getCachingTime(t);const a=sap.ushell.components.tiles.indicatorTileUtils.util.getCachingTimeUnit(t);const l=sap.ushell.components.tiles.indicatorTileUtils.util.getMillisecond(r,s[a]);let o;if(this.cacheTime instanceof Date){o=this.cacheTime}else{o=new Date(parseInt(this.cacheTime.substr(6),10))}let c=l-(sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate()-o);if(c<=0){c=0}else if(c>2147483646){c=2147483646}if(!e){c=3e5}if(this.getView().getViewName().indexOf("DualTile")!==-1){n=setTimeout(this.refreshPress.bind(this),c)}else{n=setTimeout(this.refreshHandler.bind(this,false,true),c);sap.ushell.components.tiles.indicatorTileUtils.util.setScheduledJob(i,n)}this.updateDatajobScheduled=true},scheduleTimeStampJob:function(){const e=`${this.oConfig.TILE_PROPERTIES.id}time`;let t=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(e);let i;if(t){clearTimeout(t);t=undefined}if(this.cacheTime instanceof Date){i=this.cacheTime}else{i=new Date(parseInt(this.cacheTime.substr(6),10),13)}const n=sap.ushell.components.tiles.indicatorTileUtils.util.getTimeDifference(sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate()-i);t=setTimeout(this.setTimeStamp.bind(this,this.cacheTime),n.timer);sap.ushell.components.tiles.indicatorTileUtils.util.setScheduledJob(e,t);this.updateTimeStampjobScheduled=true},getBoolValue:function(e){let t=false;if(typeof e==="boolean"&&e){t=true}return t},getSeconds:function(e){return e/1e3},getMinutes:function(e){return this.getSeconds(e)/60},getHours:function(e){return this.getMinutes(e)/60},getDays:function(e){return this.getHours(e)/24},getWeeks:function(e){return this.getDays(e)/7},getMonths:function(e){return this.getWeeks(e)/4},getYears:function(e){return this.getMonths(e)/12},getTimeDifference:function(e){const t={};if(e){const i=this.getMinutes(e);const n=this.getHours(e);const s=this.getDays(e);if(i<5){t.time=0;t.unit="minutes";t.timer=Math.round(this.getMillisecond(5-i,"minutes"))}else if(i>=5&&i<60){if(i<10){t.time=5}else{t.time=i-i%10}t.unit="minutes";t.timer=Math.round(this.getMillisecond(10-i%10,"minutes"))}else if(n>=1&&n<24){t.unit="hours";t.time=n-n%1;t.timer=Math.round(this.getMillisecond(1-n%1,"hours"))}else if(s>=1&&s<2){t.unit="days";t.time=s-s%1;t.timer=Math.round(this.getMillisecond(1-s%1,"days"))}else{t.unit="days";t.time=s-s%1;t.timer=this.getMillisecond(2,"days")}}else{t.timer=6e3;t.unit="days";t.timer=2e3}return t},getCachingTime:function(e){return e.CACHINGTIME&&Number(e.CACHINGTIME)||e.TILE_PROPERTIES.cachingTime&&Number(e.TILE_PROPERTIES.cachingTime)},getCachingTimeUnit:function(e){return e.CACHINGUNIT||e.TILE_PROPERTIES.cachingTimeUnit},getFrontendCacheQuery:function(e,t,i,n){let r;try{let e=n.url.addSystemToServiceUrl("/sap/opu/odata/SSB/SMART_BUSINESS_RUNTIME_SRV");e=sap.ushell.components.tiles.indicatorTileUtils.util.cacheBustingMechanism(e);r=this.getODataModelByServiceUri(e);e="/CacheParameters(P_CacheType=1)/Results";return{oModel:r,uri:e}}catch(e){s.error("FrontEnd cache Metadata failed");return null}},isDualTile:function(e){const t=e&&e.TILE_PROPERTIES&&e.TILE_PROPERTIES.tileType;if(t.indexOf("DT-")==-1){return false}return true},writeFrontendCacheByChipAndUserId:function(e,t,i,n,r){function a(e){s.info("cache write successFully");r(e)}function l(){s.error("cache update failed");r(null)}try{let t=e.url.addSystemToServiceUrl("/sap/opu/odata/SSB/SMART_BUSINESS_RUNTIME_SRV/");t=sap.ushell.components.tiles.indicatorTileUtils.util.cacheBustingMechanism(t);const n=this.getODataModelByServiceUri(t);const s="/CacheData";n.create(s,i,{async:true,success:a,error:l})}catch(e){s.error(e)}},getKpiChipsOnPage:function(e,t){const i=[];sap.ushell.Container.getServiceAsync("FlpLaunchPage").then(n=>{n.getGroups().done(n=>{if(n&&n instanceof Array&&n.length){s.info("Group Chip fetch")}t(e,i)})})},getFrontendCache:function(e,t){const i=this;let n=sap.ushell.components.tiles.indicatorTileUtils.cache.getFrontEndCacheDeferredObject(t.url.getApplicationSystem());let r;if(n){r=n}else{r=jQuery.Deferred()}const a=e&&e.TILE_PROPERTIES&&e.TILE_PROPERTIES.id;const l=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(a);if(l){n.resolve(true)}else if(n){return n.promise()}else{sap.ushell.components.tiles.indicatorTileUtils.cache.setFrontEndCacheDefferedObject(t.url.getApplicationSystem(),r);n=r;this.getKpiChipsOnPage(a,(e,r)=>{if(r){const a=i.getFrontendCacheQuery(r,sap.ushell.Container.getUser().getId(),r,t);if(a){const t=a.oModel;const i=a.uri;let r=false;t.read(i,null,null,true,t=>{if(t&&t.results&&t.results instanceof Array&&t.results.length){jQuery.each(t.results,(e,t)=>{sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.ChipId,t)})}if(sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(e)){r=true}n.resolve(r)},e=>{if(e&&e.response){s.error(`${e.message} : ${e.request.requestUri}`)}n.reject()})}else{n.reject()}}else{n.resolve(false)}})}return n.promise()},getModelerRuntimeServiceModel:function(){let e="/sap/hba/r/sb/core/odata/runtime/SMART_BUSINESS.xsodata";e=sap.ushell.components.tiles.indicatorTileUtils.util.cacheBustingMechanism(e);return this.getODataModelByServiceUri(e)},getSapFontErrorCode:function(){return String.fromCharCode(57521)},getSapFontBusyCode:function(){return String.fromCharCode(57842)},prepareFilterStructure:function(e,t){const i=[];if(t){e=e.concat(t)}for(let t=0;t<e.length;t++){const n={};n.comparator=e[t].OPERATOR;n.filterPropertyName=e[t].NAME;if(e[t].ID){n.id=e[t].ID}n.type=e[t].TYPE;n.value=e[t].VALUE_1;n.valueTo=e[t].VALUE_2;i.push(n)}return i},getODataModelByServiceUriFromChipAPI:function(e,t){e=t.url.addSystemToServiceUrl(e);if(!g[e]){const t=new n(e,true);g[e]=t}return g[e]},cacheBustingMechanism:function(e){if(window["sap-ushell-config"].cacheBusting.cacheBusterToken){const t=window["sap-ushell-config"].cacheBusting&&window["sap-ushell-config"].cacheBusting.cacheBusterToken;e=`${e}?_=${t}`}return e},getRunTimeUri:function(e){let t="/sap/hba/r/sb/core/odata/runtime/SMART_BUSINESS.xsodata";let i="/sap/opu/odata/SSB/SMART_BUSINESS_RUNTIME_SRV";if(e.toUpperCase()=="HANA"){if(window["sap-ushell-config"].cacheBusting){t=sap.ushell.components.tiles.indicatorTileUtils.util.cacheBustingMechanism(t)}return t}if(window["sap-ushell-config"].cacheBusting){i=sap.ushell.components.tiles.indicatorTileUtils.util.cacheBustingMechanism(i)}return i},getFilterFromRunTimeService:function(e,t,i,n){const s=e.TILE_PROPERTIES.sb_metadata;const r=this.getODataModelByServiceUriFromChipAPI(this.getRunTimeUri(s),t);const a="ID eq '#EVALUATIONID'".replace("#EVALUATIONID",e.EVALUATION.ID);const l=r.read("/EVALUATION_FILTERS",null,{$filter:a},true,function(e){let t=[];if(e.results.length){t=e.results}i.call(this,t)},n);return l},_getOData4AnalyticsObject:function(e){let t=null;if(e instanceof n){t=e}else if(typeof e==="string"){t=this.getODataModelByServiceUri(e)}else{throw new Error(`Invalid Input to Create ODataModel Object : ${e}`)}const i=new f(u(t));return i},findTextPropertyForDimension:function(e,t,i){try{const n=this._getOData4AnalyticsObject(e);const s=n.findQueryResultByName(t);const r=s.findDimensionByName(i);if(r.getTextProperty()){return r.getTextProperty().name}return i}catch(e){s.error(`Error Fetching Text Property for ${i} : ${e.toString()}`)}},getEvalValueMeasureName:function(e,t,i){const n=e.EVALUATION_VALUES;for(let e=0;e<n.length;e++){if(n[e].TYPE==t){if(i==="FIXED"){return n[e].FIXED}return n[e].COLUMN_NAME}}},getSemanticColorName:function(e){let t="";if(e=="Error"){t="sb.error"}if(e=="Neutral"){t="sb.neutral"}if(e=="Critical"){t="sb.critical"}if(e=="Good"){t="sb.good"}return t},setTooltipInTile:function(e,t,i){let n="";const s=sap.ushell.components.tiles.utils.getResourceBundle();if(t=="NT"||t=="DT"){if(i.status){n+=`${s.getText("sb.status")}: ${s.getText(i.status)}\n`}if(i.actual){n+=`${s.getText("sb.actual")}: ${i.actual}\n`}if(i.target){n+=`${s.getText("sb.target")}: ${i.target}\n`}if(i.cH){n+=`${s.getText("sb.ch")}: ${i.cH}\n`}if(i.wH){n+=`${s.getText("sb.wh")}: ${i.wH}\n`}if(i.wL){n+=`${s.getText("sb.wl")}: ${i.wL}\n`}if(i.cL){n+=`${s.getText("sb.cl")}: ${i.cL}\n`}}if(t=="CONT"||t=="COMP"){if(i.measure&&t=="CONT"){if(i&&i.contributionTile.contributionTile&&i.contributionTile.contributionTile[1]==="asc"){n+=`${s.getText("sb.bottomn")}: ${i.contributionTile[0]}\n`}else if(i&&i.contributionTile.contributionTile&&i.contributionTile.contributionTile.length){n+=`${s.getText("sb.topn")}: ${i.contributionTile[0]}\n`}}if(i.m1&&(i.v1==undefined||i.v1==null?false:i.v1.toString())&&i.c1){n+=`${i.m1}: ${i.v1} ${s.getText(i.c1)}\n`}if(i.m2&&(i.v2==undefined||i.v2==null?false:i.v2.toString())&&i.c2){n+=`${i.m2}: ${i.v2} ${s.getText(i.c2)}\n`}if(i.m3&&(i.v3==undefined||i.v3==null?false:i.v3.toString())&&i.c3){n+=`${i.m3}: ${i.v3} ${s.getText(i.c3)}\n`}}if(e&&e.setTooltip){e.setTooltip(n)}},_getFormattedTileProperties:function(e){e=e||{};const t=["sb_metadata","sb_navigation","sb_catalog"];let i=false;for(let n=0;!i&&n<t.length;n++){i=i||new r(window.location.href).get(t[n])||e[t[n]]}e.sb_metadata=(new r(window.location.href).get("sb_metadata")||e.sb_metadata||"HANA").toLowerCase();e.sb_navigation=(new r(window.location.href).get("sb_navigation")||e.sb_navigation||"abap").toLowerCase();e.sb_catalog=(new r(window.location.href).get("sb_catalog")||e.sb_catalog||"HANA").toLowerCase();e.isPlatformInfoPresent=i;return e},getEvaluationDetailsFromRunTimeService:function(e,t,i,n){const s=this.getODataModelByServiceUri(this.getRunTimeUri(t));const r="ID eq '#EVALUATIONID'".replace("#EVALUATIONID",i);s.read(e,null,{$filter:r},true,function(e){let t=[];if(e.results.length){t=e.results}n.call(this,t)})},getParsedChip:function(e,t,i){try{const n={};const s=JSON.parse(e);const r=JSON.parse(s.TILE_PROPERTIES).evaluationId||"";if(s.TILE_PROPERTIES){const e=JSON.parse(s.TILE_PROPERTIES);if(e&&(e.instanceId||e.catalogId)){return false}}const a=this;if(s.blankTile){n.BLANKTILE=s.blankTile}if(s.cachingTime){n.CACHINGTIME=s.cachingTime}if(s.cachingTimeUnit){n.CACHINGUNIT=s.cachingTimeUnit}if(s.TAGS){n.TAGS=JSON.parse(s.TAGS)}if(s.ADDITIONAL_FILTERS){n.ADDITIONAL_FILTERS=JSON.parse(s.ADDITIONAL_FILTERS)}if(s.ADDITIONAL_APP_PARAMETERS){n.ADDITIONAL_APP_PARAMETERS=JSON.parse(s.ADDITIONAL_APP_PARAMETERS)}n.TILE_PROPERTIES=this._getFormattedTileProperties(JSON.parse(s.TILE_PROPERTIES));const l=n.TILE_PROPERTIES.sb_metadata;if(s.EVALUATION_FILTERS){n.EVALUATION_FILTERS=JSON.parse(s.EVALUATION_FILTERS);if(s.EVALUATION_VALUES){n.EVALUATION_VALUES=JSON.parse(s.EVALUATION_VALUES);if(s.EVALUATION){n.EVALUATION=JSON.parse(s.EVALUATION);if(i){i(n)}else{return n}}else if(!t){a.getEvaluationDetailsFromRunTimeService("/EVALUATIONS",l,r,e=>{n.EVALUATION=e;if(i){i(n)}else{return n}})}else if(i){i(n)}else{return n}}else if(!t){a.getEvaluationDetailsFromRunTimeService("/EVALUATION_VALUES",l,r,e=>{n.EVALUATION_VALUES=e;if(s.EVALUATION){n.EVALUATION=JSON.parse(s.EVALUATION);if(i){i(n)}else{return n}}else{a.getEvaluationDetailsFromRunTimeService("/EVALUATIONS",l,r,e=>{n.EVALUATION=e;if(i){i(n)}else{return n}})}})}else if(i){i(n)}else{return n}}else if(t){if(i){i(n)}else{return n}}else{a.getEvaluationDetailsFromRunTimeService("/EVALUATION_FILTERS",l,r,e=>{n.EVALUATION_FILTERS=e;if(s.EVALUATION_VALUES){n.EVALUATION_VALUES=JSON.parse(s.EVALUATION_VALUES);if(s.EVALUATION){n.EVALUATION=JSON.parse(s.EVALUATION);if(i){i(n)}else{return n}}else{a.getEvaluationDetailsFromRunTimeService("/EVALUATIONS",l,r,e=>{n.EVALUATION=e;if(i){i(n)}else{return n}})}}else{a.getEvaluationDetailsFromRunTimeService("/EVALUATION_VALUES",l,r,e=>{n.EVALUATION_VALUES=e;if(s.EVALUATION){n.EVALUATION=JSON.parse(s.EVALUATION);if(i){i(n)}else{return n}}else{a.getEvaluationDetailsFromRunTimeService("/EVALUATIONS",l,r,e=>{n.EVALUATION=e;if(i){i(n)}else{return n}})}})}})}}catch(e){return false}},getNavigationTarget:function(e,t){let i;const n={};n.evaluationId=e.EVALUATION.ID;n.chipId=e.TILE_PROPERTIES.id;if(t){n["sap-system"]=t}n.tileType=e.TILE_PROPERTIES.tileType;if(e.TILE_PROPERTIES.dimension){n.dimension=e.TILE_PROPERTIES.dimension}if(e.TILE_PROPERTIES.storyId){n.storyId=e.TILE_PROPERTIES.storyId}if(e.TILE_PROPERTIES.apfConfId){n["sap-apf-configuration-id"]=e.TILE_PROPERTIES.apfConfId}if(e.TILE_PROPERTIES.isPlatformInfoPresent){n.sb_metadata=e.TILE_PROPERTIES.sb_metadata;n.sb_navigation=e.TILE_PROPERTIES.sb_navigation;n.sb_catalog=e.TILE_PROPERTIES.sb_catalog}if(e.ADDITIONAL_APP_PARAMETERS){for(i in e.ADDITIONAL_APP_PARAMETERS){if(e.ADDITIONAL_APP_PARAMETERS.hasOwnProperty(i)){if(e.ADDITIONAL_APP_PARAMETERS[i].constructor==Array){const t=e.ADDITIONAL_APP_PARAMETERS[i];for(let e=0;e<t.length;e++){n[i]=t[e]}}else{n[i]=e.ADDITIONAL_APP_PARAMETERS[i]}}}}let s=l&&l.hrefForExternal({target:{semanticObject:e.TILE_PROPERTIES.semanticObject,action:e.TILE_PROPERTIES.semanticAction},params:n})||"";if(e.ADDITIONAL_FILTERS){const t=e.ADDITIONAL_FILTERS;let i="&";for(let e=0;e<t.length;e++){if(t[e].OPERATOR==="EQ"){i=`${i}/${t[e].NAME}=${t[e].VALUE_1}`}}s+=i}return s},getChipTitle:function(e){let t="";if(e){const i=e.EVALUATION||{};t=i.INDICATOR_TITLE||""}return t},getstringifyTileConfig:function(e){const t={};t.EVALUATION=JSON.stringify(e.EVALUATION);t.EVALUATION_FILTERS=JSON.stringify(e.EVALUATION_FILTERS);t.EVALUATION_VALUES=JSON.stringify(e.EVALUATION_VALUES);t.TILE_PROPERTIES=JSON.stringify(e.TILE_PROPERTIES);return JSON.stringify(t)},getChipSubTitle:function(e){let t="";if(e){const i=e.EVALUATION||{};t=i.TITLE||""}return t},getAllMeasures:function(e,t){let i=[];try{const n=this._getOData4AnalyticsObject(e);const s=n.findQueryResultByName(t);i=s.getAllMeasureNames()}catch(e){s.error(`Error Fetching All Measures : ${e.toString()}`)}return i},getFormattingMetadata:function(e,t,i){const s={};s._hasCurrency=false;s._hasSapText=false;let r=null;if(e instanceof n){r=u(e)}else{const t=this.getODataModelByServiceUri(e);r=u(t)}const a=new f(r);const l=a.findQueryResultByName(t);const o=l.getAllMeasures();if(o[i]){const e=o[i]._oTextProperty&&o[i]._oTextProperty.name?o[i]._oTextProperty.name:"";if(e!=""){s._hasSapText=true;s._sapTextColumn=e}else if(o[i].hasOwnProperty("_oUnitProperty")){const e=o[i]._oUnitProperty.extensions;for(let t=0;t<o[i]._oUnitProperty.extensions.length;t++){if(e[t].name==="semantics"&&e[t].value==="currency-code"){s._hasCurrency=true;s._currencyColumn=o[i]._oUnitProperty.name}}}}return s},getAllDimensions:function(e,t){function i(e,t){let i=0;let n=0;const s=[];while(i<e.length&&n<t.length){if(e[i]<t[n]){i++}else if(e[i]>t[n]){n++}else{s.push(e[i]);i++;n++}}return s}let n=[];let r=[];try{const s=this._getOData4AnalyticsObject(e);const a=s.findQueryResultByName(t);const l=a.getEntityType();r=l.getFilterablePropertyNames();n=a.getAllDimensionNames();if(r&&r.length){n=i(r.sort(),n.sort())}}catch(e){s.error(`Error Fetching All Dimesions : ${e.toString()}`)}return n},prepareQueryServiceUri:function(t,i,r,a,l,g,T){function h(e){return e.replace(/'/g,"''")}let m=null;function p(e){let t=e.toJSON();const i=t.charAt(t.length-1).toUpperCase();if(i.charCodeAt(0)>=65&&i.charCodeAt(0)<=90){t=t.slice(0,-1)}return t}function d(e){if(e){try{if(e==+e){e=window.parseInt(e)}const t=new Date(e);const i=t.getTime();if(isNaN(i)){return e}return p(t)}catch(e){}}return e}try{let p=null;if(t instanceof n){p=u(t)}else{const e=this.getODataModelByServiceUri(t);p=u(e)}const E=new f(p);const A=E.findQueryResultByName(i);const I=new c(A);if(r){I.setMeasures(r.split(","));I.includeMeasureRawFormattedValueUnit(null,true,true,true)}if(a){if(typeof a==="string"){m=a;m=m.split(",")}for(let e=0;e<m.length;e++){I.addToAggregationLevel([m[e]]);const t=A.getAllDimensions();if(t[m[e]].getTextProperty()!=null){I.includeDimensionKeyTextAttributes([m[e]],true,true,null)}}}if(l&&l.length){const i=[];const n=[];let r;for(let e=0,t=l.length;e<t;e++){r=l[e];if(r.type==="PA"){n.push(r)}else if(r.type==="FI"){i.push(r)}}if(i.length){const n=I.getFilterExpression();for(let s=0,a=i.length;s<a;s++){r=i[s];if(this.getEdmType(t,r.filterPropertyName)=="Edm.DateTime"){r.value=d(r.value);r.valueTo=d(r.valueTo)}if(r.comparator==e.BT){n.addCondition(r.filterPropertyName,r.comparator,h(r.value),r.valueTo)}else{const e=r.value.split(",");for(let t=0,i=e.length;t<i;t++){n.addCondition(r.filterPropertyName,r.comparator,h(e[t].replace(/\^\|/g,",")),null)}}}}if(n.length){if(A.getParameterization()){const e=new o(A.getParameterization());const t=A.getParameterization();let i;let r;let a;let l;let c;for(let o=0,u=n.length;o<u;o++){i=n[o];r=t.findParameterByName(i.filterPropertyName);if(r.isIntervalBoundary()===true&&r.isLowerIntervalBoundary()===true){c=r.getPeerIntervalBoundaryParameter();for(let e=0,t=n.length;e<t;e++){if(n[e].filterPropertyName===c.getName()){l=h(n[e].value);break}}a=h(i.value);if(l){e.setParameterValue(i.filterPropertyName,a,l)}}else if(r.isIntervalBoundary()===true&&r.isLowerIntervalBoundary()===false){s.info("Future development")}else{e.setParameterValue(i.filterPropertyName,h(i.value))}}I.setParameterizationRequest(e)}}}let S=I.getURIToQueryResultEntries();if(g&&g.length){S=`${S}&$orderby=`;for(let e=0,t=g.length;e<t;e++){const t=g[e].sortOrder||"asc";if(t){S+=`${g[e].element} ${t},`}}S=S.slice(0,S.length-1)}if(T){S=`${S}&$top=${T}`}const O=A.getAllMeasures();const N=[];for(let e=0;e<r.split(",").length;e++){N.push(O[r.split(",")[e]].getUnitProperty())}return{uri:S,model:E.getODataModel(),unit:N}}catch(e){s.error(`Error Preparing Query Service Uri using OData4Analytics Library : ${e.toString()}`);if(arguments.length){s.error("Arguments Passed to this function");s.error(`${arguments[0]},${arguments[1]},${arguments[2]},${arguments[3]}`)}else{s.error("NO Arguments passed to this function")}return null}},getAllEntitySet:function(e){let t=[];try{const i=this._getOData4AnalyticsObject(e);t=i.getAllQueryResultNames()}catch(e){s.error(`Error fetching Enity Set : ${e.toString()}`)}return t},getAllMeasuresWithLabelText:function(e,i){const n=[];try{const s=this._getOData4AnalyticsObject(e);const r=s.findQueryResultByName(i);const a=r.getAllMeasureNames();for(let e=0;e<a.length;e++){const i=a[e];t.oMeasure=r.findMeasureByName(i);n.push({key:i,value:oMeasure.getLabelText()})}}catch(e){s.error(`Error Fetching All Measures : ${e.toString()}`)}return n},getAllDimensionsWithLabelText:function(e,t){const i=[];try{const n=this._getOData4AnalyticsObject(e);const s=n.findQueryResultByName(t);const r=s.getAllDimensionNames();for(let e=0;e<r.length;e++){const t=r[e];const n=s.findDimensionByName(t);let a=null;if(n.getTextProperty()!=null){a=n.getTextProperty().name}i.push({key:t,value:n.getLabelText(),textProperty:a})}}catch(e){s.error(`Error Fetching All Dimesions : ${e.toString()}`)}return i},getAllInputParams:function(e,t){let i=[];try{const n=this._getOData4AnalyticsObject(e);const s=n.findQueryResultByName(t);if(s.getParameterization()){const e=s.getParameterization();i=e.getAllParameterNames()}}catch(e){s.error(`Error Fetching Input Params : ${e.toString()}`)}return i},getAllInputParamsWithFlag:function(e,t){const i=[];try{const n=this._getOData4AnalyticsObject(e);const s=n.findQueryResultByName(t);if(s.getParameterization()){const e=s.getParameterization();const t=e.getAllParameterNames();for(let n=0;n<t.length;n++){const s=t[n];const r=e.findParameterByName(s);i.push({name:s,optional:r.isOptional()})}}}catch(e){s.error(`Error Fetching Input Params : ${e.toString()}`)}return i},formatOdataObjectToString:function(e){if(e&&e.constructor==Object){if(e.__edmType=="Edm.Time"){const t=e.ms;const i=Math.floor(t/1e3%60);const n=Math.floor(t/6e4%60);const s=Math.floor(t/36e5%24);return`${s}H${n}M${i}S`}}return e},generateCombinations:function(e){function t(e,t){while(t.length<e){t=`0${t}`}return t}let i=Math.pow(2,e.length);const n=[];let s=0;while(i>1){let r=(i-1).toString(2);r=t(e.length,r);n[s]=[];for(let t=0;t<r.length;t++){if(Number(r[t])){n[s].push(e[t])}}i--;s++}return n},logError:function(e,t){if(e=="no data"&&t){const e=sap.ushell.components.tiles.utils.getResourceBundle();t.setFailedText(e.getText("sb.noData"))}s.error(e.toString())},numberOfLeadingZeros:function(e){e=String(e);let t=0;const i=e.indexOf(".");if(i==-1){return 0}if(Number(e.split(".")[0])!=0){return 0}let n=i+1;while(e[n++]=="0"){++t}return t},formatValue:function(e,t,i){i=i||3;const n={3:"K",6:"M",9:"B",12:"T",0:""};n["-3"]="m";n["-6"]="u";n["-9"]="n";n["-12"]="t";n["-2"]="%";let s;let r;const a=Number(e).toPrecision(i);const l=this.numberOfLeadingZeros(a);if(l>0&&t<0){s=a*Math.pow(10,l+i);r=-(l+i)}else{s=Number(a.split("e")[0]);r=Number(a.split("e")[1])||0}if(!e&&e!=0){return{value:"",unitPrefix:""}}let o;if(t>=0){if(r%3!=0){if(r%3==2){if(r+1==t){r=r+1;s=s/10}else{r=r-2;s=s*100}}else if(r+2==t){r=r+2;s=s/100}else{r--;s=s*10}}else if(r==15){s=s*1e3;r=12}}else if(t=="-2"){o=this.formatValue(e*100,0)}else if(r>=0&&e<10&&t=="-3"){s=e*Math.pow(10,3);r=-3}else if(r>=0){return this.formatValue(e,0)}else{r=Math.abs(r);t=Math.abs(t);if(t>r){s=s/Math.pow(10,r%3);r=r-r%3}else{const e=r-t;s=s/Math.pow(10,e);r=r-e}r=0-r}s+="";if(t=="-2"){const e=o.unitPrefix==""?Number(`${o.value}`).toFixed(4-`${o.value}`.indexOf(".")):Number(`${o.value}`).toFixed(3-`${o.value}`.indexOf("."));return{value:Number(e),unitPrefix:o.unitPrefix+n[-2]}}s=Number(s).toFixed(4-s.indexOf("."));return{value:Number(s),unitPrefix:n[r]}},isSmartbusinessChipAndCachable:function(e){const t=this.getParsedChip(e&&e.getConfigurationParameter("tileConfiguration"));return t&&t.TILE_PROPERTIES&&t.TILE_PROPERTIES.tileType&&this.getCachingTime(t)},getHanaClient:function(){let e;function t(t,i,n){e=t.sessionClient;sap.ushell.components.tiles.indicatorTileUtils.cache.setCacheHanaClient(e);sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED.resolve(e)}function i(e,t,i){s.error(e.responseText);s.error("session client call failed");sap.ushell.components.tiles.indicatorTileUtils.cache.setCacheHanaClient(null);sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED.reject()}const n=sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED||jQuery.Deferred();const r=sap.ushell.components.tiles.indicatorTileUtils.cache.getCacheHanaClient();if(r!=undefined){e=r;sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED.resolve(e)}else if(sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED){return sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED.promise()}else{sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED=n;jQuery.ajax({type:"GET",async:false,dataType:"json",url:"/sap/hba/r/sb/core/logic/GetSessionClient.xsjs",success:t,error:i})}return sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED.promise()},abortPendingODataCalls:function(e){try{if(e){e.abort()}}catch(e){this.logError(e)}}}}(window,jQuery);sap.ushell.components.tiles.indicatorTileUtils.cache=function(){const e={};const t={};const i="HANA_CLIENT";return{getCacheHanaClient:function(){return e[i]},setCacheHanaClient:function(t){e[i]=t},getEvaluationByChipId:function(t){if(e[t]){return e[t]}return null},getEvaluationById:function(e){return this.getEvaluationByChipId(e)},setEvaluationById:function(t,i){e[t]=i},getFrontEndCacheDeferredObject:function(t){if(e[t]){return e[t]}return null},setFrontEndCacheDefferedObject:function(t,i){e[t]=i},getKpivalueById:function(e){if(t[e]){return t[e]}return null},setKpivalueById:function(e,i){t[e]=i}}}();return{}},true);
//# sourceMappingURL=smartBusinessUtil.js.map