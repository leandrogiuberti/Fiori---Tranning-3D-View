// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/tiles/generic","sap/m/library","sap/base/Log"],(e,i,t)=>{"use strict";const o=i.DeviationIndicator;const l=i.ValueColor;const s=i.Size;const a=i.LoadState;const n=i.FrameType;const c=e.extend("sap.ushell.components.tiles.indicatorcontribution.ContributionTile",{onInit:function(){this.KPI_VALUE_REQUIRED=false},_processDataForComparisonChart:function(e,i,t,o){const l=this.oConfig.TILE_PROPERTIES.semanticColorContribution;const s=[];let a;let n;for(let c=0;c<e.results.length;c++){const r=e.results[c];const T={};try{T.title=r[t].toString()}catch(e){T.title=""}T.value=Number(r[i]);let u=Number(r[i]);if(this.oConfig.EVALUATION.SCALING==-2){u*=100}const E=this.isCurrencyMeasure(i);n=r[o];a=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(u,this.oConfig.EVALUATION.SCALING,this.oConfig.EVALUATION.DECIMAL_PRECISION,E,n);T.displayValue=a.toString();if(typeof l==="undefined"){T.color="Neutral"}else{T.color=l}if(T&&o){T[o]=n}s.push(T)}return s},fetchChartData:function(e,i,o,l){const s=this;try{const a=this.oConfig.EVALUATION.ODATA_ENTITYSET;let n;s.setThresholdValues();if(this.oConfig.TILE_PROPERTIES.semanticMeasure){n=`${this.oConfig.EVALUATION.COLUMN_NAME},${this.oConfig.TILE_PROPERTIES.semanticMeasure}`}else{n=this.oConfig.EVALUATION.COLUMN_NAME}let c=null;let r=this.oConfig.TILE_PROPERTIES.dimension;const T=sap.ushell.components.tiles.indicatorTileUtils.util.getBoolValue(e);const u=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(s.oConfig.TILE_PROPERTIES.id);let E;if(sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(s.oConfig)){if(u){E=u.Data&&JSON.parse(u.Data)}}const h=s.oTileApi.configuration.getParameterValueAsString("timeStamp");const p=sap.ushell.components.tiles.indicatorTileUtils.util.isCacheValid(s.oConfig.TILE_PROPERTIES.id,h,s.chipCacheTime,s.chipCacheTimeUnit,s.tilePressed);if(E&&!E.rightData||!u||!p&&s.oTileApi.visible.isVisible()||T||i&&s.oTileApi.visible.isVisible()||s.getView().getViewData().refresh){if(s.kpiValueFetchDeferred){s.kpiValueFetchDeferred=false;const e=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.oConfig.EVALUATION_FILTERS,this.oConfig.ADDITIONAL_FILTERS);const i={};i["0"]=`${n},asc`;i["1"]=`${n},desc`;i["2"]=`${r},asc`;i["3"]=`${r},desc`;const T=i[this.oConfig.TILE_PROPERTIES.sortOrder||"0"].split(",");const E=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(s.oRunTimeODataModel,a,n,r,e,3);if(this.oConfig.TILE_PROPERTIES.semanticMeasure){E.uri+=`&$top=3&$orderby=${T[0]} ${T[2]}`}else{E.uri+=`&$top=3&$orderby=${T[0]} ${T[1]}`}this.comparisionChartODataRef=E.model.read(E.uri,null,null,true,e=>{s.kpiValueFetchDeferred=true;let i={};if(e&&e.results&&e.results.length){if(E.unit[0]){s._updateTileModel({unit:e.results[0][E.unit[0].name]});c=E.unit[0].name;i.unit=E.unit[0];i.unit.name=E.unit[0].name}r=sap.ushell.components.tiles.indicatorTileUtils.util.findTextPropertyForDimension(s.oRunTimeODataModel,a,r);i.dimension=r;s.oConfig.TILE_PROPERTIES.FINALVALUE=e;s.oConfig.TILE_PROPERTIES.FINALVALUE=s._processDataForComparisonChart(s.oConfig.TILE_PROPERTIES.FINALVALUE,n.split(",")[0],r,c);i.data=s.oConfig.TILE_PROPERTIES.FINALVALUE;i.isCurM=s.isACurrencyMeasure(s.oConfig.EVALUATION.COLUMN_NAME);const t={};s.cacheTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();t.ChipId=s.oConfig.TILE_PROPERTIES.id;t.Data=JSON.stringify(i);t.CacheMaxAge=Number(s.chipCacheTime);t.CacheMaxAgeUnit=s.chipCacheTimeUnit;t.CacheType=1;const l=s.getLocalCache(t);s.updateDatajobScheduled=false;const T=`${s.oConfig.TILE_PROPERTIES.id}data`;let h=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(T);if(h){clearTimeout(h);h=undefined}if(!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(s.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(s.oConfig.TILE_PROPERTIES.id,l);let e=false;if(u){e=true}if(s.chipCacheTime){sap.ushell.components.tiles.indicatorTileUtils.util.writeFrontendCacheByChipAndUserId(s.oTileApi,s.oConfig.TILE_PROPERTIES.id,t,e,e=>{if(e){s.cacheTime=e&&e.CachedTime;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(s.oConfig.TILE_PROPERTIES.id,e)}if(s.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(s.oConfig)){s.setTimeStamp(s.cacheTime)}})}}else{const e=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(s.oConfig.TILE_PROPERTIES.id);let t;if(e){if(!e.CachedTime){e.CachedTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate()}t=e.Data;if(t){t=JSON.parse(t);if(s.oKpiTileView.getViewName()=="tiles.indicatornumeric.NumericTile"){t.leftData=i}else{t.rightData=i}}e.Data=JSON.stringify(t);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(s.oConfig.TILE_PROPERTIES.id,e)}else{t={};t.rightData=i;l.Data=JSON.stringify(t);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(s.oConfig.TILE_PROPERTIES.id,l)}s.cacheWriteData=i}o.call(s,s.oConfig.TILE_PROPERTIES.FINALVALUE)}else if(e.results.length==0){s.oConfig.TILE_PROPERTIES.FINALVALUE=e;if(sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(s.oConfig.TILE_PROPERTIES.id)){i=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(s.oConfig.TILE_PROPERTIES.id);i.data=e}else{i.data=e}sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(s.oConfig.TILE_PROPERTIES.id,i);o.call(s,s.oConfig.TILE_PROPERTIES.FINALVALUE);s.setNoData()}else{sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(s.oConfig.TILE_PROPERTIES.id,{empty:"empty"});s.setNoData()}},e=>{s.kpiValueFetchDeferred=true;if(e&&e.response){t.error(`${e.message} : ${e.request.requestUri}`);l.call(s,e)}})}}else if(u&&u.Data){let e;const i=s.oConfig&&s.oConfig.TILE_PROPERTIES&&s.oConfig.TILE_PROPERTIES.tileType;if(i.indexOf("DT-")==-1){e=u.Data&&JSON.parse(u.Data)}else{e=u.Data&&JSON.parse(u.Data);e=e.rightData}s.cacheTime=u.CachedTime;if(s.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(s.oConfig)){s.setTimeStamp(s.cacheTime)}if(e.data&&e.data.length){if(e.unit){s._updateTileModel({unit:e.data[0][e.unit.name]})}r=e.dimension;s.oConfig.TILE_PROPERTIES.FINALVALUE=e.data;o.call(s,s.oConfig.TILE_PROPERTIES.FINALVALUE)}else if(e&&e.data&&e.data instanceof Array&&e.data.length==0){s.oConfig.TILE_PROPERTIES.FINALVALUE=e.data;o.call(s,s.oConfig.TILE_PROPERTIES.FINALVALUE);s.setNoData()}else{s.setNoData()}}else{s.setNoData()}}catch(e){s.kpiValueFetchDeferred=true;l.call(s,e)}},doProcess:function(e,i){const t=this;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);this.setTextInTile();this.fetchChartData(e,i,function(e){this.CALCULATED_KPI_VALUE=e;this._updateTileModel({data:this.CALCULATED_KPI_VALUE});if(t.oConfig.TILE_PROPERTIES.frameType==n.TwoByOne){t.oKpiTileView.oGenericTile.setFrameType(n.TwoByOne);t.oKpiTileView.oGenericTile.removeAllTileContent();t.getView().getViewData().parentController._updateTileModel(this.getTile().getModel().getData());t.getView().getViewData().deferredObj.resolve()}else{t.oKpiTileView.oGenericTile.setFrameType(n.OneByOne);t.oKpiTileView.oGenericTile.removeAllTileContent();t.oKpiTileView.oGenericTile.addTileContent(t.oKpiTileView.oNVConfS);this.oKpiTileView.oGenericTile.setState(a.Loaded)}this.setToolTip(null,this.CALCULATED_KPI_VALUE,"CONT");if(this.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(this.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.util.scheduleFetchDataJob.call(this,this.oTileApi.visible.isVisible())}},this.logError)},doDummyProcess:function(){const e=this;e.setTextInTile();e._updateTileModel({value:8888,size:s.Auto,frameType:n.OneByOne,state:a.Loading,valueColor:l.Error,indicator:o.None,title:"US Profit Margin",footer:"Current Quarter",description:"Maximum deviation",data:[{title:"Americas",value:10,color:"Neutral"},{title:"EMEA",value:50,color:"Neutral"},{title:"APAC",value:-20,color:"Neutral"}]});this.oKpiTileView.oGenericTile.setState(a.Loaded)}});return c});
//# sourceMappingURL=ContributionTile.controller.js.map