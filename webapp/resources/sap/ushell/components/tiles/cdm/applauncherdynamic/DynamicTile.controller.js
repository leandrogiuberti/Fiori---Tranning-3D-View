// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ushell/components/tiles/utils","sap/ui/core/format/NumberFormat","sap/ushell/Config","sap/ushell/utils/WindowUtils","sap/ui/model/json/JSONModel","sap/m/library","sap/ushell/library","sap/base/Log","sap/base/util/merge","sap/ushell/utils/DynamicTileRequest","sap/ushell/utils","sap/ushell/utils/UrlParsing","sap/ushell/EventHub","sap/ushell/Container","sap/ushell/navigation/NavigationState"],(e,t,i,r,o,s,n,a,l,u,p,c,f,d,h,m)=>{"use strict";const g=n.GenericTileScope;const b=n.DeviationIndicator;const v=n.ValueColor;const y=n.FrameType;const _=a.DisplayFormat;const D=a.AppType;const R="sap.ushell.components.tiles.cdm.applauncherdynamic.DynamicTile";const w="<RESET>";const P={title:"",subtitle:"",icon:"",info:"",infoState:v.Neutral,targetURL:"",number_value:"...",number_unit:"",number_factor:"",number_state_arrow:b.None,number_value_state:v.Neutral};return e.extend(R,{_aDoables:[],timer:null,iLastTimeoutStart:0,oDataRequest:null,bShouldNotRefreshDataAfterInit:false,_getConfiguration:function(e){const t={};let i;t.configuration=e.configuration;t.properties=e.properties;t.properties.info=t.properties.info||P.info;t.properties.number_value=t.properties.preview?1234:P.number_value;t.properties.number_value_state=P.number_value_state;t.properties.number_state_arrow=P.number_state_arrow;t.properties.number_factor=P.number_factor;t.properties.number_unit=t.properties.numberUnit||P.number_unit;const o=t.configuration["sap-system"];let s=t.properties.targetURL;if(s&&o){if(f.isIntentUrl(s)){i=f.parseShellHash(s);if(!i.params){i.params={}}i.params["sap-system"]=o;s=`#${f.constructShellHash(i)}`}else{s+=`${s.indexOf("?")<0?"?":"&"}sap-system=${o}`}t.properties.targetURL=s}t.properties.configSizeBehavior=r.last("/core/home/sizeBehavior");t.properties.wrappingType=r.last("/core/home/wrappingType");switch(t.properties.displayFormat){case _.Flat:t.properties.frameType=y.OneByHalf;break;case _.FlatWide:t.properties.frameType=y.TwoByHalf;break;case _.StandardWide:t.properties.frameType=y.TwoByOne;break;default:{t.properties.frameType=y.OneByOne}}t.originalProperties=u({},e.properties);return t},onInit:function(){const e=this.getView();const t=new s;const i=e.getViewData();const o=i.properties;t.setData(this._getConfiguration(i));const n=r.last("/core/contentProviders/providerInfo/enabled");const a=r.last("/core/contentProviders/providerInfo/showContentProviderInfoOnVisualizations");t.setProperty("/properties/showContentProviderInfoInTooltip",n);t.setProperty("/properties/showContentProviderInfoOnVisualizations",n&&a);if(n){this._aDoables.push(r.on("/core/contentProviders/providerInfo/showContentProviderInfoOnVisualizations").do(e=>{t.setProperty("/properties/showContentProviderInfoOnVisualizations",e)}))}e.setModel(t);this._aDoables.push(r.on("/core/home/sizeBehavior").do(e=>{t.setProperty("/properties/configSizeBehavior",e)}));if(o.preview){this.previewHandler(true)}},refreshHandler:function(){this.loadData(0,true)},visibleHandler:function(e){if(e){if(!this.oDataRequest||this.timer===null){this.initRequestInterval()}}else{this.stopRequests()}},editModeHandler:function(e){const t=e?g.ActionMore:g.Display;this.getView().getModel().setProperty("/properties/scope",t)},sizeBehaviorHandler:function(e){this.getView().getModel().setProperty("/properties/customSizeBehavior",e)},previewHandler:function(e){const t=this.getView();const i=t.getModel();if(e){const e=t.getViewData();const r=u({},e,{properties:{preview:true}});const o=this._getConfiguration(r);const s=u({},o.properties,{customSizeBehavior:i.getProperty("/properties/customSizeBehavior"),configSizeBehavior:i.getProperty("/properties/configSizeBehavior")});i.setProperty("/properties",s);return}i.setProperty("/properties/preview",false)},updateVisualPropertiesHandler:function(e){const t=this.getView().getModel().getProperty("/properties");const i=this.getView().getModel().getProperty("/originalProperties");if(c.isDefined(e.title)){t.title=e.title;i.title=e.title}if(c.isDefined(e.subtitle)){t.subtitle=e.subtitle;i.subtitle=e.subtitle}if(c.isDefined(e.icon)){t.icon=e.icon;i.icon=e.icon}if(c.isDefined(e.targetURL)){t.targetURL=e.targetURL;i.targetURL=e.targetURL}if(c.isDefined(e.info)){t.info=e.info;i.info=e.info}this.getView().getModel().refresh()},stopRequests:function(){if(this.timer){clearTimeout(this.timer);this.timer=null}if(this.oDataRequest){this.oDataRequest.abort()}},onPress:function(e){if(m.isNavigationRunning()){return}if(e.getSource().getScope&&e.getSource().getScope()===g.Display){const e=this.getView().getModel().getProperty("/properties/targetURL");const t=this.getView().getModel().getProperty("/properties/title");if(!e){return}d.emit("UITracer.trace",{reason:"LaunchApp",source:"Tile",data:{targetUrl:e}});if(e[0]==="#"){hasher.setHash(e)}else{const i=r.last("/core/shell/enableRecentActivity")&&r.last("/core/shell/enableRecentActivityLogging");if(i){const i={title:t,appType:D.URL,url:e,appId:e};h.getRendererInternal("fiori2").logRecentActivity(i)}o.openURL(e,"_blank")}}},initRequestInterval:function(){const e=this.getView().getModel();let t=e.getProperty("/configuration/serviceRefreshInterval");if(!t||t==="0"){t=0;if(this.oDataRequest){this.bShouldNotRefreshDataAfterInit=true}}else if(t<10){const i=e.getProperty("/configuration/serviceUrl");l.warning(`Refresh Interval ${t} seconds for service URL ${i} is less than 10 seconds, which is not supported. Increased to 10 seconds automatically.`,null,R);t=10}this.loadData(t,false)},loadData:function(e,t){if(!t&&this.bShouldNotRefreshDataAfterInit){return}const i=this.getView().getModel();const r=i.getProperty("/properties/preview");const o=i.getProperty("/configuration/serviceUrl");if(r){l.info("Tile in preview mode",R);return}if(!o){l.error("No service URL given!",R);this._setTileIntoErrorState();return}const s=e*1e3-(Date.now()-this.iLastTimeoutStart);if(!t&&!this.timer&&s>0){l.info(`Started timeout to call ${o} again in ${Math.ceil(s/1e3)} seconds`,null,R);this.timer=setTimeout(this.loadData.bind(this,e,false),c.sanitizeTimeoutDelay(s));return}if(!this.oDataRequest||this.oDataRequest.sUrl!==o){if(this.oDataRequest){this.oDataRequest.destroy()}const e=i.getProperty("/properties/contentProviderId");const t={dataSource:i.getProperty("/properties/dataSource")};this.oDataRequest=new p(o,this.successHandlerFn.bind(this),this.errorHandlerFn.bind(this),e,t)}else if(this.oDataRequest){this.oDataRequest.refresh()}if(e>0){l.info(`Started timeout to call ${o} again in ${e} seconds`,null,R);this.iLastTimeoutStart=Date.now();this.timer=setTimeout(this.loadData.bind(this,e,false),c.sanitizeTimeoutDelay(e*1e3))}},successHandlerFn:function(e){this.updatePropertiesHandler(e)},errorHandlerFn:function(e){let t=e&&e.message?e.message:e;const i=this.getView().getModel().getProperty("/configuration/serviceUrl");if(e.statusText==="Abort"||e.aborted===true){l.info(`Data request from service ${i} was aborted`,null,R);this.bShouldNotRefreshDataAfterInit=false}else{if(e.response){t+=` - ${e.response.statusCode} ${e.response.statusText}`}l.error(`Failed to update data via service ${i}: ${t}`,null,R);this._setTileIntoErrorState()}},_setTileIntoErrorState:function(){const e=t.getResourceBundle();this.updatePropertiesHandler({number:"???",info:e.getText("dynamic_data.error")})},_normalizeNumber:function(e,t,r,o){let s;if(isNaN(e)){s=e}else{const t=i.getFloatInstance({maxFractionDigits:o});if(!r){const t=Math.abs(e);if(t>=1e9){r="B";e/=1e9}else if(t>=1e6){r="M";e/=1e6}else if(t>=1e3){r="K";e/=1e3}}s=t.format(e)}let n=s;const a=n[t-1];t-=a==="."||a===","?1:0;n=n.substring(0,t);return{displayNumber:n,numberFactor:r}},updatePropertiesHandler:function(e){const t=this.getView().getModel().getProperty("/originalProperties");const o=this.getView().getModel().getProperty("/properties");const s=[{dataField:"title",modelField:"title"},{dataField:"subtitle",modelField:"subtitle"},{dataField:"icon",modelField:"icon"},{dataField:"info",modelField:"info"},{dataField:"infoState",modelField:"infoState"},{dataField:"targetURL",modelField:"targetURL"},{dataField:"stateArrow",modelField:"number_state_arrow"},{dataField:"numberState",modelField:"number_value_state"},{dataField:"numberUnit",modelField:"number_unit"},{dataField:"numberFactor",modelField:"number_factor"}];s.forEach(i=>{const r=e[i.dataField];const s=!r;const n=P[i.modelField];if(s){o[i.modelField]=t[i.modelField]||n}else if(this._isResetValue(r)){o[i.modelField]=n}else{o[i.modelField]=r}});o.number_value=!isNaN(e.number)?e.number:P.number_value;o.number_digits=e.numberDigits>=0?e.numberDigits:4;const n=[];if(e.targetParams){n.push(e.targetParams)}if(e.results){let t;let i;let r=0;e.results.forEach(e=>{i=e.number||0;if(typeof i==="string"){i=parseFloat(i)}r+=i;t=e.targetParams;if(t){n.push(t)}});o.number_value=r}if(n.length>0){const e=o.targetURL.indexOf("?")!==-1?"&":"?";o.targetURL+=e+n.join("&")}if(!isNaN(e.number)){if(typeof e.number==="string"){e.number=e.number.trim()}const t=this._shouldProcessDigits(e.number,e.numberDigits);const r=o.icon?4:5;if(e.number&&e.number.toString().length>=r||t){const t=this._normalizeNumber(e.number,r,e.numberFactor,e.numberDigits);o.number_factor=t.numberFactor;o.number_value=t.displayNumber}else{const t=i.getFloatInstance({maxFractionDigits:r});o.number_value=t.format(e.number)}}o.configSizeBehavior=r.last("/core/home/sizeBehavior");this.getView().getModel().refresh()},_shouldProcessDigits:function(e,t){let i;e=typeof e!=="string"?e.toString():e;if(e.indexOf(".")!==-1){i=e.split(".")[1].length;if(i>t){return true}}return false},_getLeanUrl:function(e){return o.getLeanURL(e)},_formatValueColor:function(e){if(e==="Positive"){return v.Good}if(e==="Negative"){return v.Error}return v[e]||v.Neutral},_getValueColor:function(e){const t=this._formatValueColor(e);if(t===v.Neutral){return v.None}return t},_isResetValue:function(e){if(typeof e!=="string"){return false}return e===w},onExit:function(){if(this.oDataRequest){this.stopRequests();this.oDataRequest.destroy()}this._aDoables.forEach(e=>{e.off()});this._aDoables=[]}})},true);
//# sourceMappingURL=DynamicTile.controller.js.map