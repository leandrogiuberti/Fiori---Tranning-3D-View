// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/model/json/JSONModel","sap/m/library","sap/ui/thirdparty/jquery"],(e,i,jQuery)=>{"use strict";const t=i.DeviationIndicator;const l=i.ValueColor;const o=i.LoadState;sap.ui.controller("tiles.indicatorDualDeviation.DualDeviation",{logError:function(e){this.oDualDeviationView.oGenericTile.setState(o.Failed);this.oDualDeviationView.oGenericTile.setState(o.Failed);sap.ushell.components.tiles.indicatorTileUtils.util.logError(e)},getThresholdsObjAndColor:function(e){try{const i={};i.arrObj=[];i.returnColor=l.Neutral;const t=this.DEFINITION_DATA.EVALUATION.GOAL_TYPE;let o;let a;let s;let r;if(t==="MI"){s=Number(e.criticalHighValue)||0;r=Number(e.warningHighValue)||0;if(s&&r){s=window.parseFloat(s);r=window.parseFloat(r);i.arrObj.push({value:s,color:l.Error});i.arrObj.push({value:r,color:l.Critical});if(this.CALCULATED_KPI_VALUE<r){i.returnColor=l.Good}else if(this.CALCULATED_KPI_VALUE<=s){i.returnColor=l.Critical}else{i.returnColor=l.Error}}}else if(t==="MA"){a=Number(e.criticalLowValue)||0;o=Number(e.warningLowValue)||0;if(a&&o){a=window.parseFloat(a);o=window.parseFloat(o);i.arrObj.push({value:a,color:l.Error});i.arrObj.push({value:o,color:l.Critical});if(this.CALCULATED_KPI_VALUE<a){i.returnColor=l.Error}else if(this.CALCULATED_KPI_VALUE<=o){i.returnColor=l.Critical}else{i.returnColor=l.Good}}}else{s=Number(e.criticalHighValue)||0;r=Number(e.warningHighValue)||0;a=Number(e.criticalLowValue)||0;o=Number(e.warningLowValue)||0;if(o&&r&&a&&a){s=window.parseFloat(s);r=window.parseFloat(r);o=window.parseFloat(o);a=window.parseFloat(a);i.arrObj.push({value:s,color:l.Error});i.arrObj.push({value:r,color:l.Critical});i.arrObj.push({value:o,color:l.Critical});i.arrObj.push({value:a,color:l.Error});if(this.CALCULATED_KPI_VALUE<a||this.CALCULATED_KPI_VALUE>s){i.returnColor=l.Error}else if(this.CALCULATED_KPI_VALUE>=a&&this.CALCULATED_KPI_VALUE<=o||this.CALCULATED_KPI_VALUE>=r&&this.CALCULATED_KPI_VALUE<=s){i.returnColor=l.Critical}else{i.returnColor=l.Good}}}return i}catch(e){this.logError(e)}},getTrendIndicator:function(e,i){const l=this;e=Number(e);try{let l=t.None;if(e>i){l=t.Down}else if(e<i){l=t.Up}return l}catch(e){l.logError(e)}},getTile:function(){return this.oDualDeviationView.oGenericTile},_updateTileModel:function(e){const i=this.getTile().getModel().getData();jQuery.extend(i,e);this.getTile().getModel().setData(i)},formSelectStatement:function(e){const i=Object.keys(e);let t="";for(let l=0;l<i.length;l++){if(e[i[l]]!==undefined&&e.fullyFormedMeasure){t+=`,${e[i[l]]}`}}return t},setThresholdValues:function(){const e=this;const i={};i.fullyFormedMeasure=this.DEFINITION_DATA.EVALUATION.COLUMN_NAME;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){switch(this.DEFINITION_DATA.EVALUATION.GOAL_TYPE){case"MI":i.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WH","MEASURE");i.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CH","MEASURE");i.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TA","MEASURE");i.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TC","MEASURE");i.fullyFormedMeasure+=e.formSelectStatement(i);break;case"MA":i.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WL","MEASURE");i.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CL","MEASURE");i.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TA","MEASURE");i.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TC","MEASURE");i.fullyFormedMeasure+=e.formSelectStatement(i);break;case"RA":i.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WH","MEASURE");i.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CH","MEASURE");i.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TA","MEASURE");i.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TC","MEASURE");i.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WL","MEASURE");i.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CL","MEASURE");i.fullyFormedMeasure+=e.formSelectStatement(i);break}}else{i.criticalHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CH","FIXED");i.criticalLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CL","FIXED");i.warningHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WH","FIXED");i.warningLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WL","FIXED");i.targetValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TA","FIXED");i.trendValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TC","FIXED")}return i},fetchKpiValue:function(e,i){const t=this;let l=0;try{const o=this.DEFINITION_DATA.EVALUATION.ODATA_URL;const a=this.DEFINITION_DATA.EVALUATION.ODATA_ENTITYSET;let s=this.setThresholdValues();const r=s.fullyFormedMeasure;const n=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(!n){const n=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.DEFINITION_DATA.EVALUATION_FILTERS,this.DEFINITION_DATA.ADDITIONAL_FILTERS);const u=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oTileApi.url.addSystemToServiceUrl(o),a,r,null,n);if(u){this.QUERY_SERVICE_MODEL=u.model;this.queryUriForKpiValue=u.uri;try{this.queryServiceUriODataReadRef=this.QUERY_SERVICE_MODEL.read(u.uri,null,null,true,o=>{t.writeData={};if(o&&o.results&&o.results.length){l=o.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];if(u.unit[0]){t._updateTileModel({unit:o.results[0][u.unit[0].name]});t.writeData.unit=u.unit[0];t.writeData.unit.name=u.unit[0].name}t.writeData.numericData=o;let i="";let a=l;if(t.oConfig.EVALUATION.SCALING==-2){a*=100;t.getView().oNumericContent.setFormatterValue(false)}i=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(a),t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION);const r=t.getTrendIndicator(s.trendValue,a);if(t.oConfig.EVALUATION.SCALING==-2){t._updateTileModel({scale:"%"})}t._updateTileModel({value:i.toString(),indicator:r,valueColor:t.getThresholdsObjAndColor(s).returnColor});t.writeData.data=o;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,t.writeData);if(t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){s.criticalHighValue=o.results[0][s.sCriticalHigh];s.criticalLowValue=o.results[0][s.sCriticalLow];s.warningHighValue=o.results[0][s.sWarningHigh];s.warningLowValue=o.results[0][s.sWarningLow];s.targetValue=o.results[0][s.sTarget];s.trendValue=o.results[0][s.sTrend]}e.call(t,l,s)}else{i.call(t,"no Response from QueryServiceUri")}},e=>{if(e&&e.response){i.call(t,e.message)}})}catch(e){t.logError("Error in Query Service URI")}}}else if(n.data&&n.data.results&&n.data.results.length){let i;s=t.setThresholdValues();i=n.data.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];if(t.oConfig.EVALUATION.SCALING==-2){i*=100;t.getView().oNumericContent.setFormatterValue(true)}if(t.oConfig.EVALUATION.SCALING==-2){t._updateTileModel({scale:"%"})}const l=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(i),t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION);const o=t.getTrendIndicator(s.trendValue,i);if(n.unit){t._updateTileModel({unit:n.data.results[0][n.unit.name]})}t._updateTileModel({indicator:o,value:l.toString()});if(t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){s.criticalHighValue=n.data.results[0][s.sCriticalHigh];s.criticalLowValue=n.data.results[0][s.sCriticalLow];s.warningHighValue=n.data.results[0][s.sWarningHigh];s.warningLowValue=n.data.results[0][s.sWarningLow];s.targetValue=n.data.results[0][s.sTarget];s.trendValue=n.data.results[0][s.sTrend]}e.call(t,n.data.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME],s)}else{i.call(t,"no Response from QueryServiceUri")}}catch(e){i.call(t,e)}},flowWithoutDesignTimeCall:function(){const e=this;let i;let t;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);if(this.oTileApi.visible.isVisible()&&!this.firstTimeVisible){this.firstTimeVisible=true;this.fetchKpiValue(function(l,a){let s=Number(l);if(this.oConfig.EVALUATION.SCALING==-2){s*=100}i=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(s),this.oConfig.EVALUATION.SCALING,e.oConfig.EVALUATION.DECIMAL_PRECISION);this.CALCULATED_KPI_VALUE=Number(l);const r={};const n=this.getThresholdsObjAndColor(a);const u={value:Number(l),color:n.returnColor};r.valueColor=u.color;r.actualValueLabel=i.toString();r.actual=u;const c=this.DEFINITION_DATA.EVALUATION_VALUES;let T;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){T=Number(a.targetValue);if(this.oConfig.EVALUATION.SCALING==-2){T*=100}t=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(T,this.oConfig.EVALUATION.SCALING,this.oConfig.EVALUATION.DECIMAL_PRECISION);r.targetValue=Number(a.targetValue);r.targetValueLabel=t.toString()}else{for(let e=0;e<c.length;e++){if(c[e].TYPE==="TA"){T=Number(c[e].FIXED);if(this.oConfig.EVALUATION.SCALING==-2){T*=100}t=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(T);r.targetValue=Number(c[e].FIXED);r.targetValueLabel=t.toString()}}}this._updateTileModel(r);const g=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(e.oConfig,e.system);e.oDualDeviationView.oGenericTile.$().wrap(`<a href ='${g}'></a>`);this.oDualDeviationView.oGenericTile.setState(o.Loaded);let h="";if(r.valueColor=="Error"){h="sb.error"}if(r.valueColor=="Neutral"){h="sb.neutral"}if(r.valueColor=="Critical"){h="sb.critical"}if(r.valueColor=="Good"){h="sb.good"}const E={status:h,actual:s,target:a.targetValue,cH:a.criticalHighValue,wH:a.warningHighValue,wL:a.warningLowValue,cL:a.criticalLowValue};const A=E;const d=e.oDualDeviationView.oGenericTile.getTileContent()[0].getContent();const C=e.oDualDeviationView.oGenericTile.getTileContent()[1].getContent();sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(d,"NT",E);sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(C,"DT",A)},this.logError)}},flowWithDesignTimeCall:function(){const e=this;try{const i=sap.ushell.components.tiles.indicatorTileUtils.cache.getEvaluationById(this.oConfig.EVALUATION.ID);if(i){e.oConfig.EVALUATION_FILTERS=i.EVALUATION_FILTERS;e.flowWithoutDesignTimeCall()}else{sap.ushell.components.tiles.indicatorTileUtils.util.getFilterFromRunTimeService(this.oConfig,i=>{e.oConfig.EVALUATION_FILTERS=i;sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(e.oConfig.TILE_PROPERTIES.id,e.oConfig);e.flowWithoutDesignTimeCall()})}}catch(e){this.logError(e)}},refreshHandler:function(e){if(!e.firstTimeVisible){if(Number(this.oTileApi.configuration.getParameterValueAsString("isSufficient"))){e.flowWithoutDesignTimeCall()}else{e.flowWithDesignTimeCall()}}},visibleHandler:function(e){if(!e){this.firstTimeVisible=false;sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.queryServiceUriODataReadRef)}if(e){this.refreshHandler(this)}},setTextInTile:function(){const e=this;const i=sap.ushell.components.tiles.indicatorTileUtils.util.getTileTitleSubtitle(this.oTileApi);this._updateTileModel({header:i.title||sap.ushell.components.tiles.indicatorTileUtils.util.getChipTitle(e.oConfig),subheader:i.subTitle||sap.ushell.components.tiles.indicatorTileUtils.util.getChipSubTitle(e.oConfig)})},onInit:function(){const e=this;this.firstTimeVisible=false;this.oDualDeviationView=this.getView();this.oViewData=this.oDualDeviationView.getViewData();this.oTileApi=this.oViewData.chip;if(this.oTileApi.visible){this.oTileApi.visible.attachVisible(this.visibleHandler.bind(this))}this.system=this.oTileApi.url.getApplicationSystem();this.oDualDeviationView.oGenericTile.setState(o.Loading);try{sap.ushell.components.tiles.indicatorTileUtils.util.getParsedChip(e.oTileApi.configuration.getParameterValueAsString("tileConfiguration"),e.oTileApi.preview.isEnabled(),i=>{e.oConfig=i;e.setTextInTile();if(e.oTileApi.preview){e.oTileApi.preview.setTargetUrl(sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(e.oConfig,e.system))}if(e.oTileApi.preview.isEnabled()){e._updateTileModel({valueColor:"Good",value:100,frameType:"TwoByOne",unit:"USD",actual:{value:120,color:l.Good},targetValue:100,thresholds:[{value:0,color:l.Error},{value:50,color:l.Critical},{value:150,color:l.Critical},{value:200,color:l.Error}],showActualValue:true,showTargetValue:true});e.oDualDeviationView.oGenericTile.setState(o.Loaded)}else{e.oDualDeviationView.oGenericTile.attachPress(()=>{sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(e.queryServiceUriODataReadRef);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(e.oConfig.TILE_PROPERTIES.id,null);window.location.hash=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(e.oConfig,e.system)});if(Number(e.oTileApi.configuration.getParameterValueAsString("isSufficient"))){sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(e.oConfig.TILE_PROPERTIES.id,e.oConfig);e.flowWithoutDesignTimeCall()}else{e.flowWithDesignTimeCall()}}})}catch(e){this.logError(e)}},_setLocalModelToTile:function(){if(!this.getTile().getModel()){this.getTile().setModel(new e({}))}},onExit:function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.queryServiceUriODataReadRef)}})},true);
//# sourceMappingURL=DualDeviation.controller.js.map