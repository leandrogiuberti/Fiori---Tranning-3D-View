// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/i18n/Localization","sap/base/util/ObjectPath","sap/base/util/deepExtend","sap/f/GridContainerItemLayoutData","sap/m/library","sap/ui/core/Element","sap/ui/core/Fragment","sap/ui/core/InvisibleMessage","sap/ui/core/library","sap/ui/core/mvc/Controller","sap/ui/integration/ActionDefinition","sap/ushell/utils/workpage/WorkPageHost","sap/ui/integration/widgets/Card","sap/ui/model/json/JSONModel","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/ushell/adapters/cdm/v3/utilsCdm","sap/ushell/ui/launchpad/VizInstanceCdm","sap/ushell/utils","sap/ushell/utils/workpage/WorkPageVizInstantiation","sap/ushell/components/workPageBuilder/controller/WorkPageBuilder.accessibility","sap/ushell/components/workPageBuilder/controller/WorkPageBuilder.layout","sap/ui/integration/library"],(e,t,o,i,n,s,r,a,l,d,c,g,u,h,p,f,C,P,m,w,v,D,y,_)=>{"use strict";const M=d.ValueState;const E=["PR","CO","PG"];const V=6;const k=24;const z=2;const A=4;const b=s.LoadState;const x=d.InvisibleMessageMode;const B=_.CardPreviewMode;return c.extend("sap.ushell.components.workPageBuilder.controller.WorkPageBuilder",{onInit:async function(){const e=this.byId("workPage");this._fnDeleteRowHandler=this.deleteRow.bind(this);this._fnDeleteCellHandler=this.deleteCell.bind(this);this._fnSaveCardConfiguration=this._onSaveCardEditor.bind(this);this._fnResetCardConfiguration=this._onResetCardConfigurations.bind(this);this.oModel=new p({maxColumns:A,editMode:false,previewMode:false,loaded:false,navigationDisabled:false,showFooter:false,showPageTitle:true,data:{workPage:null,visualizations:[],usedVisualizations:[]}});this.oModel.setSizeLimit(Infinity);this._saveHost();e.bindElement({path:"/data/workPage"});this.oWorkPageBuilderAccessibility=new D;this.oWorkPageVizInstantiation=await v.getInstance();this.getView().setModel(this.oModel);y.register(e);this.getView().setModel(y.getModel(),"viewSettings");this.oContentFinderPromise=new Promise(e=>{this.fnContentFinderPromiseResolve=e})},_onVisualizationFilterApplied:function(e){this.getOwnerComponent().fireEvent("visualizationFilterApplied",e.getParameters())},onExit:function(){y.deregister();if(this.oContentFinderPromise){this.oContentFinderPromise.then(e=>{e.destroy()})}if(this.oCardEditorDialogPromise){this.oCardEditorDialogPromise.then(e=>{e.destroy()})}if(this.oCardResetDialogPromise){this.oCardResetDialogPromise.then(e=>{e.destroy()})}if(this.oDeleteCell){this.oDeleteCell.then(e=>{e.destroy()})}if(this.oLoadDeleteDialog){this.oLoadDeleteDialog.then(e=>{e.destroy()})}},onGridContainerBorderReached:function(e){const t=this.byId("workPage");this.oWorkPageBuilderAccessibility._handleBorderReached(e,t)},onAddColumn:function(e){const t=this.getView().getModel();const o=e.getSource();const i=o.getParent();const n=i.indexOfAggregation("columns",o);const s=i.getBindingContext().getPath();const r=`${s}/columns/`;const a=`${o.getBindingContext().getPath()}/descriptor/value/columnWidth`;const l=t.getProperty(r);const d=l.length;const c=e.getParameter("left");if(d>=A){return}const g=o.getProperty("columnWidth");const u=Math.floor(g/2)>=V?Math.floor(g/2):V;const h=u%2;t.setProperty(a,u+h);const p=i.indexOfAggregation("columns",o)+(c===true?0:1);const f=this._createEmptyColumn(u-h);const C=[l.slice(0,p),f,l.slice(p)].flat();const P=C.reduce((e,t)=>e+this._getColumnWidth(t),0);if(P>k){this._calculateColWidths(C,n,P)}t.setProperty(r,C);this.getOwnerComponent().fireEvent("workPageEdited")},focusFirstItem:function(e){const t=e.getSource();this.oWorkPageBuilderAccessibility.focusFirstItem(t)},setEditMode:function(e){this.oModel.setProperty("/editMode",!!e)},setPreviewMode:function(e){this.oModel.setProperty("/previewMode",!!e)},getPreviewMode:function(){return this.oModel.getProperty("/previewMode")},getEditMode:function(){return this.oModel.getProperty("/editMode")},setShowFooter:function(e){this.oModel.setProperty("/showFooter",!!e)},setShowPageTitle:function(e){this.oModel.setProperty("/showPageTitle",!!e)},setPageData:function(e){let t={};const i=o.get("workPage.usedVisualizations.nodes",e);const n=o.get("workPage.contents",e);if(i&&i.length>0){t=i.reduce((e,t)=>{e[t.id]=t;return e},{})}this.oModel.setProperty("/data/usedVisualizations",t);this.oModel.setProperty("/data/workPage",n);this.oModel.setProperty("/loaded",true)},getPageData:function(){const e=this.oModel.getProperty("/data/usedVisualizations")||{};return{workPage:{contents:this.oModel.getProperty("/data/workPage"),usedVisualizations:{nodes:Object.values(e)}}}},setVisualizationData:function(e){return this.oContentFinderPromise.then(t=>{t.setVisualizationData(e)})},setCategoryTree:function(e){return this.oContentFinderPromise.then(t=>{t.setCategoryTree(e)})},onGridColumnsChange:function(e){const t=e.getParameter("columns");const o=e.getSource();o.getWidgets().filter(e=>e.isA("sap.ui.integration.widgets.Card")).forEach(e=>{e.setLayoutData(new n({columns:t,minRows:1}))})},onDeleteColumn:function(e){const t=this.getView().getModel();const o=e.getSource();const i=o.getColumnWidth();const n=o.getParent();const s=n.indexOfAggregation("columns",o);const r=n.getBindingContext().getPath();const a=`${r}/columns/`;const l=t.getProperty(a);const d=l.filter((e,t)=>t!==s);let c=i/2;let g=s-1<0?s:s-1;while(c>0){const e=d[g];this._setColumnWidth(e,this._getColumnWidth(e)+z);g=++g>=d.length?0:g++;c--}t.setProperty(a,d);n.invalidate();this.getOwnerComponent().fireEvent("workPageEdited")},onAddFirstRow:function(){const e="/data/workPage/rows/";this.getView().getModel().setProperty(e,[this._createEmptyRow()]);this.getOwnerComponent().fireEvent("workPageEdited")},onAddRow:function(e){const t=this.getView().getModel();const o=e.getSource();const i=this.byId("workPage");const n="/data/workPage/rows/";const s=t.getProperty(n);const r=this._createEmptyRow();const a=i.indexOfAggregation("rows",o)+(e.getParameter("bottom")===true?1:0);const l=[s.slice(0,a),r,s.slice(a)].flat();t.setProperty(n,l);this.getOwnerComponent().fireEvent("workPageEdited")},onResize:function(e){const o=e.getParameter("posXDiff");const i=e.getSource();const n=i.getParent();const s=n.getSingleColumnWidth();if(s<=0){return}const r=t.getRTL();const a=o/s;if(a>-1&&a<1){return}const l=a<0?Math.floor(o/s):Math.ceil(o/s);const d=l>=0?"right":"left";let c=d==="right"?z:-z;const g=n.indexOfAggregation("columns",i);const u=g-1;const h=n.getColumnFlexValues();c=r?c:-c;if(!this._resizeAllowed(h.length,h[u],h[g],c)){return}h[u]-=c;h[g]+=c;n.setGridLayoutString(h);this._updateModelWithColumnWidths(n,u,g,h[u],h[g])},_resizeAllowed:function(e,t,o,i){const n=this.getView().getModel("viewSettings");const s=n.getProperty("/currentBreakpoint/columnMinFlex");if(t-i<s){return false}if(o+i<s){return false}const r=n.getProperty("/currentBreakpoint/maxColumnsPerRow");if(e>r){return false}return true},onResizeCompleted:function(){this.getOwnerComponent().fireEvent("workPageEdited")},onDeleteCell:function(e){const t=e.getSource().getParent().getParent();const o=t.getWidgets();if(o?.[0]&&o.length===1&&o[0].isA("sap.ui.integration.widgets.Card")){return this.deleteCell(e,{cell:t,dialog:false})}if(!this.oDeleteCell){const e=this.getOwnerComponent().getRootControl();this.oDeleteCell=a.load({id:e.createId("cellDeleteDialog"),name:"sap.ushell.components.workPageBuilder.view.WorkPageCellDeleteDialog",controller:this}).then(e=>{e.setModel(this.getView().getModel("i18n"),"i18n");return e})}return this.oDeleteCell.then(e=>{e.getBeginButton().detachEvent("press",this._fnDeleteCellHandler);e.getBeginButton().attachEvent("press",{cell:t,dialog:true},this._fnDeleteCellHandler);e.open()})},deleteCell:function(e,t){const o=t.cell;const i=this.getView().getModel();const n=o.getParent();const s=n.indexOfAggregation("cells",o);const r=`${n.getBindingContext().getPath()}/cells`;const a=i.getProperty(r);const l=a.filter((e,t)=>t!==s);i.setProperty(r,l);this.getOwnerComponent().fireEvent("workPageEdited");if(t.dialog){return this.oDeleteCell.then(e=>{e.close()})}return Promise.resolve()},_deleteVisualization:function(e){const t=e.getParent().getParent();const o=e.getBindingContext();const i=o.getPath();const n=this.getView().getModel();const s=i.substring(0,i.lastIndexOf("/"));const r=t.indexOfAggregation("widgets",e);const a=n.getProperty(s);const l=a.filter((e,t)=>t!==r);n.setProperty(s,l);this.getOwnerComponent().fireEvent("workPageEdited")},onEditTitle:function(){this.getOwnerComponent().fireEvent("workPageEdited")},onWidgetAdded:function(){this.getOwnerComponent().fireEvent("workPageEdited")},onContentFinderComponentCreated:async function(e){const t=e.getParameter("component");t.attachContentFinderClosed(null,function(){t?.detachVisualizationsAdded(this._onAddVisualization,this);t?.detachVisualizationFilterApplied(this._onVisualizationFilterApplied,this);t?.setContextData({restrictedVisualizations:[]})},this);this.fnContentFinderPromiseResolve(t)},openContentFinder:function(e){const t=e.getSource();const o=this.getView().getModel("i18n").getResourceBundle();return this.oContentFinderPromise.then(e=>{e.attachVisualizationsAdded(t,this._onAddVisualization,this);e.attachVisualizationFilterApplied(t,this._onVisualizationFilterApplied,this);e.show({visualizationFilters:{displayed:["tiles","cards"],selected:"tiles",available:[{key:"tiles",title:o.getText("ContentFinder.AppSearch.VisualizationsFilter.Tiles"),types:["sap.ushell.StaticAppLauncher","sap.ushell.DynamicAppLauncher"]},{key:"cards",title:o.getText("ContentFinder.AppSearch.VisualizationsFilter.Cards"),types:["sap.card"]}]}})})},openTilesAppSearch:function(e){const t=e.getSource().getParent().getParent();const o=this.getView().getModel("i18n").getResourceBundle();return this.oContentFinderPromise.then(e=>{e.setContextData({restrictedVisualizations:this._getRestrictedVisualizationIds(t)});e.attachVisualizationsAdded(t,this._onAddVisualization,this);e.attachVisualizationFilterApplied(t,this._onVisualizationFilterApplied,this);e.show({visualizationFilters:{displayed:["tiles"],selected:"tiles",available:[{key:"tiles",title:o.getText("ContentFinder.AppSearch.VisualizationsFilter.Tiles"),types:["sap.ushell.StaticAppLauncher","sap.ushell.DynamicAppLauncher"]}]}})})},_getRestrictedVisualizationIds:function(e){return e.getWidgets().map(e=>{if(e.isA("sap.ushell.ui.launchpad.VizInstanceCdm")){return e.getProperty("vizRefId")}})},_onAddVisualization:function(e,t){const o=this.getView().getModel();const i=e.getParameter("visualizations");if(i.length>0){i.forEach(e=>{const t=`/data/usedVisualizations/${e.id}`;if(!o.getProperty(t)){o.setProperty(t,e.vizData)}});const e=this._instantiateWidgetData(i);if(t.isA("sap.ushell.components.workPageBuilder.controls.WorkPageCell")){this._setCellData(t,e)}if(t.isA("sap.ushell.components.workPageBuilder.controls.WorkPageColumn")){this._setColumnData(t,e)}}},_instantiateWidgetData:function(e){let t=[];let o;return e.map(e=>{o=this._generateUniqueId(t);t=t.concat([o]);return{id:o,visualization:{id:e.vizData.id}}})},_setCellData:function(e,t){const o=this.getView().getModel();const i=e.getBindingContext().getPath();const n=Object.assign({},o.getProperty(i));n.widgets=n.widgets.concat(t);o.setProperty(i,n);this.onWidgetAdded()},_setColumnData:function(e,t,o){const i=this.getView().getModel();const n=e.getBindingContext().getPath();const s=Object.assign({},i.getProperty(n));const r={id:this._generateUniqueId(),descriptor:{value:{},schemaVersion:"3.2.0"},widgets:t.concat([])};if(!s.cells){s.cells=[]}if(o===undefined||o>s.cells.length){o=s.cells.length}const a=s.cells.concat([]);a.splice(o,0,r);s.cells=a;i.setProperty(n,s);this.onWidgetAdded()},onDeleteRow:function(e){const t=this.getOwnerComponent().getRootControl();const o=e.getSource().getBindingContext();if(!this.oLoadDeleteDialog){this.oLoadDeleteDialog=a.load({id:t.createId("rowDeleteDialog"),name:"sap.ushell.components.workPageBuilder.view.WorkPageRowDeleteDialog",controller:this}).then(e=>{e.setModel(this.getView().getModel("i18n"),"i18n");return e})}return this.oLoadDeleteDialog.then(e=>{e.getBeginButton().detachEvent("press",this._fnDeleteRowHandler);e.getBeginButton().attachEvent("press",{rowContext:o},this._fnDeleteRowHandler);e.open()})},deleteRow:function(e,t){const o=this.getView().getModel();const i=t.rowContext;const n=o.getProperty("/data/workPage/rows");const s=i.getObject();const r=n.filter(e=>e.id!==s.id);o.setProperty("/data/workPage/rows",r);this.getOwnerComponent().fireEvent("workPageEdited");return this.oLoadDeleteDialog.then(e=>{e.close()})},onRowDeleteCancel:function(){return this.oLoadDeleteDialog.then(e=>{e.close()})},onCellDeleteCancel:function(){return this.oDeleteCell.then(e=>{e.close()})},_createErrorTile:function(){return new m({state:b.Failed}).attachPress(this.onVisualizationPress,this).bindEditable("/editMode").bindSizeBehavior("viewSettings>/currentBreakpoint/sizeBehavior").setLayoutData(new n({columns:2,rows:2}))},widgetFactory:function(t,o){const i=o.getProperty("visualization/id");if(!i){e.error("No vizId found in widget context.");return this._createErrorTile()}const n=this.getView().getModel().getProperty(`/data/usedVisualizations/${i}`);if(!n||!n.type){e.error(`No viz or vizType found for vizId ${i}`);return this._createErrorTile()}const s=o.getProperty("configurations")||[];const r=n.configurations||[];const a=this._getMergedAndSortedConfigurations(s,r);const l=o.getPath();switch(n.type){case"sap.card":return this._createCard(n,s,a,l);case"sap.ushell.StaticAppLauncher":case"sap.ushell.DynamicAppLauncher":case"ssuite.smartbusiness.tiles.dual":case"ssuite.smartbusiness.tiles.numeric":case"ssuite.smartbusiness.tiles.contribution":case"ssuite.smartbusiness.tiles.deviation":case"ssuite.smartbusiness.tiles.trend":case"ssuite.smartbusiness.tiles.comparison":return this._createVizInstance(n);default:e.error(`Unknown type for widget ${n.type}`);return this._createErrorTile()}},_getMergedAndSortedConfigurations:function(e,t){if(e.length===0&&t.length===0){return[]}const o=E.reduce((o,n)=>{const s=e.find(e=>e.level===n);const r=t.find(e=>e.level===n);const a=i({},r,s);if(Object.keys(a).length>0){o[n]=a}return o},{});return this._sortConfigurations(Object.values(o))},_sortConfigurations:function(e){const t=e&&e.sort((e,t)=>E.indexOf(e.level)-E.indexOf(t.level));return t.map(e=>e.settings.value)},_createVizInstance:function(t){const o=i({},t,{preview:this.oModel.getProperty("/previewMode")});if(this.oModel.getProperty("/navigationDisabled")&&o._siteData){delete o._siteData.target;delete o._siteData.targetURL}const s=this.oWorkPageVizInstantiation.createVizInstance(o);if(!s){e.error("No VizInstance was created.");return this._createErrorTile()}return s.setActive(true).bindPreview("/previewMode").attachPress(this.onVisualizationPress,this).bindEditable("/editMode").bindSizeBehavior("viewSettings>/currentBreakpoint/sizeBehavior").bindClickable({path:"/navigationDisabled",formatter:function(e){return!e}}).setLayoutData(new n(s.getLayout()))},formatRowAriaLabel:function(e,t=[],o){const i=this.getView().getModel("i18n").getResourceBundle();if(o){return i.getText("WorkPage.Row.Named.AriaLabel",[o])}const n=t.findIndex(t=>t.id===e);if(n<0){return""}return i.getText("WorkPage.Row.Unnamed.AriaLabel",[n+1])},onVisualizationPress:function(e){const t=e.getParameter("scope");const o=e.getParameter("action");if(t==="Actions"&&o==="Remove"){this._deleteVisualization(e.getSource())}},_createCard:function(t={},i=[],s=[],r=""){const a={};const l=t.descriptor&&t.descriptor.value&&t.descriptor.value["sap.card"];const d=t.descriptorResources&&(t.descriptorResources.baseUrl||t.descriptorResources.descriptorPath);const c=i.some(e=>e.level==="PG");let g;if(!l&&!d){e.error("No descriptor or descriptorResources for Card");return(new h).setLayoutData(new n({columns:2,rows:2}))}if(l){a.manifest=t.descriptor.value;g=!!o.get(["descriptor","value","sap.card","configuration"],t);if(d){a.baseUrl=t.descriptorResources.baseUrl+t.descriptorResources.descriptorPath}}else if(d){a.manifest=t.descriptorResources.baseUrl+t.descriptorResources.descriptorPath;if(!a.manifest.endsWith(".json")){a.manifest+="/manifest.json"}}a.referenceId=t?.provider?.id;if(a.baseUrl&&a.baseUrl.substr(-1)!=="/"){a.baseUrl+="/"}const u=new h(a);if(g){const e=this._createCardConfigurationActionDefinition(u,r,this._openCardConfigurationEditor.bind(this));u.addActionDefinition(e)}if(c){const e=this._createCardResetActionDefinition(i,r,this._openResetCardConfigurationDialog.bind(this));u.addActionDefinition(e)}return u.setModel(this.oModel,"workPageModel").bindProperty("previewMode",{path:"workPageModel>/previewMode",formatter:function(e){return e?B.MockData:B.Off}}).setManifestChanges(s).addStyleClass("workpageCellWidget").setHost(this.oHost).setLayoutData(new n({columns:16,minRows:1}))},_createCardConfigurationActionDefinition:function(e,t,o){const i=this.getView().getModel("i18n").getResourceBundle().getText("WorkPage.Card.ActionDefinition.Configure");const n=new g({type:"Custom",visible:"{/editMode}",buttonType:"Transparent",text:i});n.setModel(this.oModel);n.attachPress({card:e,widgetContextPath:t},o);return n},_createCardResetActionDefinition:function(e,t,o){const i=this.getView().getModel("i18n").getResourceBundle().getText("WorkPage.Card.ActionDefinition.Reset");const n=new g({type:"Custom",visible:"{/editMode}",buttonType:"Transparent",text:i});n.setModel(this.oModel);n.attachPress({widgetContextPath:t,widgetConfigurations:e},o);return n},_openCardConfigurationEditor:function(e,t){if(!this.oCardEditorDialogPromise){this.oCardEditorDialogPromise=this._createCardEditorDialog(t.card)}const o=this._createCardEditor(t.card);return Promise.all([o,this.oCardEditorDialogPromise]).then(e=>{this.oCardEditorDialog=e[1];this.oCardEditorDialog.removeAllContent();this.oCardEditorDialog.getBeginButton().detachPress(this._fnSaveCardConfiguration).attachPress(t.widgetContextPath,this._fnSaveCardConfiguration);this._setCardDialogTitle(this.oCardEditorDialog,t.card);this.oCardEditorDialog.addContent(e[0]);this.oCardEditorDialog.open()})},_openResetCardConfigurationDialog:function(e,t){if(!this.oCardResetDialogPromise){this.oCardResetDialogPromise=this._createResetCardConfigurationDialog()}return this.oCardResetDialogPromise.then(e=>{this.oCardResetDialog=e;this.getView().addDependent(this.oCardResetDialog);this.oCardResetDialog.getBeginButton().detachPress(this._fnResetCardConfiguration).attachPress(t,this._fnResetCardConfiguration);this.oCardResetDialog.open()})},_onResetCardConfigurations:function(e,t){const o=e.getSource().getParent();const i=t.widgetConfigurations;const n=`${t.widgetContextPath}/configurations`;const s=i.filter(e=>e.level!=="PG");this.oModel.setProperty(n,s);this.getOwnerComponent().fireEvent("workPageEdited");o.close()},_createResetCardConfigurationDialog:function(){const e=this.getView().getModel("i18n").getResourceBundle();const t=e.getText("WorkPage.CardEditor.DeleteConfigurationDialog.Title");const o=e.getText("WorkPage.CardEditor.DeleteConfigurationDialog.Content");const i=e.getText("WorkPage.CardEditor.DeleteConfigurationDialog.Accept");const n=e.getText("WorkPage.CardEditor.DeleteConfigurationDialog.Deny");return new Promise((e,r)=>{sap.ui.require(["sap/m/Dialog","sap/m/Button","sap/m/Text"],(r,a,l)=>{const d=new r({id:this.createId("cardConfigurationResetDialog"),type:s.DialogType.Message,state:M.Warning,title:t,content:new l({text:o}),beginButton:new a({type:s.ButtonType.Emphasized,text:i}),endButton:new a({text:n,press:function(){d.close()}})});e(d)},r)})},_setCardDialogTitle:function(e,t){const o=this.getView().getModel("i18n").getResourceBundle();const i=this._getCardTitle(t)?o.getText("WorkPage.CardEditor.Title",[this._getCardTitle(t)]):o.getText("WorkPage.CardEditor.Title.NoCardTitle");e.setTitle(i)},_createCardEditor:function(e){return new Promise((t,o)=>{sap.ui.require(["sap-ui-integration-card-editor"],()=>{sap.ui.require(["sap/ui/integration/designtime/editor/CardEditor"],o=>{t(new o({previewPosition:"right",card:e,mode:"content"}))},o)},o)})},_createCardEditorDialog:function(e){const t=this.getView().getModel("i18n").getResourceBundle();const o=t.getText("WorkPage.CardEditor.Save");const i=t.getText("WorkPage.CardEditor.Cancel");return new Promise((e,t)=>{sap.ui.require(["sap/m/Dialog","sap/m/Button"],(t,n)=>{const r=new t({id:this.createId("cardEditorDialog"),contentWidth:"40rem",beginButton:new n({text:o,type:s.ButtonType.Emphasized}),endButton:new n({text:i,press:function(){r.close()}})});e(r)},t)})},_getCardTitle:function(e){if(e.getCardHeader()&&e.getCardHeader().getTitle()){return e.getCardHeader().getTitle()}},_onSaveCardEditor:function(e,t){const o=e.getSource().getParent();const n=o.getContent()[0];const s=n.getCard();const r=`${t}/configurations`;const a=n.getCurrentSettings();let l=this.oModel.getProperty(r)||[];let d=l.find(e=>e.level==="PG");if(!d){d={};d.id=this._generateUniqueId();d.level="PG";d.settings={value:a,schemaVersion:"3.2.0"};l.push(d)}else{l=l.map(e=>{if(e.level==="PG"){e.settings.value=i({},e.settings.value,a)}return e})}this.oModel.setProperty(r,l);s.setManifestChanges([a]);this.getOwnerComponent().fireEvent("workPageEdited");o.close()},saveEditChanges:function(){this.getOwnerComponent().fireEvent("closeEditMode",{saveChanges:true})},cancelEditChanges:function(){this.getOwnerComponent().fireEvent("closeEditMode",{saveChanges:false})},onCellDrop:function(e){const t=e.getParameter("draggedControl");const o=e.getParameter("droppedControl");const i=e.getParameter("dropPosition");const n=t.getParent();const s=o.getParent();const r=n.indexOfAggregation("cells",t);let a=s.indexOfAggregation("cells",o);if(i==="After"){a++}this._moveCell(n,s,r,a)},onCellDropOnEmptyColumn:function(e){const t=e.getParameter("draggedControl");const o=e.getParameter("droppedControl");const i=t.getParent();const n=i.indexOfAggregation("cells",t);const s=0;this._moveCell(i,o,n,s)},onVisualizationDropBetweenCells:function(e){const t=e.getParameter("draggedControl");const o=e.getParameter("droppedControl");const i=e.getParameter("dropPosition");const n=t.getParent().getParent();const s=o.getParent();let r=s.indexOfAggregation("cells",o);if(i==="After"){r++}this._moveVisualizationToCellOrColumn(t,n,s,r)},onVisualizationDropOnCell:function(e){const t=e.getParameter("draggedControl");const o=e.getParameter("droppedControl");const i=t.getParent().getParent();const n=0;this._moveVisualizationToCellOrColumn(t,i,o,n)},onVisualizationDropOnEmptyWidgetContainer:function(e){const t=e.getParameter("draggedControl");const o=e.getParameter("droppedControl");const i=t.getParent().getParent();this._moveVisualizationToCellOrColumn(t,i,o)},_moveVisualizationToCellOrColumn:function(e,t,o,i){const n=this.getView().getModel();const s=`${t.getBindingContext().getPath()}/widgets`;const r=n.getProperty(s);const a=t.indexOfAggregation("widgets",e);const d=e.getBindingContext().getPath();const c=n.getProperty(d);r.splice(a,1);const g=[].concat(r);n.setProperty(s,g);if(o.isA("sap.ushell.components.workPageBuilder.controls.WorkPageCell")){this._setCellData(o,[c])}else if(o.isA("sap.ushell.components.workPageBuilder.controls.WorkPageColumn")){this._setColumnData(o,[c],i)}l.getInstance().announce(this.getView().getModel("i18n").getResourceBundle().getText("WorkPage.Message.WidgetMoved"),x.Assertive);this.getOwnerComponent().fireEvent("workPageEdited")},_moveCell:function(e,t,o,i){const n=this.getView().getModel();const s=t.getId()===e.getId();const r=`${e.getBindingContext().getPath()}/cells`;const a=`${t.getBindingContext().getPath()}/cells`;const d=n.getProperty(r);let c=n.getProperty(a);if(s){if(o<i){i--}if(o===i){return}}const g=d.filter((e,t)=>t!==o);if(s){c=g}const u=[c.slice(0,i),d[o],c.slice(i)].flat();n.setProperty(r,g);n.setProperty(a,u);l.getInstance().announce(this.getView().getModel("i18n").getResourceBundle().getText("WorkPage.Message.WidgetMoved"),x.Assertive);this.getOwnerComponent().fireEvent("workPageEdited")},onWidgetOnCellDrop:function(e){const t=e.getParameter("draggedControl");const o=t.getParent().getParent();const i=e.getParameter("droppedControl");const n=o.indexOfAggregation("widgets",t);const s=i.getBindingContext().getProperty("widgets").length;this._moveVisualization(o,i,n,s)},onWidgetOnCellDragEnter:function(e,t){const o=e.getParameter("target");const i=!!o.getBindingContext().getProperty("widgets").length;if(o.getTileMode()&&i||t===i){e.preventDefault()}},onGridDrop:function(e){const t=e.getSource();const o=e.getParameter("draggedControl");const i=e.getParameter("droppedControl");const n=e.getParameter("dropPosition");const s=o.getParent().getParent();const r=s.indexOfAggregation("widgets",o);let a=t.indexOfAggregation("widgets",i);const l=t.getId()===s.getId();if(n==="After"){a++}if(l){if(r<a){a--}if(r===a){return}}this._moveVisualization(s,t,r,a)},_moveVisualization:function(e,t,o,i){const n=this.getView().getModel();const s=`${e.getBindingContext().getPath()}/widgets`;const r=`${t.getBindingContext().getPath()}/widgets`;const a=s===r;const d=n.getProperty(s);let c=n.getProperty(r);const g=d[o];const u=d.filter((e,t)=>t!==o);if(a){c=u}const h=[c.slice(0,i),g,c.slice(i)].flat();n.setProperty(s,u);n.setProperty(r,h);l.getInstance().announce(this.getView().getModel("i18n").getResourceBundle().getText("WorkPage.Message.WidgetMoved"),x.Assertive);this.getOwnerComponent().fireEvent("workPageEdited")},tileMode:function(e){const t=this.getView().getModel();let i;return!!e&&(e.length>1||!e.some(e=>{i=t.getProperty(`/data/usedVisualizations/${o.get("visualization.id",e)}`);return o.get("type",i)==="sap.card"}))},showAppSearchButton:function(e,t){return this.tileMode(e)&&t},_updateModelWithColumnWidths:function(e,t,o,i,n){const s=this.getView().getModel();const r=e.getBindingContext();const a=r.getPath();const l=`${a}/columns/${t}/descriptor/value/columnWidth`;const d=`${a}/columns/${o}/descriptor/value/columnWidth`;s.setProperty(l,i);s.setProperty(d,n)},_getColumnWidth:function(e){return o.get("descriptor.value.columnWidth",e)||k},_setColumnWidth:function(e,t){o.set("descriptor.value.columnWidth",t,e)},_calculateColWidths:function(e,t,o){const i=e[t];if(this._getColumnWidth(i)-z>=V){this._setColumnWidth(i,this._getColumnWidth(i)-z);o=o-z}if(o>k){const i=t-1>=0?t-1:e.length-1;this._calculateColWidths(e,i,o)}return e},_createEmptyColumn:function(e){return{id:this._generateUniqueId(),descriptor:{value:{columnWidth:e},schemaVersion:"3.2.0"},configurations:[],cells:[]}},_createEmptyRow:function(){return{id:this._generateUniqueId(),descriptor:{value:{title:""},schemaVersion:"3.2.0"},columns:[this._createEmptyColumn(k)]}},_saveHost:function(){this.oHost=r.getElementById("sap.shell.host.environment");if(!this.oHost){this.oHost=new u("sap.shell.host.environment");this.oHost._setContainer(this.getOwnerComponent().getUshellContainer());if(this.oModel){const e=this.oModel.bindProperty("/navigationDisabled");this.oHost._setNavigationDisabled(e.getValue());e.attachChange(e=>{this.oHost._setNavigationDisabled(e.getSource().getValue())})}}},getNavigationDisabled:function(){return this.oModel.getProperty("/navigationDisabled")},setNavigationDisabled:function(e){this.oModel.setProperty("/navigationDisabled",e)},_generateUniqueId:function(e){let t=(e||[]).concat([]);const o=this.oModel.getProperty("/data/workPage");const i=this._collectIds.bind(this);t=t.concat(i(o));(o.rows||[]).forEach(e=>{t=t.concat(i(e));(e.columns||[]).forEach(e=>{t=t.concat(i(e));(e.cells||[]).forEach(e=>{t=t.concat(i(e));(e.widgets||[]).forEach(e=>{t=t.concat(i(e))})})})});t=t.filter(e=>!!e);return w.generateUniqueId(t)},_collectIds:function(e){const t=[e.id];const o=e.configurations||[];const i=o.map(e=>e.id);return t.concat(i)}})});
//# sourceMappingURL=WorkPageBuilder.controller.js.map