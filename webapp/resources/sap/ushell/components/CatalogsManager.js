// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/base/Object","sap/ui/core/EventBus","sap/ushell/ui/launchpad/TileStateInternal","sap/ushell/EventHub","sap/ushell/utils","sap/ushell/components/DestroyHelper","sap/ushell/components/GroupsHelper","sap/ushell/components/MessagingHelper","sap/ushell/components/HomepageManager","sap/ushell/resources","sap/ui/thirdparty/jquery","sap/ui/performance/Measurement","sap/base/Log","sap/ushell/Config","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/ushell/Container"],(e,t,o,a,s,i,n,l,r,g,jQuery,c,u,h,d,p)=>{"use strict";let P;const T=e.extend("sap.ushell.components.CatalogsManager",{metadata:{publicMethods:["createGroup","createGroupAndSaveTile","createTile","deleteCatalogTileFromGroup","notifyOnActionFailure","resetAssociationOnFailure"]},analyticsConstants:{PERSONALIZATION:"FLP: Personalization",RENAME_GROUP:"FLP: Rename Group",MOVE_GROUP:"FLP: Move Group",DELETE_GROUP:"FLP: Delete Group",RESET_GROUP:"FLP: Reset Group",DELETE_TILE:"FLP: Delete Tile",ADD_TILE:"FLP: Add Tile",MOVE_TILE:"FLP: Move Tile"},_aDoables:[],constructor:function(e,t){this.oLaunchPageServicePromise=p.getServiceAsync("FlpLaunchPage").then(e=>{this.oLaunchPageService=e;return e});this.oTileCatalogToGroupsMap={};this.tagsPool=[];this.iInitialLoad=100;this.oModel=t.model;if(!h.last("/core/spaces/enabled")){const e={model:this.oModel};this.oHomepageManager=r.prototype.getInstance();if(!this.oHomepageManager){this.oHomepageManager=new r("dashboardMgr",e)}}P=this.getInterface();this.registerEvents()},registerEvents:function(){const e=t.getInstance();e.subscribe("renderCatalog",this.loadAllCatalogs,this);this._aDoables=[];this._aDoables.push(a.on("showCatalog").do(this.updateTilesAssociation.bind(this)));this._aDoables.push(a.on("updateGroups").do(this.updateTilesAssociation.bind(this)))},unregisterEvents:function(){const e=t.getInstance();e.unsubscribe("renderCatalog",this.loadAllCatalogs,this);this._aDoables.forEach(e=>{e.off()});this._aDoables=[]},getModel:function(){return this.oModel},loadAllCatalogs:function(){let e=new jQuery.Deferred;const t=this;e.resolve();function o(){e.done(()=>{const e=t.getModel().getProperty("/groups");if(e&&e.length!==0){t.updateTilesAssociation()}})}if(!this.oModel.getProperty("/catalogs")){if(!this.oModel.getProperty("/groups")||this.oModel.getProperty("/groups").length===0){if(!h.last("/core/spaces/enabled")){e=this.oHomepageManager.loadPersonalizedGroups()}}i.destroyFLPAggregationModels(this.oModel.getProperty("/catalogs"));i.destroyTileModels(this.oModel.getProperty("/catalogTiles"));this.oModel.setProperty("/catalogs",[]);this.oModel.setProperty("/catalogSearchEntity",{appBoxes:[],customTiles:[]});this.aPromises=[];c.start("FLP:DashboardManager.GetCatalogsRequest","GetCatalogsRequest","FLP");c.start("FLP:DashboardManager.getCatalogTiles","getCatalogTiles","FLP");c.pause("FLP:DashboardManager.getCatalogTiles");c.start("FLP:DashboardManager.BuildCatalogModelWithRendering","BuildCatalogModelWithRendering","FLP");c.pause("FLP:DashboardManager.BuildCatalogModelWithRendering");this.oLaunchPageServicePromise.then(e=>{e.getCatalogs().done(e=>{const t=e.slice(0,this.iInitialLoad);c.end("FLP:DashboardManager.GetCatalogsRequest");this.aPromises=t.map(this.addCatalogToModel.bind(this));Promise.all(this.aPromises).then(this.processPendingCatalogs.bind(this)).then(()=>{this.aPromises=e.slice(this.iInitialLoad).map(this.addCatalogToModel.bind(this));Promise.all(this.aPromises).then(this.processPendingCatalogs.bind(this))}).then(this.onDoneLoadingCatalogs.bind(this,e)).then(o)}).fail(l.showLocalizedErrorHelper("fail_to_load_catalog_msg"))})}else{o()}},updateTilesAssociation:function(){this.mapCatalogTilesToGroups();this.updateCatalogTilesToGroupsMap()},mapCatalogTilesToGroups:function(){const e=this;this.oTileCatalogToGroupsMap={};const t=this.oModel.getProperty("/groups");t.forEach(t=>{["tiles","links"].forEach(o=>{const a=t[o];if(a){for(let o=0;o<a.length;++o){const s=encodeURIComponent(e.oLaunchPageService.getCatalogTileId(a[o].object));const i=e.oTileCatalogToGroupsMap[s]||[];const n=e.oLaunchPageService.getGroupId(t.object);if(i.indexOf(n)===-1&&(typeof t.isGroupVisible==="undefined"||t.isGroupVisible)&&!t.isGroupLocked){i.push(n)}e.oTileCatalogToGroupsMap[s]=i}}})})},updateCatalogTilesToGroupsMap:function(){let e;let t;let o;const a=this.getModel().getProperty("/catalogs");if(a){for(let s=0;s<a.length;s++){const i=a[s].appBoxes;if(i){for(let a=0;a<i.length;a++){const s=i[a];e=encodeURIComponent(this.oLaunchPageService.getCatalogTileId(s.src));o=this.oTileCatalogToGroupsMap[e];t=o||[];s.associatedGroups=t}}const n=a[s].customTiles;if(n){for(let a=0;a<n.length;a++){const s=n[a];e=encodeURIComponent(this.oLaunchPageService.getCatalogTileId(s.src));o=this.oTileCatalogToGroupsMap[e];t=o||[];s.associatedGroups=t}}}}this.getModel().setProperty("/catalogs",a)},addCatalogToModel:function(e){const t={title:this.oLaunchPageService.getCatalogTitle(e),id:this.oLaunchPageService.getCatalogId(e),numberTilesSupportedOnCurrectDevice:0,static:false,customTiles:[],appBoxes:[]};c.resume("FLP:DashboardManager.getCatalogTiles");return new Promise((o,a)=>{this.oLaunchPageService.getCatalogTiles(e).done(e=>{c.pause("FLP:DashboardManager.getCatalogTiles");o({oCatalogEntry:e,oCatalogModel:t})}).fail(e=>{l.showLocalizedErrorHelper("fail_to_load_catalog_tiles_msg");a(e)})})},getTagList:function(e){const t={};const o=[];if(this.oModel.getProperty("/tagList")&&this.oModel.getProperty("/tagList").length>0){this.tagsPool.concat(this.oModel.getProperty("/tagList"))}for(let e=0;e<this.tagsPool.length;e++){const o=this.tagsPool[e];if(t[o]){t[o]++}else{t[o]=1}}for(const e in t){o.push({tag:e,occ:t[e]})}const a=o.sort((e,t)=>t.occ-e.occ);if(e){this.oModel.setProperty("/tagList",a.slice(0,e))}else{this.oModel.setProperty("/tagList",a)}},processPendingCatalogs:function(e){const o=this.oModel.getProperty("/catalogs");const i=t.getInstance();const n=this.oModel.getProperty("/masterCatalogs")||[{title:l.getLocalizedText("all")}];c.end("FLP:DashboardManager.getCatalogTiles");c.resume("FLP:DashboardManager.BuildCatalogModelWithRendering");const r=e.reduce((e,t)=>e.then(()=>{let e;let a;const s=t.oCatalogEntry;const i=t.oCatalogModel;const l=this.searchModelCatalogByTitle(i.title);if(l.result){a=this.oModel.getProperty("/catalogs")[l.indexOfPreviousInstanceInModel];e=false}else{e=true;a=i}const r=s.map(e=>this._processCatalogObjectForModel(a,e));return Promise.all(r).then(()=>{if(a.appBoxes.length>0||a.customTiles.length>0){if(e){o.push(i);n.push({title:i.title})}}if(this.oModel.getProperty("/enableCatalogTagFilter")===true){this.getTagList()}})}),Promise.resolve());return r.then(()=>{this.oModel.setProperty("/masterCatalogs",n);this.oModel.setProperty("/catalogs",o);i.publish("launchpad","afterCatalogSegment");setTimeout(()=>{s.setPerformanceMark("FLP-TTI-AppFinder",{bUseUniqueMark:true});a.emit("firstCatalogSegmentCompleteLoaded",true)},0);c.pause("FLP:DashboardManager.BuildCatalogModelWithRendering")})},_processCatalogObjectForModel:function(e,t){if(this._getIsIntentSupported(t)){if(this._getIsAppBox(t)){return this.createCatalogAppBoxes(t,true).then(t=>{e.appBoxes.push(t)})}return this.createCatalogTiles(t).then(t=>{e.customTiles.push(t);if(!this.aFnToGetTileView){this.aFnToGetTileView=[]}})}return Promise.resolve()},searchModelCatalogByTitle:function(e){const t=this.oModel.getProperty("/catalogs");let o=false;let a;let s=0;let i=false;let n;for(let l=0;l<t.length;++l){n=t[l];if(n.title===g.i18n.getText("catalogsLoading")){i=true}else if(e===n.title){a=l;s=n.numberOfTiles;o=true;break}}return{result:o,indexOfPreviousInstanceInModel:a,indexOfPreviousInstanceInPage:i?a-1:a,numOfTilesInCatalog:s}},_getCatalogTileId:function(e){let t=this.oLaunchPageService.getStableCatalogTileId(e);if(!h.last("/core/spaces/enabled")){t=null}if(!t){t=this.oLaunchPageService.getCatalogTileId(e)}return t},createCatalogAppBoxes:async function(e,t){const o=encodeURIComponent(this._getCatalogTileId(e));const a=this.oTileCatalogToGroupsMap[o]||[];const s=this.oLaunchPageService.getCatalogTileTags(e)||[];const i=this.oLaunchPageService.getCatalogTileContentProviderId(e);const n=await d.getContentProviderLabel(i)||i;if(s.length>0){this.tagsPool=this.tagsPool.concat(s)}let l;if(e.tileResolutionResult){l=e.tileResolutionResult.navigationMode}return{id:o,associatedGroups:a,src:e,title:this.oLaunchPageService.getCatalogTilePreviewTitle(e),subtitle:this.oLaunchPageService.getCatalogTilePreviewSubtitle(e),icon:this.oLaunchPageService.getCatalogTilePreviewIcon(e),keywords:t?(this.oLaunchPageService.getCatalogTileKeywords(e)||[]).join(","):[],tags:s,navigationMode:l,url:this.oLaunchPageService.getCatalogTileTargetURL(e),contentProviderLabel:n}},onDoneLoadingCatalogs:function(e){const o=e.map(e=>new Promise((t,o)=>{this.oLaunchPageService.getCatalogTiles(e).done(t).fail(o)}));Promise.all(o).then(t=>{let o=true;for(let e=0;e<t.length;e++){if(t[e].length!==0){o=false;break}}if(o||!e.length){this.oModel.setProperty("/catalogsNoDataText",g.i18n.getText("noCatalogs"))}});const a=t.getInstance();a.publish("launchpad","catalogContentLoaded");const i=e.filter(e=>{const t=this.oLaunchPageService.getCatalogError(e);if(t){u.error("A catalog could not be loaded",t,"sap.ushell.components.CatalogsManager")}return!t});if(i.length!==e.length){l.showLocalizedError("partialCatalogFail")}s.handleTilesVisibility()},createCatalogTiles:async function(e){let t=Promise.resolve();const a=e.getChip&&e.getChip().getBaseChipId&&e.getChip().getBaseChipId();if(a&&["X-SAP-UI2-CHIP:/UI2/DYNAMIC_APPLAUNCHER","X-SAP-UI2-CHIP:/UI2/STATIC_APPLAUNCHER"].indexOf(a)===-1){t=new Promise((t,o)=>{this.oLaunchPageService.getCatalogTileViewControl(e).done(t).fail(o)})}return t.then(async t=>{const a=encodeURIComponent(this._getCatalogTileId(e));const s=this.oTileCatalogToGroupsMap[a]||[];const i=this.oLaunchPageService.getCatalogTileTags(e)||[];const n=this.oLaunchPageService.getCatalogTileContentProviderId(e);const l=await d.getContentProviderLabel(n);if(i.length>0){this.tagsPool=this.tagsPool.concat(i)}if(!t){t=new o({state:"Loading"})}let r=this.oLaunchPageService.getCatalogTilePreviewTitle(e);if(!r){r=this.oLaunchPageService.getCatalogTileTitle(e)}return{associatedGroups:s,src:e,catalog:e.title,catalogId:e.id,title:r,tags:i,keywords:(this.oLaunchPageService.getCatalogTileKeywords(e)||[]).join(","),id:a,size:this.oLaunchPageService.getCatalogTileSize(e),content:[t],isTileIntentSupported:this.oLaunchPageService.isTileIntentSupported(e),tileType:e.tileType,contentProviderLabel:l}})},createGroupAndSaveTile:function(e){const o=e.catalogTileContext;const a=e.newGroupName;const i=new jQuery.Deferred;if(s.validHash(a)&&o){this.createGroup(a).then(e=>{const a=this.oHomepageManager.getDashboardView();if(a&&a.getModel().getProperty("/tileActionModeActive")){t.getInstance().publish("launchpad","AddTileContainerContent")}let s={};this.createTile({catalogTileContext:o,groupContext:e}).done(e=>{s={group:e.group,status:1,action:"addTileToNewGroup"};i.resolve(s)}).fail(e=>{s={group:e.group,status:0,action:"addTileToNewGroup"};i.resolve(s)})})}return i.promise()},createGroup:function(e){const t=this;const o=new jQuery.Deferred;if(!s.validHash(e)){return o.reject(new Error("Invalid group title"))}const a=this.oLaunchPageService.addGroup(e);a.done(e=>{const a=t.oHomepageManager.addGroupToModel(e);o.resolve(a)});a.fail(()=>{l.showLocalizedError("fail_to_create_group_msg");const e={status:0,action:"createNewGroup"};o.resolve(e)});return o.promise()},createTile:function(e){const o=this;const a=e.catalogTileContext;const s=e.groupContext;const i=this.oModel.getProperty(s.getPath());const r=i.groupId;const g=new jQuery.Deferred;let c={};const h=t.getInstance();h.publish("launchpad","addTile",{catalogTileContext:a,groupContext:s});if(!a){u.warning("CatalogsManager: Did not receive catalog tile object. Abort.",this);c={group:i,status:0,action:"add"};return Promise.resolve(c)}const d=this.oLaunchPageService.addTile(a.getProperty("src"),s.getProperty("object"));d.done(e=>{const t=o.oModel.getProperty("/groups");const a=n.getModelPathOfGroup(t,r);o.oHomepageManager.addTileToGroup(a,e);c={group:i,status:1,action:"add"};g.resolve(c)}).fail(()=>{l.showLocalizedError("fail_to_add_tile_msg");c={group:i,status:0,action:"add"};g.resolve(c)});return g.promise()},deleteCatalogTileFromGroup:function(e){const t=this;const o=decodeURIComponent(e.tileId);const a=e.groupIndex;const s=this.oModel.getProperty(`/groups/${a}`);const i=new jQuery.Deferred;const n=[];const l=[];["tiles","links"].forEach(e=>{s[e].forEach(e=>{const a=t.oLaunchPageService.getCatalogTileId(e.object);if(a===o){const o=new jQuery.Deferred;const a=t.oLaunchPageService.removeTile(s.object,e.object);a.done(function(t){return function(){l.push(e.uuid);t.resolve({status:true})}}(o));a.fail(function(e){return function(){e.resolve({status:false})}}(o));n.push(o)}})});jQuery.when.apply(jQuery,n).done(e=>{const o=n.length===l.length;t.oHomepageManager.deleteTilesFromGroup(s.groupId,l);t.updateTilesAssociation();i.resolve({group:s,status:o,action:"remove"})});return i.promise()},calculateCatalogTileIndex:function(e,t,o){let a=parseInt(e*1e5,10);a+=(t!==undefined?t:0)+o;return a},notifyOnActionFailure:function(e,t){l.showLocalizedError(e,t)},resetAssociationOnFailure:function(e,t){this.notifyOnActionFailure(e,t);this.updateTilesAssociation()},_getIsIntentSupported:function(e){return!!this.oLaunchPageService.isTileIntentSupported(e)},_getIsAppBox:function(e){let t;const o=this.oModel.getProperty("/appFinderDisplayMode")||"appBoxes";if(o.toLowerCase()==="tiles"){t=false}else{t=!!(this.oLaunchPageService.getCatalogTileTargetURL(e)&&(this.oLaunchPageService.getCatalogTilePreviewTitle(e)||this.oLaunchPageService.getCatalogTilePreviewSubtitle(e)))}return t},destroy:function(){this.unregisterEvents()}});T.prototype.getInstance=function(){return P};return T});
//# sourceMappingURL=CatalogsManager.js.map