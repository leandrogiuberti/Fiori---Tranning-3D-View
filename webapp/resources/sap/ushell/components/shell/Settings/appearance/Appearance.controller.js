// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/base/Object","sap/ui/core/Component","sap/ui/core/Theming","sap/ui/core/EventBus","sap/ui/core/message/Message","sap/ui/core/message/MessageType","sap/ui/core/mvc/Controller","sap/ui/Device","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/m/GroupHeaderListItem","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/resources","sap/ushell/User","sap/ushell/services/DarkModeSupport","sap/ushell/Container","sap/ushell/utils/LaunchpadError"],(e,t,o,s,n,i,r,a,c,h,jQuery,d,l,g,p,u,m,f,S)=>{"use strict";return a.extend("sap.ushell.components.shell.Settings.appearance.Appearance",{TILE_SIZE:{Small:0,Responsive:1,getName:function(e){return Object.keys(this)[e]}},onInit:function(){const e=this.getView();this.oUser=f.getUser();const t=e.getViewData();this.aThemeListFromServer=t.themeList||[];this.aThemeSets=t.themeSets||[];this.sThemeRoot=t.themeRoot;this.oPersonalizers={};e.setModel(p.i18nModel,"i18n");e.setModel(this.getConfigurationModel(),"config");this._oDarkModeModel=this.getDarkModeModel(this.aThemeListFromServer);e.setModel(this._oDarkModeModel,"darkMode");e.setModel(new h({options:this._getThemeListData(this.oUser.getTheme()),ariaTexts:{headerLabel:p.i18n.getText("Appearance")},deprecatedThemeSelected:this.bShowDeprecationMsg}));this._fnHandleThemeApplied=this._handleThemeApplied.bind(this);s.attachApplied(this._fnHandleThemeApplied)},onExit:function(){s.detachApplied(this._fnHandleThemeApplied)},onAvatarError:function(e){e.oSource.getBindingContext()?.setProperty("avatar","")},getThemeSetHeader:function(e){const t=this.aThemeSets.find(t=>e.key===t.id);const o=t?.label||p.i18n.getText("AppearanceIndividualThemes");return new d({title:o})},_getSelectedThemeData:function(){const e=this.getView().byId("themeList").getSelectedItem();return e?.getBindingContext()?.getProperty?.()},_getSelectedTheme:function(){return this._getSelectedThemeData()?.id||this.oUser.getTheme()},_getThemeListData:function(e){const t=this.aThemeListFromServer||[];const o=this.aThemeSets||[];const s=[];const n=this.sThemeRoot;function i(e){return o.filter(t=>!!t.set.themes?.find?.(t=>t?.id===e))}function r(e){if(n&&e?.avatarRuntimeUrl){return n+e.avatarRuntimeUrl}return undefined}this.bShowDeprecationMsg=false;if(!this._isThemeCofigurable()||this.oUser.isSetThemePermitted()===false){const o=t.find(t=>t?.id===e);return[{id:e,name:o?.name||e,icon:"sap-icon://palette",avatar:r(o),mode:"InlineSvg",deprecated:false,isSelected:true}]}t.forEach(e=>{const t=i(e?.id);if(t.length===0){t.push({})}t.forEach(t=>{const o=t?.set?.themes?.find?.(t=>t.id===e?.id);const n={id:e?.id,name:e?.name||e?.id||"",contrast:o?.contrast,colorScheme:o?.colorScheme,icon:"sap-icon://palette",avatar:r(e),mode:"Image",deprecated:e?.deprecated===true,setId:t.id,isSelected:false};s.push(n)})});if(this._areSetsVisible()){const e=p.i18n.getText("AppearanceAutomaticSelection");o.forEach(t=>{const o={id:t.id,name:e,icon:"sap-icon://sys-monitor",avatar:r(t),mode:"InlineSvg",deprecated:t.deprecated===true,setId:t.id,isSelected:false};s.push(o)})}const a=this.oUser.getThemeSet();let c;if(a){c=s.find(t=>t.id===e&&t.setId===a)}if(!c){c=s.find(t=>t.id===e)}if(this._isDarkModeActive()&&c?.setId){const e=s.find(e=>e.id===c.setId);if(e){c=e}}if(c){c.isSelected=true;this.bShowDeprecationMsg=c.deprecated}return s},_isThemeCofigurable:function(){return l.last("/core/shell/model/setTheme")!==false},getConfigurationModel:function(){const e=l.last("/core/shell/model/contentDensity")&&(c.system.desktop||c.system.combi);const t=l.last("/core/home/sizeBehaviorConfigurable");const o=l.last("/core/contentProviders/providerInfo/enabled")&&l.last("/core/contentProviders/providerInfo/userConfigurable");const s=l.last("/core/contentProviders/providerInfo/showContentProviderInfoOnVisualizations");const n=t||e||o;const i=new h({themeConfigurable:this._isThemeCofigurable(),sizeBehaviorConfigurable:t,tileSize:this.TILE_SIZE[l.last("/core/home/sizeBehavior")],contentDensityConfigurable:e,isCozyContentMode:document.body.classList.contains("sapUiSizeCozy"),textAlign:c.system.phone?"Left":"Right",showContentProviderInfoOnVisualizationsConfigurable:o,showContentProviderInfoOnVisualizationsSelected:s,displaySettingsTabVisible:n});return i},getDarkModeModel:function(){const e=new URLSearchParams(window.location.search);const t=!e.get("sap-theme")&&!e.get("sap-ui-theme");const o=this._isThemeCofigurable();const s=new h({enabled:o,detectionSupported:o&&t,detectionEnabled:o&&t&&this.oUser.getDetectDarkMode()});return s},onAfterRendering:function(){const e=this.getView().getModel("config").getProperty("/themeConfigurable");const t=this.getView().byId("themeList");t.toggleStyleClass("sapUshellThemeListDisabled",!e)},_handleThemeApplied:function(){const e=this.getView().getModel("config");if(e){const e=this._getThemeListData(this.oUser.getTheme());const t=this.getView().getModel();t.setProperty("/options",e);t.setProperty("/deprecatedThemeSelected",this.bShowDeprecationMsg)}},onCancel:function(){const e=this.getView().getModel("config");if(e.getProperty("/themeConfigurable")){const e=this.oUser.getTheme();const t=this.getView().getModel().getProperty("/options");t.forEach(t=>{t.isSelected=e===t.id});this.getView().getModel().setProperty("/options",t)}if(e.getProperty("/showContentProviderInfoOnVisualizationsConfigurable")){e.setProperty("/showContentProviderInfoOnVisualizationsSelected",l.last("/core/contentProviders/providerInfo/showContentProviderInfoOnVisualizations"))}if(e.getProperty("/contentDensityConfigurable")){e.setProperty("/isCozyContentMode",this.oUser.getContentDensity()==="cozy")}if(e.getProperty("/sizeBehaviorConfigurable")){e.setProperty("/tileSize",this.TILE_SIZE[l.last("/core/home/sizeBehavior")])}if(this._oDarkModeModel&&this._oDarkModeModel.getProperty("/enabled")){this._oDarkModeModel.setProperty("/detectionEnabled",this.oUser.getDetectDarkMode());this.oUser.resetChangedProperty("detectDarkMode")}},onSave:function(e){this._updateUserPreferences=e;const o=this.getView().getModel("config");const s=[];if(o.getProperty("/themeConfigurable")){s.push(this.onSaveThemes().then(()=>{g.emit("themeChanged",Date.now())}))}if(o.getProperty("/showContentProviderInfoOnVisualizationsConfigurable")){s.push(this.onSaveShowContentProviderInfoOnVisualizations())}if(o.getProperty("/contentDensityConfigurable")){s.push(this.onSaveContentDensity())}if(o.getProperty("/sizeBehaviorConfigurable")){s.push(this.onSaveTileSize())}if(this._oDarkModeModel&&this._oDarkModeModel.getProperty("/enabled")){s.push(this.onSaveDarkModeEnabled())}return Promise.all(s).then(e=>{const o=e.reduce((e,o)=>{if(o&&t.isObjectA(o,"sap.ui.core.message.Message")){e.push(o)}return e},[]);if(o.length>0){return Promise.reject(o)}})},onSaveThemesSuccess:function(e){e.resetChangedProperty("theme");e.resetChangedProperty("themeSet");return this._applyDarkMode()},onSaveThemes:function(){const t=this._getSelectedThemeData();let o=t?.id;const s=t?.setId;const n=this.oUser;const a=n.getTheme(u.prototype.constants.themeFormat.ORIGINAL_THEME);const c=n.getThemeSet();const h=(this.aThemeSets||[]).find(e=>e.id===o);if(h){const e=m.prototype.prefersDark()?"DARK":"LIGHT";const t=m.prototype.prefersContrast()?"HIGH":"LOW";const s=h.set.themes.find(o=>o.colorScheme===e&&o.contrast===t);o=s?.id||h.set.themes[0].id}this._oDarkModeModel.setProperty("/detectionEnabled",!!h);let d=false;if(o&&o!==a){f.getServiceAsync("UserInfo").then(e=>{e.updateThemeRoot(o)});n.setTheme(o);d=true}if(s!==c){n.setThemeSet(s);d=true}if(d){return this._updateUserPreferences(n).then(()=>this.onSaveThemesSuccess(n)).catch(t=>{if(!t.message.includes("THEME")){return this.onSaveThemesSuccess(n)}n.setTheme(a);n.resetChangedProperty("theme");n.setThemeSet(c);n.resetChangedProperty("themeSet");e.error("Can not save selected theme",t);throw new i({type:r.Error,description:t.message})})}return Promise.resolve()},_onSaveContentDensitySuccess:function(e){const t=this.oUser;t.resetChangedProperty("contentDensity");n.getInstance().publish("launchpad","toggleContentDensity",{contentDensity:e});g.emit("toggleContentDensity",{contentDensity:e});return new Promise(e=>{g.once("toggleContentDensity").do(()=>{e()})})},onSaveContentDensity:function(){const t=this.getView().getModel("config");const o=this.oUser;const s=t.getProperty("/isCozyContentMode")?"cozy":"compact";const n=o.getContentDensity();e.debug("[000] onSaveContentDensity","Appearance.controller");if(s!==n&&t.getProperty("/contentDensityConfigurable")){o.setContentDensity(s);e.debug("[000] onSaveContentDensity: sNewContentDensity",s,"Appearance.controller");return this._updateUserPreferences(o).then(()=>this._onSaveContentDensitySuccess(s)).catch(t=>{if(!t.message.includes("CONTENT_DENSITY")){return this._onSaveContentDensitySuccess()}o.setContentDensity(n);o.resetChangedProperty("contentDensity");e.error("Can not save content density configuration",t);throw new i({type:r.Error,message:t.message})})}return Promise.resolve()},onSaveTileSize:function(){const t=this.getView().getModel("config");const o=this.TILE_SIZE.getName(t.getProperty("/tileSize"));const s=l.last("/core/home/sizeBehavior");if(o&&o!==s&&t.getProperty("/sizeBehaviorConfigurable")){return new Promise((t,s)=>{this.writeToPersonalization("flp.settings.FlpSettings","sizeBehavior",o).then(()=>{l.emit("/core/home/sizeBehavior",o);const e=document.getElementsByClassName(".sapUshellTile");for(let t=0;t<e.length;t++){e[t].classList.toggle("sapUshellSmall",o!=="Responsive")}t()}).catch(t=>{e.error("Cannot save tile size configuration",t);let o;if(t instanceof S){o=new i({type:r.Error,description:t.message,message:t.details?.message.value,date:t.details?.innererror.timestamp,httpStatus:t.details?.httpStatus})}else{o=new i({type:r.Error,description:t.message,message:t.message})}s(o)})})}return Promise.resolve()},onSaveDarkModeEnabledSuccess:async function(e,t){e.resetChangedProperty("detectDarkMode");const o=await f.getServiceAsync("DarkModeSupport");o.toggleDetection(!!t)},onSaveDarkModeEnabled:function(){const t=this._oDarkModeModel.getProperty("/detectionEnabled");const o=this.oUser.getDetectDarkMode();const s=this.oUser;if(t!==o){e.debug("[000] onSaveDarkModeEnabled: setDetectDarkModeEnabled",t,"Appearance.controller");s.setDetectDarkMode(t);return this._updateUserPreferences(this.oUser).then(()=>this.onSaveDarkModeEnabledSuccess(s,t)).catch(n=>{if(!n.message.includes("THEME_DARKMODE_AUTO_DETECTION")){return this.onSaveDarkModeEnabledSuccess(s,t)}s.setDetectDarkMode(o);s.resetChangedProperty("detectDarkMode");e.error("Can not save dark mode configuration",n);throw new i({message:n.message})})}return Promise.resolve()},onSaveShowContentProviderInfoOnVisualizations:function(){const t=l.last("/core/contentProviders/providerInfo/showContentProviderInfoOnVisualizations");const o=this.getView().getModel("config").getProperty("/showContentProviderInfoOnVisualizationsSelected");if(o===t){return Promise.resolve()}return new Promise((t,s)=>{this.writeToPersonalization("flp.settings.FlpSettings","showContentProviderInfoOnVisualizations",o).then(()=>{l.emit("/core/contentProviders/providerInfo/showContentProviderInfoOnVisualizations",o);t()}).catch(t=>{e.error("Cannot save system info on tiles configuration",t);let o;if(t instanceof S){o=new i({type:r.Error,description:t.message,message:t.details?.message.value,date:t.details?.innererror.timestamp,httpStatus:t.details?.httpStatus})}else{o=new i({type:r.Error,description:t.message,message:t.message})}s(o)})})},writeToPersonalization:function(t,o,s){return this.getPersonalizer(t,o).then(e=>e.setPersData(s)).catch(t=>{e.error("Personalization service does not work:",t);throw t})},getPersonalizer:async function(e,t){const s=`${e}-${t}`;if(!this.oPersonalizers[s]){this.oPersonalizers[s]=f.getServiceAsync("PersonalizationV2").then(s=>{const n=o.getOwnerComponentFor(this.getView());const i={keyCategory:s.constants.keyCategory.FIXED_KEY,writeFrequency:s.constants.writeFrequency.LOW,clientStorageAllowed:true};return s.getPersonalizer({container:e,item:t},i,n)})}return this.oPersonalizers[s]},_applyDarkMode:async function(){if(this._areSetsVisible()){const e=await f.getServiceAsync("DarkModeSupport");e.toggleDetection(this._isDarkModeActive())}},_isDarkModeActive:function(){const e=this._oDarkModeModel.getProperty("/");return e.enabled&&e.detectionSupported&&e.detectionEnabled},_areSetsVisible:function(){const e=this._oDarkModeModel.getProperty("/");return e.enabled&&e.detectionSupported},changeSystemModeDetection:function(){const e=this.getView().getModel();e.setProperty("/options",this._getThemeListData(this._getSelectedTheme()));e.setProperty("/deprecatedThemeSelected",this.bShowDeprecationMsg);this.getView().invalidate()}})});
//# sourceMappingURL=Appearance.controller.js.map