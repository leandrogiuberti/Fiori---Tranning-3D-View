// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/i18n/Formatting","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/core/format/DateFormat","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement","sap/ushell/Config","sap/ushell/Container"],(e,t,r,n,a,s,o,i,g,l)=>{"use strict";return s.extend("sap.ushell.components.shell.Settings.userLanguageRegion.LanguageRegionSelector",{onInit:function(){this.oUserInfoServicePromise=l.getServiceAsync("UserInfo");this.oUserInfoServicePromise.then(e=>{this.oUser=l.getUser();const s=new r(t.getLanguageTag());const i=n.getInstance(s);let u;let m;let c;let d;let L;const h=l.getRendererInternal("fiori2").getShellConfig().enableSetLanguage||false;const P=this.oUser.isLanguagePersonalized();const p=e.getUserSettingListEditSupported();const f=[];const F=e=>this.oUser.getEditState(e)!==1;const S={preferredLogonLanguage:F("PREFERRED_LOGON_LANGUAGE"),dateFormat:F("DATE_FORMAT"),timeFormat:F("TIME_FORMAT"),numberFormat:F("NUMBER_FORMAT"),timeZone:F("TIME_ZONE")};S.showWarning=Object.values(S).some(e=>e===false);if(p){u=t.getABAPDateFormat();c=t.getABAPTimeFormat();d=this._getABAPNumberFormat();L=this.oUser.getCalendarWeekNumbering?.()||"Default";f.push(this._loadUserSettingList())}else{u=i.getDatePattern("medium");m=i.getTimePattern("medium");c=m.indexOf("H")===-1?"12h":"24h";L="Default"}const T=new o({languageList:null,DateFormatList:null,TimeFormatList:null,NumberFormatList:null,TimeZoneList:null,CalendarWeekNumberingList:null,cuaFlags:S,selectedLanguage:this.oUser.getLanguage(),selectedLanguageText:this.oUser.getLanguageText(),selectedDatePattern:u,selectedTimeFormat:c,selectedNumberFormat:d,selectedTimeZone:this.oUser.getTimeZone(),selectedCalendarWeekNumbering:L,isSettingsLoaded:true,isLanguagePersonalized:P,isEnableSetLanguage:h,isEnableUserProfileSetting:p,isTimeZoneFromServerInUI5:g.last("/core/ui5/timeZoneFromServerInUI5")});T.setSizeLimit(1e3);if(h){f.push(this._loadLanguagesList())}if(f.length>0){this.getView().setBusy(true);return Promise.all(f).then(t=>{const r=p?t[0]:null;let n=null;if(h){n=t.length===1?t[0]:t[1]}if(n?.length>1){T.setProperty("/languageList",n);const e=n.some(e=>e.key==="default");if(!P&&e){T.setProperty("/selectedLanguage","default")}}if(r?.TIME_FORMAT?.length>0){T.setProperty("/TimeFormatList",r.TIME_FORMAT)}if(r?.DATE_FORMAT?.length>0){T.setProperty("/DateFormatList",r.DATE_FORMAT)}if(r?.TIME_ZONE?.length>0){const e=a.getDateTimeWithTimezoneInstance({showDate:false,showTime:false});const t=r.TIME_ZONE.map(t=>{const r=e.format(null,t.description)||t.description;return{description:r,value:t.value}});T.setProperty("/TimeZoneList",t)}if(r?.NUMBER_FORMAT?.length>0){T.setProperty("/NumberFormatList",r.NUMBER_FORMAT)}if(r?.CALENDAR_WEEK_NUMBERING){const t=e.getCalendarWeekNumberingList().map(e=>{e.selected=e.value===T.getProperty("/selectedCalendarWeekNumbering");return e});T.setProperty("/CalendarWeekNumberingList",t)}this.oView.setModel(T);this.getView().setBusy(false)})}this.oView.setModel(T)})},_loadLanguagesList:function(){i.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");return this.oUserInfoServicePromise.then(t=>new Promise(r=>{i.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");t.getLanguageList().done(e=>{i.end("FLP:LanguageRegionSelector._getLanguagesList");r(e)}).fail(t=>{i.end("FLP:LanguageRegionSelector._getLanguagesList");e.error("Failed to load language list.",t,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");r(null)})}))},_loadUserSettingList:function(){i.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");return this.oUserInfoServicePromise.then(e=>new Promise(t=>{i.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");e.getUserSettingList().then(e=>{i.end("FLP:LanguageRegionSelector._loadUserSettingList");t(e)})}))},_resetLanguage:function(){const e=this.oUser.getLanguage();const t=this.getView().getModel();const r=t.getData();const n=r.isLanguagePersonalized?e:"default";t.setProperty("/selectedLanguage",n);this._updateTextFields(e)},onCancel:function(){const e=this.getView().getModel();const t=e.getData();const r=t.languageList;const n=t.isEnableSetLanguage;if(n&&r){this._resetLanguage()}if(t.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues()}},onSaveSuccess:function(t,r,n){const a={refresh:true};t.resetChangedProperty("dateFormat");t.resetChangedProperty("timeFormat");t.resetChangedProperty("numberFormat");t.resetChangedProperty("timeZone");t.resetChangedProperty("calendarWeekNumbering");if(r){e.debug("[000] onSaveSuccess: oUser.resetChangedPropertyLanguage:","LanguageRegionSelector.controller");t.resetChangedProperty("language");a.obsoleteUrlParams=["sap-language"];a.clearSapUserContextCookie=true}return a},onSave:function(r){const n=this.oUser;const a=this.getView().getModel().getData();const s=a.selectedLanguage;const o=n.getLanguage();const i=s&&s!==(a.isLanguagePersonalized?o:"default");const g=a.isEnableUserProfileSetting;const l=a.isEnableSetLanguage&&a.languageList&&i;let u=false;const m=["DATE_FORMAT","TIME_FORMAT","NUMBER_FORMAT","TIME_ZONE","LANGUAGE","CALENDAR_WEEK_NUMBERING"];e.debug("[000] LanguageRegionSelector:onSave:bUpdateLanguage, bIsEnableSetUserProfileSetting:",l,"LanguageRegionSelector.controller");if(l){e.debug("[000] LanguageRegionSelector:onSave:UserInfo: oUser.setLanguage:",s,"LanguageRegionSelector.controller");n.setLanguage(s)}else{this._resetLanguage()}if(g){if(t.getABAPDateFormat()!==a.selectedDatePattern){u=true;n.setChangedProperties({propertyName:"dateFormat",name:"DATE_FORMAT"},t.getABAPDateFormat(),a.selectedDatePattern)}if(t.getABAPTimeFormat()!==a.selectedTimeFormat){u=true;n.setChangedProperties({propertyName:"timeFormat",name:"TIME_FORMAT"},t.getABAPTimeFormat(),a.selectedTimeFormat)}if(this._getABAPNumberFormat()!==a.selectedNumberFormat){u=true;n.setChangedProperties({propertyName:"numberFormat",name:"NUMBER_FORMAT"},this._getABAPNumberFormat(),a.selectedNumberFormat)}if(!a.selectedTimeZone){this.getView().getModel().setProperty("/selectedTimeZone",this.oUser.getTimeZone())}else if(this.oUser.getTimeZone()!==a.selectedTimeZone){u=true;n.setChangedProperties({propertyName:"timeZone",name:"TIME_ZONE"},this.oUser.getTimeZone(),a.selectedTimeZone)}if(t.getCalendarWeekNumbering()!==a.selectedCalendarWeekNumbering){u=true;n.setChangedProperties({propertyName:"calendarWeekNumbering",name:"CALENDAR_WEEK_NUMBERING"},t.getCalendarWeekNumbering(),a.selectedCalendarWeekNumbering.trim());t.setCalendarWeekNumbering(a.selectedCalendarWeekNumbering)}}if(l||u){return r().then(()=>{e.debug("[000] onSave:fnUpdateUserPreferences","LanguageRegionSelector.controller");return this.onSaveSuccess(n,l,s)}).catch(t=>{e.debug("[000] onSave:catch:errorMessage",t,"LanguageRegionSelector.controller");const r=m.some(e=>t.message.includes(e));if(!r){return this.onSaveSuccess(n,l,s)}if(l){n.setLanguage(o);n.resetChangedProperty("language");this._updateTextFields(o)}n.resetChangedProperty("dateFormat");n.resetChangedProperty("timeFormat");n.resetChangedProperty("numberFormat");n.resetChangedProperty("timeZone");n.resetChangedProperty("calendarWeekNumbering");if(a.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues()}e.error("Failed to save Language and Region Settings",t,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");throw t})}return Promise.resolve()},_restoreUserSettingPreferenceValues:function(){const e=this.getView().getModel();e.setProperty("/selectedDatePattern",t.getABAPDateFormat());e.setProperty("/selectedTimeFormat",t.getABAPTimeFormat());e.setProperty("/selectedNumberFormat",this._getABAPNumberFormat());e.setProperty("/selectedTimeZone",this.oUser.getTimeZone());e.setProperty("/selectedCalendarWeekNumbering",t.getCalendarWeekNumbering());const r=e.getProperty("/CalendarWeekNumberingList").map(e=>{e.selected=e.value===t.getCalendarWeekNumbering();return e});e.setProperty("/CalendarWeekNumberingList",r)},_handleLanguageSelectChange:function(e){const t=e.getSource().getSelectedKey();if(t){this._updateTextFields(t)}},_updateTextFields:function(e){let a;if(e===this.oUser.getLanguage()){a=new r(t.getLanguageTag())}else{a=new r(e)}const s=this.getView().getModel();const o=n.getInstance(a);const i=o.getDatePattern("medium");const g=o.getTimePattern("medium");const l=g.indexOf("H")===-1?"12h":"24h";if(!s.getData().isEnableUserProfileSetting){s.setProperty("/selectedDatePattern",i);s.setProperty("/selectedTimeFormat",l)}},_getABAPNumberFormat:function(){const e=t.getABAPNumberFormat();if(e){return e.trim()}},_handleCalendarWeekNumberingChange:function(e){const t=e.getSource().getSelectedItem().getCustomData()[0].getValue();this.getView().getModel().setProperty("/selectedCalendarWeekNumbering",t)}})});
//# sourceMappingURL=LanguageRegionSelector.controller.js.map