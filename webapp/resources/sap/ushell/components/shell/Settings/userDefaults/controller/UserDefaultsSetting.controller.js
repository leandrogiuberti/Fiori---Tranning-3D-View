// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/i18n/Localization","sap/base/util/deepExtend","sap/base/util/deepEqual","sap/m/Button","sap/m/Input","sap/m/library","sap/ui/core/mvc/Controller","sap/ui/comp/smartfield/SmartField","sap/ui/comp/smartfield/SmartLabel","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartvariants/PersonalizableInfo","sap/ui/core/Title","sap/ui/model/json/JSONModel","sap/ui/model/odata/v2/ODataModel","sap/ushell/resources","sap/m/MessageBox","./ExtendedValueDialog.controller","sap/ushell/Container"],(e,t,a,r,s,n,o,i,d,l,u,c,m,h,p,f,g,y,P,M)=>{"use strict";const v=o.ButtonType;function b(e,t){if(!(t.editorMetadata&&t.editorMetadata.groupId)){return-1}if(!(e.editorMetadata&&e.editorMetadata.groupId)){return 1}if(e.editorMetadata.groupId<t.editorMetadata.groupId){return-1}if(e.editorMetadata.groupId>t.editorMetadata.groupId){return 1}return 0}function S(e,t){if(!(t.editorMetadata&&t.editorMetadata.parameterIndex)){return-1}if(!(e.editorMetadata&&e.editorMetadata.parameterIndex)){return 1}return e.editorMetadata.parameterIndex-t.editorMetadata.parameterIndex}function D(e,t){const a=b(e,t);if(a===0){return S(e,t)}return a}return i.extend("sap.ushell.components.shell.Settings.userDefaults.controller.UserDefaultsSetting",{onInit:function(){this.oModelRecords={};this.aChangedParamsNames=[];this.oBlockedParameters={};this.aDisplayedUserDefaults=[];this.oDirtyStateModel=new p({isDirty:false,selectedVariant:null});this.getView().setModel(this.oDirtyStateModel,"DirtyState");this.oOriginalParameters={};const t=this.getView();t.setBusy(true);t.setModel(g.i18nModel,"i18n");this.getSystemContextsModel().then(e=>{t.setModel(e,"systemContexts");return this._fillGroups()}).then(this._saveIsSupportedPlatform.bind(this)).then(this._initializeSmartVariantManagement.bind(this)).then(()=>{t.setBusy(false)}).catch(a=>{e.error("Error during UserDefaultsSetting controller initialization",a,"sap.ushell.components.shell.Settings.userDefaults.UserDefaultsSetting");t.setBusy(false)})},getSystemContextsModel:function(){const e=new p({systemContexts:[],selectedKey:""});const t=this._getContentProviderIds();const a=M.getServiceAsync("ClientSideTargetResolution");const r=M.getServiceAsync("UserDefaultParameters");return Promise.all([t,a,r]).then(t=>{const a=t[0];const r=t[1];const s=t[2];if(a.length===0){a.push("")}return Promise.all(a.map(t=>r.getSystemContext(t).then(t=>{const a=e.getProperty("/systemContexts");return s.hasRelevantMaintainableParameters(t).then(e=>{if(e){a.push(t)}})}))).then(()=>{const t=e.getProperty("/systemContexts");if(t.length>0){e.setProperty("/selectedKey",t[0].id)}return e})})},_getContentProviderIds:function(){return M.getServiceAsync("CommonDataModel").then(e=>e.getContentProviderIds()).catch(()=>[""])},handleSystemContextChanged:function(){if(this.oDirtyStateModel.getProperty("/isDirty")){const e=g.i18n.getText("userDefaultsSave");const t=g.i18n.getText("userDefaultsDiscard");y.show(g.i18n.getText("userDefaultsUnsavedChangesMessage"),{title:g.i18n.getText("userDefaultsUnsavedChangesTitle"),actions:[e,t,y.Action.CANCEL],emphasizedAction:e,icon:y.Icon.QUESTION,onClose:function(a){if(a===t){this._fillGroups();this._setDirtyState(false)}else if(a===e){this.onSave();this._fillGroups();this._setDirtyState(false)}else{this.getView().getModel("systemContexts").setProperty("/selectedKey",this.sLastSelectedKey)}}.bind(this)})}else{this._fillGroups()}},_fillGroups:async function(){const e=this.getView().byId("userDefaultsForm");e.removeAllGroups();const t=this.getView().getModel("systemContexts").getProperty("/selectedKey");const r=this.getView().getModel("systemContexts").getProperty("/systemContexts").find(e=>e.id===t);const s=await M.getServiceAsync("UserDefaultParameters");const n=await s.editorGetParameters(r);this.oOriginalParameters=a({},n);this.oModel=new p(n);this.oModel.setDefaultBindingMode("TwoWay");this.getView().setModel(this.oModel,"MdlParameter");const o=await this._getFormattedParameters(this.oModel);const i=this._createContent(o);i.forEach(t=>{e.addGroup(t)})},_getFormattedParameters:function(t){const r=t.getData("/");const s=Object.keys(r).map(s=>{const n=a({},r[s]);n.parameterName=s;n.editorMetadata=n.editorMetadata||{};if(n.editorMetadata.editorInfo&&n.editorMetadata.editorInfo.propertyName){return this._createOdataModelBinding(n,t).then(e=>{n.modelBind=e;const t=e.model?e.model.getMetaModel():undefined;if(t){return t.loaded().then(()=>{const e=t.getObject("/dataServices/schema/0/namespace");const a=t.getODataEntityType(`${e}.${n.editorMetadata.editorInfo.entityName}`);const r=a.property.find(e=>{if(e.name===n.editorMetadata.editorInfo.propertyName){return true}});switch(r.type){case"Edm.DateTime":n.valueObject.value=n.valueObject.value?new Date(n.valueObject.value):null;break;default:n.valueObject.value=n.valueObject.value?n.valueObject.value:"";break}return n})}n.valueObject=a({value:""},n.valueObject);return n}).catch(()=>{e.error(`Metadata loading for parameter ${n.parameterName} failed${JSON.stringify(n.editorMetadata)}`);n.valueObject=a({value:""},n.valueObject);n.modelBind=this._createPlainModelBinding(n,t);this.oBlockedParameters[n.parameterName]=false;return Promise.resolve(n)})}n.valueObject=a({value:""},n.valueObject);n.modelBind=this._createPlainModelBinding(n,t);return Promise.resolve(n)});return Promise.all(s).then(e=>{e.sort(D);this.aDisplayedUserDefaults=e;e.forEach(e=>{e.modelBind.model.setProperty(e.modelBind.sFullPropertyPath,e.valueObject.value);e.modelBind.model.bindTree(e.modelBind.sFullPropertyPath).attachChange(this.storeChangedData.bind(this))});return e})},_createPlainModelBinding:function(e,t){const a=`/${e.parameterName}/valueObject/value`;if(!t.getProperty(`/${e.parameterName}/valueObject`)){t.setProperty(`/${e.parameterName}/valueObject`,{})}const r={isOdata:false,model:t,extendedModel:t,sFullPropertyPath:a,sPropertyName:`{${a}}`};return r},_createOdataModelBinding:function(e,t){const a=e.editorMetadata.editorInfo;const r=this._getODataServiceData(a.odataURL,e);return r.metadataLoaded.then(()=>{const e={isOdata:true,model:r.model,extendedModel:t,sPropertyName:`{${a.propertyName}}`,sFullPropertyPath:`${a.bindingPath}/${a.propertyName}`};return e})},_getODataServiceData:function(e,a){if(!this.oModelRecords[e]){const a=new f(e,{metadataUrlParams:{"sap-documentation":"heading,quickinfo","sap-value-list":"none","sap-lang-cachebuster":t.getLanguageTag().toString()},json:true});a.setDefaultCountMode("None");a.setDefaultBindingMode("TwoWay");this.oModelRecords[e]={attachedListeners:[],model:a,metadataLoaded:new Promise((e,t)=>{a.attachMetadataLoaded(e);a.attachMetadataFailed(t)})}}if(this.oModelRecords[e].attachedListeners.indexOf(a.parameterName)===-1){this.oModelRecords[e].attachedListeners.push(a.parameterName);this.oModelRecords[e].model.attachRequestCompleted(this._overrideOdataModelValue.bind(this,a));this.oBlockedParameters[a.parameterName]=true}return this.oModelRecords[e]},_overrideOdataModelValue:function(e,t){const a=t.getSource();const r=`/${t.getParameter("url").replace(/\?.*/,"")}`;if(e.editorMetadata.editorInfo.bindingPath===r){const t=`${e.editorMetadata.editorInfo.bindingPath}/${e.editorMetadata.editorInfo.propertyName}`;if(a.getProperty(t)!==e.valueObject.value){a.setProperty(t,e.valueObject.value)}this.oBlockedParameters[e.parameterName]=false}},_createContent:function(e){let t="nevermore";let a;const r={};const s=[];for(let n=0;n<e.length;++n){const o=e[n];const i=o.modelBind;if(t!==o.editorMetadata.groupId){a=new u({title:new h({text:o.editorMetadata.groupTitle||undefined})});t=o.editorMetadata.groupId;s.push(a)}const d=this._createGroupElement(o);d.setModel(i.model);if(i.isOdata){const e=o.editorMetadata.editorInfo.odataURL;if(!r[e]){const t=o.editorMetadata.editorInfo.bindingPath;d.bindElement(t);r[e]=o.modelBind.model.getContext(t)}else{d.setBindingContext(r[e])}}a.addGroupElement(d)}return s},_createGroupElement:function(e){let t;const a=new l({});const r=new s({text:"{i18n>userDefaultsExtendedParametersTitle}",tooltip:"{i18n>userDefaultsExtendedParametersTooltip}",visible:!!e.editorMetadata.extendedUsage,type:{parts:[`MdlParameter>/${e.parameterName}/valueObject/extendedValue/Ranges`],formatter:e=>e&&e.length?v.Emphasized:v.Transparent},press:t=>{P.openDialog(e,this.saveExtendedValue.bind(this))}});if(e.modelBind.isOdata&&e.editorMetadata.editorInfo){t=new d({value:e.modelBind.sPropertyName,name:e.parameterName,fieldGroupIds:["UserDefaults"]});a.setLabelFor(t)}else{t=new n({name:e.parameterName,value:e.modelBind.sPropertyName,fieldGroupIds:["UserDefaults"],type:"Text"});t.addAriaLabelledBy(a);a.setText(e.editorMetadata.displayText||e.parameterName);a.setTooltip(e.editorMetadata.description||e.parameterName)}t.attachChange(this.storeChangedData.bind(this));t.attachChange(this._setDirtyState.bind(this,true),this);const o=new c({elements:[t,r],label:a});return o},saveExtendedValue:function(e){const t=e.getSource().getModel().getProperty("/parameterName");const a=this.oModel;const r=e.getParameters().tokens||[];const s=`/${t}/valueObject/extendedValue/Ranges`;const n=r.map(e=>{const t=e.data("range");return{Sign:t.exclude?"E":"I",Option:t.operation!=="Contains"?t.operation:"CP",Low:t.value1,High:t.value2||null}});if(!a.getProperty(`/${t}/valueObject/extendedValue`)){a.setProperty(`/${t}/valueObject/extendedValue`,{})}a.setProperty(s,n);this.aChangedParamsNames.push(t);if(e.getParameter("_tokensHaveChanged")){this._setDirtyState(true)}},_setDirtyState:function(e){this.oDirtyStateModel.setProperty("/isDirty",e);this._setSmartVariantModified(e);if(e){this.sLastSelectedKey=this.getView().getModel("systemContexts").getProperty("/selectedKey")}},_setSelectedVariant:function(e){this.oDirtyStateModel.setProperty("/selectedVariant",e);this.storeChangedData()},storeChangedData:function(){const e=this.aDisplayedUserDefaults||[];for(let t=0;t<e.length;++t){const s=e[t].parameterName;const n=this.oModel.getProperty(`/${s}/valueObject/`);const o=e[t].modelBind;if(!this.oBlockedParameters[s]){const e={value:n&&n.value,extendedValue:n&&n.extendedValue};if(o&&o.model){const t=o.model;const i=o.extendedModel;const d=o.sFullPropertyPath;const l={value:t.getProperty(d)!==""?t.getProperty(d):undefined,extendedValue:i.getProperty(`/${s}/valueObject/extendedValue`)||undefined};if(!r(l,e)){n.value=l.value;if(l.extendedValue){n.extendedValue={};a(n.extendedValue,l.extendedValue)}this.oModel.setProperty(`/${s}/valueObject`,n);this.aChangedParamsNames.push(s)}}}}},onCancel:function(){this._setDirtyState(false);const e=this.aDisplayedUserDefaults;if(this.aChangedParamsNames.length>0){for(let t=0;t<e.length&&this.aChangedParamsNames.length>0;t++){const a=e[t].parameterName;if(this.aChangedParamsNames.indexOf(a)>-1){const r=this.oOriginalParameters[a];const s=e[t];const n=s.modelBind;const o=n.model?n.model.getMetaModel():undefined;if(o){const e=o.getObject("/dataServices/schema/0/namespace");const t=o.getODataEntityType(`${e}.${s.editorMetadata.editorInfo.entityName}`);const a=t.property.find(e=>{if(e.name===s.editorMetadata.editorInfo.propertyName){return true}});switch(a.type){case"Edm.DateTime":n.model.setProperty(n.sFullPropertyPath,new Date(r.valueObject.value)||null);break;default:n.model.setProperty(n.sFullPropertyPath,r.valueObject.value||"");break}}else{n.model.setProperty(n.sFullPropertyPath,r.valueObject.value||"")}if(r.editorMetadata&&r.editorMetadata.extendedUsage){n.extendedModel.setProperty(`/${a}/valueObject/extendedValue`,r.valueObject.extendedValue||{})}}}this.aChangedParamsNames=[]}this._setDefaultVariant()},onSave:function(){this.storeChangedData();this._setDirtyState(false);let e;if(this.aChangedParamsNames.length===0){e=Promise.resolve()}else{e=M.getServiceAsync("ClientSideTargetResolution").then(e=>e.getSystemContext(this.sLastSelectedKey)).then(e=>{const t=this.aChangedParamsNames.sort();this.aChangedParamsNames=[];return this._saveParameterValues(t,e)})}return e.then(this._resetSmartVariantManagement.bind(this)).then(this._setDefaultVariant.bind(this))},_saveParameterValues:function(e,t){const a=[];for(let s=0;s<e.length;s++){const n=e[s];const o=this.oModel.getProperty(`/${n}/valueObject/`);const i=this.oOriginalParameters[n].valueObject;if(!r(i,o)){if(o&&o.value===null||o&&o.value===""){o.value=undefined}if(o&&o.extendedValue&&Array.isArray(o.extendedValue.Ranges)&&o.extendedValue.Ranges.length===0){o.extendedValue=undefined}const e=this._saveParameterValue(n,o,i,t);a.push(e)}}return Promise.all(a)},_saveParameterValue:async function(e,t,a,r){const s=await M.getServiceAsync("UserDefaultParameters");await s.editorSetValue(e,t,r);a.value=t.value},_setSmartVariantModified:function(e){if(!this._bIsSupportedPlatform){return}this.getView().byId("defaultSettingsVariantManagement").currentVariantSetModified(e)},_setDefaultVariant:function(){if(!this._bIsSupportedPlatform){return}const e=this.getView().byId("defaultSettingsVariantManagement");e.setCurrentVariantId(e.getDefaultVariantKey());this._setSelectedVariant(e.getDefaultVariantKey())},_resetSmartVariantManagement:function(){if(!this._bIsSupportedPlatform){return Promise.resolve()}this.getView().byId("defaultSettingsVariantManagement").removeAllPersonalizableControls();return this._initializeSmartVariantManagement()},_initializeSmartVariantManagement:function(){if(!this._bIsSupportedPlatform){return Promise.resolve()}const e=this.getView().byId("defaultSettingsVariantManagement");const t=function(){this._setSelectedVariant(e.getSelectionKey())}.bind(this);return new Promise(a=>{const r=this.getView().byId("userDefaultsForm");const s=new m({type:"wrapper",keyName:"persistencyKey",dataSource:"none",control:r});e.detachSelect(t).detachAfterSave(t).addPersonalizableControl(s).attachSelect(t).attachAfterSave(t).initialise(()=>{e.setVisible(true);a()},r)}).then(t)},_saveIsSupportedPlatform:function(){const e=M.getLogonSystem().getPlatform();this._bIsSupportedPlatform=e!=="cdm";return Promise.resolve(this._bIsSupportedPlatform)},displayDiffText:function(){if(!this._bIsSupportedPlatform){return false}const e=this.getView().byId("defaultSettingsVariantManagement");const t=this.getView().byId("userDefaultsForm");const a=e.getStandardVariantKey();const s=e.getSelectionKey();if(s===a){return false}const n=e.getVariantContent(t,a);const o=e.getVariantContent(t,s);delete o.executeOnSelection;return!r(n,o)}})});
//# sourceMappingURL=UserDefaultsSetting.controller.js.map