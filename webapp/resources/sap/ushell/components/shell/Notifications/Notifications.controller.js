// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/m/CustomListItem","sap/m/library","sap/m/MessageToast","sap/m/Text","sap/m/VBox","sap/ui/core/library","sap/ui/core/mvc/Controller","sap/ui/core/StaticArea","sap/ui/Device","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/ushell/Container","sap/ushell/resources","sap/ushell/utils"],(t,e,i,o,s,n,r,a,c,f,l,jQuery,h,u,g)=>{"use strict";const d=r.Priority;const I=i.ListType;const N=i.FlexAlignItems;async function T(t){const e=await h.getServiceAsync("MessageInternal");e.error(t)}return a.extend("sap.ushell.components.shell.Notifications.Notifications",{oPagingConfiguration:{MAX_NOTIFICATION_ITEMS_DESKTOP:400,MAX_NOTIFICATION_ITEMS_MOBILE:100,MIN_NOTIFICATION_ITEMS_PER_BUFFER:15,NOTIFICATION_ITEM_HEIGHT:f.system.phone||f.system.tablet?130:100,TAB_BAR_HEIGHT:100},onInit:function(){const t={};if(f.system.desktop){this.iMaxNotificationItemsForDevice=this.oPagingConfiguration.MAX_NOTIFICATION_ITEMS_DESKTOP}else{this.iMaxNotificationItemsForDevice=this.oPagingConfiguration.MAX_NOTIFICATION_ITEMS_MOBILE}const e=this.getView();this.oNotificationsService=e.getViewData().notificationsService;this.oSortingType=this.oNotificationsService.getOperationEnum();this.oKeyToSortingMap={sapUshellNotificationIconTabByDate:this.oSortingType.NOTIFICATIONS_BY_DATE_DESCENDING,sapUshellNotificationIconTabByType:this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING,sapUshellNotificationIconTabByPrio:this.oSortingType.NOTIFICATIONS_BY_PRIORITY_DESCENDING};t[this.oSortingType.NOTIFICATIONS_BY_DATE_DESCENDING]=this.getInitialSortingModelStructure();t[this.oSortingType.NOTIFICATIONS_BY_PRIORITY_DESCENDING]=this.getInitialSortingModelStructure();t[this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING]={};this.sCurrentSorting=this.oSortingType.NOTIFICATIONS_BY_DATE_DESCENDING;this.oPreviousTabKey="sapUshellNotificationIconTabByDate";const i=new l(t);i.setSizeLimit(1500);e.setModel(i);e.setModel(u.i18nModel,"i18n");this.getNextBuffer()},onAfterRendering:function(){this.removeTabIndexFromList(this.sCurrentSorting);const t=this.getView();const e=t.byId("notificationIconTabBar--header");if(e){e.getDomRef().classList.remove("sapContrastPlus")}t.$("-sapUshellNotificationIconTabByDate-text").attr("aria-label",u.i18n.getText("Notifications.ByDateDescending.AriaLabel"));t.$("-sapUshellNotificationIconTabByType-text").attr("aria-label",u.i18n.getText("Notifications.ByType.AriaLabel"));t.$("-sapUshellNotificationIconTabByPrio-text").attr("aria-label",u.i18n.getText("Notifications.ByPriority.AriaLabel"))},shouldFetchMoreNotifications:function(){const t=this.getModel();const e=t.getProperty(`/${this.sCurrentSorting}/hasMoreItemsInBackend`);const i=t.getProperty(`/${this.sCurrentSorting}/listMaxReached`);return e&&!i},getNextBuffer:async function(){const t=this.getModel();const e=this.getItemsFromModel(this.sCurrentSorting);let i;if(!this.shouldFetchMoreNotifications()){return}const o=this.getNumberOfItemsToFetchOnScroll(this.sCurrentSorting);if(o===0){t.setProperty(`/${this.sCurrentSorting}/hasMoreItems`,false);return}if(e!==undefined){i=e.length}if(i===0){this.addBusyIndicatorToTabFilter(this.sCurrentSorting)}t.setProperty(`/${this.sCurrentSorting}/inUpdate`,true);try{const t=await this.oNotificationsService.getNotificationsBufferBySortingType(this.sCurrentSorting,i,o);const e=this.oNotificationsService._getNotificationSettingsAvailability();if(e.state()==="pending"){this.oNotificationsService._userSettingInitialization()}this.addBufferToModel(this.sCurrentSorting,t)}catch(t){if(i===0){this.removeBusyIndicatorToTabFilter(this.sCurrentSorting);T(u.i18n.getText("errorOccurredMsg"))}}},getNextBufferForType:async function(){const t=this.getModel();const e=this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING;const i=t.getProperty(`/${e}`);const o=i.find(t=>t.Id===this.sCurrentExpandedType);if(!o||!o.hasMoreItems){return}await this.updateGroupHeaders(true)},addBufferToModel:function(t,e){const i=this.getModel();if(!e){i.setProperty(`/${t}/hasMoreItemsInBackend`,false);return}const o=this.getItemsFromModel(t);const s=e.length>=this.getNumberOfItemsToFetchOnScroll(t);i.setProperty(`/${t}/hasMoreItemsInBackend`,s);const n=o.concat(e);i.setProperty(`/${t}/aNotifications`,n);i.setProperty(`/${t}/inUpdate`,false);if(n.length>=this.iMaxNotificationItemsForDevice){this.handleMaxReached(t)}if(o.length===0){this.removeBusyIndicatorToTabFilter(t)}},isMoreCircleExist:function(t){const e=this.getNotificationList(t);const i=e.getItems();const o=i.length;const s=i[o-1];return!!o&&s.getMetadata().getName()==="sap.m.CustomListItem"},handleMaxReached:function(t){const e=this.getNotificationList(t);const i=Math.floor(this.oNotificationsService.getNotificationsCount());const o=i-this.iMaxNotificationItemsForDevice;const s=this.isMoreCircleExist(t);const n=this.getModel();n.setProperty(`/${this.sCurrentSorting}/moreNotificationCount`,o);n.setProperty(`/${this.sCurrentSorting}/listMaxReached`,o>=0);if(o>0&&!s){e.addItem(this.getMoreCircle(this.sCurrentSorting))}else if(o<=0&&s){e.removeItem(this.oMoreListItem)}},updateGroupHeaders:async function(e){const i=this.getModel();const o=this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING;const s=i.getProperty(`/${o}`);s.inUpdate=true;let n=0;if(this.sCurrentExpandedType){const t=s.find(t=>t.Id===this.sCurrentExpandedType);if(t){n=t.aNotifications.length;if(e){n+=this.getBasicBufferSize()}t.Busy=true}}i.setProperty(`/${o}`,s);this.addBusyIndicatorToTabFilter(o);try{const t=await this.oNotificationsService.getNotificationsGroupHeaders();const e=JSON.parse(t).value;e.inUpdate=false;let s=-1;e.forEach((t,e)=>{if(t.Id&&this.sCurrentExpandedType===t.Id){t.Collapsed=false;s=e}else{t.Collapsed=true;t.aNotifications=[]}});const r=this.sCurrentExpandedType;if(r){const t=e[s];if(t){t.aNotifications=await this.oNotificationsService.getNotificationsBufferInGroup(r,0,this.getNumberOfItemsToFetchOnUpdate(n))||[];if(t.aNotifications.length<this.getBasicBufferSize()){t.hasMoreItems=false}else{t.hasMoreItems=true}}}i.setProperty(`/${o}`,e)}catch(e){t.error("Notifications control - call to getNotificationsGroupHeaders or getNotificationsBufferInGroup failed: ",e,"sap.ushell.components.shell.Notifications.Notifications")}finally{this.removeBusyIndicatorToTabFilter(o);this._retainFocus()}},updateNotifications:async function(){const e=this.sCurrentSorting;this.addBusyIndicatorToTabFilter(e);const i=this.getNumberOfItemsToFetchOnScroll(e);try{const t=await this.oNotificationsService.getNotificationsBufferBySortingType(e,0,i);const o=this.getModel();o.setProperty(`/${e}/aNotifications`,t)}catch(e){t.error("Notifications control - call to notificationsService.getNotificationsBufferBySortingType failed: ",e,"sap.ushell.components.shell.Notifications.Notifications")}finally{this.removeBusyIndicatorToTabFilter(e);this._retainFocus()}},markRead:async function(t){this.setMarkReadOnModel(t,true);try{await this.oNotificationsService.markRead(t)}catch(e){T(u.i18n.getText("notificationsFailedMarkRead"));this.setMarkReadOnModel(t,false)}},onBeforeRendering:function(){if(!this._bDependencyCallbackRegistered){this._bDependencyCallbackRegistered=true;this.oNotificationsService.registerNotificationsUpdateCallback(this.refreshModel.bind(this),false)}},executeAction:function(t,e){return this.oNotificationsService.executeAction(t,e)},executeBulkAction:async function(t,e,i,s){let n;const r=this.getModel();const a=r.getProperty(`${s}/NotificationTypeDesc`)||r.getProperty(`${s}/NotificationTypeKey`);try{await this.oNotificationsService.executeBulkAction(i.Id,t);n=u.i18n.getText("notificationsSuccessExecuteBulkAction",[e,a]);o.show(n,{duration:4e3});await this.refreshModel()}catch(t){const i=t.succededNotifications&&t.succededNotifications.length;if(i){const s=t.failedNotifications.length;n=u.i18n.getText("notificationsPartialSuccessExecuteBulkAction",[e,i,s+i,a,s]);o.show(n,{duration:4e3});await this.refreshModel()}else{T(u.i18n.getText("notificationsFailedExecuteBulkAction"))}}finally{r.setProperty(`${s}/Busy`,false);this._retainFocus()}},dismissNotification:async function(t){try{await this.oNotificationsService.dismissNotification(t);await this.refreshModel();this._retainFocus()}catch(t){T(u.i18n.getText("notificationsFailedDismiss"))}},dismissBulkNotifications:async function(t){try{await this.oNotificationsService.dismissBulkNotifications(t.Id);await this.refreshModel();this._retainFocus()}catch(t){T(u.i18n.getText("notificationsFailedExecuteBulkAction"))}},onListItemPress:async function(t,e,i,o){if(e&&i){g.toExternalWithParameters(e,i,o)}await this.markRead(t)},addBusyIndicatorToTabFilter:function(t){const e=this.getNotificationList(t);e.setBusy(true);e.setShowNoData(false)},removeBusyIndicatorToTabFilter:function(t){const e=this.getNotificationList(t);e.setBusy(false);e.setShowNoData(true)},refreshModel:async function(){if(this.sCurrentSorting===this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING){await this.updateGroupHeaders()}else{await this.updateNotifications()}},setMarkReadOnModel:function(t,e){const i=this.getModel();let o=`/${this.sCurrentSorting}`;let s;const n=i.getProperty(o);if(this.sCurrentSorting===this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING){for(let t=0;t<n.length;t++){if(n[t].Id===this.sCurrentExpandedType){o=`${o}/${t}`;s=true;break}}if(!s){return}}o=`${o}/aNotifications`;const r=i.getProperty(o);r.some(i=>{if(i.Id===t){i.IsRead=e;return true}return false});i.setProperty(o,r)},onTabSelected:function(t){const e=t.getParameter("key");if(this.oPreviousTabKey!==e){this.sCurrentSorting=this.oKeyToSortingMap[e];this.oPreviousTabKey=e;this.refreshModel()}},getModel:function(){const t=this.getView();return t.getModel()},onNotificationItemPress:function(t){const e=this.getModel();const i=t.getSource();const o=i.getBindingContext();const s=o.getPath();const n=e.getProperty(s);const r=n.NavigationTargetObject;const a=n.NavigationTargetAction;const c=n.NavigationTargetParams;const f=n.Id;this.onListItemPress(f,r,a,c)},onNotificationItemClose:function(t){const e=this.getModel();this._retainFocus();const i=t.getSource();const o=i.getBindingContext();const s=o.getPath();const n=e.getProperty(s);const r=n.Id;this.dismissNotification(r)},onNotificationItemButtonPress:function(t){const e=this.getModel();const i=t.getSource();const s=i.getBindingContext();const n=s.getPath();const r=e.getProperty(n);const a=n.split("/");const c=this.sCurrentSorting===this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING;const f=c?`/${a[1]}/${a[2]}/${a[3]}/${a[4]}`:`/${a[1]}/${a[2]}/${a[3]}`;const l=e.getProperty(f);const h=l.Id;e.setProperty(`${f}/Busy`,true);return this.executeAction(h,r.ActionId).then(t=>{if(t?.isSucessfull){if(t.message&&t.message.length){o.show(t.message,{duration:4e3})}else{const t=r.ActionText;o.show(u.i18n.getText("ActionAppliedToNotification",[t]),{duration:4e3})}if(t.DeleteOnReturn!==false){this.refreshModel();this.oNotificationsService._addDismissNotifications(h)}}else if(t){T(t.message)}else{T(u.i18n.getText("notificationsFailedExecuteAction"))}}).catch(()=>{T(u.i18n.getText("notificationsFailedExecuteAction"))}).finally(()=>{this._retainFocus();e.setProperty(`${f}/Busy`,false)})},onNotificationGroupItemClose:function(t){const e=this.getModel();const i=t.getSource();const o=i.getBindingContext();const s=o.getPath();const n=s.split("/");const r=e.getProperty(`/${n[1]}/${n[2]}`);this.dismissBulkNotifications(r)},onNotificationGroupItemCollapse:function(t){const e=this.getModel();const i=t.getSource();const o=i.getBindingContext();const s=o.getPath();if(i.getCollapsed()){delete this.sCurrentExpandedType}else{e.setProperty(`${s}/Busy`,true);this.onExpandGroup(i)}},onNotificationGroupItemButtonPress:function(t){const e=this.getModel();const i=t.getSource();const o=i.getBindingContext();const s=o.getPath();const n=e.getProperty(s);const r=s.split("/");const a=`/${r[1]}/${r[2]}`;const c=e.getProperty(a);this._retainFocus();e.setProperty(`${a}/Busy`,true);this.executeBulkAction(n.ActionId,i.getProperty("text"),c,a)},onListUpdateStarted:function(t){const e=this.getModel();if(t.getParameter("reason")==="Growing"){if(!e.getProperty(`/${this.sCurrentSorting}/inUpdate`)){if(this.sCurrentSorting===this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING){this.getNextBufferForType()}else{this.getNextBuffer()}}}},getNumberOfItemsInScreen:function(){const t=jQuery(window).height();const e=(t-this.oPagingConfiguration.TAB_BAR_HEIGHT)/this.oPagingConfiguration.NOTIFICATION_ITEM_HEIGHT;return Math.ceil(e)},getBasicBufferSize:function(){return Math.max(this.getNumberOfItemsInScreen()*3,this.oPagingConfiguration.MIN_NOTIFICATION_ITEMS_PER_BUFFER)},getNumberOfItemsToFetchOnScroll:function(t){const e=(this.getItemsFromModel(t)||[]).length;const i=this.getBasicBufferSize();if(e>=this.iMaxNotificationItemsForDevice){return 0}if(e+i>this.iMaxNotificationItemsForDevice){return this.iMaxNotificationItemsForDevice-e}return i},getNumberOfItemsToFetchOnUpdate:function(t){const e=this.getBasicBufferSize();const i=Math.ceil(t/e);const o=i>0?i*e:e;return o>this.iMaxNotificationItemsForDevice?this.iMaxNotificationItemsForDevice:o},getItemsFromModel:function(t){const e=this.getModel();return e.getProperty(`/${t||this.sCurrentSorting}/aNotifications`)},getInitialSortingModelStructure:function(){return{hasMoreItemsInBackend:true,listMaxReached:false,aNotifications:[],inUpdate:false,moreNotificationCount:""}},onExpandGroup:function(t){const e=this.getModel();const i=t.getBindingContextPath();const o=e.getProperty(i);this.sCurrentExpandedType=o.Id;this.refreshModel()},getNotificationList:function(t){const e=this.getView();switch(t){case this.oSortingType.NOTIFICATIONS_BY_DATE_DESCENDING:return e.byId("sapUshellNotificationsListDate");case this.oSortingType.NOTIFICATIONS_BY_PRIORITY_DESCENDING:return e.byId("sapUshellNotificationsListPriority");default:return e.byId("sapUshellNotificationsListType")}},removeTabIndexFromList:function(t){const e=this.getNotificationList(t);const i=e.$().children().get(1);if(i){i.removeAttribute("tabindex")}},getMoreCircle:function(t){const i=this.getModel();const o=new e({type:I.Inactive,content:new n({items:[new n({items:[new s({text:`{/${t}/moreNotificationCount}`}).addStyleClass("sapUshellNotificationsMoreCircleCount").setModel(i),new s({text:u.i18n.getText("moreNotifications")})],alignItems:N.Center}).addStyleClass("sapUshellNotificationsMoreCircle"),new s({text:u.i18n.getText("moreNotificationsAvailable_message"),textAlign:"Center"}).addStyleClass("sapUshellNotificationsMoreHelpingText"),new s({text:u.i18n.getText("processNotifications_message"),textAlign:"Center"}).addStyleClass("sapUshellNotificationsMoreHelpingText")]}).addStyleClass("sapUshellNotificationsMoreVBox")}).addStyleClass("sapUshellNotificationsMoreListItem");this.oMoreListItem=o;return o},_retainFocus:function(){const t=document.activeElement;if(!t||document.body===t||!c.contains(t)){const t=this.getView();const e=t.byId("notificationIconTabBar");const i=e.getSelectedKey();const o=e.getItems().find(t=>t.getKey()===i);if(o){o.focus()}}},priorityFormatter:function(t){if(t){t=t.charAt(0)+t.substr(1).toLowerCase();return d[t]}}})});
//# sourceMappingURL=Notifications.controller.js.map