// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/Element","sap/ui/core/Component","sap/base/Log","sap/ushell/resources","sap/ushell/Container","sap/ushell/EventHub","sap/ushell/components/shell/SearchCEPNew/SearchProviders/SearchProvider","sap/ushell/gen/ui5/webcomponents-fiori/dist/IllustratedMessage","sap/ushell/gen/ui5/webcomponents-fiori/dist/ShellBarSearch","sap/ushell/gen/ui5/webcomponents-fiori/dist/SearchItem","sap/ushell/gen/ui5/webcomponents-fiori/dist/SearchItemGroup","sap/ushell/gen/ui5/webcomponents-fiori/dist/SearchMessageArea","sap/ushell/gen/ui5/webcomponents/dist/Button","sap/ui/model/json/JSONModel","sap/ui/thirdparty/hasher","sap/ushell/api/performance/Extension","sap/ushell/utils","sap/ushell/api/performance/NavigationSource"],(e,t,s,i,a,r,n,h,o,l,c,u,d,g,_,p,S,f)=>{"use strict";return t.extend("sap.ushell.components.shell.SearchCEPNew.Component",{metadata:{manifest:"json",library:["sap.ushell","sap.ushell.components.shell"]},searchProviderMap:{RecentSearchesList:"recentSearches",AppsList:"applications",FrequentlyUsedAppsList:"frequentApplications",ProductsList:"products",ExternalSearchAppsList:"externalSearchApplications"},iGroupMaxItemCount:10,init:function(){this._init()},_init:async function(){this._oSearchCEPService=await a.getServiceAsync("SearchCEP");this._oResultModel=new g({});this._oI18nModel=await this.getModel("i18n").getResourceBundle();this._bIsMyHome=a.getFLPPlatform(true)==="MYHOME";this._oShellHeader=e.getElementById("shell-header");this._initSearchField();this._registerDefaultProviders();this._registerHandleHashChange();if(this._oShellHeader.isLargeState()||this._oShellHeader.isExtraLargeState()){this._fetchSuggestions();this._toggleSearchFieldInput(true)}this._aDoables=[];this._aDoables.push(r.on("updateExtProviderLists").do(this._updateExtProviderLists.bind(this)));this._oExtension=new p},_initSearchField:function(){try{this._oSearchField=new o({id:"newCEPShellBarSearch",placeholder:i.i18n.getText("searchAppTitle"),autoOpen:true,showClearIcon:true});this._oSearchField.setModel(this._oResultModel,"searchResults");this._oSearchField.bindAggregation("items",{path:"searchResults>/results",factory:this._searchItemGroupFactory.bind(this)});this._attachSearchEventHandlers();this._oShellHeader.setSearch(this._oSearchField)}catch(e){s.error("Failed to create CEP search field content",e)}},_attachSearchEventHandlers:function(){this._fnBoundOnSearch=this._onSearch.bind(this);this._fnBoundOnInputChange=this._onInputChange.bind(this);this._oSearchField.attachSearch(this._fnBoundOnSearch);this._oSearchField.attachInput(this._fnBoundOnInputChange)},_detachSearchEventHandlers:function(){this._oSearchField.detachSearch(this._fnBoundOnSearch);this._oSearchField.detachInput(this._fnBoundOnInputChange)},_searchItemGroupFactory:function(e,t){const s=new c({id:e,headerText:t.getProperty("headerText"),items:{path:`searchResults>${t.getPath()}/items`,model:"searchResults",length:this.iGroupMaxItemCount,template:new l({text:"{searchResults>text}",icon:"{searchResults>icon}",description:"{searchResults>contentProviderLabel}",deletable:false})}});return s},_registerDefaultProviders:async function(){Object.values(n.getDefaultProviders(this._oI18nModel)).forEach(async e=>{await this._oSearchCEPService.registerDefaultSearchProvider(e)})},_onInputChange:function(){clearTimeout(this._suggestionTimeout);this._suggestionTimeout=setTimeout(()=>{this._fetchSuggestions(this._oSearchField.getValue())},100)},_fetchSuggestions:async function(e){try{const t=await this._oSearchCEPService.getSearchProvidersPriorityArray();const s=t.map(t=>{const s=(e||"").trim().length;if(s>=t.minQueryLength&&s<=t.maxQueryLength){return t.execSearch(e,this.searchProviderMap[t.id])}return Promise.resolve([])});const i=await Promise.all(s);this._updateSearchResults(i,t)}catch(e){s.error("Error fetching search suggestions",e)}},_updateSearchResults:function(e,t){const s=this._getResultsFormatted(e,t);this._oResultModel.setProperty("/allResults",s);const i=this._getResultCount(s);this._oResultModel.setProperty("/resultCount",i);const a=this._limitResults(s);this._oResultModel.setProperty("/results",a);const r=a?.[1]?.items?.length>0;const n=a.some((e,t)=>t!==1&&e?.items?.length>0);this._refreshSearchActionButton(r);this._updateSearchMessageArea(r,n);this._updateIllustratedMessage(r,n)},_getResultsFormatted:function(e,t){return e.map((e,s)=>({id:t[s].id,headerText:t[s].title,items:e}))},_getResultCount:function(e){const t=["AppsList","ProductsList"];return e.reduce((e,s)=>e+(s?.items&&t.includes(s.id)?s.items.length:0),0)},_limitResults:function(e){const t=e.filter(e=>!e||e.items.length===0).length;return e.map(e=>{const s=e.items&&e.items.length>4&&t<3?e.items.slice(0,4):e.items.slice(0,this.iGroupMaxItemCount);if(s.length>0){return{...e,items:s}}})},_updateExtProviderLists:async function(){const e=await this._oSearchCEPService.getExternalSearchProvidersPriorityArray();e.forEach(e=>{const t=new c({headerText:e.title});this._oSearchField.addItem(t)});if(e.length>0&&this._oSearchField.getOpen()){this._fetchSuggestions(this._oSearchField.getValue())}},_onSearch:async function(e){const t=e.getParameter("item");const s={searchFieldValue:this._oSearchField.getValue?this._oSearchField.getValue():this._oSearchField.getParent().getValue(),selectedItemContext:t?.getBindingContext?t.getBindingContext("searchResults").getObject():null};if(s?.selectedItemContext!==null){this._saveSearchTerm(s.searchFieldValue);if(t.getParent().getHeaderText()===this._oI18nModel.getText("recentSearches")){e.preventDefault();this._oSearchField.setValue(s.selectedItemContext.text);this._fetchSuggestions(s.selectedItemContext.text);this._toggleSearchFieldInput(true)}else if(s.selectedItemContext.isEnterpriseSearch){e.preventDefault();this._navigateToResultPage(s.searchFieldValue,true);this._resetSearchState()}else if(s.selectedItemContext){this._navigateToApp(s.selectedItemContext,s.searchFieldValue);this._fetchSuggestions();this._toggleSearchFieldInput(false)}}else if(s.searchFieldValue!==""&&typeof s.searchFieldValue==="string"){this._saveSearchTerm(s.searchFieldValue);if(this._bIsMyHome){const e=this._oResultModel.getData()?.results;s.selectedItemContext=e?.[1]?.items?.[0];this._navigateToApp(s.selectedItemContext,s.searchFieldValue)}else{this._navigateToResultPage(s.searchFieldValue)}this._resetSearchState()}else{this._fetchSuggestions();if(this._oSearchField.getOpen()){this._oSearchField.setOpen(false)}}},_saveSearchTerm:async function(e){if(!e){return}const t=await a.getServiceAsync("UserRecents");await t.addSearchActivity({sTerm:e})},_navigateToApp:function(e,t){if(!e){return}this._oExtension.addNavigationSource(f.SearchCEP);this._oSearchCEPService.navigate(e,t)},_navigateToResultPage:async function(e,t){let s=`#WorkZoneSearchResult-display?searchTerm=${e}&category=app`;if(t){s=`#Action-search&/top=20&filter={"dataSource":{"type":"Category","id":"All","label":"All","labelPlural":"All"},"searchTerm":"${e}",`+'"rootCondition":{"type":"Complex","operator":"And","conditions":[]}}'}const i=await a.getServiceAsync("Navigation");await i.navigate({target:{shellHash:s}})},_refreshSearchActionButton:function(t){if(this._bIsMyHome){return}const s=e.getElementById("showAllSearchResultsBtn");if(s){s.destroy()}if(this._oSearchField.getValue()!==""&&this._oSearchField.getOpen()&&t){this._oSearchField.addAction(new d({id:"showAllSearchResultsBtn",text:this._oI18nModel.getText("showAllSearchResults"),click:this._fnBoundOnSearch,design:"Transparent"}))}},_updateSearchMessageArea:function(t,s){const i=e.getElementById("searchMessageArea");if(i){i.destroy()}if(this._oSearchField.getValue()!==""&&!t&&s){this._oSearchField.addMessageArea(new u({id:"searchMessageArea",text:this._oI18nModel.getText("noSearchResults"),description:this._oI18nModel.getText("tryTheFollowing")}))}},_updateIllustratedMessage:function(t,s){const i=e.getElementById("searchIllustratedMessage");if(i){i.destroy()}if(this._oSearchField.getValue()===""&&!s){this._oResultModel.setProperty("/results",[]);this._oSearchField.addIllustration(new h({id:"searchIllustratedMessage"}))}if(this._oSearchField.getValue()!==""&&!t&&!s){this._oResultModel.setProperty("/results",[]);this._oSearchField.addIllustration(new h({id:"searchIllustratedMessage",titleText:this._oI18nModel.getText("noSearchMatch"),subtitleText:this._oI18nModel.getText("searchSomethingElse")}))}},_resetSearchState:async function(e){await S.awaitTimeout(100);if(this._oSearchField.getValue()!==""&&e){this._oSearchField.setValue("")}if(this._oSearchField.getOpen()){this._oSearchField.setOpen(false)}},_registerHandleHashChange:function(){_.changed.add(async e=>{if(e!==""&&!/WorkZoneSearchResult-display|Action-search/.test(e)){await this._resetSearchState(true);this._fetchSuggestions()}})},_toggleSearchFieldInput:function(e){const t=this._oShellHeader.getComponentInstance().getModel();t.setProperty("/searchField/show",e)},exit:function(){this._detachSearchEventHandlers();this._oSearchField.destroy();this._aDoables.forEach(e=>{e.off()});this._aDoables=[];t.prototype.exit.apply(this,arguments)}})});
//# sourceMappingURL=Component.js.map