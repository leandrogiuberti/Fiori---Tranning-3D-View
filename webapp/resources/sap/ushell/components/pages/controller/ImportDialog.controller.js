// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ushell/components/pages/MyHomeImport","sap/ushell/Config","sap/ushell/library","sap/ushell/resources","sap/ushell/utils/WindowUtils","sap/ushell/Container"],(e,t,i,s,a,o,n,r,l,c)=>{"use strict";const u=n.DisplayFormat;const d={"X-SAP-UI2-CHIP:SSB_NUMERIC":"ssuite/smartbusiness/tiles/numeric","X-SAP-UI2-CHIP:SSB_CONTRIBUTION":"ssuite/smartbusiness/tiles/contribution","X-SAP-UI2-CHIP:SSB_TREND":"ssuite/smartbusiness/tiles/trend","X-SAP-UI2-CHIP:SSB_DEVIATION":"ssuite/smartbusiness/tiles/deviation","X-SAP-UI2-CHIP:SSB_COMPARISON":"ssuite/smartbusiness/tiles/comparison","X-SAP-UI2-CHIP:SSB_BLANK":"ssuite/smartbusiness/tiles/blank","X-SAP-UI2-CHIP:SSB_DUAL":"ssuite/smartbusiness/tiles/dual"};return t.extend("sap.ushell.components.pages.controller.ImportDialog",{open:async function(){if(!this._oDialog){this._oDialog=await i.load({name:"sap.ushell.components.pages.view.ImportDialog",controller:this});this._oDialog.setModel(r.i18nModel,"i18n");this._oDialog.setModel(new s({busy:true,groups:[],PersonalizedGroups:[]}));try{const e=await a.getData();this._oDialog.getModel().setData({busy:false,groups:e,PersonalizedGroups:e.map(e=>({title:e.isDefault?r.i18n.getText("my_group"):e.title,description:e.id,selected:true}))})}catch(e){const t=await c.getServiceAsync("MessageInternal");t.error(e)}}this._oURLParsingService=await c.getServiceAsync("URLParsing");this._oDialog.open();return this._oDialog},close:function(){if(this._oDialog){this._oDialog.close()}},doImport:function(){const e=this._oDialog.getModel();const t=[];e.getProperty("/PersonalizedGroups").forEach(e=>{if(e.selected){t.push(e.description)}});const i=this._prepareImport(t);this._saveImport(i)},_moveVisualization:function(e,t,i,s,a){const o=this._getSectionIndex(e,t,i,a);const n=this._getDefaultSectionIndex(e);const r=this._getDefaultSection(e);let l=0;if(r&&r.visualizations&&r.visualizations.length){l=r.visualizations.length-1}return e.moveVisualization(this.iPageIndex,n,l,o,s)},_updateVisualization:async function(e,t,i,s,a,o){if(i.bUpdateNeeded){const n=this._getSectionIndex(e,t,s,o);const r=this._filterNonSupportedProperties(i,["title","target","subtitle","icon","info","numberUnit","indicatorDataSource","displayFormatHint"]);return e.updateVisualization(this.iPageIndex,n,a,r)}},_addVisualization:function(e,t,i,s,a,o,n){let r;if(t.isABookmark){if(t.isCustomBookmark){this.aPromiseChain.push(async()=>{r=this._filterNonSupportedProperties(t,["title","url","subtitle","icon","info","vizConfig","loadManifest","chipConfig"]);await a.bookmark.addCustomBookmark(t.vizType,r,o);await this._moveVisualization(a.pages,e,s,i,n);return this._updateVisualization(a.pages,e,t,s,i,n)})}else{this.aPromiseChain.push(async()=>{r=this._filterNonSupportedProperties(t,["title","url","icon","info","subtitle","serviceUrl","serviceRefreshInterval","numberUnit"]);await a.bookmark.addBookmark(r,o);await this._moveVisualization(a.pages,e,s,i,n);return this._updateVisualization(a.pages,e,t,s,i,n)})}}else{this.aPromiseChain.push(async()=>{const o=this._getSectionIndex(a.pages,e,s,n);const r=a.pages.getModel().getProperty(`/pages/${this.iPageIndex}/sections/${o}/id`);await a.pages.addVisualization(this.sPageId,r,t.vizId);return this._updateVisualization(a.pages,e,t,s,i,n)})}},_addToPresetSection:function(e,t,i,s,a){const o=this._getPresetSection(i.pages);const n=o.visualizations.filter(e=>e.displayFormatHint!==u.Compact).length;const r=o.visualizations.filter(e=>e.displayFormatHint===u.Compact).length;for(let o=0;o<e.tiles.length;++o){this._addVisualization(e,e.tiles[o],o+n,t,i,s,a)}for(let o=0;o<e.links.length;++o){this._addVisualization(e,e.links[o],o+r+n+e.tiles.length,t,i,s,a)}},_addSection:function(e,t,i,s,a){this.aPromiseChain.push(()=>{const s=this._getSectionIndex(i.pages,e,t,a);return i.pages.addSection(this.iPageIndex,s,{title:e.title})});for(let o=0,n=e.tiles.length;o<n;++o){this._addVisualization(e,e.tiles[o],o,t,i,s,a)}for(let o=0,n=e.links.length;o<n;++o){this._addVisualization(e,e.links[o],o+e.tiles.length,t,i,s,a)}},_getMyHomeContentNode:async function(e){const t=o.last("/core/spaces/myHome/myHomeSpaceId");const i=await e.getContentNodes();const s=i.find(e=>e.id===t);if(!s){return null}return s.children.find(e=>e.id===this.sPageId)},_saveImport:async function(e){this._oDialog.setBusy(true);this.sPageId=o.last("/core/spaces/myHome/myHomePageId");this.aPromiseChain=[];const[t,i,s,a]=await Promise.all([c.getServiceAsync("BookmarkV2"),c.getServiceAsync("MessageInternal"),c.getServiceAsync("Pages"),c.getServiceAsync("UserInfo")]);try{const o=await this._getMyHomeContentNode(t);this.iPageIndex=s.getPageIndex(this.sPageId);s.enableImplicitSave(false);this._performImportOperations(e,{bookmark:t,message:i,pages:s,userInfo:a},o);await this._executeSequentially(this.aPromiseChain);await this._savePersonalizations(s);i.info(r.i18n.getText("MyHome.InitialPage.Message.ImportSuccessful"));a.getUser().setImportBookmarksFlag("done");await a.updateUserPreferences();l.refreshBrowser()}catch(e){i.error(e)}finally{this._oDialog.setBusy(false);this.close()}},_performImportOperations:function(e,t,i){let s;let a=false;for(let o=0,n=e.length;o<n;++o){s=e[o];if(s.isDefault){this._addToPresetSection(s,o,t,i,a);a=true}else{this._addSection(s,o,t,i,a)}}},_executeSequentially:function(t){return t.reduce(async(t,i)=>t.then(()=>i()).catch(t=>{e.error("Failed to execute promise",t)}),Promise.resolve())},_getSectionIndex:function(e,t,i,s){const a=this._getPresetSectionIndex(e);if(!t.isDefault&&!t.isLocked&&!s){return a+i+1}return a+i},_getPresetSectionIndex:function(e){const t=e.getModel().getProperty(`/pages/${this.iPageIndex}/sections/`);return t.findIndex(e=>e.id===o.last("/core/spaces/myHome/presetSectionId"))},_getDefaultSectionIndex:function(e){const t=e.getModel().getProperty(`/pages/${this.iPageIndex}/sections/`);return t.findIndex(e=>e.default)},_getPresetSection:function(e){const t=e.getModel().getProperty(`/pages/${this.iPageIndex}/sections/`);return t.find(e=>e.id===o.last("/core/spaces/myHome/presetSectionId"))},_getDefaultSection:function(e){const t=e.getModel().getProperty(`/pages/${this.iPageIndex}/sections/`);return t.find(e=>e.default)},_gatherVizDataObjectFromChipInstance:function(t){let i;const s={vizId:t.chipId,isABookmark:!!t.configuration};const a=t.Chip&&t.Chip.referenceChipId;if(a&&a!=="O"){s.vizId=t.Chip.referenceChipId}if(s.isABookmark){s.isCustomBookmark=["X-SAP-UI2-CHIP:/UI2/STATIC_APPLAUNCHER","X-SAP-UI2-CHIP:/UI2/DYNAMIC_APPLAUNCHER"].indexOf(t.chipId)===-1;i=JSON.parse(JSON.parse(t.configuration).tileConfiguration);s.title=i.display_title_text;s.url=i.navigation_target_url;s.icon=i.display_icon_url;s.info=i.display_info_text;s.subtitle=i.display_subtitle_text;s.serviceUrl=i.service_url;s.serviceRefreshInterval=i.service_refresh_interval;s.numberUnit=i.display_number_unit}if(s.isCustomBookmark){if(i.TILE_PROPERTIES){try{const e=JSON.parse(i.TILE_PROPERTIES);if(!s.url&&e.semanticObject&&e.semanticAction){const t={};if(e.evaluationId){t.EvaluationId=e.evaluationId}s.url=`#${this._oURLParsingService.constructShellHash({target:{semanticObject:e.semanticObject,action:e.semanticAction},params:t})}`}if(e.title){s.title=e.title}if(e.subtitle){s.subtitle=e.subtitle}}catch(t){e.error(`Could not create URL for custom bookmark with title: ${s.title}, Error Message: ${t.message}`)}}s.vizConfig={};s.loadManifest=true;s.vizType=d[t.chipId];s.chipConfig={chipId:t.chipId,bags:{},configuration:JSON.parse(t.configuration)}}const o=t.ChipInstanceBags.results;if(o.length){s.bUpdateNeeded=!s.isABookmark;if(s.isCustomBookmark){o.forEach(e=>{s.chipConfig.bags[e.id]={properties:{},texts:{}};e.ChipInstanceProperties.results.forEach(t=>{if(t.translatable==="X"){s.chipConfig.bags[e.id].texts[t.name]=t.value}else{s.chipConfig.bags[e.id].properties[t.name]=t.value}})})}o.filter(e=>e.id==="tileProperties").forEach(e=>{e.ChipInstanceProperties.results.forEach(e=>{switch(e.name){case"display_title_text":s.title=e.value||s.title;break;case"display_subtitle_text":s.subtitle=e.value||s.subtitle;break;case"display_info_text":s.info=e.value||s.info;break;case"display_search_keywords":s.searchKeyword=e.value;break;default:break}})});o.filter(e=>e.id==="sb_tileProperties").forEach(e=>{e.ChipInstanceProperties.results.forEach(e=>{switch(e.name){case"title":s.title=e.value;break;case"description":s.subtitle=e.value;break;default:break}})})}return s},_savePersonalizations:async function(e){e.enableImplicitSave(true);await e.savePersonalization(this.sPageId);e.enableImplicitSave(false)},_prepareImport:function(e){const t={};const i=this._oDialog.getModel();const s=i.getProperty("/groups");let a;let o;s.forEach(i=>{if(e.indexOf(i.id)===-1){return}a={};i.chips.forEach(e=>{o=this._gatherVizDataObjectFromChipInstance(e);a[e.instanceId]=o});i.tiles=[];i.tileOrder.forEach(e=>{o=a[e];if(o){delete a[e];i.tiles.push(o)}});i.links=[];i.linkOrder.forEach(e=>{o=a[e];if(o){delete a[e];o.displayFormatHint=u.Compact;o.bUpdateNeeded=true;i.links.push(o)}});Object.keys(a).forEach(e=>{i.tiles.push(a[e])});t[i.id]=i});const n=[];let r;e.forEach(e=>{r=t[e];if(r){n.push(r)}});return n},_filterNonSupportedProperties:function(e,t){const i={};Object.keys(e).forEach(s=>{if(t.includes(s)){i[s]=e[s]}});return i}})});
//# sourceMappingURL=ImportDialog.controller.js.map