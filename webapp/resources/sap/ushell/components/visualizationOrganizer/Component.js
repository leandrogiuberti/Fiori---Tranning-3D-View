// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/m/library","sap/m/MessageBox","sap/m/GroupHeaderListItem","sap/ui/core/Element","sap/ui/core/UIComponent","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ushell/Config","sap/ushell/Container","sap/ushell/library","sap/ushell/resources"],(e,t,i,n,s,o,a,r,l,c,g,u,d)=>{"use strict";const h=t.ButtonType;const p=u.ContentNodeType;return o.extend("sap.ushell.components.visualizationOrganizer.Component",{metadata:{version:"1.141.0",library:"sap.ushell",dependencies:{libs:["sap.m"]},properties:{pressed:{type:"boolean",group:"Misc",defaultValue:false}}},init:function(){o.prototype.init.apply(this,arguments);this.aPersonalizablePages=[];this.mVizIdInPages=new Map;this.stVizIdInSection=new Set},requestData:function(){const e=!c.last("/core/shell/enablePersonalization")&&c.last("/core/spaces/myHome/enabled");const t=c.last("/core/spaces/myHome/myHomePageId");return g.getServiceAsync("CommonDataModel").then(e=>e.getAllPages()).then(i=>{if(e){i=i.filter(e=>e.identification.id===t)}this.aPersonalizablePages=i.map(e=>({id:e.identification.id,title:e.identification.title}));this._fillVizIdMaps(i);return this.aPersonalizablePages})},_fillVizIdMaps:function(e){this.mVizIdInPages=new Map;e.forEach(e=>{Object.keys(e.payload.sections).forEach(t=>{Object.keys(e.payload.sections[t].viz).forEach(i=>{const n=e.payload.sections[t].viz[i].vizId;if(this.mVizIdInPages.has(n)){this.mVizIdInPages.get(n).add(e.identification.id)}else{this.mVizIdInPages.set(n,new Set([e.identification.id]))}})})})},isVizIdPresent:function(e,t){if(t){return this.stVizIdInSection.has(e)}const i=this.mVizIdInPages.get(e);return!!(i&&i.size)},formatPinButtonIcon:function(e,t){return this.isVizIdPresent(decodeURIComponent(e),t)?"sap-icon://accept":"sap-icon://add"},formatPinButtonType:function(e,t){return this.isVizIdPresent(decodeURIComponent(e),t)?h.Emphasized:h.Default},formatPinButtonTooltip:function(e,t){const i=this.isVizIdPresent(decodeURIComponent(e),!!t);if(!t&&i){return d.i18n.getText("EasyAccessMenu_PinButton_Toggled_Tooltip")}if(!t&&!i){return d.i18n.getText("EasyAccessMenu_PinButton_UnToggled_Tooltip")}if(t.sectionID&&i){return d.i18n.getText("VisualizationOrganizer.Button.Tooltip.RemoveFromSection")}if(t.sectionID&&!i){return d.i18n.getText("VisualizationOrganizer.Button.Tooltip.AddToSection")}if(!t.sectionID&&i){return d.i18n.getText("VisualizationOrganizer.Button.Tooltip.RemoveFromPage",[t.pageTitle])}return d.i18n.getText("VisualizationOrganizer.Button.Tooltip.AddToPage",[t.pageTitle])},onTilePinButtonClick:function(e,t){const i=e.getSource();const n=i.getBindingContext().getProperty();if(i.getBusy()){return Promise.resolve()}if(t){i.setBusy(true);return this._applyOrganizationChangeToSection(i,n,t).then(()=>{i.setBusy(false)})}if(this.aPersonalizablePages.length===1){i.setBusy(true);return this._applyChangeToPage(i,n,this.aPersonalizablePages[0]).then(()=>{i.setBusy(false)})}return this.toggle(i,n)},open:function(e,t){let i=s.getElementById("sapUshellVisualizationOrganizerPopover");let n=Promise.resolve();if(!i){n=new Promise((e,t)=>{sap.ui.require(["sap/ui/core/Fragment"],i=>{i.load({name:"sap.ushell.components.visualizationOrganizer.VisualizationOrganizerPopover",type:"XML",controller:this}).then(e).catch(t)})}).then(e=>{i=e;i.setModel(new l({pages:[],searchTerm:""}));i.setModel(d.i18nModel,"i18n")})}return n.then(()=>{this.oOpenBy=e;this.sVisualizationId=decodeURIComponent(t.id);this.sVisualizationTitle=t.title;this.oVizInfo=t;this.fnResetPopup=this._resetPopup.bind(this);i.attachAfterClose(this.fnResetPopup);return Promise.all([g.getServiceAsync("Menu"),g.getServiceAsync("Pages")]).then(e=>{let i;const n=e[0];const s=e[1];if(t.isBookmark){i=s._findBookmarks({url:t.url}).then(e=>{const t=e.map(e=>e.pageId);return Promise.resolve(new Set(t))})}else{i=this.mVizIdInPages.get(this.sVisualizationId)}return Promise.all([n.getContentNodes([p.Space,p.Page]),i])}).then(t=>{let n=t[0];const s=t[1];const o=!c.last("/core/shell/enablePersonalization")&&c.last("/core/spaces/myHome/enabled");const a=c.last("/core/spaces/myHome/myHomeSpaceId");const r=[];n=this._filterPersonalizableContentNodes(n);n.forEach(e=>{if(o&&e.id!==a){return}e.children.forEach(t=>{if(!this._isPersonalizablePage(t.id)){return}r.push({id:t.id,title:t.label,space:e.label,spaceId:e.id,selected:s&&s.has(t.id)})})});const l=i.getModel();l.setProperty("/pages",r);l.setProperty("/pinnedPages",s);this._updatePagesList();i.openBy(e)})})},_filterPersonalizableContentNodes:function(e){if(!Array.isArray(e)){return[]}return e.reduce((e,t)=>{t.children=this._filterPersonalizableContentNodes(t.children);if(t.type===p.HomepageGroup||t.type===p.Space||t.type===p.Page&&t.isContainer){e.push(t)}return e},[])},cancel:function(){const e=s.getElementById("sapUshellVisualizationOrganizerPopover");const t=this._retrieveChangedPageIds();if(e&&t.deleteFromPageIds.length===0&&t.addToPageIds.length===0){e.close()}else{i.show(d.i18n.getText("VisualizationOrganizer.MessageBox.Description"),{id:"sapUshellVisualizationOrganizerDiscardDialog",title:d.i18n.getText("VisualizationOrganizer.MessageBox.Title"),actions:[d.i18n.getText("VisualizationOrganizer.MessageBox.ActionDiscard"),i.Action.CANCEL],emphasizedAction:d.i18n.getText("VisualizationOrganizer.MessageBox.ActionDiscard"),onClose:function(t){if(t===d.i18n.getText("VisualizationOrganizer.MessageBox.ActionDiscard")){e.close()}}})}},toggle:function(e,t){const i=s.getElementById("sapUshellVisualizationOrganizerPopover");if(i&&i.isOpen()&&i._oOpenBy&&i._oOpenBy.getId()===e.getId()){this.cancel();return Promise.resolve()}return this.open(e,t)},_applyOrganizationChangeToSection:function(e,t,i){return g.getServiceAsync("Pages").then(n=>{let s;const o=decodeURIComponent(t.id);const a=t.title;const r=i.pageID;const l=i.sectionID;const c=this._getTextMsgSectionContext(i,o,a);if(this.stVizIdInSection.has(o)){s=n.findVisualization(r,l,o).then(e=>{if(e.length===0){return Promise.resolve()}let t;const i=n.getPageIndex(r);const s=e.sort((e,t)=>t.sectionIndex-e.sectionIndex);s.forEach(e=>{e.vizIndexes.sort((e,t)=>t-e)});s.forEach(e=>{const s=e.sectionIndex;e.vizIndexes.forEach(e=>{if(!t){t=n.deleteVisualization(i,s,e)}else{t=t.then(()=>n.deleteVisualization(i,s,e))}})});return t}).then(()=>{this.stVizIdInSection.delete(o)})}else{s=n.addVisualization(r,l,o).then(()=>{this.stVizIdInSection.add(o)})}return s.then(()=>{e.getBinding("icon")?.refresh(true);e.getBinding("type")?.refresh(true);e.getBinding("tooltip")?.refresh(true);sap.ui.require(["sap/m/MessageToast"],e=>{e.show(c,{offset:"0 -50"})})})})},_getTextMsgSectionContext:function(e,t,i){const n=e.sectionID;const s=e.sectionTitle;const o=e.pageTitle;if(n&&this.stVizIdInSection.has(t)){return d.i18n.getText("VisualizationOrganizer.MessageToastSectionContextRemove",[i||t,s,o])}if(n&&!this.stVizIdInSection.has(t)){return d.i18n.getText("VisualizationOrganizer.MessageToastSectionContextAdd",[i||t,s,o])}if(!n&&this.stVizIdInSection.has(t)){return d.i18n.getText("VisualizationOrganizer.MessageToastPageRemove",[i||t,o])}if(!n&&!this.stVizIdInSection.has(t)){return d.i18n.getText("VisualizationOrganizer.MessageToastPageAdd",[i||t,o])}},_organizeVisualizations:function(){const e=this._retrieveChangedPageIds();if(this.oVizInfo.isBookmark){return this._applyBookmarkOrganizationChange(e,true)}return this._applyOrganizationChange(e,true)},_applyOrganizationChange:function(e,t){const i=e.addToPageIds.length+e.deleteFromPageIds.length;if(!i){return Promise.resolve()}const n=this.sVisualizationId;const s=this.oOpenBy;const o=new Set;let a;let r=g.getServiceAsync("Pages").then(e=>{a=e});e.deleteFromPageIds.forEach(e=>{if(!o.has(e)){o.add(e);r=r.then(()=>a.findVisualization(e,null,n).then(e=>{const t=[];for(let i=e.length-1;i>=0;i--){const n=e[i];const s=a.getPageIndex(n.pageId);for(let e=n.vizIndexes.length-1;e>=0;e--){const i=n.vizIndexes[e];t.push(a.deleteVisualization(s,n.sectionIndex,i))}}return Promise.all(t)}))}this.mVizIdInPages.get(n).delete(e)});e.addToPageIds.forEach(e=>{r=r.then(()=>a.addVisualization(e,null,n));if(this.mVizIdInPages.has(n)){this.mVizIdInPages.get(n).add(e)}else{this.mVizIdInPages.set(n,new Set([e]))}});return r.then(()=>{if(s){s.getBinding("icon")?.refresh(true);s.getBinding("type")?.refresh(true);s.getBinding("tooltip")?.refresh(true)}if(t){sap.ui.require(["sap/m/MessageToast"],e=>{e.show(d.i18n.getText("VisualizationOrganizer.MessageToast"))})}})},_resetPopup:function(e){const t=s.getElementById("sapUshellVisualizationOrganizerPopover");const i=s.getElementById("sapUshellVisualizationOrganizerSpacesList");const n=s.getElementById("sapUshellVisualizationOrganizerSearch");const o=s.getElementById("sapUshellVisualizationOrganizerSelectedPages");t.detachAfterClose(this.fnResetPopup);n.setValue("");o.setType(h.Default);i.getBinding("items").filter(null);i.removeSelections();delete this.fnResetPopup;delete this.sVisualizationId;delete this.sVisualizationTitle},onSelectionChange:function(e){const t=e.getParameter("listItem");const i=e.getParameter("selected");this._changeSelectionForAllPagesWithTheSamePageId(t,i)},_changeSelectionForAllPagesWithTheSamePageId:function(e,t){const i=e.getModel();const n=e.getBindingContext();const s=n.getProperty("id");const o=t!==undefined?t:!n.getProperty("selected");const a=i.getProperty("/pages");for(let e=0;e<a.length;e++){const t=a[e];if(t.id===s){t.selected=o}}i.setProperty("/pages",a)},_onSearch:function(e){const t=s.getElementById("sapUshellVisualizationOrganizerSelectedPages");let i=this.getPressed();if(e.sId==="press"){i=!i;this.setPressed(i);t.setPressed(i)}this._updatePagesList()},_updatePagesList:function(){const e=s.getElementById("sapUshellVisualizationOrganizerSpacesList");const t=s.getElementById("sapUshellVisualizationOrganizerSearch");const i=e.getBinding("items");const n=t.getValue();const o=this.getPressed();if(o){i.filter(new a({filters:[new a({filters:[new a({path:"title",operator:r.Contains,value1:n}),new a({path:"selected",operator:r.EQ,value1:o})],and:true}),new a({filters:[new a({path:"space",operator:r.Contains,value1:n}),new a({path:"selected",operator:r.EQ,value1:o})],and:true})],and:false}))}else{i.filter(new a({filters:[new a({path:"title",operator:r.Contains,value1:n}),new a({path:"space",operator:r.Contains,value1:n})],and:false}))}if(i.getLength()===0){e.setNoDataText(d.i18n.getText(n?"VisualizationOrganizer.PagesList.NoResultsText":"VisualizationOrganizer.PagesList.NoDataText"))}},loadSectionContext:function(t){this.stVizIdInSection.clear();if(!t||!t.pageID){return Promise.resolve(null)}return g.getServiceAsync("Pages").then(i=>{const n=decodeURIComponent(t.pageID);const s=t.sectionID?decodeURIComponent(t.sectionID):"";return i.loadPage(n).then(e=>{const t=i.getModel().getProperty(e);const n=this._createSectionContext(t,s);return n}).catch(()=>{e.warning(`${n} cannot be loaded. Please, check the id of the page.`);return Promise.resolve(null)})})},_createSectionContext:function(e,t){const i=e.sections;let n;if(t){n=i.find(e=>e.id===t);this._initVizIdsInSection(n);return{pageID:e.id,sectionID:t,pageTitle:e.title,sectionTitle:n.title}}i.forEach(e=>{this._initVizIdsInSection(e)});return{pageID:e.id,sectionID:t,pageTitle:e.title}},_initVizIdsInSection:function(e){e.visualizations.forEach(e=>{this.stVizIdInSection.add(e.vizId)})},getPersonalizablePages:function(){return this.aPersonalizablePages},_isPersonalizablePage:function(e){const t=this.aPersonalizablePages.findIndex(t=>t.id===e);return t>-1},_retrieveChangedPageIds:function(){const e=s.getElementById("sapUshellVisualizationOrganizerSpacesList");const t=s.getElementById("sapUshellVisualizationOrganizerSearch");const i=e.getModel();const n=i.getProperty("/pinnedPages")||new Set;e.getBinding("items").filter(null);const o=e.getItems().filter(e=>e.isA("sap.m.StandardListItem"));t.fireSearch();const a={};const r=[];const l=[];o.forEach(e=>{const t=e.getBindingContext().getProperty("id");if(!a[t]){a[t]=true;if(e.getSelected()&&!n.has(t)){r.push(t)}else if(!e.getSelected()&&n.has(t)){l.push(t)}}});return{addToPageIds:r,deleteFromPageIds:l}},okay:function(){const t=s.getElementById("sapUshellVisualizationOrganizerPopover");if(t.getBusy()){return}t.setBusy(true);this._organizeVisualizations().then(()=>{t.setBusy(false);t.close()}).catch(t=>{e.error("Could not save the selected pages on the VisualizationOrganizerPopover",t)})},onHierarchyAppsPinButtonClick:function(e,t){const i=e.getSource();const n=i.getParent().getBinding("title").getContext().getObject();if(i.getBusy()){return Promise.resolve(false)}n.isBookmark=true;n.title=n.text;if(t){i.setBusy(true);return this._applyBookmarkTileChangeToSection(n,t).then(()=>{i.setBusy(false);return Promise.resolve(true)})}if(this.aPersonalizablePages.length===1){i.setBusy(true);return this._applyChangeToPage(i,n,this.aPersonalizablePages[0]).then(()=>{i.setBusy(false);return Promise.resolve(true)})}return new Promise(e=>{this.toggle(i,n).then(()=>{const t=s.getElementById("sapUshellVisualizationOrganizerPopover");if(t&&t.isOpen()){t.attachEventOnce("afterClose",()=>{e(true)})}else{e(false)}})})},_applyBookmarkOrganizationChange:function(e,t){const i=e.addToPageIds.length+e.deleteFromPageIds.length;if(!i){return Promise.resolve()}const n=this.oVizInfo;const s=new Set;let o;let a;let r=Promise.all([g.getServiceAsync("BookmarkV2"),g.getServiceAsync("Pages")]).then(e=>{o=e[0];a=e[1];return Promise.resolve()});e.deleteFromPageIds.forEach(e=>{if(!s.has(e)){s.add(e);r=r.then(()=>a.deleteBookmarks({url:n.url},e))}});e.addToPageIds.forEach(e=>{r=r.then(()=>{const t={url:n.url,title:n.text,subtitle:n.subtitle,icon:n.icon};const i={type:u.ContentNodeType.Page,id:e,isContainer:true};return o.addBookmark(t,i)})});return r.then(()=>{if(t){sap.ui.require(["sap/m/MessageToast"],e=>{e.show(d.i18n.getText("VisualizationOrganizer.MessageToast"))})}})},_applyBookmarkTileChangeToSection:function(e,t){return g.getServiceAsync("Pages").then(i=>{let n;let s;const o=e.url;const a=e.title;const r=t.pageID;const l=t.sectionID;if(e.bookmarkCount>0){s=d.i18n.getText("VisualizationOrganizer.MessageToastSectionContextRemove",[a,t.sectionTitle,t.pageTitle]);n=i.deleteBookmarks({url:o},r,l)}else{const c={url:o,title:e.text,subtitle:e.subtitle,icon:e.icon};s=d.i18n.getText("VisualizationOrganizer.MessageToastSectionContextAdd",[a,t.sectionTitle,t.pageTitle]);n=i.addBookmarkToPage(r,c,l)}return n.then(()=>{sap.ui.require(["sap/m/MessageToast"],e=>{e.show(s,{offset:"0 -50"})})})})},updateBookmarkCount:function(e,t){return g.getServiceAsync("Pages").then(i=>{const n=e.map(e=>i._findBookmarks({url:e.url}).then(i=>{if(t){i=i.filter(e=>t.pageID===e.pageId&&t.sectionID===e.sectionId)}e.bookmarkCount=i.length;return e}));return Promise.all(n)})},formatBookmarkPinButtonTooltip:function(e,t){let i;if(t){if(e>0){i="VisualizationOrganizer.Button.Tooltip.RemoveFromSection"}else{i="VisualizationOrganizer.Button.Tooltip.AddToSection"}}else if(e>0){i="EasyAccessMenu_PinButton_Toggled_Tooltip"}else{i="EasyAccessMenu_PinButton_UnToggled_Tooltip"}return d.i18n.getText(i)},_applyChangeToPage:function(e,t,i){const n=decodeURIComponent(t.id);const s=t.title;const o=i.id;const a=t.isBookmark?t.bookmarkCount>0:this.isVizIdPresent(n);const r={addToPageIds:a?[]:[o],deleteFromPageIds:a?[o]:[]};const l=d.i18n.getText(a?"VisualizationOrganizer.MessageToastPageRemove":"VisualizationOrganizer.MessageToastPageAdd",[s||n,i.title]);this.oVizInfo=t;this.sVisualizationId=n;let c;if(t.isBookmark){c=this._applyBookmarkOrganizationChange(r,false)}else{c=this._applyOrganizationChange(r,false)}return c.then(()=>{e.getBinding("icon")?.refresh(true);e.getBinding("type")?.refresh(true);e.getBinding("tooltip")?.refresh(true);sap.ui.require(["sap/m/MessageToast"],e=>{e.show(l,{offset:"0 -50"})})})},groupBySpace:function(e){return{key:e.getProperty("spaceId"),title:e.getProperty("space")}},getGroupHeader:function(e){return new n({title:e.title})},exit:function(){const e=s.getElementById("sapUshellVisualizationOrganizerPopover");if(e){e.destroy()}}})});
//# sourceMappingURL=Component.js.map