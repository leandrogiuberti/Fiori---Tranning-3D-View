// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/extend","sap/ui/core/Element","sap/ui/core/EventBus","sap/ushell/library","sap/ui/core/mvc/View","sap/ui/core/mvc/Controller","sap/ushell/components/_HomepageManager/PagingManager","sap/ui/thirdparty/jquery","sap/ushell/resources","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/library","sap/ui/Device","sap/ui/model/Context","sap/m/MessageToast","sap/ushell/Config","sap/ushell/components/appfinder/VisualizationOrganizerHelper","sap/ushell/utils/WindowUtils","sap/ushell/EventHub","sap/base/Log","sap/ushell/Container","sap/ushell/api/performance/Extension","sap/ushell/api/performance/NavigationSource"],(e,t,i,o,s,r,a,jQuery,n,l,g,c,h,p,d,u,f,y,C,m,F,P,w)=>{"use strict";const M=c.SplitAppMode;const S=o.AppType;let T;return r.extend("sap.ushell.components.appfinder.Catalog",{oPopover:null,onInit:function(){F.getServiceAsync("FlpLaunchPage").then(e=>{this.oLaunchPageService=e});this.categoryFilter="";this.preCategoryFilter="";const e=this.getView();this.oMainModel=e.getModel();this.oSubHeaderModel=e.getModel("subHeaderModel");this.resetPage=false;this.bIsInProcess=false;this.oVisualizationOrganizerHelper=e.oVisualizationOrganizerHelper;this.oCatalogsContainer=e.oCatalogsContainer;this.timeoutId=0;document.subHeaderModel=this.oSubHeaderModel;document.mainModel=this.oMainModel;const t=this.oSubHeaderModel.bindProperty("/openCloseSplitAppButtonToggled");t.attachChange(this.handleToggleButtonModelChanged,this);e.oCatalogsContainer.setHandleSearchCallback(this.handleSearchModelChanged.bind(this));T=this.getView().getViewData().CatalogsManager&&this.getView().getViewData().CatalogsManager.getInstance()},customRouteMatched:function(e){this.onShow(e)},onBeforeRendering:function(){i.getInstance().publish("renderCatalog")},onAfterRendering:function(){this.wasRendered=true;if(!this.PagingManager){this._setPagingManager()}if(this.PagingManager.currentPageIndex===0){this.allocateNextPage()}jQuery(window).resize(()=>{const e=jQuery(window).width();const t=jQuery(window).height();this.PagingManager.setContainerSize(e,t)});this._handleAppFinderWithDocking();i.getInstance().subscribe("launchpad","appFinderWithDocking",this._handleAppFinderWithDocking,this);i.getInstance().subscribe("sap.ushell","appFinderAfterNavigate",this._handleAppFinderAfterNavigate,this)},_setPagingManager:function(){this.lastCatalogId=0;this.PagingManager=new a("catalogPaging",{supportedElements:{tile:{className:"sapUshellTile"}},containerHeight:window.innerHeight,containerWidth:window.innerWidth});this.oCatalogsContainer.setPagingManager(this.PagingManager)},_decodeUrlFilteringParameters:function(e){let t;try{t=JSON.parse(e)}catch{t=e}const i=t&&t.tagFilter&&t.tagFilter||[];if(i){try{this.tagFilter=JSON.parse(i)}catch{this.tagFilter=[]}}else{this.tagFilter=[]}this.categoryFilter=t&&t.catalogSelector&&t.catalogSelector||this.categoryFilter;if(this.categoryFilter){this.categoryFilter=window.decodeURIComponent(this.categoryFilter)}this.searchFilter=t&&t.tileFilter&&t.tileFilter||null;if(this.searchFilter){this.searchFilter=window.decodeURIComponent(this.searchFilter)}},_applyFilters:function(e){let t=false;if(this.categoryFilter){this.categoryFilter=n.i18n.getText("all")===this.categoryFilter?"":this.categoryFilter;if(this.categoryFilter!==this.preCategoryFilter){t=true}this.oView.setCategoryFilterSelection(this.categoryFilter,t)}else{t=true;this.oView.setCategoryFilterSelection("",t)}this.preCategoryFilter=this.categoryFilter;if(this.searchFilter&&this.searchFilter.length){this.searchFilter=this.searchFilter.replace(/\*/g,"");this.searchFilter=this.searchFilter.trim();this.oSubHeaderModel.setProperty("/search",{searchMode:true,searchTerm:this.searchFilter})}else if(e){this.oSubHeaderModel.setProperty("/search",{searchMode:false,searchTerm:""});this.resetPage=true}if(this.tagFilter&&this.tagFilter.length){this.oSubHeaderModel.setProperty("/tag",{tagMode:true,selectedTags:this.tagFilter})}else if(e){this.oSubHeaderModel.setProperty("/tag",{tagMode:false,selectedTags:[]});this.resetPage=true}this.handleSearchModelChanged()},_handleAppFinderAfterNavigate:function(){this.clearFilters()},clearFilters:function(){let e=false;if(this.categoryFilter!==this.preCategoryFilter){e=true}const t=this.oSubHeaderModel.getProperty("/search/searchMode");const i=this.oSubHeaderModel.getProperty("/tag/tagMode");if(t){this.oSubHeaderModel.setProperty("/search",{searchMode:true,searchTerm:""})}if(i){this.oSubHeaderModel.setProperty("/tag",{tagMode:true,selectedTags:[]})}if(this.categoryFilter&&this.categoryFilter!==""){this.selectedCategoryId=undefined;this.categoryFilter=undefined;this.getView().getModel().setProperty("/categoryFilter","");this.oView.setCategoryFilterSelection("",e)}this.preCategoryFilter=this.categoryFilter;this.handleSearchModelChanged()},onShow:function(t){const i=t.getParameter("arguments").filters;e(this.getView().getViewData(),t);this._decodeUrlFilteringParameters(i);if(this.wasRendered&&!i){this.clearFilters()}else{this._applyFilters(this.wasRendered)}},allocateNextPage:function(){if(!this.oCatalogsContainer.nAllocatedUnits||this.oCatalogsContainer.nAllocatedUnits===0){this.PagingManager.moveToNextPage();this.allocateTiles=this.PagingManager._calcElementsPerPage();this.oCatalogsContainer.applyPagingCategoryFilters(this.allocateTiles,this.categoryFilter)}},setTagsFilter:function(e){const t={catalogSelector:this.categoryFilter?this.categoryFilter:n.i18n.getText("all"),tileFilter:this.searchFilter&&this.searchFilter.length?encodeURIComponent(this.searchFilter):"",tagFilter:e.length?JSON.stringify(e):[]};this._addNavigationContextToFilter(t);this.getView().parentComponent.getRouter().navTo("catalog",{filters:JSON.stringify(t)})},setCategoryFilter:function(e){const t={catalogSelector:e,tileFilter:this.searchFilter?encodeURIComponent(this.searchFilter):"",tagFilter:this.tagFilter.length?JSON.stringify(this.tagFilter):[]};this._addNavigationContextToFilter(t);this.getView().parentComponent.getRouter().navTo("catalog",{filters:JSON.stringify(t)})},setSearchFilter:function(e){const t={catalogSelector:this.categoryFilter?this.categoryFilter:n.i18n.getText("all"),tileFilter:e?encodeURIComponent(e):"",tagFilter:this.tagFilter.length?JSON.stringify(this.tagFilter):[]};this._addNavigationContextToFilter(t);this.getView().parentComponent.getRouter().navTo("catalog",{filters:JSON.stringify(t)})},_addNavigationContextToFilter:function(e){const t=this.oVisualizationOrganizerHelper.getNavigationContext.apply(this);if(t){Object.keys(t).forEach(i=>{e[i]=t[i]})}return e},onSearch:function(e){const t=this.oSubHeaderModel.getProperty("/activeMenu");if(this.oView.getId().indexOf(t)!==-1){const t=e.searchTerm?e.searchTerm:"";this.setSearchFilter(t)}else{this._restoreSelectedMasterItem()}},onTag:function(e){const t=this.oSubHeaderModel.getProperty("/activeMenu");if(this.oView.getId().indexOf(t)!==-1){const t=e.selectedTags?e.selectedTags:[];this.setTagsFilter(t)}else{this._restoreSelectedMasterItem()}},getGroupContext:function(){const e=this.getView().getModel();const t=e.getProperty("/groupContext/path");return{targetGroup:encodeURIComponent(t||"")}},_isTagFilteringChanged:function(e){const t=e.length===this.tagFilter.length;let i=t;if(!i){return true}e.some(e=>{i=this.tagFilter&&Array.prototype.indexOf.call(this.tagFilter,e)!==-1;return!i});return i},_setUrlWithTagsAndSearchTerm:function(e,t){const i={tileFilter:e&&e.length?encodeURIComponent(e):"",tagFilter:t.length?JSON.stringify(t):[]};this._addNavigationContextToFilter(i);this.getView().parentComponent.getRouter().navTo("catalog",{filters:JSON.stringify(i)})},handleSearchModelChanged:function(){const e=this.oSubHeaderModel.getProperty("/search/searchMode");const i=this.oSubHeaderModel.getProperty("/tag/tagMode");let o=this.oSubHeaderModel.getProperty("/search/searchTerm");const s=this.oSubHeaderModel.getProperty("/tag/selectedTags");const r=[];let a;let n;let c;if(!this.PagingManager){this._setPagingManager()}this.PagingManager.resetCurrentPageIndex();this.nAllocatedTiles=0;this.PagingManager.moveToNextPage();this.allocateTiles=this.PagingManager._calcElementsPerPage();this.oView.oCatalogsContainer.updateAllocatedUnits(this.allocateTiles);this.oView.oCatalogsContainer.resetCatalogPagination();const h=t.getElementById("catalogTilesDetailedPage");if(h){h.scrollTo(0,0)}if(e||i||this.resetPage){if(s&&s.length>0){const e=new l("tags","EQ","v");e.fnTest=function(e){if(s.length===0){return true}for(let t=0;t<s.length;t++){const i=s[t];if(e.indexOf(i)===-1){return false}}return true};a=new l([e],true)}o=o?o.replace(/\*/g,""):o;if(o){const e=o.split(/[\s,]+/);const t=new l(jQuery.map(e,e=>e&&new l("keywords",g.Contains,e)),true);const i=new l(jQuery.map(e,e=>e&&new l("title",g.Contains,e)),true);const s=new l(jQuery.map(e,e=>e&&new l("subtitle",g.Contains,e)),true);r.push(t);r.push(i);r.push(s);n=new l(r,false)}const e=this.oView.oCatalogsContainer.getCatalogs();this.oSearchResultsTotal=[];const t=this;if(a&&a.aFilters.length>0&&n){c=new l([n].concat([a]),true)}else if(a&&a.aFilters.length>0){c=new l([a],true)}else if(n&&n.aFilters.length>0){c=new l([n],true)}e.forEach(e=>{e.getBinding("customTilesContainer").filter(c);e.getBinding("appBoxesContainer").filter(c)});this.oView.oCatalogsContainer.bSearchResults=false;this.oView.oCatalogsContainer.applyPagingCategoryFilters(this.oView.oCatalogsContainer.nAllocatedUnits,this.categoryFilter);this.bSearchResults=this.oView.oCatalogsContainer.bSearchResults;this.oView.splitApp.toDetail(t.getView()._calculateDetailPageId());this.resetPage=false}else{this.oView.oCatalogsContainer.applyPagingCategoryFilters(this.oView.oCatalogsContainer.nAllocatedUnits,this.categoryFilter)}const p=this.getView()._calculateDetailPageId();this.oView.splitApp.toDetail(p)},_handleAppFinderWithDocking:function(){if(jQuery(".sapUshellContainerDocked").length>0){if(jQuery("#mainShell").width()<710){if(window.innerWidth<1024){this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonVisible",false);this.oView.splitApp.setMode(M.ShowHideMode)}else{this.oView.splitApp.setMode(M.HideMode);this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonVisible",true)}}else{this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonVisible",false);this.oView.splitApp.setMode(M.ShowHideMode)}}},_restoreSelectedMasterItem:function(){const e=this.oView.splitApp.getMasterPage("catalogSelect");const i=t.getElementById(this.selectedCategoryId);if(i){this.categoryFilter=i.getTitle()}e.setSelectedItem(i)},handleToggleButtonModelChanged:function(){const e=this.oSubHeaderModel.getProperty("/openCloseSplitAppButtonVisible");const i=this.oSubHeaderModel.getProperty("/openCloseSplitAppButtonToggled");if(i!==this.bCurrentButtonToggled&&e){if(!h.system.phone){if(i&&!this.oView.splitApp.isMasterShown()){this.oView.splitApp.showMaster()}else if(this.oView.splitApp.isMasterShown()){this.oView.splitApp.hideMaster()}}else if(this.oView.splitApp.isMasterShown()){const e=t.getElementById(this.getView()._calculateDetailPageId());this.oView.splitApp.toDetail(e)}else if(i){const e=t.getElementById("catalogSelect");this.oView.splitApp.toMaster(e,"show")}}this.bCurrentButtonToggled=i},_handleCatalogListItemPress:function(e){this.onCategoryFilter(e);if(this.oSubHeaderModel.getProperty("/search/searchTerm")!==""){this.oSubHeaderModel.setProperty("/search/searchMode",true)}if(h.system.phone||h.system.tablet){this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonToggled",!this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonToggled"))}},onCategoryFilter:function(e){const t=e.getSource();const i=t.getSelectedItem();const o=i.getBindingContext();const s=o.getModel();if(s.getProperty("static",o)){s.setProperty("/showCatalogHeaders",true);this.setCategoryFilter();this.selectedCategoryId=undefined;this.categoryFilter=undefined}else{s.setProperty("/showCatalogHeaders",false);this.setCategoryFilter(window.encodeURIComponent(i.getBindingContext().getObject().title));this.categoryFilter=i.getTitle();this.selectedCategoryId=i.getId()}},onTileAfterRendering:function(e){const t=e.oSource.getDomRef();if(t){const e=t.getElementsByClassName("sapMGT");for(let t=0;t<e.length;t++){e[t].setAttribute("tabindex","-1")}}},catalogTilePress:function(){i.getInstance().publish("launchpad","catalogTileClick")},onAppBoxPressed:function(e){const t=e.getSource();const i=t.getBindingContext().getObject();if(e.mParameters.srcControl.$().closest(".sapUshellPinButton").length){return}const o=this.oLaunchPageService.getAppBoxPressHandler(i);if(o){o(i)}else{const e=t.getProperty("url");if(!e){m.info("AppBox url property is not set.",null,"sap.ushell.components.Catalog.controller");return}const i=new P;i.addNavigationSource(w.AppFinder);C.emit("UITracer.trace",{reason:"LaunchApp",source:"Tile",data:{targetUrl:e}});if(e.indexOf("#")===0){hasher.setHash(e)}else{const i=u.last("/core/shell/enableRecentActivity")&&u.last("/core/shell/enableRecentActivityLogging");if(i){const i={title:t.getProperty("title"),appType:S.URL,url:e,appId:e};F.getRendererInternal("fiori2").logRecentActivity(i)}y.openURL(e,"_blank")}}},onTilePinButtonClick:function(e){const t=this.oLaunchPageService;const i=t.getDefaultGroup();i.done(i=>{const o=e.getSource();const r=o.getBindingContext();const a=this.getView().getModel();const n=a.getProperty("/groupContext/path");if(n){const e=()=>{if(a.getProperty(n).object){this._handleTileFooterClickInGroupContext(r,n);return}setTimeout(e,100)};e()}else{const e=a.getProperty("/groups");const n=this.getCatalogTileDataFromModel(r);const l=n.tileData.associatedGroups;const g=[];const c=e.map(e=>{const o=t.getGroupId(e.object);const s=!(l&&Array.prototype.indexOf.call(l,o)===-1);g.push({id:o,title:this._getGroupTitle(i,e.object),selected:s});return{selected:s,initiallySelected:s,oGroup:e}});let h;h=t.getCatalogTilePreviewTitle(a.getProperty(r.sPath).src);if(!h){h=t.getCatalogTileTitle(a.getProperty(r.sPath).src)}this.pPopoverView=s.create({id:"sapUshellGroupsPopover",viewName:"module:sap/ushell/components/appfinder/GroupListPopoverView",viewData:{title:h,enableHideGroups:a.getProperty("/enableHideGroups"),enableHelp:a.getProperty("/enableHelp"),sourceContext:r,catalogModel:this.getView().getModel(),catalogController:this}}).then(e=>{e.getController().initializeData({groupData:c});e.open(o).then(this._handlePopoverResponse.bind(this,r,n));this.getView().addDependent(e);return e})}})},_getGroupTitle:function(e,t){const i=this.oLaunchPageService;let o;if(e&&i.getGroupId(e)===i.getGroupId(t)){o=n.i18n.getText("my_group")}else{o=i.getGroupTitle(t)}return o},_handlePopoverResponse:function(e,t,i){if(!i.addToGroups.length&&!i.newGroups.length&&!i.removeFromGroups.length){return}const o=this.getView().getModel();const s=o.getProperty("/groups");const r=[];i.addToGroups.forEach(t=>{const i=s.indexOf(t);const a=new p(o,`/groups/${i}`);r.push(this._addTile(e,a))});i.removeFromGroups.forEach(t=>{const i=e.getModel().getProperty(e.getPath()).id;const o=s.indexOf(t);r.push(this._removeTile(i,o))});i.newGroups.forEach(t=>{const i=t.length>0?t:n.i18n.getText("new_group_name");r.push(this._createGroupAndSaveTile(e,i))});jQuery.when.apply(jQuery,r).then(function(){const e=Array.prototype.slice.call(arguments);this._handlePopoverGroupsActionPromises(t,i,e)}.bind(this))},_handlePopoverGroupsActionPromises:function(e,t,i){const o=i.filter(e=>!e.status);if(o.length){const t=this.prepareErrorMessage(o,e.tileData.title);T.resetAssociationOnFailure(t.messageId,t.parameters);return}const s=[];const r=this.oLaunchPageService;t.allGroups.forEach(e=>{if(e.selected){const t=r.getGroupId(e.oGroup.object);s.push(t)}});const a=this.getView().getModel();if(t.newGroups.length){const e=a.getProperty("/groups");const i=e.slice(e.length-t.newGroups.length);i.forEach(e=>{const t=r.getGroupId(e.object);s.push(t)})}a.setProperty(`${e.bindingContextPath}/associatedGroups`,s);let n=t.addToGroups[0]?t.addToGroups[0].title:"";if(n.length===0&&t.newGroups.length){n=t.newGroups[0]}const l=t.removeFromGroups[0]?t.removeFromGroups[0].title:"";const g=t.addToGroups.length+t.newGroups.length;const c=t.removeFromGroups.length;const h=this.prepareDetailedMessage(e.tileData.title,g,c,n,l);d.show(h)},_getCatalogTileIndexInModel:function(e){const t=e.sPath;const i=t.split("/");const o=i[i.length-1];return o},_handleTileFooterClickInGroupContext:function(e,t){const i=this.oLaunchPageService;const o=this.getView().getModel();const s=this.getCatalogTileDataFromModel(e);const r=s.tileData.associatedGroups;const a=o.getProperty(t);const n=i.getGroupId(a.object);const l=r?Array.prototype.indexOf.call(r,n):-1;const g=s.bindingContextPath;if(s.isBeingProcessed){return}o.setProperty(`${g}/isBeingProcessed`,true);let c;let h;if(l===-1){const i=new p(e.getModel(),t);c=this._addTile(e,i);h=true}else{const i=e.getModel().getProperty(e.getPath("id"));const o=parseInt(t.split("/")[2],10);c=this._removeTile(i,o);h=false}c.done(t=>{if(t.status){this._groupContextOperationSucceeded(e,s,a,h)}else{this._groupContextOperationFailed(s,a,h)}});c.always(()=>{o.setProperty(`${g}/isBeingProcessed`,false)})},_groupContextOperationSucceeded:function(e,t,i,o){const s=this.oLaunchPageService;const r=s.getGroupId(i.object);const a=t.tileData.associatedGroups;let n;if(o){a.push(r);e.getModel().setProperty(`${t.bindingContextPath}/associatedGroups`,a);n=this.prepareDetailedMessage(t.tileData.title,1,0,i.title,"")}else{for(let e=0;e<a.length;e++){if(a[e]===r){a.splice(e,1);break}}e.getModel().setProperty(`${t.bindingContextPath}/associatedGroups`,a);n=this.prepareDetailedMessage(t.tileData.title,0,1,"",i.title)}d.show(n)},_groupContextOperationFailed:function(e,t,i){let o;if(i){o={messageId:"fail_tile_operation_add_to_group",parameters:[e.tileData.title,t.title]}}else{o={messageId:"fail_tile_operation_remove_from_group",parameters:[e.tileData.title,t.title]}}T.notifyOnActionFailure(o.messageId,o.parameters)},prepareErrorMessage:function(e,t){let i;let o;let s;let r=0;let a=0;let n=false;for(const t in e){const s=e[t].group;const l=e[t].action;if(l==="add"){r++;if(r===1){i=s.title}}else if(l==="remove"){a++;if(a===1){o=s.title}}else if(l==="addTileToNewGroup"){r++;if(r===1){i=s.title}}else{n=true}}if(n){if(e.length===1){s={messageId:"fail_tile_operation_create_new_group"}}else{s={messageId:"fail_tile_operation_some_actions"}}}else if(e.length===1){if(r){s={messageId:"fail_tile_operation_add_to_group",parameters:[t,i]}}else{s={messageId:"fail_tile_operation_remove_from_group",parameters:[t,o]}}}else if(a===0){s={messageId:"fail_tile_operation_add_to_several_groups",parameters:[t]}}else if(r===0){s={messageId:"fail_tile_operation_remove_from_several_groups",parameters:[t]}}else{s={messageId:"fail_tile_operation_some_actions"}}return s},prepareDetailedMessage:function(e,t,i,o,s){let r;if(t===0){if(i===1){r=n.i18n.getText("tileRemovedFromSingleGroup",[e,s])}else if(i>1){r=n.i18n.getText("tileRemovedFromSeveralGroups",[e,i])}}else if(t===1){if(i===0){r=n.i18n.getText("tileAddedToSingleGroup",[e,o])}else if(i===1){r=n.i18n.getText("tileAddedToSingleGroupAndRemovedFromSingleGroup",[e,o,s])}else if(i>1){r=n.i18n.getText("tileAddedToSingleGroupAndRemovedFromSeveralGroups",[e,o,i])}}else if(t>1){if(i===0){r=n.i18n.getText("tileAddedToSeveralGroups",[e,t])}else if(i===1){r=n.i18n.getText("tileAddedToSeveralGroupsAndRemovedFromSingleGroup",[e,t,s])}else if(i>1){r=n.i18n.getText("tileAddedToSeveralGroupsAndRemovedFromSeveralGroups",[e,t,i])}}return r},getCatalogTileDataFromModel:function(e){const t=e.getPath();const i=e.getModel();const o=i.getProperty(t);return{tileData:o,bindingContextPath:t,isBeingProcessed:o.isBeingProcessed}},_addTile:function(e,t){const i=jQuery.Deferred();const o=T.createTile({catalogTileContext:e,groupContext:t});o.done(e=>{i.resolve(e)});return i},_removeTile:function(e,t){const i=jQuery.Deferred();const o=T.deleteCatalogTileFromGroup({tileId:e,groupIndex:t});o.done(e=>{i.resolve(e)});return i},_createGroupAndSaveTile:function(e,t){const i=jQuery.Deferred();const o=T.createGroupAndSaveTile({catalogTileContext:e,newGroupName:t});o.done(e=>{i.resolve(e)});return i},onExit:function(){f.destroy();i.getInstance().unsubscribe("launchpad","appFinderWithDocking",this._handleAppFinderWithDocking,this);i.getInstance().unsubscribe("launchpad","appFinderAfterNavigate",this._handleAppFinderAfterNavigate,this)}})});
//# sourceMappingURL=Catalog.controller.js.map