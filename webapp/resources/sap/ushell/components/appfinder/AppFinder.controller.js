// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/extend","sap/ui/core/EventBus","sap/ui/core/mvc/View","sap/ui/core/mvc/Controller","sap/ui/core/Component","sap/ushell/EventHub","sap/ushell/components/appfinder/VisualizationOrganizerHelper","sap/ui/core/routing/HashChanger","sap/ui/thirdparty/jquery","sap/ui/model/json/JSONModel","sap/ui/Device","sap/ui/thirdparty/hasher","sap/ushell/Container"],(e,t,s,o,n,a,r,i,l,jQuery,u,h,c,p)=>{"use strict";let d;return n.extend("sap.ushell.components.appfinder.AppFinder",{onInit:function(){const e=a.getOwnerComponentFor(this.getView());this.oRouter=e.getRouter();const t=this.getView();const s=e.getModel();t.setModel(s);d=e.oCatalogsManager;this.bEnableEasyAccessSAPMenu=s.getProperty("/enableEasyAccessSAPMenu");this.bEnableEasyAccessUserMenu=s.getProperty("/enableEasyAccessUserMenu");this.bEnableEasyAccessOnTablet=s.getProperty("/enableEasyAccessOnTablet");const n=this.bEnableEasyAccessSAPMenu||this.bEnableEasyAccessUserMenu;const r=!h.system.phone&&!h.system.tablet||h.system.tablet&&this.bEnableEasyAccessOnTablet||h.system.combi;this.bShowEasyAccessMenu=n&&r;this.getView().setModel(this._getSubHeaderModel(),"subHeaderModel");this.oConfig=e.getComponentData().config;this.pCatalogView=o.create({id:"catalogView",viewName:"module:sap/ushell/components/appfinder/CatalogView",height:"100%",viewData:{parentComponent:e,subHeaderModel:this._getSubHeaderModel(),CatalogsManager:d}});this.oVisualizationOrganizerHelper=i.getInstance();this.oInitPromise=this.pCatalogView.then(e=>{e.addStyleClass("sapUiGlobalBackgroundColor sapUiGlobalBackgroundColorForce");return this.oVisualizationOrganizerHelper.loadAndUpdate()});this.oRouter.attachRouteMatched(this._handleAppFinderNavigation.bind(this));t.createSubHeader();h.resize.attachHandler(this._resizeHandler.bind(this));this.oRouter.oHashChanger=l.getInstance()},onExit:function(){this.pCatalogView.then(e=>{e.destroy()})},_resizeHandler:function(){const e=this._showOpenCloseSplitAppButton();const t=this.oSubHeaderModel.getProperty("/openCloseSplitAppButtonVisible");if(e!==t){this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonVisible",e);if(e){this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonToggled",false)}}this._toggleViewWithToggleButtonClass(e)},_handleAppFinderNavigation:function(e){try{const e=p.getRendererInternal();e.getRootControl().getShellHeader()._oLastFocusedHeaderElement=null}catch{}const o=t({},e);if(this.firstView!==false){if(!this.bShowEasyAccessMenu){this.pCatalogView.then(e=>{this.getView().oPage.addContent(e);setTimeout(()=>{jQuery("#catalogSelect").focus()},0)})}this.firstView=false}this.pCatalogView.then(e=>{e.getController().customRouteMatched(o)});const n=this.getView();this._preloadAppHandler();this._getPathAndHandleGroupContext(e);this._toggleViewWithToggleButtonClass(this._showOpenCloseSplitAppButton());if(this.bShowEasyAccessMenu){this.onShow(e)}else if(n._showSearch("catalog")){n.updateSubHeader("catalog",false);this._toggleViewWithSearchAndTagsClasses("catalog")}s.getInstance().publish("showCatalog");r.emit("CenterViewPointContentRendered","appFinder");r.emit("showCatalog",{sId:"showCatalog",oData:Date.now()});s.getInstance().publish("launchpad","contentRendered");if(r.last("firstCatalogSegmentCompleteLoaded")){r.emit("CloseFesrRecord",Date.now())}},_showOpenCloseSplitAppButton:function(){return!h.orientation.landscape||h.system.phone||this.oView.getModel().getProperty("/isPhoneWidth")},_resetSubHeaderModel:function(){this.oSubHeaderModel.setProperty("/activeMenu",null);this.oSubHeaderModel.setProperty("/search",{searchMode:false,searchTerm:null});this.oSubHeaderModel.setProperty("/tag",{tagMode:false,selectedTags:[]});this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonVisible",this._showOpenCloseSplitAppButton());this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonToggled",false)},_getSubHeaderModel:function(){if(this.oSubHeaderModel){return this.oSubHeaderModel}this.oSubHeaderModel=new u;this._resetSubHeaderModel();return this.oSubHeaderModel},onTagsFilter:function(e){const t=e.getSource();const s=t.getModel("subHeaderModel");const o=e.getSource().getSelectedItems();const n=o.length>0;const a={tagMode:n,selectedTags:[]};o.forEach(e=>{a.selectedTags.push(e.getText())});s.setProperty("/activeMenu",this.getCurrentMenuName());s.setProperty("/tag",a);this.pCatalogView.then(e=>{e.getController().onTag(a)})},searchHandler:function(e){let t=e.getSource().getValue();let s=false;if(t===null){return}const o=this.oSubHeaderModel.getProperty("/search");let n=this.oSubHeaderModel.getProperty("/activeMenu");if(this.getCurrentMenuName()!==n){n=this.getCurrentMenuName()}if(!o.searchMode&&!e.getParameter("clearButtonPressed")){o.searchMode=true}if(o.searchMode&&h.system.phone){this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonToggled",false)}if(t!==o.searchTerm){if(this.containsOnlyWhiteSpaces(t)){t="*"}o.searchTerm=t;s=true}this.oSubHeaderModel.setProperty("/search",o);this.oSubHeaderModel.setProperty("/activeMenu",n);this.oSubHeaderModel.refresh(true);if(s){this.pCatalogView.then(e=>{e.getController().onSearch(o)})}},_preloadAppHandler:function(){setTimeout(()=>{const e=c.getHash()||"";if(!e.startsWith("Shell-appfinder")){return}this._updateShellHeader(this.oView.oPage.getTitle())},0)},getCurrentMenuName:function(){return this.currentMenu},_navigateTo:function(e){const t=this.oVisualizationOrganizerHelper.getNavigationContextAsText.apply(this);if(t){this.oRouter.navTo(e,{filters:t},true)}else{this.oRouter.navTo(e,{},true)}},_filterSystemModelsOnTablet:function(e){const t=new jQuery.Deferred;if(this.bEnableEasyAccessOnTablet){p.getServiceAsync("NavTargetResolutionInternal").then(s=>{const o=e.reduce((e,t)=>{const o=s.isNavigationSupported([{target:{semanticObject:"Shell",action:"startWDA"},params:{"sap-system":t.systemId,"sap-ui2-wd-app-id":"."}},{target:{semanticObject:"Shell",action:"startGUI"},params:{"sap-system":t.systemId,"sap-ui2-tcode":"."}}]);e.push(new Promise((e,s)=>{o.then(s=>{const o={system:t,isSupported:false};if(s[0].supported||s[1].supported){o.isSupported=true}e(o)}).fail(()=>{e({system:t,isSupported:false})})}));return e},[]);Promise.all(o).then(e=>{const s=e.reduce((e,t)=>{if(t.isSupported){e.push(t.system)}return e},[]);t.resolve(s)})})}else{t.resolve(e)}return t.promise()},getGroupNavigationContext:function(){const e=this.oView.getModel().getProperty("/groupContext");const t=e?e.path:null;if(t){return JSON.stringify({targetGroup:encodeURIComponent(t)})}return null},getSystemsModels:function(){const e=this;if(this.getSystemsPromise){return this.getSystemsPromise}const t=new jQuery.Deferred;this.getSystemsPromise=t.promise();const s=["userMenu","sapMenu"].map(t=>{const s=new u;s.setProperty("/systemSelected",null);s.setProperty("/systemsList",[]);return e.getSystems(t).then(e._filterSystemModelsOnTablet.bind(e)).then(e=>{s.setProperty("/systemsList",e);return s})});jQuery.when.apply(jQuery,s).then((e,s)=>{t.resolve(e,s)});return this.getSystemsPromise},onSegmentButtonClick:function(e){this.oSubHeaderModel.setProperty("/search/searchMode",false);this.oSubHeaderModel.setProperty("/search/searchTerm","");const t=e.getParameter("id");this._navigateTo(t)},onShow:function(e){const t=e.getParameter("name");if(t===this.getCurrentMenuName()){return}const s=this.getView();s._updateSearchWithPlaceHolder(t);this._updateCurrentMenuName(t);this.getSystemsModels().then((e,t)=>{const n=t.getProperty("/systemsList");const r=e.getProperty("/systemsList");s.oPage.removeAllContent();const i=this.currentMenu==="sapMenu"?n:r;if(i&&i.length){s.updateSubHeader(this.currentMenu,true)}else if(s._showSearch(this.currentMenu)){s.updateSubHeader(this.currentMenu,false)}if(this.currentMenu==="catalog"){this.pCatalogView.then(e=>{s.oPage.addContent(e)})}else if(this.currentMenu==="userMenu"){if(!this.pUserMenuView){this.pUserMenuView=o.create({id:"userMenuView",viewName:"module:sap/ushell/components/appfinder/EasyAccessView",height:"100%",viewData:{menuName:"USER_MENU",easyAccessSystemsModel:e,parentComponent:a.getOwnerComponentFor(this.getView()),subHeaderModel:this._getSubHeaderModel(),enableSearch:this.getView()._showSearch("userMenu"),CatalogsManager:d}})}this.pUserMenuView.then(e=>{s.oPage.addContent(e)})}else if(this.currentMenu==="sapMenu"){if(!this.pSapMenuView){this.pSapMenuView=o.create({id:"sapMenuView",viewName:"module:sap/ushell/components/appfinder/EasyAccessView",height:"100%",viewData:{menuName:"SAP_MENU",easyAccessSystemsModel:t,parentComponent:a.getOwnerComponentFor(this.getView()),subHeaderModel:this._getSubHeaderModel(),enableSearch:this.getView()._showSearch("sapMenu"),CatalogsManager:d}})}this.pSapMenuView.then(e=>{s.oPage.addContent(e)})}this._setFocusToSegmentedButton(i);this.oSubHeaderModel.setProperty("/activeMenu",this.currentMenu);if(this.oSubHeaderModel.getProperty("/openCloseSplitAppButtonVisible")){this.oSubHeaderModel.setProperty("/openCloseSplitAppButtonToggled",false)}this.oSubHeaderModel.refresh(true)})},_updateCurrentMenuName:function(e){if(!this.bShowEasyAccessMenu||e==="sapMenu"&&!this.bEnableEasyAccessSAPMenu||e==="userMenu"&&!this.bEnableEasyAccessUserMenu){this.currentMenu="catalog"}else{this.currentMenu=e}this._toggleViewWithSearchAndTagsClasses(e)},_toggleViewWithSearchAndTagsClasses:function(e){const t=this.getView();if(t._showSearch(e)){t.oPage.addStyleClass("sapUshellAppFinderSearch")}else{t.oPage.removeStyleClass("sapUshellAppFinderSearch")}if(t._showSearchTag(e)){t.oPage.addStyleClass("sapUshellAppFinderTags")}else{t.oPage.removeStyleClass("sapUshellAppFinderTags")}},_toggleViewWithToggleButtonClass:function(e){const t=this.getView();if(e){t.oPage.addStyleClass("sapUshellAppFinderToggleButton")}else{t.oPage.removeStyleClass("sapUshellAppFinderToggleButton")}},_setFocusToSegmentedButton:function(e){const t=this.getView();if(e&&e.length){const e=t.segmentedButton.getSelectedButton();setTimeout(()=>{jQuery(`#${e}`).focus()},0)}else{setTimeout(()=>{jQuery("#catalogSelect").focus()},0)}},_getPathAndHandleGroupContext:function(e){const t=e.getParameter("arguments");const s=t.filters;let o;try{o=JSON.parse(s)}catch{o=s}this.oVisualizationOrganizerHelper.updateModelWithContext.apply(this,[o])},_updateModelWithGroupContext:function(e){const t=this.oView.getModel();let s=e&&decodeURIComponent(e.targetGroup)||"";let o=t.getProperty(s);s=s==="undefined"?undefined:s;const n={path:s,id:"",title:o&&o.title};if(s&&s!==""){p.getServiceAsync("FlpLaunchPage").then(e=>{function a(){const r=t.getProperty("/groups");if(r.length&&o?.object){o=t.getProperty(s);n.id=e.getGroupId(o.object);n.title=o.title||e.getGroupTitle(o.object);return}setTimeout(a,100)}a()})}t.setProperty("/groupContext",n)},getSystems:function(t){const s=new jQuery.Deferred;p.getServiceAsync("ClientSideTargetResolution").then(e=>e.getEasyAccessSystems(t)).then(e=>{const t=[];const o=Object.keys(e);for(let s=0;s<o.length;s++){const n=o[s];t[s]={systemName:e[n].text,systemId:n}}s.resolve(t)}).catch(t=>{e.error("An error occurred while retrieving the systems:",t);s.reject(t)});return s.promise()},_updateShellHeader:async function(e){const t=await this.getOwnerComponent().getService("ShellUIService");t.setTitle(e);t.setHierarchy()},containsOnlyWhiteSpaces:function(e){if(!e||e===""){return false}return!e.replace(/\s/g,"").length}})});
//# sourceMappingURL=AppFinder.controller.js.map