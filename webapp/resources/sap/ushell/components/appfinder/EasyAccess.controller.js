// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/i18n/Localization","sap/ui/core/Element","sap/ui/core/mvc/Controller","sap/ui/core/mvc/View","sap/base/Log","sap/ui/model/odata/ODataUtils","sap/ui/thirdparty/datajs","sap/ui/thirdparty/jquery","sap/ushell/resources","sap/ui/model/json/JSONModel","sap/ushell/ui/launchpad/AccessibilityCustomData","sap/ushell/Config","sap/ushell/Container","sap/ushell/utils/LaunchpadError"],(e,t,s,r,i,a,o,jQuery,n,l,c,h,u,p)=>{"use strict";return s.extend("sap.ushell.components.appfinder.EasyAccess",{DEFAULT_URL:"/sap/opu/odata/UI2",DEFAULT_NUMBER_OF_LEVELS:3,SEARCH_RESULTS_PER_REQUEST:100,onInit:function(){const e=this;this.translationBundle=n.i18n;this.oView=this.getView();const t=this.oView.getModel("easyAccessSystemsModel");const s=t.bindProperty("/systemSelected");s.attachChange(e.adjustUiOnSystemChange.bind(this));this.menuName=this.oView.getViewData().menuName;this.systemId=null;this.easyAccessCache={};this.easyAccessModel=new l;this.easyAccessModel.setSizeLimit(1e3);Promise.all([this.oView.pHierarchyFolders,this.oView.pHierarchyApps]).then(e=>{e[0].setModel(this.easyAccessModel,"easyAccess");e[1].setModel(this.easyAccessModel,"easyAccess")});if(!h.last("/core/spaces/enabled")){sap.ui.require(["sap/ushell/components/HomepageManager"],e=>{const t=this.getView().getModel();if(!t.getProperty("/catalogs")){if(!t.getProperty("/groups")||t.getProperty("/groups").length===0){const t=e.prototype.getInstance();if(t){this.oHomepageManager=t;this.oHomepageManager.loadPersonalizedGroups()}else{i.error("The homepage manager was not initialized. Tiles in user and sap menu cannot be added to groups.")}}}})}const r=this.oView.getModel("subHeaderModel");const a=r.bindProperty("/openCloseSplitAppButtonToggled");a.attachChange(e.handleToggleButtonModelChanged.bind(this));if(this.oView.getViewData().enableSearch){const t=r.bindProperty("/search");t.attachChange(e.handleSearchModelChanged.bind(this))}this.checkIfSystemSelectedAndLoadData()},checkIfSystemSelectedAndLoadData:function(){const e=this.oView.getModel("easyAccessSystemsModel").getProperty("/systemSelected");if(e){this.systemId=e.systemId;this.loadMenuItemsFirstTime(this.oView.getViewData().menuName,e)}},navigateHierarchy:function(e,t){Promise.all([this.oView.pHierarchyFolders,this.oView.pHierarchyApps]).then(s=>{const r=s[0];const i=s[1];r.setBusy(false);const a=this.easyAccessModel.getProperty(e||"/");if(typeof a.folders!=="undefined"){r.updatePageBindings(e,t);i.getController().updatePageBindings(e);return}r.setBusy(true);this.getMenuItems(this.menuName,this.systemId,a.id,a.level).then(function(e,s){this.easyAccessModel.setProperty(`${e}/folders`,s.folders);this.easyAccessModel.setProperty(`${e}/apps`,s.apps);r.updatePageBindings(e,t);i.getController().updatePageBindings(e);r.setBusy(false)}.bind(this,e)).catch(e=>{this.handleGetMenuItemsError(e)})})},handleSearch:function(e){const t=!this.pHierarchyAppsSearchResults;if(t){this.pHierarchyAppsSearchResults=r.create({id:`${this.getView().getId()}hierarchyAppsSearchResults`,viewName:"module:sap/ushell/components/appfinder/HierarchyAppsView",height:"100%",viewData:{easyAccessSystemsModel:this.oView.getModel("easyAccessSystemsModel"),getMoreSearchResults:this.getMoreSearchResults.bind(this),CatalogsManager:this.getView().getViewData().CatalogsManager}}).then(e=>{this.easyAccessSearchResultsModel=new l;this.easyAccessSearchResultsModel.setSizeLimit(1e4);e.setModel(this.easyAccessSearchResultsModel,"easyAccess");e.addStyleClass(" sapUshellAppsView sapMShellGlobalInnerBackground");e.addCustomData(new c({key:"role",value:"region",writeToDom:true}));e.addCustomData(new c({key:"aria-label",value:this.oView.oResourceBundle.getText("easyAccessTileContainer"),writeToDom:true}));return e})}this.pHierarchyAppsSearchResults.then(s=>{this.searchResultFrom=0;this.oView.splitApp.getCurrentDetailPage().setBusy(true);this.easyAccessSearchResultsModel.setProperty("/apps",[]);this.easyAccessSearchResultsModel.setProperty("/total",0);this._getSearchResults(e,this.searchResultFrom).then(e=>{u.getServiceAsync("BookmarkV2").then(r=>{e.results.forEach(e=>{r.countBookmarks(e.url).then(t=>{e.bookmarkCount=t})});this.easyAccessSearchResultsModel.setProperty("/apps",e.results);this.easyAccessSearchResultsModel.setProperty("/total",e.count);this.searchResultFrom=e.results.length;if(t){this.oView.splitApp.addDetailPage(s)}s.updateResultSetMessage(parseInt(e.count,10),true);this.oView.splitApp.getCurrentDetailPage().setBusy(false);if(this.oView.splitApp.getCurrentDetailPage()!==s){this.oView.splitApp.toDetail(`${this.getView().getId()}hierarchyAppsSearchResults`)}})}).catch(e=>{this.handleGetMenuItemsError(e);this.oView.splitApp.getCurrentDetailPage().setBusy(false)});return s})},getMoreSearchResults:function(){if(this.oView.splitApp.getCurrentDetailPage().setShowMoreResultsBusy){this.oView.splitApp.getCurrentDetailPage().setShowMoreResultsBusy(true)}const e=this.oView.getModel("subHeaderModel");const t=e.getProperty("/search/searchTerm");this._getSearchResults(t,this.searchResultFrom).then(e=>{const t=this.easyAccessSearchResultsModel.getProperty("/apps");const s=t.slice();Array.prototype.push.apply(s,e.results);this.easyAccessSearchResultsModel.setProperty("/apps",s);if(this.oView.splitApp.getCurrentDetailPage().setShowMoreResultsBusy){this.oView.splitApp.getCurrentDetailPage().setShowMoreResultsBusy(false)}this.searchResultFrom=s.length}).catch(e=>{this.handleGetMenuItemsError(e);if(this.oView.splitApp.getCurrentDetailPage().setShowMoreResultsBusy){this.oView.splitApp.getCurrentDetailPage().setShowMoreResultsBusy(true)}})},_getSearchResults:function(e,t){const s=new jQuery.Deferred;const r=this._getODataRequestForSearchUrl(this.menuName,this.systemId,e,t);const i={requestUri:r};const a=this._callODataService(i,this.handleSuccessOnReadFilterResults);a.done(e=>{s.resolve(e)});a.fail(e=>{s.reject(e)});return s.promise()},getSystemNameOrId:function(){const e=this.oView.getModel("easyAccessSystemsModel").getProperty("/systemSelected");if(e){return e.name||e.id}return undefined},adjustUiOnSystemChange:function(){const e=this.easyAccessModel.getData();if(this.systemId&&e&&e.id){this.easyAccessCache[this.systemId]=e}const t=this.oView.getModel("easyAccessSystemsModel").getProperty("/systemSelected");if(t){this.systemId=t.systemId;const e=this.easyAccessCache[this.systemId];if(e){this.easyAccessModel.setData(e);this.navigateHierarchy("",false)}else{Promise.all([this.oView.pHierarchyFolders,this.oView.pHierarchyApps]).then(e=>{e[0].setBusy(true);e[1].setBusy(true)});this.loadMenuItemsFirstTime(this.menuName,t)}}},handleToggleButtonModelChanged:function(){const e=this.oView.getModel("subHeaderModel");const t=e.getProperty("/openCloseSplitAppButtonVisible");const s=e.getProperty("/openCloseSplitAppButtonToggled");const r=this.getView().splitApp;if(t){if(s&&!r.isMasterShown()){r.showMaster()}else if(r.isMasterShown()){r.hideMaster()}}},handleSearchModelChanged:function(){const e=this.oView.getModel("subHeaderModel");const s=e.getProperty("/activeMenu");if(this.getView().getId().indexOf(s)===-1){return}const r=e.getProperty("/search/searchTerm");const i=e.getProperty("/search/searchMode");if(i){t.getElementById("appFinderSearch").getCustomData()[0].setValue(`${this.getView().getId()}hierarchyAppsSearchResults`);if(r){this.handleSearch(r)}}else{t.getElementById("appFinderSearch").getCustomData()[0].setValue("");this.oView.splitApp.toDetail(`${this.getView().getId()}hierarchyApps`)}},loadMenuItemsFirstTime:function(e,t){return this.getMenuItems(e,t.systemId,"",0).then(e=>{e.text=t.systemName||t.systemId;this.easyAccessModel.setData(e);Promise.all([this.oView.pHierarchyFolders,this.oView.pHierarchyApps]).then(e=>{e[0].setBusy(false);e[1].setBusy(false)});this.navigateHierarchy("",false)}).catch(e=>{this.handleGetMenuItemsError(e);Promise.all([this.oView.pHierarchyFolders,this.oView.pHierarchyApps]).then(e=>{e[0].updatePageBindings("/",false);e[1].getController().updatePageBindings("/")})})},handleGetMenuItemsError:function(e){const t=this.getErrorMessage(e);sap.ui.require(["sap/m/MessageBox"],e=>{e.error(t)});this.easyAccessModel.setData("");this.oView.hierarchyFolders.setBusy(false);this.oView.hierarchyApps.setBusy(false)},_getErrorDetails:function(e){try{const t=JSON.parse(e.response.body);return t.error.message.value}catch(e){return null}},getErrorMessage:function(e){let t="";if(this.menuName==="SAP_MENU"){t=this.translationBundle.getText("easyAccessSapMenuNameParameter")}else if(this.menuName==="USER_MENU"){t=this.translationBundle.getText("easyAccessUserMenuNameParameter")}if(e){if(e.message){const s=this._getErrorDetails(e);if(s){return this.translationBundle.getText("easyAccessErrorGetDataErrorMsgWithDetails",[t,e.message,s])}return this.translationBundle.getText("easyAccessErrorGetDataErrorMsg",[t,e.message])}return this.translationBundle.getText("easyAccessErrorGetDataErrorMsg",[t,e])}return this.translationBundle.getText("easyAccessErrorGetDataErrorMsgNoReason",[t])},getMenuItems:function(e,t,s,r,i){const a=new jQuery.Deferred;if(e!=="SAP_MENU"&&e!=="USER_MENU"){a.reject(new Error("Invalid menuType parameter"));return a.promise()}if(typeof t!=="string"||t===""){a.reject(new Error("Invalid systemId parameter"));return a.promise()}if(typeof s!=="string"){a.reject(new Error("Invalid entityId parameter"));return a.promise()}if(typeof r!=="number"){a.reject(new Error("Invalid entityLevel parameter"));return a.promise()}if(i&&typeof i!=="number"){a.reject(new Error("Invalid numberOfNextLevels parameter"));return a.promise()}if(s===""){r=0}let o;const n=this.getView().getModel();const l=n.getProperty("/easyAccessNumbersOfLevels");if(l){o=l}else if(i){o=i}else{o=this.DEFAULT_NUMBER_OF_LEVELS}const c=r+o+1;const h=this._getODataRequestUrl(e,t,s,c);const u={requestUri:h};const p=this._callODataService(u,this.handleSuccessOnReadMenuItems,{systemId:t,entityId:s,iLevelFilter:c});p.done(e=>{a.resolve(e)});p.fail(e=>{a.reject(e)});return a.promise()},_callODataService:function(t,s,r){const i=new jQuery.Deferred;const a=u.getUser().getLanguage();if(a&&t.requestUri.indexOf("sap-language=")<0){t.requestUri+=`${t.requestUri.indexOf("?")>=0?"&":"?"}sap-language=${a}`}const n=u.getLogonSystem();const l=n&&n.getClient();o.read({requestUri:t.requestUri,headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0","Accept-Language":e.getLanguage()||"","sap-client":l||"","sap-language":a||""}},(e,t)=>{if(e&&e.results&&t&&t.statusCode===200){const t=s.bind(this,e,r||{})();i.resolve(t)}},e=>{const t=new p(`Failed to fetch data: ${e.message}`,{dataJsError:e});i.reject(t)});return i.promise()},handleSuccessOnReadMenuItems:function(e,t){const s=this._oDataResultFormatter(e.results,t.systemId,t.entityId,t.iLevelFilter);return s},handleSuccessOnReadFilterResults:function(e){let t;e.results.forEach((e,s)=>{t=this._appendSystemToUrl(e,this.systemId);e.url=t});return{results:e.results,count:e.__count}},_appendSystemToUrl:function(e,t){if(e.url){return`${e.url+(e.url.indexOf("?")>0?"&":"?")}sap-system=${t}`}},_oDataResultFormatter:function(e,t,s,r){const i={};let a={};if(s===""){a={id:"root",text:"root",level:0,folders:[],apps:[]};i.root=a}else{a={id:s,folders:[],apps:[]};i[s]=a}let o;for(let s=0;s<e.length;s++){o=e[s];let a;if(o.level==="01"){a=i.root}else{a=i[o.parentId]}const n={id:o.Id,text:o.text,subtitle:o.subtitle,icon:o.icon,level:parseInt(o.level,10)};if(o.type==="FL"){n.folders=[];n.apps=[];if(o.level==r-1){n.folders=undefined;n.apps=undefined}if(a&&a.folders){a.folders.push(n)}i[o.Id]=n}else{n.url=this._appendSystemToUrl(o,t);if(a&&a.apps){a.apps.push(n)}}}return a},_getODataRequestUrl:function(e,t,s,r){let i=this._getServiceUrl(e);let a;if(r<10){a=`0${r}`}else{a=r.toString()}let o="";if(s){if(decodeURIComponent(s)===s){s=encodeURIComponent(s)}o=`('${s}')/AllChildren`}i=`${i};o=${t}/MenuItems${o}?$filter=level lt '${a}'&$orderby=level,text`;return i},_getODataRequestForSearchUrl:function(e,t,s,r){let i=this._getServiceUrl(e);const o=this.SEARCH_RESULTS_PER_REQUEST;s=this._removeWildCards(s);s=encodeURIComponent(s);r=!r?0:r;s=a.formatValue(s,"Edm.String");i=`${i};o=${t}/MenuItems?$filter=type ne 'FL' and (`+`substringof(${s}, text) or `+`substringof(${s}, subtitle) or `+`substringof(${s}, url)`+")"+`&$orderby=text,subtitle,url&$inlinecount=allpages&$skip=${r}&$top=${o}`;return i},_getServiceUrl:function(e){let t;const s=this.getView().getModel();if(e==="SAP_MENU"){const e=s.getProperty("/sapMenuServiceUrl");if(e){t=e}else{t=`${this.DEFAULT_URL}/EASY_ACCESS_MENU`}}else if(e==="USER_MENU"){const e=s.getProperty("/userMenuServiceUrl");if(e){t=e}else{t=`${this.DEFAULT_URL}/USER_MENU`}}return t},_removeWildCards:function(e){return e.replace(/\*/g,"")}})});
//# sourceMappingURL=EasyAccess.controller.js.map