// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ushell/EventHub","sap/ushell/services/AppConfiguration","sap/ushell/performance/StatisticalRecord","sap/ushell/utils","sap/ushell/Container"],(e,n,t,a,i,r)=>{"use strict";const o="ShellAnalytics";const c="[FesrFlp]";let s=[];let l=[];let p=false;let u=false;let d=false;let h;let f;let g;const m={EXPLACE:"EXPLACE",INPLACE:"INPLACE"};const A={"sap.ushell.components.appfinder":"FLP_FINDER","sap.ushell.components.pages":"FLP_PAGE","sap.ushell.components.homepage":"FLP_HOME"};function C(e){if(!e){return false}return e.id==="FLP_HOME"||e.id==="FLP_PAGE"}function v(e){return e&&e.isHomeApp}function N(){return s}function I(){const e=N().filter(e=>e.isClosed());if(e.length>0){return e[e.length-1]}return null}function y(e){if(!e){return N().filter(e=>e.isClosed())}return N().filter(n=>e.getTimeStart()<n.getTimeStart()&&n.isClosed())}function E(){return f}function P(n){e.debug(`${c} ShellAnalytics setCurrentApplication: ${n&&n.id}`,null,o);f=n}function L(){g=performance.now();i.setPerformanceMark("FLP -- change hash")}function S(){if(!h){const e=s[s.length-1]||null;h=new a(e);s.push(h)}return h}function T(e){if(d){d=false;return}const n=S();n.setTargetHash(e);n.setTimeStart(g||performance.now())}function R(e){const n=e||"";if(n.slice(-7)==="(TCODE)"){return n.replace(/ .*/,"").replace(/^\*/,"").replace(/,/g,"").substring(0,15).concat(" (TR)")}return n}function H(e){let n="";const t=e.componentInstance&&e.componentInstance.getManifest();if(t&&t["sap.app"]&&t["sap.app"].id){n=t["sap.app"].id}return n}async function F(){const e=await r.getServiceAsync("AppLifeCycle");const n=e.getCurrentApplication();if(!n){return{}}const a=n&&n.componentInstance&&n.componentInstance.sId&&n.componentInstance.sId.includes("homeApp-component");let i;if(n.getTechnicalParameter){i=n.getTechnicalParameter("sap-fiori-id")}else{i=Promise.resolve([])}const o=await i;let c=o&&o[0];if(a){return{type:"UI5",id:c,isHomeApp:true}}if(n.homePage){const e=A[H(n)]||"FLP_HOME";return{type:"UI5",id:e}}if(n.applicationType==="UI5"){if(!c){c=H(n);c=A[c]||c}c=c.replace(/,/g,"");return{type:"UI5",id:c}}const s=t.getMetadata().technicalName||t.getCurrentApplication().text||n.applicationType;const l=R(s);return{type:n.applicationType,id:l}}function w(e,n,t,a){if(a){a.setSourceApplication(e&&e.id);a.setTargetApplication(n&&n.id);a.setTargetApplicationType(n&&n.type);a.setNavigationMode(t);a.setTargetIsHomeApp(v(n));a.setSourceIsHomeApp(v(e));if(!p&&(v(n)||C(n))){p=true;a.setHomepageLoading(true)}a.closeRecord()}}async function b(e){const n=await r.getServiceAsync("AppLifeCycle");const{ApplicationType:t}=n;return[t.WDA,t.NWBC,t.TR].includes(e)}function M(e){if(!h){return}const n=h;h=null;F().then(async t=>{const a=E();const i=await b(t.type);if(e&&e.technicalName&&i){t.id=R(e.technicalName);t.type=t.id.slice(-4)==="(TR)"?"GUI":"NWBC"}P(t);w(a,t,m.INPLACE,n)})}function O(){d=true;const e=h;h=null;const n=E();w(n,null,m.EXPLACE,e)}function $(){if(h){const e=E();h.setSourceApplication(e?e.id:undefined);h.closeRecordWithError();h=null}}async function _(){const e=await r.getServiceAsync("ShellNavigationInternal");e.hashChanger.attachEvent("hashChanged",L);e.hashChanger.attachEvent("shellHashChanged",L)}async function U(){const e=await r.getServiceAsync("ShellNavigationInternal");e.hashChanger.detachEvent("hashChanged",L);e.hashChanger.detachEvent("shellHashChanged",L)}function W(e){const n=S();n.enhanceTargetApplicationData({pageId:e.pageId,spaceId:e.spaceId})}function D(){if(u){return}u=true;const t=[{once:true,eventName:"ShellNavigationInitialized",handler:_},{eventName:"trackHashChange",handler:T},{eventName:"doHashChangeError",handler:$},{once:true,eventName:"firstSegmentCompleteLoaded",handler:M},{once:true,eventName:"firstCatalogSegmentCompleteLoaded",handler:M},{once:true,eventName:"PagesRuntimeRendered",handler:M},{once:true,eventName:"CustomHomeRendered",handler:M},{eventName:"PageRendered",handler:W},{eventName:"FESRAppLoaded",handler:M},{eventName:"openedAppInNewWindow",handler:O},{eventName:"CloseFesrRecord",handler:M}];const a=t.map(t=>{if(t.once){return n.once(t.eventName).do((...n)=>{e.debug(`${c} Incoming event: ${t.eventName}`,JSON.stringify(n[0],null,2),o);t.handler(...n)})}return n.on(t.eventName).do((...n)=>{e.debug(`${c} Incoming event: ${t.eventName}`,JSON.stringify(n[0],null,2),o);t.handler(...n)})});l=[...l,...a]}function G(){if(!u){return}l.forEach(e=>{e.off()});l=[];U();P(null);s=[];h=null;u=false;d=false}return{enable:D,disable:G,getAllRecords:N,getCurrentApplication:E,getLastClosedRecord:I,getNextNavigationRecords:y}},false);
//# sourceMappingURL=ShellAnalytics.js.map