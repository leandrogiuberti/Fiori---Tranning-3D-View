// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/ui/performance/trace/FESR","sap/ushell/EventHub","sap/ushell/performance/ShellAnalytics","sap/ushell/renderer/RendererManagedComponents"],(e,t,n,r,a,i)=>{"use strict";const s="FesrEnhancer";const o="[FesrFlp]";const c={HOME_INITIAL:"FLP@LOAD",HOME_LOADING:"FLP@DURING_LOAD",FINDER_INITIAL:"FLP@LOAD_FINDER",APP_INITIAL:"FLP@DEEP_LINK",NAVIGATION:"NAVIGATION",CUSTOM_HOME_INITIAL:"FLPCUSTOMHOME"};const l=[c.HOME_INITIAL,c.FINDER_INITIAL,c.CUSTOM_HOME_INITIAL,c.APP_INITIAL];const u={APP_START:1,STEP_IN_APP:2,UNKNOWN:3};const d=["stepName","appNameLong","appNameShort","interactionType","timeToInteractive"];const p={stepName:{maxLength:20,postfix:"@H2H"},appNameShort:{maxLength:20}};const f={_fnOriginalOnBeforeCreated:null,_oLastTrackedRecord:null,init:function(){if(n.getActive()){a.enable();this._fnOriginalOnBeforeCreated=n.onBeforeCreated;n.onBeforeCreated=this._onBeforeCreatedHandler.bind(this)}},reset:function(){n.onBeforeCreated=this._fnOriginalOnBeforeCreated;a.disable();this._setLastTrackedRecord(null)},_getPerformanceEntries:function(e,t){if(t){return performance.getEntriesByName(e)}return performance.getEntriesByType("mark").filter(t=>t.name.includes(e))},_getLastTrackedApplicationId:function(){const e=a.getCurrentApplication();if(e){return e.id}return null},_getLastTrackedRecord:function(){return this._oLastTrackedRecord},_setLastTrackedRecord:function(e){this._oLastTrackedRecord=e},_getLastFesrHandle:function(){const e=this._oLastFesrHandle;this._oLastFesrHandle=undefined;return e!==undefined?e:null},_setLastFesrHandle:function(e){this._oLastFesrHandle=e},_onBeforeCreatedHandler:function(n,a){let i=t({},n);try{const{scenario:t,relatedRecord:n}=this._detectScenario(i);e.debug(`${o} identified scenario: ${t}`,null,s);const a=this._getLastTrackedApplicationId();if(a){i.appNameShort=a}let u;switch(t){case c.HOME_INITIAL:case c.CUSTOM_HOME_INITIAL:case c.FINDER_INITIAL:u=this._enhanceInitialStart(i,t,n);break;case c.APP_INITIAL:u=this._enhanceInitialAppStart(t,n);break;case c.NAVIGATION:case c.HOME_LOADING:u=this._enhanceNavigationRecord(t,n);break;default:e.debug(`${o} unknown scenario, step name: ${i.stepName}`,null,s);this._setLastFesrHandle(i);return i}if(l.includes(t)){r.emit("startUpFesrEnhanced",Date.now())}u=this.sanitizeEnhancement(u);i={...i,...u};e.debug(`${o} passing enhancements:`,JSON.stringify(u,null,2),s)}catch(t){e.error(`${o} Could not enhance the FESR:`,t,s)}e.debug(`${o}      => UI5: ${i.stepName} - ${i.appNameShort}`,null,s);this._setLastFesrHandle(i);return i},shortenAccordingToFormatter:function(e,t){let n="";if(t&&t.maxLength){n=e.substring(0,t.maxLength)}else{n=e}return n},shortenWithPostfix:function(e,t,n=0){const r=p[t];if(r){if(r.postfix){if(e.endsWith(r.postfix)){const t={...r,maxLength:r.maxLength-r.postfix.length+n};const a=this.shortenAccordingToFormatter(e.slice(0,-1*t.postfix.length),t);return a+t.postfix}}return this.shortenAccordingToFormatter(e,r)}return e},sanitizeValue:function(e,t){if(d.includes(t)&&e){if(typeof e==="string"&&e.includes(":")){const[n,r]=e.split(":");return`${this.shortenWithPostfix(n,t,-5)}:${r}`}return this.shortenWithPostfix(e,t)}},sanitizeEnhancement:function(e){return Object.keys(e).reduce((t,n)=>{const r=e[n];const a=this.sanitizeValue(r,n);if(a!==undefined){t[n]=a}return t},{})},_getRelevantPerformanceMark:function(t){if(!t){e.warning(`${o} Could not determine performance mark`,"No Statistical Record found",s);return}const n=[];if(t.getTargetIsHomeApp()){n.push(this._getPerformanceEntries("FLP-TTI-Homepage-Custom",true)[0])}else{switch(t.getTargetApplication()){case"FLP_HOME":n.push(this._getPerformanceEntries("FLP-TTI-Homepage",true)[0]);break;case"FLP_PAGE":n.push(this._getPerformanceEntries("FLP-TTI-Homepage",true)[0]);n.push(this._getPerformanceEntries("FLP-Pages-Service-loadPage-end",false)[0]);break;case"FLP_FINDER":n.push(this._getPerformanceEntries("FLP-TTI-AppFinder",true)[0]);break;default:}}return n.filter(e=>{if(!e){return false}if(typeof e.startTime!=="number"){return false}if(e.startTime>t.getTimeStart()){return true}return false})[0]},_detectScenario:function(t){if(t.stepName==="undetermined_startup"){let n;const r=a.getLastClosedRecord();if(r){this._setLastTrackedRecord(r)}else{e.warning(`${o} Identified undetermined_startup but could not find a closed StatisticalRecord`,null,s);return{scenario:null,relatedRecord:null}}if(r.getTargetIsHomeApp()){n=c.CUSTOM_HOME_INITIAL}else{switch(t.appNameLong){case"sap.ushell.components.appfinder":n=c.FINDER_INITIAL;break;default:if(i.isManagedComponentName(t.appNameLong)){if(r.getStep()===c.APP_INITIAL){n=c.APP_INITIAL}else{n=c.HOME_INITIAL}}else{n=c.APP_INITIAL}}}return{scenario:n,relatedRecord:r}}const n=this._getLastTrackedRecord();const r=a.getNextNavigationRecords(n);if(r.length){const t=r[r.length-1];if(r.length>1){const t=r.reduce((e,t,n)=>{if(n<r.length-1){e.push(t.getTargetHash())}return e},[]);e.warning(`${o} skipped Records:`,JSON.stringify(t,null,2),s)}if(n&&t.isEqual(n)){return{scenario:null,relatedRecord:null}}this._setLastTrackedRecord(t);const a=t.getStep()===c.HOME_LOADING?c.HOME_LOADING:c.NAVIGATION;return{scenario:a,relatedRecord:t}}return{scenario:null,relatedRecord:null}},_enhanceInitialStart:function(t,n,r){const a={};if(n===c.CUSTOM_HOME_INITIAL){a.stepName=`${n}@${t.appNameShort}`}else{a.stepName=n}a.interactionType=u.APP_START;a.appNameShort=r.getTargetAppNameShort()||r.getTargetApplication();const i=this._getRelevantPerformanceMark(r);if(i){e.debug(`${o} using performance mark: ${i.name}`,null,s);a.timeToInteractive=i.startTime}else{e.warning(`${o} Scenario ${n} detected did not found a performance mark`,null,s)}return a},_enhanceNavigationRecord:function(t,n){const r={};if(t!=="FLP@DURING_LOAD"){r.stepName=n.getStep()}if(n.getTargetApplicationType()==="UI5"){r.interactionType=u.APP_START}r.appNameShort=n.getTargetAppNameShort()||n.getTargetApplication();const a=this._getRelevantPerformanceMark(n);if(/^FLP_BACK/.test(r.stepName)&&a){e.debug(`${o} using performance mark: ${a.name}`,null,s);r.timeToInteractive=a.startTime-n.getTimeStart()}return r},_enhanceInitialAppStart:function(e,t){const n={};n.stepName=e;if(t.getTargetApplicationType()==="UI5"){n.interactionType=u.APP_START}else{n.interactionType=u.STEP_IN_APP}return n}};return f},true);
//# sourceMappingURL=FesrEnhancer.js.map