// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/base/util/extend","sap/base/util/ObjectPath","sap/ui/thirdparty/URI","sap/ui/thirdparty/jquery","sap/ushell/System","sap/ushell/User","sap/ushell/utils","sap/ushell/Container","sap/ushell/resources","sap/ushell/Config"],(e,t,s,n,i,jQuery,o,r,a,l,c,u)=>{"use strict";const d=e.getLogger("sap/ushell/adapters/cdm/ContainerAdapter",e.Level.INFO);function f(u,f,g){function m(e,t){if(e.systemProperties&&e.systemProperties.logoutUrl){return e.systemProperties.logoutUrl}return t}function h(){return{setThemePermitted:false,setAccessibilityPermitted:false,setContentDensityPermitted:false,getLanguageAndRegionSettingsEntry:async function(){const[e]=await a.requireAsync(["sap/ushell/adapters/cdm/Settings/UserLanguageAndRegion/UserLanguageAndRegionEntry"]);return e}}}function p(e,t,n){const i=s(h(),e,t);i.bootTheme=i.bootTheme||{theme:i.theme,root:""};delete i.theme;if(n){if(n.editablePropterties){i.setThemePermitted=n.editablePropterties.indexOf("theme")>-1;i.setAccessibilityPermitted=n.editablePropterties.indexOf("accessibility")>-1;i.setContentDensityPermitted=n.editablePropterties.indexOf("contentDensity")>-1}if(n.ranges){i.ranges=n.ranges}}return i}function y(e){const s=t(e);const n=["id","email","firstName","lastName","fullName","isJamActive","isAdminUser","timeZone","language","languageBcp47","image","isImageConsent","isLanguagePersonalized","calendarWeekNumbering","trackUsageAnalytics","contentDensity","setContentDensityPermitted","accessibility","setAccessibilityPermitted","bootTheme","themeRoot","ranges","setThemePermitted","importBookmarks","showMyHome","detectDarkMode","getLanguageAndRegionSettingsEntry"];Object.keys(s).forEach(e=>{if(!n.includes(e)){delete s[e]}});return s}function P(e){let t;const s=e.userProfile;if(s){t=p(s.defaults,e.userProfilePersonalization,s.metadata)}const n=y(t||h());return new r(n)}function A(e,t){const s=t.systemProperties;let n=e.getAlias();let i=e.getPlatform();const r=e.getBaseUrl();let a;let l;let c;let u;let d;let f;let g;if(s){n=s.alias||n;i=s.platform||i;a=s.SID;l=s.client;c=s.productName;u=s.productVersion;d=s.systemName;f=s.systemRole;g=s.tenantRole}return new o({alias:n,platform:i,baseUrl:r,system:a,client:l,productName:c,productVersion:u,systemName:d,systemRole:f,tenantRole:g})}function b(e){const t=e&&e.systemProperties&&e.systemProperties.sessionKeepAlive;if(!t){return null}if(!t.url){d.error("Mandatory parameter 'url' missing in 'sessionKeepAlive' configuration.");return null}if(t.method!=="HEAD"&&t.method!=="GET"){t.method="HEAD"}return t}const R="/sap/public/bc/icf/logoff";const w=m(g.config,R);const T=n.get("systemProperties.logoutMethod",g.config)||"GET";const C=n.get("systemProperties.csrfTokenUrl",g.config);const S=P(g.config);const L=A(u,g.config);const U=b(g.config);this._getLogoutUrl=function(){return w};this._setDocumentLocation=function(e){document.location=e};this._setWindowLocation=function(e){window.location.href=e};this.getSystem=function(){return L};this.getUser=function(){return S};this.load=function(){return jQuery.when()};this.getCurrentUrl=function(){return window.location.href};this.logout=async function(e){let t;if(!e){throw new Error("Not implemented")}if(a.hasNativeLogoutCapability()){t=new i(this._getLogoutUrl()).absoluteTo(this.getCurrentUrl()).search("").toString();a.getPrivateEpcm().doLogOff(t)}else{await this.logoutRedirect()}};this.logoutRedirect=async function(){const t=L.adjustUrl(this._getLogoutUrl());if(T==="POST"){e.info("performing logout from system via POST",undefined,"sap.ushell.adapters.cdm.ContainerAdapter::logoutRedirect");let s=false;let n;try{n=await fetch(C,{method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}})}catch(e){s=true}if(s||!n.ok){e.error(`fetching X-CSRF-Token for logout via POST failed for system: ${L.getAlias()}`,undefined,"sap.ushell.adapters.cdm.ContainerAdapter::logoutRedirect");if(n.status===401){a.reload();return}const t=await l.getServiceAsync("MessageInternal");t.show(t.Type.ERROR,c.i18n.getText("LogoutFailed"),{callback:a.reload});return}let i;try{i=await fetch(t,{method:"POST",headers:{"X-CSRF-Token":n.headers.get("X-CSRF-Token")}});const e=await i.text();this._setWindowLocation(e)}catch(e){s=true}if(s||!i.ok){e.error(`logout via POST failed for system: ${L.getAlias()}`,undefined,"sap.ushell.adapters.cdm.ContainerAdapter::logoutRedirect")}}else{e.info("performing logout from system via GET (redirect)",undefined,"sap.ushell.adapters.cdm.ContainerAdapter::logoutRedirect");this._setDocumentLocation(t)}};this.sessionKeepAlive=function(){if(!U){return}const e=new XMLHttpRequest;e.open(U.method,U.url,true);e.onreadystatechange=function(){if(this.readyState===4){d.debug("Server session was extended")}};e.send()};this._getSessionKeepAliveConfig=function(){return U}}return f},false);
//# sourceMappingURL=ContainerAdapter.js.map