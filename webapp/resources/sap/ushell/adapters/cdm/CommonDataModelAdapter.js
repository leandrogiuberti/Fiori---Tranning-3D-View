// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/extend","sap/base/util/Version","sap/ui/thirdparty/URI","sap/ui/thirdparty/jquery","sap/ushell/Container"],(e,t,o,i,jQuery,n)=>{"use strict";function r(e,t,o){this.oAdapterConfiguration=o;if(o&&o.config&&o.config.siteData){this.oCdmSiteDataRequestPromise=(new jQuery.Deferred).resolve(o.config.siteData)}else if(o&&o.config&&o.config.siteDataPromise){this.oCdmSiteDataRequestPromise=o.config.siteDataPromise}else{const e=this._identifySiteUrlFromConfig(o);const t=this._normalizeUrl(e,location.href);this.oCdmSiteDataRequestPromise=this._requestSiteData(t)}}r.prototype._requestSiteData=function(t){const o=new jQuery.Deferred;if(!t){return o.reject(new Error("Cannot load site: configuration property 'siteDataUrl' is missing for CommonDataModelAdapter."))}jQuery.ajax({type:"GET",dataType:"json",url:t}).done(e=>{o.resolve(e)}).fail(t=>{e.error(t.responseText);o.reject(new Error("CDM Site was requested but could not be loaded."))});return o.promise()};r.prototype._normalizeUrl=function(e,t){if(typeof e!=="string"){return e}if(e.indexOf("http")===0){return e}const o=document.getElementsByTagName("base")[0];return new i(e,o).absoluteTo(t).toString()};r.prototype.getSite=function(){const e=new jQuery.Deferred;this.oCdmSiteDataRequestPromise.done(o=>{const i=t({},o);delete i.personalization;e.resolve(i)}).fail(t=>{e.reject(t)});return e.promise()};r.prototype.getPersonalization=function(){const o=new jQuery.Deferred;const i=this;this.oCdmSiteDataRequestPromise.done(n=>{const r=t({},n);const a=r._version;let s;if(i.oAdapterConfiguration&&i.oAdapterConfiguration.config&&i.oAdapterConfiguration.config.ignoreSiteDataPersonalization){delete r.personalization}if(r.personalization){s=r.personalization._version;if(Object.keys(r.personalization).length>0&&!i._isPersonalizationVersionValid(a,s)){e.error("Personalization version is not compatible to the site version and will not be loaded."+` Please proceed to personalize the homepage again if needed. Personalization version: ${s}; Site version: ${a}`);o.resolve();return}o.resolve(r.personalization)}else{i._readPersonalizationDataFromStorage(a).done(t=>{s=t._version;if(Object.keys(t).length>0&&!i._isPersonalizationVersionValid(a,s)){e.error("Personalization version is not compatible to the site version and will not be loaded."+` Please proceed to personalize the homepage again if needed. Personalization version: ${s}; Site version: ${a}`);o.resolve();return}o.resolve(t)}).fail(e=>{o.reject(e)})}}).fail(e=>{o.reject(e)});return o.promise()};r.prototype._isPersonalizationVersionValid=function(e,t){if(!e){return false}const i=new o(e).getMajor();const n=new o(t);if(i>=3){return n.getMajor()===i}return n.getMajor()<3};r.prototype.setPersonalization=function(t){const i=new jQuery.Deferred;n.getServiceAsync("PersonalizationV2").then(async n=>{let r;const a={keyCategory:n.KeyCategory.FIXED_KEY,writeFrequency:n.WriteFrequency.LOW,clientStorageAllowed:true};let s={container:"sap.ushell.cdm.personalization",item:"data"};const l=new o(t.version);if(l.inRange("3.1.0","4.0.0")){s={container:"sap.ushell.cdm3-1.personalization",item:"data"}}const c=await n.getPersonalizer(s,a,r);c.setPersData(t).then(()=>{e.info("Personalization data has been stored successfully.");i.resolve()}).catch(t=>{e.error("Writing personalization data failed.",t);i.reject(t)})});return i.promise()};r.prototype._readPersonalizationDataFromStorage=function(t){const i=new jQuery.Deferred;n.getServiceAsync("PersonalizationV2").then(async n=>{const r={keyCategory:n.KeyCategory.FIXED_KEY,writeFrequency:n.WriteFrequency.LOW,clientStorageAllowed:true};let a={container:"sap.ushell.cdm.personalization",item:"data"};if(t){const e=new o(t);if(e&&e.inRange("3.1.0","4.0.0")){a={container:"sap.ushell.cdm3-1.personalization",item:"data"}}}const s=await n.getPersonalizer(a,r);s.getPersData().then(e=>{i.resolve(e||{})}).catch(t=>{e.error("Fetching personalization data failed.",t);i.reject(t)})});return i.promise()};r.prototype._identifySiteUrlFromConfig=function(e){const t=new URLSearchParams(window.location.search);let o=t.get("sap-ushell-cdm-site-url");const i=e&&e.config;if(i&&!i.allowSiteSourceFromURLParameter&&o){o=null}if(i&&!o){o=i.siteDataUrl||i.cdmSiteUrl}this.sCdmSiteUrl=o;return o};return r},false);
//# sourceMappingURL=CommonDataModelAdapter.js.map