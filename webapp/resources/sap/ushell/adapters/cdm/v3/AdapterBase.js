// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/adapters/cdm/v3/_LaunchPage/readHome","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/m/GenericTile","sap/ui/core/ComponentContainer","sap/ushell/adapters/cdm/_LaunchPage/uri.transform","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/navigationMode","sap/ushell/resources","sap/ushell/utils","sap/ushell/adapters/cdm/v3/utilsCdm","sap/base/util/Version","sap/ui/thirdparty/jquery","sap/base/util/isPlainObject","sap/base/util/isEmptyObject","sap/base/util/ObjectPath","sap/base/util/deepExtend","sap/base/util/deepClone","sap/base/Log","sap/ushell/UI5ComponentType","sap/ushell/Container","sap/ushell/utils/LaunchpadError"],(e,t,i,o,r,n,s,l,a,u,p,c,d,jQuery,f,g,h,m,T,v,y,R,_)=>{"use strict";const C=v.getLogger("sap/ushell/adapters/cdm/LaunchPageAdapter");const b=v.Level;const I="sap.ushell.components.tiles.cdm.applauncher";const S="sap.ushell.components.tiles.cdm.applauncherdynamic";function D(e,t,i){this.oAdapterConfiguration=i;this._mResolvedTiles={};this._mCatalogTilePromises={};this._mFailedResolvedCatalogTiles={};this._mFailedResolvedTiles={};this.TileType={Tile:"tile",Link:"link",Card:"card"}}D.prototype.getGroups=function(){const e=new jQuery.Deferred;this._ensureLoaded().then(t=>{p.setPerformanceMark("FLP - homepage groups processed");e.resolve(t)}).catch(()=>{e.resolve([])});return e.promise()};D.prototype._ensureLoaded=function(){const t=this;if(this._loaded){return this._loaded}const i=new jQuery.Deferred;this._ensureLoadedDeferred=i;this._loaded=new Promise((i,o)=>{this._getSiteData().then(o=>{if(!t.isSiteSupported(o)){throw new Error("Invalid CDM site version: Check the configuration of the launchpage adapter and the version of the FLP site")}let r=[];let n=e.getGroupsArrayFromSite(o);n=t._addDefaultGroup(n,o);n.forEach(e=>{r=t._ensureGroupItemsResolved(e,o).concat(r)});t._allPromisesDone(r).done(()=>{i(n);delete t._loaded;t._logTileResolutionFailures(t._mFailedResolvedTiles)})}).catch(e=>{C.error("Delivering homepage groups failed",e);i([]);delete t._loaded})});return this._loaded};D.prototype._ensureGroupItemsResolved=function(e,t){const i=[];let o;let r;if(e.payload&&e.payload.tiles){o=this._ensureGroupTilesResolved(e.payload.tiles,t);Array.prototype.push.apply(i,o)}if(e.payload&&e.payload.links){r=this._ensureGroupLinksResolved(e.payload.links,t);Array.prototype.push.apply(i,r)}return i};D.prototype._ensureGroupTilesResolved=function(e,t){return(e||[]).map(function(e,i){return this._resolveGroupTile(e,t).then(e=>{e.isLink=false;return e})},this)};D.prototype._ensureGroupLinksResolved=function(e,t){return(e||[]).map(function(e){return this._resolveGroupTile(e,t).then(e=>{e.isLink=true;return e})},this)};D.prototype._resolveGroupTile=function(e,t){const i=this._mResolvedTiles;const o=this._mFailedResolvedTiles;let r;function n(t){i[e.id]=t;if(o[e.id]){delete o[e.id]}return t}function s(e){const t=e.target;return t&&t.semanticObject==="Shell"&&t.action==="launchURL"}if(i[e.id]){return(new jQuery.Deferred).resolve(i[e.id]).promise()}if(e.target&&e.target.url){r=jQuery.when(this._getTileForUrl(e))}else if(e.isBookmark&&e.vizType===undefined){r=this._resolveTileByIntent(e,t)}else if(s(e)){r=this._resolveTileByIntent(e,t)}else{r=this._resolveTileByVizId(e,t)}const l=new jQuery.Deferred;r.done(e=>{l.resolve(n(e))}).fail(t=>{if(t instanceof _){o[e.id]={logLevel:t.details?.logLevel||b.ERROR,message:t.message}}else{o[e.id]={logLevel:b.ERROR,message:t.toString()}}l.reject(t)});return l.promise()};D.prototype._resolveTileByVizId=function(o,r){let n;let l;let u;let d;let g;let h;let v;let y;function R(e,t){const i=new _(t,{logLevel:e});return(new jQuery.Deferred).reject(i).promise()}const C=new jQuery.Deferred;if(!f(r)){return R(b.ERROR,"Cannot resolve tile: oSite must be an object")}if(!f(o)){return R(b.ERROR,"Cannot resolve tile: oTile must be an object")}const I=o.vizId;const S=T(t.get(r,I||"")||{});const D=o.vizType||t.getTypeId(S);const L=t.getType(r,D);if(!L){return R(b.ERROR,`Cannot resolve tile '${o.id}': no visualization type found for vizTypeId '${D}'`)}const w=t.getAppId(S);if(w){n=t.getAppDescriptor(r,w);if(!n){return R(b.INFO,`Tile '${o.id}' filtered from result: no app descriptor found for appId '${w}' (dangling app reference)`)}l=e.getInbound(n,t.getTarget(S).inboundId);if(!l){return R(b.ERROR,`Cannot resolve tile '${o.id}': app '${w}' has no navigation inbound`)}u=c.mapOne(l.key,l.inbound,n,S,L,r);const p=u.resolutionResult.applicationType;const f=u.resolutionResult.additionalInformation;const m=s.last("/core/navigation/enableInPlaceForClassicUIs");const T=m?m[p]:false;d=a.computeNavigationModeForHomepageTiles(p,f,T);h=t.getOutbound(S,l.inbound);y=i.harmonizeTarget(h);g=this._toHashFromOutbound(y)}else{S.vizConfig=m({},S.vizConfig,o.vizConfig);u=c.mapOne(undefined,undefined,undefined,S,L,r);if(t.startsExternalUrl(S)){v=p.getMember(S.vizConfig,"sap|flp.target.url")}}const P=u.tileResolutionResult;P.navigationMode=d;P.isLink=false;if(!this._isFormFactorSupported(P)){return R(b.INFO,`Tile '${o.id}' filtered from result: form factor not supported`)}if(v||g){C.resolve({tileResolutionResult:P,tileIntent:v||g})}else{if(o.target){const e=T(o.target);g=c.toHashFromTarget(i.harmonizeTarget(e))}C.resolve({tileResolutionResult:P,tileIntent:g})}return C.promise()};D.prototype._isFormFactorSupported=function(t){const i=p.getFormFactor();return e.supportsFormFactor(t,i)};D.prototype._getFirstInbound=function(e){const t=Object.keys(e["sap.app"].crossNavigation.inbounds).shift();const i=e["sap.app"].crossNavigation.inbounds[t];return{key:t,inbound:i}};D.prototype._resolveTileByIntent=function(e){const t=this._prepareTileHash(e);return this._getTileFromHash(t)};D.prototype._allPromisesDone=function(e){const t=new jQuery.Deferred;if(e.length===0){t.resolve([])}else{const i=e.map(e=>{const t=new jQuery.Deferred;e.always(t.resolve.bind(t));return t.promise()});jQuery.when.apply(this,i).done(function(){const e=Array.prototype.slice.call(arguments);t.resolve(e)})}return t.promise()};D.prototype._logTileResolutionFailures=function(e){const t={};if(!e){return}Object.keys(b).filter(e=>{const t=b[e];return t>=b.FATAL&&t<=b.ALL}).forEach(e=>{t[b[e]]=""});Object.keys(e).forEach(i=>{const o=e[i];if(o.logLevel){t[o.logLevel]=t[o.logLevel].concat(o.message).concat("\n")}});if(t[b.FATAL]){C.fatal(t[b.FATAL])}if(t[b.ERROR]){C.error(t[b.ERROR])}if(t[b.WARNING]){C.warning(t[b.WARNING])}if(t[b.INFO]){C.info(t[b.INFO])}if(t[b.DEBUG]){C.debug(t[b.DEBUG])}if(t[b.TRACE]){C.trace(t[b.TRACE])}};D.prototype._isValidTitle=function(e){return typeof e==="string"&&e};D.prototype._isGroupPreset=function(t){return e.isGroupPreset(t)};D.prototype._isGroupLocked=function(t){return e.isGroupLocked(t)};D.prototype.getGroupTitle=function(t){return e.getGroupTitle(t)};D.prototype.getGroupId=function(t){return e.getGroupId(t)};D.prototype.isGroupVisible=function(t){return e.isGroupVisible(t)};D.prototype.getTileTitle=function(t){return e.getTileTitle(this._mResolvedTiles,t)};D.prototype.getTileContentProviderId=function(t){return e.getContentProviderId(t)};D.prototype.getTileSubtitle=function(t){return e.getTileSubtitle(this._mResolvedTiles,t)};D.prototype.getTileIcon=function(t){return e.getTileIcon(this._mResolvedTiles,t)};D.prototype.getTileInfo=function(t){return e.getTileInfo(this._mResolvedTiles,t)};D.prototype.getTileIndicatorDataSource=function(e){const t=this._mResolvedTiles[e.id];const i={};if(e.indicatorDataSource){i.indicatorDataSource=m({},e.indicatorDataSource);if(e.dataSource){i.dataSource=m({},e.dataSource)}return i}if(!t){return i}const o=t.tileResolutionResult;if(o.indicatorDataSource){i.indicatorDataSource=m({},o.indicatorDataSource);if(o.indicatorDataSource.hasOwnProperty("dataSource")){const e=o.indicatorDataSource.dataSource;const r=o.dataSources;if(r&&r.hasOwnProperty(e)){i.dataSource=m({},r[e])}else{v.warning(`datasource referenced but not found for tile: ${t.tileIntent}`)}}if(p.getMember(o,"runtimeInformation.componentProperties.url")){const e=p.getMember(i,"indicatorDataSource.path");const t=p.getMember(i,"dataSource.uri");const r=p.getMember(o,"runtimeInformation.componentProperties.url");const s=n(e,t,r,this.getWindowLocationHref());if(!s.error){if(e){i.indicatorDataSource.path=s.uri}if(t){i.dataSource.uri=s.uriParent}}}}return i};D.prototype.getWindowLocationHref=function(){return window.location.href};D.prototype.isGroupRemovable=function(e){return!this._isGroupPreset(e)};D.prototype.isGroupLocked=function(e){return this._isGroupLocked(e)};D.prototype.getGroupTiles=function(t){return e.getGroupTiles(t).concat(e.getGroupLinks(t))};D.prototype.getTileType=function(t){if(e.isLink(this._mResolvedTiles,t)){return this.TileType.Link}if(e.isCard(this._mResolvedTiles,t)){return this.TileType.Card}return this.TileType.Tile};D.prototype.getTileId=function(t){return e.getTileId(t)};D.prototype.getTileSize=function(t){return e.getTileSize(this._mResolvedTiles,t)||"1x1"};D.prototype.getTileTarget=function(t){const i=e.getTileId(t);const o=this._mResolvedTiles[i];if(t.target&&t.target.url){return t.target.url}if(o){return o.tileIntent}v.warning(`Could not find a target for Tile with id '${i}'`,"sap.ushell.adapters.cdm.LaunchPageAdapter");return""};D.prototype.isTileIntentSupported=function(e){return this._mFailedResolvedTiles[e.id]===undefined};D.prototype.setTileVisible=function(e,t){const i=this._mResolvedTiles[e.id];if(i){if(i.tileComponent){this._notifyTileAboutVisibility(i.tileComponent,t,i.visibility)}i.visibility=t}};D.prototype.getCardManifest=function(e){const t=this._mResolvedTiles[e.id];const i=t.tileResolutionResult;return i.tileComponentLoadInfo};D.prototype._getTileUiComponentContainer=function(e,t,i){const n=this;let s;let a;let p;let c;let d;let f;const g=new jQuery.Deferred;R.getServiceAsync("Ui5ComponentLoader").then(o=>{a=o;const r=this._createTileComponentData(e,i,t);return r}).then(t=>this._enhanceTileComponentData(e,t)).then(h=>{s=t.tileResolutionResult;if(t.isLink){p=s.navigationMode;g.resolve(n._createLinkInstance(e,i,p,o,u));return}const m=this._createTileComponentProperties(h,s.tileComponentLoadInfo);if(!m.name){throw new Error(`Cannot find name of tile component for tile with id: '${e.id}'`)}if(m.manifest){h.properties=h.properties||{};h.properties.manifest=m.manifest}f=this._isCustomTileComponent(m.name);function T(t){let o;c=t.componentHandle.getInstance();d=new r({component:c,height:"100%"});if(!i){o=n._mResolvedTiles[e.id];o.tileComponent=c;if(typeof o.visibility==="boolean"){n._notifyTileAboutVisibility(c,o.visibility)}}return d}function v(){const e=new jQuery.Deferred;a.createComponent({loadCoreExt:f,loadDefaultDependencies:false,componentData:h,url:m.url,applicationConfiguration:{},reservedParameters:{},applicationDependencies:m,ui5ComponentName:m.name},{},[],y.Visualization).then(t=>{const i=T(t);e.resolve(i)}).catch(t=>{e.reject(t)});return e.promise()}if(f){l.once("CoreResourcesComplementLoaded").do(()=>{v().then(e=>{g.resolve(e)}).fail(e=>{g.reject(e)})})}else{v().then(e=>{g.resolve(e)}).fail(e=>{g.reject(e)})}}).catch(e=>{g.reject(e)});return g.promise()};D.prototype._createTileComponentProperties=function(e,t){let i={};if(!t||g(t)){if(e.properties.indicatorDataSource&&e.properties.indicatorDataSource.path){i.name=S}else{i.name=I}}else{i=t.componentProperties||{};i.name=t.componentName}return i};D.prototype.getTileView=function(e){const t=this;return new jQuery.Deferred(i=>t._getTileView(e,false).then(e=>{i.resolve(e)}).catch(t=>{v.error(`Tile with ID '${e.id}' of type '${e.tileType}' could not be initialized:`,t);i.reject(t)})).promise()};D.prototype._getTileView=function(e){let t;const i=new jQuery.Deferred;if(typeof e!=="object"||!e.id){t=`Invalid input parameter passed to _getTileView: ${e}`;v.error(t);return i.reject(new Error(t)).promise()}const o=this._mResolvedTiles[e.id];if(!o){t=`No resolved tile found for tile ID: ${e.id}`;v.error(t);return i.reject(new Error(t)).promise()}return this._getTileUiComponentContainer(e,o,false)};D.prototype._createTileComponentData=function(e,t,i){const o=t?this.getCatalogTileTitle(e):this.getTileTitle(e);const r=t?this.getCatalogTilePreviewSubtitle(e):this.getTileSubtitle(e);const n=t?this.getCatalogTilePreviewIcon(e):this.getTileIcon(e);const s=t?this.getCatalogTilePreviewInfo(e):this.getTileInfo(e);const l=t?this.getCatalogTileTargetURL(e):this.getTileTarget(e);const a=this.getTileIndicatorDataSource(e);const u=e.numberUnit||i.tileResolutionResult&&i.tileResolutionResult.numberUnit;const p={properties:{},startupParameters:{}};if(i.tileResolutionResult&&i.tileResolutionResult.isCustomTile===true&&i.tileResolutionResult.startupParameters){p.startupParameters=i.tileResolutionResult.startupParameters}if(o){p.properties.title=o}if(s){p.properties.info=s}if(r){p.properties.subtitle=r}if(n){p.properties.icon=n}if(l){p.properties.targetURL=l}if(u){p.properties.numberUnit=u}if(a.indicatorDataSource){p.properties.indicatorDataSource=a.indicatorDataSource;if(a.dataSource){p.properties.dataSource=a.dataSource}}if(i.tileResolutionResult){p.properties.navigationMode=i.tileResolutionResult.navigationMode;p.properties.contentProviderId=i.tileResolutionResult.contentProviderId||""}return p};D.prototype._enhanceTileComponentData=function(e,t){let i=Promise.resolve();const o=this.getTileContentProviderId(e);if(o){i=R.getServiceAsync("ClientSideTargetResolution").then(e=>e.getSystemContext(o)).then(e=>{t.properties.indicatorDataSource.path=e.getFullyQualifiedXhrUrl(t.properties.indicatorDataSource.path)}).catch(()=>{v.error("System Context not available")})}return i.then(()=>t)};D.prototype._isGroupTile=function(t){return e.isGroupTile(t)};D.prototype._isCatalogTile=function(e){return!!(e&&e.isCatalogTile)};D.prototype._isFailedGroupTile=function(t){return!!(t&&this._mFailedResolvedTiles&&this._mFailedResolvedTiles[e.getTileId(t)])};D.prototype.getCatalogTileId=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return undefined}if(e.isBookmark&&h.get("target.url",e)){return e.target.url}return e.vizId||e.target&&e.target.url}if(this._isCatalogTile(e)){return e.id}return undefined};D.prototype.getCatalogTilePreviewTitle=function(e){if(this._isGroupTile(e)){return this.getTileTitle(e)}return e.tileResolutionResult&&e.tileResolutionResult.title||""};D.prototype.getCatalogTileTargetURL=function(e){if(!e){throw new Error("The given tile is falsy")}if(this._isCatalogTile(e)){if(e.tileResolutionResult&&e.tileResolutionResult.isCustomTile){if(!e.tileResolutionResult.targetOutbound){return""}return this._toHashFromOutbound(e.tileResolutionResult.targetOutbound)}return e.tileIntent||""}return this.getTileTarget(e)};D.prototype.isGroupFeatured=function(e){return!!e.isFeatured};D.prototype._getMember=function(e,t){return p.getMember(e,t)};D.prototype.getCdmVersionsSupported=function(){return{min:new d("3.0.0"),max:new d("3.1.0")}};D.prototype.isSiteSupported=function(e){if(!e._version||new d(e._version).compareTo(this.getCdmVersionsSupported().min)<0||new d(e._version).compareTo(this.getCdmVersionsSupported().max)>0){v.fatal("Invalid CDM site version: Only version 3.0.0 is supported");return false}return true};D.prototype._isCustomTileComponent=function(e){return!(e===I||e===S)};return D});
//# sourceMappingURL=AdapterBase.js.map