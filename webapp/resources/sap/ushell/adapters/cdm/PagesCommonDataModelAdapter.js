// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/ushell/adapters/cdm/util/cdmSiteUtils","sap/base/util/extend","sap/base/util/Version","sap/ui/thirdparty/jquery","sap/ushell/Config","sap/ushell/Container"],(e,t,i,s,n,jQuery,o,a)=>{"use strict";function r(){this._oCDMPagesRequests={};this._oUnstableVisualizations={};this._sComponent="sap.ushell.adapters.cdm.PagesCommonDataModelAdapter";this.oSitePromise=new Promise((e,t)=>{this.fnSiteResolve=e;this.fnSiteReject=t})}r.prototype.getSite=function(){const e=new jQuery.Deferred;a.getServiceAsync("NavigationDataProvider").then(e=>e.getNavigationData()).then(e=>{const s={};const n=e.inbounds;for(let e=0;e<n.length;e++){const t=n[e].permanentKey||n[e].id;s[t]=n[e]}const o={_version:"3.1.0",site:{},catalogs:{},groups:{},visualizations:{},applications:i.getApplications(s),vizTypes:{},systemAliases:t({},e.systemAliases),pages:{}};this.fnSiteResolve(o);return o}).then(e.resolve).catch(t=>{e.reject(t);this.fnSiteReject(t)});return e.promise()};r.prototype.getPage=async function(t){if(!t){const t="PagesCommonDataModelAdapter: getPage was called without a pageId";e.fatal(t,null,this._sComponent);throw new Error(t)}return this.oSitePromise.then(i=>{if(i.pages[t]){return i.pages[t]}return Promise.all([a.getServiceAsync("PagePersistence"),a.getServiceAsync("NavigationDataProvider")]).then(e=>{const i=e[0];const s=e[1];return Promise.all([i.getPage(t),s.getNavigationData()])}).then(e=>{const t=e[0];const s=e[1];this._addVisualizationsToSite(i,t.visualizations);this._addVizTypesToSite(i,t);this._addPageToSite(i,t.page,s);this._storeUnstableVisualizations(t.page.id,t.unstableVisualizations);return i.pages[t.page.id]}).catch(t=>{e.fatal("PagesCommonDataModelAdapter encountered an error while fetching required services: ",t,this._sComponent);throw t})})};r.prototype._storeUnstableVisualizations=function(e,t){if(!t){return}this._oUnstableVisualizations[e]=t};r.prototype._addVizTypesToSite=function(e,t){const n={};Object.keys(t.vizTypes).forEach(i=>{if(!e.vizTypes[i]){n[i]=t.vizTypes[i]}});s(e.vizTypes,i.getVizTypes(n))};r.prototype._addVisualizationsToSite=function(e,t,n){let o;if(n){o={};Object.keys(t).forEach(i=>{if(!e.visualizations[i]){o[i]=t[i]}})}else{o=t}s(e.visualizations,i.getVisualizations(o))};r.prototype._addPageToSite=function(t,i,s){const n={};const o=s.inbounds;for(let e=0;e<o.length;e++){const t=o[e].permanentKey||o[e].id;n[t]=o[e]}const a=t.pages[i.id]={identification:{id:i.id,title:i.title},payload:{layout:{sectionOrder:i.sections.map(e=>e.id)},sections:{}}};let r;let l;for(let s=0;s<i.sections.length;s++){r=i.sections[s];l=a.payload.sections[r.id]={id:r.id,title:r.title,layout:{vizOrder:r.viz.map(e=>e.id)},viz:{}};let n;let o;for(let i=0;i<r.viz.length;i++){n=r.viz[i];o=!t.visualizations[n.vizId];if(o){const t=l.layout.vizOrder;t.splice(t.indexOf(n.id),1);if(o){e.error(`Tile '${n.id}' with vizId '${n.vizId}' has no matching visualization. As the tile cannot be used to start an app it is removed from the page.`,null,this._sComponent)}continue}l.viz[n.id]={id:n.id,vizId:n.vizId,displayFormatHint:n.displayFormatHint}}}};r.prototype.getPages=async function(t){if(!(t&&Array.isArray(t)&&t.length!==0)){const t="PagesCommonDataModelAdapter: getPages is not an array or does not contain any Page id";e.fatal(t,null,this._sComponent);throw new Error(t)}return this.oSitePromise.then(i=>{let s;const n=[];for(let e=0;e<t.length;e++){s=t[e];if(!i.pages[s]){n.push(t[e])}}if(n.length===0){return i.pages}return Promise.all([a.getServiceAsync("PagePersistence"),a.getServiceAsync("NavigationDataProvider")]).then(e=>{const t=e[0];const i=e[1];return Promise.all([t.getPages(n),i.getNavigationData()])}).then(e=>{const t=e[0];const s=e[1];for(let e=0;e<t.length;e++){this._addVisualizationsToSite(i,t[e].visualizations,true);this._addVizTypesToSite(i,t[e]);this._addPageToSite(i,t[e].page,s);this._storeUnstableVisualizations(t[e].page.id,t[e].unstableVisualizations)}return i.pages}).catch(t=>{e.fatal("PagesCommonDataModelAdapter encountered an error while fetching required services: ",t,this._sComponent);throw t})}).then(e=>{const i={};t.forEach(t=>{const s=e[t];if(s){i[t]=s}});return i})};r.prototype.getPersonalization=function(t){const i=new jQuery.Deferred;a.getServiceAsync("PersonalizationV2").then(async s=>{let o;const a=new n(t);o={container:"sap.ushell.cdm.personalization",item:"data"};if(a.inRange("3.1.0","4.0.0")){o={container:"sap.ushell.cdm3-1.personalization",item:"data"}}const r={validity:"Infinity",keyCategory:s.KeyCategory.GENERATED_KEY,writeFrequency:s.WriteFrequency.HIGH,clientStorageAllowed:false};const l=await s.getPersonalizer(o,r);l.getPersData().then(e=>{i.resolve(e||{})}).catch(t=>{e.error("Could not load page personalization",t,this._sComponent);i.reject(t)})}).catch(t=>{e.error("Personalization Service could not be loaded",t,this._sComponent);i.reject(t)});return i.promise()};r.prototype.setPersonalization=function(t){const i=new jQuery.Deferred;a.getServiceAsync("PersonalizationV2").then(async e=>{let s;const o=new n(t.version);s={container:"sap.ushell.cdm.personalization",item:"data"};if(o.inRange("3.1.0","4.0.0")){s={container:"sap.ushell.cdm3-1.personalization",item:"data"}}const a={validity:"Infinity",keyCategory:e.KeyCategory.GENERATED_KEY,writeFrequency:e.WriteFrequency.HIGH,clientStorageAllowed:false};const r=await e.getPersonalizer(s,a);r.setPersData(t).then(()=>{i.resolve(t)}).catch(e=>{i.reject(e)})}).catch(t=>{e.error("Personalization Service could not be loaded",t,this._sComponent);i.reject(t)});return i.promise()};r.prototype.getVisualizations=function(){return a.getServiceAsync("VisualizationDataProvider").then(e=>Promise.all([e.getVisualizationData(),this.oSitePromise]).then(e=>{const t=e[0];const i=e[1];this._addVisualizationsToSite(i,t.visualizations);return i.visualizations}))};r.prototype.getVizTypes=function(){return a.getServiceAsync("VisualizationDataProvider").then(e=>Promise.all([e.getVisualizationData(),this.oSitePromise]).then(e=>{const t=e[0];const i=e[1];this._addVizTypesToSite(i,t);return i.vizTypes}))};r.prototype.getVizType=function(e){return this.oSitePromise.then(t=>{const n=t.vizTypes[e];if(n){return n}if(!e.startsWith("X-SAP-UI2-CHIP:")){return}return a.getServiceAsync("VisualizationDataProvider").then(t=>t.loadVizType(e)).then(n=>{if(!n){return}const o={};o[e]=n;s(t.vizTypes,i.getVizTypes(o));return t.vizTypes[e]})})};r.prototype.getCachedVisualizations=function(){return this.oSitePromise.then(e=>e.visualizations)};r.prototype.getCachedVizTypes=function(){return this.oSitePromise.then(e=>e.vizTypes)};r.prototype.migratePersonalizedPages=function(e){const t=[];e.forEach(e=>{const i=e.identification.id;const s=this._oUnstableVisualizations[i];if(!s){return}Object.keys(e.payload.sections).forEach(n=>{const o=e.payload.sections[n];Object.keys(o.viz).forEach(e=>{const n=o.viz[e];const a=s[n.vizId];if(a){n.vizId=a.vizId;if(!t.includes(i)){t.push(i)}}})});this._oUnstableVisualizations[i]=null});return Promise.resolve(t)};return r},false);
//# sourceMappingURL=PagesCommonDataModelAdapter.js.map