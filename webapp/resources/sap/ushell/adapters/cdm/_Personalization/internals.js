// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_Personalization/constants","sap/ushell/services/_Personalization/constants.private","sap/ui/thirdparty/jquery","sap/base/Log"],(e,t,jQuery,n)=>{"use strict";function r(e){const t=!e||!e.storageResourceRoot;if(t){throw new Error("Configuration error: storage resource root is not defined.")}return e.storageResourceRoot}function i(e){const t=!e||!e.relativeUrlReadOptimized;if(t){throw new Error("Configuration error: relative URL for read optimization is not defined.")}return e.relativeUrlReadOptimized}function a(e){const t=!e||!e.relativeUrlWriteOptimized;if(t){throw new Error("Configuration error: relative URL for write optimization is not defined.")}return e.relativeUrlWriteOptimized}function o(t){return t&&t.keyCategory===e.keyCategory.FIXED_KEY&&t.writeFrequency===e.writeFrequency.LOW&&t.clientStorageAllowed}function s(e){return o(e)?"p":"u"}function l(e,t){return o(t)?i(e):a(e)}function u(e){const r=t.S_CONTAINER_PREFIX;let i;let a;if(typeof e!=="string"||e.length===0){throw new Error("Personalization container key must be a non-empty string")}if(e.substring(0,r.length)===r){i=e.substring(r.length)}else{n.error(`Unexpected personalization container key: ${e}`,`should always be prefixed with ${r}`,"sap.ushell.adapters.cdm.PersonalizationAdapter");i=e}if(i.length<=40){a=i}else{a=i.substring(0,40);n.error(`Invalid personalization container key: '${i}'`+` exceeds maximum key length (40 characters) and is shortened to '${a}'`,undefined,"sap.ushell.adapters.cdm.PersonalizationAdapter")}return a}function d(e,t,n){return`${l(e,t)}/${encodeURIComponent(u(n))}.json`}function c(){return{validity:Infinity,keyCategory:e.keyCategory.GENERATED_KEY,writeFrequency:e.writeFrequency.HIGH,clientStorageAllowed:false}}function f(e,t){if(!t&&t!==""||t.constructor!==String){n.warning("Personalization container has an invalid app name; must be a non-empty string",null,"sap.ushell.adapters.cdm.PersonalizationAdapter")}if(!e){e=c()}const r={items:{},__metadata:{appName:t,expiry:Date.now()+e.validity*60*1e3,validity:e.validity,category:s(e)}};return r}function p(e,t,r){return new jQuery.Deferred(i=>{e.put(r,{data:t}).then(e=>{i.resolve()}).catch(e=>{n.error("Failed to save personalization container; response:",e,"sap.ushell.adapters.cdm.PersonalizationAdapter");i.reject(e)})}).promise()}function m(e){Object.keys(e).forEach(t=>{delete e[t]})}function g(e,t){const n=e&&e.filter(e=>e.name.toLowerCase()===t);return n&&n[0]&&n[0].value}function y(e,t,n){function r(e){m(e.items)}return new jQuery.Deferred(i=>{e.get(n).then(e=>{let n;let a;if(e.status===200&&g(e.responseHeaders,"content-length")==="0"&&g(e.responseHeaders,"content-type").indexOf("text/plain")===0){r(t)}else{n=JSON.parse(e.responseText);if(n.data){n.items=n.data;delete n.data;n.__metadata=t.__metadata}a=n.items;m(t.items);Object.keys(a).forEach(e=>{t.items[e]=a[e]});t.__metadata=n.__metadata}i.resolve()}).catch(e=>{if(e.details?.status===404){r(t);i.resolve()}else{m(t.items);i.reject(e)}})}).promise()}function I(e,t){return new jQuery.Deferred(n=>{e.delete(t).then(()=>{n.resolve()}).catch(e=>{n.reject(e)})}).promise()}function h(e,t,n,r,i){const a=d(e,i,r);const o=t&&t[a];if(o){delete t[a]}return I(n,a)}function _(e){if(e==="__metadata"){return undefined}else if(e.indexOf(t.S_VARIANT_PREFIX)===0||e.indexOf(t.S_ADMIN_PREFIX)===0){return e}return t.S_ITEM_PREFIX+e}function w(e){if(e.indexOf(t.S_ITEM_PREFIX)===0){return e.substring(t.S_ITEM_PREFIX.length)}else if(e.indexOf(t.S_VARIANT_PREFIX)===0||e.indexOf(t.S_ADMIN_PREFIX)===0){return e}throw new Error(`Illegal item key for personalization container: '${e}'; must be prefixed with one of the following: [${t.S_ITEM_PREFIX}, ${t.S_VARIANT_PREFIX}, ${t.S_ADMIN_PREFIX}] `)}function E(e){return Object.keys(e).map(_).filter(e=>!!e)}function R(e,t){return e.hasOwnProperty(w(t))}function P(e,t,n){e[w(t)]=n}function v(e,t){return e[w(t)]}function A(e,t){delete e[w(t)]}function C(e,t,n,r,i,a){const o=d(e,i,r);if(t&&t[o]){return t[o]}const s=f(i,a);const l=s.items;return{save:p.bind(null,n,s,o),load:y.bind(null,n,s,o),del:I.bind(null,n,s,o),setItemValue:P.bind(null,l),getItemValue:v.bind(null,l),getItemKeys:E.bind(null,l),containsItem:R.bind(null,l),delItem:A.bind(null,l)}}function b(e,t,n,i,a){const o={cache:{},headers:{"sap-client":n.getClient()}};a=a&&a.config;if(!a){throw new Error("PersonalizationAdapter: missing configuration.")}if(!t){t={}}const s=r(a);const l=new e(s,o);return{getAdapterContainer:C.bind(null,a,t,l),delAdapterContainer:h.bind(null,a,t,l)}}return{PersonalizationAdapter:b,getStorageResourceRoot:r,getContainerPath:d,delAdapterContainer:h,createContainerData:f,getAdapterContainer:C,getContainerCategory:s,isCategoryPContainer:o,trimContainerKey:u,save:p,load:y,del:I,clearContainerData:m,getItemKeys:E,containsItem:R,setItemValue:P,getItemValue:v,delItem:A,addPrefixToItemKey:_,stripPrefixFromItemKey:w,getHttpHeaderValue:g}});
//# sourceMappingURL=internals.js.map