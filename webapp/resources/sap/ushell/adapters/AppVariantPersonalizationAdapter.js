// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/Lib","sap/ushell/services/PersonalizationV2/constants","sap/ui/fl/apply/api/UI2PersonalizationApplyAPI","sap/base/Log","sap/ui/thirdparty/jquery"],(e,t,n,i,jQuery)=>{"use strict";function o(e){const t="sap.ushell.personalization#";if(e.substring(0,t.length)!==t){i.error(`Unexpected ContainerKey ${e}`);return e}let n=e.substring(t.length);n=n.split("#")[0];return n}function r(e,t,n,i){this._oService=t;this._oScope=n;this._sAppVarId=n.appVarId;this._sAppVersion=n.appVersion;this._oComponent=n.component;this._sContainerKey=o(e);this._sAppName=i||"";this._category=this._determineCategory(n);this._aJSONContainer=[];this._oChangedKeys={};this._oDeletedKeys={}}r.prototype._determineCategory=function(e){if(!e){return"U"}if(e.keyCategory&&e.keyCategory===t.keyCategory.FIXED_KEY&&e.writeFrequency&&e.writeFrequency===t.writeFrequency.LOW&&e.clientStorageAllowed&&e.clientStorageAllowed===true){return"P"}return"U"};r.prototype.getMap=function(){return{category:this._category,service:this._oService,changedKeys:this._oChangedKeys,component:this._oComponent,deletedKeys:this._oDeletedKeys,container:this._aJSONContainer,scope:this._oScope,appName:this._sAppName,appVarId:this._sAppVarId,appVersion:this._sAppVersion,containerKey:this._sContainerKey}};r.prototype._reset=function(){this._aJSONContainer=[]};r.prototype.load=function(){const t=new jQuery.Deferred;e.load("sap/ui/fl").then(()=>n.load({selector:this._oComponent,containerKey:this._sContainerKey})).then(e=>{this._aJSONContainer=e||[];t.resolve(e)}).catch(e=>{i.warning("Failed to load personalization container",e);this._reset();t.reject(e)});return t.promise()};r.prototype.save=function(){const e=[];const t=new jQuery.Deferred;sap.ui.require(["sap/ui/fl/write/api/UI2PersonalizationWriteAPI"],n=>{Object.keys(this._oChangedKeys).forEach(function(t){const i=this._oChangedKeys[t];const o=Object.assign({selector:this._oComponent},i);e.push(n.create(o))},this);Object.keys(this._oDeletedKeys).forEach(function(t){e.push(n.deletePersonalization({selector:this._oComponent,containerKey:this._sContainerKey,itemName:t}))},this);Promise.all(e).then(e=>{this._oChangedKeys={};this._oDeletedKeys={};t.resolve()}).catch(e=>{t.reject(e)})});return t.promise()};r.prototype.del=function(){const e=new jQuery.Deferred;sap.ui.require(["sap/ui/fl/write/api/UI2PersonalizationWriteAPI"],t=>{this.load().then(()=>{const n=[];this._aJSONContainer.forEach(function(e){n.push(t.deletePersonalization({selector:this._oComponent,containerKey:this._sContainerKey,itemName:e.itemName}))},this);Promise.all(n).then(t=>{e.resolve()}).catch(t=>{e.reject(t)})})});return e.promise()};r.prototype.getItemKeys=function(){const e=[];this._aJSONContainer.forEach(t=>{if(t.category==="V"){e.push(`VARIANTSET#${t.itemName}`)}else if(t.category==="I"){e.push(`ITEM#${t.itemName}`)}});return e};r.prototype.containsItem=function(e){return this.getItemKeys().indexOf(e)>=0};r.prototype._findItemIndex=function(e,t){let n;for(n=0;n<this._aJSONContainer.length;n=n+1){if(this._aJSONContainer[n].itemName===e&&this._aJSONContainer[n].category===t){return n}}};r.prototype._locateItem=function(e){const t={index:-1};if(e.indexOf("ITEM#")===0){t.trueItemKey=e.substring("ITEM#".length,"ITEM#".length+40);t.category="I"}else if(e.indexOf("VARIANTSET#")===0){t.trueItemKey=e.substring("VARIANTSET#".length,"VARIANTSET#".length+40);t.category="V"}else if(e.indexOf("ADMIN#")!==0){i.error(`Unknown itemkey prefix${e}`)}t.index=this._findItemIndex(t.trueItemKey,t.category);return t};r.prototype.getItemValue=function(e){let t="";let n;const i=this._locateItem(e);if(i.index>=0){t=this._aJSONContainer[i.index].content;n=t}return n};r.prototype.setItemValue=function(e,t){const n=this._locateItem(e);let i;if(n.index>=0){i=this._aJSONContainer[n.index];i.content=t}else{i={reference:this._sAppVarId,content:t,itemName:n.trueItemKey,category:n.category,containerKey:this._sContainerKey,containerCategory:this._category};this._aJSONContainer.push(i)}this._oChangedKeys[n.trueItemKey]=i;delete this._oDeletedKeys[n.trueItemKey]};r.prototype.delItem=function(e){const t=this._locateItem(e);if(t.index>=0){this._aJSONContainer.splice(t.index,1);this._oDeletedKeys[t.trueItemKey]=true}};function s(){}s.prototype.getAdapterContainer=function(e,t,n){return new r(e,this,t,n)};s.prototype.delAdapterContainer=function(e,t){return this.getAdapterContainer(e,t).del()};return s});
//# sourceMappingURL=AppVariantPersonalizationAdapter.js.map