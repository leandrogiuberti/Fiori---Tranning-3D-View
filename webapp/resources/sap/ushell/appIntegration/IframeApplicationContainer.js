// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/uid","sap/ui/Device","sap/ui/thirdparty/URI","sap/ushell/appIntegration/ApplicationContainer","sap/ushell/appIntegration/IframeApplicationContainerRenderer","sap/ushell/appIntegration/PostMessageManager","sap/ushell/ApplicationType/UrlPostProcessing","sap/ushell/ApplicationType/systemAlias","sap/ushell/Config","sap/ushell/Container","sap/ushell/library","sap/ushell/System","sap/ushell/utils","sap/ushell/utils/UriParameters"],(t,e,i,s,r,a,n,o,l,p,u,h,g,f,c)=>{"use strict";const d=3500;const m=r.extend("sap.ushell.appIntegration.IframeApplicationContainer",{metadata:{library:"sap.ushell",properties:{visible:{type:"boolean",defaultValue:true},globalDirtyStorageKey:{defaultValue:"",type:"string"},iframeUrl:{defaultValue:"",type:"string",visibility:"hidden"},iframePostAllParams:{defaultValue:false,type:"boolean"},iframeWithPost:{defaultValue:false,type:"boolean"},iframeIsValidSupport:{defaultValue:false,type:"boolean"},lastIframeIsValidTime:{defaultValue:0,type:"int"}},interfaces:["sap.ushell.renderer.INavContainerPage"]},renderer:a});m.prototype.init=function(){r.prototype.init.apply(this,arguments);this._aPendingRequestsWaitingForResponse=[];this.setProperty("lastIframeIsValidTime",Date.now(),true);const t=`sap.ushell.Container.dirtyState.${e()}`;this.setProperty("globalDirtyStorageKey",t,true);localStorage.removeItem(this.getGlobalDirtyStorageKey());this._fnStorageEventListener=this._handleStorageEvent.bind(this);addEventListener("storage",this._fnStorageEventListener);this._fnPagehideEventListener=this.exit.bind(this);addEventListener("pagehide",this._fnPagehideEventListener)};m.prototype.onBeforeRendering=function(){if(!this.getReadyForRendering()){return}this._attachLogoutEvent();this._initNWBCStorage();this._addRemoteSystemForUrl();this._calculateIframeUrl();this._calculateIframeWithPost();if(!this.getProperty("iframeWithPost")){const t=this.getProperty("iframeUrl");const e=l.addSystemAlias(t,this);this.setProperty("iframeUrl",e,true)}};m.prototype.onAfterRendering=async function(){if(!this.getReadyForRendering()){return}const t=await u.getServiceAsync("MessageBroker");const e=this.getPostMessageTargetOrigin();t.addAcceptedOrigin(e);if(i.os.ios&&this.$().prop("tagName")==="IFRAME"){this.$().parent().css("overflow","auto")}};m.prototype.setVisibility=function(t){this.setProperty("visible",t,true);const e=this.getDomRef();if(e){e.setAttribute("aria-hidden",!t)}if(t){this.removeStyleClass("sapUShellApplicationContainerIframeHidden");this.removeStyleClass("sapUShellApplicationContainerIframeHiddenButActive");return}if(this._aPendingRequestsWaitingForResponse.length>0){this.addStyleClass("sapUShellApplicationContainerIframeHiddenButActive")}else{this.addStyleClass("sapUShellApplicationContainerIframeHidden")}};m.prototype.setDataHelpId=function(t){r.prototype.setDataHelpId.apply(this,arguments);if(!this.getDomRef()||!this.getIframeWithPost()){return this}const e=this._getIframe();if(e){e.setAttribute("data-help-id",`${t}-iframe`)}return this};m.prototype._attachLogoutEvent=function(){const t=this.getApplicationType();if(f.isApplicationTypeEmbeddedInIframe(t)){this._fnLogout=this._handleLogout.bind(this);u.attachLogoutEvent(this._fnLogout)}};m.prototype._initNWBCStorage=function(){const t=this.getApplicationType();if(f.isApplicationTypeEmbeddedInIframe(t,true)||f.isApplicationTypeEmbeddedInIframe(this.getFrameworkId())){f.localStorageSetItem(this.getGlobalDirtyStorageKey(),u.DirtyState.INITIAL)}};m.prototype._getDocumentUrl=function(){return document.URL};m.prototype._calculateIframeWithPost=function(){const t=c.fromURL(this._getDocumentUrl());const e=this.getApplicationType();const i=p.last("/core/shell/enableOpenIframeWithPost")??true;const s=t.get("sap-post")==="false";const r=t.get("sap-post")==="true";const a=this.getOpenWithPostByAppParam()===false;const n=["NWBC","TR","WDA","WCF"].includes(e);let o;if(r){o=true}else if(s){o=false}else if(a){o=false}else{o=i&&n}if(o&&e==="TR"){this.setProperty("iframePostAllParams",true,true)}this.setProperty("iframeWithPost",o,true)};m.prototype._calculateIframeUrl=function(){const t=this.getApplicationType();let e=this.getUrl();e=o.processUrl(e,t,false,this);e=this._injectParametersFromDocumentUrl(e);this.setProperty("iframeUrl",e,true)};m.prototype._injectParametersFromDocumentUrl=function(t){const e=c.fromURL(this._getDocumentUrl());if(!e.has("sap-iframe-params")){return t}const i=e.get("sap-iframe-params")||"";const r=i.split(",");const a=new s(t);r.forEach(t=>{if(t&&e.has(t)){a.addQuery(t,e.get(t))}});t=a.toString();return t};m.prototype._addRemoteSystemForUrl=function(){if(this._oSystem){return}const t=this.getUrl();const e=document.createElement("a");const i=c.fromURL(t).get("sap-client");e.href=t;const s=`${e.protocol}//${e.host}`;this._oSystem=new g({alias:i?`${s}?sap-client=${i}`:s,baseUrl:s,client:i||undefined,platform:"abap"});u.addRemoteSystem(this._oSystem)};m.prototype._handleStorageEvent=function(e){if(e.key!==this.getGlobalDirtyStorageKey()){return}if(e.newValue!==u.DirtyState.PENDING){return}const i=this.getPostMessageTarget();if(!i){return}t.debug("getGlobalDirty() send pro54_getGlobalDirty ",null,"sap.ushell.appIntegration.ApplicationContainer");const s=this.getPostMessageTargetOrigin();const r=JSON.stringify({action:"pro54_getGlobalDirty"});i.postMessage(r,s)};m.prototype._handleLogout=function(t){const e=this.getPostMessageTarget();const i=this.getApplicationType();if(e&&f.isApplicationTypeEmbeddedInIframe(i)){const i=this.getPostMessageTargetOrigin();e.postMessage(JSON.stringify({action:"pro54_disableDirtyHandler"}),i);t.preventDefault()}};m.prototype._getIframe=function(){const t=this.getDomRef();if(!t||t.tagName!=="IFRAME"){if(this.getIframeWithPost()===true&&t&&t.getAttribute&&t.getAttribute("data-sap-ushell-iframe-app")==="true"){return document.getElementById(`${t.getAttribute("id")}-iframe`)}return null}return t};m.prototype.getPostMessageTarget=function(){const t=this._getIframe();return t?.contentWindow};m.prototype.getPostMessageTargetOrigin=function(){let t;const e=this._getIframe();if(!e){return""}if(this.getIframeWithPost()===true){const i=`${e.getAttribute("id").replace("-iframe","-form")}`;const s=document.getElementById(i);t=s?.action}else{t=e.src}const i=new s(t);const r=`${i.protocol()}://${i.host()}`;return r};m.prototype.isTrustedPostMessageSource=function(t){if(!t){return false}if(t.source&&t.source===this.getPostMessageTarget()){return true}if(t.origin&&t.origin===this.getPostMessageTargetOrigin()){return true}return false};m.prototype.sendRequest=async function(t,e,i=false){if(!i){return n.sendRequestToApplication(t,e,this,false)}if(!this.getProperty("visible")){this.addStyleClass("sapUShellApplicationContainerIframeHiddenButActive");this.removeStyleClass("sapUShellApplicationContainerIframeHidden")}const s=n.sendRequestToApplication(t,e,this,true);this._aPendingRequestsWaitingForResponse.push(s);const r=await s;this._aPendingRequestsWaitingForResponse=this._aPendingRequestsWaitingForResponse.filter(t=>t!==s);if(this._aPendingRequestsWaitingForResponse.length===0&&!this.getProperty("visible")){this.addStyleClass("sapUShellApplicationContainerIframeHidden");this.removeStyleClass("sapUShellApplicationContainerIframeHiddenButActive")}return r};m.prototype.sendBeforeAppCloseEvent=async function(){const t=this.getBeforeAppCloseEvent();if(t?.enabled===true){return this.sendRequest("sap.ushell.services.CrossApplicationNavigation.beforeAppCloseEvent",t.params,true)}};m.prototype.isValid=function(){if(!this.getIframeIsValidSupport()){return true}const t=Date.now()-this.getLastIframeIsValidTime();const e=t>=d;const i=`iframe did not ping in the last '${t}' ms`;if(e){throw new Error(i)}return true};m.prototype.exit=function(){localStorage.removeItem(this.getGlobalDirtyStorageKey());if(this._fnStorageEventListener){removeEventListener("storage",this._fnStorageEventListener)}if(this._fnPagehideEventListener){removeEventListener("pagehide",this._fnPagehideEventListener)}if(this._fnLogout){u.detachLogoutEvent(this._fnLogout)}r.prototype.exit.apply(this,arguments)};return m});
//# sourceMappingURL=IframeApplicationContainer.js.map