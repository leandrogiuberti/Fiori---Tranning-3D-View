// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/Deferred","sap/base/util/ObjectPath","sap/base/Log","sap/ui/thirdparty/jquery","sap/ushell/appIntegration/PostMessagePluginInterface","sap/ushell/utils"],(e,s,t,jQuery,n,i)=>{"use strict";const r="sap.ushell.appRuntime.ui5.AppCommunicationMgr";const a={};const o=[];let u=0;function d(){this.init=async function(e){this._fnHandleMessageEvent=this._handleMessageEvent.bind(this);addEventListener("message",this._fnHandleMessageEvent);if(e===true){this._sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsValid");setInterval(()=>{this._sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsValid")},2500)}n.init(this._sendMessageToOuterShell.bind(this),this.setRequestHandler.bind(this),()=>{},false)};this.destroy=function(){removeEventListener("message",this._fnHandleMessageEvent)};this.setRequestHandler=function(e,s){if(a[e]){t.error(`Request handler for service ${e} is already defined. Overwriting the existing handler.`)}a[e]={handler:s}};this._handleMessageResponse=function(e){if(e.request_id&&o[e.request_id]){const s=o[e.request_id];delete o[e.request_id];if(e.status==="success"){s.resolve(e.body.result)}else{let t;if(e?.body?.message){t=new Error(e.body.message)}else{t=new Error("Unknown error")}if(e?.body?.stack){t.stack=e.body.stack}s.reject(t)}}};this._handleMessageRequest=async function(e,n){const o=s.create("sap-ushell-config.services.PostMessage.config");let u=n&&n.service;let d;let l;let g;t.debug(`App Runtime received post message request from origin '${e.origin}': ${JSON.stringify(n)}`,null,r);if(!u){return}if(o&&o.enabled===false){t.warning(`App Runtime received message for ${l}, but this `+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,r);return}if(!this._isTrustedPostMessageSource(e)){t.warning(`App Runtime received message from untrusted origin '${e.origin}': ${JSON.stringify(e.data)}`,null,r);return}if(u==="sap.ushell.services.MessageBroker"){u=u.concat("._execute")}if(u.indexOf(".")>0){d=u.split(".");g=d[d.length-1];l=u.substr(0,u.length-g.length-1)}else{t.warning(`App Runtime received message with invalid service name (${u}) :${JSON.stringify(e.data)}`,null,r);return}try{const s=a[`${l}.${g}`];if(!s||!s.handler){t.warning(`App Runtime received message with unknown service name (${n.service}) :${JSON.stringify(e.data)}`,null,r);return}try{await i.promisify(s.handler(n.body||{},e)).then(s=>{const t=s&&s.hasOwnProperty("_noresponse_")?true:false;if(!t){this.sendResponseMessage(e,n,"success",{result:s})}})}catch(s){let t;let i=s.toString();if(s instanceof Error){i=s.message;t=s.stack}this.sendResponseMessage(e,n,"error",{message:i,stack:t})}}catch(s){t.warning(`Error in processing message: ${s.message}) :${JSON.stringify(e.data)}`,null,r)}};this._getCFLPWindow=function(){return window.parent};this._isTrustedPostMessageSource=function(e){let s=false;const t=this._getCFLPWindow();if(t){s=e.source===t}return s};this.sendResponseMessage=function(e,s,n,i){const a=JSON.stringify({type:"response",service:s.service,request_id:s.request_id,status:n,body:i});t.debug(`Sending post message response to origin ' ${e.origin}': ${a}`,null,r);if(typeof e.source!=="object"||e.source===null){t.debug(`Cannot send response message to origin ' ${e.origin}`,"`source` member of request message is not an object",r);return}e.source.postMessage(a,e.origin)};this._getTargetWindow=function(){return window.parent};this.postMessage=function(e){let s;const n=this._getTargetWindow();if(e){try{if(e.type==="request"&&!e.request_id){e.request_id=this.getId()}s=JSON.stringify(e);n.postMessage(s,"*")}catch(s){t.error(`Message '${e}' cannot be posted:`,s,"sap.ui5Isolation.AppCommunicationMgr")}}};this._sendMessageToOuterShell=function(s,t,n,i,r){const a=new e;const u={type:"request",service:s,body:t||{},request_id:n};this.postMessage(u);o[u.request_id]=a;if(i){setTimeout(()=>{a.resolve(r)},i)}return a.promise};this.sendMessageToOuterShell=function(e,s,t,n,i){const r=new jQuery.Deferred;this._sendMessageToOuterShell(e,s,t,n,i).then(r.resolve.bind(r)).catch(r.reject.bind(r));return r.promise()};this.postMessageToFLP=function(e,s,t,n,i){return this._sendMessageToOuterShell(e,s,t,n,i)};this.getId=function(){return`SAPUI5_APPRUNTIME_MSGID_${++u}`}}d.prototype._handleMessageEvent=function(e){if(!e&&!e?.data){return}let s=e.data;if(typeof s==="string"){try{s=JSON.parse(e.data,this)}catch(s){t.debug(`Message received from origin '${e.origin}' cannot be parsed:`,s,r);return}}if(s.type==="request"){return this._handleMessageRequest(e,s)}else if(s.type==="response"){return this._handleMessageResponse(s)}};return new d});
//# sourceMappingURL=AppCommunicationMgr.js.map