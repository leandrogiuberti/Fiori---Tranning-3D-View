// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/extend","sap/base/util/UriParameters","sap/base/assert","sap/ui/core/EventBus","sap/ui/thirdparty/URI","sap/ui/Device","sap/ui/core/BusyIndicator","sap/ushell/EventHub","sap/ui/thirdparty/hasher","sap/ushell/utils","sap/ushell/utils/UrlParsing","sap/ushell/resources","sap/ushell/appRuntime/ui5/services/Container","sap/ushell/appRuntime/ui5/AppRuntimeContext","sap/ushell/appRuntime/ui5/AppCommunicationMgr","sap/ushell/appRuntime/ui5/performance/FesrEnhancer"],(e,t,s,n,a,r,p,i,o,u,l,c,d,h,f,A,g)=>{"use strict";function m(){const m=this;let y;let I;let C=true;const v={};let b;const S={};const w={};const R={};const P={};let L;let F;let H;let N;this.init=function(e,t,s,n,a,r){this.resetCurrentApp();y=e;b=t;F=s;if(n!==undefined){C=n}this.addAppInfoToCache(a,r);const p={"sap.ushell.services.appLifeCycle.create":{async handler(e,t){return m.create(e)}},"sap.ushell.services.appLifeCycle.destroy":{async handler(e,t){return m.destroy(e)}},"sap.ushell.services.appLifeCycle.store":{async handler(e,t){return m.store(e)}},"sap.ushell.services.appLifeCycle.restore":{async handler(e,t){return m.restore(e)}}};Object.keys(p).forEach(e=>{A.setRequestHandler(e,p[e].handler)});o.on("disableKeepAliveRestoreRouterRetrigger").do(e=>{if(e.componentId&&w[e.componentId]){w[e.componentId]=e.disable}});this._sendAppRuntimeSetup();N=d.i18n.getText("dataLossExternalMessage");window.onbeforeunload=function(){if(h.getDirtyFlag()){return N}return undefined}};this._sendAppRuntimeSetup=()=>{const e={isStateful:true,isKeepAlive:true,isIframeValid:true,session:{bLogoutSupport:true}};const t={session:{bLogoutSupport:true}};A.postMessageToFLP("sap.ushell.services.appLifeCycle.setup",window["sap-ushell-config"]?.ui5appruntime?.config?.stateful===false?t:e)};this.create=async function(e){let t;let o;let l;let d="";g.startInteraction();const h=e.sUrl;if(f.getIsScube()){o=s.fromURL(h).get("sap-remote-intent");n(typeof o==="string","AppLifeCycleAgent::create - sAppIntent must be string");if(e.sHash.indexOf("Shell-startIntent")===0){l=c.parseShellHash(e.sHash);d=`${l.params["sap-shell-so"]}-${l.params["sap-shell-action"]}`}}else{t=s.fromURL(h).get("sap-ui-app-id");n(typeof t==="string","AppLifeCycleAgent::create - sAppId must be string")}u.disableCFLPUpdate=true;u.replaceHash("");u.replaceHash(e.sHash);u.disableCFLPUpdate=false;if(p.browser.chrome){i.show(0)}if(H){H._resetBackNavigationCallback()}a.getInstance().publish("launchpad","appOpening",{});const A=await m.getAppInfo(t,h,o);const y=A.oResolvedHashFragment?.ui5ComponentName||A.oResolvedHashFragment?.name;const I=Object.keys(S).find(e=>{if(f.getIsScube()&&d.length>0){return S[e].sAppIntent===d&&S[e].ui5ComponentName===y}return S[e].ui5ComponentName&&S[e].ui5ComponentName===y});if(I){m.destroy({sCacheId:I},true)}const C=await m.expandSapIntentParams(new r(h).query(true));const v=await b(t,C,A.oResolvedHashFragment,o,A.oParsedHash);F(v);a.getInstance().publish("sap.ushell","appOpened",{});return{deletedKeepAliveId:I}};this.destroy=async function(t){function s(t){const s=t.sId||"<unknown>";try{t.destroy()}catch(t){e.error(`exception when trying to close sapui5 application with id '${s}' when running inside the appruntime iframe '${document.URL}'. This error must be fixed in order for the iframe to operate properly.\n`,t,"sap.ushell.appRuntime.ui5.services.AppLifeCycleAgent::destroy")}}const n=t.sCacheId;if(L.oApp===undefined&&n===undefined){A.postMessageToFLP("sap.ushell.appRuntime.isInvalidIframe",{bValue:true});return}if(n&&S[n]){if(S[n].oApp===L.oApp){this.resetCurrentApp()}delete w[S[n].oApp.sId];s(S[n].oApp);delete S[n]}else if(L.oApp){delete w[L.oApp.sId];s(L.oApp);this.resetCurrentApp()}h.cleanDirtyStateProviderArray();if(H){H._resetBackNavigationCallback()}g.setAppShortId();a.getInstance().publish("sap.ushell","appClosed",{})};this.store=async function(e){const t=e.sCacheId;const s=this.cloneCurrentAppEntry(L);if(L.oApp===undefined){A.postMessageToFLP("sap.ushell.appRuntime.isInvalidIframe",{bValue:true});return}S[t]=s;if(H){P[t]=H._getBackNavigationCallback()}const n=s.oApp.getComponentInstance();s.oApp.setVisible(false);R[t]=h.getAsyncDirtyStateProviders();h.cleanDirtyStateProviderArray();if(n){if(n.isKeepAliveSupported&&n.isKeepAliveSupported()===true){n.deactivate()}else{if(n.suspend){n.suspend()}if(n.getRouter&&n.getRouter()){n.getRouter().stop()}}}a.getInstance().publish("sap.ushell","appClosed",{})};this.restore=async function(e){const t=e.sCacheId;const s=S[t];const n=s.oApp.getComponentInstance();const r=w[s.oApp.sId];u.disableCFLPUpdate=true;u.replaceHash("");u.replaceHash(e.sHash);u.disableCFLPUpdate=false;a.getInstance().publish("launchpad","appOpening",{});s.oApp.setVisible(true);if(R[t]){h.setAsyncDirtyStateProviders(R[t])}if(H){H.setBackNavigation(P[t])}if(n){if(n.isKeepAliveSupported&&n.isKeepAliveSupported()===true){n.activate()}else{if(n.restore){n.restore()}if(n.getRouter&&n.getRouter()&&n.getRouter().initialize){if(r===false){n.getRouter().initialize()}else{n.getRouter().initialize(true)}}}L=this.cloneCurrentAppEntry(s)}a.getInstance().publish("sap.ushell","appOpened",{});setTimeout(()=>{A.postMessageToFLP("sap.ushell.services.AppLifeCycle.setNewAppInfo",{info:s.oAppAttributes})},500)};this.expandSapIntentParams=async function(e){if(e.hasOwnProperty("sap-intent-param")){const s=e["sap-intent-param"];try{const n=await A.postMessageToFLP("sap.ushell.services.CrossApplicationNavigation.getAppStateData",{sAppStateKey:s});delete e["sap-intent-param"];const a=t({},e,new r(`?${n}`).query(true),true);return a}catch{}}return e};this.addAppParamsToIntent=async function(e,t){const s=await m.expandSapIntentParams(new r(e).query(true));return m.getApplicationParameters(s)};this.getApplicationParameters=async function(e){let t;let s;let n;function a(e,t){let s="";if(e&&e.length>0){s=(e.startsWith("?")?"":"?")+e}if(t&&t.length>0){s+=(s.length>0?"&":"?")+t}return s}if(e.hasOwnProperty("sap-startup-params")){t=new r(`?${e["sap-startup-params"]}`).query(true);if(t.hasOwnProperty("sap-intent-param")){s=t["sap-intent-param"];delete t["sap-intent-param"]}n=new r("?").query(t).toString();if(s){try{const e=await A.postMessageToFLP("sap.ushell.services.CrossApplicationNavigation.getAppStateData",{sAppStateKey:s});return a(n,e)}catch{}}return a(n)}return""};this.getAppInfo=async function(e,t,s){async function n(){const s=await I.getAppInfo(e,t);m.addAppInfoToCache(e,s);return{oResolvedHashFragment:s}}if(s){let e=await m.addAppParamsToIntent(t,s);if(e.length>0){e=new r(e).removeSearch("sap-remote-system").removeSearch("sap-ushell-defaultedParameterNames").toString()}const n=await h.getServiceAsync("NavTargetResolutionInternal");const a=n.resolveHashFragmentLocal(`#${s}${e}`);const p=await l.promisify(a);const i=c.parseShellHash(`#${s}${e}`);return{oResolvedHashFragment:p,oParsedHash:i}}else if(C===true&&v[e]){return{oResolvedHashFragment:JSON.parse(JSON.stringify(v[e]))}}else if(I){return n()}const[a]=await l.requireAsync([y.replace(/\./g,"/")]);I=a;return n()};this.addAppInfoToCache=function(e,t){if(e&&t&&C===true&&v[e]===undefined){v[e]=JSON.parse(JSON.stringify(t))}};this.setCurrentApp=function(e,t,s){this.resetCurrentApp();L.oApp=e;L.sAppIntent=t;L.ui5ComponentName=s;if(L.oApp){w[L.oApp.sId]=true}};this.setCurrentAppAttributes=function(e){L.oAppAttributes=e};this.resetCurrentApp=function(){L={oApp:undefined,sAppIntent:undefined,ui5ComponentName:undefined,oAppAttributes:{}}};this.cloneCurrentAppEntry=function(e){return{oApp:e.oApp,sAppIntent:e.sAppIntent,ui5ComponentName:e.ui5ComponentName,oAppAttributes:e.oAppAttributes}};this.setShellUIService=function(e){H=e};this.checkDataLossAndContinue=function(){if(h.getDirtyFlag()){if(window.confirm(N)){h.setDirtyFlag(false);return true}return false}return true}}return new m},true);
//# sourceMappingURL=AppLifeCycleAgent.js.map