/* !
 * Copyright (c) 2009-2025 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ui/thirdparty/hasher","sap/ui/core/BusyIndicator","sap/ui/core/EventBus","sap/ui/core/Lib","sap/ushell/appRuntime/ui5/plugins/baseRta/BaseRTAPluginStatus","sap/ushell/appRuntime/ui5/plugins/baseRta/AppLifeCycleUtils"],(t,i,s,e,o,n)=>{"use strict";const r=o.STATUS_STARTING;const a=o.STATUS_STARTED;const h=o.STATUS_STOPPING;const p=o.STATUS_STOPPED;function u(t){this.mConfig=t;this.sStatus=o.STATUS_STOPPED;this.oStartingPromise=null;this.oStoppingPromise=null;const i=n.getContainer();i.registerDirtyStateProvider(this._dirtyStateProvider.bind(this));this.oInitPromise=i.getServiceAsync("URLParsing").then(t=>{this.oURLParsingService=t}).catch(t=>{throw new Error(`Error during retrieval of URLParsing ushell service: ${t}`)})}function l(){return new Promise((t,i)=>{sap.ui.require(["sap/ui/rta/api/startAdaptation"],t,i)})}function c(){return n.getCurrentRunningApplication().then(t=>t.componentInstance)}u.prototype.getInitPromise=function(){return this.oInitPromise};u.prototype._onRtaFailed=function(t){i.hide();this._oRTA=t.getSource();this.mConfig.onErrorHandler()};u.prototype._startRta=function(){this.sStatus=r;s.getInstance().subscribe("sap.ushell.renderers.fiori2.Renderer","appClosed",this._onAppClosed,this);s.getInstance().subscribe("sap.ushell","appKeepAliveDeactivate",this._onAppClosed,this);i.show(0);let o;return c().then(t=>{o=t;return e.load({name:"sap.ui.rta"})}).then(l.bind(this)).then(i=>{this.sOldHash=t.getHash();const s={rootControl:o,flexSettings:{layer:this.mConfig.layer,developerMode:this.mConfig.developerMode}};return i(s,this.mConfig.loadPlugins,this.mConfig.onStartHandler,this._onRtaFailed.bind(this),this.mConfig.onStopHandler)}).then(t=>{i.hide();this._oRTA=t;this.sStatus=a}).catch(t=>{i.hide();if(t.reason==="flexEnabled"){this.handleFlexDisabledOnStart()}this.sStatus=p})};u.prototype._stopRta=function(){this.sStatus=h;return this._oRTA.stop.apply(this._oRTA,arguments).then(()=>{this.exitRta()})};u.prototype.triggerStartRta=function(){const t=this.sStatus;switch(t){case r:break;case a:this.oStartingPromise=Promise.resolve();break;case h:this.oStartingPromise=this.oStoppingPromise.then(()=>this._startRta());break;case p:this.oStartingPromise=this._startRta();break;default:}if(t!==r){this.oStartingPromise.then(()=>{this.oStartingPromise=null})}return this.oStartingPromise};u.prototype.triggerStopRta=function(){const t=this.sStatus;switch(t){case r:this.oStoppingPromise=this.oStartingPromise.then(function(){return this._stopRta.apply(this,arguments)}.bind(this));break;case a:this.oStoppingPromise=this._stopRta.apply(this,arguments);break;case h:break;case p:this.oStoppingPromise=Promise.resolve();break;default:}if(t!==h){this.oStoppingPromise.then(()=>{this.oStoppingPromise=null})}return this.oStoppingPromise};u.prototype.handleFlexDisabledOnStart=function(){sap.ui.require(["sap/ui/rta/util/showMessageBox","sap/m/MessageBox"],(t,i)=>{t(this.mConfig.i18n.getText("MSG_FLEX_DISABLED"),{icon:i.Icon.INFORMATION,title:this.mConfig.i18n.getText("HEADER_FLEX_DISABLED"),actions:[i.Action.OK],initialFocus:null,isCustomAction:false})})};u.prototype._dirtyStateProvider=function(){if(this._oRTA&&this.sStatus===a){const i=t.getHash();const s=this.oURLParsingService.parseShellHash(i);const e=this.oURLParsingService.parseShellHash(this.sOldHash);this.sOldHash=i;if(s.semanticObject===e.semanticObject&&s.action===e.action&&s.appSpecificRoute!==e.appSpecificRoute){return false}return this._oRTA.canSave()}return false};u.prototype.exitRta=function(){if(this._oRTA){this._oRTA.destroy();this.sStatus=p;this.oStartingPromise=null;this.oStoppingPromise=null;this._oRTA=null}s.getInstance().unsubscribe("sap.ushell.renderers.fiori2.Renderer","appClosed",this._onAppClosed,this);s.getInstance().unsubscribe("sap.ushell","appKeepAliveDeactivate",this._onAppClosed,this)};u.prototype._onAppClosed=function(){this.triggerStopRta(true,true)};return u},true);
//# sourceMappingURL=Trigger.js.map