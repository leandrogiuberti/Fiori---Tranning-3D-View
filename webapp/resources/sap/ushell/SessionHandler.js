// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/EventBus","sap/ushell/resources","sap/ushell/Config","sap/ushell/utils","sap/m/Dialog","sap/m/Button","sap/m/Text","sap/ui/model/json/JSONModel","sap/m/VBox","sap/ui/core/library","sap/m/library","sap/ushell/ui/launchpad/LoadingDialog","sap/ui/thirdparty/jquery","sap/ui/util/Storage","sap/base/Log","sap/ushell/appIntegration/PostMessageManager","sap/ushell/EventHub","sap/ushell/Container"],(e,i,t,s,n,o,a,r,u,l,d,c,jQuery,h,m,g,f,p)=>{"use strict";const S=d.ButtonType;const T=l.ValueState;let v=false;function I(){const l=this;let d=false;let I=false;this.init=function(e){m.debug(`SessionHandler.oConfig.sessionTimeoutIntervalInMinutes: ${e.sessionTimeoutIntervalInMinutes}`,"","SessionHandler");m.debug(`SessionHandler.oConfig.sessionTimeoutReminderInMinutes: ${e.sessionTimeoutReminderInMinutes}`,"","SessionHandler");m.debug(`SessionHandler.oConfig.enableAutomaticSignout: ${e.enableAutomaticSignout}`,"","SessionHandler");if(e.enableAutomaticSignout===undefined){e.enableAutomaticSignout=false}if(e.sessionTimeoutReminderInMinutes===undefined){e.sessionTimeoutReminderInMinutes=0}if(e.sessionTimeoutIntervalInMinutes<-1){e.sessionTimeoutIntervalInMinutes=-1;m.warning("sessionTimeoutIntervalInMinutes was invalid and has been set to -1","SessionHandler")}if(e.sessionTimeoutReminderInMinutes<0){e.sessionTimeoutReminderInMinutes=0;m.warning("sessionTimeoutReminderInMinutes was negative and has been set to 0","SessionHandler")}if(e.sessionTimeoutIntervalInMinutes<=0){e.sessionTimeoutReminderInMinutes=0}else if(e.sessionTimeoutIntervalInMinutes<=e.sessionTimeoutReminderInMinutes){e.sessionTimeoutReminderInMinutes=e.sessionTimeoutIntervalInMinutes-1<0?0:e.sessionTimeoutIntervalInMinutes-1;m.error("sessionTimeoutReminderInMinutes needs to be smaller than sessionTimeoutIntervalInMinutes."+`sessionTimeoutReminderInMinutes adapted to: ${e.sessionTimeoutReminderInMinutes}`,"SessionHandler")}this.oConfig=e;this.oModel=new r;this.putTimestampInStorage(this._getCurrentDate());this.initLogout();this._fnOnVisibilityChange=this.onVisibilityChange.bind(this);p.getServiceAsync("AppLifeCycle").then(i=>{this.oAppLifeCycleService=i;this.attachUserEvents();if(e.sessionTimeoutIntervalInMinutes>0){this.attachVisibilityEvents();this.initSessionTimeout()}if(e.sessionTimeoutTileStopRefreshIntervalInMinutes>0){this.initTileRequestTimeout()}f.on("nwbcUserIsActive").do(this.userActivityHandler.bind(this));d=true})};this.isInitialized=function(){return d};this.initLogout=function(){if(I===false){p.registerLogout(this.logout);I=true}};this.initSessionTimeout=function(){this.oModel.setProperty("/SessionRemainingTimeInSeconds",this.oConfig.sessionTimeoutReminderInMinutes*60);this.counter=0;this.oKeepAliveDialog=undefined;this.notifyServer();this.monitorUserIsInactive()};this.monitorUserIsInactive=function(e){m.debug("SessionHandler.monitorInactiveUser : Check started","*****","SessionHandler");e=typeof e!=="undefined"?e:true;const i=this.timeLastInteraction();const t=this.timePopup();const s=this.timeNow();const n=this.timeOver();const o=t-s;const a=s-i;m.debug(`SessionHandler.monitorUserIsInactive :: time since last interaction : ${a}`,"","SessionHandler");m.debug(`SessionHandler.monitorUserIsInactive :: remaining time until dialog : ${o}`,"","SessionHandler");if(s<t&&e){const e=setTimeout(this.monitorUserIsInactive.bind(this),o*1e3);this.oMonitorUserIsInactiveTimer=this.oMonitorUserIsInactiveTimer||e;return}if(s>=t&&s<n&&this.oConfig.sessionTimeoutReminderInMinutes>0){this.detachUserEvents();this.detachVisibilityEvents();this.oContinueWorkingDialog=this.createContinueWorkingDialog();this.oContinueWorkingDialog.open();m.debug("SessionHandler.monitorUserIsInactive :: Dialog opened","","SessionHandler");this.monitorCountdown(true);this._createSystemNotification()}if(s>=n){m.debug("SessionHandler.monitorUserIsInactive :: Session over detected","","SessionHandler");this.handleSessionOver();return}m.debug("SessionHandler.monitorInactiveUser :: Check done","*****","SessionHandler")};this.handleSessionOver=function(){clearTimeout(this.notifyServerTimer);e.getInstance().publish("launchpad","sessionTimeout");if(this.oConfig.enableAutomaticSignout===true){m.debug("SessionHandler.handleSessionOver :: Automatic signout gets initiated","","SessionHandler");p.defaultLogout()}else{m.debug("SessionHandler.handleSessionOver :: Session expired dialog gets opened","","SessionHandler");this.createSessionExpiredDialog().open()}};this.notifyServer=async function(){const e=this._getCurrentDate()-new Date(this.getTimestampFromStorage());const i=e/(1e3*60);const t=this.oConfig.sessionTimeoutIntervalInMinutes*30*1e3;if(i<=this.oConfig.sessionTimeoutIntervalInMinutes){p.sessionKeepAlive();g.sendRequestToAllApplications("sap.ushell.sessionHandler.extendSessionEvent",{},false)}else{}this.notifyServerTimer=setTimeout(this.notifyServer.bind(this),s.sanitizeTimeoutDelay(t))};this.monitorCountdown=function(e){if(e){m.debug("SessionHandler.monitorCountdown :: Initiated from outside","*****","SessionHandler")}else{m.debug("SessionHandler.monitorCountdown :: Initiated from internal call","**","SessionHandler")}const i=this.timeLastInteraction();const t=this.timePopup();const s=this.timeNow();const n=this.timeOver();const o=s-i;m.debug(`SessionHandler.monitorCountdown :: timeNow : ${s}`,"","SessionHandler");m.debug(`SessionHandler.monitorCountdown :: iTimeLastInteraction : ${i}`,"","SessionHandler");m.debug(`SessionHandler.monitorCountdown :: timeSinceLastInteraction : ${o}`,"","SessionHandler");m.debug(`SessionHandler.monitorCountdown :: iTimeOver : ${n}`,"","SessionHandler");if(s<t){m.debug("SessionHandler.monitorCountdown :: Auto-click","<=","SessionHandler");this.continueWorkingButtonPressHandler(true);return}const a=n-s;if(a>0){m.debug(`SessionHandler.monitorCountdown :: Remaining seconds : ${a} - iTimeOver : ${n}`,"","SessionHandler");this.oModel.setProperty("/SessionRemainingTimeInSeconds",a);this.remainingTimer=setTimeout(this.monitorCountdown.bind(this,false),500);return}if(a<=0){if(this.oSessionKeepAliveDialog){this.oSessionKeepAliveDialog.close()}this.handleSessionOver()}};this.initTileRequestTimeout=function(){this.checkStopBackendRequestRemainingTime();this.bBackendRequestsActive=true};this.checkStopBackendRequestRemainingTime=function(){const e=this._getCurrentDate()-new Date(this.getTimestampFromStorage());const i=e/(1e3*60);const t=this.oConfig.sessionTimeoutTileStopRefreshIntervalInMinutes;const n=(t-i)*60*1e3;if(i<t){setTimeout(this.checkStopBackendRequestRemainingTime.bind(this),s.sanitizeTimeoutDelay(n))}else if(t>0){this._setConnectionActive(false)}};this._setConnectionActive=function(i){if(i){setTimeout(this.checkStopBackendRequestRemainingTime.bind(this),0)}if(this.bBackendRequestsActive===i){return}e.getInstance().publish("launchpad","setConnectionToServer",{active:i});if(!t.last("/core/spaces/enabled")){if(i){this._setTilesVisibleOnHomepage()}else{this._setTilesInvisibleOnHomepage()}}this.bBackendRequestsActive=i};this._setTilesVisibleOnHomepage=function(){sap.ui.require(["sap/ushell/utils"],e=>{e.handleTilesVisibility()})};this._setTilesInvisibleOnHomepage=function(){return new Promise((i,t)=>p.getServiceAsync("FlpLaunchPage").then(t=>{t.getGroups().then(s=>{const n=e.getInstance();s.forEach(e=>{t.getGroupTiles(e).forEach(e=>{t.setTileVisible(e,false)})});n.publish("launchpad","visibleTilesChanged",[]);i()})}))};this.getLocalStorage=function(){if(this.oLocalStorage===undefined){const e=new h(this.oConfig&&this.oConfig.sessionType||h.Type.local);if(this._isLocalStorageSupported(e)){this.oLocalStorage=e}else{this.oLocalStorage=false}}return this.oLocalStorage};this._isLocalStorageSupported=function(e){let i;try{i=e.isSupported()}catch(e){i=false}if(!i){m.warning("SessionHandler._isLocalStorageSupported :: Failed to instantiate local storage handler: "+"Might be disabled by the browser!","","SessionHandler")}return i};this._createSystemNotification=function(){const e=function(){const e=this.oModel.getProperty("/SessionRemainingTimeInSeconds");const t=new Notification(i.i18n.getText("sessionTimeoutMessage_title"),{body:this.continueWorkingFormatter(e)});t.onclick=function(e){window.focus()}}.bind(this);if(!("Notification"in window)){return}else if(Notification.permission==="granted"){e()}else if(Notification.permission!=="denied"){Notification.requestPermission().then(i=>{if(i==="granted"){e()}})}};this.continueWorkingFormatter=function(e){const t=e>60;let s;const n=t?i.i18n.getText("sessionTimeoutMessage_units_minutes"):i.i18n.getText("sessionTimeoutMessage_units_seconds");const o=t?Math.ceil(e/60):e;if(l.oConfig.enableAutomaticSignout){s=i.i18n.getText("sessionTimeoutMessage_kioskMode_main",[o,n])}else{s=i.i18n.getText("sessionTimeoutMessage_main",[o,n])}return s};this.createContinueWorkingDialog=function(){m.debug("SessionHandler.createContinueWorkingDialog :: Continue working dialog being created","","SessionHandler");this.oMessageVBox=new u;this.oSessionKeepAliveLabel=new a({text:{parts:["/SessionRemainingTimeInSeconds"],formatter:this.continueWorkingFormatter}});this.oMessageVBox.addItem(this.oSessionKeepAliveLabel);if(this.oConfig.enableAutomaticSignout===false){this.oLostDataReminder=new a({text:i.i18n.getText("sessionTimeoutMessage_unsavedData")});this.oMessageVBox.addItem(this.oLostDataReminder)}this.oSessionKeepAliveLabel.setModel(this.oModel);this.oSessionKeepAliveDialog=new n("sapUshellKeepAliveDialog",{title:i.i18n.getText("sessionTimeoutMessage_title"),type:"Message",state:T.Warning,content:this.oMessageVBox,beginButton:this.createContinueWorkingButton(),afterClose:function(){this.oSessionKeepAliveDialog.destroy()}.bind(this)}).addStyleClass("sapContrastPlus");if(this.oConfig.enableAutomaticSignout===true){this.oSignOutButton=new o({text:i.i18n.getText("logoutBtn_title"),tooltip:i.i18n.getText("logoutBtn_tooltip"),press:p.defaultLogout.bind(p)});this.oSessionKeepAliveDialog.setEndButton(this.oSignOutButton)}return this.oSessionKeepAliveDialog};this.createContinueWorkingButton=function(){return new o({text:i.i18n.getText("sessionTimeoutMessage_continue_button_title"),type:S.Emphasized,press:l.continueWorkingButtonPressHandler.bind(l,false)})};this.continueWorkingButtonPressHandler=async function(e){m.debug(`SessionHandler.continueWorkingButtonPressHandler :: Session was extended ${e?"automatically":"by user"}`,"","SessionHandler");if(this.oSessionKeepAliveDialog){this.oSessionKeepAliveDialog.close()}clearTimeout(this.remainingTimer);if(!e){this.putTimestampInStorage(this._getCurrentDate())}this.monitorUserIsInactive();this.attachUserEvents();this.attachVisibilityEvents();g.sendRequestToAllApplications("sap.ushell.sessionHandler.extendSessionEvent",{},false)};this.createSessionExpiredDialog=function(){this.oSessionExpiredDialog=new n("sapUshellSessionTimedOutDialog",{title:i.i18n.getText("sessionExpiredMessage_title"),type:"Message",state:T.Warning,content:new a({text:i.i18n.getText("sessionExpiredMessage_main")}),beginButton:this.createReloadButton(),afterClose:function(){this.oSessionExpiredDialog.destroy()}.bind(this)}).addStyleClass("sapContrastPlus");return this.oSessionExpiredDialog};this.createReloadButton=function(){return new o({text:i.i18n.getText("sessionExpiredMessage_reloadPage_button_title"),press:function(){l.oSessionExpiredDialog.close();location.reload()}})};this.attachUserEvents=function(){jQuery(document).on("mousedown.sessionTimeout mousemove.sessionTimeout",this.userActivityHandler.bind(this));jQuery(document).on("keyup.sessionTimeout",this.userActivityHandler.bind(this));jQuery(document).on("touchstart.sessionTimeout",this.userActivityHandler.bind(this));this.oAppLifeCycleService.attachAppLoaded({},this.userActivityHandler,this)};this.detachUserEvents=function(){jQuery(document).off("mousedown.sessionTimeout mousemove.sessionTimeout");jQuery(document).off("keydown.sessionTimeout");jQuery(document).off("touchstart.sessionTimeout");this.oAppLifeCycleService.detachAppLoaded(this.userActivityHandler,this)};this.onVisibilityChange=function(e){if(e.target&&e.target.visibilityState==="visible"){this.monitorUserIsInactive(false)}};this.attachVisibilityEvents=function(){document.addEventListener("visibilitychange",this._fnOnVisibilityChange)};this.detachVisibilityEvents=function(){document.removeEventListener("visibilitychange",this._fnOnVisibilityChange)};this.putTimestampInStorage=function(e){m.debug(`SessionHandler.putTimestampInStorage :: Timestamp is ${e}`,"","SessionHandler");const i=this.getLocalStorage();if(i){i.put("lastActivityTime",e);if(this.bBackendRequestsActive===false){this._setConnectionActive(true)}}};this.getTimestampFromStorage=function(){const e=this.getLocalStorage();if(e){return e.get("lastActivityTime")}return null};this.timeNow=function(){return Math.floor(Date.now()/1e3)};this.timeLastInteraction=function(){return Math.floor(new Date(this.getTimestampFromStorage()).getTime()/1e3)};this.timeOver=function(){return Math.floor(this.timeLastInteraction()+this.oConfig.sessionTimeoutIntervalInMinutes*60)};this.timePopup=function(){return Math.floor(this.timeLastInteraction()+this.oConfig.sessionTimeoutIntervalInMinutes*60-this.oConfig.sessionTimeoutReminderInMinutes*60)};this.userActivityHandler=function(){if(this.oUserActivityTimer!==undefined){return}this.oUserActivityTimer=setTimeout(()=>{m.debug("SessionHandler.userActivityHandler :: Timed time stamp update","","SessionHandler");l.putTimestampInStorage(l._getCurrentDate());l.oUserActivityTimer=undefined},1e3)};this._getCurrentDate=function(){return new Date};this.logout=function(){return new Promise(async e=>{m.debug("SessionHandler.logout :: Logout initiated","","SessionHandler");function t(t){if(d===true){l.detachUserEvents();l.detachVisibilityEvents()}if(l.oUserActivityTimer){clearTimeout(l.oUserActivityTimer)}if(l.remainingTimer){clearTimeout(l.remainingTimer)}if(l.notifyServerTimer){clearTimeout(l.notifyServerTimer)}t.openLoadingScreen();t.showAppInfo(i.i18n.getText("beforeLogoutMsg"),null);p.setDirtyFlag(false);e()}const s=new c({text:""});const n=window.setTimeout(async()=>{v=true;t(s)},4e3);g.sendRequestToAllApplications("sap.ushell.sessionHandler.logout",{},true).then(async()=>{if(v===false){v=true;window.clearTimeout(n);t(s)}})})}}return I},false);
//# sourceMappingURL=SessionHandler.js.map