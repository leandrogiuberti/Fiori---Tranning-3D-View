// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/utils/UrlParsing","sap/ushell/utils/UrlShortening","sap/ushell/utils/HttpClient","sap/ushell/navigationMode","sap/ui/thirdparty/jquery","sap/ui/performance/Measurement","sap/base/util/deepExtend","sap/base/util/isPlainObject","sap/base/Log","sap/ushell/Container"],(e,t,n,s,i,jQuery,r,a,o,l,c)=>{"use strict";function u(u,p,h,d){const f=d?.config;const g=function(e){const t=this._isClientSideTargetResolutionEnabled()?this._resolveHashFragmentClientSide(e):u.resolveHashFragment(e);return t}.bind(this);let m;const v=[{name:"DefaultAdapter",isApplicable:function(){return true},resolveHashFragment:g.bind(this)}];let S;const b=new s;this._isClientSideTargetResolutionEnabled=function(){return!!(f&&f.enableClientSideTargetResolution)};this._nextResolveHashFragment=function(e,t){const n=e.pop();if(n.isApplicable(t)){l.info(`NavTargetResolutionInternal: custom resolver ${n.name} resolves ${t}`);const s=this._nextResolveHashFragment.bind(this,e);return n.resolveHashFragment(t,s)}return this._nextResolveHashFragment(e,t)};this._resolveHashFragmentClientSide=function(e){const t=this._validateHashFragment(e);if(!t.success){return(new jQuery.Deferred).reject(new Error(`${e} is not a valid hash fragment`)).promise()}const n=t.hashFragmentWithoutHash;return this._resolveHashFragmentClientSideAndFixApplicationType(n)};this._resolveHashFragmentClientSideAndFixApplicationType=function(e){const t=new jQuery.Deferred;c.getServiceAsync("ClientSideTargetResolution").then(t=>t.resolveHashFragment(e)).then(e=>{if(e&&e.applicationType==="SAPUI5"){e.applicationType="URL"}t.resolve(e)}).catch(t.reject);return t.promise()};this._validateHashFragment=function(t){let n="";const s={success:false};if(t&&t.charAt(0)!=="#"){throw new e.Error("Hash fragment expected in _validateHashFragment","sap.ushell.services.NavTargetResolutionInternal")}n=t.substring(1);if(n){s.success=true}s.hashFragmentWithoutHash=n;return s};this.expandCompactHash=function(e){const s=new jQuery.Deferred;const i=t.parseShellHash(e);if(i&&i.params&&i.params["sap-intent-param"]){c.getServiceAsync("AppState").then(t=>{t.getAppState(i.params["sap-intent-param"][0]).done(t=>{const i=t.getData("sap-intent-param");let r=e;if(i){r=n.expandParamGivenRetrievalFunction(e,"sap-intent-param",()=>i)}s.resolve(r)}).fail(()=>{s.resolve(e)})}).catch(s.reject)}else{s.resolve(e)}return s.promise()};const R=["NWBC","WDA","TR"];this._adjustResolutionResultForUi5Components=function(e){if(typeof e!=="object"){return}delete e["sap.platform.runtime"];if(e&&e.applicationType&&e.applicationType==="SAPUI5"){e.applicationType="URL"}if(e.applicationType==="URL"){const t=/^SAPUI5\.Component=(.*)/.exec(e.additionalInformation);const n=t&&t[1];if(n){e.ui5ComponentName=n}}};this._getSapSystem=function(e,t){let n;if(t&&t["sap-system"]){return t["sap-system"]}if(t&&t.url){n=new URL(t.url,window.location.href).searchParams.get("sap-system");if(n){return n}}if(R.indexOf(t.applicationType)>=0&&e&&e.substring(1)){n=new URL(e.substring(1),window.location.href).searchParams.get("sap-system");if(n){return n}}return undefined};this.resolveTarget=function(n){const s=a({},n);const i=new jQuery.Deferred;r.average("sap.ushell.navigation.resolveTarget");e.storeSapSystemToLocalStorage(s);const o=t.constructShellHash(s);c.getServiceAsync("NavTargetResolutionInternal").then(e=>{e.resolveHashFragment(`#${o}`).done(e=>{r.end("sap.ushell.navigation.resolveTarget");i.resolve({url:e.url,text:e.text,externalNavigationMode:e.targetNavigationMode==="explace"})}).fail(i.reject)}).catch(i.reject);return i.promise()};this.resolveHashFragment=function(e){const t=new jQuery.Deferred;r.average("sap.ushell.navigation.resolveHashFragment");this.expandCompactHash(e).done(n=>{let s=jQuery.when();if(n.indexOf("sap-ushell-enc-test")>=0){const e=/sap-ushell-enc-test=([^&]*)(&.*)?$/.exec(n);if(e){const t=e[1];if(t!=="A%20B%2520C"){s=new jQuery.Deferred;c.getServiceAsync("MessageInternal").then(e=>{e.error("This navigation is flagged as erroneous because"+" (likely the calling procedure) generated a wrong encoded hash."+" Please track down the encoding error and make sure to use the CrossApplicationNavigation service for navigation.","Navigation encoding wrong");s.resolve()}).catch(s.reject)}n=n.replace(/sap-ushell-enc-test=([^&]*)&/,"");n=n.replace(/[&?]sap-ushell-enc-test=([^&]*)$/,"")}}let a=this._invokeResolveHashChain(n);if(typeof u.processPostResolution==="function"){a=u.processPostResolution(n,a)}jQuery.when(a,s).done(n=>{this._adjustResolutionResultForUi5Components(n);if(n&&n.navigationMode!==undefined){n.targetNavigationMode=i.getExternalNavigationMode(n.navigationMode)}else{l.error("Resolution Result doesn't contain mandatory navigationMode!","sap.ushell.services.NavTargetResolutionInternal")}if(o(n)&&!n.hasOwnProperty("sap-system")){const t=this._getSapSystem(e,n);if(t){n["sap-system"]=t}}r.end("sap.ushell.navigation.resolveHashFragment");t.resolve(n)}).fail(t.reject)}).fail(t.reject);return t.promise().done(t=>this._recordNavigation("resolveHashFragment",{sHashFragment:e},t))};this._invokeResolveHashChain=function(e){const t=v.map(e=>e);return this._nextResolveHashFragment(t,e).done(e=>{S=e})};this.baseResolveHashFragment=g.bind(this);this._getGetLinksResolver=function(e){let t;if(this._isClientSideTargetResolutionEnabled()){t=this._getLinksClientSide.bind(this);return{resolver:t,warning:undefined,isGetSemanticObjectLinksCall:false}}if(Object.prototype.toString.apply(e.paramsOptions)==="[object Array]"&&e.paramsOptions.length>0){l.warning("Parameter options supplied to #getLinks will be ignored because FLP is not configured to use sap.ushell.services.ClientSideTargetResolution for target resolution",`provided parameters options: ${JSON.stringify(e.paramsOptions,null,4)}`,"sap.ushell.services.NavTargetResolutionInternal")}t=u&&u.getLinks&&u.getLinks.bind(u);if(t){return{resolver:t,warning:undefined,isGetSemanticObjectLinksCall:false}}t=u&&u.getSemanticObjectLinks&&u.getSemanticObjectLinks.bind(u);if(t){return{resolver:t,warning:e.hasOwnProperty("action")?"the action argument was given, however, NavTargetResolutionAdapter does not implement getLinks method. Action will be ignored.":undefined,isGetSemanticObjectLinksCall:true}}return{resolver:undefined,warning:"Cannot determine resolver for getLinks method",isGetSemanticObjectLinksCall:undefined}};this.getLinks=function(e){const t=e.semanticObject;const n=e.params;const s=e.ignoreFormFactor;const i=e.ui5Component;const r=e.appStateKey;const a=e.compactIntents;const o=new jQuery.Deferred;if(/\?/.test(t)){throw new Error("Parameter must not be part of semantic object")}let u=n===undefined?undefined:JSON.parse(JSON.stringify(n));if(r){u=u||{};u["sap-xapp-state"]=encodeURIComponent(r)}const p=this._getGetLinksResolver(e);if(p.warning){l.warning("A problem occurred while determining the resolver for getLinks",p.warning,"sap.ushell.services.NavTargetResolutionInternal")}const h=p.resolver;if(h){const n=function(e){if(a){this._shortenGetSemanticObjectLinksResults(e,i).done(o.resolve)}else{o.resolve(e)}}.bind(this);if(p.isGetSemanticObjectLinksCall){const e={target:{semanticObject:t,action:"dummyAction"},params:u};c.getServiceAsync("ShellNavigationInternal").then(r=>{r.hrefForExternal(e,true,i).then(e=>{const i=e.params||u;h(t,i,s).then(n).catch(o.reject)}).catch(o.reject)})}else{h(e).done(n).fail(o.reject)}}else{o.resolve([])}return o.promise().done(t=>this._recordNavigation("getLinks",{oArgs:e},t))};this.getDistinctSemanticObjects=function(){const e=new jQuery.Deferred;if(this._isClientSideTargetResolutionEnabled()){c.getServiceAsync("ClientSideTargetResolution").then(e=>e.getDistinctSemanticObjects()).then(e.resolve).catch(e.reject);return e.promise().done(e=>this._recordNavigation("getDistinctSemanticObjects",{},e))}if(u&&u.getDistinctSemanticObjects){return u.getDistinctSemanticObjects()}l.error("Cannot execute getDistinctSemanticObjects method","ClientSideTargetResolution must be enabled or NavTargetResolutionAdapter must implement getDistinctSemanticObjects method","sap.ushell.services.NavTargetResolutionInternal");return e.reject(new Error("Cannot execute getDistinctSemanticObjects")).promise()};this._getLinksClientSide=function(e){const n=new jQuery.Deferred;const s=new jQuery.Deferred;if((e.params||{}).hasOwnProperty("sap-intent-param")){const i=`#${e.semanticObject}-dummyAction?${t.paramsToString(e.params)}`;this.expandCompactHash(i).done(e=>{const n=t.parseShellHash(e);s.resolve(n.params)}).fail(n.reject)}else{s.resolve(e.params)}s.done(()=>{c.getServiceAsync("ClientSideTargetResolution").then(t=>t.getLinks(e)).then(n.resolve).catch(n.reject)});return n.promise()};this._shortenGetSemanticObjectLinksResults=function(e,n){const s=[];let i=0;let r=e.length;const a=new jQuery.Deferred;c.getServiceAsync("ShellNavigationInternal").then(o=>{e.forEach(e=>{const c=t.parseShellHash(e.intent);const u=o.compactParams(c.params,undefined,n);s.push(u);s[i].done(((n,i)=>{s[n]={text:e.text,intent:`#${c.semanticObject}-${c.action}?${t.paramsToString(i)}`}}).bind(null,i)).fail(((t,n)=>{l.warning("Cannot shorten GetSemanticObjectLinks result, using expanded form",`Failure message: ${n}; intent had title ''${e.title}'' and link ''${e.intent}'`,"sap.ushell.services.NavTargetResolutionInternal");s[t]={text:e.text,intent:e.intent}}).bind(null,i)).always(()=>{r--;if(r===0){a.resolve(s)}});i++})}).catch(a.reject);return a.promise()};this.isIntentSupported=function(e){const t={};const n=new jQuery.Deferred;if(this._isClientSideTargetResolutionEnabled()){c.getServiceAsync("ClientSideTargetResolution").then(t=>t.isIntentSupported(e)).then(n.resolve).catch(n.reject);return n.promise()}if(u.isIntentSupported){return u.isIntentSupported(e)}e.forEach(e=>{t[e]={supported:undefined}});return n.resolve(t).promise()};this._isIntentSupported=function(e){const t={};const n=new jQuery.Deferred;if(this._isClientSideTargetResolutionEnabled()){c.getServiceAsync("ClientSideTargetResolution").then(t=>t.isIntentSupported(e)).then(n.resolve).catch(n.reject);return n.promise()}if(u.isIntentSupported){return u.isIntentSupported(e)}e.forEach(e=>{t[e]={supported:undefined}});return n.resolve(t).promise()};this.isNavigationSupported=function(e){const n=new jQuery.Deferred;let s=[];s=e.map(e=>{if(typeof e==="string"){return e}return`#${t.constructShellHash(e)}`});this._isIntentSupported(s).done(e=>{const t=s.map(t=>e[t]||{supported:false});n.resolve(t)}).fail(n.reject.bind(n));return n.promise().done(t=>this._recordNavigation("isNavigationSupported",{aIntents:e},t))};this._recordNavigation=function(e,t,n){const s=f?.usageRecorder||{};if(s.enabled){const i=s.serviceUrl||"/navigation/api/v2/record";b.post(i,{headers:{"content-type":"application/json; charset=utf-8"},data:{function:e,parameters:JSON.stringify(t),result:JSON.stringify(n)}})}return n};this.registerCustomResolver=function(e){if(typeof e.name!=="string"){l.error("NavTargetResolutionInternal: Custom Resolver must have name {string} member");return false}if(typeof e.isApplicable!=="function"){l.error("NavTargetResolutionInternal: Custom Resolver must have isApplicable member");return false}if(typeof e.resolveHashFragment!=="function"){l.error('NavTargetResolutionInternal: Custom Resolver must have "resolveHashFragment" member');return false}v.push(e);return true};if(f&&Array.isArray(f.resolveLocal)){m=f.resolveLocal.map(e=>e.linkId);this.registerCustomResolver({name:"localResolveNavigationResolver",cleanHash:function(e){if(e===""){return"#"}const n=t.parseShellHash(e.substring(1));if(!n){return"#"}e=`#${n.semanticObject}-${n.action}`;return e},_getIndex:function(e){const t=this.cleanHash(e);return m.indexOf(t.substring(1))},isApplicable:function(e){return this._getIndex(e)>=0},resolveHashFragment:function(e){const n=this._getIndex(e);const s=new jQuery.Deferred;const i=JSON.parse(JSON.stringify(f.resolveLocal[n].resolveTo));const r=t.parseShellHash(e);if(r&&r.params){const e=t.paramsToString(r.params);if(e){const t=i.url.indexOf("?")>=0;i.url=i.url+(t?"&":"?")+e}}s.resolve(i);return s.promise()}})}this.registerCustomResolver({name:"LocalResolver",aElement:undefined,cleanHash:function(e){if(e===""){return undefined}const n=t.parseShellHash(e.substring(1));if(!n){return undefined}e=`#${n.semanticObject}-${n.action}`;return e},isApplicable:function(e){e=this.cleanHash(e);if(!e){return false}return e==="#Test-url"||e==="#Test-local1"||e==="#Test-local2"||e==="#Test-config"||e==="#Test-clear"},parseUrl:function(e){if(!this.aElement){this.aElement=window.document.createElement("a")}this.aElement.href=e;return this.aElement},resolveHashFragment:function(t){const n=new jQuery.Deferred;const s=this;t=this.cleanHash(t);if(!t){return false}const i={"#Test-config":{applicationType:"URL",url:"/sap/bc/ui5_ui5/ui2/ushell/test-resources/sap/ushell/demoapps/FioriSandboxConfigApp",additionalInformation:"SAPUI5.Component=sap.ushell.demoapps.FioriSandboxConfigApp",navigationMode:"embedded"},none:{applicationType:"URL",url:"",additionalInformation:""}};function r(e){if(localStorage){return localStorage[e]}return undefined}function a(t){if(e.calculateOrigin(s.parseUrl(t))!==e.calculateOrigin(window.location)){return undefined}return t}function o(e){return new URLSearchParams(window.location.search).get(e)}function c(e,t){if(localStorage){localStorage[e]=t}}let u;if(i[t]){u=i[t]}else if(t==="#Test-clear"){c("sap.ushell.#Test-local1",undefined);c("sap.ushell.#Test-local2",undefined);l.info("NavTargetResolutionInternal: Local storage keys for #Test have been cleared");u=i["#Test-config"]}else if(t==="#Test-local1"||t==="#Test-local2"||t==="#Test-url"){u=r(`sap.ushell.${t}`);let e;if(!u||u==="undefined"){e={applicationType:"URL",navigationMode:"embedded"}}else{e=JSON.parse(u)}if(window.location.hostname==="localhost"||f&&f.allowTestUrlComponentConfig){const n=`sap-ushell-test-${t.substring(6)}`;const s=o(`${n}-additionalInformation`);if(s){e.additionalInformation=s}const i=o(`${n}-url`);if(i){e.url=a(i)}}if(!e.url){l.info(`NavTargetResolutionInternal: No configured app for ${t} found ( local storage or url params sap-ushell-test-local1-url  sap-ushell-test-local1-additionalInfo  not supplied? `);l.info("NavTargetResolutionInternal: Defaulting to config app ...\n");n.reject(new Error("URL is not resolvable"));return n.promise()}e.url=a(e.url);u=e}if(u.url===undefined){n.reject(new Error("URL is not resolvable"));return n.promise()}l.info(`NavTargetResolutionInternal: As URL:  http://localhost:8080/sap/bc/ui5_ui5/ui2/ushell/shells/abap/FioriLaunchpad.html?sap-ushell-test-local1-url=${encodeURIComponent(u&&u.url||"")}&sap-ushell-test-local1-additionalInformation=${encodeURIComponent(u&&u.additionalInfo||"")}#Test-local1`);l.info(`NavTargetResolutionInternal: Resolving ${t} to ${JSON.stringify(u)}`);n.resolve(u);return n.promise()}});this.getCurrentResolution=function(){return S}}u.hasNoAdapter=false;return u});
//# sourceMappingURL=NavTargetResolutionInternal.js.map