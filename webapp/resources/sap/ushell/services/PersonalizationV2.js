// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/Deferred","sap/ui/base/ManagedObject","sap/ui/base/Object","sap/ui/core/Component","sap/ui/thirdparty/jquery","sap/ushell/utils","sap/ushell/services/PersonalizationV2/utils","sap/ushell/services/PersonalizationV2/constants","sap/ushell/services/PersonalizationV2/ContextContainer","sap/ushell/services/PersonalizationV2/WindowAdapter","sap/ushell/services/PersonalizationV2/TransientPersonalizer","sap/ushell/services/PersonalizationV2/Personalizer","sap/ushell/services/PersonalizationV2/VariantSetAdapter","sap/ushell/services/PersonalizationV2/Variant","sap/ushell/services/PersonalizationV2/VariantSet","sap/ushell/services/PersonalizationV2/WindowAdapterContainer"],(e,t,n,a,r,jQuery,i,o,s,p,d,c,l,u,f,h,A)=>{"use strict";function _(e,t,n,a){this._oConfig=a&&a.config||{};this._oAppVariantAdapterWithBackendAdapter=this._configureAppVariantStorage(this._oConfig.appVariantStorage);this._oAdapterWithBackendAdapter={lazy:false,instance:new d(this,e)};this._oAdapterWindowOnly={lazy:false,instance:new d(this,undefined)};this._oContainerMap=new i.Map;this._oPendingOperationsMap=new i.Map}_.prototype.SAVE_DEFERRED_DROPPED="Deferred save dropped (OK) - Data superseded by subsequent save";_.prototype.constants=s;_.prototype.KeyCategory=s.keyCategory;_.prototype.WriteFrequency=s.writeFrequency;_.prototype._configureAppVariantStorage=function(e){const t=this;const n="sap.ushell.adapters.AppVariantPersonalizationAdapter";if(!e){e={adapter:{module:n}}}if(Object.keys(e).length===0||e.enabled===false){return}const a=e.adapter&&e.adapter.module||n;const r=a.split(".").join("/");function i(){if(!t._oAppVariantAdapterLoadPromise){t._oAppVariantAdapterLoadPromise=new jQuery.Deferred;sap.ui.require([r],e=>{try{const n=new e;const a=new d(t,n);t._oAppVariantAdapterLoadPromise.resolve(a)}catch(e){t._oAppVariantAdapterLoadPromise.reject(e)}},e=>{t._oAppVariantAdapterLoadPromise.reject(e)})}return t._oAppVariantAdapterLoadPromise.promise()}return{lazy:true,create:i}};_.prototype.getGeneratedKey=async function(){return i.generateRandomKey()};_.prototype.getPersonalizer=async function(e,t,n){n=n||this._getApplicationComponent();return new l(this,this._oAdapterWithBackendAdapter.instance,e,t,n)};_.prototype._getApplicationComponent=function(){const e=n._sOwnerId;if(e){const t=r.getComponentById(e);if(a.isObjectA(t,"sap.ui.core.Component")){return t}}return undefined};_.prototype.getTransientPersonalizer=async function(){return new c};_.prototype.getContainer=async function(e,t,n){n=n||this._getApplicationComponent();const a=await this._createContainer(e,t,false,n);return a};_.prototype.createEmptyContainer=async function(e,t,n){n=n||this._getApplicationComponent();const a=await this._createContainer(e,t,true,n);return a};_.prototype._createContainer=async function(e,t,n,a){if(typeof e!=="string"){throw new i.Error("sContainerKey is not a string: sap.ushell.services.Personalization"," ")}const r=!!(o.isAppVariant(a)&&(!t||!t.shared)&&this._oAppVariantAdapterWithBackendAdapter);const s=o.adjustScope(t);let d=o.addContainerPrefix(e);if(r){const e=a.getManifestObject();s.component=a;s.appVarId=e.getEntry("/sap.ui5/appVariantId");s.appVersion=e.getEntry("/sap.app/applicationVersion/version");d+=`#${e.getEntry("/sap.ui5/appVariantId")}`}const c=r?this._oAppVariantAdapterWithBackendAdapter:this._oAdapterWithBackendAdapter;const l=this._oAdapterWindowOnly;const u=o.pickAdapter(t,l,c);const f=await o.loadAdapter(u);const h=new p(this,f,d,s,a);const A=f&&f.supportsGetWithoutSubsequentLoad===true;if(!(n&&A)){await h.load()}if(n||h.isExpired()){h.clearData()}return h};_.prototype.deleteContainer=function(t,n){let a="";n=this._adjustScope(n);a=o.addContainerPrefix(t);const r=new jQuery.Deferred;const s=this._pendingContainerOperations_cancelAddNext(t,null);s.always(()=>{this.getContainer(t,n).then(()=>{this._pendingContainerOperations_cancelAddNext(t,r);const i=n.validity===0?this._oAdapterWindowOnly:this._oAdapterWithBackendAdapter;o.loadAdapter(i).then(t=>{t.delAdapterContainer(a,n).fail(t=>{e.error("Delete failed",t);r.reject(t)}).done(r.resolve)}).catch(t=>{e.error("Delete failed",t);r.reject(t)})}).catch(n=>{e.error("Delete failed",n);this._pendingContainerOperations_cancelAddNext(t,r);r.reject(n)})});return i.promisify(r.promise())};_.prototype._pendingContainerOperations_flushAddNext=function(e,t){let n=this._oPendingOperationsMap.get(e);if(!n){n=new jQuery.Deferred;n.resolve()}if(t!==null){this._oPendingOperationsMap.put(e,t)}if(!n||n.state()!=="pending"){return n}clearTimeout(n._sapTimeoutId);n._sapTimeoutId=undefined;if(typeof n._sapFnSave==="function"){const e=n._sapFnSave;n._sapFnSave=undefined;e()}return n};_.prototype._pendingContainerOperations_cancelAddNext=function(e,t){let n=this._oPendingOperationsMap.get(e);if(!n){n=new jQuery.Deferred;n.resolve()}if(t!==null){this._oPendingOperationsMap.put(e,t)}if(!n||n.state()!=="pending"){return n}if(n._sapTimeoutId){clearTimeout(n._sapTimeoutId);n._sapTimeoutId=undefined;n.resolve(_.prototype.SAVE_DEFERRED_DROPPED)}return n};_.prototype._getBackendAdapter=function(){return this._oAdapterWithBackendAdapter.instance._oBackendAdapter};_.prototype.resetEntirePersonalization=async function(){const e=this._getBackendAdapter();const t=await this.isResetEntirePersonalizationSupported();if(t){return e.resetEntirePersonalization()}throw new Error("Reset entire personalization is not supported")};_.prototype.isResetEntirePersonalizationSupported=async function(){const t=this._getBackendAdapter();if(typeof t.resetEntirePersonalization!=="function"){return false}if(typeof t.isResetEntirePersonalizationSupported==="function"){try{const e=await t.isResetEntirePersonalizationSupported();return e}catch(t){e.error("isResetEntirePersonalizationSupported failed with error:",t);throw t}}return true};_.prototype._adjustScope=o.adjustScope;_.hasNoAdapter=false;_.ContextContainer=p;_.Variant=f;_.VariantSet=h;_.VariantSetAdapter=u;_.WindowAdapter=d;_.WindowAdapterContainer=A;return _});
//# sourceMappingURL=PersonalizationV2.js.map