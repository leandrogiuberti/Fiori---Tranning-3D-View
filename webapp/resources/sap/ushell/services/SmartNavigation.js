// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ushell/utils","sap/ushell/services/AppConfiguration","sap/base/Log","sap/ushell/utils/UrlParsing","sap/ushell/Container"],(jQuery,e,t,n,r,i)=>{"use strict";function a(e,t,n){this._oServiceConfig=n;this._oCrossAppNavigationServicePromise=i.getServiceAsync("CrossApplicationNavigation");this._oPersonalizationServicePromise=i.getServiceAsync("Personalization");this._oHashCodeCache={"":0}}a.STATISTIC_COLLECTION_WINDOW_DAYS=90;a.PERS_CONTAINER_KEY_PREFIX="ushell.smartnav.";a.ONE_DAY_IN_MILLISECOND=24*60*60*1e3;a.prototype.getLinks=function(e){const r=new jQuery.Deferred;n.error("Call to deprecated service: 'SmartNavigation.getLinks'. Please use 'CrossApplicationNavigation.getLinks' instead",null,"sap.ushell.services.SmartNavigation");this._oCrossAppNavigationServicePromise.then(i=>{const a=i.getLinks(e);if(!this._isTrackingEnabled(this._oServiceConfig)){a.done(r.resolve).fail(r.reject);return}const o=t.getCurrentApplication();const s=o.sShellHash;let c=o.componentHandle;if(o.componentHandle){c=o.componentHandle.getInstance()}if(!s){n.warning("Call to SmartNavigation#getLinks() simply delegated to CrossApplicationNavigation#getLinks()"+" because AppConfiguration#getCurrentApplication()#sShellHash evaluates to undefined.");a.done(r.resolve).fail(r.reject);return}const l=this._getNavigationOccurrences(s,c);jQuery.when(a,l).done((e,t)=>{if(t.length===0){r.resolve(e);return}const n=this._prepareLinksForSorting(e,t);e=n.sort((e,t)=>t.clickCount-e.clickCount);r.resolve(e)}).fail(r.reject)}).catch(r.reject);return r.promise()};a.prototype.toExternal=function(e){const r=arguments;n.error("Call to deprecated service: 'SmartNavigation.toExternal'. Please use 'CrossApplicationNavigation.toExternal' instead",null,"sap.ushell.services.SmartNavigation");this._oCrossAppNavigationServicePromise.then(i=>{if(!this._isTrackingEnabled(this._oServiceConfig)){i.toExternal.apply(i,r);return}const a=t.getCurrentApplication();const o=a.sShellHash;let s=a.componentHandle;if(a.componentHandle){s=a.componentHandle.getInstance()}if(!o){n.warning("Current shell hash could not be identified. Navigation will not be tracked.",null,"sap.ushell.services.SmartNavigation");i.toExternal.apply(i,r);return}const c=this._getHashFromOArgs(e.target);if(!c){n.warning("Destination hash does not conform with the ushell guidelines. Navigation will not be tracked.",null,"sap.ushell.services.SmartNavigation");i.toExternal.apply(i,r);return}this._recordNavigationOccurrences(o,c,s).then(()=>{i.toExternal.apply(i,r)})})};a.prototype.hrefForExternal=function(){n.error("Deprecated API call of 'sap.ushell.services.SmartNavigation.hrefForExternal'. Please use 'hrefForExternalAsync' instead.",null,"sap.ushell.services.SmartNavigation");const e=i.getService("CrossApplicationNavigation");return e.hrefForExternal.apply(e,arguments)};a.prototype.hrefForExternalAsync=async function(){n.error("Call to deprecated service: 'SmartNavigation.hrefForExternalAsync'. Please use 'CrossApplicationNavigation.hrefForExternalAsync' instead",null,"sap.ushell.services.SmartNavigation");const e=await this._oCrossAppNavigationServicePromise;return e.hrefForExternalAsync.apply(e,arguments)};a.prototype.getPrimaryIntent=function(){const e=new jQuery.Deferred;const t=arguments;n.error("Call to deprecated service: 'SmartNavigation.getPrimaryIntent'. Please use 'CrossApplicationNavigation.getPrimaryIntent' instead",null,"sap.ushell.services.SmartNavigation");this._oCrossAppNavigationServicePromise.then(n=>{n.getPrimaryIntent.apply(n,t).done(e.resolve).fail(e.reject)}).catch(e.reject);return e.promise()};a.prototype.trackNavigation=function(e){n.error("Call to deprecated service: 'SmartNavigation.trackNavigation'.",null,"sap.ushell.services.SmartNavigation");if(!this._isTrackingEnabled(this._oServiceConfig)){n.debug("Call to SmartNavigation#trackNavigation() ignored because Service is not enabled via Configuration",null,"sap.ushell.services.SmartNavigation");return jQuery.when(null)}const r=e.target;const i=t.getCurrentApplication();const a=i.sShellHash;if(!a){n.warning("Call to SmartNavigation#trackNavigation() simply ignored"+" because AppConfiguration#getCurrentApplication()#sShellHash evaluates to undefined.");return jQuery.when(null)}const o=this._getHashFromOArgs(r);if(!o){n.warning("Navigation not tracked - no valid destination provided",null,"sap.ushell.services.SmartNavigation");return jQuery.when(null)}n.debug(`Navigation to ${o} was tracked out of ${a}`,null,"sap.ushell.services.SmartNavigation");return this._recordNavigationOccurrences(a,o,i.componentHandle.getInstance())};a.prototype._isTrackingEnabled=function(t){return e.isDefined(t)&&e.isDefined(t.config)&&e.isDefined(t.config.isTrackingEnabled)?t.config.isTrackingEnabled:false};a.prototype._getHashCode=function(e){const t=`${e}`;if(this._oHashCodeCache[t]){return this._oHashCodeCache[t]}let n=0;let r=t.length;while(r--){n=(n<<5)-n+(t.charCodeAt(r)|0);n|=0}this._oHashCodeCache[t]=n;return n};a.prototype._getBaseHashPart=function(e){const t=r.parseShellHash(e);if(t&&t.semanticObject&&t.action){return`${t.semanticObject}-${t.action}`}throw new Error(`Invalid intent \`${e}\``)};a.prototype._getHashFromOArgs=function(e){if(!e){return null}if(e.shellHash&&r.parseShellHash(e.shellHash)){return this._getBaseHashPart(e.shellHash)}if(e.semanticObject&&e.action){return`${e.semanticObject}-${e.action}`}return null};a.prototype._getPersContainerKey=function(e){return a.PERS_CONTAINER_KEY_PREFIX+this._getHashCode(e)};a.prototype._getNavigationOccurrences=function(e,t){const n=new jQuery.Deferred;const r=this._getPersContainerKey(e);this._oPersonalizationServicePromise.then(e=>{const i=e.getContainer(r,{keyCategory:e.constants.keyCategory.FIXED_KEY,writeFrequency:e.constants.writeFrequency.HIGH,clientStorageAllowed:true},t);i.done(e=>{const t=e.getItemKeys();const r=t.map(t=>{const n=e.getItemValue(t);const r=Object.keys(n.actions);return r.map(e=>{const r=n.actions[e];const i=r.dailyFrequency.reduce((e,t)=>e+t,0);return{intent:`${t}-${e}`,clickCount:i}})});const i=r.reduce((e,t)=>{Array.prototype.push.apply(e,t);return e},[]);n.resolve(i)})}).catch(n.reject);return n.promise()};a.prototype._prepareLinksForSorting=function(e,t){const n={};t.forEach(e=>{n[e.intent]=e});e.forEach(e=>{const t=this._getBaseHashPart(e.intent);const r=n[t];e.clickCount=r?r.clickCount:0});return e};a.prototype._recordNavigationOccurrences=function(e,t,n){const i=r.parseShellHash(t);const a=this._getPersContainerKey(e);const o=i.semanticObject;const s=new jQuery.Deferred;this._oPersonalizationServicePromise.then(e=>{const t=e.getContainer(a,{keyCategory:e.constants.keyCategory.FIXED_KEY,writeFrequency:e.constants.writeFrequency.HIGH,clientStorageAllowed:true},n);t.done(e=>{let t=e.getItemValue(o);const n=i.action;if(!t){t={actions:{},latestVisit:Date.now(),dailyFrequency:[0]}}let r=t.actions[n];if(!r){r={latestVisit:Date.now(),dailyFrequency:[0]};t.actions[n]=r}this._updateHistoryEntryWithCurrentUsage(t);this._updateHistoryEntryWithCurrentUsage(r);e.setItemValue(o,t);e.save().done(s.resolve).fail(s.reject)}).fail(s.reject)}).catch(s.reject);return s.promise()};a.prototype._updateHistoryEntryWithCurrentUsage=function(e){const t=Date.now();const n=t-e.latestVisit;let r=Math.floor(n/a.ONE_DAY_IN_MILLISECOND);while(r--){e.dailyFrequency.unshift(0);if(e.dailyFrequency.length>a.STATISTIC_COLLECTION_WINDOW_DAYS){e.dailyFrequency.pop()}}++e.dailyFrequency[0];e.latestVisit=t;return e};a.hasNoAdapter=true;return a});
//# sourceMappingURL=SmartNavigation.js.map