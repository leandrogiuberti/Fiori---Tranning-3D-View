// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/AppConfiguration","sap/ushell/services/_CrossApplicationNavigation/utils","sap/ushell/utils/type","sap/ushell/TechnicalParameters","sap/ushell/appIntegration/AppLifeCycle","sap/base/util/deepExtend","sap/base/util/isPlainObject","sap/ui/thirdparty/jquery","sap/base/util/ObjectPath","sap/base/util/merge","sap/ushell/utils","sap/ushell/ApplicationType","sap/ushell/UI5ComponentType","sap/base/Log","sap/ushell/utils/UrlParsing","sap/base/util/deepClone","sap/ui/base/Object","sap/ushell/api/common/ComponentInstantiation","sap/ushell/Container"],(t,e,n,a,s,i,r,jQuery,o,p,c,l,u,h,f,g,m,y,d)=>{"use strict";function A(l,u,A){let v;if(A&&A.config){v=A.config}function S(a,s){let i;let o;let p;if(typeof a!=="string"&&!r(a)&&a!==undefined){h.error("Unexpected input type",null,"sap.ushell.services.CrossApplicationNavigation");return undefined}if(a===undefined){return undefined}const c=t.getCurrentApplication();if(s){if(typeof s.getComponentData!=="function"||!r(s.getComponentData())||!s.getComponentData().startupParameters||!r(s.getComponentData().startupParameters)){h.error("Cannot call getComponentData on component","the component should be an application root component","sap.ushell.services.CrossApplicationNavigation")}else{const t=s.getComponentData().startupParameters;if(t.hasOwnProperty("sap-system")){i=t["sap-system"][0]}if(t.hasOwnProperty("sap-ushell-next-navmode")){o=t["sap-ushell-next-navmode"][0]}}}else{if(c&&c["sap-system"]){i=c["sap-system"]}else if(c&&c.url){i=new URL(c.url,window.location.href).searchParams.get("sap-system")}if(c&&c["sap-ushell-next-navmode"]){o=c["sap-ushell-next-navmode"]}else if(c&&c.url){o=new URL(c.url,window.location.href).searchParams.get("sap-ushell-next-navmode")}}if(c){p=c.contentProviderId}const l=e._injectParameters({type:n,inject:{"sap-system":i,"sap-ushell-navmode":o,"sap-app-origin-hint":p},injectEmptyString:{"sap-app-origin-hint":true},args:a});return l}function C(t){if(localStorage&&localStorage["sap-ushell-enc-test"]==="false"){return t}if(!v||!v["sap-ushell-enc-test"]){if(localStorage&&localStorage["sap-ushell-enc-test"]!=="true"){return t}}if(typeof t!=="string"&&!r(t)&&t!==undefined){h.error("Unexpected input type",null,"sap.ushell.services.CrossApplicationNavigation");return undefined}if(t===undefined){return undefined}if(r(t)){const e=i({},t);if(e.target&&e.target.shellHash){if(typeof e.target.shellHash==="string"){if(e.target.shellHash!=="#"&&e.target.shellHash!==""){e.target.shellHash=C(e.target.shellHash)}}return e}e.params=e.params||{};e.params["sap-ushell-enc-test"]=["A B%20C"];return e}let e=t;if(!/[?&]sap-system=/.test(e)){const t=e.indexOf("?")>-1?"&":"?";e+=`${t}sap-ushell-enc-test=${encodeURIComponent("A B%20C")}`}return e}this._extractInnerAppRoute=function(t){if(typeof t==="string"){const e=t.split("&/");const n=e.shift();return{intent:n,innerAppRoute:e.length>0?`&/${e.join("&/")}`:""}}if(Object.prototype.toString.apply(t)==="[object Object]"){const e=o.get("target.shellHash",t);if(typeof e==="string"){const n=this._extractInnerAppRoute(e);t.target.shellHash=n.intent;return{intent:t,innerAppRoute:n.innerAppRoute}}if(t.hasOwnProperty("appSpecificRoute")){const e=t.appSpecificRoute;delete t.appSpecificRoute;const n=typeof e==="string"&&e.indexOf("&/")!==0&&e.length>0;return{innerAppRoute:n?`&/${e}`:e,intent:t}}return{intent:t,innerAppRoute:""}}h.error("Invalid input parameter","expected string or object","sap.ushell.services.CrossApplicationNavigation");return{intent:t}};this._injectInnerAppRoute=function(t,e){if(!e){return t}if(typeof t==="string"){return t+e}if(Object.prototype.toString.apply(t)==="[object Object]"){const n=o.get("target.shellHash",t);if(typeof n==="string"){t.target.shellHash=this._injectInnerAppRoute(n,e);return t}t.appSpecificRoute=e}return t};this.hrefForExternal=function(t,i,r){if(typeof i!=="object"&&i!==undefined&&i!==null){r=i;i=undefined}if(r){const e=this.hrefForExternalAsync(t,i);return c.toDeferred(e)}h.error("Deprecated option 'bAsync=false'. Please use 'bAsync=true' instead",null,"sap.ushell.services.CrossApplicationNavigation");let o=p({},t);const l=this._extractInnerAppRoute(o);const u=l.intent;e.addXAppStateFromParameter(u,"sap-xapp-state-data");o=S(u,i);o=e.injectStickyParameters({args:o,appLifeCycle:s,technicalParameters:a,type:n});o=C(o);o=this._injectInnerAppRoute(o,l.innerAppRoute);const f=d.getService("ShellNavigationInternal");if(!f){h.debug("Shell not available, no Cross App Navigation");return""}return f.hrefForExternalSync(o,undefined,i)};this.hrefForExternalAsync=async function(t,i){let r=p({},t);const o=this._extractInnerAppRoute(r);const l=o.intent;try{await e.addXAppStateFromParameterAsync(l,"sap-xapp-state-data");r=S(l,i);const t=await e.injectStickyParametersAsync({args:r,appLifeCycle:s,technicalParameters:a,type:n});r=t;r=C(r);r=this._injectInnerAppRoute(r,o.innerAppRoute);const p=await d.getServiceAsync("ShellNavigationInternal");const u=p.hrefForExternal(r,undefined,i);return c.promisify(u)}catch(t){h.debug("Shell not available, no Cross App Navigation");return""}};this.expandCompactHash=function(t){const e=Promise.resolve().then(async()=>{const e=await d.getServiceAsync("NavTargetResolutionInternal");const n=e.expandCompactHash(t);return c.promisify(n)});return c.toDeferred(e)};this.backToPreviousApp=async function(){const t=await this.isInitialNavigationAsync();if(t){return this.toExternal({target:{shellHash:"#"},writeHistory:false})}this.historyBack()};this.historyBack=function(t){let e=-1;if(t&&typeof t==="number"){if(t<=0){h.warning("historyBack called with an argument <= 0 and will result in a forward navigation or refresh","expected was an argument > 0","sap.ushell.services.CrossApplicationNavigation#historyBack")}e=t*-1}window.history.go(e)};this.isInitialNavigation=function(){h.error("Deprecated API call of 'sap.ushell.CrossApplicationNavigation.isInitialNavigation'. Please use 'isInitialNavigationAsync' instead",null,"sap.ushell.services.CrossApplicationNavigation");const t=d.getService("ShellNavigationInternal");if(!t){h.debug("ShellNavigationInternal service not available","This will be treated as the initial navigation","sap.ushell.services.CrossApplicationNavigation");return true}const e=t.isInitialNavigation();if(typeof e==="undefined"){return true}return e};this.isInitialNavigationAsync=async function(){try{const t=await d.getServiceAsync("ShellNavigationInternal");const e=t.isInitialNavigation();if(typeof e==="undefined"){return true}return e}catch(t){h.debug("ShellNavigationInternal service not available","This will be treated as the initial navigation","sap.ushell.services.CrossApplicationNavigation");return true}};this.toExternal=async function(t,i){const r=t.writeHistory;let o=p({},t);const c=p({},o);this._processShellHashWithParams(o);const l=this._extractInnerAppRoute(o);const u=l.intent;try{const t=await d.getServiceAsync("AppLifeCycle");const p=await d.getServiceAsync("ShellNavigationInternal");const h=t.getCurrentApplication();const f=h&&await h.getIntent();this._checkIfAppNeedsToBeReloaded(c,h,f,p.hashChanger);await e.addXAppStateFromParameterAsync(u,"sap-xapp-state-data");o=S(u,i);const g=await e.injectStickyParametersAsync({args:o,appLifeCycle:s,technicalParameters:a,type:n});o=g;o=C(o);delete o.writeHistory;o=this._injectInnerAppRoute(o,l.innerAppRoute);return await p.toExternal(o,i,r)}catch(t){h.error("CrossAppNavigation.toExternal failed",t,"sap.ushell.services.CrossApplicationNavigation")}};this._checkIfAppNeedsToBeReloaded=function(t,e,n,a){if(!e||!n||!t||!t.target){return}if(t.target.shellHash){const e=f.parseShellHash(t.target.shellHash)||{};t.target={semanticObject:e.semanticObject,action:e.action,contextRaw:e.contextRaw};t.appSpecificRoute=e.appSpecificRoute;t.params=Object.assign({},t.params,e.params)}if(t.appSpecificRoute){return}if(e.applicationType!=="UI5"){return}if(t.target.semanticObject!==n.semanticObject){return}if(t.target.action!==n.action){return}const s={params:{}};if(t.params){Object.keys(t.params).forEach(e=>{const n=t.params[e];const a=Array.isArray(n)?n:[n];s.params[e]=a.map(t=>t.toString())})}if(!f.haveSameIntentParameters(s,n)){return}a.setReloadApplication(true)};this.hrefForAppSpecificHash=function(t){h.error("Deprecated API call of 'sap.ushell.CrossApplicationNavigation.hrefForAppSpecificHash'. Please use 'hrefForAppSpecificHashAsync' instead",null,"sap.ushell.services.CrossApplicationNavigation");const e=d.getService("ShellNavigationInternal");if(e){return e.hrefForAppSpecificHash(t)}h.debug("Shell not available, no Cross App Navigation; fallback to app-specific part only");return`#${encodeURI(t)}`};this.hrefForAppSpecificHashAsync=async function(t){try{const e=await d.getServiceAsync("ShellNavigationInternal");return e.hrefForAppSpecificHash(t)}catch(e){h.debug("Shell not available, no Cross App Navigation; fallback to app-specific part only");return`#${encodeURI(t)}`}};this.getPrimaryIntent=function(t,e){const n={};let a;const s=/^#\w+-displayFactSheet(?:$|\?.)/;n.tags=["primaryAction"];n.semanticObject=t;if(e){n.params=e}return this.getLinks(n).then(t=>{if(t.length===0){delete n.tags;n.action="displayFactSheet";a=function(t,e){if(t.intent===e.intent){return 0}const n=s.test(t.intent)^s.test(e.intent);if(n){return s.test(t.intent)?-1:1}return t.intent<e.intent?-1:1};return this.getLinks(n)}a=function(t,e){if(t.intent===e.intent){return 0}return t.intent<e.intent?-1:1};return t}).then(t=>t.length===0?null:t.sort(a)[0])};this.getSemanticObjectLinks=function(t,i,r,o,p,l){const u=Promise.resolve().then(()=>e.injectStickyParametersAsync({args:{params:i},appLifeCycle:s,technicalParameters:a,type:n})).then(e=>{e=S(e,o).params;e=C({params:e}).params;let n;if(Array.isArray(t)){n=[];t.forEach(t=>{n.push([{semanticObject:t[0],params:t[1],ignoreFormFactor:!!t[2],ui5Component:t[3],appStateKey:t[4],compactIntents:!!t[5]}])})}else{n={semanticObject:t,params:e,ignoreFormFactor:r,ui5Component:o,appStateKey:p,compactIntents:!!l}}return Promise.all([d.getServiceAsync("NavTargetResolutionInternal"),n])}).then(t=>{const e=t[0];const n=t[1];return c.invokeUnfoldingArrayArguments(e.getLinks.bind(e),[n])});return c.toDeferred(u)};this.getLinks=function(t){const e=c.invokeUnfoldingArrayArguments(this._getLinks.bind(this),[t]);return c.toDeferred(e)};this._getLinks=async function(t){if(typeof t==="undefined"){t={}}let r=i({},t);r.compactIntents=!!r.compactIntents;r.action=r.action||undefined;r.paramsOptions=e.extractGetLinksParameterOptions(r.params);const o=await e.injectStickyParametersAsync({args:r,appLifeCycle:s,technicalParameters:a,type:n});r=o;let p;if(r.params){p=e.extractGetLinksParameterDefinition(r.params)}else{p=r.params}let l=S({params:p},r.ui5Component).params;l=C({params:l}).params;if(r.appStateKey){l["sap-xapp-state"]=[r.appStateKey];delete r.appStateKey}r.params=l;const u=await d.getServiceAsync("NavTargetResolutionInternal");const h=u.getLinks(r);return c.promisify(h)};this.getDistinctSemanticObjects=function(){const t=Promise.resolve().then(async()=>{const t=await d.getServiceAsync("NavTargetResolutionInternal");const e=t.getDistinctSemanticObjects();return c.promisify(e)});return c.toDeferred(t)};this.isIntentSupported=function(t,e){const n=Promise.resolve().then(async()=>{const n={};const a=t.map(t=>{const a=S(t,e);n[a]=t;return a});const s=await d.getServiceAsync("NavTargetResolutionInternal");const i=s.isIntentSupported(a);const r=await c.promisify(i);const o={};Object.keys(r).forEach(t=>{o[n[t]]=r[t]});return o});return c.toDeferred(n)};this.isNavigationSupported=function(t,e){const n=Promise.resolve().then(async()=>{const n=g(t).map(t=>{const n=this._extractInnerAppRoute(t);return S(n.intent,e)});const a=await d.getServiceAsync("NavTargetResolutionInternal");const s=a.isNavigationSupported(n);return c.promisify(s)});return c.toDeferred(n)};this.isUrlSupported=async function(t){if(typeof t!=="string"){throw new Error("Input is not a string")}if(!f.isIntentUrl(t)){return}const e=f.getHash(t);const n={target:{shellHash:e}};const a=this.isNavigationSupported([n]);const s=await c.promisify(a);if(s[0].supported){return}throw new Error("Navigation not supported")};this.createComponentInstance=function(t,e,n){const a=Promise.resolve().then(async()=>{const a=this._checkComponentConfig(e);if(a){throw new Error(a)}const s=e?.componentData;return y.createComponentInstance(t,s,n)});return c.toDeferred(a)};this.createComponentData=async function(t,e){const n=this._checkComponentConfig(e);if(n){throw new Error(n)}const a=e?.componentData;return y.createComponentInstantiationData(t,a)};this._checkComponentConfig=function(t){if(t){const e=Object.keys(t).length;if(e>1||e===1&&!t.componentData){return"`oConfig` argument should either be an empty object or contain only the `componentData` property."}}return null};this.createEmptyAppState=function(t,e,n,a){h.error("Deprecated API call of 'sap.ushell.CrossApplicationNavigation.createEmptyAppState'. Please use 'createEmptyAppStateAsync' instead",null,"sap.ushell.services.CrossApplicationNavigation");const s=d.getService("AppState");if(!m.isA(t,"sap.ui.core.UIComponent")){throw new Error("The passed oAppComponent must be a UI5 Component.")}return s.createEmptyAppState(t,e,n,a)};this.createEmptyAppStateAsync=async function(t,e,n,a){if(!m.isA(t,"sap.ui.core.UIComponent")){throw new Error("The passed oAppComponent must be a UI5 Component.")}const s=await d.getServiceAsync("AppState");return s.createEmptyAppState(t,e,n,a)};this.getStartupAppState=function(t){this._checkComponent(t);const e=t.getComponentData();const n=e&&e["sap-xapp-state"];const a=n&&n[0];return this.getAppState(t,a)};this._checkComponent=function(t){if(!m.isA(t,"sap.ui.core.UIComponent")){throw new Error("oComponent passed must be a UI5 Component")}};this.getAppState=function(t,e){const n=Promise.resolve().then(async()=>{this._checkComponent(t);const n=await d.getServiceAsync("AppState");if(typeof e!=="string"){if(e!==undefined){h.error("Illegal Argument sAppStateKey ")}await c.awaitTimeout(0);const a=n.createEmptyUnmodifiableAppState(t);return a}const a=n.getAppState(e);return c.promisify(a)});return c.toDeferred(n)};this.getAppStateData=function(t){const e=c.invokeUnfoldingArrayArguments(this._getAppStateData.bind(this),[t]);return c.toDeferred(e)};this._getAppStateData=function(t){const e=Promise.resolve().then(async()=>{const e=await d.getServiceAsync("AppState");if(typeof t!=="string"){if(t!==undefined){h.error("Illegal Argument sAppStateKey ")}await c.awaitTimeout(0);return}const n=e.getAppState(t);const a=await c.promisify(n);return a.getData()}).catch(()=>{});return c.toDeferred(e)};this.saveMultipleAppStates=function(t){const e=Promise.resolve().then(async()=>{const e=t.map(t=>t.save());return Promise.all(e)});return c.toDeferred(e)};this._processShellHashWithParams=function(t){if(t?.processParams===true&&t?.target?.shellHash&&t?.params){const e=f.parseShellHash(t.target.shellHash);t.target={semanticObject:e.semanticObject,action:e.action,contextRaw:e.contextRaw};t.appSpecificRoute=e.appSpecificRoute;t.params=Object.assign({},t.params,e.params)}};this.getSupportedAppStatePersistencyMethods=function(){h.error("Deprecated API call of 'sap.ushell.CrossApplicationNavigation.getSupportedAppStatePersistencyMethods'. Please use 'getSupportedAppStatePersistencyMethodsAsync' instead",null,"sap.ushell.services.CrossApplicationNavigation");const t=d.getService("AppState");return t.getSupportedPersistencyMethods()};this.getSupportedAppStatePersistencyMethodsAsync=async function(){const t=await d.getServiceAsync("AppState");return t.getSupportedPersistencyMethods()};this.makeStatePersistent=function(t,e,n){const a=Promise.resolve().then(async()=>{const a=await d.getServiceAsync("AppState");const s=a.makeStatePersistent(t,e,n);return c.promisify(s)});return c.toDeferred(a)};this.resolveIntent=function(t){const e=Promise.resolve().then(async()=>{const e=await d.getServiceAsync("NavTargetResolutionInternal");const n=e.resolveHashFragment(t);const a=await c.promisify(n);return{url:a.url}});return c.toDeferred(e)}}A.hasNoAdapter=true;return A},true);
//# sourceMappingURL=CrossApplicationNavigation.js.map