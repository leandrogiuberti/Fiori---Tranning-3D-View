// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/extend","sap/ui/Device","sap/ushell/Container","sap/ushell/EventHub","sap/ushell/library","sap/ushell/services/UserRecents/UserRecentsBase","sap/ushell/utils/UrlParsing"],(e,t,n,r,s,i,a,c)=>{"use strict";const o=i.AppType;const p=a.extend("sap.ushell.services.UserRecents.RecentActivity",{constructor:function(e){a.call(this,"RecentActivity",e)}});const u=["#Shell-launchURL","#Shell-startGUI","#Shell-startIntent","#Shell-startURL","#Shell-startWDA"];p.MAX_DAYS=30;p.ITEM_COUNT=30;p._compareItems=function(e,t){const n=e.appType===t.appType;const r=e.url===t.url;const s=e.appId===t.appId;const i=e.title===t.title;if(n){if(e.appType!==o.APP){return r}if(s&&u.includes(e.appId)){return i}return s}else if(e.appType===o.APP||t.appType===o.APP){return s&&r}return false};p.prototype._updateIfAlreadyIn=function(e,n,r){return e.recentUsageArray.some(s=>{const{oItem:i,aUsageArray:c}=s;if(p._compareItems(i,n)){const p=n.appType===i.appType;const u=n.appType===o.APP;if(p||!u){t(i,n);i.timestamp=r;s.iTimestamp=r;s.mobile=undefined;s.tablet=undefined;s.desktop=undefined;s[this._getCurrentDevice()]=true;const l=i.appType===o.APP;if(p||!u&&!l){c[c.length-1]+=1;s.iCount+=1}e.recentUsageArray.sort(a.itemSorter)}return true}return false})};p.prototype._insertNew=function(e,t,n,r){t.timestamp=n;if(r){t.icon=r}const s={oItem:t,iTimestamp:n,aUsageArray:[1],iCount:1,mobile:undefined,tablet:undefined,desktop:undefined};s[this._getCurrentDevice()]=true;if(e.recentUsageArray.length===this.iMaxItems){e.recentUsageArray.pop()}e.recentUsageArray.unshift(s)};p.prototype.newItem=async function(e){const t=Date.now();const n=this._getActivityIcon(e.appType,e.icon);const r=this.getDayFromDate(new Date);const i=await this._getRecentActivitiesFromLoadedData();if(r!==i.recentDay){this._addNewDay(i);i.recentDay=r}const a=this._updateIfAlreadyIn(i,e,t);if(!a){this._insertNew(i,e,t,n)}await this.save(i);s.emit("newUserRecentsItem",i)};p.prototype._getActivityIcon=function(e,t){if(t){return t}switch(e){case o.SEARCH:return"sap-icon://search";case o.COPILOT:return"sap-icon://co";case o.URL:return"sap-icon://internet-browser";default:return"sap-icon://product"}};p.prototype.clearAllActivities=async function(){await this.save([]);s.emit("userRecentsCleared",Date.now())};p.prototype._getCurrentDevice=function(){if(n.system.desktop){return"desktop"}else if(n.system.tablet){return"tablet"}return"mobile"};p.prototype._filterRecentItems=async function(e){const t=this.getDayFromDate(new Date);const n=this._getCurrentDevice();const s=await this._getRecentActivitiesFromLoadedData();let i=false;if(t!==s.recentDay){this._addNewDay(s);s.recentDay=t;i=true}const a=s.recentUsageArray.reduce((e,t,r)=>{if(t[n]===undefined){const{url:n}=t.oItem;const s=c.getShellHash(n);if(s){e.intent.push({index:r,hash:s})}else{e.url.push({index:r})}}return e},{url:[],intent:[]});const o=i||a.url.length>0||a.intent.length>0;a.url.forEach(({index:e})=>{const t=s.recentUsageArray[e];t[n]=true});if(a.intent.length>0){const e=a.intent.map(({hash:e})=>({target:{shellHash:e}}));const t=await r.getServiceAsync("Navigation");const i=await t.isNavigationSupported(e);a.intent.forEach(({index:e},t)=>{const{supported:r}=i[t];const a=s.recentUsageArray[e];a[n]=r})}if(o){await this.save(s)}const p=this._getRecentItemsForCurrentDevice(s);if(e){return p.slice(0,e)}return p};p.prototype._getRecentItemsForCurrentDevice=function(e){const t=this._getCurrentDevice();return e.recentUsageArray.filter(e=>e[t])};p.prototype.getRecentItems=async function(){const e=await this._filterRecentItems(p.ITEM_COUNT);return e.map(e=>e.oItem)};p.prototype.getFrequentItems=async function(){const e=await this._filterRecentItems();let t=0;let n=[];let r=e[0]?new Date(e[0].iTimestamp).toDateString():"";for(let s=0;s<e.length&&t<p.MAX_DAYS;s++){const i=e[s];if(i.iCount>1){n.push(i)}const a=new Date(i.iTimestamp).toDateString();if(r!==a){t++;r=a}}n.sort((e,t)=>t.iCount-e.iCount);n=n.slice(0,p.ITEM_COUNT);return n.map(e=>e.oItem)};p.prototype._addNewDay=function(e){e.recentUsageArray.forEach(e=>{if(!e.aUsageArray){e.aUsageArray=[];e.iCount=0}const{aUsageArray:t}=e;t.push(0);if(t.length>p.MAX_DAYS){e.iCount-=t[0];t.shift()}})};p.prototype._getRecentActivitiesFromLoadedData=async function(){const t=await this.load();let n;let r;if(Array.isArray(t)){r=t}else{n=t}const s=n||{recentDay:null,recentUsageArray:r||[]};s.recentUsageArray=s.recentUsageArray.filter(t=>{const n=!!t?.oItem?.url;if(!n){e.error("FLP Recent Activity",t,"is not valid. The activity is removed from the list.")}return n});return s};return p});
//# sourceMappingURL=RecentActivity.js.map