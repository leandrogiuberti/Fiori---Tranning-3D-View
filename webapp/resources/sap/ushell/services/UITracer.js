// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/EventHub","sap/base/util/isPlainObject","sap/base/Log","sap/ushell/Config","sap/ui/Device","sap/base/util/fetch"],(e,t,s,i,r,a)=>{"use strict";const n=32768;const c=2;const o=1;const h="UITracer.trace";function p(e,t,r){this._sServiceUrl=r.serviceUrl||"/bff/ui-trace/v1/trace";this._pToken=null;this._sToken="";this._resetTrace();this._attachBrowserEvents();this._attachEventHubEvents();this._sSpacesPages=i.last("/core/spaces/enabled")?"-spaces":"-groups";this._sSiteType=`wz-standard${this._sSpacesPages}`;this._sSiteId=new URLSearchParams(window.location.search).get("siteId")||i.last("/core/site/siteId");this._sDeviceType=this._getDeviceType();let a=document.querySelector("meta[name='sap.flp.cf.Config']")?.content;if(a){try{a=JSON.parse(a)}catch(e){s.error("UITracer: unable to parse sap.flp.cf.Config",e)}if(a&&a.scenario){if(a.scenario==="LAUNCHPAD"&&this._sSiteId==="sap.start.site"){this._sSiteType=`sap-start${this._sSpacesPages}`}else if(a.scenario==="WORKZONE"){this._sSiteType=`wz-advanced${this._sSpacesPages}`}else if(a.scenario==="WORKZONEHR"){this._sSiteType=`wz-advancedhr${this._sSpacesPages}`}}}this._initialized=Promise.resolve()}p.prototype._getToken=function(){this._pToken=a(this._sServiceUrl).then(e=>{this._sToken="-";return e.json()}).then(e=>{if(e&&e.token){this._sToken=e.token}}).catch(()=>{s.debug(`UITracer: getToken failed on ${this._sServiceUrl}`,"","sap.ushell.services.UITracer");this._sToken="-"})};p.prototype.trace=function(e){if(!this._sToken&&!this._pToken){this._getToken()}this._addEntry(e)};p.prototype._getDeviceType=function(){let e="desktop";if(r.system.tablet){e="tablet"}else if(r.system.phone){e="phone"}return`browser-${e}`};p.prototype._resetTrace=function(){this._aTrace=[];this._iSize=c};p.prototype._addEntry=function(e){if(t(e)&&Object.keys(e).length>0){try{const t=this._createTraceEntry(e);const i=this._getBlob(t).size+o;if(this._iSize+i>n){this._sendTrace()}this._iSize+=i;this._aTrace.push(t);s.debug(`UITracer: Trace entry added with size ${i}`,JSON.stringify(t),"sap.ushell.services.UITracer");return true}catch(e){return false}}return false};p.prototype._createTraceEntry=function(e){const t=JSON.parse(JSON.stringify(e));const s=t.data||{};s.siteType=this._sSiteType;s.siteId=this._sSiteId;s.deviceType=this._sDeviceType;t._ts=(new Date).toISOString();t.data=s;return t};p.prototype._sendTrace=function(e){if(!this._sToken||this._sToken==="-"){s.debug(`UITracer: _sendTrace failed, token ${this._sToken}`==="-"?"request failed ":"is missing","","sap.ushell.services.UITracer");return}if(this._aTrace.length>0){const t=this._aTrace[this._aTrace.length-1];if(!e&&t.reason==="LaunchApp"&&t.data&&t.data.targetUrl&&t.data.targetUrl.indexOf("#")===0){return}const i=this._getBlob({token:this._sToken,data:this._aTrace});try{window.navigator.sendBeacon(this._sServiceUrl,i);s.debug(`UITracer: _sendTrace to ${this._sServiceUrl} with size ${i.size} byte, entry count ${this._aTrace.length}`,"","sap.ushell.services.UITracer")}catch(e){s.debug(`UITracer: _sendTrace failed ${this._sServiceUrl} with size ${i.size} byte, entry count ${this._aTrace.length}`,"","sap.ushell.services.UITracer")}}this._resetTrace()};p.prototype._getBlob=function(e){if(t(e)||Array.isArray(e)){e=JSON.stringify(e)}if(typeof e==="string"){return new Blob([e],{type:"application/json"})}return null};p.prototype._attachBrowserEvents=function(){if(document.visibilityState){document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="hidden"){this._sendTrace()}})}window.addEventListener("beforeunload",()=>{this._sendTrace(true)})};p.prototype._attachEventHubEvents=function(){e.on(h).do(e=>{this.trace(e)})};p.hasNoAdapter=true;return p},true);
//# sourceMappingURL=UITracer.js.map