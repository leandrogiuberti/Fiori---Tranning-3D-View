// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/EventBus","sap/ui/thirdparty/jquery","sap/ushell/Config","sap/ushell/library","sap/ushell/utils","sap/base/util/deepClone","sap/base/util/deepExtend","sap/base/Log"],(e,jQuery,o,r,t,a,s,n)=>{"use strict";const i="sap.ushell.services.Bookmark";const c="X-SAP-UI2-HANA:hana?remoteId=HANA_CATALOG";const l=r.ContentNodeType;function u(){this._oLaunchPageServicePromise=sap.ushell.Container.getServiceAsync("LaunchPage");if(o.last("/core/spaces/enabled")){this._oPagesServicePromise=sap.ushell.Container.getServiceAsync("Pages")}this._addBookmarkToContentNodes=function(e,o,r,t){const a=o.map(async o=>{if(o&&o.hasOwnProperty("type")&&o.isContainer){switch(o.type){case l.Page:return this.addBookmarkToPage(e,o.id,t);case l.HomepageGroup:return new Promise((e,r)=>{this._oLaunchPageServicePromise.then(t=>{t.getGroupById(o.id).done(e).fail(r)})}).then(o=>this.addBookmarkToHomepageGroup(e,o,r,t));default:throw new Error(`Bookmark Service: The API needs to be called with a valid content node type. '${o.type}' is not supported.`)}}throw new Error("Bookmark Service: Not a valid content node.")});return Promise.all(a)};this.addBookmark=function(e,r,t){const a=new jQuery.Deferred;const s=o.last("/core/shell/enablePersonalization");const c=o.last("/core/spaces/enabled");const l=o.last("/core/spaces/myHome/enabled");if(!s&&(!c||!l)){return a.resolve().promise()}this._checkBookmarkParameters(e).then(()=>this._changeUrlStatesToPersistent(e.url)).then(o=>{e.url=o;if(typeof r==="undefined"&&c){return sap.ushell.Container.getServiceAsync("Menu").then(e=>e.getDefaultSpace()).then(e=>{const o=e&&e.children&&e.children[0];return o}).then(o=>this._addBookmarkToContentNodes(e,[o],false,t))}if((typeof r==="undefined"||!r.hasOwnProperty("type"))&&!Array.isArray(r)){return this.addBookmarkToHomepageGroup(e,r,false,t)}const a=[].concat(r);return this._addBookmarkToContentNodes(e,a,false,t)}).then(a.resolve).catch(e=>{n.error("Error during Bookmark creation: ",e,i);a.reject(e)});return a.promise()};this.addCustomBookmark=async function(e,o,r,t){const n=a(o);const i=s(n,{vizType:e,vizConfig:{"sap.flp":{chipConfig:n.chipConfig},"sap.platform.runtime":{includeManifest:!n.loadManifest}}});delete i.chipConfig;delete i.loadManifest;i.url=await this._changeUrlStatesToPersistent(i.url);const c=[].concat(r);return this._addBookmarkToContentNodes(i,c,true,t)};this.addBookmarkToHomepageGroup=async function(r,t,a,s){if(o.last("/core/spaces/enabled")){throw new Error("Bookmark Service: The API is not available in spaces mode.")}return new Promise((o,n)=>{this._oLaunchPageServicePromise.then(i=>{let c;if(a){c=i.addCustomBookmark(r,t,s)}else{c=i.addBookmark(r,t,s)}c.done(r=>{const a={tile:r,group:t};e.getInstance().publish("sap.ushell.services.Bookmark","bookmarkTileAdded",a);o()}).fail(n)})})};this.addBookmarkToPage=async function(e,r,t){if(!o.last("/core/spaces/enabled")){throw new Error("Bookmark Service: 'addBookmarkToPage' is not valid in launchpad home page mode, use 'addBookmark' instead.")}const a=o.last("/core/shell/enablePersonalization");const s=o.last("/core/spaces/myHome/enabled");const n=o.last("/core/spaces/myHome/myHomePageId");if(!a&&(!s||s&&r!==n)){throw new Error("Bookmark Service: Add bookmark is not allowed as the personalization functionality is not enabled.")}if(e&&(typeof e.title!=="string"||typeof e.url!=="string")){throw new Error("Bookmark Service - Invalid bookmark data.")}return this._oPagesServicePromise.then(o=>o.addBookmarkToPage(r,e,undefined,t))};this.addBookmarkByGroupId=function(e,r,t){const a=new jQuery.Deferred;if(o.last("/core/spaces/enabled")){return a.reject(new Error("Bookmark Service: The API 'addBookmarkByGroupId' is not supported in launchpad spaces mode.")).promise()}this._oLaunchPageServicePromise.then(o=>{o.getGroups().done(o=>{const s=o.find(e=>e.id===r)||null;this.addBookmark(e,s,t).done(a.resolve).fail(a.reject)}).fail(a.reject)}).catch(a.reject);return a.promise()};this.getShellGroupIDs=function(e){const r=new jQuery.Deferred;if(o.last("/core/spaces/enabled")){return r.reject(new Error("Bookmark Service: The API 'getShellGroupIDs' is not supported in launchpad spaces mode.")).promise()}this._oLaunchPageServicePromise.then(o=>{o.getGroupsForBookmarks(e).done(e=>{e=e.map(e=>({id:o.getGroupId(e.object),title:e.title}));r.resolve(e)}).fail(r.reject)});return r.promise()};this._doAddCatalogTileToGroup=function(e,o,r,t){this._oLaunchPageServicePromise.then(a=>{if(t){a.getGroups().fail(e.reject).done(s=>{const i=s.some(s=>{if(a.getGroupId(s)===t){this._addToGroup(r,e,o,s);return true}});if(!i){const o=`Group '${t}' is unknown`;n.error(o,null,"sap.ushell.services.Bookmark");e.reject(new Error(o))}})}else{a.getDefaultGroup().fail(e.reject).done(t=>{this._addToGroup(r,e,o,t)})}});return e.promise()};this._isSameCatalogTile=function(e,o,r){const t=r.getCatalogTileId(o);if(t===undefined){return false}return t.indexOf(e)===0};this._addToGroup=function(o,r,t,a){return this._oLaunchPageServicePromise.then(s=>{s.getCatalogTiles(o).fail(r.reject).done(i=>{const c=s.getGroupId(a);const l=i.some(o=>{if(this._isSameCatalogTile(t,o,s)){s.addTile(o,a).fail(r.reject).done(()=>{r.resolve();e.getInstance().publish("sap.ushell.services.Bookmark","catalogTileAdded",c)});return true}});if(!l){const e=`No tile '${t}' in catalog '${s.getCatalogId(o)}'`;n.error(e,null,"sap.ushell.services.Bookmark");r.reject(new Error(e))}})})};this.addCatalogTileToGroup=function(e,r,t){const a=new jQuery.Deferred;n.error("Deprecated API call of 'sap.ushell.Bookmark.addCatalogTileToGroup'. Please use 'addBookmark' instead",null,"sap.ushell.services.Bookmark");if(o.last("/core/spaces/enabled")){return a.reject(new Error("Bookmark Service: The API 'addCatalogTileToGroup' is not supported in launchpad spaces mode.")).promise()}this._oLaunchPageServicePromise.then(o=>{const s=t?this._isMatchingRemoteCatalog:this._isLegacyHANACatalog;t=t||{id:c};o.onCatalogTileAdded(e);o.getCatalogs().fail(a.reject).done(i=>{let c;i.forEach(e=>{if(s(e,t,o)){if(!c){c=e}else{n.warning(`More than one matching catalog: ${JSON.stringify(t)}`,null,"sap.ushell.services.Bookmark")}}});if(c){this._doAddCatalogTileToGroup(a,e,c,r)}else{const e=`No matching catalog found: ${JSON.stringify(t)}`;n.error(e,null,"sap.ushell.services.Bookmark");a.reject(new Error(e))}})});return a.promise()};this._checkBookmarkParameters=async function(e){if(!e){throw new Error("Invalid Bookmark Data: No bookmark parameters passed.")}const o=e.dataSource;let r;if(o){if(o.type!=="OData"){throw new Error(`Invalid Bookmark Data: Unknown data source type: ${o.type}`)}r=o.settings&&o.settings.odataVersion;const e=["2.0","4.0"];if(!e.includes(r)){throw new Error(`Invalid Bookmark Data: Unknown OData version in the data source: ${r}`)}}if(e.serviceUrl){return sap.ushell.Container.getServiceAsync("ReferenceResolver").then(r=>{if(r.hasSemanticDateRanges(e.serviceUrl)&&!o){throw new Error("Invalid Bookmark Data: Provide a data source to use semantic date ranges.")}})}};this._isMatchingRemoteCatalog=function(e,o,r){const t=r.getCatalogData(e);return t.remoteId===o.remoteId&&t.baseUrl.replace(/\/$/,"")===o.baseUrl.replace(/\/$/,"")};this._isLegacyHANACatalog=function(e,o,r){return r.getCatalogId(e)===c};this.countBookmarks=function(e,r){const t=new jQuery.Deferred;if(o.last("/core/spaces/enabled")){this._oPagesServicePromise.then(o=>o.countBookmarks({url:e,contentProviderId:r})).then(t.resolve).catch(t.reject)}else{this._oLaunchPageServicePromise.then(o=>{o.countBookmarks(e,r).done(t.resolve).fail(t.reject)})}return t.promise()};this.countCustomBookmarks=async function(e){if(!e||!e.url||!e.vizType){throw new Error("countCustomBookmarks: Some required parameters are missing.")}if(o.last("/core/spaces/enabled")){const o=await this._oPagesServicePromise;return o.countBookmarks(e)}const r=await this._oLaunchPageServicePromise;return r.countCustomBookmarks(e)};this.deleteBookmarks=function(r,t){const a=new jQuery.Deferred;if(o.last("/core/spaces/enabled")){this._oPagesServicePromise.then(e=>e.deleteBookmarks({url:r,contentProviderId:t})).then(a.resolve).catch(a.reject)}else{this._oLaunchPageServicePromise.then(o=>{o.deleteBookmarks(r,t).done(o=>{e.getInstance().publish("sap.ushell.services.Bookmark","bookmarkTileDeleted",r);a.resolve(o)}).fail(a.reject)})}return a.promise()};this.deleteCustomBookmarks=async function(r){if(!r||!r.url||!r.vizType){throw new Error("deleteCustomBookmarks: Some required parameters are missing.")}if(o.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(e=>e.deleteBookmarks(r))}return this._oLaunchPageServicePromise.then(e=>e.deleteCustomBookmarks(r)).then(o=>{e.getInstance().publish("sap.ushell.services.Bookmark","bookmarkTileDeleted",r.url);return o})};this.updateBookmarks=function(e,r,t){const a=new jQuery.Deferred;if(o.last("/core/spaces/enabled")){Promise.all([this._oPagesServicePromise,this._changeUrlStatesToPersistent(r.url)]).then(([o,a])=>{r.url=a;return o.updateBookmarks({url:e,contentProviderId:t},r)}).then(a.resolve).catch(a.reject)}else{Promise.all([this._oLaunchPageServicePromise,this._changeUrlStatesToPersistent(r.url)]).then(([o,s])=>{r.url=s;o.updateBookmarks(e,r,t).done(a.resolve).fail(a.reject)})}return a.promise()};this.updateCustomBookmarks=async function(e,r){if(!e||!e.url||!e.vizType){throw new Error("updateCustomBookmarks: Some required parameters are missing.")}const t=s({},r,{vizConfig:{"sap.flp":{chipConfig:r.chipConfig},"sap.platform.runtime":{includeManifest:!r.loadManifest}}});delete t.chipConfig;delete t.loadManifest;t.url=await this._changeUrlStatesToPersistent(t.url);if(o.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(o=>o.updateBookmarks(e,t))}return this._oLaunchPageServicePromise.then(o=>o.updateCustomBookmarks(e,t))};this.getContentNodes=async function(){if(o.last("/core/spaces/enabled")){const e=await sap.ushell.Container.getServiceAsync("Menu");return e.getContentNodes()}return new Promise(async(e,o)=>{const r=await this._oLaunchPageServicePromise;r.getGroupsForBookmarks().done(o=>{const t=o.map(e=>({id:r.getGroupId(e.object),label:e.title,type:l.HomepageGroup,isContainer:true}));e(t)}).fail(o)})};this._changeUrlStatesToPersistent=async function(e){const o=await sap.ushell.Container.getServiceAsync("AppState");const r=o.getPersistentWhenShared();if(o.getSupportedPersistencyMethods().length===0&&r!==true){return e}if(e&&e.length>0){return t.promisify(o.setAppStateToPublic(e))}return e}}u.hasNoAdapter=true;return u},true);
//# sourceMappingURL=Bookmark.js.map