// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/isEmptyObject","sap/ui/core/routing/HashChanger","sap/ui/performance/trace/Interaction","sap/ui/thirdparty/hasher","sap/ui/thirdparty/jquery","sap/ushell/Container","sap/ushell/navigation/NavigationState","sap/ushell/utils/UrlShortening","sap/ushell/utils/UrlParsing"],(t,e,a,n,i,jQuery,s,r,o,h)=>{"use strict";const p={HASH_SET:{name:"hashSet",historyEntry:true},HASH_REPLACED:{name:"hashReplaced",historyEntry:false},SHELL_HASH_CHANGED:{name:"shellHashChanged",historyEntry:true,usedByUi5HistoryDetection:true,ui5EventParameterNames:{oldHash:"oldAppSpecificRouteNoSeparator",newHash:"newAppSpecificRouteNoSeparator"},updateHashOnly:true},SHELL_HASH_PARAMETER_CHANGED:{name:"shellHashParameterChanged",historyEntry:null},HASH_CHANGED:{name:"hashChanged",historyEntry:false,usedByUi5HistoryDetection:true,ui5EventParameterNames:{newHash:"newHash",fullHash:"fullHash"}}};const l="ShellNavigationHashChanger";const c="[FesrFlp]";const u=a.extend("sap.ushell.services.ShellNavigationHashChanger",{constructor:function(t){this.oServiceConfig=t;this._oNavigationState={};a.apply(this);this._initializedByShellNav=false;this._bReloadApplication=false;this.privfnShellCallback=null;this.privappHashPrefix="&/";this.privhashPrefix="#";this.aNavigationFilters=[];this.NavigationFilterStatus={Continue:"Continue",Custom:"Custom",Abandon:"Abandon",Keep:"Keep"};this.getRelevantEventsInfo=function(){return this._getAllEvents().filter(t=>t.usedByUi5HistoryDetection).map(t=>{const e={name:t.name,paramMapping:t.ui5EventParameterNames};if(t.updateHashOnly!==undefined){e.updateHashOnly=t.updateHashOnly}return e})}}});u.prototype.privgetCurrentShellHash=function(){const t=this.privsplitHash(i.getHash());return{hash:`#${t?.shellPart||""}`}};u.prototype.privconstructHash=function(t){const e=this.privgetCurrentShellHash();e.hash+=t;return e};u.prototype.privconstructShellHash=function(t){return h.constructShellHash(t)};u.prototype.privsplitHash=function(t){if(t===undefined||t===null||t===""){return{shellPart:null,appSpecificRoute:null,intent:null,params:null}}const a=h.parseShellHash(t);if(a===undefined||a===null){return null}const n=a.params&&!e(a.params)?a.params:null;const i=a.appSpecificRoute;a.appSpecificRoute=undefined;return{shellPart:this.privstripLeadingHash(this.privconstructShellHash(a))||null,appSpecificRoute:i||null,intent:a.semanticObject&&a.action&&`${a.semanticObject}-${a.action}${a.contextRaw||""}`||null,params:n}};u.prototype.privsetHash=function(t,e,a){i.prependHash="";t=this.privstripLeadingHash(t);e=e||"";if(a===undefined){a=true}if(a){this.fireEvent(p.HASH_SET.name,{sHash:e});i.setHash(t)}else{this.fireEvent(p.HASH_REPLACED.name,{sHash:e});i.replaceHash(t)}};u.prototype.privstripLeadingHash=function(t){if(t[0]==="#"){return t.substring(1)}return t};u.prototype.registerNavigationFilter=function(t){if(typeof t!=="function"){throw new Error("fnFilter must be a function")}this.aNavigationFilters.push(t)};u.prototype.unregisterNavigationFilter=function(t){if(typeof t!=="function"){throw new Error("fnFilter must be a function")}this.aNavigationFilters=this.aNavigationFilters.filter(e=>e!==t)};function f(t,e,a){this.oAppState=undefined;this.oPromise=(new jQuery.Deferred).resolve();this.getNextKey=function(){this.oAppState=t.createEmptyAppState(e,a);return this.oAppState.getKey()};this.store=function(t){this.oAppState.setData(t);const e=this.oAppState.save();this.oPromise=jQuery.when(this.oPromise,e)};this.getPromise=function(){return this.oPromise}}u.prototype.compactParams=function(t,e,a,n){const i=new jQuery.Deferred;const r=h.constructShellHash({target:{semanticObject:"SO",action:"action"},params:t});if(t===undefined||Object.keys(t).length===0){return i.resolve(t).promise()}s.getServiceAsync("AppState").then(t=>{const s=new f(t,a,n);const p=o.compactHash(r,e,s);const l=h.parseParameters(p.hash.match(/\?.*/)[0]);s.getPromise().done(()=>{i.resolve(l)}).fail(i.reject)});return i.promise()};u.prototype.hrefForExternal=async function(t,e){let a=await this.hrefForExternalNoEncAsync(t,e);if(e){a.hash=encodeURI(a.hash)}else{a=encodeURI(a)}return a};u.prototype.hrefForExternalSync=function(t,e,a){let n=this.hrefForExternalNoEnc(t,e,a);if(e){n.hash=encodeURI(n.hash)}else{n=encodeURI(n)}return n};u.prototype.hrefForExternalNoEnc=function(e,a,n,i){t.error("Deprecated API call of 'sap.ushell.services.ShellNavigationHashChanger.hrefForExternalNoEnc'. Please use 'hrefForExternalNoEncAsync' instead",null,"sap.ushell.services.ShellNavigationHashChanger");if(i){const t=new jQuery.Deferred;this.hrefForExternalNoEncAsync(e,a).then(t.resolve).catch(t.reject);return t.promise()}const s=this.privhrefForExternalNoEnc(e);if(a){return{hash:s.hash,params:s.params,skippedParams:s.skippedParams}}return s.hash};u.prototype.hrefForExternalNoEncAsync=async function(t,e){let a;const n=this.privhrefForExternalNoEnc(t);if(e){a={hash:n.hash,params:n.params,skippedParams:n.skippedParams}}else{a=n.hash}return a};u.prototype.privhrefForExternalNoEnc=function(t){if(t===undefined){return this.privgetCurrentShellHash()}if(t&&t.target&&(typeof t.target.semanticObject==="string"||typeof t.target.shellHash==="string")){return{hash:`#${this.privconstructShellHash(t)}`}}return this.privgetCurrentShellHash()};u.prototype.privgetAppHash=function(t){let e;if(t&&t.target&&typeof t.target.shellHash==="string"){const a=h.parseShellHash(t.target.shellHash);e=a&&a.appSpecificRoute;e=e&&e.substring(2)}return e};u.prototype.hrefForAppSpecificHash=function(t){return encodeURI(this.privconstructHash(this.privappHashPrefix+t).hash)};u.prototype.toExternal=function(t,e,a){const n=this.privhrefForExternalNoEnc(t).hash;const i=this.privgetAppHash(t);this.privsetHash(n,i,a);return Promise.resolve()};u.prototype.toAppHash=function(t,e){const a=this.privconstructHash(this.privappHashPrefix+t).hash;this.privsetHash(a,t,e)};u.prototype.initShellNavigation=function(e){if(this._initializedByShellNav){t.info("initShellNavigation already called on this ShellNavigationHashChanger instance.");return false}this.privfnShellCallback=e;i.changed.add(this.treatHashChanged,this);if(!i.isActive()){i.initialized.addOnce(this.treatHashChanged,this);i.init()}else{this.treatHashChanged(i.getHash())}this._initializedByShellNav=true;return true};u.prototype.init=function(){if(this._initialized){t.info("init already called on this ShellNavigationHashChanger instance.");return false}const e=this.privsplitHash(i.getHash());const a=(e?.appSpecificRoute||"  ").substring(2);const n=a?"&/":"";const s=e?.shellPart||"";this.fireEvent(p.HASH_CHANGED.name,{newHash:a,fullHash:s+n+a});this._initialized=true;return true};u.prototype._removeInnerAppSeparator=function(t){return(t||"").replace("&/","")};u.prototype._startFesrInteraction=function(){if(!this._fnResolveFesrInteraction){t.debug(`${c} Interaction Start`,null,l);this._fnResolveFesrInteraction=n.notifyAsyncStep()}};u.prototype._endFesrInteraction=function(){if(this._fnResolveFesrInteraction){t.debug(`${c} Interaction End`,null,l);this._fnResolveFesrInteraction();this._fnResolveFesrInteraction=null}};u.prototype._trackNavigation=function(t,e){this._oNavigationState.newHash=t;this._oNavigationState.oldHash=e};u.prototype.getCurrentNavigationState=function(){return this._oNavigationState};u.prototype.treatHashChanged=function(e,a){r.startNavigation();this._trackNavigation(e,a);this._startFesrInteraction();if(this.inAbandonFlow){this._endFesrInteraction();this.setReloadApplication(false);r.endNavigation();return}let n;e=o.expandHash(e);a=o.expandHash(a);const s=this.privsplitHash(e);let l=this.privsplitHash(a);if(!s){const t=new Error(`Illegal new hash - cannot be parsed: '${e}'`);this.fireEvent(p.SHELL_HASH_CHANGED.name,{newShellHash:e,newAppSpecificRoute:null,fullHash:e,oldShellHash:l?l.shellPart:a,error:t});this.privfnShellCallback(e,null,l?l.shellPart:a,l?l.appSpecificRoute:null,t);this._endFesrInteraction();this.setReloadApplication(false);return}if(!l){l={shellPart:a,appSpecificRoute:null}}for(let s=0;s<this.aNavigationFilters.length;s++){try{let t;const r=this.aNavigationFilters[s].call(undefined,e,a);let o=r;if(typeof r!=="string"){o=r.status;t=r.hash}if(o===this.NavigationFilterStatus.Custom){if(t&&t.length>0){this.inAbandonFlow=true;i.replaceHash(t);this.inAbandonFlow=false}this._endFesrInteraction();this.setReloadApplication(false);return}if(o===this.NavigationFilterStatus.Abandon){this.inAbandonFlow=true;i.replaceHash(a);this.inAbandonFlow=false;this._endFesrInteraction();this.setReloadApplication(false);return}if(o===this.NavigationFilterStatus.Keep){n=true}}catch(e){t.error("Error while calling Navigation filter! ignoring filter...",e,"sap.ushell.services.ShellNavigationHashChanger")}}if(n){this.fireEvent(p.HASH_CHANGED.name,{newHash:e,oldHash:a,fullHash:e});this._endFesrInteraction();this.setReloadApplication(false);r.endNavigation();return}const c=a===undefined;const u=h.compareHashes(e,a);u.sameIntent=u.sameIntent&&!c;const f=u.sameIntent&&u.sameParameters&&u.sameAppSpecificRoute;if(f){t.info("Navigation happened but hash stayed the same",null,"sap.ushell.services.ShellNavigationHashChanger");this.fireEvent(p.HASH_CHANGED.name,{newHash:this._removeInnerAppSeparator(s.appSpecificRoute),oldHash:this._removeInnerAppSeparator(l.appSpecificRoute),fullHash:e});this._endFesrInteraction();this.setReloadApplication(false);return}const H=u.sameIntent&&u.sameParameters;if(H){if(this.getReloadApplication()){this.setReloadApplication(false)}else{const a=this._removeInnerAppSeparator(s.appSpecificRoute);const n=this._removeInnerAppSeparator(l.appSpecificRoute);t.info(`Inner App Hash changed from '${n}' to '${a}'`,null,"sap.ushell.services.ShellNavigationHashChanger");this.fireEvent(p.HASH_CHANGED.name,{newHash:a,oldHash:n,fullHash:e});this._endFesrInteraction();r.endNavigation();return}}if(u.sameIntent&&this.hasListeners(p.SHELL_HASH_PARAMETER_CHANGED.name)){const e=h.paramsToString(s.params);const a=h.paramsToString(l.params);t.info(`Shell hash parameters changed from '${a}' to '${e}'`,null,"sap.ushell.services.ShellNavigationHashChanger");this.fireEvent(p.SHELL_HASH_PARAMETER_CHANGED.name,{oNewParameters:s.params,oOldParameters:l.params});this._endFesrInteraction();this.setReloadApplication(false);r.endNavigation();return}t.info(`Outer shell hash changed from '${a}' to '${e}'`,null,"sap.ushell.services.ShellNavigationHashChanger");this.fireEvent(p.SHELL_HASH_CHANGED.name,{newShellHash:s.shellPart,newAppSpecificRoute:s.appSpecificRoute,fullHash:e,oldShellHash:l.shellPart,oldAppSpecificRoute:l.appSpecificRoute,error:"",oldAppSpecificRouteNoSeparator:this._removeInnerAppSeparator(l.appSpecificRoute),newAppSpecificRouteNoSeparator:this._removeInnerAppSeparator(s.appSpecificRoute)});this.privfnShellCallback(s.shellPart,s.appSpecificRoute,l.shellPart,l.appSpecificRoute);this._endFesrInteraction();this.setReloadApplication(false)};u.prototype.setHash=function(t){this.toAppHash(t,true)};u.prototype.replaceHash=function(t){this.toAppHash(t,false)};u.prototype.getHash=function(){return this.getAppHash()};u.prototype.getAppHash=function(){const t=this.privsplitHash(i.getHash());const e=(t?.appSpecificRoute||"  ").substring(2);return e};u.prototype.destroy=function(){i.changed.remove(this.treatHashChanged,this);a.prototype.destroy.apply(this,arguments)};u.prototype._getAllEvents=function(){return Object.keys(p).map(t=>p[t])};u.prototype.getReplaceHashEvents=function(){return this._getAllEvents().filter(t=>t.historyEntry===false).map(t=>t.name)};u.prototype.getSetHashEvents=function(){return this._getAllEvents().filter(t=>t.historyEntry===true).map(t=>t.name)};u.prototype.isInnerAppNavigation=function(t,e){const a=h.parseShellHash(t);const n=h.parseShellHash(e);const i=e===undefined;const s=h.haveSameIntent(a,n)&&!i;const r=h.haveSameIntentParameters(a,n);return s&&r};u.prototype.getReloadApplication=function(){return this._bReloadApplication};u.prototype.setReloadApplication=function(t){this._bReloadApplication=t};return u});
//# sourceMappingURL=ShellNavigationHashChanger.js.map