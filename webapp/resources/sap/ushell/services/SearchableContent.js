// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/Config","sap/ushell/Container","sap/ushell/adapters/cdm/v3/_LaunchPage/readApplications","sap/ushell/adapters/cdm/v3/_LaunchPage/readPages","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/ushell/adapters/cdm/v3/utilsCdm","sap/base/util/values","sap/ushell/library","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/base/Log","sap/ushell/utils/UrlParsing","sap/ushell/utils"],(t,e,i,a,n,s,o,l,r,c,p,u)=>{"use strict";const d=l.DisplayFormat;function g(){}g.COMPONENT_NAME="sap/ushell/services/SearchableContent";g.prototype.getApps=async function(e={}){const i={includeAppsWithoutVisualizations:false,enableVisualizationPreview:true};const a={includeAppsWithoutVisualizations:e.includeAppsWithoutVisualizations??i.includeAppsWithoutVisualizations,enableVisualizationPreview:e.enableVisualizationPreview??i.enableVisualizationPreview};if(!t.last("/core/spaces/enabled")){try{const t=await this._getLaunchPageAppData(a);const e=this._filterGetApps(t,a);c.debug(`SearchableContent@getApps in classic mode found ${e.length} apps`);return e}catch(t){c.error("SearchableContent@getApps in classic mode failed",t);throw t}}const n=await this._getPagesAppData(a);return this._filterGetApps(n,a)};g.prototype._filterGetApps=function(t,e){let i=t;i.forEach(t=>{const e=t.visualizations;const i=[];t.visualizations=[];e.forEach(e=>{const a=JSON.stringify({title:e.title,subtitle:e.subtitle,icon:e.icon,vizType:e.vizType});if(i.indexOf(a)===-1){t.visualizations.push(e);i.push(a)}})});if(!e.includeAppsWithoutVisualizations){i=i.filter(t=>t.visualizations.length>0)}u.setPerformanceMark("FLP-Search-FilterApps",{bUseUniqueMark:true});return i};g.prototype._getLaunchPageAppData=async function(t){const i=await e.getServiceAsync("FlpLaunchPage");const[a,n]=await this._collectLaunchPageTiles(i);const s=a.concat(n);const l=await Promise.all(s.map(async t=>{const e=a.includes(t);const n={tileId:null,tile:t};let s;try{if(e){n.tileId=i.getCatalogTileId(t)}else{n.tileId=i.getTileId(t)}s=i.getCatalogTilePreviewTitle(t)}catch(t){c.error(`Could not get search data from tile ${n.tileId}`,t)}if(!s){try{const a=await new Promise((a,n)=>{if(e){i.getCatalogTileViewControl(t).done(a).fail(n)}else{i.getTileView(t).done(a).fail(n)}});n.view=a;return n}catch(t){c.error(`Could not get search data from tile ${n.tileId}`,t);return n}}return n}));const r={};const p=l.map(e=>{try{return this._buildVizDataFromLaunchPageTile(e.tile,t,i)}catch(t){c.error(`Could not get search data from tile ${e.tileId}`,t);return null}}).filter(t=>t);l.forEach(t=>{const e=t.view;if(e){if(!e.destroy){c.error(`The tile with id '${t.tileId}' does not implement mandatory function destroy`)}else{e.destroy()}}});p.forEach(t=>{const e=t.targetURL;if(e){if(r[e]){r[e].visualizations.push(t)}else{r[e]=this._buildAppDataFromViz(t)}}});return o(r)};g.prototype._collectLaunchPageTiles=function(t){const e=t.getGroups().then(e=>e.reduce(async(e,i)=>{const[a,n]=await Promise.all([e,t.getGroupTilesForSearch(i)]);return a.concat(n)},Promise.resolve([])));const i=t.getCatalogs().then(e=>e.reduce(async(e,i)=>{const[a,n]=await Promise.all([e,t.getCatalogTiles(i)]);return a.concat(n)},Promise.resolve([])));return Promise.all([i,e])};g.prototype._getPagesAppData=async function(t){const i=await e.getServiceAsync("CommonDataModel");const[a,n,s,l,r]=await Promise.all([i.getAllPages({personalizedPages:true}),i.getApplications(),i.getVisualizations(),i.getVizTypes(),e.getServiceAsync("ClientSideTargetResolution")]);const c={applications:n,visualizations:s,vizTypes:l};const p={};await this._applyCdmVisualizations(c,p,t);await this._applyCdmPages(c,a,p,t);await this._filterAppDataByIntent(p,r);this._applyCdmApplications(c,p,t);return o(p)};g.prototype._filterAppDataByIntent=async function(t,e){const i=Object.keys(t).map(t=>p.isIntentUrlAsync(t).then(e=>e?t:null));const a=await Promise.all(i);const n=a.filter(t=>!!t);if(n.length===0){return}const s=500;let o=0;let l=s;const r=[];while(o<n.length){r.push(n.slice(o,l));o=o+s;l=l+s}return r.reduce((i,a)=>i.then((t=>{u.setPerformanceMark("FLP-Search-IntentPackageStart");return e.isIntentSupported(t)}).bind(null,a)).then(e=>{Object.keys(e).forEach(i=>{if(!e[i].supported&&t[i]){delete t[i]}})}).catch(()=>{}),Promise.resolve())};g.prototype._applyCdmApplications=function(t,e,a){const n={};Object.keys(e).forEach(a=>{try{const n=e[a].visualizations;const s=n.find(t=>t.target.appId&&t.target.inboundId);if(s){const o=t.applications[s.target.appId];const l=i.getInbound(o,s.target.inboundId);e[a]=this._buildAppDataFromAppAndInbound(o,l);e[a].visualizations=n;e[a].target=n[0].target}else{e[a]=this._buildAppDataFromViz(n[0]);e[a].visualizations=n;e[a].target=n[0].target}}catch(t){c.error(`Could not get search data from application ${a}`,t)}});if(a.includeAppsWithoutVisualizations){o(e).forEach(t=>{n[t.id]=t});o(t.applications).forEach(t=>{const a=i.getId(t);const s=o(i.getInbounds(t));const l=s.length>0?s[0]:undefined;if(!n.hasOwnProperty(a)){e[a]=this._buildAppDataFromAppAndInbound(t,l,true)}})}};g.prototype._applyCdmVisualizations=async function(t,e,i){for(const a in t.visualizations){try{const s={vizId:a,displayFormatHint:d.Standard};const o=await n.getVizData(t,s);const l=o.targetURL;if(i.enableVisualizationPreview){this._changeVizType(o);o.preview=true}if(l){if(e[l]){e[l].visualizations.push(o)}else{e[l]={visualizations:[o]}}}}catch(t){c.error(`Could not get search data from visualization ${a}`,t)}}};g.prototype._applyCdmPages=async function(t,e,i,s){for(const o of e){const e=a.getVisualizationReferences(o);for(let a of e){try{if(a.displayFormatHint&&a.displayFormatHint!==d.Standard){a=Object.assign({},a);a.displayFormatHint=d.Standard}const e=await n.getVizData(t,a);const o=e.targetURL;if(s.enableVisualizationPreview){this._changeVizType(e);e.preview=true}if(o){if(i[o]){i[o].visualizations.push(e)}else{i[o]={visualizations:[e]}}}}catch(t){c.error(`Could not get search data from vizReference ${a.id}`,t)}}}};g.prototype._changeVizType=function(t){if(t._instantiationData.platform==="CDM"&&!r.isStandardVizType(t.vizType)){t.vizType="sap.ushell.StaticAppLauncher";t._instantiationData.vizType={"sap.ui5":{componentName:"sap.ushell.components.tiles.cdm.applauncher"}}}};g.prototype._buildAppDataFromAppAndInbound=function(t,e,a){e=e||{};const n=i.getId(t);const o={id:n,title:e.title||i.getTitle(t),subtitle:e.subTitle||i.getSubTitle(t),icon:e.icon||i.getIcon(t),info:e.info||i.getInfo(t),keywords:e.keywords||i.getKeywords(t),technicalAttributes:i.getTechnicalAttributes(t),visualizations:[]};let l;if(a){l=s.toHashFromInbound(e,n);if(l){o.targetURL=`#${l}`}}return o};g.prototype._buildAppDataFromViz=function(t){return{id:t.vizId,title:t.title,subtitle:t.subtitle,icon:t.icon,info:t.info,keywords:t.keywords,technicalAttributes:t.technicalAttributes,target:t.target,visualizations:[t]}};g.prototype._buildVizDataFromLaunchPageTile=function(t,e,i){let a;if(i.getCatalogTileTargetURL(t)&&i.isTileIntentSupported(t)){a={id:i.getTileId(t)||i.getCatalogTileId(t),vizId:i.getCatalogTileId(t)||i.getTileId(t)||"",vizType:"",title:i.getCatalogTilePreviewTitle(t)||i.getCatalogTileTitle(t)||i.getTileTitle(t)||"",subtitle:i.getCatalogTilePreviewSubtitle(t)||"",icon:i.getCatalogTilePreviewIcon(t)||"sap-icon://business-objects-experience",info:i.getCatalogTilePreviewInfo(t)||"",keywords:i.getCatalogTileKeywords(t)||[],technicalAttributes:i.getCatalogTileTechnicalAttributes(t)||[],target:{type:"URL",url:i.getCatalogTileTargetURL(t)},targetURL:i.getCatalogTileTargetURL(t)};a._instantiationData={platform:"LAUNCHPAGE",launchPageTile:t};if(t.getContract){t.getContract("preview").setEnabled(e.enableVisualizationPreview)}if(e.enableVisualizationPreview){if(!t.getChip){a._instantiationData={platform:"CDM",vizType:{"sap.ui5":{componentName:"sap.ushell.components.tiles.cdm.applauncher"}}}}}}return a};g.hasNoAdapter=true;return g},true);
//# sourceMappingURL=SearchableContent.js.map