// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/base/util/extend","sap/base/util/isEmptyObject","sap/base/util/ObjectPath","sap/ui/thirdparty/jquery"],(e,r,i,o,t,jQuery)=>{"use strict";function s(){}s.prototype._getItemIndex=function(e,r){let i;for(i=0;i<e.length;i++){if(e[i].id===r){break}}i=i>=e.length?-1:i;return i};s.prototype._applyRenameGroup=function(e,r,i){let o;let t=false;if(!r){return false}if(e&&i&&i.groups&&i.groups[e]){o=i.groups[e];if(o.identification&&o.identification.title){i.groups[e].identification.title=r;t=true}}return t};s.prototype._applyGroupVisibility=function(e,r,i){let o=false;if(r===undefined){return false}if(e&&i&&i.groups&&i.groups[e]){i.groups[e].identification.isVisible=r;o=true}return o};s.prototype.mixinPersonalization=function(e,r){const i=new jQuery.Deferred;const t=this;if(!r||o(r)){return i.resolve(e).promise()}if(r.groups){Object.keys(r.groups).forEach(i=>{const o=r.groups[i];if(e.groups[i]){if(o.identification){if(o.identification.title){t._applyRenameGroup(i,o.identification.title,e)}if(o.identification.hasOwnProperty("isVisible")&&o.identification.isVisible===false){t._applyGroupVisibility(i,false,e)}}}})}this._applyAddGroups(e,r);if(r.removedGroups&&Array.isArray(r.removedGroups)){r.removedGroups.forEach(r=>{t._applyRemoveGroup(e,r)})}this._applyMoveGroup(e,r);this._applyItemChanges(e,r);this._applyTileSettings(e,r);return i.resolve(e).promise()};s.prototype._applyAddGroups=function(e,i){const o=[];e.site=e.site||{};e.site.payload=e.site.payload||{};e.site.payload.groupsOrder=e.site.payload.groupsOrder||[];e.groups=e.groups||{};if(Array.isArray(i.groupOrder)){e.site.payload.groupsOrder.forEach(e=>{if(i.groupOrder.indexOf(e)===-1){if(i.removedGroups&&i.removedGroups.indexOf(e)===-1||!i.removedGroups){o.push(e)}}})}if(Array.isArray(i.groupOrder)&&i.addedGroups&&Object.keys(i.addedGroups).length>0){Object.keys(i.addedGroups).forEach(o=>{e.groups[o]=r(i.addedGroups[o],20);e.groups[o].payload.isPreset=false});e.site.payload.groupsOrder=i.groupOrder}o.forEach(r=>{e.site.payload.groupsOrder.push(r)})};s.prototype._checkRenameGroup=function(e,r,i,o){if(e&&r&&i){if(i[e]){if(r[e].identification.title!==i[e].identification.title){o=o||{};o.groups=o.groups||{};o.groups[e]=o.groups[e]||{};o.groups[e].identification=o.groups[e].identification||{};o.groups[e].identification.title=r[e].identification.title}}}return o};s.prototype._applyTileSettings=function(e,r){if(!r.modifiedTiles){return}const i=Object.keys(e.groups).map(function(e){return this[e]},e.groups);const o=Object.keys(r.modifiedTiles).map(function(e){return this[e]},r.modifiedTiles);i.some(e=>{["tiles","links"].forEach(r=>{if(e.payload[r]){e.payload[r].some(e=>{let r;o.some((i,o)=>{if(i.id===e.id){if(i.title!==undefined){e.title=i.title}if(i.subTitle!==undefined){e.subTitle=i.subTitle}if(i.info!==undefined){e.info=i.info}if(i.displayFormatHint!==undefined){e.displayFormatHint=i.displayFormatHint}r=o;return true}return false});if(r!==undefined){o.splice(r,1)}return o.length===0})}});return o.length===0})};s.prototype._checkGroupVisibility=function(e,r,i,o){if(e&&r&&i){if(i[e]){if(r[e].identification.isVisible!==i[e].identification.isVisible&&typeof r[e].identification.isVisible==="boolean"){o=o||{};o.groups=o.groups||{};o.groups[e]=o.groups[e]||{};o.groups[e].identification=o.groups[e].identification||{};o.groups[e].identification.isVisible=r[e].identification.isVisible}}}return o};s.prototype._addGroupToPersonalizationDelta=function(e,r,o){let t=false;let s;let a;if(e&&e.site&&e.site.payload&&e.site.payload.groupsOrder&&e.groups&&o&&e.groups[o]&&r){s=e.site.payload.groupsOrder;a=e.groups[o];r.addedGroups=r.addedGroups||{};r.addedGroups[o]={};r.addedGroups[o].identification=i({},a.identification);r.addedGroups[o].payload=i({},a.payload);r.addedGroups[o].payload.tiles=[];r.addedGroups[o].payload.links=[];r.groupOrder=s;t=true}return t};s.prototype.extractPersonalization=function(e,r){const i=new jQuery.Deferred;let t;const s={};let a;let l;const p=this;if(e&&e.groups&&r&&r.groups){t=e.groups;a=r.groups;l=this._getExtractHelperObject(r,e,s);Object.keys(a).forEach(i=>{p._checkRemoveGroup(e,s,i);p._extractFromOriginalSiteOneGroup(r,l,i,"tiles");p._extractFromOriginalSiteOneGroup(r,l,i,"links")});Object.keys(t).forEach(r=>{if(a[r]){p._checkRenameGroup(r,t,a,s);p._checkGroupVisibility(r,t,a,s)}else{p._addGroupToPersonalizationDelta(e,s,r)}p._extractFromPersonalizedSiteOneGroup(e,l,r,"tiles");p._extractFromPersonalizedSiteOneGroup(e,l,r,"links")});this._checkMoveGroup(e,r,s);this._cleanupRemovedGroups(r,s);if(l.oPersonalizationDelta.movedTiles&&o(l.oPersonalizationDelta.movedTiles)){delete l.oPersonalizationDelta.movedTiles}if(l.oPersonalizationDelta.movedLinks&&o(l.oPersonalizationDelta.movedLinks)){delete l.oPersonalizationDelta.movedLinks}}if(r._version){s._version=r._version}return i.resolve(s).promise()};s.prototype._checkRemoveGroup=function(e,r,i){let o=false;if(e&&e.groups&&r&&i){if(!e.groups[i]){r.removedGroups=r.removedGroups||[];r.groupOrder=r.groupOrder||[];if(r.removedGroups.indexOf(i)===-1){r.removedGroups.push(i)}if(e.site&&e.site.payload&&e.site.payload.groupsOrder&&Array.isArray(e.site.payload.groupsOrder)){r.groupOrder=e.site.payload.groupsOrder.slice(0)}}o=true}return o};s.prototype._applyRemoveGroup=function(e,r){let i;let o;let t;if(e&&e.groups&&e.site&&e.site.payload&&e.site.payload.groupsOrder&&r){i=e.groups;o=e.site.payload.groupsOrder;t=o.indexOf(r);if(!(t===-1)){o.splice(t,1);delete i[r];return true}}return false};s.prototype._checkMoveGroup=function(e,r,i){let o;let t;let s=false;let a=false;if(e.site&&e.site.payload&&Array.isArray(e.site.payload.groupsOrder)&&r.site&&r.site.payload&&Array.isArray(r.site.payload.groupsOrder)){o=e.site.payload.groupsOrder;t=r.site.payload.groupsOrder;if(o.length===t.length){s=function(){let e=false;let r;for(r=0;r<t.length;r++){if(t[r]!==o[r]){e=true;break}}return e}();if(s){i.groupOrder=o;a=true}}}return a};s.prototype._applyMoveGroup=function(e,r){let i=false;if(Array.isArray(r.groupOrder)){e.site=e.site||{};e.site.payload=e.site.payload||{};if(!Array.isArray(e.site.payload.groupsOrder)){e.site.payload.groupsOrder=[]}if(e.site.payload.groupsOrder.length===r.groupOrder.length){e.site.payload.groupsOrder=r.groupOrder;i=true}}return i};s.prototype._getHashedItemsFromSite=function(e){let r=null;if(e&&e.groups){if(Object.keys(e.groups).length>0){r={};Object.keys(e.groups).forEach(i=>{const o=e.groups[i];let t;r[i]={};if(o.payload){["tiles","links"].forEach(e=>{r[i][e]={};if(Array.isArray(o.payload[e])){t=o.payload[e];t.forEach((o,t)=>{let s;if(o&&o.id){s=o.id;r[i][e][s]={iIndex:t,sItemId:o}}})}})}})}}return r};s.prototype._getExtractHelperObject=function(e,r,i){let o=null;o={};o.oHashedItemsOriginal=this._getHashedItemsFromSite(e)||{};o.oHashedItemsPersonalized=this._getHashedItemsFromSite(r);o.oPersonalizationDelta=i;return o};s.prototype._extractFromOriginalSiteOneGroup=function(e,r,i,o){let t=false;let s;let a;let l="movedTiles";o=o||"tiles";if(o!=="tiles"){l="movedLinks"}function p(e,r){a[e]=a[e]?a[e]:{};a[e].fromGroup=r;a[e].toGroup=null}if(r&&r.oHashedItemsPersonalized&&r.oPersonalizationDelta&&e&&e.groups&&e.groups[i]&&e.groups[i].payload&&Array.isArray(e.groups[i].payload[o])){s=e.groups[i].payload[o];r.oPersonalizationDelta[l]=r.oPersonalizationDelta[l]?r.oPersonalizationDelta[l]:{};a=r.oPersonalizationDelta[l];if(r.oHashedItemsPersonalized[i]){s.forEach(e=>{if(!r.oHashedItemsPersonalized[i][o][e.id]){p(e.id,i)}});t=true}else{s.forEach(e=>{p(e.id,i)});t=true}}return t};s.prototype._extractPersonalizationDeltaForTile=function(e,r,i,s){const a=t.get(["oHashedItemsOriginal",i,s,e.id,"sItemId"],r);if(!a){return false}const l={};if(e.title!==a.title){l.title=e.title}if(e.subTitle!==a.subTitle){l.subTitle=e.subTitle}if(e.info!==a.info){l.info=e.info}if(e.displayFormatHint!==a.displayFormatHint&&!(e.displayFormatHint==="default"&&!a.displayFormatHint)){l.displayFormatHint=e.displayFormatHint}if(o(l)){return false}if(!r.oPersonalizationDelta.modifiedTiles){r.oPersonalizationDelta.modifiedTiles={}}const p=r.oPersonalizationDelta.modifiedTiles;l.id=e.id;p[e.id]=l;return true};s.prototype._extractFromPersonalizedSiteOneGroup=function(r,i,o,t){let s=false;let a;let l;let p=false;let n;const u=this;let d="movedTiles";t=t||"tiles";if(t!=="tiles"&&t!=="links"){return s}if(t!=="tiles"){d="movedLinks"}if(i&&i.oPersonalizationDelta&&r&&r.groups&&r.groups[o]&&r.groups[o].payload&&Array.isArray(r.groups[o].payload[t])){n=r.groups[o].payload[t];i.oPersonalizationDelta[d]=i.oPersonalizationDelta[d]?i.oPersonalizationDelta[d]:{};a=i.oPersonalizationDelta[d];l=[];n.forEach((r,s)=>{if(!r){return}l.push(r.id);if(i.oHashedItemsOriginal[o]&&i.oHashedItemsOriginal[o][t][r.id]){if(a[r.id]){e.error("Extract personalization failed",`The Tile ID ${r.id} is not unique in the site`,"PersonalizationProcessor");delete a[r.id]}if(i.oHashedItemsOriginal[o][t][r.id].iIndex!==s){p=true}u._extractPersonalizationDeltaForTile(r,i,o,t)}else{p=true;if(a[r.id]){if(a[r.id].fromGroup&&a[r.id].fromGroup!==o){if(!a[r.id].toGroup){a[r.id].toGroup=o;u._extractPersonalizationDeltaForTile(r,i,a[r.id].fromGroup,t)}}}else{a[r.id]={};a[r.id].fromGroup=null;a[r.id].toGroup=o;a[r.id].item=r}}});if(p){i.oPersonalizationDelta.groups=i.oPersonalizationDelta.groups||{};i.oPersonalizationDelta.groups[o]=i.oPersonalizationDelta.groups[o]||{};i.oPersonalizationDelta.groups[o].payload=i.oPersonalizationDelta.groups[o].payload||{};if(t==="tiles"){i.oPersonalizationDelta.groups[o].payload.tileOrder=l}else{i.oPersonalizationDelta.groups[o].payload.linkOrder=l}}s=true}return s};s.prototype._cleanupRemovedGroups=function(e,r){let i;let o;if(r.removedGroups&&r&&Array.isArray(r.removedGroups)&&r.removedGroups.length>0){r.removedGroups.forEach(t=>{if(e&&e.groups&&e.groups[t]&&e.groups[t].payload){[{sType:"tiles",sPersonalizationDeltaType:"movedTiles"},{sType:"links",sPersonalizationDeltaType:"movedLinks"}].forEach(s=>{if(Array.isArray(e.groups[t].payload[s.sType])){i=e.groups[t].payload[s.sType];i.forEach(e=>{if(r[s.sPersonalizationDeltaType]){o=r[s.sPersonalizationDeltaType][e.id];if(o&&o.fromGroup&&o.fromGroup===t&&!o.toGroup){delete r[s.sPersonalizationDeltaType][e.id]}}})}})}})}};s.prototype._setItemOrderOnSiteCollection=function(e,r){let i=true;const o=e.length;const t={};let s;let a;let l;let p;if(!Array.isArray(e)||!Array.isArray(e)||e.length!==r.length){return false}const n=e.splice(0,e.length);for(s=0;s<r.length;s++){l=r[s];a=n.shift();if(a&&l===a.id){e.push(a)}else if(t[l]){e.push(t[l]);delete t[l];if(a){t[a.id]=a}}else if(a){t[a.id]=a;p=false;while(n.length>0){a=n.shift();if(l===a.id){e.push(a);p=true;break}else{t[a.id]=a}}if(!p){i=false}}}if(e.length!==o){i=false}return i};s.prototype._setItemOrderOnSiteGroupForItemType=function(e,r,i){let o=true;let t;let s;if(i==="tiles"||i==="links"){s=i==="tiles"?"tileOrder":"linkOrder"}else{return false}if(r.payload&&Array.isArray(r.payload[s])&&r.payload[s].length>0){if(e.payload&&Array.isArray(e.payload[i])&&e.payload[i].length>0){t=this._setItemOrderOnSiteCollection(e.payload[i],r.payload[s]);if(!t){o=false}}else{o=false}}return o};s.prototype._setItemOrderOnSite=function(e,r){let i=true;let o;const t=this;if(e.groups&&r.groups){Object.keys(r.groups).forEach(s=>{if(r.groups[s]&&e.groups[s]){o=t._setItemOrderOnSiteGroupForItemType(e.groups[s],r.groups[s],"tiles");if(!o){i=false}o=t._setItemOrderOnSiteGroupForItemType(e.groups[s],r.groups[s],"links");if(!o){i=false}}})}return i};s.prototype._applyMoveItemsWithoutOrder=function(e,r,i){let t=true;let s;let a;let l="tileOrder";let p;let n;let u;let d=[];const f=this;function y(o,t){let s=true;if(e.groups[t]&&e.groups[t].payload&&r.groups&&r.groups[t]&&r.groups[t].payload&&Array.isArray(r.groups[t].payload[l])&&r.groups[t].payload[l].length>0){if(!Array.isArray(e.groups[t].payload[i])){e.groups[t].payload[i]=[]}e.groups[t].payload[i].push(o)}else{s=false}return s}if(i==="tiles"||i==="links"){a=i==="tiles"?"movedTiles":"movedLinks";l=i==="tiles"?"tileOrder":"linkOrder"}else{return false}if(!e||!e.groups||!e.site||!e.site.payload||!Array.isArray(e.site.payload.groupsOrder)||!r){return false}if(r[a]){Object.keys(r[a]).forEach(l=>{p=r[a][l];if(p.fromGroup){if(p.toGroup){if(p.fromGroup!==p.toGroup){if(e.groups[p.fromGroup]&&e.groups[p.fromGroup].payload&&Array.isArray(e.groups[p.fromGroup].payload[i])){d=e.groups[p.fromGroup].payload[i];n=f._getItemIndex(d,l);if(n>=0){u=d.splice(n,1);s=y(u[0],p.toGroup);if(!s){t=false}}else{t=false}}else{t=false}}else{t=false}}else if(e.groups[p.fromGroup]&&e.groups[p.fromGroup].payload&&Array.isArray(e.groups[p.fromGroup].payload[i])){d=e.groups[p.fromGroup].payload[i];n=f._getItemIndex(d,l);if(n>=0){d.splice(n,1)}else{t=false}}else{t=false}}else if(p.toGroup){if(p.item&&!o(p.item)){s=y(p.item,p.toGroup);if(!s){t=false}}else{t=false}}else{t=false}})}return t};s.prototype._applyItemChanges=function(e,r){let i=true;let o;o=this._applyMoveItemsWithoutOrder(e,r,"tiles");if(!o){i=false}o=this._applyMoveItemsWithoutOrder(e,r,"links");if(!o){i=false}if(r.groups){o=this._setItemOrderOnSite(e,r);if(!o){i=false}}return i};return s});
//# sourceMappingURL=PersonalizationProcessor.js.map