// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/services/_Personalization/utils","sap/ushell/services/_Personalization/constants.private","sap/ui/core/format/DateFormat","sap/ui/core/UIComponent","sap/ui/thirdparty/jquery","sap/base/Log"],(e,t,n,i,o,jQuery,r)=>{"use strict";function a(){this._init.apply(this,arguments)}a.prototype._init=function(n,i,r,a,s){this._oService=n;this._sContainerKey=r;this._oAdapterContainer={};this._oScope=a||t.adjustScope(a);this._aLoadedKeys=[];this._oUnmodifiableContainer=undefined;let p;if(!(s instanceof o)&&s!==undefined){throw new Error("oComponent passed must be a UI5 Component or must be undefined")}if(s&&s.getMetadata&&s.getMetadata().getComponentName){p=s.getMetadata().getComponentName()}this.clear();if(!this._sContainerKey||typeof this._sContainerKey!=="string"){throw new e.Error("Invalid container key: sap.ushell.services.Personalization"," ")}this._oAdapterContainer=i.getAdapterContainer(this._sContainerKey,this._oScope,p);return this};a.prototype.getValidity=function(){return this._oScope.validity};a.prototype._getValidity=function(){return this._oScope.validity};a.prototype.clear=function(){this._oItemMap={};this._aLoadedItemKeys=[];this._clear=true;this._oItemMap=new e.Map};a.prototype.load=function(){let t={};const n=this;t=new jQuery.Deferred;if(!this._sContainerKey){throw new e.Error("Invalid container key: sap.ushell.services.Personalization"," ")}this.clear();const i=this._oService._pendingContainerOperations_flushAddNext(this._sContainerKey,t);i.always(()=>{n._oAdapterContainer.load().fail(e=>{t.reject(e)}).done(()=>{n._copyFromAdapter();if(n._isExpired()){n.clear()}t.resolve()})});return t.promise()};a.prototype._copyFromAdapter=function(){const e=this;const t=e._oAdapterContainer.getItemKeys().splice(0);t.forEach(t=>{e._oItemMap.put(t,JSON.stringify(e._oAdapterContainer.getItemValue(t)))});this._aLoadedItemKeys=e._oItemMap.keys().splice(0)};a.prototype._isExpired=function(){if(this._getValidity()===Infinity||this._getValidity()===0){return false}const e=this._getItemValueInternal(n.S_ADMIN_PREFIX,n.S_ITEMKEY_EXPIRE);const t=i.getDateInstance({pattern:n.S_ABAPTIMESTAMPFORMAT});const o=t.format(this._getNow(),true);return e&&o>e};a.prototype._getNow=function(){return new Date};a.prototype._copyToAdapterUpdatingValidity=function(){let e=[];let o=[];const r=this;let a;let s;let p;let _;if(this._clear){e=this._oAdapterContainer.getItemKeys().splice(0);e.forEach(e=>{r._oAdapterContainer.delItem(e)});this._clear=false}if(this._getValidity()===Infinity||this._getValidity()===0){this._delItemInternal(n.S_ADMIN_PREFIX,n.S_ITEMKEY_SCOPE);this._delItemInternal(n.S_ADMIN_PREFIX,n.S_ITEMKEY_EXPIRE);this._delItemInternal(n.S_ADMIN_PREFIX,n.S_ITEMKEY_STORAGE)}else{s=i.getDateInstance({pattern:n.S_ABAPTIMESTAMPFORMAT});a=this._getNow();_=s.format(a,true);p=s.format(new Date(a.getTime()+this._getValidity()*6e4),true);this._setItemValueInternal(n.S_ADMIN_PREFIX,n.S_ITEMKEY_SCOPE,this._oScope);this._setItemValueInternal(n.S_ADMIN_PREFIX,n.S_ITEMKEY_EXPIRE,p);this._setItemValueInternal(n.S_ADMIN_PREFIX,n.S_ITEMKEY_STORAGE,_)}e=this._oItemMap.keys();e.forEach(e=>{r._oAdapterContainer.setItemValue(e,t.cloneToObject(r._oItemMap.get(e)))});o=this._aLoadedItemKeys.filter(t=>!(e.indexOf(t)>-1));o.forEach(e=>{r._oAdapterContainer.delItem(e)})};a.prototype.save=function(){const e=this;this._copyToAdapterUpdatingValidity();const t=new jQuery.Deferred;const n=this._oService._pendingContainerOperations_cancelAddNext(this._sContainerKey,t);n.always(()=>{try{e._oAdapterContainer.save().fail(e=>{t.reject(e)}).done(()=>{t.resolve()})}catch(e){t.reject(e)}});return t.promise()};a.prototype.saveDeferred=function(e){const t=this;this._copyToAdapterUpdatingValidity();const n=new jQuery.Deferred;const i=this._oService._pendingContainerOperations_cancelAddNext(this._sContainerKey,n);function o(){i.always(()=>{try{t._oAdapterContainer.save().fail(e=>{n.reject(e)}).done(()=>{n.resolve()})}catch(e){n.reject(e)}})}n._sapFnSave=o;n._sapTimeoutId=setTimeout(o,e);return n.promise()};a.prototype.flush=function(){this._copyToAdapterUpdatingValidity();const e=new jQuery.Deferred;const t=this._oService._pendingContainerOperations_flushAddNext(this._sContainerKey,e);t.fail(t=>{e.reject(t)}).done(()=>{e.resolve()});return e.promise()};a.prototype.getItemKeys=function(){const e=this._oItemMap.keys().filter(e=>e.indexOf(n.S_ITEM_PREFIX)===0);return e.map(e=>e.replace(n.S_ITEM_PREFIX,"",""))};a.prototype._getInternalKeys=function(){return this._oItemMap.keys().splice(0)};a.prototype.getItemValue=function(e){return this._getItemValueInternal(n.S_ITEM_PREFIX,e)};a.prototype._getItemValueInternal=function(e,n){if(typeof n!=="string"||typeof e!=="string"){return undefined}return t.cloneToObject(this._oItemMap.get(e+n))};a.prototype.containsItem=function(e){if(typeof e!=="string"){return undefined}return this._oItemMap.containsKey(n.S_ITEM_PREFIX+e)};a.prototype.setItemValue=function(e,t){this._setItemValueInternal(n.S_ITEM_PREFIX,e,t)};a.prototype._setItemValueInternal=function(t,n,i){if(typeof n!=="string"||typeof t!=="string"){throw new e.Error("Parameter value of sItemKey or sItemValue is not a string: sap.ushell.services.Personalization"," ")}if(n.length>40){r.error(`Personalization Service item key/variant set name ("${n}") should be less than 40 characters [current :${n.length}]`)}this._oItemMap.put(t+n,JSON.stringify(i))};a.prototype.delItem=function(e){this._delItemInternal(n.S_ITEM_PREFIX,e)};a.prototype._delItemInternal=function(e,t){if(typeof t!=="string"){return undefined}if(typeof e!=="string"){return undefined}this._oItemMap.remove(e+t)};a.prototype.getKey=function(){return this._sContainerKey.substring(n.S_CONTAINER_PREFIX.length)};a.prototype.getUnmodifiableContainer=function(){const t=this;if(!this._oUnmodifiableContainer){this._oUnmodifiableContainer=function(){const n={};["clear","delItem","flush","load","save","saveDeferred","setItemValue"].forEach(t=>{n[t]=function(t){throw new e.Error(`Function ${t} can't be called on unmodifiable container`,"ContextContainer"," ")}.bind(undefined,t)});["containsItem","getItemKeys","getItemValue","getUnmodifiableContainer"].forEach(e=>{if(t[e]){n[e]=t[e].bind(t)}});return n}()}return this._oUnmodifiableContainer};return a});
//# sourceMappingURL=ContextContainer.js.map