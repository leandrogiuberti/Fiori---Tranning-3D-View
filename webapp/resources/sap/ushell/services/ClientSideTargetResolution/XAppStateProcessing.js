// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/ClientSideTargetResolution/Utils","sap/base/util/ObjectPath","sap/base/util/isEmptyObject","sap/base/util/isPlainObject","sap/fe/navigation/SelectionVariant","sap/base/Log","sap/ushell/utils"],(e,t,a,n,r,s,i)=>{"use strict";function o(e){return e.oNewAppStateMembers&&!a(e.oNewAppStateMembers)}function u(e){return e.inbound&&e.inbound.signature&&e.inbound.signature.parameters&&Object.keys(e.inbound.signature.parameters).some(t=>!!e.inbound.signature.parameters[t].renameTo)}function l(e){e.defaultedParamNames=e.defaultedParamNames.filter(t=>{if(e.intentParamsPlusAllDefaults[t]&&!Array.isArray(e.intentParamsPlusAllDefaults[t])){if(!(e.resolutionResult.oNewAppStateMembers&&e.resolutionResult.oNewAppStateMembers[t])){return false}}return true})}function m(e){const a=t.get("inbound.signature.parameters",e)||{};const n={};e.defaultedParamNames.forEach(e=>{const t=a[e]&&a[e].renameTo||e;if(n[t]){s.error(`renaming of defaultedParamNames creates duplicates${e}->${t}`)}else{n[t]=true}});e.mappedDefaultedParamNames=Object.keys(n).sort()}function c(e){l(e);m(e);delete e.resolutionResult.oNewAppStateMembers}async function p(e,t){const a=await i.promisify(e.getAppState(t));return a.getData()}function d(e){return e===undefined||n(e)}function f(e,t){return Array.isArray(e)&&e.some(e=>t.indexOf(e)!==-1)}function g(e,t){if(e&&e.selectionVariant){const a=new r(JSON.stringify(e.selectionVariant));const n=a.getSelectOptionsPropertyNames()||[];const s=a.getParameterNames()||[];if(f(n,t)||f(s,t)){return true}}return false}function P(e,t,a,n){const i=new r;const o=e.getParameterNames()||[];const u=e.getSelectOptionsPropertyNames()||[];let l;let m;o.forEach(r=>{l=e.getParameter(r);if(n&&!a[r]){t.deleted=true;return}if(a[r]&&a[r].renameTo){if(i.getParameter(a[r].renameTo)===undefined&&i.getSelectOption(a[r].renameTo)===undefined){i.addParameter(a[r].renameTo,l);t.changed=true}else{s.error(`renaming of appstate creates duplicates ${r}->${a[r].renameTo}`)}}else if(i.getParameter(r)===undefined&&i.getSelectOption(r)===undefined){i.addParameter(r,l)}});u.forEach(r=>{m=e.getSelectOption(r);if(n&&!a[r]){t.deleted=true;return}if(a[r]&&a[r].renameTo){if(i.getSelectOption(a[r].renameTo)===undefined&&i.getParameter(a[r].renameTo)===undefined){i.massAddSelectOption(a[r].renameTo,m);t.changed=true}else{s.error(`renaming of appstate creates duplicates ${r}->${a[r].renameTo}`)}}else if(i.getSelectOption(r)===undefined&&i.getParameter(r)===undefined){i.massAddSelectOption(r,m)}});o.forEach(t=>{e.removeParameter(t)});u.forEach(t=>{e.removeSelectOption(t)});i.getParameterNames().forEach(t=>{e.addParameter(t,i.getParameter(t))});i.getSelectOptionsPropertyNames().forEach(t=>{e.massAddSelectOption(t,i.getSelectOption(t))});return e}async function S(e,t){const a=e.getData()||{};let n;const s={};const u=t.inbound.signature;const l=t.resolutionResult;if(a.selectionVariant){n=new r(JSON.stringify(a.selectionVariant))}else{n=new r}if(o(l)){Object.keys(l.oNewAppStateMembers).forEach(e=>{n.massAddSelectOption(e,l.oNewAppStateMembers[e].Ranges)})}const m=u.additionalParameters==="ignored";n=P(n,s,u.parameters,m);if(n.getParameterNames().length!==0||n.getSelectOptionsPropertyNames().length!==0||s.deleted){a.selectionVariant=n.toJSONObject()}if(!s.changed&&!s.deleted&&!o(l)){c(t);return}e.setData(a);await i.promisify(e.save());t.intentParamsPlusAllDefaults["sap-xapp-state"]=[e.getKey()];t.mappedIntentParamsPlusSimpleDefaults["sap-xapp-state"]=[e.getKey()];c(t)}async function b(t,a){let n;const r=t.resolutionResult;const s=t.inbound&&(t.inbound.signature||{});const i=o(r)||s.additionalParameters==="ignored"||u(t);if(!i){c(t);return t}const l=t.intentParamsPlusAllDefaults["sap-xapp-state"]&&t.intentParamsPlusAllDefaults["sap-xapp-state"][0];if(l){const i=await p(a,l);if(d(i)){if(o(r)){const t=e.constructParameterDominatorMap(s.parameters);Object.keys(r.oNewAppStateMembers).forEach(e=>{const a=t[e].dominatedBy;if(g(i,a)){delete r.oNewAppStateMembers[e]}})}const l=s.additionalParameters==="ignored";if(!o(r)&&!u(t)&&!l){c(t);return t}n=a.createEmptyAppState(undefined,true);if(n){n.setData(i);await S(n,t);return t}}else{delete r.oNewAppStateMembers;c(t);return t}}if(o(r)){const e=a.createEmptyAppState(undefined,true);await S(e,t);return t}c(t);return t}return{mixAppStateIntoResolutionResultAndRename:b,_hasRenameTo:u}});
//# sourceMappingURL=XAppStateProcessing.js.map