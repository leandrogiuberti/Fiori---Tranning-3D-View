// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/fe/navigation/SelectionVariant","sap/ushell/utils","sap/ushell/Container"],(e,t,r,a,n)=>{"use strict";const i="sap.ushell.services.ClientSideTargetResolution.PrelaunchOperations";async function s(e){if(!e){return null}return n.getServiceAsync("AppState").then(t=>new Promise((r,a)=>{t.getAppState(e).done(e=>{r(e)}).fail(e=>{a(e)})}))}async function o(e,t,r,i,s){if(e.startupParametersModified){t.mappedIntentParamsPlusSimpleDefaults=i}if(e.defaultedParameterNamesModified){t.mappedDefaultedParamNames=s}if(e.selectionVariantModified){const e=await n.getServiceAsync("AppState");const i=e.createEmptyAppState(undefined,true);i.setData({selectionVariant:r.toJSONObject()});await a.promisify(i.save());t.mappedIntentParamsPlusSimpleDefaults["sap-xapp-state"]=[i.getKey()]}return Promise.resolve(t)}function l(e){const t=e.type;switch(t){case"merge":case"split":return`${t} - source: ${e.source} & target: ${e.target}`;case"delete":return`${t} - target: ${e.target}`;default:return""}}function u(e,t){if(t.getSelectOption(e)){return t.getSelectOption(e)[0].Low}return undefined}function c(e,t){if(t.getSelectOption(e)){return t.getSelectOption(e)[0].High}return undefined}function d(e,t){if(t[e]){return t[e][0]}return undefined}function p(e,t,r){const a=e.source[0];const n=e.source[1];const i=u(a,t);const s=u(n,t);const o=d(a,r);const l=d(n,r);let c;let p;const f=e.target;function m(e,t){if(t===undefined||e===t){return e}return undefined}if(i&&s){c=m(i,o);p=m(s,l)}else if(o&&l){c=m(o,i);p=m(l,s)}if(c&&p&&!t.getSelectOption(f)&&!r.hasOwnProperty(f)){t.addSelectOption(f,"I","BT",c,p);return{selectionVariantModified:true,startupParametersModified:false,defaultedParameterNamesModified:false}}return{}}function f(t,r,a){const n=t.target;const i=t.source;if(!r.getSelectOption(i)){e.error(`Invalid split operation: ${i} does not exist in selection variant`);return false}if(r.getSelectOption(n[0])){e.error(`Invalid split operation: ${n[0]} already exists in selection variant`);return false}if(r.getSelectOption(n[1])){e.error(`Invalid split operation: ${n[1]} already exists in selection variant`);return false}if(a[n[0]]){e.error(`Invalid split operation: ${n[0]} already exists in startup parameters`);return false}if(a[n[1]]){e.error(`Invalid split operation: ${n[1]} already exists in startup parameters`);return false}return true}function m(e,t,r){const a=e.target;const n=e.source;const i=f(e,t,r);if(i){const e=u(n,t);const i=c(n,t);t.addSelectOption(a[0],"I","EQ",e,null);r[a[0]]=[e];t.addSelectOption(a[1],"I","EQ",i||e,null);r[a[1]]=[i||e];return{selectionVariantModified:true,startupParametersModified:true,defaultedParameterNamesModified:false}}return{}}function g(t,r,a,n){const i=t.target;const s={selectionVariantModified:false,startupParametersModified:false,defaultedParameterNamesModified:false};for(let t=0;t<i.length;t++){const o=i[t];if(o==="sap-xapp-state"){e.warning("Cannot execute delete: 'sap-xapp-state' is not allowed to be deleted");continue}if(r.getParameter(o)){r.removeParameter(o);s.selectionVariantModified=true}if(r.getSelectOption(o)){r.removeSelectOption(o);s.selectionVariantModified=true}if(a[o]){delete a[o];s.startupParametersModified=true}const l=n.indexOf(o);if(l>-1){n.splice(l,1);s.defaultedParameterNamesModified=true}}return s}function y(t){let r;if(t===""){return[]}t=t.replaceAll("“",'"');t=t.replaceAll("”",'"');try{r=JSON.parse(t)}catch(t){e.error("Cannot parse operation array: sap-prelaunch-operations should be in json format.",t);return[]}if(!Array.isArray(r)){e.error("Invalid operation array: sap-prelaunch-operations should be an array.");return[]}return r}function P(t){if(t.length===0){return null}const r={split:true,merge:true,delete:true};const a=t.filter(e=>!r[e.type]);if(a.length>0){e.error(`Invalid operation: the following sap-prelaunch-operations are invalid: ${a.join(", ")}`);return null}const n=t.some(e=>e.type==="split"&&e.target[0]===e.target[1]);if(n){e.error("Invalid operation: split operation contains the same target value. Use two different target values instead.");return null}const i=t.some(e=>{if(e.type==="split"){return!e.hasOwnProperty("source")||!e.hasOwnProperty("target")||typeof e.source!=="string"||!Array.isArray(e.target)||Object.keys(e).length!==3||Object.keys(e.target).length!==2}if(e.type==="merge"){return!e.hasOwnProperty("source")||!e.hasOwnProperty("target")||typeof e.target!=="string"||!Array.isArray(e.source)||Object.keys(e).length!==3||Object.keys(e.source).length!==2}if(e.type==="delete"){return!e.hasOwnProperty("target")||!Array.isArray(e.target)||Object.keys(e).length!==2}});if(i){e.error("Invalid operation: one or more operations are specified in an incorrect format.");return null}return t}function h(e){const t=y(e);return P(t)}function O(t,r,a,n){const s=e.getLevel()>=e.Level.DEBUG?[]:null;const o={selectionVariantModified:false,startupParametersModified:false};r.forEach(r=>{let i={};switch(r.type){case"split":i=m(r,t,a);break;case"merge":i=p(r,t,a);break;case"delete":i=g(r,t,a,n);break;default:e.error(`Invalid operation: ${r.type} prelaunch operation type is not supported`)}if(s){const e=Object.keys(i).length!==0?"✅":"❌";s.push(`${e} ${l(r)}`)}if(Object.keys(i).length===0){e.warning(`Cannot execute ${l(r)}`)}o.selectionVariantModified=o.selectionVariantModified||i.selectionVariantModified;o.startupParametersModified=o.startupParametersModified||i.startupParametersModified;o.defaultedParameterNamesModified=o.defaultedParameterNamesModified||i.defaultedParameterNamesModified});if(s){e.debug(`${i}\n${s.join("\n")}`)}return o}function v(e,a){if(!a){return Promise.resolve(e)}const n=e.mappedIntentParamsPlusSimpleDefaults;const i=e.mappedDefaultedParamNames;const l=n["sap-xapp-state"]&&n["sap-xapp-state"][0];const u=h(a);if(!u||u.length===0){return Promise.resolve(e)}return s(l).then(a=>{const s=a?a.getData():{};const l=t({},n);const c=t([],i);let d;if(s.selectionVariant){d=new r(JSON.stringify(s.selectionVariant))}else{d=new r}const p=O(d,u,l,c);return o(p,e,d,l,c)})}return{executePrelaunchOperations:v,parseAndValidateOperations:h}});
//# sourceMappingURL=PrelaunchOperations.js.map