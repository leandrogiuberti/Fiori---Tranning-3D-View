// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/services/ClientSideTargetResolution/Utils","sap/ushell/services/ClientSideTargetResolution/VirtualInbounds","sap/ushell/services/ClientSideTargetResolution/Formatter","sap/ushell/TechnicalParameters","sap/base/Log"],(e,t,n,r,a,i)=>{"use strict";const s=[undefined,"GUI","WDA","UI5"];function o(e,t){const n=e.inbound.resolutionResult;if(!n){return""}return["applicationType","ui5ComponentName","url","additionalInformation","text"].map(e=>{if(t){return n.hasOwnProperty(e)?`${e}:${n[e]}`:""}return n.hasOwnProperty(e)?n[e]:""}).join("")}function u(e){return e.sort((e,t)=>{if((e["sap-priority"]||0)-(t["sap-priority"]||0)!==0){return-((e["sap-priority"]||0)-(t["sap-priority"]||0))}if(e.priorityString<t.priorityString){return 1}if(e.priorityString>t.priorityString){return-1}const n=o(e);const r=o(t);if(n<r){return 1}else if(n>r){return-1}return 0})}function l(e,t){let n;if(e&&e["sap-priority"]&&e["sap-priority"][0]){n=parseInt(e["sap-priority"][0],10);if(!isNaN(n)){t["sap-priority"]=n}}return}function c(e,t,n,r){if(!t){return true}if(!e&&e!==""){return false}const a=t.value;if(t.format==="reference"){if(/UserDefault\.extended\./.test(a)){i.error(`Illegal inbound: extended user default '${a}' used as filter`);return false}if(n.hasOwnProperty(a)){return e===n[a]}r[a]=true;return true}if(t.format==="value"||t.format==="plain"||t.format===undefined){return e===t.value}else if(t.format==="regexp"){return!!e.match(`^${t.value}$`)}i.error("Illegal oFilter format");return false}function f(e){return e.inbound&&e.inbound.resolutionResult&&e.inbound.resolutionResult["sap.ui"]&&e.inbound.resolutionResult["sap.ui"].technology}function d(e){return e.inbound&&e.inbound.resolutionResult&&e.inbound.resolutionResult.appId}function p(e,t,n,r,a){const i={};const s={};Object.keys(e).forEach(t=>{if(t!=="sap-ushell-defaultedParameterNames"){i[t]=e[t]}});if(!t){return i}Object.keys(t).forEach(e=>{const a=t[e];let o;let u=false;if(!i[e]&&a.hasOwnProperty("defaultValue")){if(a.defaultValue.format&&a.defaultValue.format==="reference"){o=a.defaultValue.value;if(n.hasOwnProperty(o)){if(typeof n[o]==="string"){i[e]=[n[o]];u=true}else if(typeof n[o]==="object"){i[e]=n[o];u=true}}else{i[e]=[a.defaultValue];r.push(a.defaultValue.value)}}else{i[e]=[a.defaultValue.value];u=true}if(u){s[e]=true}}});Object.keys(s).sort().forEach(e=>{a.push(e)});return i}function m(e,t){e.resolutionResult={contentProviderId:t.contentProviderId};if(t&&t.resolutionResult&&t.resolutionResult.hasOwnProperty("sap.platform.runtime")){e.resolutionResult["sap.platform.runtime"]=t.resolutionResult["sap.platform.runtime"]}Object.keys(e.intentParamsPlusAllDefaults).slice(0).forEach(t=>{if(!Array.isArray(e.intentParamsPlusAllDefaults[t])){if(!e.resolutionResult.oNewAppStateMembers){e.resolutionResult.oNewAppStateMembers={}}e.resolutionResult.oNewAppStateMembers[t]=e.intentParamsPlusAllDefaults[t]}})}function h(e,t){e.forEach(e=>{t[e]=true})}function P(e){const t=e.intentParamsPlusAllDefaults["sap-ui-tech-hint"]&&e.intentParamsPlusAllDefaults["sap-ui-tech-hint"][0];const n=e.defaultedParamNames&&e.defaultedParamNames.indexOf("sap-ui-tech-hint")>=0;if(t&&f(e)===t){return n?1:2}return 0}function g(e){const t=e.intentParamsPlusAllDefaults["sap-ui-app-id-hint"]&&e.intentParamsPlusAllDefaults["sap-ui-app-id-hint"][0];if(t&&t===d(e)){return 1}return 0}function y(e){const t=f(e);const n=s.indexOf(t);return Math.max(0,n)}function b(e,t){function n(e){const t=`000${e}`;return t.substr(t.length-3)}return[`AIDM=${g(e)}`,`CURCP=${t.isCurrentContentProvider?"1":"0"}`,e.genericSO?"g":"x",`TECM=${P(e)}`,`MTCH=${n(t.countMatchingParams)}`,`MREQ=${n(t.countMatchingRequiredParams)}`,`NFIL=${n(t.countMatchingFilterParams)}`,`NDEF=${n(t.countDefaultedParams)}`,`POT=${n(t.countPotentiallyMatchingParams)}`,`RFRE=${n(999-t.countFreeInboundParams)}`,`TECP=${y(e)}`].join(" ")}function R(e,t){let n=false;if(e.signature.additionalParameters==="allowed"||e.signature.additionalParameters==="ignored"){return true}if(e.signature.additionalParameters==="notallowed"||e.signature.additionalParameters===undefined){n=Object.keys(t).every(t=>!(!e.signature.parameters[t]&&t.indexOf("sap-")!==0))}else{i.error("Unexpected value of inbound for signature.additionalParameters")}return n}function O(e,t,n,r,i){const s=e.signature.parameters;let o=0;let u=0;let l=0;let c=0;let f=false;const d={};function p(e){return!a.isTechnicalParameter(e)}const m=Object.keys(n).filter(p);const h=r.filter(p);Object.keys(s).filter(p).forEach(e=>{const r=t[e];const a=r&&r[0];const i=s[e];const f=n.hasOwnProperty(e);if(f){++o;if(i.filter){++l}if(i.required){++u}}else if(a===null||a===undefined){++c}});if(i){d.countPotentiallyMatchingParams=m.filter(e=>s.hasOwnProperty(e)).length}else{d.countPotentiallyMatchingParams=m.length}if(n&&n["sap-app-origin-hint"]&&(n["sap-app-origin-hint"][0]||n["sap-app-origin-hint"][0]==="")){const t=n["sap-app-origin-hint"][0];f=t===e.contentProviderId}d.countDefaultedParams=h.length;d.countMatchingParams=o;d.countMatchingRequiredParams=u;d.countMatchingFilterParams=l;d.countFreeInboundParams=c;d.isCurrentContentProvider=f;return d}function I(e,t,n,r,a,i){const s=Object.keys(e).every(n=>{const r=t[n];const s=r&&r[0];const o=e[n];if(o.required&&(s===null||s===undefined)){return false}if(o.filter){if(!c(s,o.filter,a,i)){return false}}return true});return s}function $(e,a,i,s,o){const u={inbound:a};function c(e,t,n){e.matches=false;e.noMatchReason=t;e.noMatchDebug=n;return e}function d(t){t.matches=true;t.matchesVirtualInbound=n.isVirtualInbound(a);t.parsedIntent=e;return t}const P=a.semanticObject==="*";u.genericSO=P;const g=e.semanticObject===undefined||e.semanticObject===a.semanticObject||P;if(!g){return c(u,`Semantic object "${e.semanticObject}" did not match`)}const y=e.action===undefined||e.action===a.action;if(!y){return c(u,`Action "${e.action}" did not match`)}const $=!a.deviceTypes||e.formFactor===undefined||a.deviceTypes[e.formFactor];if(!$){return c(u,`Form factor "${e.formFactor}" did not match`,`Inbound: [${Object.keys(a.deviceTypes).filter(e=>!!a.deviceTypes[e]).join(", ")}]`)}const M=e.params&&e.params["sap-ui-tech-hint"]&&e.params["sap-ui-tech-hint"][0];if(e.treatTechHintAsFilter&&M){const e=f({inbound:a});if(e!==M){return c(u,`Tech Hint as filter "${M}" did not match`,`Inbound: [${e}]`)}}const v=[];const D=[];const j=e.params||{};const A=p(j,a.signature&&a.signature.parameters,i,v,D);const w=A["sap-system"]&&A["sap-system"][0];const S=A["sap-app-origin"]&&A["sap-app-origin"][0];const T=a.contentProviderId;if(S&&S!==T){return c(u,`Content provider as filter "${S}" did not match`,`Inbound: [${T}]`)}if(w&&typeof T==="string"&&o&&!o[w]){return c(u,`Data origin "${w}" is not compatible with the content provider "${T}"`,`Inbound: [${Object.keys(o).join(", ")}]`)}u.intentParamsPlusAllDefaults=A;u.defaultedParamNames=D;l(A,u);const F=I(a.signature.parameters,A,j,D,i,s);if(!F){return c(u,"Inbound parameter signature did not match",r.formatInboundSignature(a.signature))}const C=t.constructParameterDominatorMap(a.signature.parameters);const N=t.findDominatedDefaultParameters(A,D,C);const x=D.filter(e=>!N[e]);const E=t.filterObjectKeys(A,e=>!N[e]);if(!R(a,E)){return c(u,"Additional parameters not allowed",r.formatInboundSignature(a.signature))}const k=a.signature.additionalParameters==="ignored";if(k){t.filterObjectKeys(E,e=>{if(e.indexOf("sap-")===0){return true}if(a.signature.parameters.hasOwnProperty(e)){return true}return false},true)}const V=O(a,A,j,D,k);m(u,a);u.intentParamsPlusAllDefaults=E;u.defaultedParamNames=x;u.priorityString=b(u,V);h(v,s);return d(u)}async function M(t,n,a,i,s){function o(e,t,n){const a=r.formatInbound(n);e[a]=t.noMatchReason+(t.noMatchDebug?`| DEBUG: ${t.noMatchDebug}`:"")}let u;if(i){u=await e.promisify(i())}const l=n.reduce((e,n)=>{const r=n.contentProviderId||"";const i=a[r]||{};if(!e.missingReferences[r]){e.missingReferences[r]={}}const l=$(t,n,i,e.missingReferences[r],u?u[r]:null);if(l.matches){e.matchResults.push(l)}else if(s){o(e.noMatchReasons,l,n)}return e},{matchResults:[],noMatchReasons:{},missingReferences:{}});return l}return{match:M,matchOne:$,sortMatchingResultsDeterministic:u,matchesFilter:c,checkAdditionalParameters:R,addDefaultParameterValues:p,extractSapPriority:l,serializeMatchingResult:o}});
//# sourceMappingURL=Search.js.map