// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/base/util/deepEqual","sap/base/util/deepExtend","sap/base/util/isEmptyObject","sap/ui/base/EventProvider","sap/ushell/utils","sap/ushell/Container"],(e,t,a,r,s,n,i,o)=>{"use strict";const u="valueStored";const l=["value","noEdit","noStore","extendedValue","alwaysAskPlugin"];function c(c,d,f,m){this._aPlugins=[];this._oUserDefaultParametersNames={};this._oWasParameterPersisted={};const h=new n;function g(e){const t=typeof e.getComponentData==="function"&&e.getComponentData()&&e.getComponentData().config&&e.getComponentData().config["sap-priority"]||0;if(typeof t!=="number"||isNaN(t)){return 0}return t}this._insertPluginOrdered=function(e,t){const a=g(t);for(let r=0;r<e.length&&t;++r){const s=g(e[r]);if(t&&a>s){e.splice(r,0,t);t=undefined}}if(t){e.push(t)}return e};this.registerPlugin=function(e){this._aPlugins=this._insertPluginOrdered(this._aPlugins,e)};this._getUserDefaultValueFromPlugin=async function(t,a,r,s){if(typeof t.getUserDefault==="function"){try{const n=await i.promisify(t.getUserDefault(a,s,r));const o=n||s;const u=this._getComponentNameOfPlugin(t);e.debug(`[UserDefaults] Fetched "${a}" for SystemContext="${r.id}" from Plugin="${u}"`,JSON.stringify(o,null,2));return o}catch{e.error(`invocation of getUserDefault("${a}") for plugin ${this._getComponentNameOfPlugin(t)} rejected.`,null,"sap.ushell.services.UserDefaultParameters")}}return s};this._iterateOverPluginsToGetDefaultValue=async function(e,t,a){await this._loadPlugins();return this._aPlugins.reduce(async(t,r)=>{const s=await t;return this._getUserDefaultValueFromPlugin(r,e,a,s)},Promise.resolve(t))};this._getStoreDate=function(){return(new Date).toString()};this._storeValue=async function(t,a,r,s){if(r&&a.extendedValue){try{const e=await o.getServiceAsync("ClientSideTargetResolution");const n=await e.getUserDefaultParameterNames(s);const i=this._extractKeyArrays(n);const u=i.extended.indexOf(t)<0;return this._saveParameterValue(t,a,r,u,s)}catch{e.error(`Cannot save value for ${t}. One or more plugins could not be loaded.`)}}return this._saveParameterValue(t,a,r,false,s)};this._saveParameterValue=async function(e,a,s,n,i){if(n){a.extendedValue=undefined}if(s&&this._valueIsEmpty(a)){a=undefined;this._oWasParameterPersisted[e]=false}else{a._shellData=r({storeDate:this._getStoreDate()},a._shellData)}try{const t=await o.getServiceAsync("UserDefaultParameterPersistence");await t.saveParameterValue(e,a,i)}catch{}const l={parameterName:e,parameterValue:t(a||{}),systemContext:i};h.fireEvent(u,l);return e};this._getPersistedValue=async function(e,t){const a=await o.getServiceAsync("UserDefaultParameterPersistence");return a.loadParameterValue(e,t)};this._valueIsEmpty=function(e){return!e||!e.value&&!e.extendedValue};this._haveSameMembersValue=function(e,t,r){return r.every(r=>e[r]===t[r]||a(e[r],t[r]))};this._getUserDefaultParameterNames=function(e){if(!this._oUserDefaultParametersNames[e.id]){this._oUserDefaultParametersNames[e.id]=new Promise(async t=>{const a=await o.getServiceAsync("ClientSideTargetResolution");const r=await a.getUserDefaultParameterNames(e);const s=this._extractKeyArrays(r);const n=s.extended;const i=s.allParameters;const u=this._arrayToObject(i);t({aAllParameterNames:i,aExtendedParameterNames:n,oMetadataObject:u})})}return this._oUserDefaultParametersNames[e.id]};this._isSupportedParameterName=async function(t,a){const r=await this._getUserDefaultParameterNames(a);if(!r.aAllParameterNames||r.aAllParameterNames.indexOf(t)===-1){e.error(`The given parameter "${t}" is not part of the list of parameters for the given system context.`);return false}return true};this.hasRelevantMaintainableParameters=async function(e){try{const t=await this._getUserDefaultParameterNames(e);if(!s(t)&&t.aAllParameterNames){const a=await Promise.all(t.aAllParameterNames.map(async t=>{try{const a=await this.getValue(t,e);if(a&&!a.hasOwnProperty("noEdit")){return true}}catch{}return false}));return a.some(e=>e)}}catch{}return false};this.getValue=async function(a,r){const s=await this._isSupportedParameterName(a,r);if(!s){return{value:undefined}}const n=await this._getPersistedValue(a,r).then(e=>{this._oWasParameterPersisted[a]=true;return e||{}}).catch(()=>({value:undefined}));const i=t(n);const o=!i._shellData&&this._valueIsEmpty(i)||i.noStore||i.alwaysAskPlugin;if(!o){return i}const u=await this._iterateOverPluginsToGetDefaultValue(a,n,r);if(!this._oWasParameterPersisted[a]||!this._haveSameMembersValue(i,u,l)){this._oWasParameterPersisted[a]=true;await this._storeValue(a,u,false,r).catch(t=>{e.error("Failed to store user default parameter: ",t)})}return u};this._addParameterValuesToParameters=async function(e,t,a){await Promise.all(t.map(async t=>{const r=await this.getValue(t,a);e[t].valueObject=r}));return e};this._arrayToObject=function(e){const t={};e.forEach(e=>{t[e]={}});return t};this._getComponentNameOfPlugin=function(e){try{return e.getMetadata().getComponentName()||""}catch(e){return"'name of plugin could not be determined'"}};this._getEditorDataAndValue=async function(t,a,s,n){const o=await Promise.all(this._aPlugins.map(async t=>{if(typeof t.getEditorMetadata==="function"){try{const e=t.getEditorMetadata(s,n);const a=await i.promisify(e);return a}catch(t){e.error("Error invoking getEditorMetaData on plugin:",t,"sap.ushell.services.UserDefaultParameters");return}}}));const u=[];const l=o.reverse().reduce((e,a)=>{t.forEach(t=>{if(a?.[t]?.editorMetadata){e[t].editorMetadata=a[t].editorMetadata}});return e},s);t.forEach(e=>{if(!(l[e]&&l[e].editorMetadata)){u.push(e)}});const c=await this._addParameterValuesToParameters(l,t,n);const d=r({},c);a.forEach(e=>{if(d[e]){d[e].editorMetadata=d[e].editorMetadata||{};d[e].editorMetadata.extendedUsage=true}});const f=Object.keys(d).splice(0);f.forEach(e=>{let t;if(d[e].valueObject&&d[e].valueObject.noEdit===true){delete d[e];t=u.indexOf(e);if(t>=0){u.splice(t,1)}}});if(u.length>0){e.error(`The following parameter names have no editor metadata and thus likely no configured plugin:\n"${u.join('",\n"')}".`)}return d};this.editorGetParameters=async function(e){const t=await this._getUserDefaultParameterNames(e);const{aAllParameterNames:a,aExtendedParameterNames:r,oMetadataObject:s}=t;if(s.length===0){return{}}await this._loadPlugins();return this._getEditorDataAndValue(a,r,s,e)};this._extractKeyArrays=function(e){const t={simple:e&&e.simple&&Object.keys(e.simple).sort()||[],extended:e&&e.extended&&Object.keys(e.extended).sort()||[]};const a=t.extended.filter(e=>t.simple.indexOf(e)<0);t.allParameters=t.simple.concat(a).sort();return t};this.editorSetValue=async function(e,t,a){await this._storeValue(e,t,true,a)};this.attachValueStored=function(e){h.attachEvent(u,e)};this.detachValueStored=function(e){h.detachEvent(u,e)};this._loadPlugins=async function(){const t=await o.getServiceAsync("PluginManager");try{await i.promisify(t.loadPlugins("UserDefaults"))}catch{e.error("One or more plugins could not be loaded");throw new Error("Initialization of plugins failed")}}}c.hasNoAdapter=true;return c},true);
//# sourceMappingURL=UserDefaultParameters.js.map