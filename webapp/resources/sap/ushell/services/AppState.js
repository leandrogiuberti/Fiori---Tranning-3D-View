// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/base/Object","sap/ui/thirdparty/jquery","sap/ushell/services/appstate/AppState","sap/ushell/services/appstate/AppStatePersistencyMethod","sap/ushell/services/appstate/Sequentializer","sap/ushell/services/appstate/SequentializingAdapter","sap/ushell/services/appstate/WindowAdapter","sap/ushell/utils"],(e,jQuery,t,s,n,i,r,o)=>{"use strict";function p(e){return o.isDefined(e)&&o.isDefined(e.transient)?!!e.transient:true}function a(e,t,s,n){this._oConfig=n&&n.config;this._sSessionKey="";this._oAdapter=new i(e);this._oAdapter=new r(this,this._oAdapter,n)}a.prototype._getSessionKey=function(){if(!this._sSessionKey){this._sSessionKey=this._getGeneratedKey()}return this._sSessionKey};a.prototype.getAppState=function(e){const s=new jQuery.Deferred;let n;this._loadAppState(e).done((e,i,r,o)=>{n=new t(this,e,false,i,undefined,undefined,undefined,r,o);s.resolve(n)}).fail(()=>{n=new t(this,e);s.resolve(n)});return s.promise()};a.prototype._getGeneratedKey=function(e){let t=o.generateRandomKey();if(e){t=`TAS${t}`.substring(0,41)}else{t=`AS${t}`.substring(0,40)}return t};a.prototype.createEmptyAppState=function(n,i,r,o){let a="";let d="";const u=i||p(this._oConfig);const f=this._getGeneratedKey(u);if(r!==undefined&&!this.isPersistencyMethodSupported(r)){r=undefined}if(n){if(!e.isObjectA(n,"sap.ui.core.UIComponent")){throw new Error("oComponent passed must be a UI5 Component")}const t=n.getMetadata&&n.getMetadata();if(t){if(typeof n.getMetadata().getName==="function"){a=t.getName()||""}if(!a&&t.getComponentName){a=t.getComponentName()}if(typeof n.getManifest==="function"&&typeof n.getManifest()==="object"&&typeof n.getManifest()["sap.app"]==="object"){d=n.getManifest()["sap.app"].ach||""}}}if(u===true){r=undefined}else if(r===undefined&&this.isPersistencyMethodSupported(s.PersonalState)){r=s.PersonalState}return new t(this,f,true,undefined,a,d,u,r)};a.prototype.createEmptyUnmodifiableAppState=function(){const e=this._getGeneratedKey();const s=new t(this,e,false);return s};a.prototype._saveAppState=function(e,t,n,i,r,a,d){const u=this._getSessionKey();const f=o.isDefined(r)?r:p(this._oConfig);if(f){a=undefined;d=undefined}else if(a!==undefined){if(!this.isPersistencyMethodSupported(a)){if(this.isPersistencyMethodSupported(s.PersonalState)){a=s.PersonalState}else{a=undefined}d=undefined}}return this._oAdapter.saveAppState(e,u,t,n,i,f,a,d)};a.prototype._keyIsJson=function(e){if(typeof e==="string"&&e.indexOf("{")===0){try{JSON.parse(e);return true}catch{return false}}return false};a.prototype._loadAppState=function(e){if(this._keyIsJson(e)){return(new jQuery.Deferred).resolve(e,e).promise()}return this._oAdapter.loadAppState(e)};a.prototype.deleteAppState=function(e){return this._oAdapter.deleteAppState(e)};a._getSequentializer=function(){return new n};a.prototype.getSupportedPersistencyMethods=function(){if(this._oAdapter.getSupportedPersistencyMethods){return this._oAdapter.getSupportedPersistencyMethods()}return[]};a.prototype.isPersistencyMethodSupported=function(e){const t=this.getSupportedPersistencyMethods();if(t.length>0&&e!==undefined){return t.indexOf(e)>=0}return false};function d(e,t){const s=new RegExp(`(?:${t}=)([^&/]+)`);const n=s.exec(e);let i;if(n&&n.length===2){i=n[1]}return i}a.prototype.setAppStateToPublic=function(e){const t=d(e,"sap-xapp-state");const n=d(e,"sap-iapp-state");const i=new jQuery.Deferred;jQuery.when(t&&this.makeStatePersistent(t,s.PublicState),n&&this.makeStatePersistent(n,s.PublicState)).done((s,r)=>{if(t&&t!==s){e=e.replace(t,s)}if(n&&n!==r){e=e.replace(n,r)}i.resolve(e,t,n,s,r)}).fail(i.reject);return i.promise()};a.prototype.makeStatePersistent=function(e,t,s){const n=new jQuery.Deferred;if(this.getSupportedPersistencyMethods().length===0){return n.resolve(e)}if(this._keyIsJson(e)){return n.resolve(e)}if(this.isPersistencyMethodSupported(t)){this.getAppState(e).done(i=>{if(i._iPersistencyMethod!==t){i.bTransient=false;i._iPersistencyMethod=t;i._oPersistencySettings=s;if(e.startsWith("TAS")){e=e.substring(1,e.length)}this._saveAppState(e,i._sData,i._sAppName,i._sACHComponent,false,t,s).done(()=>{n.resolve(e)}).fail(n.reject)}else{n.resolve(e)}}).fail(n.reject)}else{n.reject(new Error(`AppState.makeStatePersistent - adapter does not support persistence method: ${t}`))}return n.promise()};a.prototype.getPersistentWhenShared=function(){return this._oConfig&&this._oConfig.persistentWhenShared===true?true:false};a.WindowAdapter=r;a.hasNoAdapter=false;return a},true);
//# sourceMappingURL=AppState.js.map