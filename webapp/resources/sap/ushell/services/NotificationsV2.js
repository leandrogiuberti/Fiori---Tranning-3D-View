// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/i18n/Localization","sap/ui/core/EventBus","sap/ushell/utils/Deferred","sap/ui/core/ws/SapPcpWebSocket","sap/ui/model/json/JSONModel","sap/ui/thirdparty/datajs","sap/ushell/utils","sap/ushell/Container","sap/ushell/utils/LaunchpadError"],(e,t,i,s,n,o,a,r,c,f)=>{"use strict";const u="/sap/bc/apc/iwngw/notification_push_apc";const l=60;function d(d,h,g){this.Priority={LOW:"LOW",MEDIUM:"MEDIUM",HIGH:"HIGH"};this.Nature={POSITIVE:"POSITIVE",NEGATIVE:"NEGATIVE",NEUTRAL:"NEUTRAL"};const p=new o;const N=g&&g.config;const _={getNotifications:{},getNotificationsByType:{},getNotificationsInGroup:{},getBadgeNumber:{},resetBadgeNumber:{},getNotificationTypesSettings:{},getNotificationsGroupHeaders:{},getMobileSupportSettings:{},getEmailSupportSettings:{},getWebSocketValidity:{},getNotificationCount:{}};const S=[];const T=[];const I=5e3;const m=6e3;const v={NOTIFICATIONS:0,NOTIFICATIONS_BY_TYPE:1,GET_BADGE_NUMBER:2,RESET_BADGE_NUMBER:3,GET_SETTINGS:4,GET_MOBILE_SUPPORT_SETTINGS:5,NOTIFICATIONS_GROUP_HEADERS:6,NOTIFICATIONS_IN_GROUP:7,GET_NOTIFICATIONS_COUNT:8,VALIDATE_WEBSOCKET_CHANNEL:9,GET_EMAIL_SUPPORT_SETTINGS:10,NOTIFICATIONS_BY_DATE_DESCENDING:"notificationsByDateDescending",NOTIFICATIONS_BY_PRIORITY_DESCENDING:"notificationsByPriorityDescending",NOTIFICATIONS_BY_TYPE_DESCENDING:"notificationsByTypeDescending"};const C={PACKAGED_APP:0,FIORI_CLIENT:1,WEB_SOCKET:2,POLLING:3};const b=new s;const E=new s;const y=b.promise();const P=10;const R=new Date;let D;let O;let A;let B;let U;let k=false;let w=[];let F=false;let $=false;let G=true;let q="fetch";let M;let L=false;let H;let V=false;let W=true;let J;let X;let x=false;let z=false;let j=[];let Y;this.isEnabled=function(){if(!N.enabled||!N.serviceUrl){G=false;if(N.enabled&&!N.serviceUrl){e.warning("No serviceUrl was found in the service configuration")}}else{G=true}return G};this.init=function(){if(!F&&this.isEnabled()){i.getInstance().subscribe("launchpad","sessionTimeout",this.destroy,this);Y=this.fireInitialRequest();this.lastNotificationDate=new Date;this._setWorkingMode();F=true;this.bUpdateDependencyInitiatorExists=false;this._userSettingInitialization()}i.getInstance().subscribe("launchpad","setConnectionToServer",this._onSetConnectionToServer,this)};this.fireInitialRequest=async function(){return new Promise(e=>{const t={requestUri:`${N.serviceUrl}/GetBadgeNumber()`,headers:{"X-CSRF-Token":q}};a.request(t,t=>{if(t.response){this._updateCSRF(t.response)}e()},t=>{if(t.response){this._updateCSRF(t.response)}e()})})};this.fireODataRequest=async function(e){await Y;if(e.headers&&e.headers["X-CSRF-Token"]){e.headers["X-CSRF-Token"]=q}a.request.apply(this,arguments)};this.fireODataRead=async function(e){await Y;if(e.headers&&e.headers["X-CSRF-Token"]){e.headers["X-CSRF-Token"]=q}a.read.apply(this,arguments)};this._onSetConnectionToServer=function(e,t,i){if(i.active){this._resumeConnection()}else{this._closeConnection()}};this.getUnseenNotificationsCount=function(){return Promise.resolve(p.getProperty("/UnseenCount"))};this.setUnseenNotificationsCount=function(e){return Promise.resolve(p.setProperty("/UnseenCount",e))};this.getNotificationsCount=function(){return p.getProperty("/NotificationsCount")||"0"};this._createRequest=function(e){const i={"Accept-Language":t.getLanguageTag().toString(),"X-CSRF-Token":this._getHeaderXcsrfToken()||"fetch"};return{requestUri:e,headers:i}};this.getNotificationsByTypeWithGroupHeaders=function(){const t=this._createRequest(this._getRequestURI(v.NOTIFICATIONS_BY_TYPE));return new Promise((i,s)=>{this.fireODataRequest(t,i,t=>{if(t.response&&t.response.statusCode===200&&t.response.body){i(t.response.body)}else{e.error("Notification service - oData executeAction failed: ",t,"sap.ushell.services.NotificationsV2");const i=new f(`Failed to fetch data: ${t.message}`,{dataJsError:t});s(i)}})})};this.getNotificationsGroupHeaders=function(){const t=this._createRequest(this._getRequestURI(v.NOTIFICATIONS_GROUP_HEADERS));return new Promise((i,s)=>{this.fireODataRequest(t,i,t=>{if(t.response&&t.response.statusCode===200&&t.response.body){i(t.response.body)}else{e.error("Notification service - oData executeAction failed: ",t,"sap.ushell.services.NotificationsV2");const i=new f(`Failed to fetch data: ${t.message}`,{dataJsError:t});s(i)}})})};this.getNotificationsBufferInGroup=function(t,i,s){const n=this;const o={group:t,skip:i,top:s};const a=this._createRequest(this._getRequestURI(v.NOTIFICATIONS_IN_GROUP,o));return new Promise((t,i)=>{this.fireODataRequest(a,e=>{n._updateCSRF(e.response);t(e.value)},s=>{if(s.response&&s.response.statusCode===200&&s.response.body){n._updateCSRF(s.response);t(JSON.parse(s.response.body).value)}else{e.error("Notification service - oData executeAction failed: ",s,"sap.ushell.services.NotificationsV2");const t=new f(`Failed to fetch data: ${s.message}`,{dataJsError:s});i(t)}})})};this.getNotificationsBufferBySortingType=function(t,i,s){const n=this;const o={skip:i,top:s};const a=this._createRequest(this._getRequestURI(t,o));return new Promise((o,r)=>{this.fireODataRequest(a,e=>{n._updateCSRF(e.response);o(e.value)},a=>{if(a.response&&a.response.statusCode===200&&a.response.body){n._updateCSRF(a.response);const t=this._parseJSON(a.response.body);if(t){o(t.value)}else{e.error("Notification service - oData executeAction failed: ",a,"sap.ushell.services.NotificationsV2");const t=new f(`Failed to fetch data: ${a.message}`,{dataJsError:a});r(t)}}else if(n._csrfTokenInvalid(a)&&x===false){n._invalidCsrfTokenRecovery(o,r,n.getNotificationsBufferBySortingType,[t,i,s])}else{e.error("Notification service - oData executeAction failed: ",a,"sap.ushell.services.NotificationsV2");const t=new f(`Failed to fetch data: ${a.message}`,{dataJsError:a});r(t)}})})};this.getNotifications=function(){if(H===C.FIORI_CLIENT||H===C.PACKAGED_APP){return this._readNotificationsData(false).then(()=>p.getProperty("/Notifications"))}return Promise.resolve(p.getProperty("/Notifications"))};this.executeBulkAction=function(e,t){return new Promise((i,s)=>{this.sendBulkAction(e,t).then(e=>{const t=[];const n=[];e.forEach(e=>{const i=e.NotificationId;if(e.Success){t.push(i)}else{n.push(i)}});const o={succededNotifications:t,failedNotifications:n};if(n.length){s(o)}else{i(o)}})})};this.dismissBulkNotifications=function(e){return this.sendBulkDismiss(e)};this.executeAction=function(t,i){const s=this;const n=`${N.serviceUrl}/ExecuteAction`;const o={NotificationId:t,ActionId:i};const a={requestUri:n,method:"POST",data:o,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:M,"X-CSRF-Token":q}};return new Promise((n,o)=>{this.fireODataRequest(a,e=>{const t={isSucessfull:true,message:""};if(e&&e.response&&e.response.statusCode===200&&e.response.body){const i=JSON.parse(e.response.body);t.isSucessfull=i.Success;t.message=i.MessageText}n(t)},a=>{const r={isSucessfull:false,message:""};if(a.response&&a.response.statusCode===200&&a.response.body){const e=JSON.parse(a.response.body);r.isSucessfull=e.Success;r.message=e.MessageText;n(r)}else if(s._csrfTokenInvalid(a)&&x===false){s._invalidCsrfTokenRecovery(n,o,s.executeAction,[t,i])}else{e.error("Notification service - oData executeAction failed: ",a,"sap.ushell.services.NotificationsV2");const t=new f(`Failed to fetch data: ${a.message}`,{dataJsError:a});o(t)}})})};this.sendBulkAction=function(t,i){const s=this;const n=`${N.serviceUrl}/BulkActionByHeader`;const o={ParentId:t,ActionId:i};const a={requestUri:n,method:"POST",data:o,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:M,"X-CSRF-Token":q}};return new Promise((n,o)=>{this.fireODataRequest(a,e=>{let t;if(e&&e.response&&e.response.statusCode===200&&e.response.body){const i=JSON.parse(e.response.body);t=i.value}n(t)},a=>{if(a.response&&a.response.statusCode===200&&a.response.body){const e=JSON.parse(a.response.body);const t=e.value;n(t)}else if(s._csrfTokenInvalid(a)&&x===false){s._invalidCsrfTokenRecovery(n,o,s.sendBulkAction,[t,i])}else{e.error("Notification service - oData executeBulkAction failed: ",a.message,"sap.ushell.services.NotificationsV2");const t=new f(`Failed to fetch data: ${a.message}`,{dataJsError:a});o(t)}})})};this.sendBulkDismiss=function(t){const i=this;const s=`${N.serviceUrl}/DismissAll`;const n={ParentId:t};const o={requestUri:s,method:"POST",data:n,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:M,"X-CSRF-Token":q}};return new Promise((s,n)=>{this.fireODataRequest(o,()=>s(),o=>{if(o.response&&o.response.statusCode===200){s()}else if(i._csrfTokenInvalid(o)&&x===false){i._invalidCsrfTokenRecovery(s,n,i.sendBulkDismiss,[t])}else{const t=o?o.message:"";e.error("Notification service - oData executeBulkAction failed: ",t,"sap.ushell.services.NotificationsV2");const i=new f(`Failed to fetch data: ${o.message}`,{dataJsError:o});n(i)}})})};this.markRead=function(t){const i=this;const s=`${N.serviceUrl}/MarkRead`;const n={NotificationId:t};const o={requestUri:s,method:"POST",data:n,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:M,"X-CSRF-Token":q}};return new Promise((s,n)=>{this.fireODataRequest(o,()=>s(),o=>{if(i._csrfTokenInvalid(o)&&x===false){i._invalidCsrfTokenRecovery(s,n,i.markRead,[t])}else{e.error("Notification service - oData reset badge number failed: ",o,"sap.ushell.services.NotificationsV2");const t=new f(`Failed to fetch data: ${o.message}`,{dataJsError:o});n(t)}})})};this.dismissNotification=function(t){const i=`${N.serviceUrl}/Dismiss`;const s=this;const n={NotificationId:t};const o={requestUri:i,method:"POST",data:n,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:M,"X-CSRF-Token":q}};return new Promise((i,n)=>{this.fireODataRequest(o,()=>{s._addDismissNotifications(t);i()},o=>{if(s._csrfTokenInvalid(o)&&x===false){s._invalidCsrfTokenRecovery(i,n,s.dismissNotification,[t])}else{e.error("Notification service - oData dismiss notification failed: ",o,"sap.ushell.services.NotificationsV2");const t=new f(`Failed to fetch data: ${o.message}`,{dataJsError:o});n(t)}})})};this.registerNotificationsUpdateCallback=function(e){S.push(e)};this.registerNotificationCountUpdateCallback=function(e){T.push(e)};this.isFirstDataLoaded=function(){return V};this.getUserSettingsFlags=async function(){try{await r.promisify(y)}catch(e){}return{highPriorityBannerEnabled:W}};this.setUserSettingsFlags=function(e){W=e.highPriorityBannerEnabled;this._writeUserSettingsFlagsToPersonalization(e)};this._getNotificationSettingsMobileSupport=function(){return J};this._getDismissNotifications=function(){return j};this.filterDismisssedItems=function(e,t){return e.filter(e=>!t.some(t=>t===e.originalItemId))};this._addDismissNotifications=function(e){if(j.indexOf(e)===-1){j.push(e)}};this._initializeDismissNotifications=function(){j=[]};this._getNotificationSettingsEmailSupport=function(){return X};this.destroy=function(){$=true;if(O){clearTimeout(O)}else if(A){clearTimeout(A)}else if(B){clearTimeout(B)}if(H===C.WEB_SOCKET&&D){D.close()}i.getInstance().unsubscribe("launchpad","sessionTimeout",this.destroy,this);i.getInstance().unsubscribe("launchpad","setConnectionToServer",this._onSetConnectionToServer,this)};this._readUnseenNotificationsCount=function(){const t=this;const i=this._createRequest(this._getRequestURI(v.GET_BADGE_NUMBER));return new Promise((s,n)=>{this.fireODataRead(i,(e,i)=>{p.setProperty("/UnseenCount",i.data.GetBadgeNumber.Number);t._setNativeIconBadge(i.data.GetBadgeNumber.Number);s(i.data.GetBadgeNumber.Number)},i=>{if(i.response&&i.response.statusCode===200&&i.response.body){const e=JSON.parse(i.response.body);p.setProperty("/UnseenCount",e.value);t._setNativeIconBadge(e.value);s(e.value)}else{e.error("Notification service - oData read unseen notifications count failed: ",i.message,"sap.ushell.services.NotificationsV2");const t=new f(`Failed to fetch data: ${i.message}`,{dataJsError:i});n(t)}})})};this.readNotificationsCount=function(){const t=this._createRequest(this._getRequestURI(v.GET_NOTIFICATIONS_COUNT));return new Promise((i,s)=>{this.fireODataRead(t,(e,t)=>i(t.data),t=>{if(t.response&&t.response.statusCode===200&&t.response.body){const e=JSON.parse(t.response.body);i(e.value)}else{e.error("Notification service - oData read notifications count failed: ",t.message,"sap.ushell.services.NotificationsV2");const i=new f(`Failed to fetch data: ${t.message}`,{dataJsError:t});s(i)}})})};this._getNotificationSettingsAvailability=function(){return E.promise()};this.notificationsSeen=function(){const t=this;const i={requestUri:this._getRequestURI(v.RESET_BADGE_NUMBER),method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:M,"X-CSRF-Token":q}};if(this._isFioriClientMode()===true||this._isPackagedMode()===true){this._setNativeIconBadge(0)}return new Promise((s,n)=>{this.fireODataRequest(i,s,i=>{if(t._csrfTokenInvalid(i)){t._invalidCsrfTokenRecovery(s,n,t.notificationsSeen)}else{e.error("Notification service - oData reset badge number failed: ",i,"sap.ushell.services.NotificationsV2");const t=new f(`Failed to fetch data: ${i.message}`,{dataJsError:i});n(t)}})})};this._readNotificationsData=function(e){const t=this;this.readNotificationsCount().then(e=>p.setProperty("/NotificationsCount",e));const i=this._readUnseenNotificationsCount(e).then(()=>{if(e===true){t._updateNotificationsCountConsumers()}});const s=this.getNotificationsBufferBySortingType(v.NOTIFICATIONS_BY_DATE_DESCENDING,0,P).then(i=>{p.setProperty("/Notifications",i);t._notificationAlert(i);if(e===true){t._updateNotificationsConsumers()}});return Promise.all([i,s])};this._getHeaderXcsrfToken=function(){return q};this._getDataServiceVersion=function(){return M};this._getRequestURI=function(e,t){const i=encodeURI(this._getConsumedIntents(e));let s;switch(e){case v.NOTIFICATIONS:if(_.getNotifications.basic===undefined){_.getNotifications.basic=`${N.serviceUrl}/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20false`}if(this._isIntentBasedConsumption()){if(_.getNotifications.byIntents===undefined){_.getNotifications.byIntents=_.getNotifications.basic.concat(`&intents%20eq%20${i}`)}return _.getNotifications.byIntents}return _.getNotifications.basic;case v.NOTIFICATIONS_BY_TYPE:if(_.getNotificationsByType.basic===undefined){_.getNotificationsByType.basic=`${N.serviceUrl}/Notifications?$expand=Actions,NavigationTargetParams`}if(this._isIntentBasedConsumption()){if(_.getNotificationsByType.byIntents===undefined){_.getNotificationsByType.byIntents=_.getNotificationsByType.basic.concat(`&$filter=intents%20eq%20${i}`)}return _.getNotificationsByType.byIntents}return _.getNotificationsByType.basic;case v.NOTIFICATIONS_GROUP_HEADERS:if(_.getNotificationsGroupHeaders.basic===undefined){_.getNotificationsGroupHeaders.basic=`${N.serviceUrl}/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20true`}if(this._isIntentBasedConsumption()){if(_.getNotificationsGroupHeaders.byIntents===undefined){_.getNotificationsGroupHeaders.byIntents=_.getNotificationsGroupHeaders.basic.concat(`&intents%20eq%20${i}`)}return _.getNotificationsGroupHeaders.byIntents}return _.getNotificationsGroupHeaders.basic;case v.NOTIFICATIONS_IN_GROUP:s=`${N.serviceUrl}/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt desc&$filter=IsGroupHeader eq false and ParentId eq ${t.group}&$skip=${t.skip}&$top=${t.top}`;if(this._isIntentBasedConsumption()===true){s=s.concat(`&intents%20eq%20${i}`)}break;case v.GET_BADGE_NUMBER:if(_.getBadgeNumber.basic===undefined){_.getBadgeNumber.basic=`${N.serviceUrl}/GetBadgeNumber()`}if(this._isIntentBasedConsumption()){if(_.getBadgeNumber.byIntents===undefined){_.getBadgeNumber.byIntents=`${N.serviceUrl}/GetBadgeCountByIntent(${i})`}return _.getBadgeNumber.byIntents}return _.getBadgeNumber.basic;case v.GET_NOTIFICATIONS_COUNT:if(_.getNotificationCount.basic===undefined){_.getNotificationCount.basic=`${N.serviceUrl}/Notifications/$count`}return _.getNotificationCount.basic;case v.RESET_BADGE_NUMBER:if(_.resetBadgeNumber.basic===undefined){_.resetBadgeNumber.basic=`${N.serviceUrl}/ResetBadgeNumber`}return _.resetBadgeNumber.basic;case v.GET_SETTINGS:if(_.getNotificationTypesSettings.basic===undefined){_.getNotificationTypesSettings.basic=`${N.serviceUrl}/NotificationTypePersonalizationSet`}return _.getNotificationTypesSettings.basic;case v.GET_MOBILE_SUPPORT_SETTINGS:if(_.getMobileSupportSettings.basic===undefined){_.getMobileSupportSettings.basic=`${N.serviceUrl}/Channels(ChannelId='SAP_SMP')`}return _.getMobileSupportSettings.basic;case v.GET_EMAIL_SUPPORT_SETTINGS:if(_.getEmailSupportSettings.basic===undefined){_.getEmailSupportSettings.basic=`${N.serviceUrl}/Channels(ChannelId='SAP_EMAIL')`}return _.getEmailSupportSettings.basic;case v.VALIDATE_WEBSOCKET_CHANNEL:if(_.getWebSocketValidity.basic===undefined){_.getWebSocketValidity.basic=`${N.serviceUrl}/Channels('SAP_WEBSOCKET')`}return _.getWebSocketValidity.basic;case v.NOTIFICATIONS_BY_DATE_DESCENDING:s=`${N.serviceUrl}/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20desc&$filter=IsGroupHeader%20eq%20false&$skip=${t.skip}&$top=${t.top}`;if(this._isIntentBasedConsumption()===true){s=s.concat(`&intents%20eq%20${i}`)}break;case v.NOTIFICATIONS_BY_PRIORITY_DESCENDING:s=`${N.serviceUrl}/Notifications?$expand=Actions,NavigationTargetParams&$orderby=Priority%20desc&$filter=IsGroupHeader%20eq%20false&$skip=${t.skip}&$top=${t.top}`;if(this._isIntentBasedConsumption()===true){s=s.concat(`&intents%20eq%20${i}`)}break;default:s=""}return s};this.readSettings=function(){const t=this._createRequest(this._getRequestURI(v.GET_SETTINGS));return new Promise((i,s)=>{this.fireODataRequest(t,e=>i(e.results),t=>{if(t.response&&t.response.statusCode===200&&t.response.body){i(t.response.body)}else{e.error("Notification service - oData get settings failed: ",t,"sap.ushell.services.NotificationsV2");const i=new f(`Failed to fetch data: ${t.message}`,{dataJsError:t});s(i)}})})};this._readMobileSettingsFromServer=function(){return this._readChannelSettingsFromServer(v.GET_MOBILE_SUPPORT_SETTINGS)};this._readEmailSettingsFromServer=function(){return this._readChannelSettingsFromServer(v.GET_EMAIL_SUPPORT_SETTINGS)};this._readChannelSettingsFromServer=function(t){const i=this._getRequestURI(t);const s=this._createRequest(i);let n;let o;return new Promise(t=>{this.fireODataRequest(s,e=>{if(typeof e.results==="string"){n=JSON.parse(e.results);n.successStatus=true;o=JSON.stringify(n);t(o)}else{e.results.successStatus=true;t(e.results)}},i=>{if(i.response&&i.response.statusCode===200&&i.response.body){n=JSON.parse(i.response.body);n.successStatus=true;o=JSON.stringify(n);t(o)}else{e.error("Notification service - oData get settings failed: ",i,"sap.ushell.services.NotificationsV2");t(JSON.stringify({successStatus:false}))}})})};this._checkWebSocketActivity=function(){const t=this._createRequest(this._getRequestURI(v.VALIDATE_WEBSOCKET_CHANNEL));return new Promise(i=>{this.fireODataRequest(t,e=>{if(typeof e.results==="string"){const t=JSON.parse(e.results);i(t.IsActive)}else{i(false)}},t=>{if(t.response&&t.response.statusCode===200&&t.response.body){const e=JSON.parse(t.response.body);i(e.IsActive)}else{e.error("Notification service - oData get settings failed: ",t,"sap.ushell.services.NotificationsV2");i(false)}})})};this.saveSettingsEntry=function(t){const i=this;const s=`${this._getRequestURI(v.GET_SETTINGS)}(NotificationTypeId=${t.NotificationTypeId})`;const n={requestUri:s,method:"PUT",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:M,"X-CSRF-Token":q}};n.data=JSON.parse(JSON.stringify(t));n.data["@odata.context"]="$metadata#NotificationTypePersonalizationSet/$entity";return new Promise((s,o)=>{this.fireODataRequest(n,s,n=>{if(n.response&&n.response.statusCode===200&&n.response.body){s(n.response.body)}else if(i._csrfTokenInvalid(n)&&x===false){i._invalidCsrfTokenRecovery(s,o,i.saveSettingsEntry,[t])}else{e.error("Notification service - oData set settings entry failed: ",n,"sap.ushell.services.NotificationsV2");const t=new f(`Failed to fetch data: ${n.message}`,{dataJsError:n});o(t)}})})};this._updateNotificationsConsumers=function(){S.forEach(e=>e())};this._updateNotificationsCountConsumers=function(){T.forEach(e=>e())};this._updateAllConsumers=function(){this._updateNotificationsConsumers();this._updateNotificationsCountConsumers()};this._getModel=function(){return p};this._getMode=function(){return H};this._setWorkingMode=function(){let e;if(N.intentBasedConsumption===true){w=this._getIntentsFromConfiguration(N.consumedIntents);if(w.length>0){k=true}}if(this._isPackagedMode()){H=C.PACKAGED_APP;e=this._getIntentsFromConfiguration(window.fiori_client_appConfig.applications);if(e.length>0){w=e}if(w.length>0){k=true}this._registerForPush();this._readNotificationsData(true);this._setNativeIconBadgeWithDelay();return}this._performFirstRead()};this._performFirstRead=function(){const t=this;this._readNotificationsData(true).then(()=>{const e=t._getFioriClientRemainingDelay();if(e<=0){t._fioriClientStep()}else{O=setTimeout(()=>{t._fioriClientStep()},e)}V=true}).catch(t=>{e.error("Notifications oData read failed. Error:",t)})};this._fioriClientStep=function(){if(this._isFioriClientMode()){H=C.FIORI_CLIENT;this._addPushNotificationHandler();this.getUnseenNotificationsCount().then(e=>{this._setNativeIconBadge(e)})}else{this._webSocketStep()}};this._webSocketStep=function(){H=C.WEB_SOCKET;this._establishWebSocketConnection()};this._webSocketRecoveryStep=function(){if(L===false){L=true;A=window.setTimeout(this._webSocketStep.bind(this),I)}else{this._activatePollingAfterInterval()}};this._activatePollingAfterInterval=function(){U=N.pollingIntervalInSeconds||l;window.clearTimeout(B);B=window.setTimeout(this._activatePolling.bind(this),r.sanitizeTimeoutDelay(U*1e3))};this._activatePolling=function(){U=N.pollingIntervalInSeconds||l;H=C.POLLING;this._readNotificationsData(true);window.clearTimeout(B);U=window.setTimeout(this._activatePolling.bind(this,U,false),r.sanitizeTimeoutDelay(U*1e3))};this._deactivatePolling=function(){if(H===C.POLLING){window.clearTimeout(U)}};this._formatAsDate=function(e){return new Date(e)};this._notificationAlert=function(e){if(W===false){return}const t=[];let s=0;for(const i in e){if(this.lastNotificationDate&&this._formatAsDate(e[i].CreatedAt)>this.lastNotificationDate){if(e[i].Priority==="HIGH"){t.push(e[i])}}if(s<this._formatAsDate(e[i].CreatedAt)){s=this._formatAsDate(e[i].CreatedAt)}}if(this.lastNotificationDate&&t.length>0){i.getInstance().publish("sap.ushell.services.Notifications","onNewNotifications",t)}this.lastNotificationDate=s};this._getFioriClientRemainingDelay=function(){return m-(new Date-R)};this._establishWebSocketConnection=function(){const t=this;let i=false;try{D=this._getWebSocketObjectObject(N.webSocketUrl||u,[n.SUPPORTED_PROTOCOLS.v10]);D.attachMessage(this,e=>{const i=e.getParameter("pcpFields");if(i&&i.Command&&i.Command==="Notification"){t._readNotificationsData(true)}});D.attachOpen(this,()=>{t._checkWebSocketActivity().then(e=>{if(!e){i=true;D.close();t._activatePollingAfterInterval()}});e.info("Notifications UShell service WebSocket: webSocket connection opened")});D.attachClose(this,s=>{e.warning(`Notifications UShell service WebSocket: attachClose called with code: ${s.mParameters.code} and reason: ${s.mParameters.reason}`);if(!$&&!i){t._webSocketRecoveryStep()}});D.attachError(this,()=>{e.warning("Notifications UShell service WebSocket: attachError called!")})}catch(t){e.error("Exception occurred while creating new sap.ui.core.ws.SapPcpWebSocket. Message:",t)}};this._isFioriClientMode=function(){return!(sap.FioriClient===undefined)};this._isPackagedMode=function(){return window.fiori_client_appConfig&&window.fiori_client_appConfig.prepackaged===true};this._setNativeIconBadge=function(e){if(sap.Push&&sap.Push.setBadgeNumber){sap.Push.setBadgeNumber(e,()=>{})}};this._setNativeIconBadgeWithDelay=function(){setTimeout(()=>{this.getUnseenNotificationsCount().then(e=>{this._setNativeIconBadge(e)})},4e3)};this._getIntentsFromConfiguration=function(e){const t=[];if(e&&e.length>0){let i;for(let s=0;s<e.length;s++){i=e[s].intent;t.push(i)}}return t};this._handlePushedNotification=function(e){let t;let i;let s;let n=[];if(e!==undefined){if(e.additionalData===undefined||e.additionalData.foreground===true){this._readNotificationsData(true)}else{if(e.additionalData&&e.additionalData.NavigationTargetObject){t=e.additionalData.NavigationTargetObject}else{t=e.NavigationTargetObject}if(e.additionalData&&e.additionalData.NavigationTargetAction){i=e.additionalData.NavigationTargetAction}else{i=e.NavigationTargetAction}if(e.additionalData&&e.additionalData.NavigationTargetParam){s=e.additionalData.NavigationTargetParam}else{s=e.NavigationTargetParam}if(s){if(typeof s==="string"||s instanceof String){n[0]=s}else if(Array.isArray(s)===true){n=s}}const o=e.NotificationId;if(t&&i){r.toExternalWithParameters(t,i,n)}this.markRead(o);this._readNotificationsData(true)}}};this._registerForPush=function(){if(sap.Push){sap.Push.initPush(this._handlePushedNotification.bind(this))}};this._addPushNotificationHandler=function(){document.addEventListener("deviceready",this._registerForPush.bind(this),false)};this._isIntentBasedConsumption=function(){return k};this._getConsumedIntents=function(e){let t="";if(!this._isIntentBasedConsumption()){return t}if(w.length>0){if(e!==v.GET_BADGE_NUMBER){t="&"}for(let i=0;i<w.length;i++){if(e===v.GET_BADGE_NUMBER){if(i===0){t=w[i]}else{t=`${t},${w[i]}`}}else{t=`${t}NavigationIntent%20eq%20%27${w[i]}%27`}}}return t};this._revalidateCsrfToken=function(){q="fetch";z=false;return this.getNotificationsBufferBySortingType(v.NOTIFICATIONS_BY_DATE_DESCENDING,0,1)};this._csrfTokenInvalid=function(e){const t=e.response;const i=t&&t.statusCode===403;const s=t&&t.headers["x-csrf-token"]||"";const n=s.toLowerCase()==="required";return i&&n};this._invalidCsrfTokenRecovery=function(t,i,s,n){const o=this;x=true;this._revalidateCsrfToken().then(()=>{s.apply(o,n).then(t).catch(e=>{i(e)}).finally(()=>{x=false})}).catch(t=>{x=false;e.error("Notification service - oData markRead failed: ",t.message,"sap.ushell.services.NotificationsV2");i(t)})};this._getWebSocketObjectObject=function(e,t){return new n(e,t)};this.getOperationEnum=function(){return v};this._readUserSettingsFlagsFromPersonalization=function(){const t=this;this._getUserSettingsPersonalizer().then(i=>{i.getPersData().then(e=>{if(e===undefined){t._writeUserSettingsFlagsToPersonalization({highPriorityBannerEnabled:W})}else{W=e.highPriorityBannerEnabled}b.resolve()}).catch(t=>{e.error("Reading User Settings flags from Personalization service failed",t);b.reject(t)})}).catch(t=>{e.error("Personalization service does not work:");e.error(`${t.name}: ${t.message}`);e.error("Reading User Settings flags from Personalization service failed")})};this._writeUserSettingsFlagsToPersonalization=function(t){return this._getUserSettingsPersonalizer().then(e=>e.setPersData(t)).catch(t=>{e.error("Personalization service does not work:");e.error(`${t.name}: ${t.message}`)})};this._getUserSettingsPersonalizer=function(){if(!this.oUserSettingsPersonalizerPromise){this.oUserSettingsPersonalizerPromise=c.getServiceAsync("PersonalizationV2").then(e=>{const t={keyCategory:e.KeyCategory.FIXED_KEY,writeFrequency:e.WriteFrequency.LOW,clientStorageAllowed:true};const i={container:"sap.ushell.services.Notifications",item:"userSettingsData"};return e.getPersonalizer(i,t)})}return this.oUserSettingsPersonalizerPromise};this._updateCSRF=function(e){if(z===true||e.headers===undefined){return}if(this._getHeaderXcsrfToken()==="fetch"){q=e.headers["x-csrf-token"]||e.headers["X-CSRF-Token"]||e.headers["X-Csrf-Token"]||"fetch"}if(!this._getDataServiceVersion()){M=e.headers.DataServiceVersion||e.headers["odata-version"]}z=true};this._userSettingInitialization=function(){if(this._bSettingsInitialized){return}this._bSettingsInitialized=true;const t={settingsAvailable:false,mobileAvailable:false,emailAvailable:false};this._readUserSettingsFlagsFromPersonalization();const i=this.readSettings();const s=this._readMobileSettingsFromServer();const n=this._readEmailSettingsFromServer();const o=[i,s,n];i.then(()=>{t.settingsAvailable=true}).catch(t=>{e.warning("User settings for the Notification service are not available.",t);E.promise().catch(()=>{});E.reject(t)});s.then(e=>{const i=JSON.parse(e);if(i.successStatus){J=e?i.IsActive:false;t.mobileAvailable=J}else{J=false;t.mobileAvailable=false}}).catch(()=>{e.warning("Mobile settings for the Notification service are not available.");J=false;t.mobileAvailable=false});n.then(e=>{const i=JSON.parse(e);if(i.successStatus){X=e?i.IsActive:false;t.emailAvailable=X}else{X=false;t.emailAvailable=false}}).catch(()=>{e.warning("Email settings for the Notification service are not available.");X=false;t.emailAvailable=false});Promise.all(o).then(()=>{E.resolve(t)}).catch(()=>e.warning("Settings for the Notification service are not loaded completely."))};this._closeConnection=function(){if(!$){if(H===C.WEB_SOCKET&&D){D.close();$=true}if(H===C.POLLING&&B){window.clearTimeout(B);$=true}}};this._resumeConnection=function(){if($){$=false;this._webSocketStep()}};this._parseJSON=function(e){try{return JSON.parse(e)}catch(e){this._deactivatePolling();return false}}}d.hasNoAdapter=true;return d},true);
//# sourceMappingURL=NotificationsV2.js.map