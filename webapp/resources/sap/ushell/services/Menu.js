// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/Config","sap/ushell/library","sap/ushell/utils","sap/ui/model/json/JSONModel","sap/base/util/deepClone","sap/base/Log","sap/ushell/resources","sap/ushell/Container"],(e,t,n,i,r,o,a,s)=>{"use strict";const d=t.ContentNodeType;function p(){this._init.apply(this,arguments)}p.prototype._init=function(e){this.oAdapter=e;this.oModel=new i([]);this.oModel.setSizeLimit(1e3);this.bIsMenuModelFilled=false;this._aBlockedList=[]};p.prototype.isMenuEnabled=function(){return this.oAdapter.isMenuEnabled()};p.prototype.isSideNavigationEnabled=function(){if(this.oAdapter.isSideNavigationEnabled){return this.oAdapter.isSideNavigationEnabled()}return Promise.resolve(false)};p.prototype.getMenuEntries=async function(){const t=await this.oAdapter.getMenuEntries();if(e.last("/core/homeApp/enabled")){const n={id:e.last("/core/spaces/myHome/myHomeSpaceId"),title:a.i18n.getText("HomeApp.Menu.Title"),"help-id":"homeApp-menuEntry",description:"",icon:undefined,type:"IBN",target:{semanticObject:"Shell",action:"home",parameters:[],innerAppRoute:undefined},isHomeEntry:true,menuEntries:[]};t.splice(0,0,n)}return t.map(e=>{e.uid=n.generateUniqueId([]);if(e.menuEntries){e.menuEntries.forEach(e=>{e.uid=n.generateUniqueId([])})}return e})};p.prototype.getSpacesPagesHierarchy=async function(){let e;if(this.oAdapter.getContentNodeEntries){e=this.oAdapter.getContentNodeEntries()}else{e=this.getMenuEntries()}try{const t=await e;return{spaces:t.reduce((e,t)=>{let n;if(t.menuEntries&&t.menuEntries.length){n=this._getAccessiblePages(t.menuEntries)}else{n=this._getAccessiblePages([t])}if(n.length){e.push({title:t.title,id:n[0].spaceId,pages:n.map(e=>({title:e.title,id:e.id}))})}return e},[])}}catch(e){return{spaces:[]}}};p.prototype.getContentNodes=async function(e,t){if(!e){e=Object.values(d)}t=!!t;let n=await this.oAdapter.getContentNodes();n=r(n);const i=this._filterContentNodes(n,e,t);return i};p.prototype._filterContentNodes=function(e,t,n){if(!Array.isArray(e)){return[]}return e.reduce((e,i)=>{i.children=this._filterContentNodes(i.children,t,n);const r=t.includes(i.type);if(r||n&&i.children.length){e.push(i)}return e},[])};p.prototype.getDefaultSpace=async function(){const t=await this.getContentNodes([d.Space,d.Page]);if(e.last("/core/menu/personalization/enabled")){const e=await this.getMenuModel();const n=e.getData().filter(e=>e.type!=="separator"&&e.pinned).filter(e=>t.some(t=>e.id===t.id&&t.children.length)).reduce((e,t)=>e.pinnedSortOrder<t.pinnedSortOrder?e:t,{});const i=t.find(e=>n.id===e.id);if(i){return i}}const n=t.find(e=>e.children.length);return n};p.prototype.getMyHomeSpace=async function(){if(!e.last("/core/spaces/myHome/enabled")){return null}const t=e.last("/core/spaces/myHome/myHomeSpaceId");const n=await this.getContentNodes([d.Space,d.Page]);return n.find(e=>e.type===d.Space&&e.id===t)||null};p.prototype._getAccessiblePages=function(e){return e.filter(e=>e&&e.type==="IBN"&&e.target&&e.target.semanticObject==="Launchpad"&&e.target.action==="openFLPPage").map(e=>{const t=e.target.parameters.find(e=>e.name==="spaceId");const n=e.target.parameters.find(e=>e.name==="pageId");return{title:e.title,id:n&&n.value,spaceId:t&&t.value}})};p.prototype.hasMultiplePages=async function(e){const t=await this.getContentNodes([d.Space,d.Page]);const n=t.find(t=>t.type===d.Space&&t.id===e);return n&&n.children.length>1};p.prototype.isSpacePageAssigned=async function(e,t){const n=await this.getContentNodes([d.Space,d.Page]);const i=n.find(t=>t.type===d.Space&&t.id===e);if(!i){return false}const r=i.children.find(e=>e.type===d.Page&&e.id===t);return!!r};p.prototype.getSpaceAndPageTitles=async function(e,t){const n=await this.getContentNodes([d.Space,d.Page]);const i=n.find(t=>t.type===d.Space&&t.id===e);if(!i){return null}const r=i.children.find(e=>e.type===d.Page&&e.id===t);if(!r){return null}return{spaceTitle:i.label,pageTitle:r.label}};p.prototype.getMenuModel=async function(){if(!this.bIsMenuModelFilled){let t;if(e.last("/core/menu/personalization/enabled")){t=this._getMenuEntriesWithPersonalizationData()}else{t=this.getMenuEntries()}const n=await t;this.oModel.setData(n);this.bIsMenuModelFilled=true}return this.oModel};p.prototype._getMenuEntriesWithPersonalizationData=async function(){const t=await this.getMenuEntries();const n=await this.oAdapter.getMenuPersonalization();let i;const r={type:"separator",pinned:true};let o=true;if(t[0]&&t[0].isHomeEntry){t.splice(1,0,r)}else if(e.last("/core/menu/personalization/showNavigationBarMenuButton")){t.splice(0,0,r)}else{o=false}if(!n){i=t.map((e,t)=>{e.pinned=true;e.pinnedSortOrder=t;return e})}else{let e=1;if(t[0].isHomeEntry){e=2}i=t.map(t=>{t.pinned=n.pinnedSpaces.includes(t.id);t.pinnedSortOrder=n.pinnedSpaces.indexOf(t.id);if(t.pinnedSortOrder>-1){t.pinnedSortOrder=t.pinnedSortOrder+e}return t});if(o){t[0].pinned=true;t[0].pinnedSortOrder=0;if(t[0].isHomeEntry){t[1].pinned=true;t[1].pinnedSortOrder=1}}}return i};p.prototype._extractPersonalization=function(){const e={version:"1.0.0",pinnedSpaces:[]};const t=this.oModel.getData();e.pinnedSpaces=t.filter(e=>!e.isHomeEntry&&e.type!=="separator"&&e.pinned).sort((e,t)=>e.pinnedSortOrder-t.pinnedSortOrder).map(e=>e.id);return e};p.prototype.savePersonalization=async function(){const e=this._extractPersonalization();const t=await s.getServiceAsync("PersonalizationV2");const n={container:"sap.ushell.menuPersonalization",item:"data"};const i={validity:"Infinity",keyCategory:t.KeyCategory.FIXED_KEY,writeFrequency:t.WriteFrequency.HIGH,clientStorageAllowed:false};const r=await t.getPersonalizer(n,i);return r.setPersData(e)};p.prototype.moveMenuEntry=function(e,t){const n=this.oModel.getData();const i=n.find(t=>t.pinnedSortOrder===e);i.pinnedSortOrder=t-.5;n.map(e=>e).filter(e=>e.pinned).sort((e,t)=>e.pinnedSortOrder-t.pinnedSortOrder).forEach((e,t)=>{e.pinnedSortOrder=t});this.oModel.refresh(true)};p.prototype.isPinned=async function(t){if(e.last("/core/menu/personalization/enabled")===false){return true}const n=await this.getMenuModel();return n.getData().some(e=>e.id===t&&e.pinned)};p.prototype.isWorkPage=async function(e){if(this.oAdapter.isWorkPage){return this.oAdapter.isWorkPage(e)}return false};p.prototype._getNodeInfo=function(e,t,n,i){let r;for(let o=0;o<t.length;o++){if(!n){i=this._getManagerIdInNodeTree(e,t[o])}if(t[o].id===e){return{node:t[o],isRootNode:!n,managerId:i||null}}if(t[o].menuEntries&&t[o].menuEntries.length>0){r=this._getNodeInfo(e,t[o].menuEntries,true,i);if(r.node){return r}}}return{node:null,isRootNode:false,managerId:null}};p.prototype._nodeManagementPermitted=function(e,t,n){const i=this._getNodeInfo(e,t);if(!i.node){o.error(`Node with id ${e} cannot be found and will be skipped.`);return false}if(i.managerId&&i.managerId!==n){o.error(`Node with id ${e} cannot be managed by '${n}'`+` because it is already managed by '${i.managerId}'.`);return false}return true};p.prototype._getManagerIdInNodeTree=function(e,t,n){if(t.id===e){return n||t.managerId}if(t.managerId){n=t.managerId}if(t.menuEntries&&t.menuEntries.length>0){for(let i=0;i<t.menuEntries.length;++i){n=this._getManagerIdInNodeTree(e,t.menuEntries[i],n)}return n}return null};p.prototype._updateNode=function(e,t,i){const o=r(i||{});function a(e){if(e){e.uid=e.uid||n.generateUniqueId([]);(e.menuEntries||[]).forEach(a)}}a(o);return t.map(t=>{if(t.id===e){return o}if(t.menuEntries&&t.menuEntries.length>0){t.menuEntries=this._updateNode(e,t.menuEntries,o)}return t})};p.prototype._createEntryProviders=function(e,t,n){const i=n.getData();const r={};let o;for(let a=0;a<t.length;++a){o=t[a];if(!this._nodeManagementPermitted(o,i,e)){continue}r[o]={setData:function(e,t){const r=this._updateNode(e,i,t);n.setData(r)}.bind(this,o)}}return r};p.prototype._isManagerBlocked=function(e){return this._aBlockedList.indexOf(e)>-1};p.prototype._setManagerBlocked=function(e){this._aBlockedList.push(e)};p.prototype.getEntryProvider=async function(e,t){if(this._isManagerBlocked(e)){o.error(`ManagerId '${e}' is already listed as an entry manager.`);throw new Error(`ManagerId ${e} is already listed as an entry manager.`)}this._setManagerBlocked(e);const n=await this.getMenuModel();return this._createEntryProviders(e,t,n)};p.hasNoAdapter=false;return p});
//# sourceMappingURL=Menu.js.map