// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/bootstrap/SchedulingAgent/FLPScheduler","sap/ushell/bootstrap/SchedulingAgent/EventProcessor","sap/ushell/bootstrap/SchedulingAgent/FLPLoader","sap/ushell/bootstrap/SchedulingAgent/logger","sap/ushell/bootstrap/SchedulingAgent/state","sap/ushell/EventHub"],(e,t,o,n,i,a)=>{"use strict";const s={CONTINUE_ON_EVENT:"continueOnEvent",BY_EVENT:"byEvent",BY_COMPONENT_CREATE:"byComponentCreate",BY_REQUIRE:"byRequire",WAIT_IN_MS:"waitInMs"};const d={WAIT:"wait",ERROR:"error",DONE:"done",STEP:"step",BLOCKDONE:"blockDone",SKIPPED:"skip"};const g={oComponentsLoading:{},oPathsLoading:{},_initialize:function(){i.clear();n.clearHistory();i.setForModule(i.id.module.schedulingAgent.id,i.id.module.schedulingAgent.Initializing,"Scheduling Agent starting");const o=e.initializeSchedule();o.then(e=>{if(!e){i.setForModule(i.id.module.schedulingAgent.id,i.id.module.schedulingAgent.FatalError,"Configuration error!");return}t.initializeStepDoneListener(this);i.setForModule(i.id.module.schedulingAgent.id,i.id.module.schedulingAgent.Initialized,"Scheduling Agent ready");this.eventReceived()})},_processStepConfiguration:function(e){const t={sStepType:"",oData:{},sStepName:"",bConfigOk:false};if(e.oConfig.loadingMode===s.CONTINUE_ON_EVENT){t.sStepType=s.CONTINUE_ON_EVENT;t.sStepName=e.oContent.LoadingStep;t.oData.eventName=e.oConfig.continueOnEvent&&e.oConfig.continueOnEvent.eventName;t.oData.timeoutInMs=e.oConfig.continueOnEvent&&e.oConfig.continueOnEvent.timeoutInMs;t.oData.stepName=e.oContent.LoadingStep;t.bConfigOk=!!(t.oData.eventName&&t.oData.stepName)}else if(e.oConfig.loadingMode===s.BY_EVENT){t.sStepType=s.BY_EVENT;t.sStepName=e.oContent.LoadingStep;t.oData.eventName=e.oConfig.byEvent&&e.oConfig.byEvent.eventName;t.oData.eventData={};t.oData.eventData.data=e.oConfig.byEvent.eventData;t.oData.eventData.stepName=e.oContent.LoadingStep;t.bConfigOk=!!t.oData.eventName}else if(e.oConfig.loadingMode===s.BY_COMPONENT_CREATE){t.sStepType=s.BY_COMPONENT_CREATE;t.sStepName=e.oContent.LoadingStep;t.oData=e.oConfig.byComponentCreate&&e.oConfig.byComponentCreate.ui5ComponentOptions||{};t.bConfigOk=!!t.oData}else if(e.oConfig.loadingMode===s.BY_REQUIRE){t.sStepType=s.BY_REQUIRE;t.sStepName=e.oContent.LoadingStep;t.oData={};t.oData.sPath=e.oConfig.byRequire.path;t.oData.sStepName=e.oContent.LoadingStep;t.bConfigOk=!!t.oData.sPath}else if(e.oConfig.loadingMode===s.WAIT_IN_MS){t.sStepType=s.WAIT_IN_MS;t.sStepName=e.oContent.LoadingStep;t.oData.iWaitingTime=e.oConfig.waitInMs&&e.oConfig.waitInMs.waitingTime;t.oData.sStepName=e.oContent.LoadingStep;t.bConfigOk=!!(t.oData.iWaitingTime&&t.oData.sStepName)}return t},dumpState:function(){i.dump()},dumpHistory:function(){n.dumpHistory()},dumpSchedule:function(){e.dumpSchedule()},dumpAll:function(){n.dumpHistory();e.dumpSchedule();i.dump()},eventReceived:function(){i.setForModule(i.id.module.schedulingAgent.id,i.id.module.schedulingAgent.Working,"Agent is active");let n;do{n=e.getNextLoadingStep();if(n.sStatus===d.ERROR){i.setForModule(i.id.module.schedulingAgent.id,i.id.module.schedulingAgent.FatalError,"Fatal loading error. Loading aborted.");t.unregisterStepDoneListener();a.emit("FLPLoadingDone",Date.now());return}if(n.sStatus===d.DONE){i.setForModule(i.id.module.schedulingAgent.id,i.id.module.schedulingAgent.Done,"Loading finished");t.unregisterStepDoneListener();a.emit("FLPLoadingDone",Date.now());return}if(n.sStatus===d.BLOCKDONE){}if(n.sStatus===d.SKIPPED){}if(n.sStatus===d.STEP){const e=this._processStepConfiguration(n);if(!e.bConfigOk){i.setForLoadingStep(e.sStepName,i.id.loadingStep.Abort,"","Step configuration error");i.setForLoadingStep(e.sStepName,i.id.loadingStep.Skipped,"","Step configuration error");i.setForModule(i.id.module.schedulingAgent.id,i.id.module.schedulingAgent.FatalError,e,"Step configuration error!")}else if(e.sStepType===s.CONTINUE_ON_EVENT){t.listenToEvent(e.oData);i.setForLoadingStep(e.sStepName,i.id.loadingStep.InProgress,e.oData.eventName,"continueOnEvent step sent to Event Processor")}else if(e.sStepType===s.BY_EVENT){o.loadComponentByEvent(e.oData);i.setForLoadingStep(e.sStepName,i.id.loadingStep.InProgress,e.oData,"byEvent step sent to FLP Loader")}else if(e.sStepType===s.WAIT_IN_MS){o.waitInMs(e.oData);i.setForLoadingStep(e.sStepName,i.id.loadingStep.InProgress,`${e.oData.iWaitingTime}ms`,"WaitInMs step sent to FLP Loader")}else if(e.sStepType===s.BY_REQUIRE){const t=o.loadComponentByRequire(e.oData.sPath);this.oPathsLoading[e.sStepName]=t;i.setForLoadingStep(e.sStepName,i.id.loadingStep.InProgress,e.oData.sPath,"byRequire step sent to FLP Loader");const n=e.sStepName;t.then(()=>{i.setForLoadingStep(n,i.id.loadingStep.InProgress,"","Step's promise has resolved");delete this.oPathsLoading[n];a.emit("StepDone",n)}).catch(()=>{i.setForLoadingStep(n,i.id.loadingStep.FatalError,"","Step's promise failed");delete this.oPathsLoading[n];a.emit("StepFailed",n)})}else if(e.sStepType===s.BY_COMPONENT_CREATE){const t=o.loadComponentByComponentCreate(e);const n=e.sStepName;this.oComponentsLoading[n]=t;i.setForLoadingStep(n,i.id.loadingStep.InProgress,e.oData,"byComponentCreate step sent to FLP Loader");t.then(()=>{i.setForLoadingStep(n,i.id.loadingStep.InProgress,"","Step's promise has resolved");delete this.oComponentsLoading[n];a.emit("StepDone",n)}).catch(()=>{i.setForLoadingStep(n,i.id.loadingStep.FatalError,"","Step's promise failed");delete this.oComponentsLoading[n];a.emit("StepFailed",n)})}}}while(n.sStatus!==d.WAIT);i.setForModule(i.id.module.schedulingAgent.id,i.id.module.schedulingAgent.Waiting,"Agent waits")}};return g},false);
//# sourceMappingURL=SchedulingAgent.js.map