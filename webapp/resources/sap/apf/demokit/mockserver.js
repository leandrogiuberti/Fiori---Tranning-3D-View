/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2017 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/core/util/MockServer","sap/apf/utils/parseTextPropertyFile","sap/apf/utils/utils","sap/base/Log","sap/base/util/deepExtend","sap/base/util/extend","sap/ui/util/Storage","sap/ui/thirdparty/jquery"],function(t,e,a,r,n,i,o,jQuery){"use strict";var o=new o;return s;function s(s){var u=[];var f=o;var c={setupConstants:function(t){this.constants={LOCAL_STORAGE_CONFIGURATION:"ApfConfiguration",LOCAL_STORAGE_TEXTS:"ApfTexts",CONFIGURATION_ENTITYSET:"AnalyticalConfigurationQueryResults",TEXTS_ENTITYSET:"TextElementQueryResults",RUNTIME_DATA_PATH:t+"model/apf/",RUNTIME_SERVICE_URL:"/sap/hba/r/apf/core/odata/apf.xsodata/",RUNTIME_SERVICE_METADATA:t+"model/apf/AnalysisPath.xml",PATH_ENTITYSET:"AnalysisPathQueryResults",MODELER_DATA_PATH:t+"model/apf/",CONFIGURATION_SERVICE:"/sap/hba/r/apf/core/odata/modeler/AnalyticalConfiguration.xsodata/",CONFIGURATION_SERVICE_METADATA:t+"model/apf/AnalyticalConfiguration.xml",DEMOKIT_SERVICE_URL:"/tmp/demokit/demokit.xsodata/",DEMOKIT_METADATA:t+"model/data/Demokit.xml",DEMOKIT_DATA_PATH:t+"model/data/",DEMOKIT_HIERARCHY_SERVICE_URL:"/tmp/demokit/hierarchy.xsodata/",DEMOKIT_HIERARCHY_METADATA:t+"model/data/hierarchyMetadata.xml",HIERARCHY_SERVICE_SPEC:{levelProperty:"Customer_Level",hierarchyNode:"Customer_NodeID",parentNode:"Customer_ParentID",measureName:"Revenue"}}},teardownMockserver:function(){u.forEach(function(t){t.stop();t.destroy()})},_getStorage:function(){return f},getConfigurationId:function(t){var e;var a=t.indexOf(c.constants.LOCAL_STORAGE_CONFIGURATION);if(a!==-1){e=t.slice(a+c.constants.LOCAL_STORAGE_CONFIGURATION.length)}return e},getAllConfigurationIdsInStorage:function(){var t=[];Object.keys(sessionStorage).forEach(function(e){var a=c.getConfigurationId(e);if(a){t.push(a)}});return t},getConfigurationFromLocalStorage:function(t){return f.get(c.constants.LOCAL_STORAGE_CONFIGURATION+t)},idIsContained:function(t,e){return t.reduce(function(t,a){return t||a.AnalyticalConfiguration===e},false)},importTextsFromFile:function(t,a,n){n=n||function(){};jQuery.ajax({url:t,method:"GET",dataType:"text"}).done(function(t){var r=e(t,{instances:{messageHandler:function(){}}});var i=[];r.TextElements.forEach(function(t){i.push(t)});a.setEntitySetData(c.constants.TEXTS_ENTITYSET,i);n(i)}).fail(function(e,a,i){var o='while importing "'+t+'" jQuery.ajax fails with '+a+",  "+i;r.error(i);n({errorText:o,filePath:t})})},mockDemokitService:function(){var e=new t({rootUri:c.constants.DEMOKIT_SERVICE_URL});e.attachAfter(t.HTTPMETHOD.GET,c._postProcessDemokitData);e.simulate(c.constants.DEMOKIT_METADATA,c.constants.DEMOKIT_DATA_PATH);e.start();u.push(e);return e},_loadAnalyticalConfiguration:function(t){function e(t){var e=t.AnalyticalConfiguration;t.SerializedAnalyticalConfiguration=c.getConfigurationFromLocalStorage(e);t.AnalyticalConfigurationName=JSON.parse(t.SerializedAnalyticalConfiguration).analyticalConfigurationName}var a=t.mParameters.oEntry;if(a){if(a.SerializedAnalyticalConfiguration&&a.AnalyticalConfigurationName){e(a)}}else if(Array.isArray(t.mParameters.oFilteredData.results)){var r=t.mParameters.oFilteredData.results;r.forEach(function(t){e(t)})}},_initialLoadConfigurationsToMockServer:function(t,e){function a(t,e){for(var a in t){if(t.hasOwnProperty(a)){e(t[a])}}}var r=[];c.getAllConfigurationIdsInStorage().forEach(function(t){var e=c.getConfigurationFromLocalStorage(t);var a=JSON.parse(e);i(a)});a(e,i);a(e,n);t.setEntitySetData("AnalyticalConfigurationQueryResults",r);function n(t){var e=t.configHeader.AnalyticalConfiguration;if(!c.getConfigurationFromLocalStorage(e)){var a=JSON.stringify(t);f.put(c.constants.LOCAL_STORAGE_CONFIGURATION+e,a)}}function i(t){var e=t.configHeader.AnalyticalConfiguration;if(c.idIsContained(r,e)){return}var a=JSON.stringify(t);var n={AnalyticalConfiguration:e,Application:t.configHeader.Application,AnalyticalConfigurationName:t.configHeader.AnalyticalConfigurationName,SerializedAnalyticalConfiguration:a,CreationUTCDateTime:"/Date(1478533989544)/",LastChangeUTCDateTime:"/Date(1478533989544)/",CreatedByUser:"demokit engine",LastChangedByUser:null};r.push(n)}},savePath:function(t){var e=t.mParameters.oXhr.requestBody;var r=JSON.parse(e);if(!r.AnalysisPath){r.AnalysisPath=a.createPseudoGuid()}if(!r.CreationUTCDateTime){r.CreationUTCDateTime="/Date("+(new Date).getTime()+")/"}if(!r.LastChangeUTCDateTime){r.LastChangeUTCDateTime="/Date("+(new Date).getTime()+")/"}t.mParameters.oXhr.requestBody=JSON.stringify(r)},mockRuntimeService:function(e){var a=new t({rootUri:c.constants.RUNTIME_SERVICE_URL});a.attachBefore(t.HTTPMETHOD.PUT,c.savePath,c.constants.PATH_ENTITYSET);a.attachBefore(t.HTTPMETHOD.POST,c.savePath,c.constants.PATH_ENTITYSET);a.attachAfter(t.HTTPMETHOD.GET,c._loadAnalyticalConfiguration,c.constants.CONFIGURATION_ENTITYSET);a.attachAfter(t.HTTPMETHOD.GET,c.loadTexts,c.constants.TEXTS_ENTITYSET);a.simulate(c.constants.RUNTIME_SERVICE_METADATA,c.constants.RUNTIME_DATA_PATH);u.push(a);a.start();c._initialLoadConfigurationsToMockServer(a,e);return a},mockConfigurationService:function(e){var a=new t({rootUri:c.constants.CONFIGURATION_SERVICE});a.attachAfter(t.HTTPMETHOD.GET,c._loadAnalyticalConfiguration,c.constants.CONFIGURATION_ENTITYSET);a.attachAfter(t.HTTPMETHOD.PUT,c.saveAnalyticalConfiguration.bind(null,"PUT"),c.constants.CONFIGURATION_ENTITYSET);a.attachAfter(t.HTTPMETHOD.POST,c.saveAnalyticalConfiguration.bind(null,"POST"),c.constants.CONFIGURATION_ENTITYSET);a.attachAfter(t.HTTPMETHOD.POST,c.saveText,c.constants.TEXTS_ENTITYSET);a.attachAfter(t.HTTPMETHOD.PUT,c.saveText,c.constants.TEXTS_ENTITYSET);a.attachAfter(t.HTTPMETHOD.GET,c.loadTexts,c.constants.TEXTS_ENTITYSET);a.simulate(c.constants.CONFIGURATION_SERVICE_METADATA,c.constants.MODELER_DATA_PATH);u.push(a);a.start();c._initialLoadConfigurationsToMockServer(a,e);return a},saveAnalyticalConfiguration:function(t,e){var r=e.mParameters.oEntity.SerializedAnalyticalConfiguration;var n;var i=e.mParameters.oEntity.AnalyticalConfiguration;if(t==="POST"){i=a.createPseudoGuid();e.mParameters.oEntity.AnalyticalConfiguration=i;n=JSON.parse(r);n.configHeader.AnalyticalConfiguration=i;r=JSON.stringify(n);e.mParameters.oEntity.SerializedAnalyticalConfiguration=r}f.put(c.constants.LOCAL_STORAGE_CONFIGURATION+i,r)},saveText:function(t){t.mParameters.oEntity=t.mParameters.oEntity||{};if(!a.isValidGuid(t.mParameters.oEntity.TextElement)){t.mParameters.oEntity.TextElement=a.createPseudoGuid()}var e=f.get(c.constants.LOCAL_STORAGE_TEXTS);if(!e){e=[]}else{e=JSON.parse(e)}e.push({TextElement:t.mParameters.oEntity.TextElement,TextElementDescription:t.mParameters.oEntity.TextElementDescription,MaximumLength:t.mParameters.oEntity.MaximumLength,TextElementType:t.mParameters.oEntity.TextElementType});f.put(c.constants.LOCAL_STORAGE_TEXTS,JSON.stringify(e))},loadTexts:function(t){var e=f.get(c.constants.LOCAL_STORAGE_TEXTS);if(e){t.mParameters.oFilteredData=t.mParameters.oFilteredData||{};t.mParameters.oFilteredData.results=t.mParameters.oFilteredData.results||[];e=JSON.parse(e);e.forEach(function(e){t.mParameters.oFilteredData.results.push(e)})}},mockHierarchyService:function(){var e;jQuery.ajax({url:c.constants.DEMOKIT_DATA_PATH+"RevenueHryQueryResults.json",dataType:"json",async:false,success:function(t){e=t}});var a=new t({rootUri:c.constants.DEMOKIT_HIERARCHY_SERVICE_URL});a.attachAfter(t.HTTPMETHOD.GET,r);a.simulate(c.constants.DEMOKIT_HIERARCHY_METADATA,c.constants.DEMOKIT_DATA_PATH);a.start();u.push(a);return a;function r(t){var a;var r=t.getParameters().oFilteredData;var u=t.getParameters().oXhr.url;var T=u.indexOf("P_Currency")+14;var _=u.indexOf("%27",T);var A=u.slice(T,_);var p=m(JSON.parse(JSON.stringify(e)),"Currency",[A],true);p=m(p,"Country",f(u,"Country"),true);p=m(p,"Customer",f(u,"Customer"),true);a=p;var v=f(u,"Customer_NodeID");if(v.length>0){p=o(p,v)}var g=u.indexOf("Customer_ParentID%20eq")+28;if(g>=28){var h=u.indexOf("%27",g);var C=u.slice(g,h);p=m(p,"Customer_ParentID",[E(C)],false)}if(u.indexOf("Customer_Level%20eq%200")>-1){p=i(p)}l(p,a);d(p);p=n(p);s(p,u);var O=c._parseUrl(u);r.results=c._sortData(c._aggregateData(p),O.parameters.$orderby)}function n(t){var e=[];t.forEach(function(t){if(t.Revenue===undefined||t.Revenue>0){e.push(t)}});return e}function i(t){var e=[];var a=[];t.forEach(function(t){a.push(t.Customer_NodeID)});t.forEach(function(t){if(a.indexOf(t.Customer_ParentID)===-1){e.push(t)}});return e}function o(t,e){var a=[];var r=false;var n=[];e.forEach(function(t){n.push(E(t))});t.forEach(function(t){if(n.indexOf(t.Customer_NodeID)>-1){a.push(t);r=true}});function i(t){if(n.indexOf(t.Customer_ParentID)>-1&&n.indexOf(t.Customer_NodeID)===-1){a.push(t);n.push(t.Customer_NodeID);r=true}}while(r){r=false;t.forEach(i)}return a}function s(t,e){e=E(e);var a=e.indexOf("$select");if(a>-1&&t.length>0){var r=e.indexOf("$",a+1);Object.keys(t[0]).forEach(function(n){if(n!=="__metadata"){var i=e.indexOf(n+"&",a);var o=e.indexOf(n+",",a);var s=i===-1?o:i;if(s<0||r>-1&&s>r){t.forEach(function(t){delete t[n]})}}})}}function f(t,e){var a=0;var r=[];r[a]=[];var n=t.indexOf(e+"%20eq%20%27")+e.length+11;while(n>=e.length+11){if(o&&o>-1&&o<n){a++;r[a]=[]}var i=t.indexOf("%27",n);r[a].push(t.slice(n,i));var o=t.indexOf("%20and%20",i);n=t.indexOf(e+"%20eq%20%27",i)+e.length+11}if(a>0){var s=r[0];var u=[];r.forEach(function(t){s.forEach(function(e){if(t.indexOf(e)>=0){u.push(e)}});s=u});return u}return r[a]}function l(t,e){t.forEach(function(t){if(t.Revenue===null){t.Revenue=T(t,e)}})}function T(t,e){var a=t.Customer_NodeID;var r=0;e.forEach(function(t){if(t.Customer_ParentID===a){if(t.Revenue===null){r+=T(t,e)}else{r+=t.Revenue}}});return r}function E(t){return t.replace(new RegExp("%3a","g"),":").replace(new RegExp("%20","g")," ").replace(new RegExp("%2c","g"),",")}function m(t,e,a,r){if(a.length===0){return t}var n=[];t.forEach(function(t){if(t[e]===null&&r||a.indexOf(t[e])>=0){n.push(t)}});return n}function d(t){t.forEach(function(t){t.__metadata={id:"/tmp/demokit/hierarchy.xsodata/RevenueHryQueryResults('"+t.GenID+"')",type:"tmp.demokit.demokit.RevenueHryQueryResultsType",uri:"/tmp/demokit/hierarchy.xsodata/RevenueHryQueryResults('"+t.GenID+"')"}})}},_postProcessDemokitData:function(t){var e=t.getParameter("oXhr");var a=t.getParameter("oFilteredData");if(e&&a){var r=c._parseUrl(e.url);var n=r.couldParse&&(r.parameters.$top!==undefined||r.parameters.$skip!==undefined);if(n){var o=i({},r.parameters);delete o.$top;delete o.$skip;var s=c._generateUrlString(r.path,o);var u;jQuery.ajax({url:s,dataType:"json",async:false,success:function(t){u=t.d}});var f=r.parameters.$skip||0;var l=r.parameters.$top;var T;if(l){T=u.results.slice(f,Number(f)+Number(l))}else{T=u.results.slice(f)}a.results=T;a.__count=u.__count}else{a.results=c._attachGUIDs(c._sortData(c._aggregateData(a.results||[]),r.parameters.$orderby));a.__count=a.results.length}}},_aggregateData:function(t){var e=["Revenue","ShippingCosts","Discount","NumberOfOrders"];var a=[];if(t.length>0){var r={};var i=Object.getOwnPropertyNames(t[0]);var o=[];var s=[];i.forEach(function(t){if(t!=="__metadata"){if(e.indexOf(t)>-1){s.push(t)}else{o.push(t)}}});if(s.length>0){t.forEach(function(t){var e="";var a=false;o.forEach(function(r){if(t[r]===null){a=true}e=e+t[r]});if(a){return}if(!r[e]){r[e]=n({},t);s.forEach(function(a){r[e][a]=Number(t[a])})}else{s.forEach(function(a){r[e][a]=Number(r[e][a])+Number(t[a])})}});a=jQuery.map(r,function(t){return t});if(a.length>0){return a}}else if(o.length===1||o.length===2){var u=[];t.forEach(function(t){if(u&&Array.prototype.indexOf.call(u,t[o[0]])===-1){u.push(t[o[0]]);a.push(t)}});if(a.length>0){return a}}}return t},_sortData:function(t,e){var a=c._parseOrderBy(e);if(a.length===0){return t}var r=t.slice().sort(function(t,e){var r=a.filter(function(a){return t[a.attr]!==e[a.attr]})[0];if(!r){return 0}if(t[r.attr]>e[r.attr]){return r.direction}return-r.direction});return r},_parseOrderBy:function(t){if(typeof t!=="string"||t.trim()===""){return[]}var e=t.split(",").map(function(t){var e=t.trim().split("%20");if(e[1]&&e[1].toLowerCase().trim()==="desc"){return{attr:e[0].trim(),direction:-1}}return{attr:e[0].trim(),direction:1}});return e},_parseUrl:function(t){if(typeof t!=="string"){return{couldParse:false}}var e=t.split("?");if(e.length<1||e.length>2){return{couldParse:false}}else if(e.length==1){return{couldParse:true,path:e[0],parameters:{}}}var a={};e[1].split("&").map(function(t){var e=t.split("=");var a=e[0];var r=e[1];return{lhs:a,rhs:r}}).forEach(function(t){a[t.lhs]=t.rhs});return{couldParse:true,path:e[0],parameters:a}},_generateUrlString:function(t,e){var a=Object.keys(e).map(function(t){return t+"="+e[t]}).join("&");return t+"?"+a},_attachGUIDs:function(t){return t.map(function(t){if(t.__metadata){var e="('"+a.createPseudoGuid()+"')";var r=n({},t);r.__metadata.uri=t.__metadata.uri.replace("('undefined')",e);r.__metadata.id=t.__metadata.id.replace("('undefined')",e);return r}return t})}};c.setupConstants(s);return c}});
//# sourceMappingURL=mockserver.js.map