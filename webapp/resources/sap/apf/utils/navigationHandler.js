/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/utils/filterSimplify","sap/apf/utils/utils","sap/apf/utils/executeFilterMapping","sap/apf/utils/exportToGlobal","sap/base/util/deepExtend","sap/base/util/uid","sap/ui/core/routing/HashChanger","sap/ui/thirdparty/jquery"],function(e,t,i,a,n,r,s,jQuery){"use strict";function o(a){var o;var c;var p;var u=a.instances.messageHandler;var f=this;var l=a.constructors&&a.constructors.FilterReduction||e.FilterReduction;var v;var g=false;this.getNavigationTargets=function(){var e,i;var r=sap.ui.require("sap/ushell/Container")?.getService("CrossApplicationNavigation");if(!r){if(!g){i=u.createMessageObject({code:5074});u.putMessage(i);g=true}c={global:[],stepSpecific:[]};return t.createPromise(c)}e=jQuery.Deferred();a.functions.getCumulativeFilterUpToActiveStep().done(function(t){if(c&&t.isEqual(p)){e.resolve(h(c));return e.promise()}p=t;if(!o){d()}c=n([],o);c.forEach(function(e){e.text=""});s(t).done(function(t){c=t;e.resolve(h(c))})});return e.promise();function s(e){var t=jQuery.Deferred();var i=[];var n=[];var s;c.forEach(function(t){var o;if(t.useDynamicParameters){s=s||A(e);t.parameters=F(t.parameters,s)}o=jQuery.Deferred();n.push(o);r.getLinks({semanticObject:t.semanticObject,action:t.action,params:S(t.parameters),ignoreFormFactor:false,ui5Component:a.instances.component}).then(function(e){e.forEach(function(e){var a=e.intent.split("-");var n=a[1].split("?");n=n[0].split("~");if(e.text!==""&&n[0]===t.action){t.text=e.text;i.push(t)}});o.resolve()},function(){o.resolve()})});jQuery.when.apply(jQuery,n).done(function(){t.resolve(i)});return t.promise()}};this.navigateToApp=function(e){if(!o){d()}var t=m(e);if(!t){return}var n=s&&s.getInstance();a.functions.getCumulativeFilterUpToActiveStep().done(function(e){if(a.functions.isFilterReductionActive&&a.functions.isFilterReductionActive()){v=v||new l;var r=v.reduceFilter(u,e);if(r===null){u.putMessage(u.createMessageObject({code:5235}))}else{e=r}}if(!t.filterMapping||!t.filterMapping.requestForMappedFilter){o(null,null)}else{var s=a.functions.createRequest(t.filterMapping.requestForMappedFilter);i(e,s,t.filterMapping.target,o,u)}function o(i,r){var s;if(r){return}if(i){e=e.addAnd(i)}var o=sap.ui.require("sap/ushell/Container")?.getService("CrossApplicationNavigation");if(o){a.instances.serializationMediator.serialize(true).done(function(i){f.generateSelectionVariant(e).done(function(r){var c;var p={};if(t.useDynamicParameters){c=A(e)}p.sapApfState=i;p.sapApfCumulativeFilter=e.mapToSapUI5FilterExpression();p.selectionVariant=r;s=o.createEmptyAppState(a.instances.component);s.setData(p);s.save();if(n){n.replaceHash("sap-iapp-state="+s.getKey())}var u=t.parameters;if(t.useDynamicParameters){u=F(u,c)}o.toExternal({target:{semanticObject:t.semanticObject,action:t.action},appStateKey:s.getKey(),params:S(u)},a.instances.component)})})}}})};this.checkMode=function(){var e=jQuery.Deferred();var t=s&&s.getInstance&&s.getInstance();var i=/(?:sap-iapp-state=)([^&=]+)/;var n,r,o,c;if(t){o=i.exec(t.getHash());if(o){n=o[1]}}r=a.functions.getXappStateId();if(n){sap.ui.require("sap/ushell/Container").getService("CrossApplicationNavigation").getAppState(a.instances.component,n).done(function(t){c=t.getData();if(c.sapApfState){a.instances.serializationMediator.deserialize(c.sapApfState).done(function(){e.resolve({navigationMode:"backward"})})}})}else if(r){sap.ui.require("sap/ushell/Container").getService("CrossApplicationNavigation").getAppState(a.instances.component,r).done(function(t){c=t.getData();if(c&&c.sapApfCumulativeFilter){e.resolve({navigationMode:"forward",sapApfCumulativeFilter:c.sapApfCumulativeFilter})}else{e.resolve({navigationMode:"forward"})}})}else{e.resolve({navigationMode:"forward"})}if(t){t.replaceHash("")}return e.promise()};this.generateSelectionVariant=function(e){var t=jQuery.Deferred();if(!a.functions.isFilterReductionActive||!a.functions.isFilterReductionActive()){v=v||new l;e=v.reduceFilter(u,e)}if(!v||!v.isContradicted()){var i=e.mapToSelectOptions(a.functions.getAllParameterEntitySetKeyProperties);i.done(function(e){e.SelectionVariantID=r();t.resolve(e)})}else{var n={};n={SelectionVariantID:r(),Text:"Filter could not be converted to a selectionVariant"};t.resolve(n)}return t.promise()};function d(){o=a.functions.getNavigationTargets()}function m(e){for(var t=0,i=o.length;t<i;t++){if(o[t].id===e){return o[t]}}}function S(e){var t;if(e&&e.length>0){t={};e.forEach(function(e){t[e.key]=e.value})}return t}function h(e){var t=n([],e);var i={global:[],stepSpecific:[]};t.forEach(function(e){if(e.isStepSpecific&&r(e.id)){delete e.isStepSpecific;i.stepSpecific.push(e)}else if(!e.isStepSpecific){delete e.isStepSpecific;i.global.push(e)}});return i;function r(e){var t=false;var i;var n=a.functions.getActiveStep();if(n&&n.getAssignedNavigationTargets){i=n.getAssignedNavigationTargets();if(i&&Array.isArray(i)){i.forEach(function(i){if(e===i.id){t=true}})}}return t}}function A(e){v=v||new l;var t=v.reduceFilter(u,e)||e;return t.getSingleValueTerms()}function F(e,t){t.forEach(function(t){e=e||[];e.push({key:t.property,value:t.value})});return e}}a("sap.apf.utils.NavigationHandler",o);return o},true);
//# sourceMappingURL=navigationHandler.js.map