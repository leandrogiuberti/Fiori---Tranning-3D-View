/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2015 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/utils/filter","sap/apf/core/utils/filterTerm","sap/apf/core/constants","sap/apf/utils/exportToGlobal"],function(e,t,r,a){function n(a){"use strict";var n=jQuery.Deferred();var s=a.instances.startParameter.getEvaluationId();var i=a.instances.startParameter.getXappStateId();var o=a.instances.messageHandler;var c=this;var l=a.functions.ajax;this.getCombinedContext=function(){if(i){u()}else if(s){f()}else{n.resolve(new e(o))}return n.promise();function t(t){if(t.levelOperator===r.BooleFilterOperators.OR){return new e(o,t)}return t}function u(){sap.ui.require("sap/ushell/Container")?.getService("CrossApplicationNavigation").getAppState(a.instances.component,i).done(function(r){var a=r.getData();if(a&&a.sapApfCumulativeFilter){n.resolve(t(e.transformUI5FilterToInternal(o,a.sapApfCumulativeFilter)))}else if(a&&a.selectionVariant){n.resolve(t(c.convertSelectionVariantToFilter(a.selectionVariant)))}else{n.resolve(new e(o))}}).fail(function(){var e=o.createMessageObject({code:5045,aParameters:[i]});o.putMessage(e)})}function f(){a.functions.getConfigurationProperties().done(function(r){var a=r&&r.smartBusiness&&r.smartBusiness.runtime;if(a&&a.service){var i=a.service+"/EVALUATIONS('"+s+"')/FILTERS?$format=json";l({url:i,success:function(r){var a;var s;var i=new e(o);var c=[];var l={};r.d.results.forEach(u);for(a in l){if(l.hasOwnProperty(a)){s=new e(o);l[a].forEach(f);c.push(s)}}c.forEach(p);n.resolve(t(i));function u(t){if(!l[t.NAME]){l[t.NAME]=[]}l[t.NAME].push(new e(o,t.NAME,t.OPERATOR,t.VALUE_1,t.VALUE_2))}function f(e){s.addOr(e)}function p(e){i.addAnd(e)}},error:function(e,t,r,a){var n=o.createMessageObject({code:5043,aParameters:[s,t]});if(a){n.setPrevious(a)}o.putMessage(n)}})}else{var c=o.createMessageObject({code:5044,aParameters:[s]});o.putMessage(c)}})}};this.convertParameterObject=function(e){var a;if(!e.PropertyName||e.PropertyValue===undefined||e.PropertyValue===null){if(!e.PropertyName){a=o.createMessageObject({code:5046,aParameters:[i]})}else{a=o.createMessageObject({code:5047,aParameters:[i,e.PropertyName]})}o.putMessage(a)}return new t(o,e.PropertyName,r.FilterOperators.EQ,e.PropertyValue)};this.convertSelectOption=function(t){var r=this;var a=null;var n;var s;if(!t.PropertyName||!t.Ranges||!Array.isArray(t.Ranges)){if(!t.PropertyName){s=o.createMessageObject({code:5048,aParameters:[i]})}else{s=o.createMessageObject({code:5049,aParameters:[i,t.PropertyName]})}o.putMessage(s)}a=new e(o);for(n=0;n<t.Ranges.length;n++){var c=r.convertRange(t.Ranges[n],t.PropertyName);a.addOr(c)}return a};this.convertRange=function(e,r){var a,n,s,c;if(e.Sign!="I"){a=o.createMessageObject({code:5050,aParameters:[i,r]});o.putMessage(a)}if(e.Option==="BT"&&(e.High===undefined||e.High===null)){a=o.createMessageObject({code:5051,aParameters:[i,r]});o.putMessage(a)}if(e.Option==="CP"){c=e.Low.split("*");if(c.length>3||c.length===3&&(c[0].length!==0||c[2].length!==0)||c.length===1){a=o.createMessageObject({code:5069,aParameters:[i,r]});o.putMessage(a)}if(e.Low.indexOf("*")===0&&e.Low.lastIndexOf("*")===e.Low.length-1){n=e.Low.substr(1,e.Low.lastIndexOf("*")-1);s="Contains"}else if(e.Low.indexOf("*")===0){n=e.Low.substr(1,e.Low.length-1);s="EndsWith"}else if(e.Low.lastIndexOf("*")===e.Low.length-1){n=e.Low.substring(0,e.Low.indexOf("*"));s="StartsWith"}return new t(o,r,s,n,e.High)}return new t(o,r,e.Option,e.Low,e.High)};this.convertSelectionVariantToFilter=function(t){var r=this;var a=new e(o);var n;if(!t){return a}if(t.Parameters&&!Array.isArray(t.Parameters)){return a}if(t.SelectOptions&&!Array.isArray(t.SelectOptions)){return a}if(t.Parameters){for(n=0;n<t.Parameters.length;n++){var s=r.convertParameterObject(t.Parameters[n]);a.addAnd(s)}}if(t.SelectOptions){for(n=0;n<t.SelectOptions.length;n++){var i=r.convertSelectOption(t.SelectOptions[n]);a.addAnd(i)}}return a}}a("sap.apf.utils.ExternalContext",n);return n},true);
//# sourceMappingURL=externalContext.js.map