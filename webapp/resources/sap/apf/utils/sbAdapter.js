/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/abap/LrepConnector","sap/base/Log","sap/base/util/deepExtend","sap/ui/thirdparty/jquery","sap/ui/thirdparty/datajs"],function(e,n,a,jQuery,t){"use strict";var i={semanticObject:"FioriApplication",action:"executeAPFConfiguration"};var r={semanticObject:"FioriApplication",action:"editAPFConfiguration"};var o={semanticObject:"FioriApplication",action:"executeAPFConfigurationS4HANA"};var s={semanticObject:"FioriApplication",action:"editAPFConfigurationS4HANA"};var c="/sap/hba/r/apf/core/odata/modeler/AnalyticalConfiguration.xsodata/AnalyticalConfigurationQueryResults";var u=undefined;var p={};p._hanaConfigurations=undefined;p._lrepConfigurations=undefined;p.getConfigurations=function(e,n){var a=jQuery.Deferred();var t=[];jQuery.when(l(),f()).then(function(r,s){t=s.concat(r);var c=y(e,n);if(c&&!I(c,i)&&!I(c,o)){t.forEach(function(e){e.runtimeIntent=c})}a.resolve(t)});return a.promise()};p.getTargetMappingInstaceIDsWithConfigurations=function(e,n,a,t){var r=jQuery.Deferred();var s=[];var c=[];jQuery.when(l(),f()).then(function(p,f){d(a,t).then(function(a){return u(1e3).then(function(){s=f.concat(p);var t=y(e,n);a.forEach(function(e){if(e.semanticParameters["sap-apf-configuration-id"]){var n=e.semanticParameters["sap-apf-configuration-id"].defaultValue;s.forEach(function(a){if(n.value===a.id){a.targetMappingInstanceId=e;if(t&&!I(t,i)&&!I(t,o)){a.runtimeIntent=t}c.push(a)}})}});r.resolve(c)})})});return r.promise();function u(e,n){return new Promise(function(a){setTimeout(a.bind(null,n),e)})}};p.getConfigurationNameById=function(e){var n=jQuery.Deferred();if(!e){return n.resolve("")}if(e.indexOf(".")>-1){l().done(a)}else{f().done(a)}return n.promise();function a(a){a.forEach(function(a){if(a.id===e){n.resolve(a.title)}});if(n.state!=="resolved"){n.resolve("")}}};function f(){var e=jQuery.Deferred();if(!p._hanaConfigurations){var n={requestUri:c+"?$select=AnalyticalConfiguration,AnalyticalConfigurationName,Application",async:true,method:"GET"};t.request(n,o,s)}else{e.resolve(a([],p._hanaConfigurations))}return e.promise();function o(n){var t=[];n.results.forEach(function(e){t.push({title:e.AnalyticalConfigurationName,id:e.AnalyticalConfiguration,runtimeIntent:i,modelerIntent:r,configurationId:e.AnalyticalConfiguration,applicationId:e.Application})});p._hanaConfigurations=a([],t);e.resolve(t)}function s(){p._hanaConfigurations=[];e.resolve([])}}function l(){var e=jQuery.Deferred();if(!p._lrepConfigurations){v().then(function(n){var t=[];n.response.forEach(function(e){var n;var a;if(e.fileType&&e.fileType==="apfconfiguration"){n=m(e);a=e.name;t.push({title:C(e,"apfdt-configname"),id:n+"."+a,runtimeIntent:o,modelerIntent:s,configurationId:a,applicationId:n})}});p._lrepConfigurations=a([],t);e.resolve(t)},function(){e.resolve([]);p._lrepConfigurations=[]})}else{e.resolve(a([],p._lrepConfigurations))}return e.promise()}function g(e){var n;const a=sap.ui.require("sap/ushell/Container");if(a?.getService){if(e=="S")n=a.getService("PageBuilding","CONF").getFactory();else if(e=="C")n=a.getService("PageBuilding","CUST").getFactory();else n=a.getService("PageBuilding","PERS").getFactory();return n}}function d(e,a){var t=jQuery.Deferred();var i=a;var r=[];var o=g(e);var s=o.getPageBuildingService();s.readCatalog(i,jQuery.proxy(function(e){if(e&&e.Chips&&e.Chips.results instanceof Array){jQuery.each(e.Chips.results,jQuery.proxy(function(e,a){try{if(a&&a.baseChipId==="X-SAP-UI2-CHIP:/UI2/ACTION"){u=a;var i=JSON.parse(u.configuration);var o=JSON.parse(i.tileConfiguration);var s=o.ui5_component;var c="smartbusiness";var p="sap.apf";if(s&&s.indexOf(c)===-1){h(s).then(function(e){jQuery.each(e.response.results,jQuery.proxy(function(e,a){if(a&&a["sap.ui5/dependencies/libs"]){if(a["sap.ui5/dependencies/libs"].indexOf(p)!==-1){var t;var i=JSON.parse(u.configuration);var o=JSON.parse(i.tileConfiguration);var s=o.signature&&o.signature.parameters;if(u.ChipBags&&u.ChipBags.results instanceof Array){jQuery.each(u.ChipBags.results,jQuery.proxy(function(e,a){if(a&&a.id==="tileProperties"){if(a.ChipProperties&&a.ChipProperties.results instanceof Array){jQuery.each(a.ChipProperties.results,jQuery.proxy(function(e,n){if(n&&n.name==="display_title_text"){t=n.value;return false}},this))}else{n.error("sbAdapter/getTargetMappingInstanceIDsFromCatalogID","Unable to read the properties inside the chip bag 'tileProperties' for "+u.catalogPageChipInstanceId)}return false}},this))}else{n.error("sbAdapter/getTargetMappingInstanceIDsFromCatalogID","Unable to read the chip bags for "+u.catalogPageChipInstanceId)}r.push({instanceID:u.catalogPageChipInstanceId||"",title:t||"",semanticObject:o.semantic_object||"",semanticAction:o.semantic_action||"",ui5Component:o.ui5_component||"",semanticParameters:s||{}});window.TargetMapping=r}}},this))},function(){t.resolve([])})}}}catch(e){n.error("sbAdapter/getTargetMappingInstanceIDsFromCatalogID",e&&e.message)}},this));t.resolve(r)}else{n.error("sbAdapter/getTargetMappingInstanceIDsFromCatalogID","Invalid catalog object");t.reject()}},this),jQuery.proxy(function(e,n){t.reject(n)},this));return t.promise()}function v(){var n=e.createConnector();var a={async:true,contentType:"application/json"};var t=[];t.push({name:"deep-read",value:true});t.push({name:"metadata",value:true});t.push({name:"layer",value:"CUSTOMER"});var i="/sap/bc/lrep/content/sap/apf/dt/";i+=n._buildParams(t);return n.send(i,"GET",{},a)}function h(n){var a=e.createConnector();var t={async:true,contentType:"application/json"};var i=[];i.push({name:"sap.app/id",value:n});i.push({name:"fields",value:"sap.ui5/dependencies/libs"});var r="/sap/bc/ui2/app_index";r+=a._buildParams(i);return a.send(r,"GET",{},t)}function m(e){var n=e.ns.split("/");return n[n.length-2]}function C(e,n){var a;e.metadata.forEach(function(e){if(e.name===n){a=e.value}});return a}function I(e,n){if(e.semanticObject===n.semanticObject&&e.action===n.action){return true}return false}function y(e,n){if(e&&n){return{semanticObject:e,action:n}}}return p},true);
//# sourceMappingURL=sbAdapter.js.map