/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/step","sap/apf/core/utils/uriGenerator","sap/apf/utils/exportToGlobal","sap/ui/model/odata/ODataUtils","sap/ui/model/odata/OperationMode","sap/ui/model/odata/v2/ODataModel","sap/ui/model/Sorter","sap/ui/thirdparty/jquery"],function(e,t,r,i,a,n,o,jQuery){"use strict";function s(r,s,p,u,c){e.constructor.call(this,r,s,p,u,c);var d;var l;var g;this.type="hierarchicalStep";var h=p.getConfigurationById(s.request).service;var f=p.getConfigurationById(s.request).entityType;var v=c.getAnnotationsForService(h);var y=s.hierarchyProperty;var m=jQuery.Deferred();var F=p.getConfigurationById(s.binding).requiredFilters;var P=c.getStartParameterFacade().getSapSystem();if(P){h=i.setOrigin(h,{force:true,alias:P})}jQuery.when(c.getMetadata(h),c.getEntityTypeMetadata(h,f)).then(function(e,t){var i=e.getHierarchyAnnotationsForProperty(f,y);if(i.type==="messageObject"){r.putMessage(i)}else{l=E(y,i)}d=p.createRequest({service:h,entityType:f,selectProperties:b(F[0],e,i),type:"request",id:"SelectionValidationRequest"});m.resolve(e,i,t)});var S=new n(h,{annotationURI:v});function b(e,t,r){var i=[e];var a=t.getPropertyMetadata(f,e)["sap:text"];if(a){i.push(a)}if(r.hierarchyNodeExternalKeyFor){i.push(r.hierarchyNodeExternalKeyFor)}return i}function E(e,r){var i=[e];for(var a in r){i.push(r[a])}i=i.concat(p.getConfigurationById(s.request).selectProperties);return t.getSelectString(i)}this.update=function(e,i){m.done(function(n,o,s){var p=e.restrictToProperties(n.getFilterablePropertiesAndParameters(f));var u=!p.isEqual(g);g=p.copy();var c="/"+t.generateOdataPath(r,n,f,e,n.getUriComponents(f).navigationProperty);var h={};h.path=c;var v=e.restrictToProperties(n.getFilterableProperties(f));if(!v.isEmpty()){h.filters=[v.mapToSapUI5FilterExpression()]}h.parameters={select:l,operationMode:a.Server,useServerSideApplicationFilters:true,treeAnnotationProperties:o};h.sorter=this.getSorter();this.getBinding().updateTreetable(h,S,s,u);if(!this.getFilter().isEmpty()&&u){var y=v.removeTermsByProperty(F[0]);d.sendGetInBatch(y.addAnd(this.getFilter()),function(e){var t=e.data;var r=this.getFilter().getFilterTerms();var a=[];r.forEach(function(e){t.forEach(function(t){if(t[F[0]]===e.getValue()){a.push(t)}})});this.getBinding().setFilterValues(a);i({},true)}.bind(this))}else{i({},u)}}.bind(this))};this.getSorter=function(){var e=[];var t=this.getBinding().getRequestOptions();if(t&&t.orderby&&t.orderby.length>0){t.orderby.forEach(function(t){e.push(new o(t.property,!t.ascending))})}if(e.length===0){return}return e};this.setData=function(){};this.adjustCumulativeFilter=function(e){if(F[0]&&!this.getFilter().isEmpty()){return e.removeTermsByProperty(F[0])}return e};this.whenMetadataInitialized=function(){return m.promise()}}r("sap.apf.core.HierarchicalStep",s);return s});
//# sourceMappingURL=hierarchicalStep.js.map