/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/constants","sap/apf/core/utils/filter","sap/apf/utils/exportToGlobal","sap/ui/thirdparty/jquery"],function(e,t,a,jQuery){"use strict";function s(a){var s;this.createPath=function(e,t,s){var i;var r=c(s);f().then(function(t){i={data:{AnalysisPath:"",AnalysisPathName:e,LogicalSystem:t,ApplicationConfigurationURL:a.functions.getComponentName(),SerializedAnalysisPath:JSON.stringify(s),StructuredAnalysisPath:JSON.stringify(r)},method:"POST"};if(a.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId()){i.data.AnalyticalConfiguration=a.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId().configurationId}n(i,o)},function(e){t({oResponse:undefined,status:"failed"},{},e)});function o(e,s,n){if(n){t({oResponse:e,status:"failed"},s,n)}else{a.instances.messageHandler.check(e&&e.data&&e.statusCode===201,"Persistence create Path - proper response");t({AnalysisPath:e.data.AnalysisPath,status:"successful"},s,n)}}};this.readPaths=function(e){var t={method:"GET"};n(t,s.bind(this));function s(t,s,n){if(!n&&t&&t.data&&t.data.results){for(var i in t.data.results){t.data.results[i].StructuredAnalysisPath=JSON.parse(t.data.results[i].StructuredAnalysisPath)}}else if(!n||t.statusCode!==200){n=a.instances.messageHandler.createMessageObject({code:"5211"})}if(n){e({oResponse:t,status:"failed"},s,n)}else{e({paths:t.data.results,status:"successful"},s,n)}}};this.deletePath=function(e,t){var s={method:"DELETE"};n(s,i.bind(this),e);function i(e,s,n){if(e.statusCode!==204&&!n){n=a.instances.messageHandler.createMessageObject({code:5201});n.setPrevious(a.instances.messageHandler.createMessageObject({code:5200,aParameters:[e.statusCode,e.statusText]}))}if(n){t({oResponse:e,status:"failed"},s,n)}else{t({status:"successful"},s,n)}}};this.modifyPath=function(e,t,s,i){var r=c(i);f().then(function(s){var c={data:{AnalysisPath:e,AnalysisPathName:t,LogicalSystem:s,ApplicationConfigurationURL:a.functions.getComponentName(),SerializedAnalysisPath:JSON.stringify(i),StructuredAnalysisPath:JSON.stringify(r)},method:"PUT"};if(a.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId()){c.data.AnalyticalConfiguration=a.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId().configurationId}n(c,o.bind(this),e)},function(e){s({oResponse:undefined,status:"failed"},{},e)});function o(t,n,i){if(t.statusCode!==204&&!i){i=a.instances.messageHandler.createMessageObject({code:5201});i.setPrevious(a.instances.messageHandler.createMessageObject({code:5200,aParameters:[t.statusCode,t.statusText]}))}if(i){s({oResponse:t,status:"failed"},n,i)}else{s({AnalysisPath:e,status:"successful"},n,i)}}};this.openPath=function(e,t){var s={method:"GET"};n(s,i,e);function i(e,s,n){var i;if(!n&&e&&e.statusCode===200&&e.data&&e.data.SerializedAnalysisPath){e.data.SerializedAnalysisPath=JSON.parse(e.data.SerializedAnalysisPath)}if(n){i=a.instances.messageHandler.createMessageObject({code:"5210"});i.setPrevious(n);a.instances.messageHandler.putMessage(i)}t({path:e.data,status:"successful"},s)}};function n(e,t,s){var n=function(e,a){o().done(function(e){t(a,e,undefined)})};var c=function(e){var s;if(e.messageObject&&e.messageObject.getCode&&e.messageObject.getCode()===5021){o().done(function(a){t(e,a,e.messageObject)});return}var n=r(e.response.body);if(n!==undefined){s=a.instances.messageHandler.createMessageObject({code:n})}if(e.response.body.match("274")){s=a.instances.messageHandler.createMessageObject({code:"5207"})}if(e.response.statusCode===400){s=a.instances.messageHandler.createMessageObject({code:"5203"})}if(e.response.statusCode===403){s=a.instances.messageHandler.createMessageObject({code:"5206"})}if(e.response.statusCode===405){s=a.instances.messageHandler.createMessageObject({code:"5202"})}if(e.response.statusCode===404){s=a.instances.messageHandler.createMessageObject({code:"5208"})}if(!s&&e.response.statusCode===500){s=a.instances.messageHandler.createMessageObject({code:"5200",aParameters:[e.response.statusCode,e.response.statusText]})}if(!s){s=a.instances.messageHandler.createMessageObject({code:"5201"})}a.instances.messageHandler.putMessage(s);o().done(function(a){t(e,a,s)})};a.instances.coreApi.getPersistenceConfiguration().done(function(r){var d=r.path.service+"/"+r.path.entitySet;a.instances.coreApi.getXsrfToken(r.path.service).done(function(r){e.headers={"x-csrf-token":r};switch(e.method){case"GET":if(!e.data&&s){e.requestUri=d+"('"+s+"')";a.instances.coreApi.odataRequest(e,n,c)}else if(!e.data&&!s){i().then(function(t){e.requestUri=d+t;a.instances.coreApi.odataRequest(e,n,c)},function(e){o().done(function(a){t({},a,e)})})}break;case"POST":if(e.data&&!s){e.requestUri=d}a.instances.coreApi.odataRequest(e,n,c);break;case"DELETE":if(!e.data&&s){e.requestUri=d+"('"+s+"')"}a.instances.coreApi.odataRequest(e,n,c);break;case"PUT":if(e.data&&s){e.requestUri=d+"('"+s+"')"}a.instances.coreApi.odataRequest(e,n,c);break;default:a.instances.coreApi.odataRequest(e,n,c);break}})})}function i(){var e=jQuery.Deferred();f().then(function(t){var s="";if(a.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId()){s="AnalyticalConfiguration%20eq%20'"+a.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId().configurationId+"'%20and%20"}var n="?$select=AnalysisPath,AnalysisPathName,StructuredAnalysisPath,CreationUTCDateTime,LastChangeUTCDateTime&$filter=("+s+"LogicalSystem%20eq%20'"+t+"'%20and%20"+"ApplicationConfigurationURL%20eq%20'"+a.functions.getComponentName()+"')"+"&$orderby=LastChangeUTCDateTime%20desc";e.resolve(n)},function(t){e.fail(t)});return e.promise()}function r(e){var t=e.match("52[0-9]{2}");if(t){return t[0]}return undefined}function c(e){var t=[];var a=e.path.steps;var s;for(var n in a){t.push({stepId:a[n].stepId,selectedRepresentationId:a[n].binding.selectedRepresentationId})}s={steps:t,indexOfActiveStep:e.path.indicesOfActiveSteps[0]};return s}function o(){var e=jQuery.Deferred();a.instances.coreApi.getPersistenceConfiguration().done(function(t){a.instances.coreApi.getEntityTypeMetadata(t.path.service,t.path.entitySet).done(function(t){e.resolve(t)})});return e}function d(e){var t=e&&e.getFilterTermsForProperty("SAPClient");if(t===undefined||t.length!==1){return undefined}return t[0].getValue()}function u(n,i){a.instances.coreApi.getPersistenceConfiguration().done(function(r){var c=a.instances.messageHandler;var o=r.logicalSystem;if(!o){s=i;n.resolve(i);return n.promise()}var d=o.service;var u=o.entitySet||o.entityType;if(d===null){s=i;n.resolve(i);return n.promise()}if(u===undefined){u=e.entitySets.logicalSystem}a.instances.coreApi.getMetadata(d).done(function(e){a.instances.coreApi.getXsrfToken(d).done(function(r){var o=new t(c,"SAPClient","eq",i);var f=a.instances.coreApi.getUriGenerator().getAbsolutePath(d);f=f+a.instances.coreApi.getUriGenerator().buildUri(c,u,["LogicalSystem"],o,undefined,undefined,undefined,undefined,undefined,"Results",e);var l={requestUri:f,method:"GET",headers:{"x-csrf-token":r}};var g=function(e){var t;if(e&&e.results&&e.results instanceof Array&&e.results.length===1&&e.results[0].LogicalSystem){s=e.results[0].LogicalSystem;n.resolve(s)}else{t=c.createMessageObject({code:"5026",aParameters:[i]});n.fail(t)}};var p=function(e){var t=c.createMessageObject({code:"5026",aParameters:[i]});if(e.messageObject!==undefined&&e.messageObject.type==="messageObject"){t.setPrevious(e.messageObject)}n.fail(t)};a.instances.coreApi.odataRequest(l,g,p)})})})}function f(){var e=jQuery.Deferred();if(s){e.resolve(s);return e.promise()}var t=a.instances.coreApi.getStartParameterFacade().getSapClient();if(t){u(e,t);return e.promise()}a.instances.coreApi.getCumulativeFilter().done(function(a){t=d(a);if(!t){e.resolve("")}else{u(e,t)}});return e.promise()}}a("sap.apf.core.Persistence",s);return{constructor:s}},true);
//# sourceMappingURL=persistence.js.map