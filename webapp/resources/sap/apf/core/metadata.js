/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/utils/utils","sap/apf/utils/hashtable","sap/apf/utils/exportToGlobal","sap/base/util/deepExtend","sap/base/util/each","sap/ui/model/odata/v2/ODataModel","sap/ui/model/odata/ODataUtils","sap/ui/thirdparty/jquery"],function(e,t,r,a,n,i,s,jQuery){"use strict";function o(t,r){this.type="metadata";var o=this;var f=jQuery.Deferred();var c=[];var u=t&&t.constructors&&t.constructors.Hashtable||u;var l=new u(t.instances.messageHandler);var y=new u(t.instances.messageHandler);var h=new u(t.instances.messageHandler);var p=new u(t.instances.messageHandler);var d=new u(t.instances.messageHandler);var g=new u(t.instances.messageHandler);var v=new u(t.instances.messageHandler);var m=new u(t.instances.messageHandler);var E=new u(t.instances.messageHandler);var P=new u(t.instances.messageHandler);var I=new u(t.instances.messageHandler);var S=new u(t.instances.messageHandler);var O=t.constructors.ODataModel||i;var H=false;if(t.deactivateFatalError){H=true}var b;var M;var k;var A;var D=w(r);function w(e){var r=t.functions.getSapSystem();if(r){return s.setOrigin(e,{force:true,alias:r})}return e}function T(e){var t;function r(e){if(!t.dataType){t.dataType={}}t.dataType[e]=t[e]}function i(e,r){if(Array.isArray(t[r])===true){t[r].forEach(function(e){t[e.name]=e.value})}else if(r!=="dataType"&&typeof t[r]==="object"){if(Object.keys(t[r]).length===0){t[e]="true"}if(r!==e){n(t[r],function(r,a){t[e]=a})}}else{t[e]=t[r]}}if(e===null){return{}}t=a({},e);n(t,function(e){switch(e){case"type":r(e);break;case"maxLength":r(e);break;case"precision":r(e);break;default:var t=e.split(".").pop();if(t.search("ISO")===0){i(t,e)}else{i(t.replace(/^./,t[0].toLowerCase()),e)}break}});return t}function F(e,t){if(p.hasItem(e)!==true){var r;var a={};var n={allParameters:[],keyParameters:[]};if(x(e)){r=B(e);if(r.key&&r.key.propertyRef){r.key.propertyRef.forEach(function(e){a[e.name]=null})}r.property.forEach(function(e){var t=T(e);t.isKey=a.hasOwnProperty(t.name);n.allParameters.push(t);if(t.isKey){n.keyParameters.push(t)}})}p.setItem(e,n)}if(!t){return p.getItem(e).allParameters}return p.getItem(e).keyParameters}function C(e){var t=[];var r;if(x(e)){e=z(e)}r=B(e);r.property.forEach(function(e){t.push(e.name)});return t}function j(e){var t;if(h.hasItem(e)===true){return h.getItem(e)}var r;var a=[];var n=[];var i=z(e);if(i&&R(i)){var s=B(i);s.property.forEach(function(e){a.push(e.name)})}var o=F(e,false);for(t=0;t<o.length;t++){n.push(o[t].name)}r=a.concat(n);h.setItem(e,r);return r}function U(e){return g.getItem(e)}function q(e){var t=U(e);t=t||U(e+"Results");if(!t&&B(e)){t=e}return t}function N(e){if(y.hasItem(e)===false){var t=[];var r=B(e);r.property.forEach(function(e){if(!(e["sap:filterable"]==="false"||e.filterable&&e.filterable==="true")){t.push(e.name)}});y.setItem(e,t)}return y.getItem(e)}function x(e){return K(e)==="parameters"}function R(e){return K(e)==="aggregate"}function K(e){if(!m.hasItem(e)){var t=B(e);var r=t&&t["sap:semantics"]||"undefined";m.setItem(e,r)}return m.getItem(e)}function L(e,t){if(l.hasItem(e+t)===false){var r=x(e);var a=B(e);var n=b.getODataProperty(a,t);if(!n&&r){var i=z(e);a=B(i);n=b.getODataProperty(a,t)}l.setItem(e+t,T(n))}return l.getItem(e+t)}function z(e){var t=P.getItem(e);if(t){return U(t.toAggregateEntitySet)}return e}function B(e){if(!e){return undefined}if(!S.hasItem(e)){var t=b.getODataEntityType(k+e);if(!t){return t}S.setItem(e,t)}return S.getItem(e)}function G(){var e;M=u();M.attachMetadataLoaded(function(){b=M.getMetaModel();b.loaded().then(function(){if(!M.getServiceMetadata()){e="5018";if(H){e="11013"}t.instances.messageHandler.putMessage(t.instances.messageHandler.createMessageObject({code:e,aParameters:[r],oCallingObject:o}));f.reject();return}a();n();i(M);s();f.resolve(this)}.bind(this))}.bind(this));M.attachMetadataFailed(function(){e="5018";if(H){e="11013"}t.instances.messageHandler.putMessage(t.instances.messageHandler.createMessageObject({code:e,aParameters:[r],oCallingObject:o}));f.reject();return});function a(){var e={};var a=b.getODataEntityContainer()&&b.getODataEntityContainer().entitySet;if(!a){t.instances.messageHandler.putMessage(t.instances.messageHandler.createMessageObject({code:"5041",aParameters:[r],oCallingObject:o}));return}a.forEach(function(t){var r=t.entityType.split(/[. ]+/).pop();g.setItem(t.name,r);v.setItem(r,t.name);if(!e.hasOwnProperty(r)){e[r]=true;c.push(r)}})}function n(){var e=b.getODataEntityContainer()&&b.getODataEntityContainer().entitySet;if(!e){return}var t=e[0].entityType.split(".");t.pop();k=t.join(".")+"."}function i(e){var t=e&&e.getServiceAnnotations();if(t&&t.aliasDefinitions&&t.aliasDefinitions.Capabilities){A=t.aliasDefinitions.Capabilities+"."}}function s(){var e=b.getODataEntityContainer();if(!e||!e.associationSet){return}e.associationSet.forEach(function(e){var t=e.end[0].entitySet,r=e.end[1].entitySet,a,n;if(x(U(t))){a=t}else if(R(U(t))){n=t}if(x(U(r))){a=r}else if(R(U(r))){n=r}if(!a||!n){return}var i;var s=B(U(a));var o;s.navigationProperty.forEach(function(t){if(!o&&t.relationship===e.association){i=t.name;o=true}});if(!i){return}var f={navigationProperty:i,fromParameterEntitySet:a,toAggregateEntitySet:n,fromIsUnique:undefined,toIsUnique:undefined};if(E.hasItem(a)){f.fromIsUnique=false;E.getItem(a).fromIsUnique=false}else{f.fromIsUnique=true;E.setItem(a,f);P.setItem(U(a),f)}if(I.hasItem(n)){I.getItem(n).toIsUnique=false}else{f.toIsUnique=true;I.setItem(n,f)}})}function u(){var e=t.instances.annotationHandler.getAnnotationsForService(r);var a={annotationURI:e,json:true};return new O(D,a)}}this.getEntityTypes=function(){return c};this.getPropertyMetadata=function(e,r){t.instances.messageHandler.check(e!==undefined&&typeof e==="string","sap.apf.core.Metadata:getPropertyMetadata incorrect EntityType name or type");t.instances.messageHandler.check(r!==undefined&&typeof r==="string","sap.apf.core.Metadata:getPropertyMetadata incorrect sPropertyName name or type");var a=q(e);if(!a){return{}}return L(a,r)};this.getUriComponents=function(e){if(!U(e)){if(U(e+"Results")){return{entitySet:e+"Results",navigationProperty:""}}return null}var r;switch(K(U(e))){case"undefined":return{entitySet:e,navigationProperty:""};case"parameters":r=E.getItem(e);if(!r||r.fromIsUnique===false){return{entitySet:e,navigationProperty:undefined}}return{entitySet:e,navigationProperty:r.navigationProperty};case"aggregate":r=I.getItem(e);if(!r){return{entitySet:e,navigationProperty:""}}if(r.toIsUnique===false){return{entitySet:undefined,navigationProperty:undefined}}return{entitySet:r.fromParameterEntitySet,navigationProperty:r.navigationProperty};default:t.instances.messageHandler.check(false,"metadata : getUriComponents - not handled return value for sap semantics")}};this.getFilterableProperties=function(e){t.instances.messageHandler.check(e!==undefined&&typeof e==="string","sap.apf.core.Metadata:getFilterableProperties incorrect EntityType name or type");var r=q(e);if(!r){return[]}r=z(r);return N(r)};this.getAllPropertiesOfEntitySet=function(e){t.instances.messageHandler.check(e!==undefined&&typeof e==="string","sap.apf.core.Metadata:getAllPropertiesOfEntitySet incorrect EntitySet name or type");var r=q(e);if(!r){return[]}return C(r)};this.getAllProperties=function(){var r=[];var a;this.getEntityTypes().forEach(function(e){a=j(e);if(a.length===0){a=C(e)}r=r.concat(a)});r=e.eliminateDuplicatesInArray(t.instances.messageHandler,r);return r};this.getFilterablePropertiesAndParameters=function(){var r=[];var a;var n=this.getEntityTypes();n.forEach(function(e){var t=B(e);t.property.forEach(function(e){if(!(e["sap:filterable"]==="false")&&e["sap:aggregation-role"]==="dimension"){r.push(e.name)}});a=F(e,false);a.forEach(function(e){r.push(e.name)})});return e.eliminateDuplicatesInArray(t.instances.messageHandler,r)};this.getParameterEntitySetKeyPropertiesForService=function(){var r=[];this.getEntityTypes().forEach(function(e){F(e,true).forEach(function(e){r.push(e.name)})});r=e.eliminateDuplicatesInArray(t.instances.messageHandler,r);return r};this.getAllKeys=function(){var r=[];var a=[];this.getEntityTypes().forEach(function(e){var t=B(e);a=[];if(t.key&&t.key.propertyRef){t.key.propertyRef.forEach(function(e){a.push(e.name)})}r=r.concat(a)});r=e.eliminateDuplicatesInArray(t.instances.messageHandler,r);return r};this.getAttributes=function(e){var t=false;var r={};this.getEntityTypes().forEach(function(a){if(!t){r=L(a,e);if(r.name){t=true}}});return r};this.getParameterEntitySetKeyProperties=function(e){t.instances.messageHandler.check(e!==undefined&&typeof e==="string","sap.apf.core.Metadata:getParameterEntitySetKeyProperties incorrect EntityType name or type");var r=q(e);if(!r){return[]}return F(r,true)};this.getEntityTypeAnnotations=function(e){var r=q(e);t.instances.messageHandler.check(e!==undefined&&typeof e==="string","sap.apf.core.Metadata:getEntityTypeAnnotations incorrect EntityType name or type");if(d.hasItem(r)===true){return d.getItem(r)}var a={};i(r,a);var n=z(r);if(n!==r){i(n,a)}d.setItem(r,a);return d.getItem(r);function i(e,t){var r;var a;var n;var i=B(e);for(r in i){if(i.hasOwnProperty(r)){if(r.indexOf(A)!==0){continue}a=r.split(".").pop();a=a.replace(/^./,a[0].toLowerCase());for(n in i[r]){if(i[r].hasOwnProperty(n)){t[a]=i[r][n]}}}}}};this.getEntitySets=function(){var e={};var t=[];var r=b.getODataEntityContainer();if(!r){return[]}if(r.associationSet){r.associationSet.forEach(function(t){var r,a,n;r=q(t.end[0].entitySet);if(!x(r)){return}n=t.end[1].entitySet;a=q(n);if(!x(a)){e[n]=true}})}if(r.entitySet){r.entitySet.forEach(function(r){if(!e[r.name]){t.push(r.name)}})}return t};this.getAllEntitySetsExceptParameterEntitySets=function(){var e=b.getODataEntityContainer();var t=[];if(!e){return[]}if(e.entitySet){e.entitySet.forEach(function(e){var r=U(e.name);if(!x(r)){t.push(e.name)}})}return t};this.getEntitySetByEntityType=function(e){return v.getItem(e)};this.getHierarchyAnnotationsForProperty=function(e,a){var n={};var i=this.getAllPropertiesOfEntitySet(e);if(i.length===0){return t.instances.messageHandler.createMessageObject({code:5072,aParameters:[e,r]})}var s=U(e);var o=z(s);i.forEach(function(e){var t=L(o,e);if(t["hierarchy-node-for"]===a){n.hierarchyNodeFor=e}});if(!n.hierarchyNodeFor){return t.instances.messageHandler.createMessageObject({code:5073,aParameters:[e,r,a]})}i.forEach(function(e){var t=L(o,e);if(t["hierarchy-level-for"]===n.hierarchyNodeFor){n.hierarchyLevelFor=e}else if(t["hierarchy-parent-node-for"]===n.hierarchyNodeFor){n.hierarchyParentNodeFor=e}else if(t["hierarchy-drill-state-for"]===n.hierarchyNodeFor){n.hierarchyDrillStateFor=e}else if(t["hierarchy-node-external-key-for"]===n.hierarchyNodeFor){n.hierarchyNodeExternalKeyFor=e}});return n};this.getHierarchicalEntitySets=function(){var e=[];var t=this.getEntitySets();t.forEach(function(t){var r=J.call(this,t);if(r.entitySet){e.push(r.entitySet)}}.bind(this));return e};this.getHierarchicalPropertiesOfEntitySet=function(e){return J.call(this,e).hierarchyProperties};function J(e){var t={};t.hierarchyProperties=[];var r=U(e);if(!r){return t}var a=z(r);var n=this.getAllPropertiesOfEntitySet(e);n.forEach(function(r){var i=L(a,r);var s=false;var o=false;var f=false;if(i["hierarchy-node-for"]!==undefined){var c=i["hierarchy-node-for"];var u=r;n.forEach(function(e){var t=L(a,e);if(t["hierarchy-level-for"]===u){s=true}else if(t["hierarchy-parent-node-for"]===u){o=true}else if(t["hierarchy-drill-state-for"]===u){f=true}});if(s&&o&&f){t.entitySet=e;t.hierarchyProperties.push(c)}}});return t}this.getNonHierarchicalPropertiesOfEntitySet=function(e){var t=[];var r=U(e);if(!r){return t}var a=z(r);var n=this.getAllPropertiesOfEntitySet(e);var i=J.call(this,e).hierarchyProperties;n.forEach(function(e){var r=L(a,e);if(r["hierarchy-node-for"]===undefined&&r["hierarchy-node-external-key-for"]===undefined&&r["hierarchy-parent-node-for"]===undefined&&r["hierarchy-level-for"]===undefined&&r["hierarchy-drill-state-for"]===undefined&&r["hierarchy-node-descendant-count-for"]===undefined&&i.indexOf(e)===-1){var n=r.name;t.push(n)}});return t};this.getODataModel=function(){return M};this.isInitialized=function(){return f.promise()};G.call(this)}r("sap.apf.core.Metadata",o);return o},true);
//# sourceMappingURL=metadata.js.map