/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/utils/utils","sap/apf/core/constants","sap/apf/utils/exportToGlobal","sap/apf/utils/hashtable","sap/apf/abap/LrepConnector","sap/apf/utils/parseTextPropertyFile","sap/base/util/deepExtend","sap/ui/thirdparty/jquery"],function(e,n,a,t,i,r,o,jQuery){"use strict";function s(n,a){var s=a.instances.coreApi;var c;var f=a.instances.messageHandler;var u="sap/apf/dt";var l="text.properties";var p=new t(a.instances.messageHandler);var d=new t(a.instances.messageHandler);var m;var v=false;this.getConnector=function(){return c};this.readEntity=function(e,n,a,t,i,r,o){var s=a[0].value;var u=P(i);var l=[];var p=false;var d=1;var m=0;var v;var g;var h;var y;var C;var b;var N;var x;var j=S(r);var I;f.check(e==="configuration","layered repository proxy - only read entity of configuration supported");if(o&&o.noMetadata){c.getStaticResource(u,s,"apfconfiguration").then(function(e){h={Application:i};x=e.response;if(typeof x==="string"){h.SerializedAnalyticalConfiguration=x}else{h.SerializedAnalyticalConfiguration=JSON.stringify(x)}h.AnalyticalConfiguration=s;n(h,E())},function(e){n(undefined,E(),O({code:"5221",aParameters:[i,s]},e&&e.messages))});return}if(t===undefined||t.indexOf("SerializedAnalyticalConfiguration")>=0){p=true;if(j==="VENDOR"){var U={contentType:"application/json"};var D=[];D.push({name:"layer",value:j});D.push({name:"dt",value:"true"});var M="/sap/bc/lrep/content/"+u+"/"+s+".apfconfiguration";M+=c._buildParams(D);I=c.send(M,"GET",undefined,U)}else{I=c.getStaticResource(u,s,"apfconfiguration")}l.push(I)}else{d=0}v=T(i,s);if(v===undefined){var R=c.getFileAttributes(u,s,"apfconfiguration",j);l.push(R)}g=Promise.all(l);g.then(function(e){v=T(i,s);if(v===undefined){v=e[d].response}A(i,s,v);h=L(i,v);if(p){x=e[m].response;if(typeof x==="string"){h.SerializedAnalyticalConfiguration=x}else{h.SerializedAnalyticalConfiguration=JSON.stringify(x)}}h.AnalyticalConfiguration=s;if(t&&t.length!==0){C=t.length;b={};for(y=0;y<C;y++){N=t[y];b[N]=h[N]}h=b}n(h,E())},function(e){n(undefined,E(),O({code:"5221",aParameters:[i,s]},e&&e.messages))})};this.doChangeOperationsInBatch=function(n,a,t){function i(e,n){a(n)}var r,o;function s(){}x(t).then(function(){for(r=0;r<n.length;r++){o=n[r];o.application=t;if(o.method==="DELETE"&&o.entitySetName==="texts"){b(o,s)}else if(o.method==="POST"&&e.isValidPseudoGuid(o.data.TextElement)){j(o.data,s)}else{j(o.data,s)}}I(t,i,true)}).fail(function(e){a(e)})};this.readCollectionsInBatch=function(e,n){var a=e.length;var t=[];var i=0;function r(e){function r(r,o,s){if(s){n(undefined,s)}else{i++;t[e]=r;if(i===a){n(t)}}}return r}for(var o=0;o<a;o++){var s=e[o];this.readCollection(s.entitySetName,r(o),s.inputParameters,s.selectList,s.filter)}};this.readCollection=function(e,n,a,i,o,s){var c,u;var l;var d;if(s&&s.layer){d=s.layer}else{d="CUSTOMER"}var m=function(e,a){if(a&&(a==="error"||a==="timeout"||a==="abort"||a==="parsererror")){n(undefined,E(),O({code:"5222",aParameters:[u]},[a]));return}var i=new t(f);var o=[];var s=e&&e.response||e&&e.responseText||"";var c=r(s,{instances:{messageHandler:f}});var l,d;if(c.Messages.length>0){l=f.createMessageObject({code:"5416"});d=l;c.Messages.forEach(function(e){d.setPrevious(e);d=e})}i=new t(f);c.TextElements.forEach(function(e){if(e.TextElement){i.setItem(e.TextElement,e);o.push(e)}});p.setItem(u,i);n(o,E(),l)};if(e==="application"){f.check(!a&&!i&&!o,"unsupported parameters when calling readCollection for application");w(n,d)}else if(e==="texts"){c=o.getFilterTermsForProperty("Application");u=c[0].getValue();l=N(u,s);l.then(function(e){m(e)},function(e){n(undefined,E(),O({code:"5222",aParameters:[u]},e&&e.messages))})}else if(e==="configuration"){c=o.getFilterTermsForProperty("Application");u=c[0].getValue();U(u,n,i)}};this.remove=function(e,n,a,t,i,r){if(!r){r="CUSTOMER"}if(e==="application"){H(n,a,r)}else if(e==="configuration"){G(n,a,i,r)}else{f.check(false,"the remove operation on entity set "+e+" is currently not supported by the lrep proxy")}};this.create=function(e,n,a,t){if(e==="application"){V(n,a,t)}else if(e==="configuration"){F(n,a,t)}else if(e==="texts"){j(n,a)}else{f.check(false,"the create operation on entity set "+e+" is currently not supported by the lrep proxy")}};this.update=function(e,n,a){if(e==="configuration"){R(n,a)}else if(e==="application"){z(n,a)}else{f.check(false,"the update operation on entity set "+e+" is currently not supported by the lrep proxy")}};function g(e,n){var a={async:true,contentType:"application/json"};var t=[];t.push({name:"layer",value:e});t.push({name:"deep-read",value:true});t.push({name:"metadata",value:true});t.push({name:"type",value:n});var i="/sap/bc/lrep/content/"+u+"/";i+=c._buildParams(t);return c.send(i,"GET",undefined,a)}function h(e){var n=e.ns.split("/");return n[n.length-2]}function y(e,n){var a=undefined;e.metadata.forEach(function(e){if(e.name===n){a=e.value}});return a}this.readAllConfigurationsFromVendorLayer=function(){var n=jQuery.Deferred();var a=[];g("VENDOR","apf*").then(function(t){var i={};t.response.forEach(function(e){if(e.fileType&&e.fileType==="apfapplication"){i[h(e)]=y(e,"apfdt-applname")}});t.response.forEach(function(n){var t;var r;var o;if(n.fileType&&n.fileType==="apfconfiguration"){t=h(n);r=n.name;if(!(e.isValidPseudoGuid(t)&&e.isValidPseudoGuid(r))){return}o=y(n,"apfdt-configname");a.push({configurationText:o,applicationText:i[t],value:t+"."+r})}});n.resolve(a)},function(e){n.reject(O({code:"5231"},e&&e.messages))});return n.promise()};C();function C(){if(a.constructors&&a.constructors.LrepConnector){c=a.constructors.LrepConnector.createConnector()}else{c=i.createConnector()}if(!c._sClient){c._sClient=s.getStartParameterFacade().getSapClient()}}function T(e,n){var a=d.getItem(e);if(a===undefined){return undefined}n=a.getItem(n);return n}function A(e,n,a){var i=d.getItem(e);if(i===undefined){i=new t(f)}i.setItem(n,a);d.setItem(e,i)}function S(e){var n=e&&e.layer||"CUSTOMER";if(n==="ALL"){return undefined}return n}function O(e,n){var a=f.createMessageObject(e);var t="";if(n){n.forEach(function(e){t=t+e+" "});a.setPrevious(f.createMessageObject({code:5220,aParameters:[t]}))}return a}function E(){return{}}function P(e){return u+"/"+e}function b(e,n){var a=e.application;var t=e.inputParameters[0].value;var i;x(a).done(function(){i=p.getItem(a);i.removeItem(t);n(e,E())}).fail(function(e){n(undefined,E(),e)})}function N(e,n){var a;var t=[];var i="/sap/bc/lrep/content/";var r=S(n);i+=u+"/"+e+"/"+l;if(r){t.push({name:"layer",value:r})}a={contentType:"text/plain"};i+=c._buildParams(t);return c.send(i,"GET",undefined,a)}function x(e){var n=jQuery.Deferred();var a;var i=p.getItem(e);var o=function(a){var o=a&&a.response||a&&a.responseText||"";var s=r(o,{instances:{messageHandler:f}});i=new t(f);s.TextElements.forEach(function(e){if(e.TextElement){i.setItem(e.TextElement,e)}});p.setItem(e,i);n.resolve({})};if(i===undefined){a=N(e);a.then(function(e){o(e)},function(a){n.reject(O({code:"5222",aParameters:[e]},a&&a.messages))})}else{n.resolve({})}return n.promise()}function j(n,a){var t=n.Application;if(n.TextElement===undefined||!e.isValidGuid(n.TextElement)){n.TextElement=e.createPseudoGuid()}x(t).done(function(){var e=p.getItem(t);e.setItem(n.TextElement,n);a(n,E())}).fail(function(e){a(undefined,E(),e)})}function I(n,a,t){var i=P(n);var o;function s(){var t=e.renderHeaderOfTextPropertyFile(n,f);t=t+e.renderTextEntries(o,f);var r=c.upsert(i,"text","properties","CUSTOMER",t,"text/plain");r.then(function(){a(E())},function(e){a(E(),O({code:"5230",aParameters:[n]},e&&e.messages))})}o=p.getItem(n);if(!o){a(E());return}if(t){s()}else{var u=N(n);u.then(function(e){var n=e&&e.response||"";var a=r(n,{instances:{messageHandler:f}});a.TextElements.forEach(function(e){if(e.TextElement){o.setItem(e.TextElement,e)}});s()},function(e){a(E(),O({code:"5222",aParameters:[n]},e&&e.messages))})}}function U(e,n,a){var t=[];var i=P(e);var r=c._buildParams([{name:"layer",value:"CUSTOMER"},{name:"metadata",value:"true"},{name:"type",value:"apfconfiguration"}]);var o=c.send("/sap/bc/lrep/content/"+i+r);o.then(function(r){var o=r.response;o.forEach(function(n){if(n.fileType==="apfconfiguration"){n.metadata.forEach(function(a){if(a.name==="apfdt-configname"){t.push({AnalyticalConfiguration:n.name,Application:e,AnalyticalConfigurationName:a.value})}})}});if(a&&a.indexOf("SerializedAnalyticalConfiguration")>=0){var s=[];t.forEach(function(e){var n=jQuery.Deferred();s.push(n);c.getStaticResource(i,e.AnalyticalConfiguration,"apfconfiguration").then(function(a){if(a.response){e.SerializedAnalyticalConfiguration=JSON.stringify(a.response);n.resolve()}else{n.reject()}},function(e){n.reject(e)})});jQuery.when.apply(jQuery,s).then(function(){n(t,E())},function(a){n([],E(),O({code:"5223",aParameters:[e]},a&&a.messages))})}else{n(t,E())}},function(a){n([],E(),O({code:"5223",aParameters:[e]},a&&a.messages))})}function D(){var e=jQuery.Deferred();var n=[];if(v){e.resolve(m)}else{n.push({name:"dt",value:false});var a="/sap/bc/lrep/content/sap/ui/fl/settings/main.flsettings";a+=c._buildParams(n);var t=c.send(a,"GET",undefined);t.then(function(n){var a=n&&n.response||{};v=true;if(a.isAtoEnabled===true){m="ATO_NOTIFICATION"}e.resolve(m)},function(n){e.reject(n)})}return e.promise()}function M(e,n,a,t){var i=t||"CUSTOMER";var r=P(e);var o=c.getFileAttributes(r,n,"apfconfiguration",i);o.then(function(t){var r=t.response;if(i==="CUSTOMER"){A(e,n,r);I(e,a)}else{a(E())}},function(t){a(E(),O({code:"5232",aParameters:[e,n]},t&&t.messages))})}function R(e,n,a){if(!a){a="CUSTOMER"}var t=e.Application;var i=e.AnalyticalConfiguration;var r=JSON.parse(e.SerializedAnalyticalConfiguration);var s=P(t);var f=D();f.then(function(f){var u=c.getStaticResource(s,"metadata","apfapplication");u.then(function(n){var u={Application:t,ApplicationName:n.response.ApplicationName,SemanticObject:n.response.SemanticObject,AnalyticalConfiguration:i,AnalyticalConfigurationName:e.AnalyticalConfigurationName,CreationUTCDateTime:e.CreationUTCDateTime,LastChangeUTCDateTime:e.LastChangeUTCDateTime};r=o(r,{configHeader:u});r=JSON.stringify(r);var l=c.upsert(s,i,"apfconfiguration",a,r,"application/json",f);return l},function(e){n(E(),O({code:"5233",aParameters:[t,i]},e&&e.messages))}).then(function(){M(t,i,n,a)},function(e){n(E(),O({code:"5233",aParameters:[t,i]},e&&e.messages))})},function(e){n(E(),O({code:"5224"},e&&e.messages))})}function F(n,a,t){var i=S(t);var r=n.Application;var s=n.AnalyticalConfiguration;if(s===undefined||!e.isValidGuid(s)){s=e.createPseudoGuid(32)}var f=JSON.parse(n.SerializedAnalyticalConfiguration);var u=P(r);var l=c.getStaticResource(u,"metadata","apfapplication");l.then(function(e){var t={Application:r,ApplicationName:e.response.ApplicationName,SemanticObject:e.response.SemanticObject,AnalyticalConfiguration:s,AnalyticalConfigurationName:f.analyticalConfigurationName,CreationUTCDateTime:n.CreationUTCDateTime,LastChangeUTCDateTime:n.LastChangeUTCDateTime};f=o(f,{configHeader:t});f=JSON.stringify(f);p(r,s,n.AnalyticalConfigurationName,f,a)},function(e){a(undefined,E(),O({code:"5223",aParameters:[r]},e&&e.messages))});function p(e,a,t,r,o){var s=P(e);var f=D();f.then(function(t){var f=c.upsert(s,a,"apfconfiguration",i,r,"application/json",t);f.then(function(){M(e,a,function(e,t){if(!t){o({AnalyticalConfiguration:a,AnalyticalConfigurationName:n.AnalyticalConfigurationName},E())}else{o(undefined,E(),t)}},i)},function(n){o(undefined,E(),O({code:"5226",aParameters:[e,a]},n&&n.messages))})},function(e){o(undefined,E(),O({code:"5224"},e&&e.messages))})}}function G(e,n,a,t){var i=e[0].value;f.check(i!==undefined,"configuration may not be undefined");f.check(a!==undefined,"application of configuration not found");var r=P(a);D().then(function(e){var o=c.deleteFile(r,i,"apfconfiguration",t,e);o.then(function(){n(E())},function(e){n(E(),O({code:"5225",aParameters:[a,i]},e&&e.messages))})},function(e){n(E(),O({code:"5224"},e&&e.messages))})}function L(e,n){var a;var t={Application:e};var i,r;for(a=0;a<n.length;a++){i=n[a].name;r=n[a].value;if(i==="apfdt-applname"){i="ApplicationName"}else if(i==="createdAt"){i="CreationUTCDateTime"}else if(i==="createdBy"){i="CreatedByUser"}else if(i==="lastChangedAt"){i="LastChangeUTCDateTime"}else if(i==="lastChangedBy"){i="LastChangedByUser"}else if(i==="apfdt-configname"){i="AnalyticalConfigurationName"}else if(i==="size"||i==="layer"){continue}t[i]=r}return t}function V(n,a,i){f.check(n.ApplicationName!==undefined&&n.ApplicationName!=="","Valid application name is required");var r=n.Application;if(r===undefined||!e.isValidGuid(r)){r=e.createPseudoGuid(32)}var o=JSON.stringify({ApplicationName:n.ApplicationName,SemanticObject:n.SemanticObject,Application:r});var s=e.renderHeaderOfTextPropertyFile(r,f);var u=S(i);function l(e){a(undefined,E(),O({code:"5227"},e&&e.messages))}var d=P(r);var m=c.upsert(d,"metadata","apfapplication",u,o,"application/json");m.then(function(){var e=c.upsert(d,"text","properties",u,s,"text/plain");e.then(function(){p.setItem(r,new t(f));a({Application:r,ApplicationName:n.ApplicationName,SemanticObject:n.SemanticObject},E())},l)},l)}function z(e,n){f.check(e.ApplicationName!==undefined&&e.ApplicationName!=="","Valid application name is required");var a=e.Application;var t=JSON.stringify({ApplicationName:e.ApplicationName,SemanticObject:e.SemanticObject,Application:a});function i(e){n(undefined,O({code:"5228",aParameters:[a]},e&&e.messages))}var r=P(a);var o=c.upsert(r,"metadata","apfapplication","CUSTOMER",t,"application/json");o.then(function(){n({Application:a,ApplicationName:e.ApplicationName,SemanticObject:e.SemanticObject})},i)}function H(e,n,a){var t=e[0].value;function i(e){var a=k(e);n(E(),a)}var r=P(t);var o=c.listContent(r,a);o.then(function(e){var a=e.response;var t=[];a.forEach(function(e){if(e.fileType==="apfconfiguration"){D().then(function(n){t.push(c.deleteFile(r,e.name,e.fileType,e.layer,n))},function(e){n(E(),O({code:"5224"},e&&e.messages))})}else{t.push(c.deleteFile(r,e.name,e.fileType,e.layer))}});var i=Promise.all(t);return i},i).then(function(){n(E())},i)}function k(e){var n;if(e&&e.messageObject&&e.messageObject.getCode){n=e.messageObject}else if(e&&e.response&&e.response.statusCode&&e.response.statusCode>=400){n=f.createMessageObject({code:"11005",aParameters:[e.response.statusCode.toString(),e.response.statusText]})}else{n=f.createMessageObject({code:"5201",aParameters:e&&e.messages||[]})}return n}function w(n,a){var t=[];g(a,"apfapplication").then(function(a){var i=a.response;i.forEach(function(n){var a;var i;if(n.fileType&&n.fileType==="apfapplication"){a=h(n);if(!e.isValidPseudoGuid(a)){return}var r="";i=y(n,"apfdt-applname");t.push({Application:a,ApplicationName:i,SemanticObject:r})}});n(t,E())},i);function i(e){n(undefined,E(),O({code:"5229"},e&&e.messages))}}}a("sap.apf.core.LayeredRepositoryProxy",s);return s});
//# sourceMappingURL=layeredRepositoryProxy.js.map