/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/binding","sap/apf/core/constants","sap/apf/core/hierarchicalStep","sap/apf/core/representationTypes","sap/apf/core/request","sap/apf/core/step","sap/apf/utils/exportToGlobal","sap/apf/utils/hashtable","sap/apf/utils/utils","sap/base/util/deepExtend","sap/ui/thirdparty/jquery"],function(e,t,n,i,r,a,s,o,c,f,jQuery){"use strict";var u=t.message.code;function d(s){var d=this;var l;var g=false;var p=jQuery.Deferred();var h=new o(s.instances.messageHandler);var y=function(e){s.instances.messageHandler.check(e!==undefined&&e.hasOwnProperty("id")!==false,"oItem is undefined or property 'id' is missing",u.errorCheckConfiguration);if(!h){h=new o(s.instances.messageHandler)}var t=h.setItem(e.id,e);s.instances.messageHandler.check(t===undefined,"Configuration includes duplicated identifiers (IDs): "+e.id+"",u.errorCheckConfigurationWarning)};var m=function(e){var t=[];if(!g&&p.state()==="pending"){s.instances.messageHandler.putMessage(s.instances.messageHandler.createMessageObject({code:"5020"}))}if(h.getNumberOfItems()!==0){h.each(function(n,i){if(i.type===e){t.push(i)}});return t}return t};function v(e){if(!t.configurationObjectTypes.hasOwnProperty(e.type)){s.instances.messageHandler.putMessage(s.instances.messageHandler.createMessageObject({code:"5033",aParams:[e.type]}))}if(e.type===t.configurationObjectTypes.facetFilter&&!e.property){s.instances.messageHandler.putMessage(s.instances.messageHandler.createMessageObject({code:"5034"}))}h.setItem(e.id,e)}function H(e){if(e.type===undefined){e.type="step"}y(e)}function C(e){s.instances.messageHandler.check(e!==undefined&&e instanceof Array!==false,"aSteps is missing or not an Array",u.errorCheckConfiguration);e.forEach(function(e){H(e)})}function b(e){if(e.type===undefined){e.type="request"}if(e.entitySet){e.entityType=e.entitySet;delete e.entitySet}y(e)}function k(e){if(e.type===undefined){e.type="navigationTarget"}y(e)}function T(e){s.instances.messageHandler.check(e!==undefined&&e instanceof Array!==false,"aRequests is missing or not an Array",u.errorCheckConfiguration);e.forEach(function(e){b(e)})}function I(e){function t(){var t=new o(s.instances.messageHandler);e.representations.forEach(function(n){if(!(n.id&&typeof n.id==="string")){s.instances.messageHandler.putMessage(s.instances.messageHandler.createMessageObject({code:"5028",aParameters:[e.id]}))}if(t.setItem(n.id,n.id)){s.instances.messageHandler.putMessage(s.instances.messageHandler.createMessageObject({code:"5029",aParameters:[e.id]}))}})}if(e.type===undefined){e.type="binding"}s.instances.messageHandler.check(e.id!==undefined,"binding has no id");s.instances.messageHandler.check(e.representations!==undefined&&e.representations instanceof Array!==false,"representations for binding "+e.id+" not defined",u.errorCheckConfiguration);t();y(e)}function F(e){s.instances.messageHandler.check(e!==undefined&&e instanceof Array!==false,"aBindings is missing or not an Array",u.errorCheckConfiguration);e.forEach(function(e){I(e)})}function A(e){s.instances.messageHandler.check(e!==undefined&&e instanceof Array!==false,"navigationTarget is missing or not an Array",u.errorCheckConfiguration);e.forEach(function(e){k(e)})}function w(e){h.setItem("configHeader",e)}function S(e){if(e.type===undefined){e.type="category"}y(e)}function R(e){s.instances.messageHandler.check(e!==undefined&&e instanceof Array!==false,"aCategories is missing or not an Array",u.errorCheckConfiguration);e.forEach(function(e){var t=e.steps;s.instances.messageHandler.check(t!==undefined&&t instanceof Array!==false,"steps for category "+e.id+" are missing or not an Array",u.errorCheckConfiguration);t.forEach(function(t){s.instances.messageHandler.check(t.type&&(t.type==="step"||t.type==="hierarchicalStep")&&t.id,"step with wrong format assigned to category '"+e.id+"'");s.instances.messageHandler.check(d.existsConfiguration(t.id),"step with id '"+t.id+"' which is assigned to category '"+e.id+"' does not exist")});S(e)})}function q(e){var t=false;var n=i();n.forEach(function(n){if(e===n.id){t=true}});return t}function M(e){var t;if(e.type===undefined){e.type="representationType"}if(!q(e.id)){t=c.extractFunctionFromModulePathString(e.constructor);if(typeof t!=="function"){s.instances.messageHandler.putMessage(s.instances.messageHandler.createMessageObject({code:"5030",parameters:[e.id]}))}}y(e)}function E(e){s.instances.messageHandler.check(e!==undefined&&e instanceof Array!==false,"aRepresentationInfo is missing or not an Array",u.errorCheckConfiguration);e.forEach(function(e){M(e)})}function P(e){if(e.type===undefined){e.type="smartFilterBar"}v(e)}function B(e){if(e.type===undefined){e.type="facetFilter"}v(e)}function L(e){s.instances.messageHandler.check(e!==undefined&&e instanceof Array!==false,"Facet filter configuration is missing or not an Array",u.errorCheckConfiguration);if(e.length===0){h.setItem(t.existsEmptyFacetFilterArray,true);return}e.forEach(B)}function O(e,t,n,i){var r,a,o;function f(e){return e.alias||e.property}function u(e){var t=e.preselectionDefaults&&e.preselectionDefaults.length>0;var n=e.valueList&&e.valueList.length>0;return t||n}function d(e,t,i,r,a){e.metadataProperty=t;B(e);O(i,r,n,a)}function p(e,t){if(c.isPropertyTypeWithDateSemantics(t)){e.preselectionDefaults=c.convertDateListToInternalFormat(e.preselectionDefaults,t);e.valueList=c.convertDateListToInternalFormat(e.valueList,t)}}if(t===e.length){n.resolve();g=false;return}a=e[t];t++;o=f(a);l=l||s.instances.coreApi.getMetadataFacade();var y=i&&Array.prototype.indexOf.call(i,o)>-1;if(y&&u(a)){if(a.valueHelpRequest||a.filterResolutionRequest){if(a.valueHelpRequest){r=h.getItem(a.valueHelpRequest)}else if(a.filterResolutionRequest){r=h.getItem(a.filterResolutionRequest)}l.getPropertyMetadataByEntitySet(r.service,r.entityType,o).done(function(n){p(a,n);d(a,n,e,t,i)})}else{l.getProperty(o).done(function(n){p(a,n);d(a,n,e,t,i)})}}else if(y){if(a.valueHelpRequest||a.filterResolutionRequest){if(a.valueHelpRequest){r=h.getItem(a.valueHelpRequest)}else if(a.filterResolutionRequest){r=h.getItem(a.filterResolutionRequest)}l.getPropertyMetadataByEntitySet(r.service,r.entityType,o).done(function(n){d(a,n,e,t,i)})}else{l.getProperty(o).done(function(n){d(a,n,e,t,i)})}}else{d(a,{},e,t,i)}}function D(e){var n=jQuery.Deferred();l=l||s.instances.coreApi.getMetadataFacade();s.instances.messageHandler.check(e!==undefined&&e instanceof Array!==false,"Facet filter configuration is missing or not an Array",u.errorCheckConfiguration);if(e.length===0){h.setItem(t.existsEmptyFacetFilterArray,true);n.resolve();return n.promise()}g=true;l.getAllProperties(function(t){O(e,0,n,t)});return n.promise()}function j(e){E(e)}function x(e,t){function n(e,t){var n=t.getConfigurationById(e.binding).representations;if(n){return n}s.instances.messageHandler.check(false,'Binding of step with ID "'+e.id+'" does not contain any representations.',u.errorCheckConfigurationWarning)}function i(e,t){var i;var r=[];if(e.binding){i=n(e,t);i.forEach(function(e){var n=f({},t.getConfigurationById(e.representationTypeId));n.representationId=e.id;n.representationLabel=e.label;n.parameter=f({},e.parameter);r.push(n)});return r}s.instances.messageHandler.check(false,'Step with ID "'+e.id+'" does not contain any binding references.',u.errorCheckConfigurationWarning)}var r=f({},e);var a=i(e,t);delete r.request;delete r.binding;delete r.thumbnail;delete r.longTitle;r.type="stepTemplate";r.getRepresentationInfo=function(){var e=f([],a);e.forEach(function(e){delete e.id;delete e.type;delete e.constructor});return e};return r}var W=function(e,t){var n=this;this.type=e.type;this.id=e.id;this.label=e.label;this.stepTemplates=[];e.steps.forEach(function(e){var i=t.getConfigurationById(e.id);n.stepTemplates.push(new x(i,t))});return this};var U=function(e,t){this.type="thumbnail";if(e===undefined){return this}this.leftUpper=t.createLabel(e.leftUpper);this.rightUpper=t.createLabel(e.rightUpper);this.leftLower=t.createLabel(e.leftLower);this.rightLower=t.createLabel(e.rightLower);this.altTitle=t.createLabel(e.altTitle);return this};this.createThumbnail=function(e){return new U(e,this)};function N(e){this.type="label";this.kind=e.kind;if(this.kind==="text"){this.file=e.file;this.key=e.key}else if(this.kind==="property"){this.property=e.property}else if(this.kind==="sapLabel"){this.labelOf=e.labelOf}}this.createLabel=function(e){return new N(e,this)};this.loadConfig=function(e,t){h=new o(s.instances.messageHandler);if(e.applicationTitle){h.setItem("applicationTitle",e.applicationTitle)}var n={constructors:{Hashtable:o},instances:{messageHandler:s.instances.messageHandler}};c.migrateConfigToCategoryStepAssignment(e,n);var r=i();j(r);C(e.steps);R(e.categories);T(e.requests);F(e.bindings);if(e.representationTypes){E(e.representationTypes)}if(e.smartFilterBar){P(e.smartFilterBar)}if(e.facetFilters){if(t){L(e.facetFilters);p.resolve()}else{D(e.facetFilters).done(function(){p.resolve()})}}else{p.resolve()}if(e.navigationTargets){A(e.navigationTargets)}if(e.configHeader){w(e.configHeader)}return p};this.getConfigurationById=function(e){return h.getItem(e)};this.existsConfiguration=function(e){return h.hasItem(e)};this.getServiceDocuments=function(){var e=m("request");var t=[];e.forEach(function(e){t.push(e.service)});return c.eliminateDuplicatesInArray(s.instances.messageHandler,t)};this.getNavigationTargets=function(){var e=m("navigationTarget");return f([],e)};this.getStepTemplates=function(){var e=[];var t=m("step");t=jQuery.merge(t,m("hierarchicalStep"));t.forEach(function(t,n){e[n]=new x(t,d)});return e};this.getSmartFilterBarConfiguration=function(){var e=jQuery.Deferred();var t;p.done(function(){t=m("smartFilterBar")[0];if(typeof t==="object"&&t.service&&(t.entityType||t.entitySet)){e.resolve(f({},t))}else{e.resolve()}});return e.promise()};this.getFacetFilterConfigurations=function(){var e=m("facetFilter");var t,n,i;var r=f([],e);for(i=0;i<r.length;i++){n=r[i];if(e[i].metadataProperty&&e[i].metadataProperty.clone){n.metadataProperty=e[i].metadataProperty.clone()}if(n.preselectionFunction){t=c.extractFunctionFromModulePathString(n.preselectionFunction);if(typeof t!=="function"){s.instances.messageHandler.putMessage(s.instances.messageHandler.createMessageObject({code:"5035",parameters:[n.id]}));n.preselectionFunction=undefined}else{n.preselectionFunction=t}}}return r};this.getCategories=function(){var e=m("category");var t=[];e.forEach(function(e,n){t[n]=new W(e,d)});return t};this.getConfigHeader=function(){return h.getItem("configHeader")};this.createStep=function(e,t){var i=this.getConfigurationById(e);const r=s.constructors.Step||a.constructor;s.instances.messageHandler.check(i!==undefined&&(i.type==="step"||i.type==="hierarchicalStep"),"Error - referenced object is undefined or has not type step",u.errorCheckConfiguration);s.instances.messageHandler.check(r!==undefined,"Step must be defined ",u.errorCheckConfiguration);s.instances.messageHandler.check(typeof r==="function","Step must be constructor function");if(i.type==="hierarchicalStep"){s.instances.messageHandler.check(typeof n==="function","HierarchicalStep must be constructor function");return new n(s.instances.messageHandler,i,this,t,s.instances.coreApi)}return new r(s.instances.messageHandler,i,this,t,s.instances.coreApi)};this.createBinding=function(t,n,i,r){var a=this.getConfigurationById(t);s.instances.messageHandler.check(a!==undefined&&a.type==="binding","Error - oBindingConfig is undefined or has not type binding",u.errorCheckConfiguration);a.oTitle=n;a.oLongTitle=i;const o=s.constructors.Binding||e;return new o(s,a,this,r)};this.createRequest=function(e){if(e.entitySet){e.entityType=e.entitySet;delete e.entitySet}var t;var n;if(typeof e==="string"){n=d.getConfigurationById(e);if(!(n!==undefined&&n.type==="request")){t=s.instances.messageHandler.createMessageObject({code:"5004",aParameters:[e]});s.instances.messageHandler.putMessage(t);return undefined}}else{n=e;s.instances.messageHandler.check(n.type&&n.type==="request"&&n.service&&n.entityType,"Wrong request configuration when creating a new request");if(!n.id){t=s.instances.messageHandler.createMessageObject({code:"5004",aParameters:[e]});s.instances.messageHandler.putMessage(t);return undefined}}return new(s&&s.constructors&&s.constructors.Request||r)(s,n)};if(s.constructors&&s.constructors.RegistryProbe){this.getRegistry=function(){return new s.constructors.RegistryProbe(h)}}}s("sap.apf.core.ConfigurationFactory",d);return d});
//# sourceMappingURL=configurationFactory.js.map