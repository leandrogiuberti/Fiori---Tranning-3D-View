sap.ui.define(["sap/apf/utils/trace","sap/apf/core/utils/filter","sap/apf/core/utils/areRequestOptionsEqual","sap/apf/utils/exportToGlobal","sap/apf/utils/utils","sap/apf/utils/filter","sap/apf/utils/executeFilterMapping","sap/apf/core/constants","sap/apf/core/metadataProperty","sap/base/util/deepExtend","sap/base/util/extend","sap/ui/thirdparty/jquery"],function(e,t,i,r,n,a,o,s,l,p,u,jQuery){"use strict";function f(t,r,a,f,d){t.check(r!==undefined,"Step: step configuration is missing");t.check(r.binding!==undefined,"No binding assigned to step "+r.id+" in analytical configuration",s.message.code.errorCheckConfiguration);var g=s.representationMetadata.labelDisplayOptions;var c=this;var h,v,y,T;var q={responseData:[]};var F=p({},r);this.type="step";this.title=p({},r.title);this.longTitle=undefined;if(r.longTitle){this.longTitle=p({},r.longTitle)}this.thumbnail=p({},r.thumbnail);this.categories=r.categories;this.destroy=function(){if(h){h.destroy()}v=undefined;y=undefined;T=undefined;h=undefined;c=undefined};this.getRequestConfiguration=function(){return a.getConfigurationById(r.request)};this.getAdditionalConfigurationProperties=function(){return F};this.update=function(t,n){var o;var s=this.getFilter();var l=!t.isEqual(y);var p=h.getRequestOptions(l);var u=!i(T,p);var f=a.getConfigurationById(r.request);e.logCall("Step.update",", bFilterChanged",l,", bRequestOptionsChanged",u);d.getMetadata(f.service).then(function(i){e.log("update  -  in oCoreApi.getMetadata().then()");if(!s.isEmpty()&&!r.topNSettings&&h.getSelectedRepresentation().type==="TableRepresentation"){var a=s.getProperties()[0];var d=[a];var g=i.getPropertyMetadata(f.entityType,a)["sap:text"];if(g){d.push(g)}o={selectionFilter:s,requiredFilterProperties:d}}if(v&&(l||u)){e.log("update() - before sendGetInBatch");v.sendGetInBatch(t,n,p,o)}else{e.log("update() - no request, before callbackAfterRequest");n({},false)}},function(){e.log("update - then.reject() - before callbackAfterRequest");n({},false)});e.logReturn("update")};this.determineFilter=function(e,i){var n;var s;if(this.adjustCumulativeFilter){n=this.adjustCumulativeFilter(e)}if(M()&&this.getFilter().toUrlParam()){var l=a.getConfigurationById(r.filterMapping.requestForMappedFilter);l.selectProperties=r.filterMapping.target.slice();if(r.filterMapping.targetPropertyDisplayOption===g.TEXT||r.filterMapping.targetPropertyDisplayOption===g.KEY_AND_TEXT){d.getMetadata(l.service).done(function(e){var t=e.getPropertyMetadata(l.entityType,l.selectProperties[0]);if(t.text){l.selectProperties.push(t.text)}p.call(this,l)}.bind(this))}else{p.call(this,l)}}else{q.responseData=[];i(this.getFilter(),n)}function p(l){var p=a.createRequest(l);s=e.addAnd(this.getFilter());if(n){s=n.copy().addAnd(this.getFilter())}if(s.isEqual(q.mergedFilter)){i(q.mappedFilter,n)}else{o(s,p,r.filterMapping.target,u,t)}}function u(e,t,a){if(!t){if(r.filterMapping.keepSource==="true"){e=c.getFilter().addAnd(e)}q.mergedFilter=s;q.mappedFilter=e;q.responseData=a;i(e,n)}}};this.getBinding=function(){return h};this.getFilter=function(){return h.getFilter(this.getContextInfo())};this.getContextInfo=function(){var e=a.getConfigurationById(r.request);var t={entityType:e.entityType,service:e.service};return t};this.setData=function(e,t){var i=!t.isEqual(y);y=t.copy();T=u({},h.getRequestOptions(i));h.setData(e)};this.getRepresentationInfo=function(){return h.getRepresentationInfo()};this.getSelectedRepresentationInfo=function(){return h.getSelectedRepresentationInfo()};this.getSelectedRepresentation=function(){return h.getSelectedRepresentation()};this.setSelectedRepresentation=function(e){h.setSelectedRepresentation(e)};this.getFilterInformation=function(e,t){var i=jQuery.Deferred();var o;if(r.longTitle&&r.longTitle.key){o=d.getTextNotHtmlEncoded(r.longTitle.key)}else{o=d.getTextNotHtmlEncoded(r.title.key)}if(M()&&r.filterMapping.keepSource==="true"){jQuery.when(u(e,o),s(e,o)).then(function(e,t){i.resolve([e,t])})}else if(M()){jQuery.when(s(e,o)).then(function(e){i.resolve([e])})}else{jQuery.when(u(e,o)).then(function(e){i.resolve([e])})}return i;function s(){var e=jQuery.Deferred();var t;if(r.filterMapping.targetPropertyLabelKey){t=d.getTextNotHtmlEncoded(r.filterMapping.targetPropertyLabelKey)}var i=r.filterMapping.target[0];var n=a.getConfigurationById(r.filterMapping.requestForMappedFilter);p(i,n).done(function(r){f(e,i,r,t,n,true)});return e}function p(e,t){var i=jQuery.Deferred();d.getMetadata(t.service).done(function(a){var o;var s=new l.constructor(a.getPropertyMetadata(t.entityType,e));if(s.text){o=s.text}var p=[];var u=r.filterMapping.targetPropertyDisplayOption;var f=false;q.responseData.forEach(function(t){if(u===g.TEXT&&o){p.push({text:t[o]})}else if(u===g.KEY_AND_TEXT&&o){p.push({text:d.getTextNotHtmlEncoded("keyAndTextSelection",[t[o],n.convertToExternalFormat(t[e],s)])})}else{p.push({text:t[e]});f=true}});p=n.sortByProperty(p,"text",s);if(f===true){p.forEach(function(e){e.text=n.convertToExternalFormat(e.text,s)})}i.resolve(p)});return i}function u(){var e=jQuery.Deferred();var t;var i;var n=a.getConfigurationById(r.binding);var o=a.getConfigurationById(r.request);if(n.requiredFilters&&n.requiredFilters.length===1){t=n.requiredFilters[0];if(n.requiredFilterOptions&&n.requiredFilterOptions.fieldDesc){i=d.getTextNotHtmlEncoded(n.requiredFilterOptions.fieldDesc.key)}}f(e,t,h.getSortedSelections(),i,o,false);return e}function f(i,r,n,a,s,l){var p;var u;if(!a){p=d.getMetadata(s.service)}if(r){u=d.getMetadata(e.getRequestConfiguration().service)}jQuery.when(p,u).then(function(p,u){var f=false;var g;var c=e.getRequestConfiguration().entityType;var h;if(u){h=u.getFilterableProperties(c).concat(u.getParameterEntitySetKeyProperties(c))}if(!a&&p&&r){a=p.getPropertyMetadata(s.entityType,r)["sap:label"]}if(!r){f=true;g=d.getTextNotHtmlEncoded("noSelectionPossible")}else if(h.indexOf(r)===-1){f=true;g=d.getTextNotHtmlEncoded("filterNotApplicable")}else if(n.length===0){f=true;g=d.getTextNotHtmlEncoded("nothingSelected")}i.resolve({text:o,selectablePropertyLabel:a||r,filterValues:n,infoIcon:l,infoText:l?d.getTextNotHtmlEncoded("infoIconfilterMapping"):undefined,warningIcon:f,warningText:g,stepIndex:t})})}};this.serialize=function(){return{stepId:r.id,binding:h.serialize()}};this.deserialize=function(e){h.deserialize(e.binding);t.check(r.id,e.stepId,"sap.apf.core.step.deserialize inconsistent serialization data - id "+e.stepId);return this};this.getAssignedNavigationTargets=function(){return r.navigationTargets};x();function x(){h=a.createBinding(r.binding,undefined,undefined,f);delete F.binding;if(r.request!==undefined&&r.request!==""){v=a.createRequest(r.request);delete F.request}}function M(){if(r.filterMapping){if(r.filterMapping.requestForMappedFilter&&r.filterMapping.target instanceof Array&&r.filterMapping.keepSource){return true}t.putMessage(t.createMessageObject({code:"5104"}))}return false}}r("sap.apf.core.Step",f);return{constructor:f}},true);
//# sourceMappingURL=step.js.map