/*!
/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/constants","sap/apf/core/utils/filter","sap/apf/utils/exportToGlobal","sap/apf/utils/trace","sap/base/util/deepExtend","sap/ui/thirdparty/jquery"],function(e,t,i,r,a,jQuery){"use strict";var n=e.message.code;function s(e){this.type="path";var i=e.instances.messageHandler;var s=e.instances.coreApi;var o=[];var u=[];var c=0;this.destroy=function(){u=[];o.forEach(function(e){e.destroy()});o=[]};this.getFilterInformation=function(){var e=false;var t=[];var i=u[0];o.forEach(function(r,a){if(!e){if(this.stepIsActive(r)){e=true}else{t.push(r.getFilterInformation(i,a))}}}.bind(this));return Promise.all(t).then(function(e){return[].concat.apply([],e)})};this.getSteps=function(){return a([],o)};this.addStep=function(e,t){r.logCall("Path.addStep");o.push(e);this.update(t);r.logReturn("addStep")};this.makeStepActive=function(e){var t=this.stepIsInPath(e);r.log("makeStepActive",", bStepIsInPath",t);i.check(t,"An unknown step can't be an active step.",n.errorCheckWarning);if(t){if(this.stepIsActive(e)===false){u.push(e)}}};this.makeStepInactive=function(e){var t=this.stepIsActive(e);r.log("makeStepInactive",", bStepIsActive",t);i.check(t,"Only an active step can be removed from the active steps.",n.errorCheckWarning);if(t){var a=u.indexOf(e);u.splice(a,1)}};this.stepIsActive=function(e){var t=u.indexOf(e);return t>=0};this.stepIsInPath=function(e){var t=o.indexOf(e);return t>=0};this.getActiveSteps=function(){return a([],u)};this.getCumulativeFilterUpToActiveStep=function(){var e=jQuery.Deferred();var t=this;h().done(function(t){if(o.length===0){e.resolve(t)}else{i(0,t,function(t){e.resolve(t)})}});return e.promise();function i(e,r,a){o[e].determineFilter(r.copy(),function(n,s){if(s){r=s}r.addAnd(n);if(t.stepIsActive(o[e])||!o[e+1]){a(r);return}i(++e,r,a)})}};this.moveStepToPosition=function(e,t,r){var a=o.indexOf(e);var n=t;i.check(typeof t==="number"&&t>=0&&t<o.length,"Path: moveStepToPosition invalid argument for nPosition");i.check(a>=0&&a<o.length,"Path: moveStepToPosition invalid step");if(a===t){return}o.splice(a,1);o.splice(n,0,e);this.update(r)};this.removeStep=function(e,t){r.logCall("Path.removeStep");var a=this.stepIsInPath(e);var n=this.stepIsActive(e);var s=o.indexOf(e);i.check(a,"Path: remove step - invalid step");o.splice(s,1);if(n){this.makeStepInactive(e)}this.update(t);e.destroy();r.logReturn("removeStep")};this.update=function(e,t){r.logCall("Path.update");if(!o[0]){if(t){r.log("update - fnUpdatePathFinished <<< ");t()}r.logReturn("update");return}var a;var n=o[0];h().done(function(u){r.log("update - @ getContextFilter().done(oContextFilter)");c++;a=c;n.update(u,f);function f(t,s){var f=o.indexOf(n);r.logCall("Path.update.callbackAfterRequest"," nIndexOfCurrentStep=",f,", nCurrentUpdateCount="+a);var p;if(a===c){if(t instanceof Error){var d=f+1;p=i.createMessageObject({code:"5002",aParameters:[d],callingObject:n});p.setPrevious(t);i.putMessage(p);n.setData({data:[],metadata:undefined},u);e(n,true);f++;n=o[f];while(n){n.setData({data:[],metadata:undefined},u);e(n,true);f++;n=o[f]}r.logReturn("update-callbackAfterRequest");return}if(s){n.setData(t,u)}r.log("update - before fnStepProcessedCallback");e(n,s);if(a!==c){r.logReturn("update-callbackAfterRequest");return}n.determineFilter(u.copy(),l)}r.logReturn("update-callbackAfterRequest")}function l(e,i){if(i){u=i}u=v(u,e,n.getContextInfo());var r=o.indexOf(n);u.addAnd(e);n=o[r+1];if(n){n.update(u,f)}else{s.storeApfState();u=undefined;if(t){t()}}}});r.logReturn("update")};this.serialize=function(){return{path:{steps:l(),indicesOfActiveSteps:f()}}};this.deserialize=function(e){p(e.path.steps,this);d(e.path.indicesOfActiveSteps,this)};function f(){var e=[];for(var t=0;t<o.length;t++){for(var i=0;i<u.length;i++){if(o[t]===u[i]){e.push(t)}}}return e}function l(){var e=[];for(var t=0;t<o.length;t++){e.push(o[t].serialize())}return e}function p(e,t){var i=t.update;t.update=function(){};var r;for(r=0;r<e.length;r++){s.createStep(e[r].stepId)}for(r=0;r<o.length;r++){o[r].deserialize(e[r])}t.update=i}function d(e,t){for(var i=0;i<e.length;i++){var r=e[i];t.makeStepActive(o[r])}}this.checkAddStep=function(e){var t=jQuery.Deferred();var r=s.getConfigurationObjectById(e);var a=s.getConfigurationObjectById(r.binding).requiredFilters;if(r.type==="hierarchicalStep"&&a&&a.length===1){var n=s.getConfigurationObjectById(r.request);s.getMetadata(n.service).done(function(e){var u=e.getPropertyMetadata(n.entityType,a[0]);if(u["hierarchy-node-for"]===r.hierarchyProperty){o.forEach(function(e){if(e.type==="hierarchicalStep"){var n=e.getBinding().getRequiredFilters();if(n.length===1&&n[0]===a[0]){t.resolve(false,i.createMessageObject({code:5234,aParameters:[r.hierarchyProperty,s.getTextNotHtmlEncoded(e.getAdditionalConfigurationProperties().title.key)],enrichInfoInMessageObject:true}))}}})}if(t.state()==="pending"){t.resolve(true)}})}else{t.resolve(true)}return t.promise()};function h(){var e=jQuery.Deferred();jQuery.when(s.getCumulativeFilter(),s.getSmartFilterBarAsPromise()).done(function(r,a){var n,s,o;var u=r.copy();if(a){n=a.getFilters();n.forEach(function(e){u.addAnd(t.transformUI5FilterToInternal(i,e))});o=a.getAnalyticalParameters();if(o&&o.length>0){for(s=0;s<o.length;s++){var c=o[s].fieldName;var f=o[s].fieldNameOData;var l=a.getFilters([c]);var p=undefined;if(l&&l.length){if(l[0].oValue1!==undefined){p=l[0].oValue1}else{p=l[0].aFilters[0].oValue1}u.addAnd(new t(i,f,"EQ",p))}}}}e.resolve(u)});return e}function v(t,i,r){if(e.exits&&e.exits.path&&e.exits.path.beforeAddingToCumulatedFilter){return e.exits.path.beforeAddingToCumulatedFilter(t,i,r)}return t}}i("sap.apf.core.Path",s);return{constructor:s}},true);
//# sourceMappingURL=path.js.map