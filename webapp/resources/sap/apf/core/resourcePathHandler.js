/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/messageHandler","sap/apf/core/messageDefinition","sap/apf/core/odataProxy","sap/apf/core/layeredRepositoryProxy","sap/apf/cloudFoundry/runtimeProxy","sap/apf/core/constants","sap/apf/core/utils/filter","sap/apf/core/utils/uriGenerator","sap/apf/utils/exportToGlobal","sap/apf/utils/hashtable","sap/apf/utils/startParameter","sap/apf/utils/utils","sap/base/util/deepExtend","sap/ui/thirdparty/jquery"],function(e,a,t,i,o,n,s,r,c,u,p,f,l,jQuery){"use strict";function d(e){var c=this;var p=e.instances.coreApi;var d=e.instances.messageHandler;var g=new u(d);var v;var m;var y=null;var L=jQuery.Deferred();var P=false;var C;this.loadConfigFromFilePath=function(a){if(P){return}P=true;var t=p.getStartParameterFacade().getAnalyticalConfigurationId();var i=a;p.ajax({url:i,dataType:"json",success:o,error:function(e,a,t){var o=d.createMessageObject({code:"5068",aParameters:[i,a,t]});B(o)},async:true,suppressSapSystem:true});function o(i,o,n){var s=e.functions.checkForTimeout(n);var r;if(s){r=d.createMessageObject({code:"5054",aParameters:[a]});r.setPrevious(s);B(r)}if(!i||!i.applicationConfiguration){B(d.createMessageObject({code:"5055",aParameters:[a]}))}if(i.applicationConfiguration.textResourceLocations===undefined){B(d.createMessageObject({code:"5056",aParameters:[a]}));return}U(i,t);M().done(function(){if(t){x(t)}else{b()}})}};function S(){return p.getStartParameterFacade().isLrepActive()}function x(a){var t=a.applicationId;var i=a.configurationId;if(S()&&!t){B(d.createMessageObject({code:"5024"}))}var o=new C({serviceRoot:m&&m.path&&m.path.service,entityTypes:{configuration:n.entitySets.configuration,texts:n.entitySets.texts}},{instances:{coreApi:p,messageHandler:d},manifests:e.manifests});if(S()){var s=[];var r=jQuery.Deferred();s.push(r);s.push(T(t,o))}o.readEntity("configuration",function(e,a,n){if(n){B(d.createMessageObject({code:"5022",aParameters:[i]}));L.resolve()}else{var s=JSON.parse(e.SerializedAnalyticalConfiguration);p.loadAnalyticalConfiguration(s);if(s.applicationTitle){v.appName=s.applicationTitle.key;v.appTitle=s.applicationTitle.key}if(S()){r.resolve()}else{t=t||e.Application;T(t,o).then(function(){L.resolve()})}}},[{name:"AnalyticalConfiguration",value:i}],undefined,t,{layer:"ALL"},{noMetadata:true});if(S()){jQuery.when.apply(jQuery,s).then(function(){L.resolve()})}}function T(e,a){var t=jQuery.Deferred();var i=new s(d,"Application","eq",e);var o=new s(d,"Language","eq",n.developmentLanguage);o.addAnd(i);var r=["TextElement","TextElementDescription"];a.readCollection("texts",function(e,a,i){if(i){B(d.createMessageObject({code:"5023",aParameters:[p.getStartParameterFacade().getAnalyticalConfigurationId()]}))}else{p.loadTextElements(e)}t.resolve()},undefined,r,o,{layer:"ALL"});return t.promise()}function b(){var e=c.getResourceLocation(n.resourceLocation.analyticalConfigurationLocation);var a;if(e!==""){p.ajax({url:e,dataType:"json",success:function(t,i,o){if(t){p.loadAnalyticalConfiguration(t);if(t.applicationTitle){v.appName=t.applicationTitle.key;v.appTitle=t.applicationTitle.key}L.resolve()}else{a=d.createMessageObject({code:"5057",aParameters:[e]});B(a)}},error:function(t,i,o,n){a=d.createMessageObject({code:"5057",aParameters:[e]});if(n){a.setPrevious(n)}B(a)},async:true,suppressSapSystem:true})}else{a=d.createMessageObject({code:"5060"});B(a)}}function M(){p.loadMessageConfiguration(a,true);return h(n.resourceLocation.applicationMessageDefinitionLocation,false)}function h(a,t){var i=jQuery.Deferred();var o=c.getResourceLocation(a);if(o!==""){p.ajax({url:o,dataType:"json",success:n,error:function(e,a,t,i){var n=d.createMessageObject({code:"5058",aParameters:[a,t,o]});if(i){n.setPrevious(i)}B(n)},async:true,suppressSapSystem:true})}else{i.resolve()}return i.promise();function n(a,o,n){var s;var r=e.functions.checkForTimeout(n);if(!r){if(a.messageConfiguration){p.loadMessageConfiguration(a.messageConfiguration.definitions,t)}}else{s=d.createMessageObject({code:"5067"});s.setPrevious(r);B(s)}i.resolve()}}function R(e){var a;if(!e||!e.path){a=d.createMessageObject({code:"5066"});B(a)}if(!e.path.service){a=d.createMessageObject({code:"5067"});B(a)}if(e.analyticalConfiguration){if(!e.analyticalConfiguration.service){a=d.createMessageObject({code:n.message.code.errorInAnalyticalConfig,rawText:"service or entity set are missing in analytical configuration in the application configuration"});B(a)}}}function j(e){var a;if(e.evaluations&&!e.evaluations.service){a=d.createMessageObject({code:"5063"});B(a)}if(e.evaluations&&(!e.evaluations.type||e.evaluations.type!=="smartBusinessRequest")){a=d.createMessageObject({code:"5062",rawText:"type in Smart Business configuration is not smartBusinessRequest"});B(a)}if(e.evaluations&&!e.evaluations.entityType){a=d.createMessageObject({code:"5061"});B(a)}}this.getResourceLocation=function(e){return g.getItem(e)};this.getPersistenceConfiguration=function(){var e=jQuery.Deferred();L.done(function(){e.resolve(m)});return e};this.getConfigurationProperties=function(){var a=jQuery.Deferred();e.corePromise.done(function(){a.resolve(v)});return a};function A(){var a,t,i;var o=e.manifests.manifest;var n=e.manifests.baseManifest;var s;if(L.state()==="resolved"){return}var c=r.getBaseURLOfComponent(f.getComponentNameFromManifest(e.manifests.baseManifest));var u=r.getBaseURLOfComponent(f.getComponentNameFromManifest(e.manifests.manifest));if(o["sap.app"].dataSources&&o["sap.app"].dataSources.PathPersistenceServiceRoot){i=o["sap.app"].dataSources.PathPersistenceServiceRoot.uri}else if(e.functions.isUsingCloudFoundryProxy()){i=""}else{s=d.createMessageObject({code:"5064"});B(s)}var l=n["sap.app"].i18n;if(typeof l==="string"){l=r.addRelativeToAbsoluteURL(c,l)}else if(typeof l==="object"){l=r.addRelativeToAbsoluteURL(c,l.bundleUrl)}var g=o["sap.app"].i18n;if(typeof g==="string"){g=r.addRelativeToAbsoluteURL(u,g)}else if(typeof g==="object"){g=r.addRelativeToAbsoluteURL(u,g.bundleUrl)}var v=o["sap.app"].title;var m=f.createPseudoGuid();p.registerTextWithKey(m,v);var y=p.getStartParameterFacade().getAnalyticalConfigurationId();var P="";if(o["sap.app"].dataSources&&o["sap.app"].dataSources.AnalyticalConfigurationLocation&&o["sap.app"].dataSources.AnalyticalConfigurationLocation.uri){P=o["sap.app"].dataSources.AnalyticalConfigurationLocation.uri;P=r.addRelativeToAbsoluteURL(u,P)}if(!y&&!P){s=d.createMessageObject({code:"5065"});B(s)}var C={appName:m,appTitle:m,analyticalConfigurationLocation:P,textResourceLocations:{apfUiTextBundle:l,applicationUiTextBundle:g},persistence:{path:{service:i}}};if(o["sap.apf"]&&o["sap.apf"].appSpecificParameters){for(a in o["sap.apf"].appSpecificParameters){C[a]=o["sap.apf"].appSpecificParameters[a]}}if(o["sap.app"].dataSources&&o["sap.app"].dataSources.SmartBusiness){t=o["sap.app"].dataSources.SmartBusiness.uri;C.smartBusiness={runtime:{service:t}}}if(o["sap.app"].dataSources&&o["sap.app"].dataSources.LogicalSystem){C.persistence.logicalSystem={service:o["sap.app"].dataSources.LogicalSystem.uri}}U({applicationConfiguration:C},y);M().done(function(){if(y){x(y)}else{b()}})}function O(){var e=p.getUriGenerator().getApfLocation();g.setItem(n.resourceLocation.apfUiTextBundle,e+"resources/i18n/apfUi.properties");g.setItem(n.resourceLocation.applicationMessageDefinitionLocation,"");g.setItem(n.resourceLocation.applicationMessageTextBundle,"");g.setItem(n.resourceLocation.applicationUiTextBundle,"");g.setItem(n.resourceLocation.analyticalConfigurationLocation,"")}function U(a,t){function i(e){v=l({},e);delete v.type;delete v.analyticalConfigurationLocation;delete v.applicationMessageDefinitionLocation;delete v.textResourceLocations;delete v.persistence}var o=a.applicationConfiguration;i(o);var s=a.applicationConfiguration.textResourceLocations;m=a.applicationConfiguration.persistence;if(!e.functions.isUsingCloudFoundryProxy()){R(m);if(!m.path.entitySet){m.path.entitySet=n.entitySets.analysisPath}}if(a.applicationConfiguration.smartBusiness){y=a.applicationConfiguration.smartBusiness;j(y)}var r;var c;var u;for(u in n.resourceLocation){if(!n.resourceLocation.hasOwnProperty(u)){continue}if(u===n.resourceLocation.analyticalConfigurationLocation&&t){continue}if(o[u]!==undefined){c=o[u]}else if(s[u]!==undefined){c=s[u]}else{continue}if(e.manifests){g.setItem(u,c)}else if(u===n.resourceLocation.apfUiTextBundle||e.instances.fileExists.check(c,true)){g.setItem(u,c)}else if(!t){r=d.createMessageObject({code:"5059",aParameters:[c,u]});B(r)}}}function B(e){d.putMessage(e)}function F(){var a;var t;var i;jQuery.when(L).done(function(){a=c.getResourceLocation(n.resourceLocation.apfUiTextBundle);t=c.getResourceLocation(n.resourceLocation.applicationUiTextBundle);i=c.getResourceLocation(n.resourceLocation.applicationMessageTextBundle);e.functions.initTextResourceHandlerAsPromise(a,t,i).done(function(){e.corePromise.resolve()})})}O();if(e.constructors&&e.constructors.ProxyForAnalyticalConfiguration){C=e.constructors.ProxyForAnalyticalConfiguration}else if(e.functions.isUsingCloudFoundryProxy()){C=e.constructors&&e.constructors.RuntimeProxy||o}else if(S()){C=e.constructors&&e.constructors.LayeredRepositoryProxy||i}else{C=t}if(e.manifests&&e.manifests.manifest){A()}if(e.corePromise){F()}}c("sap.apf.core.ResourcePathHandler",d);return d});
//# sourceMappingURL=resourcePathHandler.js.map