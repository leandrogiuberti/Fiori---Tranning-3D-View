/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/utils/filterTerm","sap/apf/core/constants","sap/ui/model/Filter","sap/apf/utils/exportToGlobal","sap/apf/utils/utils","sap/ui/thirdparty/jquery"],function(e,r,t,i,s,jQuery){"use strict";var n="%20and%20";var o="%20or%20";var a=function(r,t,i,s,n){this.type="internalFilter";this.messageHandler=r;if(t&&(t instanceof e||t instanceof a)){this.leftExpr=t}else if(t!==undefined&&i!==undefined&&s!==undefined){this.leftExpr=new e(r,t,i,s,n)}else if(t!==undefined||i!==undefined||s!==undefined){r.check(false,"wrong arguments in construction of sap.apf.core.utils.Filter")}this.restExpr=[]};a.prototype.getProperties=function(){var r;var t=[];var i=[];var n="";if(this.leftExpr===undefined){return t}if(this.leftExpr instanceof e){n=this.leftExpr.getProperty();t.push(n)}else if(this.leftExpr instanceof a){t=this.leftExpr.getProperties()}for(r=0;r<this.restExpr.length;r++){if(this.restExpr[r]instanceof e){t.push(this.restExpr[r].getProperty())}else{i=this.restExpr[r].getProperties();t=t.concat(i)}}return s.eliminateDuplicatesInArray(this.messageHandler,t)};a.prototype.copy=function(){var e;var t;if(this.leftExpr===undefined){return new a(this.messageHandler)}e=new a(this.messageHandler,this.leftExpr);if(this.levelOperator===undefined){return e}for(t=0;t<this.restExpr.length;t++){if(this.levelOperator===r.BooleFilterOperators.AND){e.addAnd(this.restExpr[t].copy())}else{e.addOr(this.restExpr[t].copy())}}return e};a.prototype.isEmpty=function(){if(this.leftExpr===undefined){return true}if(this.leftExpr instanceof e){return false}if(!this.leftExpr.isEmpty()){return false}if(this.restExpr.length===0){return true}var r;for(r=0;r<this.restExpr.length;++r){if(!this.restExpr[r].isEmpty()){return false}}return true};a.prototype.isOr=function(){if(this.levelOperator===r.BooleFilterOperators.OR){return true}else if(this.levelOperator===r.BooleFilterOperators.AND){return false}if(this.leftExpr){if(this.leftExpr instanceof a){return this.leftExpr.isOr()}}return false};a.prototype.isEqual=function(e){if(this===e){return true}if(e===undefined){return false}return this.getHash()===e.getHash()};a.prototype.getHash=function(e){var t=e||1;var i=0;if(this.restExpr.length===0){i=t}else{i=t+1}if(this.leftExpr===undefined){return 0}var s=this.leftExpr.getHash(i);var n;if(this.levelOperator===undefined){return s}if(this.levelOperator===r.BooleFilterOperators.AND){s=s+Math.pow(2,t)}else if(this.levelOperator===r.BooleFilterOperators.OR){s=s+Math.pow(3,t)}for(n=0;n<this.restExpr.length;n++){s=s+this.restExpr[n].getHash(i)}return s};a.prototype.getFilterTermsForProperty=function(r){var t=[];var i;if(this.leftExpr===undefined){return t}if(this.leftExpr instanceof a){t=this.leftExpr.getFilterTermsForProperty(r)}else if(r===this.leftExpr.getProperty()){t.push(this.leftExpr)}for(i=0;i<this.restExpr.length;i++){if(this.restExpr[i]instanceof e){if(r===this.restExpr[i].getProperty()){t.push(this.restExpr[i])}}else{t=t.concat(this.restExpr[i].getFilterTermsForProperty(r))}}return t};a.prototype.getFilterTerms=function(){var r=[];var t;if(this.leftExpr===undefined){return r}if(this.leftExpr instanceof a){r=this.leftExpr.getFilterTerms()}else{r.push(this.leftExpr)}for(t=0;t<this.restExpr.length;t++){if(this.restExpr[t]instanceof e){r.push(this.restExpr[t])}else{r=r.concat(this.restExpr[t].getFilterTerms())}}return r};a.prototype.isConsistentWithFilter=function(t,i){var s;var n=false;if(this.leftExpr===undefined){return true}if(this.levelOperator===undefined){return this.leftExpr.isConsistentWithFilter(t,i)}if(this.levelOperator===r.BooleFilterOperators.AND){if(!this.leftExpr.isConsistentWithFilter(t,i)){return false}for(s=0;s<this.restExpr.length;s++){if(!this.restExpr[s].isConsistentWithFilter(t,i)){return false}}return true}if(this.levelOperator===r.BooleFilterOperators.OR){if(o(this.leftExpr,t)){n=true;if(this.leftExpr.isConsistentWithFilter(t,i)){return true}}for(s=0;s<this.restExpr.length;s++){if(o(this.restExpr[s],t)){n=true;if(this.restExpr[s].isConsistentWithFilter(t,i)){return true}}}return!n}function o(r,t){if(r instanceof e){return r.getProperty()===t}return r.getProperties().indexOf(t)>=0}};a.prototype.removeTermsByProperty=function(e){var r=this.internalRemoveTermsByProperty(e);if(r===undefined){return new a(this.messageHandler)}return r};a.prototype.internalRemoveTermsByProperty=function(t){var i,s,n;if(this.leftExpr===undefined){return this.copy()}s=this.leftExpr.internalRemoveTermsByProperty(t);if(s instanceof e){s=new a(this.messageHandler,s.getProperty(),s.getOp(),s.getValue(),s.getHighValue())}if(this.levelOperator===undefined){return s}for(i=0;i<this.restExpr.length;i++){n=this.restExpr[i].internalRemoveTermsByProperty(t);if(s===undefined){if(n instanceof e){s=new a(this.messageHandler,n)}else{s=n}}else if(n!==undefined){if(this.levelOperator===r.BooleFilterOperators.AND){s.addAnd(n)}else{s.addOr(n)}}}if(s){return new a(this.messageHandler,s)}};a.prototype.removeTerms=function(t,i,s){var n;if(this.leftExpr===undefined){return this.copy()}var o=this.leftExpr.removeTerms(t,i,s);var l;if(o instanceof e){o=new a(this.messageHandler,o.getProperty(),o.getOp(),o.getValue(),o.getHighValue())}if(this.levelOperator===undefined){return o}for(n=0;n<this.restExpr.length;n++){l=this.restExpr[n].removeTerms(t,i,s);if(o===undefined){if(l instanceof e){o=new a(this.messageHandler,l)}else{o=l}}else if(l!==undefined){if(this.levelOperator===r.BooleFilterOperators.AND){o.addAnd(l)}else{o.addOr(l)}}}return o};a.prototype.addOr=function(t,i,s,n){var o;if(t instanceof a||t instanceof e){o=t}else if(t!==undefined&&i!==undefined&&s!==undefined){o=new e(this.messageHandler,t,i,s,n)}else{this.messageHandler.check(false,"sap.apf.core.utils.Filter.addOr: wrong arguments in construction of  Filter")}if(this.leftExpr===undefined){this.leftExpr=o;return this}if(this.levelOperator===undefined){this.levelOperator=r.BooleFilterOperators.OR}this.restExpr.push(o);this.messageHandler.check(this.levelOperator===r.BooleFilterOperators.OR,"sap.apf.core.utils.Filter - addOr wrong operation");return this};a.prototype.addAnd=function(t,i,s,n){var o;if(t instanceof a||t instanceof e){o=t}else if(t!==undefined&&i!==undefined&&s!==undefined){o=new e(this.messageHandler,t,i,s,n)}else{this.messageHandler.check(false,"sap.apf.core.utils.Filter.addAnd: wrong arguments in construction of  Filter")}if(this.leftExpr===undefined){this.leftExpr=o;return this}if(this.levelOperator===undefined){this.levelOperator=r.BooleFilterOperators.AND}this.messageHandler.check(this.levelOperator===r.BooleFilterOperators.AND,"sap.apf.core.utils.Filter - addAnd wrong operation");this.restExpr.push(o);return this};a.prototype.toUrlParam=function(e){var t="";if(this.leftExpr===undefined){return""}t=this.leftExpr.toUrlParam(e);var i=0;var s=this.restExpr.length;var a="";if(s===0){return t}if(this.levelOperator===r.BooleFilterOperators.AND){a=n}else{a=o}var l="";for(i=0;i<s;i++){l=this.restExpr[i].toUrlParam(e);if(t===""){t=l}else if(l!==""){t=t+a+l}}if(t===""){return""}return"("+t+")"};a.prototype.mapToSapUI5FilterExpression=function(){var e,i,s=[];if(this.leftExpr===undefined){return new t({filters:[],and:undefined})}if(this.restExpr.length===0){return this.leftExpr.mapToSapUI5FilterExpression()}if(!(this.leftExpr.type==="internalFilter"&&this.leftExpr.isEmpty())){s.push(this.leftExpr.mapToSapUI5FilterExpression())}for(e=0;e<this.restExpr.length;e++){if(!(this.restExpr[e].type==="internalFilter"&&this.restExpr[e].isEmpty())){s.push(this.restExpr[e].mapToSapUI5FilterExpression())}}i={aFilters:s,bAnd:this.levelOperator===r.BooleFilterOperators.AND};var n=new t({filters:i.aFilters,and:i.bAnd});n.bAnd=i.bAnd;return n};a.prototype.overwriteWith=function(e){var r=e.getProperties();var t;if(r.length!==0){t=this.removeTermsByProperty(r);if(t===undefined){return e.copy()}t.addAnd(e);return t}return this.copy()};a.prototype.restrictToProperties=function(e){var r=t(this.getProperties(),e);return this.copy().removeTermsByProperty(r)||new a(this.messageHandler);function t(e,r){var t;var i=[];var s={};var n=e?e.length:0;var o=r?r.length:0;for(t=0;t<o;t++){s[r[t]]=undefined}for(t=0;t<n;t++){if(!(e[t]in s)){i.push(e[t])}}return i}};a.prototype.isFilterTerm=function(){if(this.restExpr.length>0){return false}if(!this.leftExpr){return false}if(this.leftExpr instanceof e){return true}return this.leftExpr.isFilterTerm()};a.prototype.getSingleValueTerms=function(){var e=[];var t=this;var i=this.getProperties();i.forEach(function(i){var s=t.getFilterTermsForProperty(i);if(s.length===1&&s[0].getOp()===r.FilterOperators.EQ){e.push({property:s[0].getProperty(),value:s[0].getValue()})}});return e};a.prototype.traverse=function(t){if(!this.leftExpr){return t.processEmptyFilter()}if(this.leftExpr&&this.restExpr.length===0){if(this.leftExpr instanceof e){return t.processTerm(this.leftExpr)}return this.leftExpr.traverse(t)}if(this.levelOperator===r.BooleFilterOperators.AND){return t.processAnd(this.leftExpr,this.restExpr,this)}if(this.levelOperator===r.BooleFilterOperators.OR){return t.processOr(this.leftExpr,this.restExpr,this)}this.messageHandler.check(false,"undefined case in traverse()");return false};a.prototype.isDisjunctionOverEqualities=function(){var e=true;if(this.levelOperator===r.BooleFilterOperators.AND){return false}if(this.getProperties().length>1){return false}if(this.leftExpr instanceof a){if(this.leftExpr.getFilterTerms().length>1&&!this.leftExpr.isOr()){return false}}this.getFilterTerms().forEach(function(t){if(t.getOp()!==r.FilterOperators.EQ){e=false}});this.restExpr.forEach(function(r){if(r instanceof a){if(r.getFilterTerms().length>1){e=false}}});return e};a.prototype.mapToSelectOptions=function(e){var r=jQuery.Deferred();var t;var i=this;e(s);function s(e){t=e;var s=new n;s.process(i);r.resolve(s.getSelectionVariant())}function n(){var e={};e.SelectOptions=[];e.Parameters=[];function r(r){var t;e.SelectOptions.forEach(function(e){if(e.PropertyName===r){t=e}});if(!t){t={PropertyName:r,Ranges:[]};e.SelectOptions.push(t)}return t.Ranges}function i(e){var t,i;var s=r(e.getProperty());if(e.getHighValue()!==undefined&&e.getHighValue()!==null){s.push({Sign:"I",Option:e.getOp(),Low:e.getValue(),High:e.getHighValue()})}else{t=e.getOp();i=e.getValue();if(t==="StartsWith"){t="CP";i=i+"*"}else if(t==="EndsWith"){t="CP";i="*"+i}else if(t==="Contains"){t="CP";i="*"+i+"*"}s.push({Sign:"I",Option:t,Low:i})}}function s(r){e.Parameters.push({PropertyName:r.getProperty(),PropertyValue:r.getValue()})}this.getSelectionVariant=function(){if(e.SelectOptions.length>0||e.Parameters.length>0){return e}return{}};this.processEmptyFilter=function(){return};this.processTerm=function(e){if(!t?.includes(e.getProperty())){i(e)}else{s(e)}};this.processAnd=function(e,r){this.process(e);r.forEach(function(e){this.process(e)}.bind(this))};this.processOr=function(e,r){this.process(e);r.forEach(function(e){this.process(e)}.bind(this))};this.process=function(e){e.traverse(this)}}return r.promise()};a.createFromArray=function(e,t,i,s){var n=t.length;var o;var l;var f;var p;var h;var u;e.check(t instanceof Array&&t.length>0,"sap.apf.core.utils.Filter.createFromArray incorrect argument aProperties");e.check(i instanceof Array,"sap.apf.core.utils.Filter.createFromArray incorrect argument aData");if(s.length>0){for(o=0;o<s.length;++o){h=undefined;l=s[o];if(!i[l]){continue}for(f=0;f<n;f++){u=new a(e,t[f],r.FilterOperators.EQ,i[l][t[f]]);if(h===undefined){h=new a(e,u)}else{h.addAnd(u)}}if(p===undefined){p=new a(e,h)}else{p.addOr(h)}}return p}return new a(e)};a.createEmptyFilter=function(e,t){e.check(Array.isArray(t)&&t.length>0,"sap.apf.core.utils.Filter.createEmptyFilter - array with property names expected");return new a(e,t[0],r.FilterOperators.EQ,"").addAnd(t[0],r.FilterOperators.NE,"")};a.transformUI5FilterToInternal=function(e,r){return t(r,r.bAnd);function t(r,i){var s=new a(e);var n;if(r.aFilters){r.aFilters.forEach(function(e){if(e.aFilters){n=t(e,e.bAnd);if(i){s.addAnd(n)}else{s.addOr(n)}}else if(e.sPath){if(i){s.addAnd(e.sPath,e.sOperator,e.oValue1,e.oValue2)}else{s.addOr(e.sPath,e.sOperator,e.oValue1,e.oValue2)}}})}else{s=new a(e,r.sPath,r.sOperator,r.oValue1,r.oValue2)}return s}};i("sap.apf.core.utils.Filter",a);return a},true);
//# sourceMappingURL=filter.js.map