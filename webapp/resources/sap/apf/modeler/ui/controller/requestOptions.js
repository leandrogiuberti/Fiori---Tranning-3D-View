/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/textManipulator","sap/apf/modeler/ui/utils/textPoolHelper","sap/apf/modeler/ui/utils/viewValidator","sap/apf/modeler/ui/utils/constants","sap/apf/cloudFoundry/uiHandler","sap/apf/utils/utils","sap/ui/core/library","sap/ui/core/mvc/Controller","sap/ui/core/mvc/View","sap/ui/core/mvc/ViewType"],function(e,t,r,i,o,a,n,l,s,d,u,c){"use strict";var p=s.ValueState;function f(e){e.byId("idSource").attachEvent("selectService",e.handleSelectionOfService.bind(e))}function y(e){var r=jQuery.Deferred();e.setLabelDisplayOptionTypeAsPromise(t).done(function(){if(!e.byId("idOptionalRequestField")){r.resolve()}else{e.enableDisableLabelDisplayOptionTypeAsPromise().done(function(){r.resolve()})}});return r}var g=d.extend("sap.apf.modeler.ui.controller.requestOptions",{viewValidator:{},oConfigurationEditor:{},oParentObject:{},oStepPropertyMetadataHandler:{},initPromise:{},onInit:function(){var e=this;this.initPromise=jQuery.Deferred();var t=e.getView().getViewData().oConfigurationHandler.getTextPool();e.oSuggestionTextHandler=new i.SuggestionTextHandler(t);e.viewValidator=new o(e.getView());e.oConfigurationEditor=e.getView().getViewData().oConfigurationEditor;e.oParentObject=e.getView().getViewData().oParentObject;e.oStepPropertyMetadataHandler=e.getView().getViewData().oStepPropertyMetadataHandler;e.setDetailData();e.setDisplayText();f(e)},setDetailData:function(){var e=this;e.setSource();e.setEntityAsPromise().done(function(){e.setOptionalHierarchicalProperty();e.setSelectProperties().done(function(){e.setOptionalRequestFieldProperty();y(e).done(function(){e.initPromise.resolve()})})})},setSource:function(){var t=this;var r=t.getSource();t.byId("idSource").setValue("");t.setValidationStateForService();if(!e.checkIsNotNullOrUndefinedOrBlank(r)){t.addOrRemoveMandatoryFieldsAndRequiredFlag(false);return}t.byId("idSource").setValue(r);t.addOrRemoveMandatoryFieldsAndRequiredFlag(true)},setEntityAsPromise:function(){var r=this;var i=jQuery.Deferred();var o,a,n,l;a=r.byId("idSource").getValue();r.byId("idEntity").setModel(null);r.byId("idEntity").clearSelection();if(!e.checkIsNotNullOrUndefinedOrBlank(a)){i.resolve();return i.promise()}r.getAllEntitiesAsPromise(a).done(function(s){n=r.getEntity();if(e.checkIsNotNullOrUndefinedOrBlank(n)){l=r.validateSelectedValues(r,[n],s);s=l.aValues;n=l.aSelectedValues[0]}o=t.convert(s);r.byId("idEntity").setModel(o);if(!e.checkIsNotNullOrUndefinedOrBlank(n)||s.indexOf(n)===-1){r.getAllEntitiesAsPromise(a).done(function(t){n=t[0];if(e.checkIsNotNullOrUndefinedOrBlank(n)){r.byId("idEntity").setSelectedKey(n)}i.resolve()})}else if(e.checkIsNotNullOrUndefinedOrBlank(n)){r.byId("idEntity").setSelectedKey(n);i.resolve()}});return i.promise()},setSelectProperties:function(){var i=jQuery.Deferred();var o=this;var n,l,s,d,u=[];var c=o.getView().getViewData().oTextReader;n=o.byId("idSource").getValue();var p=o.getIdOfPropertiesControl();o.byId(p).setModel(null);o.byId(p).clearSelection();l=r.removePrefixText(o.byId("idEntity").getSelectedKey(),c(a.texts.NOTAVAILABLE));o.getAllEntitySetPropertiesAsPromise(n,l).done(function(r){s=o.getSelectProperties();if(e.checkIsNotNullOrUndefinedOrBlank(s)){u=o.validateSelectedValues(o,s,r);r=u.aValues;s=u.aSelectedValues}d=t.convert(r);o.byId(p).setModel(d);o.setSelectedKeysForProperties(s);i.resolve()});return i},updateSubViewInstancesOnReset:function(e){var t=this;t.oConfigurationEditor=e.getParameter("oConfigurationEditor");t.oParentObject=e.getParameter("oParentObject");t.setDetailData()},setDisplayText:function(){},handleChangeForSourceAsPromise:function(t){var i=jQuery.Deferred();var o=this,n,l;var s=o.byId("idSource").getValue().trim();var d=o.getView().getViewData().oTextReader;o.setValidationStateForService();if(!e.checkIsNotNullOrUndefinedOrBlank(s)){o.clearSource();o.addOrRemoveMandatoryFieldsAndRequiredFlag(false);o.setEntityAsPromise(o).done(function(){n=r.removePrefixText(o.byId("idEntity").getSelectedKey(),d(a.texts.NOTAVAILABLE));o.updateEntity(n);o.setSelectProperties();l=o.getSelectedKeysForProperties();o.updateSelectProperties(l);o.setOptionalHierarchicalProperty().done(function(){var e=r.removePrefixText(o.byId("idOptionalProperty").getSelectedKey(),d(a.texts.NOTAVAILABLE));o.updateHierarchicalProperty(e);o.setOptionalRequestFieldProperty();o.oConfigurationEditor.setIsUnsaved();o.fireRelevantEvents(t);i.resolve()})})}else{o.oConfigurationEditor.registerServiceAsPromise(s).done(function(u){o.getAllEntitiesAsPromise(s).done(function(c){if(u){o.addOrRemoveMandatoryFieldsAndRequiredFlag(true);o.updateSource(s);if(!e.checkIsNotNullOrUndefinedOrBlank(c)){var f={sValueState:p.Error,sValueStateText:d("hierarchicalServiceError")};o.setValidationStateForService(f);o.resetEntityAndProperties();return}}else{o.clearSource();o.addOrRemoveMandatoryFieldsAndRequiredFlag(false)}o.setEntityAsPromise(o).done(function(){n=r.removePrefixText(o.byId("idEntity").getSelectedKey(),d(a.texts.NOTAVAILABLE));o.updateEntity(n);o.setSelectProperties();l=o.getSelectedKeysForProperties();o.updateSelectProperties(l);o.setOptionalHierarchicalProperty().done(function(){var e=r.removePrefixText(o.byId("idOptionalProperty").getSelectedKey(),d(a.texts.NOTAVAILABLE));o.updateHierarchicalProperty(e);o.setOptionalRequestFieldProperty();o.oConfigurationEditor.setIsUnsaved();o.fireRelevantEvents(t);i.resolve()})})})})}return i.promise()},handleChangeForEntity:function(e){var t=this,i,o;var n=t.getView().getViewData().oTextReader;i=r.removePrefixText(t.byId("idEntity").getSelectedKey(),n(a.texts.NOTAVAILABLE));t.updateEntity(i);t.setSelectProperties();o=t.getSelectedKeysForProperties();t.updateSelectProperties(o);t.setOptionalHierarchicalProperty();var l=r.removePrefixText(t.byId("idOptionalProperty").getSelectedKey(),n(a.texts.NOTAVAILABLE));t.updateHierarchicalProperty(l);t.setOptionalRequestFieldProperty();t.oConfigurationEditor.setIsUnsaved();t.fireRelevantEvents(e)},handleChangeForSelectProperty:function(e){var t=this;var r=t.getSelectedKeysForProperties();t.updateSelectProperties(r);t.setOptionalRequestFieldProperty();y(t);t.oConfigurationEditor.setIsUnsaved();t.fireRelevantEvents(e)},handleChangeForOptionalRequestField:function(e){var t=this;var i=t.getView().getViewData().oTextReader;var o=[r.removePrefixText(t.byId("idOptionalRequestField").getSelectedKey(),i(a.texts.NOTAVAILABLE))];t.updateOptionalRequestFieldProperty(o);y(t);t.oConfigurationEditor.setIsUnsaved();t.fireRelevantEvents(e)},handleChangeForOptionalLabelDisplayOptionType:function(){var e=this;var t=e.byId("idOptionalLabelDisplayOptionType").getSelectedKey();e.changeLabelDisplayOption(t);e.oConfigurationEditor.setIsUnsaved()},handleChangeForOptionalSelectedPropertyLabelText:function(){var e=this;var t=e.byId("idOptionalSelectedPropertyLabelText").getValue();e.changeOptionalSelectedPropertyLabelText(t);e.oConfigurationEditor.setIsUnsaved()},handleSuggestionsForSource:function(e){var t=this;var r=t.oConfigurationEditor.getAllServices();t.oSuggestionTextHandler.manageSuggestions(e,r)},fireRelevantEvents:function(){},addOrRemoveMandatoryFieldsAndRequiredFlag:function(e){var t=this;t.byId("idEntityLabel").setRequired(e);t.byId(t.getIdOfPropertyLabel()).setRequired(e);if(e){t.viewValidator.addFields(["idEntity",t.getIdOfPropertiesControl()])}else{t.viewValidator.removeFields(["idEntity",t.getIdOfPropertiesControl()])}},handleSelectionOfService:function(e){var t=e.getParameter("sSelectedService");e.getSource().setValue(t);e.getSource().fireEvent("change")},handleShowValueHelpRequest:function(e){var t=this;var r={oTextReader:t.getView().getViewData().oTextReader,parentControl:e.getSource(),getCalatogServiceUri:t.getView().getViewData().getCalatogServiceUri};var i=t.getView().getViewData();if(i.oCoreApi&&i.oCoreApi.isUsingCloudFoundryProxy()){n.showValueHelp(r,i.oCoreApi,this)}else{u.create({id:t.createId("idCatalogServiceView"),viewName:"sap.apf.modeler.ui.view.catalogService",type:c.XML,viewData:r})}},getNonCommonValues:function(t,r){var i=[];if(!e.checkIsNotNullOrUndefined(t)){return i}i=t.filter(function(e){return r.indexOf(e)===-1});return i},validateSelectedValues:function(e,t,i){var o={},a=[],n=[],s=[],d=[],u;var c=e.getView().getViewData().oTextReader;o=l.validateSelectedValues(t,i);a=o.invalid;n=o.valid;s=r.addPrefixText(a,c);d=s.concat(i).length!==0?s.concat(i):i;u=s.concat(n).length!==0?s.concat(n):t;return{aValues:d,aSelectedValues:u}},handleSuggestionsForSelectedPropertyLabel:function(e){this.oSuggestionTextHandler.manageSuggestionTexts(e,i.TranslationFormatMap.STEPFILTERPROPERTY_LABEL)},resetEntityAndProperties:function(){},setOptionalRequestFieldProperty:function(){},setOptionalHierarchicalProperty:function(){return jQuery.Deferred().resolve()},getIdOfPropertiesControl:function(){return"idSelectProperties"},getIdOfPropertyLabel:function(){return"idSelectPropertiesLabel"},setSelectedKeysForProperties:function(e){var t=this;t.byId("idSelectProperties").setSelectedKeys(e)},getSelectedKeysForProperties:function(){var e=this,t=[],i=[];var o=e.getView().getViewData().oTextReader;t=e.byId("idSelectProperties").getSelectedKeys();t.forEach(function(e){i.push(r.removePrefixText(e,o(a.texts.NOTAVAILABLE)))});return i},setValidationStateForService:function(e){var t=this;var r={sValueState:p.None,sValueStateText:""};var i=e?e:r;t.byId("idSource").setValueState(i.sValueState);t.byId("idSource").setValueStateText(i.sValueStateText)},getSource:function(){},updateSource:function(e){},clearSource:function(){},getAllEntitiesAsPromise:function(e){return l.createPromise()},getEntity:function(){},updateEntity:function(e){},clearEntity:function(){},getAllEntitySetPropertiesAsPromise:function(e,t){return l.createPromise()},setLabelDisplayOptionTypeAsPromise:function(e){return l.createPromise()},enableDisableLabelDisplayOptionTypeAsPromise:function(){return l.createPromise()},getSelectProperties:function(){},updateSelectProperties:function(e){},clearSelectProperties:function(){},removeSelectProperties:function(e){},getOptionalRequestFieldProperty:function(){},updateOptionalRequestFieldProperty:function(e){},updateHierarchicalProperty:function(e){},clearOptionalRequestFieldProperty:function(){},removeOptionalRequestFieldProperty:function(e){},changeLabelDisplayOption:function(e){},changeOptionalSelectedPropertyLabelText:function(e){},handleChangeForOptionalProperty:function(){}});return g},true);
//# sourceMappingURL=requestOptions.js.map