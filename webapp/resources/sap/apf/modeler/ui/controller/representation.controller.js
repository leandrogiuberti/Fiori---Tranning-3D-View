/*!
* SAP APF Analysis Path Framework
*
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
sap.ui.define(["sap/apf/modeler/ui/utils/constants","sap/apf/modeler/ui/utils/representationHandler","sap/apf/ui/utils/constants","sap/apf/core/constants","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/sortDataHandler","sap/apf/modeler/ui/utils/representationBasicDataHandler","sap/apf/modeler/ui/utils/stepPropertyMetadataHandler","sap/apf/ui/utils/representationTypesHandler","sap/apf/modeler/ui/utils/viewValidator","sap/base/util/deepExtend","sap/m/Button","sap/ui/core/mvc/Controller","sap/ui/core/mvc/View","sap/ui/core/mvc/ViewType","sap/ui/thirdparty/jquery"],function(e,t,n,r,a,i,o,s,p,d,u,l,f,c,g,y,jQuery){"use strict";var T,v,m,h,D,P,E,w,C,I;var V=r.representationMetadata.labelDisplayOptions;function R(e){e.byId("idVisualization").setText(v.getText("visualization"));e.byId("idChartTypeLabel").setText(v.getText("chartType"));e.byId("idChartTypeLabel").setTooltip(v.getText("chartType"));e.byId("idBasicData").setText(v.getText("basicData"));e.byId("idSorting").setText(v.getText("sorting"));e.byId("idChartType").setValueStateText(v.getText("modeler.ui.representation.invalidChartTypeError"))}function b(e,t){var n;var r=P.getPictureOfRepresentationType(h.getRepresentationType());var a=m.getCategoriesForStep(D.getId());if(a.length===1){n={id:h.getId(),icon:r};if(t){n.name=t}e.getView().getViewData().updateSelectedNode(n)}else{e.getView().getViewData().updateTree()}}function x(e,t){var n=v.getText("representation")+": "+t;e.getView().getViewData().updateTitleAndBreadCrumb(n)}function M(e){h.setRepresentationType(e);var t="TableRepresentation";if(e===n.representationTypes.TABLE_REPRESENTATION||e===n.representationTypes.TREE_TABLE_REPRESENTATION){t=undefined}h.setAlternateRepresentationType(t)}function S(e){var t;var n=jQuery.Deferred();E.getEntityTypeMetadataAsPromise().done(function(r){var a=E.getDimensionsProperties(r);var i=P.getKindsForDimensionPropertyType(e);i.forEach(function(e,n){t=false;var i;var o;var s=a[n];if(h.getDimensions().length!==0){if(h.getDimensions()[n]){if(h.getDimensionKind(h.getDimensions()[n])){t=true}}}if(!t&&s){i=E.hasTextPropertyOfDimension(r,s);o=i?V.KEY_AND_TEXT:V.KEY;h.addDimension(s);h.setLabelDisplayOption(s,o);h.setDimensionKind(s,e)}});n.resolve()});return n.promise()}function A(e){var t;var n=E.oStep.getService();var r=E.oStep.getEntitySet();var a=E.oStep.getHierarchyProperty();m.getHierarchyNodeIdAsPromise(n,r,a).done(function(n){t=E.hasTextPropertyOfDimension(e,n)});return t}function K(e){var t,n;var r=jQuery.Deferred();E.getEntityTypeMetadataAsPromise().done(function(e){var a=E.getHierarchicalProperty();if(a&&h.getHierarchyPropertyLabelDisplayOption()===undefined){t=A(e);n=t?V.TEXT:V.KEY;h.setHierarchyPropertyLabelDisplayOption(n)}r.resolve()});return r.promise()}function O(e){var t=jQuery.Deferred(),n,r;var a;var i=0;E.getEntityTypeMetadataAsPromise().done(function(o){a=P.getKindsForMeasurePropertyType(e);n=E.getMeasures(o);a.forEach(function(t){var a=P.getDefaultCountForRepresentationKind(e,t);for(var o=0;o<a;o++){r=false;var s=n[i];if(h.getMeasures().length!==0){if(h.getMeasures()[i]){if(h.getMeasureKind(h.getMeasures()[i])){r=true}}}if(!r&&s){h.addMeasure(s);h.setMeasureKind(s,t)}i++}});t.resolve()});return t.promise()}function H(e){var t=jQuery.Deferred();var n,r;if(e==="TableRepresentation"){if(h.getProperties().length===0){r=P.getKindsForPropertyType(e);n=E.getProperties()[0];h.addProperty(n);h.setPropertyKind(n,r[0]);t.resolve()}else{t.resolve()}}else if(e==="TreeTableRepresentation"){K(e).done(function(){t.resolve()})}else{S(e).done(function(){O(e).done(function(){t.resolve()})})}return t.promise()}function L(){if(T&&T.arguments&&T.arguments.stepId){D=m.getStep(T.arguments.stepId)}}function N(){var e=v.getRepresentationTypes()[0].id;if(D.getType()==="hierarchicalStep"){e="TreeTableRepresentation"}return e}function B(e){var t;var n=jQuery.Deferred();if(T&&T.arguments&&T.arguments.representationId){h=D.getRepresentation(T.arguments.representationId)}if(!a.checkIsNotUndefined(h)){h=D.createRepresentation();t=N();M(t);b(e,v.getText(t));m.setIsUnsaved();H(t).done(function(){return n.resolve()})}else{t=h.getRepresentationType();j().done(function(){H(t).done(function(){return n.resolve()})})}return n.promise()}function _(e){var t=new f({id:e.createId("idPreviewButton"),text:v.getText("preview"),press:e.handlePreviewButtonPress.bind(e)});var n=e.getView().getViewData().oFooter;n.addContentRight(t)}async function F(t){var n=t.getView().getViewData().oConfigurationHandler.getTextPool();var r={oTextReader:v.getText,oConfigurationEditor:m,oTextPool:n,oParentObject:h,oParentStep:D,oRepresentationTypeHandler:P};var a=await c.create({name:"sap.apf.modeler.ui.controller.representationCornerTexts"});var i=await g.create({viewName:"sap.apf.modeler.ui.view.cornerTexts",type:y.XML,id:t.createId("representationCornerTexts"),viewData:r,controller:a});t.byId("idCornerTextsVBox").insertItem(i);t.getView().attachEvent(e.events.representation.SETCHARTICON,i.getController().setChartIcon.bind(i.getController()))}function U(){h.getDimensions().forEach(function(e){h.removeDimension(e)});h.getMeasures().forEach(function(e){h.removeMeasure(e)})}function k(){var e,t;if(h.getRepresentationType()==="TableRepresentation"){e=h.getDimensions();t=h.getMeasures();e.forEach(function(e){h.addProperty(e);h.setPropertyTextLabelKey(e,h.getDimensionTextLabelKey(e));h.setPropertyKind(e,r.representationMetadata.kind.COLUMN);m.setIsUnsaved()});t.forEach(function(e){h.addProperty(e);h.setPropertyTextLabelKey(e,h.getMeasureTextLabelKey(e));h.setPropertyKind(e,r.representationMetadata.kind.COLUMN);m.setIsUnsaved()});U()}}function X(e){var t;E.getEntityTypeMetadataAsPromise().done(function(n){t=E.hasTextPropertyOfDimension(n,e);if(t){h.setLabelDisplayOption(e,V.KEY_AND_TEXT)}else{h.setLabelDisplayOption(e,V.KEY)}m.setIsUnsaved()})}function Y(){var e=jQuery.Deferred();E.getEntityTypeMetadataAsPromise().done(function(t){h.getDimensions().forEach(function(e){if(h.getLabelDisplayOption(e)===undefined){X(e)}});e.resolve()});return e.promise()}function j(){k();return Y()}async function z(e){I.instantiateRepresentationSortData();await F(e);return C.instantiateBasicDataAsPromise()}function q(e){if(!e.getValidationState()){if(e.byId("idChartType").getValueState("None")){setTimeout(function(){e.byId("idChartType").setValueState("Error")},1)}}else{e.byId("idChartType").setValueState("None")}}var J=c.extend("sap.apf.modeler.ui.controller.representation",{onInit:function(){var e=this;e.promiseControllerIsCreated=new Promise(function(n){var r=e.getView().getViewData();v=r.oCoreApi;T=r.oParams;m=r.oConfigurationEditor;P=new d;e.oViewValidator=new u(e.getView());R(e);L();if(D.getType()!=="hierarchicalStep"){_(e)}E=new(r.StepPropertyMetadataHandler||p)(v,D);B(e).then(function(){w=new t(h,P,v.getText);C=new s(e.getView(),E,w,e.oViewValidator);I=new o(e.getView(),h,E,v.getText);z(e).then(function(){e.setDetailData();n()})})})},promiseControllerIsCreated:null,setDetailData:function(){var e=this;e._setChartType()},handleChangeForChartType:function(t){var n=this;var r=t.getParameter("selectedItem").getKey();var a=v.getText(r);var i=h.getRepresentationType();M(r);b(n,a);x(n,a);if(!P.isChartTypeSimilar(i,r)){n.getView().fireEvent(e.events.REMOVEALLPROPERTIESFROMPARENTOBJECT);U();H(r).done(function(){C.instantiateBasicDataAsPromise().then(function(){q(n)});n.getView().fireEvent(e.events.representation.SETCHARTICON);m.setIsUnsaved()})}else{C.instantiateBasicDataAsPromise().then(function(){q(n)});n.getView().fireEvent(e.events.representation.SETCHARTICON);m.setIsUnsaved()}},handlePreviewButtonPress:function(){var e=this;var t={oParentStep:D,oRepresentation:h,oConfigurationHandler:e.getView().getViewData().oConfigurationHandler,oCoreApi:v,oRepresentationHandler:w,oStepPropertyMetadataHandler:E,oRepresentationTypeHandler:P};g.create({id:e.createId("idPreviewContentView"),viewName:"sap.apf.modeler.ui.view.previewContent",type:y.XML,viewData:t})},onExit:function(){var e=this;e.getView().getViewData().oFooter.removeContentRight(e.byId("idPreviewButton"));C.destroyBasicData();I.destroySortData();e.byId("idCornerTextsVBox").destroyItems()},getValidationState:function(){return this.oViewValidator.getValidationState()},_setChartType:function(){var e=this;E.getEntityTypeMetadataAsPromise().done(function(t){var n;var r=E.getDimensionsProperties(t);var a=E.getMeasures(t);var o=e._getAnnotatedChartTypes(P.aRepresentationTypes,E.getRepresentationTypesArray(),r,a,v);n=i.prepareModel(o);e.byId("idChartType").setModel(n);e.byId("idChartType").setSelectedKey(h.getRepresentationType());q(e)})},_getAnnotatedChartTypes:function(e,t,n,r,a){function i(e,t){var n;e.forEach(function(e){if(e["id"]===t){n=e}});return n}var o=l([],t);o.forEach(function(t){var o=0,s=0;var p=i(e,t.key);if(p.metadata&&p.id!=="TableRepresentation"&&p.id!=="TreeTableRepresentation"){p.metadata.dimensions.supportedKinds.forEach(function(e){o+=parseInt(e.min,10)});p.metadata.measures.supportedKinds.forEach(function(e){s+=parseInt(e.min,10)});if(n.length<o||r.length<s){t.name=a.getText("modeler.ui.representation.invalidChartTypes",[t.name])}}});return o}});return J},true);
//# sourceMappingURL=representation.controller.js.map