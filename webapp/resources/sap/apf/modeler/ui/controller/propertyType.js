sap.ui.define(["sap/apf/modeler/ui/utils/constants","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/textPoolHelper","sap/apf/modeler/ui/utils/textManipulator","sap/apf/utils/utils","sap/ui/Device","sap/ui/core/Item","sap/ui/core/mvc/Controller","sap/ui/thirdparty/jquery"],function(e,t,r,o,i,a,n,s,d,jQuery){"use strict";var p=e.events;var l=o.TranslationFormatMap.REPRESENTATION_LABEL;function y(e){var t=e.oRepresentation.getRepresentationType();var r=e.getView().getViewData().oPropertyTypeData.sContext;var o=e.getView().getViewData().oRepresentationTypeHandler.getLabelsForChartType(e.oTextReader,t,r);e.byId("idPropertyTypeLabel").setText(o);e.byId("idPropertyTypeLabel").setTooltip(o)}function f(e){if(n.browser.msie&&n.browser.version>=11){e.byId("idAriaPropertyForBasicDataGroup").setText(e.oTextReader("basicData"))}e.byId("idAriaPropertyForAdd").setText(e.oTextReader("ariaTextForAddIcon"));e.byId("idAriaPropertyForDelete").setText(e.oTextReader("ariaTextForDeleteIcon"))}function u(e){var r;var o=jQuery.Deferred();var i=e.byId("idPropertyType");e.getAllPropertiesAsPromise().then(function(e){r=t.convert(e.aAllProperties);i.setModel(r);i.setSelectedKey(e.sSelectedKey);o.resolve()});return o.promise()}function g(t){var r=i.removePrefixText(t.byId("idPropertyType").getSelectedKey(),t.oTextReader(e.texts.NOTAVAILABLE));var o=t.getPropertyTextLabelKey(r)?t.oTextReader("label"):t.oTextReader("label")+" ("+t.oTextReader("default")+")";t.byId("idPropertyLabel").setText(o);t.byId("idPropertyLabel").setTooltip(o)}function c(t){var o;var a=i.removePrefixText(t.byId("idPropertyType").getSelectedKey(),t.oTextReader(e.texts.NOTAVAILABLE));var n=t.getPropertyTextLabelKey(a);if(r.checkIsNotUndefined(n)){o=t.getView().getViewData().oConfigurationHandler.getTextPool().get(n).TextElementDescription;t.byId("idPropertyLabelText").setValue(o)}else{t.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().then(function(e){var r=t.oStepPropertyMetadataHandler.getDefaultLabel(e,a);t.byId("idPropertyLabelText").setValue(r)})}}function P(e){e.byId("idAddPropertyIcon").setTooltip(e.oTextReader("addButton"));e.byId("idRemovePropertyIcon").setTooltip(e.oTextReader("deleteButton"))}function v(e){var t=e.getView().getViewData().sPropertyType;var r=e.getView().getViewData().oPropertyTypeData.sContext;var o=e.oRepresentationTypeHandler.isAdditionToBeEnabled(e.oRepresentation.getRepresentationType(),t,r);var i=o;var a=e.getView().getViewData().oPropertyTypeState;var n=a.indexOfPropertyTypeViewId(e.getView().getId());if(n===0){i=false}else if(n>0){var s=a.getViewAt(n-1);var d=s.getViewData().oPropertyTypeData.sContext;if(r!==d){i=false}}e.byId("idAddPropertyIcon").setVisible(o);e.byId("idRemovePropertyIcon").setVisible(i);if(n>0){s.oController?.byId("idAddPropertyIcon").setVisible(false)}}function T(e){var t=e.getView().getViewData().oPropertyTypeState;var r=t.indexOfPropertyTypeViewId(e.getView().getId());if(r>0){var o=t.aProperties.length-1;var i=t.getViewAt(r-1);var a=t.getViewAt(r);var n=e.oConfigurationEditor.isSaved()}if(r>0&&r==o&&n==false){i.oController.byId("idAddPropertyIcon").setVisible(false);a.oController.byId("idAddPropertyIcon").setVisible(true);a.oController.byId("idRemovePropertyIcon").setVisible(true)}}function I(e,t){var r=e.getView().getViewData().oPropertyTypeState;var o=r.aProperties.length;var i=r.getViewAt(t-1);var a=e.oConfigurationEditor.isSaved();if(t>1&&t==o&&a==false){i.oController.byId("idAddPropertyIcon").setVisible(true);i.oController.byId("idRemovePropertyIcon").setVisible(true)}if(t===1&&t==o&&a==false){i.oController.byId("idAddPropertyIcon").setVisible(true)}}function b(e){e.byId("idAddPropertyIcon").attachEvent(p.SETFOCUSONADDICON,e.setFocusOnAddRemoveIcons.bind(e))}var V=d.extend("sap.apf.modeler.ui.controller.propertyType",{_apfName:"propertyType",oConfigurationEditor:{},oRepresentation:{},oStepPropertyMetadataHandler:{},oRepresentationTypeHandler:{},oTextReader:{},oTextPool:{},initPromise:null,onInit:function(){var e=this;e.initPromise=new jQuery.Deferred;e.oConfigurationEditor=e.getView().getViewData().oConfigurationEditor;e.oRepresentation=e.getView().getViewData().oParentObject;e.oStepPropertyMetadataHandler=e.getView().getViewData().oStepPropertyMetadataHandler;e.oRepresentationTypeHandler=e.getView().getViewData().oRepresentationTypeHandler;e.oTextReader=e.getView().getViewData().oCoreApi.getText;e.oTextPool=e.getView().getViewData().oTextPool;if(e.getView().getViewData().oPropertyTypeData.bMandatory){e.getView().getViewData().oViewValidator.addField(e.byId("idPropertyType").getId());e.byId("idPropertyTypeLabel").setRequired(true)}u(e).then(function(){e.setDetailData().then(function(){e.initPromise.resolve()});v(e)})},onAfterRendering:function(){var e=this;e.initPromise.then(function(){e.enableDisableLabelDisplayOptionTypeAsPromise().then(function(){e.byId("idAddPropertyIcon").fireEvent(p.SETFOCUSONADDICON)})})},setDetailData:function(){var e=jQuery.Deferred();var r=this;r.setLabelDisplayOptionTypeAsPromise(t).then(function(){if(!r.byId("idPropertyType")){e.resolve();return}c(r);f(r);g(r);y(r);P(r);e.resolve()});return e.promise()},handleChangeForPropertyTypeAsPromise:function(t){var r=this;var o=jQuery.Deferred();var a=i.removePrefixText(r.byId("idPropertyType").getSelectedKey(),r.oTextReader(e.texts.NOTAVAILABLE));var n=r.getView().getViewData().oPropertyOrchestration;var s=r.getView().getId();var d;var p=null;if(n){d=n.isSwapCase(s,a);p=n.getPropertyTypeRowByPropertyName(a);n.updateAllSelectControlsForPropertyType(s,a).then(function(){var e;r.updateRepresentationAndView().then(function(){if(d){e=p.oView.getController();e.updateRepresentationAndView().then(function(){r.oConfigurationEditor.setIsUnsaved();o.resolve()})}else{r.oConfigurationEditor.setIsUnsaved();o.resolve()}})})}else{r.forceFailSinceOrchestrationIsMissing();o.resolve()}return o.promise()},updateRepresentationAndView:function(){var e=this;return new Promise(function(t){e.updateOfConfigurationObjectAsPromise().then(function(){e.setDetailData();e.enableDisableLabelDisplayOptionTypeAsPromise().then(function(){t()})})})},handleChangeForLabelDisplayOptionType:function(){var e=this;var t=e.byId("idLabelDisplayOptionType").getSelectedKey();e.changeLabelDisplayOption(t);e.oConfigurationEditor.setIsUnsaved()},handleChangeForLabelText:function(){var t=this,r;var o=t.byId("idPropertyLabelText").getValue();var a=i.removePrefixText(t.byId("idPropertyType").getSelectedKey(),t.oTextReader(e.texts.NOTAVAILABLE));if(o.trim().length===0){r=undefined;t.setPropertyTextLabelKey(a,r);g(t);c(t);t.oConfigurationEditor.setIsUnsaved()}else{t.getView().getViewData().oConfigurationHandler.getTextPool().setTextAsPromise(o,l).then(function(e){t.setPropertyTextLabelKey(a,e);g(t);c(t);t.oConfigurationEditor.setIsUnsaved()})}},setFocusOnAddRemoveIcons:function(){var e=this;e.byId("idAddPropertyIcon").focus()},handlePressOfAddPropertyIcon:function(){var t=this;var r=t.getView();var o=r.getViewData().oPropertyOrchestration;var i=t.byId("idPropertyType").getItems();var a=t.byId("idPropertyType").getSelectedKey();var n=t.oTextReader("none");if(this._shallAddPropertyBeHandled(i,a,n,o)){b(t);t.getView().fireEvent(e.events.ADDPROPERTY,{oSourceView:r});t.oConfigurationEditor.setIsUnsaved();T(t)}},handlePressOfRemovePropertyIcon:function(){var e=this;var t=e.getView().getViewData();var r=t.oPropertyTypeState;var o=r.indexOfPropertyTypeViewId(e.getView().getId());if(o>0){var i=r.getViewAt(o-1);b(i.getController())}var a=t.oPropertyOrchestration;a.removePropertyTypeReference(e.getView().getId());return e.updateRepresentationAndView().then(function(){a.updateAllSelectControlsForPropertyType();t.oPropertyTypeHandlerBackLink.handlePressOfRemove({oSourceView:e.getView()});e.oConfigurationEditor.setIsUnsaved();if(o!==0){I(e,o)}e.getView().destroy()})},updateOfConfigurationObjectAsPromise:function(){var e=this;return new Promise(function(t){var r=[];if(e.getView().getViewData().oPropertyOrchestration){r=e.getView().getViewData().oPropertyOrchestration.getPropertyInformationList();e.updatePropertiesInConfiguration(r)}else{e.forceFailSinceOrchestrationIsMissing()}t()})},handleSuggestions:function(e){var t=this;var r=new o.SuggestionTextHandler(t.oTextPool);r.manageSuggestionTexts(e,l)},getSelectedProperty:function(){var e=this;var t=e.getView().getViewData().oPropertyTypeState;var r=t.getPropertyValueState();var o=t.indexOfPropertyTypeViewId(e.getView().getId());return r[o]},removeAllItemsFromDropDownList:function(){var e=this;var t=e.byId("idPropertyType");t.getItems().forEach(function(e){t.removeItem(e)})},setItemsOfDropDownList:function(t,r,o,a,n){function d(e,t){return e.indexOf(t)!==-1}var p=this;var l=p.byId("idPropertyType");var y=[];var f=o===p.oTextReader("none");if(!a&&n===e.aggregationRoles.DIMENSION){l.addItem(new s({key:p.oTextReader("none"),text:p.oTextReader("none")}))}if(n===e.aggregationRoles.MEASURE){y=JSON.parse(JSON.stringify(r))}else{y=JSON.parse(JSON.stringify(t))}if(!d(y,o)&&!f){y.unshift(o)}y.forEach(function(e){var t=e;if(!d(r,e)&&!f&&e!==""){e=i.addPrefixText([e],p.oTextReader)[0]}var a=new s({key:e,text:e});l.addItem(a);if(t===o){o=e}});l.setSelectedKey(o)},updatePropertiesInConfiguration:function(e){},createNewPropertyInfoAsPromise:function(e){return a.createPromise()},setPropertyInParentObject:function(){},setLabelDisplayOptionTypeAsPromise:function(e){return a.createPromise()},getAllPropertiesAsPromise:function(){return a.createPromise()},getPropertyTextLabelKey:function(e){},setPropertyTextLabelKey:function(e,t){},enableDisableLabelDisplayOptionTypeAsPromise:function(){return a.createPromise()},removePropertyFromParentObject:function(){},addPropertyAsPromise:function(){return a.createPromise()},changeLabelDisplayOption:function(e){},_shallAddPropertyBeHandled:function(t,r,o,i){var a=t.filter(function(e){return e.mProperties.key!==o});if(i&&i.getAggregationRole()===e.aggregationRoles.MEASURE){var n=i._getPropertyTypeRows().length;return n<a.length}if(t.length===0||!r){return false}var s=a.filter(function(e){return e.mProperties.key!==r});var d=r===o;if(s.length<2&&d){return false}else if(s.length<1&&!d){return false}return true}});return V});
//# sourceMappingURL=propertyType.js.map