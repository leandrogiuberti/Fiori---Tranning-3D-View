/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/modeler/ui/controller/facetFilterVHR.controller","sap/apf/modeler/ui/controller/facetFilterFRR.controller","sap/apf/modeler/ui/utils/constants","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/textManipulator","sap/apf/modeler/ui/utils/textPoolHelper","sap/apf/modeler/ui/utils/viewValidator","sap/apf/utils/utils","sap/m/Token","sap/ui/core/library","sap/ui/core/mvc/Controller","sap/ui/core/mvc/View","sap/ui/core/mvc/ViewType"],function(e,t,i,l,n,a,o,s,d,r,u,c,f,I){"use strict";var b=u.ValueState;var V=i.events.facetFilter;var g,y,F,S,p,v,R;var h=o.TranslationFormatMap.FACETFILTER_LABEL;function P(e){e.byId("idFacetFilterBasicData").setText(y("basicData"));e.byId("idFFLabel").setText(y("ffLabel"));e.byId("idLabel").setPlaceholder(y("newFacetFilter"));e.byId("idFFPropertyLabel").setText(y("ffProperty"));e.byId("idDoNotShowAtRuntimeLabel").setText(y("doNotShowAtRuntime"));e.byId("idSelectionModeLabel").setText(y("ffSelectionMode"));e.byId("idValueHelpLabel").setText(y("valueHelpMode"));e.byId("idVHNone").setText(y("none"));e.byId("idValueHelpRequest").setText(y("valueHelpRequest"));e.byId("idConfigListOfValues").setText(y("configListOfValues"));e.byId("idConfigListOfValuesLabel").setText(y("configListOfValuesLabel"));e.byId("idSingleSelectionMode").setText(y("singleSelection"));e.byId("idMultiSelectionMode").setText(y("multipleSelection"));e.byId("idDefaultValuesTitle").setText(y("vhDefaultValues"));e.byId("idPreselectionModeLabel").setText(y("vhDefaultValueMode"));e.byId("idNoneSelection").setText(y("none"));e.byId("idAutomaticSelection").setText(y("automaticValue"));e.byId("idFixedValue").setText(y("fixedValues"));e.byId("idFunction").setText(y("function"));e.byId("idPreselectionDefaultsLabel").setText(y("vhDefaultValues"));e.byId("idPreselectionFunctionLabel").setText(y("function"));e.byId("idValueHelpTitle").setText(y("valueHelp"));e.byId("idFilterResolutionTitle").setText(y("contextResolution"));e.byId("idUseVHRAsFRRCheckBoxLabel").setText(y("vhCheckBoxLabel"));e.byId("idAriaPropertyForSelection").setText(y("ffSelectionMode"));e.byId("idAriaPropertyForDefaultMode").setText(y("vhDefaultValueMode"));e.byId("idAriaPropertyForVHR").setText(y("valueHelpMode"))}function T(e,t){var i=v.isVisible()?"sap-icon://filter":"sap-icon://hide";var l={id:v.getId(),icon:i};if(t){delete l.icon;l.name=t}e.getView().getViewData().updateSelectedNode(l)}function m(e,t){var i=y("facetFilter")+": "+t;e.getView().getViewData().updateTitleAndBreadCrumb(i)}function C(e){var t;if(g&&g.arguments&&g.arguments.facetFilterId){v=S.getFacetFilter(g.arguments.facetFilterId);L(v)}if(!l.checkIsNotUndefined(v)){t=S.createFacetFilter();v=S.getFacetFilter(t);T(e);L(v)}}function L(e){true}async function E(l){var n={oTextReader:y,oConfigurationHandler:F,oConfigurationEditor:S,oParentObject:v,getCalatogServiceUri:l.getView().getViewData().getCalatogServiceUri,oCoreApi:l.getView().getViewData().oCoreApi};const[a,o]=await Promise.all([f.create({viewName:"sap.apf.modeler.ui.view.requestOptions",type:I.XML,id:l.createId("idVHRView"),viewData:n,controller:new e}),f.create({viewName:"sap.apf.modeler.ui.view.requestOptions",type:I.XML,id:l.createId("idFRRView"),viewData:n,controller:new t})]);a.attachEvent(V.UPDATEPROPERTIES,l.setFFProperty.bind(l));o.attachEvent(V.UPDATEPROPERTIES,l.setFFProperty.bind(l));l.getView().attachEvent(V.USESAMEASVHR,o.getController().handleCopy.bind(o.getController()));l.getView().attachEvent(V.ENABLEDISABLEFRRFIELDS,o.getController().enableOrDisableView.bind(o.getController()));a.attachEvent(V.USESAMEASVHR,o.getController().handleCopy.bind(o.getController()));l.getView().attachEvent(i.events.UPDATESUBVIEWINSTANCESONRESET,a.getController().updateSubViewInstancesOnReset.bind(a.getController()));l.getView().attachEvent(i.events.UPDATESUBVIEWINSTANCESONRESET,o.getController().updateSubViewInstancesOnReset.bind(o.getController()));l.getView().attachEvent(V.DONOTSHOWATRUNTIME,a.getController().clearVHRFields.bind(a.getController()));l.getView().attachEvent(V.CLEARVHRFIELDSIFVALUELIST,a.getController().clearVHRFields.bind(a.getController()));l.getView().attachEvent(V.DONOTSHOWATRUNTIME,o.getController().clearFRRFields.bind(o.getController()));a.addStyleClass("formTopPadding");a.addStyleClass("formBottomPadding");o.addStyleClass("formTopPadding")}function D(e,t){e.byId("idSelectionMode").setVisible(t);e.byId("idSelectionModeLabel").setVisible(t);e.byId("idSelectionModeRadioGroup").setSelectedButton(e.byId("idMultiSelectionMode"));e.byId("idValueHelp").setVisible(t);e.byId("idValueHelpLabel").setVisible(t);e.byId("idValueHelpRadioGroup").setSelectedButton(e.byId("idVHNone"));e.byId("idFFForm1").setVisible(t);if(t){e.byId("idValueHelpTitle").setText(y("valueHelp"));e.byId("idFRRVBox").insertItem(e.byId("idFRRView"));e.byId("idDoNotShowAtRuntimeCheckBox").setSelected(false)}else{e.byId("idValueHelpTitle").setText("");G(e,t);U(e,t);e.byId("idFRRVBox").removeItem(e.byId("idFRRView"))}}function A(e){if(!v.isVisible()){e.byId("idDoNotShowAtRuntimeCheckBox").setSelected(true)}D(e,v.isVisible())}function O(e){if(!l.checkIsNotNullOrUndefinedOrBlank(S.getFacetFilter(g.arguments.facetFilterId))){return}if(l.checkIsNotNullOrUndefinedOrBlank(v.getLabelKey())&&p.get(v.getLabelKey())){e.byId("idLabel").setValue(p.get(v.getLabelKey()).TextElementDescription)}else{e.byId("idLabel").setValue(v.getId())}}function x(e){if(!l.checkIsNotNullOrUndefinedOrBlank(S.getFacetFilter(g.arguments.facetFilterId))){v.setMultiSelection(true)}if(v.isMultiSelection()){e.byId("idSelectionModeRadioGroup").setSelectedButton(e.byId("idMultiSelectionMode"))}else{e.byId("idSelectionModeRadioGroup").setSelectedButton(e.byId("idSingleSelectionMode"))}}function N(e){e.byId("idPreselectionFunction").setValue("");if(l.checkIsNotNullOrUndefinedOrBlank(v.getPreselectionFunction())){e.byId("idPreselectionFunction").setValue(v.getPreselectionFunction())}}function w(e){var t=false,i=false;if(v.getNoneSelection()){e.byId("idPreselectionModeRadioGroup").setSelectedButton(e.byId("idNoneSelection"))}else if(l.checkIsNotNullOrUndefinedOrBlank(v.getPreselectionFunction())){e.byId("idPreselectionModeRadioGroup").setSelectedButton(e.byId("idFunction"));N(e);t=true}else if(l.checkIsNotNullOrUndefinedOrBlank(v.getPreselectionDefaults())){e.byId("idPreselectionModeRadioGroup").setSelectedButton(e.byId("idFixedValue"));M(e);i=true}else if(v.getAutomaticSelection()){e.byId("idPreselectionModeRadioGroup").setSelectedButton(e.byId("idAutomaticSelection"))}k(e,t);B(e,i)}function k(e,t){e.byId("idPreselectionFunctionLabel").setVisible(t);e.byId("idPreselectionFunction").setVisible(t);if(t){R.addField("idPreselectionFunction")}else{e.byId("idPreselectionFunction").setValue("");R.removeField("idPreselectionFunction")}}function B(e,t){e.byId("idPreselectionDefaultsLabel").setVisible(t);e.byId("idPreselectionDefaults").setVisible(t);if(t){R.addField("idPreselectionDefaults")}else{R.removeField("idPreselectionDefaults")}}function M(e){e.byId("idPreselectionDefaults").setTokens([]);var t=v.getPreselectionDefaults();if(l.checkIsNotNullOrUndefinedOrBlank(t)){t.forEach(function(t){e.byId("idPreselectionDefaults").addToken(new r({text:t}))})}}function H(e){e.byId("idConfigListOfValuesMultiInput").setTokens([]);var t=v.getValueList();if(l.checkIsNotNullOrUndefinedOrBlank(t)){t.forEach(function(t){e.byId("idConfigListOfValuesMultiInput").addToken(new r({text:t}))})}}function U(e,t){e.byId("idConfigListOfValuesLabel").setVisible(t);e.byId("idConfigListOfValuesMultiInput").setVisible(t);if(t){R.addField("idConfigListOfValuesMultiInput")}else{R.removeField("idConfigListOfValuesMultiInput")}}function G(e,t){e.getView().fireEvent(V.ENABLEDISABLEFRRFIELDS);K(e,t);if(t){e.byId("idVHRVBox").insertItem(e.byId("idVHRView"))}else{e.getView().fireEvent(V.CLEARVHRFIELDSIFVALUELIST);e.byId("idVHRVBox").removeItem(e.byId("idVHRView"))}}function q(e){if(v.getUseSameRequestForValueHelpAndFilterResolution()){e.byId("idUseVHRAsFRRCheckBox").setSelected(true);e.getView().fireEvent(V.ENABLEDISABLEFRRFIELDS)}}function W(e){var t=false,i=false;if(l.checkIsNotNullOrUndefinedOrBlank(v.getServiceOfValueHelp())){t=true;e.byId("idValueHelpRadioGroup").setSelectedButton(e.byId("idValueHelpRequest"))}else if(l.checkIsNotNullOrUndefinedOrBlank(v.getValueList())){H(e);i=true;e.byId("idValueHelpRadioGroup").setSelectedButton(e.byId("idConfigListOfValues"))}else{e.byId("idValueHelpRadioGroup").setSelectedButton(e.byId("idVHNone"))}U(e,i);G(e,t)}function K(e,t){if(t===false){e.byId("idUseVHRAsFRRCheckBox").setSelected(false)}e.byId("idUseVHRAsFRRCheckBox").setVisible(t);e.byId("idUseVHRAsFRRCheckBoxLabel").setVisible(t)}function j(e,t){t.byId("idPreselectionDefaults").setValueState(b.Warning);t.byId("idPreselectionDefaults").setValueStateText(y(e));t.byId("idPreselectionDefaults").focus()}function _(e,t){var i=new r({text:e});t.addToken(i);S.setIsUnsaved()}function X(e,t){if(e.mEventRegistry.tokenChange===undefined){e.attachTokenChange(t)}}return c.extend("sap.apf.modeler.ui.controller.facetFilter",{onInit:function(){this._pOnInit=this.onInitAsync()},whenInitialized:function(){return Promise.resolve(this._pOnInit)},onInitAsync:async function(){var e=this;var t=e.getView().getViewData();y=t.getText;g=t.oParams;F=t.oConfigurationHandler;p=F.getTextPool();S=t.oConfigurationEditor;if(!S){F.loadConfiguration(g.arguments.configId,function(e){S=e})}R=new s(e.getView());P(e);C(e);await E(e);e.setDetailData();R.addFields(["idFFProperty","idLabel"])},onAfterRendering:function(){var e=this;if(e.byId("idLabel").getValue().length===0){e.byId("idLabel").focus()}X(e.byId("idConfigListOfValuesMultiInput"),e.handleTokenChangeForConfigListOfValues.bind(e));X(e.byId("idPreselectionDefaults"),e.handleTokenChangeForPreselectionDefaults.bind(e))},setDetailData:function(){var e=this;A(e);e.setFFProperty();O(e);x(e);w(e);W(e);q(e)},updateSubViewInstancesOnReset:function(e){var t=this;S=e;v=S.getFacetFilter(v.getId());t.getView().fireEvent(i.events.UPDATESUBVIEWINSTANCESONRESET,{oConfigurationEditor:S,oParentObject:v})},validateSelectedValues:function(e,t,i){var l={},n=[],o=[],s=[],r=[],u;l=d.validateSelectedValues(t,i);n=l.invalid;o=l.valid;s=a.addPrefixText(n,y);r=s.concat(i).length!==0?s.concat(i):i;u=s.concat(o).length!==0?s.concat(o):t;return{aValues:r,aSelectedValues:u}},setFFProperty:function(){var e=this;var t=[],i,a;S.getFilterablePropertiesAndParametersAsPromise().done(function(o){t=o;a=v.getProperty();if(l.checkIsNotNullOrUndefinedOrBlank(a)){i=e.validateSelectedValues(e,[a],t);t=i.aValues;a=i.aSelectedValues[0]}var s=n.convert(t);e.byId("idFFProperty").setModel(s);e.byId("idFFProperty").setSelectedKey(a)})},handleChangeForVisibilityAtRuntime:function(){var e=this,t=true;if(e.byId("idDoNotShowAtRuntimeCheckBox").getSelected()){t=false;v.setInvisible();v.setUseSameRequestForValueHelpAndFilterResolution(false);e.getView().fireEvent(V.ENABLEDISABLEFRRFIELDS);e.getView().fireEvent(V.DONOTSHOWATRUNTIME);v.setValueList([]);H(e)}else{v.setVisible()}v.setMultiSelection(true);S.setIsUnsaved();T(e);D(e,t)},handleChangeForProperty:function(){var e=this;var t=e.byId("idFFProperty").getSelectedKey().trim();t=a.removePrefixText(t,y(i.texts.NOTAVAILABLE));if(l.checkIsNotNullOrUndefinedOrBlank(t)){v.setProperty(t)}S.setIsUnsaved()},handleChangeForLabel:function(){var e=this;var t=e.byId("idLabel").getValue().trim();if(l.checkIsNotNullOrUndefinedOrBlank(t)){p.setTextAsPromise(t,h).done(function(i){v.setLabelKey(i);T(e,t);m(e,t);S.setIsUnsaved()})}else{S.setIsUnsaved()}},handleSuggestions:function(e){var t=new o.SuggestionTextHandler(p);t.manageSuggestionTexts(e,h)},handleChangeForSelectionMode:function(){var e=this,t,i;var l=e.byId("idSelectionModeRadioGroup").getSelectedButton();if(l===e.byId("idSingleSelectionMode")){v.setMultiSelection(false);if(e.byId("idPreselectionDefaultsLabel").getVisible()){t=v.getPreselectionDefaults();if(t&&t.length>1){v.setPreselectionDefaults([t[0]]);i=new r({text:t[0]});e.byId("idPreselectionDefaults").setTokens([i]);j("singleToMultipleSelectionWarningMessage",e)}}}else{e.byId("idPreselectionDefaults").setValueState(b.None);v.setMultiSelection(true)}S.setIsUnsaved()},handleChangeForPreselectionMode:function(){var e=this,t=false,i=false,l=false,n=false;switch(e.byId("idPreselectionModeRadioGroup").getSelectedButton()){case e.byId("idAutomaticSelection"):t=true;break;case e.byId("idFunction"):i=true;v.removePreselectionDefaults();break;case e.byId("idFixedValue"):l=true;v.removePreselectionFunction();break;default:n=true}v.setAutomaticSelection(t);v.setNoneSelection(n);M(e);N(e);B(e,l);k(e,i);S.setIsUnsaved()},handleChangeForPreselectionDefaults:function(e){var t=this;t.byId("idPreselectionDefaults").setValue("");t.byId("idPreselectionDefaults").setValueState(b.None);if(!v.isMultiSelection()){if(t.byId("idPreselectionDefaults").getTokens().length<1){t.byId("idPreselectionDefaults").setValueState(b.None);_(e.getParameter("value"),t.byId("idPreselectionDefaults"))}else{j("singleSelectionWarningMessage",t)}}else{_(e.getParameter("value"),t.byId("idPreselectionDefaults"))}},handleTokenChangeForPreselectionDefaults:function(e){var t=this;var i,l=[];var n=t.byId("idPreselectionDefaults").getTokens();t.byId("idPreselectionDefaults").setValueState(b.None);if(e.getParameters().type==="removed"||e.getParameters().type==="added"){for(i=0;i<n.length;i++){l[i]=n[i].getText()}if(v.isMultiSelection()){v.setPreselectionDefaults(l)}else{v.setPreselectionDefaults([l[0]])}if(e.getParameters().type==="removed"){S.setIsUnsaved()}}},handleChangeForPreselectionFunction:function(){var e=this;var t=e.byId("idPreselectionFunction").getValue().trim();v.removePreselectionFunction();if(l.checkIsNotNullOrUndefinedOrBlank(t)){v.setPreselectionFunction(t)}S.setIsUnsaved()},handleChangeForUseVHRAsFRRCheckBox:function(){var e=this;if(e.byId("idUseVHRAsFRRCheckBox").getSelected()){v.setUseSameRequestForValueHelpAndFilterResolution(true)}else{v.setUseSameRequestForValueHelpAndFilterResolution(false)}e.getView().fireEvent(V.ENABLEDISABLEFRRFIELDS);e.getView().fireEvent(V.USESAMEASVHR);S.setIsUnsaved()},handleChangeForValueHelpOption:function(){var e=this,t=false,i=false;switch(e.byId("idValueHelpRadioGroup").getSelectedButton()){case e.byId("idValueHelpRequest"):t=true;v.setValueList([]);break;case e.byId("idConfigListOfValues"):i=true;v.setAlias(undefined);break;default:v.setAlias(undefined);v.setValueList([])}if(v.getUseSameRequestForValueHelpAndFilterResolution()===true){v.setUseSameRequestForValueHelpAndFilterResolution(false);e.byId("idUseVHRAsFRRCheckBox").setSelected(false)}H(e);U(e,i);G(e,t);S.setIsUnsaved()},handleChangeForConfigListOfValues:function(e){var t=this;t.byId("idConfigListOfValuesMultiInput").setValue("");_(e.getParameter("value"),t.byId("idConfigListOfValuesMultiInput"))},handleTokenChangeForConfigListOfValues:function(e){var t=this;var i,l=[];var n=t.byId("idConfigListOfValuesMultiInput").getTokens();if(e.getParameters().type==="removed"||e.getParameters().type==="added"){for(i=0;i<n.length;i++){l[i]=n[i].getText()}v.setValueList(l);if(e.getParameters().type==="removed"){S.setIsUnsaved()}}},getValidationState:function(){var e=this;return R.getValidationState()&&e.byId("idVHRView").getController().getValidationState()&&e.byId("idFRRView").getController().getValidationState()},onExit:function(){var e=this;e.byId("idVHRView").destroy();e.byId("idFRRView").destroy()}})});
//# sourceMappingURL=facetFilter.controller.js.map