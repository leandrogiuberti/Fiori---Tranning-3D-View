sap.ui.define(["sap/apf/modeler/ui/utils/constants","sap/apf/modeler/ui/utils/sortDataHandler","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/viewValidator","sap/apf/modeler/ui/utils/stepPropertyMetadataHandler","sap/apf/modeler/ui/utils/textPoolHelper","sap/ui/core/library","sap/ui/core/mvc/Controller","sap/ui/core/mvc/View","sap/ui/core/mvc/ViewType"],function(e,t,i,a,n,r,o,d,s,l,g){"use strict";var c=d.ValueState;var p,u,I,f,S,T,v,b,y,h,m,V;var N=o.TranslationFormatMap.STEP_TITLE;var E=o.TranslationFormatMap.STEP_LONG_TITLE;function C(e){e.byId("idStepBasicData").setText(u("stepBasicData"));e.byId("idStepTitleLabel").setText(u("stepTitle"));e.byId("idStepTitle").setPlaceholder(u("newStep"));e.byId("idStepLongTitleLabel").setText(u("stepLongTitle"));e.byId("idStepLongTitle").setPlaceholder(u("stepLongTitle"));e.byId("idCategoryTitleLabel").setText(u("categoryAssignments"));e.byId("idGlobalLabel").setText(u("globalNavigationTarget"));e.byId("idStepSpecificLabel").setText(u("stepSpecificNavTargets"));e.byId("idDataRequest").setText(u("dataRequest"));e.byId("idFilterMapping").setText(u("filterMap"));e.byId("idFilterMapKeepSourceLabel").setText(u("filterMapKeepSource"));e.byId("idNavigationTarget").setText(u("navigationTargetAssignments"));e.byId("idDataReduction").setText(u("dataReduction"));e.byId("idDataReductionLabel").setText(u("dataReductionType"));e.byId("idNoDataReduction").setText(u("noDataReduction"));e.byId("idTopN").setText(u("topN"));e.byId("idNumberOfRecordsLabel").setText(u("recordNumber"));e.byId("idAriaPropertyForDataReduction").setText(u("dataReductionType"))}function w(e,t){var i=u(m?"hierarchicalStepTitle":"step")+": "+t;e.getView().getViewData().updateTitleAndBreadCrumb(i);R(e,t)}function R(e,t){var i=u(m?"hierarchicalStepTitle":"step")+": "+t;e.getView().getViewData().oTitleBreadCrumbController.byId("IdFormTitle").setText(i)}function F(e,t){var i={id:v.getId(),icon:v.getType()==="hierarchicalStep"?"sap-icon://drill-down":"sap-icon://step"};if(t){i.name=t}e.getView().getViewData().updateSelectedNode(i)}function x(e){var t,a;if(p&&p.arguments&&p.arguments.stepId){v=f.getStep(p.arguments.stepId);m=v&&v.getType()==="hierarchicalStep"?true:false}if(!i.checkIsNotUndefined(v)){a=p.arguments.categoryId;m=p.bIsHierarchicalStep;if(m){t=f.createHierarchicalStep(a)}else{t=f.createStep(a)}v=f.getStep(t);F(e)}}function O(t){var i=this;var a=t.getParameter("bShowFilterMappingLayout");i.byId("idStepFilterMappingVBox").setVisible(a);i.byId("idFilterMapKeepSourceLabel").setVisible(a);i.byId("idFilterKeepSourceCheckBox").setVisible(a);if(!a){i.byId("idFilterMapping").setText("");i.getView().fireEvent(e.events.step.RESETFILTERMAPPINGFIELDS)}else{i.byId("idFilterMapping").setText(u("filterMap"))}}function D(e){e.byId("idDataReductionForm").setVisible(!m)}async function P(e,t,i,a,n){return l.create({viewName:a,type:g.XML,id:e.createId(n),viewData:i,controller:t})}async function L(t){var i,a,n,r,o,d,l;i={oTextReader:u,oConfigurationEditor:f,oTextPool:S,oParentObject:v,oStepPropertyMetadataHandler:V,oCoreApi:t.getView().getViewData().oCoreApi};a=await s.create({name:"sap.apf.modeler.ui.controller.stepCornerTexts"});await P(t,a,i,"sap.apf.modeler.ui.view.cornerTexts","idStepCornerTextView");o=t.byId("idStepCornerTextView");t.byId("idStepCornerTextVBox").insertItem(o);i.oConfigurationHandler=I;i.getCalatogServiceUri=t.getView().getViewData().getCalatogServiceUri;if(m){n=await s.create({name:"sap.apf.modeler.ui.controller.hierarchicalStepRequest"})}else{n=await s.create({name:"sap.apf.modeler.ui.controller.stepRequest"})}await P(t,n,i,"sap.apf.modeler.ui.view.requestOptions","idStepRequestView");d=t.byId("idStepRequestView");t.byId("idStepRequestVBox").insertItem(d);r=await s.create({name:"sap.apf.modeler.ui.controller.stepFilterMapping"});await P(t,r,i,"sap.apf.modeler.ui.view.requestOptions","idStepFilterMappingView");l=t.byId("idStepFilterMappingView");t.byId("idStepFilterMappingVBox").insertItem(l);d.attachEvent(e.events.step.SETDATAREDUCTIONSECTION,t.setDataReductionSection.bind(t));d.attachEvent(e.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,O.bind(t));t.getView().attachEvent(e.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,O.bind(t));d.attachEvent(e.events.step.UPDATEFILTERMAPPINGFIELDS,l.getController().updateFilterMappingFields.bind(l.getController()));t.getView().attachEvent(e.events.step.RESETFILTERMAPPINGFIELDS,l.getController().resetFilterMappingFields.bind(l.getController()));t.getView().attachEvent(e.events.UPDATESUBVIEWINSTANCESONRESET,o.getController().updateSubViewInstancesOnReset.bind(o.getController()));t.getView().attachEvent(e.events.UPDATESUBVIEWINSTANCESONRESET,d.getController().updateSubViewInstancesOnReset.bind(d.getController()));t.getView().attachEvent(e.events.UPDATESUBVIEWINSTANCESONRESET,l.getController().updateSubViewInstancesOnReset.bind(l.getController()));d.addStyleClass("formTopPadding");d.addStyleClass("formBottomPadding");l.addStyleClass("formTopPadding");l.addStyleClass("formBottomPadding")}function M(e){if(!i.checkIsNotNullOrUndefinedOrBlank(f.getStep(p.arguments.stepId))){return}e.byId("idStepTitle").setValue(v.getId());if(i.checkIsNotNullOrUndefinedOrBlank(v.getTitleId())&&S.get(v.getTitleId())){e.byId("idStepTitle").setValue(S.get(v.getTitleId()).TextElementDescription)}}function B(e){if(!i.checkIsNotNullOrUndefinedOrBlank(f.getStep(p.arguments.stepId))){return}e.byId("idStepLongTitle").setValue("");if(i.checkIsNotNullOrUndefinedOrBlank(v.getLongTitleId())&&S.get(v.getLongTitleId())){e.byId("idStepLongTitle").setValue(S.get(v.getLongTitleId()).TextElementDescription)}}function U(e){var t=[];var n=f.getCategories();n.forEach(function(e){var i={};i.CategoryId=e.getId();i.CategoryTitle=S.get(e.labelKey)?S.get(e.labelKey).TextElementDescription:e.labelKey;t.push(i)});var r=a.prepareModel(t,t.length);e.byId("idCategorySelect").setModel(r);var o=f.getCategoriesForStep(v.getId());if(i.checkIsNotNullOrUndefinedOrBlank(o)){e.byId("idCategorySelect").setSelectedKeys(o)}}function A(e){e.byId("idNumberOfRecordsValue").setValue("");e.byId("idNumberOfRecordsValue").setValueState("None");if(v.getTopN()){e.byId("idNumberOfRecordsValue").setValue(v.getTopN().top)}K(e)}function k(e){e.byId("idDataReductionRadioGroup").setSelectedButton(e.byId("idNoDataReduction"));q(e);if(v.getTopN()){e.byId("idDataReductionRadioGroup").setSelectedButton(e.byId("idTopN"))}}function K(e){var t=e.byId("idDataReductionRadioGroup").getSelectedButton()===e.byId("idTopN")?true:false;e.byId("idNumberOfRecordsLabel").setVisible(t);e.byId("idNumberOfRecordsValue").setVisible(t);if(t){b.addField("idNumberOfRecordsValue")}else{b.removeField("idNumberOfRecordsValue")}}function G(t){if(v.getTopN()){y.instantiateStepSortData();if(v.getTopN().orderby.length===0){t.getView().fireEvent(e.events.step.SETTOPNPROPERTIES);var i=h.createMessageObject({code:"11523"});h.putMessage(i)}}else{y.destroySortData()}}function q(e){var t=v.getSelectProperties().length!==0?true:false;e.byId("idDataReductionRadioGroup").setEnabled(t)}function H(t){var i=v.getFilterProperties().length!==0?true:false;t.getView().fireEvent(e.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,{bShowFilterMappingLayout:i})}function _(e){if(i.checkIsNotNullOrUndefinedOrBlank(v.getFilterMappingKeepSource())){e.byId("idFilterKeepSourceCheckBox").setSelected(v.getFilterMappingKeepSource())}}function j(e,t,i,n){var r=[];if(t.length!==0){i.setBusy(true)}t.forEach(function(e){var o={};o.navTargetKey=e.getId();T(e.getId()).then(function(e){o.navTargetName=e;r.push(o);if(r.length===t.length){var d=a.prepareModel(r,r.length);i.setModel(d);i.setSelectedKeys(n);i.setBusy(false)}})})}function W(e){var t=f.getNavigationTargets();var i=v.getNavigationTargets();var a=t.filter(function(e){return e.isStepSpecific()});j(e,a,e.byId("idStepSpecificCombo"),i)}function Y(e){var t=f.getNavigationTargets();var i=t.filter(function(e){return e.isGlobal()});var a=i.map(function(e){return e.getId()});j(e,i,e.byId("idGlobalCombo"),a)}return s.extend("sap.apf.modeler.ui.controller.step",{onInit:function(){this._pOnInit=this.onInitAsync()},whenInitialized:function(){return Promise.resolve(this._pOnInit)},onInitAsync:async function(){var e=this,i;var a=e.getView().getViewData();h=a.oCoreApi;u=h.getText;p=a.oParams;I=a.oConfigurationHandler;S=I.getTextPool();f=a.oConfigurationEditor;T=a.getNavigationTargetName;b=new n(e.getView());C(e);x(e);V=new(a.StepPropertyMetadataHandler||r)(h,v);y=new t(e.getView(),v,V,u);await L(e);e.setDetailData();i=e.byId("idStepTitle").getValue().trim();if(i===""){i="< "+u("newStep")+" >"}R(e,i);b.addFields(["idStepTitle","idCategorySelect"])},setDetailData:function(){var e=this;M(e);B(e);U(e);e.setDataReductionSection();D(e);H(e);_(e);W(e);Y(e)},onAfterRendering:function(){var e=this;if(e.byId("idStepTitle").getValue().length===0){e.byId("idStepTitle").focus()}},updateSubViewInstancesOnReset:function(t){var i=this;f=t;v=f.getStep(v.getId());i.getView().fireEvent(e.events.UPDATESUBVIEWINSTANCESONRESET,{oConfigurationEditor:f,oParentObject:v})},setDataReductionSection:function(){var e=this;k(e);A(e);G(e)},handleChangeForStepTitle:function(){var e=this;var t=f.getCategoriesForStep(v.getId());var a=e.byId("idStepTitle").getValue().trim();if(i.checkIsNotNullOrUndefinedOrBlank(a)){S.setTextAsPromise(a,N).done(function(i){v.setTitleId(i);if(t.length>1){e.getView().getViewData().updateTree()}else{F(e,a)}w(e,a);f.setIsUnsaved()})}else{f.setIsUnsaved()}},handleSuggestionsForStepTitle:function(e){var t=new o.SuggestionTextHandler(S);t.manageSuggestionTexts(e,N)},handleChangeForStepLongTitle:function(){var e=this;var t=e.byId("idStepLongTitle").getValue().trim();if(i.checkIsNotNullOrUndefined(t)){S.setTextAsPromise(t,E).done(function(e){v.setLongTitleId(e);f.setIsUnsaved()})}else{f.setIsUnsaved()}},handleSuggestionsForStepLongTitle:function(e){var t=new o.SuggestionTextHandler(S);t.manageSuggestionTexts(e,E)},handleChangeForCategory:function(){var e=this;var t=v.getId();var i=p.arguments.categoryId;var a=f.getCategoriesForStep(v.getId());var n=e.byId("idCategorySelect").getSelectedKeys();var r=n.indexOf(i);var o=[];var d=[];var s,l;for(s=0;s<a.length;s++){var g=false;for(l=0;l<n.length;l++){if(a[s]===n[l]){g=true;break}}if(!g){d.push(a[s])}}if(n.length!==0){n.forEach(function(e){f.addCategoryStepAssignment(e,t);var a={oldContext:{name:p.name,arguments:{configId:p.arguments.configId,categoryId:i,stepId:t}},newContext:{arguments:{configId:p.arguments.configId,categoryId:e}}};if(e!==i){o.push(a)}});a.forEach(function(e){if(n.indexOf(e)===-1){f.removeCategoryStepAssignment(e,v.getId())}});if(d.length!==0){d.forEach(function(e){var a={oldContext:{name:p.name,arguments:{configId:p.arguments.configId,categoryId:i,stepId:t}},newContext:{arguments:{configId:p.arguments.configId,categoryId:e}},removeStep:true};if(r===-1&&e===i){var d={arguments:{appId:p.arguments.appId,configId:p.arguments.configId,categoryId:n[0],stepId:t}};a.categoryChangeContext=d;a.changeCategory=true}o.push(a)})}}if(o.length!==0){e.getView().getViewData().updateTree(o)}f.setIsUnsaved()},handleChangeForDataReductionType:function(){var e=this;if(e.byId("idDataReductionRadioGroup").getSelectedButton()===e.byId("idNoDataReduction")){v.resetTopN();e.setDataReductionSection()}else{y.instantiateStepSortData()}K(e);f.setIsUnsaved()},handleValidationForNumberOfRecords:function(e){var t=e.getSource();var i=t.getValue().trim();var a=i.indexOf("E")!==-1||i.indexOf("e")!==-1||i.indexOf(".")!==-1||i<=0||i>1e4?c.Error:c.None;t.setValueState(a);f.setIsUnsaved()},handleChangeForNoOfRecords:function(t){var a=this;var n=t.getSource().getValue().trim();if(t.getSource().getValueState()===c.Error){return}if(i.checkIsNotNullOrUndefinedOrBlank(n)){if(v.getTopN()===undefined){a.getView().fireEvent(e.events.step.SETTOPNPROPERTIES)}v.setTopNValue(n)}f.setIsUnsaved()},handleFilterMapKeepSource:function(){var e=this;var t=e.byId("idFilterKeepSourceCheckBox").getSelected();v.setFilterMappingKeepSource(t);f.setIsUnsaved()},handleChangeForStepSpecificNavTargets:function(){var e=this;var t=e.byId("idStepSpecificCombo").getSelectedKeys();var i=v.getNavigationTargets();i.forEach(function(e){if(t.indexOf(e)===-1){v.removeNavigationTarget(e)}});t.forEach(function(e){if(i.indexOf(e)===-1){v.addNavigationTarget(e)}});f.setIsUnsaved()},getValidationState:function(){var e=this;return b.getValidationState()&&e.byId("idStepRequestView").getController().getValidationState()&&e.byId("idStepFilterMappingView").getController().getValidationState()},onExit:function(){var e=this;e.byId("idStepCornerTextView").destroy();e.byId("idStepRequestView").destroy();e.byId("idStepFilterMappingView").destroy()}})});
//# sourceMappingURL=step.controller.js.map