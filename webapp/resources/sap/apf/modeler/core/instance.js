/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/utils/hashtable","sap/apf/utils/utils","sap/apf/core/constants","sap/apf/core/layeredRepositoryProxy","sap/apf/core/messageHandler","sap/apf/core/sessionHandler","sap/apf/core/representationTypes","sap/apf/core/entityTypeMetadata","sap/apf/core/configurationFactory","sap/apf/core/utils/checkForTimeout","sap/apf/core/utils/filter","sap/apf/core/utils/uriGenerator","sap/apf/core/metadata","sap/apf/core/metadataFacade","sap/apf/core/metadataProperty","sap/apf/core/messageDefinition","sap/apf/core/metadataFactory","sap/apf/core/odataProxy","sap/apf/cloudFoundry/modelerProxy","sap/apf/cloudFoundry/ajaxHandler","sap/apf/utils/proxyTextHandlerForLocalTexts","sap/apf/core/ajax","sap/apf/core/odataRequest","sap/apf/modeler/core/messageDefinition","sap/apf/modeler/core/textHandler","sap/apf/modeler/core/textPool","sap/apf/modeler/core/applicationHandler","sap/apf/modeler/core/configurationHandler","sap/apf/modeler/core/configurationEditor","sap/apf/modeler/core/step","sap/apf/modeler/core/hierarchicalStep","sap/apf/modeler/core/smartFilterBar","sap/apf/modeler/core/facetFilter","sap/apf/modeler/core/navigationTarget","sap/apf/modeler/core/elementContainer","sap/apf/modeler/core/representation","sap/apf/modeler/core/configurationObjects","sap/apf/utils/parseTextPropertyFile","sap/apf/modeler/core/lazyLoader","sap/apf/modeler/core/registryWrapper","sap/apf/utils/exportToGlobal","sap/apf/utils/startParameter","sap/apf/core/utils/fileExists","sap/apf/core/utils/annotationHandler","sap/base/util/deepExtend","sap/ui/thirdparty/datajs","sap/ui/thirdparty/jquery"],function(e,t,n,a,r,o,i,s,c,u,f,l,d,p,g,m,y,v,h,C,x,A,H,T,F,S,b,j,M,P,O,E,L,w,R,N,U,I,D,q,G,V,k,B,z,K,jQuery){"use strict";function W(G,W){var J=this;var X,$,_,Q,Y,Z,ee,te,ne,ae,re,oe,ie,se,ce,ue,fe,le,de,pe,ge,me,ye,ve,he,Ce,xe,Ae,He,Te,Fe,Se,be,je,Me,Pe,Oe,Ee,Le,we,Re,Ne;var Ue=[];var Ie;var De;X=W&&W.constructors&&W.constructors.ApplicationHandler||b;_=W&&W.constructors&&W.constructors.ConfigurationHandler||j;Q=W&&W.constructors&&W.constructors.ConfigurationEditor||M;Y=W&&W.constructors&&W.constructors.ConfigurationObjects||U;Z=W&&W.constructors&&W.constructors.ConfigurationFactory||c;ie=W&&W.constructors&&W.constructors.ElementContainer||R;ee=W&&W.constructors&&W.constructors.Step||P;te=W&&W.constructors&&W.constructors.HierarchicalStep||O;ne=W&&W.constructors&&W.constructors.SmartFilterBar||E;ae=W&&W.constructors&&W.constructors.FacetFilter||L;re=W&&W.constructors&&W.constructors.NavigationTarget||w;oe=W&&W.constructors&&W.constructors.Representation||N;ce=W&&W.constructors&&W.constructors.Hashtable||e;ue=W&&W.constructors&&W.constructors.RegistryProbe||q;me=W&&W.constructors&&W.constructors.LazyLoader||D;fe=W&&W.constructors&&W.constructors.Metadata||d;le=W&&W.constructors&&W.constructors.EntityTypeMetadata||s;de=W&&W.constructors&&W.constructors.MetadataFacade||p;pe=W&&W.constructors&&W.constructors.MetadataProperty||g.constructor;ge=W&&W.constructors&&W.constructors.MetadataFactory||y;ye=W&&W.constructors&&W.constructors.StartParameter||V;ve=W&&W.constructors&&W.constructors.AnnotationHandler||B.constructor;se=W&&W.constructors&&W.constructors.FileExists||k;he=W&&W.constructors&&W.constructors.ProxyTextHandlerForLocalTexts||x;$=W&&W.constructors&&W.constructors.AjaxHandler||C;De=W&&W.instances&&W.instances.datajs||K;if(W&&W.constructors&&W.constructors.TextHandler){Ce=new W.constructors.TextHandler}else{Ce=new F}if(W&&W.constructors&&W.constructors.MessageHandler){xe=new W.constructors.MessageHandler(true)}else{xe=new r(true)}xe.activateOnErrorHandling(true);xe.loadConfig(m);xe.loadConfig(T);xe.setTextResourceHandler(Ce);if(W&&W.instances&&W.instances.component){Ne={};Ne.baseManifest=Object.getPrototypeOf(W.instances.component).getMetadata()._getManifest();Ne.manifest=z({},W.instances.component.getManifest())}He=new ye(W&&W.instances&&W.instances.component,Ne);this.getStartParameterFacade=function(){return He};this.ajax=function(e){var t=z({},e);t.functions=t.functions||{};t.functions.getSapSystem=He.getSapSystem;if(W&&W.functions&&W.functions.ajax){t.functions.ajax=W.functions.ajax}t.instances={messageHandler:xe};return A(t)};var qe=new he({instances:{messageHandler:xe}});Se={manifests:Ne,instances:{messageHandler:xe,coreApi:this,proxyTextHandlerForLocalTexts:qe}};var Ge=W&&W.functions&&W.functions.isUsingCloudFoundryProxy&&W.functions.isUsingCloudFoundryProxy();if(Ge){je={instances:{messageHandler:xe},functions:{coreAjax:this.ajax}};Se.instances.ajaxHandler=new $(je)}if(W&&W.constructors&&W.constructors.PersistenceProxy){Te=new W.constructors.PersistenceProxy(G,Se)}else{if(Ge){Te=new h.ModelerProxy(G,Se)}else if(Ne&&Ne.manifest["sap.apf"]&&Ne.manifest["sap.apf"].activateLrep){Te=new(W&&W.constructors&&W.constructors.LayeredRepositoryProxy||a)(G,Se)}else{Te=new(W&&W.constructors&&W.constructors.OdataProxy||v)(G,Se)}}if(W&&W.constructors&&W.constructors.SessionHandler){Ae=new W.constructors.SessionHandler(Se)}else{Ae=new o(Se)}var Ve={functions:{getSapSystem:He.getSapSystem,getComponentNameFromManifest:t.getComponentNameFromManifest,getODataPath:l.getODataPath,getBaseURLOfComponent:l.getBaseURLOfComponent,addRelativeToAbsoluteURL:l.addRelativeToAbsoluteURL},instances:{fileExists:new se({functions:{ajax:this.ajax,getSapSystem:He.getSapSystem}})}};var ke=new ve(Ve);be={constructors:{EntityTypeMetadata:le,Hashtable:ce,Metadata:fe,MetadataFacade:de,MetadataProperty:pe},functions:{getServiceDocuments:function(){return[G.serviceRoot]},getSapSystem:He.getSapSystem},instances:{messageHandler:xe,coreApi:J,annotationHandler:ke},deactivateFatalError:true};Fe=new ge(be);Me={constructors:{Hashtable:ce},instances:{messageHandler:xe}};this.getCatalogServiceUri=W&&W.functions&&W.functions.getCatalogServiceUri;Pe=W&&W.functions&&W.functions.odataRequestWrapper||H;this.odataRequest=function(e,t,n,a){var r={instances:{datajs:De},functions:{getSapSystem:He.getSapSystem}};Pe(r,e,t,n,a)};this.checkForTimeout=function(e){var t=u(e);if(t){xe.putMessage(t)}return t};this.getEntityTypeMetadataAsPromise=function(e,t){return Fe.getEntityTypeMetadata(e,t)};this.getEntityTypeMetadata=this.getEntityTypeMetadataAsPromise;this.getXsrfToken=function(e){return Ae.getXsrfToken(e)};this.getUriGenerator=function(){return l};this.getText=function(e,t){return Ce.getText(e,t)};this.putMessage=function(e){return xe.putMessage(e)};this.check=function(e,t,n){return xe.check(e,t,n)};this.createMessageObject=function(e){return xe.createMessageObject(e)};this.setCallbackForMessageHandling=function(e){xe.setMessageCallback(e)};this.isUsingCloudFoundryProxy=function(){return Ge||false};this.isVendorContentAvailable=function(){if(He.isLrepActive()||Ge&&this.getGenericExit("hasVendorContent")&&this.getGenericExit("hasVendorContent")()){return true}return false};this.importConfigurationFromVendorLayer=function(e,t,n,a){if(Ge){this.getApplicationHandler(function(r,o){if(o){a(undefined,undefined,o);return}Te.importVendorContent(e,t,n,a,r.registerApplicationCreatedOnServer)})}else{Be(e,t,n,a)}};function Be(e,t,a,r){var o;Te.readAllConfigurationsFromVendorLayer().then(function(n){var a=e+"."+t;var r;for(r=0;r<n.length;r++){if(n[r].value===a){o=n[r].applicationText;break}}J.getApplicationHandler(i)});function i(t,n){if(n){r(undefined,undefined,n);return}var a=false;var i=t.getApplication(e);if(!i){a=true}var c={ApplicationName:o};t.setAndSave(c,s,e,a)}function s(e,n,a){if(a){r(t,undefined,a);return}c()}function c(){var t=new f(xe,"Language","eq",n.developmentLanguage);var a=new f(xe,"Application","eq",e);a.addAnd(t);Te.readCollection("texts",u,undefined,undefined,a,{layer:"VENDOR"})}function u(n,a,o){if(o){r(t,undefined,o);return}ze(n,e,l)}function l(n){if(n){r(t,undefined,n);return}Te.readEntity("configuration",d,[{value:t}],undefined,e,{layer:"VENDOR"})}function d(e,t,n){if(n){r(undefined,t,n);return}var o=JSON.parse(e.SerializedAnalyticalConfiguration);Ke(o,a,r)}}function ze(e,t,a){J.getApplicationHandler(o);function r(n,r,o){var i;var s;if(o){a(o)}else{i={instances:{messageHandler:xe,persistenceProxy:Te},constructors:{Hashtable:ce},isUsingCloudFoundryProxy:Ge};s=new S(i,t,n);s.addTextsAndSave(e,a,t)}}function o(o,i){if(i){a(i);return}var s;var c=o.getApplication(t);if(!c){s=xe.createMessageObject({code:11021});a(s);return}if(Le&&Le.getId()===t){Le.getInstance().getTextPool().addTextsAndSave(e,a,t)}else{var u=new f(xe,"Application","eq",t);var l=new f(xe,"Language","eq",n.developmentLanguage);l.addAnd(u);Te.readCollection("texts",r,undefined,undefined,l)}}}this.importTexts=function(e,t){var n;var a;var r;var o=I(e,{instances:{messageHandler:xe}});if(o.Messages.length>0){n=xe.createMessageObject({code:11020});a=o.Messages.length;for(r=0;r<a-1;r++){o.Messages[r+1].setPrevious(o.Messages[r])}n.setPrevious(o.Messages[a-1]);t(n)}else{ze(o.TextElements,o.Application,t)}};function Ke(e,t,n){var a=e.configHeader;J.getApplicationHandler(r);function r(e,t){if(t){n(undefined,undefined,t);return}var r=false;var s=e.getList();s.forEach(function(e){if(e.Application===a.Application){r=true}});if(r){J.getConfigurationHandler(a.Application,i)}else{var c={ApplicationName:a.ApplicationName,SemanticObject:a.SemanticObject};e.setAndSave(c,o,a.Application,true)}}function o(e,t,r){if(r){n(undefined,undefined,r);return}J.getConfigurationHandler(a.Application,i)}function i(r,o){if(o){n(undefined,undefined,o);return}var i=jQuery.extend({},e,true);delete i.configHeader;var c=false;var u=r.getList();u.forEach(function(e){if(e.AnalyticalConfiguration===a.AnalyticalConfiguration){c=true}});if(c){t(l,d,a.AnalyticalConfigurationName)}else{r.setConfiguration({AnalyticalConfigurationName:a.AnalyticalConfigurationName},a.AnalyticalConfiguration);var f={id:a.AnalyticalConfiguration,creationDate:a.CreationUTCDateTime,lastChangeDate:a.LastChangeUTCDateTime,content:i};r.loadConfiguration(f,s)}function l(){r.setConfiguration({AnalyticalConfigurationName:a.AnalyticalConfigurationName},a.AnalyticalConfiguration);var e={updateExisting:true,id:a.AnalyticalConfiguration,creationDate:a.CreationUTCDateTime,lastChangeDate:a.LastChangeUTCDateTime,content:i};r.loadConfiguration(e,s)}function d(e){if(e&&e!==""){a.AnalyticalConfigurationName=e}var t=r.setConfiguration({AnalyticalConfigurationName:a.AnalyticalConfigurationName});var n={id:t,content:i};r.loadConfiguration(n,s)}}function s(e,t){if(t){n(undefined,undefined,t);return}e.save(n)}}this.importConfiguration=function(e,n,a){var r=JSON.parse(e);if(!o(r,a)){return}Ke(r,n,a);function o(n,a){var r=[],o=true,i;if(!t.isValidGuid(n.configHeader.Application)){r.push(xe.createMessageObject({code:11037,aParameters:[n.configHeader.Application]}));o=false}if(!t.isValidGuid(n.configHeader.AnalyticalConfiguration)){r.push(xe.createMessageObject({code:11038,aParameters:[n.configHeader.AnalyticalConfiguration]}));o=false}i=U.getTextKeysFromConfiguration(n);i.forEach(function(e){var n=new ce(xe);if(!n.hasItem(e)){n.setItem(e,e);if(!t.isValidGuid(e)){r.push(xe.createMessageObject({code:11039,aParameters:[e]}));o=false}}});if(o){return o}r.forEach(function(e,t,n){if(t){e.setPrevious(n[t-1])}});a(e,undefined,r[r.length-1]);return o}};this.getApplicationHandler=function(e){if(!Ee){var t=W&&W.functions&&W.functions.loadApplicationHandler||n;Ee=new me(Me,t)}Ee.asyncGetInstance("ApplicationHandlerId",e);function n(e,t){new X({instances:{messageHandler:xe,persistenceProxy:Te},constructors:{Hashtable:ce},functions:{resetConfigurationHandler:a}},n);function n(n,a){t(e,n,a)}function a(e){if(Le&&Le.getId()===e){Le.getInstance().removeAllConfigurations();Le.reset()}}}};this.getConfigurationHandler=function(e,t){if(!Le){Oe=W&&W.functions&&W.functions.loadConfigurationHandler||a;Le=new me(Me,Oe)}Le.asyncGetInstance(e,t);function a(e,t,a){var r=new f(xe,"Application","eq",e);var o=new f(xe,"Language","eq",n.developmentLanguage);o.addAnd(r);var i=[];var s=["AnalyticalConfiguration","AnalyticalConfigurationName","Application","CreatedByUser","CreationUTCDateTime","LastChangeUTCDateTime","LastChangedByUser"];i.push({entitySetName:"configuration",filter:r,selectList:s});i.push({entitySetName:"texts",filter:o});Te.readCollectionsInBatch(i,c);function c(n,r){var o,i;var s;var c;var u=a;if(r){t(e,undefined,r)}else{s=n[0];c=n[1];i={instances:{messageHandler:xe,persistenceProxy:Te},constructors:{Hashtable:ce},isUsingCloudFoundryProxy:Ge};o=new S(i,e,c);if(!u){u=new _({instances:{messageHandler:xe,persistenceProxy:Te,coreApi:J,metadataFactory:Fe},constructors:{ConfigurationEditor:Q,ConfigurationFactory:Z,ConfigurationObjects:Y,ElementContainer:ie,EntityTypeMetadata:le,SmartFilterBar:ne,FacetFilter:ae,NavigationTarget:re,Hashtable:ce,Representation:oe,RegistryProbe:ue,Step:ee,HierarchicalStep:te,LazyLoader:me},functions:{getApplication:Ee.getInstance().getApplication}})}u.setApplicationIdAndContext(e,s,o);t(e,u,r)}}}};this.getUnusedTextKeys=function(e,t){var n={instances:{messageHandler:xe,persistenceProxy:Te},constructors:{Hashtable:ce}};var a=new Y(n);var r=null,o=null,i=null;a.getTextKeysFromAllConfigurations(e,function(e,t){if(o){return}r=e;o=t;if(t||i){s()}});this.getConfigurationHandler(e,function(e,t){if(o){return}i=e;o=t;if(t||r){s()}});function s(){var e=[];if(o){t(undefined,o);return}i.getTextPool().getTextKeys().forEach(function(t){if(!r.hasItem(t)){e.push(t)}});t(e,undefined)}};this.resetConfigurationHandler=function(){if(Le){Le.reset()}};this.getRepresentationTypes=function(){var e=i();var t=[];z(t,e);return t};this.getAllAvailableSemanticObjects=function(e){if(Re){e(Re,Ie);return}if(Ie){e([],Ie);return}Ue.push(e);if(Ue.length===1){var t={requestUri:"/sap/opu/odata/UI2/INTEROP/SemanticObjects?$format=json&$select=id,text",method:"GET",isSemanticObjectRequest:true};J.odataRequest(t,n,a)}function n(e,t){Re=e.results;Ue.forEach(function(t){t(e.results,undefined)})}function a(e){var t;if(e&&e.messageObject){t=e.messageObject}else{xe.createMessageObject({code:"11041"});Re=[]}Ie=t;Ue.forEach(function(e){e([],t)})}};this.getSemanticActions=function(e){var t;var n=jQuery.Deferred();if(!we){we=new ce(xe)}t=we.getItem(e);if(t){n.resolve(t);return n.promise()}J.getAllAvailableSemanticObjects(a);return n.promise();function a(t,a){if(a){n.reject(a);return}var r=sap.ui.require("sap/ushell/Container")?.getService("CrossApplicationNavigation");var o={id:e,text:""};var i;for(i=0;i<t.length;i++){if(t[i].id===e){o=t[i];break}}if(!r){xe.createMessageObject({code:"5038"});var s={semanticObject:o,semanticActions:[]};we.setItem(e,s);n.resolve(s)}else{r.getLinks({semanticObject:o.id,ignoreFormFactor:true,ui5Component:W.instances.component}).done(function(t){var a=[];t.forEach(function(e){var t=e.intent.split("-");var n=t[1].split("?");n=n[0].split("~");a.push({id:n[0],text:e.text})});var r={semanticObject:o,semanticActions:a};we.setItem(e,r);n.resolve(r)}).fail(function(){n.reject(xe.createMessageObject({code:"11042"}))})}}};this.navigateToGenericRuntime=function(e,t,n){var a;if(W&&W.exits&&W.exits.getRuntimeUrl&&typeof W.exits.getRuntimeUrl==="function"){a=W.exits.getRuntimeUrl(e,t)}else{var r=sap.ui.require("sap/ushell/Container")?.getService("CrossApplicationNavigation");var o={};if(J.getStartParameterFacade().isLrepActive()){o["sap-apf-configuration-id"]=e+"."+t}else{o["sap-apf-configuration-id"]=t}var i=r.hrefForExternal({target:W.functions.getNavigationTargetForGenericRuntime(),params:o});var s=jQuery(window.location).attr("href");var c=s.split("#")[0];a=c+i}n(a)};this.readAllConfigurationsFromVendorLayer=function(){return Te.readAllConfigurationsFromVendorLayer()};this.showSemanticObject=function(){if(He.isLrepActive()||Ge){return false}return true};this.getGenericExit=function(e){if(W&&W.exits&&W.exits[e]&&typeof W.exits[e]==="function"){return W.exits[e]}return undefined};this.getComponent=function(){return W&&W.instances&&W.instances.component};if(W&&W.probe&&typeof W.probe==="function"){W.probe({constructors:{ApplicationHandler:X,ConfigurationHandler:_,ConfigurationEditor:Q,ConfigurationObjects:Y,ConfigurationFactory:Z,MetadataFactory:ge,Metadata:fe,EntityTypeMetadata:le,MetadataFacade:de,MetadataProperty:pe,Step:ee,HierarchicalStep:te,SmartFilterBar:ne,FacetFilter:ae,NavigationTarget:re,Representation:oe,ElementContainer:ie,Hashtable:ce,LazyLoader:me,AnnotationHandler:ve,ProxyTextHandlerForLocalTexts:he,RegistryProbe:ue},textHandler:Ce,messageHandler:xe,sessionHandler:Ae,persistenceProxy:Te,metadataFactory:Fe,injectForFollowUp:Se,injectMetadataFactory:be,fnOdataRequestWrapper:Pe,proxyTextHandlerForLocalTexts:qe,ajax:this.ajax,odataRequestWrapper:Pe,annotationHandler:ke})}}G("sap.apf.modeler.core.Instance",W);return W});
//# sourceMappingURL=instance.js.map