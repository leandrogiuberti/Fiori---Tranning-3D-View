/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/modeler/core/configurationObjects","sap/apf/utils/exportToGlobal","sap/apf/utils/utils","sap/ui/thirdparty/jquery"],function(e,t,r,jQuery){"use strict";function n(t,i,a,o){var s=this;var f;var l;var c=i.instances.configurationHandler;var u=i.instances.persistenceProxy;var g=i.instances.messageHandler;var v=i.instances.metadataFactory;var d=true;var m,h,p,y,E,C;var S;var A=new i.constructors.ConfigurationObjects(i);var F=new i.constructors.ConfigurationFactory({instances:{messageHandler:g},constructors:{RegistryProbe:i.constructors.RegistryProbe}});if(!o){m=new i.constructors.ElementContainer("Step",i.constructors.Step,i);h=new i.constructors.ElementContainer("Category",undefined,i);p=new i.constructors.ElementContainer("FacetFilter",i.constructors.FacetFilter,i);y=new i.constructors.ElementContainer("NavigationTarget",i.constructors.NavigationTarget,i);E=new i.constructors.ElementContainer("CategoryStepAssignment",i.constructors.ElementContainer,i);C=[];f={smartFilterBar:true}}else{m=o.stepContainer;h=o.categoryContainer;S=o.smartFilterBar;p=o.facetFilterContainer;y=o.navigationTargetContainer;E=o.categoryStepAssignmentContainer;C=o.serviceList;l=o.applicationTitle;f=o.filterOption}this.registerServiceAsPromise=function(e){var t=jQuery.Deferred();var r;if(C.indexOf(e)===-1){r=v.getMetadata(e);r.done(function(){if(C.indexOf(e)===-1){C.push(e)}t.resolve(true)});r.fail(function(){t.resolve(false)})}else{t.resolve(true)}return t.promise()};this.getAllServices=function(){return C};this.getAllEntitySetsOfServiceAsPromise=function(e){return v.getEntitySets(e)};this.getAllHierarchicalEntitySetsOfServiceAsPromise=function(e){var t=jQuery.Deferred();v.getMetadata(e).done(function(e){if(e){t.resolve(e.getHierarchicalEntitySets())}t.resolve([])}).fail(function(){t.resolve([])});return t.promise()};this.checkIfHierarchicalEntitySetIsAvailableAsPromise=function(e){var t=jQuery.Deferred();this.getAllHierarchicalEntitySetsOfServiceAsPromise(e).done(function(e){if(e.length>0){t.resolve(true)}else{t.resolve(false)}});return t};this.getHierarchicalPropertiesOfEntitySetAsPromise=function(e,t){var r=jQuery.Deferred();v.getMetadata(e).done(function(e){if(e){r.resolve(e.getHierarchicalPropertiesOfEntitySet(t))}else{r.resolve([])}}).fail(function(){r.resolve([])});return r};this.getHierarchyNodeIdAsPromise=function(e,t,r){var n;var i=jQuery.Deferred();v.getMetadata(e).done(function(e){if(e){n=e.getHierarchyAnnotationsForProperty(t,r);if(n&&n.hierarchyNodeFor){i.resolve(n.hierarchyNodeFor)}else{i.resolve(null)}}else{i.resolve(null)}}).fail(function(){i.resolve(null)});return i};this.getNonHierarchicalPropertiesOfEntitySet=function(e,t){var r;var n=jQuery.Deferred();v.getMetadata(e).then(function(e){r=e.getNonHierarchicalPropertiesOfEntitySet(t);n.resolve(r)},function(){n.resolve([])});return n};this.getAllEntitySetsExceptParameterEntitySets=function(e){return v.getAllEntitySetsExceptParameterEntitySets(e)};this.getAllEntitySetsOfServiceWithGivenPropertiesAsPromise=function(e,t){var r=[];var n=jQuery.Deferred();this.getAllEntitySetsOfServiceAsPromise(e).done(function(i){if(!t||t.length===0){n.resolve(i);return}v.getMetadata(e).done(function(e){i.forEach(function(n){var i=e.getFilterableProperties(n);var a=true;for(var o=0;o<t.length;o++){if(i.indexOf(t[o])<=-1){a=false;break}}if(a){r.push(n)}});n.resolve(r)})});return n.promise()};this.getAllPropertiesOfEntitySetAsPromise=function(e,t){var r=jQuery.Deferred();v.getMetadata(e).done(function(e){r.resolve(e.getAllPropertiesOfEntitySet(t))}).fail(function(){r.resolve([])});return r.promise()};this.getAllKnownPropertiesAsPromise=function(){var e=jQuery.Deferred();var t=[];var n=C.length;C.forEach(function(i){v.getMetadata(i).done(function(i){t=t.concat(i.getAllProperties());n--;if(n===0){t=r.eliminateDuplicatesInArray(g,t);e.resolve(t)}})});return e.promise()};this.getFilterablePropertiesAndParametersAsPromise=function(){var e=jQuery.Deferred();var t=[];var n=C.length;C.forEach(function(i){v.getMetadata(i).done(function(i){t=t.concat(i.getFilterablePropertiesAndParameters());if(--n===0){e.resolve(r.eliminateDuplicatesInArray(g,t))}})});if(n===0){e.resolve([])}return e.promise()};this.setApplicationTitle=function(e){d=false;l=e};this.getApplicationTitle=function(){return l};this.getConfigurationName=function(){return c.getConfiguration(t.id||t).AnalyticalConfigurationName};this.getCategoryStepAssignments=function(e){var t=[];if(!this.getCategory(e)){return false}var r=E.getElement(e);if(r){r.getElements().forEach(function(e){t.push(e.stepId)})}return t};this.addCategoryStepAssignment=function(e,t){if(!this.getCategory(e)||!this.getStep(t)){return false}var r=E.getElement(e);if(!r){E.createElementWithProposedId({},e);r=E.getElement(e)}if(!r.getElement(t)){r.createElementWithProposedId({stepId:t},t);return true}return false};this.removeCategoryStepAssignment=function(e,t){var r;if(!t){var n=this.getCategoryStepAssignments(e);r=E.removeElement(e);if(r){T(n)}return!!r}var i=E.getElement(e);if(!i){return false}r=i.removeElement(t);if(i.getElements().length===0){E.removeElement(e)}if(r){T([t])}return!!r};function T(e){if(!e){return}e.forEach(function(e){if(s.getCategoriesForStep(e).length===0){m.removeElement(e)}})}this.moveCategoryStepAssignmentBefore=function(e,t,r){var n=E.getElement(e);if(!n){return null}return n.moveBefore(t,r)};this.moveCategoryStepAssignmentToEnd=function(e,t){var r=E.getElement(e);if(!r){return null}return r.moveToEnd(t)};this.moveCategoryStepAssignmentUpOrDown=function(e,t,r){var n=E.getElement(e);if(!n){return null}return n.moveUpOrDown(t,r)};this.getCategory=h.getElement;this.setCategory=function(e,t){d=false;return h.setElement(e,t)};this.createCategoryWithId=function(e,t){d=false;return h.createElementWithProposedId(e,t).getId()};this.removeCategory=function(e){var t=s.getCategoryStepAssignments(e);if(t){t.forEach(function(e){var t=s.getCategoriesForStep(e);if(!t||t.length<2){m.removeElement(e)}})}h.removeElement(e)};this.getCategories=h.getElements;this.copyCategory=function(e){var t=h.copyElement(e);if(!t){return}s.getCategoryStepAssignments(e).forEach(function(e){P(e,t)});return t};this.moveCategoryBefore=function(e,t){return h.moveBefore(e,t)};this.moveCategoryToEnd=function(e){return h.moveToEnd(e)};this.moveCategoryUpOrDown=function(e,t){return h.moveUpOrDown(e,t)};this.serialize=function(){return A.serializeConfiguration(s)};this.isSaved=function(){return d};this.setIsUnsaved=function(){d=false};this.save=function(e){var r;function n(n,i,a){if(!a){d=true;c.replaceConfigurationId(t.id||t,n.AnalyticalConfiguration);c.updateConfigurationName(t.id||t,r);t=n.AnalyticalConfiguration}e(t,i,a)}function i(n,i){if(!i){d=true}c.updateConfigurationName(t.id||t,r);e(t.id||t,n,i)}r=c.getConfiguration(t.id||t).AnalyticalConfigurationName;var a={AnalyticalConfiguration:"",AnalyticalConfigurationName:r,Application:c.getApplicationId(),SerializedAnalyticalConfiguration:JSON.stringify(this.serialize()),CreatedByUser:"",CreationUTCDateTime:null,LastChangeUTCDateTime:null,LastChangedByUser:""};if(typeof t==="string"){if(t.indexOf("apf1972-")===0){u.create("configuration",a,n)}else{a.AnalyticalConfiguration=t;u.update("configuration",a,i,[{name:"AnalyticalConfiguration",value:t}])}}else{if(t.id.indexOf("apf1972-")===0){a.AnalyticalConfiguration="";a.CreationUTCDateTime=null;a.LastChangeUTCDateTime=null}else{a.AnalyticalConfiguration=t.id;a.CreationUTCDateTime=t.creationDate;a.LastChangeUTCDateTime=t.lastChangeDate}if(t.updateExisting){u.update("configuration",a,i,[{name:"AnalyticalConfiguration",value:t.id}])}else{u.create("configuration",a,n)}}};this.getFilterOption=function(){return Object.assign({},f)};this.setFilterOption=function(e){if(e.none===true){S=null;t.call(this);r()}if(e.smartFilterBar===true){t.call(this);n()}if(e.facetFilter===true){S=null;i()}function t(){this.getFacetFilters().forEach(function(e){this.removeFacetFilter(e.getId())}.bind(this))}function r(){delete f.smartFilterBar;delete f.facetFilter;f.none=true}function n(){f.smartFilterBar=true;delete f.facetFilter;delete f.none}function i(){delete f.smartFilterBar;f.facetFilter=true;delete f.none}};this.isDataLostByFilterOptionChange=function(){if(f.smartFilterBar===true){if(S&&(S.getService()||S.getEntitySet())){return true}}if(f.facetFilter===true){if(p.getElements().length>0){return true}}return false};this.getSmartFilterBar=function(){if(f.smartFilterBar===true){if(!S){S=new i.constructors.SmartFilterBar("SmartFilterBar-1")}return S}return null};this.createFacetFilterWithId=function(e){if(f.facetFilter===true){return p.createElementWithProposedId(undefined,e).getId()}return null};this.createFacetFilter=function(){if(f.facetFilter===true){return p.createElement().getId()}return null};this.removeFacetFilter=p.removeElement;this.getFacetFilter=p.getElement;this.getFacetFilters=p.getElements;this.copyFacetFilter=p.copyElement;this.moveFacetFilterBefore=function(e,t){return p.moveBefore(e,t)};this.moveFacetFilterToEnd=function(e){return p.moveToEnd(e)};this.moveFacetFilterUpOrDown=function(e,t){return p.moveUpOrDown(e,t)};this.createNavigationTargetWithId=function(e){return y.createElementWithProposedId(undefined,e).getId()};this.createNavigationTarget=function(){return y.createElement().getId()};this.removeNavigationTarget=function(e){var t=y.getElement(e);if(!t){return}y.removeElement(e);if(t.isStepSpecific()){var r=this.getStepsAssignedToNavigationTarget(e);var n,i;for(n=0;n<r.length;n++){i=this.getStep(r[n]);i.removeNavigationTarget(e)}}};this.getNavigationTarget=y.getElement;this.getNavigationTargets=y.getElements;this.copyNavigationTarget=function(e){var t=y.copyElement(e);var r=y.getElement(t);if(r.isStepSpecific()){var n=this.getStepsAssignedToNavigationTarget(e);var i,a;for(i=0;i<n.length;i++){a=this.getStep(n[i]);a.addNavigationTarget(t)}}return t};this.moveNavigationTargetBefore=function(e,t){return y.moveBefore(e,t)};this.moveNavigationTargetToEnd=function(e){return y.moveToEnd(e)};this.moveNavigationTargetUpOrDown=function(e,t){return y.moveUpOrDown(e,t)};this.createStepWithId=function(e){return m.createElementWithProposedId(undefined,e).getId()};this.createStep=function(e){if(!this.getCategory(e)){return}var t=m.createElement().getId();this.addCategoryStepAssignment(e,t);return t};this.createHierarchicalStepWithId=function(e){return m.createElementWithProposedId(undefined,e,i.constructors.HierarchicalStep).getId()};this.createHierarchicalStep=function(e){if(!this.getCategory(e)){return}var t=m.createElement(undefined,i.constructors.HierarchicalStep).getId();this.addCategoryStepAssignment(e,t);return t};this.getStep=m.getElement;this.getSteps=m.getElements;this.getStepsNotAssignedToCategory=function(e){var t=this.getCategoryStepAssignments(e);var r=[];s.getSteps().forEach(function(e){var n=e.getId();if(t.indexOf(n)===-1){r.push(n)}});return r};this.copyStep=function(e){var t=P(e);var r=this.getCategoriesForStep(e);if(!t){return false}if(r){r.forEach(function(e){s.addCategoryStepAssignment(e,t)})}return t};function P(e,t){if(t&&!s.getCategory(t)){return false}var r=m.copyElement(e);if(!r){return false}if(t){s.addCategoryStepAssignment(t,r)}return r}this.getCategoriesForStep=function e(t){var r=[];var n=s.getCategories();if(n){n.forEach(function(e){var n=e.getId();var i=s.getCategoryStepAssignments(n);if(i&&i.indexOf(t)>-1){r.push(n)}})}return r};this.getAssignableStepsForNavigationTarget=function(e){var t=[];s.getSteps().forEach(function(r){var n=false;r.getNavigationTargets().forEach(function(t){if(e===t){n=true}});if(!n){t.push(r.getId())}});return t};this.getStepsAssignedToNavigationTarget=function(e){var t=[];s.getSteps().forEach(function(r){var n=false;r.getNavigationTargets().forEach(function(t){if(e===t){n=true}});if(n){t.push(r.getId())}});return t};this.copy=function(t){var r={stepContainer:m,categoryContainer:h,facetFilterContainer:p,navigationTargetContainer:y,categoryStepAssignmentContainer:E,applicationTitle:l,serviceList:C,filterOption:f};var a=e.deepDataCopy(r);if(f.smartFilterBar===true&&S){a.smartFilterBar=o()}return new n(t,i,undefined,a);function o(){var e=new i.constructors.SmartFilterBar(S.getId());e.setService(S.getService());e.setEntitySet(S.getEntitySet(),!S.isEntityTypeConverted());return e}};if(typeof t==="string"){if(t.indexOf("apf1972-")===0){d=false;if(a){a(s,undefined)}}else if(!o){I(t,u,function(e,t){if(!t){var r=JSON.parse(e.SerializedAnalyticalConfiguration);s.setApplicationTitle(r.applicationTitle);F.loadConfig(r,true);A.mapToDesignTimeAsPromise(F.getRegistry(),s).then(function(){d=true;a(s,undefined)})}else{a(undefined,t)}})}}else{F.loadConfig(t.content,true);A.mapToDesignTimeAsPromise(F.getRegistry(),this).then(function(){if(a){a(s,undefined)}})}function I(e,t,r){t.readEntity("configuration",function(e,t,n){r(e,n)},[{name:"AnalyticalConfiguration",value:e}],undefined,c.getApplicationId())}}t("sap.apf.modeler.core.ConfigurationEditor",n);return n});
//# sourceMappingURL=configurationEditor.js.map