/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/utils/proxyTextHandlerForLocalTexts","sap/apf/cloudFoundry/utils","sap/base/util/isEmptyObject","sap/ui/thirdparty/jquery"],function(e,i,n,jQuery){"use strict";function a(e,a){var t=a.instances.messageHandler;var r=a.manifests.manifest;var o=r["sap.app"].dataSources;var l=o&&o["apf.designTime.customer.applications"]&&o["apf.designTime.customer.applications"].uri;var c=o&&o["apf.designTime.customer.analyticalConfigurations"]&&o["apf.designTime.customer.analyticalConfigurations"].uri;var u=o&&o["apf.designTime.customer.applicationAndAnalyticalConfiguration"]&&o["apf.designTime.customer.applicationAndAnalyticalConfiguration"].uri;var s=o&&o["apf.designTime.textFileAndAnalyticalConfigurations"]&&o["apf.designTime.textFileAndAnalyticalConfigurations"].uri;var f=o&&o["apf.designTime.textFiles"]&&o["apf.designTime.textFiles"].uri;var d=o&&o["apf.designTime.vendor.importToCustomerLayer"]&&o["apf.designTime.vendor.importToCustomerLayer"].uri;var p=o&&o["apf.designTime.vendor.analyticalConfigurations"]&&o["apf.designTime.vendor.analyticalConfigurations"].uri;var g=a.instances.proxyTextHandlerForLocalTexts;var y=i.resolveUri.bind(this,a.instances.coreApi);function v(){return{}}function m(e){var i=JSON.parse(e.SerializedAnalyticalConfiguration);delete e.SerializedAnalyticalConfiguration;i.configHeader=e;e.SerializedAnalyticalConfiguration=JSON.stringify(i);return e}this.create=function(e,i,n){if(e==="application"){T(i,n)}else if(e==="configuration"&&i.CreationUTCDateTime&&i.LastChangeUTCDateTime){i=m(i);var a=i.AnalyticalConfiguration;_({type:"HEAD",url:y(c+"/"+a),success:function(){var e=t.createMessageObject({code:"5238",aParams:[a]});n(undefined,undefined,e)},error:function(e,a,r,o){if(e.status===404){O(i,function(e,a){n(i,e,a)})}else{var l=D(e,o,t);n(undefined,undefined,l)}}})}else if(e==="configuration"){i=m(i);C(i,n)}else if(e==="texts"){A(i,n)}else{t.check(false,"The create operation on entity set "+e+" is currently not supported by the modeler proxy.")}};function T(e,a){var r={applicationName:e.ApplicationName,textFile:{inDevelopmentLanguage:""}};var o="POST";var c=y(l);if(e.Application){o="PUT";c=c+"/"+e.Application}_({type:o,url:c,data:JSON.stringify(r),dataType:"json",success:function(r,l,c){if(o==="POST"&&r&&!n(r)){var u={ApplicationName:e.ApplicationName,Application:r.application};a(u,v(),undefined)}else if(o==="PUT"){var u={ApplicationName:e.ApplicationName,Application:e.Application};a(u,v(),undefined)}else{var s=i.buildErrorMessage(c,"5227",[],undefined,t);a(undefined,v(),s)}},error:function(e,n,r,o){var l=i.buildErrorMessage(e,"5227",[],o,t);a(undefined,v(),l)},async:true})}function C(e,a){var r=e.Application;var o={analyticalConfigurationName:e.AnalyticalConfigurationName,application:r,serializedAnalyticalConfiguration:e.SerializedAnalyticalConfiguration,textFile:{inDevelopmentLanguage:g.createTextFileOfApplication(r)}};_({type:"POST",url:y(c),data:JSON.stringify(o),dataType:"json",success:function(e,l,c){if(e&&!n(e)){var u={AnalyticalConfiguration:e.analyticalConfiguration,AnalyticalConfigurationName:o.analyticalConfigurationName};a(u,v(),undefined)}else{var s=i.buildErrorMessage(c,"5226",[r],undefined,t);a(undefined,v(),s)}},error:function(e,n,o,l){var c=i.buildErrorMessage(e,"5226",[r],l,t);a(undefined,v(),c)},async:true})}function A(e,i){var n=g.addText(e);e.TextElement=n;i(e,v())}this.readCollection=function(e,i,n,a,r){if(e==="application"){h(i)}else if(e==="configuration"){x(i,r)}else if(e==="texts"){i([],undefined)}else{t.check(false,"The read collection operation on entity set "+e+" is currently not supported by the modeler proxy.")}};function h(e){var a=y(l+"?$select=Application,ApplicationName");_({type:"GET",url:a,success:function(a,r,o){if(a&&!n(a)){var l=[];if(a.applications!==null){a.applications.forEach(function(e){l.push({Application:e.application,ApplicationName:e.applicationName,SemanticObject:""})})}e(l,v(),undefined)}else{var c=i.buildErrorMessage(o,"5229",[],undefined,t);e(undefined,v(),c)}},error:function(n,a,r,o){var l=i.buildErrorMessage(n,"5229",[],o,t);e(undefined,v(),l)},async:true})}function x(e,a){var r=a.getFilterTermsForProperty("Application");var o=r[0].getValue();var l=y(s+"?$select=AnalyticalConfiguration,AnalyticalConfigurationName,SerializedAnalyticalConfiguration&$filter="+a.toUrlParam());_({type:"GET",url:l,success:function(a,r,l){if(a&&!n(a)){var c=[];if(a.analyticalConfigurations!==null){a.analyticalConfigurations.forEach(function(e){c.push({AnalyticalConfiguration:e.analyticalConfiguration,Application:o,AnalyticalConfigurationName:e.analyticalConfigurationName,SerializedAnalyticalConfiguration:e.serializedAnalyticalConfiguration})})}g.initApplicationTexts(o,a.textFile.inDevelopmentLanguage);e(c,v(),undefined)}else{var u=i.buildErrorMessage(l,"5223",[o],undefined,t);e(undefined,v(),u)}},error:function(n,a,r,l){var c=i.buildErrorMessage(n,"5223",[o],l,t);e(undefined,v(),c)},async:true})}this.readEntity=function(e,i,n,a,r){if(e==="configuration"){var o=n[0].value;if(a&&a.length===2&&a.includes("CreationUTCDateTime")&&a.includes("LastChangeUTCDateTime")){N(o,r,i)}else{E(o,r,i)}}else{t.check(false,"The read single entity operation on entity set "+e+" is currently not supported by the modeler proxy.")}};function N(e,a,r){var o=y(c+"/"+e+"?$select=Application,CreationUtcDateTime,LastChangeUtcDateTime,ServiceInstance");_({type:"GET",url:o,success:function(o,l,c){if(o&&!n(o)){var u={CreationUTCDateTime:o.analyticalConfiguration.creationUtcDateTime,LastChangeUTCDateTime:o.analyticalConfiguration.lastChangeUtcDateTime};r(u,v())}else{var s=i.buildErrorMessage(c,"5221",[a,e],undefined,t);r(undefined,v(),s)}},error:function(n,o,l,c){var u=i.buildErrorMessage(n,"5221",[a,e],c,t);r(undefined,v(),u)},async:true})}function E(e,a,r){var o=y(c+"/"+e+"?$select=AnalyticalConfigurationName,SerializedAnalyticalConfiguration");_({type:"GET",url:o,success:function(o,l,c){if(o&&!n(o)){var u={Application:a,SerializedAnalyticalConfiguration:o.analyticalConfiguration.serializedAnalyticalConfiguration,AnalyticalConfiguration:e};r(u,v(),undefined)}else{var s=i.buildErrorMessage(c,"5221",[a,e],undefined,t);r(undefined,v(),s)}},error:function(n,o,l,c){var u=i.buildErrorMessage(n,"5221",[a,e],c,t);r(undefined,v(),u)},async:true})}this.update=function(e,i,n,a){if(e==="application"){var r=a[0].value;b(i,r,n)}else if(e==="configuration"&&i.CreationUTCDateTime&&i.LastChangeUTCDateTime){i=m(i);O(i,n)}else if(e==="configuration"){i=m(i);S(i,n)}else{t.check(false,"The update operation on entity set "+e+" is currently not supported by the modeler proxy.")}};function b(e,n,a){var r={applicationName:e.ApplicationName};var o=y(l+"/"+n);_({type:"PUT",url:o,data:JSON.stringify(r),dataType:"json",success:function(e,i,n){a(v(),undefined)},error:function(e,r,o,l){var c=i.buildErrorMessage(e,"5228",[n],l,t);a(v(),c)},async:true})}function S(e,n){var a=JSON.parse(e.SerializedAnalyticalConfiguration);var r=e.AnalyticalConfiguration;var o=y(c+"/"+r);var l=e.Application;a.configHeader={Application:l,AnalyticalConfiguration:r,AnalyticalConfigurationName:e.AnalyticalConfigurationName,CreationUTCDateTime:e.CreationUTCDateTime,LastChangeUTCDateTime:e.LastChangeUTCDateTime};var u={analyticalConfigurationName:e.AnalyticalConfigurationName,serializedAnalyticalConfiguration:JSON.stringify(a),textFile:{inDevelopmentLanguage:g.createTextFileOfApplication(l)}};_({type:"PUT",url:o,data:JSON.stringify(u),dataType:"json",success:function(e,i,a){n(v(),undefined)},error:function(e,a,o,c){var u=i.buildErrorMessage(e,"5233",[l,r],c,t);n(v(),u)},async:true})}function O(e,n){var a=JSON.parse(e.SerializedAnalyticalConfiguration);var r=a.configHeader.AnalyticalConfiguration;var o=y(u+"/"+r);var l=e.Application;var c={analyticalConfigurationName:e.AnalyticalConfigurationName,application:l,serializedAnalyticalConfiguration:e.SerializedAnalyticalConfiguration};_({type:"PUT",url:o,data:JSON.stringify(c),dataType:"json",success:function(e,i,a){n(v(),undefined)},error:function(e,a,o,c){var u=i.buildErrorMessage(e,"5233",[l,r],c,t);n(v(),u)},async:true})}this.remove=function(e,i,n,a,r,o){if(e==="application"){var l=i[0].value;F(l,n)}else if(e==="configuration"){var c=i[0].value;L(c,r,n)}else{t.check(false,"The delete operation on entity set "+e+" is currently not supported by the modeler proxy.")}};function F(e,n){var a=y(l+"/"+e);_({type:"DELETE",url:a,success:function(e,i,a){n(v(),undefined)},error:function(a,r,o,l){var c=i.buildErrorMessage(a,"5237",[e],l,t);n(v(),c)},async:true})}function L(e,n,a){var r=y(c+"/"+e);_({type:"DELETE",url:r,success:function(e,i,n){a(v(),undefined)},error:function(r,o,l,c){var u=i.buildErrorMessage(r,"5225",[n,e],c,t);a(v(),u)},async:true})}this.doChangeOperationsInBatch=function(e,i,n,a){e.forEach(function(e){if(e.entitySetName!=="texts"){t.check(false,"The create/update/delete operation in batch on entity set "+e.entitySetName+" is not supported by the modeler proxy.")}e.application=n});this._readConfigurationListAndTextFile(n).then(function(t){var r=t.textFile.inDevelopmentLanguage;this._initText(n,r);this._applyChangesOnTextFile(e);var o=this._createTextFileOfApplication(n);this._updateRemoteTextFile(n,"DEV",o,a).then(function(){i(undefined)},function(e){i(e)})}.bind(this),function(e){i(e)})};this._readConfigurationListAndTextFile=function(e){var n="'";var a=new Promise(function(a,r){var o=y(s+"?$select=AnalyticalConfiguration,AnalyticalConfigurationName,SerializedAnalyticalConfiguration"+"&$filter=(Application%20eq%20"+n+e+n+")");_({type:"GET",url:o,success:function(e,i,n){var t=[];if(e.analyticalConfigurations!==null){e.analyticalConfigurations.forEach(function(e){t.push({analyticalConfiguration:e.analyticalConfiguration,analyticalConfigurationName:e.analyticalConfigurationName,serializedAnalyticalConfiguration:e.serializedAnalyticalConfiguration})})}var r={analyticalConfigurations:t,textFile:{inDevelopmentLanguage:e.textFile.inDevelopmentLanguage}};a(r)},error:function(n,a,o,l){var c=i.buildErrorMessage(n,"5222",[e],l,t);r(c)},async:true})});return a};this._initText=function(e,i){g.initApplicationTexts(e,i)};this._applyChangesOnTextFile=function(e){e.forEach(function(e){if(e.entitySetName==="texts"){switch(e.method){case"POST":var i=e.data;this._createOrUpdateLocalText(i);break;case"PUT":var n=e.data;this._createOrUpdateLocalText(n);break;case"DELETE":var a=e.application;var r=e.inputParameters[0].value;this._deleteLocalText(a,r);break;default:t.check(false,"The method "+e.method+" is not supported during text processing in batch mode by the modeler proxy.");break}}else{t.check(false,"The create/update/delete operation on entity set "+e.entitySetName+" is not supported by the modeler proxy.")}}.bind(this))};this._createTextFileOfApplication=function(e){return g.createTextFileOfApplication(e)};this._createOrUpdateLocalText=function(e){g.addText(e)};this._deleteLocalText=function(e,i){var n={application:e,inputParameters:[{value:i}]};g.removeText(n)};this._updateRemoteTextFile=function(e,n,a,r){var o=new Promise(function(o,l){var c;if(r===true){c=y(f+"/"+e)}else{c=y(f+"/"+e+"/"+n)}var u={serializedTextFile:a};_({type:"PUT",data:JSON.stringify(u),url:c,success:function(e,i,n){o()},error:function(n,a,r,o){var c=i.buildErrorMessage(n,"5230",[e],o,t);l(c)},async:true})});return o};this.readCollectionsInBatch=function(e,i){var n=e[0];t.check(n.entitySetName==="configuration","wrong usage, only 'configuration' is allowed");var a=n.filter.getFilterTermsForProperty("Application");var r=a[0].getValue();function o(){function e(e,n,a){if(a){i(undefined,a)}else{var t=[];t.push(e);t.push(g.getTextElements(r));i(t)}}return e}this.readCollection(n.entitySetName,o(),n.inputParameters,n.selectList,n.filter)};function D(e,i,n){var a=n.createMessageObject({code:"5214",aParameters:[e.status,e.statusText]});if(i){a.setPrevious(i)}return a}this.importVendorContent=function(e,i,n,a,t){this.readAllConfigurationsFromVendorLayer().done(function(r){U(e,i,n,a,t,r)}).fail(function(e){a(undefined,undefined,e)})};function U(e,i,n,a,r,o){var l;var u,s;var f=e+"."+i;for(l=0;l<o.length;l++){if(o[l].value===f){s=o[l].configurationText;u=o[l].applicationText;break}}_({type:"HEAD",url:y(c+"/"+i),success:function(){n(g,v,s)},error:function(e,n,r,o){if(e.status===404){z(i,d)}else{var l=D(e,o,t);a(undefined,undefined,l)}}});function d(i,n,t){if(!t){r(e,u)}a(i,n,t)}function g(){z(i,a)}function v(n){var r=y(p+"/"+i+"?$select=SerializedAnalyticalConfiguration");_({type:"GET",url:r,success:function(i){P(e,n,i.serializedAnalyticalConfiguration,a)},error:function(e,i,n,r){var o=D(e,r,t);a(undefined,undefined,o)}})}}function P(e,i,n,a){var r=y(c);var o={analyticalConfigurationName:i,application:e,serializedAnalyticalConfiguration:n};_({type:"POST",url:r,dataType:"json",data:JSON.stringify(o),success:function(e){a(e.analyticalConfiguration)},error:function(e,i,n,r){var o=D(e,r,t);a(undefined,undefined,o)}})}function z(e,i){_({type:"PUT",url:y(d+"/"+e),contentType:"application/x-www-form-urlencoded",success:function(){i(e)},error:function(e,n,a,r){var o=D(e,r,t);i(undefined,undefined,o)}})}var M;this.readAllConfigurationsFromVendorLayer=function(){var e=jQuery.Deferred();if(M){e.resolve(M)}else{_({url:y(p+"?$select=Application,ApplicationName,AnalyticalConfiguration,AnalyticalConfigurationName"),success:function(i){var n=[];if(i!==null){i.forEach(function(e){n.push({configurationText:e.analyticalConfigurationName,applicationText:e.applicationName,value:e.application+"."+e.analyticalConfiguration})})}M=n;e.resolve(n)},error:function(i,n,a,r){var o=D(i,r,t);var l=t.createMessageObject({code:"5231"});l.setPrevious(o);e.reject(l)}})}return e.promise()};function _(e){return a.instances.ajaxHandler.send(e)}}var t={ModelerProxy:a};return t},true);
//# sourceMappingURL=modelerProxy.js.map