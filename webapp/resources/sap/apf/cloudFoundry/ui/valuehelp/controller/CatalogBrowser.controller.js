sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/IconPool","sap/ui/core/Item","sap/ui/core/library","sap/ui/model/json/JSONModel","sap/ui/model/odata/v2/ODataModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/m/MessageToast","sap/apf/cloudFoundry/ui/utils/ODataServiceUtils"],function(e,t,a,r,i,n,s,o,l,c,u){"use strict";const{ValueState:S}=r;var d="sap.apf.cloudFoundry.ui.valuehelp";var v={BACK:-1,DESTINATIONS:0,CATALOG:1,URL:2,OVERVIEW:3,OVERVIEW_REDUCED:4,OVERVIEW_SERVICEONLY:5};function h(e,t){return e.getManifestObject().resolveUri(t).toString()}return e.extend(d+".controller.CatalogBrowser",{onInit:function(){var e=this.getOwnerComponent();var t=h(e,e.getManifestEntry("/sap.app/dataSources/apf.destinationCatalog.destinations").uri);this.sDestination=undefined;this.sService=undefined;this.oCoreApi=e.oCoreApi;var a=this.getView();var r=new i({Title:this.translate("selectDestination"),Destination:"",Service:"",ServiceUrlValueState:S.None,SearchEnabled:true,ButtonOkEnabled:false,ButtonSelectEnabled:false,ButtonBackEnabled:false});a.setModel(r,"ui");var n=new i(t);a.setModel(n,"destinations");n.attachRequestCompleted(function(){this.oDestinationStatusPromises=u.pingDestinations(n.getData().destinations)}.bind(this));this.initializeDialog()},initializeDialog:async function(){var e=this.oDialog=await this.loadFragment({name:d+".fragment.CatalogBrowser"});e.removeStyleClass("sapUiPopupWithPadding");e.addStyleClass("sapMSelectDialog");this.addCustomEventDelegates();e.open()},addCustomEventDelegates:function(){var e=this.getView();e.byId("urlInput").addEventDelegate({onkeypress:function(e){if(e.key==="Enter"){this.onSelectServiceUrl()}}.bind(this)})},onSelectDestination:function(e){this.destinationPath=e.getSource().getBindingContext("destinations").getPath();var t=this.getView();var r=t.getModel("destinations");var i=r.getObject(this.destinationPath);this.destinationSearch=t.byId("searchField").getValue();t.byId("searchField").setValue("");this.oDestinationStatusPromises[i.name].then(function(e){switch(e){case u.DESTINATION_TYPE.SERVICE:this.navigate(v.OVERVIEW_SERVICEONLY,{destination:i.name});this.setIsAnalyticalService();t.byId("serviceOnlyOverview").bindElement({path:this.destinationPath,model:"destinations"});break;case u.DESTINATION_TYPE.CATALOG:this.navigate(v.CATALOG,{destination:i.name});this.attachCatalogModel(i.name);break;default:var r=t.byId("urlInput");r.setValue("");r.removeAllItems();r.setShowButton(false);this.navigate(v.URL,{destination:i.name});u.discoverServices(i.name).then(function(e){if(e.length>0){e.forEach(function(e){r.addItem(new a({text:e.Url}))});r.setShowButton(true)}}).catch(function(){});break}}.bind(this))},attachCatalogModel:function(e){var t=this.getView();var a=t.byId("navContainer").getCurrentPage().getContent()[0];a.bindItems({path:"catalog>/ServiceCollection",sorter:new l("TechnicalServiceName",false),parameters:{custom:{search:""}},template:a.getBindingInfo("items").template});var r=new n(u.getCatalogURL(e));t.setModel(r,"catalog");var i=t.byId("selectService");i.setBusy(true);r.attachMetadataLoaded(function(){i.setBusy(false)});r.attachMetadataFailed(function(e){this.onBack();c.show(this.translate("destinationError",e.getParameter("responseText")));i.setBusy(false)}.bind(this))},onSelectService:function(e){var t=this.getView();var a=e.getSource().getBindingContext("catalog");var r=u.getRelativeServiceURL(a.getProperty("ServiceUrl"));this.navigate(v.OVERVIEW,{service:r});this.setIsAnalyticalService();var i=a.getPath();t.byId("destinationOverview").bindElement({path:this.destinationPath,model:"destinations"});t.byId("serviceOverview").bindElement({path:i,model:"catalog"})},onSelectServiceUrl:function(){var e=this.getView();var t=e.getModel("ui");var a=e.byId("urlInput").getValue();if(!a.startsWith("/")){t.setProperty("/ServiceUrlValueState",S.Error);return}t.setProperty("/ServiceUrlValueState",S.None);this.navigate(v.OVERVIEW_REDUCED,{service:a});this.setIsAnalyticalService();e.byId("reducedDestinationOverview").bindElement({path:this.destinationPath,model:"destinations"})},onCancel:function(){this.getDialog().close();this.getDialog().destroy();this.getView().destroy();this.destroy()},onBack:function(){var e=this.getView();var t=this.navigate(v.BACK);switch(t){case v.DESTINATIONS:e.byId("searchField").setValue(this.destinationSearch);break;default:break}},onOk:function(){var e=this.getView();var t=e.getModel("ui");var a=u.getFullServiceURL(t.getProperty("/Destination"),t.getProperty("/Service"));var r=this.getView().getViewData();r.parentControl.fireEvent("selectService",{sSelectedService:a});this.getDialog().close();this.getDialog().destroy();this.getView().destroy();this.destroy()},onLiveChangeSearch:function(e){var t=e.getParameter("newValue");var a=t?300:0;var r=this;clearTimeout(this.iLiveChangeTimer);if(a){this.iLiveChangeTimer=setTimeout(function(){r.executeSearch(t)},a)}else{this.executeSearch(t)}},onSearch:function(e){this.executeSearch(e.getSource().getValue())},executeSearch:function(e){var t=this.getView();var a=t.byId("navContainer").getCurrentPage().getContent()[0];var r=t.getModel("ui").getProperty("/Destination")!=="";if(r){a.bindItems({path:"catalog>/ServiceCollection",sorter:new l("TechnicalServiceName",false),parameters:{custom:{search:e}},template:a.getBindingInfo("items").template})}else{a.getBinding("items").filter(new s({filters:[new s({path:"name",operator:o.Contains,value1:e}),new s({path:"description",operator:o.Contains,value1:e})],and:false}))}},setIsAnalyticalService:function(){var e=this.getView().getModel("ui");var t=e.getProperty("/Destination");var a=e.getProperty("/Service");e.setProperty("/ServiceStatus",u.SERVICE_STATUS.PENDING);return u.isAnalyticalService(t,a).then(function(t){e.setProperty("/ServiceStatus",t)}).catch(function(t){e.setProperty("/ServiceStatus",t)})},serviceStatusIcon:function(e){switch(e){case u.SERVICE_STATUS.ANALYTICAL_SERVICE:return t.getIconURI("status-positive");case u.SERVICE_STATUS.NOT_ANALYTICAL_SERVICE:return t.getIconURI("status-critical");case u.SERVICE_STATUS.WRONG_ODATA_VERSION:return t.getIconURI("status-error");case u.SERVICE_STATUS.NOT_ACCESSIBLE:return t.getIconURI("status-error");default:return t.getIconURI("status-inactive")}},serviceStatusState:function(e){switch(e){case u.SERVICE_STATUS.ANALYTICAL_SERVICE:return S.Success;case u.SERVICE_STATUS.NOT_ANALYTICAL_SERVICE:return S.Warning;case u.SERVICE_STATUS.WRONG_ODATA_VERSION:return S.Error;case u.SERVICE_STATUS.NOT_ACCESSIBLE:return S.Error;default:return S.None}},serviceStatusText:function(e){switch(e){case u.SERVICE_STATUS.ANALYTICAL_SERVICE:return this.translate("analyticalService");case u.SERVICE_STATUS.NOT_ANALYTICAL_SERVICE:return this.translate("nonAnalyticalService");case u.SERVICE_STATUS.WRONG_ODATA_VERSION:return this.translate("wrongOdataVersion");case u.SERVICE_STATUS.NOT_ACCESSIBLE:return this.translate("serviceNotAccessible");default:return this.translate("pending")}},proxyTypeIcon:function(e){switch(e){case"OnPremise":return t.getIconURI("it-host");default:return t.getIconURI("cloud")}},proxyTypeText:function(e){switch(e){case"OnPremise":return this.translate("onPremise");default:return this.translate("cloud")}},translate:function(e){return this.oCoreApi.getText(e,Array.prototype.slice.call(arguments,1))},getRelativeServiceURL:u.getRelativeServiceURL,navigate:function(e,t){var a=this.getView();var r=a.getModel("ui");var i=a.byId("navContainer");t=t||{};t.destination=t.destination||r.getProperty("/Destination");t.service=t.service||r.getProperty("/Service");var n;if(e<0){var s=i.getPreviousPage();n=i.indexOfPage(s)}else{n=e}switch(n){case v.DESTINATIONS:r.setProperty("/Title",this.translate("selectDestination"));r.setProperty("/Destination","");r.setProperty("/Service","");r.setProperty("/ServiceUrlValueState",S.None);r.setProperty("/SearchEnabled",true);r.setProperty("/ButtonOkEnabled",false);r.setProperty("/ButtonSelectEnabled",false);r.setProperty("/ButtonBackEnabled",false);break;case v.CATALOG:r.setProperty("/Title",this.translate("selectService",t.destination));r.setProperty("/Destination",t.destination);r.setProperty("/Service","");r.setProperty("/ServiceUrlValueState",S.None);r.setProperty("/SearchEnabled",true);r.setProperty("/ButtonOkEnabled",false);r.setProperty("/ButtonSelectEnabled",false);r.setProperty("/ButtonBackEnabled",true);break;case v.URL:r.setProperty("/Title",this.translate("enterService",t.destination));r.setProperty("/Destination",t.destination);r.setProperty("/Service","");r.setProperty("/ServiceUrlValueState",S.None);r.setProperty("/SearchEnabled",false);r.setProperty("/ButtonOkEnabled",false);r.setProperty("/ButtonSelectEnabled",true);r.setProperty("/ButtonBackEnabled",true);break;case v.OVERVIEW:r.setProperty("/Title",this.translate("overview"));r.setProperty("/Destination",t.destination);r.setProperty("/Service",t.service);r.setProperty("/ServiceUrlValueState",S.None);r.setProperty("/SearchEnabled",false);r.setProperty("/ButtonOkEnabled",true);r.setProperty("/ButtonSelectEnabled",false);r.setProperty("/ButtonBackEnabled",true);break;case v.OVERVIEW_REDUCED:r.setProperty("/Title",this.translate("overview"));r.setProperty("/Destination",t.destination);r.setProperty("/Service",t.service);r.setProperty("/ServiceUrlValueState",S.None);r.setProperty("/SearchEnabled",false);r.setProperty("/ButtonOkEnabled",true);r.setProperty("/ButtonSelectEnabled",false);r.setProperty("/ButtonBackEnabled",true);break;case v.OVERVIEW_SERVICEONLY:r.setProperty("/Title",this.translate("overview"));r.setProperty("/Destination",t.destination);r.setProperty("/Service","");r.setProperty("/ServiceUrlValueState",S.None);r.setProperty("/SearchEnabled",false);r.setProperty("/ButtonOkEnabled",true);r.setProperty("/ButtonSelectEnabled",false);r.setProperty("/ButtonBackEnabled",true);break;default:r.setProperty("/Title",this.translate("selectDestination"));r.setProperty("/Destination","");r.setProperty("/Service","");r.setProperty("/ServiceUrlValueState",S.None);r.setProperty("/SearchEnabled",true);r.setProperty("/ButtonOkEnabled",false);r.setProperty("/ButtonSelectEnabled",false);r.setProperty("/ButtonBackEnabled",false);n=v.DESTINATIONS;break}if(e<0){i.back()}else{var o=i.getPages()[n];i.to(o)}return n},getDialog:function(){return this.getView().byId("catalogBrowser")}})});
//# sourceMappingURL=CatalogBrowser.controller.js.map