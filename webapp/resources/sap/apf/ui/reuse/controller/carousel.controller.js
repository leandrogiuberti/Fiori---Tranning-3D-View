/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2019 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/utils/utils","sap/apf/ui/utils/wrappedChartWithCornerTexts","sap/apf/utils/trace","sap/base/Log","sap/ui/Device","sap/ui/core/mvc/Controller"],function(e,t,i,o,n,s){"use strict";var r=0;var a=" ************************************** ";var h=" -------------------------------------- ";function l(e,t,o,n,s){if(jQuery.sap.log.apfTrace===undefined){return}var r=c(e,t,o,n,s);i.log("Carousel."+t,r)}function g(e){var t="";e.forEach(function(e,i){var o=e.oChart;if(o){t+="'"+o.sId+"',"}else{t+="'"+o+"',"}});t=e.length===0?"[]":"["+t.slice(0,t.length-1)+"]";return t}function p(e){var t="";var i=e.getView().getCustomItemList();i.forEach(function(e,i){t+="'"+e.sId+"',"});t=i.length===0?"[]":"["+t.slice(0,t.length-1)+"]";return t}function u(e){return", relation="+g(e._relateChartsToItems)+" // "+p(e)+" #path="+e.oCoreApi.getSteps().length}function c(e,t,i,o,n){n=n||"";var s="";var r="-";var a;var h="-";if(o){a=o.getSelectedRepresentation();h=a.type}var l="";if(i===-1){return s+n}l+=": inx="+i;l+=r==="-"||r===false?"":", is iconic";l+=h==="-"?"":", repr.type="+h;l+=u(e);l+=n===""?"":"\n --- "+n+"---";return s+l}var m=s.extend("sap.apf.ui.reuse.controller.carousel",{cloneCnt:0,paddingLeft:10,paddingRight:10,paddingBottom:15,paddingTop:15,_relateChartsToItems:[],onAfterRendering:function(){},onInit:function(){if(n.system.desktop){this.getView().addStyleClass("sapUiSizeCompact")}var e=this.getView().getViewData().oInject;this.oCoreApi=e.oCoreApi;this.oUiApi=e.uiApi;this._relateChartsToItems=[]},showStepGallery:function(){this.getView().getStepGallery().getController().openHierarchicalSelectDialog()},onBeforeRendering:function(){if(!n.system.desktop){this.oUiApi.getLayoutView().getController().showMasterFooter(this.getView().addStepButton,this.getView().moveUpButton,this.getView().moveDownButton)}else{this.oUiApi.getLayoutView().getController().addMasterFooterContentLeft(this.getView().addStepButton);this.oUiApi.getLayoutView().getController().addMasterFooterContentLeft(this.getView().moveUpButton);this.oUiApi.getLayoutView().getController().addMasterFooterContentLeft(this.getView().moveDownButton)}},getStepData:function(e){var t={};t.index=this.oCoreApi.getSteps().indexOf(e);t.title=this.oCoreApi.getTextNotHtmlEncoded(e.title);t.oStepTexts=this.getTextsForCustomListItem(e);return t},update1CustomItemChartWhenChange:function(e,t){i.logCall("update1CustomItemChartWhenChange",t,e);var o=e.getSelectedRepresentation();var n=this._relateChartsToItems[t].oChart;if(!n){i.logReturn("update1CustomItemChartWhenChange: chart reference is undefined");return}i.log("...",", #oClonedChart.oModel before update:",n.getModel().getData().data.length);o.createDataset();n.setModel(o.oModel);this._setSelectionsOnThumbnailAndEnforceRendering(e,t);i.logReturn("update1CustomItemChartWhenChange",", #oClonedChart.oModel:",n.getModel().getData().data.length)},_setSelectionsOnThumbnailAndEnforceRendering:function(e,t){var o=this;var n=r++;i.emphasize("_setSelectionsOnThumbnailAndEnforceRendering, nIndex="+t," set timeout, tick=",n);setTimeout(function(){i.emphasize("_setSelectionsOnThumbnailAndEnforceRendering, nIndex="+t," resolved timeout, tick=",n);o.setSelectionsOnThumbnail(e,t)},1)},getActiveStepIndex:function(){if(this.oCoreApi.getSteps().length>1){this.getView().moveDownButton.setEnabled(true);this.getView().moveUpButton.setEnabled(true)}return this.oCoreApi.getSteps().indexOf(this.oCoreApi.getActiveStep())},deleteFromBookkeeping:function(e){if(e>=0){this._relateChartsToItems.splice(e,1)}},setSelectionsOnThumbnail:function(e,n){var s=e.getSelectedRepresentation();if(t.isIconDisplayed(s)){i.log("setSelectionsOnThumbnail","iconic, no selections applied, return");return}var r=this._relateChartsToItems[n].oChart;i.logCall("setSelectionsOnThumbnail",", nIndex",n);if(!r){o.error("***** setSelectionsOnThumbnail: chart reference is undefined");return}var a=s.oRepresentationFilterHandler.getFilterValues();var h=s.oVizFrameSelectionHandler.getSelectionInfoFromFilter(a,s.aDataResponse);i.log("setSelectionsOnThumbnail",", call oClonedChart.vizSelection"," apfId="+s.apfId,"  chart.id="+r.sId," selections&filters:",h,a);r.vizSelection(h,{clearSelection:true});var l=" #filters:"+a.length;l+=" #vizSelection="+(r.vizSelection()?r.vizSelection().length:"undefined");i.logReturn("setSelectionsOnThumbnail",l)},_createWrappedChartClone:function(e){var i=t.getClonedChart(e);var o=new t.constructor(this,e,i);return{oChart:i,oWrappedView:o.getContent(),wrappedChartWithCornerTexts:o}},_createRelation:function(e){var o=this._createWrappedChartClone(e);var n=this.getView().createCustomListItem(o.oWrappedView);var s=e.getSelectedRepresentation();var r=o.oChart;if(t.isIconDisplayed(s)){r=null}var a={oChart:r,oTable:s.toggleInstance,typeOfChart:s.type,bIsAlternateView:s.bIsAlternateView,customListItem:n,wrappedChartWithCornerTexts:o.wrappedChartWithCornerTexts};i.log("_createRelation"," return=",a);return a},_addStepAsCustomItem:function(e){var t=this._createRelation(e);this.getView().addCustomListItem(t.customListItem);t.wrappedChartWithCornerTexts.setHighlighted();this._relateChartsToItems.push(t);l(this,"_addStepAsCustomItem <<",this._relateChartsToItems.length,e)},_replaceChangedRepresentation:function(e,t){l(this,"_replaceChangedRepresentation",t,e);var o=this._createRelation(e);i.log("",", relation=",o);this._relateChartsToItems[t]=o;this.getView().removeCustomItem(t);this.getView().insertCustomItem(o.customListItem,t);this._setSelectionsOnThumbnailAndEnforceRendering(e,t);l(this,"_replaceChangedRepresentation",t,e)},isChangeOfRepresentation:function(e,t){var o=t.type!==this._relateChartsToItems[e].typeOfChart||t.bIsAlternateView!==this._relateChartsToItems[e].bIsAlternateView;i.log("isChangeOfRepresentation"," return=",o);return o},updateCustomListView:function(e,t,o){var n;try{n=e.getSelectedRepresentation();i.logCall(" --API-- Carousel.updateCustomListView",", nIndex="+t," bStepChanged="+o,"apfId=",n.apfId,u(this),h);if(t>=this._relateChartsToItems.length){this._addCustomItemAndSetHighlighting(e,t)}else if(this.isChangeOfRepresentation(t,n)){this._replaceChangedRepresentation(e,t)}else if(!o){this._setSelectionsOnThumbnailAndEnforceRendering(e,t)}else{this.update1CustomItemChartWhenChange(e,t)}this._pruneRelateChartsToItems();this._setBusyOnCustomListItem(this._relateChartsToItems[t],false)}catch(e){window.console.error("sap.apf .. carousel.controller catch exception: ",e);window.console.trace("trace ")}i.logReturn("updateCustomListView",u(this),h)},_pruneRelateChartsToItems:function(){if(this.oCoreApi.getSteps().length<this._relateChartsToItems.length){this._relateChartsToItems.splice(this.oCoreApi.getSteps().length);i.emphasize("updateCustomListView"," deletion of superfluous custom items")}},_addCustomItemAndSetHighlighting:function(e,t){var i;this._addStepAsCustomItem(e);this._setSelectionsOnThumbnailAndEnforceRendering(e,t);i=this.getActiveStepIndex();this._removeHighlightingOfAnyStep(i);if(i<=t){this._setHighlightingOfActiveStep(i)}},_setBusyOnCustomListItem:function(e,t){setTimeout(function(){e.customListItem.setBusy(t)},1)},setBusyFromIndex:function(e){var t=this;e=e||0;this._relateChartsToItems.forEach(function(i,o){if(o>=e){t._setBusyOnCustomListItem(i,true)}})},showStepChartChartAfterUpdate:function(){var e=this.oCoreApi.getSteps();if(e.length>this.getView().getCustomItemList().length){this.oUiApi.getLayoutView().setBusy(true);jQuery(this.oUiApi.getStepContainer().getDomRef()).show()}},handleMove:function(e){var t=this.oCoreApi.getSteps().indexOf(this.oCoreApi.getActiveStep());var o=t+1;var n=t-1;i.log("Carousel.handleMove",", parameter",e,", activeStepIndex="+t,a);if(e.down&&o<this.oCoreApi.getSteps().length){this._moveStep(t,o,t)}else{if(e.down!==true&&n>=0&&n<this.oCoreApi.getSteps().length){this._moveStep(t,n,n)}}},_moveInBookkeeping:function(e){i.logCall("_moveInBookkeeping",u(this));var t;t=this._relateChartsToItems[e+1];this._relateChartsToItems[e+1]=this._relateChartsToItems[e];this._relateChartsToItems[e]=t;t=this.getView().getCustomItemList()[e+1];this.getView().removeCustomItem(e+1);this.getView().insertCustomItem(t,e);i.logReturn("_moveInBookkeeping",u(this))},_moveStep:function(e,t,o){i.logCall("Carousel._moveStep"," from "+e+" to "+t,"relation=",this._relateChartsToItems);if(e!==t){this.setBusyFromIndex(o);this._moveInBookkeeping(o);var n=this.oCoreApi.getSteps()[e];var s=this.oUiApi.getAnalysisPath().getController();i.log("Carousel._moveStep"," move step in core and update path");this.oCoreApi.moveStepToPosition(n,t,s.callBackForUpdatePath.bind(s))}i.logReturn("_moveStep","relation=",this._relateChartsToItems)},setActiveStepAfterRemove:function(e){var t=this.getActiveStepIndex();if(e===t){var i;if(t===0){i=1;this._setHighlightingOfActiveStep(0)}else if(t===this.oCoreApi.getSteps().length-1){i=t-1;this._setHighlightingOfActiveStep(i)}else{i=t+1;this._setHighlightingOfActiveStep(t)}this.oCoreApi.setActiveStep(this.oCoreApi.getSteps()[i])}},removeStep:function(e){var t=this.oUiApi.getAnalysisPath().getController();var i=this.getActiveStepIndex();if(i===e&&this.oCoreApi.getSteps().length>1){this.setActiveStepAfterRemove(e)}var o=this.oCoreApi.getSteps()[e];this.oCoreApi.removeStep(o,t.callBackForUpdatePath.bind(t));this.oCoreApi.setDirtyState(true);this.oUiApi.getLayoutView().getController().setPathTitle();if(this.oCoreApi.getSteps().length>=1){this.getView().moveDownButton.setEnabled(false);this.getView().moveUpButton.setEnabled(false)}else{this.oUiApi.getStepContainer("ChartContainer").stepLayout.getAggregation("content")[0].getAggregation("toolbar").removeAllContent();this.oUiApi.getStepContainer("ChartContainer").stepLayout.getAggregation("content")[0].removeAllContent()}this.oUiApi.getLayoutView().getController().enableDisableOpenIn()},removeAllThumbnails:function(){this._removeItemsAndBookkeepingRelations()},_removeItemsAndBookkeepingRelations:function(){var e=this;e.getView().oCustomItemList.removeAllItems();e._relateChartsToItems.forEach(function(t){e._destroyItemAndChart(t)});e._relateChartsToItems=[]},getTextsForCustomListItem:function(e){var t=this;var i=["leftUpper","rightUpper","leftLower","rightLower"];var o=e.thumbnail;var n=e.getSelectedRepresentationInfo().thumbnail;var s={};i.forEach(function(e){var i=n&&n[e];i=i&&!t.oCoreApi.isInitialTextKey(n[e]);var r=o&&o[e];r=r&&!t.oCoreApi.isInitialTextKey(o[e]);if(i){s[e]=t.oCoreApi.getTextNotHtmlEncoded(n[e]);return}else if(r){s[e]=t.oCoreApi.getTextNotHtmlEncoded(o[e]);return}});return s},_getIndexOfCustomItem:function(e){return this.getView().getCustomItemList().findIndex(function(t){return t.sId===e})},deleteCustomListItem:function(e){var t=this._getIndexOfCustomItem(e);i.log("deleteCustomListItem",", indexOfItem=",t,a);var o=null;if(t>=0){o=this._relateChartsToItems[t];this.getView().removeCustomItem(t);this.deleteFromBookkeeping(t);this.setBusyFromIndex(t);this.removeStep(t);this._destroyItemAndChart(o)}l(this,"deleteCustomListItem",t,null)},_destroyItemAndChart:function(e){if(e.oChart){e.oChart.destroy()}if(e.oTable){e.oTable.destroy()}e.customListItem.destroy();e.customListItem=null;e.oChart=null},listItemPressed:function(e){var t=this._getIndexOfCustomItem(e.getParameters().id);this.changeActiveStep(t)},changeActiveStep:function(e){i.logCall("changeActiveStep -- changes the active step, index=",e,a);if(e===this.getActiveStepIndex()){i.logReturn("changeActiveStep",", index=",e,"******");return}var t=this.oCoreApi.getSteps()[e];this._removeHighlightingOfActiveStep();this.oCoreApi.setActiveStep(t);this.oUiApi.selectionChanged(false);this._setHighlightingOfActiveStep(e);i.logReturn("changeActiveStep",", index=",e,"******")},apfDestroy:function(){var t=this.getView().getStepGallery().getController();e.checkAndCloseDialog(t.oHierchicalSelectDialog)},_removeHighlightingOfActiveStep:function(){var e=this.getActiveStepIndex();var t=this._relateChartsToItems[e];t.wrappedChartWithCornerTexts.setNonHighlighted()},_removeHighlightingOfAnyStep:function(e){i.log("_removeHighlightingOfAnyStep",", nExclude",e);this._relateChartsToItems.forEach(function(t,i){if(i!==e){t.wrappedChartWithCornerTexts.setNonHighlighted()}})},_setHighlightingOfActiveStep:function(e){i.log("_setHighlightingOfActiveStep",", nActive",e);var t=this._relateChartsToItems[e];t.wrappedChartWithCornerTexts.setHighlighted()}});return m});
//# sourceMappingURL=carousel.controller.js.map