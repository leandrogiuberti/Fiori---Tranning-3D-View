/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/ui/utils/print","sap/apf/utils/utils","sap/m/Button","sap/m/Dialog","sap/m/Input","sap/m/library","sap/m/Text","sap/ui/Device","sap/ui/core/Item","sap/ui/core/library","sap/ui/core/mvc/Controller","sap/ui/core/mvc/View","sap/ui/model/json/JSONModel"],function(e,t,a,i,o,s,n,l,r,g,p,h,u){"use strict";var c=s.DialogType;var d=s.InputType;var f=g.ValueState;return p.extend("sap.apf.ui.reuse.controller.toolbar",{resetAnalysisPath:function(){this.oUiApi.getAnalysisPath().getCarouselView().getController().removeAllThumbnails();this.oCoreApi.resetPath();this.oUiApi.getAnalysisPath().getController().isNewPath=true;this.oStartFilterHandler.resetAll();this.oUiApi.contextChanged(true);this.oUiApi.getAnalysisPath().getController().refreshAnalysisPath();this.oCoreApi.setDirtyState(false);this.oCoreApi.setPathName("");this.oUiApi.getLayoutView().getController().setPathTitle();this.oUiApi.getStepContainer().rerender()},onInit:function(){this.view=this.getView();if(l.system.desktop){this.view.addStyleClass("sapUiSizeCompact")}this.oViewData=this.getView().getViewData();this.oCoreApi=this.oViewData.oCoreApi;this.oSerializationMediator=this.oViewData.oSerializationMediator;this.oUiApi=this.oViewData.uiApi;this.oStartFilterHandler=this.oViewData.oStartFilterHandler;this.bIsPathGalleryWithDelete=false;this.oPathGalleryDialog={}},addCompactStyleClassForDialog:function(e){if(l.system.desktop){e.addStyleClass("sapUiSizeCompact")}},onSaveAndSaveAsPress:function(e){var t=this;if(t.oCoreApi.getSteps().length!==0){t.oUiApi.getLayoutView().setBusy(true);t.oCoreApi.readPaths(function(a,i,o){var s=a.paths;if(i!==undefined){t.getView().maxNumberOfSteps=i.getEntityTypeMetadata().maximumNumberOfSteps;t.getView().maxNumberOfPaths=i.getEntityTypeMetadata().maxOccurs}if(o===undefined&&typeof a==="object"){t.getSaveDialog(e,function(){},s)}else{var n=t.oCoreApi.createMessageObject({code:"6005",aParameters:[]});n.setPrevious(o);t.oCoreApi.putMessage(n)}t.oUiApi.getLayoutView().setBusy(false)})}else{var a=t.oCoreApi.createMessageObject({code:"6012",aParameters:[]});t.oCoreApi.putMessage(a)}},openPathGallery:function(e){var t={};var a=this;var i,o;a.oCoreApi.readPaths(async function(s,n,l){if(l===undefined&&typeof s==="object"){var r=s.paths;for(i=0;i<r.length;i++){var g=r[i].StructuredAnalysisPath.steps.length;var p=r[i].LastChangeUTCDateTime;var h=/\d+/g;var u=parseInt(p.match(h)[0],10);var c=new Date(u).toString().split(" ");var d=c[1]+"-"+c[2]+"-"+c[3];r[i].title=r[i].AnalysisPathName;r[i].guid=r[i].AnalysisPath;r[i].StructuredAnalysisPath.noOfSteps=g;r[i].description=d+"  -   ("+a.oCoreApi.getTextNotHtmlEncoded("no-of-steps",[g])+")";r[i].summary=r[i].AnalysisPathName+"- ("+d+") - ("+a.oCoreApi.getTextNotHtmlEncoded("no-of-steps",[g])+")"}t={GalleryElements:r};if(e){await a.openSavedPathGallery(t,a,"deleteAnalysisPath")}else{await a.openSavedPathGallery(t,a,"pathGallery")}a.oUiApi.getLayoutView().setBusy(false)}else{o=a.oCoreApi.createMessageObject({code:"6005",aParameters:[]});o.setPrevious(l);a.oCoreApi.putMessage(o);a.oUiApi.getLayoutView().setBusy(false)}})},openSavedPathGallery:async function(e,t,a){if(t.oPathGalleryDialog[a]===undefined||(await t.oPathGalleryDialog[a]).bIsDestroyed){t.oPathGalleryDialog[a]=h.create({viewName:`module:sap/apf/ui/reuse/view/${a}.view`,viewData:{oInject:t.oViewData}})}const i=await t.oPathGalleryDialog[a];i.getViewData().jsonData=e;var o=i.getController().oDialog;if(!o||o&&!o.isOpen()){i.getController().openPathGallery()}},doPrint:function(){var t=new e(this.oViewData);t.doPrint()},getSaveDialog:function(e,t,s){var n=this;var l=this.oCoreApi.getTextNotHtmlEncoded("saveName");var g=this.oUiApi.getLayoutView().getController().oSavedPathName.getText();var p=new u;p.setData(s);if(g){if(this.oCoreApi.isDirty()){g=g.split("*")[1]}}this.oInput=new o({type:d.Text,placeholder:l,showSuggestion:true,maxLength:100,suggestionItems:{path:"/",template:new r({text:"{AnalysisPathName}",additionalText:"{AnalysisPath}"})}}).addStyleClass("textStyle");this.oInput.setModel(p);if(!e){this.oInput.destroySuggestionItems()}this.oInput.attachEvent("click",function(e){jQuery(e.currentTarget).attr("value","")});function h(e,t,a,i){n.oInput.setValueState(e);n.oInput.setShowValueStateMessage(t);n.saveDialog.getBeginButton().setEnabled(a);if(a===true){n.saveDialog.getBeginButton().setType("Emphasized")}if(i){n.oInput.setValueStateText(i)}}this.oInput.attachLiveChange(function(e){var t=this.getValue();var a=new RegExp("[*]","g");if(t.trim()===""){h(f.Error,true,false)}else{h(f.None,false,true)}if(t.match(a)!==null){var i=n.oCoreApi.getTextNotHtmlEncoded("invalidPathName");h(f.Error,true,false,i)}n.oInput.setValue(t)});if(g!==n.oCoreApi.getTextNotHtmlEncoded("unsaved")){this.oInput.setValue(g)}this.analysisPathName=n.oInput.getValue().trim();if(n.saveDialog===undefined||n.saveDialog&&n.saveDialog.bIsDestroyed){n.saveDialog=new i({type:c.Message,title:n.oCoreApi.getTextNotHtmlEncoded("save-analysis-path"),content:n.oInput,contentWidth:"110px",contentHeight:"110px",beginButton:new a({text:n.oCoreApi.getTextNotHtmlEncoded("ok"),enabled:false,press:function(){n.saveDialog.getBeginButton().setEnabled(false);n.saveDialog.getEndButton().setEnabled(false);var a=n.oInput.getValue().trim();n.saveAnalysisPath(a,t,e);n.saveDialog.close()}}),endButton:new a({text:n.oCoreApi.getTextNotHtmlEncoded("cancel"),press:function(){n.saveDialog.close()}}),afterClose:function(){n.oUiApi.getLayoutView().setBusy(false);n.saveDialog.destroy()}}).addStyleClass("saveDialog");this.addCompactStyleClassForDialog(n.saveDialog);if(this.oInput.getValue()===g){n.saveDialog.getBeginButton().setEnabled(true)}}if(n.oCoreApi.getSteps().length>=1){if(!e&&g===n.oCoreApi.getTextNotHtmlEncoded("unsaved")){if(!n.saveDialog||n.saveDialog&&!n.saveDialog.isOpen()){n.saveDialog.open()}}else if(e){if(!n.saveDialog||n.saveDialog&&!n.saveDialog.isOpen()){n.saveDialog.open()}}else{n.saveAnalysisPath(g,t,e)}}},doOkOnNewAnalysisPath:function(){var e=this;this.isOpen=false;e.oCoreApi.readPaths(function(t,a,i){var o=true;var s=t.paths;if(a!==undefined){e.getView().maxNumberOfSteps=a.getEntityTypeMetadata().maximumNumberOfSteps;e.getView().maxNumberOfPaths=a.getEntityTypeMetadata().maxOccurs}if(i===undefined&&typeof t==="object"){e.getSaveDialog(o,function(){e.resetAnalysisPath()},s)}else{var n=e.oCoreApi.createMessageObject({code:"6005",aParameters:[]});n.setPrevious(i);e.oCoreApi.putMessage(n)}})},doOkOnOpenAnalysisPath:function(e){var t=this;this.isOpen=true;this.bIsPathGalleryWithDelete=e;t.oCoreApi.readPaths(function(e,a,i){var o=true;var s=e.paths;if(a!==undefined){t.getView().maxNumberOfSteps=a.getEntityTypeMetadata().maximumNumberOfSteps;t.getView().maxNumberOfPaths=a.getEntityTypeMetadata().maxOccurs}if(i===undefined&&typeof e==="object"){t.getSaveDialog(o,function(){return},s)}else{var n=t.oCoreApi.createMessageObject({code:"6005",aParameters:[]});n.setPrevious(i);t.oCoreApi.putMessage(n)}})},getNewAnalysisPathDialog:function(){var e=this;if(this.oCoreApi.isDirty()&&e.oCoreApi.getSteps().length!==0){e.newDialog=new i({type:c.Message,title:e.oCoreApi.getTextNotHtmlEncoded("newPath"),content:new n({text:e.oCoreApi.getTextNotHtmlEncoded("analysis-path-not-saved")}).addStyleClass("textStyle"),beginButton:new a({text:e.oCoreApi.getTextNotHtmlEncoded("yes"),type:"Emphasized",press:function(){e.doOkOnNewAnalysisPath();e.newDialog.close()}}),endButton:new a({text:e.oCoreApi.getTextNotHtmlEncoded("no"),press:function(){e.resetAnalysisPath();e.newDialog.close()}}),afterClose:function(){e.oUiApi.getLayoutView().setBusy(false);e.newDialog.destroy()}});this.addCompactStyleClassForDialog(e.newDialog);e.newDialog.setInitialFocus(e.newDialog);e.newDialog.open()}else{this.resetAnalysisPath()}},getOpenDialog:function(e){var t=this;t.newOpenDialog=new i({type:c.Message,title:t.oCoreApi.getTextNotHtmlEncoded("newPath"),content:new n({text:t.oCoreApi.getTextNotHtmlEncoded("analysis-path-not-saved")}).addStyleClass("textStyle"),beginButton:new a({text:t.oCoreApi.getTextNotHtmlEncoded("yes"),type:"Emphasized",press:function(){t.doOkOnOpenAnalysisPath(t.bIsPathGalleryWithDelete);t.newOpenDialog.close()}}),endButton:new a({text:t.oCoreApi.getTextNotHtmlEncoded("no"),press:function(){t.resetAnalysisPath();t.openPathGallery(t.bIsPathGalleryWithDelete);t.newOpenDialog.close()}}),afterClose:function(){t.oUiApi.getLayoutView().setBusy(false);t.newOpenDialog.destroy()}});this.addCompactStyleClassForDialog(t.newOpenDialog);t.newOpenDialog.setInitialFocus(t.newOpenDialog);t.newOpenDialog.open()},getConfirmDialog:function(e){var t=this;var o=e||{};var s={success:o.success||function(){return},fail:o.fail||function(){return},msg:o.msg||""};t.confirmDialog=new i({title:t.oCoreApi.getTextNotHtmlEncoded("caution"),type:c.Message,content:new n({text:s.msg}).addStyleClass("textStyle"),beginButton:new a({text:t.oCoreApi.getTextNotHtmlEncoded("yes"),type:"Emphasized",press:function(){t.overWriteAnalysisPath();t.confirmDialog.close()}}),endButton:new a({text:t.oCoreApi.getTextNotHtmlEncoded("no"),press:function(){var e=true;var a=t.oInput.getModel().getData();t.getSaveDialog(e,function(){return},a);t.confirmDialog.close()}}),afterClose:function(){t.oUiApi.getLayoutView().setBusy(false);t.confirmDialog.destroy()}});this.addCompactStyleClassForDialog(t.confirmDialog);t.confirmDialog.open()},callbackforSave:function(e){e()},onOpenPathGallery:function(e){if(this.oCoreApi.isDirty()&&this.oCoreApi.getSteps().length!==0){this.getOpenDialog(e)}else{this.openPathGallery(e)}this.isOpen=false},saveAnalysisPath:function(e,t,a){var i=this;this.saveCallback=t;this.analysisPathName=e;this.aData=i.oInput.getModel().getData();var o=false;this.guid="";for(var s=0;s<this.aData.length;s++){var n=this.aData[s].AnalysisPathName;if(this.analysisPathName===n){o=true;this.guid=this.aData[s].AnalysisPath;break}}var l=o?this.aData.length:this.aData.length+1;var r=i.oCoreApi.getSteps().length;if(l>this.getView().maxNumberOfPaths){i.oCoreApi.putMessage(i.oCoreApi.createMessageObject({code:"6014"}));return false}else if(r>this.getView().maxNumberOfSteps){i.oCoreApi.putMessage(i.oCoreApi.createMessageObject({code:"6015"}));return false}if(!o){i.oSerializationMediator.savePath(i.analysisPathName,function(e,t,a){if(a===undefined&&typeof e==="object"){i.oCoreApi.setDirtyState(false);i.oUiApi.getLayoutView().getController().setPathTitle();i.getSuccessToast(i.analysisPathName,false);if(typeof i.saveCallback==="function"){i.saveCallback()}}else{var o=i.oCoreApi.createMessageObject({code:"6006",aParameters:[i.analysisPathName]});o.setPrevious(a);i.oCoreApi.putMessage(o)}})}else{var g;if(this.oCoreApi.isDirty()&&this.oCoreApi.getSteps().length!==0){g=i.oUiApi.getLayoutView().getController().oSavedPathName.getText().slice(1,i.oUiApi.getLayoutView().getController().oSavedPathName.getText().length)}else{g=i.oUiApi.getLayoutView().getController().oSavedPathName.getText()}if(!a&&g===i.analysisPathName){i.overWriteAnalysisPath()}else{this.getConfirmDialog({msg:i.oCoreApi.getTextNotHtmlEncoded("path-exists",["'"+i.analysisPathName+"'"])})}}},getSuccessToast:function(e,t){var a=this;var i=a.oCoreApi.createMessageObject({code:t?"6017":"6016",aParameters:[e]});a.oCoreApi.putMessage(i);if(a.isOpen&&a.bIsPathGalleryWithDelete){a.openPathGallery(a.bIsPathGalleryWithDelete)}else if(a.isOpen){a.openPathGallery()}},overWriteAnalysisPath:function(){var e=this;var t=this.analysisPathName;var a=this.guid;e.oSerializationMediator.savePath(a,t,function(a,i,o){if(o===undefined&&typeof a==="object"){e.oCoreApi.setDirtyState(false);e.oUiApi.getLayoutView().getController().setPathTitle();if(e.saveDialog&&e.saveDialog.isOpen()){e.saveDialog.close()}e.getSuccessToast(t,true);if(typeof e.saveCallback==="function"){e.saveCallback()}}else{var s=e.oCoreApi.createMessageObject({code:"6007",aParameters:[t]});s.setPrevious(o);e.oCoreApi.putMessage(s)}})},apfDestroy:function(){t.checkAndCloseDialog(this.saveDialog);t.checkAndCloseDialog(this.newOpenDialog);t.checkAndCloseDialog(this.newDialog);t.checkAndCloseDialog(this.confirmDialog);t.checkAndCloseDialog(this.errorMsgDialog);t.checkAndCloseDialog(this.noPathAddedDialog);if(this.deleteAnalysisPath!==undefined){t.checkAndCloseDialog(this.deleteAnalysisPath.getController().oDialog)}if(this.pathGallery!==undefined){t.checkAndCloseDialog(this.pathGallery.getController().oDialog)}}})});
//# sourceMappingURL=toolbar.controller.js.map