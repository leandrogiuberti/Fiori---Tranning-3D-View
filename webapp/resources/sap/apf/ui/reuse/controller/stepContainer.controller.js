/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/ui/utils/helper","sap/apf/core/constants","sap/apf/ui/utils/constants","sap/base/util/deepExtend","sap/suite/ui/commons/ChartContainerContent","sap/suite/ui/commons/ChartContainerToolbarPlaceholder","sap/ui/core/Icon","sap/ui/core/CustomData","sap/ui/core/Fragment","sap/ui/core/mvc/Controller","sap/ui/core/mvc/XMLView","sap/m/library","sap/m/Link","sap/m/ToggleButton","sap/m/Label","sap/m/Button","sap/m/ToolbarSpacer","sap/m/List","sap/m/StandardListItem","sap/m/Popover","sap/apf/utils/trace","sap/ui/thirdparty/jquery"],function(e,t,n,a,r,i,o,s,l,d,p,c,u,g,f,v,h,C,y,m,S,jQuery){"use strict";const I=c.ListMode;const b=c.PlacementType;const T=c.ListSeparators;var w,R,A,P=false;function x(){var e=A.getSelectedRepresentation();return e.type===n.representationTypes.TABLE_REPRESENTATION}function D(){var e=A.getSelectedRepresentation();return e.type===n.representationTypes.TREE_TABLE_REPRESENTATION}function E(){if(A.getSelectedRepresentation().bIsAlternateView===undefined||A.getSelectedRepresentation().bIsAlternateView===false){return false}return true}function V(e){var t=e.getCurrentRepresentation();var n=t.getParameter().requiredFilters;if(n===undefined||n.length===0){return undefined}return n[0]}function N(e){S.logCall("StepContainer._setChartContainerContent");var t=e.byId("idChartContainer");var n=e.getCurrentRepresentation();var a=A.longTitle&&!w.isInitialTextKey(A.longTitle.key)?A.longTitle:A.title;var i=w.getTextNotHtmlEncoded(a);S.log("_setChartContainerContent"," title=",i);var o=n.getMainContent(i);var s={onBeforeRendering:function(){L(e,o)}};o.addEventDelegate(s);t.removeAllContent();var l=new r({content:o});t.addContent(l);S.logReturn("_setChartContainerContent")}function L(e,t){var n=e.byId("idChartContainer");var a="0";var r=jQuery(window).width();var i=n.getId();if(jQuery("#"+i).length!==0){a=jQuery("#"+i+" > div:first-child > div:nth-child(2)").offset().top;r=jQuery("#"+i+" > div:first-child > div:nth-child(2)").width()}var o=jQuery(window).height()-a-jQuery(".applicationFooter").height();var s=r;t.setHeight(o+"px");t.setWidth(s+"px")}function F(e,t){var n=e.byId("idSelectedText");var a=e.getCurrentRepresentation();var r=K(e);var i=a.getSelectionFilterLabel();var o=i+" ("+r+") ";var s=e.byId("idSelPropertyAndCount");if(!s){s=new u({id:e.createId("idSelPropertyAndCount"),press:e.handlePressSelectedPropertyCountLink.bind(e)});s.addAriaLabelledBy(n.getId())}else{if(s&&a.chart!==undefined&&(a.chart!==null&&a.chart.setFocusOnSelectLink)){a.chart.detachEvent("setFocusOnSelectedLinkEvent",a.chart.setFocusOnSelectLink)}}if(s&&a.chart!==undefined&&a.chart!==null){a.chart.setFocusOnSelectLink=function(){s.focus()}}s.setVisible(true);s.setText(o);t.addContent(s);t.onAfterRendering=function(){if(s&&a.chart!==undefined&&a.chart!==null){a.chart.fireEvent("setFocusOnSelectedLinkEvent");a.chart.detachEvent("setFocusOnSelectedLinkEvent",a.chart.setFocusOnSelectLink)}}}function B(e){var t=e.byId("idChartContainer");t.removeAllCustomIcons();H(e);O(e);k(e)}function H(t){var n=t.byId("idChartContainer");var a=A.getSelectedRepresentationInfo();var r;if(a.parameter&&a.parameter.orderby){var i=a.parameter.orderby;new e(w).getRepresentationSortInfo(a).done(function(e){for(var s=0;s<e.length;s++){r=i[0].property}var l=i[0].ascending==true?"Sort Order: Ascending":"Sort Order: Descending";var d=w.getTextNotHtmlEncoded(a.label)+"\n"+(r!==undefined?w.getTextNotHtmlEncoded("sortBy")+": "+r:"")+"\n"+l;var p=new o({src:a.picture,tooltip:d,press:function(e){t.handlePressChartIcon(e)}});n.addCustomIcon(p)})}else{var s=w.getTextNotHtmlEncoded(a.label)+"\n"+(r!==undefined?w.getTextNotHtmlEncoded("sortBy")+": "+r:"");var l=new o({src:a.picture,tooltip:s,press:function(e){t.handlePressChartIcon(e)}});n.addCustomIcon(l)}}function O(e){var t=e.byId("idChartContainer");var n=w.getTextNotHtmlEncoded("listView");var a=new o({src:"sap-icon://table-view",tooltip:n,press:e.handlePressAlternateRepIcon.bind(e)});var r=e.getCurrentRepresentation();var i=r.type;if(x()||D()||i=="TableRepresentation"){t.removeCustomIcon(a);return}t.addCustomIcon(a)}function k(e){if(e.getCurrentRepresentation().topN!==undefined||!E()&&!x()||D()){return}var t=e.byId("idChartContainer");var n=w.getTextNotHtmlEncoded("view-Settings-Button");var a=new o({src:"sap-icon://drop-down-list",tooltip:n,press:async function(){const t=await e.getCurrentRepresentation().getViewSettingDialog();e.getView().addDependent(t);t.open()}});t.addCustomIcon(a)}function M(e,t){var n=e.byId("idSelectedText");if(!n){n=new f({id:e.createId("idSelectedText"),text:w.getTextNotHtmlEncoded("selectedValue")})}n.setVisible(true);t.addContent(n)}function _(e,t){var n=e.byId("idReset");if(!n){n=new v({text:w.getTextNotHtmlEncoded("reset"),id:e.createId("idReset"),type:"Transparent",press:e.handlePressResetButton.bind(e)}).addStyleClass("chartContainerResetStyle")}n.setVisible(true);t.addContent(n)}function z(e,t){var n=K(e);if(n>0&&V(e)!==undefined){M(e,t);F(e,t);_(e,t)}}function U(e,t){var n=e.byId("idPathFilterDisplayButton");if(!n){n=new v({text:w.getTextNotHtmlEncoded("pathFilterDisplayButton"),id:e.createId("idPathFilterDisplayButton"),icon:"sap-icon://message-information",type:"Transparent",press:function(){if(e.byId("idStepLayout").getBusy()===false){w.getPathFilterInformation().then(function(t){var n=e.byId("pathFilterDisplay");if(!n){var a=new p({viewName:"sap.apf.ui.reuse.view.pathFilterDisplay",viewData:{pathFilterInformation:t,oCoreApi:w,oUiApi:R},id:e.createId("pathFilterDisplay")})}else{var a=new p({viewName:"sap.apf.ui.reuse.view.pathFilterDisplay",viewData:{pathFilterInformation:t,oCoreApi:w,oUiApi:R}})}a.setParent(e.getView(),"content",true);a.getContent()[0].open()})}}})}t.addContent(n)}function j(e,t){var n=e.getCurrentRepresentation();var a=n.type;var r=undefined;var i=false;if(a!=="TableRepresentation"&&a!=="listView"&&a!=="TreeTableRepresentation"){if(n.chart!==undefined){if(Object.getOwnPropertyNames(n.chart).length!==0){r=n.chart.vizSelection();i=n.chart.getVizProperties().plotArea.dataLabel.visible}}if(n!==undefined){if(n.aDataResponse!==0){var o=e.byId("idToggleDisplayButton");if(!o){o=new g({id:e.createId("idToggleDisplayButton"),pressed:false,text:w.getTextNotHtmlEncoded("values"),tooltip:w.getTextNotHtmlEncoded("displayValues"),press:e.handleToggleDisplay.bind(e)})}else{n=e.getCurrentRepresentation();o.setPressed(i)}if(r!==undefined){e.getCurrentRepresentation().chart.vizSelection(r,{clearSelection:false})}t.addContent(o)}}}}function X(e){var t=e.byId("idChartContainer");var n=t.getToolbar();n.removeAllContent();var a=new f({text:w.getTextNotHtmlEncoded("currentStep")});n.addContent(a);var r=new h;n.addContent(r);j(e,n);z(e,n);if(w.getSteps().indexOf(A)!==0){U(e,n)}n.addContent(new i);t.setToolbar(n)}function q(e,t,n){S.logCall("StepContainer._drawChartContainer",", isActiveStep=",n,", oActiveStep=",t);if(t!==undefined){N(e);B(e);X(e)}S.logReturn("_drawChartContainer")}function K(e){var t=e.getCurrentRepresentation();var n=t.getSelections().length;return n}function J(t,n){var a=new C({mode:I.SingleSelectMaster,showSeparators:T.None,includeItemInSelection:true,selectionChange:t.handleSelectionChartSwitchIcon.bind(t)});var r;var i;for(var o=0;o<A.getRepresentationInfo().length;o++){i=A.getRepresentationInfo()[o];r=undefined;if(i.parameter&&i.parameter.orderby){new e(w).getRepresentationSortInfo(i).done(function(e){var t=[];for(var n=0;n<e.length;n++){e[n].done(function(e){t.push(e)})}r=t.join(", ");var o=r!==undefined?w.getTextNotHtmlEncoded("sortBy")+": "+r:"";var l=new y({description:o,icon:i.picture,title:w.getTextNotHtmlEncoded(i.label),customData:[new s({key:"data",value:{oRepresentationType:i,icon:i.picture}})]});a.addItem(l)})}else{var l=r!==undefined?w.getTextNotHtmlEncoded("sortBy")+": "+r:"";var d=new y({description:l,icon:i.picture,title:w.getTextNotHtmlEncoded(i.label),customData:[new s({key:"data",value:{oRepresentationType:i,icon:i.picture}})]});a.addItem(d)}}if(!t.byId("idAllChartPopover")){var p=new m({id:t.createId("idAllChartPopover"),placement:b.Bottom,showHeader:false,content:[a],afterClose:function(){p.destroy()}})}t.byId("idAllChartPopover").openBy(n)}function W(e,t){e.byId("idReset").setVisible(t);e.byId("idSelPropertyAndCount").setVisible(t);e.byId("idSelectedText").setVisible(t)}return d.extend("sap.apf.ui.reuse.controller.stepContainer",{onInit:function(){var e=this;w=e.getView().getViewData().oCoreApi;R=e.getView().getViewData().uiApi;A=w.getActiveStep();this.initialText=new f({id:this.createId("idInitialText")}).addStyleClass("initialText");this.initialText.setText(w.getTextNotHtmlEncoded("initialText"))},onAfterRendering:function(){jQuery(R.getStepContainer().getDomRef()).hide();if(jQuery("#"+this.initialText.getId()).length===0&&w.getSteps().length===0){jQuery("#"+R.getStepContainer().getId()).parent().append(sap.ui.getCore().getRenderManager().getHTML(this.initialText))}else if(w.getSteps().length>0){jQuery(R.getStepContainer().getDomRef()).show()}if(R.getAnalysisPath().getController().isOpenPath){jQuery(".initialText").remove()}},getCurrentRepresentation:function(){var e=A.getSelectedRepresentation();if(E()){e=A.getSelectedRepresentation().toggleInstance}return e},handlePressSelectedPropertyCountLink:function(){this.openSelectionDisplayDialog()},openSelectionDisplayDialog:async function(){var e=this;e.oCoreApi=w;const t=await l.load({type:"JS",id:"idSelectionDisplayFragment",name:"sap.apf.ui.reuse.fragment.selectionDisplay",controller:e});t.open()},handleToggleDisplay:function(){var e=this;e.oCoreApi=w;var t=e.getCurrentRepresentation();var n=e.byId("idToggleDisplayButton");if(t.measures!==undefined){var a=t.getFormatStringForMeasure(t.measures[0]);if(t.type==="PieChart"){t.chart.setVizProperties({plotArea:{dataLabel:{visible:n.getPressed(),type:"percentage"}}})}else{t.chart.setVizProperties({plotArea:{dataLabel:{visible:n.getPressed(),formatString:a}}})}return t.chart.getVizProperties().plotArea.dataLabel.visible}var r=t.chartPlotArea.plotArea.dataLabel.visible;r=n.getPressed();return r},handlePressResetButton:function(){var e=this;if(E()){e.getCurrentRepresentation().removeAllSelection()}e.getCurrentRepresentation().removeAllSelection();W(e,false)},createToggleRepresentationInstance:function(e,n){var r={};function i(n){var a=n.dimensions;var r=e.getMetaData();n.isAlternateRepresentation=true;if(r===undefined){return n}var i,o;for(i=0;i<a.length;i++){var s=r.getPropertyMetadata(a[i].fieldName).hasOwnProperty("text");if(s&&a[i].labelDisplayOption===t.representationMetadata.labelDisplayOptions.KEY_AND_TEXT){o={};o.fieldName=r.getPropertyMetadata(a[i].fieldName).text;n.dimensions.splice(i+1,0,o)}else if(s&&a[i].labelDisplayOption===t.representationMetadata.labelDisplayOptions.TEXT){o={};o.fieldName=r.getPropertyMetadata(a[i].fieldName).text;n.dimensions.splice(i,1,o)}}return n}var o=a({},e.getParameter());delete o.alternateRepresentationTypeId;delete o.alternateRepresentationType;o=i(o);if(n){o.orderby=n}r=w.createRepresentation(e.getParameter().alternateRepresentationType.constructor,o);var s=e.getData(),l=e.getMetaData();if(s!==undefined&&l!==undefined){r.setData(s,l)}return r},handlePressAlternateRepIcon:function(){var e=this;var t=A.getSelectedRepresentation();t.bIsAlternateView=true;if(E()){t.toggleInstance=e.createToggleRepresentationInstance(t)}P=true;e.getView().getViewData().uiApi.selectionChanged(true)},handlePressChartIcon:function(e){var t=this;var n=A.getSelectedRepresentation();var a=w.getSteps().indexOf(A);var r=null;if(A.getRepresentationInfo().length>1){r=e.getParameter("controlReference");J(t,r)}else{n.bIsAlternateView=false;P=true;t.getView().getViewData().uiApi.selectionChanged(true);n.createDataset();t.drawStepContent();R.getAnalysisPath().getController().updateCustomListView(A,a,false)}},handleSelectionChartSwitchIcon:function(e){this.byId("idAllChartPopover").close();var t=A.getSelectedRepresentation();var n=e.getParameter("listItem").getCustomData()[0].getValue();var a=A.getSelectedRepresentationInfo().representationId;var r=n.oRepresentationType.representationId;if(a===r&&t.bIsAlternateView===false){return}P=true;t.bIsAlternateView=false;A.setSelectedRepresentation(n.oRepresentationType.representationId);R.getAnalysisPath().getController().refresh(n.nActiveStepIndex);w.updatePath(R.getAnalysisPath().getController().callBackForUpdatePath.bind(R.getAnalysisPath().getController()));t.createDataset()},drawStepContent:function(e,t){S.logCall("StepContainer.drawStepContent"," bStepUpdated="+e);var n=this;var a=false;var r=A;A=w.getActiveStep();if(A===undefined){S.logReturn("drawStepContent",", the active step === undefined");return}if(r!==A){a=true}if(e||P||a){q(n,A,t)}else{X(n)}P=false;n.initialText.destroy();n.byId("idStepLayout").setBusy(false);S.logReturn("drawStepContent",", bIsActiveStepChanged",a)}})},true);
//# sourceMappingURL=stepContainer.controller.js.map