/* SAP APF Analysis Path Framework
* 
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
sap.ui.define(["sap/apf/core/constants","sap/apf/ui/utils/constants","sap/apf/ui/utils/determineColumnSettingsForSpreadSheetExport","sap/apf/ui/utils/formatter","sap/apf/ui/representations/utils/paginationHandler","sap/apf/ui/representations/BaseUI5ChartRepresentation","sap/apf/ui/representations/utils/paginationDisplayOptionHandler","sap/ui/Device","sap/ui/model/BindingMode","sap/ui/model/Sorter","sap/ui/table/Table","sap/ui/table/Column","sap/ui/table/rowmodes/Fixed","sap/ui/table/rowmodes/Type","sap/ui/core/CustomData","sap/ui/model/json/JSONModel","sap/ui/core/Icon","sap/ui/core/library","sap/ui/core/mvc/View","sap/ui/layout/VerticalLayout","sap/m/Text","sap/m/Title","sap/m/Label","sap/m/library","sap/m/Link","sap/m/Button","sap/m/FlexItemData","sap/m/HBox","sap/m/VBox","sap/m/ScrollContainer","sap/ui/export/Spreadsheet","sap/m/Dialog","sap/ui/thirdparty/jquery"],function(e,t,a,i,n,o,r,s,l,p,d,u,h,c,g,f,m,v,b,y,A,T,F,x,D,w,S,P,C,E,R,I,jQuery){"use strict";var O=x.DialogType;var H=v.HorizontalAlign;var N=v.TitleLevel;function B(e,t){t.forEach(function(t){e.addSelectionInterval(t,t)})}function M(e){e.loadAllButton.attachEvent("setFocusOnLoadAllButtonEvent",e.loadAllButton.setFocusOnLoadAllButton)}function V(e,t){if(e.bIsAlternateRepresentation&&e.oApi.getActiveStep()){e.oApi.getActiveStep().getSelectedRepresentation().oRepresentationFilterHandler.getFilterValues().forEach(function(t){if(e.aFiltersInTable.indexOf(t)===-1){e.aFiltersInTable.push(t)}})}if(t&&e.oParameter.top||e.oParameter.isAlternateRepresentation){e.aFiltersInTable=L(e,t)}}function L(e,t){var a=[];e.aFiltersInTable.forEach(function(i){e.aDataResponse.forEach(function(e){var n=e[t];if(n==i&&a.indexOf(i)===-1){a.push(i)}})});return a}function k(e,t,a){var i=e.tableControl.getContextByIndex(a[0]).getProperty(t);if(e.tableControl.isIndexSelected(a[0])&&e.aFiltersInTable.indexOf(i)===-1){e.aFiltersInTable.push(i)}else{var n=e.aFiltersInTable.indexOf(i);if(n!==-1){e.aFiltersInTable.splice(n,1)}}}function U(e,t){q(e);e.aFiltersInTable=t;e.oApi.getActiveStep().getSelectedRepresentation().oRepresentationFilterHandler.updateFilterFromSelection(t);e.oApi.selectionChanged()}function q(e){e.oRepresentationFilterHandler.clearFilters();e.oApi.getActiveStep().getSelectedRepresentation().oRepresentationFilterHandler.clearFilters();e.aValidatedFilter=[];e.aFiltersInTable=[]}function W(e,t,a,i,n){var o=e.nDataResponseCount||0;var r,s;var l=e.oApi.getTextNotHtmlEncoded("buttonTextExport");var p=new w({text:l,press:function(){if(e.aDataResponse.length>1e4){var a=e;a.newOpenDialog=new I({type:O.Message,title:e.oApi.getTextNotHtmlEncoded("warningTitle"),state:"Warning",content:new A({text:e.oApi.getTextNotHtmlEncoded("exportWarning")}),beginButton:new w({text:e.oApi.getTextNotHtmlEncoded("warningExport"),press:function(){e.exportExcel(t);a.newOpenDialog.close()}}),endButton:new w({text:e.oApi.getTextNotHtmlEncoded("warningCancel"),press:function(){a.newOpenDialog.close()}}),afterClose:function(){a.oUiApi.getLayoutView().setBusy(false);a.newOpenDialog.destroy()}});a.newOpenDialog.open()}else{e.exportExcel(t)}}}).addStyleClass("sapUiTinyMarginBeginEnd");e.titleControl=new T({level:N.H1}).addStyleClass("sapUiTinyMarginBegin").addStyleClass("sapUiTinyMarginTop");if(e.aDataResponse.length===0){p.setEnabled(false)}if(n){s=e.title}else if(e.oParameter.top){r=new P({items:[p]});s=e.title}else if(i){r=new P({items:[p]});s=e.oApi.getTextNotHtmlEncoded("stepTitleWithNumberOfRecords",[e.title,a,a])}else{l=e.oApi.getTextNotHtmlEncoded("buttonTextLoadAll");if(e.loadAllButton===undefined){e.loadAllButton=new w({text:l,press:e.loadAll.bind(e)});e.loadAllButton.setFocusOnLoadAllButton=function(){this.focus();this.detachEvent("setFocusOnLoadAllButtonEvent",this.setFocusOnLoadAllButton)}}r=new P({items:[e.loadAllButton,p]});s=e.oApi.getTextNotHtmlEncoded("stepTitleWithNumberOfRecords",[e.title,a,o]);e.loadAllButton.addAriaLabelledBy(e.titleControl)}p.addAriaLabelledBy(e.titleControl);e.titleControl.setText(s);var d=new P({alignItems:"Start",wrap:"Wrap",justifyContent:"SpaceBetween",items:[e.titleControl,r]});return d}function j(e,t,a,i){var n=function(t){return function(i){if(a.metadata!==undefined){var n;if(e.value[t]&&i){n=a.oFormatter.getFormattedValueAsString(e.value[t],i);if(n!==undefined){return n}}}return i}};var o=new d({extension:[t],showNoData:false,enableSelectAll:false,rowMode:c.Auto});if(i){o.setWidth(i+"px")}o.setLayoutData(new S({growFactor:1}));if(s.system.desktop){o.addStyleClass("sapUiSizeCompact")}var r=a.oParameter.requiredFilters;var p=r&&r.length>0?"MultiToggle":"None";o.setSelectionMode(p);var h=[],m,v,b;for(var y=0;y<e.name.length;y++){m=new A({wrapping:false});m.bindText({path:e.value[y],formatter:n(y),bindingMode:l.OneWay});m.bindProperty("tooltip",{path:e.value[y],formatter:n(y)});v=new u({label:new F({text:e.name[y],tooltip:e.name[y]}),template:m});b=new g({value:{text:e.name[y],key:e.value[y]}});if(i){v.setMinWidth(125)}v.addCustomData(b);h.push(v)}var T;T=h;T.forEach(function(e){o.addColumn(e)});if(h.length>10){o.getColumns().forEach(function(e){e.setWidth("125px")})}var x=new f;x.setSizeLimit(1e4);var D=a.getData();x.setData({tableData:D});o.setModel(x);o.bindRows("/tableData");if(a.metadata!==undefined){for(var w=0;w<e.name.length;w++){var P=a.metadata.getPropertyMetadata(e.value[w]);if(P["aggregation-role"]==="measure"){var C=o.getColumns()[w];C.setHAlign(H.End)}}}return o}function _(e){var t=e.getData();var a=[],i;var n={name:[],value:[]};a=e.oParameter.dimensions.concat(e.oParameter.measures).length?e.oParameter.dimensions.concat(e.oParameter.measures):e.parameter.properties;if(t.length!==0){for(var o=0;o<a.length;o++){n.value[o]=a[o].fieldName;var r=e.metadata.getPropertyMetadata(a[o].fieldName).label||e.metadata.getPropertyMetadata(a[o].fieldName).name;var s="";if(e.metadata!==undefined&&e.metadata.getPropertyMetadata(a[o].fieldName).unit!==undefined){var l=e.metadata.getPropertyMetadata(a[o].fieldName).unit;s=e.getData()[0][l];for(i=0;i<e.getData().length;i++){if(s!==e.getData()[i][l]){s=undefined;break}}n.name[o]=a[o].fieldDesc===undefined||!e.oApi.getTextNotHtmlEncoded(a[o].fieldDesc).length?r:e.oApi.getTextNotHtmlEncoded(a[o].fieldDesc);if(s!==undefined&&s!==""){n.name[o]=e.oApi.getTextNotHtmlEncoded("displayUnit",[n.name[o],s])}}else{n.name[o]=a[o].fieldDesc===undefined||!e.oApi.getTextNotHtmlEncoded(a[o].fieldDesc).length?r:e.oApi.getTextNotHtmlEncoded(a[o].fieldDesc)}}}return n}function z(e){var t;var a=e.getSelectedSortItem();e.getSortItems().forEach(function(e){if(e.getId()===a){t=e.getKey()}});return t}var J=function(e,a){this.oViewSettingDialog=undefined;this.aDataResponse=[];this.aValidatedFilter=[];this.aFiltersInTable=[];this.oParameter=a;this.orderby=a.orderby;this.omitTopAndSkipOptionsForNextPathUpdate=false;o.apply(this,[e,a]);this.alternateRepresentation=a.alternateRepresentationType;this.type=t.representationTypes.TABLE_REPRESENTATION;this.oPaginationHandler=new n(this);this.oPaginationDisplayOptionHandler=new r;this._drawSelection=function(e){var t=this.oParameter.requiredFilters;var a=t&&t.length>0?t[0]:undefined;var i=e.getParameter("userInteraction");var n=e.getParameter("rowIndices");if(!i||n.length===0){return}if(e.getSource().getFocusDomRef()&&e.getSource().getFocusDomRef().offsetTop!==0){this.nFirstVisibleRow=this.tableControl.getFirstVisibleRow()}k(this,a,n);var o=jQuery.unique(this.aFiltersInTable);U(this,o)};this._handleSelectionEvent=function(e){this._drawSelection(e)};this._getSelectedIndicesInTable=function(e){var t=this;var a=[];t.aDataResponse.forEach(function(i,n){var o=i[e];if(t.aFiltersInTable.indexOf(o)!==-1){a.push(n)}});return a}};J.prototype=Object.create(o.prototype);J.prototype.constructor=J;J.prototype.setData=function(e,t,a,n){var o=this;var r,s;if(!t){var l=this.oApi.createMessageObject({code:"6004",aParameters:[this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(l)}this.metadata=t;this.oFormatter=new i({getEventCallback:this.oApi.getEventCallback.bind(this.oApi),getTextNotHtmlEncoded:this.oApi.getTextNotHtmlEncoded,getExits:this.oApi.getExits()},this.metadata,this.aDataResponse);if(this.oParameter.requiredFilters.length>0){r=this.oParameter.requiredFilters[0];s=t.getPropertyMetadata(r).text}if(!this.oParameter.isAlternateRepresentation){if(r){this.aValidatedFilter=[];if(n&&n.length>0){n.forEach(function(e){o.aValidatedFilter.push(e[r]);o.oPaginationDisplayOptionHandler.createDisplayValueLookupForPaginatedFilter(e[r],e[s])});o.aFiltersInTable=o.aValidatedFilter}else{o.aFiltersInTable=[]}}var p=this.getRequestOptions();var d=p.paging&&p.paging.skip;this.nDataResponseCount=a;if(d===undefined||d===0){this.aDataResponse=e}else{e.map(function(e){o.aDataResponse.push(e)})}if(!this.oParameter.top&&this.titleControl){var u=this.aDataResponse&&this.aDataResponse.length||0;var h=this.oApi.getTextNotHtmlEncoded("stepTitleWithNumberOfRecords",[this.title,u,a]);this.titleControl.setText(h)}}else{this.aDataResponse=e}if(s){this.aDataResponse.forEach(function(e){o.oPaginationDisplayOptionHandler.createDisplayValueLookupForPaginatedFilter(e[r],e[s])})}};J.prototype.getFilter=function(){this.filter=this.oRepresentationFilterHandler.createFilterFromSelectedValues(this.aFiltersInTable);return this.filter};J.prototype.getSelections=function(){var e=this,t=[],a;var i=e.parameter.requiredFilters[0];V(e,i);e.aFiltersInTable.forEach(function(n){a=e.oPaginationDisplayOptionHandler.getDisplayNameForPaginatedFilter(n,e.parameter.requiredFilterOptions,i,e.oFormatter,e.metadata);t.push({id:n,text:a})});return t};J.prototype.markSelectionInTable=function(e){var t=this.oParameter.requiredFilters?this.oParameter.requiredFilters[0]:undefined;if(t){var a=this._getSelectedIndicesInTable(t);if(this.oParameter.isAlternateRepresentation){var i=[];var n=this.tableControl.getBinding().aIndices;a.forEach(function(e){i.push(n.indexOf(e))});a=i}this.tableControl.clearSelection();if(a.length>0){B(this.tableControl,a)}}};J.prototype.getRequestOptions=function(e,t){this.bIsAlternateRepresentation=t;if(e){this.oPaginationHandler.resetPaginationOption()}var a={paging:{},orderby:[]};if(e){this.omitTopAndSkipOptionsForNextPathUpdate=false}if(this.omitTopAndSkipOptionsForNextPathUpdate){a.paging={inlineCount:true}}else if(!this.bIsAlternateRepresentation){a.paging=this.oPaginationHandler.getPagingOption(this.oParameter.top)}if(this.orderby){a.orderby=this.orderby}if(this.oViewSettingDialog){var i=z(this.oViewSettingDialog);if(i){var n={property:z(this.oViewSettingDialog),ascending:!this.oViewSettingDialog.getSortDescending()};this.orderby=[n];a.orderby=[n]}}return a};J.prototype.resetPaginationForTable=function(){this.omitTopAndSkipOptionsForNextPathUpdate=false;this.oPaginationHandler.resetPaginationOption()};J.prototype.getMainContent=function(e,t,a){var i=this;var n=this.getData();this.title=e;var o=this.oParameter.dimensions.concat(this.oParameter.measures).length?this.oParameter.dimensions.concat(this.oParameter.measures):this.oParameter.properties;var r=_(this);var s;if(!e){s=this.oApi.createMessageObject({code:"6002",aParameters:["title",this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(s)}if(o.length===0){s=this.oApi.createMessageObject({code:"6002",aParameters:["dimensions",e]});this.oApi.putMessage(s)}if(!n||n.length===0){s=this.oApi.createMessageObject({code:"6000",aParameters:[e]});this.oApi.putMessage(s)}var l;if(this.oParameter.isAlternateRepresentation){l=W(this,e,n.length,true,t)}else{l=W(this,e,n.length,false,t)}this.tableControl=j(r,l,this,t);this.tableControl.addAriaLabelledBy(l.getItems()[0]);this.tableControl.addEventDelegate({onAfterRendering:function(){if(i.oParameter){i.markSelectionInTable(true);if(i.loadAllButton){i.loadAllButton.fireEvent("setFocusOnLoadAllButtonEvent")}if(!i.oParameter.top&&!i.oParameter.isAlternateRepresentation&&i.nDataResponseCount>100){i.oPaginationHandler.attachPaginationOnTable(i)}}}});this.tableControl.attachRowSelectionChange(this._handleSelectionEvent.bind(this));this.oLoadMoreLink=new D({text:this.oApi.getTextNotHtmlEncoded("moreIcon"),visible:false});var p=new C({fitContainer:true,items:[this.tableControl,this.oLoadMoreLink]}).addStyleClass("tableRepresentation");if(a){p.setHeight(a+"px")}return p};J.prototype.getThumbnailContent=function(){var e;var t=this.getData();var a=this.oParameter.isAlternateRepresentation?"sap-icon://table-view":"sap-icon://table-chart";if(t!==undefined&&t.length!==0){var i=new m({src:a,size:"70px"}).addStyleClass("thumbnailTableImage");e=i}else{var n=new A({text:this.oApi.getTextNotHtmlEncoded("noDataText")}).addStyleClass("noDataText");e=new y({content:n})}return e};J.prototype.removeAllSelection=function(){q(this);this.tableControl.clearSelection();this.oApi.selectionChanged()};J.prototype.getPrintContent=function(e){var t=this.tableControl.clone();t.getColumns().forEach(function(e){e.setWidth("auto");e.getTemplate().setWrapping(true)});var a=this.tableControl.getSelectedIndices();t.setRowMode(new h({rowCount:t.getModel().getData().tableData.length}));t.onAfterRendering=function(){a.forEach(function(e){t.getRows()[e].getDomRef().classList.add("sapTableSelectionForPrint")})};var i={oRepresentation:t};return i};J.prototype.getViewSettingDialog=async function(){if(!this.oViewSettingDialog){var e={oTableInstance:this};var t=await b.create({viewName:"module:sap/apf/ui/reuse/view/viewSetting.view",viewData:e});this.oViewSettingDialog=t.getContent()[0];this.oViewSettingDialog.addStyleClass("sapUiSizeCompact")}return this.oViewSettingDialog};J.prototype.loadAll=function(){this.omitTopAndSkipOptionsForNextPathUpdate=true;if(this.loadAllButton){M(this)}this.oApi.selectionChanged()};J.prototype.exportExcel=function(e){var t=this;function i(){var e=_(t);var i=[];var n,o;for(n=0;n<e.value.length;n++){o=a(e.value[n],t.metadata);o.property=e.value[n];o.label=e.name[n];i.push(o)}return i}var n=this.getData();var o=i();var r={workbook:{columns:o},dataSource:n,fileName:e+".xlsx"};var s=new sap.ui.export.Spreadsheet(r);s.build()};J.prototype.onChartSwitch=function(){this.resetPaginationForTable()};J.prototype.destroy=function(){if(this.orderby){this.orderby=null}if(this.oParameter){this.oParameter=null}if(this.oViewSettingDialog){this.oViewSettingDialog.destroy()}if(this.aDataResponse){this.aDataResponse=null}if(this.aValidatedFilter){this.aValidatedFilter=[]}if(this.aFiltersInTable){this.aFiltersInTable=[]}o.prototype.destroy.call(this)};return J},true);
//# sourceMappingURL=table.js.map