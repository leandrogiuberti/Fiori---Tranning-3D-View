/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
sap.ui.define(["sap/viz/ui5/controls/VizFrame","sap/viz/ui5/controls/common/feeds/FeedItem","sap/apf/ui/representations/BaseUI5ChartRepresentation","sap/apf/ui/representations/utils/vizFrameSelectionHandler","sap/apf/ui/utils/representationTypesHandler","sap/apf/ui/utils/constants","sap/apf/core/constants","sap/apf/utils/trace"],function(e,t,i,a,r,s,n,o){"use strict";var l=" ************************************** ";var h=function(e,t){i.apply(this,[e,t]);this.oApi=e};h.prototype=Object.create(i.prototype);h.prototype.constructor=h;h.prototype.destroy=function(){if(this.chart){this.chart.destroyDataset();this.chart.destroyFeeds();this.chart.detachRenderComplete(this.fnDrawSelectionOnMainChart);this.fnDrawSelectionOnMainChart=null}if(this.thumbnailChart){this.thumbnailChart.destroyDataset();this.thumbnailChart.destroyFeeds();this.thumbnailChart.detachRenderComplete(this.fnDrawSelectionOnThumbnailChart);this.fnDrawSelectionOnThumbnailChart=null}i.prototype.destroy.call(this)};h.prototype.getMeasures=function(){return this.measures};h.prototype.getChartForCustomListItem=function(){o.logCall("getChartForCustomListItem");if(!this.chart4CustomItemList){var e=this.getMainContent("#chartForCustomListItem#",null,null,"isCreate4CIL");this.chart=undefined;this.title=undefined;this.chart4CustomItemList=e}o.logReturn("getChartForCustomListItem"," return=",this.chart4CustomItemList);return this.chart4CustomItemList};h.prototype.getMainContent=function(t,i,a,r){o.logCall("BaseVizFrame.getMainContent"," apfId=",this.apfId,", creationMode"+r);var s=r==="isCreate4CIL";var n=this;var l=this;var h=(a||725)+"px";var p=i||1e3;p=p+"px";this.title=t;this.createDataset();if(!this.chart){this.chart=new e({vizType:this.chartType,dataset:this.dataset,width:p,height:h,uiConfig:{applicationSet:"fiori"}});o.log(""," *** new VizFrame ***",t,", chartType="+this.chartType,", chart=",this.chart);this.setVizPropertiesOnChart(this.metadata);if(this.metadata){this._createAndAddFeedItemBasedOnId(this.chart);if(this.measures.length!==0){var c={};var u;this.measures.forEach(function(e){var t=l.getFormatStringForMeasure(e);u=l.getFormatStringForMeasureTooltip(e);c.measure=e;c.formatString=t;n.setFormatStringOnChart(c)});this.setFormatString("tooltip",u);if(this.handleCustomFormattingOnChart){this.handleCustomFormattingOnChart()}}}if(!s){this.fnDrawSelectionOnMainChart=this.drawSelectionOnMainChart.bind(n);this.chart.attachRenderComplete(this.fnDrawSelectionOnMainChart);l.attachSelectionAndFormatValue.call(this,t)}}else{if(i){this.chart.setWidth(p)}if(a){this.chart.setHeight(h)}this.chart.destroyDataset();this.chart.removeAllFeeds();this.chart.destroyFeeds();this.chart.vizUpdate({data:this.dataset});this._createAndAddFeedItemBasedOnId(this.chart)}this.chart.setModel(this.oModel);o.logReturn("BaseVizFrame.getMainContent");return this.chart};h.prototype.setVizPropertiesOnChart=function(e){var t={behaviorType:null};if(this.parameter.requiredFilters.length===0){t={selectability:{axisLabelSelection:false,legendSelection:false,plotLassoSelection:false,plotStdSelection:false},enableHover:false,noninteractiveMode:false,behaviorType:null}}this.chart.setVizProperties({title:{visible:true,text:this.title},interaction:t,categoryAxis:{visible:true,title:{visible:true},label:{visible:true}},valueAxis:{visible:true,title:{visible:true},label:{visible:true}},legend:{visible:true,title:{visible:true},isScrollable:true},plotArea:{window:{start:null},dataLabel:{visible:false,unitFormatType:"measureFormatter",hideWhenOverlap:true}},tooltip:{visible:true,label:{visible:true}},general:{groupData:false}});this.setVizPropsForSpecificRepresentation();var i=new r;if(i.isCombinationChart(this.type)){this.chart.setVizProperties(this.getVizPropertiesForCombinationCharts(i))}};h.prototype.getVizPropertiesForCombinationCharts=function(e){var t=[];var i=[];this.measures.forEach(function(a){if(!a.measureDisplayOption){return}if(a.kind===e.getKindsForMeasurePropertyType(this.type)[0]){t.push(a.measureDisplayOption)}if(a.kind===e.getKindsForMeasurePropertyType(this.type)[1]){i.push(a.measureDisplayOption)}}.bind(this));var a={plotArea:{dataShape:{}}};if(t.length>0){a.plotArea.dataShape.primaryAxis=t}if(i.length>0){a.plotArea.dataShape.secondaryAxis=i}return a};h.prototype.setVizPropsForSpecificRepresentation=function(){};h._setVizPropsForBubbleAndScatter=function(e,t){o.log("_setVizPropsForBubbleAndScatter",", dimensions",e);var i={valueAxis2:{visible:t,title:{visible:t}},sizeLegend:{visible:t},plotArea:{adjustScale:true}};if(!t){i.plotArea.markerSize=4;i.plotArea.marker={visible:true,size:4}}else{i.valueAxis2.label={visible:true}}var a=0;var r=0;e.forEach(function(e){if(e.kind===n.representationMetadata.kind.REGIONCOLOR){a++}else if(e.kind===n.representationMetadata.kind.REGIONSHAPE){r++}});if(a>0){i.plotArea.colorDepth=a}if(r>0){i.plotArea.shapeDepth=r}return i};h.prototype.setFormatStringOnChart=function(e){var t=e.formatString;var i=e.measure.axisfeedItemId;this.setFormatString(i,t)};h.prototype.setFormatString=function(e,t){var i=this;var a=i.getIsAllMeasureSameUnit();switch(e){case n.vizFrame.feedItemTypes.VALUEAXIS:if(a){this.chart.setVizProperties({valueAxis:{label:{formatString:t}}})}break;case n.vizFrame.feedItemTypes.VALUEAXIS2:if(a){this.chart.setVizProperties({valueAxis2:{label:{formatString:t}}})}break;case n.vizFrame.feedItemTypes.CATEGORYAXIS:this.chart.setVizProperties({categoryAxis:{label:{formatString:t}}});break;case n.vizFrame.feedItemTypes.BUBBLEWIDTH:this.chart.setVizProperties({sizeLegend:{formatString:t}});break;case"tooltip":this.chart.setVizProperties({tooltip:{formatString:t}});break;default:break}};h.prototype._createAndAddFeedItemBasedOnId=function(e){var t=this._createFeedItemGroup(this.parameter.measures);this._addFeedItemsToChart(e,t,"Measure");var i=this._createFeedItemGroup(this.parameter.dimensions);this._addFeedItemsToChart(e,i,"Dimension")};h.prototype._createFeedItemGroup=function(e){var t=this;var i={};e.forEach(function(e){e.axisfeedItemId=t.getAxisFeedItemId(e.kind);var a=i[e.axisfeedItemId];if(a){var r=a.some(function(t){return t.identity===e.identity});if(!r){a.push(e)}}else{i[e.axisfeedItemId]=[e]}});return i};h.prototype.manageSelectionsOnChart=function(e,t,i){o.logCall("BaseVizFrame.manageSelectionsOnChart",l,", is deselection",t,", oParameter: ",i);var r=new a.constructor(i,this.oApi);var s=this.chart.vizSelection();var n=r.getSelectionInfoFromEvent(e,t,s);this.setSelectionOnMainChart(n.dataPointsFromSelection,t);this.setSelectionOnThumbnailChart(n.dataPointsFromSelection,t);if(this.oRepresentationFilterHandler.getIfSelectedFilterChanged(n.aUniqueFilterValueFromChart)){o.logCall("...manageSelectionsOnChart, selected filter changed",", aUniqueFilterValueFromChart: ",n.aUniqueFilterValueFromChart);this.oRepresentationFilterHandler.updateFilterFromSelection(n.aUniqueFilterValueFromChart);this.oApi.selectionChanged(false)}o.logReturn("BaseVizFrame.manageSelectionsOnChart")};h.prototype._addFeedItemsToChart=function(e,i,a){for(var r in i){var s={};var n=[];var o=0;for(o in i[r]){n.push(i[r][o].identity);s.feedItemId=i[r][0].axisfeedItemId}s.value=n;var l=new t({uid:s.feedItemId,type:a,values:s.value});e.addFeed(l)}};h.prototype.setVizPropertiesOnThumbnailChart=function(){if(!this.thumbnailChart){return}this.thumbnailChart.setVizProperties({title:{visible:false},categoryAxis:{visible:false,title:{visible:false}},valueAxis:{visible:false,title:{visible:false}},legend:{visible:false,title:{visible:false}},tooltip:{visible:false},interaction:{selectability:{axisLabelSelection:false,legendSelection:false,plotLassoSelection:false,plotStdSelection:false},enableHover:false,noninteractiveMode:true},background:{visible:false},general:{layout:{padding:0},groupData:false},plotArea:{window:{start:null},gridline:{visible:false},dataLabel:{visible:false},seriesStyle:{rules:[{properties:{width:1}}]}}});this.setVizPropsOfThumbnailForSpecificRepresentation();var e=new r;if(e.isCombinationChart(this.type)){this.thumbnailChart.setVizProperties(this.getVizPropertiesForCombinationCharts(e))}};h.prototype.setVizPropsOfThumbnailForSpecificRepresentation=function(){};h.prototype.setSelectionOnMainChart=function(e,t){o.log("BaseVizFrame.setSelectionOnMainChart",", aSelection=",e," apfId=",this.apfId,", bIsDeselection="+t,"chart.sId"+this.chart.sId);this.chart.vizSelection(e,{clearSelection:t})};h.prototype.setSelectionOnThumbnailChart=function(e,t){o.log("BaseVizFrame.setSelectionOnThumbnailChart",", aSelection=",e," apfId=",this.apfId,", bIsDeselection="+t,"thumbnailChart.sId"+!this.thumbnailChart?"-":this.thumbnailChart.sId);if(this.thumbnailChart){this.thumbnailChart.vizSelection(e,{clearSelection:t})}};h.prototype.getAxisFeedItemId=function(e){};h.prototype.getPrintContent=function(e){var t,i=this.chartType,a={},r,s;var n=this.getMainContent(e);a=n.getVizProperties();t=n.clone();t.setVizType(i);t.setVizProperties(a);t.setWidth("1000px");t.setHeight("600px");this.createDataset();t.setDataset(this.dataset);t.setModel(this.oModel);r=this.chart.vizSelection();t.attachRenderComplete(function(){t.vizSelection(r)});s={oRepresentation:t};return s};return h},true);
//# sourceMappingURL=BaseVizFrameChartRepresentation.js.map