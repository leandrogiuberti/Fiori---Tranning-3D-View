/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/core/constants","sap/apf/ui/representations/utils/displayOptionHandler","sap/apf/utils/exportToGlobal","sap/apf/utils/utils","sap/base/util/deepExtend","sap/ui/model/json/JSONModel","sap/viz/ui5/data/FlattenedDataset"],function(t,e,a,i,n,r,o){"use strict";function s(t,a){this.oFormatter=t;this.aDataResponseWithDisplayValue=[];this.oDisplayOptionHandler=new e;this.oTimeAxisDateConverter=a;this.oChartDataSet={}}s.getFieldNameForOriginalContentOfProperty=function(t){return"original_"+t};function l(t,e){var a=t.map(function(t){return t.fieldName});return a.indexOf(e)===-1?true:false}function p(t){var e=t.dimensions.concat(t.measures),a;e.forEach(function(t){for(a in t){if(a!=="name"&&a!=="value"&&a!=="dataType"&&a!=="displayValue"&&a!=="identity"){delete t[a]}}})}function d(e,a,r,o){var l=n([],o);var p,d={};e.oTimeAxisDateConverter.createPropertyInfo(a.dimensions);var u=a.dimensions.concat(a.requiredFilters);u.forEach(function(n,o){var u=a.requiredFilterOptions?a.requiredFilterOptions.labelDisplayOption:undefined;var f=n.labelDisplayOption?n.labelDisplayOption:u;var h=n.fieldName?n.fieldName:n;if(f===undefined||f===t.representationMetadata.labelDisplayOptions.TEXT){return l}l.forEach(function(a,o){a[h]=a[h]===null||a[h]===undefined?a[h]:a[h].toString();if(f===t.representationMetadata.labelDisplayOptions.KEY){p="formatted_"+h;if(!l[o][p]){l[o][p]=e.oFormatter.getFormattedValue(h,l[o][h])}}if(f===t.representationMetadata.labelDisplayOptions.KEY_AND_TEXT){var u=r.getPropertyMetadata(h).text;p=h+"_"+u;var m={text:l[o][u],key:l[o][h]};l[o][p]=e.oFormatter.getFormattedValueForTextProperty(h,m)}if(e.oTimeAxisDateConverter.bIsConversionToDateRequired(n.fieldName,r)){var D=a[h];var y=s.getFieldNameForOriginalContentOfProperty(h);if(a[y]){d[D]=a[y]}else{var c=i.convertFiscalYearMonthDayToDateString(D)+"";d[c]=D;a[h]=c;a[y]=D}}})});e.oTimeAxisDateConverter.setConvertedDateLookUp(d);return l}s.prototype.constructor=s;s.prototype.createFlattenDataSet=function(t,e,a,i){var r=this;this.aDataResponseWithDisplayValue=d(this,t,e,a);t.dimensions.forEach(function(t,a){t.name=r.oDisplayOptionHandler.getDisplayNameForDimension(t,e,i);t.value="{"+t.fieldName+"}";t.identity=t.fieldName;t.displayValue="{"+r.oDisplayOptionHandler.getColumnNameBasedOnDisplayOption(t.fieldName,t.labelDisplayOption,e)+"}"});t.measures.forEach(function(t){t.name=r.oDisplayOptionHandler.getDisplayNameForMeasure(t,e,a,i);t.value="{"+t.fieldName+"}";t.identity=t.fieldName});var o={dimensions:t.dimensions,measures:t.measures};var s=t.requiredFilters[0];this.oChartDataSet=n({},o);this.oChartDataSet.context=[];p(this.oChartDataSet);if(s&&l(t.dimensions,s)){this.oChartDataSet.context.push(s);this.oChartDataSet.dimensions.push({name:s,value:"{"+s+"}",identity:s})}this.oChartDataSet.data={path:"/data"}};s.prototype.addUnusedDimensionsToChartContext=function(t,e){if(e.length===0){return}var a=[];this.oChartDataSet.dimensions.forEach(function(e){var i=e.identity;a.push(i);var n=t.getPropertyMetadata(i).text;if(n){a.push(n)}});this.oChartDataSet.measures.forEach(function(t){a.push(t.identity)});var i=Object.keys(e[0]);i.forEach(function(e){if(a.indexOf(e)>=0||e==="__metadata"){return}var i=t.getPropertyMetadata(e);if(i&&i["aggregation-role"]==="measure"){return}this.addPropertyToContext(e,i)}.bind(this))};s.prototype.addPropertyToContext=function(t,e){var a=e&&e.label?e.label:t;this.oChartDataSet.context.push(t);this.oChartDataSet.dimensions.push({name:a,value:"{"+t+"}",identity:t})};s.prototype.getFlattenDataSet=function(){return new o(this.oChartDataSet)};s.prototype.getModel=function(){var t=new r({data:this.aDataResponseWithDisplayValue});return t};a("sap.apf.ui.representations.utils.ChartDataSetHelper",s);return s});
//# sourceMappingURL=chartDataSetHelper.js.map