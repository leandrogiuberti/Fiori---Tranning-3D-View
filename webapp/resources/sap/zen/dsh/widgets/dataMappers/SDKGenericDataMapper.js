/*!
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/base/Log","sap/sac/df/thirdparty/lodash","sap/zen/dsh/utils/BaseHandler","sap/zen/dsh/widgets/dataMappers/SDKChartDataMapper","sap/zen/dsh/widgets/charts/ChartException"],function(jQuery,e,a,n,i,t){"use strict";e.info("Loaded SDKGenericDataMapper");function s(){i.apply(this,arguments);this.createAnalysisAxis=function(e){var a=new r(this,e,false);var n=new r(this,e,true);var i=a.toAnalysisAxisData();var t=n.toAnalysisAxisData();var u=[{name:"",type:"Dimension",values:[""]}];var l=[];var o=s(this,e);if(!o.isAa1DimensionRequired){l=[];if(i.length){l.push({index:1,data:i})}if(t.length){l.push({index:l.length+1,data:t})}if(l.length===0){l=[{index:1,data:u}]}}else if(t.length===0&&this.getMeasureAxis()==="COLUMNS"){l=[{index:1,data:i.length?i:u}]}else{l=[{index:1,data:t.length?t:u}];if(i.length){l.push({index:2,data:i})}else if(o.isAa2DimensionRequired){l.push({index:2,data:u})}}return l};this.createMeasureValues=function(i,u){var l=[];var o=this.getUtilsHelper();var h=this.indexOfMeasuresDimension(i.dimensions);var f=i.dimensions[h];var d=i.newChartOptionsProperties;var v=this;if(i.externalDimensions!==undefined&&this.indexOfMeasuresDimension(i.externalDimensions)!==-1){var p=i.externalDimensions[this.indexOfMeasuresDimension(i.externalDimensions)];l.push({type:"Measure",name:p.members[0].text,values:n(i.data.slice(0),u[0].data[0].values.length),key:p.members[0].key})}else if(i.data&&i.data.length>0&&f.isFake){l.push({type:"Measure",name:"",values:n(i.data.slice(0),u[0].data[0].values.length),key:""})}else{var g=e(i,f,h);var m=g.map(function(e){return e.key});var c=o.allChartOptionsMeasures(d);for(var x=0;x<c.length;x++){if(jQuery.inArray(c[x],m)<=-1){throw new t(i.messages.feedingerror,"")}}g.forEach(function(e){l.push({type:"Measure",name:e.text,values:[],key:e.key,initialIndex:e.initialIndex})});var M=new r(this,i,false);var y=new r(this,i,true);var A=s(this,i);var w=0;i.data.forEach(function(e,n){var t=i.tuples[n];var s=M.getIndexOnAxis(t);var r=y.getIndexOnAxis(t);var u=t[h];var o=a.find(l,{initialIndex:u});var f;if(y.isEmpty()&&v.getMeasureAxis()==="COLUMNS"){r=s;s=0}else if(!A.isAa1DimensionRequired&&!M.isEmpty()){f=s;s=r;r=f}o.values[s]=o.values[s]||[];o.values[s][r]=e;w=Math.max(w,o.values[s].length)});a.forEach(l,function(e){e.values=a.map(e.values,function(e){var a=e||[];for(var n=0;n<w;n++){if(a.length<=n){a.push(null)}else if(a[n]===undefined){a[n]=null}}return a})})}var _=o.getMetadataFeedsArray(i.cvomType,"Measure");var b=[];if(c&&!o.isChartFeedsEmpty(d)){for(x=0;x<c.length;x++){var O=jQuery.inArray(c[x],m);b.push(l[O])}if(b.length>0){l=b}}var D=this.getMeasureAxis();var I=this.getMessages().chart_mapping_error+".";if(i.cvomType==="viz/scatter"&&l.length<2){if(D==="COLUMNS")throw new t(I,this.getMessages().scatter_datamapping_cmd);else throw new t(I,this.getMessages().scatter_datamapping_rmd)}if(i.cvomType==="viz/bubble"&&l.length<3){if(D==="COLUMNS")throw new t(I,this.getMessages().bubble_datamapping_cmd);else throw new t(I,this.getMessages().bubble_datamapping_rmd)}var E;if(i.dualAxis){var C;if(this.getMeasureAxis()=="COLUMNS"){var z=i.cvomType;if(z=="viz/dual_line")C=this.getMessages().dualline_datamapping_tmd;if(z=="viz/dual_column"||z=="viz/dual_combination")C=this.getMessages().dualcolumn_datamapping_tmd;if(z=="viz/dual_horizontal_combination")C=this.getMessages().dualhorizontal_datamapping_tmd;if(z=="viz/dual_bar")C=this.getMessages().dualbar_datamapping_tmd}if(C!==undefined&&(!i.newChartOptionsProperties||!i.newChartOptionsProperties.feeds)){throw new t(I,C)}E=i.dualAxis}else if(i.newChartOptionsProperties&&i.newChartOptionsProperties.feeds){E=this.generateAxisMapping(i.newChartOptionsProperties.feeds,_)}var k=a.partial(a.omit,a,"initialIndex");l=a.map(l,k);if(E){return this.groupMeasureObjectsByAxisMapping(l,E,_)}else{return this.groupMeasureObjectsAutomatically(l,_)}};this.groupMeasureObjectsAutomatically=function(e,a){var n=[];for(var i=0;i<a.length;i++){var t=[];if(a.length!==i+1){while(e.length&&t.length<(a[i].min||1)){t.push(e.shift())}}else{while(e.length&&t.length<a[i].max){t.push(e.shift())}}n.push({index:i+1,data:t})}return n};this.groupMeasureObjectsByAxisMapping=function(e,a,n){var i=[];for(var t=0;t<n.length;t++){i[n[t].mgIndex-1]={index:n[t].mgIndex,data:[]}}for(var s=0;s<a.length&&s<e.length;s++){var r=e[s];var u=a[s];if(typeof u!=="string"){u=u[1]}var l=u.slice(u.length-1);l=l-1;i[l].data.push({name:r.name,type:r.type,values:r.values})}return i};this.indexOfMeasuresDimension=function(e){for(var a=0;a<e.length;a++){var n=e[a];if(n.containsMeasures===true){return a}}return-1};this.generateAxisMapping=function(e,n){var i=[];var t=[];for(var s in e){for(var r=0;r<e[s].length;r++){for(var u=0;u<n.length;u++){if(n[u].id==s||n[u].id==s.replace(/_/g,".")){t.push({index:n[u].mgIndex,axisArray:["stub","axis"+n[u].mgIndex,e[s][r]]})}}}}t=a.sortBy(t,"index");a.forEach(t,function(e){i.push(e.axisArray)});return i};function e(e,n,i){var t=[];var s={},r;if(n.axis==="ROWS"){r=e.axis_rows}else{r=e.axis_columns}r.forEach(function(e){var r=n.members[e[i]];var u;if(!s[r.key]){u=a.clone(r);u.initialIndex=e[i];t.push(u);s[r.key]=true}});return t}function n(e,a){var n=[];while(e.length){n.push(e.splice(0,a))}return n}function s(e,a){var n=e.getUtilsHelper().getMetadataFeedsArray(a.cvomType,"Dimension");var i;var t;for(var s=0;s<n.length;s++){if(n[s].aaIndex===1){i=n[s]}if(n[s].aaIndex===2){t=n[s]}if(i!==undefined&&t!==undefined){break}}return{isAa1DimensionRequired:!(i&&i.min===0),isAa2DimensionRequired:t&&t.min>0}}function r(e,n,i){var t=i?n.axis_columns:n.axis_rows;var s=n.dimensions;var r=e.indexOfMeasuresDimension(s);var u=[];var l=[];if(t.length){a.forEach(t[0],function(e,a){if(e!=-1&&a!=r){l.push(a)}})}var o=a.map(t,g);u=a.uniq(u);if(u.length&&o.length&&o[0].length){var h={};a.forEach(o,function(e){var n=a.map(e,"dimensionIndex");h[n]=h[n]||[];h[n].push(e[0].measureIndex)});a.forEach(h,function(e,n){var i=a.difference(u,e);a.forEach(i,function(e){f(n,e)})})}o=a.uniq(o,false,function(e){var n=a.map(e,"value");return n.toString()});this.toAnalysisAxisData=function(){var e=[];a.forEach(o,function(n){a.forEach(n,function(a,n){e[n]=e[n]||{type:"Dimension",name:a.name,values:[]};e[n].values.push(a.dimensionValue.text)})});return e};this.getIndexOnAxis=function(e){var a=g(e);var n=-1;for(var i=0;i<o.length&&n===-1;i++){if(v(a,o[i])){n=i}}return n};this.isEmpty=function(){return!o.length||!o[0].length};function f(e,n){var i=[];a.forEach(e,function(e){i.push(d(null,e,n))})}function d(e,a,n){return{dimensionIndex:a,dimensionValue:s[a].members[e],measureIndex:n,name:s[a].text,value:e}}function v(e,a){return e&&a&&p(e,a)===0}function p(e,a){var n=0;for(var i=0;i<e.length&&n===0;i++){if(e[i].value<a[i].value){n=-1}else if(e[i].value>a[i].value){n=1}}return n}function g(e){var n=e[r];if(n>=0){u.push(n)}return a.chain(e).map(function(e,a){return d(e,a,n)}).filter(function(e,n){return a.includes(l,n)}).value()}}}return s});
//# sourceMappingURL=SDKGenericDataMapper.js.map