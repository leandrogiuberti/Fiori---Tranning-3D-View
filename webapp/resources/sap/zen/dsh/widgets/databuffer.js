/*
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/sac/df/thirdparty/lodash","sap/zen/dsh/utils/BaseHandler","sap/zen/dsh/widgets/datasource","sap/zen/dsh/widgets/component"],function(jQuery,e,r,t,n){"use strict";var i=function(r,n){t.call(this,r);var i={data:[],formattedData:[],tuples:[],axis_columns:[],axis_rows:[],dimensions:[]};var f=this;if(n){this.buffer=n;this.buffer.formattedData=this.buffer.formattedData||this.buffer.data}else{this.buffer=jQuery.extend({},i)}this.projectData=function(e,r){var t,n,i,f;if(Array.isArray(e)){t=e}else{t=this.getIndexSelection(e)}var a={};r=r||{};if(r.allDataOnEmptySelection===false&&l(t)){return undefined}if(r.selectionShape!==undefined){var s=u(t);if(s>r.selectionShape){return undefined}}if(r.includeData||r.includeFormattedData||r.includeTuples||r.includeAxesTuples||r.includeConditionalFormats){a.selection=c(t);if(r.includeData){a.data=[]}if(r.includeFormattedData&&this.buffer.formattedData){a.formattedData=[]}if(r.includeTuples){a.tuples=[]}if(r.includeAxesTuples){a.axis_columns=[];a.axis_rows=[]}if(r.includeConditionalFormats&&this.buffer.conditionalFormatValues){a.conditionalFormatValues=[]}var o=this.fillIndex(this.buffer.axis_columns,t,r);var h=this.fillIndex(this.buffer.axis_rows,t,r);a.columnCount=o.length;a.rowCount=h.length;for(var d=0;d<h.length;d++){var v=h[d];var m=this.buffer.axis_rows[v];if(a.axis_rows){a.axis_rows.push(m)}for(n=0;n<o.length;n++){i=o[n];f=this.buffer.axis_columns[i];var p=this.buffer.axis_columns.length*v+i;var b=D(f,m);this.addResult(a,p,b)}}if(a.axis_columns){for(n=0;n<o.length;n++){i=o[n];f=this.buffer.axis_columns[i];a.axis_columns.push(f)}}}a.dimensions=this.buffer.dimensions;if(this.buffer.externalDimensions){a.externalDimensions=this.buffer.externalDimensions}a.locale="en";return a};this.addResult=function(e,r,t){if(e.data){e.data.push(this.buffer.data[r])}if(e.formattedData){e.formattedData.push(this.buffer.formattedData[r])}if(e.tuples){e.tuples.push(t)}if(e.conditionalFormatValues){e.conditionalFormatValues.push(this.buffer.conditionalFormatValues[r])}};this.fillIndex=function(e,r,t){var n=[];var i=null;var a=d(f.buffer.dimensions.length,0);e.forEach(function(e,u){i=s(a,i,e);if(f.tupleMatches(e,r,t,a)){n.push(u)}});return n};this.tupleMatches=function(e,r,t,n){n=n||[];for(var i=0;i<e.length;i++){var f=r[i];var s=e[i];if(f&&s!==-1){if(!a(f,s,n[i])){return false}}if(s!==-1&&this.buffer.dimensions[i].members[s].type==="RESULT"&&(f===false||t&&!t.includeResults)){return false}}return true};function a(e,r,t){for(var n=0;n<e.length;n++){var i=e[n];if(i<0){if(t===(i+1)*-1)return true}else{if(i===r){return true}}}return false}function s(e,r,t){if(r){for(var n=0;n<t.length;n++){if(r[n]!==t[n]){v(e,0,n+1);e[n]=e[n]+1;break}}}return t}function u(e){var r={};var t={};f.buffer.dimensions.forEach(function(n,i){if(e[i]!=null){r[n.axis]=n.axis}else{t[n.axis]=n.axis}});return Object.keys(t).length}this.getIndexSelection=function(e){var r=d(f.buffer.dimensions.length,undefined);o(e,r);o(this.filters(),r);return r};function l(e){for(var r=0;r<e.length;r++){if(e[r]!==undefined)return false}return true}function o(e,r){for(var t in e){if(Object.prototype.hasOwnProperty.call(e,t)){var n=m(t);if(n>=0){if(e[t]==="*")r[n]=null;else if(e[t]==="?")r[n]=false;else{var i=p(f.buffer.dimensions[n],e[t]);if(i.length>0){r[n]=h(i,r[n])}}}}}}function h(e,r){if(r){var t=[];while(e.length>0&&r.length>0){if(e[0]<r[0]){e.shift()}else if(e[0]>r[0]){r.shift()}else{t.push(e.shift());r.shift()}}return t}return e}function c(e){var r=[];for(var t=0;t<e.length;t++){var n=e[t];if(n&&n.length===1){r.push(n[0])}else{r.push(-1)}}return r}function d(e,r){var t=[];for(var n=0;n<e;n++){t.push(r)}return t}function v(e,r,t){for(var n=t;n<e.length;n++){e[n]=r}}function m(e){var r=f.buffer.dimensions;for(var t=0;t<f.buffer.dimensions.length;t++){if(e===r[t].key){return t}if(e==="(MEASURES_DIMENSION)"&&r[t].containsMeasures){return t}}return-1}function p(e,r){var t=[];if(typeof r==="number"){return[0-r-1]}else if(r instanceof Array){for(var n=0;n<r.length;n++){t=t.concat(p(e,r[n]))}}else if(typeof r==="string"){var i=b(e,r);if(i>=0){t.push(i)}}return t}function b(e,r){var t=e.members;for(var n=0;n<t.length;n++){if(r===t[n].key){return n}if(r==="(RESULT_MEMBER)"&&t[n].type==="RESULT"){return n}}return-1}this.fetchData=function(e,r){return this.projectData(e,r)};this.metadata=function(e){if(e===undefined){return JSON.stringify({dimensions:f.buffer.dimensions,externalDimensions:f.buffer.externalDimensions})}};this.getBuffer=function(){return f.buffer};this.defineDimensions=function(e,r){e.forEach(function(e){if(e.members===undefined){e.members=[]}});f.buffer.dimensions=e;if(r){f.buffer.externalDimensions=[r]}};this.clear=function(e){f.buffer.data=[];f.buffer.formattedData=[];f.buffer.tuples=[];f.buffer.axis_columns=[];f.buffer.axis_rows=[];if(e){f.buffer.dimensions.forEach(function(e){e.members=[]})}};this.setDataCell=function(e,r){if(e.length!==f.buffer.dimensions.length){throw"setDataCell call with "+e.length+" coodinates, but expected "+f.buffer.dimensions.length}var t=[];for(var n=0;n<e.length;n++){var i=e[n];if(typeof i!=="number"){i=y(n,i)}t.push(i)}var a=x(t);var s=g(f.buffer.axis_columns,a.col_tuple);var u=g(f.buffer.axis_rows,a.row_tuple);var l=u*f.buffer.axis_columns.length+s;if(l>f.buffer.data.length){throw"Can only change existing cells or append and the end of last line."}f.buffer.axis_columns[s]=a.col_tuple;f.buffer.axis_rows[u]=a.row_tuple;var o=f.buffer.data[l]===undefined;if(o){w(e,t);var h=0;var c="";if(r===null){c=null;h=null}else if(typeof r==="string"){c=_(r);h=parseFloat(r)}else if(typeof r==="number"){c=r+"";h=r}f.buffer.data[l]=h;f.buffer.formattedData[l]=c}else{if(typeof r==="number"){f.buffer.data[l]=r}else{f.buffer.formattedData[l]=r}}};function g(r,t){for(var n=0;n<r.length;n++){if(e.isEqual(r[n],t)){return n}}return n}function x(e){var r=e.slice();var t=e.slice();for(var n=0;n<f.buffer.dimensions.length;n++){var i=f.buffer.dimensions[n];if(i.axis==="COLUMNS"){r[n]=-1}else{t[n]=-1}}return{row_tuple:r,col_tuple:t}}function D(e,r){var t=[];for(var n=0;n<e.length;n++){if(e[n]>-1){t.push(e[n])}else{t.push(r[n])}}return t}function _(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/"/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function y(e,r){var t=f.buffer.dimensions[e];var n=t.members;for(var i=0;i<n.length;i++){var a=n[i];if(a.key===r){return i}}return n.length}function w(e,r){for(var t=0;t<e.length;t++){var n=f.buffer.dimensions[t].members;var i=r[t];if(n[i]===undefined){var a=e[t]+"";n[i]={key:a,text:_(a)}}}}this.fillWithArray=function(e,r,t){this.clear(true);var n=0;var i=0;var f=e[0].length;var a=e.length;var s;var u;if(r){i=1}if(t){n=1}if(r){s=E(e,n)}else{s=A(f)}if(t){u=I(e,i)}else{u=S(a)}for(var l=i;l<a;l++){for(var o=n;o<f;o++){this.setDataCell([s[o],u[l]],e[l][o])}}};function S(e){var r=[];for(var t=0;t<e;t++){r.push(""+(t+1))}return r}function A(e){var r=[];for(var t=0;t<e;t++){r.push(C(t))}return r}function C(e){var r="0".charCodeAt(0);var t="A".charCodeAt(0);var n=e.toString(26).toUpperCase();var i="";for(var f=0;f<n.length;f++){var a=n.charCodeAt(f);var s=n.length>1&&f==0?-1:0;var u;if(a<t){u=a-r+t+s}else{u=a-t+t+10+s}i+=String.fromCharCode(u)}return i}function E(e,r){var t=[];for(var n=0;n<e[0].length;n++){if(n<r){t.push("")}else{t.push(e[0][n])}}return t}function I(e,r){var t=[];for(var n=0;n<e.length;n++){if(n<r){t.push("")}else{t.push(e[n][0])}}return t}this.testaccess={getDimIndex:m,getSelectionShape:u,intersectArray:h,createAxisTuples:x,findAxisTuple:g,tupleMatches:this.tupleMatches.bind(this),fillIndex:this.fillIndex,mergeAxisTuples:D,isIndexSelectionEmpty:l,updateIndexeForIndexAccess:s}};i.subclass=n.makeSubClass(i);return i});
//# sourceMappingURL=databuffer.js.map