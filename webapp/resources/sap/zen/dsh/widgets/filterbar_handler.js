/*
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/base/Log","sap/ui/comp/filterbar/FilterBar","sap/m/Button","sap/ui/comp/smartvariants/PersonalizableInfo","sap/ui/comp/smartvariants/SmartVariantManagement","sap/zen/dsh/utils/BaseHandler","sap/zen/dsh/widgets/filterpanel_m_handler"],function(jQuery,Log,FilterBar,Button,PersonalizableInfo,SmartVariantManagement,BaseHandler){"use strict";var FilterBarHandler=function(){BaseHandler.apply(this,arguments);var dispatcher=BaseHandler.dispatcher;var me=this;me.create=function(e,t){var a=t["id"];var n=FilterBar.extend("sap.zen.ZenFilterBar",{renderer:{}});n.prototype._createVariantManagement=function(){this._smartVm=false;var e;if(sap.zen.dsh.sapbi_page.appComponent){e=new SmartVariantManagement(this.getId()+"-variant",{showExecuteOnSelection:false,showShare:true});this._smartVm=true}return e};var i=new n(a,{advancedMode:false,considerGroupTitle:false,showRestoreButton:false,filterBarExpanded:t.expanded,persistencyKey:t.VARIANT_KEY}).addStyleClass("zenFilterBarM");i._initializeVariantManagementOriginal=sap.ui.comp.filterbar.FilterBar.prototype._initializeVariantManagement;i._initializeVariantManagement=function(){if(this._smartVm){if(this._oVariantManagement&&this.getPersistencyKey()){this._sOwnerId=sap.zen.dsh.sapbi_page&&sap.zen.dsh.sapbi_page.appComponent.getId();var e=new PersonalizableInfo({type:"filterBar",keyName:"persistencyKey"});e.setControl(this);this._oVariantManagement.addPersonalizableControl(e);i._initializeVariantManagementOriginal.call(i)}else{this.fireInitialise()}}else{i._initializeVariantManagementOriginal.call(i)}};if(i._oVariantManagement){i._oVariantManagement._initializeOriginal=i._oVariantManagement._initialize;i._oVariantManagement._initialize=function(e,a){if(t.ignoreDefaultVariant){this.setInitialSelectionKey(i._oVariantManagement.STANDARDVARIANTKEY);var n=me.allowVariantSave(i,t);i._oVariantManagement.currentVariantSetModified(n)}i._oVariantManagement._initializeOriginal.call(i._oVariantManagement,e,a)}}i.applyVariant=function(e,t,a){if(e){var n=e.filterBarVariant;if(n){var r=getCommand(i,"loadSfinBookmark");if(r){me.applyForChildren(i,function(e){var t=e.getModel();var a;if(t){a=t.getProperty("/filters")}if(a){for(var n in a){if(Object.prototype.hasOwnProperty.call(a,n)){if(a[n].dirty){a[n].dirty=false}}}}});if(r.indexOf("__bmId__")>=0){r=me.prepareCommand(r,"__bmId__","42");r=me.prepareCommand(r,"__arg2__",n);new Function(r).call()}}}if(a&&this._isNewFilterBarDesign()){this._fHandleResize()}}};i.registerFetchData(function(){if(!sap.zen.dsh.wnd){sap.zen.dsh.wnd={}}var e=sap.zen.dsh.wnd[t.PAGE_ID].getWindow().getContext("BookmarkInternal").createBookmark().getBookmark();var a=JSON.parse(JSON.stringify(e));return a});i._initializeVariantManagement();if(!sap.zen.designmode&&!t.fbVisible){i.toggleStyleClass("zenFilterBarMHidden")}i.custProp={};i.custProp.i18n={expand:t.EXPAND_ACTION,collapse:t.COLLAPSE_ACTION,novariant:t.NO_VARIANT};i.custProp.allChildrenSubmit=t.allChildrenSubmit;me.addCustomExpandButton(i);if(typeof sap.zen.dsh.DSH_deployment!=="undefined"){setCommand(i,"loadSfinBookmark",t.loadsfinbookmarkcmd)}i.zenInitLater=function(){init(i,t);i.zenInitLater=null};setCommand(i,"EXPAND",t.expandcmd);setCommand(i,"DELAYRERENDER",t.delayrerendercmd);if(!sap.zen.designmode){i.addEventDelegate({onAfterRendering:function(e){e.srcControl.removeEventDelegate(this);me.updateEnablement(e.srcControl,t);jQuery(e.srcControl.getParent().getDomRef()).addClass("zenFilterBarMParentCont")}})}i.registerGetFiltersWithValues(function(){return handleDetermineFilterCount(i)});i.attachSearch(function(){handleFilterDialog_submit(i)});handleFilterDialog(i);me.initOverflowExpand(i,t);return i};me.update=function(e,t){if(t){if(e.zenInitLater){setTimeout(e.zenInitLater)}else{init(e,t,true)}me.updateVisibility(e,t);me.updateEnablement(e,t);var a=me.allowVariantSave(e,t);if(e._oVariantManagement){e._oVariantManagement.currentVariantSetModified(a)}}return e};function init(e,t,a){var n=t.content;if(n&&n[0]){if(n[0].component.content&&n[0].component.content.control.newds){e.custProp.allChildrenSubmit=t.allChildrenSubmit;if(a){n.forEach(function(e){if(e.component.content&&e.component.content.control.newds){e.component.content.control.newds=false}})}}me.updateChildren(n,e,function(t,a,n){if(n){var i=new sap.ui.comp.filterbar.FilterGroupItem(e.getId()+t.getId(),{name:e.getId()+"-"+t.getId(),groupName:sap.ui.comp.filterbar.FilterBar.INTERNAL_GROUP,partOfCurrentVariant:true,visibleInFilterBar:false});i.setControl(t);if(n.content&&n.content.control&&n.content.control.characteristics&&n.content.control.characteristics.length>0){i.setLabel(n.content.control.characteristics[0].characteristic.text)}t.addStyleClass("zenFilterBarMFilter");if(t.ZEN_multiInput&&t.ZEN_multiInput[0]){t.ZEN_multiInput[0].attachTokenChange(function(t){e.fireFilterChange(t)})}e.addFilterGroupItem(i)}},function(){});e.fireFilterChange()}if(t.visibleDimensionNames){var i=t.visibleDimensionNames;var r=e.getFilterGroupItems();for(var l=0;l<r.length;l++){var o=r[l];var s=e.determineControlByFilterItem(o);if(s){o.setVisibleInFilterBar(false);var d=s.getModel();if(!d){Log.error("FilterControl "+s.getId()+" has no model")}else{var m=d.getProperty("/characteristics/0/characteristic/name");for(var u=0;u<i.length;u++){if(m===i[u]._n){o.setVisibleInFilterBar(true);break}}}}}}}me.applyForChildren=function(e,t){var a=e.getAllFilterItems();for(var n=0;n<a.length;n++){var i=e.determineControlByFilterItem(a[n]);if(i){var r=t(i);if(r){return r}}}return null};me.getType=function(){return"filterbar"};me.updateVisibility=function(e,t){if(t.visibilityChanged){e.toggleStyleClass("zenFilterBarMHidden")}};me.allowVariantSave=function(e,t){if(e._oVariantManagement){var a=e._oVariantManagement;if(a.getSelectionKey()!==a.STANDARDVARIANTKEY&&t.datasourcechanged){return true}else{return false}}return null};me.initOverflowExpand=function(oFilterBar,oControlProperties){dispatcher.registerResizeHandler(oFilterBar,{endResize:function(e){if(e){if(getSampleDFWidth()===-1){me.sampleDimensionFilterWidth(oFilterBar)}if(oFilterBar.getFilterBarExpanded()){me.refreshCollapseVisibleDFCount(oFilterBar)}me.updateCustomExpandVisibility(oFilterBar)}}});oFilterBar.orig_setFilterBarExpanded=oFilterBar.setFilterBarExpanded;oFilterBar.setFilterBarExpanded=function(showExpanded){var lOldExpanded=this.getFilterBarExpanded();oFilterBar.orig_setFilterBarExpanded.call(oFilterBar,showExpanded);if(showExpanded!==lOldExpanded){var lCommandString=getCommand(oFilterBar,"EXPAND");if(lCommandString){eval(lCommandString)}new Function(oControlProperties.onToggle).call()}}};me.addCustomExpandButton=function(e){if(e._oToolbar){var t;if(e._oHideShowButton){t=e._oToolbar.indexOfContent(e._oHideShowButton)}if(t){e.customExpandButton=new Button({text:e.custProp.i18n.expand,visible:false,type:sap.m.ButtonType.Transparent});e.customExpandButton.attachPress(function(){me.toggleExpandOverlay(e)});e.customExpandButton.addStyleClass("zenCustomExpandButton");e._oToolbar.insertContent(e.customExpandButton,t)}}};me.updateCustomExpandVisibility=function(e){var t=false;if(e.getFilterBarExpanded()){t=me.checkCustomExpandVisibility(e)&&e.getFilterBarExpanded()}e.customExpandButton&&e.customExpandButton.setVisible(t);if(e.custProp.customExpanded&&!t){me.toggleExpandOverlay(e,true)}};me.refreshCollapseVisibleDFCount=function(e){if(getSampleDFWidth()===-1){me.sampleDimensionFilterWidth(e)}var t=Math.floor(jQuery(e.getDomRef()).width()/getSampleDFWidth());var a=e.getFilterGroupItems();var n=0;for(var i=0;i<a.length;i++){var r=a[i];if(r.getVisibleInFilterBar()){var l=e.determineControlByFilterItem(r);if(l){var o=l.getParent();if(o&&o.addStyleClass&&o.removeStyleClass){if(n++>=t){o.addStyleClass("zenFBIhidden")}else{o.removeStyleClass("zenFBIhidden")}}}}}};me.checkCustomExpandVisibility=function(e){var t=false;var a=getVisibleDFCount(e);if(getSampleDFWidth()!==-1){if(a*getSampleDFWidth()>jQuery(e.getDomRef()).width()){t=true}}return t};me.sampleDimensionFilterWidth=function(e){var t=-1;var a=e.getAllFilterItems();if(a.length>1){var n=jQuery(e.getDomRef()).find(".sapUiAFLayoutItem:first-of-type");if(n){var i=parseInt(n.css("padding-left"))+parseInt(n.css("padding-right"));if(isNaN(i)){i=0}var r=parseInt(n.css("margin-left"))+parseInt(n.css("margin-right"));if(isNaN(r)){r=0}t=n.width()+i+r}}setSampleDFWidth(t)};me.toggleExpandOverlay=function(e,t){if(e.custProp.customExpanded||t===true){e.removeStyleClass("zenCustomExpand");e.custProp.customExpanded=false;e.customExpandButton&&e.customExpandButton.setText(e.custProp.i18n.expand)}else{e.addStyleClass("zenCustomExpand");e.custProp.customExpanded=true;e.customExpandButton&&e.customExpandButton.setText(e.custProp.i18n.collapse)}};function handleDetermineFilterCount(e){var t=[];var a=e.getFilterGroupItems();for(var n=0;n<a.length;n++){var i=e.determineControlByFilterItem(a[n]);if(i&&i.ZEN_multiInput&&i.ZEN_multiInput[0]&&i.ZEN_multiInput[0].getTokens().length||i&&Object.values(i.getModel().getProperty("/filters"))[0].ranges.length>0){t.push(a[n])}}return t}function handleFilterDialog(e){e.attachFiltersDialogBeforeOpen(function(){handleFilterDialog_show(e)});e.attachFiltersDialogClosed(function(){handleFilterDialog_close(e)});me.originalCancelFilterDialog=e._cancelFilterDialog;e.attachFiltersDialogCancel(function(){handleFilterDialog_cancel(e)})}function handleFilterDialog_show(e){jQuery(document.body).addClass("zenFilterBarDialogOpened");me.applyForChildren(e,function(e){e.ZENFilterBeforeDialog=JSON.stringify(e.getModel().getProperty("/filters"))})}function handleFilterDialog_close(e){if(!me._bFilterDialogCancelled){handleFilterDialog_submit(e)}me._bFilterDialogCancelled=null;me.applyForChildren(e,function(e){if(e.ZENFilterBeforeDialog){e.ZENFilterBeforeDialog=null}});jQuery(document.body).removeClass("zenFilterBarDialogOpened");if(e.getFilterBarExpanded()){me.refreshCollapseVisibleDFCount(e)}me.updateCustomExpandVisibility(e)}function handleFilterDialog_cancel(e){me._bFilterDialogCancelled=true;me.applyForChildren(e,function(e){if(e.ZENFilterBeforeDialog){e.getModel().setProperty("/filters",JSON.parse(e.ZENFilterBeforeDialog));e.ZENFilterBeforeDialog=null}});if(me.originalCancelFilterDialog){me.originalCancelFilterDialog.call(e)}}function handleFilterDialog_submit(oFilterBar){var lSubmitMethod=oFilterBar.custProp.allChildrenSubmit;var lKeyWordToReplace=lSubmitMethod.indexOf("__STRING____");while(lKeyWordToReplace>0){var lKeyWeNeedToReplace;if(typeof sap.zen.dsh.DSH_deployment==="undefined"){lKeyWeNeedToReplace=lSubmitMethod.substring(lKeyWordToReplace,lSubmitMethod.indexOf("'",lKeyWordToReplace))}else{lKeyWeNeedToReplace=lSubmitMethod.substring(lKeyWordToReplace,lSubmitMethod.indexOf("\\x27",lKeyWordToReplace))}var lIdWeNeed=lKeyWeNeedToReplace.substring(12)+"_filter1";var loDimensionFilter=sap.ui.getCore().byId(lIdWeNeed);var lOriginalSubmitMethod=lSubmitMethod;lSubmitMethod=loDimensionFilter.ZEN_submit(lKeyWeNeedToReplace,lSubmitMethod);if(!lSubmitMethod){lSubmitMethod=lOriginalSubmitMethod.replace(lKeyWeNeedToReplace,"{}")}lKeyWordToReplace=lSubmitMethod.indexOf("__STRING____")}var lDelayrerendercmdStart=getCommand(oFilterBar,"DELAYRERENDER");if(lDelayrerendercmdStart&&lDelayrerendercmdStart.indexOf("__arg1__")>=0){lDelayrerendercmdStart=lDelayrerendercmdStart.replace("__arg1__","true")}var lDelayrerendercmdEnd=getCommand(oFilterBar,"DELAYRERENDER");if(lDelayrerendercmdEnd&&lDelayrerendercmdEnd.indexOf("__arg1__")>=0){lDelayrerendercmdEnd=lDelayrerendercmdEnd.replace("__arg1__","false")}var lVisibleDimensions=me.getVisibleDimensions(oFilterBar);if(lVisibleDimensions&&lDelayrerendercmdEnd&&lDelayrerendercmdEnd.indexOf("__arg2__")>=0){lDelayrerendercmdEnd=lDelayrerendercmdEnd.replace("__arg2__",lVisibleDimensions)}lSubmitMethod=lDelayrerendercmdStart+lDelayrerendercmdEnd+lSubmitMethod;eval(lSubmitMethod)}me.getVisibleDimensions=function(e){if(typeof sap.zen.dsh.DSH_deployment!=="undefined"){var t=e.getFilterGroupItems();var a=[];for(var n=0;n<t.length;n++){var i=t[n];if(i.getVisibleInFilterBar()){var r=e.determineControlByFilterItem(i);if(r){var l=r.getModel().getProperty("/characteristics/0/characteristic/name");if(l){a.push(l)}}}}return JSON.stringify(a)}return null};me.updateEnablement=function(e){if(e._oVariantManagement){e._oVariantManagement.setEnabled(true)}};function getVisibleDFCount(e){var t=e.getAllFilterItems(true);var a=0;for(var n=0;t&&n<t.length;n++){if(t[n].getVisibleInFilterBar()){a++}}return a}function setSampleDFWidth(e){me._sampleDFWidth=e}function getSampleDFWidth(){if(!me._sampleDFWidth){me._sampleDFWidth=-1}return me._sampleDFWidth}function getCommand(e,t){var a;if(e.custProp&&e.custProp.commands){a=e.custProp.commands[t]}return a}function setCommand(e,t,a){if(e.custProp){if(!e.custProp.commands){e.custProp.commands={}}e.custProp.commands[t]=a}}this.getDecorator=function(){return"DataSourceFixedHeightDecorator"}};var instance=new FilterBarHandler;BaseHandler.dispatcher.addHandlers(instance.getType(),instance);return instance});
//# sourceMappingURL=filterbar_handler.js.map