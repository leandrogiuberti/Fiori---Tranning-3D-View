/*!
 * (c) Copyright 2010-2019 SAP SE or an SAP affiliate company.
 */
sap.ui.define(["jquery.sap.global","sap/zen/crosstab/TouchHandler","sap/zen/crosstab/SelectionHandler","sap/zen/crosstab/rendering/CrossRequestManager","sap/zen/crosstab/rendering/RenderingConstants","sap/zen/crosstab/utils/Utils","sap/zen/crosstab/keyboard/CrosstabKeyboardNavHandler","sap/zen/crosstab/HeaderResizer","sap/zen/crosstab/ColResizer"],function(jQuery,e,t,n,i,a,l,r,o){"use strict";jQuery.sap.declare("sap.zen.crosstab.EventHandler");sap.zen.crosstab.EventHandler=function(t){var n=this;var i=t.getRenderEngine();var s=i.getCrossRequestManager();var c=new l(t,this);var u=null;var d=false;var v=null;var f="";var g=null;var h=null;var p=null;this.handleHierarchyClick=function(e,t,n){var i=m(t);var l=i.getHierarchyAction();var r=i.getDrillState();if(r!=="L"){s.saveTableDimensions();s.saveHScrollInfo(n);s.saveVScrollInfo(n);E(l)}a.cancelEvent(e)};this.handleSortClick=function(e,n,i){var l=m(n);var r=l.getSortAction();if(r||t.getTestProxy().getTestAction()){s.saveVScrollInfo(i);s.saveHScrollInfo(i);s.saveColWidths();if(!t.getTestProxy().getTestAction()){E(r)}}a.cancelEvent(e)};this.findTargetId=function(e){var t=null;var n;var i;i=jQuery(e).attr("xtabspacer-cellid");if(i&&i.length>0){t=i}else{n=jQuery(e).closest("div");if(n.length>0){var a=n.attr("id");if(a){var l=a.indexOf("_contentDiv");if(l>-1){t=a.slice(0,l)}}}}return t};this.executeOnClickAction=function(e){if(d){return}u=null;d=false;var t=e.target.id;if(!t){t=n.findTargetId(e.target)}if(!t){return}var i=_(t);if(i==="sort"){n.handleSortClick(e,t,i)}else if(i==="hier"){n.handleHierarchyClick(e,t,i)}else if(i==="__ce"){n.handleClickOnCell(e,t)}else if(i==="vhlp"){n.handleValueHelpClick(t)}a.cancelEvent(e)};this.handleClickOnCell=function(e,i){if(t.hasLoadingPages()){a.cancelEvent(e);return}if(i){var l=t.getUtils().getCellIdFromContenDivId(i);if(l){var r=sap.ui.getCore().getControl(l);if(r){if(r.isEntryEnabled()){n.handleInputEnabledCell(i,-1,-1)}else{if(t.getSelectionMode()!==undefined&&t.getSelectionMode()!==""){var o="";if(e.ctrlKey){o="CTRL"}else if(e.shiftKey){o="SHIFT"}t.getSelectionHandler().handleCellClick(r,o)}}}}}};this.postPlanningValue=function(){if(t.isPlanningMode()===true&&g&&g.length>0){var e=jQuery(document.activeElement);if(e.is("input")&&g.attr("id")===e.attr("id")){var n=g.val()||"";if(n!==f){g.blur()}}}};this.provideInputEnabledCell=function(e,i,l,r,o){g=l.find("input");if(g.length===0){var u=l.text();var d=l.html();var v=e.getArea().isDataArea();var h=null;var p=function(n){var i=e.getUnit();if(i&&i!==""){var a=n.toUpperCase().indexOf(i.toUpperCase());if(a!==-1){if(a===0){n=n.substring(a+i.length)}else{n=n.substring(0,a)}}}var l=t.calculateOffset(e);n=jQuery.trim(n);var r=t.getTransferDataCommand();r=r.replace("__ROW__",e.getRow()+"");r=r.replace("__COL__",e.getCol()-l+"");r=r.replace("__VALUE__",n);r=r.replace("__CTYPE__",e.getPassiveCellType());s.saveVScrollInfo("plan");s.saveHScrollInfo("plan");s.saveColWidths();E(r,true)};var C=function(e){if(g.val()!==u){p(g.val());var t=jQuery("<div></div>").text(u).html();d=d.replace(t,g.val())}m(e)};var _=function(e){var n=true;var i=null;var a=null;var l=null;if(e&&e.relatedTarget&&e.relatedTarget.id&&t.getValueHelpStatus()!==sap.zen.crosstab.VHLP_STATUS_OPENING){i=e.relatedTarget.id;l=jQuery(document.getElementById(i));a=t.getTableDiv();n=l.closest(a).length>0}return n};var m=function(e){var t=jQuery(document.getElementById(i+"_contentDiv"));t.html(d);if(h&&v){t.width(h)}if(_(e)===true){t.focus()}else{c.reset();f="";g.off("keydown focusout");g=null}};var b=function(i){if(i.which===27){m();a.cancelEvent(i)}if(i.which===13){if(g.val()!==u){a.cancelEvent(i);p(g.val())}else{m();if(t.isIE8Mode()){c.keyboardNavKeyHandler(i)}}}if(i.which===38||i.which===40){return true}if(i.which===37||i.which===39){if(!i.ctrlKey&&!i.altKey&&!i.shiftKey){a.stopEventPropagation(i)}return true}if(i.which===115&&!v){n.invokeValueHelp(e,"vhlp_"+e.getId())}return null};var M=0;if(v){M=l.innerWidth();h=a.getWidthFromStyle(l)}l.html('<input id="'+i+"_input"+'" type="text" value="'+u+'" />');if(v){l.width(M+"px")}g=jQuery(document.getElementById(i+"_input"));if(a.isMainMode()){g.addClass("sapzencrosstab-EntryEnabledInput-MainMode")}else{g.addClass("sapzencrosstab-EntryEnabledInput")}g.on("keydown",b);g.focus();t.getUtils().selectTextInInputField(g,r,o);g.on("focusout",C)}else{t.getUtils().selectTextInInputField(g,r,o)}f=g.val()||""};this.handleValueHelpClick=function(e){var t=m(e);n.invokeValueHelp(t,e)};this.invokeValueHelp=function(e,n){if(e){c.focusNewCell(e,-1,-1);var i=t.getCallValueHelpCommand();var a=t.calculateOffset(e);s.saveVScrollInfo("plan");s.saveHScrollInfo("plan");s.saveColWidths();i=i.replace("__ROW__",e.getRow());i=i.replace("__COL__",e.getCol()-a);i=i.replace("__DOM_REF_ID__",n);E(i,true)}};this.handleInputEnabledCell=function(e,n,i){if(e){e=t.getUtils().getCellIdFromContenDivId(e);if(e){var a=sap.ui.getCore().getControl(e);if(a){if(a.getArea().isDataArea()||a.getArea().isRowHeaderArea()){c.focusNewCell(a,n,i)}}}}};this.sendSelectCommand=function(e){var n=-1;var i=-1;var a="";if(e){var l=e.getArea();if(l.isRowHeaderArea()){a="ROWS"}else if(l.isColHeaderArea()){a="COLUMNS"}else{a="DATA"}n=e.getRow();i=e.getCol()}var r=t.getOnSelectCommand();r=r.replace("__ROW__",n+"");r=r.replace("__COL__",i+"");r=r.replace("__AXIS__",a);E(r,true)};this.getContextElement=function(e,t){var n=[];var i=0;var a=jQuery(document.elementFromPoint(e,t));var l=a.closest(".zenControl");var r=l.attr("id");r=a.attr("id");while(r&&r.indexOf("droparea")>-1){n.push(a);a.css("display","none");a=jQuery(document.elementFromPoint(e,t));r=a.attr("id")}for(i=0;i<n.length;i++){n[i].css("display","block")}return a};this.onContextMenuClick=function(e){var i=n.getContextElement(e.clientX,e.clientY);var l=t.createContextMenu();var r=l.getContext(i);if(r){var o=t.getPropertyBag().getContextMenuCommand();o=o.replace("__AXIS__",r.sAxis);o=o.replace("__ROW__",r.iRow);o=o.replace("__COL__",r.iCol);o=o.replace("__ID__","CONTEXT_MENU");o=o.replace("__DOM_REF_ID__",i.attr("id"));if(o.indexOf("__REMOVE_SELECTION__")>=0){o=o.replace("__REMOVE_SELECTION__",r.bRemoveSelection)}var s=sap.bi.framework.getService(null,"zen.rt.components.dynamicmenu");s.showDynamicMenu("ExpandedMenuBuilder",i.context,"",{command:o},"",["crosstabActions"],"",false)}a.cancelEvent(e);t.enableClick()};this.attachEvents=function(){var n=false;var i=t.getRenderSizeDiv();var l=t.getTableDiv();i.unbind("mousedown");i.bind("mousedown",this.onMouseDown);if(t.getPropertyBag().isMobileMode()||t.getPropertyBag().isTestMobileMode()){i.unbind("click");i.bind("click",function(e){a.cancelEvent(e)});i.unbind("mousedown");i.bind("mousedown",function(e){a.cancelEvent(e)});v=new e(this,t);v.registerTouchEvents(i);c.setEnabled(false);if(t.getPropertyBag().isEnableColResize()===true){var s=new o(t);v.setColResizer(s)}}else{i.unbind("mouseup",this.onMouseUp);i.bind("mouseup",this.onMouseUp);l.unbind("mouseup",this.onMouseUp);l.bind("mouseup",this.onMouseUp);i.unbind("click");i.bind("click",this.executeOnClickAction);if(t.isSelectable()===true&&t.isHoveringEnabled()===true){i.unbind("mouseover");i.bind("mouseover",this.executeOnMouseEnter);i.unbind("mouseout");i.bind("mouseout",this.executeOnMouseOut)}c.setEnabled(t.isPlanningMode());c.attachEvents(i);if(t.getUserHeaderWidthCommand()&&t.getUserHeaderWidthCommand().length>0){h=new r(t);h.initialize();n=true}if(t.getPropertyBag().isEnableColResize()===true){p=new o(t);p.initialize();n=true}if(n===true){i.unbind("mousemove",this.onMouseMove);i.bind("mousemove",this.onMouseMove)}}};this.onMouseMove=function(e){if(p&&p.isResizeAction()){p.onMouseMove(e)}else if(h&&h.isResizeAction()){h.onMouseMove(e)}};this.onMouseDown=function(e){var t=e.target.id;u=t};function C(e,t){var n=false;var i=document.getElementById(e);if(i){var a=i.getBoundingClientRect();var l=a.left<t.clientX&&t.clientX<a.right;var r=a.bottom>t.clientY&&t.clientY>a.top;n=l&&r}return n}this.onMouseUp=function(e){if(p&&p.isResizeAction()){p.onMouseUp(e)}else if(h&&h.isResizeAction()){h.onMouseUp(e)}else{d=false;if(u){var i=t.getUtils().getCellIdFromContenDivId(u);if(C(i,e)){var l=sap.ui.getCore().getControl(i);if(l){if(t.isPlanningMode()){var r=document.getElementById(u);var o=null;if(r){o=t.getUtils().getSelectionParams(r)}if(o.iSelectionStartPos>=0||o.iSelectionEndPos>=0){d=true;n.handleInputEnabledCell(e.target.id,o.iSelectionStartPos,o.iSelectionEndPos)}}}}else{if(!t.isDragAction()){a.cancelEvent(e);a.stopEventPropagation(e)}d=true}}}};this.restoreFocusOnCell=function(){c.restoreFocusOnCell()};function _(e){var t=e.slice(0,4);return t}function m(e){var t=e.slice(5);return sap.ui.getCore().getControl(t)}function E(e,n){if(e){if(!n){}t.getUtils().executeCommandAction(e)}}this.handleHoverEntry=function(e){if(e){var n=t.getUtils().getCellIdFromContenDivId(e);if(n&&n!==undefined){var i=sap.ui.getCore().getControl(n);if(i&&i!==undefined){t.getSelectionHandler().handleCellHoverEntry(i)}}}};this.executeOnMouseEnter=function(e){var i=null;var l=e.target.id;if(t.hasLoadingPages()){a.cancelEvent(e);return}if(!l){l=n.findTargetId(e.target)}if(!l){return}i=_(l);if(i==="__ce"){n.handleHoverEntry(l)}a.cancelEvent(e)};this.executeOnMouseOut=function(e){t.getSelectionHandler().handleCellHoverOut(e);a.cancelEvent(e)};this.enableClick=function(){d=false;u=null};this.getColResizer=function(){return p}};return sap.zen.crosstab.EventHandler});
//# sourceMappingURL=EventHandler.js.map