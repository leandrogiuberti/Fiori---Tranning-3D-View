/*!
 * (c) Copyright 2010-2019 SAP SE or an SAP affiliate company.
 */
sap.ui.define(["jquery.sap.global","sap/zen/crosstab/TouchHandler","sap/zen/crosstab/rendering/CrossRequestManager","sap/zen/crosstab/rendering/RenderingConstants","sap/zen/crosstab/utils/Utils"],function(jQuery,e,t,l,r){"use strict";jQuery.sap.declare("sap.zen.crosstab.SelectionHandler");sap.zen.crosstab.SelectionHandler=function(e){var t=this;var a={};var i=null;var n=null;var s=false;this.blockSelectionHovering=function(e){s=e;if(s&&n){this.removeSelection(n,true);n=null}};this.removeAllSelections=function(){this.removeAllPreviousSelectionEffects();this.setSelection(null)};this.checkHeaderCellMerge=function(t,l){var r;var a;if(e.getPropertyBag().isRepeatTexts()===true){return false}if(!t.isHeaderCell()||!l.isHeaderCell()){return false}if(t.getId()===l.getId()){return true}if(t.getMergeKey()===""||l.getMergeKey()===""){return false}if(t.getMergeKey()!==l.getMergeKey()){return false}if(t.getDrillState()!==l.getDrillState()){return false}r=t.getArea();a=l.getArea();if(r.getAreaType()!==a.getAreaType()){return false}if(r.isRowHeaderArea()){if(t.getCol()!==l.getCol()){return false}}else if(r.isColHeaderArea()){if(t.getRow()!==l.getRow()){return false}}return true};this.provideSelectionForAllClickedCells=function(){jQuery.each(a,function(e,l){t.selectCells(l)})};this.mapClickedCellsToModel=function(){var e=null;var l={};var r=[];var i=0;var n=null;jQuery.each(a,function(a,s){e=s.getArea().getCell(s.getRow(),s.getCol());if(!e){if(s.isHeaderCell()){if(s.getArea().isRowHeaderArea()){e=s.getArea().getCellWithRowSpan(s.getRow(),s.getCol())}else if(s.getArea().isColHeaderArea()){e=s.getArea().getCellWithColSpan(s.getRow(),s.getCol())}if(e){if(t.checkHeaderCellMerge(e,s)===true){l[e.getId()]=e}else{if(s.getArea().isRowHeaderArea()){r=s.getArea().getDataModel().getAllLoadedCellsByCol(s.getArea(),s.getCol())}else if(s.getArea().isColHeaderArea()){r=s.getArea().getDataModel().getAllLoadedCellsByRow(s.getArea,s.getRow())}for(i=0;i<r.length;i++){n=r[i];if(n){if(n.getMergeKey()===s.getMergeKey()&&n.getText()===s.getText()){l[n.getId()]=n;break}}}}}}}else{l[e.getId()]=e}});a=l};this.addClickedCellsForSpannedHeaderCells=function(){var e=null;var l={};jQuery.each(a,function(r,a){var i=null;if(a.isHeaderCell()){e=a.getArea();if(e.isRowHeaderArea()){i=e.getRenderedCellsByCol(a.getCol());jQuery.each(i,function(e,r){if(t.checkHeaderCellMerge(r,a)===true){l[e]=r}})}else if(e.isColHeaderArea()){i=e.getRenderedCellsByRow(a.getRow());jQuery.each(i,function(e,r){if(t.checkHeaderCellMerge(r,a)===true){l[e]=r}})}}});jQuery.extend(a,l)};this.extractClickedCellsFromSelection=function(){var t="";var l;var r=0;var n=null;var s;var o;var c;var f;if(i){t=i.axis;if(i.bFromBackend===true){var g=e.getHeaderInfo();if(e.getNewLinesPos()==="TOP"){r=e.getNewLinesCnt()}for(var d=0;d<i.length;d++){s=i[d];if(t==="ROWS"){o=e.getRowHeaderArea();c=s.row+r;f=g.getColForAbsoluteCol(s.col)}else if(t==="COLUMNS"){o=e.getColumnHeaderArea();c=g.getRowForAbsoluteRow(s.row)+r;f=s.col}else if(t==="DATA"){o=e.getDataArea();c=s.row+r;f=s.col}l=o.getCell(c,f);if(l){a[l.getId()]=l}}}else{n=i[t];if(n){for(d=0;d<n.length;d++){s=n[d];if(t==="ROW"){o=e.getRowHeaderArea()}else if(t==="COL"){o=e.getColumnHeaderArea()}else if(t==="DATA"){o=e.getDataArea()}l=o.getCell(s.row,s.col);if(l){a[l.getId()]=l}}}}}};this.ensureCellsSelected=function(){a={};if(e.isPlanningMode()===true&&e.getSelectionMode()==="DATA"){i=null}if(i){this.extractClickedCellsFromSelection()}if(a&&Object.keys(a).length>0){this.mapClickedCellsToModel();this.addClickedCellsForSpannedHeaderCells();this.provideSelectionForAllClickedCells()}};this.checkSingleCellClicked=function(e){var l=true;if(a&&Object.keys(a).length===0){return false}if(a&&Object.keys(a).length===1&&a[e.getId()]){return true}if(e.isHeaderCell()===true){jQuery.each(a,function(r,a){if(!t.checkHeaderCellMerge(e,a)){l=false;return false}})}else{l=false}return l};this.checkCellIsAlreadyClicked=function(l){var r=null;var i=false;if(!l.isHeaderCell()){r=a[l.getId()];if(r){return true}}else{if(Object.keys(a).length===1&&a[l.getId()]){return true}jQuery.each(a,function(r,a){if(e.getPropertyBag().isRepeatTexts()===true){if(r===l.getId()){i=true;return false}}else{if(t.checkHeaderCellMerge(l,a)===true){i=true;return false}}})}return i};this.translateClick=function(t){var l=null;var r=t.getArea();var a=0;var i=0;var n=0;var s=0;var o="";var c=e.getHeaderInfo();l=t;if(r.isRowHeaderArea()){if(e.getPropertyBag().isRepeatTexts()===true){if(t.getCol()>0){l=r.getCell(t.getRow(),0)}else{l=t}}else{a=t.getCol();o=c.getDimensionNameByCol(a);if(o&&o.length>0){i=c.getFirstColForDimension(o);if(i>=0&&i!==a){l=r.getCell(t.getRow(),i)}}}}else if(r.isColHeaderArea()){if(e.getPropertyBag().isRepeatTexts()===true){if(t.getRow()>0){l=r.getCell(0,t.getCol())}else{l=t}}else{n=t.getRow();o=c.getDimensionNameByRow(n);if(o&&o.length>0){s=c.getFirstRowForDimension(o);if(s>=0&&s!==n){l=r.getCell(s,t.getCol())}}}}return l};this.checkSelectionAllowed=function(t){var l=t.getArea();var r=0;if(l.isDimHeaderArea()){return false}if(e.isPlanningMode()===true){if(e.getNewLinesCnt()>0){r=t.getRow();if(e.getNewLinesPos()==="TOP"){if(r<e.getNewLinesCnt()){return false}}else{if(r>t.getArea().getRowCnt()-e.getNewLinesCnt()-1){return false}}}if(e.getSelectionMode()==="DATA"){return false}}if(e.getSelectionMode()==="DATA"){if(l.isRowHeaderArea()||l.isColHeaderArea()){return false}}else{if(l.isDataArea()){return false}}if(e.getSelectionSpace()==="ROW"){if(l.isColHeaderArea()){return false}}else if(e.getSelectionSpace()==="COL"){if(l.isRowHeaderArea()){return false}}if(e.getSelectionMode()==="SINGLE"){var a=e.getHeaderInfo();if(l.isRowHeaderArea()){return a.isColOfInnermostDimension(t.getCol())}else if(l.isColHeaderArea()){return a.isRowOfInnermostDimension(t.getRow())}}return true};this.registerCtrlKeyUpListener=function(){if(e.getPropertyBag().isFireOnSelectedOnlyOnce()===true){if(!document.oSapCrosstabOnSelectHandlerReg){document.oSapCrosstabOnSelectHandlerReg={}}document.oSapCrosstabOnSelectHandlerReg[e.getId()]={me:this,fOnSelect:this.sendOnSelectCommand};if(!document.fSapCrosstabOnKeyUpHandler){document.fSapCrosstabOnKeyUpHandler=function(e){if(e.which===17){jQuery(document).off("keyup");document.fSapCrosstabOnKeyUpHandler=null;jQuery.each(document.oSapCrosstabOnSelectHandlerReg,function(e,t){t.fOnSelect.apply(t.me)});document.oSapCrosstabOnSelectHandlerReg=null;r.cancelEvent(e);r.stopEventPropagation(e)}};jQuery(document).on("keyup",document.fSapCrosstabOnKeyUpHandler)}}};this.postSelectionToServer=function(l){var r=document.oSapCrosstabOnSelectHandlerReg&&document.oSapCrosstabOnSelectHandlerReg[e.getId()];if(!e.getPropertyBag().isFireOnSelectedOnlyOnce()||e.getPropertyBag().isFireOnSelectedOnlyOnce()===true&&!r){t.sendOnSelectCommand(l)}};this.handleCellClick=function(e,l){if(!this.checkSelectionAllowed(e)){this.removeAllSelections();this.sendJson("{}");return}if(n){t.removeSelection(n,true);n=null}e=this.translateClick(e);if(!l||l==="SHIFT"){if(this.checkSingleCellClicked(e)===true){this.removeSelection(e);return}else{this.startNewSelection(e)}}else if(l==="CTRL"){this.registerCtrlKeyUpListener();if(this.checkCellIsAlreadyClicked(e)===true){this.removeSelection(e);return}else{var r=this.checkMultiselectPossible(e);if(r){a[e.getId()]=e}else{this.startNewSelection(e)}}}this.selectCells(e);this.updateSelectionState()};this.getCellsForSelectionState=function(){var t={};var l={};var r;var a="";var i=null;t=this.consolidateClickedCells();jQuery.each(t,function(t,n){i=e.getUtils().translateCellCoordinatesForBackend(n);a=i.axisName;r={};if(!l[a]){l[a]=[]}r["row"]=i.row;r["col"]=i.col;l[a].push(r)});return{axis:a,oCells:l}};this.sendOnSelectCommand=function(l){var r;if(e.getOnSelectCommand()){if(l){r=l.oCells}else{r=this.getCellsForSelectionState().oCells}var a=JSON.stringify(r);t.sendJson(a)}};this.sendJson=function(t){var l=e.getOnSelectCommand();if(l){var r='"';var a=new RegExp(r,"g");var i=t.replace(a,'\\"');l=l.replace("__CELLS__",i);e.getUtils().executeCommandAction(l)}};this.consolidateClickedCells=function(){var t={};var r={};var i={};var n="";var s="";if(e.getPropertyBag().isRepeatTexts()===true){return a}jQuery.each(a,function(e,a){n=a.getArea().getAxisName();if(n===l.ROW_AXIS){s=a.getText()+" "+a.getMergeKey()+" "+a.getCol();if(!t[s]){t[s]=a}}else if(n===l.COL_AXIS){s=a.getText()+" "+a.getMergeKey()+" "+a.getRow();if(!r[s]){r[s]=a}}else{i[e]=a}});return jQuery.extend(t,r,i)};this.selectCells=function(e,l){var r=this.getSelectedCells(e);jQuery.each(r,function(e,r){var a=r.getArea();if(a.isRowHeaderArea()){t.selectRowHeaderCell(r,l)}else if(a.isColHeaderArea()){t.selectColHeaderCell(r,l)}else if(a.isDataArea()){t.selectDataCell(r,l)}})};this.getSelectedCells=function(t,l){var r=t.getArea();var a={};if(r.isRowHeaderArea()||r.isColHeaderArea()){var i=r.getSelectedCellsBySelectionCoordinates(t.getRow(),t.getCol());var n=e.getDataArea().getSelectedCellsByHeaderSelection(t,l);a=jQuery.extend({},i,n)}else if(r.isDataArea()){n={};n[t.getId()]=t;var s=e.getRowHeaderArea().getSelectedCellsByDataSelection(t);var o=e.getColumnHeaderArea().getSelectedCellsByDataSelection(t);a=jQuery.extend({},n,s,o)}return a};this.checkMultiselectPossible=function(t){var l=t.getArea();var r=true;var i="";var n=null;var s=null;if(e.getSelectionMode()==="DATA"||e.getSelectionMode()==="SINGLE"){return false}if(e.getPropertyBag().isRepeatTexts()===true){return true}if(l.isRowHeaderArea()){s=l.getDataModel().getCellWithSpan(t.getRow(),Math.max(t.getCol()-1,0))}else if(l.isColHeaderArea()){s=l.getDataModel().getCellWithSpan(Math.max(t.getRow()-1,0),t.getCol())}i=s.getId();jQuery.each(a,function(e,a){if(a.getArea().getAreaType()!==l.getAreaType()){r=false;return false}if(l.isRowHeaderArea()){if(t.getCol()!==a.getCol()){r=false;return false}if(t.getCol()!==0){n=l.getDataModel().getCellWithSpan(a.getRow(),Math.max(a.getCol()-1,0));if(i!==n.getId()){r=false;return false}}}else if(l.isColHeaderArea()){if(t.getRow()!==a.getRow()){r=false;return false}if(t.getRow()!==0){n=l.getDataModel().getCellWithSpan(Math.max(a.getRow()-1,0),a.getCol());if(i!==n.getId()){r=false;return false}}}else if(l.isDataArea()){r=false;return false}return null});return r};this.startNewSelection=function(e){this.removeAllPreviousSelectionEffects();i=null;a={};a[e.getId()]=e};this.updateSelectionState=function(){var e=this.getCellsForSelectionState();t.postSelectionToServer(e);i=e.oCells;i.axis=e.axis};this.removeSelection=function(e,l){var r={};r[e.getId()]=e;if(e.isHeaderCell()===true){jQuery.each(a,function(l,a){if(a.isHeaderCell()===true){if(t.checkHeaderCellMerge(a,e)===true){r[l]=a}}})}jQuery.each(r,function(e,r){if(!l){delete a[e]}t.removePreviousSelectionEffectsForCell(r,l)});if(!l){this.updateSelectionState()}};this.removeAllPreviousSelectionEffects=function(){jQuery.each(a,function(e,l){t.removePreviousSelectionEffectsForCell(l,false)})};this.removePreviousSelectionEffectsForCell=function(e,l){var r=this.getSelectedCells(e,true);jQuery.each(r,function(e,r){var a=r.getArea();if(a.isRowHeaderArea()){t.deselectRowHeaderCell(r,l)}else if(a.isColHeaderArea()){t.deselectColHeaderCell(r,l)}else if(a.isDataArea()){t.deselectDataCell(r,l)}})};this.selectRowHeaderCell=function(e,t){var l=null;if(t===true){l="sapzencrosstab-HeaderCellHoverRow"}else{e.addStyle("SelectRow");l="sapzencrosstab-HeaderCellSelectRow"}var r=jQuery(document.getElementById(e.getId()));r.addClass(l)};this.deselectRowHeaderCell=function(e,t){var l=null;if(t===true){l="sapzencrosstab-HeaderCellHoverRow"}else{e.removeStyle("SelectRow");l="sapzencrosstab-HeaderCellSelectRow"}var r=jQuery(document.getElementById(e.getId()));r.removeClass(l)};this.selectColHeaderCell=function(e,t){var l=null;if(t===true){l="sapzencrosstab-HeaderCellHoverCol"}else{e.addStyle("SelectCol");l="sapzencrosstab-HeaderCellSelectCol"}var r=jQuery(document.getElementById(e.getId()));r.addClass(l)};this.deselectColHeaderCell=function(e,t){var l=null;if(t===true){l="sapzencrosstab-HeaderCellHoverCol"}else{e.removeStyle("SelectCol");l="sapzencrosstab-HeaderCellSelectCol"}var r=jQuery(document.getElementById(e.getId()));r.removeClass(l)};this.selectDataCell=function(e,t){var l=null;if(t===true){l="sapzencrosstab-HoverDataCell"}else{e.addStyle("SelectData");l="sapzencrosstab-DataCellSelectData"}var r=jQuery(document.getElementById(e.getId()));r.addClass(l)};this.deselectDataCell=function(e,t){var l=null;if(t===true){l="sapzencrosstab-HoverDataCell"}else{e.removeStyle("SelectData");l="sapzencrosstab-DataCellSelectData"}var r=jQuery(document.getElementById(e.getId()));r.removeClass(l)};this.setSelection=function(e){a={};i=e;if(i){i.bFromBackend=true}};this.hasSelection=function(){return r.getSizeOf(a)>0};this.handleCellHoverEntry=function(e){if(s){return}if(!this.checkSelectionAllowed(e)){if(n){t.removeSelection(n,true);n=null}return}e=this.translateClick(e);if(n&&e!==n){t.removeSelection(n,true);n=null}if(!n){if(!e||e===undefined||e.hasStyle("SelectCol")||e.hasStyle("SelectData")||e.hasStyle("SelectRow")){return}n=e;t.selectCells(e,true)}};this.handleCellHoverOut=function(e){if(n){var l=e.toElement||e.relatedTarget;var r=e.target;var a=null;var i=sap.ui.getCore().getControl(e.target.id);var s=null;var o=false;if(i){if(i===n){a=jQuery(r).find(jQuery(l));if(!(a&&a.length>0)){o=true}}}else{s=jQuery(document.getElementById(n.getId()));a=s.find(jQuery(r));if(a&&a.length>0){a=s.find(jQuery(l));if(!(a&&a.length>0)){o=true}}}if(o===true){t.removeSelection(n,true);n=null}}}};return sap.zen.crosstab.SelectionHandler});
//# sourceMappingURL=SelectionHandler.js.map