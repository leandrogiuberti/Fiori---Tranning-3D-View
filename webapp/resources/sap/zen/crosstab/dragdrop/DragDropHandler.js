/*!
 * (c) Copyright 2010-2019 SAP SE or an SAP affiliate company.
 */
sap.ui.define(["jquery.sap.global","sap/base/Log","sap/zen/crosstab/dragdrop/DragDropUtils","sap/zen/crosstab/dragdrop/DragDropAreaRenderer","sap/zen/crosstab/dragdrop/DragDropHoverManager","sap/zen/crosstab/dragdrop/MemberDragDropHandler","sap/zen/crosstab/TextConstants","sap/zen/crosstab/utils/Utils"],function(jQuery,e){"use strict";e.info("Load Drag Drop Handler");jQuery.sap.declare("sap.zen.crosstab.dragdrop.DragDropHandler");sap.zen.crosstab.dragdrop.DragDropHandler=function(e,r){var a=this;var t;var o;var n;var s;var i;this.initDragDrop=function(a){var l=r.insertmembercommand&&r.insertmembercommand.length>0;sap.zen.Dispatcher.instance.registerUnhandledDropHandler(e.getId(),e.onUnhandledDrop);sap.zen.Dispatcher.instance.registerDragDropCancelHandler(e.getId(),e.onEscKeyPressed);this.registerCrosstabAsDropHandler();n=new sap.zen.crosstab.dragdrop.DragDropHoverManager(e);t=new sap.zen.crosstab.dragdrop.DragDropUtils(e);o=new sap.zen.crosstab.dragdrop.DragDropAreaRenderer(e);if(l){s=new sap.zen.crosstab.dragdrop.MemberDragDropHandler(e,r,t,o,n)}i=e.getHeaderInfo().setupPivotCell();n.init(t);t.init(n);o.init(i,t);if(l){s.init(i)}if(i){this.enableDimHeaderNonPivotCells();this.enableDimHeaderPivotCell();if(!a){o.renderDimHeaderDropAreas();this.enableDimHeaderDropAreas()}}this.addExternalDimensionDropAreasIfOnlyMeasures()};this.addExternalDimensionDropAreasIfOnlyMeasures=function(){var r;var a;t.setOnlyMeasuresMode(false);if(sap.zen.crosstab.utils.Utils.isDispatcherAvailable()){if(sap.zen.Dispatcher.instance.isInterComponentDragDropEnabled()&&e.getHeaderInfo().hasOnlyMeasureStructure()){t.setOnlyMeasuresMode(true);r=e.getTableCell(0,0);if(r&&document.getElementById(r.getId())){a=o.createExternalDimDropAreasForMemberCell(r);this.makeAboveAreaDroppable(a.oJqAboveArea,"sapzencrosstab-rowAboveCellDropArea");this.makeBeforeAreaDroppable(a.oJqBeforeArea,"sapzencrosstab-columnBeforeCellDropArea")}}}};this.returnFromDimHeaderDropAccept=function(e,r,a){e.setRevertDrop(a);sap.zen.Dispatcher.instance.setDropAccepted(e.getId(),r);return r};function l(){var r;var o;var s;var i;i=n.getCellFromJqCell(this);r=sap.zen.Dispatcher.instance.getDragDropPayload();if(e.isBlocked()||!r||r&&r.oDragDropInfo.bIsMemberDrag){return a.returnFromDimHeaderDropAccept(i,false,true)}if(!t.checkAcceptExternalDimension(r)){return a.returnFromDimHeaderDropAccept(i,false,true)}if(!t.checkDroppableInArea(jQuery(this),t.determineValidHeaderRect())){return a.returnFromDimHeaderDropAccept(i,false,false)}s=e.getHeaderInfo().getDimensionInfoByRowCol(i);if(t.isExternalDropOnNonRemovableStructure(s,r)){return a.returnFromDimHeaderDropAccept(i,false,true)}if(t.isDragFromOtherCrosstab(r)){return a.returnFromDimHeaderDropAccept(i,false,true)}if(!t.checkAcceptCrossComponent(r)){return a.returnFromDimHeaderDropAccept(i,false,true)}if(r.oDragDropInfo){o=r.oDragDropInfo;if(s&&s.sDimensionName===o.sDimensionName){return a.returnFromDimHeaderDropAccept(i,false,true)}}else{return a.returnFromDimHeaderDropAccept(i,false,true)}return a.returnFromDimHeaderDropAccept(i,true,false)}function D(a){var o;var s;var i;var l;var D;if(t.checkDropAllowedOnCrosstabElement(a)){D=sap.zen.Dispatcher.instance.getDragDropPayload();if(D&&D.oDragDropInfo){l=n.getCellFromJqCell(this);o=D.oDragDropInfo.sDimensionName;s=e.getHeaderInfo().getDimensionInfoByRowCol(l);i=s?s.sDimensionName:null;if(o&&o.length>0&&i&&i.length>0){if(o!==i){var p=r.swapdimensionscommand.replace("__DIMENSION_NAME__",o);p=p.replace("__WITH_DIMENSION_NAME__",i);e.getUtils().executeCommandAction(p)}}}t.resetDragDrop()}}this.getTextForDragGhostCell=function(r,a,t){var o=null;var n;if(a.bIsMeasureStructure===true){o=t}else{if(r.isSplitPivotCell()===true){if(a.sAxisName==="ROWS"){n=e.getHeaderInfo().getDimensionInfoByCol(r.getTableCol())}else if(a.sAxisName==="COLS"){n=e.getHeaderInfo().getDimensionInfoByRow(r.getTableRow())}if(n){if(n.sAttributeName){o=n.sAttributeText}else{o=n.sDimensionText}}else{o=r.getText()}}else{o=r.getText()}}if(!o||o&&o.length===0){o=a.sDimensionText}return o};this.getDragGhostCellHtml=function(e,r,a){var t;var o;var n;var s;var i;var l;o=jQuery(document.getElementById(e.getId()));if(!r.bIsStructure){n=jQuery(document.getElementById(e.getId()+"_cellLayoutDiv"));s=n.outerWidth();l=s+"px"}else{l="100%"}t=this.getTextForDragGhostCell(e,r,a);i='<td class="'+o.attr("class")+" sapzencrosstab-DragHeaderCell"+'">';i+='<div style="width: '+l+'">'+t+"</div></td>";return i};this.createDimHeaderCellDragObject=function(r,a){var o=null;var n=0;var s;var i;var l;var D;var p;var c;if(a.bIsMeasureStructure===true){l=e.getPropertyBag().getText(sap.zen.crosstab.TextConstants.MEASURE_STRUCTURE_TEXT_KEY);D=1}else{D=r.length}i='<table id="'+e.getId()+'_dragghost" style="z-index: 9999;border-collapse: collapse" class="sapzencrosstab-DimensionHeaderArea"><tbody>';i+=t.getDeleteDragGhostCellRowHtml(a.sAxisName==="ROWS"?r.length:1);if(a.sAxisName==="ROWS"){s=r[0];p=jQuery(document.getElementById(s.getId())).outerHeight();i+='<tr style="height: '+p+'px">';for(n=0;n<D;n++){s=r[n];i+=this.getDragGhostCellHtml(s,a,l)}i+="</tr>"}else if(a.sAxisName==="COLS"){for(n=0;n<D;n++){s=r[n];p=jQuery(document.getElementById(s.getId())).outerHeight();i+='<tr style="height: '+p+'px">';i+=this.getDragGhostCellHtml(s,a,l);i+="</tr>"}}i+="</tbody></table>";o=jQuery(i);c=sap.zen.Dispatcher.instance.createDragDropPayload(e.getId());c.oDragDropInfo=t.buildDimensionDragDropInfo(a);sap.zen.Dispatcher.instance.setDragDropPayload(c);e.setDragAction(true);return o};function p(){var r;var o;var s;var i=[];r=n.getCellFromJqCell(this);if(r){t.setCurrentJqDragCell(jQuery(this));s=e.getHeaderInfo().getDimensionInfoByRowCol(r);i=e.getHeaderInfo().getCellsWithSameDimension(r);t.saveRevertCellPosInfo(r,i);o=a.createDimHeaderCellDragObject(i,s);t.setCursorAt(r,o)}return o}this.makeAboveAreaDroppable=function(r,o){var n=t.getAreaInfo(r);var s=function(r){var o;if(t.checkDropAllowedOnCrosstabElement(r)){if(t.isOnlyMeasuresMode()===true){o={};o.sDragDimensionName=t.getDimensionNameDromDragDropPayload();o.sDropAxisName="COLS";o.iDropAxisIndex=0}else{o=t.getCellInfoFromDropArea(r,"droparea_above");if(o){if(o.sDropAxisName==="ROWS"&&e.getTableMaxDimHeaderRow()===0){o.sDropAxisName="COLS";o.iDropAxisIndex=0}}}if(o){a.sendInsertDimensionCommand(o)}t.resetDragDrop()}};var i=function(e){return t.checkGenericDimMoveToAreasAccept(r,e,n.oDimInfo,n.oCell,"droparea_above",false)};t.makeDropAreaDroppable(r,o,i,s)};this.makeBelowAreaDroppable=function(r,o){var n=t.getAreaInfo(r);var s=function(r){var o;if(t.checkDropAllowedOnCrosstabElement(r)){o=t.getCellInfoFromDropArea(r,"droparea_below");if(o){if(o.bDropCellIsBottomRight===true){o.sDropAxisName="COLS";o.iDropAxisIndex=e.getHeaderInfo().getNumberOfDimensionsOnColsAxis()}else{o.iDropAxisIndex++}a.sendInsertDimensionCommand(o)}t.resetDragDrop()}};var i=function(e){return t.checkGenericDimMoveToAreasAccept(r,e,n.oDimInfo,n.oCell,"droparea_below",false)};t.makeDropAreaDroppable(r,o,i,s)};this.makeBeforeAreaDroppable=function(r,o){var n=t.getAreaInfo(r);var s=function(r){var o;if(t.checkDropAllowedOnCrosstabElement(r)){if(t.isOnlyMeasuresMode()===true){o={};o.sDragDimensionName=t.getDimensionNameDromDragDropPayload();o.sDropAxisName="ROWS";o.iDropAxisIndex=0}else{o=t.getCellInfoFromDropArea(r,"droparea_before");if(o){if(o.sDropAxisName==="COLS"&&e.getTableMaxDimHeaderCol()===0){o.sDropAxisName="ROWS";o.iDropAxisIndex=0}}}if(o){a.sendInsertDimensionCommand(o)}t.resetDragDrop()}};var i=function(e){return t.checkGenericDimMoveToAreasAccept(r,e,n.oDimInfo,n.oCell,"droparea_before",false)};t.makeDropAreaDroppable(r,o,i,s)};this.makeAfterAreaDroppable=function(r,o){var n=t.getAreaInfo(r);var s=function(r){var o;if(t.checkDropAllowedOnCrosstabElement(r)){o=t.getCellInfoFromDropArea(r,"droparea_after");if(o){if(o.bDropCellIsBottomRight===true){o.sDropAxisName="ROWS";o.iDropAxisIndex=e.getHeaderInfo().getNumberOfDimensionsOnRowsAxis()}else{o.iDropAxisIndex++}a.sendInsertDimensionCommand(o)}t.resetDragDrop()}};var i=function(e){var a=t.checkGenericDimMoveToAreasAccept(r,e,n.oDimInfo,n.oCell,"droparea_after",true);return a};t.makeDropAreaDroppable(r,o,i,s)};this.enableDimHeaderDropAreas=function(){var r=jQuery(document.getElementById(e.getId()));var t=null;var o=null;var n=null;var s=null;var i=null;var l=null;t="sapzencrosstab-columnBeforeCellDropArea";o=r.find("."+t);jQuery.each(o,function(e,r){a.makeBeforeAreaDroppable(jQuery(r),t)});t="sapzencrosstab-columnAfterCellDropArea";n=r.find("."+t);jQuery.each(n,function(e,r){a.makeAfterAreaDroppable(jQuery(r),t)});t="sapzencrosstab-columnAfterCellDropAreaWithSort";s=r.find("."+t);jQuery.each(s,function(e,r){a.makeAfterAreaDroppable(jQuery(r),t)});t="sapzencrosstab-rowAboveCellDropArea";i=r.find("."+t);jQuery.each(i,function(e,r){a.makeAboveAreaDroppable(jQuery(r),t)});t="sapzencrosstab-rowBelowCellDropArea";l=r.find("."+t);jQuery.each(l,function(e,r){a.makeBelowAreaDroppable(jQuery(r),t)})};this.getPivotCellAreaFromMouseCoordinates=function(r,a){var t=null;var o=document.getElementById(a.getId()+"_dragarea_cols");var n=o.getBoundingClientRect();var s=r.clientX-n.left;var i=r.clientY-n.top;var l=s*n.height/n.width;if(e.getPropertyBag().isRtl()){l=n.height-l}i>l?t="ROWS":t="COLS";return t};function c(r){var o;var s;var i;var l=null;var D;var p;var c;c=n.getCellFromJqCell(this);s=c.getTableCol();i=c.getTableRow();o=a.getPivotCellAreaFromMouseCoordinates(r,c);if(o==="ROWS"){D=e.getHeaderInfo().getDimensionInfoByCol(s)}else if(o==="COLS"){D=e.getHeaderInfo().getDimensionInfoByRow(i)}l=e.getHeaderInfo().getCellsWithSameDimensionByDimInfo(D);t.saveRevertCellPosInfo(c,l,o);p=a.createDimHeaderCellDragObject(l,D);t.setCursorAt(c,p);return p}this.makeSplitPivotCellDraggable=function(e,r){o.renderSplitPivotCellDragAreas(e,r);t.makeCellDraggable(r,c)};this.enableDimHeaderNonPivotCells=function(){var r=0;var a=0;var o=i.getTableRow();var n=i.getTableCol();var s=null;var c=null;while(a<n){s=e.getTableCellWithColSpan(o,a);if(s){c=jQuery(document.getElementById(s.getId()));t.makeCellDraggable(c,p);t.makeCellDroppable(c,l,D);a=a+s.getColSpan()}}while(r<o){s=e.getTableCellWithRowSpan(r,n);if(s){c=jQuery(document.getElementById(s.getId()));t.makeCellDraggable(c,p);t.makeCellDroppable(c,l,D);r=r+s.getRowSpan()}}};this.isNonSplitPivotCellDragDropEnabled=function(){var r=true;if(i&&!i.isSplitPivotCell()){if(i.getScalingAxis()==="COLS"){r=e.getHeaderInfo().hasDimensionsOnRowsAxis()}else if(i.getScalingAxis()==="ROWS"){r=e.getHeaderInfo().hasDimensionsOnColsAxis()}}return r};this.enableDimHeaderPivotCell=function(){var e;if(i){e=jQuery(document.getElementById(i.getId()));if(i.isPivotCell()===true&&i.isSplitPivotCell()===true){this.makeSplitPivotCellDraggable(i,e)}else{if(this.isNonSplitPivotCellDragDropEnabled()){t.makeCellDraggable(e,p);t.makeCellDroppable(e,l,D)}}}};this.onUnhandledDrop=function(a,o,n){var i;var l=false;var D=false;if(sap.zen.Dispatcher.instance.isDragDropCanceled()){return}if(!n){sap.zen.Dispatcher.instance.setDragDropCanceled(true);return}if(t.checkMouseInRenderSizeDiv(a)===true){sap.zen.Dispatcher.instance.setDragDropCanceled(true)}else if(n&&n.oDragDropInfo){i=n.oDragDropInfo;if(i.bIsMemberDrag){s.removeMember(a,o,i)}else{l=i.bIsStructure;D=i.bIsRemoveStructureAllowed;if(l&&!D){sap.zen.Dispatcher.instance.setDragDropCanceled(true)}else{if(i.sDimensionName&&i.sDimensionName.length>0){var p=r.removedimensioncommand.replace("__DIMENSION_NAME__",i.sDimensionName);e.getUtils().executeCommandAction(p)}else{sap.zen.Dispatcher.instance.setDragDropCanceled(true)}}}}};this.onEscKeyPressed=function(){var e;sap.zen.Dispatcher.instance.setDragDropCanceled(true);e=t.getCurrentJqDragCell();if(e){e.draggable().trigger("mouseup")}else{t.resetDragDrop()}n.cleanupDropCells();n.cleanupDropAreas()};this.repositionDropAreasForHeaderScrolling=function(){o.repositionDropAreasForHeaderScrolling()};this.sendInsertDimensionCommand=function(a){var t=r.insertdimensioncommand;if(a&&t&&t.length>0){t=t.replace("__DIMENSION_NAME__",a.sDragDimensionName);t=t.replace("__AXIS__",a.sDropAxisName);t=t.replace("__AXIS_INDEX__",a.iDropAxisIndex);e.getUtils().executeCommandAction(t)}};this.registerCrosstabAsDropHandler=function(){var r;r=jQuery(document.getElementById(e.getId()));if(!r.hasClass("ui-droppable")){r.droppable({greedy:true,accept:function(){return true},drop:function(e,r){if(!e.buttons){sap.zen.Dispatcher.instance.onUnhandledDrop(e,r)}}})}}};return sap.zen.crosstab.dragdrop.DragDropHandler});
//# sourceMappingURL=DragDropHandler.js.map