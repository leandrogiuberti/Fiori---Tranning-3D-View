/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
"use strict";sap.ui.define(["sap/cards/ap/common/odata/ODataUtils","sap/cards/ap/generator/helpers/NavigationProperty","sap/cards/ap/generator/odata/v2/MetadataAnalyzer","sap/cards/ap/generator/odata/v4/MetadataAnalyzer","sap/ui/VersionInfo","sap/ui/core/Element","sap/ui/model/odata/ODataUtils","sap/ui/model/odata/v4/ODataUtils","../odata/ODataUtils","../pages/Application","../types/CommonTypes","../utils/CommonUtils","./Batch","./I18nHelper","./PropertyExpression"],function(t,e,n,r,o,a,i,s,c,u,p,l,f,d,m){"use strict";const h=typeof Symbol!=="undefined"?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function y(t,e,n){if(!t.s){if(n instanceof g){if(n.s){if(e&1){e=n.s}n=n.v}else{n.o=y.bind(null,t,e);return}}if(n&&n.then){n.then(y.bind(null,t,e),y.bind(null,t,2));return}t.s=e;t.v=n;const r=t.o;if(r){r(t)}}}const g=function(){function t(){}t.prototype.then=function(e,n){const r=new t;const o=this.s;if(o){const t=o&1?e:n;if(t){try{y(r,1,t(this.v))}catch(t){y(r,2,t)}return r}else{return this}}this.o=function(t){try{const o=t.v;if(t.s&1){y(r,1,e?e(o):o)}else if(n){y(r,1,n(o))}else{y(r,2,o)}}catch(t){y(r,2,t)}};return r};return t}();function v(t){return t instanceof g&&t.s&1}function E(t,e,n){var r=-1,o,a;function i(s){try{while(++r<t.length&&(!n||!n())){s=e(r);if(s&&s.then){if(v(s)){s=s.v}else{s.then(i,a||(a=y.bind(null,o=new g,2)));return}}}if(o){y(o,1,s)}else{o=s}}catch(t){y(o||(o=new g),2,t)}}i();return o}const P=function(t,e){try{if(!t){return Promise.resolve()}const n=e.getManifestEntry("sap.app").id;return Promise.resolve(o.load({library:"sap.ui.core"})).then(function(e){const r=e;t["sap.insights"]={templateName:"ObjectPage",parentAppId:n,cardType:"LEAN_DT",versions:{ui5:r.version+"-"+r.buildTimestamp}}})}catch(t){return Promise.reject(t)}};function x(t,e,n){if(typeof t[h]==="function"){var r=t[h](),o,a,i;function p(t){try{while(!(o=r.next()).done&&(!n||!n())){t=e(o.value);if(t&&t.then){if(v(t)){t=t.v}else{t.then(p,i||(i=y.bind(null,a=new g,2)));return}}}if(a){y(a,1,t)}else{a=t}}catch(t){y(a||(a=new g),2,t)}}p();if(r.return){var s=function(t){try{if(!o.done){r.return()}}catch(t){}return t};if(a&&a.then){return a.then(s,function(t){throw s(t)})}s()}return a}if(!("length"in t)){throw new TypeError("Object is not iterable")}var c=[];for(var u=0;u<t.length;u++){c.push(t[u])}return E(c,function(t){return e(c[t])},n)}const b=t["handleSingleProperty"];function S(t,e){try{var n=t()}catch(t){return e(t)}if(n&&n.then){return n.then(void 0,e)}return n}const I=t["isSingleKeyWithoutAssignment"];const O=e["getNavigationPropertiesWithLabel"];const C=n["getPropertyReference"];const T=r["getPropertyReferenceKey"];const $=c["getDataType"];const _=c["isODataV4Model"];const M=u["Application"];const D=u["ODataModelVersion"];const F=p["ColorIndicator"];const A=l["extractValueWithoutBooleanExprBinding"];const N=l["getColorForGroup"];const V=l["hasBooleanBindingExpression"];const Q=f["updateManifestWithExpandQueryParams"];const w=f["updateManifestWithSelectQueryParams"];const j=d["getYesAndNoTextValues"];const W=d["resolveI18nTextFromResourceModel"];const K=m["extractPathExpressionWithoutUOM"];const U=m["extractPathWithoutUOM"];const L=m["extractPropertyConfigurationWithoutTextArrangement"];const B=m["getTextArrangementFromCardManifest"];const G=m["hasFormatter"];const R=m["isExpression"];const k=m["isI18nExpression"];const q=m["updateAndGetSelectedFormatters"];let z;const H=[];function J(t){const{title:e,subTitle:n,description:r,service:o,serviceModel:a,sapAppId:i,sapCoreVersionInfo:s,entitySetName:c,entitySetWithObjectContext:u,data:p}=t;const l=_(a);if(!l){ot(u,p)}const f=l?"/content/":"/content/d/";const d=l?"/header/":"/header/d/";const m=l?T(a,c):C(a,c);const h={};const{yesText:y,noText:g}=j();m.forEach(t=>{if(t.type==="Edm.Boolean"&&typeof p[t.name]==="string"){p[t.name]=p[t.name]===y}h[t.name]={type:$(t.type),value:p[t.name]}});const v=m.map(t=>t.name);z={_version:"1.15.0","sap.app":{id:`${i}.cards.op.${c}`,type:"card",i18n:"../../../i18n/i18n.properties",title:e,subTitle:n,description:r,applicationVersion:{version:"1.0.0"}},"sap.ui":{technology:"UI5",icons:{icon:"sap-icon://switch-classes"}},"sap.card":{extension:"module:sap/cards/ap/common/extensions/BaseIntegrationCardExtension",type:"Object",configuration:{parameters:{...h,_contentSelectQuery:{value:v?.length?`$select=${v.join(",")}`:""},_headerSelectQuery:{value:v?.length?`$select=${v.join(",")}`:""},_contentExpandQuery:{value:""},_headerExpandQuery:{value:""},_entitySet:{type:"string",value:c},_yesText:{type:"string",value:y},_noText:{type:"string",value:g}},destinations:{service:{name:"(default)",defaultUrl:"/"}},csrfTokens:{token1:{data:{request:{url:`{{destinations.service}}${o}`,method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}}}}},data:{request:{url:`{{destinations.service}}${o}/$batch`,method:"POST",headers:{"X-CSRF-Token":"{{csrfTokens.token1}}","Accept-Language":"{{parameters.LOCALE}}"},batch:{header:{method:"GET",url:Y(),headers:{Accept:"application/json","Accept-Language":"{{parameters.LOCALE}}"},retryAfter:30},content:{method:"GET",url:Z(),headers:{Accept:"application/json","Accept-Language":"{{parameters.LOCALE}}"}}}}},header:{data:{path:d},type:"Numeric",title:e,subTitle:n,unitOfMeasurement:"",mainIndicator:{number:"",unit:""}},content:{data:{path:f},groups:[]}},"sap.ui5":{_version:"1.1.0",contentDensities:{compact:true,cozy:true},dependencies:{libs:{"sap.insights":{lazy:false}}}},"sap.insights":{templateName:"ObjectPage",parentAppId:i,cardType:"LEAN_DT",versions:{ui5:s.version+"-"+s.buildTimestamp}}};return z}function X(){const{rootComponent:t,entitySet:e}=M.getInstance().fetchDetails();const n=t.getModel();const r=[];const o=_(n);if(o){const t=T(n,e);t.forEach(t=>{const e=s.formatLiteral(`{{parameters.${t.name}}}`,t.type);r.push(`${t.name}=${e}`)})}else{const t=C(n,e);t.forEach(t=>{let e="";if(t.type==="Edm.DateTimeOffset"||t.type==="Edm.DateTime"){const n=t.type==="Edm.DateTimeOffset"?"datetimeoffset":"datetime";e=n+`'{{parameters.${t.name}}}'`}else{e=i.formatValue(`{{parameters.${t.name}}}`,t.type,true)}r.push(`${t.name}=${e}`)})}return r.join(",")}function Y(){return`{{parameters._entitySet}}(${X()})?{{parameters._headerSelectQuery}}{{parameters._headerExpandQuery}}`}function Z(){return`{{parameters._entitySet}}(${X()})?{{parameters._contentSelectQuery}}{{parameters._contentExpandQuery}}`}function tt(){return z||{}}function et(t,e){z={...t};w(z);e&&Q(z);const n=a.getElementById("cardGeneratorDialog--cardPreview");if(n){n.setBaseUrl("./");n.setManifest(z);n.refresh()}}function nt(t){const e=t.getProperty("/configuration/groups");const n=t?.getProperty("/configuration/mainIndicatorOptions/criticality");const r=e.map(function(t){const e=t?.items?.filter(function(t){return t.name}).map(t=>{const e=n?.filter(e=>{if(t?.navigationProperty){return`${e.name}/${e?.propertyKeyForId}`===`${t.name}/${t.navigationProperty}`}return e.name===t.name});let r;if(e?.[0]?.criticality){const t=e[0]?.activeCalculation?e[0]:e[0]?.criticality;r=N(t)}const o={label:t.label,value:t.value,name:t.name};if(r){o.state=r;o.type="Status";o.showStateIcon=true}if(t.hasActions){o["actions"]=t.actions;o["hasActions"]=t.hasActions;o["actionType"]=t.actionType}return o});return{title:t.title,items:e?e:[]}});z["sap.card"].content.groups=r;et(z,t)}function rt(t,e,n){if(k(t)){return W(t,e)}if(R(t)&&!G(t)){let e="";if(V(t)){e=A(t)}else{e=U(t)}return n.find(t=>t.name===e)?.labelWithValue??""}if(R(t)&&G(t)){const e=K(t);const r=q(e);pt(r);return n.find(t=>t.name===r.property)?.labelWithValue??""}return t}function ot(t,e){const n=t=>{const[e,n]=t.split("=");if(n==="true"||n==="false"){return[e,n==="true"]}const r=n.replace(/guid|datetimeoffset|datetime|'*/g,"");return[e,r]};const r=t=>{for(const r of t){const[t,o]=n(r);e[t]=o}};const o=t.indexOf("(");const a=t.indexOf(")");const i=t.slice(o+1,a);const s=i.split(",");if(I(s)){const r=t.split("(")[0];const o=M.getInstance().getRootComponent().getModel();const a=C(o,r);const i=b(a,s).join(",");const[c,u]=n(i);e[c]=u}else{r(s)}}function at(t){const e=t["sap.card"].header.mainIndicator;let n="";let r={referenceValue:"",downDifference:"",upDifference:""};const o=[];const a=t["sap.card"].content.groups;if(a.length>0){it(t,o)}if(!e||!e.number){return{mainIndicatorStatusKey:"",mainIndicatorNavigationSelectedKey:"",criticalityOptions:o,navigationValue:"",trendOptions:r}}const{propertyPath:i,formatterExpression:s}=L(e.number,t);const c=e.state;if(s.length){const t=s.map(q);t.forEach(pt)}if(R(i)&&!G(i)){if(V(i)){n=A(i)}else{n=U(i)}}if(e.trend&&e.trend!=="None"){const t=e.trend;const n=/"referenceValue":(\d+),"downDifference":(\d+),"upDifference":(\d+)/;const o=t.match(n);if(o){r={referenceValue:o[1]||"",downDifference:o[2]||"",upDifference:o[3]||""}}}if(R(i)&&G(i)){const t=K(i);const e=q(t);pt(e);n=e.property||""}let u={criticality:"",name:"",activeCalculation:false};if(c&&G(c)){const t=K(c);const e=q(t);pt(e);u={criticality:"{"+e.property+"}",name:n,activeCalculation:false}}else if(c&&c!=="None"){u={criticality:c,name:n,activeCalculation:false}}if(u.name.length){st(o,u)}let p="";let l=n;if(n.includes("/")){l=n.split("/")[0];p=n.split("/")[1]}return{mainIndicatorStatusKey:l,mainIndicatorNavigationSelectedKey:p,criticalityOptions:o,navigationValue:n,trendOptions:r}}function it(t,e){const n=t["sap.card"].content.groups;n.forEach(t=>{t.items.forEach(t=>{if(t.state){const n=ct(t.state);const r=/\/([^,}]+)/;const o=t.value.match(r);let a;if(o){a=o[1]}const i={criticality:n,name:a?`${t.name}/${a}`:t.name,activeCalculation:false};st(e,i)}})})}function st(t,e){const n=t.some(t=>t.name===e.name);if(!n){t.push(e)}}function ct(t){if(t&&G(t)){const e=K(t);const n=q(e);pt(n);return"{"+n.property+"}"}if(t&&t in F){return F[t]}return F.None}function ut(t){const e=t["sap.card"].header.sideIndicators||[];if(e.length===0||!e[0].number){return{targetValue:"",targetUnit:"",deviationValue:"",deviationUnit:""}}const[n={},r={}]=e;const{number:o="",unit:a=""}=n;const{number:i="",unit:s=""}=r;return{targetValue:o,targetUnit:a,deviationValue:i,deviationUnit:s}}function pt(t){if(H.length===0||!H.find(e=>e.property===t.property)){H.push({...t})}}function lt(t,e){const{formatterExpression:n}=L(t,e);if(n.length){const t=n.map(q);t.forEach(pt)}return t}function ft(t,e){const n=t["sap.card"].content.groups;if(n.length===0){return[]}return n.map(n=>({title:W(n.title,e),items:n.items.map(n=>{const r={label:W(n.label,e),value:lt(n.value,t),name:n.name,isEnabled:true,isNavigationEnabled:false};if(n.hasActions){r.actions=n.actions;r.hasActions=n.hasActions;r.actionType=n.actionType}if(n.state){r.type="Status";r.state=n.state}return r})}))}function dt(t,e){const n=t["sap.card"];const r=M.getInstance();const o=r.getRootComponent();const a=o.getModel();const{odataModel:i,entitySet:s}=r.fetchDetails();const c=[];if(i===D.V4){T(a,s).forEach(t=>c.push(t.name))}else{C(a,s).forEach(t=>c.push(t.name))}if(!n.configuration){n.configuration={parameters:{}}}if(!n.configuration?.parameters){n.configuration.parameters={}}const u=n.configuration?.parameters;u["_propertyFormatting"]={};const p=e.getProperty("/configuration/advancedFormattingOptions/textArrangements");const l=It(e);const f={};p.forEach(({name:t,arrangementType:e,value:n})=>{if(t&&l.includes(t)&&e&&n){f[t]={arrangements:{text:{[e]:true,path:n}}}}});if(Object.keys(f).length>0){u["_propertyFormatting"]=f}u["_mandatoryODataParameters"]={value:c};u["_entitySet"]={value:s,type:"string"};c.forEach(t=>{u[t]={type:$(t),value:""}});u["_yesText"]={type:"string",value:"{{CardGeneratorValue_Yes}}"};u["_noText"]={type:"string",value:"{{CardGeneratorValue_No}}"}}const mt=t=>{const e=JSON.parse(JSON.stringify(t));const n=e["sap.card"].data?.request?.batch;const r="?{{parameters._headerSelectQuery}}";const o="?{{parameters._contentSelectQuery}}";const a="{{parameters._headerExpandQuery}}";const i="{{parameters._contentExpandQuery}}";const s=n?.header?.url;const c=n?.content?.url;if(s?.indexOf(r)===-1){n.header.url=`${n.header.url}${r}${a}`}else if(s?.indexOf(a)===-1){n.header.url=`${n.header.url}${a}`}if(c?.indexOf(o)===-1){n.content.url=`${n.content.url}${o}${i}`}else if(c?.indexOf(i)===-1){n.content.url=`${n.content.url}${i}`}const u=e["sap.card"].configuration?.parameters;u._contentSelectQuery=u?._contentSelectQuery??{value:""};u._headerSelectQuery=u?._headerSelectQuery??{value:""};u._contentExpandQuery=u?._contentExpandQuery??{value:""};u._headerExpandQuery=u?._headerExpandQuery??{value:""};return e};const ht=(t,e)=>{const n=M.getInstance();const r=n.getRootComponent();const o=r.getModel();const{odataModel:a,entitySet:i,entitySetWithObjectContext:s}=n.fetchDetails();const c=_(o);if(!c){ot(s,e)}const u=a===D.V4?T(o,i):C(o,i);const p=t["sap.card"];if(!p.configuration){p.configuration={parameters:{}}}if(!p.configuration?.parameters){p.configuration.parameters={}}const l=p.configuration?.parameters;l["_entitySet"]={value:i,type:"string"};const{yesText:f,noText:d}=j();l["_yesText"]={type:"string",value:f};l["_noText"]={type:"string",value:d};u.forEach(t=>{if(t.type==="Edm.Boolean"&&typeof e[t.name]==="string"){e[t.name]=e[t.name]===f}l[t.name]={type:$(t.type),value:e[t.name]}})};function yt(t,e){const n=t["sap.card"].header.data;const r=e?"/header/":"/header/d/";if(n?.path){n.path=r}}const gt=(t,e)=>{if(!e){return e}e=mt(e);const n=e["sap.card"].data.request?.batch;if(n!==undefined){n.header.url=Y();n.content.url=Z()}const{componentName:r,odataModel:o,entitySet:a}=M.getInstance().fetchDetails();e["sap.app"].id=`${r}.cards.op.${a}`;e["sap.app"].i18n=e["sap.app"].i18n||"../../../i18n/i18n.properties";ht(e,t);const i=o===D.V4;yt(e,i);return e};function vt(t,e,n){const r=t["sap.card"].header.title??"";const o=t["sap.card"].header.subTitle??"";const a=t["sap.card"].header.unitOfMeasurement??"";H.splice(0,H.length);const i=B(t);return{title:rt(r,e,n),subtitle:rt(o,e,n),headerUOM:rt(a,e,n),mainIndicatorOptions:at(t),sideIndicatorOptions:ut(t),groups:ft(t,e),formatterConfigurationFromCardManifest:H,textArrangementsFromCardManifest:i}}const Et=function(t,e,n){try{const r=[...t];const o=x(e,function(t){const e=r.find(e=>e.name===t.property);const o=t.parameters?.[0].value;let a;if(V(o)){a=A(o)}else{a=o?.replace(/\$\{/g,"");a=a?.replace(/\}/g,"")}const i=t.property;const s=function(){if(e&&a){const t={...e,propertyKeyForDescription:a,value:a};const n=r.indexOf(e);r[n]=t}else{const t=function(){if(a&&i){return Promise.resolve(xt(i,a,r,n)).then(function(){})}}();if(t&&t.then)return t.then(function(){})}}();if(s&&s.then)return s.then(function(){})});return Promise.resolve(o&&o.then?o.then(function(){return r}):r)}catch(t){return Promise.reject(t)}};const Pt=function(t,e){try{const n=x(t,function(t){const n=function(){if(t.name.includes("/")){const[n,r]=t.name.split("/");const o=S(function(){return Promise.resolve(O(M.getInstance().fetchDetails().rootComponent,n,e)).then(function({propertiesWithLabel:e}){t.navigationKeyForId=r;t.navigationKeyForDescription="";t.propertyKeyForId=r;t.isNavigationForId=true;t.isNavigationForDescription=false;t.name=n;t.navigationalPropertiesForId=e})},function(t){Error("Error fetching navigation properties:"+t)});if(o&&o.then)return o.then(function(){})}}();if(n&&n.then)return n.then(function(){})});return Promise.resolve(n&&n.then?n.then(function(){return t}):t)}catch(t){return Promise.reject(t)}};const xt=function(t,e,n,r){try{if(!t){return Promise.resolve()}const o=function(){if(t.includes("/")){const[o,a]=t.split("/");const i=S(function(){return Promise.resolve(O(M.getInstance().fetchDetails().rootComponent,o,r)).then(function({propertiesWithLabel:r}){n.push({propertyKeyForDescription:e,name:t,propertyKeyForId:o,value:e,isNavigationForId:true,navigationKeyForId:a,isNavigationForDescription:false,navigationKeyForDescription:"",navigationalPropertiesForId:r})})},function(t){Error("Error fetching navigation properties:"+t)});if(i&&i.then)return i.then(function(){})}else{n.push({propertyKeyForDescription:e,name:t,propertyKeyForId:t,value:e})}}();return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(t){return Promise.reject(t)}};const bt=function(t,e,n){try{const r=t.getManifestEntry("sap.app");const{title:a,description:i,id:s}=r;const c=t.getModel();if(!c){throw new Error("No model found in the view")}const u=M.getInstance();return Promise.resolve(o.load({library:"sap.ui.core"})).then(function(t){const{serviceUrl:r,entitySet:o,entitySetWithObjectContext:p}=u.fetchDetails();const l=o;const f=gt(n.getProperty("/configuration/$data"),e)||J({title:a,subTitle:i,service:r,serviceModel:c,sapAppId:s,sapCoreVersionInfo:t,entitySetName:l,entitySetWithObjectContext:p,data:n.getProperty("/configuration/$data")});return f})}catch(t){return Promise.reject(t)}};const St=function(t,e){const n=e.getProperty("/configuration/navigationProperty")??[];for(const e of n){if(e.name===t){return true}}return false};const It=function(t){const e=t.getProperty("/configuration/title");const n=t.getProperty("/configuration/subtitle");const r=t.getProperty("/configuration/headerUOM");const o=t.getProperty("/configuration/properties")??[];const a=t.getProperty("/configuration/mainIndicatorStatusKey");const i=t.getProperty("/configuration/groups")||[];const s=i.flatMap(t=>t.items.map(t=>t.isNavigationEnabled&&t.navigationProperty?`${t.name}/${t.navigationProperty}`:t.name));if(a){if(!a.includes("/")&&St(a,t)){const e=t.getProperty("/configuration/mainIndicatorNavigationSelectedKey");s.push(`${a}/${e}`)}else{s.push(a)}}[e,n,r].forEach(t=>{o.forEach(e=>{if(e.labelWithValue===t){s.push(e.name)}})});return s};var Ot={__esModule:true};Ot.createInitialManifest=J;Ot.getCurrentCardManifest=tt;Ot.renderCardPreview=et;Ot.updateCardGroups=nt;Ot.resolvePropertyLabelFromExpression=rt;Ot.formatDataForV2=ot;Ot.getCriticallityStateForGroup=ct;Ot.enhanceManifestWithInsights=P;Ot.enhanceManifestWithConfigurationParameters=dt;Ot.addQueryParametersToManifest=mt;Ot.updateExistingCardManifest=gt;Ot.parseCard=vt;Ot.getUpdatedUnitOfMeasures=Et;Ot.updateCriticalityForNavProperty=Pt;Ot.handleFormatterWithoutMatchingProperty=xt;Ot.createCardManifest=bt;Ot.getPreviewItems=It;return Ot});
//# sourceMappingURL=IntegrationCardHelper-dbg.js.map