sap.ui.define(["sap/ui/core/Control","sap/ui/core/Item","sap/m/Select","sap/m/Input","sap/m/Button","sap/m/SelectDialog","sap/m/StandardListItem","sap/m/Text","sap/m/DatePicker","sap/ui/model/type/Float","sap/ui/model/type/Date","sap/ui/model/type/Time","sap/ui/model/type/DateTime","sap/ui/core/HTML","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","./Utils","sap/m/DateTimePicker","sap/m/TimePicker","sap/rules/ui/providers/ValueHelpProvider","sap/rules/ui/providers/ValueHelpDialogProvider","sap/ui/core/LocaleData","sap/rules/ui/Constants","sap/m/Popover","sap/base/i18n/Formatting","sap/base/i18n/date/CalendarType","sap/ui/model/type/String","sap/m/MessageBox","sap/ui/core/format/DateFormat"],function(e,t,a,n,i,r,s,o,l,u,c,p,d,h,g,T,f,v,_,S,m,E,L,C,y,N,I,O,A,D){"use strict";return e.extend("sap.rules.ui.InstructionRenderer",{metadata:{properties:{instructions:{type:"any"}},aggregations:{_content:{type:"sap.ui.core.Control",multiple:true,visibility:"hidden"}},events:{change:{}},publicMethods:["getTokensAndTexts","getExpression"]},init:function(){this.INTERNAL_MODEL="internal";this.TOKEN="token";this.TEXT="text";this.MODEL_INSTRUCTIONS="/instructions";this.LINE_GAP_CLASS="sapUiSmallMarginTop";this.TOKENS_GAP_CLASS="sapUiTinyMarginEnd";var e="'";var t="'";this.VALIDATION_REGEX="^["+t+"][^"+e+"]*["+t+"]$"+"|"+"^[^"+e+"]*$";this.lineBreakIndexes={start:{},end:{}};this._internalModel=new g({instructions:[]});this._internalModel.setSizeLimit(300);this.setModel(this._internalModel,this.INTERNAL_MODEL)},setInstructions:function(e){this.setProperty("instructions",e);this.destroyAggregation("_content");if(!e||!e.length){e=[]}this.getModel(this.INTERNAL_MODEL).setProperty(this.MODEL_INSTRUCTIONS,e)},setUseIndent:function(e){this.setProperty("useIndent",e,true);this.destroyAggregation("_content")},onBeforeRendering:function(){var e=this.getAggregation("_content");if(!e){var t=this._internalModel.getProperty(this.MODEL_INSTRUCTIONS);if(!t){return}try{var a=this._createControls(t);for(var n=0,i=a.length;n<i;++n){this.addAggregation("_content",a[n],true)}}catch(e){console.error(e)}}},renderer:{apiVersion:2,render:function(e,t){e.openStart("div",t);e.class("sapUiSizeCompact");e.openEnd();var a=t.getAggregation("_content");if(a){if(t._getIndent()){t._setTableStart(e,t)}for(var n=0,i=a.length;n<i;++n){var r=t.lineBreakIndexes.start[n];var s=t.lineBreakIndexes.end[n];if(r&&t._getIndent()){t._setLogicalOperatorStart(e,t)}e.renderControl(a[n]);if(s&&t._getIndent()){t._setLogicalOperatorEnd(e,t)}}if(t._getIndent()){t._setTableEnd(e,t)}}e.close("div")}},getTokensAndTexts:function(){var e=[];var t=this._internalModel.getProperty(this.MODEL_INSTRUCTIONS);for(var a=0,n=t.length;a<n;++a){var i=t[a];var r={text:i[this.TEXT],token:i[this.TOKEN]};e.push(r)}return e},getExpression:function(){var e=[];var t=this._internalModel.getProperty(this.MODEL_INSTRUCTIONS);for(var a=0,n=t.length;a<n;++a){var i=t[a];var r=i[this.TOKEN];e.push(r)}var s=t[t.length-1].token;if(!s&&s!==0){e.pop(t.length-1)}return e.join(" ")},_onChange:function(e){var t=e.getSource().data("instructionNum");this.fireEvent("change",{instructionNum:t})},_createControls:function(e){this.lineBreakIndexes={start:{},end:{}};var t=[];var a=[];var n,i;var r;var s;var o;for(n=0,i=e.length;n<i;++n){r=e[n];s=this._getCreateFunction(r);if(s===null){var l=" ";this._showErrorMessage(l);a=[];break}a.push(s)}for(n=0,i=a.length;n<i;++n){r=e[n];s=a[n];o=a[n+1];var u=this.MODEL_INSTRUCTIONS+"/"+n+"/";var c=this.INTERNAL_MODEL+">"+u;var p=s.apply(this,[r,o,u,c]);var d=p.controls;p.controls.forEach(function(e){e.data({instructionNum:n});if(e.attachChange){e.attachChange(this._onChange.bind(this))}}.bind(this));if(p.needLineBreak){this.lineBreakIndexes.start[t.length]=true;this.lineBreakIndexes.end[t.length+d.length-1]=true}t.push.apply(t,d)}return t},_getCreateFunction:function(e){var t=null;if(e.valueListObject){t=this._createValueListControl;return t}else if(e.visible===false){t=this._createHiddenControl}else if(e.type&&e.type==="action"){t=this._createAddRepetitiveControl}else if(e.tokenType=="ConjunctionOperator"&&!e.editable){t=this._createNonEditableLogicalOperator}else if(e.tokenType=="ConjunctionOperator"&&e.editable){t=this._createEditableLogicalOperator}else if(e.editable===false){t=this._createTextControl}else if(e.businessDataType==="Number"){t=this._createNumberControl}else if(e.businessDataType==="Date"){t=this._createDateControl}else if(e.businessDataType==="Time"){t=this._createTimeControl}else if(e.businessDataType==="Timestamp"){t=this._createDateTimeControl}else if(e.businessDataType==="TimeSpan"){t=this._createNumberControl}else if(e.businessDataType==="String"){t=this._createGeneralInputControl}else if(e.businessDataType==="Boolean"){t=this._createBooleanSelectionControl}else if(e.valueOptions&&e.valueOptions.type==="Set"){t=this._createSelectionControl}return t},_createHiddenControl:function(e,t,a,n){return[]},_createValueListControl:function(e,t,a,i){var r=this;this.valueHelpCtrl=new n({showValueHelp:true,id:"valueHelpCtrl",valueHelpRequest:function(){if(r.valueHelpCtrl.oValueHelpDialogProvider){r.valueHelpCtrl.oValueHelpDialogProvider._onInitialise()}else{E._createCpValueHelp(e,0,false,false)}},value:{path:i+this.TEXT},change:function(e){var t=e.getSource().getParent();t._syncToken(a)},width:"auto"});var s=e.valueListAnnotation;if(s){this.valueHelpCtrl.oValueHelpDialogProvider=new m({annotation:s.primaryValueListAnnotation,additionalAnnotations:s.additionalAnnotations,control:this.valueHelpCtrl,model:e.valueListObject.model,preventInitialDataFetchInValueHelpDialog:false,supportMultiSelect:false,supportRanges:false,takeOverInputValue:false,fieldName:s.primaryValueListAnnotation.valueListTitle,title:s.primaryValueListAnnotation.valueListTitle,cursorPosition:0,bReplaceWord:false,businessDataType:"string",bAddSpace:false});var o=this.getParent().getParent();if(o instanceof y){this.valueHelpCtrl.oValueHelpDialogProvider._popover=o}}this.valueHelpCtrl.addStyleClass(this.TOKENS_GAP_CLASS);return{controls:[this.valueHelpCtrl],needLineBreak:false}},_createSelectionControl:function(e,n,i,r){var s=this.getParent();var o=new a({items:{path:r+"valueOptions/values",template:new t({key:"{"+this.INTERNAL_MODEL+">"+this.TOKEN+"}",text:"{"+this.INTERNAL_MODEL+">"+this.TEXT+"}"})},forceSelection:false,selectedKey:"{"+r+this.TOKEN+"}",width:"auto",change:function(e){},enabled:s.bReadOnly&&s.isA("sap.rules.ui.DecisionTableCellExpressionBasics")?false:true});o.addStyleClass(this.TOKENS_GAP_CLASS);return{controls:[o],needLineBreak:false}},_createAddRepetitiveControl:function(e,t,a,n){var r=[];var s=new i({text:"",press:e.callback});s.setIcon("sap-icon://add");r.push(s);return{controls:r,needLineBreak:false}},_createTextControl:function(e,t,a,n){var i=[];var r=new o({text:"{"+n+this.TEXT+"}",width:"auto"}).addStyleClass("sapUiTinyMarginTop").addStyleClass("sapRULExpressionBasic");i.push(r);return{controls:i,needLineBreak:false}},_createNumberControl:function(e,t,a,i){var r=this._createValueRange(e);var s=new n({width:"auto",type:"Text",value:{path:i+this.TOKEN,type:new u({minIntegerDigits:0,minFractionDigits:0},r)},valueStateText:this._getValueStateText(r),change:function(e){}});s.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(s);return{controls:[s],needLineBreak:false}},_createDateControl:function(e,t,a,n){var i=this._createValueRange(e);this._removeTextSingleQuote(a);var r=new l({width:"auto",type:"Date",value:{path:n+this.TEXT},valueStateText:this._getValueStateText(i),change:function(e){var t=e.getSource().getParent();t._syncToken(a)}});r.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(r);return{controls:[r],needLineBreak:false}},_createTimeControl:function(e,t,a,n){var i=this._createValueRange(e);this._removeTextSingleQuote(a);var r=N.getLanguageTag();var s=L.getInstance(r);var o=s.getTimePattern("medium");var l=new S({width:"auto",type:"Time",value:{path:n+this.TEXT},valueStateText:this._getValueStateText(i),change:function(e){var t=e.getSource().getParent();t._syncToken(a)},valueFormat:o});l.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(l);return{controls:[l],needLineBreak:false}},_createDateTimeControl:function(e,t,a,n){var i=this._createValueRange(e);this._removeTextSingleQuote(a);var r=N.getLanguageTag();var s=L.getInstance(r);var o=s.getDatePattern("short");var l=s.getTimePattern("medium");var u=o+" "+l;var c=new _({width:"auto",value:{path:n+this.TEXT},valueStateText:this._getValueStateText(i),change:function(e){var t=e.getSource().getParent();t._syncToken(a)},valueFormat:u});c.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(c);return{controls:[c],needLineBreak:false}},_createGeneralInputControl:function(e,t,a,i){this._removeTextSingleQuote(a);var r=new n({value:{path:i+this.TEXT,type:new O(null,{search:this.VALIDATION_REGEX})},width:"auto",change:function(e){var t=e.getSource();var n=t.getValue();t.setValue(n.replace(/\'/g,""));var i=e.getSource().getParent();i._syncToken(a)}});r.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(r);return{controls:[r],needLineBreak:false}},_createBooleanSelectionControl:function(e,t,n,i){var r=new a({selectedKey:"{"+i+this.TOKEN+"}",width:"auto",items:[{text:"true",key:"true"},{text:"false",key:"false"}],forceSelection:false});r.addStyleClass(this.TOKENS_GAP_CLASS);return{controls:[r],needLineBreak:false}},_createNonEditableLogicalOperator:function(e,t,a,n){var i=this._createLineBreak();var r=[];var s=new h({content:"<B class='sapMText sapUiTinyMarginTop sapUiTinyMarginEnd'>"+e[this.TEXT]+"</B>"});if(!this._getIndent()){r.push(i)}r.push(s);return{controls:r,needLineBreak:true}},_createEditableLogicalOperator:function(e,n,i,r){var s=this._createLineBreak();var o=[];var l=new a({items:{path:r+"valueOptions/values",template:new t({key:"{"+this.INTERNAL_MODEL+">"+this.TOKEN+"}",text:"{"+this.INTERNAL_MODEL+">"+this.TEXT+"}"})},selectedKey:"{"+r+this.TOKEN+"}",width:"auto",change:function(e){}});l.addStyleClass(this.TOKENS_GAP_CLASS);if(!this._getIndent()){o.push(s)}o.push(l);return{controls:o,needLineBreak:true}},_createSpace:function(){var e=new h({content:"<span>&nbsp;</span>"});return e},_createLineBreak:function(){var e=new h({content:'<DIV class="'+this.LINE_GAP_CLASS+'"></DIV>'});return e},_setTableStart:function(e,t){e.openStart("table",t);e.openEnd();e.openStart("td",t);e.openEnd();e.close("td");e.openStart("td",t);e.openEnd();oRm.class("sapRULExpressionBasicVerticalAlign");e.openEnd()},_setTableEnd:function(e,t){oRm.close("td");oRm.close("tr");oRm.close("table")},_setLogicalOperatorStart:function(e,t){e.openStart("div",t);oRm.class(this.LINE_GAP_CLASS);e.openEnd();oRm.close("td");oRm.close("tr");e.openStart("tr",t);e.openEnd();e.openStart("td",t);oRm.class("sapRULExpressionBasicVerticalAlign");e.openEnd()},_setLogicalOperatorEnd:function(e,t){oRm.close("td");e.openStart("td",t);oRm.class("sapRULExpressionBasicVerticalAlign");e.openEnd()},_getTableStart:function(){return'<table><td></td><td class="sapRULExpressionBasicVerticalAlign">'},_getTableEnd:function(){return"</td></tr></table>"},_getLogicalOperatorStart:function(){return'<div class="'+this.LINE_GAP_CLASS+'"></td></tr><tr><td class="sapRULExpressionBasicVerticalAlign">'},_getLogicalOperatorEnd:function(){return'</td><td class="sapRULExpressionBasicVerticalAlign">'},_getIndent:function(){var e;try{e=this.getProperty("useIndent")}catch(t){e=false}return e},_createValueRange:function(e){var t=null;if(e.valueOptions&&e.valueOptions.type==="Range"){t={};var a=e.valueOptions;if(a.from){t.minimum=a.from}if(a.to){t.maximum=a.to}}return t},_getValueStateText:function(e){var t;if(!e){return t}if(e.minimum!==undefined&&e.maximum!==undefined){t=""}else if(e.minimum!==undefined){t=""}else if(e.maximum!==undefined){t=""}else{t=""}return t},_attachValidationHandlers:function(e){e.attachParseError(function(e){e.getParameter("element").setValueState("Error");e.getParameter("element").setValueStateText(e.getParameter("message"))});e.attachValidationSuccess(function(e){e.getParameter("element").setValueState("None")})},_showErrorMessage:function(e){A.alert(e,{icon:"ERROR"})},_removeTextSingleQuote:function(e){var t=this._internalModel;var a=t.getProperty(e+this.TEXT);t.setProperty(e+this.TEXT,a.replace(/\'/g,""))},_syncToken:function(e){var t=this._internalModel,a=false,n=false;var i="";var r="";if(t){i=t.getProperty(e+this.TEXT);if(t.oData&&t.oData.instructions){var s=t.oData.instructions;for(var o in s){r=s[o].businessDataType}}}var l=N.getLanguageTag();var u=L.getInstance(l);this.oFormatDate=D.getInstance({pattern:u.getDatePattern("short"),calendarType:I.Gregorian},l);if(r===C.STRING||r===C.DATE_BUSINESS_TYPE||r===C.TIMESTAMP_BUSINESS_TYPE||r==="Time"){if(r===C.DATE_BUSINESS_TYPE){i=this.oFormatDate.format(this.oFormatDate.parse(i))}i=i.toString();if(i==="'"){a=true}if(i.substr(0,"'")!=="'"){a=true}if(i.substr(i.length-1,"'")!=="'"){n=true}if(a){i="'"+i}if(n){i=i+"'"}}if(r===C.NUMBER){i=parseInt(i)}t.setProperty(e+this.TOKEN,i)}})});
//# sourceMappingURL=InstructionRenderer.js.map