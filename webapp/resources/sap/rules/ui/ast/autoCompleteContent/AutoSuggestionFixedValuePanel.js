sap.ui.define(["sap/ui/thirdparty/jquery","../../library","sap/ui/core/Control","sap/m/List","sap/ui/model/json/JSONModel","sap/m/library","sap/ui/core/CustomData","sap/ui/model/Sorter","sap/rules/ui/ast/util/utilsBase","sap/ui/core/LocaleData","sap/rules/ui/Constants","sap/m/DatePicker","sap/m/DateTimePicker","sap/m/TimePicker","sap/m/Dialog","sap/m/Button","sap/base/i18n/Formatting","sap/base/i18n/date/CalendarType","sap/ui/core/format/DateFormat","sap/ui/core/InvisibleText","sap/m/Input","sap/m/Panel","sap/m/ToolbarSpacer","sap/ui/comp/smartfilterbar/SmartFilterBar","sap/ui/comp/valuehelpdialog/ValueHelpDialog","sap/ui/model/odata/v2/ODataModel","sap/ui/comp/smartfilterbar/ControlConfiguration","sap/ui/table/Column","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/Label","sap/m/Text","sap/m/Link","sap/ui/core/Lib","sap/ui/core/BusyIndicator","sap/ui/core/Element","./AutoSuggestionFixedValuePanelRenderer"],function(jQuery,e,t,a,i,r,s,l,n,o,u,p,d,c,h,f,g,v,D,m,_,b,F,V,T,y,x,S,C,w,B,I,P,O,H,L,M){"use strict";var k=r.ListMode;var A=t.extend("sap.rules.ui.ast.autoCompleteContent.AutoSuggestionFixedValuePanel",{metadata:{library:"sap.rules.ui",properties:{reference:{type:"object",defaultValue:null},vocabularyInfo:{type:"object",defaultValue:null},data:{type:"object",defaultValue:null},dialogOpenedCallbackReference:{type:"object",defaultValue:null},inputValue:{type:"string",defaultValue:""}},aggregations:{PanelLayout:{type:"sap.m.Panel",multiple:false}},events:{}},init:function(){this.infraUtils=new n.utilsBaseLib;this.needCreateLayout=true;this.businessDataType="S";this._propertyValue="Value";this._propertyDescription="Description";this.oBundle=O.getResourceBundleFor("sap.rules.ui.i18n");this.vocabularyInfo=this.getVocabularyInfo();this.autoSuggestionData=this.getData();var e=g.getLanguageTag();var t=o.getInstance(e);this.oFormatDate=D.getInstance({pattern:t.getDatePattern("short"),calendarType:v.Gregorian},e)},onBeforeRendering:function(){this._reference=this.getReference();this._dialogOpenedCallbackReference=this.getDialogOpenedCallbackReference();this.vocabularyInfo=this.getVocabularyInfo();this.valueHelpData=this.getData();if(this.needCreateLayout){var e=this._createLayout(this.vocabularyInfo);this.setAggregation("PanelLayout",e,true);this.needCreateLayout=false}},onAfterRendering:function(){var e="#"+this.fixedValueTextArea.getId();$(e).on("keydown",function(e){if(e.key=="Enter"){e.preventDefault()}})},initializeVariables:function(){},_createLayout:function(e){var t=this;var a=false;if(this.getData().valuehelp){a=true}else{a=false}this._invisibleTextLabel=new m({text:this.oBundle.getText("fixedValuePanelTitle")});this._invisibleTextDescription=new m({text:this.oBundle.getText("fixedValueInvisibleText")});this.fixedValueTextArea=new _({showValueHelp:a,showSuggestion:true,autocomplete:false,ariaLabelledBy:this._invisibleTextLabel.getId(),ariaDescribedBy:this._invisibleTextDescription.getId(),valueHelpRequest:function(){t._dialogOpenedCallbackReference(true);t._setModal(true);t._generateValueHelpInfoAndCreateDialog(e)},value:this.getInputValue(),change:function(e){t._setModal(false);var a=t._formatText(e);a.oSource.mProperties.forceFireChange=true;t._reference(a)}.bind(this),width:"auto"});var i=new b({headerText:this.oBundle.getText("fixedValuePanelTitle"),expandable:true,expanded:false,content:[this._invisibleTextLabel,this._invisibleTextDescription,this.fixedValueTextArea],width:"auto"});this.toolBarSpacerAfterInput=new F({width:"1em"});this.toolBarSpacerAfterDateLink=new F({width:"1em"});this.dateContent=this._createDateLink();this.timeContent=this._createTimeStampLink();i.addContent(this.toolBarSpacerAfterInput);i.addContent(this.dateContent);i.addContent(this.toolBarSpacerAfterDateLink);i.addContent(this.timeContent);return i},_setModal:function(e){var t=L.getElementById("popover");if(t){t.setModal(e)}},_generateValueHelpInfoAndCreateDialog:function(e){var t=this;var a=this.getData().valuehelp;if(a){a.expressionLanguage=e;a.HasValueSource=true;if(a.sourceType==="U"){a.entitySet="Enumerations";a.serviceURL="/Enumerations"}else{a.entitySet="ExternalValues";a.serviceURL="/ExternalValues"}var i=e.getModel().sServiceUrl;t._createDialog(i,a)}},_createDialog:function(e,t,a){this._createValueHelpDialog(e,t);this.oValueHelpDialog.getTableAsync().then(function(a){this.oValueHelpDialogTable=a;this._createSmartFilterBar(e,t);this.oValueHelpDialog.setFilterBar(this.oFilterBar);this._openValueHelpDialog()}.bind(this))},_openValueHelpDialog:function(){this.oValueHelpDialog.open();this.oValueHelpDialogTable.setBusy(true)},_createValueHelpDialog:function(e,t){var a=this;var i=t.expressionLanguage.getModel();var r="Attributes(Id='"+t.attributeId+"',VocabularyId='"+t.vocabularyId+"',DataObjectId='"+t.dataObjectId+"')";if(r.includes(":")){r=r=r.replace(":","%3A")}this.attributeName=t.attributeName;if(!i.oData[r]){t.dataObjectId=this._getStructureObjectForTableType(t.attributeId,t)}H.show(0);this.oValueHelpDialog=new T({supportMultiselect:false,supportRanges:false,horizontalScrolling:false,title:a.attributeName,resizable:false,beforeOpen:function(){a._bindTable(e,t)},ok:function(e){var t=e.getParameter("tokens")[0].data("row");var i=t.Value;if(a.businessDataType==="D"||a.businessDataType==="U"){i=a._getValidValue(i)}var r=this._syncToken(i,a.businessDataType);e.getParameter("tokens")[0].data("row").Value=r;e.oSource.mProperties.forceFireChange=true;a._dialogOpenedCallbackReference(false);a.oValueHelpDialog.close();a._setModal(false);a.oValueHelpDialog.destroy();H.hide();a._reference(e)}.bind(this),cancel:function(){a.oFilterBar.destroy();a._setModal(false);a.oValueHelpDialog.close();a.oValueHelpDialog.destroy();H.hide()},afterClose:function(){a._dialogOpenedCallbackReference(false);a.oFilterBar.destroy();H.hide()}})},_getStructureObjectForTableType:function(e,t){var a=t.expressionLanguage.getData().ValueSources;for(var i in a){if(e===a[i].AttributeId){return a[i].DataObjectId}}return t.dataObjectId},_syncToken:function(e,t){var a=false;var i=false;t=this.getData().valuehelp.attributeDataType;if(t!="G"){var r=e.replace(/'/g,"").replace(/"/g,"")}else{r="'"+e+"'"}if(t==="N"){var s=parseFloat(r);var l=s.toString();if(l!=r){t="Operations"}else if(l==="NaN"){t="S"}else{r=s}}if(t==="S"||t==="D"||t==="U"){if(!(t==="S")){if(t==="D"){this._dateBusinessDataType="D"}else if(t==="U"){this._dateBusinessDataType="U"}r=this._getValidDateValue(r)}r=r.toString();if(r==="'"){a=true}if(r.substr(0,"'")!=="'"){a=true}if(r.substr(r.length-1,"'")!=="'"){i=true}if(a){r="'"+r}if(i){r=r+"'"}}if(t==="B"){r=r==="true"}return r},_getValidDateValue:function(e){var t,a;var i="";var r=this._getDateTimeFormatterForParsing();if(r){t=r.parse(e)}if(this._dateBusinessDataType==="D"){a=D.getDateInstance({pattern:"yyyy-MM-dd"});i=a.format(t)}else if(this._dateBusinessDataType==="U"){a=D.getDateTimeInstance({pattern:"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'",UTC:true});i=a.format(t)}if(i!==""){i}return e},_createSmartFilterBar:function(e,t){var a=this;this.oFilterBar=new V({entitySet:t.entitySet,enableBasicSearch:true,advancedMode:true,filterBarExpanded:true,search:function(){a.onSearch(e,t)},filterChange:function(e){a.setValueStateFilter(e,t)},controlConfiguration:[a._createControlConfiguration()]});var i=new y(e);this.oFilterBar.setModel(i)},_createControlConfiguration:function(){var e=[new x({hasValueHelpDialog:true,key:"Value",label:this.oBundle.getText("value"),visibleInAdvancedArea:true,width:"100px",index:1}),new x({hasValueHelpDialog:true,key:"Description",label:this.oBundle.getText("description"),visibleInAdvancedArea:true,width:"100px",index:2}),new x({hasValueHelpDialog:true,key:"VocabularyId",label:"VocabularyId",width:"100px",visible:false,index:3}),new x({hasValueHelpDialog:true,key:"DataObjectId",label:"DataObjectId",visible:false,width:"100px",groupId:"abc",index:4}),new x({hasValueHelpDialog:true,key:"AttributeId",label:"AttributeId",visible:false,width:"100px",index:5}),new x({hasValueHelpDialog:true,key:"Version",label:"Version",visible:false,width:"100px",index:6})];return e},onSearch:function(e,t){this.oValueHelpDialogTable.setBusy(true);this._unBindTable();this._bindTable(e,t)},_bindTable:function(e,t){var a=t.serviceURL;var i=this._fetchFilterParams(t);var r={valueHelp:{collection:a,properties:[this._propertyValue,this._propertyDescription]}};var s=this.oValueHelpDialogTable;s.setThreshold(10);for(var l=0;l<r.valueHelp.properties.length;l++){var n="";if(r.valueHelp.properties[l]==="Value"){n=this.oBundle.getText("value")}else if(r.valueHelp.properties[l]==="Description"){n=this.oBundle.getText("description")}this._addValueHelpColumn(r.valueHelp.properties[l],s,n)}var o=new y(e);s.setModel(o);s.bindRows(r.valueHelp.collection,null,i);s.getBinding("rows").attachDataReceived(this._handleRowsDataReceived,this)},_handleRowsDataReceived:function(e){var t=this;var a=e.getParameter("data");if(jQuery.isEmptyObject(a)||a&&a.results&&a.results.length===0){this.oValueHelpDialogTable.setNoData(t.oBundle.getText("no_data"))}else{this.oValueHelpDialogTable.setNoData(t.oBundle.getText("searching"))}this.oValueHelpDialogTable.setBusy(false)},_addValueHelpColumn:function(e,t,a){var i=(new S).setLabel(new B({text:a}));if(e===this._propertyValue){i.setSortProperty(a)}t.addColumn(i.setTemplate((new I).bindProperty("text",e)))},_unBindTable:function(){var e=this.oValueHelpDialogTable;e.destroyColumns();e.unbindRows()},_fetchFilterParams:function(e){var t=this;var a=[];var i=[new C("AttributeId",w.EQ,e.attributeId),new C("DataObjectId",w.EQ,e.dataObjectId),new C("VocabularyId",w.EQ,e.vocabularyId)];var r=this.oFilterBar.getFilters();var s=this.oFilterBar.getParameters();if(!jQuery.isEmptyObject(s)&&r&&r.length>0){s=this.oFilterBar.getParameters().custom.search;a=this._getSearchFilters(s);r=t._formatFilterParams(r,e.sourceType);i.push(new C({filters:[new C(r),new C(a)],and:true}))}else if(!jQuery.isEmptyObject(s)){s=this.oFilterBar.getParameters().custom.search;a=this._getSearchFilters(s);i.push(a)}else if(r&&r.length>0){r=t._formatFilterParams(r,e.sourceType);i.push(r[0])}return i},_formatFilterParams:function(e,t){var a=this;if(e[0]&&e.length===1&&e[0].aFilters[0]&&e[0].aFilters[0].sOperator){e=a._formatSingleFilter(e)}else if(e[0]&&e[0].aFilters[0]&&e[0].aFilters[0].aFilters[0]&&e[0].aFilters[0].aFilters[0].aFilters&&e[0].aFilters[1].aFilters[0].aFilters){e=a._formatMultiFilter(e,0,true);e=a._formatMultiFilter(e,1,true)}else if(e[0]&&e[0].aFilters[0]&&e[0].aFilters[1]&&e[0].aFilters[0].aFilters[0]&&e[0].aFilters[0].aFilters[0].aFilters&&e[0].aFilters[1].aFilters){e=a._formatMultiFilter(e,0,true);e=a._formatMultiFilter(e,1,false)}else if(e[0]&&e[0].aFilters[0]&&e[0].aFilters[1]&&e[0].aFilters[1].aFilters[0]&&e[0].aFilters[0].aFilters&&e[0].aFilters[1].aFilters[0].aFilters){e=a._formatMultiFilter(e,0,false);e=a._formatMultiFilter(e,1,true)}else if(e[0]&&e[0].aFilters[0]&&e[0].aFilters[1]&&e[0].aFilters[0].aFilters&&e[0].aFilters[1].aFilters){e=a._formatMultiFilter(e,0,false);e=a._formatMultiFilter(e,1,false)}return e},_formatSingleFilter:function(e){var t=this;var a=null;for(var i=0;i<e[0].aFilters.length;i++){if(e[0].aFilters[i].sOperator==="Contains"){a=e[0].aFilters[i].sPath===this._propertyValue?this._valueFieldValue:this._valueFieldDescription}else if(e[0].aFilters[i].sOperator==="BT"){var r=t._manageParam(e[0].aFilters[i].sPath,e[0].aFilters[i].sOperator,e[0].aFilters[i].oValue1,e[0].aFilters[i].oValue2);delete e[0].aFilters[i];e[0].aFilters[i]=r}else if(e[0].aFilters[i].sOperator==="StartsWith"){a=e[0].aFilters[i].sPath===this._propertyValue?this._valueFieldValue:this._valueFieldDescription;a.setValueState("Error");a.setValueStateText(e[0].aFilters[i].sOperator+" operator not supported")}else if(e[0].aFilters[i].sOperator==="EndsWith"){a=e[0].aFilters[i].sPath===this._propertyValue?this._valueFieldValue:this._valueFieldDescription;a.setValueState("Error");a.setValueStateText(e[0].aFilters[i].sOperator+" operator not supported")}}return e},_formatMultiFilter:function(e,t,a){var i=this;var r=null;var s=[];if(a){s=e[0].aFilters[t].aFilters[0].aFilters}else{s=e[0].aFilters[t].aFilters}for(var l=0;l<s.length;l++){if(s[l].sOperator==="Contains"){r=s[l].sPath===this._propertyValue?this._valueFieldValue:this._valueFieldDescription}else if(s[l].sOperator==="BT"){var n=i._manageParam(s[l].sPath,s[l].sOperator,s[l].oValue1,s[l].oValue2);delete s[l];s[l]=n}else if(s[l].sOperator==="StartsWith"){r=s[l].sPath===this._propertyValue?this._valueFieldValue:this._valueFieldDescription;r.setValueState("Error");r.setValueStateText(s[l].sOperator+" operator not supported")}else if(s[l].sOperator==="EndsWith"){r=s[l].sPath===this._propertyValue?this._valueFieldValue:this._valueFieldDescription;r.setValueState("Error");r.setValueStateText(s[l].sOperator+" operator not supported")}}return e},_manageParam:function(e,t,a,i){var r=[];if(a&&i){r=new C({filters:[new C(e,w.GT,a),new C(e,w.LT,i)],and:true})}return r},_getSearchFilters:function(e){return new C({filters:[new C(this._propertyValue,w.EQ,e),new C(this._propertyDescription,w.EQ,e)],and:false})},setValueStateFilter:function(e,t){var a=e.getSource().getAllFilterItems();var i=e.getSource().getFilterData();for(var r=0;r<a.length;r++){if(a[r].getName()==="Value"&&i&&i.Value&&i.Value.ranges){var s=this.filterUnSupportedOperator(i.Value.ranges,t);if(s){a[r].getControl().setValueState("Error");a[r].getControl().setValueStateText(s)}else{a[r].getControl().setValueState("None");a[r].getControl().setValueStateText("")}}else if(a[r].getName()==="Description"&&i&&i.Description&&i.Description.ranges){var l=this.filterUnSupportedOperator(i.Description.ranges,t);if(l){a[r].getControl().setValueState("Error");a[r].getControl().setValueStateText(l)}else{a[r].getControl().setValueState("None");a[r].getControl().setValueStateText("")}}else if(a[r].getName()==="Value"){a[r].getControl().setValueState("None");a[r].getControl().setValueStateText("")}else if(a[r].getName()==="Description"){a[r].getControl().setValueState("None");a[r].getControl().setValueStateText("")}}},filterUnSupportedOperator:function(e,t){var a=[];var i="";for(var r=0;r<e.length;r++){var s=u.OPERATOR_MAPPING.find(function(a){return e[r].operation===a.operator&&e[r].exclude===a.exclude&&t.sourceType===a.valueHelpType});if(!s.supported&&a.indexOf("'"+s.message+"'")===-1){a.push("'"+s.message+"'")}}if(a.length>1){i=a.join(",")+" are not supported"}else if(a.length===1){i=a.join(",")+" is not supported"}return i},_formatText:function(e){var t=this;var a=this.getData().businessDataTypeList;if(a&&a.length>0){this.businessDataType=this.getData().businessDataTypeList[0]}else{this.businessDataType="N"}var i=e.getSource().getValue();e.getSource().setValue(i);return e},_createDateLink:function(){var e=this;this.dateContent=new P({wrapping:true,text:this.oBundle.getText("select_date"),press:function(t){e.dateContext="D";e._createDateTimeDialog()}});return this.dateContent},_createTimeStampLink:function(){var e=this;this.timeContent=new P({wrapping:true,text:this.oBundle.getText("select_date_time"),press:function(t){e.dateContext="U";e._createDateTimeDialog()}});return this.timeContent},_createDateTimeDialog:function(){var e=this;var t=g.getLanguageTag();var a=o.getInstance(t);var i=a.getDatePattern("medium");var r=a.getTimePattern("medium");var s=i+" "+r;if(this.dateContext){this._dateBusinessDataType=this.dateContext}if(this._dateBusinessDataType==="D"){this.control=new p({width:"auto",valueFormat:i})}if(this._dateBusinessDataType==="U"){var e=this;this.control=new d({width:"auto",valueFormat:s})}this._oSelectNewDateDialog=new h({title:this.oBundle.getText("calendarTitle"),afterClose:function(){e._dialogOpenedCallbackReference(false)},content:[this.control],beginButton:new f({text:this.oBundle.getText("okBtn"),enabled:true,press:function(t){var a=this._updateText(this.control);t.oSource.mProperties.value="'"+a+"'";t.oSource.mProperties.dateSelected=this._dateBusinessDataType;t.oSource.mProperties.forceFireChange=true;e._reference(t);e._setModal(false);e._oSelectNewDateDialog.close()}.bind(this)}),endButton:new f({text:this.oBundle.getText("clsBtn"),press:function(){e._setModal(false);e._oSelectNewDateDialog.close()}.bind(this)})});this._dialogOpenedCallbackReference(true);this._setModal(true);this._oSelectNewDateDialog.open()},_updateText:function(e){var t=e._getInputValue();var a=this._getValidValue(t);return a},_getValidValue:function(e){var t,a;var i="";if(this.dateContext){this._dateBusinessDataType=this.dateContext}var r=this._getDateTimeFormatterForParsing();if(r){t=r.parse(e)}if(this._dateBusinessDataType==="D"){a=D.getDateInstance({pattern:"yyyy-MM-dd"});i=a.format(t)}else if(this._dateBusinessDataType==="U"){a=D.getDateTimeInstance({pattern:"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'",UTC:true});i=a.format(t)}if(i!==""){return i}return e},_getDateTimeFormatterForParsing:function(){var e;var t=g.getLanguageTag();var a=o.getInstance(t);var i=a.getDatePattern("medium");var r=a.getTimePattern("medium");if(this.dateContext==="D"){e=D.getDateInstance({pattern:i})}else if(this.dateContext==="U"){e=D.getDateTimeInstance({pattern:i+" "+r})}return e},renderer:M});return A},true);
//# sourceMappingURL=AutoSuggestionFixedValuePanel.js.map