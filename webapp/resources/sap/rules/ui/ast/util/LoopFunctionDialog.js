sap.ui.define(["sap/ui/core/Control","sap/m/List","sap/ui/model/json/JSONModel","sap/rules/ui/ast/constants/Constants","sap/rules/ui/ast/provider/TermsProvider","sap/ui/layout/GridData","sap/m/Select","sap/ui/core/ListItem","sap/m/ColumnListItem","sap/ui/layout/HorizontalLayout","sap/m/Button","sap/m/library","sap/ui/core/IconPool","sap/m/TextArea","sap/m/Table","sap/m/Column","sap/ui/layout/form/SimpleForm","sap/m/Label","sap/m/Dialog","sap/ui/core/Lib","sap/m/Text","sap/ui/core/Element"],function(e,t,a,o,n,s,i,l,r,d,c,u,p,h,b,g,f,x,S,D,I,_){"use strict";var y;var F=function(){this.oBundle=D.getResourceBundleFor("sap.rules.ui.i18n");this.functionLabelDisplay="";this.functionLabel="";this._loopFunctionSelected="";this._whereExpressionId="";this.dataObjectId="";this.dataObjectLabel="";this.dataObjectIdSelected="";this.selectedData=[{operationSelected:"",preSuggestionContext:"",cancelButton:false,addButton:true}];this.enabledData={enabled:false};this.dataObjectIdData={dataObjectId:""}};F.prototype._filterloopFunctionVocabulary=function(e){var t=[];var a=n.getInstance();if(e&&e.length>0){for(var s=0;s<e.length;s++){var i=e[s].ResultDataObjectId;if(e[s].type&&e[s].type==="T"){t.push(e[s])}else if(i){var l=a.getTermByTermId(i);if(l&&l.getDataObjectType()===o.Table){t.push(e[s])}}}return{terms:t}}};F.prototype._createLoopFunctionDropDown=function(e,t){var n=this;var r=new a(e);this.functionLoop=new i({width:"200px",selectedKey:this._loopFunctionSelected,forceSelection:false,showSecondaryValues:true,layoutData:new s({span:"L3 M3 S3"}),ariaLabelledBy:t,change:function(e){n._loopFunctionSelected=e.getSource().getSelectedItem().getText();if(n.dataObjectId&&n._loopFunctionSelected){n.functionLabelDisplay=n._loopFunctionSelected+"("+n.dataObjectLabel+")";n.functionLabel=n._loopFunctionSelected+"("+n.dataObjectId+")";n.functionLabelField.setValue(n.functionLabelDisplay);if(n.oModel.getData().selectionData[0].operationSelected!==""&&n._loopFunctionSelected===o.FOREACH){n.applyButton.setEnabled(true)}else{n.applyButton.setEnabled(false)}n.astExpressionBasicForWhere.setEditable(true)}else{n.applyButton.setEnabled(false);n.astExpressionBasicForWhere.setEditable(false);n.astExpressionBasicForWhere.setValue("");n.functionLabelField.setValue("")}}.bind(this)}).addStyleClass("sapAstExpressionDialogField");this.functionLoop.setModel(r);this.functionLoop.bindItems({path:"/loop",template:new l({text:"{name}",key:"{name}",additionalText:"{label}"})});return this.functionLoop};F.prototype._getOperationAstExpressionBasic=function(e,t){var a=this;this.astExpressionBasicForOperation=new t({astExpressionLanguage:this._oAstExpressionLanguage,value:"{operationSelected}",conditionContext:false,operationsContext:true,editable:true,placeholder:this.oBundle.getText("expressionPlaceHolder"),ariaLabelledBy:e,dataObjectInfo:"{preSuggestionContext}",change:function(e){var t=parseInt(e.getSource().getBindingContext().sPath.split("/")[2]);a._expressionForOperationInput=e.getParameter("newValue");var n=a.oModel.getData().selectionData;if(a._expressionForOperationInput){n[t].operationSelected=a._expressionForOperationInput.trim()}if(a.oModel.getData().selectionData[0].operationSelected!==""&&a._loopFunctionSelected===o.FOREACH){a.applyButton.setEnabled(true)}else{a.applyButton.setEnabled(false)}a._setPreSuggestionContextChange(t)}.bind(this)});this.astExpressionBasicForOperation.addStyleClass("sapAstExpressionDialog");return this.astExpressionBasicForOperation};F.prototype._tableColumnsFactory=function(e,t,a){var o=this;var n=new r({cells:[o._getOperationAstExpressionBasic("loopOperationsLabelId",e),new d({content:[new c({type:u.ButtonType.Transparent,icon:p.getIconURI("sys-cancel"),visible:"{cancelButton}",enabled:"{/enabledData/enabled}",press:function(e){var t=e.getSource().getIdForLabel().split("-")[2];o._removeColumnFromJsonModel(parseInt(t))}.bind(this)}),new c({type:u.ButtonType.Transparent,icon:p.getIconURI("add"),visible:"{addButton}",enabled:"{/enabledData/enabled}",press:function(e){var t=e.getSource().getIdForLabel().split("-")[2];o._addColumnToJsonModel(parseInt(t))}.bind(this)})]})]});return n};F.prototype._addColumnToJsonModel=function(e){var t={operationSelected:"",preSuggestionContext:"",cancelButton:true,addButton:true};this.selectedData.splice(e+1,0,t);if(this.selectedData.length>1){this.selectedData[0].cancelButton=true}this._setPreSuggestionContext();this.oModel.setData({selectionData:this.selectedData,enabledData:this.enabledData,dataObjectIdData:this.dataObjectIdData})};F.prototype._setPreSuggestionContext=function(){for(var e=1;e<this.selectedData.length;e++){for(var t=0;t<e;t++){this.selectedData[e].preSuggestionContext=this.selectedData[t].preSuggestionContext+this.selectedData[t].operationSelected+","}}};F.prototype._setPreSuggestionContextChange=function(e){if(e>=0&&e<this.selectedData.length-1){for(var t=e;t<this.selectedData.length-1;t++){this.selectedData[t+1].preSuggestionContext=this.selectedData[t].preSuggestionContext+this.selectedData[t].operationSelected+","}}};F.prototype._removeColumnFromJsonModel=function(e){this.selectedData.splice(e,1);if(this.selectedData.length===1){this.selectedData[0].cancelButton=false}if(e!==1){this._setPreSuggestionContext()}this.oModel.setData({selectionData:this.selectedData,enabledData:this.enabledData,dataObjectIdData:this.dataObjectIdData})};F.prototype._getSuggestionsForTheGivenInput=function(e){var t=this._oAstExpressionLanguage.getTokensForGivenStringInput(e);var a=this._oAstExpressionLanguage.convertTokensToUiModelForAutoSuggestion(t);var o={};o.AttributeContext=true;o.OperationsContext=false;var n=this._oAstExpressionLanguage.getSuggesstions(a,o);return n};F.prototype._createVocabularyDropDown=function(e){var t=this;var n=this._getSuggestionsForTheGivenInput("");var s=this._filterloopFunctionVocabulary(n.autoComplete.categories.terms);var r=new a(s);this.vocabularySelect=new i({width:"100%",selectedKey:this.dataObjectIdSelected,forceSelection:false,ariaLabelledBy:e,change:function(e){t.dataObjectIdSelected=e.getSource().getSelectedItem().getKey();t.dataObjectId="/"+e.getSource().getSelectedItem().getKey();t.dataObjectLabel=e.getSource().getSelectedItem().getText();if(t.dataObjectId){t.oModel.getData().dataObjectIdData.dataObjectId=t.dataObjectId;t.oModel.getData().enabledData.enabled=true}this.selectedData=[{operationSelected:"",preSuggestionContext:"",cancelButton:false,addButton:true}];t.selectedData[0].preSuggestionContext=this._loopFunctionSelected+"("+t.dataObjectId+",";t._bindOperations();var a=t._setDataObjectInfoForWhereConditionAutoSuggestion();t.astExpressionBasicForWhere.setDataObjectInfo(a);if(t.dataObjectId&&t._loopFunctionSelected){t.functionLabelDisplay=t._loopFunctionSelected+"("+t.dataObjectLabel+")";t.functionLabel=t._loopFunctionSelected+"("+t.dataObjectId+")";t.functionLabelField.setValue(t.functionLabelDisplay);if(t.oModel.getData().selectionData[0].operationSelected!==""&&t._loopFunctionSelected===o.FOREACH){t.applyButton.setEnabled(true)}else{t.applyButton.setEnabled(false)}t.astExpressionBasicForWhere.setValue("");t._whereExpressionId="";t.astExpressionBasicForWhere.setEditable(true)}else{t.applyButton.setEnabled(false);t.astExpressionBasicForWhere.setEditable(false);t.astExpressionBasicForWhere.setValue("");t.functionLabelField.setValue("")}}.bind(this)}).addStyleClass("sapAstExpressionDialogField");this.vocabularySelect.setModel(r);this.vocabularySelect.bindItems({path:"/terms",template:new l({text:"{label}",key:"{id}"})});var d=n.autoComplete.categories.vocabularyRules;for(var c in d){var u=new l({text:d[c].label,key:d[c].id});this.vocabularySelect.addItem(u)}return this.vocabularySelect};F.prototype._bindOperations=function(){this.oModel=new a;this.oModel.setData({selectionData:this.selectedData,enabledData:this.enabledData,dataObjectIdData:this.dataObjectIdData});this.conditionsTable.setModel(this.oModel)};F.prototype._createWhereAstExpressionBasic=function(e,t){var a=this;this.astExpressionBasicForWhere=new t({astExpressionLanguage:this._oAstExpressionLanguage,enableAggregateFunctionWhereClause:true,value:this._whereExpressionId,editable:"{/value}",dataObjectInfo:this._setDataObjectInfoForWhereConditionAutoSuggestion(),ariaLabelledBy:e,change:function(e){a._whereExpressionId=e.getParameter("newValue");if(a.selectedData.length===1&&a._whereExpressionId){a.selectedData[0].preSuggestionContext=a._loopFunctionSelected+"("+o.FILTER+"("+a.dataObjectId+","+a._whereExpressionId+") ,"}else if(a.selectedData.length===1&&!a._whereExpressionId){a.selectedData[0].preSuggestionContext=a._loopFunctionSelected+"("+a.dataObjectId+","}else if(a.selectedData.length>1&&a._whereExpressionId){a.selectedData[0].preSuggestionContext=a._loopFunctionSelected+"("+o.FILTER+"("+a.dataObjectId+","+a._whereExpressionId+") ,";a._setPreSuggestionContextChange(0)}else if(a.selectedData.length>1&&!a._whereExpressionId){a.selectedData[0].preSuggestionContext=a._loopFunctionSelected+"("+a.dataObjectId+",";a._setPreSuggestionContextChange(0)}a._bindOperations()}.bind(this)});this.astExpressionBasicForWhere.addStyleClass("sapAstExpressionDialog");return this.astExpressionBasicForWhere};F.prototype._setDataObjectInfoForWhereConditionAutoSuggestion=function(){if(this.dataObjectId){var e=this.dataObjectId;return this._loopFunctionSelected+"("+o.FILTER+"("+e+","}};F.prototype._createFunctionLabel=function(){this.functionLabelField=new h({value:this.functionLabelDisplay,enabled:false,width:"100%"}).addStyleClass("sapAstExpressionDialogTextField");return this.functionLabelField};F.prototype._clearData=function(){this.functionLabelDisplay="";this.functionLabel="";this._loopFunctionSelected="";this._whereExpressionId="";this.dataObjectId="";this.dataObjectLabel="";this.dataObjectIdSelected="";this.operationsPreExpression="";this.selectedData=[{operationSelected:"",preSuggestionContext:"",cancelButton:false,addButton:true}];this.enabledData={enabled:false};this.dataObjectIdData={dataObjectId:""}};F.prototype._createTable=function(e){var t=this;this.conditionsTable=new b({backgroundDesign:u.BackgroundDesign.Solid,showSeparators:u.ListSeparators.None,columns:[new g({width:"89%"}).setStyleClass("sapAstOperationColumn"),new g({width:"11%"})]}).addStyleClass("sapAstOperationTable");this._bindOperations();var a=t._tableColumnsFactory(e);this.conditionsTable.bindItems("/selectionData",a);return this.conditionsTable};F.prototype._convertFunctionLabelToText=function(e,t){this.termsProvider=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var a=this.termsProvider.getTermNameFromASTNodeReference(e);t=t.replace(e,a);return t};F.prototype._createLoopFunctionDialog=function(e,t,a,n,i){var l=this;var r=0;this._clearData();this.oBundle=D.getResourceBundleFor("sap.rules.ui.i18n");this._oAstExpressionLanguage=a;this._loopFunctionSelected=o.FOREACH;sap.ui.require(["sap/rules/ui/AstExpressionBasic"],a=>{if(i){this._loopFunctionSelected=i.function;this._whereExpressionId=i.filter;this.dataObjectId=i.dataObject;this.functionLabel=i.functionLabel;this.dataObjectIdSelected=i.dataObject.replace("/","");this.operationArray=i.actions;l.functionLabelDisplay=this._convertFunctionLabelToText(i.dataObject,i.functionLabel);if(this.dataObjectId){this.dataObjectIdData.dataObjectId=this.dataObjectId;this.enabledData.enabled=true;this.termsProvider=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;this.dataObjectLabel=this.termsProvider.getTermNameFromASTNodeReference(this.dataObjectId)}if(this.operationArray&&this.operationArray.length>0){this.selectedData=[];for(var d=0;d<this.operationArray.length;d++){var u={operationSelected:"",preSuggestionContext:"",cancelButton:true,addButton:true};u.operationSelected=this.operationArray[d];this.selectedData.push(u);r++}if(r===1){this.selectedData[0].cancelButton=false}if(!this._whereExpressionId){l.selectedData[0].preSuggestionContext=this._loopFunctionSelected+"("+this.dataObjectId+","}else{l.selectedData[0].preSuggestionContext=this._loopFunctionSelected+"("+o.FILTER+"("+this.dataObjectId+","+l._whereExpressionId+") ,"}l._setPreSuggestionContextChange(0)}}var p=l._createLoopFunctionDropDown(e,"LoopFuntionLabelId");var h=new I({text:l.oBundle.getText("vocabulary"),tooltip:l.oBundle.getText("vocabulary"),textAlign:"End",layoutData:new s({span:"L2 M2 S2"})});var b=l._createTable(a);var g=l._createWhereAstExpressionBasic("loopWhereLabelId",a);var D=l._createFunctionLabel();var _=new f({layout:"ResponsiveGridLayout",editable:true,content:[new x("loopFunctionSelectionLabelId",{text:l.oBundle.getText("function"),tooltip:l.oBundle.getText("function"),labelFor:p.getId()}),p,h,l._createVocabularyDropDown(h.getId()),new x("loopWhereLabelId",{text:l.oBundle.getText("where"),tooltip:l.oBundle.getText("where"),labelFor:g.getId()}),g,new x("loopOperationsLabelId",{text:"",tooltip:"",labelFor:b.getId()}).addStyleClass(""),b,new x({text:l.oBundle.getText("function_label"),tooltip:l.oBundle.getText("function_label"),labelFor:D.getId()}),D]});var y=new S({title:this.oBundle.getText("loopFunctionTitle"),contentWidth:"800px",showHeader:true,draggable:true,beforeClose:function(){n(false)},content:[_],buttons:[this.applyButton=new c({text:this.oBundle.getText("apply"),tooltip:this.oBundle.getText("applyChangesBtnTooltip"),press:function(e){var a=l._createJson();e.getSource().mProperties={value:l.functionLabel,jsonData:a};t(e);l._setModal(false);y.close();y.destroy()}}),new c({text:this.oBundle.getText("cancel"),tooltip:this.oBundle.getText("cancelBtnTooltip"),press:function(e){l._setModal(false);y.close();y.destroy()}})]}).addStyleClass("sapUiSizeCompact");l._setModal(true);y.open()})};F.prototype._setModal=function(e){var t=_.getElementById("popover");if(t){t.setModal(e)}};F.prototype._getOperations=function(){var e=[];for(var t=0;t<this.oModel.getData().selectionData.length;t++){if(this.oModel.getData().selectionData[t].operationSelected!==""){e.push(this.oModel.getData().selectionData[t].operationSelected)}}return e};F.prototype._createJson=function(){var e=this._getOperations();var t=this._whereExpressionId;var a={function:this._loopFunctionSelected,filter:t,functionLabel:this.functionLabel,dataObject:this.dataObjectId,actions:e,doVocabId:this.dataObjectId};return a};F.prototype.includes=function(e,t){var a=false;if(e.indexOf(t)!==-1){a=true}return a};return{getInstance:function(){y=new F;return y}}},true);
//# sourceMappingURL=LoopFunctionDialog.js.map