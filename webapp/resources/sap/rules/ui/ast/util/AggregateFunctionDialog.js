sap.ui.define(["sap/ui/core/Control","sap/m/List","sap/ui/model/json/JSONModel","sap/rules/ui/ast/constants/Constants","sap/m/Select","sap/ui/layout/GridData","sap/ui/core/ListItem","sap/m/MultiComboBox","sap/m/TextArea","sap/m/Text","sap/ui/layout/form/SimpleForm","sap/m/Button","sap/m/Label","sap/m/Dialog","sap/ui/core/Lib","sap/ui/core/Element"],function(e,t,a,s,r,i,o,n,l,u,c,p,h,g,d,b){"use strict";var y;var f=function(){this._vocabularyExpressionId="";this.functionLabelDisplay="";this.functionLabel="";this._aggregateFunctionSelected="";this._whereExpressionId="";this._groupBy=[];this.functionLabelExpression="";this.displayTextVocabulary="";this.jsonDataArray=[];this.groupBySelectEnable=true;this.oBundle=d.getResourceBundleFor("sap.rules.ui.i18n")};f.prototype._filterAggregateFunction=function(e){var t=[];if(e&&e.aggregate){for(var a=0;a<e.aggregate.length;a++){if(e.aggregate[a].name!==s.FILTER){t.push(e.aggregate[a])}}return{aggregate:t}}};f.prototype._createFunctionSelectionDropDown=function(e,t){var s=this;e=this._filterAggregateFunction(e);var n=new a(e);this.functionSelect=new r({selectedKey:this._aggregateFunctionSelected,forceSelection:false,showSecondaryValues:true,layoutData:new i({span:"L3 M3 S12"}),ariaLabelledBy:t,change:function(e){this._aggregateFunctionSelected=e.getSource().getSelectedItem().getText();this.astExpressionBasicForVocabulary.setValue("");this.applyButton.setEnabled(false);this.astExpressionBasicForWhere.setEditable(false);this.astExpressionBasicForAttributes.setEditable(false);this.groupBySelect.setEnabled(false);this.astExpressionBasicForAttributes.setValue("");this._attributeId="";this._groupBy=[];this.groupBySelected=[];this.astExpressionBasicForWhere.setValue("");this._whereExpressionId="";this.functionLabelField.setValue("");this.groupBySelect.setSelectedKeys([])}.bind(this)}).addStyleClass("sapAstExpressionDialogField");this.functionSelect.setModel(n);this.functionSelect.bindItems({path:"/aggregate",template:new o({text:"{name}",key:"{name}",additionalText:"{label}"})});return this.functionSelect};f.prototype._enableField=function(){if(this._vocabularyExpressionId&&this._aggregateFunctionSelected){return true}else{return false}};f.prototype._enableFieldGroupBy=function(){if(this._vocabularyExpressionId&&this._aggregateFunctionSelected&&this.groupBySelectEnable){return true}else{return false}};f.prototype._enableFieldWhere=function(){if(this._vocabularyExpressionId&&this._aggregateFunctionSelected&&this.jsonDataArray.length===0){return true}else{return false}};f.prototype._enableFieldAttribute=function(){var e=false;if(this._vocabularyExpressionId&&this._aggregateFunctionSelected&&this.jsonDataArray.length===0){e=true}return e};f.prototype._createVocabularyAstExpression=function(e,t){var a=this;var r=[];this.astExpressionBasicForVocabulary=new t({value:this._vocabularyExpressionId,jsonData:this.jsonDataArray,astExpressionLanguage:this._oAstExpressionLanguage,enableAggregateFunctionVocabulary:true,ariaLabelledBy:e,editable:true,change:function(e){this._vocabularyExpressionId=e.getParameter("newValue");this.sDataObjectSelected=a._getDataObjectFromExpression(a._vocabularyExpressionId);if(a._vocabularyExpressionId&&this._aggregateFunctionSelected){if(e.getSource().getProperty("jsonData")&&e.getSource().getProperty("jsonData").length>0){a._helperForSelectFunction(e)}else{if(this.sDataObjectSelected){this.functionLabelDisplay=this._aggregateFunctionSelected+"("+this.sDataObjectSelected.label+")";this.functionLabel=this._aggregateFunctionSelected+"("+this.dataObjectId+")";this.functionLabelField.setValue(a.functionLabelDisplay);this.astExpressionBasicForWhere.setValue("");this.astExpressionBasicForAttributes.setValue("");this._whereExpressionId="";this._attributeId="";this.applyButton.setEnabled(this._aggregateFunctionSelected===s.COUNT?true:false);this.jsonDataArray=[];var t=this._setDataObjectInfoForWhereConditionAutoSuggestion();this.astExpressionBasicForWhere.setDataObjectInfo(t);this.astExpressionBasicForAttributes.setDataObjectInfo(this._getDataObjectInfoForAttribute());this._bindGroupByDropDown();this._groupBy=[];this.groupBySelected=[];this.astExpressionBasicForWhere.setEditable(true);this.astExpressionBasicForAttributes.setEditable(this._aggregateFunctionSelected===s.COUNT?false:true);this.groupBySelectEnable=this._aggregateFunctionSelected!==s.COUNTDISTINCT&&this._aggregateFunctionSelected!==s.DISTINCT?true:false;this.groupBySelect.setEnabled(this.groupBySelectEnable);if(!this._isDataObjectStructure()&&!this._isDataObjectElement()){this.astExpressionBasicForVocabulary.setValueState("None")}}}}else{this.applyButton.setEnabled(false);this.astExpressionBasicForWhere.setEditable(false);this.astExpressionBasicForAttributes.setEditable(false);this.groupBySelect.setEnabled(false);this.astExpressionBasicForWhere.setValue("");this._whereExpressionId="";this.astExpressionBasicForWhere.setDataObjectInfo("");this.astExpressionBasicForAttributes.setValue("");this._attributeId="";this.functionLabelField.setValue("");this.groupBySelect.setSelectedKeys([]);this.jsonDataArray=[];this.astExpressionBasicForVocabulary.setValueState("None")}}.bind(this)});this.astExpressionBasicForVocabulary.addStyleClass("sapAstExpressionDialog");return this.astExpressionBasicForVocabulary};f.prototype._helperForSelectFunction=function(e){if(e.getSource().getProperty("jsonData")&&e.getSource().getProperty("jsonData").length>0){this.functionLabelExpression=e.getSource().getProperty("jsonData")[0].functionLabel;this.jsonDataArray=e.getSource().getProperty("jsonData");this.sDataObjectSelected=this._getDataObjectFromExpression(this.functionLabelExpression);if(!this._isDataObjectStructure()&&!this._isDataObjectElement()){this.astExpressionBasicForVocabulary.setValueState("None")}else{this.astExpressionBasicForVocabulary.setValueState("Error")}if(Object.keys(this.jsonDataArray[0].attributes).length===0||Object.keys(this.jsonDataArray[0].attributes).length>1){this.applyButton.setEnabled(false);this.astExpressionBasicForVocabulary.setValueState("Error");this.astExpressionBasicForVocabulary.setValueStateText(this.oBundle.getText("invalidAttribute"))}else{this.applyButton.setEnabled(true);this.astExpressionBasicForVocabulary.setValueState("None")}this.displayTextVocabulary=e.getParameter("displayText");this.functionLabelDisplay=this._aggregateFunctionSelected+"("+this.displayTextVocabulary+")";this.functionLabelField.setValue(this.functionLabelDisplay);this.functionLabel=this._aggregateFunctionSelected+"("+this.functionLabelExpression+")";this.astExpressionBasicForWhere.setValue("");this._whereExpressionId="";this.astExpressionBasicForAttributes.setValue("");this._attributeId="";var t=this._setDataObjectInfoForWhereConditionAutoSuggestion();this.astExpressionBasicForWhere.setDataObjectInfo(t);this._bindGroupByDropDown();this._groupBy=[];this.groupBySelected=[];this.astExpressionBasicForWhere.setEditable(false);this.astExpressionBasicForAttributes.setEditable(false);this.groupBySelectEnable=this._aggregateFunctionSelected!==s.COUNTDISTINCT&&this._aggregateFunctionSelected!==s.DISTINCT?true:false;this.groupBySelect.setEnabled(this.groupBySelectEnable)}};f.prototype._setDataObjectInfoForWhereConditionAutoSuggestion=function(){var e="";if(this.jsonDataArray&&this.jsonDataArray.length>0){return this._aggregateFunctionSelected+"(FILTER("+this._vocabularyExpressionId+","}else if(this.dataObjectId){var t=this.dataObjectId;if(this.includes(t,"/")){t=t.replace("/","")}e=this._returnDataObjectBasedOnType(this._vocabularyExpressionId);if(e){return this._aggregateFunctionSelected+"(FILTER("+e+","}return this._aggregateFunctionSelected+"(FILTER(/"+t+","}};f.prototype._getDataObjectInfoForAttribute=function(){var e="";if(this.jsonDataArray&&this.jsonDataArray.length===0&&this._vocabularyExpressionId){e=this._vocabularyExpressionId}return e};f.prototype._getDataObjectFromExpression=function(e){var t="";if(e&&e.trim()&&this.includes(e,"(")){var a=/\(([^)]+),/;var r=e.split("(");t=r[0]===s.SELECT||r[0]===s.TOP||r[0]===s.BOTTOM||r[0]===s.FIRST?this.jsonDataArray[0]?this.jsonDataArray[0].dataObject:"":"";t=t.replace("/","")}else if(e&&e.trim()){var i=e.split("/");t=i[1]}if(t){var o={};t=t.trim();var n=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var l=n.getTermByTermId(t);if(l){o={name:n.getTermByTermId(t)._termName,label:n.getTermByTermId(t)._label};this.dataObjectId="/"+t}return o}};f.prototype._createAttributeAstExpressionBasic=function(e,t){var a=this;this.astExpressionBasicForAttributes=new t({value:this._attributeId,astExpressionLanguage:this._oAstExpressionLanguage,dataObjectInfo:this._getDataObjectInfoForAttribute(),ariaLabelledBy:e,enableAggregateFunctionAttribute:true,isAttributeContext:true,editable:a._enableFieldAttribute(),change:function(e){a._attributeId=e.getParameter("newValue");if(a._attributeId){a.applyButton.setEnabled(true)}else{a.applyButton.setEnabled(false)}}.bind(this)});this.astExpressionBasicForAttributes.addStyleClass("sapAstExpressionDialog");return this.astExpressionBasicForAttributes};f.prototype._createWhereAstExpressionBasic=function(e,t){var s=this;this.oModel=new a;this.oModel.setData({value:this._whereExpressionId});this.astExpressionBasicForWhere=new t({astExpressionLanguage:this._oAstExpressionLanguage,enableAggregateFunctionWhereClause:true,value:this._whereExpressionId,editable:s._enableFieldWhere(),dataObjectInfo:this._setDataObjectInfoForWhereConditionAutoSuggestion(),ariaLabelledBy:e,change:function(e){s._whereExpressionId=e.getParameter("newValue")}.bind(this)});this.astExpressionBasicForWhere.setModel(this.oModel);this.astExpressionBasicForWhere.addStyleClass("sapAstExpressionDialog");return this.astExpressionBasicForWhere};f.prototype._createGroupByDropDown=function(e){var t=this;this.groupBySelect=new n({showSecondaryValues:true,enabled:t._enableFieldGroupBy(),ariaLabelledBy:e,selectionFinish:function(e){t._groupBy=[];for(var a=0;a<e.getSource().getSelectedItems().length;a++){var s="./"+e.getSource().getSelectedItems()[a].getKey();t._groupBy.push(s)}}}).addStyleClass("sapAstExpressionDialogField");this.groupBySelect.bindItems({path:"/terms",template:new o({text:"{label}",key:"{id}"})});this._bindGroupByDropDown();return this.groupBySelect};f.prototype._bindGroupByDropDown=function(){var e="";if(this.dataObjectId){e=this._returnDataObjectBasedOnType(this._vocabularyExpressionId);if(e){var t=this._getSuggestionsForTheGivenInput(e)}else{var t=this._getSuggestionsForTheGivenInput(this.dataObjectId)}var s=this._getAttributesForGroupBy(t.autoComplete.categories);var r=new a(s);this.groupBySelect.setModel(r)}if(this.groupBySelected){this.groupBySelect.setSelectedKeys(this.groupBySelected)}};f.prototype._getAttributesForGroupBy=function(e){var t=[];if(e&&e.terms){for(var a=0;a<e.terms.length;a++){if(e.terms[a].type==="E"){t.push(e.terms[a])}}return{terms:t}}};f.prototype._createFunctionLabel=function(){this.functionLabelField=new l({value:this.functionLabelDisplay,enabled:false,width:"100%",height:"34px"}).addStyleClass("sapAstFieldMargin sapAstExpressionDialogTextField");return this.functionLabelField};f.prototype._clearData=function(){this._vocabularyExpressionId="";this.functionLabelDisplay="";this.functionLabel="";this._aggregateFunctionSelected="";this._groupBy=[];this._whereExpressionId="";this._attributeId="";this.groupBySelected=[];this.dataObjectId="";this.functionLabelExpression="";this.displayTextVocabulary="";this.jsonDataArray=[];this.groupBySelectEnable=true};f.prototype._convertFunctionLabelToText=function(e,t){this.termsProvider=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var a=this.termsProvider.getTermNameFromASTNodeReference(e);t=t.replace(e,a);return t};f.prototype._createAggregationFunctionDialog=function(e,t,a,r,o){var n=this;this._clearData();this.oBundle=d.getResourceBundleFor("sap.rules.ui.i18n");this._oAstExpressionLanguage=a;sap.ui.require(["sap/rules/ui/AstExpressionBasic"],a=>{if(o){this._whereExpressionId=o.filter;this._aggregateFunctionSelected=o.function;this._attributeId=o.attribute;this.functionLabel=o.functionLabel;this.functionLabelDisplay=this._convertFunctionLabelToText(o.dataObject,o.functionLabel);if(o.groupBy){for(var l=0;l<o.groupBy.length;l++){this.groupBySelected.push(o.groupBy[l].replace("./",""))}}this._groupBy=o.groupBy;this.dataObjectId=o.dataObject;if(typeof o.vocabulary==="object"||o.vocabulary instanceof Object){this._vocabularyExpressionId=o.selectExpression;this.jsonDataArray=[o.vocabulary]}else{this._vocabularyExpressionId=o.vocabulary}this.groupBySelectEnable=this._aggregateFunctionSelected!==s.COUNTDISTINCT&&this._aggregateFunctionSelected!==s.DISTINCT?true:false}var d=n._createFunctionSelectionDropDown(e,"aggregateFunctionSelectLabelId");var b=new u({text:n.oBundle.getText("vocabulary"),tooltip:n.oBundle.getText("vocabulary"),textAlign:"End",width:"90%",layoutData:new i({span:"L2 M2 S12"})});var y=n._createWhereAstExpressionBasic("aggregateWhereLabelId",a);var f=n._createGroupByDropDown("aggregateGroupByLabelId");var _=n._createAttributeAstExpressionBasic("aggregateAttributeLabelId",a);var x=n._createFunctionLabel("aggregateFunctionLabelId");var E=new c({layout:"ResponsiveGridLayout",editable:true,content:[new h("aggregateFunctionSelectLabelId",{text:n.oBundle.getText("function"),tooltip:n.oBundle.getText("function"),labelFor:d.getId()}),d,b,n._createVocabularyAstExpression(b.getId(),a),new h("aggregateAttributeLabelId",{text:n.oBundle.getText("attribute"),tooltip:n.oBundle.getText("attribute"),labelFor:_.getId()}),_,new h("aggregateWhereLabelId",{text:n.oBundle.getText("where"),tooltip:n.oBundle.getText("where"),labelFor:y.getId()}),y,new h("aggregateGroupByLabelId",{text:n.oBundle.getText("group_by"),tooltip:n.oBundle.getText("group_by"),labelFor:f.getId()}),f,new h("aggregateFunctionLabelId",{text:n.oBundle.getText("function_label"),tooltip:n.oBundle.getText("function_label"),labelFor:x.getId()}).addStyleClass("sapAstDialogLabelMargin"),x]});var B=new g({title:this.oBundle.getText("configure_aggr_title"),contentWidth:"800px",showHeader:true,afterOpen:function(){n.astExpressionBasicForWhere.setValue(n._whereExpressionId)},beforeClose:function(){r(false)},content:[E],buttons:[this.applyButton=new p({text:n.oBundle.getText("apply"),enabled:n._enableField(),tooltip:n.oBundle.getText("applyChangesBtnTooltip"),press:function(e){if(n._isDataObjectStructure()||n._isDataObjectElement()){n.astExpressionBasicForVocabulary.setValueState("Error");n.astExpressionBasicForVocabulary.setValueStateText(n.oBundle.getText("StructureElementNotSupported"))}else{n.astExpressionBasicForVocabulary.setValueState("None");if(n.jsonDataArray&&n.jsonDataArray.length>0){var a=n._whereExpressionId;var s=n._attributeId;var r=n._groupBy;var i=n._createJson(n._aggregateFunctionSelected,n.jsonDataArray[0],a,r,n.functionLabel,n.dataObjectId,s)}else{var a=n._whereExpressionId;var s=n._attributeId;var r=n._groupBy;var i=n._createJson(n._aggregateFunctionSelected,n._vocabularyExpressionId,a,r,n.functionLabel,n.dataObjectId,s)}e.getSource().mProperties={value:n.functionLabel,jsonData:i};t(e);n._setModal(false);B.close();B.destroy()}}}),new p({text:n.oBundle.getText("cancel"),tooltip:n.oBundle.getText("cancelBtnTooltip"),press:function(e){n._setModal(false);B.close();B.destroy()}})]}).addStyleClass("sapUiSizeCompact");this._setModal(true);B.open()})};f.prototype._returnDataObjectBasedOnType=function(e){var t="";if(this.jsonDataArray&&this.jsonDataArray.length>0){if(this.jsonDataArray[0]&&this.jsonDataArray[0].attributes){for(var a in this.jsonDataArray[0].attributes){t=this.jsonDataArray[0].doVocabId+a.replace(".","");break}}}else{t=this._vocabularyExpressionId}if(t){var s=t.split("/");var r=s[1];var i=0;var o;var n="";if(s.length>2){for(var l=2;l<s.length;l++){r+="."+s[l];o=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(r);if(o&&o._dataObjectType==="AO"&&o._cardinality==="1..n"){i=l}else if(o&&o._dataObjectType==="R"&&o._isDataObjectTable){i=l}}if(i>0){for(var l=1;l<=i;l++){n+="/"+s[l]}}}if(n){return n}else{return"/"+s[1]}}};f.prototype._isDataObjectStructure=function(){if(this.jsonDataArray&&this.jsonDataArray.length===0){this.tableId=this._vocabularyExpressionId;this.tableId=this.tableId.replace(/\//,"");this.tableId=this.tableId.replace(/\//g,".");var e=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(this.tableId);if(e&&e._dataObjectType&&e._dataObjectType==="S"){return true}else if(e&&e._dataObjectType&&e._dataObjectType==="AO"&&e._cardinality&&e._cardinality==="1..1"){return true}else if(e&&e._dataObjectType&&e._dataObjectType==="R"&&!e._isDataObjectTable){return true}}else{this.tableId=this._returnDataObjectBasedOnType(this._vocabularyExpressionId);if(this.tableId&&(this.tableId.match(/\//g)||[]).length===1){var e=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(this.tableId.replace(/\//,""));if(e&&e._dataObjectType==="S"){return true}}}return false};f.prototype._isDataObjectElement=function(){var e=this.jsonDataArray?this.jsonDataArray[0]:undefined;var t=e?e.dataObject:this._vocabularyExpressionId;this.elementDOId=t.replace(/\//,"");this.elementDOId=this.elementDOId.trim();var a=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(this.elementDOId);if(a&&(a._isDataObjectElement||a.isResultDataObjectElement)){return true}return false};f.prototype._setModal=function(e){var t=b.getElementById("popover");if(t){t.setModal(e)}};f.prototype._createJson=function(e,t,a,s,r,i,o){return{function:e,vocabulary:t,filter:a,attribute:o,groupBy:s,functionLabel:r,dataObject:i}};f.prototype._getSuggestionsForTheGivenInput=function(e){var t=this._oAstExpressionLanguage.getTokensForGivenStringInput(e);var a=this._oAstExpressionLanguage.convertTokensToUiModelForAutoSuggestion(t);var s={};s.AttributeContext=true;s.OperationsContext=false;var r=this._oAstExpressionLanguage.getSuggesstions(a,s);return r};f.prototype.includes=function(e,t){var a=false;if(e.indexOf(t)!==-1){a=true}return a};return{getInstance:function(){if(!y){y=new f;y.constructor=null}return y}}},true);
//# sourceMappingURL=AggregateFunctionDialog.js.map