/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/rules/ui/DecisionTableCellExpressionAdvanced","sap/rules/ui/type/DecisionTableCell","sap/rules/ui/DecisionTableCellExpressionBasic","sap/m/Popover","sap/rules/ui/Constants","sap/rules/ui/ast/constants/Constants","sap/rules/ui/services/AstExpressionLanguage","sap/rules/ui/ast/util/AstUtil","sap/ui/core/LocaleData","sap/ui/core/Control","sap/m/Input","sap/ui/model/Context","sap/ui/core/library","sap/base/i18n/Formatting","sap/ui/core/format/DateFormat","sap/ui/core/EventBus","sap/ui/core/Lib","sap/ui/core/Element","sap/ui/core/Fragment","sap/rules/ui/DecisionTableCellAstExpressionBasic","./DecisionTableCellRenderer"],function(jQuery,e,t,a,i,s,r,n,o,l,u,g,p,d,h,c,f,b,v,y,m,T,S){"use strict";var A=g.extend("sap.rules.ui.DecisionTableCell",{metadata:{library:"sap.rules.ui",properties:{valuePath:{type:"string",defaultValue:"",bindable:"bindable"},valueOnlyPath:{type:"string",defaultValue:"",bindable:"bindable"},headerValuePath:{type:"string",defaultValue:"",bindable:"bindable"},fixedOperatorPath:{type:"string",defaultValue:"",bindable:"bindable"},typePath:{typePath:"string",bindable:"bindable"},valueStatePath:{type:"string",defaultValue:"null",bindable:"bindable"},valueStateTextPath:{type:"string",defaultValue:"null",bindable:"bindable"},valueModelName:{type:"string",defaultValue:"",bindable:"bindable"},displayModelName:{type:"string",defaultValue:"",bindable:"bindable"},editable:{type:"boolean",defaultValue:true},inFocus:{type:"boolean",defaultValue:false},decisionTableCellType:{type:"any",multiple:false},ruleFormatPath:{type:"string",defaultValue:"null",bindable:"bindable"},decisionTableFormat:{type:"sap.rules.ui.DecisionTableFormat",defaultValue:e.DecisionTableFormat.RuleFormat},keyProperties:{type:"object",defaultValue:"{}"},attributeInfoPath:{type:"string",defaultValue:null,bindable:"bindable"},attributeNamePath:{type:"string",defaultValue:null,bindable:"bindable"},headerInfo:{type:"object",defaultValue:{}}},aggregations:{_displayedControl:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},associations:{expressionLanguage:{type:"sap.rules.ui.services.ExpressionLanguage",multiple:false,validateOnLoad:true,singularName:"expressionLanguage"},astExpressionLanguage:{type:"sap.rules.ui.services.AstExpressionLanguage",multiple:false,singularName:"astExpressionLanguage"},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}}},renderer:S});A.prototype._addNodeObject=function(e){var t=[];var a=y.getElementById(this.getAstExpressionLanguage());var i=a._astBunldeInstance.ASTUtil;var s=[];s.Root=e.Root;s.SequenceNumber=e.Sequence;s.ParentId=e.ParentId;s.Reference=e.Reference;s.Id=e.NodeId;s.Type=e.Type;s.Value=e.Value?e.Value:"";if(e.Type==="I"){s.Value=e.IncompleteExpression}if(e.Function){s.Function=e.Function}if(e.Type!=="P"&&!e.Function){var r=[];r.BusinessDataType=e.Output?e.Output.BusinessDataType:e.BusinessDataType;r.DataObjectType=e.Output?e.Output.DataObjectType:e.DataObjectType;s.Output=r}i.createNode(s)};A.prototype._bindPopOverFragment=function(e){var t=this;var a=this.getExpressionLanguage()&&this.getDisplayModelName()?this.getDisplayModelName()+">"+this.getValuePath():this.getValuePath();var i=this.getValueModelName()?this.getValueModelName()+">"+this.getValuePath():this.getValuePath();var s=this.getExpressionLanguage()&&this.getDisplayModelName()?this.getDisplayModelName()+">"+this.getHeaderValuePath():this.getHeaderValuePath();var r=this.getExpressionLanguage()&&this.getDisplayModelName()?this.getDisplayModelName()+">"+this.getFixedOperatorPath():this.getFixedOperatorPath();var n=this.getModel().getProperty(this.getFixedOperatorPath());var o=this.getAggregation("_displayedControl");if(i&&i!=="null"){if(!this.getTypePath()){if(this.getAstExpressionLanguage()){e.setHeaderInfo(this.getHeaderInfo());e.markerString=this._getMarkerString().trim();var l="";n=this.astUtil._getCapitalOperatorName(n);if(o.relString){if(this.includes(o.relString,e.markerString)){l=o.relString.replace(e.markerString,"")}else{l=o.relString}}if(l.startsWith(n+" ")){l=l.split(n+" ")[1]}var u=o.JSON;e.setValue(l);e.setJsonData(u);e.setValueState(o.getValueState())}else{e.bindValue({parts:[{path:s},{path:r},{path:i},{path:a}],type:this.getDecisionTableCellType()})}}else{if(this.getAstExpressionLanguage()){e.setAttributeInfo(this.getAttributeInfoPath());e.setValue(o.relString);e.setJsonData(o.JSON);e.setValueState(o.getValueState())}else{e.bindValue({parts:[{path:i},{path:this.getTypePath()},{path:a}],type:this.getDecisionTableCellType()});if(this.getTypePath()){e.bindType(this.getTypePath())}}}}if(s){e.bindHeaderValue(s);if(r){e.bindFixedOperator(r)}}if("getAttributeInfo"in e&&this.getAttributeInfoPath()&&this.getExpressionLanguage()){e.bindAttributeInfo(this.getAttributeInfoPath())}if("getAttributeName"in e&&this.getAttributeNamePath()){e.bindAttributeName(this.getAttributeNamePath())}};A.prototype._createStaticControl=function(){var e=this;var t=this.getModel("dtModel").getProperty("/editable");var a=this.getModel().getProperty(this.getFixedOperatorPath());var i=this.getAstExpressionLanguage()?this.astUtil._getCapitalOperatorName(a):a;var s=this.getAggregation("_displayedControl");if(s){s.destroy()}s=new p({ariaLabelledBy:this.getAriaLabelledBy(),editable:false});if(t){s.addStyleClass("sapRULDecisionTableSCellEditable")}else{s.removeStyleClass("sapRULDecisionTableSCellEditable")}s.addDelegate({onclick:function(e){if(t){this.onFocusIn()}}.bind(this),onkeyup:function(e){if(e.keyCode===13&&t){this.onFocusIn()}else{return}}.bind(this)});var r=this.getValuePath();var n;var o="/"+r.split("/")[1];var l=new d(this.getModel(),o);if(this.getExpressionLanguage()){r=this.getDisplayModelName()+">"+r}if(r&&r!=="null"){var u=this.getTypePath()?false:true;var g="";if(u&&this.getAstExpressionLanguage()){g=this._getMarkerString()}s.bindValue({path:r,formatter:function(t){if(e.getAstExpressionLanguage()){var a=e._getExpressionFromAstNodes(l,true);if(a&&u){if(g!==""&&e.includes(a,g)){return a.split(g)[1]}else if(a.startsWith(i+" ")){return a.split(i+" ")[1]}else{return a}}else{return a}}else{return t}}});s.bindProperty("tooltip",{path:r,formatter:function(t){if(e.getAstExpressionLanguage()){var a=e._getExpressionFromAstNodes(l,true);if(a&&u){if(g!==""&&e.includes(a,g)){return a.split(g)[1]}else if(a.startsWith(i+" ")){return a.split(i+" ")[1]}else{return a}}else{return a}}else{return t}}})}var c=this.getValueStatePath();if(c&&c!=="null"&&!this.getAstExpressionLanguage()){s.bindProperty("valueState",{path:c,formatter:function(e){var t=h.ValueState.None;if(e===h.ValueState.Error){t=h.ValueState.Error}return t}.bind(this)})}return s};A.prototype._getLocaleData=function(){var e=c.getLanguageTag();return u.getInstance(e)};A.prototype._getDateFormatter=function(){var e=this._getLocaleData();var t=e.getDatePattern("medium");var a=f.getDateInstance({pattern:t});return a};A.prototype._getDateTimeFormatter=function(){var e=this._getLocaleData();var t=e.getDatePattern("medium");var a=e.getTimePattern("medium");var i=f.getDateTimeInstance({pattern:t+" "+a});return i};A.prototype._getExpressionFromAstNodes=function(e,t){var a=this;var i=y.getElementById(this.getAstExpressionLanguage());var s=i._astBunldeInstance.TermsProvider.TermsProvider;var o="";var l="";var u=this.getModel("displayModel");var g=e.getModel();var p=e.getPath();var d=g.getObject(p);var h=0;var c=0;var f=d?d.DecisionTableRowCellASTs:[];var b=i._astBunldeInstance.ASTUtil;var v=[n.AVG,n.SUM,n.COUNT,n.COUNTDISTINCT,n.DISTINCT,n.MIN,n.MAX,n.FILTER,n.TOP,n.BOTTOM,n.FIRST,n.SELECT,n.SORTASC,n.SORTDESC];b.clearNodes();if(f&&f.__list&&f.__list.length>0){f=f.__list;for(var m in f){this._addNodeObject(e.getObject("/"+f[m]))}var T=b.getNodes();if(t){var S=this._getDateFormatter();var A=this._getDateTimeFormatter();o=b.toAstExpressionStringForDt(T,S,A)}else{o=b.toAstExpressionString(T)}c=o.JSON.length;if(o&&o.relString){o.relString=o.relString.replace(/\\/g,"\\\\").replace(/{/g,"\\{").replace(/}/g,"\\}")}this.getAggregation("_displayedControl").relString=o?o.relString:"";this.getAggregation("_displayedControl").shortRELString=o?o.shortRELString:"";this.getAggregation("_displayedControl").JSON=o?o.JSON:[];a.getAggregation("_displayedControl").displayString=o?o.displayString:"";if(T&&T[0].Type==="I"&&T[0].Value!=""){this.getAggregation("_displayedControl").setValueState("Error")}else{this.getAggregation("_displayedControl").setValueState("None")}var _=o.shortRELString?o.shortRELString.split(" "):[];_=o.displayString?o.displayString.split(" "):[];for(var N in _){var E="";if(_[N].startsWith("./")||_[N].startsWith("/")&&!a.includes(_[N],r.MARKER_STRING)){E=s.getTermNameFromASTNodeReference(_[N])}if(E!==""){l=l+" "+E}else{if(a.includes(_[N],"/"+r.MARKER_STRING)){_[N]=_[N].replace("/"+r.MARKER_STRING,"")}if(this.getAggregation("_displayedControl").getValueState()==="Error"&&a.includes(_[N],"====")){_[N]=_[N].replace("====","")}if(a.includes(_[N],r.MARKER_STRING)){_[N]=_[N].replace(r.MARKER_STRING,"")}var P=_[N].split("(");if(a.includes(v,P[0])&&h<c){_[N]=_[N].replace(o.JSON[h].dataObject,s.getTermNameFromASTNodeReference(o.JSON[h].dataObject));h++}l=l+" "+_[N]}}if(l!=""){o=l.trim()}}return o instanceof Object?o.shortRELString:o.trim()};A.prototype._getMarkerString=function(){var e;var t=this.getHeaderInfo().headerValue;if(t===undefined||t.trim()===""){return""}var a=t.split(" ");var i=a[a.length-1]!==""?a[a.length-1]:a[a.length-2];var s=["=","!=",">",">=","<","<=","IN","NOTIN","EXISTSIN","NOTEXISTSIN","MATCHES","NOTMATCHES","CONTAINS","NOTCONTAINS","STARTSWITH","NOTSTARTSWITH","ENDSWITH","NOTENDSWITH","ISWITHIN","ISNOTWITHIN","+","-","/","*"];var n=["AND","OR"];if(n.indexOf(i)>-1){e=""}else if(s.indexOf(i)>-1){e="/"+r.MARKER_STRING+" ==== "}else{e="/"+r.MARKER_STRING+" "}return e};A.prototype._setDisplayedControl=function(){var e=this._createStaticControl();this.setAggregation("_displayedControl",e,true)};A.prototype.init=function(){this.astUtil=new l;this.oBundle=v.getResourceBundleFor("sap.rules.ui.i18n")};A.prototype.onAfterRendering=function(){this.bColumnResized=false;var e=b.getInstance();e.unsubscribe("sap.ui.rules","_onColumnResized",this._setColumnResized,this)};A.prototype.onBeforeRendering=function(){var e=b.getInstance();e.subscribeOnce("sap.ui.rules","_onColumnResized",this._setColumnResized,this);if(!this.bColumnResized){this._setDisplayedControl()}};A.prototype._setColumnResized=function(e,t){this.bColumnResized=true};A.prototype.onFocusIn=async function(){var t=function(e){var t=e.getSource().getAggregation("content")[1];t.setVisible(true);var a=this.getAggregation("_displayedControl");a.setEnabled(false)}.bind(this);var a=function(e){var t=this.getAggregation("_displayedControl");if(t){t.setEnabled(true)}}.bind(this);var i=function(e){if(this._oPopover){var t=this._oPopover.getAggregation("content")[1];if(t.isA("sap.rules.ui.ExpressionAdvanced")){if(t.codeMirror){var a=t.codeMirror.getValue();t.setValue(a)}}else if(t.isA("sap.rules.ui.AstExpressionBasic")){t._fireChange(t._input.text())}this._oPopover.destroy();this._oPopover=null;var i=this.getAggregation("_displayedControl");i.focus()}}.bind(this);this._oPopover=null;if(!this._oPopover){var s=this.getModel().getProperty(this.getValueOnlyPath());var r=this.getModel().getProperty(this.getRuleFormatPath());var n=this.getDecisionTableFormat();if(y.getElementById("popover")){y.getElementById("popover").destroy()}if(this.getAstExpressionLanguage()){this._oPopover=await m.load({name:"sap.rules.ui.fragments.DecisionTableCellAstExpressionBasic",controller:this});this._oPopover.setTooltip(this.oBundle.getText("ctrlSpaceCue"));var o=this._oPopover.getAggregation("content")[1];o.setAstExpressionLanguage(this.getAstExpressionLanguage());o.attachChange(T.prototype._changeValue)}else{if(n===e.DecisionTableFormat.RuleFormat){if(r.toUpperCase()===e.RuleFormat.Advanced){this._oPopover=await m.load({name:"sap.rules.ui.fragments.DecisionTableCellExpressionAdvanced",controller:this})}else{this._oPopover=await m.load({name:"sap.rules.ui.fragments.DecisionTableCellExpressionBasic",controller:this})}}else if(s){this._oPopover=await m.load({name:"sap.rules.ui.fragments.DecisionTableCellExpressionBasic",controller:this})}else{this._oPopover=await m.load({name:"sap.rules.ui.fragments.DecisionTableCellAstExpressionBasic",controller:this})}var o=this._oPopover.getAggregation("content")[1];o.setExpressionLanguage(this.getExpressionLanguage())}this._oPopover.attachAfterOpen(t);this._oPopover.attachBeforeClose(a);this._oPopover.attachAfterClose(i);this.addDependent(this._oPopover);var l=jQuery(document.getElementById(this.getId())).closest("td").width()*.93;var u=l+"px";var g=this._oPopover.getAggregation("content")[0];g.setWidth(u);if(this.getModel("settingModel")&&this.getModel("settingModel").oData){o.resultDataObjectId=this.getModel("settingModel").oData.ResultDataObjectId;o.resultDataObjectName=this.getModel("settingModel").oData.ResultDataObjectName}this._bindPopOverFragment(o);var p=this.getAggregation("_displayedControl");this._oPopover.openBy(p)}};A.prototype.includes=function(e,t){var a=false;if(e.indexOf(t)!==-1){a=true}return a};A.prototype.setDecisionTableCellType=function(e){if(e!=null&&e.isA("sap.rules.ui.type.DecisionTableCell")){this.setProperty("decisionTableCellType",e)}};return A},true);
//# sourceMappingURL=DecisionTableCell.js.map