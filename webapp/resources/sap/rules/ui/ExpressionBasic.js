/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/ui/core/Control","sap/rules/ui/InstructionRenderer","sap/rules/ui/ExpressionBase","sap/base/i18n/Formatting","sap/ui/core/format/DateFormat","sap/ui/core/format/NumberFormat","sap/ui/comp/odata/MetadataAnalyser","sap/ui/core/Element","./ExpressionBasicRenderer"],function(jQuery,t,e,i,n,s,r,a,o,u,c){"use strict";var l=n.extend("sap.rules.ui.ExpressionBasic",{metadata:{properties:{value:{type:"string",defaultValue:"",bindable:"bindable"}},aggregations:{_instructionRenderer:{type:"sap.rules.ui.InstructionRenderer",multiple:false}}},init:function(){this.shouldReload=true},_removeFurtherInstructions:function(t){var e=this.instructions.length;var i=e-t-1;this.instructions.splice(t+1,i)},_onChange:function(t){var e=t.getParameter("instructionNum");this._onChangeByIndex(e)},_onChangeByIndex:function(e,i,n){i=i||"";n=n===undefined||n===null?e:n;var s=this.getAggregation("_instructionRenderer");var r=s.getExpression();if(e>1){this.setProperty("value",r);return}this._removeFurtherInstructions(n);r=s.getExpression();var a=u.getElementById(this.getExpressionLanguage());var o=t.SuggestionsPart;var c;var l;if(e==0){c=a._getBasicSuggestions(r,o.compPart)}if(e==1){c=a._getBasicSuggestions(i+" "+r,o.rightPart)}this.oDeferred=new jQuery.Deferred;for(var h=0;h<c.length;h++){if(c[h].valueListObject&&h===c.length-1){this.oDeferred.done(function(t,e){if(e){this.instructions=this.instructions.concat(l);s.setInstructions(this.instructions);this.setProperty("value",r);return}l=t;this.instructions=this.instructions.concat(l);s.setInstructions(this.instructions);this.setProperty("value",r);return}.bind(this))}}l=this._createInstructions(c);if(l){this.instructions=this.instructions.concat(l);s.setInstructions(this.instructions);this.setProperty("value",r)}},_callbackForActionControl:function(t,e){var i=this._createInstructions(e);this.instructions.splice.apply(this.instructions,[t,0].concat(i));var n=this.getAggregation("_instructionRenderer");n.setInstructions(this.instructions)},_createInstructions:function(e){var i=[];var n;var r;var c;for(var l=0;l<e.length;l++){r={};n=e[l];if(Array.isArray(n)){r.type="action";r.callback=this._callbackForActionControl.bind(this,l,n);r.editable=true}else{c=n.sugg;if(c&&c.length!==0){r.valueOptions={};r.valueOptions.type="Set";r.valueOptions.values=[];var h=r.valueOptions.values;for(var g=0;g<c.length;g++){h.push({token:c[g],text:c[g]})}}r.text=n.currentValue;r.token=n.currentValue;if(n.BDT){r.businessDataType=n.BDT}if(n.BDT===t.ExpressionType.Number){var d=s.getLanguageTag();var f=a.getFloatInstance(d);var v=function(t){t=f.parse(t);if(isNaN(t)){return""}return t};r.text=v(r.text);r.token=v(r.token)}r.editable=true}r.visible=true;if(n.tokenCategory==="reservedword.undefined"||n.tokenCategory==="reservedword.null"){r.editable=false}else{r.editable=true}if(n.valueListObject){var p=[n.valueListObject];r.valueListObject=n.valueListObject;var b=u.getElementById(this.getExpressionLanguage());r.expressionLanguage=b;if(p&&p instanceof Array&&!p[0].metadata.HasValueSource){r.valueListObject=p[0];var _=r.valueListObject.model;if(_&&!_.getMetaModel().oModel){var y=function(){var t=b.getValueHelpCallback();t.call(this,p);var e=r.valueListObject.model;var n=new o(e);var s=r.valueListObject.metadata.propertyPath;var a=n.getValueListAnnotation(s);i.forEach(function(t){t.valueListAnnotation=a}.bind(this));this.oDeferred.resolve(i)}.bind(this);if(l===e.length-1){_.attachMetadataLoaded(y);_.attachMetadataFailed(function(){this.oDeferred.resolve(i,true)}.bind(this))}}}}i.push(r)}return i},setValue:function(t){this.shouldReload=true;this.setProperty("value",t)},_reload:function(){this.shouldReload=false;var t=u.getElementById(this.getExpressionLanguage())._getBasicSuggestions(this.getValue());if(this._checkForValueHelpSuggestions(t)){return}this.instructions=this._createInstructions(t);var e=new i({instructions:this.instructions,useIndent:false,change:this._onChange.bind(this)});this.setAggregation("_instructionRenderer",e,true)},onBeforeRendering:function(){if(this.shouldReload==true){this._reload()}},onAfterRendering:function(){if(this.shouldReload==true){this._reload()}var t=this.getAggregation("_instructionRenderer");if(!t){return}var e=t.getAggregation("_content");if(!e){return}var i=this.instructions[this.instructions.length-2];if(i&&!i.editable&&e[e.length-3]){e[e.length-3].focus()}else{e[e.length-1].focus()}this.$().on("change",null,function(t){this.focus()}.bind(this))},_checkForValueHelpSuggestions:function(t){this.oDeferred=new jQuery.Deferred;for(var e=0;e<t.length;e++){if(t[e].valueListObject){this.oDeferred.done(function(t){var e=new i({instructions:this.instructions,useIndent:false,change:this._onChange.bind(this)});this.setAggregation("_instructionRenderer",e,true);this.shouldReload=false;this.rerender()}.bind(this));this.instructions=this._createInstructions(t);return true}}return false},renderer:c});return l},true);
//# sourceMappingURL=ExpressionBasic.js.map