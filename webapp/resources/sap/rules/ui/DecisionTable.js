/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/ui/thirdparty/jquery","./library","sap/rules/ui/DecisionTableCell","sap/rules/ui/RuleBase","sap/rules/ui/Utils","sap/ui/table/Table","sap/ui/table/Column","sap/m/OverflowToolbar","sap/m/Popover","sap/m/Menu","sap/m/Dialog","sap/m/MenuButton","sap/m/Button","sap/m/ToolbarSpacer","sap/m/Text","sap/m/Input","sap/m/ObjectIdentifier","sap/m/Link","sap/m/Label","sap/m/BusyIndicator","sap/m/DisplayListItem","sap/m/MenuItem","sap/m/FlexBox","sap/m/MessageStrip","sap/rules/ui/DecisionTableSettingsOld","sap/rules/ui/DecisionTableSettings","sap/rules/ui/type/DecisionTableCell","sap/rules/ui/ast/constants/Constants","sap/rules/ui/services/AstExpressionLanguage","sap/rules/ui/ast/util/AstUtil","sap/rules/ui/Constants","sap/ui/core/LocaleData","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/Title","sap/m/library","sap/ui/core/library","sap/ui/table/library","sap/ui/core/EventBus","sap/ui/base/Event","sap/ui/model/Sorter","sap/base/i18n/Formatting","sap/ui/core/format/DateFormat","sap/ui/core/Lib","sap/ui/core/Element","sap/ui/core/message/MessageType","sap/ui/model/odata/v2/Context","sap/ui/table/rowmodes/Fixed","./DecisionTableRenderer"],function(e,jQuery,t,a,i,s,n,r,o,l,d,u,c,h,g,p,f,b,v,_,m,y,R,T,w,C,M,S,x,D,E,B,P,I,A,O,L,N,F,V,k,q,H,U,j,W,K,J,z,Y){"use strict";var G=L.ButtonType;var X={vocabulary:"vocabulary",rule:"rule",columns:"columns",rows:"rows"};var Q=3;var Z=i.extend("sap.rules.ui.DecisionTable",{metadata:{properties:{enableSettings:{type:"boolean",group:"Misc",defaultValue:false},enableSettingResult:{type:"boolean",defaultValue:true},cellFormat:{type:"sap.rules.ui.DecisionTableCellFormat",defaultValue:t.DecisionTableCellFormat.Both},hitPolicies:{type:"sap.rules.ui.RuleHitPolicy[]",defaultValue:[t.RuleHitPolicy.FirstMatch,t.RuleHitPolicy.AllMatch]},lineActionBuffer:{type:"any",defaultValue:{rowPath:null,operation:null}},decisionTableFormat:{type:"sap.rules.ui.DecisionTableFormat",defaultValue:t.DecisionTableFormat.RuleFormat},threshold:{type:"int",defaultValue:999},visibleRowCount:{type:"int",defaultValue:999}},aggregations:{_toolbar:{type:"sap.m.OverflowToolbar",multiple:false,singularName:"_toolbar"},_table:{type:"sap.ui.core.Control",multiple:false,singularName:"_table"},_errorsText:{type:"sap.m.MessageStrip",multiple:false,singularName:"_errorsText"}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},ariaRoleDescription:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaRoleDescription"}}},_addErrorLabel:function(){var e=new w({showCloseButton:true,showIcon:true,type:K.Error,visible:false}).addStyleClass("sapUiTinyMargin");this.setAggregation("_errorsText",e,true)},_addNewRow:function(e,t){var a=this.oMenu;if(a){a.close()}var i=this._getModel();var s=this.dataBucket.columns&&this.dataBucket.columns.results;if(!i||!s){return}var n=this.getAggregation("_table"),r=this.getBindingContext(),o=r.getProperty("Id"),l=r.getProperty("Version");var d={RuleId:o,Version:l};e=e||0;var u;if(t){d.Sequence=1}else{u=n.getContextByIndex(e).getPath();d.Sequence=i.getProperty(u).Sequence;d.Sequence++}d.Id=this._calNextRowId();i.createEntry("/DecisionTableRows",{properties:d});n.setSelectedIndex(d.Sequence-1);this._clearErrorMessages();this._saveWorkAround([],this.oBundle.getText("addRowSuccess"))},_addNewRowWorkaround:function(e){var t=this._internalModel.getProperty("/selectedRow");this._addNewRow(t,e)},_addNodeObject:function(e){var t=[];var a=W.getElementById(this.getAstExpressionLanguage());var i=a._astBunldeInstance.ASTUtil;var s=[];s.Root=e.Root;s.SequenceNumber=e.Sequence;s.ParentId=e.ParentId;s.Reference=e.Reference;s.Id=e.NodeId;s.Type=e.Type;s.Value=e.Value?e.Value:"";if(e.Type==="I"){s.Value=e.IncompleteExpression}if(e.Function){s.Function=e.Function}if(e.Type!=="P"&&e.Type!=="O"&&!e.Function){var n=[];n.BusinessDataType=e.Output?e.Output.BusinessDataType:e.BusinessDataType;n.DataObjectType=e.Output?e.Output.DataObjectType:e.DataObjectType;s.Output=n}i.createNode(s)},_addTable:function(){var e=new n({threshold:this.THRESHOLD,rowMode:new z({rowCount:this.VISIBLEROWCOUNT,rowContentHeight:50}),selectionMode:{parts:[{path:"dtModel>/editable"}],formatter:this._decideSelectionMode},rowSelectionChange:function(){this.oParent._rowSelectionChange()},enableColumnReordering:false,busy:"{dtModel>/busyTableState}"});e.attachRowsUpdated(function(){for(const t of e.getRows()){for(const e of t.getCells()){this._updateTableCell(e,t.getBindingContext())}}});e._updateTableCell=this._updateTableCell;e.setBusyIndicatorDelay(0);this.setAggregation("_table",e,true)},_addToolBar:function(){var e=new o({design:"Transparent",enabled:"{dtModel>/editable}"});var t=new O({text:this.oBundle.getText("decisionTable"),tooltip:this.oBundle.getText("decisionTable")});var a=new c({text:this.oBundle.getText("addRow"),visible:"{dtModel>/editable}",enabled:{parts:[{path:"dtModel>/newTable"}],formatter:this._decideAddRowEnablement},menu:new d({items:this._getMenuItems()})}).setTooltip(this.oBundle.getText("addRow"));var i=new h({text:this.oBundle.getText("deleteRow"),press:[this._deleteRowWorkaround,this],visible:"{dtModel>/editable}",type:G.Transparent,enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isAtLeastOneRowSelected"}],formatter:this._decideDeleteRowEnablement}}).setTooltip(this.oBundle.getText("deleteRow"));var s=new h({text:this.oBundle.getText("copyRow"),press:[this._copyRow,this],type:G.Transparent,visible:{parts:[{path:"dtModel>/editable"},{path:"dtModel>/sequenceExist"}],formatter:this._decideLineActionVisibility},enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement}}).setTooltip(this.oBundle.getText("copyRow"));var n=new h({text:this.oBundle.getText("cutRow"),type:G.Transparent,press:[this._cutRow,this],visible:{parts:[{path:"dtModel>/editable"},{path:"dtModel>/sequenceExist"}],formatter:this._decideLineActionVisibility},enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement}}).setTooltip(this.oBundle.getText("cutRow"));var r=new c({text:this.oBundle.getText("pasteRow"),type:G.Transparent,visible:{parts:[{path:"dtModel>/editable"},{path:"dtModel>/sequenceExist"}],formatter:this._decideLineActionVisibility},enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"},{path:"dtModel>/isSelection"}],formatter:this._decidePasteRowEnablement},menu:new d({items:this._getPasteMenuItems()})}).setTooltip(this.oBundle.getText("pasteRow"));var l=new h({text:"",press:this._openTableSettings.bind(this),visible:{parts:[{path:"dtModel>/enableSettings"},{path:"dtModel>/editable"}],formatter:this._decideSettingsEnablement},enabled:{parts:[{path:"dtModel>/enableSettings"},{path:"dtModel>/editable"}],formatter:this._decideSettingsEnablement}}).setTooltip(this.oBundle.getText("tableSettings"));l.setIcon("sap-icon://action-settings");e.addContent(t);e.addContent(new g({}));e.addContent(a);e.addContent(new g({width:"1em"}));e.addContent(i);e._delete=i;e.addContent(new g({width:"1em"}));e.addContent(s);e.addContent(new g({width:"1em"}));e.addContent(n);e.addContent(new g({width:"1em"}));e.addContent(r);e.addContent(new g({width:"1em"}));e.addContent(l);e.addContent(new g({width:"1em"}));this.setAggregation("_toolbar",e,true)},_bindColumns:function(){var e=this.getAggregation("_table");var t=[this._getBindModelName(),this.getBindingContextPath(),"/DecisionTable/DecisionTableColumns"].join("");var a="Condition,Result";if(this.getAstExpressionLanguage()){a="Condition/DecisionTableColumnConditionASTs,Result/DecisionTableColumnResultASTs"}e.bindColumns({path:t,parameters:{expand:a},factory:this._columnFactory.bind(this)});e.getBinding("columns").attachDataRequested(this._handleColumnsDataRequested,this);e.getBinding("columns").attachDataReceived(this._handleColumnsDataReceived,this);e.attachColumnResize(e,this._onColumnResize,this)},_onColumnResize:function(){this.columnResized=true;var e={colResize:true};var t=V.getInstance();t.publish("sap.ui.rules","_onColumnResized",e)},_bindRows:function(){var e=this.getAggregation("_table");var t=[this._getBindModelName(),this.getBindingContextPath(),"/DecisionTable/DecisionTableRows"].join("");var a="Cells";if(this.getAstExpressionLanguage()){a="Cells/DecisionTableRowCellASTs"}var i=new q("Sequence");e.bindRows({path:t,parameters:{expand:a},sorter:i});e.getBinding("rows").attachDataRequested(this._handleRowsDataRequested,this);e.getBinding("rows").attachDataReceived(this._handleRowsDataReceived,this)},_bindRule:function(){var e=[this._getBindModelName(),this.getBindingContextPath()].join("");this.bindElement({path:e,parameters:{expand:"DecisionTable"}});this.getElementBinding().attachDataRequested(this._handleRuleDataRequested,this);this.getElementBinding().attachDataReceived(this._handleRuleDataReceived,this);this.getElementBinding().refresh()},_buildMessagesStructure:function(e,t,a){var i;var s;var n;var r;if(!e.details){return t}for(var o=0;o<e.details.length;o++){i=e.details[o];if(!i.messages){continue}for(var l=0;l<i.messages.length;l++){n=i.messages[l].description;s=i.messages[l].additionalInfo;if(s.type==="ruleResult"){a.push(n);r="genericError";t[r]=a}else if(s.type==="column"){r="errorInColumnHeader";t[r]=true}else if(s.type==="cell"){r="RowId="+s.rowId+",ColId="+s.colId;t[r]=n}}}return t},_callCopyRuleRow:function(e,t,a,i,s,n){var r={groupId:"changes"};this._getModel().setDeferredGroups([r.groupId]);var o=function(e){this.resetControl();this._internalModel.setProperty("/busyState",false)}.bind(this);var l=function(e){A.show(e)}.bind(this);var d=function(t){this._getModel().callFunction("/CopyRuleRow",{method:"POST",groupId:r.groupId,urlParameters:{RuleId:e,SourceRowId:a,TargetRowSeq:i,DeleteSourceRow:s,OverrideTargetRow:n}});this._getModel().submitChanges({groupId:r.groupId,success:o,error:l})}.bind(this);if(this._getModel().hasPendingChanges()){this._getModel().submitChanges({groupId:r.groupId,success:d,error:l})}else{d()}},_calNextRowId:function(){var e=this.dataBucket.rows.results;var t=0;for(var a=0;a<e.length;a++){if(e[a].Id>t){t=e[a].Id}}var i=t+1;return i},_clearErrorMessages:function(){var e=this.getAggregation("_errorsText");e.setText("");e.setVisible(false);this._internalModel.setProperty("/validationStatus",{},null,true);this._internalModel.setProperty("/valueState",{},null,true)},_closePopover:function(){var e=W.getElementById("popover");if(e){e.close()}},_collectColIdAndExpressionDetails:function(e){var t=e.length;var a=[];for(var i=0;i<t;i++){if(e[i].Result&&e[i].Result.Expression){var s={columnID:e[i].Result.Id,expressionContent:e[i].Result.Expression};a.push(s)}}return a},_columnFactory:function(e,a){var i=this;if(this.multiHeaderFlag){this.multiHeaderFlag=false}var s=this._getBindModelName();var n=a.getProperty("Type"),o=a.getProperty("Id"),l=a.getProperty("RuleId"),d=a.getProperty("Version");var u={RuleId:l,Id:o,Version:d};var c=s+a.getModel().createKey("/DecisionTableColumnResults",u);var h=a.getModel();var g=h.aBindings;this.columnWidth="auto";var p=this._createColIfThenHeader(a);var f=this._createColDescriptionHeader(a,this);var b=new r(e,{width:this.columnWidth,minWidth:128,multiLabels:[p,f],template:this._createCell(a,f.getId())});s=this._getBindModelName();this.firstResultColumnBound=a.getProperty(s+"Type")===t.DecisionTableColumn.Result;if(n===t.DecisionTableColumn.Result){if(this.getAstExpressionLanguage()){b.bindProperty("visible",{parts:[{path:c+"/AccessMode"}],formatter:this._columnVisibility})}if(this.getExpressionLanguage()){b.bindProperty("visible",{parts:[{path:c+"/AccessMode"}],formatter:function(){var e=i.getModel()&&c!==""?i.getModel().getObject(c).BusinessDataType:"";if(e===B.DATE_BUSINESS_TYPE||e===B.TIMESTAMP_BUSINESS_TYPE||e===B.NUMBER||e===B.STRING||e===B.BOOLEAN_BUSINESS_TYPE||e===B.BOOLEAN_ENHANCED_BUSINESS_TYPE){var t=i.getModel().getObject(c).AccessMode;return i._columnVisibility(t)}else{return false}}})}}return b},_columnVisibility:function(e){if(e==="Hidden"||e==="HIDDEN"){return false}else{return true}},_concatinateColumnsHeaderErrors:function(e){var t="";for(var a in e){if(e.hasOwnProperty(a)){if(e[a].header){t+="In Col: "+a+" - "+e[a].header+"\n"}}}return t},_concatinateHeaderErrors:function(e){var t="";for(var a=0;a<e.length;a++){t+="\n"+e[a]}return t},_convertAndValidate:function(){var e=this._getRuleData();var t=W.getElementById(this.getExpressionLanguage());if(t){var a={};if(t&&e){a=t.convertRuleToDisplayValues(e);if(a.deferredResult){a.deferredResult.done(this._processValidationResults.bind(this))}else{this._processValidationResults(a,e)}}}else{this._displayModel.setData(e);this._settingsModel.setData(e)}},_copyRow:function(){this._cutCopyRow("copy")},_createCell:function(e,t){var i=e.getProperty("Id");var s=e.getProperty("Type");var n=new a({editable:"{dtModel>/editable}",displayModelName:"displayModel",ariaLabelledBy:t,decisionTableCellType:this._decisionTableCellFormatter}).data({colId:i,colType:s,table:this.getAggregation("_table")});if(this.getAstExpressionLanguage()){n.setAstExpressionLanguage(this.getAstExpressionLanguage())}else{n.setExpressionLanguage(this.getExpressionLanguage())}return n},_createColDescriptionHeader:function(e,a){var i=this;var s=e.getProperty("Type"),n=e.getProperty("Id"),r=e.getProperty("RuleId"),o=e.getProperty("Version");var l="";var d;var u;var c;var h;var g={RuleId:r,Id:n,Version:o};var f;if(this.getExpressionLanguage()){l="displayModel>"}var b=document.getElementsByClassName("sapUiSizeCozy").length>0?3:1;var v=new p({maxLines:b}).addStyleClass("sapRULDecisionTableColumnHeaderLabel");if(s===t.DecisionTableColumn.Condition){u=e.getModel().createKey("/DecisionTableColumnConditions",g);f=e.getModel().createKey("/DecisionTableColumns",g);c=new J(e.getModel(),u);if(this.getAstExpressionLanguage()){h=a._getExpressionFromAstNodes(c)}d=l+u;v.bindText({parts:[{path:d+"/Expression"},{path:f+"/Label"},{path:d+"/FixedOperator"}],formatter:function(e,t,a){var s="";if(i.getAstExpressionLanguage()){s=!t?h:t}else{s=!t?e:t}if(a){var n=i.getAstExpressionLanguage()?i.astUtil._getCapitalOperatorName(a):a;s+=" "+n}return s}});v.bindProperty("tooltip",{parts:[{path:d+"/Expression"},{path:d+"/FixedOperator"}],formatter:function(e,t){var a="";if(i.getAstExpressionLanguage()){a=h?h:""}else{a=e}if(t){var s=i.getAstExpressionLanguage()?i.astUtil._getCapitalOperatorName(t):t;a+=" "+s}return a}})}else if(s===t.DecisionTableColumn.Result){var _=e.getModel().createKey("/DecisionTableColumnResults",g);d=l+_;v.bindText({parts:[{path:d+"/DataObjectAttributeName"},{path:d+"/DataObjectAttributeLabel"},{path:"dtModel>/busyState"}],formatter:this._getOutputColumnDescription.bind(this)});v.bindProperty("tooltip",{parts:[{path:d+"/DataObjectAttributeName"},{path:d+"/DataObjectAttributeLabel"},{path:"dtModel>/busyState"}],formatter:this._getOutputColumnDescription.bind(this)})}return v},_createColIfThenHeader:function(e){var a=this._getBindModelName();var i=this.oBundle;return new _({text:{parts:[{path:a+"Type"},{path:a+"Sequence"}],formatter:function(e,a){if(a===1){return i.getText("title_if")}else if(e===t.DecisionTableColumn.Result){return i.getText("title_then")}else{return""}}},design:"Bold"})},_createDecisionTableSettings:function(){var e;if(this.isSequenceExistsInOdataMetadata()){e=this._createNewDecisionTableSettings()}else{e=this._createOldDecisionTableSettings()}return e},_createNewDecisionTableSettings:function(){var e=this._getModel();var t=this.getBindingContext();var a=new M({hitPolicies:"{dtModel>/hitPolicies}",newDecisionTable:this._internalModel.getProperty("/newTable"),cellFormat:"{dtModel>/cellFormat}",decisionTableFormat:this.getDecisionTableFormat(),enableSettingResult:this.getEnableSettingResult()});if(this.getAstExpressionLanguage()){a.setAstExpressionLanguage(this.getAstExpressionLanguage())}else{a.setExpressionLanguage(this.getExpressionLanguage())}var i=JSON.stringify(this._settingsModel.getData());var s=JSON.parse(i);var n=new I(s);a.setModel(n);a.setModel(this._internalModel,"dtModel");a.setModel(e,"oDataModel");a.setBindingContext(t,"dummy");return a},_createOldDecisionTableSettings:function(){var e=this._getModel();var t=this.getBindingContext();var a=new C({expressionLanguage:this.getExpressionLanguage(),hitPolicies:"{dtModel>/hitPolicies}",newDecisionTable:this._internalModel.getProperty("/newTable")});a.setModel(e);a.setModel(this._internalModel,"dtModel");a.setBindingContext(t);return a},_cutCopyRow:function(e){var t=this._getModel();if(!t){return}var a=this.getAggregation("_table");var i=[];if(a){i=a.getSelectedIndices()}if(i.length!==1){return}var s=a.getContextByIndex(i[0]).getPath();this._markSelection(false);this.setLineActionBuffer({rowPath:s,operation:e});this._markSelection(true);a.setSelectedIndex(-1);A.show(this.oBundle.getText(e+"RowSuccess"))},_cutRow:function(){this._cutCopyRow("cut")},_dataPartRequested:function(e){this.dataBucket.dataReceived[e]=false;this._setDataLoadedPromise();this._updateBusyState()},_dataPartReceived:function(e){this.dataBucket.dataReceived[e]=true;if(!this._isAllDataReceived()){return}try{this._convertAndValidate();this.dataBucket.collectRowsMode="replace"}catch(e){window.console.log(e)}this._updateBusyState();this._dataLoaded.resolve()},_decideAddRowEnablement:function(e){return!e},_decideCopyRowEnablement:function(e,t){return e===false&&t},_decideDeleteRowEnablement:function(e,t){return e===false&&t},_decideLineActionVisibility:function(e,t){return e===true&&t},_decidePasteRowEnablement:function(e,t,a){return e===false&&t&&a},_decideSelectionMode:function(e){return e?F.SelectionMode.MultiToggle:F.SelectionMode.None},_decideSettingsEnablement:function(e,t){return e&&t},_deleteRow:function(){var e=this._getModel();if(!e){return}var t=this.getAggregation("_table");var a=[];if(t){a=t.getSelectedIndices()}if(a.length===0){return}var i=a.length;for(var s=0;s<i;s++){var n=t.getContextByIndex(a[s]).getPath();e.remove(n)}t.setSelectedIndex(-1);this._clearErrorMessages();this.setLineActionBuffer({rowPath:null,operation:null});A.show(this.oBundle.getText("deleteRowSuccess"))},_deleteRowWorkaround:function(){var e=this._getModel();if(e.hasPendingChanges()){this._saveWorkAround({success:function(){this._deleteRow()}.bind(this)})}else{this._deleteRow()}},_displayErrorMessages:function(e,t){},_displayHeaderErrorMessages:function(e,t){var a=this.getAggregation("_errorsText");this.oBundle=j.getResourceBundleFor("sap.rules.ui.i18n");var i=this._concatinateHeaderErrors(e);a.setText(this.oBundle.getText("errorInTableHeader")+i);a.setVisible(true)},_flatRule:function(t){var a=this._getModel();var i={};var s=function(e,t,i){var s=a.createKey(t,i);e[s]=i};t.DecisionTable.DecisionTableColumns.results.forEach(function(e,t){if(e.Type==="CONDITION"){var a=e.Condition;if(a.parserResults&&a.parserResults.status==="Success"){a.Expression=a.parserResults.converted.Expression;if(a.parserResults.converted.FixedOperator||a.parserResults.converted.FixedOperator===""){a.FixedOperator=a.parserResults.converted.FixedOperator}else{a.FixedOperator=a.FixedOperator}}else{try{a.Expression=JSON.parse(a.Expression).text}catch(e){a.Expression=a.Expression}try{a.FixedOperator=JSON.parse(a.FixedOperator).text}catch(e){a.Expression=a.Expression}}delete a.parserResults;s(i,"DecisionTableColumnConditions",a)}else if(e.Type==="RESULT"){var n=e.Result;s(i,"DecisionTableColumnResults",n)}});t.DecisionTable.DecisionTableRows.results.forEach(function(t){var a=t.Cells;a.results.forEach(function(t){if(t.parserResults&&t.parserResults.status==="Success"){if(t.parserResults.converted.Content){t.Content=t.parserResults.converted.Content}else{t.Content=t.Content}}else if(t.parserResults&&t.parserResults.status==="Error"){try{if(t.Content===Object){t.Content=JSON.parse(t.Content).text}else{t.Content=t.Content}}catch(a){t.Content="";e.error("failed to pars AST cell in ColId "+t.ColId+" RowId "+t.RowId+" set cell content to empty")}}delete t.parserResults;s(i,"DecisionTableRowCells",t)})});return i},_getBindModelName:function(){var e="";var t=this.getModelName();if(t){e=t+">"}return e},_getBlankContent:function(){var e=new _({text:this.oBundle.getText("start")});var t=new p;t.setText(" ");var a=new v({enabled:{parts:[{path:"dtModel>/enableSettings"},{path:"dtModel>/editable"}],formatter:this._decideSettingsEnablement},text:" "+this.oBundle.getText("settings"),press:[this._openTableSettings,this]}).addStyleClass("sapRULDecisionTableLink");var i=new T({justifyContent:"Center",items:[e,t,a],visible:{parts:[{path:"dtModel>/enableSettings"},{path:"dtModel>/editable"}],formatter:this._decideSettingsEnablement}}).addStyleClass("sapUiMediumMargin");return i},_getDataLoadedPromise:function(){if(!this._dataLoaded){this._setDataLoadedPromise()}return this._dataLoaded.promise()},_getExpressionFromAstNodes:function(e){var t=this;var a=W.getElementById(this.getAstExpressionLanguage());var i=a._astBunldeInstance.TermsProvider.TermsProvider;var s="";var n="";var r=e.getPath();var o=e.getObject(r);var l=o.DecisionTableColumnConditionASTs;var d=a._astBunldeInstance.ASTUtil;var u=this._internalModel.getProperty("/conditionCellAstValues");var c=0;var h=0;var g=[x.AVG,x.SUM,x.COUNT,x.COUNTDISTINCT,x.DISTINCT,x.MIN,x.MAX,x.FILTER,x.TOP,x.BOTTOM,x.FIRST,x.SELECT,x.SORTASC,x.SORTDESC];d.clearNodes();l=l.__list;if(l&&l.length>0){for(var p in l){var f=l[p];t._addNodeObject(e.getObject("/"+f))}var b=d.getNodes();var v=t._getDateFormatter();var _=t._getDateTimeFormatter();s=d.toAstExpressionStringForDt(b,v,_);h=s.JSON.length;var m=e.getObject(e.getPath()).FixedOperator;var y=t.astUtil._getCapitalOperatorName(m);if(s&&s.relString){s.relString=s.relString.replace(/\\/g,"\\\\").replace(/{/g,"\\{").replace(/}/g,"\\}")}u[e.getPath()]={headerValue:s.relString+" "+y};var R=s.shortRELString?s.shortRELString.split(" "):[];R=s.displayString?s.displayString.split(" "):[];for(var T in R){var w="";if(R[T].startsWith("./")||R[T].startsWith("/")){w=i.getTermNameFromASTNodeReference(R[T])}if(w!==""){n=n+" "+w}else{var C=R[T].split("(");if(t.includes(g,C[0])&&c<h){R[T]=R[T].replace(s.JSON[c].dataObject,i.getTermNameFromASTNodeReference(s.JSON[c].dataObject));c++}n=n+" "+R[T]}}if(n!=""){s=n}}if(!u[e.getPath()]){u[e.getPath()]={headerValue:""}}this._internalModel.setProperty("/conditionCellAstValues",u);return s instanceof Object?s.shortRELString:s.trim()},_getMenuItems:function(){var e=[new R({text:this.oBundle.getText("insertFirst"),enabled:true,press:this._addNewRowWorkaround.bind(this,true)}),new R({text:this.oBundle.getText("insertAfter"),enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement},press:this._addNewRowWorkaround.bind(this,false)})];return e},_getModel:function(){var e=this.getModelName();if(e){return this.getModel(e)}return this.getModel()},_getOutputColumnDescription:function(e,t){var a;if(this.getExpressionLanguage()){a=W.getElementById(this.getExpressionLanguage());if(a&&a._isDataExist()){var i=this.getBindingContext().getProperty("ResultDataObjectId");var s=a.getResultColumnDescription(e,i,t);return s}}return t?t:e},_getPasteMenuItems:function(){var e=[new R({text:this.oBundle.getText("pasteRowAction"),enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement},press:this._rowAction.bind(this,"paste")}),new R({text:this.oBundle.getText("insertBeforeRowAction"),enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement},press:this._rowAction.bind(this,"insertBefore")}),new R({text:this.oBundle.getText("insertAfterRowAction"),enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement},press:this._rowAction.bind(this,"insertAfter")})];return e},_getRuleData:function(){var e=this.getBindingContextPath();var t=this._getModel();var a=jQuery.extend({},true,t.getProperty(e,null,true));var i=a.DecisionTable;i.DecisionTableColumns=this.dataBucket.columns;i.DecisionTableRows=this.dataBucket.rows;return a},_handleColumnsDataReceived:function(e){var t=e.getParameter("data");if(!t){return}var a=this.getAggregation("_table");if(t.results&&t.results.length>0){this._internalModel.setProperty("/newTable",false);a.setNoData(null);this._setExpressionLanguageVersionOnoData(false)}else{this._internalModel.setProperty("/newTable",true);var i=this._getBlankContent();a.setNoData(i);this._setExpressionLanguageVersionOnoData(true)}this.dataBucket[X.columns]=t;this._dataPartReceived(X.columns);this._handleHeaderSpan()},_handleColumnsDataRequested:function(e){this._dataPartRequested(X.columns)},_handleRowsDataReceived:function(e){var t=e.getParameter("data");if(t){if(this.dataBucket.collectRowsMode==="replace"){this.dataBucket[X.rows]=t;this.dataBucket.collectRowsMode="append"}else{var a=this.dataBucket[X.rows];var i={results:a.results?a.results.concat(t.results):t.results};this.dataBucket[X.rows]=i}this._dataPartReceived(X.rows)}this._setTableRows()},_handleRowsDataRequested:function(e){this._dataPartRequested(X.rows)},_handleRuleDataReceived:function(e){if(e){this._dataPartReceived(X.rule)}},_handleRuleDataRequested:function(){this._dataPartRequested(X.rule)},_handleVocabularyDataChanged:function(e){var t=e.getParameter("data");if(t){this._handleVocabularyDataReceived(t)}else{this._handleVocabularyDataRequested()}},_handleVocabularyDataReceived:function(e){if(e){this._dataPartReceived(X.vocabulary)}},_handleVocabularyDataRequested:function(){this._dataPartRequested(X.vocabulary)},_handleHeaderSpan:function(){if(!this.multiHeaderFlag){var e;this.multiHeaderFlag=true;var a=this.dataBucket.columns.results;this.iNumOfCondition=0;this.iNumOfResults=0;for(e=0;e<a.length;e++){if(a[e].Type===t.DecisionTableColumn.Condition){this.iNumOfCondition++}else if(a[e].Type===t.DecisionTableColumn.Result){this.iNumOfResults++}}var i=this.getAggregation("_table");a=i.getAggregation("columns");for(e=0;e<this.iNumOfCondition;e++){a[e].setHeaderSpan([this.iNumOfCondition,1])}for(;e<a.length;e++){a[e].setHeaderSpan([this.iNumOfResults,1])}}},_initDataBucket:function(){var e=false;var t;if(this.getAstExpressionLanguage()){t=W.getElementById(this.getAstExpressionLanguage())}else{t=W.getElementById(this.getExpressionLanguage())}if(t&&t._isDataExist()){e=true}this.dataBucket={dataReceived:{vocabulary:e,rule:false,rows:false,columns:false},rows:{},columns:{},collectRowsMode:"replace"}},_initDisplayModel:function(){this._displayModel=new I;this.setModel(this._displayModel,"displayModel");this._settingsModel=new I;this.setModel(this._settingsModel,"settingModel")},_initInternalModel:function(){var e={};e.editable=this.getEditable();e.newTable=true;e.sequenceExist=true;e.busyState=true;e.busyTableState=true;e.cellFormat=this.getCellFormat();e.hitPolicies=this.getHitPolicies();e.enableSettings=this.getEnableSettings();e.isAtLeastOneRowSelected=false;e.isExactlyOneRowSelected=false;e.isSelection=false;e.validationStatus={};e.valueState={};e.selectedRow=null;e.conditionCellAstValues=[];e.ruleBindingPath="";this._internalModel=new I(e);this.setModel(this._internalModel,"dtModel")},_isAllDataReceived:function(){var e=this.dataBucket.dataReceived;return e.rule&&e.rows&&e.columns&&e.vocabulary},_markSelection:function(e){var t=this.getLineActionBuffer().rowPath;var a=this.getAggregation("_table");var i=this._getModel();if(t){var s=a.getFirstVisibleRow();var n=i.getProperty(t).Sequence-1;if(n-s>-1&&n-s<a.getRowMode().getRowCount()){var r=a.getRows()[n-s];var o=r.getCells();if(o){for(var l=0;l<o.length;l++){if(e){o[l].addStyleClass("sapRULDecisionTableSCellMarked")}else{o[l].removeStyleClass("sapRULDecisionTableSCellMarked")}}}}}},_openTableSettings:function(){this.dataBucket.dataReceived.rows=false;var e=this._createDecisionTableSettings();var t=new u({contentWidth:"70%",contentHeight:"490px",title:this.oBundle.getText("tableSettings")});t.addContent(e);var a=e.getButtons(t);for(var i=0;i<a.length;i++){t.addButton(a[i])}t.attachBeforeClose(function(e){var a=t.getState();t.destroy();if(a===N.ValueState.Success){this._initDisplayModel();this._refreshBinding()}},this);this._closePopover();t.open()},_processValidationResults:function(e,t){if(e&&e.output){if(e.output.status==="Error"){var a=[];var i=this._internalModel.getProperty("/validationStatus");var s={};i=this._buildMessagesStructure(e,i,a);for(var n in i){if(i.hasOwnProperty(n)&&typeof i[n]==="string"&&i[n]!=="null"){s[n]=N.ValueState.Error}}this._displayErrorMessages(a,i);this._internalModel.setProperty("/validationStatus",i,null,true);this._internalModel.setProperty("/valueState",s,null,true)}var r=this._flatRule(e.output.decisionTableData);this._settingsModel.setData(e.output.decisionTableData);if(this.dataBucket.rows.results){this._settingsModel.rowLength=this.dataBucket.rows.results.length}this._displayModel.setData(r,true)}},_rowAction:function(e){this._rowActionWorkAround(e)},_rowActionWorkAround:function(e){var t=this._internalModel.getProperty("/selectedRow");this._markSelection(false);var a=this.getLineActionBuffer();this.setLineActionBuffer({rowPath:null,operation:null});var i=this.getAggregation("_table");var s=t+1;if(e==="insertAfter"){s++}var n=this._getModel();var r=n.getProperty(a.rowPath).Id;var o=n.getProperty(a.rowPath).RuleId;var l=n.getProperty(a.rowPath).Version;this._internalModel.setProperty("/busyState",true);var d=a.operation==="cut";if(e==="paste"){this._callCopyRuleRow(o,l,r,s,d,true)}else{this._callCopyRuleRow(o,l,r,s,d,false)}i.setSelectedIndex(-1);if(e==="insertBefore"||e==="insertAfter"){A.show(this.oBundle.getText("addRowSuccess"))}if(e==="paste"){A.show(this.oBundle.getText("pasteSuccess"))}},_refreshBinding:function(){var e=this.getAggregation("_table");var t=this.getElementBinding();if(t){t.refresh()}var a=e.getBinding("columns");if(a){a.refresh()}var i=e.getBinding("rows");if(i){i.refresh()}var s=V.getInstance();s.publish("sap.ui.rules","refreshDTRuleModel")},_rowSelectionChange:function(){var e=this.getAggregation("_table");var t=[];if(e){t=e.getSelectedIndices()}if(t.length>0){this._internalModel.setProperty("/isAtLeastOneRowSelected",true);this._internalModel.setProperty("/selectedRow",t[0])}else{this._internalModel.setProperty("/isAtLeastOneRowSelected",false)}if(t.length==1){this._internalModel.setProperty("/isExactlyOneRowSelected",true)}else{this._internalModel.setProperty("/isExactlyOneRowSelected",false)}if(this.getLineActionBuffer().rowPath){this._internalModel.setProperty("/isSelection",true)}else{this._internalModel.setProperty("/isSelection",false)}},_setDataLoadedPromise:function(){if(!this._dataLoaded||this._dataLoaded.state()!=="pending"){this._dataLoaded=new jQuery.Deferred}},_setExpressionLanguageVersionOnoData:function(e){var t=this._getModel();var a=this.getBindingContext();var i="1.0.0";if(e){var s;if(this.getAstExpressionLanguage()){s=W.getElementById(this.getAstExpressionLanguage());i="2.0.0"}else{s=W.getElementById(this.getExpressionLanguage());i=s.getExpressionLanguageVersion()}t.setProperty("ExpressionLanguageVersion",i,a,true)}else{i=t.getProperty(this.getBindingContextPath()+"/ExpressionLanguageVersion");if(!i){i="1.0.0"}}this._decisionTableCellFormatter.setExpressionLanguageVersion(i)},_setTableRows:function(){var e=this.getAggregation("_table");var t=e.getBinding("rows");var a=Q;if(t&&t.getLength()){a=Math.min(t.getLength(),this.VISIBLEROWCOUNT)}var i=e.getRowMode().getRowCount();if(i!==a){e.getRowMode().setRowCount(a)}if(this.dataBucket&&this.dataBucket.rows&&this.dataBucket.rows.results.length===0||!this.getEditable()){e.setSelectionMode(F.SelectionMode.None)}else{e.setSelectionMode(F.SelectionMode.MultiToggle)}},_unbindColumns:function(){var e=this.getAggregation("_table");e.unbindColumns()},_unbindRows:function(){var e=this.getAggregation("_table");e.unbindRows()},_unbindRule:function(){this.unbindElement()},_updateBusyState:function(){var e=this.dataBucket.dataReceived;var t=e.rule&&e.columns&&e.vocabulary;var a=!t;this._internalModel.setProperty("/busyState",a);var i=!e.rows;this._internalModel.setProperty("/busyTableState",i)},_updateTableCell:function(e,t){e.removeStyleClass("sapRULDecisionTableSCellMarked");var a="null";var i=this;var s=this.getParent();if(t){var n=e.data("colId");var r=t.getProperty("Id");var o=t.getProperty("RuleId");var l=t.getProperty("Version");var d=t.getModel();var u="";var c="";var h={RuleId:o,ColId:n,RowId:r,Version:l};var g=d.createKey("/DecisionTableRowCells",h);var p=new J(d,g);var f={RuleId:o,Id:n,Version:l};var b=d.createKey("/DecisionTableColumnConditions",f);var v=s.getModel("dtModel").getData().conditionCellAstValues;var _={RuleId:o,Id:n,Version:l};var m={Id:o,Version:l};a=g+"/Content";switch(e.data("colType")){case"CONDITION":u="/"+d.createKey("DecisionTableColumnConditions",_);c="/"+d.createKey("Rules",m);e.setHeaderValuePath(u+"/Expression");e.setFixedOperatorPath(u+"/FixedOperator");e.setRuleFormatPath(c+"/RuleFormat");e.setDecisionTableFormat(i.getParent().getDecisionTableFormat());e.setValueOnlyPath(u+"/ValueOnly");if(v[b]){e.setHeaderInfo(v[b])}break;case"RESULT":u="/"+d.createKey("DecisionTableColumnResults",_);c="/"+d.createKey("Rules",m);e.setTypePath(u+"/BusinessDataType");if(W.getElementById(s.getAstExpressionLanguage())){var y=s.getModel("settingModel").getData().ResultDataObjectId;var R=d.getProperty(u+"/DataObjectAttributeId");e.setAttributeInfoPath("/"+y+"/"+i.getParent()._formatAttributeId(R))}else{e.setAttributeInfoPath(u+"/DataObjectAttributeId")}e.setAttributeNamePath(u+"/DataObjectAttributeName");e.setRuleFormatPath(c+"/RuleFormat");e.setDecisionTableFormat(i.getParent().getDecisionTableFormat());break;default:break}e.setKeyProperties(h);e.setValueStateTextPath("dtModel>/validationStatus/"+"RowId="+r+",ColId="+n);e.setValueStatePath("dtModel>/valueState/"+"RowId="+r+",ColId="+n)}e.setValuePath(a)},_formatAttributeId:function(e){var t=e;if(t&&t.indexOf(":")>-1){t=t.replace(/:/g,"/")}return t},exit:function(){var e=this.oMenu;if(e){e.destroy()}},init:function(){this.multiHeaderFlag=false;this.resetContent=true;this.astUtil=new E;this._initInternalModel();this._initDisplayModel();this._initDataBucket();this.bindProperty("busy","dtModel>/busyState");this.oBundle=j.getResourceBundleFor("sap.rules.ui.i18n");this._addToolBar();this._addTable();this._addErrorLabel();this._decisionTableCellFormatter=new S;this.setBusyIndicatorDelay(0)},isSequenceExistsInOdataMetadata:function(){var e=this.getModel();if(e){var t=e.getServiceMetadata();if(t){var a=t.dataServices.schema[0].entityType;var i;var s;var n;for(var r=0;r<a.length;r++){i=a[r];if(i.name!=="DecisionTableColumn"){continue}s=i.property;for(var o=0;o<s.length;o++){n=s[o];if(n.name==="Sequence"){return true}}}}}return false},onBeforeRendering:function(){if(this.resetContent){this.resetControl();this.resetContent=false}},resetControl:function(){this._unbindRule();this._unbindRows();this._unbindColumns();this._clearErrorMessages();this._initDataBucket();this._initDisplayModel();this._updateBusyState();var e=this._getModel();var t=this.getBindingContextPath();if(!t||!e){return}var a=new J(e,t);this._internalModel.setProperty("/ruleBindingPath",t);this.setBindingContext(a);this._bindRule();this._bindRows();this._bindColumns()},setAstExpressionLanguage:function(e){this.setAssociation("astExpressionLanguage",e,true);var t=e instanceof Object?e:W.getElementById(e);if(!t){return this}var a=this.getAggregation("_table");if(a){var i=a.getBinding("columns");if(i){i.refresh()}}if(t._isDataExist()){var s=new k("","",{data:true});this._handleVocabularyDataChanged(s)}t.attachDataChange(this._handleVocabularyDataChanged.bind(this));return this},setBindingContextPath:function(e){var t=this.getBindingContextPath();if(e&&t!==e){this._unbindRule();this._unbindRows();this._unbindColumns();this.setProperty("bindingContextPath",e);this.resetContent=true;this._initDataBucket();var a=this.getModel();if(!a.isMetadataLoadingFailed()){if(a.getServiceMetadata()){this._internalModel.setProperty("/sequenceExist",this.isSequenceExistsInOdataMetadata())}else{a.attachMetadataLoaded(function(){this._internalModel.setProperty("/sequenceExist",this.isSequenceExistsInOdataMetadata())}.bind(this))}}}return this},setCellFormat:function(e){this.setProperty("cellFormat",e,true);this._internalModel.setProperty("/cellFormat",e);return this},setEditable:function(e){this.setProperty("editable",e,true);this._internalModel.setProperty("/editable",e);this._internalModel.setProperty("/sequenceExist",this.isSequenceExistsInOdataMetadata());var t=this.getAggregation("_table");var a=this.getAggregation("_toolbar");if(e===false){t.addStyleClass("sapRULDecisionTableEdit");a.removeStyleClass("sapRULDecisionTableToolBar")}else{t.removeStyleClass("sapRULDecisionTableEdit");a.addStyleClass("sapRULDecisionTableToolBar")}if(e===false){this._clearErrorMessages()}return this},setEnableSettings:function(e){this.setProperty("enableSettings",e,true);this._internalModel.setProperty("/enableSettings",e);return this},setEnableSettingResult:function(e){this.setProperty("enableSettingResult",e,true);return this},setExpressionLanguage:function(e){this.setAssociation("expressionLanguage",e,true);this._decisionTableCellFormatter.setExpressionLanguage(this.getExpressionLanguage());var t=e instanceof Object?e:W.getElementById(e);if(!t){return this}var a=this.getAggregation("_table");if(a){var i=a.getBinding("columns");if(i){i.refresh()}}if(t._isDataExist()){var s=new k("","",{data:true});this._handleVocabularyDataChanged(s)}t.attachDataChange(this._handleVocabularyDataChanged.bind(this));return this},setHitPolicies:function(e){this.setProperty("hitPolicies",e,true);this._internalModel.setProperty("/hitPolicies",e);return this},setModelName:function(e){this.setProperty("modelName",e);this.resetContent=true;return this},renderer:Y});Z.prototype._saveWorkAround=function(e,t){var a=this._getModel();a.submitChanges(e);A.show(t)};Z.prototype.includes=function(e,t){var a=false;if(e.indexOf(t)!==-1){a=true}return a};Z.prototype._getLocaleData=function(){var e=H.getLanguageTag();return P.getInstance(e)};Z.prototype._getDateFormatter=function(){var e=this._getLocaleData();var t=e.getDatePattern("medium");var a=U.getDateInstance({pattern:t});return a};Z.prototype._getDateTimeFormatter=function(){var e=this._getLocaleData();var t=e.getDatePattern("medium");var a=e.getTimePattern("medium");var i=U.getDateTimeInstance({pattern:t+" "+a});return i};Z.prototype.VISIBLEROWCOUNT=30;Z.prototype.THRESHOLD=30;return Z},true);
//# sourceMappingURL=DecisionTable.js.map