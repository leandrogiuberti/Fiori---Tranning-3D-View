/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["./library","./ExpressionAdvancedRenderer","sap/base/Log","sap/m/Dialog","sap/ui/core/Control","sap/m/Button","sap/m/TextArea","sap/m/Text","sap/m/MessageBox","sap/ui/layout/HorizontalLayout","sap/rules/ui/Utils","sap/ui/core/Popup","sap/ui/thirdparty/jquery","sap/rules/ui/ExpressionBase","sap/ui/comp/odata/MetadataAnalyser","sap/rules/ui/providers/ValueHelpProvider","sap/ui/core/LocaleData","sap/rules/ui/Constants","sap/base/i18n/Formatting","sap/base/i18n/date/CalendarType","sap/ui/core/format/DateFormat","sap/ui/core/library","sap/ui/model/json/JSONModel","sap/ui/unified/Calendar","sap/ui/model/odata/v2/ODataModel","sap/ui/comp/valuehelpdialog/ValueHelpDialog","sap/ui/comp/smartfilterbar/SmartFilterBar","sap/ui/comp/smartfilterbar/ControlConfiguration","sap/ui/table/Column","sap/m/Label","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Lib","sap/ui/core/BusyIndicator","sap/ui/core/Element","sap/rules/ui/codemirror/lib/codemirror"],function(e,t,r,a,i,o,s,n,l,p,u,d,h,c,f,g,v,y,m,M,E,_,C,V,x,b,T,F,S,I,B,D,w,P,L){"use strict";var A=c.extend("sap.rules.ui.ExpressionAdvanced",{metadata:{properties:{type:{type:"sap.rules.ui.ExpressionType",defaultValue:e.ExpressionType.All,bindable:"bindable"},collection:{type:"boolean",defaultValue:false},placeholder:{type:"string",defaultValue:null},focusOnLoad:{type:"boolean",defaultValue:false},attributeInfo:{type:"string",defaultValue:"",bindable:"bindable"}},aggregations:{_expressionArea:{type:"sap.m.TextArea",multiple:false,visibility:"hidden"}},events:{change:{},liveChange:{},valueHelpRequest:{parameters:{fromSuggestions:{type:"boolean"}}}},publicMethosds:["validate"]},renderer:t});A.prototype.init=function(){c.prototype.init.apply(this,arguments);var e=sap.ui.require.toUrl("sap/rules/ui/codemirror/lib")+"/codemirror.css";var t=sap.ui.require.toUrl("sap/rules/ui/codemirror/addon/hint")+"/show-hint.css";sap.ui.require(["sap/ui/dom/includeStylesheet"],r=>{r(e);r(t)});this.pop=new d(h("<span></span>")[0],false,false,false);this.errorWidgets=[];this.expressionTokens=[];this._liveValue="";this.oBundle=w.getResourceBundleFor("sap.rules.ui.i18n");this.dataModel=this.initControlDataModel();this.oTextArea=new s({width:"100%"});this.validationCompleteEvent=document.createEvent("Event");this.validationCompleteEvent.initEvent("validationCompleteEvent",true,false);this.setAggregation("_expressionArea",this.oTextArea,true);this.bFlagForEventListener=true;var r=m.getLanguageTag();var a=v.getInstance(r);this.oFormatDate=E.getInstance({pattern:a.getDatePattern("short"),calendarType:M.Gregorian},r);this._dateBusinessDataType="Date";this._valueHelpSelectionText="Select from value help...";this._hasValueSource="HasValueSource";this._propertyValue="Value";this._propertyDescription="Description"};A.prototype._processValidationResult=function(t){if(t.status===e.ValidationStatus.Error){var r=u.parseUTFToString(t.errorDetails);r=r.replace(/\r\n/g," ").replace(/\r/g," ").replace(/\n/g," ");this.errorCursorPosition=t.cursorPosition;this.setValueStateText(r)}else{this.oTextArea.setValueState("None");this.oTextArea.setValueStateText("");this.setValueStateText("");jQuery(this.codeMirror.getWrapperElement()).removeClass("sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError")}};A.prototype.validateExpression=function(e){for(var t=0;t<this.errorWidgets.length;t++){this.codeMirror.removeLineWidget(this.errorWidgets[t])}this.errorWidgets=[];var r=this.codeMirror?this.codeMirror.getValue():this.getValue();var a={};var i={};var o=L.getElementById(this.getExpressionLanguage());if(o){i=o.validateExpression(e||r,this.getProperty("type"),this.getCollection(),false);if(i&&this.isActive()){a=i;this._processValidationResult(a);if(a.deferredResult){a.deferredResult.done(function(e){this._processValidationResult(e);document.dispatchEvent(this.validationCompleteEvent)}.bind(this))}}}return i};A.prototype._showPopUp=function(){var e="Error";var t=this.getProperty("valueStateText");var r=this.getId()+"-message";var a=this.pop;if(!this.pop){return}a.attachClosed(function(){jQuery(document.getElementById(r)).remove()});var i=d.Dock;var o="sapMInputBaseMessage"+e+" sapMFocus";var s="sapMValueStateMessageError sapMText";var n=w.getResourceBundleFor("sap.m");if(e===_.ValueState.Success){o="sapUiInvisibleText";t=""}var l=h("<div>",{id:r,class:o,role:"tooltip","aria-live":"assertive"}).append(h("<span>",{"aria-hidden":true,class:"sapUiHidden",text:n.getText("INPUTBASE_VALUE_STATE_"+e.toUpperCase())})).append(h("<span>",{id:r+"-text",class:s,text:t}));a.setContent(l[0]);a.close(0);a.open(0,i.BeginTop,i.BeginBottom,jQuery(this.codeMirror.getWrapperElement()),null,"none flip",true);var p=this.pop.oContent.clientWidth;var u=document.getElementById(this.getAggregation("_expressionArea"));if(!u){return}var c=u.sId.clientWidth;if(p>c){jQuery(".sapMText").css("width",c);jQuery(".sapMText").css("padding-left","12px");jQuery(".sapMText").css("padding-right","12px");jQuery(".sapMText").css("padding-top","8px");jQuery(".sapMText").css("padding-bottom","8px")}};A.prototype._closePopUp=function(){if(this.pop){this.pop.close(0)}};A.prototype._showErrorMessage=function(){var e=this.getValueStateText();if(e&&e!==""){this._setExpressionErrorStyle()}};A.prototype.initControlDataModel=function(){var e=new C;var t={};e.setData(t);return e};A.prototype.setExpressionTokens=function(e){var t=0,r=false;this.expressionTokens=[];if(e instanceof Array){for(var a=0;a<e.length;a++){var i=e[a];var o=/\n/;if(o.test(i.token)){t=i.start+i.token.lastIndexOf("\n")+1;r=true;continue}if(r){i.start=i.start-t;i.end=i.end-t+1}else{i.end=i.end+1}this.expressionTokens.push(i)}}};A.prototype.getExpressionTokens=function(){return this.expressionTokens};A.prototype.getValue=function(){if(this.codeMirror!==undefined){return this.codeMirror.getValue()}return this.getProperty("value")};A.prototype.setValue=function(e){if(e===undefined||e===null){e=""}this._liveValue=e;this.oTextArea.setValue(e);if(this.getProperty("value")===e){return}this.setProperty("value",e,true);if(this.codeMirror!==undefined){this.codeMirror.setValue(e)}};A.prototype.setPlaceholder=function(e){this.setProperty("placeholder",e);var t=this.getEditable()?e:"";this.dataModel.setProperty("/placeholder",t)};A.prototype.getPlaceholder=function(){return this.dataModel.getProperty("/placeholder")};A.prototype.setValueStateText=function(e){this.setProperty("valueStateText",e,true);if(e){this._showErrorMessage(e)}else{jQuery(this.codeMirror.getWrapperElement()).removeClass("CodeMirror-error");jQuery(this.codeMirror.getWrapperElement()).removeClass("sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError")}};A.prototype.setEditable=function(e){this.setProperty("editable",e);this.getAggregation("_expressionArea").setProperty("editable",e);if(this.codeMirror){jQuery(this.codeMirror.getWrapperElement()).addClass("CodeMirror-rules-Not-Editable")}var t=e?this.getProperty("placeholder"):"";this.dataModel.setProperty("/placeholder",t);this.invalidate()};A.prototype.setType=function(e){if(e===y.DATE_BUSINESS_TYPE||e===y.TIMESTAMP_BUSINESS_TYPE||e===y.NUMBER||e===y.STRING||e===y.BOOLEAN_BUSINESS_TYPE||e===y.BOOLEAN_ENHANCED_BUSINESS_TYPE){this.setProperty("type",e)}if(this.codeMirror){this.codeMirror.options.returnType=e}};A.prototype.setCollection=function(e){this.setProperty("collection",e,true);if(this.codeMirror){this.codeMirror.options.collection=e}};A.prototype.validate=function(){return this.validateExpression()};A.prototype.setFocusOnLoad=function(e){this.dataModel.setProperty("/focus",e);this.setProperty("focusOnLoad",e,true)};A.prototype.focus=function(){if(this.codeMirror){var e=this.codeMirror.getLine(this.codeMirror.lastLine());var t=e.length;this.codeMirror.setCursor({line:this.codeMirror.lastLine(),ch:t});this.codeMirror.focus()}};A.prototype.onAliasLinkPress=function(e){var t=L.getElementById(this.getExpressionLanguage());if(t){t.onAliasLinkPress(e);t.attachEvent("aliasDialogClosed",this.aliasClickCancel,this)}};A.prototype.onCreateAliasLinkForText=function(e){var t=L.getElementById(this.getExpressionLanguage());if(t){t.attachEvent("aliasDialogClosed",this.replaceTextWithAlias,this);t.onCreateAliasLinkForText(e)}};A.prototype.replaceTextWithAlias=function(e){if(e.getParameter("isSave")){this.codeMirror.replaceSelection(e.getParameter("savedAliasName"))}};A.prototype.aliasClickCancel=function(e){this.codeMirror.focus();this.codeMirror.execCommand("goLineEnd");this.fireDialog({dialogStatus:library.ValueListDialogMode.Close})};A.prototype.onAfterRendering=function(){sap.ui.require(["sap/rules/ui/codemirror/addon/hint/show-hint","sap/rules/ui/codemirror/mode/hdf/hdf","sap/rules/ui/codemirror/addon/display/placeholder","sap/rules/ui/codemirror/addon/mh/mark-selection","sap/rules/ui/codemirror/addon/hint/hdf-hint","sap/rules/ui/codemirror/addon/closeBrackets/closebrackets"],()=>{this.timer=null;this.needAutoComplete=false;this.endCompletion=false;this._setCodeMirror();this._setEditorStyle();this._handleMousedown();this._handleChange();this._handleFocusLeave();this._handleEndCodeCompletion();this._handleKeyPress();this._handleEditableProperty();this._handleOnLoadValidation();this._refreshOnNavigationEnd();this._handleFocus();this._handleValueListSelect();this._handleCalendarChange();if(this.bFlagForEventListener){this.bFlagForEventListener=false;this.fnMouseDownListsner=function(e){this.bFlagForChangeBeforeBlur=e.target.className.indexOf("CodeMirror-hint")>-1}.bind(this);this.fnBlurListsner=function(e){if(this.bFlagForChangeBeforeBlur){this.bFlagForChangeBeforeBlur=false;e.stopPropagation();this.codeMirror.focus()}}.bind(this);document.addEventListener("mousedown",this.fnMouseDownListsner,true);document.getElementById(this.getId()).addEventListener("blur",this.fnBlurListsner,true)}})};A.prototype._handleCalendarChange=function(){var e=this;this.codeMirror.on("onChangeDate",function(){e._createCalendarDialog(e.codeMirror.getCursor())}.bind(this))};A.prototype._createCalendarDialog=function(e){var t=false;var r=this;var i=new V({width:"100%",select:this.handleCalendarSelect.bind(this)});this._oSelectNewDateDialog=new a({title:this.oBundle.getText("calendarTitle"),content:[i],beginButton:new o({text:this.oBundle.getText("okBtn"),enabled:false,press:function(){var a=this.updateText(i);r._updateModal(false);r.setTextOnCursor(a,e,false,this._dateBusinessDataType,t,false);r._oSelectNewDateDialog.close();r.focus(r.codeMirror)}.bind(this)}),endButton:new o({text:this.oBundle.getText("clsBtn"),press:function(){r._updateModal(false);r._oSelectNewDateDialog.close();r.focus(r.codeMirror)}.bind(this)})});this._oSelectNewDateDialog.open()};A.prototype._updateModal=function(e){var t=L.getElementById("popover");if(t){t.setModal(e)}};A.prototype.handleCalendarSelect=function(e){var t=e.getSource(),r=t.getSelectedDates()[0].getStartDate();if(r){this._oSelectNewDateDialog.getBeginButton().setEnabled(true)}};A.prototype.updateText=function(e){var t=e.getSelectedDates();var r;if(t.length>0){r=t[0].getStartDate();return this.oFormatDate.format(r)}};A.prototype._raiseError=function(e){r.error(e);var t=w.getResourceBundleFor("sap.rules.ui.i18n");this.setValueStateText(t.getText("valueHelpTechnicalError"));this._showPopUp()};A.prototype._handleValueListSelect=function(){this.codeMirror.on("onValueListSelect",function(){var e=this.codeMirror.currentHintData.data.listCompletion;var t=[];for(var r=0;r<e.length;r++){if(e[r].text===this._valueHelpSelectionText){t=e[r].info}}var a=L.getElementById(this.getExpressionLanguage());t.expressionLanguage=a;var i=a.getValueHelpCallback();this.oTextArea.setValueState("None");this.oTextArea.setValueStateText("");this.setValueStateText("");jQuery(this.codeMirror.getWrapperElement()).removeClass("sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError");if(typeof i!=="function"&&t.metadata.hasOwnProperty(this._hasValueSource)&&t.metadata.HasValueSource===true){this._createCpValueHelp(t,this.codeMirror.getCursor(),false)}else{if(typeof i!=="function"){this._raiseError("value help callback is not set or is not a function")}else{i.call(this,t);var o=t[0].model;if(!(o instanceof x)){this._raiseError("value help model is not an oData V2 model")}else if(o.isMetadataLoadingFailed()){this._raiseError("model metadata loading has failed in the past")}else if(!o.getMetaModel().oModel){o.attachMetadataLoaded(function(){this._createValueHelpProvider(t[0])}.bind(this));o.attachMetadataFailed(function(){this._raiseError("attached model metadata failed")}.bind(this))}else{this._createValueHelpProvider(t[0])}}}}.bind(this))};A.prototype._createValueHelpProvider=function(e,t){var r=e.model;this.oMetadataAnalyzer=new f(r);var a=e.metadata.propertyPath;var i=this.oMetadataAnalyzer.getValueListAnnotation(a);if(!i.primaryValueListAnnotation){this._raiseError("proprety path is wrong");return}var o=this.getExpressionTokens();var s=false;if(o.length>0){s=o[o.length-1].tokenType!=="whitespace"}if(this.oValueHelpDialogProvider){this.oValueHelpDialogProvider.destroy()}this.oValueHelpDialogProvider=new g({annotation:i.primaryValueListAnnotation,additionalAnnotations:i.additionalAnnotations,control:this,model:r,preventInitialDataFetchInValueHelpDialog:false,supportMultiSelect:false,supportRanges:false,takeOverInputValue:false,fieldName:i.primaryValueListAnnotation.valueListTitle,title:i.primaryValueListAnnotation.valueListTitle,cursorPosition:this.codeMirror.getCursor(),bReplaceWord:t,businessDataType:e.metadata.businessDataType,bAddSpace:s});this.fireValueHelpRequest({fromSuggestions:false})};A.prototype._createCpValueHelp=function(e,t,r,a){var i=e.metadata.businessDataType;var o=this.getExpressionTokens();var s=false;var n=L.getElementById("popover");if(n){n.setModal(true)}if(o.length>0){s=o[o.length-1].tokenType!=="whitespace"}if(this.oDialog){this.oDialog.destroy()}var l=L.getElementById(this.getExpressionLanguage()).getModel().sServiceUrl;this._createDialog(l,e,t,i,s,r,a)};A.prototype._createDialog=function(e,t,r,a,i,o,s){this._createValueHelpDialog(e,t,r,a,i,o,s);this.oValueHelpDialog.getTableAsync().then(function(r){this.oValueHelpDialogTable=r;this._createSmartFilterBar(e,t);this.oValueHelpDialog.setFilterBar(this.oFilterBar);this.oValueHelpDialog.open();this.oValueHelpDialogTable.setBusy(true)}.bind(this))};A.prototype._createValueHelpDialog=function(e,t,r,a,i,o,s){var n=this;var l=t.expressionLanguage.getModel();var p="Attributes(Id='"+t.metadata.attributeId+"',VocabularyId='"+t.metadata.vocabularyId+"',DataObjectId='"+t.metadata.dataObjectId+"')";if(p.includes(":")){p=p=p.replace(":","%3A")}this.attributeName=l.oData[p].Name;P.show(0);this.oValueHelpDialog=new b({supportMultiselect:false,supportRanges:false,horizontalScrolling:false,title:n.attributeName,resizable:false,beforeOpen:function(){n._bindTable(e,t)},ok:function(e){var t=e.getParameter("tokens")[0].data("row");var l=t.Value;if(a===n._dateBusinessDataType){l=n._formatDate(l)}n.setTextOnCursor(l,r,o,a,i,s);n._updateModal(false);n.oValueHelpDialog.close();n.focus(n.codeMirror)},cancel:function(){n._updateModal(false);n.oValueHelpDialog.close();n.focus(n.codeMirror)},afterClose:function(){n._updateModal(false);n.oValueHelpDialog.destroy();n.focus(n.codeMirror);n.oFilterBar.destroy();P.hide()}})};A.prototype._formatDate=function(e){return this.oFormatDate.format(this.oFormatDate.parse(e))};A.prototype._createSmartFilterBar=function(e,t){var r=this;this.oFilterBar=new T({entitySet:t.metadata.entitySet,enableBasicSearch:true,advancedMode:true,filterBarExpanded:true,search:function(){r.onSearch(e,t)},filterChange:function(e){r.setValueStateFilter(e)},controlConfiguration:[r._createControlConfiguration()]});var a=new x(e);this.oFilterBar.setModel(a)};A.prototype._createControlConfiguration=function(){var e=[new F({hasValueHelpDialog:true,key:"Value",label:"Value",visibleInAdvancedArea:true,width:"100px",index:1}),new F({hasValueHelpDialog:true,key:"Description",label:"Description",visibleInAdvancedArea:true,width:"100px",index:2}),new F({hasValueHelpDialog:true,key:"VocabularyId",label:"VocabularyId",width:"100px",visible:false,index:3}),new F({hasValueHelpDialog:true,key:"DataObjectId",label:"DataObjectId",visible:false,width:"100px",groupId:"abc",index:4}),new F({hasValueHelpDialog:true,key:"AttributeId",label:"AttributeId",visible:false,width:"100px",index:5}),new F({hasValueHelpDialog:true,key:"Version",label:"Version",visible:false,width:"100px",index:6})];return e};A.prototype.onSearch=function(e,t){this.oValueHelpDialogTable.setBusy(true);this._unBindTable();this._bindTable(e,t)};A.prototype._bindTable=function(e,t){var r=t.metadata.serviceURL;var a=this._fetchFilterParams(t);var i={valueHelp:{collection:r,properties:[this._propertyValue,this._propertyDescription]}};var o=this.oValueHelpDialogTable;o.setThreshold(10);for(var s=0;s<i.valueHelp.properties.length;s++){this._addValueHelpColumn(i.valueHelp.properties[s],o)}var n=new x(e);o.setModel(n);o.bindRows(i.valueHelp.collection,null,a);o.getBinding("rows").attachDataReceived(this._handleRowsDataReceived,this)};A.prototype._handleRowsDataReceived=function(e){var t=this;var r=e.getParameter("data");if(jQuery.isEmptyObject(r)||r&&r.results&&r.results.length===0){this.oValueHelpDialogTable.setNoData(t.oBundle.getText("no_data"))}else{this.oValueHelpDialogTable.setNoData(t.oBundle.getText("searching"))}this.oValueHelpDialogTable.setBusy(false)};A.prototype._addValueHelpColumn=function(e,t){var r=(new S).setLabel(new I({text:e}));if(e===this._propertyValue){r.setSortProperty(e)}t.addColumn(r.setTemplate((new n).bindProperty("text",e)))};A.prototype._unBindTable=function(){var e=this.oValueHelpDialogTable;e.destroyColumns();e.unbindRows()};A.prototype._fetchFilterParams=function(e){var t=this;var r=[];var a=[new B("AttributeId",D.EQ,e.metadata.attributeId),new B("DataObjectId",D.EQ,e.metadata.dataObjectId),new B("VocabularyId",D.EQ,e.metadata.vocabularyId)];var i=this.oFilterBar.getFilters();var o=this.oFilterBar.getParameters();if(!jQuery.isEmptyObject(o)&&i&&i.length>0){o=this.oFilterBar.getParameters().custom.search;r=this._getSearchFilters(o);i=t._formatFilterParams(i);a.push(new B({filters:[new B(i),new B(r)],and:true}))}else if(!jQuery.isEmptyObject(o)){o=this.oFilterBar.getParameters().custom.search;r=this._getSearchFilters(o);a.push(r)}else if(i&&i.length>0){i=t._formatFilterParams(i);a.push(i[0])}return a};A.prototype._formatFilterParams=function(e){var t=this;if(e[0]&&e.length===1&&e[0].aFilters[0]&&e[0].aFilters[0].sOperator){e=t._formatSingleFilter(e)}else if(e[0]&&e[0].aFilters[0]&&e[0].aFilters[0].aFilters[0]&&e[0].aFilters[0].aFilters[0].aFilters&&e[0].aFilters[1].aFilters[0].aFilters){e=t._formatMultiFilter(e,0,true);e=t._formatMultiFilter(e,1,true)}else if(e[0]&&e[0].aFilters[0]&&e[0].aFilters[1]&&e[0].aFilters[0].aFilters[0]&&e[0].aFilters[0].aFilters[0].aFilters&&e[0].aFilters[1].aFilters){e=t._formatMultiFilter(e,0,true);e=t._formatMultiFilter(e,1,false)}else if(e[0]&&e[0].aFilters[0]&&e[0].aFilters[1]&&e[0].aFilters[1].aFilters[0]&&e[0].aFilters[0].aFilters&&e[0].aFilters[1].aFilters[0].aFilters){e=t._formatMultiFilter(e,0,false);e=t._formatMultiFilter(e,1,true)}else if(e[0]&&e[0].aFilters[0]&&e[0].aFilters[1]&&e[0].aFilters[0].aFilters&&e[0].aFilters[1].aFilters){e=t._formatMultiFilter(e,0,false);e=t._formatMultiFilter(e,1,false)}return e};A.prototype._formatSingleFilter=function(e){var t=this;var r=null;for(var a=0;a<e[0].aFilters.length;a++){if(e[0].aFilters[a].sOperator==="Contains"){e[0].aFilters[a].sOperator="EQ"}else if(e[0].aFilters[a].sOperator==="BT"){var i=t._manageParam(e[0].aFilters[a].sPath,e[0].aFilters[a].sOperator,e[0].aFilters[a].oValue1,e[0].aFilters[a].oValue2);delete e[0].aFilters[a];e[0].aFilters[a]=i}else if(e[0].aFilters[a].sOperator==="StartsWith"){r=e[0].aFilters[a].sPath===this._propertyValue?this._valueFieldValue:this._valueFieldDescription;r.setValueState("Error");r.setValueStateText(e[0].aFilters[a].sOperator+" operator not supported")}else if(e[0].aFilters[a].sOperator==="EndsWith"){r=e[0].aFilters[a].sPath===this._propertyValue?this._valueFieldValue:this._valueFieldDescription;r.setValueState("Error");r.setValueStateText(e[0].aFilters[a].sOperator+" operator not supported")}}return e};A.prototype._formatMultiFilter=function(e,t,r){var a=this;var i=null;var o=[];if(r){o=e[0].aFilters[t].aFilters[0].aFilters}else{o=e[0].aFilters[t].aFilters}for(var s=0;s<o.length;s++){if(o[s].sOperator==="Contains"){o[s].sOperator="EQ"}else if(o[s].sOperator==="BT"){var n=a._manageParam(o[s].sPath,o[s].sOperator,o[s].oValue1,o[s].oValue2);delete o[s];o[s]=n}else if(o[s].sOperator==="StartsWith"){i=o[s].sPath===this._propertyValue?this._valueFieldValue:this._valueFieldDescription;i.setValueState("Error");i.setValueStateText(o[s].sOperator+" operator not supported")}else if(o[s].sOperator==="EndsWith"){i=o[s].sPath===this._propertyValue?this._valueFieldValue:this._valueFieldDescription;i.setValueState("Error");i.setValueStateText(o[s].sOperator+" operator not supported")}}return e};A.prototype._manageParam=function(e,t,r,a){var i=[];if(r&&a){i=new B({filters:[new B(e,D.GT,r),new B(e,D.LT,a)],and:true})}return i};A.prototype._getSearchFilters=function(e){return new B({filters:[new B(this._propertyValue,D.EQ,e),new B(this._propertyDescription,D.EQ,e)],and:false})};A.prototype.setValueStateFilter=function(e){var t=e.getSource().sId;this._valueFieldValue=L.getElementById(t+"-filterItemControlA_-Value");if(this._valueFieldValue){this._valueFieldValue.setValueState("None");this._valueFieldValue.setValueStateText("")}this._valueFieldDescription=L.getElementById(t+"-filterItemControlA_-Description");if(this._valueFieldDescription){this._valueFieldDescription.setValueState("None");this._valueFieldDescription.setValueStateText("")}};A.prototype.onValueHelpLinkPress=function(e,t){if(!this.getEditable()){return}var r=L.getElementById(this.getExpressionLanguage());var a=r.getValueHelpCallback();var i=this.getExpressionTokens();var o;var s;var n=this.codeMirror.getCursor().line;var l;for(o=0;o<i.length;o++){if(i[o].tokenType==="valueList"&&i[o].info&&i[o].info.id===t&&i[o].token===e){s=[i[o].info];l=i[o].end;break}}var p={};p.ch=l;p.line=n;if(typeof a==="function"){a.call(this,s);var u=s[0].model;if(!u.getMetaModel().oModel){u.attachMetadataLoaded(function(){this._createValueHelpProvider(s[0],true)}.bind(this))}else{this._createValueHelpProvider(s[0],true)}}else if(s&&s[0].metadata.hasOwnProperty(this._hasValueSource)&&s[0].metadata.HasValueSource===true){s[0].expressionLanguage=r;this._createCpValueHelp(s[0],p,true,true)}};A.prototype._createSearchCursor=function(e){var t=this.codeMirror;t.getCursor().ch=t.getCursor().ch+e.length;var r=t.getSearchCursor(e,t.getCursor(),typeof e=="string"&&e==e.toLowerCase());return r};A.prototype.setTextOnCursor=function(e,t,r,a,i,o){function s(e,t){var r=e+1;for(var a=r;a<t.length;a++){if(t[a].length===0){r++}else{break}}return r}var n="String",l="Date",p="Timestamp",u="Time";var d;var h=a===n||a===l||a===p||a===u?"'"+e+"'":e;var c=this.getExpressionTokens();var f=this.getValue().split("\n");var g=-1;var v={start:{line:t.line,ch:t.ch},end:{line:t.line,ch:t.ch}};for(var y=0;y<c.length;y++){g=c[y].start===0?s(g,f):g;if(g===t.line&&c[y].end>t.ch||c[y].end>=t.ch&&o){v.start.ch=c[y].start;v.end.ch=c[y].end;r=true;break}}if(r){this.codeMirror.replaceRange(h,v.start,v.end);d=this.codeMirror.findPosH(v.start,h.length,"char",true);this.codeMirror.setCursor(d)}else{h=i?" "+h:h;this.codeMirror.replaceRange(h,t);d=this.codeMirror.findPosH(t,h.length,"char",true);this.codeMirror.setCursor(d)}var m=L.getElementById(this.getExpressionLanguage());this.getFormattingTokens(m);this.ValueHelpRequested=false};A.prototype._setCodeMirror=function(){var e=this.getEditable();var t;if("getAttributeInfo"in this&&this.getAttributeInfo()){t=this.getAttributeInfo()}var r=L.getElementById(this.getExpressionLanguage());var a;if(t){a=r.getValueListAttribute(t)}function i(e,t,r){var a=e.options.expressionEditor;if(a.getEditable()!==false&&L.getElementById(a.getExpressionLanguage())){window.clearTimeout(a.timer);a.timer=window.setTimeout(function(){e.execCommand(t)},r);return window.CodeMirror.Pass}return null}function o(e){var t=e.options.expressionEditor;if(t.getEditable()!==false){window.clearTimeout(t.timer);t.needAutoComplete=true;t.timer=window.setTimeout(function(){if(t.needAutoComplete&&L.getElementById(t.getExpressionLanguage())){e.execCommand("autocomplete")}},500);return window.CodeMirror.Pass}return null}function s(e){return i(e,"enterAutocomplete",500)}function n(e){return i(e,"colonAutocomplete",500)}function l(e){i(e,"autocomplete",0)}function p(e){return i(e,"autocomplete",500)}function d(e){var t=e.options.expressionEditor;var r=e.getRange({line:0,ch:0},e.getCursor());if(e.options.headerValue){var a=e.options.headerValue+" ";if(e.options.fixedOperator){a=a+e.options.fixedOperator+" "}r=a+r}var i=e.options.relDelegate.getSuggestions(r,e.options.returnType,e.options.collection);var o;if(i&&i.hasOwnProperty("suggs")&&i.suggs.length>0){o=i.suggs;for(var s=0;s<o.length;s++){if(o[s].tokenType==="valueList"&&o[s].info.metadata.hasOwnProperty(t._hasValueSource)){t._createCpValueHelp(o[s].info,e.getCursor(),false)}}}}this.keyMap={Tab:false,"Shift-Tab":false,"Ctrl-Space":l,Backspace:o,Enter:s,"':'":n,"'+'":o,"'-'":o,"'*'":o,"'/'":o,"'_'":o,"'o'":o,"'q'":o,"'w'":o,"'e'":o,"'r'":o,"'t'":o,"'y'":o,"'u'":o,"'i'":o,"'p'":o,"'.'":o,"'a'":o,"'s'":o,"'d'":o,"'f'":o,"'g'":o,"'h'":o,"'j'":o,"'k'":o,"'l'":o,"'z'":o,"'x'":o,"'c'":o,"'v'":o,"'b'":o,"'n'":o,"'m'":o,"'O'":o,"'Q'":o,"'W'":o,"'E'":o,"'R'":o,"'T'":o,"'Y'":o,"'U'":o,"'I'":o,"'P'":o,"'A'":o,"'S'":o,"'D'":o,"'F'":o,"'G'":o,"'H'":o,"'J'":o,"'K'":o,"'L'":o,"'Z'":o,"'X'":o,"'C'":o,"'V'":o,"'B'":o,"'N'":o,"'M'":o,"'0'":false,"'1'":false,"'2'":false,"'3'":false,"'4'":false,"'5'":false,"'6'":false,"'7'":false,"'8'":false,"'9'":false,"' '":p,F4:d};function h(e){return e.keyMap}if(this.expressionTokens.length===0){var c=L.getElementById(this.getExpressionLanguage());if(c){this.getFormattingTokens(c)}}var f=h(this);var g=this.oTextArea.getId()+"-inner";var v=u.msieversion()>=0;if(v){jQuery("#"+g).attr("placeholder",this.getProperty("placeholder"))}this.codeMirror=window.CodeMirror.fromTextArea(document.getElementById(g),{mode:"text/hdf",lineNumbers:false,lineWrapping:true,matchBrackets:e===true?true:false,highlightSelectionMatches:e===true?{showToken:/\w/}:{},relDelegate:r,returnType:this.getProperty("type"),collection:this.getProperty("collection"),valueListAttribute:a,expressionEditor:this,stillNeedShowHint:true,shouldValidate:true,styleSelectedText:true,smartIndent:true,autoCloseBrackets:true,indentUnit:6});this.codeMirror.addKeyMap(f,true)};A.prototype.getFormattingTokens=function(e){this.tokens=[];this.valueListAttrInfo=e.getValueListAttribute(this.mProperties.attributeInfo);var t=e.getExpressionMetadata(this._liveValue);if(t){this.tokens=t.tokens}if(e._hasValueSource&&this.valueListAttrInfo){this.newExpression=this.valueListAttrInfo.navPath+" "+y.IS_EQUAL_TO+" "+this._liveValue;t=e.getExpressionMetadata(this.newExpression);if(t){var r=t.tokens;for(var a=0;a<r.length;a++){for(var i=0;i<this.tokens.length;i++){if(r[a].tokenType==="valueList"&&r[a].token===this.tokens[i].token){this.tokens[i].info=r[a].info;this.tokens[i].tokenType=r[a].tokenType}}}}}this.setExpressionTokens(this.tokens)};A.prototype._setEditorStyle=function(){if(this.getValueStateText()&&this.getValueStateText()!==""){jQuery(this.codeMirror.getWrapperElement()).addClass("CodeMirror-error");jQuery(this.codeMirror.getWrapperElement()).addClass("sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError");jQuery("#"+this.oTextArea.getId()).addClass("sapMInputBaseError")}jQuery("#"+this.oTextArea.getId()).removeClass().addClass("sapMInput");jQuery(this.codeMirror.getWrapperElement()).addClass("sapMInputBaseInner CodeMirror-rules");if(!this.getEditable()){jQuery(this.codeMirror.getWrapperElement()).addClass("CodeMirror-rules-Not-Editable")}else{jQuery(this.codeMirror.getWrapperElement()).removeClass("CodeMirror-rules-Not-Editable")}if(this.codeMirror){this.codeMirror.refresh()}};A.prototype._handleOnLoadValidation=function(){if(this.getValidateOnLoad()){this.validateExpression();this.setValidateOnLoad(false)}};A.prototype._handleEditableProperty=function(){if(this.getEditable()===false){this.codeMirror.setOption("readOnly","true");this.codeMirror.setOption("theme","read-only")}};A.prototype._handleFocus=function(){var e=this.codeMirror;if(this.getFocusOnLoad()){this.focus()}this.codeMirror.on("focus",function(e,t){var r=e.options.expressionEditor.getProperty("valueStateText");if(r&&r!==""){e.options.expressionEditor._showPopUp()}e.options.stillNeedShowHint=true;jQuery("#"+e.options.expressionEditor.oTextArea.getId()).addClass("sapMInputFocused");jQuery(e.getWrapperElement()).removeClass("CodeMirror-errorBackground")});if(this.dataModel.getProperty("/focus")===true){window.setTimeout(function(){var t=e.getLine(e.lastLine());var r=t.length;e.setCursor({line:e.lastLine(),ch:r})},10)}};A.prototype._refreshOnNavigationEnd=function(){jQuery(".sapMNav").on("webkitTransitionEnd oTransitionEnd transitionend msTransitionEnd",jQuery.proxy(e,this));function e(){if(this.codeMirror){this.codeMirror.refresh()}}};A.prototype._handleKeyPress=function(){this.codeMirror.on("keyHandled",function(e,t,r){if(r.keyCode===27&&this&&this.endCompletion===true){r.stopPropagation();this.endCompletion=false}if(r.ctrlKey===true&&t==="Ctrl-A"){r.stopPropagation()}})};A.prototype._handleEndCodeCompletion=function(){this.codeMirror.on("endCompletion",function(e){e.options.expressionEditor.needAutoComplete=false;e.options.expressionEditor.endCompletion=!e.options.expressionEditor.endCompletion})};A.prototype._handleMousedown=function(){this.codeMirror.on("mousedown",function(e,t){t.stopPropagation();var r=t.target||t.srcElement;if(r&&t.button===0){var a=r.className.split(/\s+/);for(var i=0;i<a.length;i++){if(a[i]==="cm-valuehelp"){var o=a[++i].split("-valuehelpid-")[1];e.options.expressionEditor.onValueHelpLinkPress(r.textContent,o)}}}})};A.prototype._handleChange=function(){this.codeMirror.on("change",function(e,t){var r=e.options.expressionEditor;if(r.codeMirror.state.completionActive&&r.keyMap["'"+t.text[0]+"'"]===false){r.codeMirror.state.completionActive.close()}jQuery(r.codeMirror.getWrapperElement()).removeClass("CodeMirror-error");jQuery(r.codeMirror.getWrapperElement()).removeClass("sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError");r._liveValue=e.getValue();var a=L.getElementById(r.getExpressionLanguage());if(a){r.getFormattingTokens(a)}r.codeMirror.options.shouldValidate=true;r.fireLiveChange({newValue:e.getValue()});if(t.origin!=="+delete"){e.operation(function(){for(var t=0,r=e.lineCount();t<r;++t){e.indentLine(t,"smart")}})}})};A.prototype._handleFocusLeave=function(){this.codeMirror.on("blur",function(e){var t=e.options.expressionEditor;t._closePopUp();t.codeMirror.options.stillNeedShowHint=false;if(t.codeMirror.options.shouldValidate&&!t.bFlagForPreventBlurWhenPopOverOpen){t.setValue(t.codeMirror.getValue());if(!t){t.validate()}t._closePopUp();t.fireChange({newValue:e.getValue()});t.codeMirror.options.shouldValidate=false}jQuery("#"+t.oTextArea.getId()).removeClass("sapMInputFocused");t.dataModel.setProperty("/focus",false)})};A.prototype._setExpressionErrorStyle=function(){var e=this.getProperty("valueStateText");if(e!==""&&e!==undefined&&this.codeMirror){jQuery(this.codeMirror.getWrapperElement()).addClass("CodeMirror-error");jQuery(this.codeMirror.getWrapperElement()).addClass("sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError");jQuery("#"+this.oTextArea.getId()).addClass("sapMInputBaseError");var t;if(this.errorCursorPosition<0){var r=this.codeMirror.getLine(this.codeMirror.lastLine());t=r.length;jQuery(this.codeMirror.getWrapperElement()).addClass("CodeMirror-errorBackground")}else{var a=e.lastIndexOf("'");if(a>0){var i=e.substring(0,a);a=i.lastIndexOf("'");if(a>0){i=i.substring(a+1)}var o=false;for(var s=this.codeMirror.lastLine();!o&&s>=0;s--){var n=this.codeMirror.getLine(s);t=n.lastIndexOf(i);if(t>=0){o=true;this.codeMirror.setSelection({line:s,ch:t},{line:s,ch:t+i.length})}}}}}};A.prototype.getSelectedText=function(){return this.codeMirror.getSelection()};A.prototype.exit=function(){document.removeEventListener("mousedown",this.fnMouseDownListsner,true)};return A},true);
//# sourceMappingURL=ExpressionAdvanced.js.map