/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/rules/ui/Utils","sap/rules/ui/AstExpressionBasic","sap/rules/ui/Constants","sap/ui/core/library","sap/ui/core/EventBus","sap/ui/core/Lib","sap/ui/core/Element","./DecisionTableCellAstExpressionBasicRenderer"],function(jQuery,e,t,i,s,a,o,r,n,l){"use strict";var u=i.extend("sap.rules.ui.DecisionTableCellAstExpressionBasic",{metadata:{library:"sap.rules.ui",properties:{headerValue:{type:"string",defaultValue:"",bindable:"bindable"},fixedOperator:{type:"string",defaultValue:"",bindable:"bindable"},type:{type:"sap.rules.ui.ExpressionType",defaultValue:e.ExpressionType.BooleanEnhanced,bindable:"bindable"}}},renderer:l});u.prototype.validateExpression=function(){var e=this.getValue();if(e){var t=this.getHeaderValue()+" "+this.getFixedOperator()+" "+e}else{this.setValueStateText("")}};u.prototype.init=function(){i.prototype.init.apply(this,arguments);this.bFlagForChangeBeforeBlur=false;this.oBundle=r.getResourceBundleFor("sap.rules.ui.i18n")};u.prototype.onAfterRendering=function(){var e=this;this._oAstExpressionLanguage=n.getElementById(this.getAstExpressionLanguage());i.prototype.onAfterRendering.apply(this,arguments);this.oDecisionTableCell=this.getParent()&&this.getParent().getParent()?this.getParent().getParent():null;this._handleValidation();if(jQuery(document.getElementById(this.getId())).closest("td").next().width()){this._showPopUp()}if(this.oDecisionTableCell){this.markerString=this.oDecisionTableCell._getMarkerString().trim();var t=this.oDecisionTableCell.getValueStatePath();var s=this.oDecisionTableCell.getModel("dtModel");var o=this.oDecisionTableCell.getAggregation("_displayedControl");if(o){s.setProperty(t.slice(8),a.ValueState.None)}}};u.prototype._handleValidation=function(){this.validateExpression()};u.prototype.exit=function(){this._handleValidation();if(this.bFocusCellAfterEscape&&this.oDecisionTableCell){var e=this.oDecisionTableCell.getDomRef().parentElement.parentElement;if(e){jQuery(e).focus()}}};u.prototype.createEventListeners=function(){};u.prototype._updateModelAstNodes=function(e,t,i){if(this.oDecisionTableCell){var s=t.ASTNodes;for(var a in s){var o={};if(s[a].Root){o.Sequence=1;o.Root=true}else{o.Sequence=s[a].SequenceNumber;o.ParentId=s[a].ParentId}if(s[a].Function){o.Function=s[a].Function?s[a].Function:""}if(s[a].Type==="I"){o.IncompleteExpression=s[a].Value}if(s[a].Type!=="P"&&s[a].Type!=="O"&&!s[a].Function){o.BusinessDataType=s[a].Output?s[a].Output.BusinessDataType:s[a].BusinessDataType;o.DataObjectType=s[a].Output?s[a].Output.DataObjectType:s[a].DataObjectType;o.Value=s[a].Value?s[a].Value:""}else if(s[a].Type==="O"){o.Reference=s[a].Reference}o.NodeId=s[a].Id;o.Type=s[a].Type;o.RuleId=t.RuleId;o.Version=t.Version;o.ColId=t.ColId;o.RowId=t.RowId;var r={};r.properties=o;r.groupId=i;e.createEntry("/DecisionTableRowCellASTs",r)}}};u.prototype._removeExistingAstNodes=function(e,t,i,s,a){if(this.oDecisionTableCell){var o={};o.ColId=t.ColId;o.RowId=t.RowId;o.RuleId=t.RuleId;o.Version=t.Version;var r;var n=[];var l;if(s&&s.length>0){for(var u=0;u<s.length;u++){r={};r.ColId=t.ColId;r.RowId=t.RowId;r.RuleId=t.RuleId;r.Version=t.Version;r.NodeId=s[u].Id;l=e.createKey("DecisionTableRowCellASTs",r);n.push(l)}}if(i&&e.getProperty(i)&&"DecisionTableRowCellASTs"in e.getProperty(i)&&e.getProperty(i).DecisionTableRowCellASTs&&"__list"in e.getProperty(i).DecisionTableRowCellASTs){e.getProperty(i).DecisionTableRowCellASTs.__list=n}e.callFunction("/DeleteDTRowCellASTDraft",{method:"POST",groupId:a,urlParameters:o})}};u.prototype._checkEmptyMarkerNode=function(e){if(e&&e.length===1&&(e[0].Type==="I"&&(e[0].Value===""||e[0].Value===this.markerString)||e[0].Type==="M")){return false}return true};u.prototype._removeAndUpdateExisitingNodes=function(e,t,i,s,a){var r=t.RowId+","+t.ColId;e.setDeferredGroups([r]);var n=o.getInstance();e.update(i,{Content:e.getProperty(a)},{groupId:r,success:function(e){n.publish("sap.ui.rules","astCreated")}});this._removeExistingAstNodes(e,t,i,s,r);if(this._checkEmptyMarkerNode(s)){this._updateModelAstNodes(e,t,r)}e.submitChanges({groupId:r})};u.prototype._changeValue=function(e){var t={};if(this.oDecisionTableCell){var i=e.getSource();var s=o.getInstance();var a=e.getParameter("newValue");i.setValue(a);var r=this.oDecisionTableCell.getAggregation("_displayedControl");r.setValue(e.getParameter("displayText"));r.JSON=this.getJsonData();r.relString=this.relString;var l=n.getElementById(this.getAstExpressionLanguage());var u=this.getBindingContext().getModel();t=this.oDecisionTableCell.getKeyProperties();var p=e.getParameter("astNodes");if(p&&p.length===1&&p[0].Type==="I"&&p[0].Value!==""&&p[0].Value!==this.markerString){r.setValueState("Error");r.setTooltip(this.oBundle.getText("invalidExpression"))}else{r.setValueState("None")}t.ASTNodes=p;var d=this.oDecisionTableCell.getValuePath();var c="/"+d.split("/")[1];s.publish("sap.ui.rules","astCreating");this._removeAndUpdateExisitingNodes(u,t,c,p,d)}};return u},true);
//# sourceMappingURL=DecisionTableCellAstExpressionBasic.js.map