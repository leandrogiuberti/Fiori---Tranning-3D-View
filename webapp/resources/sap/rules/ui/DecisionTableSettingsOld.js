/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/rules/ui/library","sap/ui/core/Control","sap/ui/layout/form/SimpleForm","sap/m/Label","sap/m/Switch","sap/m/Select","sap/m/Table","sap/m/Text","sap/m/CheckBox","sap/m/Input","sap/m/Button","sap/rules/ui/ExpressionAdvanced","sap/ui/layout/VerticalLayout","sap/rules/ui/type/Expression","sap/ui/core/Lib","./DecisionTableSettingsOldRenderer"],function(e,t,o,r,a,i,n,s,l,u,d,p,c,g,h,y){"use strict";var v=t.extend("sap.rules.ui.DecisionTableSettingsOld",{metadata:{library:"sap.rules.ui",properties:{hitPolicies:{type:"sap.rules.ui.RuleHitPolicy[]",defaultValue:[e.RuleHitPolicy.FirstMatch,e.RuleHitPolicy.AllMatch]},modelName:{type:"string",defaultValue:""},newDecisionTable:{type:"boolean",defaultValue:false}},aggregations:{mainLayout:{type:"sap.ui.layout.form.SimpleForm",multiple:false}},defaultAggregation:"mainLayout",associations:{expressionLanguage:{type:"sap.rules.ui.services.ExpressionLanguage",multiple:false,singularName:"expressionLanguage"}},events:{},publicMethods:[]},renderer:y});v.prototype.init=function(){this.oBundle=h.getResourceBundleFor("sap.rules.ui.i18n");this.needCreateLayout=true;this.firstLoad=true;this.onsapescape=function(e){e.stopPropagation()};this._decisionTableHeaderSettingFormatter=new g;this.setBusyIndicatorDelay(0)};v.prototype.onBeforeRendering=function(){if(this.firstLoad){this._initSettingsModel();if(this.getProperty("newDecisionTable")===true){this._prepareNewRuleWorkaround()}this.firstLoad=false}if(this.needCreateLayout){var e=this.getAggregation("mainLayout");if(e){e.destroy()}e=this._createLayout();this.setAggregation("mainLayout",e,true);this.needCreateLayout=false;this.conditionsTable.getBinding("items").attachDataRequested(function(){this.setBusy(true)}.bind(this));this.conditionsTable.getBinding("items").attachDataReceived(function(){this.setBusy(false)}.bind(this))}};v.prototype._prepareNewRule=function(){var t=this._getModel();var o=this.getBindingContext();var r=e.RuleFormat.Advanced;t.setProperty("Type",e.RuleType.DecisionTable,o,true);t.setProperty("RuleFormat",r,o,true);var a=sap.ui.getCore().byId(this.getExpressionLanguage());var i=a.getExpressionLanguageVersion();t.setProperty("ExpressionLanguageVersion",i,o,true);var n={ruleId:o.getProperty("Id"),version:o.getProperty("Version")};var s={};this._createDecisionTable(n,s);n.colId=1;n.expression="";this._createCondition(n,s);n.colId=2;var l=this._createResult(n,s);n.rowId=1;n.columnsNumber=1+l;this._createRow(n,s)};v.prototype._createDecisionTable=function(e,t){var o=this._getModel();var r=this.getBindingContext();var a=this.getHitPolicies()[0];if(r.getProperty("DecisionTable")){o.setProperty("DecisionTable/HitPolicy",a,r,true)}else{var i={RuleId:e.ruleId,Version:e.version,HitPolicy:a};t=t?t:{};t.properties=i;o.createEntry("/DecisionTables",t)}};v.prototype._createRow=function(e,t){t=t?t:{};var o=this._getModel();var r={RuleId:e.ruleId,Version:e.version,Id:e.rowId};t.properties=r;o.createEntry("/DecisionTableRows",t);this._createCellsForNewRow(e,t)};v.prototype._createCondition=function(t,o){o=o?o:{};var r=this._getModel();var a={RuleId:t.ruleId,Version:t.version,Id:t.colId,Type:e.DecisionTableColumn.Condition};o.properties=a;r.createEntry("/DecisionTableColumns",o);var i={RuleId:t.ruleId,Version:t.version,Id:t.colId,Expression:t.expression,ValueOnly:false,FixedOperator:"",Description:""};o.properties=i;r.createEntry("/DecisionTableColumnConditions",o)};v.prototype._createCellsForNewColumn=function(e,t){t=t?t:{};var o=this._getModel();var r=this.getBindingContext();var a=o.getProperty("DecisionTable/DecisionTableRows",r);for(var i=0;i<a.length;i++){var n=o.getProperty("/"+a[i]).Id;var s={RuleId:e.ruleId,Version:e.version,RowId:n,ColId:e.colId,Content:""};t.properties=s;o.createEntry("/DecisionTableRowCells",t)}};v.prototype._createCellsForNewRow=function(e,t){t=t?t:{};var o=this._getModel();for(var r=1;r<=e.columnsNumber;r++){var a={RuleId:e.ruleId,Version:e.version,RowId:e.rowId,ColId:r,Content:""};t.properties=a;o.createEntry("/DecisionTableRowCells",t)}};v.prototype._createResult=function(e,t){var o=this.getBindingContext();var r=o.getProperty("ResultDataObjectName");var a=sap.ui.getCore().byId(this.getExpressionLanguage());var i=a.getResultInfo(r);var n=i?i.requiredParams:[];var s=n.length;var l=e.colId;for(var u=0;u<s;u++){e.colId=l+u;e.resultParameterData=n[u];this._createResultParameter(e,t)}return s};v.prototype._createResultParameter=function(t,o){o=o?o:{};var r=this._getModel();var a={RuleId:t.ruleId,Version:t.version,Id:t.colId,Type:e.DecisionTableColumn.Result};o.properties=a;r.createEntry("/DecisionTableColumns",o);var i={RuleId:t.ruleId,Version:t.version,Id:t.colId,DataObjectAttributeName:t.resultParameterData.name,DataObjectAttributeId:t.resultParameterData.paramId,BusinessDataType:t.resultParameterData.businessDataType};o.properties=i;r.createEntry("/DecisionTableColumnResults",o)};v.prototype._removeColumn=function(e,t){var o=this._getModel();var r=e.getPath();o.remove(r,t);this._internalModel.setProperty("/tableData",{},true)};v.prototype._removeCellsForColumn=function(e,t){var o=this._getModel();var r=this.getBindingContext();var a=o.getProperty("DecisionTable/DecisionTableRows",r);var i=e.colId-1;for(var n=0;n<a.length;n++){var s=o.getProperty("/"+a[n]+"/Cells");var l="/"+s[i];o.remove(l,t)}};v.prototype._createTable=function(){this.conditionsTable=new n({backgroundDesign:sap.m.BackgroundDesign.Solid,showSeparators:sap.m.ListSeparators.None,fixedLayout:true,columns:[new sap.m.Column({width:"50%",header:new sap.m.Label({text:this.oBundle.getText("colOfDecisionTable"),design:sap.m.LabelDesign.Bold}).setTooltip(this.oBundle.getText("colOfDecisionTable"))}),new sap.m.Column({width:"30%",header:new sap.m.Label({text:this.oBundle.getText("fixedOperator"),design:sap.m.LabelDesign.Bold}).setTooltip(this.oBundle.getText("fixedOperator"))}),new sap.m.Column({width:"20%"})]}).data("hrf-id","columnsTable",true);this.conditionsTable.bindItems({path:"DecisionTable/DecisionTableColumnsCondition",factory:this._tableColumnsFactory.bind(this),parameters:{expand:"Condition"}});this.conditionsTable.setBusyIndicatorDelay(0);return this.conditionsTable};v.prototype._createLayout=function(){var e=new o({editable:true,layout:"ResponsiveGridLayout",maxContainerCols:1,columnsL:1,columnsM:1,labelSpanM:1,content:[new r({text:this.oBundle.getText("hitPolicy")}).setTooltip(this.oBundle.getText("hitPolicy")),new i({width:"25%",enabled:"{settingsModel>/hitPolicy/enabled}",items:{path:"settingsModel>/hitPolicy/hitPolicyEnumration",template:new sap.ui.core.Item({key:"{settingsModel>key}",text:"{settingsModel>text}"})},selectedKey:"{DecisionTable/HitPolicy}"}),new r,this._createTable(),new r({text:this.oBundle.getText("ouput")}).setTooltip(this.oBundle.getText("ouput")),new s({width:"25%",text:"{ResultDataObjectName}"})]});return e};v.prototype._setFixedOperatorOnExpressionChange=function(e,t){var o=this._getFixedOperatorDataForExpression(e);this._internalModel.setProperty("/tableData/"+t,o,true);this._updateRemoveRowEnabled()};v.prototype.setExpressionLanguage=function(e){this.setAssociation("expressionLanguage",e,true);this._decisionTableHeaderSettingFormatter.setExpressionLanguage(e)};v.prototype._getColumnControlObject=function(t){var o=this._internalModel.getProperty("/advancedMode/current");if(o===e.RuleFormat.Advanced){var r=sap.ui.getCore().byId(this.getExpressionLanguage());return new p({expressionLanguage:r,placeholder:this.oBundle.getText("expressionPlaceHolder"),validateOnLoad:true,type:e.ExpressionType.NonComparison,value:{path:"Condition/Expression",type:this._decisionTableHeaderSettingFormatter,events:{change:function(t){var o=t.getSource();var a=o.getContext();var i=a.getProperty("Id");var n=r.convertDecisionTableExpressionToDisplayValue(o.getValue(),"","",e.ExpressionType.All);var s;if(n.output.status==="Success"&&n.output.converted){s=n.output.converted.header}else{s=o.getValue()}this._setFixedOperatorOnExpressionChange(s,i)}.bind(this)}},enabled:true,change:function(e){var t=e.getSource();var o=t.getBindingContext();var r=o.getProperty("Id");this._setFixedOperatorOnExpressionChange(t.getValue(),r);var a=o.getProperty("Condition/Expression");if(!a){var i=o.getModel();i.setProperty(o.getPath()+"/Condition/FixedOperator","")}}.bind(this)})}else{return new i({width:"100%",items:{path:"",template:new sap.ui.core.Item({key:"",text:""})},selectedKey:"{Condition/Expression}",enabled:true,change:function(e){}})}};v.prototype._tableColumnsFactory=function(e,t){var o=t.getProperty("RuleId");var r=t.getProperty("Version");var a=t.getProperty("Id");return new sap.m.ColumnListItem({cells:[this._getColumnControlObject(t),new sap.m.Select({width:"100%",items:{path:"settingsModel>/tableData/"+a+"/fixOperatorEnumration",template:new sap.ui.core.Item({key:"{settingsModel>key}",text:"{settingsModel>value}"})},selectedKey:"{Condition/FixedOperator}",enabled:"{settingsModel>/tableData/"+a+"/fixOperatorEnabled}"}),new sap.ui.layout.HorizontalLayout({content:[new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("sys-cancel"),visible:"{settingsModel>/removeRowEnabled}",press:function(e){var t=e.getSource().getBindingContext();var o={};this._removeColumnWorkaround(t,o)}.bind(this)}).setTooltip(this.oBundle.getText("removeColumn")),new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("add"),press:function(e){var t={ruleId:o,version:r,colId:a+1,expression:""};var i={};this._addConditionWorkaround(t,i)}.bind(this)}).setTooltip(this.oBundle.getText("addColumn"))],height:"1em"})]})};v.prototype._prepareNewRuleWorkaround=function(){this._prepareNewRule();this._saveWorkaround()};v.prototype._addConditionWorkaround=function(e,t){this._createCondition(e,t);this._saveWorkaround()};v.prototype._removeColumnWorkaround=function(e,t){var o=this._getModel();if(o.hasPendingChanges()){this._saveWorkaround({success:function(){this._removeColumn(e,t)}.bind(this)})}else{this._removeColumn(e,t)}};v.prototype._saveWorkaround=function(e){var t=this._getModel();t.submitChanges(e)};v.prototype._getModel=function(){var e=this.getModelName();if(e){return this.getModel(e)}return this.getModel()};v.prototype._getBindModelName=function(){var e="";var t=this.getModelName();if(t){e=t+">"}return e};v.prototype._initSettingsModel=function(){var e={};e.advancedMode=this._getAdvancedModeData();e.hitPolicy=this._getHitPoliciesData();e.tableData={};e.removeRowEnabled=false;this._internalModel=new sap.ui.model.json.JSONModel(e);this.setModel(this._internalModel,"settingsModel")};v.prototype._getAdvancedModeData=function(){var t;var o={};var r=this.getBindingContext();var a=r.getProperty("RuleFormat");if(a===e.RuleFormat.Advanced){t=e.RuleFormat.Advanced}else{t=e.RuleFormat.Advanced}switch(t){case e.RuleFormat.All:o={current:e.RuleFormat.Basic,enabled:true,visible:true};break;case e.RuleFormat.Basic:o={current:e.RuleFormat.Basic,enabled:false,visible:false};break;case e.RuleFormat.Advanced:o={current:e.RuleFormat.Advanced,enabled:false,visible:true};break;default:}return o};v.prototype._getHitPoliciesData=function(){var e=this.getProperty("hitPolicies");var t=e.length;var o={hitPolicyEnumration:[]};for(var r=0;r<t;r++){o.hitPolicyEnumration.push({key:e[r],text:this.oBundle.getText(e[r])})}o.enabled=t>1?true:false;return o};v.prototype._getFixedOperatorDataForExpression=function(t){var o=t?true:false;var r={fixOperatorEnumration:[{key:"",value:this.oBundle.getText("fixOperatorDefaultValue")}],fixOperatorEnabled:o};if(o){var a=[];var i=sap.ui.getCore().byId(this.getExpressionLanguage());var n=[{tokenType:e.ExpressionTokenType.reservedWord,tokenCategory:e.ExpressionCategory.comparisonOp},{tokenType:e.ExpressionTokenType.reservedWord,tokenCategory:e.ExpressionCategory.comparisonBetweenOp},{tokenType:e.ExpressionTokenType.reservedWord,tokenCategory:e.ExpressionCategory.comparisonExistOp}];a=i.getSuggestionsByCategories(t,n);for(var s=0;s<a.length;s++){r.fixOperatorEnumration.push({key:a[s].text,value:a[s].text})}}return r};v.prototype._setAdvancedMode=function(t){var o=t.getParameter("selected");var r=o?e.RuleFormat.Advanced:e.RuleFormat.Basic;var a=this._getModel();var i=this.getBindingContext().getPath();a.setProperty(i+"/RuleFormat",r);this.needCreateLayout=true;this.invalidate()};v.prototype._updateRemoveRowEnabled=function(){var e=this._internalModel.getProperty("/tableData");var t=Object.keys(e).length;var o=t>1;this._internalModel.setProperty("/removeRowEnabled",o,null,true)};v.prototype.getButtons=function(e){var t=[];var o=new d({text:this.oBundle.getText("applyChangesBtn")}).setTooltip(this.oBundle.getText("applyChangesBtn"));o.attachPress(function(){this.multiHeaderFlag=false;this.getModel().submitChanges();e.setState(sap.ui.core.ValueState.Success);e.close()},this);t.push(o);return t};return v},true);
//# sourceMappingURL=DecisionTableSettingsOld.js.map