sap.ui.define(["sap/rules/ui/parser/ruleBody/lib/ruleBody","sap/rules/ui/parser/ruleBody/lib/constants","sap/rules/ui/parser/businessLanguage/lib/constants","sap/rules/ui/parser/resources/dependencies/lib/objects","sap/rules/ui/parser/ruleBody/lib/dependenciesHandler","sap/rules/ui/parser/resources/vocabulary/lib/constants","sap/rules/ui/parser/infrastructure/messageHandling/lib/responseCollector","sap/rules/ui/parser/infrastructure/util/utilsBase","sap/rules/ui/parser/infrastructure/util/constants","sap/rules/ui/parser/ruleBody/lib/decisionTableCell","sap/rules/ui/parser/resources/dependencies/lib/constants","sap/base/Log"],function(t,e,s,a,n,i,r,u,o,l,p,h){"use strict";var d=new u.utilsBaseLib;var c=r.ResponseCollector;function f(){h.debug("CTOR - Rule Validator");t.RuleBody.call(this);this.initValidation();this.invalidRuleBody=null;this.mode=e.RULE_MODE_VALIDATION;this.aliasOutputBusinessDataType=null;this.rootObjectContext={};this.rootObjectContext.name=null;this.rootObjectContext.keysMap={};this.haveSameRootObject=true;this.vocaRulesRootObjectMap=null;this.dependenciesByFlags=false}f.prototype=Object.create(t.RuleBody.prototype);f.prototype.constructor=f;f.prototype.initValidation=function t(){this.invalidHeaders=[];this.headersOfInvalidCells={};this.actionMap={};this.status=e.RULE_SUCCESS;this.ruleBody={};this.ruleBody.type="";this.ruleBody.content={};this.flags={};this.flags[e.outputFlagsEnum.dependenciesOutput]=false;this.flags[e.outputFlagsEnum.validationOutput]=true;this.flags[e.outputFlagsEnum.unknownTokensOutput]=false;this.flags[e.outputFlagsEnum.isAlias]=false;this.depHandler=null;this.unknownTokens={};this.rowOutputParamsCnt=0;this.conditionColumnsCnt=0;this.currentParserResult=null};f.prototype.isParserReturnedErrorMessage=function t(){if(this.currentParserResult.hasOwnProperty("status")&&this.currentParserResult.status===e.RULE_ERROR){return true}return false};f.prototype.updateValidateResult=function t(s){if(this.currentParserResult.hasOwnProperty("status")&&this.currentParserResult.status===e.RULE_ERROR){s.errorDetails=this.currentParserResult.errorDetails;s.status=this.currentParserResult.status;s.cursorPosition=this.currentParserResult.cursorPosition;return s}return null};f.prototype.handleMessages=function t(e,s,a,n,i){if(e!==null&&e!==undefined){var r=i||{cursorPosition:e.cursorPosition};c.getInstance().addMessage(e.errorID,undefined,s,r,e.errorDetails)}else{if(i){s=null}c.getInstance().addMessage(a,n,s,i)}};f.prototype.handleMessages4OdataFormatOutput=function t(s,a,n,i,r,u,o){var l=null;if(s){if(this.flags[e.ODATA_FORMAT_PAYLOAD]){l={};l.type=a;l.ruleId=this.flags[e.ODATA_FORMAT_PAYLOAD][e.RULE_ID];l.colId=n;l.cursorPosition=s.cursorPosition;if(i){l.rowId=i}this.handleMessages(s,o,s.errorID,null,l)}}else{if(this.flags[e.ODATA_FORMAT_PAYLOAD]){l={};l.type=a;l.ruleId=this.flags[e.ODATA_FORMAT_PAYLOAD][e.RULE_ID];if(n){l.colId=n}if(i){l.rowId=i}}this.handleMessages(null,o,r,u,l)}};f.prototype.updateRootObjectContext=function t(s){var a,n=null;var i,r=[];if(this.rootObjectContext.name&&s.name&&this.rootObjectContext.name!==s.name){this.haveSameRootObject=false;this.status=e.RULE_ERROR;r=[this.rootObjectContext.name];a="rule_body_validator_expressions_need_to_have_same_root_object";n=c.getInstance().getMessage(a,r);this.handleMessages4OdataFormatOutput(null,e.additionalInfoTypeEnum.ruleResult,null,null,a,r,null)}else{if(s.associations){for(i=0;i<s.associations.length;i++){this.rootObjectContext.keysMap[s.associations[i]]=true}}if(s.keys){for(i=0;i<s.keys.length;i++){this.rootObjectContext.keysMap[s.keys[i]]=true}}if(!this.rootObjectContext.name&&s.name){this.rootObjectContext.name=s.name}}return n};f.prototype.updateRootObjectContextFromParser=function t(){var e,a=null;if(this.currentParserResult.hasOwnProperty(s.propertiesEnum.rootObjectContext)&&this.currentParserResult.status===s.statusEnum.SUCCESS&&this.haveSameRootObject){e=this.currentParserResult[s.propertiesEnum.rootObjectContext];a=this.updateRootObjectContext(e)}return a};f.prototype.validateRootObjectContextAgainstVocaRules=function t(){var e=null;var s;var a;if(this.vocaRulesRootObjectMap){var n=this.depHandler.getDependencies();if(n){for(s in n){if(n.hasOwnProperty(s)){if(n[s][p.PROPERTY_NAME_CATEGORY]===p.CATEGORY_VOCA_DO&&this.vocaRulesRootObjectMap.hasOwnProperty(n[s].DOName)){a=this.vocaRulesRootObjectMap[n[s].DOName];e=this.updateRootObjectContext(a)}}}}}return e};f.prototype.updateDependnciesFromParser=function t(){if(this.currentParserResult.hasOwnProperty(e.outputFlagsEnum.dependenciesOutput)&&this.status===e.RULE_SUCCESS){this.depHandler.addDependencies(this.currentParserResult[e.outputFlagsEnum.dependenciesOutput])}};f.prototype.updateUnknownTokensFromParser=function t(){var e="";if(this.currentParserResult.hasOwnProperty("unknownTokens")){for(e in this.currentParserResult.unknownTokens){if(this.currentParserResult.unknownTokens.hasOwnProperty(e)){if(this.unknownTokens.hasOwnProperty(e)===false){this.unknownTokens[e]=1}else{this.unknownTokens[e]++}}}}};f.prototype.valiadteCollectionInfoOnOutputParameter=function t(s,a,n){var i=[];var r=null;var u=null;if(s!==null){if(!this.outputInfo&&this.flags[e.outputFlagsEnum.isAlias]){if(this.isOutputParameterCollection(s)){this.status=e.RULE_ERROR;i=[a];u="rule_body_validator_alias_output_parameter_cannot_be_collection";r=c.getInstance().getMessage(u,i);this.handleMessages(null,n,u,i)}}}return r};f.prototype.handleTextCondition=function t(a,n,i){h.debug("Validate Condition");this.currentParserResult=this.getParserAST(a,s.VALIDATE_MODE,null,s.TYPE_BOOLEAN,this.flags);if(this.isParserReturnedErrorMessage()){this.status=e.RULE_ERROR;this.handleMessages(this.currentParserResult,i);if(this.flags[e.outputFlagsEnum.unknownTokensOutput]){this.updateUnknownTokensFromParser()}}if(this.flags[e.outputFlagsEnum.dependenciesOutput]){this.updateDependnciesFromParser()}};f.prototype.initTextOutputsResult=function t(){this.ruleBody.content.outputs=[]};f.prototype.getOutputParamBusinessDataType=function t(a,n){var i=null;if(this.outputInfo===null){if(n!==null){i=n}else{if(this.flags[e.outputFlagsEnum.isAlias]&&this.aliasOutputBusinessDataType!==null){i=this.aliasOutputBusinessDataType}else{i=s.TYPE_ALL}}}else{var r;var u=this.outputInfo.requiredParams;for(r=0;r<u.length;r++){if(a===u[r].name){i=u[r].businessDataType;break}}}return i};f.prototype.getOutputParamFromOutputRTInfo=function t(e){var s;var a;if(this.outputInfo!==null){a=this.outputInfo.requiredParams;for(s=0;s<a.length;s++){if(e===a[s].name){return a[s]}}}return null};f.prototype.updateParserIsCollectionFlag=function t(s){var a=this.flags;var n=this.getOutputParamFromOutputRTInfo(s);if(n!==null&&n.hasOwnProperty(i.PROPERTY_NAME_IS_COLLECTION)&&n[i.PROPERTY_NAME_IS_COLLECTION]===true){a=JSON.parse(JSON.stringify(this.flags));a[e.outputPropertiesEnum.isCollection]=true}return a};f.prototype.isValidOutputName=function t(e){if(this.outputInfo===null){return true}var s;var a=this.outputInfo.requiredParams;for(s=0;s<a.length;s++){if(e===a[s].name){return true}}return false};f.prototype.isOutputParameterCollection=function t(e){if(e.hasOwnProperty(s.propertiesEnum.isCollection)&&e[s.propertiesEnum.isCollection]===true){return true}return false};f.prototype.handleTextOutputParameter=function t(a,n,i){var r;var u;var o;var l;this.rowOutputParamsCnt++;r=this.isValidOutputName(a.name);if(r===false){this.status=e.RULE_ERROR;o=d.buildJsonPath(i,e.RULE_OUTPUT_PARAM_NAME);u=[a.name,this.outputInfo.name];this.handleMessages(null,o,"rule_body_validator_parameter_not_exists_in_output",u);return}var p=null;if(a.hasOwnProperty(e.RULE_PARAM_BUSINESS_DATA_TYPE)){p=a[e.RULE_PARAM_BUSINESS_DATA_TYPE]}var h=this.getOutputParamBusinessDataType(a.name,p);if(h!==null){l=this.updateParserIsCollectionFlag(a.name);this.currentParserResult=this.getParserAST(a.content,s.VALIDATE_MODE,null,h,l);if(this.isParserReturnedErrorMessage()){this.status=e.RULE_ERROR;o=d.buildJsonPath(i,e.RULE_CONTENT);this.handleMessages(this.currentParserResult,o);if(this.flags[e.outputFlagsEnum.unknownTokensOutput]){this.updateUnknownTokensFromParser()}}else{o=d.buildJsonPath(i,e.RULE_CONTENT);this.valiadteCollectionInfoOnOutputParameter(this.currentParserResult,a.name,o)}if(this.flags[e.outputFlagsEnum.dependenciesOutput]){this.updateDependnciesFromParser()}}};f.prototype.initTextParametersResult=function t(){this.ruleBody.content.parameters=[]};f.prototype.initTextActionsResult=function t(){this.ruleBody.content.actions=[]};f.prototype.handleTextActionParameter=function t(a,n,i,r){var u;var o;var l;this.handleActionParameterForText(a.actionReference,a.name,i,r);var p=this.getActionParamBusinessDataArray({colID:i});for(u=0;u<p.length;u++){o=p[u];this.currentParserResult=this.getParserAST(a.content,s.VALIDATE_MODE,null,o,this.flags);if(this.isParserReturnedErrorMessage()){this.status=e.RULE_ERROR;l=d.buildJsonPath(r,e.RULE_CONTENT);this.handleMessages(this.currentParserResult,l);if(this.flags[e.outputFlagsEnum.unknownTokensOutput]){this.updateUnknownTokensFromParser()}}if(this.flags[e.outputFlagsEnum.dependenciesOutput]){this.updateDependnciesFromParser()}}};f.prototype.isActionExists=function t(e){var s=null;if(this.actionsMap.hasOwnProperty(e)===false){s=this.vocabularyDataProvider.getAction(this.vocabulary,e,null);if(s===null){return false}this.actionsMap[e]={paramMap:{}}}return true};f.prototype.handleTextAction=function t(s,n,r){var u={};var o=s.name;var l=this.isActionExists(o);if(l===false){var p=d.buildJsonPath(r,e.RULE_ACTION_NAME);var h=[o];this.handleMessages(null,p,"rule_body_validator_action_not_exists",h);this.status=e.RULE_ERROR}if(this.flags[e.outputFlagsEnum.dependenciesOutput]&&this.status===e.RULE_SUCCESS){if(s.hasOwnProperty(e.RULE_ACTION_NAME)){var c=this.vocabularyDataProvider.getAction(this.vocabulary,o,null);var f=null;if(c!==null){f=c.vocaName}var O=i.PROPERTY_NAME_ACTIONS.concat("."+o);u[O]=new a.VocaAction(o,f);this.depHandler.addDependencies(u)}}};f.prototype.setActionInfoInActionMap=function t(e){var s=null;if(this.actionsMap.hasOwnProperty(e)===false){s=this.vocabularyDataProvider.getAction(this.vocabulary,e,null);if(s===null){return false}this.actionsMap[e]={paramMap:{},vocabulary:s.vocaName};var a;var n;var i;for(a=0;a<s.requiredParams.length;a++){n=s.requiredParams[a].name;i=s.requiredParams[a].businessDataType;this.actionsMap[e].paramMap[n]={bdType:i,isExists:false,colID:null}}}return true};f.prototype.isParameterExistsInActionMap=function t(e,s,a){if(this.actionsMap.hasOwnProperty(s)===false){return false}var n=this.actionsMap[s];if(n.paramMap.hasOwnProperty(e)===false){return false}n.paramMap[e].isExists=true;n.paramMap[e].colID=a;return true};f.prototype.handleActionParameterForText=function t(s,a,n,i){var r;var u;var o;var l;var p;for(r=0;r<s.length;r++){u=s[r];o=this.setActionInfoInActionMap(u);if(o===false){p=d.buildJsonPath(i,e.RULE_ACTION_REFERENCE);l=[u];this.handleMessages(null,p,"rule_body_validator_action_ref_not_exists",l);this.status=e.RULE_ERROR}else if(this.isParameterExistsInActionMap(a,u,n)===false){p=d.buildJsonPath(i,e.RULE_ACTION_PARAM_NAME);l=[a,u];this.handleMessages(null,p,"rule_body_validator_param_name_not_exists",l);this.status=e.RULE_ERROR}}};f.prototype.handleActionParameterForDecisionTable=function t(s,a,n){var i;var r;var u;var o;var l;var p;for(i=0;i<s.length;i++){r=s[i];u=this.setActionInfoInActionMap(r);if(u===false){l=[r];o=c.getInstance().getMessage("rule_body_validator_action_ref_not_exists",l);this.handleMessages(null,undefined,"rule_body_validator_action_ref_not_exists",l);p={};p.colID=n;p.status=e.RULE_ERROR;p.errorDetails=o;this.status=e.RULE_ERROR;if(this.flags[e.outputFlagsEnum.validationOutput]){this.ruleBody.content.headers.push(p)}this.invalidHeaders[n]=true}else if(this.isParameterExistsInActionMap(a,r,n)===false){l=[a,r];o=c.getInstance().getMessage("rule_body_validator_param_name_not_exists",l);this.handleMessages(null,undefined,"rule_body_validator_param_name_not_exists",l);p={};p.colID=n;p.status=e.RULE_ERROR;p.errorDetails=o;this.status=e.RULE_ERROR;if(this.flags[e.outputFlagsEnum.validationOutput]){this.ruleBody.content.headers.push(p)}this.invalidHeaders[n]=true}}};f.prototype.handleOutputParameterHeader=function t(s,a,n){var i=this.isValidOutputName(s);var r="";var u;this.rowOutputParamsCnt++;if(i===false||this.flags[e.outputFlagsEnum.isAlias]&&this.rowOutputParamsCnt>1){if(i===false){u=[s,this.outputInfo.name];r="rule_body_validator_parameter_not_exists_in_output"}else if(this.flags[e.outputFlagsEnum.isAlias]&&this.rowOutputParamsCnt>1){r="rule_body_validator_one_alias_output_param_allowed"}var o=c.getInstance().getMessage(r,u);this.handleMessages4OdataFormatOutput(null,e.additionalInfoTypeEnum.column,n,null,r,u,null);var l={};l.colID=n;l.name=s;l.type=a;l.status=e.RULE_ERROR;l.errorDetails=o;this.status=e.RULE_ERROR;if(this.flags[e.outputFlagsEnum.validationOutput]){this.ruleBody.content.headers.push(l)}this.invalidHeaders[n]=true}};f.prototype.updateHeaderValidationResult=function t(e){var s={};s.expression=e.expression;s.colID=e.colID;s.type=e.type;s=this.updateValidateResult(s);return s};f.prototype.handleConditionHeader=function t(a){var n={};var i=[];var r;var u;this.conditionColumnsCnt++;if(this.ruleType===e.RULE_SET&&this.conditionColumnsCnt>1){r="rule_body_validator_one_condition_column_allowed";u=c.getInstance().getMessage(r,i);this.handleMessages(null,undefined,r,i);this.status=e.RULE_ERROR;if(this.flags[e.outputFlagsEnum.validationOutput]){n.expression=a.expression;n.colID=a.colID;n.type=a.type;n.status=e.RULE_ERROR;n.errorDetails=u;this.ruleBody.content.headers.push(n)}this.invalidHeaders[a.colID]=true}else{this.currentParserResult=this.getParserAST(a.expression,s.VALIDATE_MODE,null,s.TYPE_SINGLE_EXPRESSION,this.flags);if(a.expression!==null&&a.expression!==undefined&&a.expression!==""){n=this.updateHeaderValidationResult(a);if(n!==null){this.handleMessages4OdataFormatOutput(this.currentParserResult,e.additionalInfoTypeEnum.column,a.colID,null,null,null,null);this.status=e.RULE_ERROR;if(!this.ruleBody.content.hasOwnProperty("headers")){this.ruleBody.content.headers=[]}if(this.flags[e.outputFlagsEnum.validationOutput]){this.ruleBody.content.headers.push(n)}this.invalidHeaders[a.colID]=true;if(this.flags[e.outputFlagsEnum.unknownTokensOutput]){this.updateUnknownTokensFromParser()}}if(this.flags[e.outputFlagsEnum.dependenciesOutput]){this.updateDependnciesFromParser()}if(this.flags[e.outputFlagsEnum.rootObjectContextOutput]){this.updateRootObjectContextFromParser()}}}};f.prototype.validateHeader=function t(s){h.debug("validate header");if(s.hasOwnProperty(e.RULE_CELL_TYPE)){this.invalidHeaders[s.colID]=false;if(s.type===e.CONDITION&&s.hasOwnProperty(e.RULE_DT_EXPRESSION)){this.handleConditionHeader(s)}else if(s.type===e.PARAM){this.handleActionParameterForDecisionTable(s.actionReference,s.name,s.colID)}else if(s.type===e.OUTPUT_PARAM){this.handleOutputParameterHeader(s.name,s.type,s.colID)}}};f.prototype.initRow=function t(e){var s={};s.rowID=e;s.row=[];return s};f.prototype.handleHeaders=function t(e){var s=this;this.conditionColumnsCnt=0;this.traverseDecisionTableHeaders(e,function(t){s.validateHeader(t)});var a=this.buildHeadersMap(e);return a};f.prototype.handleDecisionTableCondition=function a(n,i,r,u){var o=u;var l=null;t.RuleBody.prototype.handleDecisionTableCondition.call(this,n,i,r,u);if(n!==null&&n.hasOwnProperty(e.RULE_DT_EXPRESSION)&&i.row[r].hasOwnProperty(e.RULE_CONTENT)){if(this.flags[e.outputFlagsEnum.unknownTokensOutput]||this.invalidHeaders[n.colID]!==true){l=this.concatToDecisionTableCondition(n.expression,i.row[r].content);this.currentParserResult=this.getParserAST(l,s.VALIDATE_MODE,null,s.TYPE_BOOLEAN_ENHANCED,this.flags);var p={};p.expression=l;p.colID=i.row[r].colID;p.content=i.row[r].content;p=this.updateValidateResult(p);if(p!==null){this.status=e.RULE_ERROR;this.handleMessages4OdataFormatOutput(this.currentParserResult,e.additionalInfoTypeEnum.cell,n.colID,i.rowID,null,null,null);if(this.flags[e.outputFlagsEnum.validationOutput]){if(o===null){o=this.initRow(i.rowID)}o.row.push(p)}if(this.flags[e.outputFlagsEnum.unknownTokensOutput]){this.updateUnknownTokensFromParser();if(this.invalidHeaders[n.colID]!==true){this.headersOfInvalidCells[n.colID]=n}}}if(this.flags[e.outputFlagsEnum.dependenciesOutput]){this.updateDependnciesFromParser()}if(this.flags[e.outputFlagsEnum.rootObjectContextOutput]){this.updateRootObjectContextFromParser()}}}return o};f.prototype.getActionParamBusinessDataArray=function t(e){var s=null;var a=null;var n=null;var i=null;var r=[];for(i in this.actionsMap){if(this.actionsMap.hasOwnProperty(i)){s=this.actionsMap[i];for(n in s.paramMap){if(s.paramMap.hasOwnProperty(n)){a=s.paramMap[n];if(a.colID!==null&&a.colID===e.colID){r.push(a.bdType)}}}}}return r};f.prototype.handleDecisionTableActionParameter=function t(s,a,n,i){var r;var u=this.getActionParamBusinessDataArray({colID:a.row[n].colID});r=this.validateParameter(s,a,n,i,u,this.flags);if(r.hasOwnProperty(e.ROW_RESULT)){return r[e.ROW_RESULT]}};f.prototype.handleDecisionTableOutputParameter=function s(a,n,i,r){var u=a.name;var o=null;var l=r;var p={};var h;var d;var c;t.RuleBody.prototype.handleDecisionTableOutputParameter.call(this,a,n,i,r);if(n.row[i].hasOwnProperty(e.RULE_PARAM_BUSINESS_DATA_TYPE)){o=n.row[i][e.RULE_PARAM_BUSINESS_DATA_TYPE]}else if(a.hasOwnProperty(e.RULE_PARAM_BUSINESS_DATA_TYPE)){o=a[e.RULE_PARAM_BUSINESS_DATA_TYPE]}d=this.getOutputParamBusinessDataType(u,o);if(d===null){p={};p.colID=a.colID;this.status=e.RULE_ERROR;if(this.flags[e.outputFlagsEnum.validationOutput]){if(r===null){r=this.initRow(n.rowID)}r.row.push(p)}}h=this.updateParserIsCollectionFlag(a.name);l=this.validateParameter(a,n,i,r,[d],h);if(l.hasOwnProperty(e.ROW_RESULT)){r=l[e.ROW_RESULT]}if(l.hasOwnProperty(e.PARSER_RESULT)&&this.isParserReturnedErrorMessage(l[e.PARSER_RESULT])===false){var f=l[e.PARSER_RESULT];c=this.valiadteCollectionInfoOnOutputParameter(f,u,undefined);if(c!==null&&this.flags[e.outputFlagsEnum.validationOutput]){p={};p.colID=a.colID;p.status=e.RULE_ERROR;p.errorDetails=c;p.expression=n.row[i].content;p.content=n.row[i].content;this.status=e.RULE_ERROR;if(r===null){r=this.initRow(n.rowID)}r.row.push(p)}}return r};f.prototype.handleDecisionTableAction=function t(s,n,r,u){var o={};var l=n.row[r].content;if(l===undefined||l===null||l===""){return u}var p=this.isActionExists(l);if(p===false){var h=[l];var d=c.getInstance().getMessage("rule_body_validator_action_not_exists",h);this.handleMessages(null,undefined,"rule_body_validator_action_not_exists",h);var f={};f.colID=s.colID;f.status=e.RULE_ERROR;f.errorDetails=d;this.status=e.RULE_ERROR;if(u===null){u=this.initRow(n.rowID)}u.row.push(f)}if(this.flags[e.outputFlagsEnum.dependenciesOutput]&&this.status===e.RULE_SUCCESS){if(n.row[r].hasOwnProperty(e.RULE_CONTENT)){var O=null;if(this.actionsMap.hasOwnProperty(l)===true){O=this.actionsMap[l].vocabulary}var R=i.PROPERTY_NAME_ACTIONS.concat("."+l);o[R]=new a.VocaAction(l,O)}this.depHandler.addDependencies(o)}return u};f.prototype.initResult=function t(){this.rowOutputParamsCnt=0;if((this.ruleType===e.DECISION_TABLE||this.ruleType===e.RULE_SET)&&this.flags[e.outputFlagsEnum.validationOutput]){this.ruleBody.content.rows=[];this.ruleBody.content.headers=[]}};f.prototype.initRowResult=function t(e,s){return null};f.prototype.addRowResult=function t(s){if(this.ruleType===e.DECISION_TABLE||this.ruleType===e.RULE_SET){if(this.flags[e.outputFlagsEnum.validationOutput]&&s!==null){this.ruleBody.content.rows.push(s)}}};f.prototype.validateParameter=function t(a,n,i,r,u,o){var l={};var p=null;var h="";var d="";l.rowResult=r;l.parserResult=null;if(n.row[i].hasOwnProperty(e.RULE_CONTENT)){var f;var O;if(u!==null&&u!==undefined){for(f=0;f<u.length;f++){this.currentParserResult=this.getParserAST(n.row[i].content,s.VALIDATE_MODE,null,u[f],o);l.parserResult=this.currentParserResult;O={};O.expression=n.row[i].content;O.colID=a.colID;O.content=n.row[i].content;O=this.updateValidateResult(O);if(this.flags[e.outputFlagsEnum.isAlias]){if((!a.hasOwnProperty(e.RULE_PARAM_BUSINESS_DATA_TYPE)||a.businessDataType===s.TYPE_ALL)&&this.currentParserResult.hasOwnProperty("actualReturnType")){if(O===null){if(this.aliasOutputBusinessDataType===null){this.aliasOutputBusinessDataType=this.currentParserResult.actualReturnType}}else{if(this.aliasOutputBusinessDataType!==null&&this.aliasOutputBusinessDataType!==this.currentParserResult.actualReturnType){p=[a.name];h="rule_body_validator_alias_output_params_should_have_same_type";d=c.getInstance().getMessage(h,p);this.handleMessages(null,undefined,h,p);O={};O.expression=n.row[i].content;O.colID=a.colID;O.content=n.row[i].content;O.errorDetails=d}}}else{this.aliasOutputBusinessDataType=a.businessDataType}}else{a.businessDataType=u[f]}if(O!==null){this.status=e.RULE_ERROR;this.handleMessages4OdataFormatOutput(this.currentParserResult,e.additionalInfoTypeEnum.cell,O.colID,n.rowID,null,null,null);if(this.flags[e.outputFlagsEnum.validationOutput]){if(l.rowResult===null){l.rowResult=this.initRow(n.rowID)}l.rowResult.row.push(O)}if(this.flags[e.outputFlagsEnum.unknownTokensOutput]){this.updateUnknownTokensFromParser();if(this.invalidHeaders[a.colID]!==true){this.headersOfInvalidCells[a.colID]=a}}}if(this.flags[e.outputFlagsEnum.dependenciesOutput]){this.updateDependnciesFromParser()}if(this.flags[e.outputFlagsEnum.rootObjectContextOutput]){this.updateRootObjectContextFromParser()}}}}return l};f.prototype.initPathPrefix=function t(s){if(s!==null&&s!==undefined){if(s.hasOwnProperty(e.RULE_BODY)){this.ruleBodyPathPrefix=s[e.pathPrefixKeysEnum.ruleBody]}else{this.ruleBodyPathPrefix=o.JSON_PATH_ROOT}if(s.hasOwnProperty(e.EXPLICIT_OUTPUT)){this.outputPathPrefix=s[e.pathPrefixKeysEnum.explicitOutput]}else{this.outputPathPrefix=o.JSON_PATH_ROOT}}else{this.ruleBodyPathPrefix=o.JSON_PATH_ROOT;this.outputPathPrefix=o.JSON_PATH_ROOT}};f.prototype.initFlags=function t(s){if(s!==null&&s!==undefined){if(s.hasOwnProperty(e.ODATA_FORMAT_PAYLOAD)){this.flags[e.ODATA_FORMAT_PAYLOAD]=s[e.ODATA_FORMAT_PAYLOAD]}if(s.hasOwnProperty(e.outputFlagsEnum.validationOutput)){this.flags[e.outputFlagsEnum.validationOutput]=s[e.outputFlagsEnum.validationOutput]}if(s[e.outputFlagsEnum.unknownTokensOutput]){this.flags[e.outputFlagsEnum.unknownTokensOutput]=s[e.outputFlagsEnum.unknownTokensOutput]}if(s[e.outputFlagsEnum.isAlias]){this.flags[e.outputFlagsEnum.isAlias]=s[e.outputFlagsEnum.isAlias]}if(s.hasOwnProperty(e.outputFlagsEnum.dependenciesOutput)){this.flags[e.outputFlagsEnum.dependenciesOutput]=s[e.outputFlagsEnum.dependenciesOutput];this.dependenciesByFlags=s[e.outputFlagsEnum.dependenciesOutput]}if(s.hasOwnProperty(e.outputFlagsEnum.rootObjectContextOutput)){if(s.hasOwnProperty(e.outputFlagsEnum.rootObjectContextOutput)){this.flags[e.outputFlagsEnum.rootObjectContextOutput]=s[e.outputFlagsEnum.rootObjectContextOutput]}}if(this.vocaRulesRootObjectMap&&this.flags[e.outputFlagsEnum.rootObjectContextOutput]===true){this.flags[e.outputFlagsEnum.dependenciesOutput]=true}if(this.flags[e.outputFlagsEnum.dependenciesOutput]){this.depHandler=new n.DependeciesHandler}}};f.prototype.validateOutput=function t(s,a){var n,i;if(s===null){return s}i=this.vocabularyDataProvider.getOutput(a,s,null);if(i===null){i=this.vocabularyDataProvider.getVocaRuleOutput(a,s,null)}if(i===null){var r=[s];n="rule_body_validator_output_not_exists";this.handleMessages4OdataFormatOutput(null,e.additionalInfoTypeEnum.ruleResult,null,null,n,r,this.outputPathPrefix);this.status=e.RULE_ERROR}return i};f.prototype.getIsCollection=function t(){var s=true;if(this.hasOwnProperty(e.HIT_POLICY_PROPERTY)){if(this.hitPolicy===e.FIRST_MATCH){s=false}else if(this.hitPolicy===e.ALL_MATCH){s=true}}return s};f.prototype.getRootObjectContext=function t(){var e={};e.keys=[];e.name=this.rootObjectContext.name;Object.keys(this.rootObjectContext.keysMap).forEach(function(t){e.keys.push(t)});return e};f.prototype.updateInvalidRuleBodyHeaders=function t(){var e=null;if(!this.invalidRuleBody.content.hasOwnProperty("headers")){this.invalidRuleBody.content.headers=[]}for(e in this.headersOfInvalidCells){if(this.headersOfInvalidCells.hasOwnProperty(e)){this.invalidRuleBody.content.headers.push(this.headersOfInvalidCells[e])}}};f.prototype.deactivateParserMessages=function t(a){if(a.hasOwnProperty(e.RULE_BODY_TYPE)&&a[e.RULE_BODY_TYPE]===e.SINGLE_TEXT||this.flags[e.ODATA_FORMAT_PAYLOAD]){this.flags[s.propertiesEnum.raiseError]=false}};f.prototype.reValidateBusinessRule=function t(s,a,n,i){var r={};this.mode=e.RULE_MODE_RE_VALIDATION;this.initValidation();this.initFlags(n);if(this.flags[e.outputFlagsEnum.unknownTokensOutput]&&this.invalidRuleBody!==null){r=this.validateBusinessRule(this.invalidRuleBody,s,a,n,i,null,null)}return r};f.prototype.validateBusinessRule=function t(s,a,n,i,r,u,o){var p={};h.debug("flags "+JSON.stringify(i));this.needDeserializeInput=l.needDeserializeInput(i,s.relVersion,n);this.vocaRulesRootObjectMap=i&&i.vocaRules?i.vocaRules.rootObjectMap:null;this.initPathPrefix(u);this.initFlags(i);this.aliasOutputBusinessDataType=null;this.vocabularyDataProvider=n;this.outputInfo=this.validateOutput(r,a,p);this.actionsMap={};this.deactivateParserMessages(s);this.traverse(s,a,n,o,this.ruleBodyPathPrefix);this.validateRootObjectContextAgainstVocaRules();this.ruleBody.type=this.ruleType;this.ruleBody.hitPolicy=this.hitPolicy;if(this.flags[e.outputFlagsEnum.unknownTokensOutput]){p[e.outputPropertiesEnum.unknownTokens]=this.unknownTokens;this.invalidRuleBody=JSON.parse(JSON.stringify(this.ruleBody));this.updateInvalidRuleBodyHeaders()}if(this.flags[e.outputFlagsEnum.isAlias]){p.isCollection=this.getIsCollection();p.businessDataType=this.aliasOutputBusinessDataType}if(this.flags[e.outputFlagsEnum.validationOutput]){p.status=this.status;if(this.ruleType===e.DECISION_TABLE||this.ruleType===e.RULE_SET){p.ruleBody=this.ruleBody}p.output=this.output}else{p.status=this.status}if(this.flags[e.outputFlagsEnum.dependenciesOutput]&&this.status===e.RULE_SUCCESS&&this.dependenciesByFlags){p.dependencies=this.depHandler.getDependencies();h.debug("getDependencies")}if(this.flags[e.outputFlagsEnum.rootObjectContextOutput]&&this.status===e.RULE_SUCCESS){p[e.outputPropertiesEnum.rootObjectContext]=this.getRootObjectContext();h.debug("getRootObjectContext")}return p};return{RuleBodyValidator:f}},true);
//# sourceMappingURL=ruleBodyValidator.js.map