sap.ui.define(["sap/rules/ui/parser/businessLanguage/lib/parsingBackendMediator","sap/rules/ui/parser/businessLanguage/lib/ASTConvertor","sap/rules/ui/parser/infrastructure/errorHandling/hrfException","sap/rules/ui/parser/infrastructure/messageHandling/lib/responseCollector","sap/rules/ui/parser/businessLanguage/lib/constants","sap/rules/ui/parser/ruleBody/lib/constants","sap/rules/ui/parser/AST/lib/bundleAst","sap/rules/ui/parser/resources/vocabulary/lib/constants"],function(e,t,r,s,n,o,i,a){"use strict";var p=RulesAPI_Ast;var l=p.astOperations;var s=s.ResponseCollector;var e=new e.parsingBackendMediatorLib;function u(e,t,r,s,o,i){this.cellExpression=r;this.headerExpression=e;this.operator=t;this.businessDataType=s;this.vocabulary=o;this.vocaDataProvider=i;this.status=n.statusEnum.SUCCESS;this.convertedHeader={};this.convertedHeader.text=null;this.convertedHeader.AST=null;this.convertedCell={};this.convertedCell.text=null;this.convertedCell.AST=null;this.convertedCondition={};this.convertedCondition.text=null;this.convertedCondition.AST=null;this.convertedOperator={};this.convertedOperator.text=this.operator;this.convertedOperator.AST=null;this.valueHelp=null;this.tokensRequested=false;this.tokens=[];this.headerTokens=[];this.operatorTokens=[];this.cellTokens=[];this.currCursorInfo={};this.needASTResult=false}var h=function e(t){var r=null;if(t&&t.hasOwnProperty(o.expressionProperties.AST)&&t.hasOwnProperty(o.expressionProperties.text)){r={};r[o.expressionProperties.text]=t[o.expressionProperties.text];if(t[o.expressionProperties.AST]){r[o.expressionProperties.AST]=JSON.parse(t[o.expressionProperties.AST].serialize())}else{r[o.expressionProperties.AST]=null}r=JSON.stringify(r)}return r};var d=function e(t){t=t.replace(/(\r\n|\n|\r|\t|\f)/gm," ");return JSON.parse(t)};var c=function e(t,r,s){var n="";if(t){n+=t}if(s){n+=" "+s}if(r){n+=" "+r}return n};var v=function e(t,r,s){var n,o=0,i=r.length;if(t){o=t.length+1;i=r.length-t.length-1;if(s){o+=s.length+1;i-=s.length+1}}n=r.substr(o,i);return n};var E=function e(t){var r;var s;var o=false;if(t){r=parseInt(t.replace(/\./g,""),10);s=parseInt(n.supportedVersions.NEW_AST.replace(/\./g,""),10);o=r>=s}return o};var f=function e(t,r,s){var o=false;var i=s?s.getTermModes():null;if(E(r)){if(t&&(t[n.propertiesEnum.locale]&&t[n.propertiesEnum.locale][n.propertiesEnum.convert]&&t[n.propertiesEnum.locale][n.propertiesEnum.convert][n.propertiesEnum.source]===n.CODE_TEXT||t.hasOwnProperty(n.propertiesEnum.termMode)&&t[n.propertiesEnum.termMode].hasOwnProperty(n.propertiesEnum.convert)&&t[n.propertiesEnum.termMode][n.propertiesEnum.convert]&&t[n.propertiesEnum.termMode][n.propertiesEnum.convert][n.propertiesEnum.source]===n.CODE_TEXT)){o=true}else if(!(t&&t.hasOwnProperty(n.propertiesEnum.locale)&&t[n.propertiesEnum.locale].hasOwnProperty(n.propertiesEnum.convert)||t&&t.hasOwnProperty(n.propertiesEnum.termMode)&&t[n.propertiesEnum.termMode].hasOwnProperty(n.propertiesEnum.convert))&&i&&i.indexOf(a.TermModeRelated.TERM_MODE_BY_DESCRIPTION)===-1){o=true}}return o};var x=function e(t,r){var s=false;if(E(r)&&t&&(t[n.propertiesEnum.locale]&&t[n.propertiesEnum.locale][n.propertiesEnum.convert]&&t[n.propertiesEnum.locale][n.propertiesEnum.convert][n.propertiesEnum.target]===n.CODE_TEXT||t.hasOwnProperty(n.propertiesEnum.termMode)&&t[n.propertiesEnum.termMode].hasOwnProperty(n.propertiesEnum.convert)&&t[n.propertiesEnum.termMode][n.propertiesEnum.convert]&&t[n.propertiesEnum.termMode][n.propertiesEnum.convert][n.propertiesEnum.target]===n.CODE_TEXT)){s=true}return s};u.prototype.deserializeExpressionParts=function e(){this.headerExpression=this.headerExpression?d(this.headerExpression).text:null;this.cellExpression=this.cellExpression?d(this.cellExpression).text:null;this.operator=this.operator?d(this.operator).text:null};u.prototype.getParserAST=function t(o,i,a,p,l){function u(e){if(e===null||e===undefined||e===""){return true}return false}var h=e.parseInputRT(o,i,this.vocaDataProvider,a,p,this.vocabulary,l);if(h===undefined||h===null&&u(o)===false){s.getInstance().addMessage("error_in_parsing_expression",[o]);throw new r.HrfException("error_in_parsing_expression: "+o,false)}if(i===e.PARSE_MODE){if(h!==null&&h.status===n.statusEnum.ERROR){throw new r.HrfException("",false)}}return h};u.prototype.getParserConvertedExpression=function e(t){return t[o.parserResultEnum.convertedExpression]};u.prototype.hasParserConvertedExpression=function e(t){if(t.status===n.statusEnum.SUCCESS){if(!t.hasOwnProperty(n.propertiesEnum.convertedExpression)){this.status=n.statusEnum.ERROR}else{return true}}return false};u.prototype.validateAndConvert=function e(r,i){var a;var p;var u;if(r.hasOwnProperty(n.propertiesEnum.tokens)&&r[n.propertiesEnum.tokens]===true){this.tokensRequested=true}function d(e){var t={};if(this.convertedHeader.text&&e>this.convertedHeader.text.length){t.position=e-this.convertedHeader.text.length-this.convertedOperator.text.length-2;t.expressionPart=o.expressionParts.cell}else{t.position=e;t.expressionPart=o.expressionParts.header}return t}function E(e){var t={};if(e){if(e.hasOwnProperty("cursorPosition")&&e.cursorPosition!==undefined&&e.cursorPosition!==null){t.cursorInfo=d.call(this,e.cursorPosition)}s.getInstance().addMessage(e.errorID,undefined,null,t,e.errorDetails)}}function T(){var e={};e.status=this.status;if(this.status===n.statusEnum.SUCCESS){if(this.convertedCell.text||this.convertedHeader.text){e.converted={};if(this.needASTResult){e.converted.header=h(this.convertedHeader);e.converted.fixedOperator=h(this.convertedOperator);e.converted.cell=h(this.convertedCell)}else{e.converted.header=this.convertedHeader.text;e.converted.fixedOperator=this.convertedOperator.text;e.converted.cell=this.convertedCell.text}}e.actualReturnType=this.actualReturnType;if(this.valueHelp){e.valueHelp=this.valueHelp}}if(this.tokensRequested){e.tokens={};e.tokens.header=this.headerTokens;e.tokens.fixedOperator=this.operatorTokens;e.tokens.cell=this.cellTokens}return e}function m(){if(this.operator){this.operatorTokens=this.getParserAST(this.operator,n.TOKEN_TYPES,null,null,r)}else{this.operatorTokens=[]}var e=0;var t=0;var s=0;if(this.headerExpression){e=this.headerExpression.length}if(this.operator){t=this.operator.length+1}if(this.cellExpression){s=1}var o=e+t+s;var i=0;var a=this.tokens;var p=false;var l=0;for(l=0;l<a.length;++l){if(a[l].start===o){i=l;p=true;break}if(a[l].start<o&&o<=a[l].end){i=l;a[l].start=o;p=true;break}if(a[l].end<o){continue}}if(p){for(l=i;l<a.length;++l){a[l].start-=o;a[l].end-=o;this.cellTokens.push(a[l])}}}function S(e,r,s){var o;var i=null;var a={};var p=null;var l={};a.text=null;a.AST=null;o=this.getParserAST(e,n.VALIDATE_MODE,null,r,s);if(this.tokensRequested){if(o.tokens){i=o.tokens}else{i=[]}}if(o.status===n.statusEnum.SUCCESS){this.actualReturnType=o.actualReturnType;if(o.valueHelp){this.valueHelp=o.valueHelp}if(o.hasOwnProperty(n.propertiesEnum.convertedExpression)){a.text=this.getParserConvertedExpression(o);if(this.needASTResult){p=new t.ASTConvertor(o.model);a.AST=p.getAST()}}}else{E.call(this,o);this.status=n.statusEnum.ERROR}l.converted=a;l.tokens=i;return l}this.needASTResult=x(r,i);if(f(r,i,this.vocaDataProvider)){this.deserializeExpressionParts()}var O={};if(this.headerExpression){O=S.call(this,this.headerExpression,n.TYPE_SINGLE_EXPRESSION,r);this.convertedHeader=O.converted;this.headerTokens=O.tokens}if(this.status===n.statusEnum.SUCCESS&&this.cellExpression){a=c(this.headerExpression,this.cellExpression,this.convertedOperator.text);p=this.businessDataType||n.TYPE_BOOLEAN_ENHANCED;O=S.call(this,a,p,r);this.convertedCondition=O.converted;this.tokens=O.tokens;if(this.status===n.statusEnum.SUCCESS&&this.convertedCondition&&this.convertedCondition.text){this.convertedCell.text=v(this.convertedHeader.text,this.convertedCondition.text,this.convertedOperator.text);if(this.needASTResult){var C=l.split(this.convertedHeader.AST,this.convertedCondition.AST,t.ASTConvertor.operatorsMap[this.convertedOperator.text]);if(C){this.convertedOperator.AST=C.operator;this.convertedCell.AST=C.rest}else{this.convertedOperator.AST=this.convertedOperator.text?l.buildOperator(t.ASTConvertor.operatorsMap[this.convertedOperator.text]):null;this.convertedCell.AST=null}}}}if(this.tokensRequested){m.call(this)}u=T.call(this);return u};return{DecisionTableCell:u,isASTVersion:E,needDeserializeInput:f,needASTResult:x,serializeExpression:h,deserializeExpression:d,concatToDecisionTableCondition:c,splitDecisionTableCondition:v}},true);
//# sourceMappingURL=decisionTableCell.js.map