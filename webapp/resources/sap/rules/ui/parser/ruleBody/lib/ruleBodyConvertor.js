sap.ui.define(["sap/rules/ui/parser/ruleBody/lib/ruleBodyValidator","sap/rules/ui/parser/ruleBody/lib/constants","sap/rules/ui/parser/businessLanguage/lib/constants","sap/rules/ui/parser/infrastructure/util/utilsBase","sap/rules/ui/parser/businessLanguage/lib/valueHelpValidator","sap/rules/ui/parser/ruleBody/lib/decisionTableCell","sap/rules/ui/parser/businessLanguage/lib/ASTConvertor","sap/rules/ui/parser/AST/lib/bundleAst","sap/base/Log"],function(e,t,s,r,a,o,i,u,n){"use strict";var l=RulesAPI_Ast;var p=l.astOperations;var d=new r.utilsBaseLib;function h(t){n.debug("CTOR - Rule Convertor");this.oDataRule=t;e.RuleBodyValidator.call(this);this.decisionTableData=t?JSON.parse(JSON.stringify(t)):null;this.ruleValueHelpInfoArray=[];this.needASTResult=false}h.prototype=Object.create(e.RuleBodyValidator.prototype);h.prototype.constructor=h;h.prototype.getSerializedExpressionAndAST=function e(t,s){var r={};r.convertedData={};r.serializedData=t;if(this.needASTResult){var a=new i.ASTConvertor(s);r.convertedData.AST=a.getAST();r.convertedData.text=t;r.serializedData=o.serializeExpression(r.convertedData)}return r};h.prototype.getConvertedData=function e(t,s,r){t[r]=s;return t};h.prototype.addParserResults=function e(s,r,a){var o={};o.status=a;if(r){o.converted=r}d.setJsonValueAccordingPath(this.decisionTableData,s,t.decisionTableDataOutputPropEnum.parserResults,o)};h.prototype.hasParserConvertedExpression=function e(){if(this.currentParserResult.status===s.statusEnum.SUCCESS){if(!this.currentParserResult.hasOwnProperty(t.parserResultEnum.convertedExpression)){if(!this.flags[t.outputFlagsEnum.ASTOutput]){this.status=t.RULE_ERROR}}else{return true}}return false};h.prototype.getParserConvertedExpression=function e(){return this.currentParserResult[t.parserResultEnum.convertedExpression]};function c(e,t){var s=0;var r=0;var a=false;for(s=0;s<e.length;++s){a=false;for(r=0;r<t.length;++r){if(e[s]===t[r]){a=true;break}}if(a===false){t.push(e[s])}}}function E(e,t){var r=0;var o=-1;for(r=0;r<e.length;++r){o=a.getValueHelpIndexInInfoArray(e[r][s.propertiesEnum.id],t);if(o===-1){t.push(e[r])}else{c(e[r][s.propertiesEnum.values],t[o][s.propertiesEnum.values])}}}h.prototype.handleTextCondition=function s(r,a,o){e.RuleBodyValidator.prototype.handleTextCondition.call(this,r,a,o);if(this.status===t.RULE_SUCCESS&&this.hasParserConvertedExpression()){this.ruleBodyCopy.content.condition=this.getParserConvertedExpression()}};h.prototype.handleTextOutputParameter=function s(r,a,o){e.RuleBodyValidator.prototype.handleTextOutputParameter.call(this,r,a,o);if(this.status===t.RULE_SUCCESS&&this.hasParserConvertedExpression()){r.content=this.getParserConvertedExpression()}};h.prototype.handleTextActionParameter=function s(r,a,o,i){e.RuleBodyValidator.prototype.handleTextActionParameter.call(this,r,a,o,i);if(this.status===t.RULE_SUCCESS&&this.hasParserConvertedExpression()){r.content=this.getParserConvertedExpression()}};h.prototype.handleDecisionTableCondition=function r(a,u,n,l){var d,h;var c={};var f={};l=e.RuleBodyValidator.prototype.handleDecisionTableCondition.call(this,a,u,n,l);if(this.hasParserConvertedExpression()&&this.invalidHeaders[a.colID]!==true){d=this.getParserConvertedExpression();var v=a.hasOwnProperty(t.afterConversionParts.fixedOperator)?a.fixedOperator.operator:null;h=this.splitDecisionTableCondition(a.convertedExpression,d,v);if(this.flags[t.outputFlagsEnum.oDataOutput]){if(this.needASTResult){var P=new i.ASTConvertor(this.currentParserResult.model);var g=P.getAST();if(a.AST){var m=p.split(a.AST,g,i.ASTConvertor.operatorsMap[v]);f.AST=m?m.rest:null}else{f.AST=g}f.text=h;h=o.serializeExpression(f)}c=this.getConvertedData(c,h,t.decisionTableExpressionParts.content);this.addParserResults(u.row[n].inputModelPath,c,this.currentParserResult.status)}else if(this.status===t.RULE_SUCCESS){a.expression=a.convertedExpression;u.row[n].content=h}}else if(this.flags[t.outputFlagsEnum.oDataOutput]){this.addParserResults(u.row[n].inputModelPath,null,s.statusEnum.ERROR)}if(this.flags[t.outputFlagsEnum.ASTOutput]&&this.currentParserResult.status===s.statusEnum.SUCCESS){c=this.getConvertedData(c,this.currentParserResult.model,t.decisionTableExpressionParts.astOutput);this.addParserResults(u.row[n].inputModelPath,c,this.currentParserResult.status)}if(this.flags[s.propertiesEnum.valueHelp]&&this.flags[s.propertiesEnum.valueHelp].hasOwnProperty(s.propertiesEnum.collectInfo)&&this.flags[s.propertiesEnum.valueHelp][s.propertiesEnum.collectInfo]===true&&this.currentParserResult.status===s.statusEnum.SUCCESS&&this.currentParserResult[s.propertiesEnum.valueHelp]){E(this.currentParserResult[s.propertiesEnum.valueHelp][s.propertiesEnum.info],this.ruleValueHelpInfoArray)}return l};h.prototype.handleDecisionTableActionParameter=function s(r,a,o,i){i=e.RuleBodyValidator.prototype.handleDecisionTableActionParameter.call(this,r,a,o,i);if(this.status===t.RULE_SUCCESS&&this.hasParserConvertedExpression()){a.row[o].content=this.getParserConvertedExpression()}return i};h.prototype.handleDecisionTableOutputParameter=function r(a,o,i,u){var n={};var l;var p;u=e.RuleBodyValidator.prototype.handleDecisionTableOutputParameter.call(this,a,o,i,u);if(this.hasParserConvertedExpression()&&this.invalidHeaders[a.colID]!==true){l=this.getParserConvertedExpression();if(this.flags[t.outputFlagsEnum.oDataOutput]){p=this.getSerializedExpressionAndAST(l,this.currentParserResult.model);l=p.serializedData;n=this.getConvertedData(n,l,t.decisionTableExpressionParts.content);this.addParserResults(o.row[i].inputModelPath,n,this.currentParserResult.status)}else if(this.status===t.RULE_SUCCESS){o.row[i].content=l}}else if(this.flags[t.outputFlagsEnum.oDataOutput]){this.addParserResults(o.row[i].inputModelPath,null,s.statusEnum.ERROR)}if(this.flags[t.outputFlagsEnum.ASTOutput]&&this.currentParserResult.status===s.statusEnum.SUCCESS){n=this.getConvertedData(n,this.currentParserResult.model,t.decisionTableExpressionParts.astOutput);this.addParserResults(o.row[i].inputModelPath,n,this.currentParserResult.status)}return u};h.prototype.handleConditionHeader=function r(a){var u={};var n;var l={};e.RuleBodyValidator.prototype.handleConditionHeader.call(this,a);if(this.hasParserConvertedExpression()){n=this.getParserConvertedExpression();if(this.flags[t.outputFlagsEnum.oDataOutput]){a.convertedExpression=n;var d=this.getSerializedExpressionAndAST(n,this.currentParserResult.model);n=d.serializedData;u=this.getConvertedData(u,n,t.decisionTableExpressionParts.expression);if(this.needASTResult){a.AST=d.convertedData.AST}if(a.hasOwnProperty(t.afterConversionParts.fixedOperator)){if(this.needASTResult){l.text=a.fixedOperator.operator;l.AST=a.fixedOperator.operator?p.buildOperator(i.ASTConvertor.operatorsMap[l.text]):null;n=o.serializeExpression(l);u=this.getConvertedData(u,n,t.decisionTableExpressionParts.fixedOperator);a.AST=d.convertedData.AST}else if(this.needDeserializeInput){u=this.getConvertedData(u,a.fixedOperator.operator,t.decisionTableExpressionParts.fixedOperator)}}this.addParserResults(a.inputModelPath,u,this.currentParserResult.status)}else if(this.status===t.RULE_SUCCESS){a.convertedExpression=n}}else if(this.flags[t.outputFlagsEnum.oDataOutput]){this.addParserResults(a.inputModelPath,null,this.currentParserResult.status)}if(this.flags[t.outputFlagsEnum.ASTOutput]&&this.currentParserResult.status===s.statusEnum.SUCCESS){u=this.getConvertedData(u,this.currentParserResult.model,t.decisionTableExpressionParts.astOutput);this.addParserResults(a.inputModelPath,u,this.currentParserResult.status)}if(this.flags[s.propertiesEnum.valueHelp]&&this.flags[s.propertiesEnum.valueHelp].hasOwnProperty(s.propertiesEnum.collectInfo)&&this.flags[s.propertiesEnum.valueHelp][s.propertiesEnum.collectInfo]===true&&this.currentParserResult.status===s.statusEnum.SUCCESS&&this.currentParserResult[s.propertiesEnum.valueHelp]){E(this.currentParserResult[s.propertiesEnum.valueHelp][s.propertiesEnum.info],this.ruleValueHelpInfoArray)}};h.prototype.finalizeResult=function e(s){var r;if(!this.flags[t.outputFlagsEnum.oDataOutput]){for(r=0;r<s.content.headers.length;r++){if(s.content.headers[r].hasOwnProperty(t.parserResultEnum.convertedExpression)){delete s.content.headers[r].convertedExpression}}}};h.prototype.initFlags=function r(a){e.RuleBodyValidator.prototype.initFlags.call(this,a);if(a!==null&&a!==undefined){if(a.hasOwnProperty(t.outputFlagsEnum.conversionOutput)){this.flags[t.outputFlagsEnum.conversionOutput]=a[t.outputFlagsEnum.conversionOutput]}else if(a.hasOwnProperty(t.outputFlagsEnum.locale)&&a[t.outputFlagsEnum.locale].hasOwnProperty(t.localeEnum.convert)&&a[t.outputFlagsEnum.locale][t.localeEnum.convert]){this.flags[t.outputFlagsEnum.locale]=a[t.outputFlagsEnum.locale]}if(a.hasOwnProperty(s.propertiesEnum.termMode)&&a[s.propertiesEnum.termMode].hasOwnProperty(s.propertiesEnum.convert)&&a[s.propertiesEnum.termMode][s.propertiesEnum.convert]){this.flags[s.propertiesEnum.termMode]=a[s.propertiesEnum.termMode]}if(this.oDataRule){this.flags[t.outputFlagsEnum.oDataOutput]=true}else{this.flags[t.outputFlagsEnum.oDataOutput]=false}this.flags[t.outputFlagsEnum.ASTOutput]=a.hasOwnProperty(t.outputFlagsEnum.ASTOutput)?a[t.outputFlagsEnum.ASTOutput]:false;if(a&&a.hasOwnProperty(s.propertiesEnum.valueHelp)){this.flags[s.propertiesEnum.valueHelp]={};this.flags[s.propertiesEnum.valueHelp]=a[s.propertiesEnum.valueHelp]}}};h.prototype.convert=function e(r,a,i,u,n,l,p){this.needASTResult=o.needASTResult(u,r.relVersion);var d=this.validateBusinessRule(r,a,i,u,n,l,p);if(this.ruleValueHelpInfoArray.length>0){d[s.propertiesEnum.valueHelp]={};d[s.propertiesEnum.valueHelp][s.propertiesEnum.info]=this.ruleValueHelpInfoArray}if(this.flags[t.outputFlagsEnum.oDataOutput]){d.decisionTableData=this.decisionTableData}else{if(this.status===t.RULE_SUCCESS){d.convertedRuleBody=this.ruleBodyCopy}else{d.convertedRuleBody=null}}return d};return{RuleBodyConvertor:h}},true);
//# sourceMappingURL=ruleBodyConvertor.js.map