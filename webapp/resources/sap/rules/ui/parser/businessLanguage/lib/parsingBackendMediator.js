sap.ui.define(["sap/rules/ui/parser/businessLanguage/lib/constants","sap/rules/ui/parser/resources/dependencies/lib/constantsBase","sap/rules/ui/parser/businessLanguage/lib/parseModel","sap/rules/ui/parser/businessLanguage/lib/parseUtils","sap/rules/ui/parser/resources/vocabulary/lib/parameterRuntimeServices","sap/rules/ui/parser/businessLanguage/lib/IDPLexer","sap/rules/ui/parser/businessLanguage/lib/IDPParser","sap/rules/ui/parser/businessLanguage/lib/autoCompleteUtils","sap/rules/ui/parser/businessLanguage/lib/parserTokens","sap/rules/ui/parser/businessLanguage/lib/antlr3_all_min","sap/rules/ui/parser/resources/vocabulary/lib/vocabularyDataProviderFactory","sap/rules/ui/parser/businessLanguage/lib/conversionUtils","sap/rules/ui/parser/businessLanguage/lib/valueHelpValidator","sap/base/Log"],function(e,r,t,n,s,a,o,u,i,p,l,E,c,d){"use strict";var g=new n.parseUtilsLib;var v=new t.parseModelLib;var m=new u.autoCompleteUtilsLib;var f=new l.vocaDataProviderFactoryLib;var T=new E.conversionUtilsLib;function y(){}y.prototype.getRELType=function r(t,n){var s;s=t===undefined||t===null?e.TYPE_ALL:t;if(n!==null&&n!==undefined&&n[e.propertiesEnum.isCollection]===true){s=g.getCollectionRelTypeFromBusinessDT(s)}return s};y.prototype.parseExpression=function(r,t,n,s,u,i,l,E){function f(r,t){var n="";var s=t&&t.hasOwnProperty(e.propertiesEnum.locale);var a=t&&t.hasOwnProperty(e.propertiesEnum.locale)&&t[e.propertiesEnum.locale].hasOwnProperty(e.propertiesEnum.convert)&&t[e.propertiesEnum.locale][e.propertiesEnum.convert].hasOwnProperty(e.propertiesEnum.source)&&t[e.propertiesEnum.locale][e.propertiesEnum.convert].hasOwnProperty(e.propertiesEnum.target)&&t[e.propertiesEnum.locale][e.propertiesEnum.convert][e.propertiesEnum.source]===e.CODE_TEXT&&t[e.propertiesEnum.locale][e.propertiesEnum.convert][e.propertiesEnum.target]===e.DISPLAY_TEXT;if(!s||a){var o=false;var u=false;var i="";var p="";if(typeof r!=="string"){n=r}else{for(p in r){if(r.hasOwnProperty(p)){if(!r[p]){continue}u=false;switch(r[p]){case"'":o=!o;break;case",":if(o===false){u=true}break}if(u===true){i+=";"}else{i+=r[p]}}}n=i}}else{n=r}return n}try{d.debug("ParsingBackendMediator expression to parse: "+r);var y=v.createModelManger();y.vocaRTServ=n;y.vocabulary=i;y.mode=t;y.paramServ=s;y.flags=l===undefined||l===null?{}:l;u=this.getRELType(u,l);r=f(r,l);var O=r;if(r!==null&&r!==undefined){r=r.toString();r=r.replace(/(\r\n|\n|\r)/gm," ");r=r.replace(/\\/g,"\\\\")}if(r===null||r===undefined||g.isBlank(r)){var P={};P.status=e.statusEnum.SUCCESS;if(t===e.TOKEN_TYPES||y.flags.hasOwnProperty(e.propertiesEnum.tokens)&&y.flags[e.propertiesEnum.tokens]===true){P.tokens=[];if(r!==null&&r!==undefined){var b=O.length;var R=new g.TokenInfo(O,e.tokenTypesEnum.whitespace,null,0,b);P.tokens.push(R)}}if(t===e.VALIDATE_MODE||t===e.PARSE_MODE){P.errorDetails=null;P.model=null;P.cursorPosition=null;P.actualReturnType=e.TYPE_ALL;if(y.flags.hasOwnProperty(e.propertiesEnum.conversionOutput)&&(y.flags[e.propertiesEnum.conversionOutput]===e.conversionOutputEnum.toKeys||y.flags[e.propertiesEnum.conversionOutput]===e.conversionOutputEnum.toDescriptions)||l&&l.hasOwnProperty(e.propertiesEnum.locale)&&l[e.propertiesEnum.locale].hasOwnProperty(e.propertiesEnum.convert)){P.convertedExpression=O}return P}else if(t===e.TOKEN_TYPES){return P}}y.expression=r;var k=new p.antlr.runtime.ANTLRStringStream(r);var h=new a(k);h.displayRecognitionError=function(e,r){var t=h.getErrorHeader(r);var n=h.getErrorMessage(r,e);g.handleWarning(t+" "+n)};var D=new p.antlr.runtime.CommonTokenStream(h);var w=new o(D);w.mode=t;w.displayRecognitionError=function(e,r){var t=w.getErrorHeader(r);var n=w.getErrorMessage(r,e);g.handleWarning(t+" "+n)};var M={};var A={};switch(t){case e.AUTOCOMPLETE_MODE:case e.AUTOCOMPLETE_MODE_LOWERCASE:d.debug("mode autocomplete");M.suggs=JSON.parse(m.getNextSuggestions(r,h,w,n,u,E));if(y.flags.hasOwnProperty(e.propertiesEnum.tokens)&&y.flags[e.propertiesEnum.tokens]===true){M.tokens=g.buildTokenTypes(w,O,y)}d.debug("ParsingBackendMediator: autocomplete responseObject: "+M);return M;case e.PARSE_MODE:case e.VALIDATE_MODE:d.debug("mode validate");g.parseWithValidation(h,w,u,v.getModelManger());M=v.getModelManger().parseResult.getParseResults();if(y.flags.hasOwnProperty(e.propertiesEnum.tokens)&&y.flags[e.propertiesEnum.tokens]===true){M.tokens=g.buildTokenTypes(w,O,y)}if(y.flags.hasOwnProperty(e.propertiesEnum.valueHelp)&&M.status===e.statusEnum.SUCCESS){c.handleExternalValueHelp(w,O,y,M)}if(T.needsConversion(y)){A=M.tokens||g.buildTokenTypes(w,O,y);M.convertedExpression=T.convert(n,i,y,A,O)}if(y.flags.hasOwnProperty(e.propertiesEnum.rootObjectContext)&&y.flags[e.propertiesEnum.rootObjectContext]===true){M.rootObjectContext=null;if(M.status===e.statusEnum.SUCCESS){M.rootObjectContext={};M.rootObjectContext.name=y[e.propertiesEnum.rootObjectContext].name;M.rootObjectContext.associations=y[e.propertiesEnum.rootObjectContext].assocs}}return M;case e.TOKEN_TYPES:d.debug("mode token types");g.parseWithValidation(h,w,u,v.getModelManger());M.tokens=g.buildTokenTypes(w,O,y);M.status=e.statusEnum.SUCCESS;return M;default:g.handleError("Unknown mode",null,v.getModelManger());M=v.getModelManger().parseResult.getParseResults();return M}}catch(r){v.getModelManger().parseResult.status=e.statusEnum.ERROR;d.error("ParsingBackendMediator error: "+r);return v.getModelManger().parseResult.getParseResults()}};y.prototype.convertExpressionToKeys=function(r,t,n,s,a,o){var u={};if(o){u=o}u[e.propertiesEnum.conversionOutput]=e.conversionOutputEnum.toKeys;return this.parseExpression(r,e.VALIDATE_MODE,t,n,s,a,u)};y.prototype.convertExpressionToDescriptions=function(r,t,n,s,a,o){var u={};if(o){u=o}u[e.propertiesEnum.conversionOutput]=e.conversionOutputEnum.toDescriptions;return this.parseExpression(r,e.VALIDATE_MODE,t,n,s,a,u)};y.prototype.parseInputRT=function(e,r,t,n,a,o,u){var i=null;if(n){i=new s.ParameterRuntimeServices(n,t,o)}return this.parseExpression(e,r,t,i,a,o,u)};y.prototype.parseInput=function(e,r,t,n,s,a,o){var u=null;u=f.getVocabularyDataProvider();return this.parseInputRT(e,r,u,n,s,a,o)};y.prototype.isReservedWord=function(e){var r=v.getModelManger();r.clearModelData();r.parseResult.clear();e=e.split(" ")[0];var t=new p.antlr.runtime.ANTLRStringStream(e);var n=new a(t);var s=new p.antlr.runtime.CommonTokenStream(n);var u=new o(s);var l=true;u.reportError=function(e){if(u.input.tokens.length>0&&(u.input.tokens[0].type===i.NAVIGATION||u.input.tokens[0].type===i.TYPEATTRIBUTE||u.input.tokens[0].type===i.INT||u.input.tokens[0].type===i.STRING||u.input.tokens[0].type===i.ANYCHAR||u.input.tokens[0].type===undefined||u.input.tokens[0].type===null)){l=false}};n.reportError=function(e){if(u.input.tokens.length>0&&(u.input.tokens[0].type===i.NAVIGATION||u.input.tokens[0].type===i.TYPEATTRIBUTE||u.input.tokens[0].type===i.INT||u.input.tokens[0].type===i.STRING||u.input.tokens[0].type===undefined||u.input.tokens[0].type===null)){l=false}};u.dummyRule();return l};y.prototype.validateAndGetExpressionActualReturnTypeRT=function(t,n,s,a,o,u){var i={type:null,dataObject:null,businessDataType:null,unknownTokens:{},isCollection:false,errorDetails:null,isValid:false,dependenciesOutput:{}};if(a===undefined){a=null}var p;if(u){p=u}else{p={};p[e.propertiesEnum.unknownTokens]=true;p[r.PROPERTY_NAME_DEPENDENCIES_OUTPUT]=true}if(o!==undefined&&o===false){p[e.propertiesEnum.raiseError]=false}var l=this.parseExpression(n,e.VALIDATE_MODE,t,a,e.TYPE_ALL,s,p);if(l.actualReturnType){d.debug(l.actualReturnType)}if(l.status===e.statusEnum.ERROR){i.errorDetails=l.errorDetails;i.unknownTokens=l[e.propertiesEnum.unknownTokens];return i}i.type=l.actualReturnType;i.dataObject=l.hasOwnProperty(e.attributesNamesEnum.dataObject)?l.dataObject:null;i.isValid=true;var E=g.getBusinessDTFromRelType(i.type);i.isCollection=E[e.propertiesEnum.isCollection];i.businessDataType=E[e.propertiesEnum.businessType];i.dependenciesOutput=l.hasOwnProperty(r.PROPERTY_NAME_DEPENDENCIES_OUTPUT)?l.dependenciesOutput:{};if(l.hasOwnProperty(e.propertiesEnum.convertedExpression)){i.convertedExpression=l.convertedExpression}return i};y.prototype.validateAndGetExpressionActualReturnType=function(e,r,t,n,a,o){var u=null;var i=null;u=f.getVocabularyDataProvider();if(e){if(n){i=new s.ParameterRuntimeServices(n,u,t)}}return this.validateAndGetExpressionActualReturnTypeRT(u,r,t,i,a,o)};y.prototype.validateExpression=function(e,r,t,n,s,a){var o=this.parseInput(r,n,e,a,s,t);var u={status:o.status,errorDetails:o.errorDetails};return u};y.prototype.validateAndGetExpressionModel=function(e,r,t,n,s,a){var o=this.parseInput(r,n,e,a,s,t);return o.model};y.prototype.getRELDependencies=function(t,n,s,a){var o={};o[r.PROPERTY_NAME_DEPENDENCIES_OUTPUT]=true;var u=this.parseInput(n,e.VALIDATE_MODE,t,a,e.TYPE_ALL,s,o);return u[r.PROPERTY_NAME_DEPENDENCIES_OUTPUT]};y.prototype.handleParse=function(r){if(!r.hasOwnProperty("expression")){return v.getModelManger().parseResult.getParseResults()}if(!r.hasOwnProperty("vocabulary")){r.vocabulary=null}if(!r.hasOwnProperty("mode")){r.mode=e.VALIDATE_MODE}if(!r.hasOwnProperty("returnType")){r.returnType=e.TYPE_ALL}if(!r.hasOwnProperty("parameters")){r.parameters=null}if(!r.hasOwnProperty(e.propertiesEnum.flags)){r.flags={}}return this.parseInput(r.expression,r.mode,r.connection,r.parameters,r.returnType,r.vocabulary,r.flags)};return{parsingBackendMediatorLib:y}},true);
//# sourceMappingURL=parsingBackendMediator.js.map