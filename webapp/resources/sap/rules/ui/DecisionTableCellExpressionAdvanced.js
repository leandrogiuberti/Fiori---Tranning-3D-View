/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/rules/ui/Utils","sap/rules/ui/ExpressionAdvanced","sap/rules/ui/Constants","sap/ui/core/library","./DecisionTableCellExpressionAdvancedRenderer"],function(jQuery,e,t,i,o,r,s){"use strict";var a=i.extend("sap.rules.ui.DecisionTableCellExpressionAdvanced",{metadata:{library:"sap.rules.ui",properties:{headerValue:{type:"string",defaultValue:"",bindable:"bindable"},fixedOperator:{type:"string",defaultValue:"",bindable:"bindable"},type:{type:"sap.rules.ui.ExpressionType",defaultValue:e.ExpressionType.BooleanEnhanced,bindable:"bindable"}}},renderer:s});a.prototype.validateExpression=function(){var e=this.codeMirror?this.codeMirror.getValue():this.getValue();if(e){var t=this.getHeaderValue()+" "+this.getFixedOperator()+" "+e;i.prototype.validateExpression.apply(this,[t])}else{this.setValueStateText("")}};a.prototype.init=function(){i.prototype.init.apply(this,arguments);this.bFlagForChangeBeforeBlur=false};a.prototype.onAfterRendering=function(){i.prototype.onAfterRendering.apply(this,arguments);sap.ui.require(["sap/rules/ui/codemirror/addon/hint/show-hint","sap/rules/ui/codemirror/mode/hdf/hdf","sap/rules/ui/codemirror/addon/display/placeholder","sap/rules/ui/codemirror/addon/mh/mark-selection","sap/rules/ui/codemirror/addon/hint/hdf-hint","sap/rules/ui/codemirror/addon/closeBrackets/closebrackets"],()=>{this.codeMirror.options.fixedOperator=this.getFixedOperator();this.codeMirror.options.headerValue=this.getHeaderValue();this.codeMirror.options.filterOutStructuredCond=true;this.oDecisionTableCell=this.getParent()&&this.getParent().getParent()?this.getParent().getParent():null;this._handleValidation();if(jQuery(document.getElementById(this.getId())).closest("td").next().width()){this._showPopUp()}if(this.oDecisionTableCell){var e=this.oDecisionTableCell.getValueStatePath();var t=this.oDecisionTableCell.getModel("dtModel");var i=this.oDecisionTableCell.getAggregation("_displayedControl");if(i){t.setProperty(e.slice(8),r.ValueState.None)}}this.createEventListeners()})};a.prototype._handleValidation=function(){this.validateExpression();this._showErrorMessage();if(this.getProperty("valueStateText")&&this.codeMirror){this.codeMirror.options.expressionEditor._showPopUp()}};a.prototype._processValidationResult=function(t){i.prototype._processValidationResult.apply(this,arguments);if(this.oDecisionTableCell){var o=this.oDecisionTableCell.getValueStateTextPath();var s=this.oDecisionTableCell.getValueStatePath();var a=this.oDecisionTableCell.getModel("dtModel");var n=this.oDecisionTableCell.getAggregation("_displayedControl");if(n&&t.status===e.ValidationStatus.Error){var l=this.getValueStateText();a.setProperty(o.slice(8),l);if(!this.oDecisionTableCell._oPopover||!this.oDecisionTableCell._oPopover.isOpen()){a.setProperty(s.slice(8),r.ValueState.Error)}else{a.setProperty(s.slice(8),r.ValueState.None)}this.setProperty("valueStateText",l)}else if(n){a.setProperty(o.slice(8),"null");a.setProperty(s.slice(8),r.ValueState.None);this.setProperty("valueStateText","")}}};a.prototype.exit=function(){i.prototype.exit.apply(this,arguments);this._handleValidation();this._closePopUp();this.pop=null;var e=this.codeMirror;if(e&&e.state.completionActive){e.state.completionActive.onClose()}if(this.bFocusCellAfterEscape&&this.oDecisionTableCell){var t=this.oDecisionTableCell.getDomRef().parentElement.parentElement;if(t){jQuery(t).focus()}}};a.prototype.getFormattingTokens=function(e){var t=this._liveValue;var i=this.getHeaderValue();var r=this.getFixedOperator();var s="All";if(e._hasValueSource&&i===""&&r===""){this.attributeId=this.mProperties.attributeInfo;this.valueListAttrInfo=e.getValueListAttribute(this.attributeId);if(this.valueListAttrInfo){i=this.valueListAttrInfo.navPath;r=o.IS_EQUAL_TO}}var a=e.getDecisionTableCellTokens(i,r,t,s);var n;if(a.tokens&&a.tokens.cell){n=a.tokens.cell;this.setExpressionTokens(n)}};a.prototype.createEventListeners=function(){document.getElementById(this.getId()).addEventListener("keydown",function(e){var t=e.keyCode||e.charCode;if(t===8){this.bFlagForChangeBeforeBlur=true}else if(t===27){this.bFocusCellAfterEscape=true}}.bind(this),true);var e="ontouchstart"in document.documentElement?"touchstart":"mousedown";if(e==="touchstart"){document.addEventListener("mousedown",function(e){if(e.target.className.includes("CodeMirror-hint")){e.stopPropagation()}}.bind(this),true);document.addEventListener("touchstart",function(e){if(e.target.className.includes("CodeMirror-hint")){e.stopPropagation()}}.bind(this),true)}if(!window.ActiveXObject&&"ActiveXObject"in window){this.codeMirror.on("blur",function(e,t){this.bFlagForPreventBlurWhenPopOverOpen=true}.bind(this));document.getElementById(this.getId()).addEventListener("mousedown",function(e){this.bFlagForChangeBeforeBlur=true}.bind(this),true)}if(navigator.userAgent.toLowerCase().indexOf("firefox")>-1){document.addEventListener("mousedown",function(e){this.bIsClickedOnTheAutoComplete=e.target.className.includes("CodeMirror-hint")}.bind(this),true);document.addEventListener("blur",function(e){if(this.bIsClickedOnTheAutoComplete||this.ValueHelpRequested===true){this.bIsClickedOnTheAutoComplete=false;e.stopPropagation()}}.bind(this),true)}};return a},true);
//# sourceMappingURL=DecisionTableCellExpressionAdvanced.js.map