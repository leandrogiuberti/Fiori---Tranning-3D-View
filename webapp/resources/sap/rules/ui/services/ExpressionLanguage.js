/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Element","sap/rules/ui/parser/businessLanguage/lib/parsingBackendMediator","sap/rules/ui/parser/ruleBody/lib/ruleServices","sap/rules/ui/parser/resources/common/lib/resourcesConvertor","sap/rules/ui/parser/resources/vocabulary/lib/vocabularyDataProviderInitiator","sap/rules/ui/parser/infrastructure/messageHandling/lib/responseCollector","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/rules/ui/parser/resources/vocabulary/lib/constants","sap/rules/ui/library","sap/ui/comp/odata/MetadataAnalyser","sap/base/i18n/Formatting","sap/ui/model/odata/v2/ODataModel","sap/ui/model/Filter","sap/ui/core/Lib"],function(jQuery,e,t,r,s,a,o,i,n,u,l,p,c,g,d,f){"use strict";u=u;var v=e.extend("sap.rules.ui.services.ExpressionLanguage",{metadata:{library:"sap.rule.ui",properties:{valueHelpCallback:{type:"any"},bindingContextPath:{type:"string",group:"Misc"}},publicMethods:["setData","validateExpression","getSuggestions","getExpressionMetadata","getValueListAttribute"],events:{dataChange:{}}}});v.prototype._initLocale=function(){var e=c.getLanguageTag();var t=n.getInstance(e);var r=t.getDatePattern("short");var s=t.getTimePattern("medium");var a=-(new Date).getTimezoneOffset();var o=t.getNumberSymbol("decimal");var i=t.getNumberSymbol("group");this._localeSettings={dateFormat:r,timeFormat:s,timeZoneOffset:a,number:{groupSeparator:i,decimalSeparator:o}}};v.prototype.init=function(){this._hasValueSource="HasValueSource";this._valueListName="valueListName";this._ofModifier=" of the ";this._initLocale();this.attachModelContextChange(this._setDataFromModel.bind(this))};v.prototype._setDataFromModel=function(){if(this.hasModel()&&this.getBindingContextPath()){this.getModel().read(this.getBindingContextPath(),{urlParameters:{$expand:"DataObjects/Associations,DataObjects/Attributes,ValueHelps,Rules"},success:this.setData.bind(this),error:this.makeJavaServiceCall()})}};v.prototype.makeJavaServiceCall=function(){this.isJavaService=true;if(this.hasModel()&&this.getBindingContextPath()){this.getModel().read(this.getBindingContextPath(),{urlParameters:{$expand:"DataObjects/Associations,DataObjects/Attributes,ValueSources"},success:this.setData.bind(this)})}};v.prototype.setBindingContextPath=function(e){this.setProperty("bindingContextPath",e,false);this.fireModelContextChange();return this};v.prototype._initVocaRuntimeService=function(){var e=this._CopyAndRemoveOdataTags(this._data);this._vocabularyName=e.Id||e.id;var t={connection:null,vocaLoadingType:"json",resourceID:this._vocabularyName,resourceContent:e,termModes:this._getTermModes()};var r=a;var s=new r.vocaDataProviderInitiatorLib;this._runtimeService=s.init(t)};v.prototype._initBackendParser=function(){var e=t;this._backendParser=new e.parsingBackendMediatorLib};v.prototype._initParser=function(){this._initVocaRuntimeService();this._initBackendParser()};v.prototype.setData=function(e){if(e.Rules&&!e.Rules.results){e.Rules.results=[];delete e.Rules.__deferred}this._data=e;this._initParser();this.fireDataChange({data:e})};v.prototype._isDataExist=function(){if(!this._data){return false}return true};v.prototype._removeOdataTags=function(e){for(var t in e){if(e[t]&&typeof e[t]==="object"){if(Array.isArray(e[t].results)){e[t]=e[t].results}this._removeOdataTags(e[t])}}};v.prototype._CopyAndRemoveOdataTags=function(e){var t={};if(e){t=JSON.parse(JSON.stringify(e));this._removeOdataTags(t)}return t};v.prototype._addOdataTags=function(e){for(var t in e){if(typeof e[t]==="object"){this._addOdataTags(e[t]);if(Array.isArray(e[t])&&t!=="results"){e[t]={results:e[t]}}}}};v.prototype._CopyAndAddOdataTags=function(e){var t;if(e){t=JSON.parse(JSON.stringify(e));this._addOdataTags(t)}return t};v.prototype._getTermModes=function(){return["byName","byDescription"]};v.prototype._initResponseCollector=function(e){var t=o.ResponseCollector;var r=t.getInstance();r.clear();r.addSubject(e);return t};v.prototype.convertRuleToDisplayValues=function(e){var t={source:"codeText",target:"displayText"};var r=this._buildFlagsObject(t,null,null,true);return this._validateRule(e,r)};v.prototype.convertRuleToCodeValues=function(e){var t={source:"displayText",target:"codeText"};var r=this._buildFlagsObject(t);return this._validateRule(e,r)};v.prototype.validateRule=function(e){return this._validateRule(e)};v.prototype._fnValidateRule=function(e,t){t=t||{};t.isCollection=false;t.tokensOutput=true;var s=this._CopyAndRemoveOdataTags(e);var a=this._initResponseCollector("Rule Validation");var o=a.getInstance();var i="************* RULE: "+JSON.stringify(s)+"\n\n\n\n"+"*************    VOCABULARY: "+JSON.stringify(this._data)+"\n\n\n\n";o.trace(a.severity().debug,i);o.setOpMessage("RuleValidation","failure");var n=r.validateRule(s,this._vocabularyName,this._runtimeService,t);if(n.status=="Success"){o.setOpMessage("RuleValidation","success")}if(n&&n.hasOwnProperty("decisionTableData")){this._addOdataTags(n.decisionTableData)}o.setOutput(n);return o.build()};v.prototype._validateRule=function(e,t){if(!this._isDataExist()){return null}var r=this._fnValidateRule(e,t);var s=r.output.valueHelp&&r.output.valueHelp.info.length>0;var a=this.getValueHelpCallback();var o=a&&typeof a==="function";if(s&&!o&&!r.output.valueHelp.info[0].metadata.hasOwnProperty(this._hasValueSource)){this._raiseError({},"Value help callback function is not set or is not a function")}if(s&&o){var i=r.output.valueHelp.info;a.call(this,i);var n=true;for(var u=0;u<i.length;u++){if(!i[u].model){this._raiseError({},"value help model is not provided");n=false;break}else if(!(i[u].model instanceof g)){this._raiseError({},"value help model is not an oData V2 model");n=false;break}}if(n){var l=this._buildValueHelpMap(i);this._buildDeferredResponse(l,t,r,i);var p=new jQuery.Deferred;r.deferredResult=p.promise();r.valueHelpMapDeferred.done(function(t){p.resolve(this._fnValidateRule(e,t))}.bind(this));r.valueHelpMapDeferred.fail(function(){p.resolve(r)}.bind(this));i.forEach(function(e){if(e.model.isMetadataLoadingFailed()){p.resolve(r);return}})}}return r};v.prototype._validateExpression=function(e,t,r,s,a){this._initResponseCollector("Parsing");var o=this._backendParser.parseExpression(e,l.BackendParserRequest.Validate,this._runtimeService,null,t,this._vocabularyName,a);var i={};i.status=o.status;if(o.valueHelp){i.valueHelp=o.valueHelp}if(i.status==="Error"){i.errorDetails=o.errorDetails;i.cursorPosition=o.cursorPosition}else{i.actualReturnType=o.actualReturnType}if(o.tokens){i.tokens=o.tokens}return i};v.prototype._raiseError=function(e,t){e.status="Error";e.cursorPosition=-1;var r=f.getResourceBundleFor("sap.rules.ui.i18n");e.errorDetails=r.getText("valueHelpTechnicalError");window.console.log(t)};v.prototype.validateExpression=function(e,t,r,s){if(!this._isDataExist()){return null}var a=this._buildFlagsObject(null,r,s,true);var o=this._validateExpression(e,t,r,s,a);var i=o.valueHelp&&o.valueHelp.info.length>0;if(i){if(typeof this.getValueHelpCallback()!=="function"&&!o.valueHelp.info[0].metadata.hasOwnProperty(this._hasValueSource)){this._raiseError(o,"value help callback is not set or is not a function")}else if(o.status==="Success"&&!o.valueHelp.info[0].metadata.hasOwnProperty(this._hasValueSource)){var n=o.valueHelp.info;var u=this.getValueHelpCallback();u.call(this,n);var l=true;for(var p=0;p<n.length;p++){if(!n[p].model){this._raiseError(o,"value help model is not provided");l=false;break}else if(!(n[p].model instanceof g)){this._raiseError(o,"value help model is not an oData V2 model");l=false;break}}if(l){var c=this._buildValueHelpMap(n);this._buildDeferredResponse(c,a,o,n);var d=new jQuery.Deferred;o.deferredResult=d.promise();o.valueHelpMapDeferred.done(function(o){var i=this._validateExpression(e,t,r,s,a);d.resolve(i)}.bind(this));o.valueHelpMapDeferred.fail(function(e){this._raiseError(e,"failed to read from value help oData service");d.resolve(e)}.bind(this))}}}return o};v.prototype._buildFlagsObject=function(e,t,r,s){if(!t){t=false}if(r===undefined||r===null){r=true}var a={isCollection:t,tokensOutput:r};if(this._localeSettings){a.locale={localeSettings:this._localeSettings}}if(e){a.locale={localeSettings:this._localeSettings,convert:e};a.termMode={convert:e};a.ASTOutput=true}if(s){a.valueHelp={collectInfo:true}}return a};v.prototype.getSuggestions=function(e,t,r,s,a){if(!this._isDataExist()){return null}this._initResponseCollector("Parsing");var o=this._buildFlagsObject(null,r,s);var i=this._backendParser.parseExpression(e,l.BackendParserRequest.Suggests,this._runtimeService,null,t,this._vocabularyName,o,a);var n="valueList";for(var u=0;u<i.suggs.length;u++){if(i.suggs[u].tokenType===n){var p=f.getResourceBundleFor("sap.rules.ui.i18n");i.suggs[u].text=p.getText("valueHelp")}}var c={};c.suggs=i.suggs;if(i.tokens){c.tokens=i.tokens}return c};v.prototype.getValueListAttribute=function(e){var t;if(this._runtimeService){var r=this._runtimeService.getAllVocaObjects().allValueLists;if(r){for(var s=0;s<r.length;s++){if(r[s].name.indexOf(e)>1){t=this._getValueAttrInfo(e);if(t){t.attributeValueList=r[s].name;return t}}}}}};v.prototype._getValueAttrInfo=function(e){var t=this._runtimeService.getAllVocaObjects().allAttr;for(var r=0;r<t.length;r++){if(t[r].hasOwnProperty(this._valueListName)&&t[r].valueListName&&t[r].valueListName.indexOf(e)>1){return{navPath:t[r].name+this._ofModifier+t[r].objectName}}}};v.prototype.getSuggestionsByCategories=function(e,t){e=e?e:"";var r=this.getSuggestions(e,l.ExpressionType.BooleanEnhanced,false).suggs;r=r?r:[];if(!t){return r}var s=[];for(var a=0;a<t.length;a++){var o=t[a];for(var i=0;i<r.length;i++){if(o.tokenType===undefined||o.tokenType===r[i].tokenType||o.hasOwnProperty("tokenType")===false){if(r[i].hasOwnProperty("info")===false){if(o.hasOwnProperty("tokenCategory")===false&&o.hasOwnProperty("tokenBusinessType")===false||o.tokenCategory===undefined&&o.tokenBusinessType===undefined){s.push(r[i])}}else if((o.tokenCategory===undefined||o.tokenCategory===r[i].info.category||o.hasOwnProperty("tokenCategory")===false)&&(o.tokenBusinessType===undefined||o.tokenBusinessType===r[i].info.type||o.hasOwnProperty("tokenBusinessType")===false)){s.push(r[i])}}}}return s};v.prototype.getExpressionMetadata=function(e){if(!this._isDataExist()){return null}this._initResponseCollector("Parsing");var t=this._backendParser.parseExpression(e,l.BackendParserRequest.GetMetadata,this._runtimeService,null,null,this._vocabularyName,null);var r={};r.tokens=t.tokens;return r};v.prototype.getResultInfo=function(e){if(!this._isDataExist()){return null}var t=null;t=this._runtimeService.getOutput(this._vocabularyName,e,null);if(t&&t.name){this._getResultRequiredParamIds(t)}return t};v.prototype.getResults=function(){if(!this._isDataExist()){return null}var e=null;var t=[];e=this._runtimeService.getOutputs(this._vocabularyName).outputs;for(var r=0;r<e.length;r++){if(e[r].Type!==u.PROPERTY_DATA_OBJECT_TYPE_ELEMENT){var s=e[r].Label?e[r].Label:e[r].name;t.push({id:e[r].id,name:e[r].name,label:s,description:e[r].description,columns:e[r].requiredParams})}}if(this.isJavaService||this._data.DataObjects){e=this._data.DataObjects.results;for(var a=0;a<e.length;a++){if(e[a].Type!==u.PROPERTY_DATA_OBJECT_TYPE_ELEMENT){var o=e[a].Label?e[a].Label:e[a].Name;t.push({id:e[a].Id,name:e[a].Name,label:o,description:e[a].Description})}}}return t};v.prototype.getResultColumnDescription=function(e,t,r){if(!this._isDataExist()){return r?r:e}var s=null;var a=[];var o=0;s=this._runtimeService.getOutputs(this._vocabularyName).outputs;for(o=0;o<s.length;o++){if(s[o].id===t){a=s[o].requiredParams;break}}for(o=0;o<a.length;o++){if(a[o].name===e){if(a[o].description!==""){return a[o].description}}}return r?r:e};v.prototype._getResultRequiredParamIds=function(e){var t,r,s;var a=JSON.parse(JSON.stringify(this._data));if(a.DataObjects&&a.DataObjects.results){a.DataObjects=a.DataObjects.results;for(t=0;t<a.DataObjects.length;t++){if(a.DataObjects[t].Attributes&&a.DataObjects[t].Attributes.results&&a.DataObjects[t].Name==e.name&&a.DataObjects[t].Usage=="RESULT"&&e.requiredParams){a.DataObjects[t].Attributes=a.DataObjects[t].Attributes.results;for(r=0;r<a.DataObjects[t].Attributes.length;r++){for(s=0;s<e.requiredParams.length;s++){if(e.requiredParams[s].name===a.DataObjects[t].Attributes[r].Name){e.requiredParams[s].paramId=a.DataObjects[t].Attributes[r].Id}}}return}}}return};v.prototype._setConfigurationForBasic=function(){this.suggestAfterMap={initial:["vocabulary,undefined"],"vocabulary,undefined":["reservedword,comparisonOp","reservedword,comparisonBetweenOp","reservedword,comparisonExistOp"],"reservedword,comparisonOp":["constant,dynamic","constant,fixed","reservedword,value"],"reservedword,comparisonBetweenOp":["constant,dynamic","reservedword,value"],"reservedword,comparisonExistOp":["constant,dynamic","constant,fixed","reservedword,value"],"reservedword,UOM":["reservedword,null","reservedword,conjunctionOp"],"reservedword,function":["vocabulary,undefined"],"reservedword,conjunctionOp":["initial"],"reservedword,value":["reservedword,null","reservedword,conjunctionOp"],"reservedword,null":["reservedword,conjunctionOp"],"constant.dynamic":["reservedword,UOM","reservedword,null","reservedword,conjunctionOp"],"constant.fixed":["reservedword,null","reservedword,conjunctionOp"],"unknown,undefined":[]};this.filterByTypeMap={"vocabulary,undefined":[{tokenType:l.ExpressionTokenType.vocabulary}],"reservedword,comparisonOp":[{tokenType:l.ExpressionTokenType.reservedWord,tokenCategory:l.ExpressionCategory.comparisonOp}],"reservedword,comparisonBetweenOp":[{tokenType:l.ExpressionTokenType.reservedWord,tokenCategory:l.ExpressionCategory.comparisonBetweenOp}],"reservedword,comparisonExistOp":[{tokenType:l.ExpressionTokenType.reservedWord,tokenCategory:l.ExpressionCategory.comparisonExistOp}],"reservedword,UOM":[{tokenType:l.ExpressionTokenType.reservedWord,tokenCategory:l.ExpressionCategory.UOM}],"reservedword,function":[{tokenType:l.ExpressionTokenType.reservedWord,tokenCategory:l.ExpressionCategory.func}],"reservedword,conjunctionOp":[{tokenType:l.ExpressionTokenType.reservedWord,tokenCategory:l.ExpressionCategory.conjunctionOp}],"reservedword,value":[{tokenType:l.ExpressionTokenType.reservedWord,tokenCategory:l.ExpressionCategory.value}],"reservedword,null":[{tokenType:l.ExpressionTokenType.reservedWord,tokenCategory:null}],"constant.dynamic":[{tokenType:l.ExpressionTokenType.constant,tokenCategory:l.ExpressionCategory.dynamic}],"constant.fixed":[{tokenType:l.ExpressionTokenType.constant,tokenCategory:l.ExpressionCategory.fixed}]}};v.prototype.getSuggestionsForBasic=function(e,t,r){var s=[];var a=this.getSuggestions(e,t,r,true);if(!a||!a.suggs||!a.suggs.length){return s}s=this._filterSuggestionsForBasic(a);return s};v.prototype._filterSuggestionsForBasic=function(e){var t=this._groupTokensByTokenType(e.tokens);var r=null;if(t&&t.length>0){r=t[t.length-1]}var s=this._getCategoryForToken(r);var a=this.suggestAfterMap[s];var o=this._getFilterForTokenTypes(a);var i=this._filterSuggestionsByCategories(e,o);return{suggs:i,afterTokenType:r&&r.tokenType}};v.prototype._getCategoryForToken=function(e){if(!e){return"initial"}var t=e.tokenType;var r=e.info&&e.info.category;return t+","+r};v.prototype._getFilterForTokenTypes=function(e){var t=[];for(var r=0;r<e.length;r++){var s=e[r];var a=this.filterByTypeMap[s];if(a){t.push(a)}}return t};v.prototype._filterSuggestionsByCategories=function(e,t){var r=[];if(!e||!t){return r}for(var s=0;s<t.length;s++){var a=t[s];for(var o=0;o<e.length;o++){if(a.tokenType===undefined||a.tokenType===e[o].tokenType||a.hasOwnProperty("tokenType")===false){if(e[o].hasOwnProperty("info")===false){if(a.hasOwnProperty("tokenCategory")===false&&a.hasOwnProperty("tokenBusinessType")===false||a.tokenCategory===undefined&&a.tokenBusinessType===undefined){r.push(e[o])}}else if((a.tokenCategory===undefined||a.tokenCategory===e[o].info.category||a.hasOwnProperty("tokenCategory")===false)&&(a.tokenBusinessType===undefined||a.tokenBusinessType===e[o].info.type||a.hasOwnProperty("tokenBusinessType")===false)){r.push(e[o])}}}}return r};v.prototype._groupTokensByTokenType=function(e){var t=[];if(!e||!e.length){return t}var r="";for(var s=0;s<e.length;s++){var a=e[s];if(a.tokenType===l.ExpressionTokenType.whitespace){continue}else if(a.tokenType!==l.ExpressionTokenType.vocabulary){t.push(a);r=a.tokenType}else{if(r!==l.ExpressionTokenType.vocabulary){t.push(a)}else{t[t.length-1].token+=" "+a.token;t[t.length-1].end=a.end}r=a.tokenType}}return t};v.prototype._getSubExpressions=function(e,t){if(!e){e=this.validateExpression(t)}var r=[];var s;var a;for(s=e.tokens.length-1;s>=0;s--){if(e.tokens[s].info){var o=e.tokens[s].info;if(o.category===l.ExpressionCategory.comparisonOp||o.category===l.ExpressionCategory.comparisonBetweenOp||o.category===l.ExpressionCategory.comparisonExistOp){a=e.tokens[s];break}}}r.push({exp:""});var i=0;while(i<e.tokens.length&&e.tokens[i]!==a){r[0].exp+=e.tokens[i].token;i++}r[0].exp=r[0].exp.replace(/  +/g," ");if(!r[0].exp){return r}if(r[0].exp.slice(-1)===" "){r[0].exp=r[0].exp.slice("",-1)}i++;if(!a){return r}r.push({exp:a.token.replace(/  +/g," "),type:this._getCompType(this.exp)});if(i<e.tokens.length){r.push({exp:""});for(;i<e.tokens.length;i++){r[2].exp+=e.tokens[i].token}}return r};v.prototype._getBasicSuggestions=function(e,t){if(!t){t=l.SuggestionsPart.all}var r=this.validateExpression(e);var s=[];var a=this._getSubExpressions(r);var o=a[0]&&a[0].exp?a[0].exp:"";if(t===l.SuggestionsPart.all){s.push(this._getLeftSuggestions("",o));if(o===""){return s}}var i=a[1]&&a[1].exp?a[1].exp:"";var n=""||a[1]&&a[1].type;if(t===l.SuggestionsPart.all||t===l.SuggestionsPart.compPart){s.push(this._getCompSuggestions(o,i,n));if(a.length===1){return s}}if(t===l.SuggestionsPart.all||t===l.SuggestionsPart.rightPart){var u=a[2]&&a[2].exp?a[2].exp:"";n=t===l.SuggestionsPart.all?s[1].type:null;var p=this._getRightSuggestions(o,i,u,n,r);s.push.apply(s,p)}return s};v.prototype._getLeftSuggestions=function(e,t){var r=this._createEmptySuggestion(1)[0];var s=[{tokenType:l.ExpressionTokenType.vocabulary}];var a=this.getSuggestionsByCategories(e,s);for(var o=0;o<a.length;o++){r.sugg.push(a[o].text)}r.currentValue=t;r.tokenCategory=l.ExpressionTokenType.vocabulary;return r};v.prototype._getCompSuggestions=function(e,t,r){var s=this._createEmptySuggestion(1)[0];var a=[{tokenType:l.ExpressionTokenType.reservedWord,tokenCategory:l.ExpressionCategory.comparisonOp},{tokenType:l.ExpressionTokenType.reservedWord,tokenCategory:l.ExpressionCategory.comparisonBetweenOp}];var o=this.getSuggestionsByCategories(e,a);s.type=r||this._getCompType(t);for(var i=0;i<o.length;i++){s.sugg.push(o[i].text)}s.currentValue=t;return s};v.prototype._getRightSuggestions=function(e,t,r,s,a){var o;var i=e+" "+t;var n=this._getLeftBusinessDataType(e);if(!s){s=this._getCompType(t)}switch(s){case l.ExpressionCategory.comparisonOp:o=this._getRightForComparisonOp(n,i,r);break;case l.ExpressionCategory.comparisonBetweenOp:o=this._geRightForBetweenOp(n,i,r);break;case l.ExpressionCategory.comparisonExistOp:break;default:break}if(!o){return[{}]}return o};v.prototype._getRightForComparisonOp=function(e,t,r){var s=this._createEmptySuggestion(1);var a;s[0].BDT=e;var o;var i;o=[{tokenType:l.ExpressionTokenType.valueList}];a=this.getSuggestionsByCategories(t+" ",o);s[0].currentValue=jQuery.trim(r);if(a.length){s[0].valueListObject=a[0].info;s[0].isValueList=true}s[0].currentValue=jQuery.trim(r);if(s[0].isValueList){return s}if(e===l.ExpressionType.TimeSpan){s.push.apply(s,this._createEmptySuggestion(1));o=[{tokenType:l.ExpressionTokenType.reservedWord,tokenCategory:l.ExpressionCategory.UOM}];var n=this._splitStringBySeperator(r," ");s[0].currentValue=n[0];s[1].currentValue=n[1];a=this.getSuggestionsByCategories(t+" 5",o);for(i=0;i<a.length;i++){s[1].sugg.push(a[i].text)}}else if(e===l.ExpressionType.Date){o=[{tokenType:l.ExpressionTokenType.reservedWord,tokenCategory:l.ExpressionCategory.value},{tokenType:l.ExpressionTokenType.constant,tokenCategory:l.ExpressionCategory.dynamic}];a=this.getSuggestionsByCategories(t+" ",o);for(i=0;i<a.length;i++){s[0].sugg.push(a[i].text)}s[0].currentValue=jQuery.trim(r)}return s};v.prototype._geRightForBetweenOp=function(e,t,r){(function(){var e=this.validateExpression(r).tokens;if(e){for(var t=0;t<e.length;t++){if(e[t].info&&(e[t].info.category===l.ExpressionCategory.comparisonOp||e[t].info.category===l.ExpressionCategory.comparisonBetweenOp||e[t].info.category===l.ExpressionCategory.comparisonExistOp)){r="";return}}}}).bind(this)();var s=this._createEmptySuggestion(1);var a;var o,i,n;s[0].BDT=e;if(e!==l.ExpressionType.TimeSpan&&e!==l.ExpressionType.Date){o=this._getRightExpressionsForTimeStamp(r)}else{o=this._splitStringBySeperator(r," ")}if(e===l.ExpressionType.TimeSpan){s.push.apply(s,this._createEmptySuggestion(4));s[3].BDT=e;i=[{tokenType:l.ExpressionTokenType.reservedWord,tokenCategory:l.ExpressionCategory.UOM}];a=this.getSuggestionsByCategories(t+" 5",i);for(n=0;n<a.length;n++){s[1].sugg.push(a[n].text);s[4].sugg.push(a[n].text)}}else if(e===l.ExpressionType.Date){s.push.apply(s,this._createEmptySuggestion(2));s[2].BDT=e;i=[{tokenType:l.ExpressionTokenType.reservedWord,tokenCategory:l.ExpressionCategory.value},{tokenType:l.ExpressionTokenType.constant,tokenCategory:l.ExpressionCategory.dynamic}];a=this.getSuggestionsByCategories(t+" ",i);for(n=0;n<a.length;n++){s[0].sugg.push(a[n].text);s[2].sugg.push(a[n].text)}}else{s.push.apply(s,this._createEmptySuggestion(2));s[2].BDT=e;i=[{tokenType:l.ExpressionTokenType.valueList}];a=this.getSuggestionsByCategories(t+" ",i);s[0].currentValue=jQuery.trim(r);if(a.length){s[0].valueListObject=a[0].info;s[0].isValueList=true;s[2].valueListObject=a[0].info;s[2].isValueList=true}}for(n=0;n<s.length;n++){if(o[n]==="to"||n===2&&e===l.ExpressionType.TimeSpan||n===1&&e===l.ExpressionType.Date||n===1&&e!==l.ExpressionType.Date&&(n===1&&e!=l.ExpressionType.TimeSpan)){s[n].tokenCategory="reservedword.undefined";s[n].currentValue=o[n]==="to"||o[n]==="and"?o[n]:"to"}else if(e===l.ExpressionType.Date){s[n].currentValue=jQuery.trim(o[n]||"''")}else if(e===l.ExpressionType.TimeSpan){s[n].currentValue=jQuery.trim(o[n]||"''")}else{s[n].currentValue=jQuery.trim(o[n])}}return s};v.prototype._geRightForExistOp=function(e,t,r,s){var a=this._createEmptySuggestion(1);a[0].BDT=e;var o;if(e===l.ExpressionType.TimeSpan){o=s.tokens.filter(function(e){if(e.info){return e.info.category===l.ExpressionCategory.UOM||e.tokenType===l.ExpressionTokenType.constant}return null});o.forEach(function(e,t){})}else if(e===l.ExpressionType.Date){o=s.tokens.filter(function(e){if(e.info){return e.info.category===l.ExpressionCategory.value}return null});o.forEach(function(e,t){})}return a};v.prototype._getLeftBusinessDataType=function(e){var t=this.validateExpression(e);var r=t.actualReturnType;if(r){return r}return t};v.prototype._splitStringBySeperator=function(e,t){return e.split(t).filter(function e(t){return t!==""})};v.prototype._getCompType=function(e){if(e){return this.getExpressionMetadata(e).tokens[0].info.category}else{return null}};v.prototype._createEmptySuggestion=function(e){var t=[];for(var r=0;r<e;r++){t.push({sugg:[]})}return t};v.prototype._getRightExpressionsForTimeStamp=function(e){if(!String.prototype.includes){String.prototype.includes=function(){return String.prototype.indexOf.apply(this,arguments)!==-1}}var t;if(e.indexOf("to")!==-1){t=this._splitStringBySeperator(e,"to");t.splice(1,0,"to");return t}else if(e.indexOf("and")!==-1){t=this._splitStringBySeperator(e,"and");t.splice(1,0,"and");return t}return[e,"to"]};v.prototype.convertDecisionTableExpressionToDisplayValue=function(e,t,r,s){var a={source:"codeText",target:"displayText"};var o=this._buildFlagsObject(a);var i=this._validateDecisionTableExpression(e,t,r,s,o,"RuleServiceValidation");return i};v.prototype.getDecisionTableCellTokens=function(e,t,s,a){var o=this._buildFlagsObject(null,"",true,false);var i=r.validateDecisionTableExpression(e,t,s,a,this._vocabularyName,this._runtimeService,null,o);return i};v.prototype.convertDecisionTableExpressionToModelValue=function(e,t,r,s,a){var o={source:"displayText",target:"codeText"};var i=this._buildFlagsObject(o,"","",true);var n=this._validateDecisionTableExpression(e,t,r,s,i,"RuleServiceValidation",a);return n};v.prototype._validateDecisionTableExpression=function(e,t,s,a,o,i,n){var u=this._initResponseCollector(i);var l=u.getInstance();l.setOpMessage(i,"failure");var p=r.validateDecisionTableExpression(e,t,s,a,this._vocabularyName,this._runtimeService,n,o);if(p.status=="Success"){l.setOpMessage("RuleServiceValidation","success")}l.setOutput(p);var c=l.build();return c};v.prototype._buildDeferredResponse=function(e,t,r,s){var a=e.length;var o=0;t.valueHelp={collectInfo:false,info:[]};t.valueHelpInfo=s;r.valueHelpMapDeferred=new jQuery.Deferred;for(var i=0;i<a;i++){e[i].done(function(e,s,i){o++;var n={};n.id=s;n.values={};for(var u=0;u<t.valueHelpInfo.length;u++){if(t.valueHelpInfo[u].id==s){for(var l=0;l<t.valueHelpInfo[u].values.length;l++){n.values[t.valueHelpInfo[u].values[l]]=null}for(var p=0;p<e.results.length;p++){n.values[e.results[p][i]]=e.results[p][i]}break}}t.valueHelp.info.push(n);if(o==a){delete t.valueHelpInfo;r.valueHelpMapDeferred.resolve(t)}});e[i].fail(function(){r.valueHelpMapDeferred.reject(r)})}};v.prototype._buildValueHelpMap=function(e){var t=[];function r(e){var t=e.model;var r=e.metadata.propertyPath;var s=new p(t);var a=s.getValueListAnnotation(r);if(!a.primaryValueListAnnotation){e.deferred.reject("Failed to read value help annotation");return}var o="/"+a.primaryValueListAnnotation.annotation.CollectionPath.String+"/";var i=a.primaryValueListAnnotation.keyField;var n=a.primaryValueListAnnotation.keys;var u=[];if(n.length>1){for(var l=0;l<n.length;l++){if(n[l]!==i){u.push(new d(n[l],"EQ",null))}}}for(var c=0;c<e.values.length;c++){u.push(new d(i,"EQ",e.values[c]))}var g=e.id;t.read(o,{filters:u,success:function(t){e.deferred.resolve(t,g,i)}.bind(this),error:function(t){e.deferred.reject("Failed to read value help values");window.console.log("Failed to read value help values")}})}for(var s=0;s<e.length;s++){this.oValueHelpInfo=e[s];this.oValueHelpInfo.deferred=new jQuery.Deferred;t.push(this.oValueHelpInfo.deferred);if(!this.oValueHelpInfo.model.getMetaModel().oModel){this.oValueHelpInfo.model.attachMetadataLoaded(function(){r(this)}.bind(this.oValueHelpInfo));this.oValueHelpInfo.model.attachMetadataFailed(function(){if(this.deferred){this.deferred.reject("Failed to load value help model metadata")}}.bind(this.oValueHelpInfo))}else{r(this.oValueHelpInfo)}}return t};v.prototype.getExpressionLanguageVersion=function(){return r.getParserExprLangVersion()};return v},true);
//# sourceMappingURL=ExpressionLanguage.js.map