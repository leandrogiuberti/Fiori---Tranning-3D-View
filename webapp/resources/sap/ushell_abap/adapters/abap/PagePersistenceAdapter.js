// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/i18n/Localization","sap/base/util/ObjectPath","sap/ushell/utils/HttpClient","sap/ushell/resources","sap/ushell/utils/chipsUtils","sap/ushell/Container","sap/ushell/utils/LaunchpadError"],(e,t,i,a,n,s,o)=>{"use strict";function r(){const e=window["sap-ushell-config"].services&&window["sap-ushell-config"].services.PagePersistence||{};return(t.get("config.serviceUrl",e.adapter)||"").replace(/\/?$/,"/")}function c(){this.S_COMPONENT_NAME="sap.ushell_abap.adapters.abap.PagePersistenceAdapter"}c.prototype.getPage=function(e){return Promise.all([this._readPage(e),s.getServiceAsync("URLParsing")]).then(e=>{const t=e[0];const i=e[1];return this._convertODataToReferenceData(t,i)}).catch(this._rejectWithError.bind(this))};c.prototype.getPages=function(e){return Promise.all([this._readPages(e),s.getServiceAsync("URLParsing")]).then(e=>{const t=e[0].results;const i=e[1];return t.map(e=>this._convertODataToReferenceData(e,i))}).catch(this._rejectWithError.bind(this))};c.prototype._readPage=function(t){return new Promise((a,n)=>{const o={"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0","Accept-Language":e.getLanguage()||"",Accept:"application/json, text/plain"};const c=s.getUser().getLanguage();if(c){o["sap-language"]=c}const p=s.getLogonSystem();const l=p?p.getClient():"";if(l){o["sap-client"]=l}const d=r();const g=new i(d,{headers:o});const u=`${d}pageSet('${encodeURIComponent(t)}')`+"?$expand=sections/viz,vizReferences/chipBags/properties,tileTypes/vizOptions/displayFormats/supported";g.get(u).then(e=>{a(JSON.parse(e.responseText).d)}).catch(n)})};c.prototype._readPages=function(t){return new Promise((a,n)=>{const o={"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0","Accept-Language":e.getLanguage()||"",Accept:"application/json, text/plain","content-type":"multipart/mixed; boundary=batch_bd56-ff53-571c"};const c=s.getUser().getLanguage();if(c){o["sap-language"]=c}const p=s.getLogonSystem();const l=p?p.getClient():"";if(l){o["sap-client"]=l}const d=`pageSet?$expand=${encodeURIComponent("sections/viz,vizReferences/chipBags/properties,tileTypes/vizOptions/displayFormats/supported")}&$filter=`;const g=t.length?`id eq '${t.join("' or id eq '")}'`:"";const u=r();const h=`${u}$batch`;const m=new i(u,{headers:o});const f=this._createBatchData(d+encodeURIComponent(g).replace(/[!'()*]/g,escape));m.post(h,{data:f}).then(e=>{const t=this._retrieveBatchData(e);a(t)}).catch(n)})};c.prototype._createBatchData=function(e){const t=s.getUser().getLanguage();const i=s.getLogonSystem()?s.getLogonSystem().getClient():"";const a=["--batch_bd56-ff53-571c","Content-Type: application/http","Content-Transfer-Encoding: binary","",`GET ${e} HTTP/1.1`,"sap-cancel-on-close: true",`sap-language: ${t||""}`,`sap-client: ${i||""}`,"sap-contextid-accept: header","Accept: application/json",`Accept-Language: ${t||""}`,"DataServiceVersion: 2.0","MaxDataServiceVersion: 2.0","X-Requested-With: XMLHttpRequest","","","","--batch_bd56-ff53-571c--"];return a.join("\r\n")};c.prototype._retrieveBatchData=function(e){const t=e.responseText.split("\r\n");let i=[];for(let e=0;e<t.length;e++){if(t[e].startsWith("{")){i=t[e]}}return JSON.parse(i).d};c.prototype._convertODataToReferenceData=function(e,t){const i={};const a={page:{id:e.id,title:e.title,description:e.description,createdBy:e.createdBy,createdByFullname:e.createdByFullname||e.createdBy,modifiedBy:e.modifiedBy,modifiedByFullname:e.modifiedByFullname||e.modifiedBy,sections:e.sections.results.map(e=>({id:e.id,sectionIndex:e.sectionIndex,title:e.title,viz:e.viz.results.map(e=>({catalogTileId:e.catalogTileId,id:e.id,itemIndex:e.itemIndex,targetMappingId:e.targetMappingId,vizId:e.catalogTileIdStable,inboundPermanentKey:e.targetMappingIdStable,displayFormatHint:e.displayFormatHint})).sort((e,t)=>e.itemIndex-t.itemIndex)})).sort((e,t)=>e.sectionIndex-t.sectionIndex)},visualizations:e.vizReferences.results.reduce((e,a)=>{const s=this._getSimplifiedChip(a);const o={vizId:a.catalogTileIdStable,vizType:a.tileType,title:a.title,subTitle:a.subTitle,icon:a.iconUrl,info:n.getInfoFromSimplifiedChip(s),keywords:n.getKeywordsFromSimplifiedChip(s),size:n.getTileSizeFromSimplifiedChip(s),indicatorDataSource:n.getIndicatorDataSourceFromSimplifiedChip(s),url:n.getTargetUrlFromSimplifiedChip(s,t),numberUnit:n.getNumberUnitFromSimplifiedChip(s),isCustomTile:n.isCustomTileFromSimplifiedChip(s),_instantiationData:{platform:"ABAP",simplifiedChipFormat:true,chip:s}};e[a.catalogTileIdStable]=o;if(a.fromPersonalization&&a.id!==a.catalogTileIdStable){i[a.id]=o}return e},{}),vizTypes:e.tileTypes.results.reduce((e,t)=>{const i=t.vizOptions.displayFormats;const a=t.id;e[a]={id:a,url:t.url,vizOptions:{displayFormats:{supported:i.supported.results.map(e=>e.id),default:i.preferred}}};return e},{})};a.unstableVisualizations=Object.keys(i).length>0?i:null;return a};c.prototype._getSimplifiedChip=function(e){const t={};let i;try{i=JSON.parse(e.configuration)}catch{i={}}e.chipBags.results.forEach(e=>{t[e.id]={texts:{},properties:{}};e.properties.results.forEach(i=>{if(i.translatable){t[e.id].texts[i.id]=i.value}else{t[e.id].properties[i.id]=i.value}})});return{chipId:e.tileType,configuration:i,bags:t}};c.prototype._rejectWithError=async function(e){throw new o(e.message,{component:this.S_COMPONENT_NAME,description:a.i18n.getText("PagePersistenceAdapter.CannotLoadPage"),detail:e},e)};return c});
//# sourceMappingURL=PagePersistenceAdapter.js.map