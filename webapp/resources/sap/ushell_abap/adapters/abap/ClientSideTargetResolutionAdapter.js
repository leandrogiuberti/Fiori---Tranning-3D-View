// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/ObjectPath","sap/base/util/isPlainObject","sap/base/util/deepExtend","sap/ushell/utils","sap/ushell/utils/UrlParsing","sap/base/Log","sap/ushell_abap/pbServices/ui2/ODataWrapper","sap/ushell_abap/pbServices/ui2/Utils","sap/ui/thirdparty/URI","sap/ushell/Container"],(e,t,a,r,i,s,n,o,l,p)=>{"use strict";const u="sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter";const f=["sap-wd-configId","SAP-WD-CONFIGID","sap-client","SAP-CLIENT","System","SYSTEM","sap-language","SAP-LANGUAGE","sap-wd-htmlrendermode","sap-wd-deltarendering","wdallowvaluesuggest","sap-wd-lightspeed","sap-wd-remotedesktop","sap-wd-flashdebug","sap-accessibility","sap-theme","sap-*","SAP-*","wd*","WD*"];function c(e,t,a){const i=this;const o=p;let l="";if(o){l=o.getLogonSystem().getProductName()||""}this._oLocalSystemAlias={http:{id:"",host:"",port:"",pathPrefix:"/sap/bc/"},https:{id:"",host:"",port:"",pathPrefix:"/sap/bc/"},rfc:{id:"",systemId:"",host:"",service:0,loginGroup:"",sncNameR3:"",sncQoPR3:""},id:"",label:"local",client:"",language:"",properties:{productName:l}};this.hasSegmentedAccess=true;this._oAdapterConfig=a&&a.config;this._wdLengthLimit=1800;this._oODataWrapper=undefined;this._getODataWrapper=function(){if(!this._oODataWrapper){this._oODataWrapper=n.createODataWrapper("/sap/opu/odata/UI2/INTEROP/")}return this._oODataWrapper};this._aTargetMappings=[];this._aInbounds=[];this._aInitialSegment=undefined;this._oSystemAliasBuffer=new r.Map;this._oURLTemplates={};this._storeFromFullStartupResponse=function(e){if(e){if(e.targetMappings){i._aTargetMappings=e.targetMappings}if(e.systemAliases){i._writeUserSystemAliasesToBuffer(e.systemAliases)}if(e.urlTemplates){i._oURLTemplates=e.urlTemplates}}};this._fallbackToFullStartupRequest=function(e,t){s.debug("Falling back to full start_up request from adapter","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");i._requestAllTargetMappings().then(t=>{i._storeFromFullStartupResponse(t);e()}).catch(e=>{t(e)})};this._iTargetMappingsUnusedPromiseRejectCount=0;this._oInitialSegmentPromise=a&&a.config&&a.config.initialSegmentPromise||new Promise((e,t)=>{i._iTargetMappingsUnusedPromiseRejectCount++;if(i._iTargetMappingsUnusedPromiseRejectCount===2){i._fallbackToFullStartupRequest(e,t)}});this._oNavTargetPromise=a&&a.config&&a.config.navTargetDataPromise||new Promise((e,t)=>{i._iTargetMappingsUnusedPromiseRejectCount++;if(i._iTargetMappingsUnusedPromiseRejectCount===2){i._fallbackToFullStartupRequest(e,t)}});this._oInitialSegmentPromise.then(e=>{if(e===null){s.debug("Initial target mappings segment promise resolved with 'null'","Will not process initial target mappings segments again (mostly likely because this is no longer needed)","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");return}if(i._aTargetMappings.length===0){s.debug("Segmented start_up response returned","storing system aliases and inbounds from segment","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");const t=e[0];const a=e[1];const r=e[2];if(e.length>3){i._oURLTemplates=e[3]}i._aTargetMappings=a;i._writeUserSystemAliasesToBuffer(r);i._aInitialSegment=t}else{s.debug("Segmented start_up response returned","ignoring response because the full target mapping response returned before","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter")}}).catch(e=>{s.error("Initial segment promise was rejected.",e,"sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter")});this._oNavTargetPromise.then(e=>{s.debug("Full start_up response returned","storing system aliases and inbounds","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");i._storeFromFullStartupResponse(e)})}c.prototype._adjustNavTargetResult=function(e){if(e){let t=e.url;let a;const r={applicationType:e.applicationType,additionalInformation:e.applicationData};let i;let n;let p;if(e.text){r.text=e.text}if(e.applicationType==="URL"||e.applicationType==="SAPUI5"){n=/^SAPUI5\.Component=(.*)/.exec(e.applicationData);i=n&&n[1];if(i||e.applicationDependencies){if(i){r.ui5ComponentName=i}if(e.applicationDependencies){try{p=JSON.parse(e.applicationDependencies);if(!r.ui5ComponentName&&p.name){r.ui5ComponentName=p.name;r.additionalInformation=`SAPUI5.Component=${r.ui5ComponentName}`}if(p&&p.url&&typeof p.url==="string"){a=t&&new l(t);if(a){if(p.url.toUpperCase().indexOf(a.path().toUpperCase())!==0){s.debug("Component URL defined in target mapping "+"does not match the URL retrieved from application index. "+"The URL of the application index is used for further processing.",`Target mapping URL: ${e.url}\nApplication index URL: ${p.url}`,"sap.ushell_abap.bootstrap.abap")}a.path(p.url);t=a.toString();s.debug("ResolveLink result's component url has been replaced with the url specified "+"in Application Dependencies, which includes cache buster token")}else{t=p.url}}r.applicationDependencies=p}catch(e){s.error(`Parsing of applicationDependencies attribute in resolveLink result failed for SAPUI5 component '${i}'`,e,"sap.ushell_abap.bootstrap.abap")}}t=o.addCacheBusterTokenUsingUshellConfig(t)}}r.url=t;return r}};c.prototype.resolveHashFragmentFallback=function(e,t,a){const r=this._constructShellHashForLpdCust(t,a);const i=a&&a["sap-system"]&&a["sap-system"][0];return this._resolveHashFragmentBE(r||e).then(e=>{if(e&&i){e["sap-system"]=e["sap-system"]||i}return e})};c.prototype.getInbounds=function(e){return new Promise((t,a)=>{this._oInitialSegmentPromise.then(a=>{if(a===null){return}if(this._isInSegment(e,this._aInitialSegment)){s.debug("Got inbounds from initial segment","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");this._aInbounds=this._formatDirectStart(this._aTargetMappings);t(this._aInbounds)}else{s.debug("Did not get inbound in initial segment","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter")}});this._oNavTargetPromise.then(()=>{s.debug("Got inbounds from full start_up response","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");this._aInbounds=this._formatDirectStart(this._aTargetMappings);this.getInbounds=function(){return Promise.resolve(this._aInbounds)};t(this._aInbounds)}).catch(a)})};c.prototype._isInSegment=function(e,t){if(!Array.isArray(t)||!Array.isArray(e)){return false}return e.every(e=>!t.every(t=>!(e.semanticObject===t.semanticObject&&e.action===t.action)))};c.prototype._requestAllTargetMappings=function(){const t=o.getParameterMap();let a="/sap/bc/ui2/start_up?so=%2A&action=%2A&";const i=e.create("services.targetMappings",this._oAdapterConfig).cacheId&&`&sap-cache-id=${e.create("services.targetMappings",this._oAdapterConfig).cacheId}`||"";function s(e){const r=t[e];if(r){a+=`${e}=${encodeURIComponent(r[0])}&`}}s("sap-language");s("sap-client");return new Promise((e,t)=>{o.get(`${a}&shellType=${r.getShellType()}&depth=0${i}`,false,a=>{const r=JSON.parse(a);if(!r){t(new Error("Malformed Full TM Result"))}e(r)},e=>{t(new Error(e))})})};c.prototype._formatDirectStart=function(e){const r=this;if(!e){this._aInitialSegment=undefined;return[]}function i(e,i){const n={};const o=e.match(/^([^-]+)-([^~]+)/);if(!o){s.warning(`The target mapping id ${e} is not valid`,"this target mapping will be discarded","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");return undefined}if(!i.hasOwnProperty("text")){i.text=""}n.semanticObject=o[1];n.action=o[2];n.id=e;n.title=i.text;n.permanentKey=`X-SAP-UI2-PAGE:${i.catalogId}:${i.tmChipId}`;n.contentProviderId="";const l={};["applicationType","applicationDependencies","applicationData","postParameters","text","url","systemAlias"].forEach(e=>{l[e]=i[e]});n.resolutionResult=c.prototype._adjustNavTargetResult(l);n.resolutionResult.additionalInformation=n.resolutionResult.additionalInformation||"";n.resolutionResult.appId=n.permanentKey;const p=n.resolutionResult;const u=p.applicationType;if(e.indexOf("Shell-startWCF")===0&&u==="URL"){n.resolutionResult.systemAliasSemantics="apply"}n.resolutionResult.applicationType=r._formatApplicationType(e,n.resolutionResult);n.resolutionResult.systemAlias=i.systemAlias||"";n.deviceTypes=i.formfactors;n.resolutionResult["sap.ui"]={};n.resolutionResult["sap.ui"].technology=n.resolutionResult.applicationType;if(n.resolutionResult["sap.ui"].technology==="SAPUI5"){n.resolutionResult["sap.ui"].technology="UI5"}if(n.resolutionResult["sap.ui"].technology==="TR"){n.resolutionResult["sap.ui"].technology="GUI"}if(!n.deviceTypes){n.deviceTypes=i.formFactors||{}}n.deviceTypes.desktop=n.deviceTypes.desktop||false;n.deviceTypes.phone=n.deviceTypes.phone||false;n.deviceTypes.tablet=n.deviceTypes.tablet||false;if(Array.isArray(i.signature)){n.signature={};n.signature.additionalParameters=i.allowParams?"allowed":"ignored";n.signature.parameters={};i.signature.forEach(e=>{const t={};let a;const i=e.name;if(e.defaultValue&&e.defaultValue.value){t.defaultValue={};t.defaultValue.value=e.defaultValue.value;t.defaultValue.format=e.defaultValue.format||"plain";a=r._extractUserDefaultValue(t.defaultValue.value);if(a){t.defaultValue={value:a,format:"reference"}}}if(e.filter&&e.filter.value){t.filter={};t.filter.value=e.filter.value;t.filter.format=e.filter.format||"plain";a=r._extractUserDefaultValue(t.filter.value);if(a){t.filter={value:a,format:"reference"}}}if(e.renameTo){t.renameTo=e.renameTo}t.required=e.required||false;n.signature.parameters[i]=t})}else{n.signature=a({parameters:{}},i.signature);n.signature.additionalParameters=n.signature.additionalParameters||(i.allowParams?"allowed":"ignored");Object.keys(n.signature.parameters).forEach(e=>{const t=n.signature.parameters[e];if(t.filter){t.filter.format=t.filter.format||"plain"}if(t.defaultValue){t.defaultValue.format=t.defaultValue.format||"plain"}t.required=t.required||false;if(t.filter&&t.filter.hasOwnProperty("format")&&!t.filter.hasOwnProperty("value")){delete t.filter}if(t.defaultValue&&t.defaultValue.hasOwnProperty("format")&&!t.defaultValue.hasOwnProperty("value")){delete t.defaultValue}})}const f=n.signature&&n.signature.parameters&&n.signature.parameters["sap-hide-intent-link"];if(f&&f.hasOwnProperty("defaultValue")){n.hideIntentLink=f.defaultValue.value==="true"}if(f&&!f.required&&f.hasOwnProperty("defaultValue")){delete n.signature.parameters["sap-hide-intent-link"]}if(typeof i.parameterMappings==="object"){Object.keys(i.parameterMappings).forEach(e=>{const t=i.parameterMappings[e];if(e&&t.target){n.signature.parameters[e]=n.signature.parameters[e]||{};n.signature.parameters[e].renameTo=t.target}})}if(n.resolutionResult.applicationType==="URL"&&t(i.urlTemplate)){n.templateContext=r.getUrlTemplateContext(i)}if(i.tcode){n.resolutionResult.appInfo={"abap.transaction":i.tcode}}return n}const n=[];Object.keys(e).forEach(t=>{const a=i(t,e[t]);if(a){n.push(a)}});return n};c.prototype._formatApplicationType=function(e,t){const a=t.applicationType;const r=t.url||"";function i(t,a){s.warning(`Cannot detect application type for TargetMapping id '${e}', will default to ${a} application type`,`TargetMapping URL is '${r}'`,u)}if(a==="SAPUI5"){return"SAPUI5"}if(a==="URL"&&t.additionalInformation&&t.additionalInformation.indexOf("SAPUI5.Component=")===0){return"SAPUI5"}if(a==="WDA"||a==="TR"||a==="WCF"){return a}if(e.indexOf("Shell-startWCF")===0&&a==="URL"){return"WCF"}if(a==="NWBC"){if(r.indexOf("/~canvas;window=app/wda")>=0){return"WDA"}if(r.indexOf("/~canvas;window=app/transaction")>=0){return"TR"}i(t,"TR");return"TR"}if(a!=="URL"){i(t,"URL")}return"URL"};c.prototype._extractUserDefaultValue=function(e){let t;const a=new RegExp("^%%(UserDefault[.].+)%%$");const r=a.exec(e);return r?r[1]:t};c.prototype._formatSignature=function(e,t){const a=this;const r={parameters:{},additionalParameters:t===false?"ignored":"allowed"};if(!e.results){return r}e.results.forEach(t=>{const i=t.name;let n;if(Object.prototype.hasOwnProperty.call(r.parameters,i)){s.error(`Duplicate property name ${i} in ${JSON.stringify(e)}`,"ClientSideTargetResolutionAdapter._formatSignature")}r.parameters[i]={required:a._getObjectDefaulting(t,"required",false)};const o=r.parameters[i];const l=a._getObjectDefaulting(t,"value","");if(t.regexp===true){o.filter={value:l===""?".*":l,format:"regexp"};return}if(t.required===false){n=a._extractUserDefaultValue(l);if(n){o.defaultValue={value:n,format:"reference"};return}if(l!==""){o.defaultValue={value:l}}return}if(t.required===true&&t.value){n=a._extractUserDefaultValue(l);if(n){o.filter={value:n,format:"reference"};return}if(l!==""){o.filter={value:l}}}});return r};c.prototype._mergeParameterMappingsIntoSignature=function(e,t){const a=t.results;if(!a){return}a.forEach(t=>{const a=t.source;const r=t.target;if(r){e.parameters[a]=e.parameters[a]||{};if(e.parameters[a].renameTo){s.warning(`duplicate parameter mapping for'${a}'`,`OData Parameter mappings is ${JSON.stringify(t,null,"   ")}`,u)}e.parameters[a].renameTo=r}})};c.prototype._formatDeviceTypes=function(e){const t={};const a=this;["desktop","tablet","phone"].forEach(r=>{t[r]=a._getObjectDefaulting(e,r,false)});return t};c.prototype._getObjectDefaulting=function(t,a,r){const i=e.get(a||"",t);return i===undefined?r:i};c.prototype._constructShellHashForLpdCust=function(a,r){let n="";let o;const l=e.get("resolutionResult._original",a);if(!t(l)){o="the given target mapping is not an object"}if(!o&&!l.hasOwnProperty("id")){o="no id found in target mapping _original object"}if(!o&&typeof l.id!=="string"){o="the target mapping id was not a string"}if(!o&&l.id.length===0){o="the target mapping id was an empty string"}if(o){s.error("Cannot construct Shell Hash for LPD_CUST resolution",o,"sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");return undefined}n+=l.id;const p=i.paramsToString(r);if(p.length>0){n+=`?${p}`}return n};c.prototype._openBatchQueueUnlessOpen=function(e){if(e.isBatchQueueOpen()){return false}e.openBatchQueue();return true};c.prototype._resolveHashFragmentBE=function(e){const t=this;const a=o.getFormFactor();function i(e){return encodeURIComponent(e).replace(/'/g,"''")}const n=this._openBatchQueueUnlessOpen(this._getODataWrapper());function l(e,t){if(e){t+=t.indexOf("?")<0?"?":"&";t+=e}return t}return new Promise((o,p)=>{this._oODataWrapper.read(`ResolveLink?linkId='${i(e)}'&shellType='${r.getShellType()}'${a?`&formFactor='${i(a)}'`:""}`,a=>{let r;let i="";let n;if(a.results.length){if(a.results.length>1){for(r=0;r<a.results.length;r+=1){delete a.results[r].__metadata;i+=(r===0?"used target: ":"\nignored target: ")+JSON.stringify(a.results[r])}s.error("INTEROP service's ResolveLink operation "+`returned ${a.results.length} targets for hash '#${e}', first one is used.`,i,"sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter")}a=a.results[0];n=c.prototype._adjustNavTargetResult(a);n.url=l(a.postParameters,n.url);if(n&&n.applicationType==="SAPUI5"){n.applicationType="URL"}t._compactTooLongWdaUrl(n).then(e=>{o(e)}).catch(t=>{s.error(`Could not resolve link '${e}' due to compactation failure`,t);p(t)})}else{p(new Error(`Could not resolve link '${e}'`))}},e=>{p(new Error(e))});if(n){t._getODataWrapper().submitBatchQueue(()=>{},e=>{p(new Error(e))})}})};c.prototype._compactTooLongWdaUrl=function(e){const t=e&&e.url;return new Promise((a,r)=>{if(e&&e.applicationType==="NWBC"&&t&&t.indexOf("/ui2/nwbc/~canvas;window=")===0&&t.length>this._getWDAUrlShorteningLengthLimit()){this._compactUrl(t).then(t=>{e.url=t;a(e)}).catch(r)}else{a(e)}})};c.prototype._compactUrl=function(e){const t=e.match(/\?.*/);const a=t&&t[0];const r=this._getWDAUrlShorteningLengthLimit()-200;return new Promise((s,n)=>{if(a&&a.length<r){return s(e)}const o=i.parseParameters(t[0]);p.getServiceAsync("ShellNavigationInternal").then(t=>{t.compactParams(o,f,undefined).done(t=>{const a=`${e.match(/^[^?]*/)[0]}?${i.paramsToString(t)}`;s(a)}).fail(n)}).catch(n)})};c.prototype._getWDAUrlShorteningLengthLimit=function(){const e=r.getParameterValueBoolean("sap-ushell-nowdaurlshortening");if(e){return 6e6}return this._wdLengthLimit};c.prototype.resolveSystemAlias=function(e){let t;const a=this;let r;return new Promise((i,n)=>{function o(){r=a._readSystemAliasFromBuffer(e);if(r){s.debug(`System alias '${e}' is now in buffer`,"Skipping INTEROP service call","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");i(r)}else{s.debug(`System alias '${e}' still not in buffer`,"Resolving via INTEROP service","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");a._readSystemAliasViaInterop(e).catch(e=>{n(e)}).then(e=>{r=a._fixSystemAlias(e);if(r&&r.id){a._writeSystemAliasToBuffer(r);i(r)}else{t="Data returned for system alias is not valid. Has no 'id'. System alias data will not be cached.";s.warning(`ClientSideTargetResolutionAdapter: ${t}`);i(r)}})}}r=this._readSystemAliasFromBuffer(e);if(r){s.debug(`System alias '${e}' was already buffered`,"","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");window.setTimeout(()=>{i(r)},0)}else{s.debug(`System alias '${e}' is not in buffer`,"","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");this._oInitialSegmentPromise.finally(o)}})};c.prototype._writeUserSystemAliasesToBuffer=function(e){const a=this;if(typeof e==="undefined"){return}if(t(e)){Object.keys(e).forEach(t=>{a._writeSystemAliasToBuffer(a._fixSystemAlias(e[t]))});return}e.forEach(e=>{a._writeSystemAliasToBuffer(a._fixSystemAlias(e))})};c.prototype._readSystemAliasFromBuffer=function(e){const t=this._oSystemAliasBuffer.get(e);if(e===""){if(!t){return this._oLocalSystemAlias}t.properties=a({},this._oLocalSystemAlias.properties,t.properties||{})}return t};c.prototype._writeSystemAliasToBuffer=function(e){if(e&&e.id){this._oSystemAliasBuffer.put(e.id,e)}return e};c.prototype._fixSystemAlias=function(e){e=e||{};delete e.__metadata;const t={};t.id=e.id||"";t.client=e.client||"";t.language=e.language||"";["http","https"].forEach(r=>{if(e.hasOwnProperty(r)){delete e[r].__metadata;if(e[r].id!==""){t[r]=a({id:"",host:"",port:"",pathPrefix:""},e[r])}}});if(e.hasOwnProperty("rfc")&&e.rfc.id){delete e.rfc.__metadata;t.rfc=a({id:"",systemId:"",host:"",service:0,loginGroup:"",sncNameR3:"",sncQoPR3:""},e.rfc)}return t};c.prototype._readSystemAliasViaInterop=function(e){const t=`SystemAliases(id='${encodeURIComponent(e)}')?$format=json`;return new Promise((e,a)=>{this._getODataWrapper().read(t,t=>{e(t)},e=>{a(new Error(e))})})};c.prototype.getSystemAliases=function(){return this._oSystemAliasBuffer&&this._oSystemAliasBuffer.entries||{}};c.prototype.getUrlTemplateContext=function(e){const t=this._oURLTemplates[e.urlTemplate.id];if(!t){s.error("No URL template found.");return null}const a={systemAliases:this.getSystemAliases(),urlTemplates:this._oURLTemplates};return{payload:t.payload,site:a,siteAppSection:e}};return c});
//# sourceMappingURL=ClientSideTargetResolutionAdapter.js.map