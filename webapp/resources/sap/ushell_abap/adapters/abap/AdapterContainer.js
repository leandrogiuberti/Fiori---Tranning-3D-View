// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/ObjectPath","sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/core/format/DateFormat","sap/ushell_abap/pbServices/ui2/ODataService","sap/ushell/services/_Personalization/constants","sap/ushell/utils/LaunchpadError"],(e,t,jQuery,n,r,o,i)=>{"use strict";const a="PersContainers";const s="yyyyMMddHHmmss";const c=new Date(9999,1,1,0,0,0);const p=new Date(9999,1,1,0,0,0,0);const u="ADMIN#sap-ushell-container-expireUTCTimestamp";const l="ADMIN#sap-ushell-container-storageUTCTimestamp";const y="ADMIN#sap-ushell-container-scope";function h(e){const n="sap.ushell.personalization#";if(e.substring(0,n.length)!==n){t.error(`Unexpected ContainerKey ${e}`);return e}return e.substring(n.length,n.length+40)}function f(t,n,r,o){this._oService=n;this._oScope=r;this["sap-cache-id"]=e.get("_oService._oConfig.services.personalization.cacheId",this);this._sContainerKey=h(t);this._sAppName=o||"";this._category=this._determineCategory(r);this._oJSONContainer={category:this._category,clientExpirationTime:p,appName:this._sAppName,component:"",id:this._sContainerKey,PersContainerItems:[]};this._oPropertyBag={};this._aOperationQueue=[]}f.prototype._reset=function(){this._oJSONContainer.PersContainerItems=[]};f.prototype._obtainODataWrapper=function(){return this._oService._oWrapper};f.prototype.load=function(){const e=new jQuery.Deferred;const n=this;const o=this._obtainODataWrapper();let s=`${a}(category='${this._category}',id='${encodeURIComponent(this._sContainerKey)}')?$expand=PersContainerItems`;if(this._category&&this._category==="P"&&this["sap-cache-id"]){s=`${s}&sap-cache-id=${this["sap-cache-id"]}`}r.call(this,o,()=>false);o.read(s,t=>{n._oJSONContainer=t;n._oJSONContainer.category=n._category;n._oJSONContainer.id=n._sContainerKey;n._oJSONContainer.appName=n._sAppName;n._oJSONContainer.PersContainerItems=n._oJSONContainer.PersContainerItems&&n._oJSONContainer.PersContainerItems.results||[];e.resolve(n)},(n,r)=>{t.error(n);e.reject(new i(n,r))});return e.promise()};f.prototype.save=function(){t.debug("[000] save","AdapterContainer");const e=new jQuery.Deferred;const n=this;const o=this._obtainODataWrapper();const s=a;r.call(this,o,()=>false);o.create(s,this._oJSONContainer,()=>{e.resolve(n)},(t,n)=>{e.reject(new i(t,n))});return e.promise()};f.prototype.del=function(){const e=new jQuery.Deferred;const t=this;const n=this._obtainODataWrapper();const o=`${a}(category='${this._category}',id='${encodeURIComponent(this._sContainerKey)}')`;r.call(this,n,()=>false);n.del(o,n=>{e.resolve(t)},(t,n)=>{e.reject(new i(t,n))});this._reset();return e.promise()};f.prototype.getItemKeys=function(){const e=[];this._oJSONContainer.PersContainerItems.forEach(t=>{if(t.category==="V"){e.push(`VARIANTSET#${t.id}`)}else if(t.category==="I"){e.push(`ITEM#${t.id}`)}});if(this._oJSONContainer.validity>=0){e.push(l);e.push(u);e.push(y)}return e};f.prototype.containsItem=function(e){return this.getItemKeys().indexOf(e)>=0};function d(e){if(e===undefined||e===null){return null}const t=n.getDateInstance({pattern:s});return t.parse(JSON.parse(e),true)}function _(e){const r=n.getDateInstance({pattern:s});if(e===null){e=p}if(typeof e==="string"){if(/\/Date\(([0-9]+)\)\//.exec(e)){e=new Date(parseInt(/\/Date\(([0-9]+)\)\//.exec(e)[1],10))}else{t.error(`Expected Date format ${e}`)}}if(+e===+p){return undefined}return r.format(e,true)}f.prototype._findItemIndex=function(e,t){let n;for(n=0;n<this._oJSONContainer.PersContainerItems.length;n=n+1){if(this._oJSONContainer.PersContainerItems[n].id===e&&this._oJSONContainer.PersContainerItems[n].category===t){return n}}return undefined};f.prototype._locateItem=function(e){const n={index:-1};if(e===u){return{containerProperty:"clientExpirationTime",initialValue:p,convToABAP:d,convFromABAP:_}}if(e===y){return{containerProperty:"validity",initialValue:0,convToABAP:function(e){if(!e){return null}return JSON.parse(e).validity},convFromABAP:function(e,t){if(e<=0){return undefined}t=t||{};t.validity=e;return t}}}if(e===l){return{containerProperty:" ignore",initialValue:c,convToABAP:d,convFromABAP:_}}if(e.indexOf("ITEM#")===0){n.trueItemKey=e.substring("ITEM#".length,"ITEM#".length+40);n.category="I"}else if(e.indexOf("VARIANTSET#")===0){n.trueItemKey=e.substring("VARIANTSET#".length,"VARIANTSET#".length+40);n.category="V"}else if(e.indexOf("ADMIN#")!==0){t.error(`Unknown itemkey prefix${e}`)}n.index=this._findItemIndex(n.trueItemKey,n.category);return n};f.prototype.getItemValue=function(e){let t="";let n;const r=this._locateItem(e);if(r.containerProperty===" ignore"){return undefined}if(r.index>=0){t=this._oJSONContainer.PersContainerItems[r.index].value;try{n=JSON.parse(t)}catch{if(t==="X"){n=true}else{n=undefined}}}if(r.containerProperty){if(typeof r.convFromABAP==="function"){return r.convFromABAP(this._oJSONContainer[r.containerProperty],n)}return this._oJSONContainer[r.containerProperty]}return n};f.prototype.setItemValue=function(e,t){const n=JSON.stringify(t);const r=this._locateItem(e);if(r.containerProperty===" ignore"){return}if(r.containerProperty){if(typeof r.convToABAP==="function"){this._oJSONContainer[r.containerProperty]=r.convToABAP(n)}else{this._oJSONContainer[r.containerProperty]=n}if(!r.trueItemKey){return}}if(r.index>=0){this._oJSONContainer.PersContainerItems[r.index].value=n;return}this._oJSONContainer.PersContainerItems.push({value:n,id:r.trueItemKey,category:r.category,containerId:this._sContainerKey,containerCategory:this._category})};f.prototype.delItem=function(e){const t=this._locateItem(e);if(t.containerProperty===" ignore"){return}if(t.containerProperty){this._oJSONContainer[t.containerProperty]=t.initialValue;return}if(t.index>=0){this._oJSONContainer.PersContainerItems.splice(t.index,1);return}};f.prototype._determineCategory=function(e){if(!e){return"U"}const t=o;if(e.keyCategory&&e.keyCategory===t.keyCategory.FIXED_KEY&&e.writeFrequency&&e.writeFrequency===t.writeFrequency.LOW&&e.clientStorageAllowed&&e.clientStorageAllowed===true){return"P"}return"U"};return f});
//# sourceMappingURL=AdapterContainer.js.map