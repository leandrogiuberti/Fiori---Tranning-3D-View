// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/URI","sap/ushell/components/cards/ManifestPropertyHelper","sap/ui/thirdparty/jquery","sap/base/util/ObjectPath","sap/base/util/isEmptyObject","sap/m/GenericTile","sap/ushell/Config","sap/base/util/deepExtend","sap/ushell/utils/chipsUtils","sap/ushell_abap/pbServices/ui2/Utils","sap/ushell_abap/pbServices/ui2/Page","sap/base/Log","sap/m/library","sap/ushell/ui/tile/StaticTile","sap/ushell/utils","sap/ushell_abap/pbServices/ui2/contracts/preview","sap/ushell/Container","sap/ushell/utils/LaunchpadError"],(e,t,jQuery,i,r,n,o,s,a,l,c,u,g,p,f,d,h,_)=>{"use strict";const C=g.LoadState;const m="sap.ushell_abap.adapters.abap.LaunchPageAdapter";const y="/UI2/Fiori2LaunchpadHome";const T="/UI2/FLPD_CATALOG";const I="X-SAP-UI2-CHIP:/UI2/DYNAMIC_APPLAUNCHER";const P="X-SAP-UI2-CHIP:/UI2/STATIC_APPLAUNCHER";const b="X-SAP-UI2-CHIP:/UI2/CARD";const S={catalogTileNotFound:"catalogTileNotFound",referenceTileNotFound:"referenceTileNotFound",noTargetMapping:"noTargetMapping",emptyConfiguration:"emptyConfiguration",tileIntentSupportException:"tileIntentSupportException"};const v="/UI2/FLPNoActionChip";function w(g,E,O){let k;let A;let x;const j=new l.Map;const D=O&&O.config||{};const B=D.services&&D.services.launchPage;const N={};const $=this;this._oCurrentPageSet=null;this._bPageSetFullyLoaded=false;this._aOtherChipsPromises=[];d.setEnvironmentType("runtime");function L(e,t,i){try{return e.getImplementationAsSapui5()}catch(e){u.error(i,e,m);return new p({icon:"sap-icon://error",info:"",infoState:"Critical",subtitle:e.message||e,title:t}).addStyleClass("sapUshellTileError")}}w.prototype._getBagText=function(e,t,i){if(e.getBagIds().indexOf(t)>-1&&e.getBag(t).getTextNames().indexOf(i)>-1){return e.getBag(t).getText(i)}return undefined};w.prototype._getConfigurationProperty=function(e,t,i){let r;let n;try{r=e.getConfigurationParameter(t);n=JSON.parse(r)}catch{return undefined}if(n[i]!==undefined){return n[i]}return undefined};w.prototype._orderBasedOnConfiguration=function(e,t){let i=e&&l.isArray(e.order)?e.order:[];const r={};const n=[];let o;let s;let a;i=i.concat(e&&l.isArray(e.linkOrder)?e.linkOrder:[]);for(s=0,a=t.length;s<a;s+=1){o=t[s];r[o.getId()]=o}for(s=0,a=i.length;s<a;s+=1){const e=i[s];if(Object.prototype.hasOwnProperty.call(r,e)){n.push(r[e]);delete r[e]}}for(s=0,a=t.length;s<a;s+=1){o=t[s];if(Object.prototype.hasOwnProperty.call(r,o.getId())){n.push(o)}}return n};function R(e,t){const i=e.indexOf(t);if(i<0){return i}e.splice(i,1);return i}function F(e,t,i){if(i==="link"){return R(e.linkOrder,t.getId())}return R(e.order,t.getId())}function G(e,t,i,r){if(r==="link"){i=i-e.order.length;e.linkOrder.splice(i,0,t)}else{e.order.splice(i,0,t)}}function U(e,t){const i=t.getGroupTiles(e);const r={order:[],linkOrder:[]};i.forEach(e=>{const i=t.getTileType(e);if(i==="link"){r.linkOrder.push(e.getId())}else{r.order.push(e.getId())}});return r}function M(){let e;try{e=JSON.parse($._oCurrentPageSet.getConfiguration());e.order.splice(0,0,$._oCurrentPageSet.getDefaultPage().getId())}catch{e={order:[$._oCurrentPageSet.getDefaultPage().getId()]}}return w.prototype._orderBasedOnConfiguration(e,$._oCurrentPageSet.getPages())}this.hideGroups=function(e){const t=new jQuery.Deferred;if(!e||!(e instanceof Array)){t.reject(new Error("Input parameter must be of type Array."))}else{const i=JSON.parse($._oCurrentPageSet.getConfiguration()||"{}");i.hiddenGroups=e;$._oCurrentPageSet.setConfiguration(JSON.stringify(i),t.resolve.bind(t),e=>{t.reject(new Error(e))})}return t.promise()};this.isGroupVisible=function(e){const t=$._oCurrentPageSet.getConfiguration();if(!t){return true}const i=JSON.parse(t);if(!i||!i.hiddenGroups){return true}const r=i.hiddenGroups;for(let t=0;t<r.length;t+=1){if(r[t]===e.getId()){return false}}return true};w.prototype._triggerChipInstanceLoad=function(e){function t(){if(e._loadingDeferred){e._loadingDeferred.resolve()}delete e._loadingDeferred;delete e.$loadingPromise}function i(t){u.error(`Failed to load tile '${e.toString()}': ${t}`,null,m);if(e._loadingDeferred){e._loadingDeferred.reject(new Error(t))}delete e._loadingDeferred;delete e.$loadingPromise}e.load(t,i)};function J(e){const t=e.getChip().getBaseChipId();return t===I||t===P}function H(e){const t=e.getChip().getBaseChipId();return b===t}function q(e){return!!e.getChip().getRemoteCatalog()}function z(e){return!q(e)&&e.getChip().getBaseChipId()===undefined}this._loadApplaunchersAndDelayLoadingOfOtherChips=function(e,t){let i=0;const r=[];const n=[];function o(){if(i<=0){t()}}function s(e){e._loadingDeferred=new jQuery.Deferred;e.$loadingPromise=e._loadingDeferred.promise();$._aOtherChipsPromises.push(new Promise((t,i)=>{e.$loadingPromise.done(t).fail(i)}));if(window["sap-ui-debug"]===true){w.prototype._triggerChipInstanceLoad(e)}else{sap.ui.require(["sap/ushell/EventHub"],t=>{const i=t.on("CoreResourcesComplementLoaded");i.do(t=>{if(t.status==="success"){w.prototype._triggerChipInstanceLoad(e);i.off()}else{u.error("Did not load custom tile as core resources where not loaded",null,m)}})})}}function a(e){function t(){i-=1;o()}i+=1;e.load(t,i=>{u.error(`Failed to load tile: ${i}`,e.toString(),m);t()})}e.forEach(e=>{e.getChipInstances().forEach(e=>{if(q(e)){n.push(e)}else if(z(e)){}else if(J(e)||H(e)){a(e)}else{r.push(e)}})});r.forEach(e=>{s(e)});n.forEach(e=>{s(e)});o()};w.prototype._readTargetMappings=function(){const e=new jQuery.Deferred;function t(e){const t=[];const i=e.targetMappings||e||{};Object.keys(i).forEach(e=>{const r={};["semanticObject","semanticAction","formFactors"].forEach(t=>{r[t]=i[e][t]});t.push(r)});return t}if(i.get("compactTMPromise",D)){D.compactTMPromise.then(i=>{const r=t(i||{});e.resolve({results:r})}).catch(t=>{e.reject(t)});return e.promise()}const r=i.create("services.targetMappings",D);const n=r.cacheId||"";let o=`/sap/bc/ui2/start_up?so=%2A&action=%2A&tm-compact=true&shellType=${f.getShellType()}&depth=0`;if(n){o+=`${o.indexOf("?")<0?"?":"&"}sap-cache-id=${n}`}const s=r.sUI2CacheDisable;if(s){o+=`${o.indexOf("?")<0?"?":"&"}sap-ui2-cache-disable=${s}`}l.get(o,false,i=>{const r=JSON.parse(i);const n=r.targetMappings||{};const o=t(n);e.resolve({results:o})},t=>{e.reject(new Error(t))});return e.promise()};w.prototype._makeTargetMappingSupportKey=function(e,t){return`${e}-${t}`};w.prototype._isWrapperOnly=function(e){return!e.getConfiguration()};function V(e,t){const i=[];t.forEach(t=>{const r=t.getRemoteCatalog();if(t.getBaseChipId()==="X-SAP-UI2-CHIP:/UI2/ACTION"){return}const n=e.createChipInstance({chipId:t.getId(),remoteCatalogId:r&&r.getId()});i.push(n)});return i}function K(e){const t=$._oCurrentPageSet.getDefaultPage().getAllCatalogs();const i=t.getCatalogs();const r=[];for(let t=0;t<i.length;t+=1){const n=i[t];r.push({data:{},errorMessage:undefined,id:n.getId(),title:n.isStub()?n.getId():n.getTitle(),tiles:n.isStub()?[]:V(e,n.getChips()),ui2catalog:n})}return r}function W(e){let t;const i=e.getConfigurationParameter("tileConfiguration");try{t=JSON.parse(i||"{}")}catch(t){u.error(`Tile with ID '${e.getId()}' has a corrupt configuration containing a 'tileConfiguration' value '${i}' which could not be parsed. If present, a (stringified) JSON is expected as value.`,t,"sap.ushell_abap.adapters.abap.LaunchPageAdapter");return{}}return t}function X(e){const t={};let i;let r;let n;try{i=JSON.parse(e.getChip()._getChipRawConfigurationString());r=JSON.parse(i&&i.tileConfiguration||"{}");n=JSON.parse(r&&r.TILE_PROPERTIES||"{}");if(n.semanticObject&&n.semanticAction){t.navigation_use_semantic_object=true;t.navigation_semantic_object=n.semanticObject;t.navigation_semantic_action=n.semanticAction}}catch(e){return{}}return t}function Q(e){let t;if(e.getChip().getBaseChipId()==="X-SAP-UI2-CHIP:/UI2/AR_SRVC_NEWS"){return{navigation_use_semantic_object:true,navigation_semantic_object:"NewsFeed",navigation_semantic_action:"displayNewsList",navigation_semantic_parameters:"",navigation_target_url:"#NewsFeed-displayNewsList"}}const i=X(e);if(i.navigation_use_semantic_object){return i}try{const i=JSON.parse(e.getChip()._getChipRawConfigurationString());t=JSON.parse(i&&i.tileConfiguration||"{}")}catch(e){return{}}return t}this._parseFullChipId=function(e){const t=e.split(":");const i=t.pop();let r=null;if(t.length>2){r=t.shift()}return{id:i,prefix:r,catalog:t.join(":")}};this.getTargetMappingSupport=function(){return j};this._parseReferenceLost=function(e){const t=e||"";if(!t.match(/^Reference lost: Note \d+ Page.+\s,\sInstance ID.+$/)){u.warning("The string that describes a lost reference is in an unexpected format",`This is expected to be a string exactly like 'Reference lost: Note <#> Page <CATALOG_ID> , Instance ID <CHIP_ID>' instead of the given '${e}'`,"sap.ushell_abap.adapters.abap.LaunchPageAdapter");return{id:"Unknown",catalog:"Unknown"}}const i=t.split(" , ").map(e=>e.split(" ").pop());return{id:i[1],catalog:i[0]}};this._flattenArray=function(e){const t=this;if(Object.prototype.toString.apply(e)!=="[object Array]"){return e}return e.reduce((e,i)=>e.concat(t._flattenArray(i)),[])};this._findAndReportTileErrors=function(e,t){const i=this._getPossibleTileErrors(e,t);if(i.length>0){this._reportTileErrors(i)}};this._getPossibleTileErrors=function(e,t){const i=this;return e.map(e=>({group:{id:e.getId(),title:e.getTitle()},errors:i._getPossibleTileErrorsFromOnePage(e,t)}))};this._getPossibleTileErrorsFromOnePage=function(e,t){const i=this;const r=e.getChipInstances().reduce((e,r)=>{let n;let o;const s=r.getChip();const a=i._parseFullChipId(s.getId());if(!s.isInitiallyDefined()){e.push({type:S.catalogTileNotFound,chipInstanceId:r.getId(),chipId:a.id,chipCatalogId:a.catalog})}else if(s.isReference()&&s.isBrokenReference()){const t=i._parseReferenceLost(s.getTitle());e.push({type:S.referenceTileNotFound,chipInstanceId:r.getId(),referenceChipId:a.id,referenceChipCatalogId:a.catalog,missingReferredChipId:t.id,missingReferredCatalogId:t.catalog})}else{try{n=i._checkTileIntentSupport(r,t)}catch(e){n={isSupported:false,reason:S.tileIntentSupportException,exception:e}}if(!n.isSupported){const t=i._getBagText(r,"tileProperties","display_title_text");const s=i._getBagText(r,"tileProperties","display_subtitle_text");switch(n.reason){case S.noTargetMapping:if(J(r)){o=W(r)}else{o=Q(r)}e.push({type:S.noTargetMapping,chipInstanceId:r.getId(),chipInstanceTitle:t||o.display_title_text||r.getTitle(),chipInstanceSubtitle:s||o.display_subtitle_text,tileURL:o.navigation_target_url||`#${o.navigation_semantic_object}-${o.navigation_semantic_action}${o.navigation_semantic_parameters?`?${o.navigation_semantic_parameters}`:""}`});break;case S.emptyConfiguration:const i=r.getConfigurationParameter("tileConfiguration");e.push({type:S.emptyConfiguration,chipInstanceId:r.getId(),chipInstanceTitle:t||r.getTitle(),chipInstanceSubtitle:s||null,tileConfiguration:i});break;case S.tileIntentSupportException:e.push({type:S.tileIntentSupportException,exception:n.exception,chipInstanceId:r.getId()});break;case S.referenceTileNotFound:break;default:}}}return e},[]);return r};this._formatTileError=function(e){switch(e.type){case S.catalogTileNotFound:return`comes from catalog tile with ID '${e.chipId}' but this cannot be found in catalog '${e.chipCatalogId}' (CATALOG TILE NOT FOUND).`;case S.referenceTileNotFound:return`comes from reference tile '${e.referenceChipId}'`+` in catalog '${e.referenceChipCatalogId}'`+` which in turn refers to the tile '${e.missingReferredChipId}'`+` from catalog '${e.missingReferredCatalogId}', but this is missing (REFERENCED TILE NOT FOUND).`;case S.noTargetMapping:return`was hidden because a target mapping for the tile URL '${e.tileURL}' was not found (TARGET MAPPING NOT FOUND).`;case S.emptyConfiguration:return`the tile configuration '${e.tileConfiguration}' is empty or invalid (BAD CONFIGURATION).`;case S.tileIntentSupportException:return`exception occurred while checking tile intent support: ${e.exception} (EXCEPTION RAISED).`;default:return`unknown error type '${e.type}' (UNKNOWN ERROR). Error data: ${JSON.stringify(e,null,3)}`}};this._reportTileErrors=function(e){const t=this;const i=[];const r=[];function n(e,t){const i=[e,t].map((e,t)=>t===1&&e?`(${e})`:e).filter(e=>typeof e==="string"&&e.length>0).join(" ");return i.length>0?`'${i}'`:""}e.forEach(e=>{const o=`  in Group '${e.group.title}' with Group ID '${e.group.id}'`;const s=[];const a=[];e.errors.forEach(e=>{const i=["  - tile instance",n(e.chipInstanceTitle,e.chipInstanceSubtitle),`with ID '${e.chipInstanceId}'`].filter(e=>e.length>0).join(" ");if(e.type===S.noTargetMapping){a.push([i,`    ${t._formatTileError(e)}`].join("\n"))}else{s.push([i,`    ${t._formatTileError(e)}`].join("\n"))}});if(s.length>0){r.push([o,s.join("\n")].join("\n"))}if(a.length>0){i.push([o,a.join("\n")].join("\n"))}});if(r.length>0){r.unshift("Tile error(s) were detected:");u.error(r.join("\n"),null,"sap.ushell_abap.adapters.abap.LaunchPageAdapter")}if(i.length>0){i.unshift("Tile warning(s) were detected:");u.warning(i.join("\n"),null,"sap.ushell_abap.adapters.abap.LaunchPageAdapter")}};this.getGroups=function(){if(this._bPageSetFullyLoaded){return(new jQuery.Deferred).resolve(M()).promise()}if(!A){A=new jQuery.Deferred;const e=new jQuery.Deferred;h.getServiceAsync("PageBuilding").then(t=>{const i=t.getFactory().getPageBuildingService().readPageSet;if(B&&B.cacheId){i.cacheBusterTokens.put(y,B.cacheId)}if(B&&B["sap-ui2-cache-disable"]&&i){const e=i.appendedParameters||{};e["sap-ui2-cache-disable"]=B["sap-ui2-cache-disable"];i.appendedParameters=e}const r=this._loadTargetMappings();if(o.last("/core/spaces/enabled")){const e=t.getFactory();const i=new c(e,{id:v});$._oCurrentPageSet={getDefaultPage:function(){return i},getPages:function(){return[i]},appendPage:function(){throw new Error("Not implemented in Pages Runtime")},isPageRemovable:function(){return false},removePage:function(){throw new Error("Not implemented in Pages Runtime")},isPageResettable:function(){return true},resetPage:function(){},getConfiguration:function(){return"{}"},setConfiguration:function(){},filter:function(){}};A.resolve([])}else{const i=t.getPageSet(y);i.fail(e.reject.bind(e)).done(t=>{this._oCurrentPageSet=t;this._oCurrentPageSet.filter([y],[T]);this._loadApplaunchersAndDelayLoadingOfOtherChips(t.getPages(),e.resolve.bind(e,t))});jQuery.when(r,e).done((e,t)=>{this._bPageSetFullyLoaded=true;if(u.getLevel()>=u.Level.DEBUG){this._findAndReportTileErrors(t.getPages(),j)}A.resolve(M())}).fail(A.reject.bind(A))}})}return A.promise()};this._loadTargetMappings=function(){if(this._oTargetMappingPromise){return this._oTargetMappingPromise}this._oTargetMappingPromise=this._readTargetMappings().done(e=>{const t=l.getFormFactor();e.results.forEach(e=>{const i=w.prototype._makeTargetMappingSupportKey(e.semanticObject,e.semanticAction);j.put(i,j.get(i)||!!(e.formFactors&&e.formFactors[t]))})});return this._oTargetMappingPromise};this.getGroupsAndWaitForAllChips=function(){return new Promise((e,t)=>{$.getGroups().done(e).fail(t)}).then(e=>Promise.allSettled($._aOtherChipsPromises).then(()=>e))};this.getDefaultGroup=function(){const e=new jQuery.Deferred;this.getGroups().done(()=>{e.resolve($._oCurrentPageSet.getDefaultPage())}).fail(e.reject.bind(e));return e.promise()};this.getGroupTitle=function(e){return e.getTitle()};this.getGroupId=function(e){return e.getId()};this.getGroupTiles=function(e){let t;try{t=JSON.parse(e.getLayout())}catch(t){u.warning(`Group ${e.getId()}: invalid layout: ${e.getLayout()}`,t,m)}return this._orderBasedOnConfiguration(t,e.getChipInstances())};this.getGroupTileClones=function(e){const t=this.getGroupTiles(e);const i=t.map(e=>e.clone());return Promise.allSettled(i).then(e=>e.map(e=>{if(!e.value){u.warning("Group tile was filtered out: ",e.reason)}return e.value}).filter(e=>e))};this.addGroup=function(e){const t=new jQuery.Deferred;$._oCurrentPageSet.appendPage(e,T,t.resolve.bind(t),e=>{t.reject(new Error(e),M())});return t.promise()};this.removeGroup=function(e){const t=new jQuery.Deferred;if($._oCurrentPageSet.isPageRemovable(e)){$._oCurrentPageSet.removePage(e,t.resolve.bind(t),i=>{u.error(`Failed to remove group '${e.toString()}'`,i,m);t.reject(new Error(i),M())})}else{t.reject(new Error("Group is not removable"),M())}return t.promise()};this.resetGroup=function(e){const t=new jQuery.Deferred;const i=this;if(i._oCurrentPageSet.isPageRemovable(e)){t.reject(new Error("Group is not removable"),M())}else if(i._oCurrentPageSet.isPageResettable(e)){i._oCurrentPageSet.resetPage(e,()=>{i._loadApplaunchersAndDelayLoadingOfOtherChips([e],t.resolve.bind(t,e))},e=>{t.reject(new Error("Failed to reset group"),M())})}else{t.resolve(e)}return t.promise()};this.isGroupRemovable=function(e){return $._oCurrentPageSet.isPageRemovable(e)};this.isGroupLocked=function(e){return e.isPersonalizationLocked()};this.isLinkPersonalizationSupported=function(e){if(!e){return true}if(!e.isStub()){const t=e.getContract&&e.getContract("types");const i=t&&t.getAvailableTypes()||[];return i.indexOf("link")!==-1}return false};this.isTileIntentSupported=function(e){if(!this._oTargetMappingPromise||this._oTargetMappingPromise.state()!=="resolved"){u.error("isTileIntentSupported might return wrong results as data loading hasn't finished yet!","sap.ushell_abap.adapters.abap.LaunchPageAdapter")}let t;const i=this._checkTileIntentSupport(e,j);if(!i.isSupported&&i.reason===S.noTargetMapping){if(J(e)){t=W(e)}else{t=Q(e)}const i=this._getBagText(e,"tileProperties","display_title_text")||t.display_title_text;const r=this._getBagText(e,"tileProperties","display_subtitle_text")||t.display_subtitle_text;const n=t.navigation_target_url;u.warning(`Group tile with ID '${e.getId()}' is filtered out as the current user has no target mapping assigned for the intent '${n}'`,`\nGroup Tile ID: '${e.getId()}'\n`+`Title: '${i}'\n`+`Subtitle: '${r}'\n`+`Intent: '${n}' - `,"sap.ushell_abap.adapters.abap.LaunchPageAdapter")}return i.isSupported};this.isTileIntentSupportedAsync=function(e){return this._loadTargetMappings().then(()=>this.isTileIntentSupported(e))};this._checkTileIntentSupport=function(e,t){let i;let n;const o=w.prototype._makeTargetMappingSupportKey;if(!J(e)){i=Q(e);if(!i.navigation_use_semantic_object||!i.navigation_semantic_object||!i.navigation_semantic_action){return{isSupported:true}}n=t.get(o(i.navigation_semantic_object,i.navigation_semantic_action));if(!n){n=t.get(o("*",i.navigation_semantic_action))}if(!n){return{isSupported:false,reason:S.noTargetMapping}}return{isSupported:true}}if(e.isStub()){u.error("Applauncher Tile not loaded completely! This might be caused by a RemoteCatalog content. Standard Tiles are not supported as part of RemoteCatalogs",new Error("Applauncher Tile is still a stub"),"sap.ushell_abap.adapters.abap.LaunchPageAdapter");return{isSupported:true}}if(e.getChip()&&typeof e.getChip().isBrokenReference==="function"&&e.getChip().isBrokenReference()){return{isSupported:false,reason:S.referenceTileNotFound}}i=W(e);if(r(i)){return{isSupported:false,reason:S.emptyConfiguration}}if(!i.navigation_use_semantic_object){return{isSupported:true}}n=t.get(o(i.navigation_semantic_object,i.navigation_semantic_action));if(n){return{isSupported:true}}return{isSupported:false,reason:S.noTargetMapping}};this.moveGroup=function(e,t){const i=new jQuery.Deferred;function r(e){const t=[];e.forEach(e=>{t.push(e.getId())});const r=JSON.parse($._oCurrentPageSet.getConfiguration()||"{}");r.order=t;$._oCurrentPageSet.setConfiguration(JSON.stringify(r),i.resolve.bind(i),e=>{i.reject(new Error(e),M())})}this.getGroups().done(i=>{const n=i.indexOf(e);i.splice(n,1);i.splice(t,0,e);r(i)});return i.promise()};this.setGroupTitle=function(e,t){const i=new jQuery.Deferred;e.setTitle(t,i.resolve.bind(i),t=>{i.reject(new Error("Failed to set group title"),e.getTitle())});return i.promise()};this.addTile=function(e,t){const i=new jQuery.Deferred;const r=e.getChip();if(e.isStub()){i.reject(new Error("Tile was not added to the group as the tile failed loading"),M())}else{if(!t){t=$._oCurrentPageSet.getDefaultPage()}t.addChipInstance(r,i.resolve.bind(i),e=>{i.reject(new Error(e),M())})}return i.promise()};this.removeTile=function(e,t){const i=new jQuery.Deferred;e.removeChipInstance(t,i.resolve.bind(i),e=>{i.reject(new Error(e),M())});return i.promise()};this.moveTile=function(e,t,i,r,n,o){const s=new jQuery.Deferred;const a=this._isWrapperOnly(e);const c=new l.Map;let g;function p(e){s.reject(new Error(e),M())}let f=2;function d(e){f-=1;g=g||e;if(f<=0){s.resolve(g)}}if(!n){n=r}const _=U(r,this);const C=U(n,this);const y=this.getTileType(e);t=F(_,e,y);if(t<0){u.error("moveTile: tile not found in source group",null,m);p("moveTile: tile not found in source group");return s.promise()}if(r===n){G(_,e.getId(),i,o);r.setLayout(JSON.stringify(_),s.resolve.bind(s,e),p)}else{h.getServiceAsync("PageBuilding").then(t=>{const s=t.getFactory().getPageBuildingService();const l=e.getBagIds();l.forEach(t=>{const i={texts:[],properties:[]};const r=e.getBag(t);r.getOwnTextNames().forEach(e=>{i.texts.push({name:e,value:r.getText(e)})});r.getOwnPropertyNames().forEach(e=>{i.properties.push({name:e,value:r.getProperty(e)})});if(i.texts.length>0||i.properties.length>0){c.put(t,i)}});s.openBatchQueue();const g=this.getGroupTiles(n);n.addChipInstance(a?e.getChip():e,function(e){let t;g.splice(i,0,e);l.forEach(i=>{const r=c.get(i);if(r){t=e.getBag(i);r.texts.forEach(e=>{t.setText(e.name,e.value)});r.properties.forEach(e=>{t.setProperty(e.name,e.value)});t.save(()=>{},()=>{u.error(`Bag ${i}: could not be saved`,null,m)})}});G(C,e.getId(),i,o);n.setLayout(JSON.stringify(C),d.bind(this,e),p)},p,e.isStub());r.removeChipInstance(e,d,p);r.setLayout(JSON.stringify(_),undefined,p);s.submitBatchQueue(undefined,p)})}return s.promise()};this.getTileId=function(e){return e.getId()};this.getTileType=function(e){const t=e.getPage();try{const i=JSON.parse(t.getLayout());if(i.linkOrder&&i.linkOrder.indexOf(e.getId())>-1){return"link"}}catch(e){u.warning(`Group ${t.getId()}: invalid layout: ${t.getLayout()}`,e,m)}if(e.isStub()===false){const t=e.getContract("types");if(t&&t.getAvailableTypes().indexOf("card")>-1){return"card"}}return"tile"};this.getCardManifest=function(e){try{const i=e.getConfigurationParameter("cardManifest");let r=JSON.parse(i);const n=t.getCardData(e);r=t.mergeCardData(r,n);return r}catch(t){u.error(`Manifest of card with id '${e.getId()}' could not be read.`,t)}};this.getTileTitle=function(e){return e.getTitle()};this.getTileView=function(e){const t=this;const i=new jQuery.Deferred;function r(e){u.error("Tile not successfully loaded:",e,m);i.reject(e)}function o(){let o;const s=e.getContract("types");if(s){o=t.getTileType(e);s.setType(o)}e.getImplementationAsSapui5Async().then(e=>{if(o==="link"){if(!e.hasModel()){e=e.getComponentInstance().getRootControl()}const t=e.getModel();const r=e.getController();const o=t&&t.getProperty?t.getProperty("/nav/navigation_target_url"):undefined;const s=new n({mode:"{view>/mode}",header:"{view>/config/display_title_text}",subheader:"{view>/config/display_subtitle_text}",sizeBehavior:"{view>/sizeBehavior}",size:"Auto",url:r.formatters&&r.formatters.leanURL(o),press:[r.onPress,r]});s.setModel(t,"view");i.resolve(s);return}i.resolve(e)}).catch(r)}if(!e.$loadingPromise){if(!e.isStub()){l.callHandler(o,r,!J(e))}else{r(new Error("Tile failed to load - tile is still a stub"))}}else{e.$loadingPromise.fail(r).done(()=>{try{o()}catch(e){r(e)}})}return i.promise()};this.getTileSize=function(e){const t=!e.isStub()&&e.getConfigurationParameter("row")||"1";const i=!e.isStub()&&e.getConfigurationParameter("col")||"1";return`${t}x${i}`};this.refreshTile=function(e){e.refresh()};this.setTileVisible=function(e,t){const i=!e.isStub()&&e.getContract("visible");if(i){i.setVisible(t);return}if(e.isStub()&&e.$loadingPromise){const i=this.getTileId(e);const r=N[i];N[i]=t;if(r===undefined){e.$loadingPromise.done(()=>{const t=e.getContract("visible");if(t){t.setVisible(N[i])}})}return}};this.getTileActions=function(e){const t=!e.isStub()&&e.getContract("actions");if(t){return t.getActions()}return[]};this.getTileTarget=function(){return null};this.getTileDebugInfo=function(e){const t=e.getChip();const i=t.getCatalog();const r={chipId:t.getId(),chipInstanceId:e.getId(),chipTitle:t.getTitle(),chipDescription:t.getDescription(),completelyLoaded:!e.isStub()};if(i){r.catalogId=i.getId()}const n=JSON.stringify(r);return n};this.getCatalogs=function(){let e;const t=x;const i=k===false;if(t&&!t.$notified&&!i){e=t}else{x=new jQuery.Deferred;e=x;e.done(()=>{if(e===x){k=true}}).always(()=>{if(e===x){x=null}});if(t){if(i){k=undefined}t.always(()=>{this._startLoading(e,i)})}else{this._startLoading(e,i)}}return e.promise()};this._refreshRemoteCatalogs=function(e){return h.getServiceAsync("PageBuilding").then(t=>{let i=0;const r=t.getFactory();const n=K(r);n.forEach(t=>{const o=t.ui2catalog;if(o.isStub()||o.getType()==="H"||o.getType()==="REMOTE"){i+=1;o.refresh(()=>{t.title=o.getTitle();t.tiles=V(r,o.getChips());e.notify(t);i-=1;if(i<=0){e.resolve(n)}},r=>{u.error(`Failed to load catalog: ${r}`,o.toString(),m);t.errorMessage=r||"Error";e.notify(t);i-=1;if(i<=0){e.resolve(n)}})}else{e.notify(t);e.$notified=true}});if(i<=0){e.resolve(n)}})};this._useKnownCatalogs=function(e){return h.getServiceAsync("PageBuilding").then(t=>{const i=K(t.getFactory());i.forEach(t=>{e.notify(t)});e.resolve(i)})};this._doGetCatalogs=function(e,t){const i=this._oCurrentPageSet.getDefaultPage().getAllCatalogs();if(i.isStub()){i.load(()=>{this._refreshRemoteCatalogs(e)},t=>{e.reject(new Error(t))},"type eq 'CATALOG_PAGE' or type eq 'H' or type eq 'SM_CATALOG' or type eq 'REMOTE'",true,"title",true)}else if(t){this._refreshRemoteCatalogs(e)}else{this._useKnownCatalogs(e)}};this._startLoading=function(e,t){let i;if(B&&B.cacheId){i=h.getServiceAsync("PageBuilding").then(e=>{const t=e.getFactory().getPageBuildingService().readAllCatalogs.cacheBusterTokens;t.put(y,B.cacheId);if(o.last("/core/spaces/enabled")){t.put(v,B.cacheId)}}).catch(e.reject)}else{i=Promise.resolve()}i.then(()=>{if($._bPageSetFullyLoaded){this._doGetCatalogs(e,t)}else{this.getGroups().done(()=>{this._doGetCatalogs(e,t)}).fail(e.reject)}}).catch(e.reject)};this.isCatalogsValid=function(){return!!k};this.getCatalogData=function(e){return e.ui2catalog.getCatalogData()};this.getCatalogError=function(e){return e.errorMessage};this.getCatalogId=function(e){return e.id};this.getCatalogTitle=function(e){return e.title};this.getCatalogTiles=function(e){const t=new jQuery.Deferred;let i=0;function r(){i-=1;if(i===0){t.resolve(e.tiles)}}function n(e,t){u.error(`Failed to load catalog tile: ${t}`,e.toString(),m);r()}for(let t=0;t<e.tiles.length;t+=1){const o=e.tiles[t];if(o.isStub()){i+=1;o.load(r,n.bind(null,o))}}if(i===0){t.resolve(e.tiles)}return t.promise()};this.getCatalogTileNumberUnit=a.getCatalogTileNumberUnit;this.getCatalogTileId=function(e){const t=e.getChip();let i=t.getId();if(t.getCatalog()&&t.getCatalog().getCatalogData()&&t.getCatalog().getCatalogData().systemAlias){i+=`_${t.getCatalog().getCatalogData().systemAlias}`}return i};this.getStableCatalogTileId=function(e){const t=e.getChip();let i=t.getReferenceChipId();if(i==="O"){i=null}if(!i){i=this.getCatalogTileId(e)}return i};this.getCatalogTileTitle=function(e){return e.getChip().getTitle()};this.getCatalogTileSize=a.getCatalogTileSize;this.getCatalogTileView=function(e,t){t=typeof t!=="undefined"?t:true;const i=this.getCatalogTileTitle(e);if(e.isStub()){u.warning("CHIP (instance) is just a stub!",e.toString(true),m);return new p({icon:"sap-icon://hide",info:"",infoState:"Critical",subtitle:"",title:i}).addStyleClass("sapUshellTileError")}if(t){const t=e.getContract("preview");if(t){t.setEnabled(true)}else{return new p({title:i,subtitle:"",info:"",infoState:"Neutral",icon:"sap-icon://folder-full"})}}return L(e,i,"Cannot get catalog tile view as SAPUI5")};this.getCatalogTileViewControl=function(e,t){const i=new jQuery.Deferred;t=typeof t!=="undefined"?t:true;const r=this.getCatalogTileTitle(e);if(e.isStub()){u.warning("CHIP (instance) is just a stub!",e.toString(true),m);i.resolve(this._createErrorTile(r,"CHIP was just a stub!"));return i.promise()}if(t){const t=e.getContract("preview");if(t){t.setEnabled(true)}else{i.resolve(this._createPreviewTile(r));return i.promise()}}e.getImplementationAsSapui5Async().catch(e=>{u.error(`Cannot get catalog tile view as SAPUI5: ${e.message||e}`,e.stack,m);return this._createErrorTile(r,e.message||e)}).then(i.resolve);return i.promise()};this._createErrorTile=function(e,t){const i=new n({state:C.Failed,header:e,subheader:t||""}).addStyleClass("sapUshellTileError");return i};this._createPreviewTile=function(e){return new p({title:e,subtitle:"",info:"",infoState:"Neutral",icon:"sap-icon://folder-full"})};this.getCatalogTileTargetURL=a.getCatalogTileTargetURL;this.getCatalogTilePreviewSubtitle=a.getCatalogTilePreviewSubtitle;this.getCatalogTilePreviewTitle=a.getCatalogTilePreviewTitle;this.getCatalogTilePreviewInfo=a.getCatalogTilePreviewInfo;this.getCatalogTilePreviewIndicatorDataSource=a.getCatalogTilePreviewIndicatorDataSource;this.getCatalogTilePreviewIcon=a.getCatalogTilePreviewIcon;this.getCatalogTileKeywords=function(e){const t={};const i=e.getTitle();const r=this.getCatalogTilePreviewSubtitle(e);const n=e.getChip().getDescription();function o(e,t){if(l.isArray(t)){t.forEach(t=>{if(e.hasOwnProperty(t)){return}e[t]=null})}}function s(e){const t=w.prototype._getBagText(e,"tileProperties","display_search_keywords");if(!l.isString(t)||t===""){return[]}return t.trim().split(/\s*,\s*/g)}function a(e){const t=w.prototype._getBagText(e,"tileProperties","display_info_text");if(t){return[t]}return[]}function c(e){const t=w.prototype._getConfigurationProperty(e,"tileConfiguration","display_number_unit");if(t){return[t]}return[]}function u(e){if(e.isStub()){return[]}const t=e.getContract("search");if(t){return t.getKeywords()}return[]}o(t,s(e));o(t,a(e));o(t,c(e));o(t,u(e));if(i){o(t,[i])}if(r){o(t,[r])}if(n){o(t,[n])}return Object.keys(t)};this.addBookmark=function(e,t){let r=P;let n={display_icon_url:e.icon||"",display_info_text:e.info||"",display_subtitle_text:e.subtitle||"",display_title_text:e.title};const o=new jQuery.Deferred;const s={tileProperties:{texts:{display_title_text:n.display_title_text,display_subtitle_text:n.display_subtitle_text,display_info_text:n.display_info_text}}};if(e.serviceUrl){r=I;n.display_number_unit=e.numberUnit;n.service_refresh_interval=e.serviceRefreshInterval||0;n.service_url=e.serviceUrl;if(e.dataSource){n.data_source={type:e.dataSource.type,settings:{odataVersion:i.get(["dataSource","settings","odataVersion"],e)}}}}if(t&&!(t instanceof c)){o.reject(new Error("The given object is not a group"));return o.promise()}n={tileConfiguration:JSON.stringify(n)};this._createBookmarkTile(r,e.url,n,s,e.title,t).then(()=>{o.resolve()}).catch(e=>{o.reject(e)});return o.promise()};this.addCustomBookmark=function(e,t){const i=e.vizConfig["sap.flp"].chipConfig;const r=new jQuery.Deferred;if(t&&!(t instanceof c)){r.reject(new Error("The given object is not a group"));return r.promise()}this._createBookmarkTile(i.chipId,e.url,i.configuration,i.bags,e.title,t).then(()=>{r.resolve()}).catch(e=>{r.reject(e)});return r.promise()};this._getTileTargetConfiguration=function(t){return h.getServiceAsync("URLParsing").then(i=>{const r={navigation_target_url:t,navigation_use_semantic_object:false};const n=new e;const o=new e(t);const s=o.host()+o.path()===n.host()+n.path();const a=w.prototype._makeTargetMappingSupportKey;if(t[0]==="#"||s){const e=i.parseShellHash(i.getShellHash(t));if(e&&j.get(a(e.semanticObject,e.action))!==undefined){r.navigation_use_semantic_object=true;r.navigation_semantic_object=e.semanticObject;r.navigation_semantic_action=e.action;r.navigation_semantic_parameters=i.paramsToString(e.params)}}return r})};this._updateBags=function(e,t){const i=[];const r=[];if(!t){t={};i.push(Promise.resolve([]))}Object.keys(t).forEach(n=>{let o;let s=false;const a=t[n];const l=e.getBag(n);try{for(o in a.properties){l.setProperty(o,a.properties[o]);s=true}for(o in a.texts){l.setText(o,a.texts[o]);s=true}i.push(new Promise((e,t)=>{if(s){r.push(n);l.save(e,(e,i)=>{const r=Object.keys(e)[0];t(new _(`Bag save failed: ${e[r]}`,{info:i[r],otherMessages:e,otherInfo:i}))})}else{e()}}))}catch(e){i.push(Promise.reject(e))}});return Promise.all(i).then(()=>r)};this._checkBookmarkConfiguration=function(e){return new Promise((t,i)=>{try{const i=W(e);if(!i.navigation_target_url){throw new Error("tileConfiguration.navigation_target_url was not set")}this.getTileSize(e);t()}catch(t){const r=`Chip configuration check failed for '${e.getId()}':`;u.error(r,t,m);i(t)}})};this._createBookmarkTile=function(e,t,i,r,n,o){return Promise.all([h.getServiceAsync("PageBuilding"),this._getTileTargetConfiguration(t)]).then(t=>{const r=t[0];const a=t[1];if(!i.tileConfiguration){i.tileConfiguration=JSON.stringify(a)}else{let e=JSON.parse(i.tileConfiguration);e=s({},e,a);i.tileConfiguration=JSON.stringify(e)}const l=r.getFactory();const c=l.getPageBuildingService();return new Promise((t,r)=>{if(this._bPageSetFullyLoaded){o=o||this._oCurrentPageSet.getDefaultPage();const s=l.createChipInstance({chipId:e,pageId:o.getId(),title:n,configuration:JSON.stringify(i),layoutData:""});o.addChipInstance(s,t,e=>{r(new Error(e))},undefined)}else{try{c.createPageChipInstanceFromRawData({chipId:e,configuration:JSON.stringify(i),pageId:"/UI2/Fiori2LaunchpadHome",title:n},e=>{l.createChipInstance(e,t,e=>{r(new Error(e))},undefined)},e=>{r(new Error(e))})}catch(e){r(e)}}})}).then(e=>this._updateBags(e,r).then(()=>this._checkBookmarkConfiguration(e)).catch(t=>new Promise((i,r)=>{e.remove(r.bind(undefined,t),r.bind(undefined,t))})))};w.prototype._isBookmarkFor=function(e,t){const i=e.getChip().getBaseChipId();if(i!==undefined){const r=W(e).navigation_target_url;if(typeof t==="string"){return J(e)&&r===t}return t.chipId===i&&t.url===r}return false};w.prototype._visitBookmarks=function(e,t){const i=[];const r=new jQuery.Deferred;$.getGroupsAndWaitForAllChips().then(n=>{let o=0;n.forEach(r=>{r.getChipInstances().forEach(r=>{if($._isBookmarkFor(r,e)){o+=1;if(t){i.push(t(r))}}})});if(i.length===0){r.resolve(o)}else{jQuery.when.apply(jQuery,i).fail(e=>{r.reject(e)}).done(()=>{r.resolve(o)})}}).catch(e=>{r.reject(e)});return r.promise()};this._visitCustomBookmarks=async function(e,t){if(!e.chipId){throw new Error("_visitCustomBookmarks: Required parameter is missing: oIdentifier.chipId")}return new Promise((i,r)=>{this.getGroups().fail(r).done(n=>{const o=[];let s=0;n.forEach(i=>{i.getChipInstances().forEach(i=>{if(w.prototype._isBookmarkFor(i,e)){s+=1;if(t){o.push(t(i))}}})});Promise.all(o).then(()=>{i(s)}).catch(r)})})};this.countBookmarks=function(e){return w.prototype._visitBookmarks(e)};this.countCustomBookmarks=function(e){return this._visitCustomBookmarks(e)};this.deleteBookmarks=function(e){return w.prototype._visitBookmarks(e,e=>{const t=new jQuery.Deferred;e.remove(t.resolve.bind(t),e=>{t.reject(new Error(e))});return t.promise()})};this.deleteCustomBookmarks=function(e){return this._visitCustomBookmarks(e,e=>new Promise((t,i)=>{e.remove(t,e=>{i(new Error(e))})}))};this.updateBookmarks=function(e,t){return w.prototype._visitBookmarks(e,e=>{const i=W(e);const r=new jQuery.Deferred;const n={tileProperties:{texts:{}}};if(t.title){n.tileProperties.texts.display_title_text=t.title}if(typeof t.subtitle==="string"){n.tileProperties.texts.display_subtitle_text=t.subtitle}if(typeof t.info==="string"){n.tileProperties.texts.display_info_text=t.info}let o={display_icon_url:typeof t.icon==="string"?t.icon:i.display_icon_url,display_info_text:typeof t.info==="string"?t.info:i.display_info_text,display_subtitle_text:typeof t.subtitle==="string"?t.subtitle:i.display_subtitle_text,display_title_text:t.title||i.display_title_text,display_number_unit:typeof t.numberUnit==="string"?t.numberUnit:i.display_number_unit,service_refresh_interval:t.serviceRefreshInterval||i.service_refresh_interval,service_url:t.serviceUrl||i.service_url};const a={};this._getTileTargetConfiguration(t.url||i.navigation_target_url).then(e=>{o=s({},o,e);a.tileConfiguration=JSON.stringify(o)}).then(()=>new Promise((t,i)=>{e.updateConfiguration(a,t,e=>{i(new Error(e))})})).then(()=>{e.getContract("configuration").fireConfigurationUpdated(Object.keys(a));return this._updateBags(e,n)}).then(t=>{if(t.length){e.getContract("bag").fireBagsUpdated(t)}r.resolve()}).catch(e=>{r.reject(e)});return r.promise()})};this.updateCustomBookmarks=function(e,t){const r=i.get(["vizConfig","sap.flp","chipConfig"],t)||{};const n=r.configuration||{};const o=r.bags||{};const a=t.url;return this._visitCustomBookmarks(e,e=>this._getTileTargetConfiguration(a).then(t=>{let i;if(!n.tileConfiguration){i=W(e);i=s({},i,t);n.tileConfiguration=JSON.stringify(i)}else{i=JSON.parse(n.tileConfiguration);i=s({},i,t);n.tileConfiguration=JSON.stringify(i)}return new Promise((t,i)=>{try{e.updateConfiguration(n,t,e=>{i(new Error(e))})}catch(e){i(e)}})}).then(()=>{e.getContract("configuration").fireConfigurationUpdated(Object.keys(n));return this._checkBookmarkConfiguration(e)}).then(()=>this._updateBags(e,o)).then(i=>{if(i.length){e.getContract("bag").fireBagsUpdated(i)}return new Promise((i,r)=>{if(t.title){e.setTitle(t.title,true,i,e=>{r(new Error(e))})}else{i()}})}))};this.onCatalogTileAdded=function(){k=false};this.isCustomTile=function(e){return!J(e)}}w.prototype._getCatalogTileIndex=function(){this._oCatalogTileIndexPromise=h.getServiceAsync("PageBuilding").then(e=>{const t=e.getFactory().getPageBuildingService();return new Promise((e,i)=>{t.readAllCatalogs(v,e,e=>{i(new Error(e))},"type eq 'CATALOG_PAGE' or type eq 'H' or type eq 'SM_CATALOG' or type eq 'REMOTE'","title",true)})}).then(e=>{const t={};e.results.forEach(e=>{e.Chips.results.forEach(e=>{let i;if(e.referenceChipId){i=e.referenceChipId}else{i=e.id}if(!t[i]){t[i]=e}})});return t}).catch(()=>({}));return this._oCatalogTileIndexPromise};return w});
//# sourceMappingURL=FlpLaunchPageAdapter.js.map