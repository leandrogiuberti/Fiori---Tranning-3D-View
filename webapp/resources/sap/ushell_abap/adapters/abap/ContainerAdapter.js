// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ushell/System","sap/ushell/User","sap/ushell/utils","sap/ushell_abap/bootstrap/evo/abap.bootstrap.utils","sap/ushell_abap/pbServices/ui2/ODataWrapper","sap/ui/thirdparty/URI","sap/ui/thirdparty/datajs","sap/base/util/deepClone","sap/base/util/ObjectPath","sap/base/Log","sap/ushell/Container"],(jQuery,e,t,s,a,i,r,n,o,l,u,c)=>{"use strict";function d(f,m,p){let g;const y="/sap/public/bc/icf/logoff";this._logoutViaHiddenIFrame=function(e){return new Promise(t=>{const s=document.createElement("iframe");const a=e.replace(/"/g,'\\"');window.addEventListener("message",s=>{if(s.data===e){t()}});s.style.visibility="hidden";s.setAttribute("src",e);function i(){window.parent.postMessage(a,"*")}s.addEventListener("load",i);s.addEventListener("error",i);document.body.appendChild(s)})};this.getSystem=function(){return f};this.getUser=function(){return g};this._determineAccessibility=function(e){let t=s.getParameterValueBoolean("sap-accessibility");if(t!==undefined){return t}t=e.accessibility;if(t!==undefined){return t}return false};this._setThemeAccessibilityFlags=function(e){if(e.userProfile&&e.userProfile.length){const t=e.userProfile.filter(e=>e.id&&e.id==="THEME")[0];if(t&&t.value){e.setThemePermitted=t.editState===3}else{e.oUserProfileDataTheme=false}const s=e.userProfile.filter(e=>e.id&&e.id==="ACCESSIBILITY")[0];if(s&&s.id){e.setAccessibilityPermitted=s.editState===3}else{e.setAccessibilityPermitted=false}if(s&&s.value==="true"){e.accessibility=true}if(s&&s.value==="false"){e.accessibility=false}e.accessiblity=this._determineAccessibility(e)}};this._setUserProfileFlags=function(e){if(e.userProfile&&e.userProfile.length&&Array.isArray(e.userProfile)){const t={};e.setContentDensityPermitted=false;e.userProfile.forEach(s=>{if(s.id in t){return}t[s.id]=s.id;if(s.id==="CONTENT_DENSITY"){e.contentDensity=s.value;e.setContentDensityPermitted=s&&s.editState===3||false}if(s.id==="TRACKING_USAGE_ANALYTICS"){if(typeof s.value==="string"){if(s.value.toLowerCase()==="true"||s.value.toLowerCase()==="false"){s.value=s.value.toLowerCase()==="true"||false}else{s.value=undefined}}if(typeof s.value==="undefined"||typeof s.value==="boolean"){e.trackUsageAnalytics=s.value}else{e.trackUsageAnalytics=undefined}}if(s.id==="MYHOME_IMPORT_FROM_CLASSIC"){e.importBookmarks=s.value}if(s.id==="MYHOME_ENABLEMENT"){switch(s.value){case"false":e.showMyHome=false;break;case"true":e.showMyHome=true;break;default:e.showMyHome=undefined;break}}if(s.id==="THEME_DARKMODE_AUTO_DETECTION"){switch(s.value){case"false":e.detectDarkMode=false;break;case"true":e.detectDarkMode=true;break;default:e.detectDarkMode=undefined;break}}})}};this._removeUnsupportedUserProperties=function(e){const t=o(e);const s=["id","email","firstName","lastName","fullName","isJamActive","isAdminUser","timeZone","language","languageBcp47","image","isImageConsent","isLanguagePersonalized","calendarWeekNumbering","trackUsageAnalytics","contentDensity","setContentDensityPermitted","accessibility","setAccessibilityPermitted","bootTheme","themeRoot","ranges","setThemePermitted","importBookmarks","showMyHome","detectDarkMode","userProfile"];Object.keys(t).forEach(e=>{if(!s.includes(e)){delete t[e]}});return t};this.load=function(){const s=new jQuery.Deferred;const a=p.config;const r=a.systemProperties;f=new e({alias:f.getAlias(),platform:f.getPlatform(),baseUrl:a.baseUrl,client:a.client,clientRole:a.clientRole,system:a.system,productName:r&&r.productName,systemName:r&&r.systemName,systemRole:r&&r.systemRole,tenantRole:r&&r.tenantRole,productVersion:a.productVersion,isTrialSystem:a.isTrialSystem,sysInfoBar:r&&r.sysInfoBar,sysInfoBarColor:r&&r.sysInfoBarColor,sysInfoBarMainText:r&&r.sysInfoBarMainText,sysInfoBarSecondaryText:r&&r.sysInfoBarSecondaryText,sysInfoBarIcon:r&&r.sysInfoBarIcon});this._setThemeAccessibilityFlags(a);this._setUserProfileFlags(a);const n=this._removeUnsupportedUserProperties(a);g=new t(n);i["sap-language"]=a.language;i["sap-client"]=a.client;if(a.target){d.startUpApplication={adjustedInitialTarget:a.adjustedInitialTarget,target:a.target}}this._setUserImage(g);return s.resolve().promise()};this.addFurtherRemoteSystems=function(){const t=new jQuery.Deferred;c.getServiceAsync("PageBuilding").then(s=>{s.getFactory().getPageBuildingService().readAllCatalogsForUser("type eq 'H' or type eq 'REMOTE'",s=>{const a="/sap/opu/odata/sap/SM_CATALOG_SRV/";if(s.results){s.results.forEach(t=>{const s=/^\/sap\/hba\//.test(t.baseUrl);if(t.type==="H"||t.baseUrl===a||s){c.addRemoteSystem(new e({alias:t.systemAlias,platform:s||t.type==="H"?"hana":"abap",baseUrl:t.type==="H"?"":";o="}))}})}t.resolve()},e=>{u.error("Reading REMOTE catalogs failed:",e,"sap.ushell_abap.adapters.abap.ContainerAdapter");t.reject(new Error(e))})}).catch(t.reject);return t.promise()};this.getCurrentUrl=function(){return window.location.href};this.sessionKeepAlive=function(){const e="/sap/opu/odata/UI2/PAGE_BUILDER_PERS";const t=a.createAndOpenXHR(e,null,"HEAD");t.onreadystatechange=function(){if(this.readyState===4){u.debug("server session was extended")}};t.send()};this.logout=async function(e){if(e){if(s.hasNativeLogoutCapability()){const e=new r(y).absoluteTo(this.getCurrentUrl()).search("").toString();window.external.getPrivateEpcm().doLogOff(e)}else{this.logoutRedirect()}u.info(`ABAP system logged out: ${f.getAlias()}`,null,"sap.ushell_abap.adapters.abap.ContainerAdapter")}else{const e=this._setUrlLanguage(f.adjustUrl(y));u.info(`Logging out from system '${f.getAlias()}' via hidden iframe`);await this._logoutViaHiddenIFrame(e)}};this.logoutRedirect=function(){const e=this._setUrlLanguage(f.adjustUrl(y));this._setDocumentLocation(e)};this._setDocumentLocation=function(e){window.document.location=e};this._setUserImage=function(e){function t(){const e=window["sap-ushell-config"];const t=l.get("renderers.fiori2.componentData.config.enableUserImage",e);return!!t}if(t()&&e&&e.isJamActive&&e.isJamActive()){n.read("/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData/Self?$format=json",t=>{const s=t.results.Id;const a=`/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData/Members('${s}')/ProfilePhoto/$value`;e.setImage(a)},e=>{u.error("Could not receive JAM user data")})}};this._setUrlLanguage=function(e){const t=this.getUser().getLanguage();if(t){e+=`${e.indexOf("?")>=0?"&":"?"}sap-language=${t}`}return e}}return d});
//# sourceMappingURL=ContainerAdapter.js.map