// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["./abap.bootstrap.utils","sap/base/util/ObjectPath","sap/base/Log"],(e,t,o)=>{"use strict";const i="sap-ushell-reloaded";function n(e,t){this._oWindow=e||window;this._sXhrLogonMode=t;this._bPending=false}n.prototype.handleEvent=function(e){if(this._bPending){return true}if(e.type==="logon"){this._bPending=true;if(this._sXhrLogonMode==="logoffAndRedirect"){this._showErrorAndReload({key:"bootstrap.xhr.authenticationRequired",text:"Authentication required"},{key:"bootstrap.xhr.sessionExpired",text:"Your session has expired. Press OK to reload."},this._logoffAndRedirect,this._handleAuthenticationRequiredNoUi5.bind(this))}else{this._showErrorAndReload({key:"bootstrap.xhr.authenticationRequired",text:"Authentication required"},{key:"bootstrap.xhr.sessionExpired",text:"Your session has expired. Press OK to reload."},this._reloadPage,this._handleAuthenticationRequiredNoUi5.bind(this))}}else{o.error(`Cannot handle event with type: ${e.type}`,null,"sap.ushell_abap.bootstrap.evo.XhrLogonEventHandler")}return true};n.prototype._getUpdatedLocationSearchForReload=function(e){const t=Date.now();const o=new RegExp(["(.*)([?&])",i,"(=[^&]*)?(.*)"].join(""));let n;let r=false;if(typeof e!=="string"){throw new Error("Illegal argument: sCurrentLocationSearch must be a string")}n=e.replace(o,(e,o,n,s,a)=>{r=true;return[o,n,i,"=",t,a].join("")});if(!r){if(e){n=[e,"&",i,"=",t].join("")}else{n=["?",i,"=",t].join("")}}return n};n.prototype._reloadPage=function(){const e=this;e._oWindow.setTimeout(()=>{e._oWindow.location.search=e._getUpdatedLocationSearchForReload(e._oWindow.location.search)},0)};n.prototype._logoffAndRedirect=function(){const o=e.getLocationHref();const i=t.get("sap-ushell-config.services.Container.adapter.config.client");const n=new URI("/sap/public/bc/icf/logoff").absoluteTo(o).search(`sap-client=${i}&propagateLogoff=false&redirectURL=${encodeURIComponent(o)}`).toString();document.location=n};n.prototype._isPageReloaded=function(){return new RegExp(["[?&]",i].join("")).test(this._oWindow.location.search)};n.prototype._handleAuthenticationRequiredNoUi5=function(e){if(!this._isPageReloaded()){o.error("Illegal state: XHR authentication (mode=reload) requested before SAPUI5 is initialized. "+"This should not happen if the FioriLaunchpad.html page is loaded from the server. Trying to reload page once.",null,"sap.ushell_abap.bootstrap.evo.XhrLogonEventHandler");const t="Authentication required\n\nYour session might have expired. Press OK to reload.";this._oWindow.alert(t);e.call(this)}else{o.error("Illegal state: XHR authentication (mode=reload) requested before SAPUI5 is initialized and page reload has been triggered once."+" Stopping reload to avoid endless loop. This state cannot be overcome. Please ensure that the FioriLaunchpad.html"+" page is not cached, but always loaded from the server.",null,"sap.ushell_abap.bootstrap.evo.XhrLogonEventHandler")}};n.prototype._showErrorAndReload=function(e,t,o,i){let n;let r;if(sap.ui.require("sap/ui/core/Core")&&sap.ui.require("sap/m/MessageBox")){const i=sap.ui.require("sap/m/MessageBox");const s=i.Action;const a=i.Icon;const l=sap.ui.require("sap/ushell/resources");if(l){n=this._getText(e,l);r=this._getText(t,l)}if(sap.ui.require("sap/ui/core/BusyIndicator")){const e=sap.ui.require("sap/ui/core/BusyIndicator");if(typeof e.show==="function"&&typeof e.hide==="function"){e.hide();e.show=function(){}}}i.show(r,{icon:a.ERROR,title:n,actions:[s.OK],onClose:o.bind(this)})}else{i.call(this,o)}};n.prototype._getText=function(e,t){const o=t.i18n.getText(e.key);if(o&&o!==e.key){return o}return e.text};return n},true);
//# sourceMappingURL=XhrLogonEventHandler.js.map