// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/datajs","sap/base/i18n/Localization","sap/ui/core/Supportability","sap/ushell_abap/pbServices/ui2/Utils","sap/ushell_abap/pbServices/ui2/ODataService","sap/ushell_abap/pbServices/ui2/Error","sap/base/Log","sap/ui/thirdparty/jquery"],(e,t,a,r,s,n,i,jQuery)=>{"use strict";function o(){}function u(e,t){if(r.isArray(e)){e.forEach(e=>{e.reject(t)})}else{e.reject(t)}}function c(e){if(e===undefined){return undefined}try{return JSON.parse(JSON.stringify(e))}catch{return undefined}}function f(e,a){const s="saplb";let l;let p;let d;const h=this;let g;let b;function O(e){const t={};t.baseUrl=e[0];if(typeof e[2]==="boolean"){t.supportsChangeSets=e[2]}return t}this.getBatchQueue=function(){return l};f.headerValue=function(e,t){e=e.toLowerCase();for(const a in t){if(Object.prototype.hasOwnProperty.call(t,a)&&a.toLowerCase()===e){return t[a]}}return undefined};function S(t){const a=e["sap-language"]||f["sap-language"];const r=e["sap-statistics"]||f["sap-statistics"];const s=e["sap-client"]||f["sap-client"];t=t||{};if(a){t["sap-language"]=a}if(r||r==="false"){t["sap-statistics"]=`${r}`}if(s){t["sap-client"]=s}return t}function y(e){e=e||{};const t=f.oStickySessionConfiguration[g];if(typeof t==="undefined"){return e}if(t&&t.enabled&&typeof t.value!=="undefined"){e[s]=t.value}return e}this.detectStickySession=function(e){const t=f.oStickySessionConfiguration[g];if(!t||!t.enabled){return}const a=f.headerValue(s,e);if(typeof a==="undefined"){return}if(t.value!==a){t.value=a}};f.csrfTokenValue=function(e){const t=f.headerValue("x-csrf-token",e);if(t==="Required"){return t}const a=f.headerValue("cache-control",e);if(a===undefined||a.indexOf("max-age=0")>-1||a.indexOf("no-cache")>-1){return t||""}return""};this.doRequest=function(e,s,n,u,c,l,p){i.debug("[000] do request, sMethod",s,"ODataWrapper");u=u||o;c=c||a.getDefaultErrorHandler();h.check(u,c);const d={Accept:"application/json","Accept-Language":t.getLanguage()||"","X-CSRF-Token":a.getCsrfToken()};if(a.getCsrfToken()===""&&s!=="GET"){a.refreshCsrfToken(this.doRequest.bind(h,e,s,n,u,c,l,true),c);return}S(d);y(d);OData.request({requestUri:e,method:s,data:n,headers:d},(t,a)=>{this.detectStickySession((a||{}).headers);i.debug(`Received OData response for ${s} "${e}"`,null,"ODataWrapper");r.callHandler(u.bind(null,t),c)},t=>{function r(){c.apply(null,arguments)}function o(){u.apply(null,arguments)}if(!p&&t.response.statusCode===403&&f.csrfTokenValue(t.response.headers).toLowerCase()==="required"){i.debug(`CSRF token required for ${s} "${e}", refreshing it`,JSON.stringify(t.response),"ODataWrapper");a.refreshCsrfToken(this.doRequest.bind(h,e,s,n,o,r,l,true),r)}else{h.onError(s,e,c,null,t)}},l);i.debug(`Sent OData request for ${s} "${e}"`,null,"ODataWrapper")};this.toRelativeUrl=function(e){const t=e.indexOf(g);if(t<0){throw new n(`Not relative to base URL "${g}": ${e}`,"ODataWrapper")}return e.slice(t+g.length)};this.toRequestUrl=function(e){if(/^\//.test(e)){throw new n(`Not a relative URL: ${e}`,"ODataWrapper")}return g+e};this.readOrBatch=function(e,a,r){let s;const n=this.toRequestUrl(e);const o=y(S());if(l&&e!==""){i.debug(`Queued OData request for GET "${e}"`,null,"ODataWrapper");l.push({method:"GET",requestUri:e,headers:o});s=(new jQuery.Deferred).done(a).fail(r);d.push(s);p=false;return}o.Accept="application/json";o["Accept-Language"]=t.getLanguage()||"";o["X-CSRF-Token"]="Fetch";OData.read({requestUri:n,headers:o},a,r);i.debug(`Sent OData request for GET "${n}"`,null,"ODataWrapper")};this.requestOrBatch=function(e,t,s,n,u){let c;const f={data:s,method:t,requestUri:e,headers:y(S())};const g=this.toRequestUrl(e);if(l){n=n||o;u=u||a.getDefaultErrorHandler();h.check(n,u);i.debug(`Queued OData request for ${t} "${e}"`,null,"ODataWrapper");if(!p){l.push({__changeRequests:[]});d.push([]);p=b}l[l.length-1].__changeRequests.push(f);c=(new jQuery.Deferred).done((e,a)=>{i.debug(`Received OData response for ${t} "${g}"`,null,"ODataWrapper");r.callHandler(n.bind(null,e),u)}).fail(h.onError.bind(h,t,g,u,null));d[d.length-1].push(c);return}this.doRequest(g,t,s,n,u)};this.isStickySessionEnabled=function(){return(f.oStickySessionConfiguration[g]||{}).enabled||false};this.enableStickySession=function(){f.oStickySessionConfiguration[g].enabled=true};this.check=function(e,t){if(!e){throw new n("Missing success callback","ODataWrapper")}if(typeof e!=="function"){throw new n("Success callback is not a function","ODataWrapper")}if(!t){throw new n("Missing error callback","ODataWrapper")}if(typeof t!=="function"){throw new n("Error callback is not a function","ODataWrapper")}};this.create=function(e,t,a,r){i.debug("[000] create: url",e,"ODataWrapper");this.requestOrBatch(e,"POST",t,a,r)};this.del=function(e,t,a){let r=e;if(typeof r!=="string"){r=this.toRelativeUrl(e.__metadata.uri)}this.requestOrBatch(r,"DELETE",null,e=>{if(t){t()}},a)};this.getBaseUrl=function(){return g};this.getODataService=function(){return a};this.onError=function(e,t,a,r,s){let n;let o="Error ";if(s.response&&s.response.statusCode){o+=`(${s.response.statusCode}, ${s.response.statusText}) `}o+=`in OData response for ${e} "${t}": ${s.message}`;if(s.response&&s.response.body){try{n=JSON.parse(s.response.body).error;if(n){if(n.hasOwnProperty("message")&&n.message.hasOwnProperty("value")){o+=`\nDetails: ${n.message.value}`}if(s.response.statusCode&&!n.httpStatus){n.httpStatus=s.response.statusCode}}}catch(e){}}i.error(o,JSON.stringify(s.response),"ODataWrapper");if(r){r.reject(o,n)}a(o,n)};this.openBatchQueue=function(){if(l){throw new n("Batch queue already open","ODataWrapper")}l=[];d=[];p=false};this.isBatchQueueOpen=function(){return!!l};this.read=function(e,t,s,n){let o;const u=this.toRequestUrl(e);let c;function l(e,n){this.detectStickySession(n.headers);a.setCsrfToken(f.csrfTokenValue(n.headers)||a.getCsrfToken());i.debug(`Received OData response for GET "${u}"`,null,"ODataWrapper");c=f.headerValue("sap-message",n.headers);if(c){i.warning(`SAP message for GET ${u}`,c,"ODataWrapper")}if(o){o.resolve(JSON.parse(JSON.stringify(e)),a.getCsrfToken())}r.callHandler(t.bind(null,e),s)}s=s||a.getDefaultErrorHandler();this.check(t,s);if(n){OData.read.$cache=OData.read.$cache||new r.Map;o=OData.read.$cache.get(u);if(o){i.debug(`Using cached response for GET "${u}"`,null,"ODataWrapper");o.done((e,n)=>{a.setCsrfToken(a.getCsrfToken()||n);r.callHandler(t.bind(null,JSON.parse(JSON.stringify(e))),s)}).fail(s);return}o=new jQuery.Deferred;OData.read.$cache.put(u,o.promise())}this.readOrBatch(e,l.bind(this),this.onError.bind(this,"GET",u,s,o))};this.batch=function(e,t,a){const r=this.toRequestUrl("$batch");this.doRequest(r,"POST",e,t,a,OData.batchHandler)};this.submitBatchQueue=function(e,t){const s=d;function o(n){const i=n.__batchResponses.length;const o=s.length;if(o!==i){h.onError("POST",this.toRequestUrl("$batch"),t,null,{message:`Protocol error! Expected ${o} responses, but received ${i}`});return}n.__batchResponses.forEach((e,t)=>{const a=s[t];if(e.response){u(a,e)}else if(e.__changeResponses){e.__changeResponses.forEach((e,t)=>{a[t].resolve(e.data,e)})}else{a.resolve(e.data,e)}});if(e){r.callHandler(e,a.getDefaultErrorHandler())}}if(!l){throw new n("No open batch queue to submit","ODataWrapper")}if(l.length>0){i.debug("[000] submit batch queue: batch","ODataWrpper");this.batch({__batchRequests:l},o.bind(this),t)}else if(e){r.callHandler(e,a.getDefaultErrorHandler(),true)}i.debug("[000] submit batch queue","ODataWrapper");l=undefined;d=undefined};this.toString=function(e){const t=['ODataWrapper({sBaseUrl:"',g,'"'];t.push("})");return t.join("")};this.put=function(e,t,a,r){i.debug("[000] put: request or batch, payload.id",t.id,"ODataWrapper");this.requestOrBatch(e,"PUT",t,e=>{if(a){a()}},r)};this.update=function(e,t,a){const r={__metadata:{type:e.__metadata&&e.__metadata.type}};let s;const n=this.toRelativeUrl(e.__metadata.uri);for(s in e){if(Object.prototype.hasOwnProperty.call(e,s)&&s.indexOf("$")!==0&&typeof e[s]!=="object"){r[s]=e[s]}}this.put(n,r,t,a)};if(typeof e==="string"){e=O(arguments)}else if(typeof e==="object"){e=c(e)}if(!e||!e.baseUrl||typeof e.baseUrl!=="string"){throw new n("Missing base URL","ODataWrapper")}if(!a||typeof a!=="object"){throw new n("Missing OData service facade","ODataWrapper")}e.baseUrl=`${e.baseUrl.replace(/\/$/,"")}/`;g=e.baseUrl;b=e.supportsChangeSets;if(typeof f.oStickySessionConfiguration==="undefined"){i.error("ODataWrapper.oStickySessionConfiguration is not defined!","the ODataWrapper constructor was called before the static property was defined","ODataWrapper")}else if(typeof f.oStickySessionConfiguration[g]==="undefined"){f.oStickySessionConfiguration[g]={enabled:false,value:undefined}}}function l(e){const t={};const a={};t.baseUrl=e[0];if(typeof e[1]==="boolean"){t.supportsChangeSets=e[1]}if(typeof e[2]==="function"){a.defaultFailure=e[2]}a.settings=t;return a}if(typeof f.oStickySessionConfiguration==="undefined"){f.oStickySessionConfiguration={}}f.checkSapStatisticsSetting=function(e){try{f["sap-statistics"]=a.isStatisticsEnabled()}catch{f["sap-statistics"]=/sap-statistics=(true|x|X)/.test(e)}};f.checkSapStatisticsSetting(window.location.search);f._Service=function e(t,a){const r=new f(t,this);s.call(this,r,a);return r};f.createODataWrapper=function(e,t){i.debug("[000] createOdataWrapper","ODataWrapper");if(typeof arguments[0]==="string"){const a=l(arguments);e=a.settings;if(a.defaultFailure){t=a.defaultFailure}}else if(typeof arguments[0]==="object"){e=c(e)}return new f._Service(e,t)};return f});
//# sourceMappingURL=ODataWrapper.js.map