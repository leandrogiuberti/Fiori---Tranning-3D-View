/*!
 * SAPUI5
 * Copyright (c) 2025 SAP SE or an SAP affiliate company. All rights reserved.
 * 
 */
sap.ui.define(["./error/ErrorHandler","./sinaNexTS/sina/DataSourceResultSet","./sinaNexTS/sina/UserCategoryDataSource","sap/esh/search/ui/error/errors"],function(e,t,r,a){"use strict";function o(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}const s=o(e);const i=t["DataSourceResultSet"];const u=r["UserCategoryDataSource"];class n{children;parent;unsureWhetherNodeisBelowRoot;tree;constructor(e,t,r){this.dataSource=e;this.count=t;this.children=[];this.parent=null;this.tree=r}equals(e){return this===e}setCount(e){this.count=e}getAncestors(){const e=[];let t=this;while(t.parent){e.push(t.parent);t=t.parent}return e}getChildren(){const e=[];for(let t=0;t<this.children.length;++t){const r=this.children[t];if(r.unsureWhetherNodeisBelowRoot){continue}e.push(r)}return e}getChildrenSortedByCount(){const e=this.getChildren();e.sort(function(e,t){return t.count-e.count});return e}clearChildren(){for(let e=0;e<this.children.length;++e){const t=this.children[e];t.parent=null}this.children=[]}appendNode(e){e.parent=this;this.children.push(e)}appendNodeAtIndex(e,t){e.parent=this;this.children.splice(t,0,e)}insertNode(e){if(this.children.length===0){this.appendNode(e);return}if(e.dataSource===this.tree.model.appDataSource){this.appendNodeAtIndex(e,0);return}if(e.dataSource===this.tree.model.favDataSource){if(this.children[0].dataSource===this.tree.model.appDataSource){this.appendNodeAtIndex(e,1)}else{this.appendNodeAtIndex(e,0)}return}let t=-1;let r=true;for(const a of this.children){t++;if(a.dataSource===this.tree.model.appDataSource||a.dataSource===this.tree.model.favDataSource||a.children.length>0){continue}if(a.dataSource.labelPlural&&e.dataSource.labelPlural&&a.dataSource.labelPlural>e.dataSource.labelPlural){r=false;break}}if(r){this.appendNode(e)}else{this.appendNodeAtIndex(e,t)}}removeChildNode(e){const t=this.children.indexOf(e);if(t<0){return}this.children.splice(t,1);e.parent=null}hasChild(e){return this.children.indexOf(e)>-1}hasSibling(e){if(this.equals(e)){return false}const t=this.parent;if(!t){return false}if(t.hasChild(e)){return true}return false}_findNode(e,t){if(this.dataSource===e){t.push(this);return}for(let r=0;r<this.children.length;++r){const a=this.children[r];a._findNode(e,t);if(t.length>0){return}}}}class l{rootNode;model;constructor(e,t){this.model=t;this.rootNode=new n(e,null,this)}reset(){this.rootNode=null}invalidate(e){let t=this.findNode(e);if(!t){this.rootNode.children=[];this.rootNode.count=0;return}let r=null;while(t){t.children=r?[r]:[];t.count=null;if(r){r.count=null}r=t;t=t.parent}}findNode(e){if(!this.rootNode){return null}const t=[];this.rootNode._findNode(e,t);return t.length>0?t[0]:null}hasChild(e,t){if(t===this.rootNode.dataSource){return false}const r=this.findNode(e);if(!r){return false}const a=this.findNode(t);if(!a){return false}return r.hasChild(a)}hasSibling(e,t){if(t===this.rootNode.dataSource){return false}const r=this.findNode(e);if(!r){return false}const a=this.findNode(t);if(!a){return false}return r.hasSibling(a)}removeObsoleteTreeNodes(e,t){for(let r=e.children.length-1;r>=0;r--){const a=e.children[r];if(a.children.length>0){this.removeObsoleteTreeNodes(a,t)}if(t.map(e=>e.dataSource).indexOf(a.dataSource)===-1){e.removeChildNode(a)}}}updateFromSearchResultSet(e,t){let r=0;let a;if(t){r=t.totalCount}let o=this.findNode(e);if(o){a=this.collectDataSourcesFromResult(o,t);this.removeObsoleteTreeNodes(o,a)}else{o=new n(e,r,this);a=this.collectDataSourcesFromResult(o,t);this.removeObsoleteTreeNodes(this.rootNode,a);if(o.dataSource===this.model.favDataSource){o.unsureWhetherNodeisBelowRoot=false}else{o.unsureWhetherNodeisBelowRoot=true}if(this.isIncludedInMyFavorites(e)){let e=this.findNode(this.model.favDataSource);if(!e){e=new n(this.model.favDataSource,0,this);e.unsureWhetherNodeisBelowRoot=false;this.rootNode.insertNode(e)}e.insertNode(o)}else{this.rootNode.insertNode(o)}}o.setCount(r);if(e===this.model.allDataSource||this.model.isUserCategory()){o.setCount(o.count+this.model.getProperty("/appCount"))}else if(e===this.model.appDataSource){o.setCount(this.model.getProperty("/appCount"))}this.updateTreeFromResultDataSources(o,a);this.updateCountMyFavorites(o,a)}updateMyFavTreeNode(e,t){if(this.model.userCategoryManager&&this.model.userCategoryManager.isFavActive()){if(e.dataSource===this.model.allDataSource){let r=this.findNode(this.model.favDataSource);if(!r){r=new n(this.model.favDataSource,t.filter(e=>e.isFavDataSource).reduce((e,t)=>e+t.measureValue,0),this);e.unsureWhetherNodeisBelowRoot=false;e.insertNode(r)}}}}updateCountMyFavorites(e,t){const r=this.findNode(this.model.favDataSource);if(r&&e.dataSource===this.model.allDataSource){r.setCount(t.filter(e=>e.isFavDataSource).reduce((e,t)=>e+t.measureValue,0));if(this.isIncludedInMyFavorites(this.model.appDataSource)&&t.map(e=>e.dataSource).indexOf(this.model.appDataSource)===-1){r.setCount(r.count+this.model.getProperty("/appCount"))}}}getFacets(e,t){function r(e){return e instanceof i}const a=[];if(!t||e.dataSource===this.model.appDataSource){return a}if(t.facets.length===0&&t.items.length>0&&e.dataSource instanceof u){const r=[];r.push(this.model.sinaNext._createDataSourceResultSetItem({dataSource:e.dataSource.subDataSources[0],dimensionValueFormatted:e.dataSource.subDataSources[0].labelPlural,measureValue:t.totalCount,measureValueFormatted:t.totalCount.toString()}));const o=this.model.sinaNext._createDataSourceResultSet({title:this.model.query.filter.dataSource.label,items:r,query:this.model.query,facetTotalCount:undefined});a.push(o);return a}else if(t.facets.length===0){return a}if(!r(t.facets[0])){return a}if(t.facets[0].type!==this.model.sinaNext.FacetType.DataSource){return a}return t.facets}isIncludedInMyFavorites(e){if(this.model.userCategoryManager&&this.model.userCategoryManager.isFavActive()&&(this.model.favDataSource.subDataSources.indexOf(e)>-1||e===this.model.appDataSource&&this.model.favDataSource.includeApps)){return true}else{return false}}collectDataSourcesFromResult(e,t){function r(e){return e instanceof i}const a=[];const o={};if((e.dataSource===this.model.allDataSource||e.dataSource===this.model.favDataSource)&&this.model.getProperty("/appCount")>0){o.dataSource=this.model.appDataSource;o.isAppDataSource=true;o.isFavDataSource=this.model.userCategoryManager?this.model.userCategoryManager.isFavActive()?this.model.favDataSource.includeApps:false:false;o.measureValue=this.model.getProperty("/appCount");o.measureValueFormatted=o.measureValue.toString();o.dimensionValueFormatted=this.model.appDataSource.labelPlural;if(e.dataSource===this.model.favDataSource&&o.isFavDataSource||e.dataSource===this.model.allDataSource&&!o.isFavDataSource){a.push(o)}}if(e.dataSource.type===this.model.sinaNext.DataSourceType.BusinessObject){o.dataSource=e.dataSource;o.isAppDataSource=false;o.isFavDataSource=this.isIncludedInMyFavorites(e.dataSource);o.measureValue=e.count?e.count:0;o.measureValueFormatted=o.measureValue.toString();o.dimensionValueFormatted=e.dataSource.labelPlural?e.dataSource.labelPlural:e.dataSource.label;a.push(o);return a}const s=this.getFacets(e,t);if(!s||s.length===0||!r(s[0])){return a}s[0].items.forEach(e=>a.push({dataSource:e.dataSource,isAppDataSource:false,isFavDataSource:this.isIncludedInMyFavorites(e.dataSource),measureValue:e.measureValue,measureValueFormatted:e.measureValueFormatted,dimensionValueFormatted:e.dimensionValueFormatted}));return a}updateTreeFromResultDataSources(e,t){if(e.dataSource===this.model.appDataSource||!t){return}this.updateMyFavTreeNode(e,t);const r=this.findNode(this.model.favDataSource);for(const a of t){const t=this.findNode(a.dataSource);if(t){if(t.unsureWhetherNodeisBelowRoot){t.unsureWhetherNodeisBelowRoot=false}if(e!==t.parent&&(e.dataSource.type===this.model.sinaNext.DataSourceType.Category||e.dataSource.type===this.model.sinaNext.DataSourceType.UserCategory)){t.parent.removeChildNode(t);e.insertNode(t)}}else{const t=new n(a.dataSource,a.measureValue,this);t.unsureWhetherNodeisBelowRoot=false;if(r&&a.isFavDataSource){r.insertNode(t)}else{e.insertNode(t)}}}}}class d{errorHandler;tree;constructor(e,t){this.errorHandler=s.getInstance();this.tree=new l(e,t)}format(e,t,r){this.tree.updateFromSearchResultSet(e,t);const a=this.generateTabStrips(e,r);return a}invalidate(e){if(this.tree){this.tree.invalidate(e)}}generateTabStrips(e,t){let r=this.doGenerateTabStrips(e,t);let o;try{o=t.config.tabStripsFormatter(r.strips);if(o.indexOf(r.selected)<0){o.splice(0,0,r.selected)}r.strips=o}catch(o){const s=new a.ConfigurationExitError("tabStripsFormatter",t.config.applicationComponent,o);this.errorHandler.onError(s);r=this.doGenerateTabStrips(e,t)}return r}doGenerateTabStrips(e,t){const r=9999;let a,o,s;const i={strips:[],selected:null};const u=this.tree.findNode(e);if(!u){if(e!==t.allDataSource){i.strips.push(t.allDataSource)}i.strips.push(e);i.selected=e;return i}if(u.dataSource===t.allDataSource){i.strips.push(t.allDataSource);s=u.getChildrenSortedByCount();for(a=0;a<s.length&&i.strips.length<r;++a){o=s[a];i.strips.push(o.dataSource)}i.selected=t.allDataSource;return i}if(u.parent===this.tree.rootNode&&!u.unsureWhetherNodeisBelowRoot){i.strips.push(t.allDataSource);let e=false;s=this.tree.rootNode.getChildrenSortedByCount();for(a=0;a<s.length;++a){o=s[a];if(e){if(i.strips.length>=r){break}i.strips.push(o.dataSource)}else{if(i.strips.length<r-1||u===o){i.strips.push(o.dataSource);if(u===o){e=true}}}}if(s.length===0){i.strips.push(u.dataSource)}i.selected=u.dataSource;return i}i.strips.push(t.allDataSource);i.strips.push(u.dataSource);i.selected=u.dataSource;return i}}var c={__esModule:true};c.Tree=l;c.Formatter=d;return c});
//# sourceMappingURL=SearchTabStripsFormatter.js.map