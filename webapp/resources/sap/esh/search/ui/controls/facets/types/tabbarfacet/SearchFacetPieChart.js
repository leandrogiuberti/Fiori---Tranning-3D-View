/*!
 * SAPUI5
 * Copyright (c) 2025 SAP SE or an SAP affiliate company. All rights reserved.
 * 
 */
sap.ui.define(["../../../../i18n","sap/ui/thirdparty/d3","sap/ui/core/Control","../../FacetTypeUI","sap/ui/core/Element"],function(t,e,i,n,s){"use strict";function a(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}const r=a(t);const l=n["FacetTypeUI"];const d=i.extend("sap.esh.search.ui.controls.SearchFacetPieChart",{renderer:{apiVersion:2,render(t,e){t.openStart("div",e);t.attr("role","figure");t.openEnd();t.close("div");e.PieChart=o}},metadata:{properties:{oSearchFacetDialog:{type:"object"}},aggregations:{items:{type:"sap.esh.search.ui.FacetItem",multiple:true}}},constructor:function t(n,s){i.prototype.constructor.call(this,n,s);this.iMissingCnt=0;d.d3=e},getFacetIndex:function t(){let e=this.getDomRef();let i;while(e){if(e.classList.contains("sapUshellSearchFacetIconTabBar")){i=e;break}e=e.parentElement}if(!i){return-1}const n=document.querySelectorAll(".sapUshellSearchFacetIconTabBar");for(let t=0;t<n.length;++t){const e=n.item(t);if(e===i){return t}}return-1},getFacetIndexByIdForLargePieChart:function t(e){let i=-1;const n=document.getElementById(e);const s=n?.parentElement?.parentElement;if(!s){return-1}const a=s.id;const r=Array.from(document.querySelectorAll(".searchFacetLargeChartContainer"));for(let t=0;t<r.length;t++){const e=r[t].id;if(e===a){i=t;break}}return i},getPieChartIndexByFacetIndex:function t(e){let i;let n=-1;let s=0;const a=document.querySelectorAll(".sapUshellSearchFacetIconTabBar");for(let t=0;t<e;t++){const e=a[t];if(!e)continue;const n=e.querySelectorAll(".sapMLIBContent");if(n.length<2)continue;const r=n[1].firstChild;if(!r||!("id"in r))continue;i=r.id;if(i&&i.match(/pieChart/)!==null){s++}}n=s;return n},getSumSelected:function t(e){let i;let n=0;if(e){for(let t=0;t<e.length;t++){if(e[t].facetType===l.Attribute){for(let s=0;s<e[t].items.length;s++){i=e[t].items[s].value;if(i&&e[t].items[s].selected){n+=i}}}}}return n},getDataForPieChart:function t(e,i,n){const s=[];let a=[];let d;let o=0;let h=-1;let c="";const g=i.oData.count;let u;let f=0;this.iMissingCnt=0;for(let t=0;t<e.length;t++){if(e[t].facetType===l.Attribute){h++;a=[];f=0;for(let i=0;i<e[t].items.length;i++){d={};o=e[t].items[i].value;if(o){c=""+o;f+=o;d.filterCondition=e[t].items[i].filterCondition;d.dimension=e[t].items[i].facetTitle;d.label=e[t].items[i].label;d.selected=e[t].items[i].selected;d.filterLabel=e[t].items[i].label;d.id=e[t].items[i].label;d.value=o;d.valueLabel=e[t].items[i].valueLabel;if(c){d.tooltip=e[t].items[i].label+": "+o}else{d.tooltip=e[t].items[i].label}d.filtered=false;d.removed=false;d.fill="#007CAA";d.maxLabelLength=30;a.push(d)}else if(h===n){this.iMissingCnt++}}if(typeof e[t].totalCount==="number"){u=e[t].totalCount}else{u=g}const i=Math.round(f/u*100);let l=100-i;if(l>0){if(l===100){l=99}const t=18*f/350;const e=`${l}`;d={};d.filterCondition=null;d.dimension="";d.label=e;d.id="perc_missing";d.value=t;d.valueLabel=e;d.tooltip=r.getText("facetPieChartOverflowText",[e]);d.filtered=false;d.removed=false;d.fill="transparent";d.stroke="none";d.maxLabelLength=30;a.push(d)}s.push(a)}}return s},getDataForPieChartLarge:function t(e,i,n,s){const a=[];let l=0;const d=i.oData.count;let o;let h=0;this.iMissingCnt=0;let c;for(let t=0;t<e.length;t++){if(t+1>=s){break}l=e[t].value;if(l){c={};h=h+l;c.filterCondition=e[t].filterCondition;c.dimension=e[t].facetAttribute;c.label=e[t].label;c.selected=e[t].selected;c.filterLabel=e[t].label;c.id=e[t].label;c.value=l;c.valueLabel=e[t].valueLabel;c.tooltip=e[t].label+"\t: "+l;c.filtered=false;c.removed=false;c.fill="#007CAA";c.maxLabelLength=30;a.push(c)}}if(e.length>0){if(typeof n==="undefined"){o=d}else{o=n}const t=Math.round(h/o*100);let i=100-t;if(i>0){if(i===100){i=99}const t=18*h/350;const n=`${i}`;c={};c.filterCondition=null;c.dimension=e[0].facetAttribute;c.label=n;c.selected=false;c.filterLabel=n;c.id="perc_missing";c.value=t;c.valueLabel=n;c.tooltip=r.getText("facetPieChartOverflowText2",[n,s]);c.filtered=false;c.removed=false;c.fill="transparent";c.stroke="none";c.maxLabelLength=30;a.push(c)}}return a},directUpdate:function t(e,i,n,s,a){let r;const l=[];const d=20;const h=null;r=this.getModel();if(!r){r=this.getParent().getModel()}a.pieChartParentClass="sapUshellSearchFacetPieChartLarge";a.height=a.relevantContainerHeight;$(i).parent().parent().parent().height();this.chartElements=this.getDataForPieChartLarge(e,r,s,d);const c=new o(i,a,h,r);for(let t=0;t<d;t++){if(this.chartElements[t]){l.push(this.chartElements[t])}}c.update(l)},isFacetPanel:function t(){let e=this.getDomRef();while(e){if(e.classList.contains("sapUshellSearchFacetTabBar")){return true}e=e.parentElement}return false},onAfterRendering:function t(){const e=this;let i,n,a,l,d;const o=null;const h={};const c=this.getModel();if(c){l=document.getElementById(this["sId"]);if(this.isFacetPanel()){h.pieChartParentClass="sapUshellSearchFacetPieChart";d=this.getFacetIndex();if(l){l.className=h.pieChartParentClass}i=this.getDataForPieChart(c.getProperty("/facets"),c,d);n=i[d];const t=n.map(t=>t.tooltip);this.getDomRef().setAttribute("aria-label",t.join("; "));const g=this.getBindingContext().getObject();this.getDomRef().setAttribute("data-test-id-facet-dimension-value",`${g.title}-${g.dimension}`);a=new this.PieChart(l,h,o,c);a.update(n);const u=this.getDomRef().closest(".sapUshellSearchFacetIconTabBar");let f=null;if(u){f=u.querySelector(".sapUshellSearchFacetInfoZeile")}if(f){const t=s.getElementById(f.id);if(e.iMissingCnt>0){t.setVisible(true);const i=r.getText("infoZeileNumberMoreSelected",[e.iMissingCnt]);t.setText(i);t.rerender()}else{t.setVisible(false)}}}else if(l&&l.className==="largeChart2piechart"){l.setAttribute("tabindex","0")}}}});d.isIE=function t(){if(navigator.appName==="Microsoft Internet Explorer"){return true}return false};class o{application;parent;model;chartElements;options;svg;svgArcs;svgLabels;oldArcs;clickedSegment;firstUpdate;xOrigin;yOrigin;tweenGenArc;tweenGenText;arcSequence;constructor(t,e,i,n){this.init(t,e,i,n)}init(t,e,i,n){this.parent=t;this.application=i;this.model=n;this.chartElements=[];const s=d.d3.select(t);let a=t instanceof HTMLElement?t.offsetHeight:0;const r=t instanceof HTMLElement?t.offsetWidth:0;if(e.height>a){a=e.height}const l=Math.min(r,a)/2;this.options={"dimension-pie":"YEAR",backgroundWidth:r,backgroundHeight:a,width:r,height:a,innerRadius:0,outerRadius:l*.8,tweenGen:o.Tweens.tweenGenSimple,tweenGenText:o.Tweens.tweenGenSimpleText,arcCalculator:o.generateHistoricalArcCalculator(this),animationduration:1500,labelHideThreshold:.05,easing:"linear",pieChartClass:"sap-piechart",pieChartParentClass:"sapUshellSearchFacetPieChart",color:"blue",strokewidth:1,strokewidthHover:3,padding4click:7,multipleselectable:true,oSearchFacetDialog:null};if(e){for(const t in e){this.options[t]=e[t]}}this.createAttributeService(o,"innerRadius",function(){this.init()});this.createAttributeService(o,"outerRadius",function(){this.init()});this.createAttributeService(o,"tweenGen",function(){this.init()});this.createAttributeService(o,"tweenGenText",function(){this.init()});this.createAttributeService(o,"width",function(){this.init()});this.createAttributeService(o,"height",function(){this.init()});this.createAttributeService(o,"animationduration");this.createAttributeService(o,"labelHideThreshold");this.createAttributeService(o,"arcCalculator");const h=Math.round(this.options.width/2);const c=Math.round(this.options.height/2);this.svg=s.append("svg:svg").attr("width",r).attr("height",a).attr("id",t.id+"_svg").append("svg:g").attr("transform","translate("+h+","+c+")");this.svgArcs=this.svg.append("svg:g");this.svgLabels=this.svg.append("svg:g");this.svg.attr("class",this.options.pieChartClass);this.initTween();this.oldArcs=[];this.clickedSegment={};this.firstUpdate=true}getParent(){return this.parent}static Tweens=function(){const t={tweenGenSimple:undefined,tweenGenSimpleText:undefined,translateStr4Padding:undefined,tweenGenEcstasy:undefined,tweenGenLSD:undefined};t.tweenGenSimple=function(t,e,i,n,s,a){const r={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:n,outerRadius:s};const l={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:n,outerRadius:s};const o=d.d3.interpolate(r,l);return function(t){return a(o(t))}};t.tweenGenSimpleText=function(e,i,n,s,a,r,l){let o=" ";if(e.labelElement.childNodes[1]&&e.labelElement.childNodes[1].childNodes[0]&&e.labelElement.childNodes[1].childNodes[0].data){o=e.labelElement.childNodes[1].childNodes[0].data}const c=new h(r.options.width,r.options.height,e.oldArc.startAngle,e.oldArc.endAngle,r.options.outerRadius,e.labelElement.childNodes[1].getBBox().width,e.labelElement.childNodes[1].getBBox().height,r.svgArcGen(e).centroid(e),o,r.svg);c.update();const g=[c.x,c.y];const u=new h(r.options.width,r.options.height,e.startAngle,e.endAngle,r.options.outerRadius,e.labelElement.childNodes[1].getBBox().width,e.labelElement.childNodes[1].getBBox().height,r.svgArcGen(e).centroid(e),o,r.svg);u.update();if(u.labelWidth<e.labelElement.childNodes[1].getBBox().width){r.adjustLabelWidth(e.labelElement,u.labelWidth)}const f=[u.x,u.y];const p=d.d3.interpolateArray(g,f);const A=function(i){let n;if(l){n=t.translateStr4Padding(e.startAngle,e.endAngle,r.options.padding4click,i[0],i[1])}else{n="translate("+i+")"}return n};return function(t){return A(p(t))}};t.translateStr4Padding=function(t,e,i,n,s){const a=e-t;let r=i*Math.sin(a/2);let l=-(i*Math.cos(a/2));const d=r*Math.cos(t)-l*Math.sin(t);l=r*Math.sin(t)+l*Math.cos(t);r=d;const o="translate("+(n+r)+", "+(s+l)+")";return o};t.tweenGenEcstasy=function(t,e,i,n,s,a){const r=Math.round((n+s)/2);let l;let o;if(e%2){l=s;o=r}else{l=r;o=n}let h={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:n,outerRadius:s};let c={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:o,outerRadius:l};const g=d.d3.interpolate(h,c);h={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:o,outerRadius:l};c={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:o,outerRadius:l};const u=d.d3.interpolate(h,c);h={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:o,outerRadius:l};c={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:n,outerRadius:s};const f=d.d3.interpolate(h,c);return function(t){if(t<=.25){return a(g(t*4))}if(t<=.75){return a(u((t-.25)*2))}return a(f((t-.75)*4))}};t.tweenGenLSD=function(t,e,i,n,s,a){const r=Math.round((n+s)/2);let l;let o;if(e%2){l=s;o=r}else{l=r;o=n}let h={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:n,outerRadius:s};let c={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:o,outerRadius:l};const g=d.d3.interpolate(h,c);h={startAngle:t.oldArc.startAngle,endAngle:t.oldArc.endAngle,innerRadius:o,outerRadius:l};c={startAngle:t.startAngle,endAngle:t.startAngle+(t.oldArc.endAngle-t.oldArc.startAngle),innerRadius:o,outerRadius:l};const u=d.d3.interpolate(h,c);h={startAngle:t.startAngle,endAngle:t.startAngle+(t.oldArc.endAngle-t.oldArc.startAngle),innerRadius:o,outerRadius:l};c={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:o,outerRadius:l};const f=d.d3.interpolate(h,c);h={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:o,outerRadius:l};c={startAngle:t.startAngle,endAngle:t.endAngle,innerRadius:n,outerRadius:s};const p=d.d3.interpolate(h,c);return function(t){if(t<=.25){return a(g(t*4))}if(t<=.5){return a(u((t-.25)*4))}if(t<=.75){return a(f((t-.5)*4))}return a(p((t-.75)*4))}};return t}();createAttributeService(t,e,i){t.prototype[e]=function(t){if(t===null){return this.options[e]}this.options[e]=t;if(i){i.call(this)}return this}}initTween(){const t=this;t.xOrigin=Math.round(t.options.width/2);t.yOrigin=Math.round(t.options.height/2);t.svg.attr("width",this.options.width).attr("height",this.options.height);this.tweenGenArc=function(e,i,n){return t.options.tweenGen(e,i,n,t.options.innerRadius,t.options.outerRadius,t.svgArcGen(e))};this.tweenGenText=function(e,i,n,s){return t.options.tweenGenText(e,i,n,t.options.innerRadius,t.options.outerRadius,t,s)}}update(t){this.notAnimatedUpdate(t)}notAnimatedUpdate(t){const e=this;let i=[];if(!t){return}this.chartElements=t;e.svgArcs.selectAll("path").remove();e.svgLabels.selectAll("g").remove();let n=0;for(let e=0;e<t.length;++e){n+=t[e].value}for(let e=0;e<t.length;++e){t[e].percentage=t[e].value/n}i=this.options.arcCalculator.calculateNewArcsOnly(t);let s=this.svgArcs.selectAll("path").data(i,o.getIdOfArc);if(!s.exit().empty()){s.exit().remove()}if(!s.empty()){s.attr("d",function(t){const i=e.svgArcGen(t);return i(t)}).attr("transform",function(t){let i;if(t.data.selected){i=o.translateStr4Padding(t.startAngle,t.endAngle,e.options.padding4click,0,0)}else{i="translate(0,0)"}return i}).style("stroke",function(t){let e;if(t.data.stroke==="none"){e=t.data.stroke}else if(t.data.selected||t.data.hovered){e="#dadada"}else{e="white"}return e}).style("stroke-width",function(t){let i;if(t.data.selected||t.data.hovered){i=e.options.strokewidthHover}else{i=e.options.strokewidth}return i}).style("opacity",function(t){let e;if(t.data.selected||t.data.hovered){e="1"}else if(t.data.initial){e="0.75"}else{e="0.5"}return e}).each(function(t){while(this.hasChildNodes()){this.removeChild(this.lastChild)}d.d3.select(this).append("svg:title").text(""+t.data.tooltip)})}s.enter().append("svg:path").attr("data-label",t=>t.data.label).attr("transform",function(t){let i;if(t.data.selected){e.clickedSegment[t.data.id]=this;i=o.translateStr4Padding(t.startAngle,t.endAngle,e.options.padding4click,0,0)}return i}).attr("shape-rendering","geometricPrecision").attr("tabindex","0").style("stroke",function(t){let e;if(t.data.stroke==="none"){e=t.data.stroke}else if(t.data.selected||t.data.hovered){e="#dadada"}else{e="white"}return e}).style("stroke-width",function(t){let i;if(t.data.selected||t.data.hovered){i=e.options.strokewidthHover}else{i=e.options.strokewidth}return i}).style("opacity",function(t){let e;if(t.data.selected||t.data.hovered){e="1"}else if(t.data.initial){e="0.75"}else{e="0.5"}return e}).attr("fill",function(t){return t.data.fill}).on("keydown",function(){const t=d.d3.event;const e=t.keyCode||t.which;if(e==32){t.target.__onclick()}}).on("click",function(t,i){let n;if(t.data.click&&t.data.pieupdateuionly===false){const n=t.data.click(t,i);if(!e.options.multipleselectable&&!n){return}}let s,a;let r;const l=e.getLabelElementtbyLabel(t.data.label);if(l){let i=" ";if(l.childNodes[1]&&l.childNodes[1].childNodes[0]&&l.childNodes[1].childNodes[0].data){i=l.childNodes[1].childNodes[0].data}r=new h(e.options.width,e.options.height,t.startAngle,t.endAngle,e.options.outerRadius,l.childNodes[1].getBoundingClientRect().width,l.childNodes[1].getBoundingClientRect().height,e.svgArcGen(t).centroid(t),i,e.svg);r.update();if(r.labelWidth<l.childNodes[1].getBoundingClientRect().width){e.adjustLabelWidth(l,r.labelWidth)}}if(t.data.selected){if(!e.options.multipleselectable&&Object.keys(e.clickedSegment).length>0){delete e.clickedSegment[t.data.id]}s="translate(0,0)";if(l){a="translate("+r.x+","+r.y+")"}t.data.selected=false;if(e.options.oSearchFacetDialog){n={};n.cnt=e.getNumberOfClickedSegments();n.dataObject=t.data;e.options.oSearchFacetDialog.onDetailPageSelectionChangeCharts(n)}else{e.model.removeFilterCondition(t.data.filterCondition,true)}}else{if(!e.options.multipleselectable){if(Object.keys(e.clickedSegment).length>0){for(const t in e.clickedSegment){const i=e.clickedSegment[t];if(typeof i.__onclick==="function"){i.__data__.data.pieupdateuionly=true;i.__onclick.apply(i)}delete e.clickedSegment[t]}}if(Object.keys(e.clickedSegment).length<1){e.clickedSegment[t.data.id]=this}}s=o.translateStr4Padding(t.startAngle,t.endAngle,e.options.padding4click,0,0);if(l){a=o.translateStr4Padding(t.startAngle,t.endAngle,e.options.padding4click,r.x,r.y)}t.data.selected=true;if(t.data.filterCondition){if(e.options.oSearchFacetDialog){n={};n.cnt=e.getNumberOfClickedSegments();n.dataObject=t.data;e.options.oSearchFacetDialog.onDetailPageSelectionChangeCharts(n)}else{e.model.addFilterCondition(t.data.filterCondition,true)}}}d.d3.select(this).transition().duration(1e3).ease(d.d3.ease("elastic")).attr("transform",s).style("stroke",t=>{let e;if(t.data.stroke==="none"){e=t.data.stroke}else if(t.data.selected){e="#dadada"}else{e="white"}return e}).style("stroke-width",t=>{let i;if(t.data.selected){i=e.options.strokewidthHover}else{i=e.options.strokewidth}return i}).style("opacity",t=>{let e;if(t.data.selected||t.data.hovered){e="1"}else if(t.data.initial){e="0.75"}else{e="0.5"}return e});const c=e.getLabelElementtbyLabel(t.data.label);if(c){d.d3.select(c).transition().duration(1e3).ease(d.d3.ease("elastic")).attr("transform",a)}}).on("mouseover",function(t,i){if(!e.options.multipleselectable&&Object.keys(e.clickedSegment).length>0){return}if(t.data.selected||t.data.hovered){return}if(t.data.mouseover){const n=t.data.mouseover(t,i);if(!e.options.multipleselectable&&!n){return}}}).on("mouseout",function(t,i){if(t.data.selected){d.d3.select(this).style("opacity",1)}if(!e.options.multipleselectable&&Object.keys(e.clickedSegment).length>0){return}if(t.data.selected){return}if(t.data.mouseout){const n=t.data.mouseout(t,i);if(!e.options.multipleselectable&&!n){return}}}).attr("d",t=>{const i=e.svgArcGen(t);return i(t)}).append("svg:title").text(t=>""+t.data.tooltip);s=e.svgLabels.selectAll("g").data(i,o.getIdOfArc);if(!s.exit().empty()){s.exit().remove()}if(!s.empty()){s.style("opacity",function(t){if(t.removed||t.data.percentage<e.options.labelHideThreshold){return 0}return 1}).attr("transform",function(t){let i;let n;if(this.childNodes[1]&&this.childNodes[1].childNodes[0]){n=new h(e.options.width,e.options.height,t.startAngle,t.endAngle,e.options.outerRadius,this.getBoundingClientRect().width,this.getBoundingClientRect().height,e.svgArcGen(t).centroid(t),t.data.label,e.svg)}else{n=new h(e.options.width,e.options.height,t.startAngle,t.endAngle,e.options.outerRadius,this.getBoundingClientRect().width,this.getBoundingClientRect().height,e.svgArcGen(t).centroid(t)," ",e.svg)}n.update();if(n.labelWidth<this.childNodes[1].getBoundingClientRect().width){e.adjustLabelWidth(this,n.labelWidth)}if(t.data.selected){i=o.translateStr4Padding(t.startAngle,t.endAngle,e.options.padding4click,n.x,n.y)}else{i="translate("+n.x+","+n.y+")"}return i})}if(!s.enter().empty()){const t=s.enter().append("svg:g").style("opacity",0);t.append("svg:text").attr("class","labelshadow").attr("text-anchor","middle").text(function(t){return""+t.data.label}).style("pointer-events","none");t.append("svg:text").attr("class","label").attr("text-anchor","middle").text(function(t){return""+t.data.label}).style("pointer-events","none");t.style("opacity",function(t){if(t.removed||t.data.percentage<e.options.labelHideThreshold){return 0}return 1}).attr("transform",function(t){let i;const n=new h(e.options.width,e.options.height,t.startAngle,t.endAngle,e.options.outerRadius,this.getBoundingClientRect().width,this.getBoundingClientRect().height,e.svgArcGen(t).centroid(t),t.data.label,e.svg);n.update();if(n.labelWidth<this.childNodes[1].getBoundingClientRect().width){e.adjustLabelWidth(this,n.labelWidth)}if(t.data.selected){i=o.translateStr4Padding(t.startAngle,t.endAngle,e.options.padding4click,n.x,n.y)}else{i="translate("+n.x+","+n.y+")"}return i})}e.oldArcs=o.removeDeletedArcs(i)}getNumberOfClickedSegments(){let t=0;const e=this.chartElements;for(let i=0;i<e.length;i++){if(e[i].selected===true){t++}}return t}adjustLabelWidth(t,e){const i=t.childNodes[0];const n=t.childNodes[1];if(e<=0){i.childNodes[0].data="";n.childNodes[0].data="";return}let s=i.childNodes[0].data.length;i.childNodes[0].data+="...";let a="";while(i.getBBox().width>e){a=i.childNodes[0].data;a=a.substr(0,s-1)+a.substr(s,3);i.childNodes[0].data=a;s--;if(s<=0){i.childNodes[0].data="";break}}n.childNodes[0].data=i.childNodes[0].data}getArcsWithLabel(t){const e=[];for(let i=0;i<t.length;++i){const n=t[i];if(n.data.percentage>this.options.labelHideThreshold){e.push(n)}}return e}svgArcGen(...t){const e=this;const i=d.d3.svg.arc().innerRadius(function(){return e.options.innerRadius}).outerRadius(function(){return e.options.outerRadius}).startAngle(t=>t.startAngle).endAngle(t=>t.endAngle);return i}getArcElementtbyLabel(t){let e=this;e.svgArcs.selectAll("g").each(function(i){if(i.data.label===t){e=this}return});return e}getLabelElementtbyLabel(t){let e=this;e.svgLabels.selectAll("g").each(function(i){if(i.data.label===t){e=this}});return e}static removeDeletedArcs(t){const e=[];for(let i=0;i<t.length;++i){const n=t[i];if(!n.removed){e.push(n)}}return e}static createZeroArc(t,e){return{startAngle:t,endAngle:t,data:e,removed:true}}insertAfter(t,e,i){let n;if(e>=0){const s=t[e];n=o.createZeroArc(s.endAngle,i.data)}else{n=o.createZeroArc(0,i.data)}n.oldArc=i;t.splice(e+1,0,n)}static getIdOfArc(t){return t.data.id}static arcsGen=function(){return d.d3.layout.pie().value(function(t){return t.value}).sort(null)};static getIndexById(t,e){for(let i=0;i<t.length;++i){const n=t[i];if(o.getIdOfArc(n)===e){return i}}return null}static add2arcSequence(t,e){if(d.isIE()){const i=function(t){e.getIndex(t.id)};t.forEach(i)}return t}static translateStr4Padding(t,e,i,n,s){const a=e-t;let r=i*Math.sin(a/2);let l=-(i*Math.cos(a/2));const d=r*Math.cos(t)-l*Math.sin(t);l=r*Math.sin(t)+l*Math.cos(t);r=d;const o="translate("+(n+r)+", "+(s+l)+")";return o}generateDefaultArcCalculator(){return new u(this)}calculateNewArcsOnly(t){t=t.slice();o.add2arcSequence(t,this.arcSequence);t.sort((t,e)=>this.arcSequence.getIndex(t.id)-this.arcSequence.getIndex(e.id));const e=o.arcsGen()(t);return e}calculateArcs(t,e){const i=o.arcsGen()(e);this.insertMissingArcs(t,i,true);this.insertMissingArcs(i,t,false);return i}insertMissingArcs(t,e,i){let n=-1;for(let s=0;s<e.length;++s){const a=e[s];const r=o.getIndexById(t,a.data.id);let l;if(r!==null){l=t[r];l.oldArc=a;n=r;continue}else{if(i){n=this.determineInsertIndex(t,n,e,s)}let r;if(n>=0){const e=t[n];r=o.createZeroArc(e.endAngle,a.data)}else{r=o.createZeroArc(0,a.data)}r.oldArc=a;t.splice(n+1,0,r);n++}}}determineInsertIndex(t,e,i,n){const s=i[n];const a=this.arcSequence.getIndex(s.data.id);let r;for(r=e+1;r<t.length;++r){const e=this.arcSequence.getIndex(t[r].data.id);if(e>a){break}if(o.getIndexById(i,t[r].data.id)!==null){break}}return r-1}static generateHistoricalArcCalculator(t,...e){return new g(t,e)}}class h{x;y;backgroundWidth;backgroundHeight;startAngle;endAngle;r;labelPaddingX;labelPaddingY;radiusPadding;labelWidth;labelHeight;outsetMin;outsetMax;outsetStep;apexAngle;startLabelWidth;d3centroid;text;svgBackground;translateStr;debug;constructor(t,e,i,n,s,a,r,l,d,o){this.backgroundWidth=t;this.backgroundHeight=e;this.startAngle=i;this.endAngle=n;this.r=s;this.labelPaddingX=3;this.labelPaddingY=3;this.radiusPadding=4.24;this.labelWidth=a+2*this.labelPaddingX;this.labelHeight=r;this.outsetMin=.3;this.outsetMax=1.2;this.outsetStep=.025;this.apexAngle=n-i;this.startLabelWidth=this.labelWidth;this.d3centroid=l;this.text=d;this.svgBackground=o;this.debug=false;this.labelHeight=this.labelHeight+2*this.labelPaddingY;const h=Math.round(this.backgroundWidth/2);const c=Math.round(this.backgroundHeight/2);this.translateStr="translate("+h+","+c+")"}update(){let t=Math.max(this.outsetMin,Math.sin(this.apexAngle/2)/(this.apexAngle/2)*2/3);let e=true;let i=Math.max(100,this.labelWidth*2,1/this.outsetStep);let n=0;let s;do{e=true;s=this.calc(t,this.labelWidth);if(t>this.outsetMax||t<this.outsetMin){break}if(this.labelWidth<0){break}let a,r,l,d;if(n===0){a=this.calc(t+this.outsetStep,this.labelWidth);r=this.calc(t-this.outsetStep,this.labelWidth);l=this.value(a,s);d=this.value(r,s);if(l<d&&d>.5){n=-1;t+=this.outsetStep*n;e=false}else if(l>.5||s.labelWidth<=0){n=1;t+=this.outsetStep*n;e=false}}else{a=this.calc(t+this.outsetStep*n,this.labelWidth);l=this.value(a,s);if(l>.5||s.labelWidth<=0){t+=this.outsetStep*n;e=false}}i--}while(!e&&i>0&&!isNaN(t));s=this.calc(t,this.labelWidth);this.labelWidth=s.labelWidth;const a=s.x;const r=s.y;this.svgBackground.select("circle.centroid").remove();if(this.debug){this.svgBackground.append("svg:circle").attr("class","centroid").attr("cx",s.centroidX).attr("cy",s.centroidY).attr("r",2).style("fill","blue")}this.svgBackground.selectAll("line.helper").remove();if(this.debug){this.svgBackground.append("svg:line").attr("class","helper helper2").attr("x1",-this.backgroundWidth/2).attr("x2",this.backgroundWidth/2).attr("y1",r-this.labelHeight/2).attr("y2",r-this.labelHeight/2);this.svgBackground.append("svg:line").attr("class","helper helper2").attr("x1",-this.backgroundWidth/2).attr("x2",this.backgroundWidth/2).attr("y1",r+this.labelHeight/2).attr("y2",r+this.labelHeight/2);this.svgBackground.append("svg:line").attr("class","helper").attr("x1",0).attr("y1",0).attr("x2",Math.sin(this.startAngle)*(this.r+this.radiusPadding)).attr("y2",-Math.cos(this.startAngle)*(this.r+this.radiusPadding));this.svgBackground.append("svg:line").attr("class","helper").attr("x1",0).attr("y1",0).attr("x2",Math.sin(this.endAngle)*(this.r+this.radiusPadding)).attr("y2",-Math.cos(this.endAngle)*(this.r+this.radiusPadding));this.svgBackground.append("svg:line").attr("class","helper").attr("x1",Math.sin(this.startAngle)*(this.r+this.radiusPadding)).attr("y1",-Math.cos(this.startAngle)*(this.r+this.radiusPadding)).attr("x2",this.isStartAngleOnRight()?this.backgroundWidth/2:-this.backgroundWidth/2).attr("y2",-Math.cos(this.startAngle)*(this.r+this.radiusPadding));this.svgBackground.append("svg:line").attr("class","helper").attr("x1",Math.sin(this.endAngle)*(this.r+this.radiusPadding)).attr("y1",-Math.cos(this.endAngle)*(this.r+this.radiusPadding)).attr("x2",this.isEndAngleOnRight()?this.backgroundWidth/2:-this.backgroundWidth/2).attr("y2",-Math.cos(this.endAngle)*(this.r+this.radiusPadding))}if(this.labelWidth<2*this.labelPaddingX){this.labelWidth=0}else if(this.labelWidth<this.startLabelWidth){this.labelWidth=this.labelWidth-2*this.labelPaddingX}this.x=isNaN(a)?0:a;this.y=isNaN(a)?0:r}calc(t,e){let i,n,s,a,r,l;if(this.startAngle-this.endAngle+2*Math.PI<1e-9){i=0;n=0;a=this.backgroundWidth/2;s=-this.backgroundWidth/2;l=-this.r;r=this.r}else{i=Math.sin(this.apexAngle/2)*this.r*t;n=Math.cos(this.apexAngle/2)*-this.r*t;const e=i*Math.cos(this.startAngle)-n*Math.sin(this.startAngle);n=i*Math.sin(this.startAngle)+n*Math.cos(this.startAngle);i=e;const d=n-this.labelHeight/2;const o=n+this.labelHeight/2;s=Math.max(this.calcLeftBorder(i,d),this.calcLeftBorder(i,o),-this.backgroundWidth/2);if(Math.abs(this.startAngle-this.endAngle%(2*Math.PI))>1e-9&&i>0&&d<=0&&o>=0){s=Math.max(s,0)}if(!this.doesFitHeight(s,d,o,i<0,true)){s=this.backgroundWidth/2}a=Math.min(this.calcRightBorder(i,d),this.calcRightBorder(i,o),this.backgroundWidth/2);if(Math.abs(this.startAngle-this.endAngle%(2*Math.PI))>1e-9&&i<0&&d<=0&&o>=0){a=Math.min(a,0)}if(!this.doesFitHeight(a,d,o,i<0,false)){a=-this.backgroundWidth/2}let h=this.calcPerimeterBorder(1,n-this.labelHeight/2);if(h<i){h=this.backgroundWidth/2}let c=this.calcPerimeterBorder(1,n+this.labelHeight/2);if(c<i){c=this.backgroundWidth/2}r=Math.min(h,c,a);let g=this.calcPerimeterBorder(-1,n-this.labelHeight/2);if(g>i){g=-this.backgroundWidth/2}let u=this.calcPerimeterBorder(-1,n+this.labelHeight/2);if(u>i){u=-this.backgroundWidth/2}l=Math.max(g,u,s);if(isNaN(r)){r=a}if(isNaN(l)){l=s}}this.svgBackground.select("line.left").remove();this.svgBackground.select("line.right").remove();this.svgBackground.select("line.perimeterLeft").remove();this.svgBackground.select("line.perimeterRight").remove();if(this.debug){this.svgBackground.append("svg:line").attr("class","left").attr("y1",-this.backgroundHeight/2).attr("y2",this.backgroundHeight/2).attr("x1",s).attr("x2",s);this.svgBackground.append("svg:line").attr("class","right").attr("y1",-this.backgroundHeight/2).attr("y2",this.backgroundHeight/2).attr("x1",a).attr("x2",a);this.svgBackground.append("svg:line").attr("class","perimeterLeft").attr("y1",-this.backgroundHeight/2).attr("y2",this.backgroundHeight/2).attr("x1",l).attr("x2",l);this.svgBackground.append("svg:line").attr("class","perimeterRight").attr("y1",-this.backgroundHeight/2).attr("y2",this.backgroundHeight/2).attr("x1",r).attr("x2",r)}const d=e;e=Math.min(e,Math.floor(a-s));let o=i;o=Math.max(o,l+e/2);o=Math.min(o,r-e/2);if(o-e/2<l-1e-9||o+e/2>r+1e-9){o=(l+r)/2}if(i>=0){o=Math.max(o,s+e/2);o=Math.min(o,a-e/2)}else{o=Math.min(o,a-e/2);o=Math.max(o,s-e/2)}const h=n;return{x:o,y:h,labelWidth:e,labelShortened:e!==d,xSpace:a-s,centroidX:i,centroidY:n,asymmetry:Math.abs(o-i)}}value(t,e){if(t.labelWidth<0){return-1e4}if(t.labelWidth<e.labelWidth){return-100}if(t.labelWidth>e.labelWidth){return(t.labelWidth-e.labelWidth)*1e3}if(e.labelShortened&&t.labelWidth===e.labelWidth){return(t.xSpace-e.xSpace)*100}return 0}doesFitHeight(t,e,i,n,s){let a=-Math.cos(this.startAngle)*(this.r+this.radiusPadding);let r=-Math.cos(this.endAngle)*(this.r+this.radiusPadding);if(Math.abs(this.startAngle-this.endAngle%(2*Math.PI))<1e-9){a=-this.backgroundHeight/2;r=this.backgroundHeight/2}else if(t===0){a=-this.backgroundHeight/2;r=this.backgroundHeight/2}else if(t>0){if(!this.isStartAngleOnRight()){a=-this.backgroundHeight/2}else if(t<=Math.sin(this.startAngle)*(this.r+this.radiusPadding)){a=t/-Math.tan(this.startAngle)}if(!this.isEndAngleOnRight()){r=this.backgroundHeight/2}else if(t<=Math.sin(this.endAngle)*(this.r+this.radiusPadding)){r=t/-Math.tan(this.endAngle)}if(n&&!s&&a>=i){a=-this.backgroundHeight/2}if(n&&!s&&r<=e){r=this.backgroundHeight/2}}else{if(this.isStartAngleOnRight()){a=this.backgroundHeight/2}else if(t>Math.sin(this.startAngle)*(this.r+this.radiusPadding)){a=t/-Math.tan(this.startAngle)}if(this.isEndAngleOnRight()){r=-this.backgroundHeight/2}else if(t>Math.sin(this.endAngle)*(this.r+this.radiusPadding)){r=t/-Math.tan(this.endAngle)}if(!n&&s&&r>=i){r=-this.backgroundHeight/2}if(!n&&s&&a<=e){a=this.backgroundHeight/2}}if(!s){this.svgBackground.selectAll(".rightBorder").remove();if(this.debug){this.svgBackground.append("svg:rect").attr("class","rightBorder").attr("x",t-3).attr("y",a-3).attr("width",6).attr("height",6).style("fill","green");this.svgBackground.append("svg:circle").attr("class","rightBorder").attr("cx",t).attr("cy",r).attr("this.r",3).style("fill","green")}}else{this.svgBackground.selectAll(".leftBorder").remove();if(this.debug){this.svgBackground.append("svg:rect").attr("class","leftBorder").attr("x",t-3).attr("y",a-3).attr("width",6).attr("height",6).style("fill","red");this.svgBackground.append("svg:circle").attr("class","leftBorder").attr("cx",t).attr("cy",r).attr("this.r",3).style("fill","red")}}return e>=Math.min(a,r)-1e-9&&i<=Math.max(a,r)+1e-9}calcLeftBorder(t,e){let i=-this.backgroundWidth/2;if(Math.abs(this.startAngle-this.endAngle%(2*Math.PI))<1e-9){return i}if(e<=0){if(e>-Math.cos(this.startAngle)*(this.r+this.radiusPadding)){i=Math.tan(this.startAngle)*-e}}else if(e<-Math.cos(this.endAngle)*(this.r+this.radiusPadding)){i=Math.tan(this.endAngle)*-e}return i}calcRightBorder(t,e){let i=this.backgroundWidth/2;if(Math.abs(this.startAngle-this.endAngle%(2*Math.PI))<1e-9){return i}if(e>=0){if(-e>Math.cos(this.startAngle)*(this.r+this.radiusPadding)){i=Math.tan(this.startAngle)*-e}}else if(-e<Math.cos(this.endAngle)*(this.r+this.radiusPadding)){i=Math.tan(this.endAngle)*-e}return i}calcPerimeterBorder(t,e){let i=t>0?this.backgroundWidth/2:-this.backgroundWidth/2;i=Math.sqrt(this.r*this.r-e*e);if(t<0){i*=-1}return i}isStartAngleOnRight(){return this.startAngle>0&&this.startAngle<=2*Math.PI/360*180}isEndAngleOnRight(){return this.endAngle%(2*Math.PI)<2*Math.PI/360*180}}class c{maxIndex;objectMap;constructor(...t){this.init(t)}init(...t){this.maxIndex=0;this.objectMap={}}getIndex(t){let e=this.objectMap[t];if(typeof e!=="undefined"){return e}e=this.maxIndex;this.maxIndex++;this.objectMap[t]=e;return e}}class g{_pieChart;constructor(t,...e){this._pieChart=t;this.init(t,e)}init(t,...e){t.arcSequence=new c(e)}calculateNewArcsOnly(t){t=t.slice();o.add2arcSequence(t,this._pieChart.arcSequence);const e=o.arcsGen()(t);return e}calculateArcs(t,e){e=e.slice();o.add2arcSequence(e,this._pieChart.arcSequence);e.sort(function(t,e){return this._pieChart.arcSequence.getIndex(t.id)-this._pieChart.arcSequence.getIndex(e.id)});const i=o.arcsGen()(e);this.insertMissingArcs(t,i);this.insertMissingArcs(i,t);return i}insertMissingArcs(t,e){let i=0;for(let n=0;n<e.length;++n){const s=e[n];const a=this._pieChart.arcSequence.getIndex(s.data.id);let r;let l=false;for(;i<t.length;++i){r=t[i];const e=this._pieChart.arcSequence.getIndex(r.data.id);if(e===a){l=true;break}if(e>a){break}}if(l){r.oldArc=s}else{let e;if(i-1>=0&&i-1<t.length){const n=t[i-1];e=o.createZeroArc(n.endAngle,s.data)}else{e=o.createZeroArc(0,s.data)}t.splice(i,0,e);e.oldArc=s}i++}}}class u{constructor(t,...e){this.init(t,e)}init(t,...e){t.arcSequence=new c(e)}}return d});
//# sourceMappingURL=SearchFacetPieChart.js.map