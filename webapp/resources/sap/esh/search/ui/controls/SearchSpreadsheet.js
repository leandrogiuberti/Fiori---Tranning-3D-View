/*!
 * SAPUI5
 * Copyright (c) 2025 SAP SE or an SAP affiliate company. All rights reserved.
 * 
 */
sap.ui.define(["../i18n","sap/ui/export/Spreadsheet","../error/ErrorHandler","sap/ui/core/mvc/Controller","sap/esh/search/ui/SearchResultFormatter","sap/ui/core/Element","../SearchResultTableColumnType","../sinaNexTS/sina/SearchResultSetItemAttributeGroup","../sinaNexTS/sina/AttributeType","sap/ui/export/library","sap/m/MessageBox"],function(t,e,o,r,s,n,i,a,u,l,c){"use strict";function f(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}const m=f(t);const p=f(o);const h=i["TableColumnType"];const b=a["SearchResultSetItemAttributeGroup"];const d=u["AttributeType"];const y=l["EdmType"];const C=r.extend("sap.esh.search.ui.controls.SearchSpreadsheet",{constructor:function t(){r.prototype.constructor.apply(this,arguments);this.limit=1e3},onExport:async function t(e){this.model=e;if(this.model.getProperty("/boCount")>this.limit){c.information(m.getText("exportDataInfo"),{actions:[c.Action.OK,c.Action.CANCEL],emphasizedAction:c.Action.OK,onClose:async t=>{let e;if(t==c.Action.OK){e=true}if(t==c.Action.CANCEL){e=false}await this.controlExport(e)},styleClass:"sapUshellSearchResultExportDialog"})}else{await this.controlExport(true)}},controlExport:async function t(e){try{this.lockUI();if(!e){return}const t=await this.formatExportData();await this.doUI5Export(t)}catch(t){const e=p.getInstance();e.onError(t)}finally{this.unlockUI()}},formatExportData:async function t(){const e=this.model.query.clone();e.setCalculateFacets(false);e.setTop(this.limit);const o=await e.getResultSetAsync();const r=new s(this.model);const n=r.format(o,e.filter.searchTerm,{suppressHighlightedValues:true});this.exportDataType="technical";this.visibleColumns=this.getVisibleColumns();const i=this.formatExportColumns(n);const a=this.formatExportRows(n);return{exportColumns:i,exportRows:a}},getVisibleColumns:function t(){const e=[];if(this.model.getResultViewType()!=="searchResultTable"){this.model.getTableInitialColumns().forEach(t=>{if(t.visible===true){e.push(t)}})}else{this.model.getTableColumns(false).forEach(t=>{if(t.visible===true){e.push(t)}})}return e},formatExportColumns:function t(e){const o=e[0].itemattributes;let r=[];for(const t of this.visibleColumns){switch(t.type){case h.TITLE:case h.TITLE_DESCRIPTION:r.push({label:t.name,property:t.p13NColumnName,type:y.String,columnType:t.type});break;case h.DETAIL:if(this.exportDataType==="formatted"){r=r.concat([this.formatMergedColumn(t)])}else{r=r.concat(this.formatSeparateColumns(t,o))}break;default:break}}return r},formatMergedColumn:function t(e){return{label:e.name,property:e.attributeId,type:y.String,columnType:h.DETAIL}},formatSeparateColumns:function t(e,o){const r=o.find(t=>t?.sinaAttribute?.id===e.attributeId);const s=r?.sinaAttribute;if(s){if(s instanceof b){return this.formatColumnsForGroupAttribute(s)}else{return[this.formatColumnForSingleAttribute(s)]}}return[]},formatColumnsForGroupAttribute:function t(e){const o=[];const r=e?.attributes||[];for(const t of r){if(t?.attribute instanceof b){const e=this.formatColumnsForGroupAttribute(t?.attribute);o.push(...e)}else{o.push(this.formatColumnForSingleAttribute(t.attribute))}}return o},formatColumnForSingleAttribute:function t(e){if(e){return{label:e?.label,property:e?.id,type:this.isNumberType(e)?y.Number:y.String,columnType:h.DETAIL}}return{}},formatExportRows:function t(e){const o=[];for(const t of e){o.push(this.formatExportRow(t))}return o},formatExportRow:function t(e){let o={};for(const t of this.visibleColumns){switch(t.type){case h.TITLE:o[t.p13NColumnName]=e.title;break;case h.TITLE_DESCRIPTION:o[t.p13NColumnName]=e.titleDescription;break;case h.DETAIL:if(this.exportDataType==="formatted"){o={...o,...this.formatMergedCell(t,e.itemattributes)}}else{o={...o,...this.formatSeparateCells(t,e.itemattributes)}}break;default:break}}return o},formatMergedCell:function t(e,o){const r=o.find(t=>t?.sinaAttribute?.id===e.attributeId);if(r){const t=e?.attributeId;const o=r?.value||"";return{[t]:o}}return{}},formatSeparateCells:function t(e,o){const r=o.find(t=>t?.sinaAttribute?.id===e.attributeId);if(r){const t=r?.sinaAttribute;if(t instanceof b){return this.formatCellsForGroupAttribute(t)}else{return this.formatCellsForSingleAttribute(t)}}return{}},formatCellsForGroupAttribute:function t(e){let o={};const r=e?.attributes||[];for(const t of r){if(t?.attribute instanceof b){const e=this.formatCellsForGroupAttribute(t?.attribute);o={...o,...e}}else{o={...o,...this.formatCellsForSingleAttribute(t.attribute)}}}return o},formatCellsForSingleAttribute:function t(e){if(e){const t=e?.id;let o;if(this.isNumberType(e)){o=e?.value||""}else{o=e?.valueFormatted||""}return{[t]:o}}return{}},isNumberType:function t(e){if(e?.metadata?.type===d.Double||e?.metadata?.type===d.Integer){return true}else{return false}},doUI5Export:async function t(o){const r={workbook:{columns:o.exportColumns},fileName:m.getText("exportFileName"),dataSource:o.exportRows};new e(r).build().then(()=>{},t=>{const e=p.getInstance();e.onError(t)})},lockUI:function t(){const e=document?.querySelectorAll('[id$="ushell-search-result-dataExportButton"]')[0]?.id;const o=n.getElementById(e);o?.setEnabled(false);this.model?.busyIndicator?.setBusy(true)},unlockUI:function t(){const e=document?.querySelectorAll('[id$="ushell-search-result-dataExportButton"]')[0]?.id;const o=n.getElementById(e);o?.setEnabled(true);this.model?.busyIndicator?.setBusy(false)}});return C});
//# sourceMappingURL=SearchSpreadsheet.js.map