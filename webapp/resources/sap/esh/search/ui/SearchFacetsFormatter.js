/*!
 * SAPUI5
 * Copyright (c) 2025 SAP SE or an SAP affiliate company. All rights reserved.
 * 
 */
sap.ui.define(["./error/ErrorHandler","./hierarchydynamic/SearchHierarchyDynamicFacetsFormatter","./hierarchystatic/SearchHierarchyStaticFacetsFormatter","./Facet","./FacetItem","./sinaNexTS/sina/ComparisonOperator","./controls/facets/FacetTypeUI"],function(e,t,a,r,o,c,i){"use strict";function n(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}const s=n(e);const u=n(t);const l=n(a);const d=n(r);const h=n(o);const f=c["ComparisonOperator"];const S=i["FacetTypeUI"];class F{searchFacetDialogModel;errorHandler;hierarchyDynamicFacetsFormatter;hierarchyStaticFacetsFormatter;treeQuickSelectDataSourceFacet;constructor(e){this.searchFacetDialogModel=e;this.errorHandler=s.getInstance();this.hierarchyDynamicFacetsFormatter=new u(e);this.hierarchyStaticFacetsFormatter=new l(e)}_getAncestorDataSources(e){const t=[];const a=e.dataSourceTree.findNode(e.getProperty("/uiFilter/dataSource"));if(a){const e=a.getAncestors().reverse();for(let a=0;a<e.length;a++){const r=e[a].dataSource;const o=new h({label:r.labelPlural,icon:r.icon||"sap-icon://none",filterCondition:r,level:0,value:e[a].count?e[a].count.toString():""});t.push(o)}}return t}_getSiblingDataSources(e,t){const a=[];const r=e.getProperty("/uiFilter/dataSource");const o=e.dataSourceTree.findNode(r);let c;if(o.parent&&!o.unsureWhetherNodeisBelowRoot){c=o.parent.getChildren()}else{c=[]}if(c.length===0){c.push(o)}for(let o=0,i=c.length;o<i;o++){const i=c[o].dataSource;const n=new h({label:i.labelPlural,icon:i.icon||"sap-icon://none",value:c[o].count,filterCondition:i,selected:r===i,level:t});a.push(n);if(n.selected){a.push(...this._getChildrenDataSources(e,t+1))}}return a}_getChildrenDataSources(e,t){const a=[];const r=e.getProperty("/uiFilter/dataSource");const o=e.dataSourceTree.findNode(r).getChildren();for(let e=0,r=o.length;e<r;e++){const r=o[e].dataSource;const c=new h({label:r.labelPlural,icon:r.icon||"sap-icon://none",value:o[e].count?o[e].count.toString():"",filterCondition:r,selected:false,level:t});a.push(c)}return a}getDataSourceFacetFromTree(e){const t=new d({facetType:S.DataSource,title:"Search In"});const a=e.getProperty("/uiFilter/dataSource");const r=this._getAncestorDataSources(e);t.items.push(...r);const o=this._getSiblingDataSources(e,e.allDataSource===a?0:1);t.items.push(...o);return t}_createFacetItemsFromConditionGroup(e,t){const a=[];for(let r=0;r<t.conditions.length;r++){const o=t.conditions[r];for(let t=0;t<o.conditions.length;t++){const r=o.conditions[t];let c;if(r.type===this.searchFacetDialogModel.sinaNext.ConditionType.Simple){c=r.attribute;if(e.getAttributeMetadata(c).isHierarchy){continue}a.push(new h({facetAttribute:c,label:this._formatLabel(r.valueLabel,r.operator),filterCondition:r,selected:true}))}else{c=r.conditions[0].attribute;if(e.getAttributeMetadata(c).isHierarchy){continue}a.push(new h({facetAttribute:c,label:r.valueLabel,filterCondition:r,selected:true}))}}}return a}_formatLabel(e,t){let a;switch(t){case f.Bw:a=e+"*";break;case f.Ew:a="*"+e;break;case f.Co:a="*"+e+"*";break;default:a=e;break}return a}getAttributeFacetsFromResultSet(e,t){const a=t.getDataSource();if(a.type===t.sinaNext.DataSourceType.Category){return Promise.resolve([])}const r=e.facets.filter(function(e){return e&&e.type&&e.type===t.sinaNext.FacetType.Chart});const o=[];const c={};for(const t of r){let a;if(typeof t?.facetTotalCount==="number"){a=t?.facetTotalCount}else{a=e.totalCount}const r=new d({title:t.title,facetType:S.Attribute,dimension:t.query.dimension,totalCount:a});if(t.items.length===0){continue}for(let e=0;e<t.items.length;e++){const a=t.items[e];const o=new h({facetAttribute:t.query.dimension,label:this._formatLabel(a.dimensionValueFormatted,a.filterCondition.operator),value:a.measureValue,filterCondition:a.filterCondition,icon:a.icon});o.facetTitle=t.title;r.items.push(o)}c[t.query.dimension]=r;o.push(r)}this.addDataTypeToClientSideFacets(o,t);const i={};const n=this._createFacetItemsFromConditionGroup(a,t.getProperty("/uiFilter/rootCondition"));for(let e=0,t=n.length;e<t;e++){const t=n[e];const a=c[t.facetAttribute];if(a){const e=o.indexOf(a);if(e>0){o.splice(e,1);o.splice(0,0,a)}for(let e=0,r=a.items.length;e<r;e++){const r=a.items[e];if(t.filterCondition.equals(r.filterCondition)){r.selected=true}}}i[t.facetAttribute]=a}return Promise.resolve(o)}addDataTypeToClientSideFacets(e,t){const a=t.getDataSource();for(let t=0;t<e.length;t++){const r=e[t];try{const e=a.getAttributeMetadata(r.dimension);r.dataType=e.type}catch(e){this.errorHandler.onError(e)}}}addQuickSelectDataSourceFacet(e,t){if(e.config.quickSelectDataSources.length===0){return}const a=e.config.quickSelectDataSources[0];let r;if(a.type==="quickSelectDataSourceTreeNode"){r=this.createTreeQuickSelectDataSourceFacet(e)}else{r=this.createListQuickSelectDataSourceFacet(e)}t.push(r)}createListQuickSelectDataSourceFacet(e){return{facetType:S.QuickSelectDataSource,items:e.config.quickSelectDataSources.map(e=>({type:"quickSelectDataSourceListItem",dataSource:e}))}}createTreeQuickSelectDataSourceFacet(e){if(!this.treeQuickSelectDataSourceFacet){this.treeQuickSelectDataSourceFacet={facetType:S.QuickSelectDataSource,items:[{type:"quickSelectDataSourceTreeNode",children:e.config.quickSelectDataSources.map(e=>this.createTreeNodeQuickSelectDataSource(e))}]}}const t=this.treeQuickSelectDataSourceFacet.items[0];this.expandPathToSelectedDataSource(e,t);return this.treeQuickSelectDataSourceFacet}expandPathToSelectedDataSource(e,t){function a(e,t){const a=[];function r(e,o){e=e.slice();e.push(o);if(o.getDataSource&&o.getDataSource()===t){a.push(e);return}if(!o.children){return}for(const t of o.children){r(e,t)}}r([],e);return a}const r=a(t,e.getDataSource());for(const e of r){for(let t=0;t<e.length-1;++t){const a=e[t];a.expanded=true}}}createTreeNodeQuickSelectDataSource(e){let t=[];if(e.children){t=e.children.map(e=>this.createTreeNodeQuickSelectDataSource(e))}return{expanded:false,type:"quickSelectDataSourceTreeNode",label:e.dataSource.labelPlural,icon:e.dataSource.icon,getDataSource:()=>e.dataSource,dataSourceId:e.dataSource.id,children:t,toggleExpand:function(){this.expanded=!this.expanded}}}async getFacets(e,t,a){const r=[];r.push(this.getDataSourceFacetFromTree(a));this.addQuickSelectDataSourceFacet(a,r);if(e===a.appDataSource||e.type===a.sinaNext.DataSourceType.Category){this.sortFacets(r,a);this.setFacetIndex(r);return r}if(!t){this.sortFacets(r,a);this.setFacetIndex(r);return r}const o=await this.hierarchyDynamicFacetsFormatter.getFacets(t,a);r.push(...o);const c=await this.hierarchyStaticFacetsFormatter.getFacets(t);r.push(...c);const i=await this.getAttributeFacetsFromResultSet(t,a);r.push(...i);this.sortFacets(r,a);this.setFacetIndex(r);return r}setFacetIndex(e){for(let t=0;t<e.length;++t){const a=e[t];if(a.setFacetIndex){a.setFacetIndex(t)}else{a.facetIndex=t}}}sortFacets(e,t){const a={[S.DataSource]:-2e3,[S.QuickSelectDataSource]:-1e3,[S.HierarchyStatic]:100,[S.Hierarchy]:1e3,[S.Attribute]:1e3};for(let r=0;r<e.length;++r){const o=e[r];o.position=r;o.position+=a[o.facetType];if(o.facetType===S.Attribute||o.facetType===S.Hierarchy){if(t.getFilterRootCondition().containsAttribute(o.dimension)){o.position-=500}}}e.sort((e,t)=>e.position-t.position)}getDialogFacetsFromMetaData(e,t){const a=[];const r=this.getAttributeDialogFacetsFromMetaData(e,t);a.push(...r);const o=this.hierarchyDynamicFacetsFormatter.getFacetsFromMetadata(e,t);a.push(...o);a.sort(function(e,t){return e.title.localeCompare(t.title)});this.setFacetIndex(a);return a}getAttributeDialogFacetsFromMetaData(e,t){const a=Object.values(e.attributeMetadataMap);const r=[];for(const e of a){if((e.usage.Facet||e.usage.AdvancedSearch)&&e.isHierarchy!==true){const a=new d({title:e.label,facetType:S.Attribute,dimension:e.id,dataType:e.type,matchingStrategy:e.matchingStrategy});const o=this._createFacetItemsFromConditionGroup(t.getDataSource(),t.getProperty("/uiFilter/rootCondition"));let c=0;for(let e=0,t=o.length;e<t;e++){const t=o[e];t.visible=a.visible;if(t.facetAttribute===a.dimension){c++;a.items.splice(0,0,t)}}a["count"]=c;r.push(a)}}return r}getDialogFacetsFromChartQuery(e,t,a,r){const o=new d({dimension:a,totalCount:e?.facetTotalCount});if(e){for(let t=0;t<e.items.length;t++){const a=e.items[t];const r=new h({value:a.measureValue,filterCondition:a.filterCondition,label:a.dimensionValueFormatted,facetAttribute:e.query.dimension});o.items.push(r)}let a;if(r){a=r}else{a=this._createFacetItemsFromConditionGroup(t.getDataSource(),t.getProperty("/uiFilter/rootCondition"))}for(let e=0,t=a.length;e<t;e++){const t=a[e];if(t.facetAttribute===o.dimension){let e=false;for(let a=0,r=o.items.length;a<r;a++){const r=o.items[a];if(t.filterCondition.equals(r.filterCondition)){r.selected=true;e=true}}if(!e){o.items.splice(o.items.length,0,t);if(t.filterCondition.userDefined){t.advanced=true}else{t.listed=true;t.value="";t.valueLabel=""}}else{t.listed=true}}}}return o}hasDialogFacetsFromMetaData(e){const t=e.getDataSource();const a=Object.values(t.attributeMetadataMap);let r=false;for(const e of a){if(e.usage){if(e.usage.Facet||e.usage.AdvancedSearch){r=true;break}}}return r}handleDataSourceChanged(){this.hierarchyDynamicFacetsFormatter.handleDataSourceChanged();this.hierarchyStaticFacetsFormatter.handleDataSourceChanged()}destroy(){this.hierarchyDynamicFacetsFormatter.destroy();this.hierarchyDynamicFacetsFormatter=null;this.hierarchyStaticFacetsFormatter.destroy();this.hierarchyStaticFacetsFormatter=null}}return F});
//# sourceMappingURL=SearchFacetsFormatter.js.map