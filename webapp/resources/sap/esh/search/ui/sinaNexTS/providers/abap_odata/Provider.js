/*!
 * SAPUI5
 * Copyright (c) 2025 SAP SE or an SAP affiliate company. All rights reserved.
 * 
 */
sap.ui.define(["./ajax","./ajaxTemplates","./conditionSerializer","../../core/core","./dataSourceSerializer","./labelCalculation","./suggestionTermSplitter","../AbstractProvider","./FacetParser","./ItemParser","./suggestionParser","./MetadataParser","../../core/errors","./nlqParser","../../sina/SuggestionType","../tools/util"],function(e,t,r,s,i,n,a,o,u,l,c,d,h,S,f,p){"use strict";function g(e){return new Promise(function(t,r){sap.ui.require([e],function(r){if(!(r&&r.__esModule)){r=r===null||!(typeof r==="object"&&e.endsWith("/library"))?{default:r}:r;Object.defineProperty(r,"__esModule",{value:true})}t(r)},function(e){r(e)})})}const y=e["createAjaxClient"];const m=o["AbstractProvider"];const b=u["FacetParser"];const P=l["ItemParser"];const C=c["SuggestionParser"];const v=d["MetadataParser"];const O=h["ESHNotActiveError"];const E=h["NotImplementedError"];const N=S["parseNlqInfo"];const Q=f["SuggestionType"];const x=p["handleError"];class T extends m{id="abap_odata";contentProviderId;requestPrefix;ajaxClient;metadataLoadPromises;internalMetadata;labelCalculator;metadataParser;itemParser;facetParser;suggestionParser;sessionId;sorsNavigationTargetGenerator;serviceXML;async initAsync(e){this.contentProviderId=e.contentProviderId;this.requestPrefix=e.url||"/sap/opu/odata/sap/ESH_SEARCH_SRV";this.sina=e.sina;this.ajaxClient=e.ajaxClient??y();this.metadataLoadPromises={};this.internalMetadata={};this.labelCalculator=n.createLabelCalculator();this.metadataParser=new v(this);this.itemParser=new P(this);this.facetParser=new b(this);this.suggestionParser=new C(this,this.itemParser);this.sessionId=s.generateGuid();this.sorsNavigationTargetGenerator=this.sina._createSorsNavigationTargetGenerator({urlPrefix:"#Action-search&/top=10&filter=",getPropertyMetadata(e){return{name:e.id,label:e.label,semanticObjectType:e._private.semanticObjectType,response:!!(e.usage&&(e.usage.Detail||e.usage.Title)),request:true}}});const t=await this.loadServerInfo();this.serverInfo=t.d.results[0];if(!this.supports("Search")){throw new O}await this.loadBusinessObjectDataSources();return{capabilities:this.sina._createCapabilities({fuzzy:false,nlq:this.supports("Search","NLSSearch"),nlqEnabledInfoOnDataSource:this.supports("misc","DataSourceIsNLSEnabled")})}}supports(e,t){if(e==="misc"){let e="";if(t==="InteractionEventLists"){e="Schema[Namespace=ESH_SEARCH_SRV]>EntityContainer[Name=ESH_SEARCH_SRV_Entities]>EntitySet[Name=InteractionEventLists]"}if(t==="NavigationEvents"){e="Schema[Namespace=ESH_SEARCH_SRV]>EntityContainer[Name=ESH_SEARCH_SRV_Entities]>EntitySet[Name=NavigationEvents]"}if(t==="DataSourceIsNLSEnabled"){e="Schema[Namespace=ESH_SEARCH_SRV]>EntityType[Name=DataSource]>Property[Name=IsNLSEnabled]"}if(e.length!==0){const t=this.querySelectorAll(e);return t.length>0}}for(let r=0;r<this.serverInfo.Services.results.length;++r){const s=this.serverInfo.Services.results[r];if(s.Id==e){if(!t){return true}for(let e=0;e<s.Capabilities.results.length;++e){const r=s.Capabilities.results[e];if(r.Id===t){return true}}}}return false}loadServerInfo(){const e=this.buildQueryUrl(this.requestPrefix,"/ServerInfos?$expand=Services/Capabilities");const t=this.buildQueryUrl(this.requestPrefix,"/$metadata");const r=this.ajaxClient.getJson(e);const i=this.ajaxClient.getXML(t);return Promise.all([r,i]).then(async e=>{const t=e[0];const r=e[1];if(s.isBrowserEnv()){const e=new DOMParser;const t=e.parseFromString(r,"text/xml");if(t.documentElement.nodeName!="parsererror"){this.serviceXML=t}}else{const e=await g("jsdom");const t=new e.JSDOM(r);this.serviceXML=t.window.document}return t.data})}loadBusinessObjectDataSources(){let e="/DataSources?$expand=Annotations,Attributes/UIAreas,Attributes/Annotations&$filter=Type eq 'View'";if(this.serviceXML){if(!this.isCDSAnnotationSupported()){e="/DataSources?$expand=Attributes/UIAreas&$filter=Type eq 'View'"}const t="Schema[Namespace=ESH_SEARCH_SRV]>EntityType[Name=DataSource]>Property[Name=IsInternal]";if(this.isQueryPropertySupported(t)){e=e+" and IsInternal eq false"}}const t=this.buildQueryUrl(this.requestPrefix,e);return this.ajaxClient.getJson(t).then(function(e){const t=e.data.d.results;this.metadataParser.parseDataSourceData(t,this.sorsNavigationTargetGenerator);this.sorsNavigationTargetGenerator.finishRegistration()}.bind(this))}isCDSAnnotationSupported(){if(!this.serviceXML){return false}const e="Schema[Namespace='ESH_SEARCH_SRV']>EntityType[Name='DataSource'][*|content-version='1']>NavigationProperty[Name='Annotations'],"+"Schema[Namespace='ESH_SEARCH_SRV']>EntityType[Name='DataSourceAttribute'][*|content-version='1']>NavigationProperty[Name='Annotations']";const t=this.querySelectorAll(e);if(t.length<2){return false}return true}assembleOrderBy(e){const t=[];for(let r=0;r<e.sortOrder.length;++r){const s=e.sortOrder[r];const i=s.order===this.sina.SortOrder.Descending?"desc":"asc";t.push({AttributeId:s.id,SortOrder:i})}return t}async executeSearchQuery(e){let s=t.searchRequest;const n="Schema[Namespace=ESH_SEARCH_SRV]>EntityType[Name=SearchOptions]>Property[Name=ClientServiceName]";if(!this.isQueryPropertySupported(n)){delete s.d.QueryOptions.ClientServiceName}s=JSON.parse(JSON.stringify(s));const a=e.filter.rootCondition.clone();const o=r.serialize(e.filter.dataSource,a);if(o.SubFilters.length!==0){s.d.Filter=o}else{delete s.d.Filter}s.d.DataSources=i.serialize(e.filter.dataSource);s.d.QueryOptions.SearchTerms=e.filter.searchTerm;s.d.QueryOptions.Top=e.top;s.d.QueryOptions.Skip=e.skip;s.d.OrderBy=this.assembleOrderBy(e);this.addSessionId(s);if(!e.calculateFacets){delete s.d.MaxFacetValues;delete s.d.Facets}else{s.d.MaxFacetValues=5;s.d.Facets=[{Values:[]}]}if(e.nlq){s.d.ActivateNLQ=true;s.d.ResultList.NLQQueries=[{NLQConnectorQueries:[]}]}const u=this.buildQueryUrl(this.requestPrefix,"/SearchQueries");return x(async()=>(await this.ajaxClient.postJson(u,s)).data,async t=>{this.metadataParser.parseDynamicMetadata(t.d);const r=await this.itemParser.parse(e,t.d);const s=await this.facetParser.parse(e,t.d);const i=N(this.sina,t.d?.ResultList?.NLQQueries?.results);const n=this.sina._createSearchResultSet({id:t.d.ResultList.ExecutionID,title:"Search Result List",query:e,items:r,totalCount:t.d.ResultList.TotalHits,facets:s,nlqResult:i});this.sorsNavigationTargetGenerator.generateNavigationTargets(n);return n})}executeChartQuery(e){let s="";let n;const a=e.filter.rootCondition.clone();let o;if(this.decideValueHelp(e)){n=JSON.parse(JSON.stringify(t.valueHelperRequest));this.removeClientOptions(n);n.d.ValueHelpAttribute=e.dimension;o=r.serialize(e.filter.dataSource,a);if(o.SubFilters.length!==0){n.d.Filter=o}else{delete n.d.Filter}n.d.ValueFilter=this.getFilterValueFromConditionTree(e.dimension,o);n.d.QueryOptions.SearchTerms=e.filter.searchTerm;n.d.DataSources=i.serialize(e.filter.dataSource);s=this.buildQueryUrl(this.requestPrefix,"/ValueHelpQueries")}else{n=JSON.parse(JSON.stringify(t.chartRequest));o=r.serialize(e.filter.dataSource,a);if(o.SubFilters.length!==0){n.d.Filter=o}else{delete n.d.Filter}n.d.DataSources=i.serialize(e.filter.dataSource);n.d.QueryOptions.SearchTerms=e.filter.searchTerm;n.d.QueryOptions.Skip=0;this.addSessionId(n);n.d.FacetRequests=[{DataSourceAttribute:e.dimension}];n.d.MaxFacetValues=e.top;s=this.buildQueryUrl(this.requestPrefix,"/SearchQueries");if(e.nlq){n.d.ActivateNLQ=true}}return this.ajaxClient.postJson(s,n).then(function(t){return this.facetParser.parse(e,t.data.d)}.bind(this)).then(function(t){if(t.length>0){return t[0]}return this.sina._createChartResultSet({title:e.filter.dataSource.getAttributeMetadata(e.dimension).label,items:[],query:e,facetTotalCount:undefined})}.bind(this))}executeHierarchyQuery(e){throw new E}decideValueHelp(e){const t=e.filter.rootCondition.conditions;for(let r=0;r<t.length;r++){if(e.filter._getAttribute(t[r])===e.dimension){return true}}return false}async executeSuggestionQuery(e){return Promise.all([this.executeRegularSuggestionQuery(e),this.executeObjectSuggestionQuery(e)]).then(function(t){const r=[];r.push(...t[1]);r.push(...t[0]);return this.sina._createSuggestionResultSet({title:"Suggestions",query:e,items:r})}.bind(this))}isObjectSuggestionQuery(e){return e.types.indexOf("Object")>=0&&e.filter.dataSource.type===e.sina.DataSourceType.BusinessObject}executeObjectSuggestionQuery(e){if(!this.supports("ObjectSuggestions")||!this.isObjectSuggestionQuery(e)){return Promise.resolve([])}const s=JSON.parse(JSON.stringify(t.objectSuggestionRequest));const n=e.filter.rootCondition.clone();const a=r.serialize(e.filter.dataSource,n);if(a.SubFilters.length!==0){s.d.Filter=a}else{delete s.d.Filter}s.d.DataSources=i.serialize(e.filter.dataSource);s.d.QueryOptions.Top=e.top;s.d.QueryOptions.Skip=e.skip;s.d.QueryOptions.SearchTerms=e.filter.searchTerm;this.addSessionId(s);if(e.nlq){s.d.ActivateNLQ=true}const o=this.buildQueryUrl(this.requestPrefix,"/SuggestionsQueries");return this.ajaxClient.postJson(o,s).then(t=>this.suggestionParser.parseObjectSuggestions(e,t.data))}executeRegularSuggestionQuery(e){if(e.types.indexOf(Q.SearchTermAI)>=0){return[]}const s=JSON.parse(JSON.stringify(t.suggestionRequest));const n=e.filter.searchTerm;const o=a.split(n);const u=e.filter.rootCondition.clone();const l=r.serialize(e.filter.dataSource,u);if(l.SubFilters.length!==0){s.d.Filter=l}else{delete s.d.Filter}s.d.DataSources=i.serialize(e.filter.dataSource);s.d.QueryOptions.Top=e.top;s.d.QueryOptions.Skip=e.skip;s.d.SuggestionInput=o.suggestionTerm;s.d.QueryOptions.SearchTerms=o.searchTerm===null?"":o.searchTerm;if(!this.includeSuggestionTypes(e,s)){return[]}this.addSessionId(s);if(e.nlq){s.d.ActivateNLQ=true}const c=this.buildQueryUrl(this.requestPrefix,"/SuggestionsQueries");return this.ajaxClient.postJson(c,s).then(t=>this.suggestionParser.parseRegularSuggestions(e,t.data)).then(e=>{a.concatenate(o,e);return e})}includeSuggestionTypes(e,t){const r={SearchTerm:{Data:"IncludeAttributeSuggestions",History:"IncludeHistorySuggestions"},Object:{},DataSource:{Data:"IncludeDataSourceSuggestions"}};const s=e.types;const i=e.calculationModes;let n=false;for(let e=0;e<s.length;e++){const a=s[e];for(let e=0;e<i.length;e++){const s=i[e];const o=r[a][s];if(typeof o==="undefined"){continue}t.d[o]=true;n=true}}return n}addSessionId(e){e.d.QueryOptions.ClientSessionID=this.sessionId;const t=(new Date).getTime();e.d.QueryOptions.ClientCallTimestamp="\\/Date("+t+")\\/"}removeClientOptions(e){delete e.d.QueryOptions.ClientSessionID;delete e.d.QueryOptions.ClientCallTimestamp;delete e.d.QueryOptions.ClientServiceName;delete e.d.QueryOptions.ClientLastExecutionID}getFilterValueFromConditionTree(e,t){if(t.ConditionAttribute&&t.ConditionAttribute===e){return t.ConditionValue}else if(t.SubFilters){let r;let s=null;for(r=0;s===null&&r<t.SubFilters.length;r++){s=this.getFilterValueFromConditionTree(e,t.SubFilters[r])}return s}return null}getConfigurationAsync(){let e=this.buildQueryUrl(this.requestPrefix,"/PersonalizedSearchMainSwitches?$filter=Selected eq true");return this.ajaxClient.getJson(e).then(t=>{const r={personalizedSearch:false,isPersonalizedSearchEditable:false};const s=t.data;switch(s.d.results[0].MainSwitch){case 3:r.isPersonalizedSearchEditable=true;break;case 4:r.isPersonalizedSearchEditable=true;break;case 2:r.isPersonalizedSearchEditable=false;break;case 1:r.isPersonalizedSearchEditable=false;break}e=this.buildQueryUrl(this.requestPrefix,"/Users('<current>')");return this.ajaxClient.getJson(e).then(function(e){if(e.data.d.IsEnabledForPersonalizedSearch){r.personalizedSearch=true}return this.sina._createConfiguration(r)}.bind(this))})}saveConfigurationAsync(e){const t={IsEnabledForPersonalizedSearch:e.personalizedSearch};const r=this.buildQueryUrl(this.requestPrefix,"/Users('<current>')");return this.ajaxClient.mergeJson(r,t)}resetPersonalizedSearchDataAsync(){const e={ClearPersonalizedSearchHistory:true};const t=this.buildQueryUrl(this.requestPrefix,"/Users('<current>')");return this.ajaxClient.mergeJson(t,e)}buildQueryUrl(e,t){if(typeof window==="undefined"){return e+t}const r=window.location.href;let s="";let i;let n="";let a="";i=r.indexOf("esh-system=sid(");if(i!==-1){const e=r.substring(i).indexOf(")");if(e!==-1){n=r.substring(i+15,i+e);if(n.length!==0){a=";o=sid("+n+")"}}}if(n.length===0){i=r.indexOf("esh-system=");if(i!==-1){const e=r.substring(i).indexOf("&");const t=r.substring(i).indexOf("#");if(e!==-1&&t!==-1){if(e<t){n=r.substring(i+11,i+e)}else{n=r.substring(i+11,i+t)}}if(e!==-1&&t===-1){n=r.substring(i+11,i+e)}if(e===-1&&t!==-1){n=r.substring(i+11,i+t)}if(e===-1&&t===-1){n=r.substring(i+11)}}if(n.length!==0){a=";o="+n}}s=e+a+t;return s}getDebugInfo(){return`Searchsystem: ${this.serverInfo.SystemId} Client: ${this.serverInfo.Client} ESH Search API Provider: ${this.id}`}isQueryPropertySupported(e){if(this.serviceXML===undefined){return false}const t=this.querySelectorAll(e);if(t.length>0){return true}return false}transformPathToJsDomPath(e){function t(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function r(e,r,s){return e.replace(new RegExp(t(r),"g"),s)}const s=[["Schema","schema"],["EntityType","entitytype"],["EntityContainer","entitycontainer"],["EntitySet","EntitySet"],["NavigationProperty","navigationproperty"],["Property","property"],[">"," "],["content-version","sap:\\content-version"]];for(const t of s){const[s,i]=t;e=r(e,s,i)}return e}querySelectorAll(e){if(this.serviceXML===undefined){return undefined}if(!s.isBrowserEnv()){e=this.transformPathToJsDomPath(e)}return this.serviceXML.querySelectorAll(e)}}var I={__esModule:true};I.Provider=T;return I});
//# sourceMappingURL=Provider.js.map