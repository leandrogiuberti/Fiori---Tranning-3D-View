/*!
 * SAPUI5
 * Copyright (c) 2025 SAP SE or an SAP affiliate company. All rights reserved.
 * 
 */
sap.ui.define(["../../../sina/SinaObject","../../../sina/AttributeGroupTextArrangement","../../../sina/AttributeType","../../../sina/AttributeFormatType","../../../sina/AttributeSemanticsType","../../../core/Log"],function(t,e,i,s,r,a){"use strict";const n=t["SinaObject"];const o=e["AttributeGroupTextArrangement"];const u=i["AttributeType"];const d=s["AttributeFormatType"];const p=r["AttributeSemanticsType"];const A=a["Log"];class _ extends n{_datasource;_cdsAnnotations;_parsedAttributes;_knownAttributeGroups;_knownAttributeGroupsArray;_attributeGroupReplacements;_AttributeUsagePrio;_detailUsageStubsMap;_detailUsageStubsPrioHigh;_detailUsageStubsPrioMedium;_detailUsageStubsPrioNone;_defaultTextArrangement;_parsingResult;log=new A("hana odata cds annotations parser");constructor(t){super(t);this._datasource=t.dataSource;this._cdsAnnotations=t.cdsAnnotations;this._parsedAttributes={};this._knownAttributeGroups={};this._knownAttributeGroupsArray=[];this._attributeGroupReplacements={};this._AttributeUsagePrio={HIGH:"HIGH",MEDIUM:"MEDIUM",NONE:"NONE"};this._detailUsageStubsMap={};this._detailUsageStubsPrioHigh=[];this._detailUsageStubsPrioMedium=[];this._detailUsageStubsPrioNone=[];this._defaultTextArrangement=o.TextLast}parseCDSAnnotationsForDataSource(){this._parsingResult={dataSourceIsCdsBased:false,detailAttributesAreSorted:false,titleAttributesAreSorted:false};this._parseDefaultTextArrangement();this._parseAttributeAnnotations();this._parseDataSourceAnnotations();return this._parsingResult}_addDetailUsageStub(t,e,i){let s;if(typeof t==="string"){s=t;t=undefined}else{s=t.id}const r={attribute:t,displayOrder:e,prio:i,obsolete:false};this._detailUsageStubsMap[s]=r;if(i===this._AttributeUsagePrio.HIGH){this._detailUsageStubsPrioHigh.push(r)}else if(i===this._AttributeUsagePrio.MEDIUM){this._detailUsageStubsPrioMedium.push(r)}else{this._detailUsageStubsPrioNone.push(r)}}_getDetailUsageStub(t){if(!t){return undefined}let e;if(typeof t==="string"){e=t}else{e=t.id}return this._detailUsageStubsMap[e]}_setParsedAttribute(t,e){this._parsedAttributes[t.toUpperCase()]=e}_getParsedAttribute(t){return this._parsedAttributes[t.toUpperCase()]}_setknownAttributeGroup(t,e){this._knownAttributeGroups[t.toUpperCase()]=e}_getknownAttributeGroup(t){return this._knownAttributeGroups[t.toUpperCase()]}_parseDefaultTextArrangement(){try{const t=this._deriveTextArrangementFromCdsAnnotation(this._cdsAnnotations.dataSourceAnnotations.UI&&this._cdsAnnotations.dataSourceAnnotations.UI.TEXTARRANGEMENT);this._defaultTextArrangement=t||this._defaultTextArrangement}catch(t){this.log.warn("Could not parse default text arrangement for datasource: "+t)}}_parseDataSourceAnnotations(){if(Object.keys(this._cdsAnnotations.dataSourceAnnotations).length>0){try{const t=this._cdsAnnotations.dataSourceAnnotations.UI;const e=t&&t.HEADERINFO;const i=e&&e.TITLE;let s,r,a;if(i){s=i.TYPE&&i.TYPE.toUpperCase();if(s==="AS_CONNECTED_FIELDS"){r=i.VALUEQUALIFIER;if(r&&r.trim().length>0){a=this._getknownAttributeGroup(r);if(a){a.usage.Title={displayOrder:1}}}}else if(!s){const t=i.VALUE;if(t){const e=this._getParsedAttribute(t);if(e){e.usage.Title={displayOrder:1}}}}const t=i.URL;if(t){const e=this._getParsedAttribute(t);if(e){e.usage.Navigation={mainNavigation:true}}}}const n=e&&e.DESCRIPTION;if(n){s=n.TYPE;if(s==="AS_CONNECTED_FIELDS"){r=n.VALUEQUALIFIER;if(r&&r.trim().length>0){a=this._getknownAttributeGroup(r);if(a){a.usage.TitleDescription={displayOrder:1}}}}else if(!s){const t=n.VALUE;if(t){const e=this._getParsedAttribute(t);if(e){e.usage.TitleDescription={}}}}}const o=e&&e.IMAGEURL;if(o){const t=this._getParsedAttribute(o);if(t){t.usage.Title={};t.type=this.sina.AttributeType.ImageUrl}}}catch(t){this.log.warn("Could not parse attribute for datasource: "+t)}}}_parseAttributeAnnotations(){for(const t in this._datasource.attributeMetadataMap){this._parseSingleAttribute(t)}this._datasource.attributesMetadata=this._datasource.attributesMetadata.concat(this._knownAttributeGroupsArray);this._datasource.attributeMetadataMap=Object.assign(this._datasource.attributeMetadataMap,this._knownAttributeGroups);this._sortAttributes()}_parseSingleAttribute(t){let e=this._getParsedAttribute(t);if(!e){e=this._getPropertyFromObject(this._datasource.attributeMetadataMap,t);if(e&&e.id){this._setParsedAttribute(e.id,e);const t=this._cdsAnnotations.attributeAnnotations[e.id];if(typeof t==="object"&&Object.keys(t).length>0){this._parsingResult.dataSourceIsCdsBased=true;try{if(t.UI!==undefined){this._parseSingleAnnotationOrArray(e,t.UI.IDENTIFICATION,this._parseIdentification);this._parseSingleAnnotationOrArray(e,t.UI.CONNECTEDFIELDS,this._parseConnectedFields);this._parseURLsForDocumentResultItemThumbnail(e,t.UI.IDENTIFICATION,t.SEMANTICS);if(t.UI.MULTILINETEXT!==undefined){e.format=d.MultilineText}}this._parseSemantics(e,t.SEMANTICS);this._parseDescriptionAttribute(e,t.OBJECTMODEL,t.UI)}catch(t){this.log.warn("Could not parse attribute for datasource: "+t)}}}}return e}_parseConnectedFields(t,e){const i=e.QUALIFIER;if(i){const s={};if(e.NAME){s[e.NAME]=t}this._createAttributeGroup(i,e.GROUPLABEL,e.TEMPLATE,s)}}_createAttributeGroup(t,e,i,s,r){let a=this._getknownAttributeGroup(t);if(!a){a=this.sina._createAttributeGroupMetadata({id:t,label:e||"",type:u.Group,template:i||"",attributes:[],usage:{},displayAttributes:r||[]});this._setknownAttributeGroup(t,a);this._knownAttributeGroupsArray.push(a);this._datasource.attributeGroupsMetadata.push(a);this._datasource.attributeGroupMetadataMap[t]=a;const s=this._getDetailUsageStub(t);if(s){s.attribute=a}}else{if(e&&!a.label){a.label=e}if(i&&!a.template){a.template=i}if(r&&!a.displayAttributes){a.displayAttributes=r}}if(s){for(const t in s){const e=s[t];const i=this.sina._createAttributeGroupMembership({group:a,attribute:e,nameInGroup:t});a.attributes.push(i);e.groups.push(i)}}return a}_parseIdentification(t,e){this._parseAttributePositions(t,e);this._parseIconUrlAttributeName(t,e)}_parseIconUrlAttributeName(t,e){if(e){if(Array.isArray(e)){for(let i=0;i<e.length;i++){if(e[i].ICONURL){t.iconUrlAttibuteName=e[i].ICONURL;break}}}else if(e.ICONURL){t.iconUrlAttributeName=e.ICONURL}}}_parseAttributePositions(t,e){const i=e.IMPORTANCE&&e.IMPORTANCE.toUpperCase();let s=e.POSITION;if(i&&!s){s=Number.MAX_VALUE}if(s!==undefined){switch(i){case"HIGH":case"MEDIUM":case undefined:{s=this._parsePosition(s);const r=e.TYPE&&e.TYPE.toUpperCase();switch(r){case"AS_CONNECTED_FIELDS":{const i=e.VALUEQUALIFIER;if(i){const e=this._getknownAttributeGroup(i);if(e){t=e}else{t=i}}}case undefined:{const e=this._getDetailUsageStub(t);if(e){if(!e.attribute&&typeof t!=="string"){e.attribute=t}}else{let e;if(i==="HIGH"){e=this._AttributeUsagePrio.HIGH}else if(i==="MEDIUM"){e=this._AttributeUsagePrio.MEDIUM}else{e=this._AttributeUsagePrio.NONE}this._addDetailUsageStub(t,s,e)}}}}}}}_parseURLsForDocumentResultItemThumbnail(t,e,i){if(!(i&&i.IMAGEURL)){return}let s;if(e){if(Array.isArray(e)){for(let t=0;t<e.length;t++){if(e[t].URL){s=e[t].URL;break}}}else{s=e.URL}}if(s&&i&&i.IMAGEURL){const e=this._getPropertyFromObject(this._cdsAnnotations.attributeAnnotations,s);if(e){const i=e.SEMANTICS&&e.SEMANTICS.URL&&e.SEMANTICS.URL.MIMETYPE;if(i){const e=this._getPropertyFromObject(this._datasource.attributeMetadataMap,s);const r=this._getPropertyFromObject(this._datasource.attributeMetadataMap,i);t.suvUrlAttribute=e;t.suvMimeTypeAttribute=r;t.format=d.DocumentThumbnail}}}}_parseSemantics(t,e){if(e){if(e.CONTACT&&e.CONTACT.PHOTO!==undefined){t.format=d.Round;if(t.type!==u.ImageBlob){t.type=u.ImageUrl}}if(e.IMAGEURL!==undefined){if(t.type!==u.ImageBlob){t.type=u.ImageUrl}}if(e.NAME!==undefined){if(e.NAME.GIVENNAME!==undefined){t.semantics=p.FirstName}if(e.NAME.FAMILYNAME!==undefined){t.semantics=p.LastName}}if(e.EMAIL&&e.EMAIL.ADDRESS!==undefined){t.semantics=p.EmailAddress}if(e.TELEPHONE&&e.TELEPHONE.TYPE!==undefined){t.semantics=p.PhoneNr}if(e&&e.URL!==undefined){t.semantics=p.HTTPURL}if(e&&e.CURRENCYCODE!==undefined){t._private.isCurrency=true}if(e&&e.UNITOFMEASURE!==undefined){t._private.isUnitOfMeasure=true}let i,s,r;let a;const n=e.QUANTITY&&e.QUANTITY.UNITOFMEASURE;if(n){a=[];t._private.isQuantity=true;i=this._parseSingleAttribute(n);if(i){if(i._private.isUnitOfMeasure){r="{"+t.id+"} {"+i.id+"}";a.push(t.id);a.push(i.id);this._createAttributeGroupForParentChildAttributes(t,i,"____UnitOfMeasureGroup",r,a)}}}const o=e.AMOUNT&&e.AMOUNT.CURRENCYCODE;if(o){a=[];s=this._parseSingleAttribute(o);if(s){if(s._private.isCurrency){r="{"+t.id+"} {"+s.id+"}";a.push(t.id);a.push(s.id);this._createAttributeGroupForParentChildAttributes(t,s,"____CurrencyGroup",r,a)}}}}}_parseDescriptionAttribute(t,e,i){let s=e&&e.TEXT&&e.TEXT.ELEMENT;if(s){if(Array.isArray(s)){if(s.length>0){s=s[0]}else{return}}const e=this._parseSingleAttribute(s);if(e){const s=this._deriveTextArrangementFromCdsAnnotation(i&&i.TEXTARRANGEMENT)||this._defaultTextArrangement;const r=!(t.semantics==p.FirstName&&e.semantics==p.LastName||e.semantics==p.FirstName&&t.semantics==p.LastName);const a=r?"(":"";const n=r?")":"";let u;if(s===o.TextFirst){u="{"+e.id+"} "+a+"{"+t.id+"}"+n}else if(s===o.TextLast){u="{"+t.id+"} "+a+"{"+e.id+"}"+n}else if(s===o.TextOnly){u="{"+e.id+"}"}else{u="{"+t.id+"} "+a+"{"+e.id+"}"+n}const d=[];if(s===o.TextOnly){d.push(e.id)}else{d.push(t.id);d.push(e.id)}const A=this._createAttributeGroupForParentChildAttributes(t,e,"____Description",u,d);A._private.isDescription=true;A._private.textArrangement=s;if(t._private.isUnitOfMeasure||e._private.isUnitOfMeasure){A._private.isUnitOfMeasure=true}if(t._private.isCurrency||e._private.isCurrency){A._private.isCurrency=true}}}}_deriveTextArrangementFromCdsAnnotation(t){if(t){switch(t.toUpperCase()){case"TEXT_FIRST":return o.TextFirst;case"TEXT_LAST":return o.TextLast;case"TEXT_ONLY":case"#TEXT_ONLY":return o.TextOnly;case"TEXT_SEPARATE":return o.TextSeparate}}return undefined}_createAttributeGroupForParentChildAttributes(t,e,i,s,r){const a=t.id+i;const n={};n[t.id]=t;n[e.id]=e;const o=this._createAttributeGroup(a,t.label,s,n,r);const u=this._getDetailUsageStub(t);if(u){u.obsolete=true;this._addDetailUsageStub(o,u.displayOrder,u.prio)}this._replaceAttributeWithGroup(t,o);o._private.parentAttribute=t;o._private.childAttribute=e;if(e._private&&e._private.isCurrency){o._private.isCurrency=true}if(e._private&&e._private.isUnitOfMeasure){o._private.isUnitOfMeasure=true}return o}_replaceAttributeWithGroup(t,e){this._setParsedAttribute(t.id,e);for(let i=0;i<t.groups.length;i++){const s=t.groups[i];if(s.group!=e){s.attribute=e}}}_sortAttributes(){const t=function(t,e){if(t.displayOrder<e.displayOrder){return-1}else if(t.displayOrder>e.displayOrder){return 1}return 0};let e,i;if(this._detailUsageStubsPrioHigh.length>0||this._detailUsageStubsPrioMedium.length>0){this._detailUsageStubsPrioHigh.sort(t);this._detailUsageStubsPrioMedium.sort(t);const s=this._detailUsageStubsPrioHigh.concat(this._detailUsageStubsPrioMedium);for(e=0;e<s.length;e++){if(!s[e].obsolete){i=s;break}}}if(!i){i=this._detailUsageStubsPrioNone.sort(t)}for(e=0;e<i.length;e++){const t=i[e];if(!t.obsolete&&t.attribute&&typeof t.attribute!=="string"){t.attribute.usage=t.attribute.usage||{};t.attribute.usage.Detail={displayOrder:e}}}this._parsingResult.detailAttributesAreSorted=true}_parseSingleAnnotationOrArray(t,e,i){if(e!==undefined){if(Array.isArray(e)){for(let s=0;s<e.length;s++){i.apply(this,[t,e[s]])}}else{i.apply(this,[t,e])}}}_parsePosition(t){if(typeof t==="string"){try{t=parseInt(t,10)}catch(e){this.log.warn("Could not parse position as integer: "+t+" ("+e+")");t=Number.MAX_VALUE}}if(typeof t!=="number"||isNaN(t)){t=Number.MAX_VALUE}return t}_getPropertyFromObject(t,e){if(t[e]){return t[e]}e=e.toLowerCase();for(const i in t){if(i.toLowerCase()===e){return t[i]}}return undefined}}var c={__esModule:true};c.CDSAnnotationsParser=_;return c});
//# sourceMappingURL=CDSAnnotationsParser.js.map