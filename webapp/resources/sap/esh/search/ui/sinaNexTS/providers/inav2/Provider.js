/*!
 * SAPUI5
 * Copyright (c) 2025 SAP SE or an SAP affiliate company. All rights reserved.
 * 
 */
sap.ui.define(["../AbstractProvider","../../core/core","./conditionSerializer","./dataSourceSerializer","../../core/util","../../core/lang","./ajaxTemplates","./labelCalculation","./pivotTableParser","./suggestionParser","./suggestionTermSplitter","./MetadataParser","./ItemParser","./FacetParser","../../sina/AttributeType","../../core/errors","./ajax"],function(e,t,a,s,r,i,n,o,u,c,l,d,h,S,p,f,g){"use strict";const m=e["AbstractProvider"];const R=d["MetadataParser"];const b=h["ItemParser"];const P=S["FacetParser"];const C=p["AttributeType"];const D=f["ESHNotActiveError"];const q=f["NotImplementedError"];const y=g["createAjaxClient"];class I extends m{id="inav2";urlPrefix;getServerInfoUrl;getResponseUrl;ajaxClient;metadataLoadPromises;internalMetadata;labelCalculator;metadataParser;itemParser;facetParser;sessionId;initAsync(e){this.urlPrefix=e.url||"/sap/es/ina";this.getServerInfoUrl=this.urlPrefix+"/GetServerInfo";this.getResponseUrl=this.urlPrefix+"/GetResponse";this.sina=e.sina;this.ajaxClient=e.ajaxClient??y({getLanguage:typeof e.getLanguage==="function"?e.getLanguage:undefined});this.metadataLoadPromises={};this.internalMetadata={};this.labelCalculator=o.createLabelCalculator();this.metadataParser=new R(this);this.itemParser=new b(this);this.facetParser=new P(this);this.executeSearchQuery=this.addMetadataLoadDecorator(this.executeSearchQuery);this.executeChartQuery=this.addMetadataLoadDecorator(this.executeChartQuery);this.executeSuggestionQuery=this.addMetadataLoadDecorator(this.executeSuggestionQuery);this.sessionId=t.generateGuid();return this.loadServerInfo().then(e=>{this.serverInfo=e;if(!this.supports("Search")){return Promise.reject(new D)}return this.loadBusinessObjectDataSources()}).then(()=>({capabilities:this.sina._createCapabilities({fuzzy:this.supports("Search","OptionFuzzy")})}))}addMetadataLoadDecorator(e){return function(...t){const a=t[0];const s=a.filter.dataSource;return Promise.resolve().then(function(){return this.loadMetadata(s)}.bind(this)).then(function(){return e.apply(this,t)}.bind(this))}.bind(this)}loadMetadata(e){if(e.type===this.sina.DataSourceType.Category){return Promise.resolve()}let t=this.metadataLoadPromises[e.id];if(t){return t}n.loadDataSourceMetadataRequest.DataSource.ObjectName=e.id;this.addLanguagePreferences(n.loadDataSourceMetadataRequest);t=this.ajaxClient.postJson(this.getResponseUrl,n.loadDataSourceMetadataRequest).then(function(t){this.metadataParser.parseMetadataRequestMetadata(e,t.data)}.bind(this));this.metadataLoadPromises[e.id]=t;return t}supports(e,t){for(let a=0;a<this.serverInfo.Services.length;++a){const s=this.serverInfo.Services[a];if(s.Service==e){if(!t){return true}for(let e=0;e<s.Capabilities.length;++e){const a=s.Capabilities[e];if(a.Capability===t){return true}}}}return false}loadServerInfo(){return this.ajaxClient.getJson(this.getServerInfoUrl).then(function(e){return e.data})}loadBusinessObjectDataSources(){const e=this;e.addLanguagePreferences(n.loadDataSourcesRequest);if(e.supports("Search","PluralDescriptionForDataSource")){n.loadDataSourcesRequest.Search.NamedValues.push({AttributeName:"DescriptionPlural",Name:"DescriptionPlural"})}return e.ajaxClient.postJson(e.getResponseUrl,n.loadDataSourcesRequest).then(function(t){e._processDataSourcesResponse(t,false)},function(){const t=e.serverInfo.ServerInfo.SystemId+e.serverInfo.ServerInfo.Client+"~ESH_CONNECTOR~";n.fallbackLoadDataSourcesRequest.DataSource.ObjectName=t;return e.ajaxClient.postJson(e.getResponseUrl,n.fallbackLoadDataSourcesRequest).then(function(t){e._processDataSourcesResponse(t,true)})})}_processDataSourcesResponse(e,a){const s=u.parse(e.data);const r=s.axes[0];for(let e=0;e<r.length;++e){const s=r[e];let i="";let n="";let o="";if(!a){if(t.isObject(s.Description)){i=s.Description.Value}else{i=s.Description}if(t.isObject(s.DescriptionPlural)){n=s.DescriptionPlural.Value}else{n=s.DescriptionPlural}if(t.isObject(s.ObjectName)){o=s.ObjectName.Value}else{o=s.ObjectName}}else{s.$$ResultItemAttributes$$.forEach(function(e){if(e.Name==="DESCRIPTION"){i=e.Value}if(e.Name==="DESCRIPTION_PLURAL"){n=e.Value}if(e.Name==="OBJECT_NAME"){o=e.Value}})}if(!i){i=o}if(!n){n=i}const u=this.sina._createDataSource({id:o,label:i,labelPlural:n,type:this.sina.DataSourceType.BusinessObject});this.labelCalculator.calculateLabel(u)}}getInternalMetadataAttributes(e){const t=[];const a=this.internalMetadata[e.id];if(!a){return t}for(const e in a.data){t.push(a.data[e])}return t}getInternalMetadataAttribute(e,t){return this.internalMetadata[e.id].data[t]}getInternalMetadataLoadStatus(e){const t=this.internalMetadata[e.id];if(!t){return{}}return t.loadStatus}fillInternalMetadata(e,t,a){let s=this.internalMetadata[e.id];if(!s){s={loadStatus:{},data:{}};this.internalMetadata[e.id]=s}for(let e=0;e<a.length;++e){const t=a[e];let r=s.data[t.Name];if(!r){r={};s.data[t.Name]=r}for(const e in t){r[e]=t[e]}}s.loadStatus[t]=true}addTemplateConditions(e){e.addCondition({attribute:"$$RenderingTemplatePlatform$$",operator:this.sina.ComparisonOperator.Eq,value:"html"});e.addCondition({attribute:"$$RenderingTemplateTechnology$$",operator:this.sina.ComparisonOperator.Eq,value:"Tempo"});e.addCondition({attribute:"$$RenderingTemplateType$$",operator:this.sina.ComparisonOperator.Eq,value:"ResultItem"});e.addCondition({attribute:"$$RenderingTemplateType$$",operator:this.sina.ComparisonOperator.Eq,value:"ItemDetails"})}assembleOrderBy(e){const t=[];for(let a=0;a<e.sortOrder.length;++a){const s=e.sortOrder[a];const r=s.order===this.sina.SortOrder.Descending?"DESC":"ASC";t.push({AttributeName:s.id,SortOrder:r})}return t}executeSearchQuery(e){let t,r;const i=e.filter.rootCondition.clone();this.addTemplateConditions(i);n.searchRequest.Search.Filter=a.serialize(e.filter.dataSource,i);n.searchRequest.DataSource=s.serialize(e.filter.dataSource);n.searchRequest.Search.SearchTerms=e.filter.searchTerm;n.searchRequest.Search.Top=e.top;n.searchRequest.Search.Skip=e.skip;n.searchRequest.Options=this.assembleRequestOptions(e);n.searchRequest.Search.OrderBy=this.assembleOrderBy(e);n.searchRequest.Search.Expand=["Grid","Items","TotalCount"];this.addLanguagePreferences(n.searchRequest);this.addSessionId(n.searchRequest);if(e.calculateFacets){n.searchRequest.Search.Expand.push("ResultsetFacets")}return this.ajaxClient.postJson(this.getResponseUrl,n.searchRequest).then(function(t){r=t;return this.itemParser.parse(e,r.data)}.bind(this)).then(function(a){t=a;return this.facetParser.parse(e,r.data)}.bind(this)).then(function(a){return this.sina._createSearchResultSet({id:r.data.ExecutionID,title:"Search Result List",query:e,items:t.items,totalCount:t.totalCount,facets:a})}.bind(this))}executeChartQuery(e){const t=e.filter.rootCondition.clone();this.addTemplateConditions(t);n.chartRequest.Search.Filter=a.serialize(e.filter.dataSource,t);n.chartRequest.DataSource=s.serialize(e.filter.dataSource);n.chartRequest.Search.SearchTerms=e.filter.searchTerm;n.chartRequest.Search.Top=1;n.chartRequest.Search.Skip=0;n.chartRequest.Facets.Attributes=[e.dimension];n.chartRequest.Facets.MaxNumberOfReturnValues=e.top;n.chartRequest.Options=this.assembleRequestOptions(e);this.addLanguagePreferences(n.chartRequest);this.addSessionId(n.chartRequest);return this.ajaxClient.postJson(this.getResponseUrl,n.chartRequest).then(function(t){return this.facetParser.parse(e,t.data)}.bind(this)).then(function(t){if(t.length>0){return t[0]}return this.sina._createChartResultSet({title:e.filter.dataSource.getAttributeMetadata(e.dimension).label,items:[],query:e,facetTotalCount:undefined})}.bind(this))}executeHierarchyQuery(e){throw new q}async executeSuggestionQuery(e){const t=e.filter.searchTerm;const r=l.split(this,t);const i=e.filter.rootCondition.clone();if(r.searchTerm){i.addCondition(e.sina.createSimpleCondition({attribute:C.INAV2_SearchTerms,value:r.searchTerm}))}i.addCondition(e.sina.createSimpleCondition({attribute:C.INAV2_SuggestionTerms,value:r.suggestionTerm}));n.suggestionRequest.Suggestions2.Filter=a.serialize(e.filter.dataSource,i);n.suggestionRequest.DataSource=s.serialize(e.filter.dataSource);n.suggestionRequest.Options=this.assembleSuggestionOptions(e);if(n.suggestionRequest.Options.length===0){return this.sina._createSuggestionResultSet({title:"Suggestions",query:e,items:[]})}n.suggestionRequest.Suggestions2.Top=e.top;n.suggestionRequest.Suggestions2.Skip=e.skip;this.addLanguagePreferences(n.suggestionRequest);this.addSessionId(n.suggestionRequest);return this.ajaxClient.postJson(this.getResponseUrl,n.suggestionRequest).then(function(t){const a=c.parse(this,e,t.data);l.concatenate(this,r,a);return this.sina._createSuggestionResultSet({title:"Suggestions",query:e,items:a})}.bind(this))}addSessionId(e){if(!this.supports("Search","SessionHandling")){delete e.SessionID;delete e.SessionTimestamp;return}e.SessionID=this.sessionId;e.SessionTimestamp=parseInt(r.generateTimestamp(),10)}addLanguagePreferences(e){if(!this.supports("Search","LanguagePreferences")){delete e.LanguagePreferences;return}e.LanguagePreferences=i.getLanguagePreferences()}assembleSuggestionOptions(e){const t={SearchTerm:{Data:"SuggestObjectData",History:"SuggestSearchHistory"},Object:{},DataSource:{Data:"SuggestDataSources"}};if(!this.supports("Suggestions2","ScopeTypes")){delete t.SearchTerm.History;delete t.DataSource.Data}const a=[];const s=e.types;const r=e.calculationModes;for(let e=0;e<s.length;e++){const i=s[e];for(let e=0;e<r.length;e++){const s=r[e];const n=t[i][s];if(!n){continue}a.push(n)}}return a}assembleRequestOptions(e){const t=["SynchronousRun"];if(this.decideValueHelp(e)){t.push("ValueHelpMode")}return t}decideValueHelp(e){const t=e.filter.rootCondition.conditions;for(let a=0;a<t.length;a++){if(e.filter._getAttribute(t[a])===e["dimension"]){return true}}return false}async getConfigurationAsync(){if(!this.supports("PersonalizedSearch","SetUserStatus")){return Promise.resolve(this.sina._createConfiguration({personalizedSearch:false,isPersonalizedSearchEditable:false}))}return this.ajaxClient.postJson(this.getResponseUrl,n.getConfigurationRequest).then(function(e){const t={personalizedSearch:false,isPersonalizedSearchEditable:false};t.personalizedSearch=e.data.Data.PersonalizedSearch.SessionUserActive;switch(e.data.Data.PersonalizedSearch.PersonalizationPolicy){case"Opt-In":t.isPersonalizedSearchEditable=true;break;case"Opt-Out":t.isPersonalizedSearchEditable=true;break;case"Enforced":t.isPersonalizedSearchEditable=false;break;case"Disabled":t.isPersonalizedSearchEditable=false;break}return this.sina._createConfiguration(t)}.bind(this))}async saveConfigurationAsync(e){if(!this.supports("PersonalizedSearch","SetUserStatus")){return Promise.resolve()}n.saveConfigurationRequest.SearchConfiguration.Data.PersonalizedSearch.SessionUserActive=e.personalizedSearch;return this.ajaxClient.postJson(this.getResponseUrl,n.saveConfigurationRequest)}async resetPersonalizedSearchDataAsync(){if(!this.supports("PersonalizedSearch","ResetUserData")){return}await this.ajaxClient.postJson(this.getResponseUrl,n.resetPersonalizedSearchDataRequest)}getDebugInfo(){return`Searchsystem: ${this.serverInfo.ServerInfo.SystemId} Client: ${this.serverInfo.ServerInfo.Client} ESH API Provider: ${this.id}`}}var v={__esModule:true};v.Provider=I;return v});
//# sourceMappingURL=Provider.js.map