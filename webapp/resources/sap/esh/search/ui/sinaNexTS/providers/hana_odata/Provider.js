/*!
 * SAPUI5
 * Copyright (c) 2025 SAP SE or an SAP affiliate company. All rights reserved.
 * 
 */
sap.ui.define(["../../core/core","./MetadataParserXML","./MetadataParserJson","./ItemParser","./FacetParser","./suggestionParser","./eshObjects/src/index","./conditionSerializerEshObj","../../core/Log","../../sina/SearchQuery","../../sina/SortOrder","../AbstractProvider","../../sina/SuggestionType","../../sina/ComplexCondition","../../core/errors","./HierarchyParser","./HierarchyNodePathParser","../../sina/SuggestionCalculationMode","../../sina/DataSource","../hana_odata/ajax","../tools/util","./nlqParser"],function(e,t,r,s,a,i,o,n,c,u,l,h,g,f,d,y,S,p,m,b,P,C){"use strict";const x=t["MetadataParserXML"];const A=r["MetadataParserJson"];const T=s["ItemParser"];const v=a["FacetParser"];const q=i["SuggestionParser"];const w=o["getEshSearchQuery"];const F=o["Comparison"];const j=o["Phrase"];const D=o["Term"];const I=o["SearchQueryComparisonOperator"];const O=o["ESOrderType"];const E=o["HierarchyFacet"];const R=c["Log"];const Q=u["SearchQuery"];const M=l["SortOrder"];const _=h["AbstractProvider"];const N=g["SuggestionType"];const B=f["ComplexCondition"];const H=d["ESHNoBusinessObjectDatasourceError"];const L=d["ESHNotActiveError"];const $=d["InternalSinaError"];const U=y["HierarchyParser"];const k=S["HierarchyNodePathParser"];const z=p["SuggestionCalculationMode"];const J=m["DataSource"];const G=b["createAjaxClient"];const V=P["handleError"];const X=C["parseNlqInfo"];var Y=function(e){e["TITLE"]="TITLE";e["SUMMARY"]="SUMMARY";e["DETAIL"]="DETAIL";e["IMAGE"]="IMAGE";e["THUMBNAIL"]="THUMBNAIL";e["HIDDEN"]="HIDDEN";return e}(Y||{});class K extends _{id="hana_odata";ajaxClient;requestPrefix;metadataParser;itemParser;facetParser;suggestionParser;odataVersion;responseAttributes;facetAttributes;dataSourceConfigurations;metaDataSuffix;hierarchyNodePathParser;getTextFromResourceBundle;async initAsync(e){this.getTextFromResourceBundle=e.getTextFromResourceBundle;this.requestPrefix=e.url;this.odataVersion=e.odataVersion;this.responseAttributes=e?.responseAttributes;this.facetAttributes=e?.facetAttributes;this.sina=e.sina;this.dataSourceConfigurations=e?.dataSourceConfigurations||[];if(this.dataSourceConfigurations.length===0&&e.querySuffix){this.dataSourceConfigurations.push({id:"SEARCH_DESIGN",filterCondition:e.querySuffix})}this.metaDataSuffix=e.metaDataSuffix??"";this.ajaxClient=e.ajaxClient??G({getLanguage:typeof e.getLanguage==="function"?e.getLanguage:undefined,requestFormatters:e.ajaxRequestFormatters,responseFormatters:e.ajaxResponseFormatters});const t=e.metaDataJsonType;if(t){this.metadataParser=new A(this)}else{this.metadataParser=new x(this)}this.itemParser=new T(this);this.facetParser=new v(this);this.suggestionParser=new q(this);this.hierarchyNodePathParser=new k(this.sina);this.serverInfo=await this.loadServerInfo();if(!this.supports("Search")){throw new L}await this.loadBusinessObjectDataSources();if(this.sina.getBusinessObjectDataSources().length===0){return Promise.reject(new H)}return{capabilities:this.sina._createCapabilities({fuzzy:false,nlq:true})}}supports(e,t){const r=this.serverInfo.services;for(const s in r){if(s===e){if(!t){return true}const e=r[s].Capabilities;for(let r=0;r<e.length;++r){const s=e[r];if(s===t){return true}}}}return false}async loadServerInfo(){const e={rawServerInfo:{Services:[{Service:"Search",Capabilities:[{Capability:"SemanticObjectType"}]},{Service:"Suggestions2",Capabilities:[{Capability:"ScopeTypes"}]}]},services:{Suggestions:{suggestionTypes:["objectdata"]},Search:{capabilities:["SemanticObjectType"]}}};return e}_prepareMetadataRequest(){const e={metadataCall:true,resourcePath:this.getPrefix()+"/$metadata"};if(typeof this.metaDataSuffix==="string"&&this.metaDataSuffix.length>0){e.metadataObjects={entitySets:this.metaDataSuffix}}return this.assembleUrl(e)}async loadBusinessObjectDataSources(){const e=this._prepareMetadataRequest();const t=await this.metadataParser.fireRequest(this.ajaxClient,e);const r=await this.metadataParser.parseResponse(t);for(let e=0;e<r.dataSourcesList.length;++e){const t=r.dataSourcesList[e];this.metadataParser.fillMetadataBuffer(t,r.businessObjectMap[t.id])}}assembleOrderBy(e){const t=[];if(Array.isArray(e.sortOrder)){for(let r=0;r<e.sortOrder.length;++r){const s=e.sortOrder[r];const a=s.order===M.Descending?O.Descending:O.Ascending;t.push({key:s.id,order:a})}}return t}assembleGroupBy(e){const t=null;if(e.groupBy&&e.groupBy.attributeName&&e.groupBy.attributeName.length>0){t.properties=e.groupBy.attributeName;if(e.groupBy.aggregateCountAlias&&e.groupBy.aggregateCountAlias!==""){t.aggregateCountAlias=e.groupBy.aggregateCountAlias}}return t}executeSearchQuery(e){const t=this._prepareSearchObjectSuggestionRequest(e);return this.fireSearchQuery(t)}_prepareSearchObjectSuggestionRequest(e){const t=e.filter.rootCondition.clone();const r=n.serialize(e.filter.dataSource,t);if(!Array.isArray(r.items)){r.items=[]}const s=e.filter.searchTerm||"*";this.addFilterConditionToFilter(e,r,this.dataSourceConfigurations);const a=e.filter.dataSource;const i=e.top||10;const o=e.skip||0;const c=this.assembleOrderBy(e);const u={resourcePath:this.getPrefix()+"/$all",$top:i,$skip:o,whyfound:true,$count:true,$orderby:c,freeStyleText:s,searchQueryFilter:r};if(a!==this.sina.getAllDataSource()){u.scope=a.id}if(this.sina?.configuration?.useValueHierarchy===true&&i<100){let e=a.hierarchyAttribute;const t=a.getHierarchyDataSource();if(t instanceof J){e=t.hierarchyAttribute}if(e){u.valuehierarchy=e}}if(e instanceof Q){if(typeof this.responseAttributes!=="undefined"){u.$select=this.responseAttributes}if(e.calculateFacets){if(typeof this.facetAttributes!=="undefined"){u.facets=this.facetAttributes}else{u.facets=["all"]}u.facetlimit=e.facetTop||5}const t=this.assembleGroupBy(e);if(t){u.groupby=t;u.whyfound=false}}const l={url:this.assembleUrl(u,{nlq:e.nlq,doNotEsacpeFreeStyleText:this.sina?.configuration?.enableQueryLanguage}),query:e};return l}async fireSearchQuery(e){return await V(async()=>(await this.ajaxClient.getJson(e.url))?.data,async t=>await this.parseSearchResponse(e,t))}async parseSearchResponse(e,t){this.metadataParser.parseDynamicMetadata(t);const r=this.hierarchyNodePathParser.parse(t?.["@com.sap.vocabularies.Search.v1.ParentHierarchies"],e.query);const s=await this.itemParser.parse(e.query,t);let a;const i=t["@com.sap.vocabularies.Search.v1.SearchStatistics"]?.ConnectorStatistics;if(e.query.getDataSource()===this.sina.getAllDataSource()&&i&&Array.isArray(i)&&i.length===1){const r={"@com.sap.vocabularies.Search.v1.Facets":[{"@com.sap.vocabularies.Search.v1.Facet":{Dimensions:[{PropertyName:"scope",isConnectorFacet:true}]},Items:[{scope:i[0].OdataID,_Count:t["@odata.count"]}]}]};a=await this.facetParser.parse(e.query,r)}else{a=await this.facetParser.parse(e.query,t)}const o=X(this.sina,t["@com.sap.vocabularies.Search.v1.Nlq"]);return this.sina._createSearchResultSet({title:"Search Result List",query:e.query,items:s,totalCount:t["@odata.count"]||0,facets:a,hierarchyNodePaths:r,nlqResult:o})}async _fireObjectSuggestionsQuery(e,t){return await V(async()=>(await this.ajaxClient.getJson(t.url))?.data,async r=>{this.metadataParser.parseDynamicMetadata(r);const s=await this.itemParser.parse(t.query,r);const a=this.suggestionParser.parseObjectSuggestions(t.query,s);return this.sina._createSuggestionResultSet({title:"Suggestions",query:e,items:a})})}_prepareChartQueryRequest(e,t,r){const s=e.filter.searchTerm;const a=e.filter.dataSource;const i=15;const o=r.deleted||false;const c=n.serialize(a,t);if(!Array.isArray(c.items)){c.items=[]}const u=e.top||5;if(o===true){const e=r.value;if(!r.value||r.value===""||e.match(/^[*\s]+$/g)!==null){r.value="*";c.items.push(new F({property:r.attribute,operator:I.Search,value:new D({term:"*"})}))}else{c.items.push(new F({property:r.attribute,operator:I.EqualCaseInsensitive,value:new j({phrase:r.value+"*"})}))}}this.addFilterConditionToFilter(e,c,this.dataSourceConfigurations);const l={resourcePath:this.getPrefix()+"/$all",$top:0,$count:true,searchQueryFilter:c,freeStyleText:s};if(a!==this.sina.getAllDataSource()){l.scope=a.id}const h=[];l.facetlimit=u;if(e.dimension){h.push(e.dimension);const t=e.filter.dataSource.getAttributeMetadata(e.dimension);if(t&&(t.type==="Double"||t.type==="Integer")&&u>=20){l.facetlimit=i}}l.facets=h;return this.assembleUrl(l,{nlq:e.nlq})}async executeChartQuery(e){const t=new R;const r=e.filter.rootCondition.clone();const s=r.removeAttributeConditions(e.dimension);const a=this._prepareChartQueryRequest(e,r,s);return await V(async()=>(await this.ajaxClient.getJson(a))?.data,async r=>{const s=await this.facetParser.parse(e,r);if(s.length>0){return s[0]}let a="";const i=e.filter.dataSource.getAttributeMetadata(e.dimension);if(i&&i.label){a=i.label}return this.sina._createChartResultSet({title:a,items:[],query:e,log:t,facetTotalCount:undefined})})}async executeHierarchyQuery(t){const r=new U;const s=n.serialize(t.filter.dataSource,t.filter.rootCondition);if(!Array.isArray(s.items)){s.items=[]}this.addFilterConditionToFilter(t,s,this.dataSourceConfigurations);const a=this.assembleUrl({resourcePath:this.getPrefix()+"/$all",$top:0,searchQueryFilter:s,freeStyleText:t.filter.searchTerm,scope:t.filter.dataSource.id,facets:[t.attributeId],facetroot:[new E({facetColumn:t.attributeId,rootIds:[t.nodeId],levels:1})]},{nlq:t.nlq});return await V(async()=>(await this.ajaxClient.getJson(a))?.data,async s=>{const a=t.filter.dataSource.getAttributeMetadata(t.attributeId);const i=s["@com.sap.vocabularies.Search.v1.Facets"]||[];const o=i.find(r=>{const s=e.getProperty(r,["@com.sap.vocabularies.Search.v1.Facet","Dimensions",0,"PropertyName"]);return s===t.attributeId});return r.parseHierarchyFacet(t,a,o||{})})}async executeSuggestionQuery(e){const[t,r]=await Promise.all([this.executeRegularSuggestionQuery(e),this.executeObjectSuggestionQuery(e)]);const s=this.sina._createSuggestionResultSet({title:"Suggestions",query:e,items:[...r.items,...t.items]});s.addErrors(t.getErrors());s.addErrors(r.getErrors());return s}isObjectSuggestionQuery(e){return e.types.indexOf(N.Object)>=0&&e.filter.dataSource.type===e.sina.DataSourceType.BusinessObject}async executeObjectSuggestionQuery(e){if(!this.isObjectSuggestionQuery(e)){return Promise.resolve(this.sina._createSuggestionResultSet({title:"Suggestions",query:e,items:[]}))}const t=this._prepareSearchObjectSuggestionRequest(e);return this._fireObjectSuggestionsQuery(e,t)}executeRegularSuggestionQuery(e){if(e.calculationModes.includes(z.Data)&&(e.types.includes(N.SearchTerm)||e.types.includes(N.SearchTermAI))){return this._fireSuggestionQuery(e)}return Promise.resolve(this.sina._createSuggestionResultSet({title:"Suggestions",query:e,items:[]}))}_prepareSuggestionQueryRequest(e){const t=e.filter.searchTerm;const r=e.filter.dataSource;const s=e.filter.rootCondition.clone();const a=n.serialize(e.filter.dataSource,s);if(!Array.isArray(a.items)){a.items=[]}const i=e.top||10;const o=e.skip||0;this.addFilterConditionToFilter(e,a,this.dataSourceConfigurations);const c={suggestTerm:t,resourcePath:this.getPrefix()+"/$all",$top:i,$skip:o,searchQueryFilter:a};if(r!==this.sina.getAllDataSource()){c.scope=r.id}let u=e.nlq;if(e.types.indexOf(N.SearchTermAI)>=0){if(e.types.length>1){throw new $({message:"inconsistent suggestion query: ai suggestion mixed with other suggestion"})}u=true}return this.assembleUrl(c,{nlq:u,workaroundForEmptySuggestionTerm:true})}async _fireSuggestionQuery(e){const t=this._prepareSuggestionQueryRequest(e);return await V(async()=>(await this.ajaxClient.getJson(t))?.data,async t=>{let r=[];if(t.value){r=this.suggestionParser.parse(e,t.value)}return this.sina._createSuggestionResultSet({title:"Suggestions",query:e,items:r})})}addFilterConditionToFilter(e,t,r){if(r){const s=r.filter(t=>t.id===e.filter.dataSource.id)[0];if(s?.filterCondition){t.items.push(this.convertFilterConditionToExpression(s.filterCondition))}}}getPrefix(){const e=this.odataVersion??"/v20411";const t=this.requestPrefix??"/sap/es/odata";const r=t+e;return r}convertFilterConditionToExpression(e){let t=null;if(e&&e instanceof B){t=n.serialize(null,e)}return t}getDebugInfo(){return"ESH API Provider: "+this.id}assembleUrl(e,t){const r="FDGhfdhgfHFGHrdthfgcvgzjmbvndf";const s=e?.freeStyleText;if(t?.doNotEsacpeFreeStyleText&&e?.freeStyleText){e.freeStyleText=r}const a="fdjksghdfjkhvbbnfydfsd";if(t?.workaroundForEmptySuggestionTerm){if(e.suggestTerm===""){e.suggestTerm=a}}let i=w(e);if(t?.nlq){const e=i.indexOf("?");if(e>=0){i=i.slice(0,e+1)+"nlq=true&"+i.slice(e+1)}else{i+="?nlq=true"}}if(t?.doNotEsacpeFreeStyleText){if(e?.freeStyleText===r){i=i.replace(r,encodeURIComponent("("+s+")"))}}if(t?.workaroundForEmptySuggestionTerm){if(e.suggestTerm===a){i=i.replace(a,"")}}return i}}var W={__esModule:true};W.PresentationUsage=Y;W.Provider=K;return W});
//# sourceMappingURL=Provider.js.map