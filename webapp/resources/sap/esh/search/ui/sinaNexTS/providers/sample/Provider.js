/*!
 * SAPUI5
 * Copyright (c) 2025 SAP SE or an SAP affiliate company. All rights reserved.
 * 
 */
sap.ui.define(["../../core/errors","../../core/util","../../sina/ComparisonOperator","../../sina/ComplexCondition","../../sina/SearchQuery","../../sina/SearchResultSetItemAttribute","../../sina/SimpleCondition","../../sina/UserCategoryDataSource","../AbstractProvider","./template","./template2"],function(t,e,i,a,r,s,o,n,l,u,c){"use strict";const h=t["ForcedBySearchTermTestError"];const d=t["NotImplementedError"];const f=e["escapeRegExp"];const m=i["ComparisonOperator"];const g=a["ComplexCondition"];const S=r["SearchQuery"];const p=s["SearchResultSetItemAttribute"];const y=o["SimpleCondition"];const C=n["UserCategoryDataSource"];const b=l["AbstractProvider"];const v=u["createTemplate"];const F=c["createTemplate"];class I extends b{static dataSourceIds={All:"All",Urban_Legends:"Urban_Legends",Folklorists:"Folklorists",Publications:"Publications",Scientists:"Scientists",Mysterious_Sightings:"Mysterious_Sightings"};id;searchQuery;templateProvider;constructor(){super();this.id="sample"}async initAsync(t){this.sina=t.sina;this.templateProvider=v;if(document.location.href.indexOf("use=sample1")>0){this.templateProvider=F}const e=this.templateProvider(this);e._init(e);const i=Promise.resolve({capabilities:this.sina._createCapabilities({fuzzy:false})});return i}getSuggestionList(t){const e=this._stringify(t);const i=new RegExp('"valueFormatted":"([^{/]+?)","valueHighlighted',"g");let a=e.match(i).map(t=>t.replace(i,"$1"));const r=a.toString().split(/\W/);a=a.concat(r);a=a.filter(function(t,e){if(t!==""){return a.indexOf(t)==e}});return a}_stringify(t){let e=[];const i=JSON.stringify(t,function(t,i){if(typeof i==="object"&&i!==null){if(e.indexOf(i)!==-1){return undefined}e.push(i)}return i});e=null;return i}applyFilters(t,e){const i=[];if(e.filter.rootCondition instanceof y){}else{if(e.filter.rootCondition.conditions.length===0||e.filter.rootCondition.conditions[0]instanceof y||e.filter.rootCondition.conditions[0]instanceof g&&e.filter.rootCondition.conditions[0].conditions.length===0){if(e.filter.dataSource instanceof C){const i=e.filter.dataSource.subDataSources;if(i){return t.filter(t=>i.find(e=>e.id===t.dataSource.id))}}return t}}const a=[];const r=[];if(e.filter.rootCondition instanceof y){const t=e.filter.rootCondition;a.push({attribute:t.attribute,operator:t.operator,value:t.value,fits:false});r.push(t.attribute)}else{for(let t=0;t<e.filter.rootCondition.conditions.length;t++){const i=e.filter.rootCondition.conditions[t].conditions;if(i){for(let t=0;t<i.length;t++){a.push({attribute:i[t].attribute,value:i[t].value,operator:i[t].operator,fits:false});r.push(i[t].attribute)}}}}let s=false;for(let e=0;e<t.length;e++){const o=t[e];const n=[];for(let t=0;t<a.length;t++){s=false;for(let e=0;e<o.detailAttributes.length;e++){const i=o.detailAttributes[e];if(i instanceof p){if(i.id===a[t].attribute&&this.checkFilterValueMatch(i.value,a[t].value,a[t].operator)){s=true}}}for(let e=0;e<o.titleAttributes.length;e++){const i=o.titleAttributes[e];if(i instanceof p){if(i.id===a[t].attribute&&this.checkFilterValueMatch(i.value,a[t].value,a[t].operator)){s=true}}}a[t].fits=s;n.push(s)}if(n.toString().match(/false/)===null){i.push(o)}else{const t=[];const e=r.filter(function(t,e){return r.indexOf(t)==e});for(let i=0;i<e.length;i++){s=false;const r=e[i];for(let t=0;t<a.length;t++){if(a[t].attribute===r&&a[t].fits===true){s=true;break}}t.push(s)}if(t.toString().match(/false/)===null){i.push(o)}}}return i}checkFilterValueMatch(t,e,i){switch(i){case m.Co:{return t.toLowerCase().includes(e.toLowerCase())}case m.Eq:{return e===t}case m.Ne:{return e!==t}case m.Gt:{return e>t}case m.Ge:{return e>=t}case m.Lt:{return e<t}case m.Le:{return e<=t}default:{return t===e}}return false}adjustHighlights(t,e){const i=[];let a="";for(let r=0;r<t.length;r++){const s=t[r];let o=true;a="";s.titleHighlighted=this.addHighlight(s.title,e);if(s.titleHighlighted!==s.title){o=false}for(let i=0;i<t[r].detailAttributes.length;i++){const s=t[r].detailAttributes[i];a=s.metadata.type;if(a==="String"||a==="Integer"){s.valueHighlighted=this.addHighlight(s.valueFormatted,e);if(s.valueHighlighted!==s.valueFormatted){o=false}}}for(let i=0;i<t[r].titleAttributes.length;i++){const s=t[r].titleAttributes[i];a=s.metadata.type;if(a==="String"||a==="Integer"||a==="ImageUrl"){s.valueHighlighted=this.addHighlight(s.valueFormatted,e);if(s.valueHighlighted!==s.valueFormatted){o=false}}}if(o===false||e==="*"||e===""){i.push(s)}}return i}addHighlight(t,e){if(typeof t!=="string"||typeof e!=="string"){return t}const i=t.toLowerCase().indexOf(e.toLowerCase());if(i>-1){const a=i+e.length;const r=t.substring(0,i)+"<b>"+t.substring(i,a)+"</b>"+t.substring(a);return r}return t}addSuvLinkToSearchResultItem(t,e,i){const a=this.sina._createSuvNavTargetResolver();if(!e){e="/resources/sap/esh/search/ui/sinaNexTS/providers/sample/docs/folklorist_authors_and_publications.suv"}if(!i){i=[]}const r={};r.obj={suvThumbnailAttribute:t,suvTargetMimeTypeAttribute:{value:"application/vnd.sap.universal-viewer+suv"},suvTargetUrlAttribute:{value:e}};a.resolveSuvNavTargets(null,r,i)}async executeSearchQuery(t){this.searchQuery=t;return new Promise(e=>{let i;const a=this.templateProvider(this);const r=a.searchResultSetItemArray;const s=a.searchResultSetItemArray2;let o=r.concat(s);let n;if(a.searchResultSetItemArray3){n=a.searchResultSetItemArray3;o=o.concat(n)}const l=t.filter.searchTerm;const u=t.filter.dataSource.id;const c=t.filter.dataSource.type;const d=this.generateFacets(t);if(l===h.forcedBySearchTerm){throw new h}let f;if(u===I.dataSourceIds.Scientists||u===I.dataSourceIds.Folklorists){f=this.adjustHighlights(r,l);f=this.applyFilters(f,t);i=this.sina._createSearchResultSet({items:f,facets:d,query:t,title:"",totalCount:f.length})}else if(u===I.dataSourceIds.Mysterious_Sightings||u===I.dataSourceIds.Urban_Legends){f=this.adjustHighlights(s,l);f=this.applyFilters(f,t);i=this.sina._createSearchResultSet({items:f,facets:d,query:t,title:"",totalCount:f.length})}else if(u==="Publications"){f=this.adjustHighlights(n,l);f=this.applyFilters(f,t);i=this.sina._createSearchResultSet({items:f,facets:d,query:t,title:"",totalCount:f.length})}else if(u===I.dataSourceIds.All||c===this.sina.DataSourceType.UserCategory){d[0].items.forEach(t=>{t.measureValue=0;t.measureValueFormatted=""});f=this.adjustHighlights(r,l);f=this.applyFilters(f,t);const e=f.length;f=this.adjustHighlights(s,l);f=this.applyFilters(f,t);const a=f.length;let u=0;if(n){f=this.adjustHighlights(n,l);f=this.applyFilters(f,t);u=f.length}d[0].items[0].measureValue=e;d[0].items[0].measureValueFormatted=""+e;d[0].items[1].measureValue=a;d[0].items[1].measureValueFormatted=""+a;if(n&&d[0].items.length>2){d[0].items[2].measureValue=u;d[0].items[2].measureValueFormatted=""+u}d[0].items=d[0].items.filter(t=>t.measureValue>0);f=this.adjustHighlights(o,l);f=this.applyFilters(f,t);const c=[];for(let e=t.skip;e<t.skip+t.top&&e<f.length;e++){c.push(f[e])}i=this.sina._createSearchResultSet({items:c,facets:d,query:t,title:"",totalCount:f.length})}e(i)})}executeHierarchyQuery(t){throw new d}async executeSuggestionQuery(t){const e=t.filter.searchTerm;const i=this.templateProvider(this);const a=i.searchResultSetItemArray.concat(i.searchResultSetItemArray2).concat(i.searchResultSetItemArray3);const r=this.getSuggestionList(a);const s=new RegExp(`^${f(e)}`,"gi");const o=r.filter(t=>t.match(s));const n=[];const l=e=>{const i=this.sina.SuggestionCalculationMode.Data;const a=t.filter.clone();a.setSearchTerm(e);return this.sina._createSearchTermSuggestion({searchTerm:e,calculationMode:i,filter:a,label:e})};for(let t=0;t<o.length;t++){n.push(l(o[t]))}const u=this.sina._createSuggestionResultSet({title:"Suggestions",query:t,items:n});return new Promise(function(t){t(u)})}async executeChartQuery(t){const e=this.generateFacets(t);let i=1;if(t.dimension==="LOCATION"||e.length===1){i=0}return new Promise(function(t){t(e[i])})}getChartResultSetItemsForLocations(t){const e=[];let i;const a=[];let r,s,o,n,l;for(s=0;s<t.length;s++){l=t[s].detailAttributes;for(o=0;o<l.length;o++){if(l[o].id==="LOCATION"){i=l[o].value;if(a.indexOf(i)===-1){a.push(i);r=this.sina._createChartResultSetItem({filterCondition:this.sina.createSimpleCondition({attribute:"LOCATION",attributeLabel:"Location",operator:this.sina.ComparisonOperator.Eq,value:i}),dimensionValueFormatted:i,measureValue:1,measureValueFormatted:"1"});e.push(r)}else{for(n=0;n<e.length;n++){if(e[n].filterCondition.value===i){e[n].measureValue=e[n].measureValue+1;e[n].measureValueFormatted=""+e[n].measureValue}}}}}}return e}getChartResultSetItemsForPublications(t){const e=[];let i;const a=[];let r,s,o,n,l;for(s=0;s<t.length;s++){l=t[s].detailAttributes;for(o=0;o<l.length;o++){if(l[o].id==="PUBLICATION"){i=l[o].value;if(a.indexOf(i)===-1){a.push(i);r=this.sina._createChartResultSetItem({filterCondition:this.sina.createSimpleCondition({attribute:"PUBLICATION",attributeLabel:"Publication",operator:this.sina.ComparisonOperator.Eq,value:i}),dimensionValueFormatted:i,measureValue:1,measureValueFormatted:"1"});e.push(r)}else{for(n=0;n<e.length;n++){if(e[n].filterCondition.value===i){e[n].measureValue=e[n].measureValue+1;e[n].measureValueFormatted=""+e[n].measureValue}}}}}}return e}getSientistOrFolkloristFacet(t,e){let i;const a=[];let r,s,o,n,l,u;const c=[];for(s=0;s<e.length;s++){l=e[s].titleAttributes;if(t.filter.dataSource.id===I.dataSourceIds.Mysterious_Sightings||t.filter.dataSource.id===I.dataSourceIds.Urban_Legends||t.filter.dataSource.id===I.dataSourceIds.Publications){l=e[s].detailAttributes}for(o=0;o<l.length;o++){if(l[o].id==="SCIENTIST"||l[o].id==="FOLKLORIST"){i=l[o].value;u=l[o].id;if(a.indexOf(i)===-1){a.push(i);r=this.sina._createChartResultSetItem({filterCondition:this.sina.createSimpleCondition({attribute:l[o].id,attributeLabel:l[o].label,operator:this.sina.ComparisonOperator.Eq,value:i}),dimensionValueFormatted:i,measureValue:1,measureValueFormatted:"1"});c.push(r)}else{for(n=0;n<c.length;n++){if(c[n].filterCondition.value===i){c[n].measureValue=c[n].measureValue+1;c[n].measureValueFormatted=""+c[n].measureValue}}}}}}return[c,u]}getTopFacetOnly(t){const e=t.filter.sina.allDataSource;const i=[this.sina._createDataSourceResultSetItem({dataSource:t.filter.sina.dataSources[1],dimensionValueFormatted:e.labelPlural,measureValue:4,measureValueFormatted:"4"}),this.sina._createDataSourceResultSetItem({dataSource:t.filter.sina.dataSources[2],dimensionValueFormatted:e.labelPlural,measureValue:5,measureValueFormatted:"5"})];if(t.filter.sina.dataSources[3]){i[2]=this.sina._createDataSourceResultSetItem({dataSource:t.filter.sina.dataSources[3],dimensionValueFormatted:e.labelPlural,measureValue:1,measureValueFormatted:"1"})}const a=[this.sina._createDataSourceResultSet({title:t.filter.dataSource.label,items:i,query:t,facetTotalCount:undefined})];return a}generateFacets(t){if(t.filter.dataSource.id===I.dataSourceIds.All||t.filter.dataSource.type===this.sina.DataSourceType.UserCategory||t instanceof S&&(t.calculateFacets===undefined||t.calculateFacets===false)){return this.getTopFacetOnly(t)}const e=[];let i;const a=this.templateProvider(this);const r=this.sina.createFilter({searchTerm:this.searchQuery.filter.searchTerm,dataSource:this.searchQuery.filter.dataSource,rootCondition:this.searchQuery.filter.rootCondition.clone()});let s=[];let o;if(t.filter.dataSource.id===I.dataSourceIds.Publications){o=a.searchResultSetItemArray3}else if(t.filter.dataSource.id===I.dataSourceIds.Scientists||t.filter.dataSource.id===I.dataSourceIds.Folklorists){o=a.searchResultSetItemArray}else if(t.filter.dataSource.id===I.dataSourceIds.Urban_Legends||t.filter.dataSource.id===I.dataSourceIds.Mysterious_Sightings){o=a.searchResultSetItemArray2}if(t.filter.dataSource.id===I.dataSourceIds.Scientists||t.filter.dataSource.id===I.dataSourceIds.Mysterious_Sightings){s=this.getChartResultSetItemsForLocations(o);i=this.sina._createChartResultSet({items:s,query:this.sina.createChartQuery({filter:r,dimension:"LOCATION"}),title:"Locations",facetTotalCount:undefined});e.push(i)}const n=this.getSientistOrFolkloristFacet(t,o);s=n[0];const l=n[1];i=this.sina._createChartResultSet({items:s,query:this.sina.createChartQuery({filter:r,dimension:l}),title:l.charAt(0).toUpperCase()+l.slice(1).toLowerCase()+"s",facetTotalCount:undefined});e.push(i);return e}}var V={__esModule:true};V.Provider=I;return V});
//# sourceMappingURL=Provider.js.map