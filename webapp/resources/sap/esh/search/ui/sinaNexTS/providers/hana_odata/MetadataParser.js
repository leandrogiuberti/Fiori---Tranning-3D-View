/*!
 * SAPUI5
 * Copyright (c) 2025 SAP SE or an SAP affiliate company. All rights reserved.
 * 
 */
sap.ui.define(["../../core/Log","../../sina/AttributeType","../../sina/AttributeFormatType","../../sina/MatchingStrategy","../../core/errors","../../sina/i18n"],function(t,e,a,r,i,n){"use strict";const s=t["Log"];const o=e["AttributeType"];const c=a["AttributeFormatType"];const l=r["MatchingStrategy"];const u=i["UnknownAttributeTypeError"];const p=i["UnknownPresentationUsageError"];const y=n["getText"];var d=function(t){t[t["AUTO_FACET"]=0]="AUTO_FACET";t[t["SUGGESTION"]=1]="SUGGESTION";return t}(d||{});var f=function(t){t[t["TITLE"]=0]="TITLE";t[t["SUMMARY"]=1]="SUMMARY";t[t["DETAIL"]=2]="DETAIL";t[t["IMAGE"]=3]="IMAGE";t[t["THUMBNAIL"]=4]="THUMBNAIL";t[t["HIDDEN"]=5]="HIDDEN";return t}(f||{});class h{log;provider;presentationUsageConversionMap;accessUsageConversionMap;sina;constructor(t){this.log=new s("hana_odata metadata parser");this.provider=t;this.sina=t.sina}_setAnnotationValue(t,e,a){const r=e.split(".");let i;let n=t;const s="___temporaryDummyEntriesForArrays___";let o;for(o=0;o<r.length-1;o++){i=r[o];if(n[i]===undefined){n[i]={};n=n[i]}else if(Array.isArray(n[i])){n[s]=n[s]||{};if(!n[s][i]){n[s][i]={};n[i].push(n[s][i])}n=n[s][i]}else if(typeof n[i]==="object"){n=n[i]}else if(typeof n[i]==="boolean"){n[i]={};n=n[i]}else{return}}if(o<r.length){i=r[o];if(n[i]===undefined){n[i]=a}else if(Array.isArray(n[i])){if(Array.isArray(a)){n[i]=n[i].concat(a)}else{n[s]=n[s]||{};if(!n[s][i]){n[s][i]=a;n[i].push(n[s][i])}else{for(const t in a){if(!n[s][i][t]){n[s][i][t]=a[t]}}}}}}}fillMetadataBuffer(t,e){if(t.attributesMetadata[0].id!=="dummy"){return}t.attributesMetadata=[];t.attributeMetadataMap={};const a={dataSourceAnnotations:{},attributeAnnotations:{}};a.dataSourceAnnotations=t.annotations;for(const r in e.attributeMap){try{this.fillPublicMetadataBuffer(t,e.attributeMap[r],a)}catch(e){this.log.error("Attribue "+r+" of DataSource "+t.label+" can not be filled in meta data"+e.toString())}}const r=this.sina._createCDSAnnotationsParser({dataSource:t,cdsAnnotations:a});r.parseCDSAnnotationsForDataSource()}fillPublicMetadataBuffer(t,e,a){const r=e.displayOrder;const i=a.attributeAnnotations[e.labelRaw]={};for(const t in e.annotationsAttr){i[t]=e.annotationsAttr[t]}const n=this._parseAttributeTypeAndFormat(e,t,e.labelRaw);if(n&&n.type){const a=this.sina._createAttributeMetadata({id:e.labelRaw,label:e.label||e.labelRaw,isKey:e.isKey||false,isSortable:e.isSortable,usage:this._parseUsage(e,r)||{},type:n.type,format:n.format,matchingStrategy:this._parseMatchingStrategy(e),isHierarchy:!!e.hierarchyDefinition,hierarchyName:e?.hierarchyDefinition?.name,hierarchyDisplayType:e?.hierarchyDefinition?.displayType});if(e.hierarchyDefinition&&e.hierarchyDefinition?.isHierarchyDefinition){t.isHierarchyDataSource=true;t.hierarchyName=e.hierarchyDefinition?.name;t.hierarchyAttribute=e.hierarchyDefinition?.attributeName;t.hierarchyDisplayType=e.hierarchyDefinition?.displayType}a._private.semanticObjectType=e.SemanticObjectTypeId;t.attributesMetadata.push(a);t.attributeMetadataMap[a.id]=a}}_parseMatchingStrategy(t){if(t.supportsTextSearch===true){return l.Text}return l.Exact}_parseAttributeTypeAndFormat(t,e,a){for(let e=0;e<t.presentationUsage.length;e++){const a=t.presentationUsage[e]||"";switch(a.toUpperCase()){case"SUMMARY":continue;case"DETAIL":continue;case"TITLE":continue;case"HIDDEN":continue;case"FACTSHEET":continue;case"THUMBNAIL":case"IMAGE":return{type:o.ImageUrl};case"LONGTEXT":return{type:o.String,format:c.LongText};default:throw new p(a)}}switch(t.type){case"Edm.Binary":if(t.annotationsAttr){if(t.annotationsAttr.SEMANTICS&&t.annotationsAttr.SEMANTICS.CONTACT&&t.annotationsAttr.SEMANTICS.CONTACT.PHOTO||t.annotationsAttr.SEMANTICS&&t.annotationsAttr.SEMANTICS.IMAGEURL){return{type:o.ImageBlob}}}return{type:o.String};break;case"Edm.String":case"Edm.PrimitiveType":case"Edm.Boolean":case"Edm.Byte":case"Edm.Guid":return{type:o.String};case"Edm.Double":case"Edm.Decimal":case"Edm.Float":case"Edm.Single":case"Edm.SingleRange":return{type:o.Double};case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":return{type:o.Integer};case"Edm.TimeOfDay":return{type:o.Time};case"Edm.Date":return{type:o.Date};case"Edm.DateTimeOffset":return{type:o.Timestamp};case"Collection(Edm.String)":return{type:o.String};case"Edm.GeometryPoint":case"Edm.GeographyPoint":case"GeoJson":return{type:o.GeoJson};default:if(t.type&&t.type.startsWith("Collection")){this.log.warn("Unsupported data type "+t.type+" of attribute "+t.labelRaw+" in "+e.label);return{type:o.String}}throw new u(y("error.sina.unsupportedOdataType",[t.type,t.labelRaw||a,e.label]))}}_parseUsage(t,e){const a={};for(let r=0;r<t.presentationUsage.length;r++){const i=t.presentationUsage[r].toUpperCase()||"";if(i==="TITLE"){a.Title={displayOrder:e}}if(i==="SUMMARY"||i==="DETAIL"||i==="IMAGE"||i==="THUMBNAIL"||i==="LONGTEXT"){a.Detail={displayOrder:e}}}if(t.isFacet){a.AdvancedSearch={displayOrder:t.facetPosition||e||100,iconUrlAttributeName:t.facetIconUrlAttributeName};a.Facet={displayOrder:t.facetPosition||e||100,iconUrlAttributeName:t.facetIconUrlAttributeName}}if(t.isFilteringAttribute){a.AdvancedSearch={displayOrder:t.facetPosition||e||100,iconUrlAttributeName:t.facetIconUrlAttributeName}}return a}parseDynamicMetadata(t){if(!t){return}const e=t["@com.sap.vocabularies.Search.v1.Metadata"];if(!e){return}for(const t in e){const a=e[t];for(const e in a){if(e==="$Kind"){continue}const r=a[e];this.parseDynamicAttributeMetadata(this.sina.getDataSource(t),e,r)}}}parseDynamicAttributeMetadata(t,e,a){const r=this._parseAttributeTypeAndFormat({presentationUsage:[],type:a.$Type},t,e);let i;try{i=t.getAttributeMetadata(e)}catch(t){this.log.warn("Error while getting attribute metadata: "+t)}if(i){if(!i._private.dynamic){return}i.label=a["@SAP.Common.Label"];i.type=r.type;i.format=r?.format;i.usage=a["@EnterpriseSearch.filteringFacet.default"]===true?{Facet:{displayOrder:a["@EnterpriseSearch.filteringFacet.displayPosition"]||i.usage?.Facet?.displayOrder||20,iconUrlAttributeName:a["@EnterpriseSearch.filteringFacet.iconUrl"]||i.iconUrlAttributeName||""}}:{};i.isSortable=a["@EnterpriseSearchHana.isSortable"]||i.isSortable||false}else{i=this.sina._createAttributeMetadata({id:e,label:a["@SAP.Common.Label"],isKey:false,isSortable:a["@EnterpriseSearchHana.isSortable"]||false,usage:a["@EnterpriseSearch.filteringFacet.default"]===true?{Facet:{displayOrder:a["@EnterpriseSearch.filteringFacet.displayPosition"]||20,iconUrlAttributeName:a["@EnterpriseSearch.filteringFacet.iconUrl"]||""}}:{},type:r.type,format:r?.format,matchingStrategy:l.Exact,_private:{dynamic:true}});t.attributesMetadata.push(i);t.attributeMetadataMap[i.id]=i}}getUniqueDataSourceFromSearchResult(t){const e=t.data;if(!e){return}const a=e.value;if(!a){return}let r,i;for(let t=0;t<a.length;++t){const e=a[t];const n=e["@odata.context"];if(!n){return}r=n.split("#")[1];if(!r){return}if(i&&i!==r){return}i=r}return this.sina.getDataSource(r)}}var A={__esModule:true};A.MetadataParser=h;return A});
//# sourceMappingURL=MetadataParser.js.map