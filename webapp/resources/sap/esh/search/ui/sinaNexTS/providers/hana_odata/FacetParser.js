/*!
 * SAPUI5
 * Copyright (c) 2025 SAP SE or an SAP affiliate company. All rights reserved.
 * 
 */
sap.ui.define(["../../sina/SearchQuery","./typeConverter","../../sina/LogicalOperator","../../sina/ComparisonOperator","../../sina/ChartQuery","../../core/Log","../../core/errors","./HierarchyParser"],function(e,t,a,r,o,i,s,n){"use strict";const c=e["SearchQuery"];const l=a["LogicalOperator"];const u=r["ComparisonOperator"];const p=o["ChartQuery"];const m=i["Log"];const h=s["FacetsParseError"];const d=n["HierarchyParser"];class f{log;provider;sina;constructor(e){this.provider=e;this.sina=e.sina;this.log=new m("hana_odata facet parser")}async parse(e,t){const a=new d;const r=t["@com.sap.vocabularies.Search.v1.Facets"];if(!r){return Promise.resolve([])}if(t.error){this.log.warn("Server-side Warning: "+t.error.message)}const o=[];for(let i=0;i<r.length;i++){const s=r[i];let n;if(e.filter.dataSource===e.sina.getAllDataSource()){try{n=this.parseDataSourceFacet(e,s)}catch(e){this.log.warn("Error occurred by parsing dataource item number "+i+": "+e.message);continue}}else{if(e.filter.dataSource.type===e.sina.DataSourceType.Category){continue}if(s["@com.sap.vocabularies.Search.v1.Facet"].Dimensions[0].PropertyType==="GeometryPolygonFacet"){continue}try{const r=this.parseFacetAttribute(e,s);if(r.isHierarchy){n=a.parseHierarchyFacet(e,r,s)}else{n=this.parseChartFacet(e,r,s,t["@odata.count"]||undefined)}}catch(e){let t="";if(s.Items&&Array.isArray(s.Items)){t=JSON.stringify(s)}this.log.warn("Error occurred by parsing facet "+(s["@com.sap.vocabularies.Common.v1.Label"]||"")+"', facet position: "+i+": "+e.message+"; item data: "+t);continue}}o.push(n)}return Promise.all(o)}parseDataSourceFacet(e,t){let a=e;if(e instanceof c){a=this.sina.createDataSourceQuery({dataSource:e.filter.dataSource,filter:e.filter.clone(),nlq:e.nlq})}const r=[];for(let e=0;e<t.Items.length;e++){const a=t.Items[e];let o=this.sina.getDataSource(a.scope);if(!o){o=this.sina.createDataSource({type:this.sina.DataSourceType.Category,id:a.ValueLow,label:a.Description})}r.push(this.sina._createDataSourceResultSetItem({dataSource:o,dimensionValueFormatted:o.labelPlural,measureValue:a._Count,measureValueFormatted:a._Count.toString()}))}const o=this.sina._createDataSourceResultSet({title:e.filter.dataSource.label,items:r,query:a,facetTotalCount:undefined});if(e instanceof c){return a._setResultSet(o)}return o}createAttributeFilterCondition(e,a,r){if(typeof r[e]==="object"&&(Object.prototype.hasOwnProperty.call(r[e],"From")||Object.prototype.hasOwnProperty.call(r[e],"From"))){const o=this.sina.createComplexCondition({attributeLabel:a.label,valueLabel:this.formatFacetValue(r[e]),operator:l.And,conditions:[]});let i,s;if(!r[e].From){s=this.sina.createSimpleCondition({attribute:e,operator:u.Le,value:t.odata2Sina(a.type,r[e].To)});o.conditions.push(s)}else if(!r[e].To){i=this.sina.createSimpleCondition({attribute:e,operator:u.Ge,value:t.odata2Sina(a.type,r[e].From)});o.conditions.push(i)}else{i=this.sina.createSimpleCondition({attribute:e,operator:u.Ge,value:t.odata2Sina(a.type,r[e].From)});o.conditions.push(i);s=this.sina.createSimpleCondition({attribute:e,operator:u.Le,value:t.odata2Sina(a.type,r[e].To)});o.conditions.push(s)}return o}let o=t.convertValueToString(t.odata2Sina(a.type,r[e]));const i=r[e+"@com.sap.vocabularies.Common.v1.Text"];if(typeof i==="string"&&i.length>0){if(i.startsWith("sap-icon://")===false){o=i}}return this.sina.createSimpleCondition({attributeLabel:a.label,attribute:e,value:r[e],valueLabel:o})}formatFacetValue(e){const t="";if(e["@com.sap.vocabularies.Common.v1.Label"]){return e["@com.sap.vocabularies.Common.v1.Label"]}if(typeof e==="object"&&(Object.prototype.hasOwnProperty.call(e,"From")||Object.prototype.hasOwnProperty.call(e,"To"))){e=(e.From||t)+"..."+(e.To||t)}return e}parseFacetAttribute(e,t){const a=e.filter.dataSource;let r="";if(e instanceof p&&e.dimension){r=e.dimension}else{if(t["@com.sap.vocabularies.Search.v1.Facet"]&&t["@com.sap.vocabularies.Search.v1.Facet"].Dimensions&&t["@com.sap.vocabularies.Search.v1.Facet"].Dimensions[0]&&t["@com.sap.vocabularies.Search.v1.Facet"].Dimensions[0].PropertyName){r=t["@com.sap.vocabularies.Search.v1.Facet"].Dimensions[0].PropertyName}else{throw new h}}const o=a.getAttributeMetadata(r);return o}async parseChartFacet(e,t,a,r){const o=e.filter.dataSource;const i=[];let s=e;const n=e.filter.clone();n.setDataSource(o);n.setRootCondition(e.filter.rootCondition.clone());s=this.sina.createChartQuery({filter:n,dimension:t.id,nlq:e.nlq});const l=t.usage?.AdvancedSearch?.iconUrlAttributeName||t.id+"@com.sap.vocabularies.Common.v1.Text";const u=a.Items.findIndex(e=>e[l]?.startsWith("sap-icon://"))>-1;for(let e=0;e<a.Items.length;e++){const r=a.Items[e];const o=r[t.id+"@com.sap.vocabularies.Common.v1.Text"];let s="";if(u===true){s="sap-icon://none"}let n=this.formatFacetValue(r[t.id]);if(typeof o==="string"&&o.length>0){if(o.startsWith("sap-icon://")){s=o}else{n=o;s=r[t.usage?.AdvancedSearch?.iconUrlAttributeName]||s}}else{s=r[t.usage?.AdvancedSearch?.iconUrlAttributeName]||s}i.push(this.sina._createChartResultSetItem({filterCondition:this.createAttributeFilterCondition(t.id,t,r),dimensionValueFormatted:n,measureValue:r._Count,measureValueFormatted:r._Count,icon:s}))}const p=this.sina._createChartResultSet({title:t.label,items:i,query:s,facetTotalCount:r});if(e instanceof c){return s._setResultSet(p)}return p}}var y={__esModule:true};y.FacetParser=f;return y});
//# sourceMappingURL=FacetParser.js.map