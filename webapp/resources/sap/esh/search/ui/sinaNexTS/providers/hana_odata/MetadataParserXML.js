/*!
 * SAPUI5
 * Copyright (c) 2025 SAP SE or an SAP affiliate company. All rights reserved.
 * 
 */
sap.ui.define(["../../sina/DataSourceType","./MetadataParser","./HierarchyMetadataParser","../../core/errors","../../sina/i18n"],function(e,t,n,a,i){"use strict";function r(e){return new Promise(function(t,n){sap.ui.require([e],function(n){if(!(n&&n.__esModule)){n=n===null||!(typeof n==="object"&&e.endsWith("/library"))?{default:n}:n;Object.defineProperty(n,"__esModule",{value:true})}t(n)},function(e){n(e)})})}const s=e["DataSourceType"];const o=t["MetadataParser"];const c=n["HierarchyMetadataParser"];const u=a["MetadataParserError"];const l=i["getText"];class E extends o{jsDOMWindow;constructor(e){super(e)}async _getWindow(){if(typeof window==="undefined"){if(typeof this.jsDOMWindow==="undefined"){const e=await r("jsdom");const t=await r("node:fs");const jquery=t.readFileSync("./node_modules/jquery/dist/jquery.js","utf-8");const n=new e.JSDOM("<html><script>"+jquery+"<\/script><body></body></html>",{runScripts:"dangerously"});this.jsDOMWindow=n.window;n.window.$=n.window.jQuery}return this.jsDOMWindow}return window}async fireRequest(e,t){const n=await e.getXML(t);return n}async parseResponse(e){if(typeof e==="string"){const t={businessObjectMap:new Map,businessObjectList:[],dataSourceMap:new Map,dataSourcesList:[]};const n=await this._getWindow();const a=n.$.parseXML(e);const i=n.$(a).find("Schema");const r=n.$(i);const s=await this._parseEntityType(r,n);this._parseEntityContainer(r,s,t,n);return t}else{throw new u(l("error.sina.metadataParserNotStringError"))}}async _parseEntityType(e,t){const n=this;const a={};e=t.$(e);const i=new c(t.$);const r=[];e.find("EntityType").each(function(){const s=t.$(this).attr("Name");const o={schema:e.attr("Namespace"),keys:[],attributeMap:new Map,resourceBundle:undefined,labelResourceBundle:undefined,label:"",labelPlural:"",annotations:{},hierarchyDefinitionsMap:new Map,icon:"",name:"",dataSource:undefined};a[s]=o;t.$(this).find("Key>PropertyRef").each(function(){o.keys.push(t.$(this).attr("Name"))});t.$(this).find('>Annotation[Term="EnterpriseSearch.hierarchy.parentChild"]').each(function(){o.hierarchyDefinitionsMap=i.parse(s,this)});t.$(this).find('Annotation[Term="Search.searchable"]').each(function(){t.$(this).siblings("Annotation").each(function(){const e=t.$(this);let a=e.attr("Term");if(a!==undefined&&a.length>0){a=a.toUpperCase();const e=n._getValueFromElement(this,t);if(a==="ENTERPRISESEARCHHANA.UIRESOURCE.LABEL.BUNDLE"){o.resourceBundle=e}else if(a==="ENTERPRISESEARCHHANA.UIRESOURCE.LABEL.KEY"){const t=e;if(typeof t==="string"&&t&&o.resourceBundle){r.push(n.provider.getTextFromResourceBundle(o.resourceBundle,t).then(e=>{if(e){o.labelResourceBundle=e}}).catch(e=>{n.log.error("Resource bundle of "+s+" '"+o.resourceBundle+"' can't be found:"+e.toString())}))}}else if(a==="UI.HEADERINFO.TYPENAME"){if(typeof e==="string"){o.label=e}}else if(a==="UI.HEADERINFO.TYPENAMEPLURAL"){if(typeof e==="string"){o.labelPlural=e}}else if(a==="UI.HEADERINFO.TITLE.TYPE"){n._setAnnotationValue(o.annotations,a,e)}else if(a==="UI.HEADERINFO.TITLE.VALUEQUALIFIER"){n._setAnnotationValue(o.annotations,a,e)}else if(a==="UI.HEADERINFO.TYPEIMAGEURL"){if(typeof e==="string"){o.icon=e}}else{n._setAnnotationValue(o.annotations,a,e)}}})});t.$(this).find("Property").each(function(e){const a=t.$(this).attr("Name")||"";const i={labelRaw:a,label:"",type:t.$(this).attr("Type")||"",presentationUsage:[],isFacet:false,isSortable:false,supportsTextSearch:false,displayOrder:e,annotationsAttr:{},unknownAnnotation:[],hierarchyDefinition:o.hierarchyDefinitionsMap[a],facetPosition:0,facetIconUrlAttributeName:"",isKey:false,isFilteringAttribute:undefined};o.attributeMap[a]=i;t.$(this).find("Annotation").each(function(){let e=t.$(this).attr("Term");if(e!==undefined&&e.length>0){e=e.toUpperCase();let a=n._getValueFromElement(this,t);if(a==undefined){t.$(this).children("Collection").children("Record").each(function(){a=a||[];const e={};a.push(e);t.$(this).children("PropertyValue").each(function(){let a=t.$(this).attr("Property");if(a!==undefined&&a.length>0){a=a.toUpperCase();const i=n._getValueFromElement(this,t);if(i!==undefined){e[a]=i}}})})}if(a!==undefined){switch(e){case"SAP.COMMON.LABEL":if(!i.label){i.label=a}break;case"ENTERPRISESEARCHHANA.UIRESOURCE.LABEL.KEY":if(a&&o.resourceBundle){r.push(n.provider.getTextFromResourceBundle(o.resourceBundle,a).then(e=>{if(e){i.label=e}}).catch(e=>{n.log.error("Resource bundle of "+s+" '"+o.resourceBundle+"' can't be found:"+e.toString())}))}break;case"ENTERPRISESEARCH.KEY":i.isKey=a;break;case"ENTERPRISESEARCH.PRESENTATIONMODE":t.$(this).find("Collection>String").each(function(){const e=n._getValueFromElement(this,t);if(e){i.presentationUsage.push(e)}});break;case"ENTERPRISESEARCHHANA.ISSORTABLE":i.isSortable=a;break;case"ENTERPRISESEARCHHANA.SUPPORTSTEXTSEARCH":i.supportsTextSearch=a;break;case"ENTERPRISESEARCH.FILTERINGFACET.DEFAULT":i.isFacet=a;break;case"ENTERPRISESEARCH.FILTERINGFACET.DISPLAYPOSITION":i.facetPosition=a;break;case"ENTERPRISESEARCH.FILTERINGFACET.ICONURL":i.facetIconUrlAttributeName=a;break;case"ENTERPRISESEARCH.FILTERINGATTRIBUTE.DEFAULT":i.isFilteringAttribute=a;break;case"ENTERPRISESEARCH.FILTERINGATTRIBUTE.DISPLAYPOSITION":i.facetPosition=a;break;case"ENTERPRISESEARCH.FILTERINGATTRIBUTE.ICONURL":i.facetIconUrlAttributeName=a;break;case"ENTERPRISESEARCH.DISPLAYORDER":i.displayOrder=a;break;default:if(e.startsWith("UI")||e.startsWith("OBJECTMODEL")||e.startsWith("SEMANTICS")){n._setAnnotationValue(i.annotationsAttr,e,a)}else{i.unknownAnnotation.push(t.$(this))}}}}});const c=i.annotationsAttr.UI&&i.annotationsAttr.UI.IDENTIFICATION;if(c){if(c.POSITION!==undefined){i.displayOrder=c.POSITION}else if(Array.isArray(c)){for(let e=0;e<c.length;e++){if(c[e].TYPE==undefined&&c[e].POSITION!==undefined){i.displayOrder=c[e].POSITION;break}}}}})});await Promise.all(r);return a}_getValueFromElement(e,t){const n=t.$(e);const a=n.text();if(a&&a.trim().length>0){return a}try{if(n.attr("String")!==undefined){return n.attr("String")}else if(n.attr("Decimal")!==undefined){const e=Number.parseFloat(n.attr("Decimal")||"");if(!isNaN(e)){return e}}else if(n.attr("Int")!==undefined){const e=Number.parseInt(n.attr("Int")||"",10);if(!isNaN(e)){return e}}else if(n.attr("Bool")!==undefined){return n.attr("Bool")=="true"}}catch(e){this.log.error("Error parsing annotation value: "+e.toString())}}_parseEntityContainer(e,t,n,a){const i=this;e.find("EntityContainer>EntitySet").each(function(){if(a.$(this).attr("Name")&&a.$(this).attr("EntityType")){const e=a.$(this).attr("Name")||"";const r=a.$(this).attr("EntityType")||"";const o=r.slice(r.lastIndexOf(".")+1);const c=t[o];if(c===undefined){throw"EntityType "+o+" has no corresponding meta data!"}const u=i.sina.createDataSource({id:e,label:c.labelResourceBundle||c.label||e,labelPlural:c.labelResourceBundle||c.labelPlural||c.label||e,icon:c.icon||"",type:s.BusinessObject,attributesMetadata:[{id:"dummy"}]});u.annotations=c.annotations;n.dataSourceMap[u.id]=u;n.dataSourcesList.push(u);c.name=e;c.dataSource=u;n.businessObjectMap[e]=c;n.businessObjectList.push(c)}})}}var d={__esModule:true};d.MetadataParserXML=E;return d});
//# sourceMappingURL=MetadataParserXML.js.map