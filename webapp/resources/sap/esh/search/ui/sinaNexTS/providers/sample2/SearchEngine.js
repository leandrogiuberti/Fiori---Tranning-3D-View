/*!
 * SAPUI5
 * Copyright (c) 2025 SAP SE or an SAP affiliate company. All rights reserved.
 * 
 */
sap.ui.define(["../../sina/SearchQuery","./DataSourceService","../../sina/FacetType","../../sina/SuggestionType","./RecordService","./FacetService","./Util","../../sina/ComparisonOperator","../../sina/LogicalOperator"],function(e,t,a,r,i,s,c,o,n){"use strict";const u=e["SearchQuery"];const l=t["DataSourceService"];const S=a["FacetType"];const h=r["SuggestionType"];const d=i["RecordService"];const g=s["FacetService"];const f=c["getMatchedStringValues"];const m=c["formatHighlightedValue"];const p=c["isValuePairMatched"];const y=c["isStarString"];const T=o["ComparisonOperator"];const v=n["LogicalOperator"];class b{dataSourceService;recordService;facetService;historySearchTerms=[];sina;dataSourceIds;constructor(e,t){this.sina=e;this.dataSourceIds=t}async initAsync(e){this.sina=e??this.sina;this.dataSourceService=new l(this.sina,this.dataSourceIds);this.recordService=new d(this.sina,this.dataSourceIds);this.facetService=new g(this.sina,this.dataSourceIds,this);await this.loadData()}async loadData(){await this.dataSourceService.loadDataSources();await this.recordService.loadRecords()}async search(e){await this.recordService.loadRecords();if(!y(e.filter.searchTerm)&&!this.historySearchTerms.includes(e.filter.searchTerm)){this.historySearchTerms.push(e.filter.searchTerm)}const t=this.recordService.getResponse(e);return await this.createSinaSearchResultSet(e,t)}async createSinaSearchResultSet(e,t){const a=[];for(const r of t.resultsToDisplay){a.push(await this.createSinaSearchResultSetItem(e,r))}const r=await this.createSinaFacets(e,t);return this.sina._createSearchResultSet({query:e,title:"Search Results",items:a,facets:r,totalCount:t.totalCount})}async createSinaSearchResultSetItem(e,t){const a=[];const r=[];const i=[];const s=this.dataSourceService.getDataSourceById(t.dataSourceId).attributesMetadata;s.forEach(s=>{const c=this.createSinaSearchResultSetItemSingleAttribute(s,t,e);if(c!==undefined){a.push(c);if("Title"in c.metadata.usage){r.push(c)}if("Detail"in c.metadata.usage){i.push(c)}}});const c=this.createSinaNavigationTarget(t);const o=this.sina._createSearchResultSetItem({dataSource:this.sina.getDataSource(t.dataSourceId),attributes:a,titleAttributes:r,detailAttributes:i,defaultNavigationTarget:c,navigationTargets:[]});o._private.allAttributesMap=a.reduce((e,t)=>{e[t.id]=t;return e},{});const n=this.sina._createItemPostParser({searchResultSetItem:o});return await n.postParseResultSetItem()}createSinaSearchResultSetItemSingleAttribute(e,t,a){const r=t.valueMap[e.id]?.stringValue;const i=t.valueMap[e.id]?.rawValue;if(r===undefined){return undefined}const s=p(r,a.filter.searchTerm,T.Co);const c=this.sina._createSearchResultSetItemAttribute({id:e.id,label:e.label,metadata:e,value:i,valueFormatted:r,valueHighlighted:s?m(r,a.filter.searchTerm):undefined,isHighlighted:s,groups:[]});return c}createSinaNavigationTarget(e){const t=this.dataSourceService.getDataSourceById(e.dataSourceId);const a=t.defaultNavigationTarget?.targetUrl||"";const r="https://sap.com?";const i=a.replace(/{([^}]+)}/g,(t,a)=>e.valueMap[a]?.stringValue||"");return this.sina.createNavigationTarget({text:t.defaultNavigationTarget?.text,targetUrl:r+i,target:t.defaultNavigationTarget?.target||"_self"})}async createSinaFacets(e,t){const a=[];const r=this.facetService.createFacetsByDataSourceId(e.filter.dataSource.id,t.results)?.facets;if(!r){return[]}for(let t=0;t<r.length;t++){const i=r[t];if(i.type===S.DataSource){a.push(this.createSinaDataSourceFacet(e,i))}else{if(e.filter.dataSource.type===e.sina.DataSourceType.Category||e.filter.dataSource.type===e.sina.DataSourceType.UserCategory){continue}a.push(this.createSinaChartFacet(e,i))}}return Promise.all(a)}async createSinaDataSourceFacet(e,t){const a=this.sina.createDataSourceQuery({dataSource:e.filter.dataSource,filter:e.filter.clone()});const r=[];for(let e=0;e<t.items.length;e++){const a=t.items[e];let i=this.sina.getDataSource(a.rawValueLow);if(!i){i=this.sina.createDataSource({type:this.sina.DataSourceType.Category,id:a.rawValueLow,label:a.description})}r.push(this.sina._createDataSourceResultSetItem({dataSource:i,dimensionValueFormatted:i.labelPlural,measureValue:a.count,measureValueFormatted:a.count.toString()}))}const i=this.sina._createDataSourceResultSet({title:e.filter.dataSource.label,items:r,query:a,facetTotalCount:undefined});if(e instanceof u){a._setResultSet(i)}return Promise.resolve(i)}createSinaChartFacet(e,t){const a=this.sina.getDataSource(e.filter.dataSource.id);const r=t.id;const i=a.getAttributeMetadata(r);let s=e;if(e instanceof u){const r=e.filter.clone();r.setDataSource(a);r.setRootCondition(e.filter.rootCondition.clone());s=this.sina.createChartQuery({filter:r,dimension:t.id})}const c=this.sina._createChartResultSet({title:i.label,items:this.createSinaChartResultSetItems(e,t),query:s,facetTotalCount:99999});if(e instanceof u){return s._setResultSet(c)}return Promise.resolve(c)}async chart(e){await this.recordService.loadRecords();const t=this.sina.getDataSource(e.filter.dataSource.id);const a=e.dimension;const r=t.getAttributeMetadata(a);const i=this.recordService.getResponse(e);const s=this.facetService.createAttributeFacetSet(i.results,[r],e.top);if(s&&s.facets.length>0){return this.sina._createChartResultSet({title:r.label,items:this.createSinaChartResultSetItems(e,s.facets[0]),query:e,facetTotalCount:99999})}}createSinaChartResultSetItems(e,t){const a=[];for(let e=0;e<t.items.length;e++){const r=t.items[e];if(typeof r.rawValueHigh!=="string"&&typeof r.rawValueLow!=="string"){const e=[];e.push(this.sina.createSimpleCondition({attribute:t.id,operator:T.Ge,value:r.rawValueLow}));e.push(this.sina.createSimpleCondition({attribute:t.id,operator:T.Le,value:r.rawValueHigh}));a.push(this.sina._createChartResultSetItem({filterCondition:this.sina.createComplexCondition({attributeLabel:t.label,valueLabel:r.description,operator:v.And,conditions:e}),dimensionValueFormatted:r.description,measureValue:r.count,measureValueFormatted:r.stringValueLow}))}else{a.push(this.sina._createChartResultSetItem({filterCondition:this.sina.createSimpleCondition({attributeLabel:t.label,attribute:t.id,operator:T.Eq,value:r.rawValueLow,valueLabel:r.description}),dimensionValueFormatted:r.description,measureValue:r.count,measureValueFormatted:r.stringValueLow}))}}return a}async suggestion(e){await this.recordService.loadRecords();let t;let a=[];switch(e.types[0]){case h.DataSource:t=this.dataSourceService.getResponse(e);a=await this.createSinaDataSourceSuggestions(e,t);break;case h.SearchTerm:t=this.recordService.getResponse(e);a=await this.createSinaSearchTermSuggestions(e,t);break;case h.Object:t=this.recordService.getResponse(e);a=await this.createSinaObjectSuggestions(e,t);break;default:}return this.sina._createSuggestionResultSet({title:"Suggestions",query:e,items:a})}async createSinaDataSourceSuggestions(e,t){const a=[];t.results.map(t=>{a.push(this.sina._createDataSourceSuggestion({calculationMode:this.sina.SuggestionCalculationMode.Data,dataSource:t,label:m(t.labelPlural||t.label,e.filter.searchTerm)}))});return a}async createSinaSearchTermSuggestions(e,t){const a=[];t.resultsToDisplay.forEach(t=>{const r=e.filter.clone();const i=this.sina.getDataSource(t.dataSourceId);r.setDataSource(i);a.push(this.sina._createSearchTermSuggestion({calculationMode:this.sina.SuggestionCalculationMode.Data,searchTerm:f(t.stringValues,e.filter.searchTerm)[0],filter:e.filter,label:m(f(t.stringValues,e.filter.searchTerm)[0],e.filter.searchTerm),childSuggestions:[this.sina._createSearchTermAndDataSourceSuggestion({calculationMode:this.sina.SuggestionCalculationMode.Data,searchTerm:f(t.stringValues,e.filter.searchTerm)[0],filter:r,dataSource:i,label:m(f(t.stringValues,e.filter.searchTerm)[0],e.filter.searchTerm)})]}))});if(!y(e.filter.searchTerm)){f(this.historySearchTerms,e.filter.searchTerm).forEach(t=>{a.push(this.sina._createSearchTermSuggestion({calculationMode:this.sina.SuggestionCalculationMode.History,searchTerm:t,filter:e.filter,label:m(t,e.filter.searchTerm)}))})}return a}async createSinaObjectSuggestions(e,t){const a=[];for(const r of t.resultsToDisplay){a.push(this.sina._createObjectSuggestion({calculationMode:this.sina.SuggestionCalculationMode.Data,label:"",object:await this.createSinaSearchResultSetItem(e,r)}))}return a}}var D={__esModule:true};D.SearchEngine=b;return D});
//# sourceMappingURL=SearchEngine.js.map