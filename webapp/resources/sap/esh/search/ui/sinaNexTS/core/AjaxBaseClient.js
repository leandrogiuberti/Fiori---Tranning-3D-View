/*!
 * SAPUI5
 * Copyright (c) 2025 SAP SE or an SAP affiliate company. All rights reserved.
 * 
 */
sap.ui.define(["./Log","./ajax","./ajaxUtil","./core","./defaultAjaxErrorFactory","./errors"],function(e,t,s,r,a,o){"use strict";const i=e["Log"];const n=t["applyResponseFormattersAndUpdateJSON"];const h=t["request"];const c=s["addEncodedUrlParameters"];const u=r["isBrowserEnv"];const f=a["createDefaultAjaxErrorFactory"];const d=o["ResponseFormatError"];const l=o["LanguageHeaderError"];class p{handleCookies;cookieStore={};csrf;csrfByPassCache;csrfToken;csrfFetchRequest;csrfFetchRequestPromise;getLanguage;authorization;requestFormatters=[];responseFormatters=[];defaultParameters={};errorFactories=[];errorFormatters=[];log;constructor(e){this.csrf=e.csrf;this.csrfByPassCache=e.csrfByPassCache||false;this.csrfToken=null;this.csrfFetchRequest=e.csrfFetchRequest||null;this.getLanguage=e?.getLanguage;this.authorization=undefined;if(e.authorization){this.authorization={user:e.authorization.user,password:e.authorization.password}}this.requestFormatters=e.requestFormatters??[];this.responseFormatters=e.responseFormatters??[];this.defaultParameters=e.defaultParameters??{};this.errorFactories=e.errorFactories??[f()];this.errorFormatters=e.errorFormatters||[];this.handleCookies=!u();this.log=new i("ajax base client")}getJsonHeaders(){const e={"Content-Type":"application/json",Accept:"application/json"};this.addLanguageToHeader(e);this.addDefaultHeaders(e);return e}getXmlHeaders(){const e={"Content-Type":"application/xml",Accept:"application/xml"};this.addLanguageToHeader(e);this.addDefaultHeaders(e);return e}addDefaultHeaders(e){e["Cache-Control"]="no-cache"}addLanguageToHeader(e){if(typeof this.getLanguage==="function"){try{e["Accept-Language"]=this.getLanguage()}catch(e){throw new l({previous:e})}}}async getJson(e){const t=await this.request({headers:this.getJsonHeaders(),method:"GET",url:e});try{t.data=JSON.parse(t.data)}catch(e){if(e.name==="SyntaxError"){throw new d(e,"JSON",t.data)}else{throw e}}return t}async postJson(e,t){const s=await this.request({headers:this.getJsonHeaders(),method:"POST",url:e,data:JSON.stringify(t)});try{if(s.data?.length>0){s.data=JSON.parse(s.data)}}catch(e){if(e.name==="SyntaxError"){throw new d(e,"JSON",s.data)}else{throw e}}return s}async mergeJson(e,t){const s=await this.request({headers:this.getJsonHeaders(),method:"MERGE",url:e,data:JSON.stringify(t)});try{if(s.data?.length>0){s.data=JSON.parse(s.data)}}catch(e){if(e.name==="SyntaxError"){throw new d(e,"JSON",s.data)}else{throw e}}return s}async getXML(e){const t=await this.request({headers:this.getXmlHeaders(),method:"GET",url:e});return t.data}fetchCsrf(){if(this.csrfFetchRequestPromise){return this.csrfFetchRequestPromise}this.csrfFetchRequest.headers=this.csrfFetchRequest.headers||{};this.csrfFetchRequest.headers["x-csrf-token"]="fetch";this.csrfFetchRequest.parameters=this.csrfFetchRequest.parameters||{};if(this.csrfByPassCache){this.csrfFetchRequest.parameters._=Date.now()}this.csrfFetchRequestPromise=this.requestPlain(this.csrfFetchRequest).then(function(e){this.csrfFetchRequestPromise=null;this.csrfToken=e.headers["x-csrf-token"];return e}.bind(this));return this.csrfFetchRequestPromise}async requestWithCsrf(e,t){if(c(this.csrfFetchRequest.url,this.csrfFetchRequest.parameters)===c(e.url,e.parameters)){return await this.fetchCsrf()}if(t&&!this.csrfToken){await this.fetchCsrf()}e.headers=e.headers||{};e.headers["x-csrf-token"]=this.csrfToken;const s=await this.requestPlain(e);const r=s?.headers["x-csrf-token"];if(t&&typeof r==="string"&&r.toLowerCase()==="required"){await this.fetchCsrf();return await this.requestWithCsrf(e,false)}return s}createUrlMatchingResponseFormatter(e,t){const s=(s,r)=>{if(s.url.indexOf(e)!==0){return r}return t(s,r)};this.addResponseFormatter(s);return{delete:()=>this.removeResponseFormatter(s)}}addResponseFormatter(e){this.responseFormatters.push(e)}removeResponseFormatter(e){const t=this.responseFormatters.indexOf(e);if(t>=0){this.responseFormatters.splice(t)}}removeAllResponseFormatters(){this.responseFormatters=[]}applyRequestFormatters(e){for(const t of this.requestFormatters){e=t(e)}return e}applyResponseFormatters(e,t){return n(e,t,this.responseFormatters)}setBasicAuth(e){e.headers=Object.assign({},e.headers);if(this.authorization!==undefined){if(typeof Buffer==="function"){e.headers.Authorization="Basic "+Buffer.from(this.authorization.user+":"+this.authorization.password).toString("base64")}else if(window&&typeof window.btoa==="function"){e.headers.Authorization="Basic "+window.btoa(this.authorization.user+":"+this.authorization.password)}}}async request(e){const t=await this.requestInternal(e);this.checkForErrors(e,t);return t}async requestInternal(e){this.setBasicAuth(e);if(!this.csrf){return await this.requestPlain(e)}if(!this.csrfFetchRequest){this.csrfFetchRequest=e}return await this.requestWithCsrf(e,true)}saveCookies(e){const t=e?.headers["set-cookie"];if(!t){return}for(const e of t){const t=e.split(";");if(t.length===0){continue}const s=t[0];const r=s.indexOf("=");if(r<0){continue}const a=s.slice(0,r).trim();if(a.length===0){continue}const o=s.slice(r+1).trim();if(o.length===0){continue}this.cookieStore[a]=o}}pasteCookies(e){const t=Object.entries(this.cookieStore);if(t.length===0){return}e.headers=e.headers||{};e.headers["Cookie"]=t.map(([e,t])=>`${e}=${t}`).join(";")}addDefaultParameters(e){for(const[t,s]of Object.entries(this.defaultParameters)){e.parameters=e.parameters||{};if(typeof e.parameters[t]!=="undefined"){continue}e.parameters[t]=s}}applyErrorFormatters(e,t,s){for(const r of this.errorFormatters){s=r(e,t,s)}return s}checkForErrors(e,t){for(const s of this.errorFactories){let r;try{r=s(e,t)}catch(e){this.log.error(`ajax error factory raised exception ${e}`)}if(r){r=this.applyErrorFormatters(e,t,r);throw r}}}async requestPlain(e){this.addDefaultParameters(e);if(this.handleCookies){this.pasteCookies(e)}e=this.applyRequestFormatters(e);let t=await h(e);t=this.applyResponseFormatters(e,t);if(this.handleCookies){this.saveCookies(t)}return t}}var m={__esModule:true};m.AjaxBaseClient=p;return m});
//# sourceMappingURL=AjaxBaseClient.js.map