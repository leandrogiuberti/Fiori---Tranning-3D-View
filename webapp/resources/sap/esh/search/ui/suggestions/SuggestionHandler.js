/*!
 * SAPUI5
 * Copyright (c) 2025 SAP SE or an SAP affiliate company. All rights reserved.
 * 
 */
sap.ui.define(["sap/base/Log","../i18n","./AppSuggestionProvider","./RecentlyUsedSuggestionProvider","./SinaSuggestionProvider","./SuggestionType","./TimeMerger","sap/esh/search/ui/SearchHelper","../eventlogging/UserEvents","sap/ui/core/Element"],function(e,t,s,i,o,r,n,g,u,a){"use strict";function l(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}const c=l(t);const h=l(s);const d=l(i);const p=l(o);const S=r["Type"];const m=r["SuggestionType"];const f=l(n);const y=u["UserEventType"];class T{_oLogger;model;suggestionProviders;keyboardRelaxationTime;uiUpdateInterval=500;uiClearOldSuggestionsTimeOut=1e3;recentlyUsedSuggestionProvider;appSuggestionProvider;timeMerger;suggestionProvidersPromise;sinaNext;firstInsertion;busyIndicator;performanceLoggerSuggestionMethods;clearSuggestionTimer;suggestionResultSetCounter;suggestionHeaders;generatedPositions;doSuggestionInternalDelayed;constructor(t){this._oLogger=e.getLogger("sap.esh.search.ui.suggestions.SuggestionHandler");this.model=t.model;this.suggestionProviders=[];this.keyboardRelaxationTime=this.model.config.suggestionKeyboardRelaxationTime;if(this.supportsRecentlyUsedSuggestions()){this.recentlyUsedSuggestionProvider=new d({model:this.model,suggestionHandler:this})}this.appSuggestionProvider=new h({model:this.model,suggestionHandler:this});this.doSuggestionInternalDelayed=g.delayedExecution(this.doSuggestionInternal.bind(this),this.keyboardRelaxationTime);this.timeMerger=new f;this.performanceLoggerSuggestionMethods=[]}supportsRecentlyUsedSuggestions(){if(!this.model.config.bRecentSearches)return false;return true}abortSuggestions(e){if(e===undefined||e===true){this.model.setProperty("/suggestions",[]);this.model.setProperty("/isBusySuggestions",false)}if(this.clearSuggestionTimer){clearTimeout(this.clearSuggestionTimer);this.clearSuggestionTimer=null}this.doSuggestionInternalDelayed.abort();this.getSuggestionProviders().then(e=>{for(let t=0;t<e.length;++t){const s=e[t];s.abortSuggestions()}this.timeMerger.abort();for(const e of this.performanceLoggerSuggestionMethods){this.model.config.performanceLogger?.leaveMethod({name:e})}this.performanceLoggerSuggestionMethods=[]})}getSuggestionProviders(){if(this.suggestionProvidersPromise){return this.suggestionProvidersPromise}this.suggestionProvidersPromise=this.model.initAsync().then(()=>{this.sinaNext=this.model.sinaNext;const e=[];if(this.model.config.isUshell){e.push(this.appSuggestionProvider)}if(this.supportsRecentlyUsedSuggestions()){e.push(this.recentlyUsedSuggestionProvider)}if(!this.model.config.searchBusinessObjects){return Promise.resolve(e)}e.push(...this.createSinaSuggestionProviders());return Promise.resolve(e)});return this.suggestionProvidersPromise}createSinaSuggestionProviders(){const e=[{suggestionTypes:[S.SearchTermHistory]},{suggestionTypes:[S.SearchTermData]},{suggestionTypes:[S.DataSource]}];if(this.model.config.boSuggestions){e.push({suggestionTypes:[S.Object]})}if(this.model.config.aiSuggestions){e.push({suggestionTypes:[S.SearchTermAI]})}const t=[];for(let s=0;s<e.length;++s){const i=e[s];t.push(new p({model:this.model,sinaNext:this.sinaNext,suggestionTypes:i.suggestionTypes,suggestionHandler:this}))}return t}isSuggestionPopupVisible(){const e=document.querySelectorAll(".searchSuggestion");return Array.from(e).some(e=>e.offsetParent!==null)}doSuggestion(e){if(e?.searchTerm?.toLocaleLowerCase().indexOf("/o")===0||e?.searchTerm?.toLocaleLowerCase().indexOf("/n")===0){this.abortSuggestions(true);return}const t=e?.searchTerm?.length===0;this.abortSuggestions(t);this.doSuggestionInternalDelayed(e)}autoSelectAppSuggestion(e){return this.appSuggestionProvider.getSuggestions(e).then(function(e){return e[0]})}doSuggestionInternal(e){this.firstInsertion=true;this.busyIndicator=false;this.model.setProperty("/isBusySuggestions",false);const t=this.model.getProperty("/uiFilter/searchTerm");if(t.trim()==="*"){this.insertSuggestions([],0);return}const s=`Suggestions for term ${t}`;this.performanceLoggerSuggestionMethods.push(s);this.model.config.performanceLogger?.enterMethod({name:s},{isSearch:true,comments:`suggestion term: ${t}`});this.model.eventLogger.logEvent({type:y.SUGGESTION_REQUEST,suggestionTerm:this.model.getProperty("/uiFilter/searchTerm"),dataSourceKey:this.model.getProperty("/uiFilter/dataSource").id});this.getSuggestionProviders().then(t=>{const s=[];let i=t.length;for(let i=0;i<t.length;++i){const o=t[i];s.push(o.getSuggestions(e))}if(this.isSuggestionPopupVisible()){if(this.clearSuggestionTimer){clearTimeout(this.clearSuggestionTimer)}this.clearSuggestionTimer=window.setTimeout(()=>{this.clearSuggestionTimer=null;this.insertSuggestions([],i)},this.uiClearOldSuggestionsTimeOut)}else{this.insertSuggestions([],i)}this.timeMerger.abort();this.timeMerger=new f(s,this.uiUpdateInterval);this.timeMerger.process(t=>{i-=t.length;const s=[];for(let i=0;i<t.length;++i){const o=t[i];if(o&&o instanceof Error){this._oLogger.error("A suggestion provider reported an error while getting suggestions for term '"+e.searchTerm+"'\n"+o.stack||o+"");continue}if(typeof o!=="object"){this._oLogger.error("A suggestion provider returned a bad response "+e.searchTerm+"'\n"+o);continue}s.push(...o)}if(i>0&&s.length===0){return}if(this.clearSuggestionTimer){clearTimeout(this.clearSuggestionTimer);this.clearSuggestionTimer=null}this.insertSuggestions(s,i);if(i===0){for(const e of this.performanceLoggerSuggestionMethods){this.model.config.performanceLogger?.leaveMethod({name:e})}this.performanceLoggerSuggestionMethods=[]}})}).catch(()=>{for(const e of this.performanceLoggerSuggestionMethods){this.model.config.performanceLogger?.leaveMethod({name:e})}this.performanceLoggerSuggestionMethods=[]})}generateSuggestionHeader(e){const t={};switch(e.uiSuggestionType){case S.App:t.label=c.getText("label_apps");break;case S.DataSource:t.label=c.getText("searchIn");break;case S.SearchTermData:case S.SearchTermHistory:t.label=c.getText("searchFor");break;case S.SearchTermAI:t.label=c.getText("searchTermAIHeader");t.helpLink=this.model.config.aiSuggestionsHeaderHelpLink;break;case S.Object:t.label=e.dataSource.labelPlural;t.dataSource=e.dataSource;break}if(e.isRecentEntry){t.label=c.getText("label_recently_used")}t.position=e.position;t.suggestionResultSetCounter=this.suggestionResultSetCounter;t.uiSuggestionType=S.Header;t.uiSuggestionTypeOfSuggestionsInSection=e.uiSuggestionType;return t}enableBusyIndicator(e,t){if(t){e.push({position:m.properties[S.BusyIndicator].position,uiSuggestionType:S.BusyIndicator});return}for(let t=0;t<e.length;++t){const s=e[t];if(s.uiSuggestionType===S.BusyIndicator){e.splice(t,1);return}}}checkDuplicate(e,t){const s=function(e){return e.uiSuggestionType===S.SearchTermHistory||e.uiSuggestionType===S.SearchTermData&&!e.dataSource};if(!s(t)){return{action:"append"}}for(let i=0;i<e.length;++i){const o=e[i];if(!s(o)){continue}if(t.searchTerm===o.searchTerm){if(t.grouped&&t.uiSuggestionType===S.SearchTermData&&o.uiSuggestionType===S.SearchTermHistory){return{action:"replace",index:i}}return{action:"skip"}}}return{action:"append"}}insertSuggestions(e,t){let s=this.model.getProperty("/suggestions").slice();s=this.insertIntoSuggestionList(e,s);if(!this.busyIndicator&&t>0){if(!this.model.config.isWebCompSearchFieldGroupEnabled()){this.enableBusyIndicator(s,true)}this.busyIndicator=true;this.model.setProperty("/isBusySuggestions",true)}if(this.busyIndicator&&t===0){if(!this.model.config.isWebCompSearchFieldGroupEnabled()){this.enableBusyIndicator(s,false)}this.busyIndicator=false;this.model.setProperty("/isBusySuggestions",false)}this.sortSuggestions(s);this.limitSuggestions(s);this.updateSuggestions(s)}insertIntoSuggestionList(e,t){let s=false;if(this.firstInsertion){this.firstInsertion=false;s=true}if(s){t=[];this.suggestionHeaders={};this.suggestionResultSetCounter=0;this.generatedPositions={maxPosition:m.properties[S.Object].position,position:{}}}this.suggestionResultSetCounter+=1;for(let s=0;s<e.length;++s){const i=e[s];if(i.uiSuggestionType===S.Object&&!i.isRecentEntry){let e=this.generatedPositions.position[i.dataSource.id];if(!e){this.generatedPositions.maxPosition+=1;e=this.generatedPositions.maxPosition;this.generatedPositions.position[i.dataSource.id]=e}i.position=e}i.suggestionResultSetCounter=this.suggestionResultSetCounter;i.resultSetPosition=s;const o=this.checkDuplicate(t,i);switch(o.action){case"append":t.push(i);break;case"skip":continue;case"replace":t.splice(o.index,1,i);break}if(this.isHeaderGenerationEnabled()&&!this.suggestionHeaders[i.position]){t.push(this.generateSuggestionHeader(i));this.suggestionHeaders[i.position]=true}}return t}isHeaderGenerationEnabled(){if(this.model.getDataSource()===this.model.appDataSource){return false}if(!this.model.config.boSuggestions&&this.model.getDataSource().type===this.sinaNext.DataSourceType.BusinessObject){return false}return true}sortSuggestions(e){e.sort(function(e,t){let s=e.position-t.position;if(s!==0){return s}if(e.uiSuggestionType===S.Header){return-1}if(t.uiSuggestionType===S.Header){return 1}if(e.grouped&&!t.grouped){return-1}if(!e.grouped&&t.grouped){return 1}s=e.suggestionResultSetCounter-t.suggestionResultSetCounter;if(s!==0){return s}s=e.resultSetPosition-t.resultSetPosition;return s})}getSuggestionLimit(e){const t=m.properties[e];if(typeof t==="undefined"){return Infinity}let s;if(this.model.getDataSource()===this.model.sinaNext.allDataSource||this.model.getDataSource()===this.model.favDataSource){s=t.limitDsAll}else{s=t.limit}return s}limitSuggestions(e){const t={};for(let s=0;s<e.length;++s){const i=e[s];let o=i.uiSuggestionType;if(o===S.SearchTermHistory){o=S.SearchTermData}const r=this.getSuggestionLimit(o);let n=t[o];if(typeof n==="undefined"){n=0;t[o]=n}if(n>=r){e.splice(s,1);--s;continue}t[o]=n+1}}updateSuggestions(e){const t="searchFieldInShell-input";let s=a.getElementById(t);if(!s){s=this.model.getProperty("/inputHelp")}let i;if(!this.model.config.isWebCompSearchFieldGroupEnabled()){const e=s.getSuggestionRows();for(let t=0;t<e.length;++t){const s=e[t];const o=s.getBindingContext().getObject();if(s.getSelected()){i=o.key}}}this.model.setProperty("/suggestions",e);if(!this.model.config.isWebCompSearchFieldGroupEnabled()){if(!i){return}window.setTimeout(()=>{const e=s.getSuggestionRows();for(let t=0;t<e.length;++t){const o=e[t];const r=o.getBindingContext().getObject();if(r.key===i){s["_oSuggPopover"]._iPopupListSelectedIndex=t;o.setSelected(true);o.rerender()}}},100)}}}return T});
//# sourceMappingURL=SuggestionHandler.js.map