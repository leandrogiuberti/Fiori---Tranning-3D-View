sap.ui.define(["sap/ui/base/Object","sap/base/util/extend","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger"],function(e,t,i,o){"use strict";var n=new o("detailTemplates.DiscardEditHandler").getLogger();function r(e,t,o,r){var a=t.oComponentUtils.isDraftEnabled();var s=t.oComponentUtils.getCRUDActionHandler();var c=t.oServices.oApplication.getBusyHelper();var l=e.getView();var u=l.getModel("ui");var f=t.oComponentUtils.getTemplatePrivateModel();var p=f.setProperty.bind(f,"/objectPage/cancelEnabled");var g;var v;var d=false;var C=false;var m;var D;if(a&&t.oComponentUtils.getViewLevel()!==1){D=Function.prototype}function y(){D();m=null;D=null}function E(){C=false;if(d){g.close()}else{y()}}function T(e,o){if(!v){v=t.oCommonUtils.getDialogFragmentAsync("sap.suite.ui.generic.template.fragments.DiscardEditPopover",{onDiscardConfirm:function(){if(!d||C){return}m();p(true)},beforeClose:function(){d=false;if(!C){y()}},afterClose:function(){p(true);setTimeout(function(){var t=i.getControlWithFocus();if(t&&t.isFocusable()){n.debug("Discard draft is not confirmed. Focus will stay on "+t.getId())}else if(e.isFocusable()){n.debug("Setting back focus on the Cancel button");i.focusUI5Control(e)}else{n.debug("Focus not set here. Should be handled elsewhere.")}},0)}},"discard",function(e,t){t.setProperty("/placement",sap.m.PlacementType.Top)})}v.then(function(i){d=true;g=i;var n=g.getModel("discard");var r=t.oCommonUtils;if(a&&o){n.setProperty("/text",r.getText("CANCEL_AND_DISCARD"))}else if(!a&&o){n.setProperty("/text",r.getText("CANCEL_AND_DISCARD_ND"))}else{n.setProperty("/text",r.getText("DISCARD_EDIT"))}p(false);g.openBy(e)})}function A(){if(a){var i=l.getBindingContext();return t.oServices.oApplication.getNavigateAfterDraftCancelPromise(i).then(function(i){return function(){t.oServices.oViewDependencyHelper.setRootPageToDirty();t.oServices.oViewDependencyHelper.unbindChildren(e.getOwnerComponent());t.oServices.oApplication.invalidatePaginatorInfo();i()}})}return Promise.resolve(function(){if(u.getProperty("/createMode")){var i=e.getOwnerComponent().getModel("_templPrivGlobal");var o=i.getProperty("/generic/FCL");return o&&o.highestViewLevel===1?t.oServices.oNavigationController.navigateToRoot():t.oServices.oNavigationController.navigateBack()}})}function P(){return new Promise(function(e){if(a){var i=l.getBindingContext();var o=i.getPath();s.hasValidationMessageOnDetailsViews().then(function(i){var n=t.oServices.oApplication.getIsDraftModified(o)||i;e(n)})}else{e(t.oComponentUtils.isComponentDirty())}})}function h(){if(a){var e=l.getBindingContext();var t=e.getObject();var i=t.hasOwnProperty("HasActiveEntity")&&!e.getProperty("IsActiveEntity")&&!e.getProperty("HasActiveEntity");return i}return u.getProperty("/createMode")}function S(e,i){if(D){return Promise.reject()}if(!(t.oComponentUtils.isComponentActive()&&u.getProperty("/editable"))){return Promise.reject()}var o=new Promise(function(o,n){D=n;var r=A();var s=function(){if(e&&c.isBusy()){y();return}var n=function(){C=true;var e=r.then(function(e){var n=function(){D=o;e();s();E();if(i){t.oServices.oApplication.setNextFocus(i)}};var r;if(a){r=t.oServices.oCRUDManager.discardDraft(l.getBindingContext()).then(n);r.catch(E)}else{n()}t.oComponentUtils.cancelEdit(r);return r});c.setBusy(e)};function s(){P().then(function(e){if(e){if(u.getProperty("/createMode")){t.oServices.oApplication.showMessageToast(t.oCommonUtils.getText("ST_GENERIC_DRAFT_WITHOUT_ACTIVE_DOCUMENT_DELETED"))}else{t.oServices.oApplication.showMessageToast(t.oCommonUtils.getText("ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED"))}}})}P().then(function(t){if(e&&t){m=n;T(e,h())}else{n()}})};t.oServices.oApplication.performAfterSideEffectExecution(s)});o.catch(Function.prototype);return o}return{discardEdit:S}}return e.extend("sap.suite.ui.generic.template.detailTemplates.DiscardEditHandler",{constructor:function(e,i,o,n){t(this,r(e,i,o,n))}})});
//# sourceMappingURL=DiscardEditHandler.js.map