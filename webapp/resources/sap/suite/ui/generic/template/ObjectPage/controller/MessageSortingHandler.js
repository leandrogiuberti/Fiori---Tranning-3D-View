sap.ui.define(["sap/ui/base/Object","sap/base/util/extend","sap/ui/model/Sorter","sap/ui/core/message/MessageType","sap/suite/ui/generic/template/lib/MessageUtils","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper"],function(e,t,r,n,o,a,s){"use strict";function i(e,t,i){var l=Function.prototype;var u;var g;var f;function c(){u=Object.create(null);if(g){for(var e in g){var t=g[e];t.destroy()}}g=Object.create(null)}function d(e,r){var n=Object.create(null);var o=function(e,t,r){if(r){n[r.getId()]=t}};r.controlId=t.oCommonUtils.getPositionableControlId(e,true,o);var s=[];var i,l;var u;for(var g=r.controlId&&a.byId(r.controlId);g;g=n[u]){u=g.getId();s.push(u);i=i||a.isObjectPageSection(g)&&g;l=l||a.isSmartTable(g)&&g}s.reverse();r.pathToControlId=s;r.groupers=i?[i]:[];if(i&&l){r.groupers.push(l);if(r.message.validation){r.getItemBindingPath=Function.prototype}else{var f=I(l);if(f){var c=t.oComponentUtils.getBindingPath();var d=f.presentationControlHandler.getBindingPath();var v=c+"/"+d;r.getItemBindingPath=function(){var e=r.message.aFullTargets.find(function(e){return e.startsWith(v)});if(!e){return null}var t=e.substring(v.length);var n=t.split("/")[0];return v+n}}else{r.getItemBindingPath=Function.prototype}}}else{r.getItemBindingPath=Function.prototype}}function v(e,t){var r=u[e];if(r){t=r.message;var n=r.controlId&&r.controlIds[r.controlId];t.controlIds.some(function(e){if(e===r.controlId){n=false}else if(!r.controlIds[e]){n=true;return true}});r=!n&&r}if(!r){t=t||o.getMessageById(e);var s=Object.create(null);t.controlIds.forEach(function(e){s[e]=a.byId(e)});r={message:t,controlIds:s};d(t.controlIds,r);u[e]=r}return r}function I(e){var t=e.getId();var r=g[t];if(!r){r=M(e);g[t]=r}return r}function m(e,t){var r=e.getTitleInfoForItem(t);return r&&r.title}function p(e,t){return t&&{label:e.presentationControlHandler.getColumnLabel(t),hidden:!t.getVisible()}}function h(e,t){var r=e.table.getTable().getColumns();var n=r.find(function(e){var r=e.getLeadingProperty?e.getLeadingProperty():e.data("p13nData").leadingProperty;return r===t});return p(e,n)}function b(e,t){var r=e.columnInfo;if(r){var n=r[t];if(n){return n}}else{r=Object.create(null);e.columnInfo=r}var o=h(e,t);r[t]=o;return o}function C(e,t){var r=e.getItemBindingPath();var n=e.message.aFullTargets.find(function(e){return e.startsWith(r)});if(!n){return}var o=n.substring(r.length);if(o.startsWith("/")){o=o.substring(1)}if(!o||o.indexOf("(")>0){return}return b(t,o)}function T(e,t,r){var n=t&&t.getMessages();if(n&&n.length){var o=m(e.presentationControlHandler,t);n.forEach(function(t){var n=v(t.id,t);if(!n.controlId){d([e.table.getId()],n)}if(n.groupers[1]===e.table){var a={index:r<0?9999999:r,rowCurrentlyShown:r>=0,rowIdentifier:o,columnInfo:C(n,e)};e.messageToMsgInTableInfo[t.id]=a}})}}function M(e){var r=t.oServices.oPresentationControlHandlerFactory.getPresentationControlHandler(e);var n=r.getBinding();if(!n){return null}var a=false;var s={table:e,presentationControlHandler:r,messageToMsgInTableInfo:Object.create(null)};var i=function(){if(a){return}var e=s.messageToMsgInTableInfo;s.messageToMsgInTableInfo=Object.create(null);var t=T.bind(null,s);var n=r.getCurrentContexts()||[];n.forEach(t);for(var i in e){if(!s.messageToMsgInTableInfo[i]){var u=e[i];var g=o.getMessageById(i);u.rowCurrentlyShown=g&&g.validation;s.messageToMsgInTableInfo[i]=u}}l()};s.tableLoaded=r.getUnbusyPromise().then(i);n.attachChange(i);e.attachUiStateChange(c);s.destroy=function(){a=true;n.detachChange(i);e.detachUiStateChange(c)};return s}function y(e){var r=v(e);var n=r.groupers;switch(n.length){case 0:return t.oCommonUtils.getText("GENERIC_MESSAGE_GROUP_NAME");case 1:return n[0].getTitle();default:var o=n[0].getTitle();var a=n[1];var s=a.getHeader();var i=n[0].getSubSections();if(i.length===1){if(i[0]&&i[0].getBlocks().concat(i[0].getMoreBlocks()).length===1){return s}}return t.oCommonUtils.getText("MESSAGE_GROUP_TABLE",[o,s])}}function S(e){switch(e){case n.Error:return 1;case n.Warning:return 2;case n.Success:return 3;case n.Information:return 4;case n.None:return 5;default:return 6}}function P(e,t,r){if(!t){return r?1:0}if(!r){return-1}return a.sortChildControls(e,t,r)}function O(e,t){var r=v(e.id);var n=v(t.id);var o=r.groupers.length===n.groupers.length&&r.groupers.every(function(e,t){return n.groupers[t]===e});if(o){var s=r.getItemBindingPath();var l=n.getItemBindingPath();if(s!==l){var u=r.groupers[1];var g=I(u);var f=g&&g.messageToMsgInTableInfo[e.id];var c=g&&g.messageToMsgInTableInfo[t.id];if(f&&c){if(f.index!==c.index){return f.index-c.index}}else if(f||c){return 1-2*!c}return(""+s).localeCompare(""+l)}var d=S(e.type)-S(t.type);if(d||!(r.controlId||n.controlId)){return d||e.message.localeCompare(t.message)}}if(!o&&(r.groupers.length===1||n.groupers.length===1)&&r.groupers[0]===n.groupers[0]){return r.groupers.length-n.groupers.length}var m=r.pathToControlId;var p=n.pathToControlId;var h=Math.max(m.length,p.length);for(var b=0;b<h;b++){if(m[b]!==p[b]){var C=b===0?i:a.byId(m[b-1]);return P(C,b<m.length&&a.byId(m[b]),b<p.length&&a.byId(p[b]))}}return e.message.localeCompare(t.message)}function _(e,t,r){e.read(t,{headers:{"sap-messages":"transientOnly"},canonicalRequest:false,error:r.bind(null,null),updateAggregatedMessages:false,success:function(n){var o=n&&e._getKey(n);var a=o?e.getContext("/"+o,t):null;r(a)}})}function E(e,t,r){return new Promise(function(n){var o=i.getModel();_(o,e,function(e){if(e){T(t,e,-1)}else{r.forEach(function(e){var t=v(e);var r=t.groupers[1];var n=r&&I(r);if(!n||n.messageToMsgInTableInfo[e]){return}n.messageToMsgInTableInfo[e]={index:9999999,rowCurrentlyShown:false,rowIdentifier:"",columnInfo:C(t,n)}})}n()})})}function H(e,r,n){var o=false;e.aFullTargets.some(function(s){if(s.startsWith(n)){t.oInfoObjectHandler.executeForAllInformationObjects("smartTable",function(t){const i=!!a.byId(t.getId());if(!o&&i){var l=n+t.getNavigationProperty();if(s===l||s.startsWith(l+"(")){o=true;var u=t.getId();var g=r[u];if(g){g.messages.push(e)}else{var f=[e];g={messages:f,promise:t.getControlAsync().then(function(e){var t=I(e);return t&&t.tableLoaded.then(function(){f.forEach(function(e){var t=v(e.id,e);if(!t.controlId){d([u],t)}})})})};r[u]=g}}}},true)}return o})}function U(e,t,n,o){c();var a=Object.create(null);t.forEach(function(e){var t=e.id;v(t,e);if(e.controlIds.length===0){H(e,a,o+"/")}});var s=[];for(var i in a){s.push(a[i].promise)}var u=function(){if(f){clearTimeout(f);f=0}var o=Object.create(null);var a=Object.create(null);var s=Object.create(null);var i;t.forEach(function(e){var t=v(e.id,e);if(t.groupers.length===0){i=i||function(){f=f||setTimeout(u);n.setProperty("/messageToUpdateFunction",null)};s[e.id]=i}o[e.id]=y(e.id);a[e.id]=B(e.id,e.additionalText)});n.setProperty("/messageToGroupName",o);n.setProperty("/messageToSubtitle",a);n.setProperty("/messageToUpdateFunction",s);var l=new r("");l.fnCompare=O;e.sort(l)};return Promise.all(s).then(function(){return x().then(function(){u();l=function(){var e=n.getProperty("/heartBeat")||0;e++;n.setProperty("/heartBeat",e)};return{getSubtitle:B,getDescription:D}})})}function x(){var e=[];for(var t in g){var r=g[t];if(r){e.push(r.tableLoaded)}}return Promise.all(e).then(w)}function L(e,t){var r=a.byId(e.controlIds[0]);var n=r.getBindingContext();var o=t.presentationControlHandler.getCurrentContexts()||[];var s=-1;o.some(function(e,t){if(e===n){s=t;return true}});var i=t.presentationControlHandler.getColumnForCell(r);var l={index:s,rowCurrentlyShown:true,rowIdentifier:m(t.presentationControlHandler,n),columnInfo:p(t,i)};t.messageToMsgInTableInfo[e.id]=l;return l}function w(){var e=[];var t=Object.create(null);var r=function(r){var n=v(r);var o=n.groupers[1];var a=o&&I(o);if(a){var s=n.message;var i=a.messageToMsgInTableInfo[r];if(!(i&&i.rowCurrentlyShown)){if(s.validation){L(s,a)}else{var l=n.getItemBindingPath();if(l){var u=t[l];if(u){u.push(r)}else{u=[r];t[l]=u;var g=E(l,a,u);e.push(g)}}}}}};for(var n in u){r(n)}return Promise.all(e)}function F(e,r,n,o){const a=!Array.isArray(o);let s=a?"MSG_SUBTITLE_DEFAULT_ROW":"MSG_SUBTITLE_ROW";let i=null;let l=[];let u=e?.columnInfo?.label;if(!e.rowCurrentlyShown){s+="_HIDDEN"}if(a){l=[e.rowIdentifier];if(e.columnInfo){l.push(e.columnInfo.label);s+="_COLUMN";if(e.columnInfo.hidden&&!e.columnInfo.label){s+="_HIDDEN"}}return t.oCommonUtils.getText(s,l)}if(!u){u=r.presentationControlHandler.getColumnLabelForMessage(n)}if(o.length===1){i=o.pop();l=[i.sLabel,i.sValue];s+="_COLUMN";if(i.bHidden){s+="_HIDDEN"}}else if(o.length===0){if(!u){return}s+="_EMPTY";l=[u]}else{s+="_MORE_DETAILS"}return t.oCommonUtils.getText(s,l)}function B(e,t){var r=v(e);var n=r.groupers[1];if(!n){return t}var o=I(n);if(o){var a=o.messageToMsgInTableInfo[e];if(!a&&r.message.validation){a=L(r.message,o)}if(a&&a.index>=0){const e=o.presentationControlHandler.getItemContextForMessage(r.message);var s=o.presentationControlHandler.getRelevantColumnsForMessage(e);return F(a,o,r.message,s)}}return t}function D(e,t){const r=v(e);const n=r.groupers[1];if(!n){return t}const o=I(n);const a=o&&o.messageToMsgInTableInfo[e];if(a&&a.index>=0){const e=o.presentationControlHandler.getItemContextForMessage(r.message);const t=o.presentationControlHandler.getRelevantColumnsForMessage(e);if(Array.isArray(t)&&t.length>1){return N(a,o,r.message,t)}}return t}function N(e,r,n,o){const a="\n";const s=t.oCommonUtils.getText;const i=s("MSG_DESCRIPTION_ROW_TABLE",[r.table.getHeader()])+a;const l=(e.rowCurrentlyShown?s("MSG_DESCRIPTION_ROW"):s("MSG_DESCRIPTION_ROW_HIDDEN"))+a;let u="";let g=e?.columnInfo?.label;if(!g){g=r.presentationControlHandler.getColumnLabelForMessage(n)}let f=s("MSG_DESCRIPTION_COLUMN",[g]);for(const e of o){if(e.bHidden){u+=s("MSG_DESCRIPTION_COLUMN_VALUE_HIDDEN",[e.sLabel,e.sValue])+a}else{u+=s("MSG_DESCRIPTION_COLUMN_VALUE",[e.sLabel,e.sValue])+a}}return i+l+u+f}s.testableStatic(F,"filterHelper_getSubtitleForRow");s.testableStatic(H,"messageSortingHandler_fnFindTableForMessage");return{getPrepareMessageDisplayPromise:U}}return e.extend("sap.suite.ui.generic.template.ObjectPage.controller.MessageSortingHandler",{constructor:function(e,r,n){t(this,i(e,r,n))}})});
//# sourceMappingURL=MessageSortingHandler.js.map