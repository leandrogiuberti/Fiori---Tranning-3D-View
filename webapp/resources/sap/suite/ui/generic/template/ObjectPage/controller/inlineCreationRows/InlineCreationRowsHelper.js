sap.ui.define(["sap/ui/base/Object","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/base/util/extend","sap/suite/ui/generic/template/ObjectPage/controller/inlineCreationRows/RequiredPropHelper","sap/ui/core/Element"],function(e,t,n,i,r){"use strict";function a(e,n,a,o,s){const c="@$ui5.context.isTransient",l="@$ui5.context.isInactive",u={INLINE_CREATION_ROWS:"creationRows",INLINE_CREATION_ROWS_HIDDEN_IN_EDIT_MODE:"creationRowsHiddenInEditMode"};var d={creationRows:new Set,creationRowsHiddenInEditMode:new Set};var f={creationRows:"/editable",creationRowsHiddenInEditMode:"/createMode"};var g=new Set,v=new Map,h=new Set,I=new Map,p=new Set,C=new Map,R=new Map,b=new Set;function E(){d.creationRows.clear();d.creationRowsHiddenInEditMode.clear();Array.from(C.values()).forEach(function(e){e.onBeforeRebindObjectPage()})}function P(e){var t=e.data("isCreationAllowedByBoolAndPathRestrictions");return["true",true].includes(t)}function w(e){return e.getAllCurrentContexts().some(function(e){return e.isInactive()&&!p.has(e.getPath())})}function T(e){return n.oServices.oPresentationControlHandlerFactory.getPresentationControlHandler(e)}function m(t){var r=t.getId(),a=C.get(r);if(!a){a=new i(n,t,T(t),o,e,s);C.set(r,a)}return a}function N(e){if(!n.oComponentUtils.isDraftEnabled()){return}var i=e.getSource();var r=i.getTable();if(t.isAnalyticalTable(r)||t.isTreeTable(r)){return}var o=a(i);var s=[u.INLINE_CREATION_ROWS,u.INLINE_CREATION_ROWS_HIDDEN_IN_EDIT_MODE].includes(o);if(!s){return}i.addEventDelegate({oninput:function(){B(i)}});var c=e.getParameters().bindingParams;var l=c.events.dataReceived||Function.prototype;var d=c.events.dataRequested||Function.prototype;c.events.dataRequested=function(e){d.call(this,e);var t=a(i);var r=f[t];var o=i.getBindingContext();var s=!!o.getObject();var c=s?n.oServices.oApplication.getDraftInfoForContext(o):null;var l={"/editable":c?.bIsDraft,"/createMode":c?.bIsCreate};if(l[r]){R.set(i.getId(),F(i))}};c.events.dataReceived=function(e){l.call(this,e);var t=T(i),n=t.getBinding();_(i);if(w(n)){var r=e.getParameter("reason")==="SIDE_EFFECT_TARGET";if(r){k(i)}else{L(i.getTable());x(i,n);return}}D(i);O(i)}}function _(e){var t=e.getId();if(C.has(t)){C.get(t).onTableDataReceived()}}function B(e){var n=t.getControlWithFocus();var i=function(t){var n=t.getPath&&t.getPath();if(n&&!p.has(n)){y(e,true);p.add(n)}};var r=function(e){var t=e.getBindingContext&&e.getBindingContext();return t.isTransient&&t.isTransient()?t:false};while(n){var a=r(n);if(a&&(t.isSmartField(n)||t.isColumnListItem(n)||t.isRow(n))){i(a);break}else if(t.isSmartTable(n)){break}n=n.getParent()}}function D(t){var n=e.getModel("ui"),i=a(t),r=f[i],o=t.getId();if(n.getProperty(r)){y(t)}else{d[i].add(o)}if(!h.has(r)){n.bindProperty(r).attachChange(S.bind(null,i));h.add(r)}}function S(e,t){if(t.getSource().getValue()){var n=d[e];n.forEach(function(e){var t=r.getElementById(e);y(t).then(function(){n.delete(e)})})}}function O(t){var n=e.getBindingContext(),i=t.getId();if(I.get(i)===n){return}var r=t.data("inlineCreationRowsConfig"),a=r.creatablePath,o=a.creatable;if(typeof o==="boolean"){return}e.getModel().bindProperty(o,n).attachChange(function(e){var n=!!e.getSource().getValue();n=a.negate?!n:n;if(n){D(t)}else{k(t)}});I.set(i,n)}function y(e,t){var n=T(e);var i=n.getBinding();var r={itemsBinding:i,isLengthFinal:n.isLengthFinal(),isResponsiveTable:n.isMTable()};return new Promise(function(n){H(e).then(function(){var t;var n=e.getId();if(R.has(n)){t=R.get(n)}else{t=F(e)}return t}).then(function(a){if(t){M(i,a,true);L(e.getTable())}else{A(e,a,r)}n()})})}function A(e,t,n){var i=e.getTable();var r=n.isResponsiveTable;var a=n.itemsBinding;var o=n.isLengthFinal;var s=P(e);var c=w(a);if(o&&a.isResolved()&&s&&!c&&!a.bIsBeingDestroyed){M(a,t,!r);R.delete(e.getId());var l=L.bind(null,i);G(i,l);x(e,a)}}function x(e,t){if(g.has(t)){return}g.add(t);t.attachCreateActivate(function(t){var i=t.getParameter("context");if(i&&!p.has(i.getPath&&i.getPath())){y(e,true);p.add(i.getPath())}var r=m(e);var a=r.handleActivateRow(i);if(!a){t.preventDefault();return}var o=e.getBindingContext(),s=e.getTableBindingPath();n.oServices.oApplicationController.executeSideEffects(o,[],[s])})}function M(e,t,n){e.create(t,n,{inactive:true,changeSetId:"Create"})}function F(e){return new Promise(function(t){var i=n.oServices.oCRUDManager.getDefaultValues(e,null,true);if(i instanceof Promise){i.then(function(e){t(e)}).catch(function(){t(null)})}else{t(null)}})}function H(e){if(e.getBindingContext()){return Promise.resolve()}return new Promise(function(t){function n(i){if(!e.getBindingContext()){return}e.detachEvent("modelContextChange",n);t()}e.attachEvent("modelContextChange",n)})}function L(e){if(t.isMTable(e)){W(e)}else{U(e)}}function W(e){var t,n=e.getId(),i=j(e);if(i.length===0){return}if(v.get(n)){t=v.get(n)}else{t=i.at(0).getProperty("type");v.set(n,t)}i.forEach(function(n){q(e,n);G(n,V.bind(null,n,t))})}function j(e){var t=[];e.getItems().forEach(function(e){var n=e.getBindingContext();var i=e.getBinding("type")&&e.getBinding("type").getPath();if(n.isInactive()&&i!==l){t.push(e)}});return t}function U(e){var t=e.getId();if(b.has(t)){return}b.add(t);e.attachEvent("rowsUpdated",function(){var t=e.getRows();t.forEach(function(t){q(e,t)})})}function q(e,t){var n=e.getParent();var i=e.getColumns();var r=n.data("inlineCreationRowsConfig").nonInsertableProperties;var a=[];if(r&&r.length>0){for(var o=0;o<t.getCells().length;o++){for(var s=0;s<r.length;s++){if(r[s].PropertyPath===i[o].data("p13nData").leadingProperty){a.push(o)}}}var l=t.getCells();for(var s=0;s<a.length;s++){var u=l[a[s]];var d=u.getBinding("editable");if(d&&d.getPath()==="BINDING_PATH_TRANSIENT_CONTEXT"){return}u.bindProperty("editable",{path:c,formatter:function(e){return!e}})}}}function V(e,t){var i=e.getDeleteControl();e.bindProperty("type",{path:l,formatter:function(e){return e?"Inactive":t}});i&&i.bindProperty("visible",{path:l,formatter:function(e){return!e}});var r=e.getBindingContext().created();r&&r.then(function(){e.getSelected()&&n.oCommonUtils.setEnabledToolbarButtons(e)})}function k(e){var t=T(e),n=t.getBinding();if(n.isResolved()&&n.isLengthFinal()){n.getAllCurrentContexts().forEach(function(e){if(e.isInactive()&&!p.has(e.getPath())){e.delete()}})}}function G(e,t){var n;if(e.getDomRef()){t()}else{n=e.addEventDelegate({onAfterRendering:function(){t();e.removeEventDelegate(n)}})}}function $(e){var t=T(e),n=a(e);if(n===u.INLINE_CREATION_ROWS){t.focusOnFirstTransientRow()}else if(n===u.INLINE_CREATION_ROWS_HIDDEN_IN_EDIT_MODE){if(!w(t.getBinding())){y(e)}else{t.focusOnFirstTransientRow()}}}return{onBeforeRebindObjectPage:E,addCreationRows:y,addCreationRowsImpl:A,onBeforeRebindControl:N,handleAddEntry:$}}return e.extend("sap.suite.ui.generic.template.ObjectPage.controller.inlineCreationRows.InlineCreationRowsHelper",{constructor:function(e,t,i,r,o){n(this,a(e,t,i,r,o))}})});
//# sourceMappingURL=InlineCreationRowsHelper.js.map