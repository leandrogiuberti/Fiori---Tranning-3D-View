sap.ui.define(["sap/ui/base/Object","sap/f/FlexibleColumnLayoutSemanticHelper","sap/f/library","sap/base/util/extend","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/lib/FlexibleColumnLayoutHelper"],function(e,t,r,n,a,o){"use strict";var i=r.LayoutType;var l=2;var u=["begin","mid","end"];var s=["fullScreen","exitFullScreen","closeColumn"];var f=["messagePageBeginColumn","messagePageMidColumn","messagePageEndColumn"];function v(e){return u[e]?e:l}function c(e){return u[v(e)]+"ColumnPages"}function d(e){for(var t=0;t<u.length;t++){e(f[t],c(t))}}function L(e){return f[v(e)]}function m(e){return u[v(e)]}function C(e){var t;if(e instanceof sap.ui.table.Table){t=e.getRows()}else if(e instanceof sap.m.Table||e instanceof sap.m.List){t=e.getItems()}return t}function p(e){var t=C(e);var r=t?t[0]:false;return r}function y(e){return e&&(Array.isArray(e.FCLLayout)?e.FCLLayout.sort()[0]:e.FCLLayout)||""}function g(e,r){var n=r.oTemplateContract;var l=n.oAppComponent.getFlexibleColumnLayout();var f=t.getInstanceFor(e,l);var C=new o(n);C.setColumnDistributionModel();var g;var N;var b;var F=Object.create(null);var T=sap.ui.Device.system.phone?1:l.maxColumnsCount||3;var h=T>1&&l.initialColumnsCount===2;var P;var S=function(){var e=f.getDefaultLayouts();return[h?e.defaultTwoColumnLayoutType:e.defaultLayoutType,e.defaultTwoColumnLayoutType,e.defaultThreeColumnLayoutType]}();var R=l.displayNextObjectAfterDelete===true;function x(e){return e.fCLLevel===1||e.fCLLevel===2||e.level===0&&h}function I(e){if(e.fCLLevel===3||T===1||e.fCLLevel===0&&e.level>0){return 1}var t=l.initialColumnsCount||1;var r=Math.max(e.fCLLevel+1,t);return sap.ui.Device.system.tablet&&r>2?2:r}function E(e,t,r,n){var a=I(n);e.showBeginColumn=n.fCLLevel===0||a>1;e.showMidColumn=n.fCLLevel===1||a>1;e.showEndColumn=n.fCLLevel>1;if(a===1){e.target=t}else if(n.level===0){P=n.page.pages[0].entitySet;e.target=[t,P]}else{e.target=r.concat([t])}return c(n.fCLLevel)}function A(e,t){if(e===i.OneColumn&&h){return false}var r=t&&n.mRoutingTree[t];var a=r&&r.defaultLayoutType;if(a){return e===a}return e===S[0]||e===S[1]||e===S[2]}function V(e,t,a){var o=n.mRoutingTree[a];return o.componentCreated.then(function(n){return r.activateOneComponent(t,e,n)})}function w(e){var t=r.getCurrentIdentity();if(!t){return null}var a={};var o=true;var i=t.treeNode;while(o){var l=i.fCLLevel;var u=m(l);a[u]={route:i.sRouteName,path:e?"-":i.getPath(2,t.keys),isVisible:l>2||g.columnsVisibility[u+"Column"]};o=l===1||l===2;e=false;i=n.mRoutingTree[i.parentRoute]}return a}function B(e,t){var a=w(e.isNonDraftCreate);if(!a){return Promise.resolve()}var o=[];var i=t||a;for(var l in i){if(i[l]){var u=a[l];if(u.isVisible){o.push(V(e,u.path,u.route))}else{var s=n.oTemplatePrivateGlobalModel.getProperty("/generic/routeLevel");var f=n.mRoutingTree[u.route];var v=s===f.level?2:3+G(N);r.setVisibilityOfRoute(u.route,v)}}}return Promise.all(o).then(r.afterActivation)}function M(){return!(g.columnsVisibility.beginColumn?g.columnsVisibility.midColumn:g.columnsVisibility.midColumn&&g.columnsVisibility.endColumn)}function D(e){if(!g&&!e){return}var t=f.getCurrentUIState();var a=r.getCurrentIdentity();var o=a&&a.treeNode;if(a&&N!==t.layout){var l=A(t.layout,o.sRouteName)?null:t.layout;r.navigateByExchangingQueryParam("FCLLayout",l);return}var v=!e&&{};var c=false;u.forEach(function(e){var r=e+"Column";if(v){var a=g&&g.columnsVisibility[r]!==t.columnsVisibility[r];v[e]=a;c=c||a}if(e!=="begin"){var o={};s.forEach(function(e){o[e]=t.actionButtonsInfo[r][e]!==null});n.oTemplatePrivateGlobalModel.setProperty("/generic/FCL/"+e+"ActionButtons",o)}});g=t;if(a){var d=M();var L=o.level-(o.fCLLevel===2&&!g.columnsVisibility.endColumn);var m=L-(L>1&&!d)-(g.columnsVisibility.endColumn&&g.columnsVisibility.beginColumn&&L>2);n.oTemplatePrivateGlobalModel.setProperty("/generic/FCL/isVisuallyFullScreen",d);n.oTemplatePrivateGlobalModel.setProperty("/generic/FCL/highestViewLevel",L);n.oTemplatePrivateGlobalModel.setProperty("/generic/FCL/lowestDetailViewLevel",m)}var C=r.getActiveComponents();C.forEach(function(e){var t=F[e];var r=N;var a=n.componentRegistry[e];if(r===i.ThreeColumnsMidExpanded){var o=n.mRoutingTree[a.route];if(o.fCLLevel===0){r=i.ThreeColumnsEndExpanded}}if(t!==r){F[e]=r;if(t){a.utils.layoutChanged()}}});if(c||e){return B(e||r.getActivationInfo(),v)}}var O=false;function H(t){var a=U(t);var o=G(a);var l=[];var u=null;for(var s=t.treeNode;s.fCLLevel===1||s.fCLLevel===2;){s=n.mRoutingTree[s.parentRoute];u=r.prepareHostView(s,false,o);l.push(u)}if(h&&t.treeNode.level===0){var v=n.mRoutingTree[P];u=r.prepareHostView(v);l.push(u)}var c=async function(){if(x(t.treeNode)){N=U(t);if(!N){switch(t.treeNode.fCLLevel){case 0:var a=f.getNextUIState(0).columnsVisibility;if(a.midColumn){N=S[1]}else{N=S[0];r.navigateByExchangingQueryParam("FCLLayout",N)}break;case 1:N=S[1];break;case 2:N=S[2];break;default:}}}else{N=t.treeNode.fCLLevel===0?S[0]:i.EndColumnFullScreen}N=await C.getStoredLayout(N);e.setLayout(N);e.setAutoFocus(false);e.setRestoreFocusOnBackNavigation(true);if(t.treeNode.fCLLevel===1||t.treeNode.fCLLevel===2){var o=f.getCurrentUIState();if(o.columnsVisibility.midColumn){var l=1-o.columnsVisibility.beginColumn;for(var u=t.treeNode;u.fCLLevel>l;){u=n.mRoutingTree[u.parentRoute];t.componentsDisplayed[u.sRouteName]=1;u.display()}}}};if(O){c();return Promise.resolve()}var d=f.whenReady();l.push(d);return Promise.all(l).then(function(){O=true;c()})}function k(e){return D(e)}function U(e){return y(e.appStates)||e.treeNode.defaultLayoutType||S[v(e.treeNode.fCLLevel)]}function j(e,t,r){if(!A(t,r)){e.FCLLayout=t}}function G(e){return e===i.EndColumnFullScreen||e===i.MidColumnFullScreen}function Q(e){return e===i.ThreeColumnsBeginExpandedEndHidden||e===i.ThreeColumnsMidExpandedEndHidden}function q(e,t,n,a){var o={treeNode:e,keys:t,appStates:a};var i=r.getApplicableStateForIdentityAddedPromise(o);n.push(i)}function K(e,t,r,a){j(e,r,t.sRouteName);var o=[];if(!Q(r)){q(t,a,o,e)}if(!G(r)){for(var i=t;i.fCLLevel>0;){i=n.mRoutingTree[i.parentRoute];q(i,a,o,e)}}return Promise.all(o)}function z(e){return G(N)?X(e.fCLLevel):e.defaultLayoutType||f.getNextUIState(e.fCLLevel).layout}function J(e,t){var r=t.treeNode.fCLLevel===1&&e&&e.treeNode.parentRoute===t.treeNode.sRouteName&&e.treeNode.fCLLevel===2?g.actionButtonsInfo.endColumn.closeColumn:z(t.treeNode);return K(t.appStates,t.treeNode,r,t.keys)}function W(e,t,r){var n;if(e.treeNode.fCLLevel===t.treeNode.fCLLevel){n=N}else if(e.treeNode.fCLLevel===2){n=g.actionButtonsInfo.endColumn.closeColumn}else{n=z(t.treeNode)}return K(r,t.treeNode,n,t.keys)}function X(e){if(e===0){return i.OneColumn}else if(e===1){return i.MidColumnFullScreen}else if(e===2){return i.EndColumnFullScreen}else{return""}}function Y(e,t){var a=n.mRoutingTree[e];if(!x(a)){return null}var o=b||a.defaultLayoutType||f.getNextUIState(a.fCLLevel).layout;j(t,o,e);b=null;if(G(o)){return null}var i=[];for(var l=a.fCLLevel;l>0;l--){var u=a.parentRoute;i.push(r.addUrlParameterInfoForRoute(u,t));a=n.mRoutingTree[u]}return Promise.all(i)}function Z(e,t){if(e.treeNode.fCLLevel===0||e.treeNode.fCLLevel===3){return true}var r=U(e);var n=U(t);return G(r)===G(n)}function $(e,t,o){var i=function(){var i=m(e.fCLLevel);var l=g.actionButtonsInfo[i+"Column"][t];var u=o?n.mRoutingTree[e.parentRoute]:e;var s=r.getCurrentIdentity();var f=Object.create(null);if(t==="fullScreen"||t==="exitFullScreen"){n.oApplicationProxy.setNextFocus(function(){var e=t==="fullScreen"?"exitFullScreen":"fullScreen";var r=n.componentRegistry[s.treeNode.componentId];setTimeout(function(){a.focusControl(r.oController.createId(e))})})}var v=K(f,u,l,s.keys);var c=v.then(function(){r.navigateToIdentity({treeNode:u,keys:u===s.treeNode?s.keys:s.keys.slice(0,u.level+1),appStates:f})});n.oBusyHelper.setBusy(c)};if(o){var l=n.oNavigationControllerProxy.getCurrentIdentity();if(l.treeNode.isDraft&&l.treeNode.level===1){n.oPageLeaveHandler.performAfterDiscardOrKeepDraft(i,Function.prototype,"LeavePage")}else{n.oDataLossHandler.performIfNoDataLoss(i,Function.prototype,"LeavePage")}}else{n.oApplicationProxy.performAfterSideEffectExecution(i,true)}}function _(e){return{onCloseColumnPressed:$.bind(null,e,"closeColumn",true),onFullscreenColumnPressed:$.bind(null,e,"fullScreen",false),onExitFullscreenColumnPressed:$.bind(null,e,"exitFullScreen",false)}}n.oTemplatePrivateGlobalModel.setProperty("/generic/FCL",{});function ee(t){N=f.getNextUIState(t).layout;e.setLayout(N)}function te(){return!M()}function re(e,t){var a=0;for(var o in t){var i=n.mRoutingTree[o];if(i.level>=e.viewLevel&&t[o]===1){if(i.level===e.viewLevel){a=i.fCLLevel}t[o]=5+(i.level>e.viewLevel)}}ee(a);var l=r.oRouter.getTargets();var u=L(a);var s=l.display(u);n.oBusyHelper.setBusy(s)}function ne(e,t){if(!x(t)){return}var r=X(t.fCLLevel);if(A(r,t.sRouteName)){return}e.FCLLayout=r}function ae(e,t,r){if(r&&r.appStates&&r.appStates.FCLLayout){e.FCLLayout=r.appStates.FCLLayout}else{delete e.FCLLayout}}function oe(e,t){if(e.page.defaultLayoutTypeIfExternalNavigation&&!A(e.page.defaultLayoutTypeIfExternalNavigation,e.sRouteName)){t.FCLLayout=e.page.defaultLayoutTypeIfExternalNavigation}else{delete t.FCLLayout}}function ie(e){return e.treeNode.fCLLevel==0||e.treeNode.fCLLevel==3||G(U(e))}function le(e){return!ie(e)}function ue(){return T}function se(e,t){if(!h){return}var n=false;var a=f.getNextUIState(0).columnsVisibility;if(a.midColumn){var o=r.getCurrentIdentity();var l=o&&o.treeNode;n=l&&l.level===0&&y(o.appStates)!==i.OneColumn}if(n){if(e){t(e)}else{r.navigateByExchangingQueryParam("FCLLayout",i.OneColumn)}}}function fe(){return R}function ve(){return h}function ce(e,t){if(a.isSmartTable(e)){e=e.getTable()}else if(a.isSmartList(e)){e=e.getList()}var r=p(e);se(r,t)}function de(e){if(e>2){b=""}else{b=X(e)}}function Le(e){var t={};if(e.fCLLevel===1||e.fCLLevel===2){t.oActionButtonHandlers=_(e)}if(e.level===0){t.handleDataReceived=ve&&ve()?ce:Function.prototype;t.isListAndFirstEntryLoadedOnStartup=ve}t.isNextObjectLoadedAfterDelete=fe;return t}function me(e){var t=e||G(N);for(var a=e||r.getCurrentIdentity().treeNode;a;a=!t&&a.fCLLevel&&n.mRoutingTree[a.parentRoute]){var o={aggregation:c(a.fCLLevel)};n.oNavigationHost.hidePlaceholder(o);if(a.level===0){var i=r.oRouter.getTargets();var l=i.getTarget("root");delete l.placeholder}}}e.attachStateChange(D.bind(null,false));function Ce(e){return z(e)===X(e.fCLLevel)}return{hidePlaceholder:me,adaptRoutingInfo:E,createMessagePageTargets:d,displayMessagePage:re,handleBeforeRouteMatched:H,handleRouteMatched:k,areIdentitiesLayoutEquivalent:Z,getAppStatesPromiseForNavigation:J,getSpecialDraftCancelPromise:W,getFCLAppStatesPromise:Y,adaptBreadCrumbUrlParameters:ne,adaptPreferredLayout:ae,isAppTitlePrefered:te,hasIdentityFullscreenLayout:ie,hasNavigationMenuSelfLink:le,getMaxColumnCountInFCL:ue,isNextObjectLoadedAfterDelete:fe,getFclProxy:Le,isListAndFirstEntryLoadedOnStartup:ve,setStoredTargetLayoutToFullscreen:de,adaptAppStatesForExternalNavigation:oe,willBeOpenedInFullscreen:Ce,getFullscreenLayout:X}}return e.extend("sap.suite.ui.generic.template.lib.FlexibleColumnLayoutHandler",{constructor:function(e,t){n(this,g(e,t))}})});
//# sourceMappingURL=FlexibleColumnLayoutHandler.js.map