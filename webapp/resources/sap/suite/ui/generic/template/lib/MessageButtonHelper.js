sap.ui.define(["sap/ui/base/Object","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/suite/ui/generic/template/lib/MessageUtils","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper","sap/suite/ui/generic/template/lib/ai/ErrorExplanationHelper"],function(e,t,r,n,a,o,i,s,l){"use strict";t=o.observableConstructor(t,true);var u=new t({path:"persistent",operator:r.EQ,value1:false});var c=new t({path:"technical",operator:r.EQ,value1:false});var p=new t({path:"validation",operator:r.EQ,value1:true});var f=new t({filters:[p,new t({path:"validation",operator:r.EQ,value1:false})],and:true});function g(e,r,o){var i=r.controller;var g=i.getOwnerComponent();var v=g.getModel("ui");var m=new n({isPopoverOpen:false,messageToGroupName:Object.create(null),isAIErrorExplanationEnabled:false});var d=i.byId("showMessages");var P=e.oComponentUtils.isDraftEnabled();var h=false;var b;var E;var M;var T;var y=[];function O(t,r,n){var a=!!(n&&r&&e.oCommonUtils.getPositionableControlId(r));var o=a&&m.getProperty("/messageToUpdateFunction");var i=o&&o[t];(i||Function.prototype)();return a}function C(e,t,r,n){var a=n&&e&&t&&T?T.getSubtitle(e,r):r;return a}function S(e,t,r,n){return n&&e&&t&&T?T.getDescription(e,r):r}var w=o&&!P?v.getProperty.bind(v,"/createMode"):function(){return false};var x=f;var U,A;e.oCommonUtils.getDialogFragment("sap.suite.ui.generic.template.fragments.MessagePopover",{afterClose:function(){m.setProperty("/isPopoverOpen",false);A.sort([])},beforeOpen:function(){U.navigateBack();m.setProperty("/isPopoverOpen",true)},isPositionable:O,generateErrorExplanation:function(t){l.generateErrorExplanation(t,i,e)},getSubtitle:C,getDescription:S,titlePressed:function(t){a.navigateFromMessageTitleEvent(e,t,g,P,b);U.close()}}).then(function(t){U=t;U.setModel(sap.ui.getCore().getMessageManager().getMessageModel(),"msg");U.setModel(m,"helper");A=U.getBinding("items");A.filter(x);m.setProperty("/isAIErrorExplanationEnabled",l.isErrorExplanationEnabled(e));var r=e.oComponentUtils.getTemplatePrivateModel();r.setProperty("/generic/messageButtonInfo",{count:0,tooltip:e.oCommonUtils.getText("MESSAGE_BUTTON_TOOLTIP_P",[0])});A.attachChange(function(t){var n=A.getLength();var a=0;var o={count:n};if(n>0){if(m.getProperty("/isPopoverOpen")){var i=t.getParameters();if(i.reason!=="sort"){Z(true)}}var s=A.getAllCurrentContexts();var l,u,c;s.forEach(function(e){var t=e.getObject();switch(t.type){case"Error":a++;break;case"Warning":l=true;break;case"Success":u=true;break;default:c=true}});if(a>0){o.severity="Negative";o.icon="sap-icon://message-error"}else if(l){o.severity="Critical";o.icon="sap-icon://message-warning"}else if(c){o.severity="Neutral";o.icon="sap-icon://message-information"}else if(u){o.severity="Success";o.icon="sap-icon://message-success"}}o.label=""+(a||"");o.tooltip=e.oCommonUtils.getText(n===1?"MESSAGE_BUTTON_TOOLTIP_S":"MESSAGE_BUTTON_TOOLTIP_P",[n]);r.setProperty("/generic/messageButtonInfo",o);y.forEach(function(e){e()})})});var B=new t({filters:[p,new t({path:"controlIds",test:function(t){return!!e.oCommonUtils.getPositionableControlId(t)},caseSensitive:true})],and:true});var F=[];var I=0;var _;var N;function j(e){if(Array.isArray(e)){var t=false;for(var r=0;r<e.length;r++){t=j(e[r])||t}return t}if(e instanceof Promise){e.then(_);return false}N.push(e);return true}function D(e){x=e;if(A){A.filter(x)}}function H(){if(h){E=new t({filters:N,and:false});var r=[E,u];if(e.oServices.oApplication.needsToSuppressTechnicalStateMessages()){r.push(c)}M=new t({filters:r,and:true});D(new t({filters:[M,B],and:false}))}}function L(e,t){if(e===I&&j(t)){H()}}function k(e){var t=e();return j(t)}function G(){F.forEach(k)}function Q(e){b=e;I++;_=L.bind(null,I);var r=w();N=o?[new t(r?{path:"aTargets",test:function(e){return e.some(function(e){return e.startsWith(b)})}}:{path:"aFullTargets",test:function(e){return e.some(function(e){return e.startsWith(b)})}})]:[];G();H()}function W(e){F.push(e);if(N&&k(e)){H()}}var J;function q(){J=J||function(){if(A.getLength()>0){U.openBy(d)}};setTimeout(function(){var e=Z();e.then(J)},0)}function z(e){h=e;if(e){if(N){H()}}else{N=null;D(f)}}function K(e){return e?B:x}function R(e){return e?M:E}function V(e){var t=w(),r=!t&&s.analyseContextPath(b,e),n=t?b:r.canonicalPath,a=b;return{target:n,fullTarget:a}}function X(){var e=m.getProperty("/isPopoverOpen")?Promise.resolve():Z();e.then(function(){U.toggle(d)})}var Y=Object.create(null);function Z(t){var n=e.oServices.oApplication.getBusyHelper();var a=Object.create(null);var o=false;var i=A.getAllCurrentContexts().map(function(e){var t=e.getObject();o=o||!Y[t.id];a[t.id]=t;return t});Y=o?a:Y;var s=o&&r.getPrepareMessageDisplayPromise?r.getPrepareMessageDisplayPromise(i,A,m,b):Promise.resolve(T);if(!t){e.oServices.oApplication.setNextFocus(Function.prototype);n.setBusy(s)}return s.then(function(e){T=e})}function $(e){y.push(e)}return{adaptToContext:Q,toggleMessagePopover:X,showMessagePopover:q,registerMessageFilterProvider:W,setEnabled:z,getMessageFilters:K,getContextFilter:R,getTargetInfo:V,registerExternalListener:$}}return e.extend("sap.suite.ui.generic.template.lib.MessageButtonHelper",{constructor:function(e,t,r){i(this,o.testableStatic(g,"MessageButtonHelper")(e,t,r))}})});
//# sourceMappingURL=MessageButtonHelper.js.map