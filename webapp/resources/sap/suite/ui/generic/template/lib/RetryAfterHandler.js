sap.ui.define(["sap/ui/base/Object","sap/base/util/extend","sap/base/i18n/Formatting","sap/m/Button","sap/m/Dialog","sap/m/IllustratedMessageType","sap/m/ProgressIndicator","sap/m/Text","sap/m/library","sap/ui/core/format/DateFormat","sap/ui/core/library","sap/ui/core/Messaging","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/suite/ui/generic/template/genericUtilities/testableHelper"],function(e,t,a,n,r,s,i,o,l,u,E,_,c,p,T,g){"use strict";function d(e,t){var d=l.ButtonType;var R=l.DialogType;var f=E.ValueState;var v=e.getText;var S=a.getTimePattern("short")||"hh:mm a";function m(e){var t=e.message;var a;if(t){a=v("ST_GENERIC_503_SOURCE_MESSAGE")+" "+t}var n=e.retryAfter;var r=new Date;var s=n.getTime()-r.getTime();var i=Math.ceil(s/1e3);return new Promise((e,t)=>{if(i<5){I(i,e)}else if(i<=600){M(r,n,i,a,e,t)}else{N(r,n,a);t()}})}function I(t,a){var n=new Promise(function(e){setTimeout(function(){e()},t*1e3)});e.oBusyHelper.setBusy(n,undefined,undefined,true);n.then(function(){a()})}function M(e,t,a,s,l,u){var E=t.getTime();var _=new T({lapsedSeconds:0});var c=null;var p=null;var g=null;var S=null;var m=-1;function I(e){return v("ST_GENERIC_503_SERVICE_UNAVAILABLE")+" "+v("ST_GENERIC_503_AUTO_RETRY_MSG",[e])}S=new o({text:I(a)});S.setModel(_);S.bindText({path:"/lapsedSeconds",formatter:function(e){var t=a-e;return I(t)}});g=new i({percentValue:0,state:f.None});g.setModel(_);g.bindProperty("percentValue",{path:"/lapsedSeconds",formatter:function(e){return e/a*100}});c=new r({type:R.Message,state:f.Warning,title:v("ST_MESSAGES_DIALOG_TITLE_WARNING"),content:[S,g],buttons:[new n({type:d.Emphasized,text:v("CANCEL"),press:function(){c.close();p.open()}})]});p=new r({type:R.Message,state:f.Warning,title:v("ST_MESSAGES_DIALOG_TITLE_WARNING"),content:[new o({text:v("ST_GENERIC_503_CANCEL_RETRY")})],buttons:[new n({type:d.Emphasized,text:v("RETRY"),press:function(){p.close();c.open()}}),new n({text:v("CANCEL"),press:function(){u(new Error("Request(s) canceled by user"));p.close();clearInterval(m);N(e,t,s)}})]});c.open();var m=setInterval(function(){var e=_.getProperty("/lapsedSeconds");_.setProperty("/lapsedSeconds",e+1);if((new Date).getTime()>E){clearInterval(m);l();c.close()}},1e3)}function N(t,a,n){var r=[];if(n){r.push(new o({text:n}))}e.oNavigationControllerProxy.navigateToMessagePage({messageType:s.UnableToLoad,title:v("ST_GENERIC_ERROR_TITLE"),text:v("ST_GENERIC_503_SERVICE_UNAVAILABLE"),description:A(t,a),additionalContent:r})}function A(e,t){var a=null;var n=null;var r=null;var s=u.getTimeInstance({pattern:S});var i=s.format(t);if(e.getYear()!==t.getYear()){n=u.getDateInstance({pattern:"MMMM dd, yyyy"});r=n.format(t);a=v("ST_GENERIC_503_RETRY_MSG_OTHER_DAY",[r,i])}else if(e.getMonth()!==t.getMonth()||e.getDate()!==t.getDate()){n=u.getDateInstance({pattern:"MMMM dd"});r=n.format(t);a=v("ST_GENERIC_503_RETRY_MSG_OTHER_DAY",[r,i])}else{a=v("ST_GENERIC_503_RETRY_MSG_SAME_DAY",[i])}return a}function y(){var e=t.getModel();e.setRetryAfterHandler(m)}var C=_.getMessageModel();var G=[new c("technical",p.EQ,true),new c("technicalDetails/statusCode",p.EQ,503)];var h=C.bindList("/",null,null,G);h.attachChange(t=>{var a=t.getSource();if(a.getLength()===1&&C.getData()?.length===1){e.oNavigationControllerProxy.navigateToMessagePage({messageType:s.UnableToLoad,title:v("ST_GENERIC_ERROR_TITLE"),text:v("ST_GENERIC_503_SERVICE_UNAVAILABLE"),description:v("ST_GENERIC_503_RETRY_MSG_TIME_UNKNOWN")})}});g.testable(A,"fnGetErrorMessageWithTime");return{registerRetryAfterHandler:y}}return e.extend("sap.suite.ui.generic.template.lib.RetryAfterHandler",{constructor:function(e,a){t(this,d(e,a))}})});
//# sourceMappingURL=RetryAfterHandler.js.map