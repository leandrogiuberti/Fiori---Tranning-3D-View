sap.ui.define(["sap/ui/base/Object","sap/suite/ui/generic/template/lib/MessageUtils","sap/base/util/extend","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/lib/CRUDHelper","sap/base/util/isEmptyObject","sap/ui/model/Filter"],function(e,t,n,o,i,s,r){"use strict";function a(e,n,a){var l,g;function u(e){var t=l.getBindingContext().getPath();var o="/"+n.getOwnerComponent().getEntitySet();var i=[new r({path:"aFullTargets",test:function(e){return e.some(function(e){return e.startsWith(t)})}}),new r({path:"aTargets",test:function(e){return e.includes(o)}})];if(e){return new r({filters:[new r("persistent","EQ",false),new r({filters:i,and:false})],and:true})}else{return new r({filters:i,and:false})}}function f(){var e=u(false);var t=sap.ui.getCore().getMessageManager().getMessageModel();if(e){var n=t.bindList("/",null,null,[e]);var o=n.getContexts();if(o.length){var i=[];for(var s in o){i.push(o[s].getObject())}sap.ui.getCore().getMessageManager().removeMessages(i)}}}function c(){l.close();l.setVisible(false);if(a.oComponentUtils.isDraftEnabled()){a.oServices.oCRUDManager.discardDraft(l.getBindingContext())}else{f(l);var e=l.getBindingContext().getPath();n.getView().getModel().resetChanges([e],undefined,true)}l.setBindingContext(null)}function d(){var o=false;var i;var s=l&&typeof l.getContent==="function"&&l.getContent()&&l.getContent()[0];var r=s?s.check():Promise.resolve();r.then(function(){var s=sap.ui.getCore().getMessageManager().getMessageModel().getData();o=s.some(function(e){return e.type==="Error"&&e.validation});if(!o&&a.oComponentUtils.isDraftEnabled()){var r=a.oComponentUtils.getCRUDActionHandler();i=u(true);r.handleCRUDScenario(1,C.bind(null,i))}else if(!o){a.oCommonEventHandlers.submitChangesForSmartMultiInput();i=u(false);var c=a.oServices.oCRUDManager.saveEntity(i);if(a.oComponentUtils.getViewLevel()===1){a.oServices.oApplicationController.executeSideEffects(g.getBindingContext(),[],[g.getTableBindingPath()])}c.then(function(){l.close();l.setVisible(false);if(e.oPresentationControlHandler){if(e.refreshModel){e.refreshModel()}else{a.oCommonUtils.refreshModel(e.oPresentationControlHandler.getEntitySet())}e.oPresentationControlHandler.refresh();t.showSuccessMessageIfRequired(a.oCommonUtils.getText("OBJECT_CREATED"),a.oServices)}else{a.oCommonUtils.refreshModel(g.getEntitySet());a.oServices.oPresentationControlHandlerFactory.getPresentationControlHandler(g).refresh();t.showSuccessMessageIfRequired(a.oCommonUtils.getContextText("ITEM_CREATED",g.getId()),a.oServices)}var n=a.oServices.oApplication.getBusyHelper();n.getUnbusy().then(function(){f(l);l.setBindingContext(null)})});var d={saveEntityPromise:c};a.oComponentUtils.fire(n,"AfterSave",d)}})}function C(o){var i=a.oServices.oCRUDManager.activateDraftEntity(l.getBindingContext(),o);i.then(function(n){if(n&&n.response&&n.response.statusCode==="200"){l.close();l.setVisible(false);l.setBindingContext(null);t.showSuccessMessageIfRequired(a.oCommonUtils.getText("OBJECT_CREATED"),a.oServices);e.oPresentationControlHandler.refresh()}},Function.prototype);var s={activationPromise:i};a.oComponentUtils.fire(n,"AfterActivate",s)}function v(e,t,n){g=a.oCommonUtils.getOwnerControl(t,true);var o=g.getParent().getBindingContext();n=s(n)?false:n;if(!n){var i=a.oServices.oCRUDManager.getDefaultValues(t,n);if(i instanceof Promise){var r=function(n){p(e,t,n,g,o)};i.then(r,r)}else{p(e,t,n,g,o)}}else{p(e,t,n,g,o)}}function p(t,n,o,s,r){var g=e.oSmartFilterbar;var u=r?s.getTableBindingPath():"/"+s.getEntitySet();var f=new sap.ui.model.json.JSONModel;l=t;l.setVisible(true);f.setProperty("/title",a.oCommonUtils.getContextText("CREATE_DIALOG_TITLE",s.getId()));l.setModel(f,"localModel");l.setEscapeHandler(c);if(a.oComponentUtils.isDraftEnabled()){a.oCommonEventHandlers.addEntry(n,false,g,o,false,true).then(function(e){a.oServices.oApplication.registerContext(e);l.setBindingContext(e);l.open()})}else{var d=i.createNonDraft(r,u,l.getModel(),o);l.setBindingContext(d);l.open()}}var C=o.testable(C,"fnActivateImpl");var f=o.testable(f,"fnRemoveOldMessageFromModel");var u=o.testable(u,"fnGetFilterForCurrentState");var p=o.testable(p,"openDialog");return{onCancelPopUpDialog:c,onSavePopUpDialog:d,createWithDialog:v}}return e.extend("sap.suite.ui.generic.template.lib.CreateWithDialogHandler",{constructor:function(e,t,o){n(this,a(e,t,o))}})});
//# sourceMappingURL=CreateWithDialogHandler.js.map