sap.ui.define(["sap/ui/base/Object","sap/suite/ui/generic/template/lib/navigation/routingHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/extend","sap/base/util/deepExtend","sap/base/util/isEmptyObject"],function(e,t,n,r,a,i,u){"use strict";var l=new r("lib.StatePreserver").getLogger();function o(e,n){var r=t.getCrossAppNavServicePromise();var a=e.componentRegistry[n.oComponent.getId()];var o=a.viewLevel===0;var s="";var p=Promise.resolve();var c=null;var f=Promise.resolve();var v=null;var g=null;var y=null;var S,m;var d=Object.create(null);var x={};var b={};function h(){d.permanentEntries=Object.create(null);d.sessionEntries=Object.create(null);d.pageEntries=Object.create(null);d.allEntries=Object.create(null)}h();function E(e){h();for(var t in e){var n=i({},e[t]);d.allEntries[t]=n;var r=n.lifecycle||Object.create(null);if(r.permanent){d.permanentEntries[t]=n}else if(r.session){d.sessionEntries[t]=n}if(r.page||r.pagination){d.pageEntries[t]=n}}return d}function P(e,t){if(t===e){return}var n=t.next.next;t.next.next=e.next;e.next=t.next;t.next=n}function K(e,t,a){if(u(t)){return Promise.resolve({appStateKey:""})}var i=JSON.stringify(t);var l=0;var o;for(o=e;o.next&&l<10;l++){if(o.next.serialize===i){P(e,o);return Promise.resolve({appStateKey:e.next.appStateKey})}o=o.next}o.next=null;var s=r.then(function(e){return e.createEmptyAppState(n.oComponent.getAppComponent(),a?undefined:true)});return s.then(function(n){var r={next:e.next,serialize:i,appStateKey:n.getKey()};n.setData(t);e.next=r;var a=n.save();return a.then(function(){return{appStateKey:r.appStateKey}})})}function A(){var t=K(b,d.sessionEntries,false);return t.then(function(t){var r=Object.create(null);if(t.appStateKey){r.sessionAppStateKey=t.appStateKey}if(!u(d.permanentEntries)){r.permanentEntries=d.permanentEntries}var i=K(x,r,true);return i.then(function(t){g=t;var r=Promise.resolve();if(y===g.appStateKey){g=null}else if(a.utils.isComponentActive()){r=e.oNavigationControllerProxy.navigateByExchangingQueryParam(n.appStateName,g.appStateKey)}else{s=g.appStateKey;g=null}if(v){v(r.then(e.oBusyHelper.getUnbusy));v=null}})})}function O(){if(!v||s!==y){return}var e=n.getCurrentState()||Object.create(null);E(e);return A()}function j(){var t=a.aKeys;var n="";var r=a.route;for(var i=t.length-1;i>0;i--){var u=e.mRoutingTree[r];var l=i===1?u.entitySet:u.navigationProperty;n="/"+l+(t[i]?"("+t[i]+")":"")+n;r=u.parentRoute}return n}function C(e,t){return p.then(function(){var t=Object.create(null);var r=(!e||j()===e)&&S;if(r){t[n.appStateName]=r}return t})}function w(){if(e.bStateHandlingSuspended){return}f=f.then(function(){return new Promise(function(e){v=e;setTimeout(O,0)})});return f}function N(){s=y;g=null;S=y;if(c){c();c=null}}function H(e,t,n){if(!t){return}for(var r in t){var a=t[r];if(n||a.lifecycle.page){e[r]=a}}}async function F(e,t){E(t);var r=Object.create(null);for(var a in t){r[a]=t[a].data}await n.applyState(r,e);if(c){c();c=null}N();return A().then(O)}function I(e,t,n){for(var r=e;r.next;r=r.next){if(r.next.appStateKey===n){P(e,r);return}}var a={next:e.next,serialize:JSON.stringify(t),appStateKey:n};e.next=a}function L(t,n,r,i,u,l){if(e.bStateHandlingSuspended){a.utils.hidePlaceholder();return}if(y===null){y=t}else if(t!==y){return}if(l){I(b,l,u);H(r,l,true)}H(r,i,true);return F(n,r)}function R(t,n,r,a){var i=a||Object.create(null);I(x,i,t);if(o&&!i.permanentEntries){i={permanentEntries:{permanentState:{data:i,lifecycle:{permanent:true}}}}}var u=e.oNavigationControllerProxy.getAppStateFromShell(i.sessionAppStateKey).catch(Function.prototype);u.then(L.bind(null,t,n,r,i.permanentEntries,i.sessionAppStateKey))}function U(t){var r=e.componentRegistry[n.oComponent.getId()];var a=r.utils.getHeaderDataAvailablePromise()||Promise.resolve();return a.then(function(){return e.oApplicationProxy.areTwoKnownPathesIdentical(m,t,r.viewLevel===1)})}function z(e,t){if(e===m){t(true);return}if(!e||!m){t(false);return}U(e).then(t)}function T(t,r){z(t,function(i){if(!n.callAlways&&i){if(y===s){a.utils.hidePlaceholder();return}if(!y){A();return}}m=t;var u=Object.create(null);H(u,d[i?"allEntries":"pageEntries"],i||r);if(!y){if(i){H(u,d.sessionEntries,true);H(u,d.permanentEntries,true)}F(i,u);return}if(!c){p=new Promise(function(e){c=e})}var l=e.bStateHandlingSuspended?"":y;var o=e.oNavigationControllerProxy.getAppStateFromShell(l).catch(Function.prototype);o.then(R.bind(null,l,i,u))})}function B(){for(var e in d.pageEntries){var t=d.pageEntries[e].lifecycle;if(!t.permanent&&!t.session){delete d.allEntries[e];delete d.pageEntries[e]}}}function D(e){y=e[n.appStateName]||"";if(Array.isArray(y)){y=y.sort((e,t)=>e.localeCompare(t))[0]||""}if(g){if(g.appStateKey!==y){l.error("StatePreserver: Got AppstateKey "+y+" expected "+g.appStateKey);return false}N();return true}return false}function J(){return{isStateChange:D,leaveApp:B}}function G(e){if(e){var t=n.getInitialState();n.applyState(t,true);s="";return}T(m,true)}return{getUrlParameterInfo:C,stateChanged:w,applyAppState:T,getAsStateChanger:J,setState:G}}return e.extend("sap.suite.ui.generic.template.lib.StatePreserver",{constructor:function(e,t){a(this,o(e,t))}})});
//# sourceMappingURL=StatePreserver.js.map