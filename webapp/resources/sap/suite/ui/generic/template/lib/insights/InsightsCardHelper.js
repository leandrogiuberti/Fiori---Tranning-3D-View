sap.ui.define(["sap/suite/ui/generic/template/genericUtilities/metadataAnalyser","sap/suite/ui/generic/template/lib/filterHelper","sap/fe/navigation/SelectionVariant","sap/base/util/deepExtend","sap/suite/ui/generic/template/listTemplates/semanticDateRangeTypeHelper","sap/ui/core/library","sap/base/strings/formatMessage","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/ObjectPath"],function(e,t,a,r,n,i,s,o,l){"use strict";var u={};u.CardTypes={TABLE:"Table",ANALYTICAL:"Analytical",LIST:"List",DT_CARD:"DT_CARD"};var c=i.ValueState;var p=new o("js.InsightsCardHelper").getLogger();u.createCardForPreview=function(e){return v(e)};u.isCardCreationAllowed=function(e){return!n.hasSemanticDateValue(e)};u.getCardId=function(e){var t=e.getManifestEntry("sap.app");return"user."+t.id+"."+Date.now()};var v=function(e){var t={};if(e.cardType===u.CardTypes.DT_CARD){t=e.descriptorContent;t["sap.insights"]=y(e);return t}var a=e["component"];var r=a.getAppComponent();var n=r.getManifestEntry("sap.ui");var i=r.getManifestEntry("sap.app");if(i&&i["crossNavigation"]){delete i["crossNavigation"]}i.type="card";i.id=u.getCardId(r);t["sap.app"]=f(i);t["sap.ui"]=n;t["sap.card"]=d(e);t["sap.insights"]=y(e);t["sap.ui5"]=g();return t};var m=function(e){var t=e.oServices.oApplication.getNavigationHandler();return t.getIAppStateKey()};var g=function(){return{_version:"1.1.0",contentDensities:{compact:true,cozy:true},dependencies:{libs:{"sap.insights":{lazy:false}}}}};var f=function(e){var t=r({},e);if(t&&t.dataSources&&t.dataSources.mainService&&t.dataSources.mainService.settings){t.dataSources["filterService"]=t.dataSources.mainService;t.dataSources["filterService"].settings["odataVersion"]="2.0"}return t};var d=function(e){var t={};var a=e["component"].getMetadata().getName();t["type"]=C(a);t["configuration"]=T(e);t["data"]=u.fnCreateManifestSapCardData(e,t);t["header"]=u.fnCreateManifestSapCardHeader(e,t);t["extension"]="module:sap/insights/CardExtension";if(t.type==="Analytical"){t["content"]=u.fnCreateManifestSapAnalyticalCardContent(e,t)}else{t["content"]=u.fnCreateManifestSapTableCardContent(e,t)}u.getCardActions(e,t);return t};var y=function(e){var t=e["component"],a=e["currentControlHandler"],r=t.getAppComponent().getManifestEntry("sap.app"),n=r.id,i="RT",s=t.getModel("_templPrivGlobal").getProperty("/generic/ui5VersionInfo");return{parentAppId:n,cardType:i,allowedChartTypes:a.getAvailableChartTypes&&a.getAvailableChartTypes(),versions:{ui5:s.version+"-"+s.buildTimestamp},filterEntitySet:e.entitySet.name}};var C=function(e){switch(e){case"sap.suite.ui.generic.template.ListReport.Component":return u.CardTypes.TABLE;case"sap.suite.ui.generic.template.AnalyticalListPage.Component":return u.CardTypes.ANALYTICAL;default:return u.CardTypes.LIST}};var T=function(e){var t={};var a=e["component"];var r=a.getModel().sServiceUrl;t["parameters"]=u.getFilterDetails(e)["filters"];t["parameters"]["_entitySet"]={value:e.entitySet.name};t["parameters"]["_urlSuffix"]={value:"/Results"};t["destinations"]={service:{name:"(default)",defaultUrl:"/"}};t["csrfTokens"]={token1:{data:{request:{url:"{{destinations.service}}"+r,method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}}}};return t};u.getFilterDetails=function(r){var n={filters:{}},i=n.filters,s=r.oSmartFilterbar,o=s&&s.getModel(),l=r.view.getModel(),u=r.entityType,c=[],p=[],v=[],m=[],g,f=[],d=[],y=[];if(o){var C=e.checkAnalyticalParameterisedEntitySet(o,r.entitySet.name);if(C){var T=e.getParametersByEntitySet(o,r.entitySet.name);if(T.entitySetName){y=T.parameters||[]}}}var x=e.getParametersByEntitySet(l,r.entitySet.name,true).parameters;var D="";x.forEach(function(e){var a=b(e);var n=t.getParameterDefaultValue(l,r.entitySet.name,e);var o=t.getParameterActualValue(e,s);D=t.getLabelForConfigParams(e,s,i,r,n);var u=t.IsSemanticDateRangeValid(r,e);if(u){t.setFilterRestrictionToSemanticDateRange(e,true);n=t.getDateRangeDefaultValue(r,e)||n;o=t.getDateRangeValue(o,e,true)||o;if(D&&typeof D==="string"){D=D.substring(0,D.indexOf("(")-1)}else if(n){D=n;t.getLabelForConfigParams(e,s,i,r,n,true)}}if(a){v.push(e)}i[e]={value:o?o:n,type:t.getPropertyType(e),description:e&&e.description,label:D};i[e]["description"]=P(e,"description");c.push(e);f.push(e)});y=y.filter(function(e){return!f.includes(e)});if(u&&u.property){d=t.getCommonFilterProperties(u.property,y)}for(var O=0;O<d.length;O++){var $=d[O],M="";var V=h($,u.property);var A=b(V);var I=t.getFilterDefaultValue($.name,u)||$.defaultValue||"";var N=t.getParameterActualValue($.name,s);if(f.includes($.name)){D=t.getLabelForConfigParams($.name,s,i,r,I);var R=t.IsSemanticDateRangeValid(r,$);if(R){t.setFilterRestrictionToSemanticDateRange($,true);I=t.getDateRangeDefaultValue(r,$.name)||I;N=t.getDateRangeValue(N,$,true)||N;if(D&&typeof D==="string"){D=D.substring(0,D.indexOf("(")-1)}else if(I){D=I;t.getLabelForConfigParams($.name,s,i,r,I,true)}}i[$.name]={value:N?N:I,type:t.getPropertyType($),description:$&&$.description,label:D};if(A){v.push(A)}c.push($.name)}else{g=new a;var L=t.getLabelForConfigParams($.name,s,i,r,I);var R=t.IsSemanticDateRangeValid(r,$);if(R){t.setFilterRestrictionToSemanticDateRange($,false);t.addDateRangeValueToSV(r,$,I,g,L)}else if(N){t.addFiltervalues(s,$.name,g,L)}else if(I){var E=t.getRelatedTextToRange({Low:I},L,s,$.name);g.addSelectOption($.name,"I","EQ",I,null,E)}else{g.addSelectOption($.name,"I","EQ",M)}i[$.name]={value:g.toJSONString(),type:t.getPropertyType($),description:$&&$.description};i[$.name].value=t.enhanceVariant(i[$.name].value);if(A){m.push(A)}p.push($.name)}i[$.name]["description"]=P($,"description")}var F=r["oFECustomFilterData"];if(F){g=new a;g.addSelectOption(F.name,"I","EQ",F.value);i[F.name]={value:g.toJSONString(),type:"string",description:""};i[F.name].value=t.enhanceVariant(i[F.name].value);p.push(F.name)}var U=s.getBasicSearchName(),w=s.getBasicSearchValue();if(w){g=new a;g.addSelectOption(U,"I","EQ",w);i[U]={value:g.toJSONString(),type:"string",description:""};i[U].value=t.enhanceVariant(i[U].value);p.push(U)}var H=S(p);var _=S(c);var B=S(v);var k=S(m);t.updateRangeValue(i);i["_relevantODataFilters"]={value:H};i["_relevantODataParameters"]={value:_};i["_mandatoryODataParameters"]={value:B};i["_mandatoryODataFilters"]={value:k};return n};var S=function(e){return e&&e.filter(function(t,a){return e.indexOf(t)===a})};var h=function(e,t){if(t&&t.length){var a=t.filter(function(t){return t.name===e.name});return a&&a[0]}};var b=function(e){var t=[];if(e&&e.extensions){t=e.extensions;for(var a=0;a<t.length;a++){if(t[a].name==="parameter"&&t[a].value==="mandatory"){return e.name}else if(t[a].name==="required-in-filter"&&t[a].value==="true"){return e.name}}}};var P=function(e,t){var a;if(e&&e[t]){return e[t]}else if(e&&e.extensions){a=e.extensions;for(var r=0;r<a.length;r++){if(a[r].name===t){return a[r].value}}}return undefined};var x=function(e,t){if(e&&t){if(e.indexOf("?")===-1){e+="?"+t}else{e+="&"+t}}return e};u.fnCreateManifestSapCardData=function(e,t){var a={};var r=e["component"],n=e["component"].getMetadata().getName();var i=r.getModel().sServiceUrl;var s=i;var o=e["currentControlHandler"];var l="";if(o.getBinding()){l=o.getBinding().getDownloadUrl()}if(n==="sap.suite.ui.generic.template.ListReport.Component"){var u="$top=15";l=x(l,u)}var c="$inlinecount=allpages";l=x(l,c);var p={};p.content={method:"GET",url:l,headers:{Accept:"application/json"}};a["request"]={url:"{{destinations.service}}"+s+"/$batch",method:"POST",headers:{"X-CSRF-Token":"{{csrfTokens.token1}}"},batch:p};return a};u.fnCreateManifestSapCardHeader=function(e,t){var a=e["currentControlHandler"].getToolbar();var r=e["component"].getMetadata().getName(),n=a.getTitleControl()&&a.getTitleControl().getText();if(n&&n.indexOf("(")>-1&&r==="sap.suite.ui.generic.template.ListReport.Component"){var i=n.split("(");n=i[0].trim()}var s="__count";var o={text:"{= ${"+s+"} === '0' ? '' : ${"+s+"} }"};var l={title:n,subTitle:"",actions:{},status:o,data:{path:"/content/d"}};return l};u.fnCreateManifestSapTableCardContent=function(e,t){var a=E(e);var r={data:{path:"/content/d/results"},maxItems:15,row:{columns:a,highlight:D(e),actions:{}}};return r};var D=function(e){var t=R(e);return L(t["com.sap.vocabularies.UI.v1.Criticality"]?t["com.sap.vocabularies.UI.v1.Criticality"]:"")};var O=function(e,t,a){var r;var n=a.getMeasures();var i=a.getDimensions();if(t==="Dimension"){r=i.filter(function(t){return t.getName()===e})[0].getLabel()||e}else{r=n.filter(function(t){return t.getName()===e})[0].getLabel()||e}return r};var $=function(e){var t=[],a=e._getVizFrame().getFeeds(),r,n;for(var i=0;i<a.length;i++){r=a[i].getProperty("values");n=[];for(var s=0;s<r.length;s++){var o=O(r[s].getProperty("name"),r[s].getProperty("type"),e);var l={type:a[i].getProperty("type"),uid:a[i].getProperty("uid"),values:[o]};n.push(l)}t=t.concat(n)}return t};u.fnCreateManifestSapAnalyticalCardContent=function(e,t){var a={},r=e["currentControlHandler"],n=r.getInnerChart(),i=n.getMeasures(),s=n.getDimensions(),o=n.getVisibleDimensions(),l=n.getVisibleMeasures(),u=n.getInResultDimensions();for(var c=0;c<u.length;c++){o.push(u[c])}a["data"]={path:"/content/d/results"};a["chartType"]=n.getChartType();a["measures"]=A(i,l);a["dimensions"]=N(s,o,e);a["feeds"]=$(n);a["chartProperties"]=V(n);a["actionableArea"]="Chart";a["actions"]={};return a};function M(e,t){const a=["axisTick","axisLine","label.visible","label.formatString","title.visible"];if(!e?.[t]){return undefined}const r=e[t];const n={};a.forEach(e=>{const t=l.get(e,r);if(t!==undefined){l.set(e,t,n)}});return n}const V=function(e){const t=e.getProperty("vizProperties");const a=e.getVizProperties();const r=Object.assign({},t);const n=["valueAxis","valueAxis2","categoryAxis","categoryAxis2"];n.forEach(e=>{if(a[e]){r[e]=M(a,e)}});return r};var A=function(e,t){var a=[];for(var r in e){var n=e[r];for(var i=0;i<t.length;i++){if(t[i]===n.getName()){a.push({name:n.getLabel(),value:"{"+n.getName()+"}"});break}}}return a};var I=function(e,t){var a=e["entityType"];var r=e["currentControlHandler"].getModel().getMetaModel();var n=r.getODataProperty(a,t.getName());var i="{"+n.name+"}";var s="{"+t.getTextProperty()+"}";if(n["com.sap.vocabularies.Common.v1.Text"]&&n["com.sap.vocabularies.Common.v1.Text"].Path){var o=n["com.sap.vocabularies.Common.v1.Text"]["com.sap.vocabularies.UI.v1.TextArrangement"];if(!o){o=a["com.sap.vocabularies.UI.v1.TextArrangement"]}var l=o&&o.EnumMember.split("/")[1];if(l==="TextOnly"){i="{= $"+s+" === '' ? '' : $"+s+"}"}else if(l==="TextLast"){i="{= $"+i+" === '' ? '' : $"+i+"}"+"{= $"+s+" === '' ? '' : ' (' + ($"+s+") + ')'}"}else if(l==="TextSeparate"){i="{= $"+i+" === '' ? '' : $"+i+"}"}else{i="{= $"+s+" === '' ? '' : $"+s+"}"+"{= $"+i+" === '' ? '' : ' (' + ($"+i+") + ')'}"}}return i};var N=function(e,t,a){var r=[];for(var n in e){var i=e[n];for(var s=0;s<t.length;s++){if(t[s]===i.getName()){if(i.getTextProperty()){r.push({name:i.getLabel(),value:"{"+i.getTextProperty()+"}",displayValue:I(a,i)})}else{r.push({name:i.getLabel(),value:"{"+i.getName()+"}",displayValue:I(a,i)})}break}}}return r};u.getCardActions=function(e,t){var a=window.hasher.getHash(),r=a.split("&/")[0],n;if(r.includes("?")){n=r.split("?")[1];r=r.split("?")[0].split("-")}else{r=r.split("-")}var i={ibnTarget:{semanticObject:r[0],action:r[1]},sensitiveProps:[],ibnParams:{nhHybridIAppStateKey:m(e.oTemplateUtils)}};if(!!n){n=n.split("sap-appvar-id=")[1];i.ibnParams["sap-appvar-id"]=n}var s=[{type:"Navigation",parameters:"{= extension.formatters.getNavigationContext(${parameters>/headerState/value})}"}];var o=JSON.parse(JSON.stringify(i));var l=[{type:"Navigation",parameters:"{= extension.formatters.getNavigationContext(${parameters>/contentState/value}, ${})}"}];t.configuration.parameters.headerState={value:JSON.stringify(i)};t.configuration.parameters.contentState={value:JSON.stringify(o)};t.header.actions=s;if(t.type!="Analytical"){var u=e["component"].getModel("_templPriv");if(!u.getProperty("/listReport/bSupressCardRowNavigation")){t.content.row.actions=l}}};var R=function(e){var t=e["entityType"];var a=e["currentControlHandler"].getControl().getCustomData();var r=a.find(function(e){return e.getKey()==="lineItemQualifier"});var n=r&&r.getValue()?"#"+r.getValue():"";return t["com.sap.vocabularies.UI.v1.LineItem"+n]||[]};var L=function(e){var t=c.None;var a;var r=e.Criticality||e;if(r){a="'{'= ({0} === ''com.sap.vocabularies.UI.v1.CriticalityType/Negative'') || ({0} === ''1'') || ({0} === 1) ? ''"+c.Error+"'' : "+"({0} === ''com.sap.vocabularies.UI.v1.CriticalityType/Critical'') || ({0} === ''2'') || ({0} === 2) ? ''"+c.Warning+"'' : "+"({0} === ''com.sap.vocabularies.UI.v1.CriticalityType/Positive'') || ({0} === ''3'') || ({0} === 3) ? ''"+c.Success+"'' : "+"''"+c.None+"'' '}'";if(r.Path){var n="${"+r.Path+"}";t=s(a,n)}else if(r.EnumMember){var i="'"+r.EnumMember+"'";t=s(a,i)}else{p.warning("Case not supported, returning the default sap.ui.core.ValueState.None")}}else{p.warning("Case not supported, returning the default sap.ui.core.ValueState.None")}return t};var E=function(e){var t=e["entityType"];var a=e["currentControlHandler"].getControl();var r=e["currentControlHandler"].getModel().getMetaModel();var n=[];var i=e.oTemplateUtils.oCommonUtils;e["currentControlHandler"].getVisibleProperties(true).filter(function(s){var o=s.data("p13nData");var l=o&&o.description||"";var u=r.getODataProperty(t,o.leadingProperty);if(i.isSupportedColumn(s,u,a)){if(u&&(u["sap:label"]||u["com.sap.vocabularies.Common.v1.Label"])&&s.getVisible()){var c={};l="{"+l+"}";var p="{"+u.name+"}";var v="";var m;var g=t["com.sap.vocabularies.Common.v1.SemanticKey"];var f=!!g&&g.some(function(e){return e.PropertyPath===u.name});var d=R(e);var y=!!d&&d.some(function(e){m=e;return(e.Criticality&&e.Value&&e.Value.Path)===u.name});if(u["Org.OData.Measures.V1.ISOCurrency"]&&u["Org.OData.Measures.V1.ISOCurrency"].Path){p=p.concat(" "+"{"+v+u["Org.OData.Measures.V1.ISOCurrency"].Path+"}")}if(u["Org.OData.Measures.V1.Unit"]&&u["Org.OData.Measures.V1.Unit"].Path){p=p.concat(" "+"{"+v+u["Org.OData.Measures.V1.Unit"].Path+"}")}if(u["com.sap.vocabularies.Common.v1.Text"]&&u["com.sap.vocabularies.Common.v1.Text"].Path){var C=u["com.sap.vocabularies.Common.v1.Text"]["com.sap.vocabularies.UI.v1.TextArrangement"];if(!C){C=t["com.sap.vocabularies.UI.v1.TextArrangement"]}var T=C&&C.EnumMember.split("/")[1];if(f&&e.oTemplateUtils.oComponentUtils.isDraftEnabled()){var S=e["component"].getModel("i18n").getResourceBundle().getText("NEW_OBJECT");if(T==="TextOnly"){c["value"]="{= $"+l+" === '' ?  '"+S+"'  : $"+l+"}"}else if(T==="TextLast"){c["value"]="{= $"+p+" === '' ?  '' : $"+p+"}";c.additionalText="{= $"+l+" === '' ?  '"+S+"' : $"+l+"}"}else if(T==="TextSeparate"){c["value"]="{= $"+p+" === '' ? '' : $"+p+"}"}else{c["value"]="{= $"+l+" === '' ?  '"+S+"' : $"+l+"}";c.additionalText="{= $"+p+" === '' ?  '' : $"+p+"}"}c.identifier=true}else if(T==="TextOnly"){c["value"]="{= $"+l+" === '' ? '' : $"+l+"}"}else if(T==="TextLast"){c["value"]="{= $"+p+" === '' ? '' : $"+p+"}"+"{= $"+l+" === '' ? '' : ' (' + ($"+l+") + ')'}"}else if(T==="TextSeparate"){c["value"]="{= $"+p+" === '' ? '' : $"+p+"}"}else{c["value"]="{= $"+l+" === '' ? '' : $"+l+"}"+"{= $"+p+" === '' ? '' : ' (' + ($"+p+") + ')'}"}}else{c["value"]=p;if(f){c.identifier=f}}if(y){c.state=L(m);c.showStateIcon=m.CriticalityRepresentation?m.CriticalityRepresentation.EnumMember!=="com.sap.vocabularies.UI.v1.CriticalityRepresentationType/WithoutIcon":true}if(u["com.sap.vocabularies.Common.v1.Label"]&&u["com.sap.vocabularies.Common.v1.Label"].String){var h=u["com.sap.vocabularies.Common.v1.Label"].String,b=e["component"].getModel("i18n").getResourceBundle();if(h.match(/{@i18n>.+}/gi)&&b){c["title"]=b.getText(h.substring(h.indexOf(">")+1,h.length-1))}else{c["title"]=h}}else{c["title"]=u["sap:label"]}if(u.type==="Edm.DateTime"||u.type==="Edm.DateTimeOffset"){var P=JSON.stringify(o.typeInstance.oFormat.oFormatOptions).replace(/"/g,"'");c["value"]="{=$"+p+" ? format.dateTime($"+p+", "+P+") : ''}"}n.push(c)}}});return n};return u});
//# sourceMappingURL=InsightsCardHelper.js.map