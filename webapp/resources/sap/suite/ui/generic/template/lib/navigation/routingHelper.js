sap.ui.define(["sap/ui/core/Element","sap/ui/core/mvc/XMLView","sap/suite/ui/generic/template/lib/FlexibleColumnLayoutHandler","sap/suite/ui/generic/template/js/StableIdHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/extend","sap/suite/ui/generic/template/genericUtilities/FeError"],function(e,t,n,o,a,r,i){"use strict";var l="lib.navigation.routingHelper";var u=new a(l).getLogger();var p=Object.create(null);var s={getPlaceholderInfo:Function.prototype};var c=sap.ui.require("sap/ushell/Container");var m=c?c.getServiceAsync("Navigation"):function(){var e=0;var t=function(){e++;return{getKey:function(){return""+e},setData:Function.prototype,getData:function(){return{historicalEntries:[""]}},save:function(){return Promise.resolve()}}};return Promise.resolve({createEmptyAppState:function(){return Promise.resolve(t())},getAppState:function(){return Promise.resolve({getData:function(){return Object.create(null)}})},isInitialNavigation:function(){return Promise.resolve(true)}})}();function g(e,t,n,o,a,i){var l=e.oTemplateContract.bEnablePlaceholder?a&&a.getPlaceholderInfo():null;var u=r({controlId:n,controlAggregation:o,placeholder:l},i);var p=e.oRouter.getTargets();p.addTarget(t,u);return p.getTarget(t)}function d(e,t,n,o,a,r){return g(e,o,t,a,r,{type:"View",name:n})}function v(e,t){if(e.oTemplateContract.oFlexibleColumnLayoutHandler){e.oTemplateContract.oFlexibleColumnLayoutHandler.createMessagePageTargets(d.bind(null,e,t,"sap.suite.ui.generic.template.fragments.MessagePage"))}else{d(e,t,"sap.suite.ui.generic.template.fragments.MessagePage","messagePage","pages")}}function f(e,t,n,o){var a=d(e,n,t.sRouteName,t.sRouteName,o,t.behaviour);var r=function(){var n=e.treeNodeFirstDisplay(t);if(n){a.detachDisplay(r)}};a.attachDisplay(r)}function y(e,t,n){var o=t.page.routingSpec?t.page.routingSpec.draftSpec:"OData";if(o===undefined){o="parent"}switch(o){case"parent":t.isDraft=n.isDraft;return;case"OData":var a=e.oAppComponent.getTransactionController().getDraftController();var r=a.getDraftContext();try{t.isDraft=r.isDraftEnabled(t.entitySet)}catch(e){u.warning("Could not determine draft info for entity set "+t.entitySet);t.isDraft=n&&n.isDraft}return;default:break}t.isDraft=o}function C(e){var t=e.page.component.name;var n=p[t];if(!n){n=new Promise(function(e){var n=t.replace(/\./g,"/")+"/behaviour";sap.ui.require([n],function(t){var n=r({},s);r(n,t);e(n)},function(){e(s)})});p[t]=n}return n.then(function(t){e.behaviour=t})}function b(e){e.children=[];e.willBeDisplayed=new Promise(function(t){e.display=function(){t();e.display=Function.prototype}});return e}function h(e){var o=e.oAppComponent.getFlexibleColumnLayout();if(o){e.oFlexibleColumnLayoutHandler=new n(e.oNavigationHost,e.oNavigationControllerProxy)}e.oNavigationControllerProxy.createHostView=function(){return t.create({viewName:"sap.suite.ui.generic.template.fragments.TemplateHost"})};var a=e.oAppComponent.getModel();return a.getMetaModel().loaded().then(function(){var t=e.oNavigationHost.getId();var n=e.oAppComponent.getConfig();if(!n.pages||!n.pages.length){throw new i(l,"Route Configuration missing")}if(n.pages.length>1){throw new i(l,"Currently only one Top route supported")}var o=n.pages[0];e.mEntityTree=Object.create(null);e.mRoutingTree=Object.create(null);var a=e.oAppComponent.getManifestEntry("sap.app");var r=e.oAppComponent.getManifestEntry("sap.ui");var u=b({sRouteName:"root",entitySet:o.entitySet,page:o,getPath:function(){return""},level:0,fCLLevel:0,headerTitle:a.title,text:a.description,titleIconUrl:r.icons&&r.icons.icon});y(e.oNavigationControllerProxy,u,null);var p=M([],o,u,null,e.oNavigationControllerProxy,t);return p.then(function(){var n=S("root",o,0,u,e.oNavigationControllerProxy,t,u.children);return n.then(function(){v(e.oNavigationControllerProxy,t)})})})}function S(e,t,n,o,a,r,i,l,u){return t.pages?Promise.all(t.pages.map(function(t){return N(e,t,n+1,o,a,r,i,l,u||0)})):Promise.resolve()}function P(){return"---"}function T(e,t,n,o,a,r,i,l,u,p){e=a.target||e;var s={pages:n.pages};var c={entitySet:a.entitySet,sRouteName:a.sRouteName,isDraft:a.isDraft,embeddedComponent:t,getPath:function(e){return a.getPath(e)+(e===1?"/"+t:"")},patternDelimiter:P()};return S(e,s,o,c,r,i,l,u,p)}function R(e,t,n,o,a,r,i,l,u,p,s,c){var m={};var g={key:i,definition:l,componentName:l.componentName,componentUsage:l.componentUsage,hiddenByDefault:l.hiddenByDefault,containerId:u,sectionId:p,subSectionId:s,componentId:c,pages:l.pages||[],children:[],communicationObject:m};t.embeddedComponents[i]=g;return l.pages?T(e,i,l,n,t,o,a,g.children,m,r):Promise.resolve()}function I(e,t,n,a,r,i,l){t.embeddedComponents=Object.create(null);t.leadingComponents=Object.create(null);t.facetsWithEmbeddedComponents=Object.create(null);if(n.implementingComponent){var u=o.getStableId({type:"Canvas",subType:"ImplementingComponentContainer"});var p=o.getStableId({type:"Canvas",subType:"ImplementingComponentContainerContent"});return R(e,t,a,r,i,l,"implementation",n.implementingComponent,u,null,null,p)}var s=[];if(n.embeddedComponents){var c=Object.create(null);var m=Object.create(null);var g;var d;var v;for(g in n.embeddedComponents){d=n.embeddedComponents[g];if(!d.leadingSectionIdOrPath||d.leadingSectionIdOrPath===g){c[g]=[g]}else if(n.embeddedComponents[d.leadingSectionIdOrPath]){m[g]=d.leadingSectionIdOrPath}else{v=t.facetsWithEmbeddedComponents[d.leadingSectionIdOrPath];if(v){v.push(g)}else{t.facetsWithEmbeddedComponents[d.leadingSectionIdOrPath]=[g]}}}var f=[];for(g in m){var y=m[g];v=c[y];if(v){v.push(g)}else{f.push(g);delete m[g]}}for(var C=0;C<f.length;C++){c[f[C]]=[f[C]]}for(g in n.embeddedComponents){d=n.embeddedComponents[g];var b=c[g]&&o.getStableId({type:"ObjectPageSection",subType:"ReuseComponentSection",sReuseComponentName:d.componentName,sReuseComponentUsage:d.componentUsage,sReuseComponentKey:g});var h=o.getStableId({type:"ObjectPageSection",subType:"ReuseComponentSubSection",sReuseComponentName:d.componentName,sReuseComponentUsage:d.componentUsage,sReuseComponentKey:g});var u=o.getStableId({type:"ObjectPageSection",subType:"ReuseComponentContainer",sReuseComponentName:d.componentName,sReuseComponentUsage:d.componentUsage,sReuseComponentKey:g});var S=o.getStableId({type:"ObjectPageSection",subType:"ReuseComponentContainerContent",sReuseComponentName:d.componentName,sReuseComponentUsage:d.componentUsage,sReuseComponentKey:g});var P=R(e,t,a,r,i,l,g,d,u,b,h,S);s.push(P)}Object.keys(c).forEach(function(e){var n=t.embeddedComponents[e];t.leadingComponents[e]={sectionId:n.sectionId,title:n.definition.groupTitle||n.definition.title,followingComponents:c[e].map(function(e){var o=t.embeddedComponents[e];o.sectionId=n.sectionId;return o})}})}return Promise.all(s)}function N(e,t,n,o,a,r,i,l,u){var p=t.routingSpec&&t.routingSpec.noOData;var s=a.oAppComponent.getModel();var c=s.getMetaModel();var m=c.getODataEntitySet(t.entitySet);if(t.component&&(p||m)){var g=a.oTemplateContract.oFlexibleColumnLayoutHandler?a.oTemplateContract.oFlexibleColumnLayoutHandler.getMaxColumnCountInFCL():1;var d=g===1||t.defaultLayoutType==="OneColumn"?0:u+1;var v=b({parent:o&&o.entitySet,parentRoute:o?o.sRouteName:"root",parentEmbeddedComponent:o&&o.embeddedComponent,entitySet:t.entitySet,navigationProperty:t.navigationProperty,level:n,fCLLevel:d>=g?3:d,communicationObject:l,page:t,text:"",defaultLayoutType:t.defaultLayoutType,noKey:t.routingSpec&&t.routingSpec.noKey,noOData:p});if(m){v.entitySetDefinition=m;v.entityTypeDefinition=c.getODataEntityType(m.entityType)}y(a,v,o);E(v,o,a.oTemplateContract.bCreateRequestsCanonical);x(v,a.oTemplateContract);var f=M(e,t,v,o,a,r);return f.then(function(e){var o=e;var u=a.oAppComponent.getModel();var p=u.getMetaModel().getODataEntitySet(t.entitySet);v.semanticObject=p&&p["com.sap.vocabularies.Common.v1.SemanticObject"]&&p["com.sap.vocabularies.Common.v1.SemanticObject"].String;if(i){i.push(t.entitySet)}var s=a.oTemplateContract.mEntityTree[t.entitySet];if(!s||s.level>v.level){a.oTemplateContract.mEntityTree[t.entitySet]=v}O(a,v,t);var c=S(o.target,t,n,v,a,r,v.children,l,d);return c.then(function(){return I(o.target,v,t,n,a,r,d)})})}return Promise.resolve()}function D(e,t){var n=r({},e);n.name=e.name+"query";n.pattern=e.pattern+"{?query}";t.oRouter.addRoute(n)}function O(e,t,n){if(t.noOData){t.headerTitle=n.routingSpec.headerTitle;t.titleIconUrl=n.routingSpec.titleIconUrl}else{var o=e.oAppComponent.getModel();var a=o.getMetaModel();a.loaded().then(function(){var n=a.getODataEntitySet(t.entitySet);var o=a.getODataEntityType(n.entityType);var r=o["com.sap.vocabularies.UI.v1.HeaderInfo"];var i=r&&r.TypeName&&r.TypeName.String||"";if(i.substr(0,7)==="{@i18n>"){var l=i.substring(1,i.length-1);var u=l.split(">");i=e.oAppComponent.getModel(u[0]).getResourceBundle().getText(u[1])}t.headerTitle=i;var p=r&&r.Title&&r.Title.IconUrl&&r.Title.IconUrl.String||"";t.titleIconUrl=p})}}function E(e,t,n){var o=e.level===1||!e.page.navigationProperty?e.page.entitySet:e.page.navigationProperty;var a=e.noKey?"":"({keys"+e.level+"})";var r=o+a;var i=t&&t.getPath(1);if(i){r=i+(t.patternDelimiter||"/")+r}var l;var u;if(e.noOData){var p=e.page.routingSpec.binding?"/"+e.page.routingSpec.binding:"";l=t.getPath(3)+p;u=t.getPath(2)+p}else{l="/"+e.entitySet+a;u=n||(!e.page.navigationProperty||e.level===1)?l:t.getPath(2)+"/"+e.page.navigationProperty+a}e.getPath=function(t,n){var o;switch(t){case 1:o=r;break;case 2:o=u;break;case 3:o=l;break;default:}if(n){for(var a=1;a<=e.level;a++){o=o.replace("{keys"+a+"}",n[a])}}return o}}function x(t,n){t.specificModelName="_templPrivGlobaleODESM_"+t.entitySet;n.oAppComponent.setModel(n.oAppComponent.getModel(),t.specificModelName);var o=Object.create(null);var a=Object.create(null);t.bindElement=function(e,r,i,l){var u=t.componentId&&n.componentRegistry[t.componentId];var p=u&&!r&&u.nonDraftCreateContext;if(p){e.setBindingContext(p,i?t.specificModelName:undefined);return}var s=i?o:a;var c=e.getId();r=r||t.getPath(2,n.oNavigationControllerProxy.getCurrentKeys(t.level));var m=u&&u.utils.getRootExpand();if(!m&&t.level===1&&t.isDraft){m="DraftAdministrativeData"}var g=s[c];if(g&&g.bindingPath===r&&g.expand===m){if(g.binding.isSuspended()){g.binding.resume()}return}var d={createPreliminaryContext:true,canonicalRequest:!n.bCreateRequestsCanonical};if(m){d.expand=m}g={bindingPath:r,expand:m};var v={path:r,events:l||{},parameters:d,batchGroupId:"Changes",changeSetId:"Changes"};if(i){v.model=t.specificModelName}e.bindElement(v);g.binding=e.getElementBinding(v.model);s[c]=g};t.unbindElement=function(n,r){var i=r?o:a;var l=r?t.specificModelName:undefined;var u=function(e,t){e.unbindElement(l);delete i[t]};if(n){u(n,n.getId())}else{for(var p in i){u(e.getElementById(p),p)}}}}function M(e,t,n,o,a,r){n.componentCreated=new Promise(function(e){n.componentCreatedResolve=e});var i=n.level;var l=Array.isArray(e)?e:[e];var u={};switch(i){case 0:n.sRouteName="root";break;case 1:n.sRouteName=t.entitySet;break;default:n.sRouteName=o.sRouteName+"/"+(o.embeddedComponent?o.embeddedComponent+"/":"")+(t.navigationProperty||t.entitySet)}a.oTemplateContract.mRoutingTree[n.sRouteName]=n;u.name=n.sRouteName;var p;if(a.oTemplateContract.oFlexibleColumnLayoutHandler){p=a.oTemplateContract.oFlexibleColumnLayoutHandler.adaptRoutingInfo(u,n.sRouteName,l,n)}else{p="pages";u.target=n.sRouteName}var s=C(n);return s.then(function(){f(a,n,r,p);u.pattern=n.getPath(1);a.oRouter.addRoute(u);D(u,a);return u})}function j(){return m}return{generateRoutingStructure:h,getCrossAppNavServicePromise:j,getEmbeddedComponentsPatternDelimiter:P}});
//# sourceMappingURL=routingHelper.js.map