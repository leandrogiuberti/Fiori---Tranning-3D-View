sap.ui.define(["sap/ui/base/Event","sap/ui/core/library","sap/ui/core/IconPool","sap/m/MessageToast","sap/ui/generic/app/util/MessageUtil","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/lib/TemplateComponent","sap/m/IllustratedMessageType"],function(e,t,r,a,s,n,o,i,c){"use strict";var l=t.ValueState;var g=t.IconColor;var u=new o("lib.MessageUtils").getLogger();var E=sap.ui.getCore().getMessageManager();const p=[];function T(e,t,r,a,n,o){n=n||{};var i=s.parseErrorResponse(a);var l=i.messageText;var g;var E=false;var p=false;var T=t&&t.getOwnerComponent();var f=n.resourceBundle||T.getModel("i18n").getResourceBundle();var v=n.navigationController||r.oNavigationController;var _=n.model||T.getModel();u.debug("handleError has been called with operation "+e+" and HTTP response status code "+i.httpStatusCode);var I=o&&o[i.httpStatusCode];if(I){I(i.httpStatusCode)}var d=i.httpStatusCode;switch(d){case 400:switch(e){case s.operations.modifyEntity:break;case s.operations.callAction:l=f.getText("ST_GENERIC_BAD_REQUEST_ACTION");break;case s.operations.deleteEntity:l=f.getText("ST_GENERIC_BAD_REQUEST_DELETE");break;case s.operations.editEntity:l=f.getText("ST_GENERIC_BAD_REQUEST_EDIT");break;case s.operations.saveEntity:case s.operations.activateDraftEntity:if(r&&r.oTemplateCapabilities&&r.oTemplateCapabilities.oMessageButtonHelper&&r.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover){r.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover();p=true}else{u.info("A MessageButtonHelper class instance could not be found as one of the services' template capabilities.")}break;default:l=f.getText("ST_GENERIC_BAD_REQUEST");break}break;case 401:E=true;l=f.getText("ST_GENERIC_ERROR_AUTHENTICATED_FAILED");g=f.getText("ST_GENERIC_ERROR_AUTHENTICATED_FAILED_DESC");break;case 403:switch(e){case s.operations.callAction:l=f.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_ACTION");break;case s.operations.addEntry:l=f.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_CREATE");break;case s.operations.deleteEntity:l=f.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_DELETE");break;case s.operations.editEntity:l=f.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_EDIT");break;default:l=f.getText("ST_GENERIC_ERROR_NOT_AUTORIZED");g=f.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_DESC");E=true;break}break;case 404:switch(e){case s.operations.callAction:l=f.getText("ST_GENERIC_BAD_REQUEST_ACTION");break;default:l=f.getText("ST_GENERIC_BAD_REQUEST");break}break;case 409:case 412:if((e===s.operations.activateDraftEntity||e===s.operations.deleteEntity)&&a.response&&a.response.headers&&a.response.headers["preference-applied"]==="handling=strict"){return}break;case 422:break;case 423:if(e===s.operations.activateDraftEntity||e===s.operations.saveEntity||e===s.operations.deleteEntity){return}break;case 500:case 501:case 502:case 503:case 504:case 505:E=!Object.keys(s.operations).some(function(t){return t===e});switch(e){case s.operations.callAction:l=f.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_FOR_ACTION");break;default:l=f.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE");break}g=f.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC");break;case 0:E=false;p=true;break;default:E=true;l=f.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE");g=f.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC");break}if(E){var S;if(T){var R=T.getModel("_templPriv");S=R.getProperty("/generic/viewLevel")}v.navigateToMessagePage({title:f.getText("ST_GENERIC_ERROR_TITLE"),text:l,description:g,messageType:c.UnableToLoad,viewLevel:S})}else if(!i.containsTransientMessage&&!p){s.addTransientErrorMessage(l,g,_)}}function f(t,r,a,s,o){var c;if(r instanceof e){var l=r.getParameter("item");c=l.getBindingContext("msg").getObject()}else{c=r}var g=t.oCommonUtils.getPositionableControlId(c.controlIds,true);if(!g){t.oServices.oApplication.registerForMessageNavigation(t,c,a);return}var u=Promise.resolve(false);if(s){var E=n.byId(g);if(n.isTable(E)){var p=c.controlIds.filter(function(e){var t=n.byId(e);return!n.isTable(t)});var T;p.forEach(function(e){var r=n.isElementVisibleOnView(e,null,function(t){var r=n.isView(t)&&t.getVisible()&&t.getController().getOwnerComponent();return r instanceof i&&{component:r,controlId:e}});if(r&&t.oServices.oApplication.isComponentActive(r.component)){var a=r.component.getModel("_templPriv");r.level=a.getProperty("/generic/viewLevel");if(!T||T.level<r.level){T=r}}});if(T){g=T.controlId;a=T.component}else{var f=c.aFullTargets.find(function(e){return e.startsWith(o)&&e.lastIndexOf("/")>o.length});if(f){u=t.oServices.oApplication.navigateToMessageTarget(c,f)}}}}u.then(function(e){if(e){return}var r={targetInfo:c};t.oServices.oApplication.prepareForControlNavigation(a,g).then(function(){var e=n.byId(g);var t=n.isSmartField(e)?n.getSmartFieldIsFocussableForInputPromise(e):Promise.resolve(true);t.then(function(t){n.focusUI5Control(t?e:e.getParent(),r)})})})}function v(e,t){var r=E.getMessageModel().getData();var a=r.some(function(e){return e.persistent&&t.oApplication.isTransientMessageNoCustomMessage(e)});if(!a){t.oApplication.showMessageToast(e)}}function _(e,t){var r=e.some(function(e){var r=t.oCommonUtils.getPositionableControlId(e.controlIds,true);return!r||n.isTable(n.byId(r))});return r?t.oComponentUtils.prepareForMessageHandling(e):Promise.resolve()}function I(e){var t=e.getTechnicalDetails();return!!t&&t.statusCode==="412"&&!t.headers["preference-applied"]}function d(e){var t=E.getMessageModel().getData();return t.find(function(t){return t.id===e})}function S(e,t){var r=E.getMessageModel().getProperty("/");var a=r.filter(function(r){return r.persistent&&(e||!r.technicalDetails||r.technicalDetails.statusCode!=="404"||r.type!=="Error")&&t(r)});return a}function R(e){var t=S(true,e);if(t.length>0){E.removeMessages(t)}}function m(e){var t=l.None,r=0;for(var a=0;a<e.length;a++){var s=b(e[a]);if(s>r){t=e[a].type;r=s}}return t}function A(e,t){var r,a="";r=m(e);var s="";if(r===l.Error){s=e.length>1?"ST_MESSAGES_DIALOG_TITLE_ERROR_PLURAL":"ST_MESSAGES_DIALOG_TITLE_ERROR"}else if(r===l.Warning){s=e.length>1?"ST_MESSAGES_DIALOG_TITLE_WARNING_PLURAL":"ST_MESSAGES_DIALOG_TITLE_WARNING"}else if(r===l.Information){s="ST_MESSAGES_DIALOG_TITLE_INFORMATION"}else if(r===l.Success){s="ST_MESSAGES_DIALOG_TITLE_SUCCESS_PLURAL"}a=t.getText(s);return{sTitle:a,sSeverity:r}}function C(e,t,r){var s=e.oApplicationProxy.isTransientMessageNoCustomMessage;var o;R(P.bind(this));var i=S(false,s);if(i.length===0){return Promise.resolve()}R(s);if(i.length===1){o=i[0].type;if(o===l.Success||o===l.Information||o===l.None){a.show(i[0].message);return Promise.resolve()}}var c=A(i,e);o=c.sSeverity;return new Promise(function(a){var s,g,u;var E=function(){u.setProperty("/backButtonVisible",false);u.setProperty("/messages",[]);u.setProperty("/messageToGroupName",Object.create(null));g.navigateBack();u.getProperty("/resolve")()};var p={onMessageDialogClose:function(){s.close()},onActionButtonPressed:function(){u.getProperty("/actionButtonCallback")();s.close()},afterClose:E,onBackButtonPress:function(){u.setProperty("/backButtonVisible",false);g.navigateBack()},onMessageSelect:function(){var e=s.getButtons().find(function(e){return e.isFocusable()});n.focusUI5Control(e);u.setProperty("/backButtonVisible",true)},getSeverityIconFromIconPool:M,getIconColor:y};var T=function(t,r){r.setProperty("/genericGroupName",e.getText("ST_MESSAGE_GENERAL_TITLE"));r.setProperty("/backButtonVisible",false);r.setProperty("/cancelButtonText",e.getText("CANCEL"));r.setProperty("/closeButtonText",e.getText("ST_GENERIC_DIALOG_CLOSE_BUT"))};var f=function(e){var t=sap.ui.require("sap/ushell/Container");if(!t){e.promise.resolve({allowed:false,id:e.id})}t.getServiceAsync("Navigation").then(function(t){t.isUrlSupported(e.url).then(function(){e.promise.resolve({allowed:true,id:e.id})}).catch(function(){e.promise.resolve({allowed:false,id:e.id})})})};e.oApplicationProxy.getDialogFragmentAsync("sap.suite.ui.generic.template.fragments.MessageDialog",p,"settings",T,false,true).then(function(e){s=e;g=s.getContent()[0];g.setAsyncURLHandler(f);var n=s.getModel();var E=n&&n.getMetaModel();var p=false;var T=!!(r&&r.action);var v=Object.create(null);if(E){i.forEach(function(e){var t=e.getTargets()[0];if(!t){return}if(t.lastIndexOf("/")>0){t=t.substring(0,t.lastIndexOf("/"))}var r=t.substring(1,t.indexOf("("));var a=r&&E.getODataEntitySet(r);var s=a&&E.getODataEntityType(a.entityType);var o=s&&s["com.sap.vocabularies.UI.v1.HeaderInfo"];var i=o&&o.Title&&o.Title.Value&&o.Title.Value.Path;var c=n.getProperty(t);var l=c&&c[i];if(l){v[e.getId()]=l;p=true}})}u=s.getModel("settings");u.setProperty("/showActionButton",T);if(T){u.setProperty("/actionButtonText",r.actionLabel);u.setProperty("/actionButtonCallback",r.action)}u.setSizeLimit(9999);u.setProperty("/title",o!==l.Error&&o!==l.Warning&&t||c.sTitle);u.setProperty("/messages",i);u.setProperty("/grouping",p);u.setProperty("/state",o);u.setProperty("/resolve",a);u.setProperty("/messageToGroupName",v);s.open()})})}function b(e){var t;switch(e.type){case"Error":t=4;break;case"Warning":t=3;break;case"Information":t=2;break;case"Success":t=1;break;default:t=0}return t}function M(e){switch(e){case l.Error:return r.getIconURI("error");case l.Warning:return r.getIconURI("alert");case l.Information:return r.getIconURI("information");case l.Success:return r.getIconURI("sys-enter-2");default:return""}}function y(e){switch(e){case l.Error:return g.Negative;case l.Warning:return g.Critical;case l.Success:return g.Positive;default:return""}}function h(e){var t=[];e.forEach(function(e){var r=d(e);if(r){t.push(r)}});E.removeMessages(t)}function N(e){const t=e?.innererror?.errordetails?.[0];if(t){p.push(t)}}function O(e,t){const r=["code","message","severity","target","transition"];for(const a of r){const r=a in e;const s=a in t;if(r&&s){if(e[a]!==t[a]){return false}}else if(r||s){return false}}return true}function P(e){const t=e?.technicalDetails?.headers?.["sap-message"];if(!t){return false}let r;r=JSON.parse(t);return p.some(e=>this.areMessagesSame(e,r))}function D(){p.length=0}return{operations:s.operations,handleTransientMessages:C,prepareForMessageHandling:_,handleError:T,navigateFromMessageTitleEvent:f,removeTransientMessages:R,getTransientMessages:S,showSuccessMessageIfRequired:v,parseError:s.parseErrorResponse,isMessageETagMessage:I,getMessageById:d,getSeverityAsNumber:b,getSeverityIconFromIconPool:M,getIconColor:y,getMessageDialogTitleAndSeverity:A,deleteMessages:h,cacheWarningMessage:N,areMessagesSame:O,isDuplicateMessage:P,clearWarningCache:D}});
//# sourceMappingURL=MessageUtils.js.map