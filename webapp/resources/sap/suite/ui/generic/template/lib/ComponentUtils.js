sap.ui.define(["sap/ui/base/Object","sap/ui/model/base/ManagedObjectModel","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper","sap/suite/ui/generic/template/lib/CRUDActionHandler","sap/suite/ui/generic/template/lib/StatePreserver","sap/base/util/extend","sap/base/util/isEmptyObject","sap/suite/ui/generic/template/genericUtilities/FeError","sap/suite/ui/generic/template/lib/CommandComponentUtils","sap/suite/ui/generic/template/lib/ViewCreationHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper"],function(e,t,n,o,r,a,i,s,l,u,c,p,d){"use strict";var f="lib.ComponentUtils";var g=new o(f).getLogger();var m={isPreliminary:function(){return false}};function v(e,t,n){var o;for(o=n;o.level>t.level;o=e[o.parentRoute]){g.info("Checked test node with route "+o.sRouteName)}return o===t}function C(e,o){var C=o.oTemplateContract.mRoutingTree[o.route];var h;var b;var P;var y;var x=false;var T;var A;var R=false;var S;var I=[];var F=[];var D=new c(o);function E(){return e.getModel("_templPriv")}function N(e){return o.oTemplateContract.oNavigationControllerProxy.preloadComponent(e)}function B(){var t=e.getAppComponent();return t.getModel("_templPrivGlobal")}function w(){return C.level}function M(){var t=o.oTemplateContract.oApplicationProxy.getAncestralNode(C,1);if(t){var n={};var r=t.getPath(2,Re());n.bindingContext=e.getModel().createBindingContext(r)||e.getModel().getContext(r);n.entitySet=t.entitySet;n.view=t.componentId&&o.oTemplateContract.componentRegistry[t.componentId].oController.getView();n.componentId=t.componentId;return n}return null}function O(){var e=o.oTemplateContract.oApplicationProxy.getAncestralNode(C,1);var t=Promise.resolve();if(!e.componentId){t=N(e.sRouteName)}var n;return t.then(function(){return e.componentCreated}).then(function(e){n=o.oTemplateContract.componentRegistry[e.getId()];return n.viewRegistered}).then(function(){return{getText:n.oControllerUtils.oCommonUtils.getText,getRootExpand:n.oControllerUtils.oComponentUtils.getRootExpand,entitySet:e.entitySet}})}function U(){return o.preprocessorsData}function H(e){var t=o.oTemplateContract.oNavigationControllerProxy.getCurrentIdentity();var n=t.keys;var r=[];for(var a=0;a<e;a++){r[a]=""}var i=o.oTemplateContract.oApplicationProxy.fillSiblingKeyPromise(t.treeNode,n,r,"Changes");return i.then(function(e){return{keys:r,treeNode:e}})}function j(){var e=U();var t=V().getObject("/templateSpecific/streamEnabledAssociatedEntites");var n=[];if(e&&e.rootContextExpand){n=e.rootContextExpand}n=t&&t.length>0?n.concat(t):n;if(n){var o=n.filter(function(e,t){return n.indexOf(e)===t});return o.join(",")}}function V(){return o.oParameterModel}function L(e,t,n){if(typeof n!=="function"){throw new u(f,"Event handler must be a function")}F.push({template:e,event:t,handler:n})}function k(e,t,n){for(var o=F.length;o--;){if(F[o].handler===n&&F[o].event===t&&F[o].template===e){F.splice(o,1)}}}function q(e,t,n){for(var o=0;o<F.length;o++){if(F[o].event===t&&F[o].template===e){F[o].handler(n)}}}function $(e){return e.getMetadata().getName()}function G(){return o.oApplication.isComponentActive(e)}function K(e){var t=o.oTemplateContract.componentRegistry[e];var n=o.oTemplateContract.mRoutingTree[t.route];var r=n.level<C.level;var a=r?v(o.oTemplateContract.mRoutingTree,n,C):v(o.oTemplateContract.mRoutingTree,C,n);return(n.level-C.level)*a}function W(){return o.oNavigationObserver.getProcessFinished(true)}function _(e,t){var n=W();n.then(function(){if(G()){if(t){le(true,false)}q($(o.oController),"PageDataLoaded",{context:e});if(e&&Be()){var n=e.getObject();if(!n.IsActiveEntity){o.oApplication.getDraftSiblingPromise(e)}}}})}function z(){h.then(function(e){if(e){_(e)}})}function J(){o.oHeaderLoadingObserver.startProcess();if(!T){var e=new Promise(function(e){T=e});o.oApplication.getBusyHelper().setBusy(e,undefined,undefined,true)}}function Q(){if(!b){h=new Promise(function(e){b=e})}}if(C.getPath(3)){Q()}else{h=Promise.resolve()}function X(t){g.info("Request header data",t.getSource().getPath(),"Class sap.suite.ui.generic.template.lib.ComponentUtils");R=true;Q();if(!e.getComponentContainer().getElementBinding().isSuspended()){J()}}function Y(){if(T){T();T=null}if(A){A();A=null}o.oHeaderLoadingObserver.stopProcess()}function Z(t){var n=t.getSource().getBoundContext();if(n){return n}if(e.getComponentContainer().getElementBinding().isSuspended()){n=null}else{n=m}ie();return n}function ee(){x=true;var e=o.oTemplateContract.oNavigationControllerProxy.getActiveComponents();var t=e.find(function(e){return o.oTemplateContract.componentRegistry[e].utils.getDataNotExisting()});var n=o.oTemplateContract.componentRegistry[t];var r=o.oTemplateContract.mRoutingTree[n.route];o.oTemplateContract.oNavigationControllerProxy.navigationContextNotFound(r)}function te(){return x}function ne(){R=false;if(!y){return}if(y===m){ee();ie()}else if(!e.getComponentContainer().getElementBinding().isSuspended()){var t=e.getBindingContext();var n=ye(t);var r=n.bIsDraft||o.oApplication.getObjectInEditMode();var a;if(r){o.oApplication.setObjectInEditMode(false);a=n.bIsCreate?4:2}else{a=1}var i=E();var s=e.getModel("ui");i.setProperty("/objectPage/displayMode",a);s.setProperty("/editable",r);s.setProperty("/enabled",true);s.setProperty("/createMode",n.bIsCreate);(o.methods.updateBindingContext||Function.prototype)(t);if(b){b(y)}}else{return}b=null;y=null}function oe(e){g.info("Received header data",e.getSource().getPath(),"Class sap.suite.ui.generic.template.lib.ComponentUtils");P();Y();if(R){y=Z(e)}ne()}function re(e){P();var t=Z(e);if(t&&t.isPreliminary()){return}y=t;ne();o.oHeaderLoadingObserver.stopProcess()}function ae(t){x=false;o.oHeaderLoadingObserver.startProcess();var n=new Promise(function(e){P=e});Q();if(o.methods.beforeRebind){o.methods.beforeRebind(n)}y=null;C.bindElement(e.getComponentContainer(),t,false,{dataRequested:X,dataReceived:oe,change:re});S=t;let r=o.oTemplateContract.mRoutingTree;let a=r[C.parentRoute];while(a.level>0){a.bindElement(o.oTemplateContract.oNavigationHost,null,true);a=r[a.parentRoute]}if(o.methods.afterRebind){o.methods.afterRebind()}}function ie(){Q();var t=e.getComponentContainer();t.setBindingContext();C.unbindElement(t);S=null;y=null;R=false;Y()}function se(){var e=Re();var t=e.length===I.length;for(var n=0;n<e.length&&t;n++){t=e[n]===I[n]}I=e;return!t}function le(e,t){o.reuseComponentsReady.then(function(n){for(var o in n){var r=n[o];if(!t||r.isStarted()){r.pathUnchangedCallBack(e)}}})}function ue(e,t){var n=Object.create(null);for(var o in e){var r=e[o];n[o]=t(r,o)}return n}function ce(){var e=E();for(var t in C.embeddedComponents){var n=!!C.embeddedComponents[t].definition.hiddenByDefault;e.setProperty("/generic/embeddedComponents/"+t+"/hidden",n)}}function pe(t,n){var r=se();if(r&&!n){ce()}if(!t){if(o.routingSpec&&o.routingSpec.noOData){_(null,r)}return Promise.resolve()}var a=Promise.resolve();if(o.oController){var i=o.oController.getView();if(i&&i.isDestroyed()){a=p.initializeViewCreation(o);e.onBeforeRendering(o)}}var s=e.getComponentContainer();if(!s){return Promise.resolve()}return a.then(function(){var a=e.getModel("ui");var i=!!o.nonDraftCreateContext;if(i){var l=s.getBindingContext();if(l===o.nonDraftCreateContext){return}a.setProperty("/enabled",true);a.setProperty("/editable",true);a.setProperty("/createMode",true);ie();if(b){b(o.nonDraftCreateContext);b=null}else{h=Promise.resolve(o.nonDraftCreateContext)}z();if(o.methods.beforeRebind){o.methods.beforeRebind(h)}s.setBindingContext(o.nonDraftCreateContext);Promise.all([o.oViewRenderedPromise,o.viewRegistered]).then(le.bind(null,true,false));if(o.methods.afterRebind){o.methods.afterRebind()}}else{var u=s.getElementBinding();if(u){if(S===t){if(u.isSuspended()){u.resume();ne()}if(R){J()}o.oApplication.getBusyHelper().getUnbusy().then(le.bind(null,r,false));if(!n){z()}if(!n&&!Be()){var c=o.oApplication.getEditFlowOfRoot();if(c==="direct"){a.setProperty("/editable",true)}else{a.setProperty("/editable",false)}}a.setProperty("/enabled",true);return}else if(!n){ie()}}a.setProperty("/enabled",false);a.setProperty("/editable",false);a.setProperty("/createMode",false);ae(t);z()}})}function de(t,n){var r={};if(t){r.discardPromise=t}var a=e.getModel();if(a.hasPendingChanges()){var i=o.oController.getView();i.setBindingContext(null);a.resetChanges();i.setBindingContext()}var s=e.getModel("ui");if(n||s.getProperty("/editable")){if(!t){delete o.nonDraftCreateContext;s.setProperty("/editable",false);var l=E();l.setProperty("/objectPage/displayMode",1)}q($(o.oController),"AfterCancel",r)}}function fe(e,t){return Be()?null:o.oTemplateContract.oNavigationControllerProxy.navigateForNonDraftCreate(e,t)}function ge(e,t){o.oApplication.setObjectInEditMode(t);o.oTemplateContract.oNavigationControllerProxy.adaptUrlAfterNonDraftCreateSaved(e)}function me(){return S}function ve(t){var n=e.getComponentContainer().getElementBinding();if(n){e.getModel().invalidateEntry(n.getBoundContext());if(n.isSuspended()){ie()}else{if(!A){var r=new Promise(function(e){A=e});o.oTemplateContract.fnAddSideEffectPromise(r)}n.refresh(!t);o.bWithoutAssociationsRefresh=false}}}function Ce(t,n){t=t||e.getIsRefreshRequired();if(t||!l(o.mRefreshInfos)||o.bWithoutAssociationsRefresh){(o.methods.refreshBinding||Function.prototype)(t,o.mRefreshInfos,o.bWithoutAssociationsRefresh,n);e.setIsRefreshRequired(false);o.mRefreshInfos=Object.create(null)}le(t,true)}function he(t){var n=e.getModel();var r={canonicalRequest:!o.oTemplateContract.bCreateRequestsCanonical,batchGroupId:t||"facets",updateAggregatedMessages:true};n.read(S,r)}function be(t){if(Be()){var n=e.getComponentContainer();var o=n.getElementBinding();if(o&&!o.isSuspended()){o.suspend();t.catch(function(){o.resume()})}}}function Pe(){var t=e.getComponentContainer();if(o.nonDraftCreateContext){t.setBindingContext();delete o.nonDraftCreateContext;return}var r=t.getElementBinding();if(r&&!r.isSuspended()){var a=o.oTemplateContract.oValidationMessageBinding.getAllCurrentContexts();var i=o.oController.getView();var s=a.some(function(e){var t=e.getObject();var o=t.controlIds;return o.some(function(e){return n.isElementVisibleOnView(e,i)})});if(s){ie()}else{r.suspend()}Y()}}function ye(t){var n=w();return o.oApplication.registerContext(t,n,e.getEntitySet(),Re())}function xe(e){if(e.level<2){return[e.entitySet]}var t=o.oTemplateContract.mRoutingTree[e.parentRoute];var n=xe(t);if(e!==C){n.push(e.navigationProperty?n[t.level-1]+"/"+e.navigationProperty:e.entitySet)}return n}function Te(){return C.level<2?[]:xe(C)}function Ae(e,n,r){var a;for(a=C;a.level>r;){a=o.oTemplateContract.mRoutingTree[a.parentRoute]}var i=new t(e);i.bindProperty("/"+n).attachChange(function(e){var t=e.getSource().getValue();o.oTemplateContract.oNavigationControllerProxy.setTextForTreeNode(a,t)});a.contextTargets=a.contextTargets||[];a.contextTargets.push(e)}function Re(){return o.oApplication.getCurrentKeys(w())}function Se(t){return o.oApplication.getCommunicationObject(e,t)}function Ie(e,t,n,r,a){o.oTemplateContract.oNavigationControllerProxy.navigateToChildInHierarchy(C,e,n,t,r,a)}function Fe(e,t,n){o.oTemplateContract.oNavigationControllerProxy.navigateFromNodeAccordingToContext(C,e,t,n)}function De(){var t=e.getAppComponent().getManifestEntry("sap.app");return t.title??""}function Ee(){return C.headerTitle}function Ne(e){o.oTemplateContract.oNavigationControllerProxy.setTextForTreeNode(C,e)}function Be(){return C.isDraft}function we(){return!(o.routingSpec&&o.routingSpec.noOData)}function Me(){return!o.oTemplateContract.bCreateRequestsCanonical}function Oe(){return h}function Ue(){return o.oTemplateContract.oPaginatorInfo[w()-1]}function He(t){var n=w();var a=t&&!t.suppressButtons&&t.objectPageNavigationContexts.find(function(e){return e});if(a){var i=r.analyseContext(a);var s=i.entitySet;t.suppressButtons=o.mRefreshInfos[s]||e.getIsRefreshRequired()}o.oTemplateContract.oPaginatorInfo[n]=t}function je(e,t){o.reuseComponentsReady.then(function(n){var o=t.getComponentInstance();for(var r in n){if(o===n[r].component){var a=E();a.setProperty("/generic/embeddedComponents/"+r+"/isInVisibleArea",e);return}}})}function Ve(){return o.oStatePreserverPromise.then(function(e){return e.stateChanged()})}o.oStatePreserverPromise=o.reuseComponentsReady.then(function(t){var n=o.methods.getStatePreserverSettings&&o.methods.getStatePreserverSettings();if(!n){return{getUrlParameterInfo:function(){return Promise.resolve({})},applyAppState:Function.prototype,stateChanged:Function.prototype}}var r="sap-iapp-state"+(C.level===0?"":"-"+C.entitySet);var a=function(e){var n=e?"getInitialState":"getCurrentState";var r=e?"stGetInitialState":"stGetCurrentState";return function(){var e=o.methods[n]?o.methods[n]():Object.create(null);var a=function(t,n){if(t.component[r]){var o=t.component[r]();for(var a in o){e["$embeddedComponent$"+n.length+"$"+n+"$"+a]=o[a]}}};ue(t,a);return e}};var l=s({appStateName:encodeURI(r),getCurrentState:a(false),getInitialState:a(true),applyState:function(e,n){var r=Object.create(null);var a=Object.create(null);for(var i in e){if(i.indexOf("$embeddedComponent$")===0){var s=i.substring(19);var l=s.indexOf("$");var u=Number(s.substring(0,l));var c=s.substring(l+1,l+u+1);var p=a[c];if(!p){p=Object.create(null);a[c]=p}var d=s.substring(l+u+2);p[d]=e[i]}else{r[i]=e[i]}}var f=(o.methods.applyState||Function.prototype)(r,n);var g=function(e,t){if(e.component.stApplyState){e.component.stApplyState(a[t]||Object.create(null),n)}};Promise.all([o.oViewRenderedPromise,h]).then(ue.bind(null,t,g));return f},oComponent:e},n);var u=new i(o.oTemplateContract,l);o.oApplication.registerStateChanger(u.getAsStateChanger());return u});o.oTemplateContract.oStatePreserversAvailablePromise=Promise.all([o.oTemplateContract.oStatePreserversAvailablePromise,o.oStatePreserverPromise]);function Le(){var e=o.oTemplateContract.oFlexibleColumnLayoutHandler;return e?e.getFclProxy(C):{handleDataReceived:C.level?null:Function.prototype,isListAndFirstEntryLoadedOnStartup:C.level?null:Function.prototype,isNextObjectLoadedAfterDelete:Function.prototype}}function ke(){return C.page.component.settings||{}}function qe(){var t=e.getAppComponent().getManifestEntry("sap.ui5");var n=t.extends&&t.extends.extensions&&t.extends.extensions["sap.ui.controllerExtensions"];var r=o.methods.oComponentData.templateName+"#"+o.oComponent.getAppComponent().getMetadata().getComponentName()+"::"+o.methods.oComponentData.templateName+"::"+o.oComponent.getEntitySet();n=n&&(n[r]||n[o.methods.oComponentData.templateName]);n=n&&n["sap.ui.generic.app"];var a=n&&Object.keys(n).find(function(t){return n[t]&&n[t].EntitySet===e.getEntitySet()});return a&&n[a]}function $e(){var t=e.getAppComponent().getManifestEntry("sap.ui5");var n=t.extends&&t.extends.extensions&&t.extends.extensions["sap.ui.viewExtensions"];return n&&n[o.methods.oComponentData.templateName]}function Ge(e){o.aUnsavedDataCheckFunctions=o.aUnsavedDataCheckFunctions||[];o.aUnsavedDataCheckFunctions.push(e)}function Ke(){if(o.methods.adaptToChildContext){var e=E().getProperty("/generic/currentActiveChildContext");o.methods.adaptToChildContext(e)}}var We;function _e(){We=We||new a(o.oTemplateContract,o.oController,o.oControllerUtils.oCommonUtils,o.methods.prepareForMessageHandling||function(){return Promise.resolve()});return We}function ze(e){if(o.methods.executeAfterInvokeActionFromExtensionAPI){o.methods.executeAfterInvokeActionFromExtensionAPI(e,o.oControllerUtils.oCommonUtils)}}function Je(e){if(o.methods.executeBeforeInvokeActionFromExtensionAPI){o.methods.executeBeforeInvokeActionFromExtensionAPI(e,o.oControllerUtils.oCommonUtils)}}function Qe(){var e=o.oController.getView();var t=e.getModel();if(t.hasPendingChanges(true)){return true}if(o.aUnsavedDataCheckFunctions){return o.aUnsavedDataCheckFunctions.some(function(e){return e()})}return false}function Xe(e){if(o.reactivate&&!e){return}if(!o.oController){return}var t=o.oController.onLeaveAppExtension&&o.oController.onLeaveAppExtension.apply(o.oController,[e]);o.reactivate=o.reuseComponentsReady.then(function(n){var o=Object.create(null);ue(n,function(t,n){var r=t.leaveApp(e);if(r&&!e){o[n]=r}});return!e&&function(){if(t){t()}for(var e in o){o[e]()}}})}function Ye(){if(o.oTemplateContract.oFlexibleColumnLayoutHandler){o.oTemplateContract.oFlexibleColumnLayoutHandler.hidePlaceholder(C)}else{o.oTemplateContract.oNavigationHost.hidePlaceholder()}if(C.level===0){var e=o.oTemplateContract.oNavigationControllerProxy.oRouter.getTargets();var t=e.getTarget("root");delete t._oOptions.placeholder}}function Ze(t){var n=o.oTemplateContract.oNavigationControllerProxy.getActiveComponents();var r=n.indexOf(e.getId());var a=[];for(var i=r;i<n.length;i++){var s=n[i];var l=o.oTemplateContract.componentRegistry[s];if(l.methods.prepareForMessageHandling){a.push(l.methods.prepareForMessageHandling(t))}}return Promise.all(a)}function et(){return o.oViewRenderedPromise}function tt(){return o.viewRegistered}function nt(){return C.selectionInfo}function ot(){var e=ke();var t=new URLSearchParams(window.location.search).get("sap-fe-xx-lazyloadingtest");return t!=null?t==="true":e.renderingBehavior&&e.renderingBehavior.waitForViewportEnter}function rt(){return o.lastFocus}function at(e,t){var n=e["sap.app"].crossNavigation&&e["sap.app"].crossNavigation.outbounds;return n&&n[t]||Object.create(null)}function it(e){var t=C.page.pages;return!!(t&&t.some(function(t){return e===t.entitySet}))}function st(){return o.oTemplateContract.bStateHandlingSuspended}function lt(){var e=B();return e.getProperty("/generic/ui5VersionInfo")}function ut(e){o.oTemplateContract.oNavigationControllerProxy.openContextInNewTab(C,e)}function ct(e){return o.oTemplateContract.oNavigationControllerProxy.getTargetIdentityForContext(C,e)}d.testableStatic(ae,"filterHelper_fnRebindHeaderData");return{getBusyHelper:function(){return o.oApplication.getBusyHelper()},attach:function(e,t,n){L($(e),t,n)},detach:function(e,t,n){k($(e),t,n)},fire:function(e,t,n){q($(e),t,n)},getPreprocessorsData:U,getRootExpand:j,getParameterModelForTemplating:V,bindComponent:pe,cancelEdit:de,getNonDraftCreatePromise:fe,adaptUrlAfterNonDraftCreateSaved:ge,getBindingPath:me,refreshBinding:Ce,refreshBindingUnconditional:ve,suspendBinding:Pe,messagesRefresh:he,getTemplatePrivateModel:E,getTemplatePrivateGlobalModel:B,getViewLevel:w,getMainComponentDetails:M,getMainComponentUtils:O,getBreadCrumbInfo:Te,registerAncestorTitleUpdater:Ae,getCurrentKeys:Re,getCommunicationObject:Se,navigateRoute:Ie,navigateAccordingToContext:Fe,getAppTitle:De,getTitle:Ee,setText:Ne,onBeforeDraftTransfer:be,isDraftEnabled:Be,isODataBased:we,getNoStateMessagesForTables:Me,isComponentActive:G,getHierarchicalDistance:K,getDataNotExisting:te,getHeaderDataAvailablePromise:Oe,getPaginatorInfo:Ue,setPaginatorInfo:He,onVisibilityChangeOfReuseComponent:je,getNavigationFinishedPromise:W,stateChanged:Ve,unbind:ie,getFclProxy:Le,getSettings:ke,getControllerExtensions:qe,getViewExtensions:$e,registerUnsavedDataCheckFunction:Ge,layoutChanged:Ke,getCRUDActionHandler:_e,executeAfterInvokeActionFromExtensionAPI:ze,executeBeforeInvokeActionFromExtensionAPI:Je,preloadComponent:N,isComponentDirty:Qe,getTargetKeyFromLevel:H,leaveApp:Xe,hidePlaceholder:Ye,prepareForMessageHandling:Ze,getViewRenderedPromise:et,getViewInitializedPromise:tt,getSelectionInfo:nt,isRenderingWaitingForViewportEntered:ot,getLastFocus:rt,getOutboundNavigationIntent:at,canNavigateToSubEntitySet:it,getToolbarDataFieldForActionCommandDetails:D.getToolbarDataFieldForActionCommandDetails,getToolbarDataFieldForIBNCommandDetails:D.getToolbarDataFieldForIBNCommandDetails,isStateHandlingSuspended:st,getUI5VersionInfo:lt,openContextInNewTab:ut,getTargetIdentityForContext:ct}}return e.extend("sap.suite.ui.generic.template.lib.ComponentUtils",{constructor:function(e,t){s(this,C(e,t))}})});
//# sourceMappingURL=ComponentUtils.js.map