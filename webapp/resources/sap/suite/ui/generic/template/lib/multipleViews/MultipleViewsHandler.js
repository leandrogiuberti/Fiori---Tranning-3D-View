sap.ui.define(["sap/ui/base/Object","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/multipleViews/MultipleTablesModeHelper","sap/suite/ui/generic/template/lib/multipleViews/SingleTableModeHelper","sap/fe/navigation/SelectionVariant","sap/suite/ui/generic/template/genericUtilities/metadataAnalyser","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/base/security/encodeURL","sap/ui/comp/util/DateTimeUtil","sap/base/util/isEmptyObject","sap/ui/core/format/NumberFormat","sap/suite/ui/generic/template/genericUtilities/filterHelper"],function(e,t,r,n,a,i,o,s,l,u,p,c,f,g){"use strict";var m=new o("lib.multipleViews.MultipleViewsHandler").getLogger();function d(e,o,d){var v=Object.create(null);var S=o.oComponentUtils.getTemplatePrivateModel();var y=d.pathInTemplatePrivateModel+"/items";var h=d.pathInTemplatePrivateModel+"/selectedKey";S.setProperty(d.pathInTemplatePrivateModel,Object.create(null));S.setProperty(y,Object.create(null));var C=new(d.mode==="single"?n:r)(e,o,d);S.setProperty(d.pathInTemplatePrivateModel+"/mode",C.getMode());var b;var P=new Promise(function(e){b=e});var O=o.oServices.oApplication.getBusyHelper().getBusyDelay();var F=e.getOwnerComponent().getModel();var T;var E;var M=[];var w;function I(){if(E){var e=d.getSearchValue&&d.getSearchValue();var t=e?{search:e}:{};var r=(C.getBatchGroupIdForCount||Function.prototype)();for(var n in v){var a=v[n];var i=a.getPath();a.numberOfUpdates++;a.updateStartFunction(a.numberOfUpdates);F.read(i+"/$count",{urlParameters:t,filters:a.getFiltersForCount&&a.getFiltersForCount(),groupId:r,success:a.updateSuccessFunction.bind(null,a.numberOfUpdates),error:a.errorFunction.bind(null,a.numberOfUpdates)})}}}function U(e,t){var r="";var n=t["parameters"];if(!t||!t.entitySetName||!t.navPropertyName||n.length<1){r="/"+e.name;return r}var i=d.smartFilterBar&&d.smartFilterBar.getAnalyticalParameters();if(i&&i.length>0){var o=d.smartFilterBar&&d.smartFilterBar.getUiState({allFilters:false});var s=o?JSON.stringify(o.getSelectionVariant()):"{}";var l=new a(s);var c=[];n.forEach(function(e){i.forEach(function(t){if(t&&t.name===e){var r=t.name;var n=l.getParameter(r);if(t.type==="Edm.DateTime"||t.type==="Edm.DateTimeOffset"){n=new Date(n);n=p.localToUtc(n)}else if(t.type==="Edm.String"&&t["sap:parameter"]==="optional"){if(n===undefined){n=""}}n=u(t.control.getModel().formatValue(n,t.type));c.push(r+"="+n)}})});r="/"+t.entitySetName+"("+c.join(",")+")/"+t.navPropertyName}else{r="/"+e.name;m.error("SelectionParameters","There are no parameters to resolve");return r}return r}function B(t){var r;var n=t.getEntitySet();var a=e.getOwnerComponent();if(d.smartFilterBar&&d.smartFilterBar.getConsiderAnalyticalParameters&&d.smartFilterBar.getConsiderAnalyticalParameters()){var o=F.getMetaModel();var s=o.getODataEntitySet(n);var l=a.getAppComponent();var u=i.getParametersByEntitySet(l.getModel(),n);r=d.resolveParameterizedEntitySet?d.resolveParameterizedEntitySet(s,u):U(s,u);return r}var p=t.getBindingPath();r=p?p:"/"+n;var c=a.getComponentContainer();var f=c.getElementBinding();return f?f.getPath()+"/"+r:r}function V(e,r){var n=F.getMetaModel();var a=n.getODataEntityType(n.getODataEntitySet(e.getEntitySet()).entityType);var i=[],o;var s=r.variantAnnotationPath;if(s){var l=a[s];if(!l){return[]}if(!l.SelectOptions&&l.SelectionVariant){l=l.SelectionVariant;if(l.Path){s=l.Path.split("@")[1];l=s&&a[s]}}if(l.AnnotationPath){o=l.AnnotationPath.split("@")[1];l=a[o]}for(var u in l.SelectOptions){if(l.SelectOptions[u].PropertyName){var p=l.SelectOptions[u].PropertyName.PropertyPath;for(var c in l.SelectOptions[u].Ranges){var f=l.SelectOptions[u].Ranges[c].Sign&&l.SelectOptions[u].Ranges[c].Sign.EnumMember;var g=l.SelectOptions[u].Ranges[c].Option&&l.SelectOptions[u].Ranges[c].Option.EnumMember;g=f?R(f.replace("com.sap.vocabularies.UI.v1.SelectionRangeSignType/",""),g.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","")):g.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","");var m=l.SelectOptions[u].Ranges[c].Low;var d=l.SelectOptions[u].Ranges[c].High;var v=H(m);if(d){var S=H(d);i.push(new t(p,g,v,S))}else{i.push(new t(p,g,v))}}}}}return i}function R(e,t){var r;var n=new Map([["EQ","NE"],["BT","NB"],["CP","NP"],["LE","GT"],["GE","LT"],["NE","EQ"],["NB","BT"],["NP","CP"],["GT","LE"],["LT","GE"]]);if(e==="I"){r=t}else if(e==="E"){if(n.has(t)){r=n.get(t)}else{r=t}}return r}function H(e){var t;if(e){if(e.String){t=e.String}else if(e.Bool){t=e.Bool.toLowerCase()==="true"}else{var r=Object.keys(e)[0];t=e[r]}}return t}function N(e){for(var t in v){var r=v[t];if(r.presentationControlHandler.getEntitySet()===e){return t}}return""}function A(e){return!!N(e)}function K(e){return e&&L().presentationControlHandler.getEntitySet()!==e&&N(e)||w}function x(e,t){if(E){var r=C.getCommonFiltersForCounts?C.getCommonFiltersForCounts(e.filters,t):e.filters;for(var n in v){var a=v[n];a.getFiltersForCount=D.bind(null,r,a,true)}}var i=L();e.filters=D(e.filters,i,false)}function D(e,t,r){e=g.fnNormaliseControlFilters(e);if(C.getFiltersAdaptedFromItem){e=C.getFiltersAdaptedFromItem(e,t,r)}return e.concat(t.selectionVariantFilters)}function L(){return v[w]}function j(e,t){return C.formatMessageStrip(e,t)}function G(){return w}function z(){return C.getMode()}function W(e){if(!e){e=T}w=e;S.setProperty(h,w)}function _(){return C.getContentForIappState(w)}function k(e){var t;if(!e){return""}if(e.state==="error"){return o.oCommonUtils.getText("SEG_BUTTON_ERROR",[e.text])}if(e.state===""||e.state==="busy"){var r=f.getIntegerInstance({groupingEnabled:true});t=r.format(e.count)}return o.oCommonUtils.getText("SEG_BUTTON_TEXT",[e.text,e.state==="busyLong"?"...":t])}function q(e){w=C.getSelectedKeyAndRestoreFromIappState(e);if(v[w]){S.setProperty(h,w)}}var Q={getState:G,setState:W,attachStateChanged:ae};function J(){return C.getSFBVariantContentStateWrapper(Q)}function X(){return C.getGeneralContentStateWrapper(Q)}function $(){return v[w].templateSortOrder}function Y(e){var t=L();if(e!==2){t.presentationControlHandler.rebind()}if(e>1){if(d.refreshModelOnTableRefresh){var r=o.oCommonUtils.refreshModel(t.presentationControlHandler.getEntitySet());if(r){ne(t.presentationControlHandler)}}t.presentationControlHandler.refresh()}}function Z(e,t,r){var n=Array.isArray(t);var a=o.oComponentUtils.isComponentActive();if(n&&t.length===0||r&&c(r)){return}C.refreshOperation(e,t,r,w,n,a,Y)}function ee(e,t){if(C.setControlVariant){C.setControlVariant(e,t)}}function te(e,t,r,n){return o.oCommonUtils.getCustomDataText(e).then(function(e){r.text=e;n.text=e;return{modelEntry:r,pathToTheItem:t}})}function re(e){S.setProperty(e.pathToTheItem,e.modelEntry)}function ne(e){if(C.refreshSiblingControls){C.refreshSiblingControls(e)}}function ae(e){M.push(e)}function ie(){return Object.keys(v)}(function(){s.testable(function(){return C},"getImplementingHelper");s.testable(function(){return E},"getShowCounts");s.testable(function(){return v[w]},"getCurrentViewMeta");var e=function(e,t,r,n){if(e.numberOfUpdates!==r){return}var a=y+"/"+e.switchingKey;var i=l({},S.getProperty(a));if(!i.state&&t=="busy"){setTimeout(function(){if(S.getProperty(a).state==="busy"){i=l({},S.getProperty(a));i.state="busyLong";S.setProperty(a,i)}},O)}i.state=t;if(!t){i.count=n}S.setProperty(a,i)};d.getSwitchingControlAsync().then(function(t){var r=t?t.getItems():[];for(var n=0;n<r.length;n++){var a=r[n];var i=a.getKey();if(n===0){T=i}var s={presentationControlHandler:d.getPresentationControlHandler(i),switchingKey:i};var l=o.oCommonUtils.getElementCustomData(a);var u=y+"/"+s.switchingKey;var p=Object.create(null);p.text=l.text;p.count=0;p.state="";p.facetId=d.sectionKey;te(a,u,p,s).then(re);s.templateSortOrder=l.TemplateSortOrder;s.getPath=B.bind(null,s.presentationControlHandler);s.selectionVariantFilters=V(s.presentationControlHandler,l);s.numberOfUpdates=0;s.updateStartFunction=e.bind(null,s,"busy");s.updateSuccessFunction=e.bind(null,s,"");s.errorFunction=e.bind(null,s,"error");v[i]=s}if(C.init){C.init(v,Z,L)}if(d.manifestSettings.showCounts===undefined){E=C.getDefaultShowCounts()}else{E=d.manifestSettings.showCounts}W(w);var c=S.bindProperty(h);c.attachChange(function(e){var t=e.getSource().getValue();M.forEach(function(e){e(t,w)});w=t;if(C.onSelectedKeyChanged){C.onSelectedKeyChanged(t)}var r=d.isDataToBeShown();var n=C.getRefreshMode(w);if(d.adaptRefreshRequestMode){n=d.adaptRefreshRequestMode(n);if(r&&n>0){Y(n)}else{L().presentationControlHandler.setEnabledToolbarButtons()}}d.appStateChange()});b()})})();return{updateCounts:I,refreshOperation:Z,onRebindContentControl:x,formatMessageStrip:j,getSelectedKey:G,setSelectedKey:W,getContentForIappState:_,restoreFromIappState:q,getSFBVariantContentStateWrapper:J,getGeneralContentStateWrapper:X,formatItemTextForMultipleView:k,determineSortOrder:$,setControlVariant:ee,hasEntitySet:A,getPreferredKey:K,refreshSiblingControls:ne,resolveParameterizedEntitySet:U,getMode:z,registerKeyChange:ae,getKeys:ie,getFiltersForItem:D,getInitializationPromise:function(){return P}}}return e.extend("sap.suite.ui.generic.template.lib.multipleViews.MultipleViewsHandler",{constructor:function(e,t,r){l(this,d(e,t,r))}})});
//# sourceMappingURL=MultipleViewsHandler.js.map