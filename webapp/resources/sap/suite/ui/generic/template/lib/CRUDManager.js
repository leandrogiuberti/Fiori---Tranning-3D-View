sap.ui.define(["sap/ui/base/Object","sap/ui/generic/app/util/ModelUtil","sap/ui/generic/app/util/ActionUtil","sap/suite/ui/generic/template/lib/MessageUtils","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/genericUtilities/CacheHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/base/util/isEmptyObject","sap/suite/ui/generic/template/genericUtilities/FeError","sap/ui/model/Context","sap/m/MessageBox","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper","sap/ui/core/message/Message","sap/ui/core/message/MessageType","sap/suite/ui/generic/template/js/AnnotationHelper"],function(e,t,n,r,a,o,i,s,l,c,u,p,g,f,v,d){"use strict";var C="lib.CRUDManager";var m=Promise.reject();m.catch(Function.prototype);function E(e){return Object.keys(e).map(function(t){return e[t]})}function h(e){if(e){return e.map(function(e,t){return t})}}function y(e,y,D,b,x){function A(t,n,a,o){if(a){r.handleError(t,e,D,a,o)}return(n||Function.prototype)(a)}var T;function M(t){return new Promise(function(n,a){var o=e.getOwnerComponent();var i=o.getBindingContext();var s=o.getModel();s.read(i.getPath(),{urlParameters:{$expand:"DraftAdministrativeData"},success:function(e){if(!e.DraftAdministrativeData){if(t){return A(r.operations.editEntity,a,t)}return n({})}if(e.DraftAdministrativeData.InProcessByUser){var o=e.DraftAdministrativeData.InProcessByUserDescription||e.DraftAdministrativeData.InProcessByUser;var i=Promise.resolve(t||y.getMainComponentUtils().then(function(e){var t=e.getText("ST_GENERIC_DRAFT_LOCKED_BY_USER",[" ",o]);return new c(t)}));return i.then(function(e){A(r.operations.editEntity,a,e,e)})}return n({draftAdministrativeData:e.DraftAdministrativeData})},error:A.bind(null,r.operations.editEntity,a)})})}function P(){var t=e.getView().getModel();var n=e.getOwnerComponent();var r=n.getAppComponent();var a=r.getId();return y.getMainComponentUtils().then(function(e){var n=o.getInfoForContentIdPromise(e.entitySet,t,a,e.getRootExpand);return n.then(function(e){return e.contentIdRequestPossible?e.parametersForContentIdRequest.sRootExpand:null})})}function S(e,t,n){var a=e.bindingContext;if(n&&n.draftAdministrativeData){return Promise.resolve(n)}return P().then(function(n){return new Promise(function(o,i){D.oTransactionController.editEntity(a,!t,n).then(function(t){var n;n=e.view;var r=function(){a.getModel().invalidateEntry(a);n.detachEvent("modelContextChange",r)};if(n){n.attachEvent("modelContextChange",r)}return o({context:t.context})},function(e){if(e&&e.response&&e.response.statusCode==="409"&&!t){D.oApplication.removeTransientMessages();return M(e).then(o,i)}else{A(r.operations.editEntity,i,e,e)}})})})}T=function(t){var n=y.isDraftEnabled();var r,a;if(n){var o=y.getViewLevel();var i;if(o>0){i=y.getMainComponentDetails();var s=D.oApplication.checkContextData(i.bindingContext);if(!s){D.oApplication.registerContext(i.bindingContext,1,i.entitySet,D.oApplication.getCurrentKeys(1))}a=y.getTargetKeyFromLevel(2)}if(!t){var l=D.oDraftController.getDraftContext();var c=l.hasPreserveChanges(i.bindingContext);if(!c){r=M().then(S.bind(null,i,true))}}r=r||S(i,t,{});D.oApplication.editingStarted(i.bindingContext,r)}else{var u=e.getView().getBindingContext();r=Promise.resolve({context:u})}var p=Promise.all([r,a]);return p.then(function(e){var t={};var n=Object.keys(e[0])[0];t[n]=e[0][n];t.targetSiblingKey=e[1];return t})};function R(e){if(x.isBusy()){return m}var t=T(e);x.setBusy(t);return t}function I(n,a,o){var i=new Promise(function(i,s){var l=function(){var e=t.getEntitySetFromContext(o);var i=D.oDraftController.getDraftContext();var s=i.isDraftRoot(e);var l=y.getViewLevel();var c=l>=2?b.getText("ITEM_DELETED"):b.getText("ST_GENERIC_OBJECT_DELETED");if(!n&&s){c=b.getText(a?"ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED":"ST_GENERIC_DRAFT_WITHOUT_ACTIVE_DOCUMENT_DELETED")}r.showSuccessMessageIfRequired(c,D)};var c=function(t){if(t.length===0){l();i()}else{r.handleError(r.operations.deleteEntity,e,D,t[0].oError,null);s()}};var u=w({pathes:[o.getPath()],withWarningDialog:true});u.then(c,s)});return i}function F(){var t=e.getView().getBindingContext();var n=D.oDraftController.isActiveEntity(t);return a.deleteEntity(D.oDraftController,I,D.oApplication,t,n,"deleteAction")}function O(e,t,n){var a={mFailed:Object.create(null),mSuccess:Object.create(null),mWarning:Object.create(null),aMessagesForUserDecision:[]};for(var o=0;o<e.length;o++){var i=e[o];var s=t[o];var c=r.parseError(s);var u=parseInt(c.httpStatusCode,10);var p=s&&s.response&&s.response.headers;if(u>=200&&u<300||u===304){a.mSuccess[i]=s}else if(u===412&&p&&p["preference-applied"]){a.mWarning[i]=s}else{a.mFailed[i]=s}}if(!l(a.mWarning)&&n){a.aMessagesForUserDecision=D.oApplication.getTransientMessages();D.oApplication.removeTransientMessages()}return a}function w(e){var t=new Promise(function(t,n){var r=Object.create(null);var a=Object.create(null);var o=function(e,t,n){a[e]={resolve:t,reject:n}};for(var i=0;i<e.pathes.length;i++){var c=e.pathes[i];r[c]=new Promise(o.bind(null,c))}D.oApplication.prepareDeletion(r,e.suppressRefreshAllComponents);var u=Object.create(null);var p=Object.create(null);var g;var f=function(r){if(!l(u)){D.oApplication.markCurrentDraftAsModified()}for(var o in a){var i=a[o];i[u[o]?"resolve":"reject"]()}if(r){return n()}var s=e.pathes.map(function(e){return{sPath:e,oError:p[e]||g[e],isWarning:!!g[e]}}).filter(function(e){return!!e.oError});t(s)};var v=function(e){if(e.length>0){var t=y.getCRUDActionHandler();var n={messagesForUserDecison:e};t.handleCRUDScenario(4,d.bind(null,Object.keys(g),false,false),f.bind(null,true),"Delete",n);return}f()};var d=function(t,n,r){if(e.suppressRefreshAllComponents&&e.smartTable){D.oPresentationControlHandlerFactory.getPresentationControlHandler(e.smartTable).refresh("Changes")}var a=function(e){var n=O(t,e,r);p=s(p,n.mFailed);u=s(u,n.mSuccess);g=n.mWarning;v(n.aMessagesForUserDecision)};var o=D.oTransactionController.deleteEntities(t,{bIsStrict:n}).then(a,a);x.setBusy(o)};var C=e.withWarningDialog&&(e.pathes.length===1||e.onlyOneDraftPlusActive);d(e.pathes,true,C)});return t}function U(e){return a.discardDraft(D.oDraftController,D.oTransactionController,D.oApplication,e)}function _(e){var t=function(t){var n=[];e.forEach(function(e){n.push(e.sContextPath)});var r=O(n,t);var a=E(r.mSuccess);return a};var n=D.oTransactionController.updateMultipleEntities(e).then(t,t);x.setBusy(n);return n}function B(t){var n=t.getMetaModel().getODataEntitySet(e.getOwnerComponent().getEntitySet());return d.getRequiredProps(n)}function N(e,t){var n=t.getObject();return e.filter(function(e){return!n[e]})}function H(t){var n=t.oMetaModel.getODataEntitySet(e.getOwnerComponent().getEntitySet()),r=t.oMetaModel.getODataEntityType(n.entityType);return r}function j(e,t,n,r){t.removeAllMessages();var a=H(r);e.forEach(function(e){var o=n.target,i=n.fullTarget,s=r.oMetaModel.getODataProperty(a,e)&&r.oMetaModel.getODataProperty(a,e)["sap:label"];if(s){var l=new f({message:b.getSpecializedText("ENTER_MANDATORY",e,null,[s]),persistent:false,technical:false,target:o+"/"+e,fullTarget:i+"/"+e,type:v.Error,processor:r});t.addMessages(l)}});D.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover()}function L(t,n,r){var o=sap.ui.getCore().getMessageManager();var i=e.getView().getModel();if(!r){var s=B(i),l=e.getView().getBindingContext(),c=N(s,l);if(c.length>0){j(c,o,D.oTemplateCapabilities.oMessageButtonHelper.getTargetInfo(i),i);n();return}}var u=r?r:D.oTemplateCapabilities.oMessageButtonHelper&&D.oTemplateCapabilities.oMessageButtonHelper.getContextFilter(false);var p=a.fnGetMessagesFromContextFilter(u,o,true);var g=Object.create(null);p.forEach(function(e){g[e.getId()]=e});var f=function(){var e=y.getCRUDActionHandler();e.handleCRUDScenario(4,v.bind(null,false),n,"Activate")};var v=function(e){var i=D.oTransactionController.triggerSubmitChanges({bStrict:e});i.then(function(e){o.removeMessages(p);t(e.context)},function(t){var i=false;var s=[];var l=a.fnGetMessagesFromContextFilter(u,o,true);var c=l.map(function(e){if(!g[e.getId()]){e.persistent=false;e.technical=false;i=i||e.technicalDetails.statusCode==="412"&&e.technicalDetails.headers["preference-applied"]==="handling=strict";s.push(e)}return e});if(s.length){o.removeMessages(c);o.addMessages(s);if(i&&e){f();return}if(!r){D.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover()}}n()});x.setBusy(i)};v(true)}function G(e){var t=e;var n=new Promise(function(e,n){L(e,n,t)});return n}function W(t,n){return a.activateDraftEntity(t,n,x,D,e,y)}function V(e){var t=new n(e);t.setActionLabel(e.actionLabel);return t}function k(e,t,n){if(!y.isDraftEnabled()||n){var r,a;var o=D.oPresentationControlHandlerFactory.getPresentationControlHandler(b.getOwnerPresentationControl(e));var i=o.getEntitySet();var s=o.getBindingContext();if(s&&s.getPath()!==i){r=s;a=o.getBindingPath()}else{r=new u(o.getModel(),"/"+i)}return D.oTransactionController.getDefaultValues([r],t,a)}else{return t}}async function q(t,n,a,o){const i=t.bInvokedByExtensionApi||false;if(x.isBusy()&&!i){o();return}var s=[];var l=[];var c=[];var g=false;var f=Object.create(null);var v=[];var d=t.contexts||[];var C=t.sourceControlHandler;let m=d.length>0;if(d.length===0&&C){var A=C.getModel();var T="/";var M=C.getEntitySet();var P=T.concat(M);d.push(new u(A,P))}var S=t.label;var R=t.operationGrouping;var I=function(){if(!i){if(d[0]){var e=d[0].oModel;if(e&&e.hasPendingChanges()){e.resetChanges()}}}};var F=function(e){I();o(e)};var w=function(e,t){if(e.length>0){var n=y.getCRUDActionHandler();var r;if(d.length===0){r=_.bind(null,false,false,d)}else{var a=d.filter(function(e,t){return v.includes(""+t)});r=_.bind(null,false,false,a)}var o={messagesForUserDecison:e,actionName:S};n.handleCRUDScenario(4,r,t,"BOPFAction",o);return}t()};var U=d.length<=1;var _=function(n,u,d){if(!n){I()}var A=V({controller:e,applicationController:D.oApplicationController,contexts:d,functionImport:t.functionImport,functionImportPath:t.functionImportPath,entityType:t.entityType,actionLabel:S,actionButtonText:t.actionButtonText,isDraftEnabled:y.isDraftEnabled(),contextIndependentParameterData:f,expand:t.sRootExpand,operationGrouping:R,handleFocus:D.controllerServices&&D.controllerServices.getRestoreFocusHelper?D.controllerServices.getRestoreFocusHelper().rememberFocus:null,actionParameters:t.urlParameters,invokedByExtensionApi:i});A.call(n).then(function(e){var t={};t.actionLabel=S;D.oApplication.setNextFocus(Function.prototype);const n=!i;if(n){x.setBusy(e.executionPromise,null,t)}e.executionPromise.then(e=>{T(e)}).catch(e=>{T(e);if(x.isBusy()&&i){o()}})},F);var T=function(e){var t=Array.isArray(e)?e:[e];var n=h(t);var a=t.map(function(e){var t=e.error||e.response;if(t){t.actionContext=e.actionContext}return t});f=t[0].userEnteredAdditionalParams;var o=O(n,a,u);l=l.concat(E(o.mFailed));s=s.concat(E(o.mSuccess));v=Object.keys(o.mWarning);c=E(o.mWarning);c.forEach(e=>{if(e?.response?.statusCode==="412"){const t=JSON.parse(e?.response?.responseText);r.cacheWarningMessage(t.error)}});w(o.aMessagesForUserDecision,M.bind(null,t))};var M=function(e){var n=l.concat(s.concat(c));if(i){const e=e=>{if(A.getExecutedSuccessfully()){const t={context:e.context,response:e.response,data:e.data};if(m){return{actionContext:e.actionContext,response:t}}return{response:t}}else{const t={error:{response:e.response}};if(m){return{actionContext:e.actionContext,...t}}return t}};let t=n.map(e);D.oApplication.setNextFocus(()=>{r.clearWarningCache()});if(A.getExecutedSuccessfully()){a(t)}else{o(t)}return}if(n.length>1){var u=c.length>0;var f=l.concat(c);var v=n.length;var d=f.length;if(d>0){var E;if(v===d){E=b.getText("ST_GENERIC_NOT_PROCESSED_RECORDS_PLURAL")}else{E=b.getText("ST_GENERIC_NOT_PROCESSED_RECORDS",[d,v])}if(u){E=E+"\n";if(d===1){E=E+b.getText("ST_GENERIC_ACTION_WITH_WARNING_SUGGESTION_SINGULAR")}else{E=E+b.getText("ST_GENERIC_ACTION_WITH_WARNING_SUGGESTION_PLURAL")}}x.getUnbusy().then(function(){if(l.length>1){p.error(E)}else{p.warning(E)}})}}var h,T;g=g||A.getExecutedSuccessfully();if(g){var M;if(s.length===1&&c.length===0&&l.length===0){h=s[0];M=e[0].actionContext}T=h&&h.context;var P;if(T&&T.getObject()){P=D.oApplication.registerContext(T)}if(T&&T!==M&&T.getPath()!=="/undefined"&&t.navigateToInstance!=="false"){D.oApplication.setNextFocus(function(e,t){r.clearWarningCache();t({ignorePersistence:true})});var S=t.actionType==="determining";D.oApplication.navigateToDetailContextIfPossible(T,S,P.bIsDraft?2*(1+P.bIsCreate):1,P)}else{D.oApplication.setNextFocus(function(e,t){r.clearWarningCache();t()})}var R=C&&C.getBindingInfo();var F=R&&R.binding;if(F&&F.oEntityType){C.setEnabledToolbarButtons();if(y.getViewLevel()===0){C.setEnabledFooterButtons()}}a(n)}else{I();o(n)}}};if(t.bStrict===undefined){_(true,U,d)}else{_(t.bStrict,U,d)}}function K(t,n){var r=e.getView().getModel()||t.oModelFromExtensionApi;var a=r.getMetaModel();var i=e.getOwnerComponent();var s=i.getEntitySet();var l=Y(a,t.functionImportPath);var c=a.getODataEntitySet(s);var u=l&&l.returnType;var p=c&&c.entityType;var g=a.getODataEntityType(p);t.functionImport=l;t.entityType=g;if(!t?.label&&l?.["name"]){t.label=l["name"]}if(u===p){var f=i.getAppComponent();var v=D.oApplication.getComponentUtilsIfLoaded(s);var d=v&&v.viewRegistered&&!v.fnViewRegisteredResolve&&v.getRootExpand;var C=o.getInfoForContentIdPromise(s,r,f.getId(),d);return C.then(function(e){var r=e.contentIdRequestPossible?e.parametersForContentIdRequest.sRootExpand:null;t.sRootExpand=r;return J(t,n)})}return J(t,n)}function J(e,t){var n=new Promise(function(n,r){D.oApplication.performAfterSideEffectExecution(q.bind(null,e,t,n,r))});return n}function Y(e,t){if(e&&t){var n=t.split("/").pop();return e.getODataFunctionImport(n)}return undefined}function z(t,n){if(!t){throw new c(C,"Unknown Table")}var i=e.getOwnerComponent();var s=i.getAppComponent();var l=e.getView();var u=l.getModel();var p,f;var v=y.getViewLevel();if(v>0){var d=D.oPresentationControlHandlerFactory.getPresentationControlHandler(b.getOwnerPresentationControl(t)).getBindingInfo().path;p=t.getEntitySet();f=i.getComponentContainer().getElementBinding().getPath()+"/"+d}else{p=i.getCreationEntitySet&&i.getCreationEntitySet()||t.getEntitySet();f="/"+p}return new Promise(function(t,i){var l=function(e){var t=D.oApplication.getBusyHelper();t.setBusy(e);D.oApplication.setNextFocus(Function.prototype)};var c=D.oApplication.getComponentUtilsIfLoaded(p);var d=c&&c.viewRegistered&&!c.fnViewRegisteredResolve&&c.getRootExpand;var C=o.getInfoForContentIdPromise(p,u,s.getId(),d);l(C);C.then(function(o){var s=y.getSettings();var c=o.contentIdRequestPossible?o.parametersForContentIdRequest.sRootExpand:null;var d={sRootExpand:c,oController:e,oApplicationController:D.oApplicationController,bUseNewActionForCreate:s&&s.useNewActionForCreate,fnSetBusy:l,handleFocus:D.controllerServices&&D.controllerServices.getRestoreFocusHelper?D.controllerServices.getRestoreFocusHelper().rememberFocus:null};var C=a.create(D.oDraftController,p,f,u,D.oApplication,n,d,b);C.catch(A.bind(null,r.operations.addEntry,function(e){i();if(e){throw e}}));var m=v===0?D.oApplication.preloadComponent(p):Promise.resolve();Promise.all([C,m]).then(function(e){var n=e[0];D.oApplication.markCurrentDraftAsModified();var r=y.getCurrentKeys();r.push(g.analyseContext(n).key);var a=r.length-1;D.oApplication.registerContext(n,a,p,r);t(n)})})})}var A=i.testable(A,"handleError");var V=i.testable(V,"getActionUtil");return{editEntity:R,deleteEntity:F,deleteEntities:w,saveEntity:G,activateDraftEntity:W,discardDraft:U,callAction:K,addEntry:z,updateMultipleEntities:_,getDefaultValues:k,getUnfilledProperties:N}}return e.extend("sap.suite.ui.generic.template.lib.CRUDManager",{constructor:function(e,t,n,r,a){s(this,y(e,t,n,r,a))}})});
//# sourceMappingURL=CRUDManager.js.map