sap.ui.define(["sap/ui/base/Object","sap/base/util/extend","sap/suite/ui/generic/template/lib/filterHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/ui/model/FilterOperator","sap/ui/model/Filter","sap/suite/ui/generic/template/js/AnnotationHelper"],function(e,t,a,r,i,n,o){"use strict";var l=new r("lib.ai.EasyFilterBarHandler").getLogger();function s(e,t,r){var s={};var u;var c,p;var f;function d(){return new Promise(function(t){e.oIappStateHandler.onFEStartupInitialized().then(function(){v().then(function(e){t(e)})})})}function v(){var n=[];var o;var l={};var c=e.oSmartFilterbar;var p=c.getModel();var f=p.getMetaModel();var d=t.getOwnerComponent().getEntitySet();var v={};var m=r.oCommonUtils.getMetaModelEntityType(d);m.property.map(function(e){var t="ValueHelp";if(a.isPropertyFilterable(e)){var r;var i=false;var n=false;var o="";e.extensions&&e.extensions.forEach(function(e){if(e.name==="value-list"&&e.value==="fixed-values"){t="MenuWithCheckBox";r=true}if(e.name==="hidden"){i=e.value==="true"}if(e.name==="hidden-filter"){n=e.value==="true"}if(e.name==="filter-restriction"){o=e.value}});if(e.type==="Edm.DateTime"&&e["sap:display-format"]==="Date"||e.type==="Edm.String"&&e["com.sap.vocabularies.Common.v1.IsCalendarDate"]&&e["com.sap.vocabularies.Common.v1.IsCalendarDate"].Bool==="true"){t="Calendar"}else if(e.type==="Edm.DateTimeOffset"){t="Time"}v[e.name]={name:e.name,dataType:e.type,defaultValue:[],filterable:true,sortable:false,codeList:r,type:t,unit:e["sap:unit"]||"",required:e["sap:required-in-filter"]==="true"?true:false,hidden:i,hiddenFilter:n,filterRestriction:o||undefined}}});u={version:1,entitySet:d,fields:[]};l=c.getFilterData()||{};c.getAllFilterItems().forEach(function(e){var t=v[e.getName()];if(t){var a=l[e.getName()];if(a){var r=[];if(a.ranges&&a.ranges.length>0){r=a.ranges.map(function(e){if(e.exclude===false){if(e.operation==="BT"){return{operator:i.BT,selectedValues:[e.value1,e.value2]}}else{return{operator:e.operation,selectedValues:[e.value1]}}}else{return{operator:i.NE,selectedValues:[e.value1]}}})}else if(a.items&&a.items.length>0){a.items.forEach(function(e){r.push({operator:i.EQ,selectedValues:[e.key]})})}else if(a){if(t.dataType==="Edm.Boolean"){var c=JSON.parse(a);r=[{operator:i.EQ,selectedValues:[{value:c,description:c}]}]}else{r=[{operator:i.EQ,selectedValues:[a]}]}}t.defaultValue=r}t.label=e.getLabel();if(t.codeList){var d=f.getODataProperty(m,t.name,true);var h=f.createBindingContext(d);var y=f.getODataValueLists(h);n.push(y);y.then(function(e){if(s[t.name]){t.codeList=s[t.name]}else{t.codeList=function(){return g(t,e,p)}}u.fields.push(t)})}else{u.fields.push(t)}}else if(e.getName()==="EditState"){o=e}});if(r.oComponentUtils.isDraftEnabled()){var h=t.byId("editStateFilter");if(h){var y=h.getItems().map(function(e){return{value:e.getKey(),description:e.getText()}});var V={name:o.getName(),label:o.getLabel(),dataType:"Edm.String",filterable:true,required:false,sortable:false,type:"MenuWithSingleSelect",codeList:y};u.fields.push(V)}}return Promise.allSettled(n).then(function(){return u})}function g(e,t,a){if(s[e.name]){return s[e.name]}return new Promise(function(r,i){var n=t[""];if(n){var o=n.Parameters&&n.Parameters.map(function(e){return e.ValueListProperty.String}).join(",");var l=function(t){var a=[];t.results&&t.results.forEach(function(e){a.push({value:e[c],description:p?e[p]:undefined})});s[e.name]=a;u.fields.forEach(function(t){if(t.name===e.name){t.codeList=a}});r(a)};a.read("/"+n.CollectionPath.String,{$select:o,success:l,error:i});var c;var p;n.Parameters&&n.Parameters.forEach(function(t){if(t.LocalDataProperty&&t.LocalDataProperty.PropertyPath===e.name){c=t.ValueListProperty.String}else{p=t.ValueListProperty.String}})}})}function m(e){var t=[];var a=0;e.forEach(function(e){if(e.key==="EditState"){a=e.keySpecificSelectedValues[0].selectedValues[0]}else{var r={PropertyName:e.key,Ranges:[]};e.keySpecificSelectedValues.forEach(function(e){var t={Sign:"I",High:""};if(e.operator==="BT"||e.operator==="NB"){t.Low=e.selectedValues[0];t.High=e.selectedValues[1];t.Option=e.operator;r.Ranges.push(t)}else{e.selectedValues.forEach(function(a){if(e.operator==="Contains"){t.Option="CP";t.Low=a}else{t.Option=e.operator;t.Low=a}r.Ranges.push(t)})}});t.push(r)}});return{aSelectOptions:t,oEditStateFilter:a}}function h(){return t.byId("template::easyFilterContainer")}function y(){var e=h();var a=d();var i=t.getOwnerComponent().getEntitySet();a.then(a=>{e.setContextPath(i);e.setAppId(t.getOwnerComponent().getAppComponent().getManifestEntry("sap.app").id);e.setFilterBarMetadata(a.fields);e.easyfilter=r.oServices.oFioriAIHandler.fioriaiLib.EasyFilter})}function V(t){var a=e.oSmartFilterbar;a.search()}function E(e){p()}function S(e){c=new Promise(function(e){p=e});r.oComponentUtils.getBusyHelper().setBusy(c)}function F(t){var a=e.oSmartFilterbar;var i=t.getParameter("tokens");var n=a.getId();var o=r.oCommonUtils.getControlStateWrapperById(n,"SmartFilterBar");var l=o.getState();var s=m(i);var u=Object.keys(l.customFilters.appExtension);if(u.length>0){u.forEach(function(e){l.customFilters.appExtension[e]=""})}l.selectOptions=s.aSelectOptions;if(r.oComponentUtils.isDraftEnabled()){l.customFilters.editState=s.oEditStateFilter}if(l.semanticDates){var{Low:c,High:p}=s.aSelectOptions[0].Ranges[0];var f=l.semanticDates.Dates[0].Data;f.operation="DATERANGE";f.value1=c;f.value2=p||c}o.setState(l);a.getSmartVariant()&&a.getSmartVariant().currentVariantSetModified(true);a.search()}function P(t){var a=e.oSmartFilterbar;var r=t.getParameter("key");f=t.getParameter("resolve");a.associateValueLists();try{a.ensureLoadedValueHelp(r);a.openValueHelpRequestForFilterItem(r)}catch(e){l.error("Value help cannot be triggered for the field "+r)}}function b(){var t=e.oSmartFilterbar;t.fireFilterChange()}function C(e){var t=e.getParameters("mParameters");var a=[];var r,i,n,o;if(t.sId==="change"&&f){r=t.getParameter("filterChangeReason");i=e.getSource().getFilterData();n=new Map;o=i[r]?.items||[];o.forEach(function(e){n.set(e.key,e.text)});e.getSource().getFilters().forEach(function(e){e.aFilters&&e.aFilters.forEach(function(e){e=e.aFilters?e.aFilters:[e];e.forEach(function(e){if(e.sPath===r){var t={operator:"",selectedValues:[]};var i=a.find(function(t){return t.operator===e.sOperator});if(i){a.forEach(function(t){if(t.operator===e.sOperator){t.selectedValues.push({value:e.oValue1,description:n.get(e.oValue1)||e.oValue1})}})}else{t.operator=e.sOperator;t.selectedValues.push({value:e.oValue1,description:n.get(e.oValue1)||e.oValue1});a.push(t)}}})})});f(a)}}function O(t){var a=r.oComponentUtils.getTemplatePrivateModel();if(!t.getParameter("context")&&a.getProperty("/listReport/filterMode")!=="classic"){var i=e.oSmartFilterbar;a.setProperty("/listReport/filterMode","classic");i.setVisible(true)}}function L(e,t){const a=[];for(var r=0;r<t.length;++r){const l=t[r];if(l.operator===i.BT||l.operator===i.NB){a.push(new n({path:e,operator:l.operator,value1:l.selectedValues[0],value2:l.selectedValues[1]}))}else{for(var o=0;o<l.selectedValues.length;++o){a.push(new n({path:e,operator:l.operator,value1:l.selectedValues[o]}))}}}return a}function D(a,l,s){return new Promise((s,u)=>{var c=[];var p=e.oSmartFilterbar;var f=a;var d=t.getOwnerComponent().getEntitySet();var v=r.oCommonUtils.getMetaModelEntityType(d);var g=p.getModel();var m=g.getMetaModel();var h=L(a,l);var y=m.getODataProperty(v,a);var V=m.getODataProperty(v,a,true);var E=o.isValueHelpTableAvailable(y);if(E){var S=m.createBindingContext(V);var F=m.getODataValueLists(S);var P=h.length;var b=0;let e=(e,t,r,n)=>{++b;var l=e.results;t.forEach(e=>{var t=l.find(t=>t[a]===e.getValue1());if(t){c.push({operator:i.EQ,selectedValues:[{value:t[a],description:o.getTextArrangementFinalString(t,a,r.split("/")[1],n)}]})}else{c.push(B(e))}});if(b===P){s(c)}};let t=(t,l,u)=>{var p=r.oCommonUtils.getMetaModelEntityType(u);var f=m.getODataProperty(p,a);var d=t.results;var v=o.getTextArrangementPath(f);var h=o.getTextArrangementForEasyFilter(p,f);var y=null;var V=null;if(v&&v.split("/").length>1){y=v.split("/")[0];V=m.getODataAssociationSetEnd(p,y).entitySet}if(d.length===0){++b;c.push(B(l))}else if(d.length!==0&&V&&u!==V){var E=d.map(e=>e[a]);var S=E.map(e=>new n({path:a,operator:i.EQ,value1:e}));g.read("/"+V,{filters:S,success:function(t){e(t,S)}})}else{++b;d.forEach(e=>{c.push({operator:i.EQ,selectedValues:[{value:e[a],description:o.getTextArrangementFinalString(e,a,v,h)}]})})}if(b===P){s(c)}};F.then(e=>{var r=e[""];var i=r.CollectionPath.String;if(Array.isArray(r.Parameters)){var n=r.Parameters.find(e=>e.RecordType==="com.sap.vocabularies.Common.v1.ValueListParameterInOut"&&e.LocalDataProperty.PropertyPath===f);if(n){a=n.ValueListProperty.String}}h.forEach(e=>{g.read("/"+i,{urlParameters:{search:e.getValue1()},success:function(a){t(a,e,i)}})})})}else{h.forEach(e=>c.push(B(e)));s(c)}})}function B(e){var t=[];if(e.getOperator()===i.BT||e.getOperator()===i.NB){var t=[{value:e.getValue1(),description:e.getValue1()},{value:e.getValue2(),description:e.getValue2()}]}else{t.push({value:e.getValue1(),description:e.getValue1()})}return{operator:e.getOperator(),selectedValues:t}}return{getEasyFilterBar:h,initialiseEasyFilterBar:y,getSFBVariantData:m,getEasyFilterSearchMetadata:d,onClearFilters:V,onAfterQueryProcessing:E,onBeforeQueryProcessing:S,onQueryChanged:b,onTokensChanged:F,onShowValueHelp:P,onFilterChange:C,handleVariantLoad:O,onDataFetcher:D,getkeySpecifiedResultFromFilters:B}}return e.extend("sap.suite.ui.generic.template.lib.ai.EasyFilterBarHandler",{constructor:function(e,a,r){t(this,s(e,a,r))}})});
//# sourceMappingURL=EasyFilterBarHandler.js.map