sap.ui.define(["sap/base/util/extend","sap/base/util/ObjectPath","sap/m/MessageBox","sap/suite/ui/commons/collaboration/ServiceContainer","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/ui/base/Object","sap/ui/base/Event"],function(e,t,n,r,o,i,a,s){"use strict";var l=new i("lib.ContextMenuHandler").getLogger();var u=10;var c=1;var v=["btnPersonalisation","btnExcelExport"];function f(i,a,f,g,p){var d=i.getView();var b=d.getModel("_templPriv");var m=a.oCommonUtils;var h=a.oComponentUtils;var C="/generic/controlProperties/"+d.getLocalId(g.getId());if(!b.getProperty(C)){b.setProperty(C,{})}var x=C+"/contextMenu";var A=x+"/items";b.setProperty(x,{items:[]});var E=a.oServices.oPresentationControlHandlerFactory.getPresentationControlHandler(g);var P=h.canNavigateToSubEntitySet(g.getEntitySet());var T;var S=0;var I=g.getTable().getContextMenu().data("CrossNavigation");var O=I&&j(I);var y;function M(e,t,n,r,o,i,a){S++;var s="ContextMenuKey"+S;var l=t.length;a=a||[];if(i){i.then(function(t){if(t){T[s]=t;b.setProperty(e+"/"+l+"/enabled",true)}})}else if(a.length>0){var u=a.map(function(e){return e.handlerPromise});Promise.all(u).then(function(t){var n=false;t.forEach(function(t,r){if(t){b.setProperty(e+"/"+l+"/children/"+r+"/enabled",true);n=true}});b.setProperty(e+"/"+l+"/enabled",n)})}o=o&&t.length>0;t.push({text:n,icon:r,key:s,enabled:false,startsSection:o,children:a,handlerPromise:i})}var _=M.bind(null,A);function L(t,n,r){f.oFocusInfo=e(t,{smartControlId:g.getId()});if(n.command){B(n)}else{N(n,r)}f.oFocusInfo=null}function B(e){var t=g.getDependents().find(function(t){return t.isA("sap.ui.core.CommandExecution")&&t.getProperty("command")===e.command});if(!t){return}t.fireExecute()}function N(e,n){var r=e.press;var o=null;if(r.startsWith(".")){var a=r.substring(1);o=t.create(a,i)}else{o=i[r]}var l=n;var u=new s("press",l);o&&o.apply(i,[u])}function w(e,t,n){var r=function(r){return r&&p.executeAction.bind(null,e,t,n)};var o=m.getToolbarActionEnablementInfo(t,e.applicableContexts,g);if(o.enabledPromise){return o.enabledPromise.then(r)}return Promise.resolve(r(o.enabled))}function R(e,t,n){var r=function(r){return r&&L.bind(null,e,t,n)};if(t.excludeFromContextMenu||!t.requiresSelection){return}var o=m.isBreakoutActionEnabled(t,e.applicableContexts,g.getModel(),g,true);return Promise.resolve(r(o))}function H(e,t,n,r,o,i){var a=d.getLocalId(o.getId())||d.getLocalId(o.data("originalButtonId"));var s=null;var l=n.standardActions.find(function(e){return e.ID===a});var u=p.findBreakoutActionByLocalId(n.breakoutActions,a);if(l){s=w(t,l,o)}else if(u){s=R(t,u,o)}if(s){M(e,r,o.getText(),o.getIcon(),i,s);return true}return false}function D(e,t,n,r,o,i){var a=o.getMenu().getItems();var s=[];a.forEach(function(e){var r=e.getStartsSection();H(A,t,n,s,e,r)});if(s.length===1){var l=s[0];M(e,r,l.text,l.icon,l.startsSection,l.handlerPromise);return true}else if(s.length>1){M(e,r,o.getText(),o.getIcon(),i,null,s);return true}return false}function F(e,t){var n=m.getToolbarCustomData(g);var r=m.getBreakoutActions(g);var i=r?Object.values(r):[];var a={standardActions:n,breakoutActions:i};var s=g.getToolbar();var l=s.getContent();var u=true;l.forEach(function(n){if(!(n.getVisible&&n.getVisible())){return}var r=v.some(function(e){return n.getId().includes(e)});if(r){return}if(o.isButton(n)){u=!H(A,e,a,t,n,u)&&u}else if(o.isMenuButton(n)){u=!D(A,e,a,t,n,u)&&u}})}function U(e){var t=e.isInactive();return!t}function j(e){var t=i.getOwnerComponent().getAppComponent().getManifestEntry("sap.app");return t.crossNavigation.outbounds[e]}function k(e,t){l.error("Error while opening the context "+e.getPath()+"in new tab: "+t)}function V(e,t){if(e.applicableContexts.length>u){var r=m.getText("T_TABLE_NAVIGATION_TOO_MANY_ITEMS_SELECTED",[u]);n.warning(r);return}var o=g.getModel().hasPendingChanges()?a.oServices.oApplicationController.synchronizeDraftAsync():Promise.resolve();o.then(function(){t.forEach(function(e){if(O){var t=k.bind(null,e);a.oCommonEventHandlers.navigateIntentOnNewTab(O,e,f.oSmartFilterbar,t)}else{a.oCommonUtils.openContextInNewTabFromListItem(e)}})})}function W(e){var t=function(e,t,n){return e&&V.bind(null,t,n)};var n=a.oServices.oApplication.getEditFlowOfRoot()==="direct";var r=i.hasOwnProperty("onListNavigationExtension");var o=sap.ui.require("sap/ushell/Container");if(!P||n||r||!o){return}var s=e.applicableContexts.filter(U);var l=s.length>0;return Promise.resolve(t(l,e,s))}function G(e,t){var n=W(e);var r=true;if(n){_(t,m.getText("ST_OPEN_NEW_TAB_OR_WINDOW"),null,r,n)}}function q(){var{promise:e,resolve:t,reject:n}=Promise.withResolvers();if(!y){r.getCollaborationServices().then(function(e){if(e&&e.oCMHelperService){var r=e.oCMHelperService.getOptions();if(r){y=e.oCMHelperService;t(y)}else{n()}}else{n()}})}else{t(y)}return e}function K(e,t){var r=e.applicableContexts.filter(U);if(!r.length){return}var o=r[0].getObject();var s=h.isDraftEnabled();var l=s&&o.IsActiveEntity===false;var u=l?o.HasActiveEntity===true:true;var v=l?e.focussedBindingContext.sPath!==e.focussedBindingContext.sDeepPath:false;var f=a.oServices.oApplication.getEditFlowOfRoot()==="direct";var g=i.hasOwnProperty("onListNavigationExtension");if(!t||!P||g||!u||v||O||f){return}return Promise.resolve(function(){if(r.length>c){var o=m.getText("T_TABLE_SHARE_TO_COLLABORATION_MANAGER_TOO_MANY_ITEMS_SELECTED",[c]);n.warning(o);return}var i=h.getAppTitle();if(l){var s=a.oServices.oApplication.getBusyHelper();if(s.isBusy()){return}var u=a.oServices.oApplication.createDraftSiblingPromise(e.focussedBindingContext.oModel,e.focussedBindingContext.sPath);var v=new sap.ushell.services.URLParsing;s.setBusy(u.then(function(e){var n=document.URL.split(v.getHash(document.URL))[0]+v.getShellHash(document.URL)+"&"+e.sPath;var r=n.replace(/\(/g,"%28").replace(/\)/g,"%29");t.publishData({sAppTitle:i,sCurrentURL:r})}))}else{var f=h.getTargetIdentityForContext(e.focussedBindingContext);f.then(function(e){t.publishData({sAppTitle:i,sCurrentURL:e})})}})}function Y(e,t){q().then(function(n){var r=K(e,n);if(r){_(t,m.getText("ST_SHARE_TO_COLLABORATION_MANAGER"),null,false,r)}}).catch(function(e){l.error("SAP Collaboration Manager is unavailable"+e)})}function z(e){var t=E.getFocusInfoForContextMenuEvent(e);T=Object.create(null);var n=[];F(t,n);G(t,n);Y(t,n);return n}function J(e){var t=z(e);b.setProperty(x+"/items",t);if(t.length===0){e.preventDefault()}}function Q(e){var t=e.getSource().getKey();var n=T[t];n()}return{beforeOpenContextMenu:J,onContextMenu:Q}}return a.extend("sap.suite.ui.generic.template.lib.ContextMenuHandler",{constructor:function(t,n,r,o,i){e(this,f(t,n,r,o,i))}})});
//# sourceMappingURL=ContextMenuHandler.js.map