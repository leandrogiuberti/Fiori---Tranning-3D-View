sap.ui.define(["sap/ui/model/Context","sap/suite/ui/generic/template/lib/MessageUtils","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/suite/ui/generic/template/genericUtilities/CacheHelper"],function(e,t,n,r,a,i){"use strict";var s=Promise.reject();s.catch(Function.prototype);function o(e,t,n,r,a){var i=n.createEntry(t,{properties:r,context:e,batchGroupId:"Changes",changeSetId:"Changes",canonicalRequest:a});return i}function l(e,t,n,r,a,i,s,o){n=n||"/"+t;var l=a.mustRequireRequestsCanonical();s.oFunctionImportDialogInfo={getTitleText:function(){return o.getText("DIALOG_TITLE_NEW_ACTION_FOR_CREATE")},getActionButtonText:function(){return o.getText("DIALOG_ACTION_BUTTON_NEW_ACTION_FOR_CREATE")}};return e.createNewDraftEntity(t,n,i,l,s).then(function(e){return e.context})}function u(e,t,n){var r=new Promise(function(n,r){e.read(t,{urlParameters:{$expand:"DraftAdministrativeData"},success:function(e){n(e)},error:function(e){r(e)}})});n.setBusy(r,true);return r}function f(e,t,a,i,s,o){var l=new Promise(function(o,l){var u,f,d,v,g=[];if(a&&i&&s){f=a.length;for(u=0;u<f;u++){d=a[u].PropertyPath;v=i[d][0];g.push(new n(d,r.EQ,v))}if(e.getDraftController().getDraftContext().isDraftEnabled(t)){var p=new n({filters:[new n("IsActiveEntity","EQ",false),new n("SiblingEntity/IsActiveEntity","EQ",null)],and:false});g.push(p)}var D=new n(g,true);s.read("/"+t,{urlParameters:{$expand:"DraftAdministrativeData"},filters:[D],success:function(e){var t=c(e,s,i);if(t){o(t)}else{l(e)}},error:function(e){l(e)}})}});o.oBusyHelper.setBusy(l,true);return l}function c(e,t,n){var r,a,i,s;if(e&&e.results){i=e.results.length;if(i==0){s=null}else if(i==1){s=e.results[0]}else if(i>=1){var o=[];var l=[];for(a=0;a<i;a++){r=e.results[a];if(r&&r.IsActiveEntity){l.push(r)}else if(r&&r.IsActiveEntity==false){o.push(r)}}if(l.length==0&&o.length>=2){var u;for(var f=0;f<o.length;f++){u=o[f];if(u.DraftUUID==n.DraftUUID){s=u;break}}if(!s){s=o[0]}}else if(l.length==1&&o.length==1){s=l[0]}else if(l.length==1&&o.length>=2){s=l[0]}}}return s}function d(e){var n=e.oAppComponent;var r=n.getModel();var a=r.getMetaModel();var i=n.getNavigationController();var s=n.getApplicationController();var o=s.getTransactionController().getDraftController().getDraftContext();var l=function(n){e.oApplicationProxy.getResourceBundleForEditPromise().then(function(a){t.handleError(t.operations.modifyEntity,null,null,n,{resourceBundle:a,navigationController:i,model:r});t.handleTransientMessages(e)})};var u=function(t){e.oTemplatePrivateGlobalModel.setProperty("/generic/draftIndicatorState",sap.m.DraftIndicatorState.Clear);var n=t.getParameter("context");if(!o.hasDraft(n)){return}if(!a.getODataEntitySet(n.getPath().split("(")[0].substring(1))){return}var r=t.getParameter("path");s.propertyChanged(r,n,e.nDelayedDraftTimerInSeconds).catch(l);e.oApplicationProxy.markCurrentDraftAsModified()};r.attachPropertyChange(u)}function v(e,t,n,r,i){var s=e||n;return new Promise(function(e,n){var o=s.getText("DRAFT_LOCK_EXPIRED",[t.LastChangedByUserDescription||t.LastChangedByUser]);var l=s.getText("Edit");var u=s.getText("CANCEL");a.warning(o,{title:s.getText("ST_UNSAVED_CHANGES_TITLE"),actions:[l,u],emphasizedAction:l,onClose:function(t){if(t===l){e()}else if(t===u){if(i&&r&&r.navigateUp){r.navigateUp()}}n()}})})}function g(t,n,r,a,s,o,l,c){var d=new Promise(function(d,g){var p=function(e,n){var r=t.editEntity(e,false,n);d(r);r.then(function(){a.invalidateEntry(e)})};if(r===""&&l&&c){var D=s.mEntityTree[n];var m=D.componentId&&s.componentRegistry[D.componentId];var y=m?i.getInfoForContentIdPromise(n,a,s.oAppComponent.getId(),m.utils.getRootExpand):Promise.resolve({contentIdRequestPossible:false});Promise.all([y,f(t,n,l,c,a,s)]).then(function(t){var i=t[1];var l=t[0].contentIdRequestPossible?t[0].parametersForContentIdRequest.sRootExpand:null;var u="/"+a.createKey(n,i);a.createBindingContext(r,null,null,function(t){var t=new e(a,u);if(!i.DraftAdministrativeData||i.DraftAdministrativeData.DraftIsCreatedByMe){p(t,l)}else if(i.DraftAdministrativeData.InProcessByUser){g({lockedByUser:i.DraftAdministrativeData.InProcessByUserDescription||i.DraftAdministrativeData.InProcessByUser})}else{v(s,i.DraftAdministrativeData,o).then(function(){p(t)},function(){g({lockedByUser:i.DraftAdministrativeData.LastChangedByUserDescription||i.DraftAdministrativeData.LastChangedByUser})})}})},function(e){g({draftAdminReadResponse:e})})}else{var h=t.getDraftController().getDraftContext();a.createBindingContext(r,null,null,function(e){if(h.isDraftEnabled(n)){u(a,r,s.oBusyHelper).then(function(t){if(!t.DraftAdministrativeData||t.DraftAdministrativeData.DraftIsCreatedByMe){p(e)}else if(t.DraftAdministrativeData.InProcessByUser){g({lockedByUser:t.DraftAdministrativeData.InProcessByUserDescription||t.DraftAdministrativeData.InProcessByUser})}else{var n=function(){p(e)};var r=function(){g({lockedByUser:t.DraftAdministrativeData.LastChangedByUserDescription||t.DraftAdministrativeData.LastChangedByUser})};var a=v(s,t.DraftAdministrativeData,o);a.then(n,r)}},function(e){g({draftAdminReadResponse:e})})}else{d({context:e})}})}});s.oBusyHelper.setBusy(d,true);return d}function p(e,t,n,r,a,i,s,o,l){var f=e.getDraftController().getDraftContext();var c=new Promise(function(d,g){r.createBindingContext(n,null,null,function(p){if(f.isDraftEnabled(t)){e.editEntity(p,true).then(function(e){p.getModel().invalidateEntry(p);s.setRootPageToDirty();d({context:e.context})},function(t){if(t&&t.response&&t.response.statusCode==="409"){a.removeTransientMessages();u(r,n,a.getBusyHelper()).then(function(t){if(t.DraftAdministrativeData.InProcessByUser){g({lockedByUser:t.DraftAdministrativeData.InProcessByUserDescription||t.DraftAdministrativeData.InProcessByUser})}else{var n=function(){var t=e.editEntity(p,false).then(function(e){p.getModel().invalidateEntry(p);s.setRootPageToDirty();d({context:e.context})});a.getBusyHelper().setBusy(t,true)};var r=g({cancelled:true});var u=v(undefined,t.DraftAdministrativeData,i,o,l);u.then(n,r)}},function(e){g({draftAdminReadResponse:e})});a.getBusyHelper().setBusy(c,true)}else{g(t)}})}else{return d({context:p})}})});return c}function D(e,t,n,r,a,i){var s=e.hasActiveEntity(r);var o=s&&!a?n.getDraftSiblingPromise(r):Promise.resolve();return o.then(function(e){var o=t(a,s,r);if(!a){var l=function(){return{context:e}};var u=o.then(l);n.cancellationStarted(r,u,i,e)}return o})}function m(e,t,n,r){var a=function(e,n,r){return t.deleteEntity(r,null,true)};return D(e,a,n,r,false,"discardAction")}function y(e,n,r){var a=n.getMessageModel();var i=a.bindList("/",null,null,[e]);var s=i.getAllCurrentContexts().map(function(e){return e.getObject()});if(r){s=s.filter(function(e){return!t.isMessageETagMessage(e)})}return s}function h(e,n,r,a,o,l){if(r.isBusy()){return s}var u=new Promise(function(s,u){var f=o.getView();var c=e?e:f.getBindingContext();var d=n?n:a.oTemplateCapabilities.oMessageButtonHelper&&a.oTemplateCapabilities.oMessageButtonHelper.getContextFilter(true);var v=sap.ui.getCore().getMessageManager();var g=f.getModel();var p=o.getOwnerComponent();var D=p.getEntitySet();var m=p.getAppComponent();var h=m.getId();var C=i.getInfoForContentIdPromise(D,g,h,l.getRootExpand);var A=C.then(function(e){var n=e.contentIdRequestPossible?e.parametersForContentIdRequest.sRootExpand:undefined;var i;var f=function(e){var g=i||y(d,v);var p=a.oDraftController.activateDraftEntity(c,e,n);a.oApplication.activationStarted(c,p);p.then(function(e){v.removeMessages(g);s(e)});p.catch(function(n){i=y(d,v);if(i.length>0){var r=i[0];var s=g.some(function(e){return e===r});if(s){u();return}}var c=a.oApplication.getTransientMessages();var p=[];var D=[];var m=false;c.forEach(function(t){m=!e&&(m||t.technicalDetails&&t.technicalDetails.statusCode==="412"&&t.technicalDetails.headers&&t.technicalDetails.headers["preference-applied"]==="handling=strict");if(t.type==="Warning"){p.push(t)}else if(t.type==="Error"){D.push(t)}});var h=i.some(function(e){return e.type==="Error"});var C=i.some(function(e){return e.type==="Warning"});var A=m&&!h&&(!!p.length||C);if(A){var E=C?i:p;var B=i.length===0&&{isCustomMessage:function(e){return p.indexOf(e)>=0}};if(B){a.oApplication.registerCustomMessageProvider(B)}a.oApplication.removeTransientMessages();var I=function(e){if(B){a.oApplication.deregisterCustomMessageProvider(B);a.oApplication.removeTransientMessages()}if(e){f(true)}else{u()}};var P={messagesForUserDecison:E};var x=l.getCRUDActionHandler();x.handleCRUDScenario(4,I.bind(null,true),I.bind(null,false),"Activate",P);return}u();if(h){a.oApplication.removeTransientMessages();if(a.oTemplateCapabilities&&a.oTemplateCapabilities.oMessageButtonHelper){a.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover();return}}t.handleError(t.operations.activateDraftEntity,o,a,n,null)});r.setBusy(p)};r.setBusy(A);var p=a.oApplication.getDraftSiblingPromise(c).then(function(e){if(e){g.invalidateEntry(e)}});r.setBusy(p);p.then(f.bind(null,false))});r.setBusy(A)});return u}return{createNonDraft:o,create:l,edit:g,directEdit:p,enableAutomaticDraftSaving:d,discardDraft:m,deleteEntity:D,activateDraftEntity:h,fnGetMessagesFromContextFilter:y}});
//# sourceMappingURL=CRUDHelper.js.map