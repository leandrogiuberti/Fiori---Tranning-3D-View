sap.ui.define(["sap/ui/core/Control","sap/ui/model/Sorter","sap/ui/model/analytics/odata4analytics","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/ui/core/format/NumberFormat","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms","sap/ui/core/format/DateFormat","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/AnalyticalListPage/util/CriticalityUtil","sap/suite/ui/generic/template/listTemplates/listUtils","sap/base/util/extend","sap/base/util/deepExtend","sap/ui/core/Element"],function(e,t,i,a,r,s,n,l,o,u,g,p,f){"use strict";var c=new l("AnalyticalListPage.control.visualfilterbar.FilterItemMicroChart").getLogger();var d="Donut";var h="Line";var m="Bar";var y="__IS_OTHER__";var _=e.extend("sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemMicroChart",{metadata:{properties:{selectFilters:{type:"any",group:"Misc",defaultValue:null},filterRestriction:{type:"string",group:"Misc",defaultValue:null},entitySet:{type:"string",group:"Misc",defaultValue:null},lazyLoadVisualFilter:{type:"boolean",group:"Misc",defaultValue:true},dimensionField:{type:"string",group:"Misc",defaultValue:null},dimensionFieldIsDateTime:{type:"boolean",group:"Misc",defaultValue:false},dimensionFieldIsDateTimeOffset:{type:"boolean",group:"Misc",defaultValue:false},dimensionFieldDisplay:{type:"string",group:"Misc",defaultValue:null},dimensionFilter:{type:"any",group:"Misc",defaultValue:null},dimensionFilterExternal:{type:"any",group:"Misc",defaultValue:null},measureField:{type:"string",group:"Misc",defaultValue:null},unitField:{type:"string",group:"Misc",defaultValue:null},isCurrency:{type:"boolean",group:"Misc",defaultValue:false},isMandatory:{type:"boolean",group:"Misc",defaultValue:false},isDropDown:{type:"boolean",group:"Misc",defaultValue:false},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},title:{type:"string",group:"Misc",defaultValue:""},outParameter:{type:"string",group:"Misc",defaultValue:null},inParameters:{type:"object[]",group:"Misc",defaultValue:null},parentProperty:{type:"string",group:"Misc",defaultValue:null},sortOrder:{type:"object[]",group:"Misc",defaultValue:null},scaleFactor:{type:"string",group:"Misc",defaultValue:null},numberOfFractionalDigits:{type:"string",group:"Misc",defaultValue:null},textArrangement:{type:"string",group:"Misc",defaultValue:sap.ui.comp.smartfilterbar.DisplayBehaviour.descriptionAndId},chartQualifier:{type:"string",group:"Misc",defaultValue:null},smartFilterId:{type:"string",group:"Misc",defaultValue:null},isParameter:{type:"boolean",group:"Misc",defaultValue:false},activeVisualFilters:{type:"boolean",group:"Misc",defaultValue:false},stringdate:{type:"string",group:"Misc",defaultValue:""}},aggregations:{control:{type:"sap.ui5.controls.microchart",multiple:false}},events:{filterChange:{},titleChange:{},beforeRebindVisualFilter:{}}},renderer:{apiVersion:2,render:function(e,t){e.openStart("div",t);e.style("width","100%");document.body.classList.contains("sapUiSizeCozy")?e.style("height","9.9rem"):e.style("height","7.9rem");e.openEnd();e.renderControl(t.getAggregation("control"));e.close("div")}}});_.prototype._formattingId="__UI5__ShortIntegerMaxFraction2";_.prototype._maxFractionalDigits=2;_.prototype._maxFractionalDigitsValsLessThanZero=7;_.prototype._minFractionalDigits=0;_.prototype._isTriggeredBySync=false;_.prototype._multiUnit=false;_.prototype.technicalIssueMessage="M_VISUAL_FILTERS_ERROR_DATA_TEXT";_.prototype.noDataIssueMessage="NO_DATA_FOUND_OVERLAY_MESSAGE";_.prototype.multipleCurrencyMessage="M_VISUAL_FILTERS_MULTIPLE_CURRENCY";_.prototype.multipleUnitMessage="M_VISUAL_FILTERS_MULTIPLE_UNIT";_.prototype.hiddenMeasureMessage="M_VISUAL_FILTER_HIDDEN_MEASURE";_.prototype.invalidMeasureForDonutMessage="INVALID_MEASURE_DONUT_MESSAGE";_.prototype.valuehelpAllMandatoryFilters={};_.prototype.oDataQueryOptions=["$select","$top","$expand","$inlinecount","$orderby","$filter","$skip","$format"];_.prototype.missingMandatoryField="M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_SINGLEVF";_.prototype.missingMultipleMandatoryFields="M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_MULTIPLEVF";_.prototype.init=function(){this._bAllowBindingUpdateOnPropertyChange=false;this._attachChartEvents()};_.prototype._attachChartEvents=function(){var e=this;this._chart.addEventDelegate({onAfterRendering:function(){if(e._getChartAggregations().length){if(e._multiUnit){var t=a.getPropertyNameDisplay(e.getModel(),e.getEntitySet(),e.getDimensionField(),e.getModel("@i18n"));e.applyOverlay(e.getIsCurrency()?e.multipleCurrencyMessage:e.multipleUnitMessage,t);if(e.data("isDialogFilterItem")==="true"){a._updateVisualFilterAria(e.getParent().getParent())}}}}});this._chart.attachSelectionChanged(this._onSelectionChanged,this)};_.prototype._getCurrentSelectedChart=function(e){if(this._chart.getPoints){return e?h:"point"}else if(this._chart.getSegments){return e?d:"segment"}else if(this._chart.getBars){return e?m:"bar"}};_.prototype._getCustomData=function(e){var t=this._getCurrentSelectedChart();var i=t?e.getParameter(t):undefined;if(t&&i){var r=i.getCustomData(),s=r[0].getValue(),n;if(s instanceof Date){s=this.getDimensionFieldIsDateTimeOffset()?s:a.convertLocalDatetoUTCDate(s)}else if(this.getDimensionFieldIsDateTime()&&this._isStringDateType()=="yearmonth"){n=s}else if(i.getLabel()===this._getI18nText("NOT_ASSIGNED")){n=""}else{n=i&&i.getLabel()}var l={dimValue:s,dimValueDisplay:n};return l}};_.prototype._getEntityParameters=function(e,t){var i={};if(this.getSmartFilterId()){var a=f.getElementById(this.getSmartFilterId());var r=u.getSelectionVariantParameterNamesWithoutNavigation(this.getSelectFilters()&&this.getSelectFilters().Parameters);var s=a.getEntitySet()===t?a.getAnalyticalParameters():[];var n=this.getSelectFilters()&&this.getSelectFilters().SelectOptions;var l=this.checkSearchable(e,t,a,r,n);if(l.aMandatoryFilter.length===1){this.applyOverlay(this.missingMandatoryField,l.aMandatoryFilter[0]);return}if(!l.bIsMandatoryFilter){this.applyOverlay(this.missingMultipleMandatoryFields);return}if(r){r.forEach(function(e){i[e.PropertyName.PropertyPath]=e.PropertyValue.String})}if(s){var o=a.getUiState().getSelectionVariant().Parameters;var g={};o&&o.map(function(e){g[e.PropertyName]=e.PropertyValue});var p=JSON.parse(a.data("dateFormatSettings"));s.forEach(function(e){var t=g[e.name];if(t){if(e.type==="Edm.Time"&&t instanceof Date){if(p&&!p.UTC){t=new Date(t.valueOf()+t.getTimezoneOffset()*60*1e3)}t={__edmType:"Edm.Time",ms:((t.getHours()*60+t.getMinutes())*60+t.getSeconds())*1e3+t.getMilliseconds()}}else if(p&&p.UTC&&t instanceof Date){t=this._getDateInUTCOffset(t)}else if(isNaN(t)&&!isNaN(Date.parse(t))&&t.indexOf("Z")!==t.length-1){t=t.split("T")[0]+"T00:00:00Z"}i[e.name]=t}else if(e.type==="Edm.String"&&e["sap:parameter"]==="optional"){i[e.name]=""}}.bind(this))}return i}return};_.prototype._executeRebindVisualFilterExtension=function(e,t,i,a,r){var s={sEntityType:e,sDimension:t,sMeasure:i,oContext:{filters:a,queryParameters:{},sorters:this._sorters,entityParameters:r,groupId:undefined}};this.fireBeforeRebindVisualFilter(s);return s.oContext};_.prototype._onSelectionChanged=function(e){var t=e.getSource().getParent().getBindingContext("_visualFilterDialogModel");if(t){var i=t.getObject("component");i.properties.activeVisualFilters=e.getParameter("selected")}var a=this.getFilterRestriction(),r=this._getCustomData(e),s=e.getParameter("selected"),n=a==="single"&&r.dimValue===y&&s;if(r.dimValue===y&&s&&this.getIsDropDown()){e.getParameter("segment").setSelected(false);return}if(n){e.getParameter("segment").setSelected(false)}if(s&&r.dimValue===y&&a==="multiple"||s&&r.dimValue!==y){this._onChartSelectData(e)}else if(!s){this._onChartDeselectData(e)}};_.prototype._onChartSelectData=function(e){var t,i=this.getFilterRestriction();if(i==="multiple"){t=p({items:[],ranges:[],value:null},this.getDimensionFilter());var r=this._getCustomData(e),s=this._getCurrentSelectedChart(true);if(s===d){t=this._applyDonutChartSelections(r,t)}else if(r.dimValue instanceof Date){t.ranges.push({exclude:false,keyField:this.getDimensionField(),operation:"EQ",value1:r.dimValue,value2:null})}else if(r.dimValue===""){t.ranges.push({exclude:false,keyField:this.getDimensionField(),operation:"Empty",value1:r.dimValue,value2:null})}else{t.items.push({key:r.dimValue,text:r.dimValueDisplay})}}else{t=this.getDimensionFilter();if(t){t=null;var n=e.getParameter("bar")||e.getParameter("point")||e.getParameter("segment");this._setSelectedAggregation(n);n.setSelected(true)}var r=this._getCustomData(e);if(this.getDimensionFieldIsDateTime()&&this.getDimensionFilter()instanceof Object){t=p({},this.getDimensionFilter());t.conditionTypeInfo.data.operation="DATE";if(this._isStringDateType()=="yearmonthday"){t.conditionTypeInfo.data["value1"]=a.formatStringDate(r.dimValue)}else{t.conditionTypeInfo.data["value1"]=r.dimValue}t.ranges=[]}else{t=r.dimValue}}this.setDimensionFilter(t);this.fireFilterChange()};_.prototype._setSelectedAggregation=function(e){var t=this._chart.setSelectedBars||this._chart.setSelectedPoints||this._chart.setSelectedSegments;t.call(this._chart,e)};_.prototype._getChartAggregations=function(){var e=this._chart.getPoints||this._chart.getSegments||this._chart.getBars;return e.call(this._chart)};_.prototype._onChartDeselectData=function(e){var t=this;var i,r=this.getFilterRestriction(),s=this._getCustomData(e),n=[],l=[];if(r==="single"){i=null}else{i=p({},this.getDimensionFilter());var o=i&&i.items?i.items:undefined,u=i&&i.ranges?i.ranges:undefined,g=i&&i.value?i.value:null;if(o){o.forEach(function(e){var t=a.getResolvedDimensionValue(e.key),i=a.getResolvedDimensionValue(s.dimValue);if(t!==i){n.push(e)}})}i.items=n;if(g){if(s.dimValue===g){i.value=null}}if(u){u.forEach(function(e){if(e.operation==="EQ"&&s.dimValue!==y&&e.exclude){l.push(e)}else if(e.operation==="EQ"&&!e.exclude){if(e.value1 instanceof Date&&s.dimValue instanceof Date){if(t.getDimensionFieldIsDateTimeOffset()){if(a.getDateTimeInMedium(e.value1)!==a.getDateTimeInMedium(s.dimValue)){l.push(e)}}else if(a.getDateInMedium(e.value1)!==a.getDateInMedium(s.dimValue)){l.push(e)}}else if(typeof e.value1==="string"&&s.dimValue instanceof Date){if(a.getDateTimeInMedium(new Date(e.value1))!==a.getDateTimeInMedium(s.dimValue)){l.push(e)}}else if(e.value1!==s.dimValue){l.push(e)}}else if(e.operation!=="EQ"&&!e.exclude&&e.value1!==s.dimValue){l.push(e)}})}i.ranges=l}this.setDimensionFilter(i);this.fireFilterChange()};_.prototype._updateBinding=function(){if(a.isVisualFilterLazyLoaded(this)){return}this.applyOverlay();this._chart.setBusy(true);var e=this._getCurrentSelectedChart(true);var t=e===d;if(e===h){this._chart.unbindPoints()}else if(e===m){this._chart.unbindBars()}else if(t){this._chart.unbindSegments()}var i=this.getEntitySet(),r=this.getDimensionField(),s=this.getDimensionFieldDisplay(),n=this.getMeasureField(),l=this.getUnitField(),u=this.getDimensionFilterExternal(),p=[],f=this.getSortOrder(),y=this.getModel(),_=y.getMetaModel(),v=this._getSorter(f);this._sorters=v.sorter;p=v.sortFields;if(!i||!n||!r||!s){return}if(this._determineHiddenVisualFilter(_,i,n)){var F=a.getPropertyNameDisplay(y,i,n,this.getModel("@i18n"));this.applyOverlay(this.hiddenMeasureMessage,F);return}if(l){var D=a.getUnitFieldText(this.getModel(),i,l);if(D&&a.IsNavigationProperty(this.getModel(),i,D)){var M=D.split("/")[0]}}if(t){if(this._determineIfInvalidMeasure(_,i,n)){this.applyOverlay(this.invalidMeasureForDonutMessage);return}}var S=[n,r],I=a.IsNavigationProperty(this.getModel(),i,s)?s.split("/")[0]:null,T=a.getKeysForNavigationEntitySet(_,this.getEntitySet(),I),S=a.getVisualFilterSelectFields(n,r,s,l,p,T,D);var V=[];if(u&&u.aFilters&&u.aFilters.length>0){V=[u]}var E=this;var P=!t&&this.getFixedCount();var y=this.getModel(),b=this.getModel("visualFilter")||y;var O=this._getEntityParameters(y,i);if(!(O instanceof Object)){return}var L=this._executeRebindVisualFilterExtension(i,r,n,V,O),R=L.groupId,C="/"+i;if(y){var U=o.getDataPoint(y,this);this.setNumberOfFractionalDigits(null);if(U){U.ValueFormat&&U.ValueFormat.ScaleFactor?this.setScaleFactor(a.getPrimitiveValue(U.ValueFormat.ScaleFactor)):this.setScaleFactor(null);U.ValueFormat&&U.ValueFormat.NumberOfFractionalDigits?this.setNumberOfFractionalDigits(a.getPrimitiveValue(U.ValueFormat.NumberOfFractionalDigits)):this.setNumberOfFractionalDigits(null);var A=o.getCriticalityRefProperties(U)}C=this._getBindingPathforVisualFilter(y,i,O);if(!C){return}if(this._oObject){this._oObject.abort()}if(this._oTop4ReadObject){this._oTop4ReadObject.abort()}if(this._oTotalReadObject){this._oTotalReadObject.abort()}if(this._determineInteger(_,i,n)){this.setNumberOfFractionalDigits(0)}var N={};var x={async:true,filters:V,urlParameters:N};if(R){x.groupId=R}if(!t){g(x,{sorters:this._sorters,success:function(e,t){E._oObject=null;if(U&&(U.Criticality||U.CriticalityCalculation)){e=o.CalculateCriticality(U,e,E.getMeasureField())}else{e=o.CalculateDimensionCriticality(y,E.getDimensionField(),E.getEntitySet(),e)}E._onDataReceived(e)},error:function(e){c.error("Error reading URL:"+e.message);if(e&&e.statusCode!==0&&e.statusText!=="abort"){E.applyOverlay(E.technicalIssueMessage);E._oObject=null}}});this._updateBindingInfo(x,S,A,P,L,I,M,t);this._fetchData(b,C,x,t)}else{this._updateBindingInfo(x,[n],A,1,L,I,M,t,true,V);var B=this._fetchData(b,C,x,t,true,U);x.filters=V;this._updateBindingInfo(x,S,A,4,L,I,M,t,false);var j=this._fetchData(b,C,x,t,false,U);Promise.all([j,B]).then(function(e){var t=e[0].data;var i=e[0].iDataLength;var a=e[1].data;var r=e[1].iDataLength;if(!i){E.applyOverlay(E.noDataIssueMessage)}else if(i<=3){E._onDataReceived(t)}else if(i>3){if(r){E._onDataReceived(t,a)}else{E.applyOverlay(E.noDataIssueMessage)}}},function(e){var t=e.error;var i=e.bToFetchTotalData;if(!t||t.statusCode!==0&&t.statusText!=="abort"){if(i===true){E._oTotalReadObject=null}else{E._oTop4ReadObject=null}E.applyOverlay(E.technicalIssueMessage)}})}}};_.prototype._updateBindingInfo=function(e,t,i,a,r,s,n,l,o,u){e.urlParameters={$select:i?[i].concat(t).join(","):t.join(","),$top:a};if(Object.keys(r.queryParameters).length>0){Object.keys(r.queryParameters).forEach(function(t){if(this.oDataQueryOptions.indexOf(t)<0){e.urlParameters[t]=r.queryParameters[t]}}.bind(this))}if(l?s&&!o:s){g(e.urlParameters,{$expand:s})}if(l?n&&!o:n){g(e.urlParameters,{$expand:n})}if(l&&!o){e.sorters=this._sorters}else if(l&&o){e.filters=u}};_.prototype._fetchData=function(e,t,i,a,r,s){var n=this;if(a){return new Promise(function(a,l){if(!e){l({error:null,bToFetchTotalData:r})}i.success=function(e,t){if(r===true){n._oTotalReadObject=null}else{n._oTop4ReadObject=null}if(s&&(s.Criticality||s.CriticalityCalculation)){e=o.CalculateCriticality(s,e,n.getMeasureField())}else if(!r){e=o.CalculateDimensionCriticality(n.getModel(),n.getDimensionField(),n.getEntitySet(),e)}var i=e&&e.results&&e.results.length?e.results.length:0;a({data:e,iDataLength:i})};i.error=function(e,t){l({error:e,bToFetchTotalData:t})};if(r){n._oTotalReadObject=e.read(t,i)}else{n._oTop4ReadObject=e.read(t,i)}})}this._oObject=e.read(t,i)};_.prototype._getSorter=function(e){var i=[],a=[],r=[];for(var s=0;s<e.length;s++){i[s]=e[s].Field.String;a[s]=e[s].Descending.Boolean;r.push(new t(i[s],a[s]))}var n={sorter:r,sortFields:i};return n};_.prototype._getNumberFormatter=function(e){var t=r.getIntegerInstance({style:"short",showScale:false,shortRefNumber:e});return t};_.prototype.setWidth=function(e){this.setProperty("width",e)};_.prototype.setHeight=function(e){this.setProperty("height",e)};_.prototype.setEntitySet=function(e){this.setProperty("entitySet",e)};_.prototype.setDimensionField=function(e){this.setProperty("dimensionField",e)};_.prototype.setDimensionFieldIsDateTime=function(e){this.setProperty("dimensionFieldIsDateTime",e)};_.prototype.setDimensionFieldDisplay=function(e){this.setProperty("dimensionFieldDisplay",e)};_.prototype.setMeasureField=function(e){if(e&&e.constructor===Object){if(e.value){this.setProperty("measureField",e.value)}if(e.bUpdateBinding){this._updateBinding()}}else if(e&&e.constructor===Array){this.setProperty("measureField",e)}else{this.setProperty("measureField",e)}};_.prototype.setUnitField=function(e){this.setProperty("unitField",e)};_.prototype.setSortOrder=function(e){if(e&&e.constructor===Object){if(e.value){this.setProperty("sortOrder",e.value)}if(e.bUpdateBinding){this._updateBinding()}}else if(e&&e.constructor===Array){this.setProperty("sortOrder",e)}else{this.setProperty("sortOrder",e)}};_.prototype.setDimensionFilterExternal=function(e){this.setProperty("dimensionFilterExternal",e);if(this._bAllowBindingUpdateOnPropertyChange){this._updateBinding()}};_.prototype.getP13NConfig=function(){var e=["width","height","filterRestriction","isDropDown","sortOrder","measureField","scaleFactor","numberOfFractionalDigits","chartQualifier","entitySet","dimensionField","dimensionFieldDisplay","dimensionFieldIsDateTime","dimensionFilter","unitField","isCurrency","isMandatory","outParameter","inParameters","parentProperty"];var t={};for(var i=0;i<e.length;i++){var a=e[i];t[a]=this.getProperty(a);if((a=="outParameter"||a=="inParameters")&&t[a]==""){t[a]=undefined}}return t};_.prototype.setDimensionFilter=function(e,t){this.setProperty("dimensionFilter",e,true)};_.prototype._onDataReceived=function(e){if(!e||this.isDestroyStarted()){return}this.data("sOverlay","none");if(!this.getParent()){this.data("needsToUpdateAria","true")}else{this.data("needsToUpdateAria","false");if(this.data("isDialogFilterItem")==="true"){a._updateVisualFilterAria(this.getParent().getParent())}}this._determineUnit(e);this._getShortRefNumber(e.slice(0))};_.prototype._determineUnit=function(e){this._multiUnit=false;var t=this.getUnitField();if(t){var i=e[0][t];for(var r=1;r<e.length;r++){if(e[r].dimensionValue!==y){var s=e[r][t]}if(s!=i){if(e.length>1){this._multiUnit=true}break}i=s}var n=a.getUnitFieldText(this.getModel(),this.getEntitySet(),t);if(n&&a.IsNavigationProperty(this.getModel(),this.getEntitySet(),n)){var l=n.split("/")[0],o=n.split("/")[1];this._applyUnitValue(this._multiUnit?"":i+" ("+e[0][l][o]+")");return}if(n){n=e[0][n];this._applyUnitValue(this._multiUnit?"":i+" ("+n+")")}else{this._getUnitTextFromValueList(t,i)}}else{this._applyUnitValue("")}};_.prototype._getUnitTextFromValueList=function(e,t){var i=this;var r=this.getModel().getMetaModel();var s=r.getODataEntitySet(this.getEntitySet());var n=r.getODataEntityType(s.entityType);var l=r.getODataProperty(n,e);if(l["com.sap.vocabularies.Common.v1.ValueList"]){var o=l["com.sap.vocabularies.Common.v1.ValueList"].CollectionPath?l["com.sap.vocabularies.Common.v1.ValueList"].CollectionPath.String:"";var u=l["com.sap.vocabularies.Common.v1.ValueList"].Parameters&&l["com.sap.vocabularies.Common.v1.ValueList"].Parameters[0].ValueListProperty?l["com.sap.vocabularies.Common.v1.ValueList"].Parameters[0].ValueListProperty.String:""}if(o&&u){var p=a.getUnitFieldText(this.getModel(),o,u);if(p){var f="/"+o;var d=new sap.ui.model.Filter({path:u,operator:"EQ",value1:t});var h=[];h.push(d);this.aSelectFields=[];this.aSelectFields.push(u);this.aSelectFields.push(p);this.prevUnit=t;var m={$select:this.aSelectFields};var y={async:true,filters:h,urlParameters:m};g(y,{success:function(e,t){i._oObject=null;i._onValueListUnitDataReceived(e)},error:function(e){c.error("Error reading URL:"+e);if(e&&e.statusCode!==0&&e.statusText!=="abort"){i.applyOverlay(i.technicalIssueMessage);i._oObject=null}}});this._oObject=this.getModel().read(f,y)}}else{this._applyUnitValue(this._multiUnit?"":t)}};_.prototype._onValueListUnitDataReceived=function(e){var t=e.results[0];if(t[this.aSelectFields[0]]==this.prevUnit){var i=t[this.aSelectFields[1]]}this._applyUnitValue(this.prevUnit+" ("+i+")")};_.prototype._applyUnitValue=function(e){if(this._lastUnitValue!=e){this._lastUnitValue=e;this.fireTitleChange()}};_.prototype._getShortRefNumber=function(e){this._scaleValue="";this._shortRefNumber=undefined;var t=this.getScaleFactor(),i;if(!t){var a=this._getScaleFactorFromMedian(e);t=a.iShortRefNumber;i=a.scale}else{var r=this._getNumberFormatter(t);i=r.getScale()?r.getScale():""}this._shortRefNumber=t;this._scaleValue=i;this.fireTitleChange()};_.prototype._getScaleFactorFromMedian=function(e){var t=this.getMeasureField();e.sort(function(e,i){if(Number(e[t])<Number(i[t])){return-1}if(Number(e[t])>Number(i[t])){return 1}return 0});var i=e.length/2,a=i%1===0?(parseFloat(e[i-1][t])+parseFloat(e[i][t]))/2:parseFloat(e[Math.floor(i)][t]),r=a,s;for(var n=0;n<14;n++){s=Math.pow(10,n);if(Math.round(Math.abs(r)/s)<10){break}}var l=this._getNumberFormatter(s);for(var n=0;n<e.length;n++){var o=e[n],u=l.format(o[t]),g=u.split(".");if(!g[1]&&parseInt(g[0],10)===0||g[1]&&parseInt(g[0],10)===0&&g[1].indexOf("0")===0||u/1e3>=1e3){s=undefined;break}}return{iShortRefNumber:s,scale:s?l.getScale():""}};_.prototype._getScaleFactor=function(e){var e=parseFloat(e);var t=this._minFractionalDigits;for(var i=0;i<14;i++){var a=Math.pow(10,i);if(Math.round(Math.abs(e)/a,t-1)<10){return a}}return undefined};_.prototype.getTitle=function(e){var t=this.getModel();if(!t){return""}var i=a.getPropertyNameDisplay(t,this.getEntitySet(),this.getMeasureField(),e);var r=a.getPropertyNameDisplay(t,this.getEntitySet(),this.getDimensionField(),e);var s=this._lastUnitValue?this._lastUnitValue:"";var n=this._scaleValue?this._scaleValue:"";var l=this.getModel("i18n");if(!l){return""}var o=l.getResourceBundle();var u=o.getText("VIS_FILTER_TITLE_MD",[i,r]);var g=n+" "+s;g=g.trim();g=g.indexOf("%")>-1?"":g;var p=a.getPropertyNameDisplay(t,this.getEntitySet(),this.getMeasureField(),e,true);var f=a.getPropertyNameDisplay(t,this.getEntitySet(),this.getDimensionField(),e,true);var c=o.getText("VIS_FILTER_TITLE_MD",[p,f]);var d={titleMD:u,titleUnitCurr:g,titleQuickInfo:c};return d};_.prototype.getFormattedNumber=function(e,t){var i=this.getNumberOfFractionalDigits();if(i===""||i===undefined){i="1"}else{if(Number(i)>1){i="1"}}var a=r.getFloatInstance({style:"short",decimals:Number(i),showScale:t,shortRefNumber:this._shortRefNumber,minFractionDigits:this._minFractionalDigits,maxFractionDigits:this._maxFractionalDigits});return a.format(parseFloat(e))};_.prototype._getFormattedNumberWithUoM=function(e,t,i){t=t?t:"";i=i?" ("+i+")":"";var a=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var s=r.getFloatInstance({maxFractionDigits:3,groupingEnabled:true},a).format(e);return t==="%"?s+"%":s+" "+t+i};_.prototype._getDisplayedValue=function(e,t){var i=this._scaleValue==="",a=this.getFormattedNumber(e,i),r=t==="%";return r?a+"%":""+a};_.prototype._getToolTip=function(e,t,i,a,r){var s=this.getModel("i18n");if(!s){return""}var n=s.getResourceBundle();var l=this._getFormattedNumberWithUoM(t,i,a);var o;switch(r){case"Good":o=n.getText("VIS_FILTER_TOOLTIP_STATUS_GOOD");break;case"Error":o=n.getText("VIS_FILTER_TOOLTIP_STATUS_ERROR");break;case"Critical":o=n.getText("VIS_FILTER_TOOLTIP_STATUS_CRITICAL");break;default:o="Neutral"}if(o==="Neutral"){return e+" "+l}else{return e+" "+l+"\n"+o}};_.prototype._getSelected=function(e,t){var i=false,r=this.getFilterRestriction(),s=[];if(e){if(r==="multiple"){if(e.items){e.items.forEach(function(e){var r=a.getResolvedDimensionValue(e.key),s=a.getResolvedDimensionValue(t);if(r===s){i=true}})}if(e.value&&e.value===t){i=true;return i}if(e.ranges){var s=e.ranges.filter(function(e){if(e.exclude&&(e.operation==="EQ"||e.operation==="Empty")){return e}});for(var n=0;n<e.ranges.length;n++){var l=e.ranges[n];if((l.operation==="EQ"||l.operation==="Empty")&&(l.value1||l.value1==="")&&!l.exclude){if(l.value1 instanceof Date&&t instanceof Date){if(this.getDimensionFieldIsDateTimeOffset()){if(a.getDateTimeInMedium(l.value1)===a.getDateTimeInMedium(t)){i=true;break}}else if(a.getDateInMedium(l.value1)===a.getDateInMedium(t)){i=true;break}}else if(l.value1===t||this._isDateTimeFieldSelected(l.value1,t)){i=true;break}}}if(i){for(var n=0;n<s.length;n++){if(s[n].value1===t&&s[n].operation==="EQ"){i=false;break}}}if(s.length===2&&t===y){var o=0,u=this._chart.getSegments();u.forEach(function(e){var t=e.getCustomData()[0].getValue();s.forEach(function(e){if(e.value1.indexOf(t)>-1){o++}})});if(o===2){i=true}}}}else if(e instanceof Date&&t instanceof Date){if(this.getDimensionFieldIsDateTimeOffset()){if(a.getDateTimeInMedium(e)===a.getDateTimeInMedium(t)){i=true}}else if(a.getDateInMedium(e)===a.getDateInMedium(t)){i=true}}else if(e&&e===t){i=true}else if(this._isDateTimeFieldSelected(e,t)){i=true}}return i};_.prototype._isDateTimeFieldSelected=function(e,t){if(this.getDimensionFieldIsDateTime()){if(typeof e==="string"&&t instanceof Date){if(a.getDateInMedium(new Date(e))===a.getDateInMedium(t)){return true}}else if(e instanceof Date&&typeof t==="string"){var i=n.getDateInstance({pattern:"yyyyMMdd"});var r=i.parse(t);if(a.getDateInMedium(r)===a.getDateInMedium(e)){return true}}else if(e instanceof Object&&t instanceof Date){if(e.ranges.length){if(e.ranges[0].value1 instanceof Date&&a.getDateInMedium(e.ranges[0].value1)===a.getDateInMedium(t)){return true}else if(typeof e.ranges[0].value1==="string"&&a.getDateInMedium(new Date(e.ranges[0].value1))===a.getDateInMedium(t)){return true}}}else if(e instanceof Object&&typeof t==="string"){if(e.ranges.length&&e.ranges[0].value1===t){return true}}}else if(this.getDimensionFieldIsDateTimeOffset()){if(typeof e==="string"&&t instanceof Date){if(a.getDateTimeInMedium(new Date(e))===a.getDateTimeInMedium(t)){return true}}}return false};_.prototype._getLabel=function(e,t,i){if(this.getDimensionFieldIsDateTime()){if(t&&t!=y){e=t}var r=this._getCurrentSelectedChart(true);if(e instanceof Date){return a.getDateInMedium(a.convertLocalDatetoUTCDate(e))}else if(this._isStringDateType()=="yearmonthday"){return t===y?e:a.formatStringDate(e,r,i)}else if(this._isStringDateType()=="yearmonth"){return t===y?e:a.formatStringDateYearMonth(e,r,i)}else if(this._isStringDateType()=="yearweek"){return t===y?e:a.formatStringDateYearWeek(e,r,i)}else if(this._isStringDateType()=="yearquarter"){return t===y?e:a.formatStringDateYearQuarter(e,r,i)}else if(this._isStringDateType()=="fiscalyearperiod"){return t===y?e:a.formatStringFiscalYearPeriod(e,r,i)}else{return e}}else if(this.getDimensionFieldIsDateTimeOffset()){return a.getDateTimeInMedium(e)}else{var s=this.getTextArrangement();return a.getTextArrangement(e,t,s)}};_.prototype._getChartAggregationSettings=function(e){var t=f.getElementById(this.getSmartFilterId());var i=e===d?"dimensionValue":this.getDimensionField(),r=this.getDimensionFieldDisplay(),s=this.getMeasureField(),n=this.getUnitField(),l=n&&a.getUnitFieldText(this.getModel(),this.getEntitySet(),n),o=i===r?[r]:[r,i],u=i===r?[r,s,""]:[r,s,i],g=n?u.push(n):u,g=l?u.push(l):u,p=this,c={label:{parts:o,formatter:function(e,t){return p._getLabel(e,t,false)||p._getI18nText("NOT_ASSIGNED")}},value:{path:s,formatter:function(e){return parseFloat(e)}},color:"{color}",displayedValue:{parts:[s,n],formatter:function(e,t){return p._getDisplayedValue(e,t)}},tooltip:{parts:g.constructor===Array?g:u,formatter:function(e,t,i,a,r){e=e||e===""||e===0?e:"";i=i||i===""||i===0?i:"";i=i.constructor===Object?"":i;e=p._getLabel(e,i,false)||p._getI18nText("NOT_ASSIGNED");return p._getToolTip(e,t,a,r,this.getColor())}},selected:{parts:t.isDialogOpen()?["_dialogFilter>/"+p.getParentProperty(),i]:["_filter>/"+p.getParentProperty(),i],formatter:function(e,t){if(t instanceof Date){t=p.getDimensionFieldIsDateTimeOffset()?t:a.convertLocalDatetoUTCDate(t)}return p._getSelected(e,t)}},customData:{Type:"sap.ui.core.CustomData",key:i,value:"{"+i+"}"}};if(e===h&&p._isStringDateType()&&p._isStringDateType()!=="year"){c.secondaryLabel={parts:o,formatter:function(e,t){return p._getLabel(e,t,true)}}}return c};_.prototype.applyOverlay=function(e,t){if(this.isDestroyStarted()){return}if(e){this._chart.setShowError(true);this._chart.setErrorMessageTitle(this._getI18nText("M_VISUAL_FILTERS_ERROR_MESSAGE_TITLE"));this._chart.setErrorMessage(this.getModel("i18n").getResourceBundle().getText(e,t?[t]:undefined));this._chart.setBusy(false);this.data("sOverlay","true");if(this.data("isDialogFilterItem")==="true"){this.data("needsToUpdateAria","true")}this.fireTitleChange()}else{this._chart.setShowError(false);this._chart.setErrorMessageTitle("");this._chart.setErrorMessage("")}};_.prototype.considerAnalyticBinding=function(e,t){if(t&&t.getAnalyticBindingPath&&t.getConsiderAnalyticalParameters()){try{var i=t.getAnalyticBindingPath();if(i){return i}}catch(e){c.warning("Mandatory parameters have no values")}}return e};_.prototype._getBindingPathforVisualFilter=function(e,t,a){var r="";var s=new i.Model(i.Model.ReferenceByModel(e));var n=s.findQueryResultByName(t);var l=new i.QueryResultRequest(n);var o=n&&n.getParameterization();if(o){l.setParameterizationRequest(new i.ParameterizationRequest(o));if(a){Object.keys(a).forEach(function(e){l.getParameterizationRequest().setParameterValue(e,a[e])})}}try{r=l.getURIToQueryResultEntitySet()}catch(e){n=l.getQueryResult();r="/"+n.getEntitySet().getQName();c.error("getEntitySetPathWithParameters","binding path with parameters failed - "+e||e.message)}return r};_.prototype.checkSearchable=function(e,t,r,s,n){var l=new i.Model(i.Model.ReferenceByModel(e));var o=l.findQueryResultByName(t);var u=o&&o.getParameterization(),g=[],p={bIsMandatoryFilter:true};p=a.checkManditoryFieldsFilled(r);if(p.aMandatoryFilter.length===1){_.prototype.missingMandatoryField="M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_SINGLEVF";return p}if(!p.bIsMandatoryFilter){_.prototype.missingMultipleMandatoryFields="M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_MULTIPLEVF";return p}if(u){var f=[];var c=u.getAllParameters();for(var d in c){if(!c[d].isOptional()){f.push(c[d].getName())}}f.forEach(function(e){s&&s.forEach(function(t){if(t.PropertyName.PropertyPath===e&&t.PropertyValue.String){g.push("$Parameter."+t.PropertyName.PropertyPath)}})});_.prototype.missingMultipleMandatoryFields="REQUIRED_VH_FIELDS_OVERLAY_MESSAGE";if(r.getEntitySet()===t){_.prototype.missingMultipleMandatoryFields="M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_MULTIPLEVF";var h=r.getFilterData(true);f.forEach(function(e){if(h["$Parameter."+e]&&g.indexOf("$Parameter."+e)<0){g.push("$Parameter."+e)}})}if(f.length!==g.length){p.bIsMandatoryFilter=false;return p}}if(r.getEntitySet()===t){_.prototype.missingMultipleMandatoryFields="M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_MULTIPLEVF";var m=r.determineMandatoryFilterItems();var m=m.filter(function(e){return!e._bIsParameter});p.bIsMandatoryFilter=m.every(function(e){return a.checkFilterHasValueFromSelectionVariantOrSmartFilterBar(e.getName(),e.getName(),n,r)})}else{_.prototype.missingMultipleMandatoryFields="REQUIRED_VH_FIELDS_OVERLAY_MESSAGE";var y;if(!_.prototype.valuehelpAllMandatoryFilters[t]){_.prototype.valuehelpAllMandatoryFilters[t]=a.getAllMandatoryFilters(e,t)}y=a.getAllMandatoryFiltersMapping(_.prototype.valuehelpAllMandatoryFilters[t],this.getInParameters());p.bIsMandatoryFilter=y.aMappedFilterList.every(function(e){return a.checkFilterHasValueFromSelectionVariantOrSmartFilterBar(e.valueListProperty,e.localDataProperty,n,r)});if(!p.bIsMandatoryFilter){return p}p.bIsMandatoryFilter=y.aMappingMissingFilterList.every(function(e){var t=n&&a.checkFilterHasValueFromSelectionVariant(n,e);return t})}return p};_.prototype._getDateInUTCOffset=function(e){return new Date(e.valueOf()-e.getTimezoneOffset()*60*1e3)};_.prototype._isStringDateType=function(){var e=this.getCustomData();var t;e.forEach(function(e){if(e.getKey()=="stringdate"){t=e.getValue()}});return t};_.prototype._determineHiddenVisualFilter=function(e,t,i){var a=this._getMeasureProperty(e,t,i);if(a[s.Hidden]&&a[s.Hidden].Bool==="true"){return true}};_.prototype._determineIfInvalidMeasure=function(e,t,i){var a=this._getMeasureProperty(e,t,i);if(a["com.sap.vocabularies.Analytics.v1.AccumulativeMeasure"]&&a["com.sap.vocabularies.Analytics.v1.AccumulativeMeasure"].Bool==="false"){return true}return false};_.prototype._getMeasureProperty=function(e,t,i){var a=e.getODataEntityType(e.getODataEntitySet(t).entityType);var r=e.getODataProperty(a,i);return r};_.prototype._determineInteger=function(e,t,i){var r=false;var s=this._getMeasureProperty(e,t,i);if(s.type&&a.isInteger(s.type)){r=true}return r};_.prototype._getI18nText=function(e){var t=this.getModel("i18n");if(!t){return""}var i=t.getResourceBundle();return i.getText(e)};return _},true);
//# sourceMappingURL=FilterItemMicroChart.js.map