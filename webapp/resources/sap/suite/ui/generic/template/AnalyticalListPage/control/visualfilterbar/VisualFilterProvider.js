sap.ui.define(["sap/ui/comp/odata/MetadataAnalyser","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/genericUtilities/metadataAnalyser"],function(e,t,r,i,a){"use strict";var n=new i("AnalyticalListPage.control.visualfilterbar.VisualFilterProvider");var o=n.getLogger();var s=n.Level;var l=function(t){o.setLevel(s.WARNING,"VisualFilter");this._filter=t;this._oMetadataAnalyser=new e(t.getModel());this._groupList=[];this._groupListByName={};this._groupMap={};this._measureList=[];this._measureMap={};this._dimensionMap={};this._selectionFieldsLength=0;this._selectionFieldsParsed=0;this._annotationData={Filters:[]};this._metaModel=t.getModel().getMetaModel();this._initMetadata()};l.prototype._initMetadata=function(){var e=this._filter.getEntitySet();var t=this.getEntityType(e,this._metaModel);this._getFieldAnnotations(e,t);this._getVisualFilterAnnotation(t)};l.prototype.getVisualFilterConfig=function(){return JSON.parse(JSON.stringify(this._filterConfig))};l.prototype.getMetadataAnalyser=function(){return this._oMetadataAnalyser};l.prototype._getFieldAnnotations=function(e,t){if(!e){return}var i=this._filter.getModel();var a=i.getMetaModel();if(!t||!a){return}var n=this.getEntityType(e,a);if(!n){return}var o={};var s={};var l=this._oMetadataAnalyser.getFieldGroupAnnotation(n);for(var f=0;f<l.length;f++){var u=l[f];var p={name:u.groupName,label:u.groupLabel,fieldList:u.fields};s[p.name]=p;for(var d=0;d<u.fields.length;d++){o[u.fields[d]]=p}}var g=a.getODataEntityType(t);var h=g[r.SelectionFields];var m={};if(h){for(var f=0;f<h.length;f++){var y=h[f];m[y.PropertyPath]=y}}var c={};var v=this._oMetadataAnalyser.getFieldsByEntityTypeName(n);for(var f=0;f<v.length;f++){var _=v[f];var P=_.name;var F=a.getODataProperty(g,P);var M=F["sap:aggregation-role"];if(M=="dimension"){var D={name:P,fieldInfo:_,propInfo:F};var p=o[P];if(p){for(var d=0;d<p.fieldList.length;d++){if(p.fieldList[d]==P){p.fieldList[d]=D;break}}}else{var L=g[r.Label]?g[r.Label].String:undefined;var S=m[P]?"_BASIC":g[L]||g.name;var p=s[S];if(!p){p={name:S,label:S=="_BASIC"?this._filter.getModel("i18n").getResourceBundle().getText("VIS_FILTER_GRP_BASIC_TITLE"):S,fieldList:[]};s[S]=p}p.fieldList.push(D);o[P]=p}c[p.name]=true}}var I=[];if(c["_BASIC"]){I.push(s["_BASIC"]);delete s["_BASIC"]}for(var f=0;f<l.length;f++){var S=l[f].groupName;if(S=="_BASIC"){continue}if(c[S]){I.push(s[S])}delete s[S]}for(var S in s){if(c[S]){I.push(s[S])}delete s[S]}s={};for(var f=0;f<I.length;f++){var p=I[f];s[p.name]=p}};l.prototype.getGroupList=function(){return this._groupList?this._groupList:[]};l.prototype.getGroupMap=function(){return this._groupMap?this._groupMap:{}};l.prototype.getMeasureMap=function(){return this._measureMap};l.prototype.getDimensionMap=function(){return this._dimensionMap};l.prototype.getEntityType=function(e,t){return a.getEntityTypeNameFromEntitySetName(e,t)};l.prototype._updateGroupList=function(e,t,i,a){var n=function(e){return e.PropertyPath===i};var o;if(this._allSelectionFields){o=this._allSelectionFields.filter(n)}o=o&&o.length?true:false;var s=this._filter.getModel().getMetaModel();var l=s.getODataEntityType(e);l=l[r.Label]?l[r.Label].String:l.name;var f=function(e,r){for(var i in r._groupList){var n=r._groupList[i],o=false;if(n.name===e){var l=n.fieldList;for(var f in l){if(l[f].name===a){o=true}else{continue}}if(!o){var u=s.getODataEntityType(t);var p=r._oMetadataAnalyser.getFieldsByEntityTypeName(t);for(var d of p){if(d.name===a){var g=s.getODataProperty(u,d.name);l.push({name:d.name,fieldInfo:d,propInfo:g})}}}}else{continue}}};if(o){f("_BASIC",this)}else{f(l,this)}};l.prototype._createDimensionMap=function(e,t){var r,i=this._filter.getModel(),a=i.getMetaModel(),n,o={},s,l,f,u={};if(!a){return false}n=a.getODataEntityType(t);r=this._oMetadataAnalyser.getFieldsByEntityTypeName(t);if(!this._dimensionMap[e]||!this._measureMap[e]){for(var p in r){var d=r[p];s=a.getODataProperty(n,d.name);if(d["aggregationRole"]==="dimension"){l={name:d.name,fieldInfo:d,propInfo:s};o[d.name]=l}else if(d["aggregationRole"]==="measure"){f={name:d.name,label:d.fieldLabel,fieldInfo:d,propInfo:s};u[d.name]=f}}if(Object.keys(o).length){this._dimensionMap[e]=o}if(Object.keys(u).length){this._measureMap[e]=u}}};l.prototype._createGroupList=function(e,t,r,i){var a;if(r){a=this._filter.getModel("i18n").getResourceBundle().getText("VIS_FILTER_GRP_BASIC_TITLE");this._addToGroupListByName("_BASIC",a,e,t)}else{a=e.groupTitle;this._addToGroupListByName(i,a,e,t)}};l.prototype._addToGroupListByName=function(e,t,r,i){if(this._groupListByName[e]===undefined){this._groupListByName[e]=[];this._groupListByName[e].push({name:e,label:t,fieldList:[]});var a=r.name;if(r.isParameter){a="$Parameter."+a}this._groupListByName[e][0].fieldList.push({name:a,fieldInfo:r,propInfo:i})}else{this._groupListByName[e][0].fieldList.push({name:r.name,fieldInfo:r,propInfo:i})}};l.prototype._setGroupListForDialog=function(){if(Object.keys(this._groupListByName).length){for(var e in this._groupListByName){this._groupList.push(this._groupListByName[e][0])}}var t={};for(var r=0;r<this._groupList.length;r++){var i=this._groupList[r];t[i.name]=i}this._groupMap=t};l.prototype._getScaleFactor=function(e,r){if(!r){return""}if(r.indexOf("com.sap.vocabularies.UI.v1.DataPoint")>-1){r=r.toString();if(r.charAt(0)==="@"){r=r.slice(1)}var i=e[r];if(i&&i.ValueFormat&&i.ValueFormat.ScaleFactor){return t.getPathOrPrimitiveValue(i.ValueFormat.ScaleFactor)}else{return""}}};l.prototype._getNumberOfFractionalDigits=function(e,r){if(!r){return""}if(r.indexOf("com.sap.vocabularies.UI.v1.DataPoint")>-1){r=r.toString();if(r.charAt(0)==="@"){r=r.slice(1)}var i=e[r];if(i&&i.ValueFormat&&i.ValueFormat.NumberOfFractionalDigits){return t.getPathOrPrimitiveValue(i.ValueFormat.NumberOfFractionalDigits)}else{return""}}};l.prototype._getVisualFilterAnnotation=function(e){var t=this._filter.getModel();var i=t.getMetaModel();if(!e||!i){return null}var a=i.getODataEntityType(e);if(!a){return null}this._allSelectionFields=a[r.SelectionFields];var n=this._filter._smartFilterContext.getFilterBarViewMetadata(true),s,l,f,u,p,d,g,h,m,y=[],c,v,_,P;var F=this._filter._smartFilterContext.getAnalyticalParameters();var M=F.length;for(var D=0;D<M;D++){var L=F[D];var S={};S.fields=[];S.fields.push(L);n.unshift(S)}for(var S in n){y=n[S].fields;u=n[S].groupName;for(var I in y){s=y[I].filterable;l=y[I].filterRestriction;m=y[I].hasFixedValues===true;_=y[I].displayBehaviour;if(l==="auto"){l="multiple"}if(l!=="interval"&&s!=="false"){c=y[I];var A=c[r.Hidden]&&c[r.Hidden].Bool==="true"||c[r.HiddenFilter]&&c[r.HiddenFilter].Bool==="true";P=y[I].isParameter;g=y[I].fieldName;f=y[I].isMandatory;p=y[I].requiredFilterField;for(var O in y[I]){if(O.indexOf(r.ValueList)>-1&&y[I][O].PresentationVariantQualifier){if(A){o.warning("The dimension "+g+" is set to UI.Hidden in the collection "+c.groupEntitySet+". Corresponding chart cannot be displayed as VisualFilter.");break}h=u==="_BASIC"||f||p;v=i.getODataProperty(a,g);d=y[I][O];this._createGroupList(c,v,h,u);this._getAnnotationFromValueList(e,h,d,g,l,m,f,_,P)}}}}}this._setGroupListForDialog();this._filterConfig=this._getConfig(this._annotationData)};l.prototype._getAnnotationFromValueList=function(e,r,i,a,n,o,s,l,f){var u=e;if(i!==undefined){var p={Filters:[]},d,g=t.readProperty(i,"PresentationVariantQualifier.String"),h=t.readProperty(i,"SelectionVariantQualifier.String"),m=t.readProperty(i,"CollectionPath"),y=t.readProperty(i,"Parameters"),c=t.readProperty(m,"String"),v=this._filter.getModel(),_=v.getMetaModel(),u=this.getEntityType(c,_),P=_.getODataEntityType(u);if(h){var F=this._oMetadataAnalyser.getSelectionVariantAnnotationList(u);d=this._getFiltersAndParamsFromSV(F,h)}if(g){var M=g,D=this._oMetadataAnalyser.getPresentationVariantAnnotation(u,M),L={},S=t.readProperty(D,"chartAnnotation.annotation.Dimensions.0.PropertyPath");if(S){this._createDimensionMap(m.String,u);this._updateGroupList(e,u,a,S);if(!l){var I=this._oMetadataAnalyser.getTextArrangementValue(e);if(o){l=I?I:sap.ui.comp.smartfilterbar.DisplayBehaviour.descriptionOnly}else{l=I?I:sap.ui.comp.smartfilterbar.DisplayBehaviour.descriptionAndId}}L=this._createConsumeableObjectFromAnnotation(D,m,r,y,a,n,o,s,l,P,d,f);if(L){p.Filters.push(L);this._annotationData.Filters.push(L)}}}}};l.prototype._createSortObject=function(e,t,r,i){var a=t,n=true;if(e==="Line"){a=r;if(!i){n=false}}var o={};o.Field={String:a};o.Descending={Boolean:n};return o};l.prototype._createSortOrderFromAnnotation=function(e,r,i,a,n,o){n.SortOrder=[];var s=e.annotation.SortOrder,l,f;if(s!==undefined&&s.length){for(var u=0;u<s.length;u++){var p=t.readProperty(s,u+".Property.PropertyPath"),d=t.readProperty(s,u+".Descending.Bool");if(p&&d){if(a==="Line"){if(!o){if(p===i){f=i;l=!(d==="false");break}}}else if(p===r){f=r;l=!(d==="false");break}}}if(f){var g={};g.Field={String:f};g.Descending={Boolean:l};n.SortOrder.push(g)}}if(!n.SortOrder.length){n.SortOrder.push(this._createSortObject(a,r,i,o))}return n};l.prototype._getChartQualifier=function(e){var t=e.annotation.Visualizations,r;r=t?t[0].AnnotationPath.substring(1):undefined;return r};l.prototype._IsDimensionDateTime=function(e,i){var a=this.getDimensionMap(),n=t.readProperty(a,e+"."+i+".fieldInfo"),o=false,s;if(n.type==="Edm.DateTime"||n.type==="Edm.Time"){o=true}else{s=n[r.CalendarYear]||n[r.CalendarYearMonth]||n[r.CalendarYearMonthDay]||n[r.CalendarYearWeek]||n[r.CalendarYearQuarter]||n[r.FiscalYear]||n[r.FiscalYearPeriod];if(s&&s.Bool&&s.Bool==="true"){o=true}}return o};l.prototype._IsDimensionDateTimeOffset=function(e,r){var i=this.getDimensionMap(),a=t.readProperty(i,e+"."+r+".fieldInfo"),n=false;if(a.type==="Edm.DateTimeOffset"){n=true}return n};l.prototype._isDimensionDateFilterStringType=function(e,i){var a=this.getDimensionMap(),n=a&&t.readProperty(a,e+"."+i+".fieldInfo"),o="";if(n&&n.type==="Edm.String"){var s=n&&n[r.CalendarYearMonthDay];if(s&&s.Bool&&s.Bool==="true"){o="yearmonthday";return o}s=n&&n[r.CalendarYearMonth];if(s&&s.Bool&&s.Bool==="true"){o="yearmonth";return o}s=n&&n[r.CalendarYearWeek];if(s&&s.Bool&&s.Bool==="true"){o="yearweek";return o}s=n&&n[r.CalendarYearQuarter];if(s&&s.Bool&&s.Bool==="true"){o="yearquarter";return o}s=n&&n[r.CalendarYear]||n[r.FiscalYear];if(s&&s.Bool&&s.Bool==="true"){o="year";return o}s=n&&n[r.FiscalYearPeriod];if(s&&s.Bool&&s.Bool==="true"){o="fiscalyearperiod";return o}}return o};l.prototype._createConsumeableObjectFromAnnotation=function(e,i,n,s,l,f,u,p,d,g,h,m){var y={},c=a.getEntitySetNameFromEntityTypeName(this.getEntityType(i.String,this._metaModel),this._metaModel),v=e.chartAnnotation.annotation.ChartType.EnumMember.split("/"),_=v[v.length-1],P,F,M=false;if(_){y.Type={String:_}}var D=t.readProperty(e,"chartAnnotation.annotation.Dimensions.0.PropertyPath");var L=t.readProperty(e,"chartAnnotation.annotation.Measures.0.PropertyPath");var S=this._isValidDimensionandMeasure(c,D,L);if(!S){return S}P=this._IsDimensionDateTime(c,D);if(P){F=this._isDimensionDateFilterStringType(c,D);y.stringdate=F}else{M=this._IsDimensionDateTimeOffset(c,D)}y.dimensionFieldIsDateTime=P;y.dimensionFieldIsDateTimeOffset=M;y=this._createSortOrderFromAnnotation(e,L,D,_,y,P);var I="";if(e.chartAnnotation.measureAttributes[L]){I=e.chartAnnotation.measureAttributes[L].dataPoint}var A=this._getScaleFactor(g,I);var O=this._getNumberOfFractionalDigits(g,I);var T=this._getChartQualifier(e);y.scaleFactor={String:A};y.numberOfFractionalDigits={String:O};y.chartQualifier=T;if(f){y.filterRestriction={String:f}}else{y.filterRestriction={String:undefined}}y.isDropDown=u;y.Dimensions=[];var B={};B.Field={String:D};y.Dimensions.push(B);y.Measures=[];var b={};b.Field={String:L};y.Measures.push(b);if(n){y.Selected={Boolean:"true"}}else{y.Selected={Boolean:"false"}}if(i){y.CollectionPath=i}if(s&&s.length){y.InParameters=[];for(var V in s){var C=s[V]?s[V]:undefined,E=C&&C.RecordType?C.RecordType:undefined,N=C.ValueListProperty&&C.ValueListProperty.String?C.ValueListProperty.String:undefined,R=C.LocalDataProperty&&C.LocalDataProperty.PropertyPath?C.LocalDataProperty.PropertyPath:undefined;if(C&&E&&N&&R){if(y.OutParameter===undefined&&(E===r.ValueListParameterOut||E===r.ValueListParameterInOut)&&N===D&&R===l){y.OutParameter=R}if(R!==l&&(E===r.ValueListParameterIn||E===r.ValueListParameterInOut)){var w=this._metaModel,G=this.getEntityType(i.String,w),k=w.getODataEntityType(G),H=w.getODataEntitySet(c),Y=w.getODataProperty(k,N);var U=t.isPropertyNonFilterable(H,Y.name);if(U){o.error("IN Parameter valueListProperty: "+N+" is non filterable")}else{if(!t.isPropertyHidden(Y)){y.InParameters.push({localDataProperty:R,valueListProperty:N})}}}}}}if(l){y.ParentProperty=l}if(!m){this._addAllFiltersAsInParameters(c,y)}else{y.isParameter=m}y.isMandatoryProperty=p;y.displayBehaviour=d;if(h){y.selectionVariant=h}return y};l.prototype._getConfig=function(e){var t={filterList:[]};if(!e){return t}var r={};var i={};var a=e.Filters;for(var n=0;n<a.length;n++){var s=a[n];var l=s.ParentProperty;var f=s.Dimensions[0].Field.String;var u=s.CollectionPath.String;var p=this._dimensionMap[u][f];if(!p){o.error("Unknown Dimension :"+f);continue}var d=s.Measures[0].Field.String;var g=this._measureMap[u][d];if(!g){o.error("Unknown Measure :"+d);continue}var h=p.fieldInfo.description;if(!h){h=f}if(!r[f]){r[f]=[]}if(!i[l]){i[l]=[]}var m={type:s.Type.String,selected:s.Selected.Boolean=="true",dimension:{field:f,fieldDisplay:h},measure:{field:s.Measures[0].Field.String},sortOrder:s.SortOrder,scaleFactor:s.scaleFactor.String,numberOfFractionalDigits:s.numberOfFractionalDigits.String,chartQualifier:s.chartQualifier,dimensionFieldIsDateTime:s.dimensionFieldIsDateTime,dimensionFieldIsDateTimeOffset:s.dimensionFieldIsDateTimeOffset,stringdate:s.stringdate,selectionVariant:s.selectionVariant};m.collectionPath=s.CollectionPath.String;m.outParameter=s.OutParameter;m.inParameters=s.InParameters;m.parentProperty=s.ParentProperty;m.filterRestriction=s.filterRestriction.String;m.isMandatory=s.isMandatoryProperty;m.isDropDown=s.isDropDown;m.displayBehaviour=s.displayBehaviour;m.isParameter=s.isParameter;i[l].push(m);r[f].push(m)}var y={};for(var n=0;n<this._groupList.length;n++){var c=this._groupList[n];for(var v=0;v<c.fieldList.length;v++){var _=c.fieldList[v];var a=i[_.name];if(!a){continue}y[c.name]=true;for(var P=0;P<a.length;P++){t.filterList.push(a[P])}}}for(var n=this._groupList.length-1;n>=0;n--){var c=this._groupList[n];if(y[c.name]){continue}this._groupList.splice(n,1);delete this._groupMap[c.name]}return t};l.prototype._isValidDimensionandMeasure=function(e,i,a){if(!(i&&a)){return false}var n=this.getDimensionMap(),s=t.readProperty(n,e+"."+i+".fieldInfo","","VisualFilter");var l=this.getMeasureMap(),f=t.readProperty(l,e+"."+a+".fieldInfo","","VisualFilter"),u=l[e],p=0;if(!(s&&f)){o.error("The dimension "+i+" or the measure "+a+" or both are either NOT given in the chart, or IS given but undefined in metadata. Corresponding chart cannot be displayed as VisualFilter.");return false}for(var d in u){var g=u[d].fieldInfo;if(g[r.Hidden]&&g[r.Hidden].Bool==="true"){o.warning("The measure "+g.name+" is set to UI.Hidden in the collection "+e+". Chart configured with this measure cannot be rendered.");p++}}var h=s[r.Hidden]&&s[r.Hidden].Bool==="true";if(s&&h){o.warning("The dimension "+i+" is set to UI.Hidden in the collection "+e+". Corresponding chart cannot be displayed as VisualFilter.");return false}if(!(s["aggregationRole"]==="dimension"&&f["aggregationRole"]==="measure")){o.error("The dimension "+i+" or the measure "+a+" or both have NO 'sap:aggregation-role' defined in metadata. Corresponding chart cannot be displayed as VisualFilter.");return false}if(Object.keys(u).length===p){o.warning("All the measures in the collection "+e+" are set to UI.Hidden. Corresponding chart cannot be displayed as VisualFilter.");return false}return true};l.prototype._getFiltersAndParamsFromSV=function(e,t){for(var r in e){if(e[r].qualifier===t){return e[r].annotation}}};l.prototype._addAllFiltersAsInParameters=function(e,r){if(!this._filter.getAllFiltersAsInParameters()){return}var i=this.getDimensionMap(),a=this._filter.getEntitySet(),n=this.getEntityType(a,this._metaModel),o=r.InParameters||[],s=r.ParentProperty;if(a!==e){this._createDimensionMap(a,n)}if(Object.keys(i).length){i=i[a]}if(a!==e){var l=this._filter.getModel().getMetaModel(),f=l.getODataEntitySet(e),u=l.getODataEntityType(f.entityType),p,d,g,h,m,y,c;for(var p in i){if(i.hasOwnProperty(p)){h=s===p;d=l.getODataProperty(u,p);m=y=c=true;if(d){m=t.isPropertyNonFilterable(f,d.name);y=t.isPropertyHidden(d)}c=t.isAlreadyInParameter(o,p);g=!h&&!c&&!m&&!y;if(g){o.push({localDataProperty:p,valueListProperty:p})}}}}else{for(var p in i){if(i.hasOwnProperty(p)){var c=t.isAlreadyInParameter(o,p);if(!c&&s!==p){o.push({localDataProperty:p,valueListProperty:p})}}}}r.InParameters=o};return l},true);
//# sourceMappingURL=VisualFilterProvider.js.map