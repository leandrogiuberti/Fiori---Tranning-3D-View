sap.ui.define(["sap/ui/core/mvc/Controller","sap/fe/navigation/SelectionVariant","sap/m/MessageBox","sap/ui/model/analytics/odata4analytics"],function(t,e,a,i){"use strict";var n,r,o,s;var l=t.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.KpiCard",{onInit:function(t){sap.ui.require(["sap/ovp/cards/CommonUtils"],function(t){o=t})},onExit:function(){},onBeforeRendering:function(){var t=this.getView();var e=t.data("qualifierSettings");var a=e.qualifier;var i=t.getModel();var n=i.getMetaModel();var r=n.getODataEntitySet(e.entitySet);var l=n.getODataEntityType(r.entityType);var c=t.data("mergedSelectionVariant");var g=t.data("kpiAnnotationPath");var d=t.data("selectionPresentationVariantPath");var v=t.data("dataPointPath");var h=t.data("searchQuery");var f="kpiCard"+a;var p={cards:{}};p["cards"][f]={model:e.model,template:"sap.ovp.cards.charts.analytical",settings:{title:t.data("kpiTitle"),entitySet:e.entitySet,showFilterInHeader:true,navigation:"chartNav",bEnableStableColors:e.enableStableColors,colorPalette:e.colorPalette}};if(h){p["cards"][f]["settings"]["searchQuery"]=h}var S=s.getOwnerComponent();var u=S&&S.getChartSettings()&&S.getChartSettings().showDataLabel;p["cards"][f]["settings"].showDataLabel=u;if(l[v]&&l[v].hasOwnProperty("Description")){p["cards"][f]["settings"].subTitle=l[v]["Description"].String}if(g){p["cards"][f].settings.kpiAnnotationPath=g;o.createCardComponent(t,p,"template::ALPcardContainer",c)}else{p["cards"][f].settings.dataPointAnnotationPath=v;p["cards"][f].settings.selectionPresentationAnnotationPath=d;var m=function(){var e=t.getModel("detailNavigation");if(e){var a=e.getProperty("/target");var i=e.getProperty("/action");if(a&&i){return true}}return false};o.createCardComponent(t,p,"template::ALPcardContainer",c,m)}o.onHeaderClicked=function(e){this.handleNavigationPress(t)}.bind(this);o.onContentClicked=function(e){var a=e.getObject();this.handleNavigationPress(t,a)}.bind(this)},handleNavigationPress:function(t,i){var o=t.getModel("detailNavigation");if(o){var l=o.getProperty("/target");var c=o.getProperty("/action");var g=t.getParent();g.setModal(true);if(l&&c){var d={semanticObject:l,action:c};this._oSelectionVariant=new e;var v=JSON.parse(o.getProperty("/parameters"));this._createNavigationContext(v,true);this._getSelectOptionsFromAnnotation(t);if(i){this._createNavigationContext(i)}s.adaptNavigationParameterExtension(this._oSelectionVariant,d);this._constructContextURL();if(this._sParameterContextURL){this._oSelectionVariant.setParameterContextUrl(this._sParameterContextURL)}if(this._sFilterContextURL){this._oSelectionVariant.setFilterContextUrl(this._sFilterContextURL)}n.setModel(this.getView().getModel());this._oSelectionVariant=this._oSelectionVariant.toJSONString();n.navigate(l,c,this._oSelectionVariant,null,function(t){if(t instanceof sap.fe.navigation.NavError){if(t.getErrorCode()==="NavigationHandler.isIntentSupported.notSupported"){a.show(r.getText("ST_NAV_ERROR_NOT_AUTHORIZED_DESC"),{title:r.getText("ST_GENERIC_ERROR_TITLE"),onClose:function(){g.setModal(false)}})}else{a.show(t.getErrorCode(),{title:r.getText("ST_GENERIC_ERROR_TITLE"),onClose:function(){g.setModal(false)}})}}})}}},_assignSmartTemplateDependencies:function(t,e){r=t.oCommonUtils;s=e;n=t.oServices.oApplication.getNavigationHandler()},_createNavigationContext:function(t,e){var a=Object.keys(t);for(var i=0;i<a.length;i++){var n=a[i];if(!t[n]&&t[n]!==""){return}if(e){this._oSelectionVariant.addParameter(n,t[n])}else{if(this._oSelectionVariant.getSelectOption(n)){this._oSelectionVariant.removeSelectOption(n)}this._oSelectionVariant.addSelectOption(n,"I","EQ",t[n])}}},_getSelectOptionsFromAnnotation:function(t){var e=this;var a=t.data("qualifierSettings").filterable;if(a){var i=t.data("mergedSelectionVariant");var n=this._oSelectionVariant.getParameterNames();if(n){for(var r=0;r<n.length;r++){if(!i.getParameter(n[r])){i.addParameter(n[r],this._oSelectionVariant.getParameter(n[r]))}}}this._oSelectionVariant=i;return}var o=t.data("selectionVariant");var s=o.SelectOptions;var l=o.Parameters;if(l&&l.length){l.forEach(function(t){var a=t.PropertyName.PropertyPath;var i=t.PropertyValue.String;if(e._oSelectionVariant.getParameter(a)){e._oSelectionVariant.removeParameter(a)}e._oSelectionVariant.addParameter(a,i)})}if(s&&s.length){s.forEach(function(t){var a=t.PropertyName.PropertyPath;var i=t.Ranges;i.forEach(function(t){var i=t.Low.String;var n=t.High&&t.High.String?t.High.String:null;var r=t.Sign.EnumMember.split("/")[1];var o=t.Option.EnumMember.split("/")[1];e._oSelectionVariant.addSelectOption(a,r,o,i,n)})})}},_constructContextURL:function(){if(this._sFilterContextURL||this._sParameterContextURL){return}var t=this.getView();var e=t.data("qualifierSettings");var a=t.getModel();var r=a.getMetaModel();var o=r.getODataEntitySet(e.entitySet);var s=new i.Model(i.Model.ReferenceByModel(a));var l=s.findQueryResultByName(o.name);var c=l&&l.getParameterization();if(c){this._sParameterContextURL=n.constructContextUrl(c.getEntitySet().getQName(),a)}this._sFilterContextURL=n.constructContextUrl(o.name,a)}});return l});
//# sourceMappingURL=KpiCard.controller.js.map