sap.ui.define(["sap/ui/base/Object","sap/ui/core/mvc/ControllerExtension","sap/fe/navigation/NavError","sap/suite/ui/generic/template/listTemplates/listUtils","sap/fe/navigation/SelectionVariant","sap/ui/comp/state/UIState","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/deepEqual","sap/base/util/extend","sap/base/util/isEmptyObject","sap/suite/ui/generic/template/genericUtilities/FeError","sap/ui/Device","sap/suite/ui/generic/template/listTemplates/semanticDateRangeTypeHelper","sap/suite/ui/generic/template/ListReport/controller/LegacyStateHandler","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/js/StableIdHelper","sap/suite/ui/generic/template/genericUtilities/utils"],function(e,t,a,n,r,i,o,s,l,c,p,u,f,d,m,g,S){"use strict";var v="ListReport.controller.IappStateHandler";var y=new o(v);var b=y.getLogger();var D=y.Level;var h="sap.suite.ui.generic.template.customData",V="sap.suite.ui.generic.template.extensionData",C="sap.suite.ui.generic.template.genericData";var O=["save-appvar-id"];function P(e,t){if(sap.ui.support){var a=b.getLevel();if(a<D.INFO){b.setLevel(D.INFO)}}var n;if(typeof t==="string"){n=t}else{n="";var r="";for(var i in t){n=n+r+i+": "+t[i];r="; "}}b.info(e,n,"sap.suite.ui.generic.template.ListReport.controller.IappStateHandler")}function E(e,a,o){var m=new d(a);var y;var D=new Promise(function(e){y=e});var E;var w=new Promise(function(e){E=e});var F=[];var N=[];var I=a.byId(g.getStableId({type:"ListReportTable",subType:"SmartTable"}));if(I){F.push(o.oCommonUtils.getControlStateWrapper(I))}var M=a.byId(g.getStableId({type:"ListReportAction",subType:"SearchField"}));if(M){F.push(o.oCommonUtils.getControlStateWrapper(M))}var x=e.oMultipleViewsHandler.getGeneralContentStateWrapper();if(x){x.getLocalId=function(){return"$multipleViewsGeneralContent"};F.push(x)}if(a.getOwnerComponent().getSmartVariantManagement()&&!a.getOwnerComponent().getVariantManagementHidden()){N=F;F=[]}var A=e.oMultipleViewsHandler.getSFBVariantContentStateWrapper();if(A){A.getLocalId=function(){return"$multipleViewsSFBVariantContent"};N.push(A)}var L=[];function U(){L.forEach(function(e){e()})}var T={getLocalId:function(){return"$customFilters"},getState:function(){var e={appExtension:Object.create(null),adaptationExtensions:Object.create(null)};if(o.oComponentUtils.isDraftEnabled()){var n=o.oComponentUtils.getTemplatePrivateModel();e.editState=n.getProperty("/listReport/vDraftState")}a.getCustomAppStateDataExtension(e.appExtension);var r=true;var i=function(a,n){if(!(a instanceof t)){throw new p(v,"State must always be set with respect to a ControllerExtension")}if(!r){throw new p(v,"State must always be provided synchronously")}e.adaptationExtensions[a.getMetadata().getNamespace()]=n};a.templateBaseExtension.provideExtensionAppStateData(i);r=false;return e},setState:function(e){if(o.oComponentUtils.isDraftEnabled()){var n=o.oComponentUtils.getTemplatePrivateModel();n.setProperty("/listReport/vDraftState",e.editState)}a.restoreCustomAppStateDataExtension(e.appExtension);var r=true;var i=function(a){if(!(a instanceof t)){throw new p(v,"State must always be retrieved with respect to a ControllerExtension")}if(!r){throw new p(v,"State must always be restored synchronously")}return e.adaptationExtensions[a.getMetadata().getNamespace()]};a.templateBaseExtension.restoreExtensionAppStateData(i);r=false},attachStateChanged:function(e){if(a.byId("editStateFilter")){a.byId("editStateFilter").attachChange(e)}L.push(e)}};var H=o.oCommonUtils.getControlStateWrapper(e.oSmartFilterbar,{oCustomFiltersWrapper:T});var W=a.byId(g.getStableId({type:"ListReportPage",subType:"DynamicPage"}));var k=o.oCommonUtils.getControlStateWrapper(W);F.push(k);var J=e.oSmartFilterbar.getSmartVariant();if(J){var R=o.oCommonUtils.getControlStateWrapper(J,{managedControlWrappers:N.concat([H]),dynamicPageWrapper:k});F.push(R)}else{F.push(H)}function j(){var t=o.oComponentUtils.getTemplatePrivateModel();function a(e){t.setProperty("/generic/bDataAreShownInTable",e)}function n(){return t.getProperty("/generic/bDataAreShownInTable")}function r(e,t){if(e===n()){return}a(e);t()}return{getLocalId:function(){return"$dataLoaded"},setState:a,getState:n,attachStateChanged:function(t){e.oSmartFilterbar.attachSearch(r.bind(null,true,t));e.oSmartFilterbar.attachFilterChange(r.bind(null,false,t))}}}var _=j();F.push(_);F.forEach(function(e){e.attachStateChanged(ne)});var B=o.oServices.oApplication.getNavigationHandler();var Q=a.getOwnerComponent().getSmartVariantManagement();var K=o.oComponentUtils.getSettings();if(!o.oComponentUtils.isStateHandlingSuspended()){e.oSmartFilterbar.setSuppressSelection(true)}var $=true;function z(e){_.setState(e)}function G(){var e=o.oComponentUtils.getTemplatePrivateModel();return e.getProperty("/generic/bDataAreShownInTable")}function q(){e.oSmartFilterbar.search()}function X(){var e={},t=o.oComponentUtils.getUI5VersionInfo();F.forEach(function(t){if(t.getLocalId()){e[t.getLocalId()]=t.getState()}});return{version:t.version,controlStates:e}}function Y(e){if(o.oComponentUtils.isDraftEnabled()){var t=e["IsActiveEntity"];if(t&&t[0]){var a=o.oComponentUtils.getTemplatePrivateModel();a.setProperty("/listReport/vDraftState",t[0])}}}function Z(e){if(Q){var t=e["sap-ui-fe-variant-id"];if(t&&t[0]){J.setCurrentVariantId(t[0])}}else{var a=e["sap-ui-fe-variant-id"],n=e["sap-ui-fe-filterbar-variant-id"],r=e["sap-ui-fe-chart-variant-id"],i=e["sap-ui-fe-table-variant-id"];ee(n&&n[0],r&&r[0],i&&i[0],a&&a[0])}}function ee(t,a,n,r){if(t||r){J.setCurrentVariantId(t||r)}if(n||r){e.oPresentationControlHandler.setCurrentVariantId(n||r);e.oMultipleViewsHandler.setControlVariant(a,n)}}function te(e){a.restoreCustomAppStateDataExtension(e||{})}function ae(){if(!e.oSmartFilterbar.checkSearchAllowed()){return}e.refreshModel();if(u.system.phone){ye()}_.setState(true);ne()}function ne(){P("changeIappState called",{bDataAreShownInTable:G()});if(e.oSmartFilterbar.isDialogOpen()||$){return}o.oComponentUtils.stateChanged()}function re(t){var a=e.oSmartFilterbar.determineMandatoryFilterItems(),n;for(var r=0;r<a.length;r++){if(a[r].getName().indexOf("P_DisplayCurrency")!==-1){if(t.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&t.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0]&&t.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){n=t.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low;if(n){t.oSelectionVariant.addParameter("P_DisplayCurrency",n)}}break}}}function ie(t){var a=typeof t==="string"?JSON.parse(t):t;var n=a&&a.SortOrder;e.oPresentationControlHandler.applyNavigationSortOrder(n)}function oe(t){de(t.controlStates);if(G()){q()}else{o.oComponentUtils.hidePlaceholder()}if(!e.oSmartFilterbar.checkSearchAllowed()){o.oComponentUtils.hidePlaceholder()}}function se(t,n,r){Z(n);Y(n);if(t.presentationVariant!==undefined){ie(t.presentationVariant)}if(t.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1&&t.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1&&t.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1){re(t)}var i={viaExternalNavigation:true,selectionVariant:t.oSelectionVariant,urlParameters:n,selectedQuickVariantSelectionKey:r,semanticDates:(typeof t.semanticDates==="string"?JSON.parse(t.semanticDates):t.semanticDates)||{}};if(!e.oWorklistData.bWorkListEnabled){a.modifyStartupExtension(i);if(e.oSmartFilterbar.isCurrentVariantStandard()){i.semanticDates=f.addSemanticDateRangeDefaultValue(K,e.oSmartFilterbar,i.semanticDates,i.urlParameters||{},i.selectionVariant,true);i.semanticDates.Dates.forEach(function(e){i.selectionVariant.addSelectOption(e.PropertyName,"I","EQ","")})}Oe(i.selectionVariant,t.selectionVariant||"",true,i.semanticDates,false)}te();e.oMultipleViewsHandler.handleStartUpObject(i);Ee(e.oSmartFilterbar.isCurrentVariantStandard())}function le(t,n){Z(t);var i={viaExternalNavigation:false,selectionVariant:"",urlParameters:t,selectedQuickVariantSelectionKey:n,semanticDates:{}};var o=e.oSmartFilterbar.getUiState();var l=new r(JSON.stringify(o.getSelectionVariant()));De(l);var c=JSON.parse(JSON.stringify(l));var p=o.getSemanticDates();i.selectionVariant=l;i.semanticDates=p;a.modifyStartupExtension(i);if(!(s(JSON.parse(JSON.stringify(i.selectionVariant)),c)&&s(i.semanticDates,p))){Oe(i.selectionVariant,"",true,i.semanticDates,true)}te();e.oMultipleViewsHandler.handleStartUpObject(i);if(!e.oWorklistData.bWorkListEnabled&&!e.oSmartFilterbar.getLiveMode()&&e.oSmartFilterbar.isCurrentVariantStandard()){i.semanticDates=f.addSemanticDateRangeDefaultValue(K,e.oSmartFilterbar,i.semanticDates||{},i.urlParameters,i.selectionVariant);i.semanticDates.Dates.forEach(function(e){i.selectionVariant.addSelectOption(e.PropertyName,"I","EQ","")})}Ee();J&&J.currentVariantSetModified(false)}function ce(e,t){return s(e.map(JSON.stringify).sort(),t.map(JSON.stringify).sort())}function pe(e,t){var a={};e.forEach(function(e){a[e.PropertyName]=e});t.forEach(function(e){a[e.PropertyName]=e});return Object.values(a)}function ue(t,i,o){Z(i);var l=e.oSmartFilterbar.getUiState();var c=l.getSemanticDates();var p={viaExternalNavigation:false,selectionVariant:t.oSelectionVariant,urlParameters:i,selectedQuickVariantSelectionKey:o,semanticDates:(typeof t.semanticDates==="string"?JSON.parse(t.semanticDates):t.semanticDates)||{}};if(t.presentationVariant!==undefined){ie(t.presentationVariant)}var u=new r(JSON.stringify(l.getSelectionVariant()));De(u);var d=JSON.parse(JSON.stringify(u));if(t.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1&&t.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1&&t.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1){re(t)}if(!e.oWorklistData.bWorkListEnabled){if(e.oSmartFilterbar.isCurrentVariantStandard()){a.modifyStartupExtension(p);p.semanticDates=f.addSemanticDateRangeDefaultValue(K,e.oSmartFilterbar,p.semanticDates,p.urlParameters,p.selectionVariant);var m=s(p.semanticDates,c);if(c&&c.Dates){p.semanticDates.Dates=pe(c.Dates,p.semanticDates.Dates)}p.semanticDates.Dates.forEach(function(e){var t=p.selectionVariant.getSelectOption(e.PropertyName);var a=u.getSelectOption(e.PropertyName);if(t&&t.length!=0){return}if(a&&a.length!=0){p.selectionVariant.massAddSelectOption(e.PropertyName,a);return}p.selectionVariant.addSelectOption(e.PropertyName,"I","EQ","")});var g=e.oSmartFilterbar.getAllFilterItems().map(function(e){return e.getName()});var S=function(e){return g.includes(e.PropertyName)};var v=e.oSmartFilterbar.getAnalyticalParameters().map(function(e){return e.name});var y=function(e){return v.includes(e.PropertyName)};var b=n.getMergedVariants([u,p.selectionVariant]);var D=b.toJSONObject();var h=u.toJSONObject();if(!ce(h.SelectOptions.filter(S),D.SelectOptions.filter(S))||!ce(h.Parameters.filter(y),D.Parameters.filter(y))||!m){Oe(b,t.selectionVariant,true,p.semanticDates,false);J.currentVariantSetModified(true)}}else{p.selectionVariant=u;p.semanticDates=c;a.modifyStartupExtension(p);if(!(s(JSON.parse(JSON.stringify(p.selectionVariant)),d)&&s(p.semanticDates,c))){Oe(p.selectionVariant,t.selectionVariant,true,p.semanticDates,false)}}}te();e.oMultipleViewsHandler.handleStartUpObject(p);Ee()}function fe(t,n,r){P("fnAdaptToAppState called",{sNavType:r});e.oSmartFilterbar.setSuppressSelection(false);$=false;if(r===sap.fe.navigation.NavType.hybrid){t=t.iAppState;t.controlStates=t.data.permanentEntries.permanentState.data.controlStates;oe(t);return}if(r===sap.fe.navigation.NavType.iAppState){oe(t);return}var i=o.oComponentUtils.getSelectionInfo();var s=i&&i.pageEntitySet;var l=e.oMultipleViewsHandler.getPreferredKey(s);switch(r){case sap.fe.navigation.NavType.initial:le(n,l);break;case sap.fe.navigation.NavType.xAppState:case sap.fe.navigation.NavType.URLParams:if(t.bNavSelVarHasDefaultsOnly||t.oSelectionVariant.getSelectOptionsPropertyNames().length&&S.isASubsetOfB(t.oSelectionVariant.getSelectOptionsPropertyNames(),O)){ue(t,n,l)}else{se(t,n,l)}break;default:throw new p(v,"Invalid navigation type: "+r)}if(G()){e.oSmartFilterbar.search();if(u.system.desktop){o.oCommonUtils.getControlStateWrapper(a.byId(g.getStableId({type:"ListReportPage",subType:"DynamicPage"}))).setHeaderState(a,true)}else{ye()}}if(!G()||Object.keys(e.oSmartFilterbar.verifySearchAllowed()).length>0){o.oComponentUtils.hidePlaceholder()}ne()}function de(e){F.forEach(function(t){t.setState(e[t.getLocalId()])})}function me(e){if(!e){return D.then(function(){var e=ge();e.then(E);return e})}var t;if(c(e)){t=sap.fe.navigation.NavType.initial}else{t=sap.fe.navigation.NavType.iAppState;e=m.getStateInCurrentFormat(e)}var a=l({oDefaultedSelectionVariant:new r,oSelectionVariant:new r(e&&e.selectionVariant)},e);D.then(function(){fe(a,{},t);E()});return D}function ge(){var e=new Promise(function(e){try{var t=B.parseNavigation();t.done(function(t,a,n){if(n!==sap.fe.navigation.NavType.iAppState){fe(t,a,n)}e()});t.fail(function(t,a,n){b.warning(t.getErrorCode()+"app state could not be parsed - continuing with empty state");fe({},a,sap.fe.navigation.NavType.initial);e()})}catch(t){fe({},{},sap.fe.navigation.NavType.initial);e()}});return e}function Se(t){if(e.oWorklistData.bWorkListEnabled&&t.getParameter("context")!=="SET_VM_ID"){q()}}function ve(e){if(sap.ui.getCore().getMessageManager().getMessageModel().oData.length){var t=[];for(var a in sap.ui.getCore().getMessageManager().getMessageModel().oData){var n=sap.ui.getCore().getMessageManager().getMessageModel().oData[a];if(n.persistent&&e.getParameters().context===undefined){t.push(n)}}sap.ui.getCore().getMessageManager().removeMessages(t)}Se(e)}function ye(){var e=a.getOwnerComponent().getModel("_templPriv");e.setProperty("/listReport/isHeaderExpanded",false)}function be(t,a,n,r){var o=new i({selectionVariant:t,semanticDates:r});e.oSmartFilterbar.setUiState(o,{replace:a,strictMode:n})}function De(e){[V,h,C].forEach(e.removeSelectOption.bind(e))}function he(t,a,n){if(t&&(a!==""||n)){var r=t.getParameterNames().concat(t.getSelectOptionsPropertyNames());for(var i=0;i<r.length;i++){e.oSmartFilterbar.addFieldToAdvancedArea(r[i])}}}function Ve(e,t,a){if(e.getParameter(t)&&!e.getParameter(a)){e.addParameter(a,e.getParameter(t))}if(e.getSelectOption(t)&&!e.getSelectOption(a)){var n=e.getSelectOption(t);n.forEach(function(t){e.addSelectOption(a,t.Sign,t.Option,t.Low,t.High)})}}function Ce(e){var t=a.getOwnerComponent().getModel().getMetaModel();var n=a.getOwnerComponent().getEntitySet();var r=t.getODataEntityType(t.getODataEntitySet(n).entityType);r.property.forEach(function(t){if(t["com.sap.vocabularies.Common.v1.EditableFieldFor"]){var a=t["com.sap.vocabularies.Common.v1.EditableFieldFor"].PropertyPath||t["com.sap.vocabularies.Common.v1.EditableFieldFor"].String;var n=t.name;Ve(e,a,n);Ve(e,n,a)}})}function Oe(t,a,n,r,i){Ce(t);if(n){e.oSmartFilterbar.clearVariantSelection()}he(t,a,i);be(t.toJSONObject(),n,false,r)}function Pe(){var t={loadDataOnAppLaunch:"ifAnyFilterExist"};var n=e.oMultipleViewsHandler.getOriginalEnableAutoBinding();if(n!==undefined&&n!==null){t.loadDataOnAppLaunch=n?"always":"never"}var r=a.getOwnerComponent().getDataLoadSettings();if(r&&r.loadDataOnAppLaunch===""){r.loadDataOnAppLaunch=undefined}return l(t,r)}function Ee(t){var n=e.oSmartFilterbar;var r=e.oWorklistData.bWorkListEnabled||n.getLiveMode()||e.bLoadListAndFirstEntryOnStartup;var i=Pe().loadDataOnAppLaunch;if(!J||a.getOwnerComponent().getVariantManagementHidden()){r=r||i==="always";r=r||i==="ifAnyFilterExist"&&n.getFiltersWithValues().length>0}else{var o=(r||i!=="never")&&n.checkSearchAllowed();J&&J.setExecuteOnStandard(o);if(e.oSmartFilterbar.isCurrentVariantStandard()){var s=J.getExecuteOnStandard();if(o!==s){r=s}else{r=r||i==="always";r=r||i==="ifAnyFilterExist"&&e.oSmartFilterbar.getFiltersWithValues().length>0}}else{r=r||e.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled()}}r=r||t;r=r&&n.checkSearchAllowed();_.setState(!!r)}function we(){return w}return{areDataShownInTable:G,setDataShownInTable:z,onSearchPressed:ae,customAppStateChange:U,changeIappState:ne,onSmartFilterBarInitialized:y,onAfterSFBVariantLoad:ve,applyState:me,getCurrentAppState:X,setFiltersUsingUIState:be,onFEStartupInitialized:we}}return e.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(e,t,a){l(this,E(e,t,a))}})});
//# sourceMappingURL=IappStateHandler.js.map