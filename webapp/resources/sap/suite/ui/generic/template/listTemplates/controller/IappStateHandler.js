sap.ui.define(["sap/ui/base/Object","sap/fe/navigation/SelectionVariant","sap/ui/Device","sap/ui/comp/state/UIState","sap/suite/ui/generic/template/listTemplates/listUtils","sap/ui/core/mvc/ControllerExtension","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/deepEqual","sap/base/util/extend","sap/base/util/deepExtend","sap/suite/ui/generic/template/genericUtilities/FeError","sap/suite/ui/generic/template/listTemplates/semanticDateRangeTypeHelper"],function(t,e,a,r,i,n,o,l,s,c,p,u){"use strict";var f="listTemplates.controller.IappStateHandler";var S=new o(f).getLogger();function d(t,o,d){var m=d.oServices.oApplication.getNavigationHandler();var g="sap.suite.ui.generic.template.customData";var v="sap.suite.ui.generic.template.genericData";var y="sap.suite.ui.generic.template.extensionData";var b="visual";var V="compact";var C;var h=false,F=false,D=null,P;var I=null;var O=d.oComponentUtils.getSettings();var w=null;var A={appStateKey:"",urlParams:{}};var N={};var T="sap-iapp-state";if(!t.oSmartFilterbar.isLiveMode()){t.oSmartFilterbar.setSuppressSelection(true)}var U=o.byId("template::Page");var M=d.oCommonUtils.getControlStateWrapper(U);M.attachStateChanged(function(){nt()});var _,E;E=t.oSmartChart&&d.oCommonUtils.getControlStateWrapper(t.oSmartChart);_=t.oSmartTable&&d.oCommonUtils.getControlStateWrapper(t.oSmartTable);if(t?.oSmartTable?.getTableType()==="ResponsiveTable"){_?.attachStateChanged(function(){setTimeout(function(){nt()},0)})}function x(){return C.then(function(){if(A.appStateKey){return{"sap-iapp-state":[A.appStateKey]}}return A.urlParams})}function B(e){if(e&&e.editStateFilter!==undefined){var r=o.byId("editStateFilter");if(r){r.setSelectedKey(e.editStateFilter===null?0:e.editStateFilter)}}var i=t.oController.getOwnerComponent().getModel("_templPriv");if(e.chartVariantId&&t.oSmartChart){t.oSmartChart.setCurrentVariantId(e.chartVariantId)}if(e.filterMode){i.setProperty("/alp/filterMode",e.filterMode);t.filterBarController.handleFilterSwitch(e.filterMode)}else{R()}if(e.contentView){var n=i.getProperty("/alp/enableHybridMode");if(n===false&&e.contentView==="charttable"){i.setProperty("/alp/contentView","chart")}else{(a.system.phone||a.system.tablet&&!a.system.desktop)&&e.contentView==="charttable"?i.setProperty("/alp/contentView","chart"):i.setProperty("/alp/contentView",e.contentView)}}if(e.autoHide){i.setProperty("/alp/autoHide",e.autoHide)}}function H(t){if(!t){return}var e=true;var a=function(a){if(!(a instanceof n)){throw new p(f,"State must always be retrieved with respect to a ControllerExtension")}var r=a.getMetadata().getNamespace();if(!e){throw new p(f,"State must always be restored synchronously")}return t[r]};o.templateBaseExtension.restoreExtensionAppStateData(a);e=false}function L(t){t=t||{};if(t.hasOwnProperty(g)&&t.hasOwnProperty(v)){B(t[v]);et(t[g]);H(t[y])}else{if(t._editStateFilter!==undefined){B({editStateFilter:t._editStateFilter});delete t._editStateFilter}R();et(t)}if(t[v]){if(t[v].variantDirty===undefined){t[v].variantDirty=true}o.byId("template::PageVariant")&&o.byId("template::PageVariant").currentVariantSetModified(t[v].variantDirty)}}function J(){var t=d.oComponentUtils.getTemplatePrivateModel();return t.getProperty("/generic/bDataAreShownInTable")}function k(e){if(t.oSmartFilterbar.isPending()){var a=function(r){var i=r.getParameters();if(!i.pendingValue){t.oSmartFilterbar.detachPendingChange(a);L(e)}};t.oSmartFilterbar.attachPendingChange(a)}else{L(e)}}function R(){var e=t.oController.getOwnerComponent().getModel("_templPriv"),a=t.oSmartFilterbar.isCurrentVariantStandard()?t.oController.getOwnerComponent().getDefaultFilterMode():e.getProperty("/alp/filterMode");if(!(a===b||a===V)){S.error("Defaulting to Visual filter due to incorrect value of defaultFilterMode in App descriptor");a=b}if(a===b&&t.hideVisualFilter){S.error("Visual filter is hidden defaulting to compact");a=V}t.filterBarController.setDefaultFilter(a)}function j(e){var a=t.oController.getOwnerComponent().getProperty("smartVariantManagement");if(a){var r=e["sap-ui-fe-variant-id"];if(r&&r[0]){t.oSmartFilterbar.getSmartVariant().setCurrentVariantId(r[0])}}else{var i=e["sap-ui-fe-variant-id"],n=e["sap-ui-fe-filterbar-variant-id"],o=e["sap-ui-fe-chart-variant-id"],l=e["sap-ui-fe-table-variant-id"];K(n&&n[0],o&&o[0],l&&l[0],i&&i[0])}}function K(e,a,r,i){if(e||i){t.oSmartFilterbar.getSmartVariant().setCurrentVariantId(e||i)}if(t.oSmartChart&&(a||i)){t.oSmartChart.attachAfterVariantInitialise(function(e){t.oSmartChart.setCurrentVariantId(a||i)});t.oSmartChart.setCurrentVariantId(a||i)}if(t.oSmartTable&&(r||i)){t.oSmartTable.attachAfterVariantInitialise(function(e){t.oSmartTable.setCurrentVariantId(r||i)});t.oSmartTable.setCurrentVariantId(r||i)}}function W(a,r,n){if(n===sap.fe.navigation.NavType.hybrid){a=a.iAppState;n=sap.fe.navigation.NavType.iAppState}t.oSmartFilterbar.setSuppressSelection(false);t.oSmartFilterbar.resumeSetFilterData();var s=a.appStateKey||"";if(h){return}if(d.oComponentUtils.isStateHandlingSuspended()){d.oComponentUtils.hidePlaceholder();return}w=s;h=true;t.sNavType=n;var c=!s&&r||{};j(c);if(n!==sap.fe.navigation.NavType.iAppState&&a.presentationVariant!==undefined){q(a.presentationVariant)}if(n!==sap.fe.navigation.NavType.initial){var p=a&&a.bNavSelVarHasDefaultsOnly;var f=new e(a.selectionVariant);var S=a.semanticDates;N=JSON.parse(a.selectionVariant);if(f.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1&&f.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1&&f.getParameterNames().indexOf("P_DisplayCurrency")===-1){Y(f,a)}if(!p||t.oSmartFilterbar.isCurrentVariantStandard()){var m={selectionVariant:f,semanticDates:S};var g=t.oSmartFilterbar.getUiState();var y=new e(JSON.stringify(g.getSelectionVariant()));if(n!==sap.fe.navigation.NavType.iAppState){t.oController.modifyStartupExtension(m);m.semanticDates=u.addSemanticDateRangeDefaultValue(O,t.oSmartFilterbar,m.semanticDates,m.urlParameters||{},m.selectionVariant);m.semanticDates.Dates.forEach(function(t){m.selectionVariant.addSelectOption(t.PropertyName,"I","EQ","")})}var V=t.oSmartFilterbar.getAllFilterItems().map(function(t){return t.getName()});var C=a.oSelectionVariant.toJSONObject().SelectOptions.filter(function(t){return V.includes(t.PropertyName)});if(!Q(y.toJSONObject().SelectOptions,C)){o.byId("template::PageVariant")&&o.byId("template::PageVariant").currentVariantSetModified(true)}if(p){var D=i.getMergedVariants([new e(JSON.stringify(t.oSmartFilterbar.getUiState().getSelectionVariant())),m.selectionVariant]);m.selectionVariant=D}it(m.selectionVariant);rt(m)}else{var P=new e(JSON.stringify(t.oSmartFilterbar.getUiState().getSelectionVariant())),T=P.getSelectOption("sap.suite.ui.generic.template.customData"),U=P.getSelectOption("sap.suite.ui.generic.template.genericData");x=t.oSmartFilterbar.getUiState().getSemanticDates();X(P,T,U,true);var m={selectionVariant:P,semanticDates:x};t.oController.modifyStartupExtension(m);if(t.oSmartFilterbar.isCurrentVariantStandard()){u.addSemanticDateRangeDefaultValue(O,t.oSmartFilterbar,m.semanticDates,m.urlParameters||{},m.selectionVariant)}X(m.selectionVariant,T,U,false);if(!l(m.selectionVariant,new e(JSON.stringify(t.oSmartFilterbar.getUiState().getSelectionVariant())))){it(m.selectionVariant);rt(m)}}if(a.tableVariantId&&t.oSmartTable){t.oSmartTable.setCurrentVariantId(a.tableVariantId)}var M=t.oController.getOwnerComponent().getModel("_templPriv");if(n===sap.fe.navigation.NavType.xAppState&&M.getProperty("/alp/filterMode")===b){at()}if(a.customData){var _=a.customData;k(_);if(_.hasOwnProperty(v)){var E=_[v];vt(E.controlStates)}}else{R()}if(!p){t.oSmartFilterbar.checkSearchAllowed(t);if(t.oController.getView().getModel("_templPriv").getProperty("/alp/searchable")){F=true;t.oSmartFilterbar.search()}}A={appStateKey:s,urlParams:c}}else{var f=new e(JSON.stringify(t.oSmartFilterbar.getUiState().getSelectionVariant())),T=f.getSelectOption("sap.suite.ui.generic.template.customData"),U=f.getSelectOption("sap.suite.ui.generic.template.genericData"),x=t.oSmartFilterbar.getUiState().getSemanticDates();X(f,T,U,true);var m={selectionVariant:f,semanticDates:x};t.oController.modifyStartupExtension(m);m.semanticDates=u.addSemanticDateRangeDefaultValue(O,t.oSmartFilterbar,m.semanticDates,m.urlParameters||{},m.selectionVariant);m.semanticDates.Dates.forEach(function(t){var e=m.selectionVariant.getSelectOption(t.PropertyName);if(e&&e.length!=0){return}m.selectionVariant.addSelectOption(t.PropertyName,"I","EQ","")});X(m.selectionVariant,T,U,false);if(!l(m.selectionVariant,new e(JSON.stringify(t.oSmartFilterbar.getUiState().getSelectionVariant())))){it(m.selectionVariant);rt(m)}if(t.oSmartFilterbar.isLiveMode()||t.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled()){t.oSmartFilterbar.checkSearchAllowed(t);if(t.oController.getView().getModel("_templPriv").getProperty("/alp/searchable")){F=true}}R()}st();I=null;if(!t.oSmartFilterbar.isLiveMode()){var B=gt();if(!B||!z()){d.oComponentUtils.hidePlaceholder()}}else{if(!z()){d.oComponentUtils.hidePlaceholder()}}if(!F){ft()}else{h=false}if(a.bNavSelVarHasDefaultsOnly){o.byId("template::PageVariant").currentVariantSetModified(true)}else{o.byId("template::PageVariant").currentVariantSetModified(false)}G()}function G(){var e=t.oController.getView().getModel("_templPriv").getProperty("/alp/contentView");if(e!=="charttable"&&e!=="table"){if(!t.oSmartChart||e==="customview1"||e==="customview2"){d.oComponentUtils.hidePlaceholder()}}}function Q(t,e){return l(t.map(JSON.stringify).sort(),e.map(JSON.stringify).sort())}function q(e){var a=typeof e==="string"?JSON.parse(e):e;var r=a&&a.SortOrder;if(t.oSmartTable){var i=t.oTemplateUtils.oServices.oPresentationControlHandlerFactory.getPresentationControlHandler(t.oSmartTable);i.applyNavigationSortOrder(r)}if(t.oSmartChart){var n=t.oTemplateUtils.oServices.oPresentationControlHandlerFactory.getPresentationControlHandler(t.oSmartChart);n.applyNavigationSortOrder(r)}}function z(){var e=t.oSmartFilterbar.determineMandatoryFilterItems();var a=t.oSmartFilterbar.getFiltersWithValues();return e.every(function(t){return a.includes(t)})}function X(t,e,a,r){if(r){if(e){t.removeSelectOption("sap.suite.ui.generic.template.customData")}if(a){t.removeSelectOption("sap.suite.ui.generic.template.genericData")}}else{if(e){t.massAddSelectOption("sap.suite.ui.generic.template.customData",e)}if(a){t.massAddSelectOption("sap.suite.ui.generic.template.genericData",a)}}}function Y(e,a){var r=t.oSmartFilterbar.determineMandatoryFilterItems(),i;for(var n=0;n<r.length;n++){if(r[n].getName().indexOf("P_DisplayCurrency")!==-1){if(a.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&a.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){i=a.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low}if(i){e.addParameter("P_DisplayCurrency",i)}if(t.alr_visualFilterBar&&i){t.alr_visualFilterBar.setDisplayCurrency(i)}break}}}function Z(){var e={};e[g]={};var a=t.oController.getOwnerComponent().getModel("_templPriv");var r=t.chartController&&s({},t.chartController._chartInfo);if(r&&r.chartSelection){delete r.chartSelection}var i={};if(E){i[t.oSmartChart.getId()]=E.getState()}if(_){i[t.oSmartTable.getId()]=_.getState()}i[U.getId()]=M.getState();e[v]={chartVariantId:t.oSmartChart&&t.oSmartChart.getCurrentVariantId(),filterMode:a.getProperty("/alp/filterMode"),contentView:a.getProperty("/alp/contentView"),autoHide:a.getProperty("/alp/autoHide"),chartInfo:r,variantDirty:o.byId("template::PageVariant")&&o.byId("template::PageVariant").currentVariantGetModified(),controlStates:i};var l=o.byId("editStateFilter");if(l){e[v].editStateFilter=l.getSelectedKey()}o.getCustomAppStateDataExtension(e[g]);var c;var u=true;var S=function(t,e){if(!(t instanceof n)){throw new p(f,"State must always be set with respect to a ControllerExtension")}if(!u){throw new p(f,"State must always be provided synchronously")}if(e){c=c||Object.create(null);var a=t.getMetadata().getNamespace();c[a]=e}};o.templateBaseExtension.provideExtensionAppStateData(S);u=false;if(c){e[y]=c}return e}function $(){return N}function tt(){var e=t.oSmartFilterbar.getUiState(),a=e.getSelectionVariant(),r=e.getSemanticDates(),i=o.getVisibleSelectionsWithDefaults();for(var n=0;n<i.length;n++){if(!a.getValue(i[n])){a.addSelectOption(i[n],"I","EQ","")}}if(t.oController.byId("template::PageVariant").currentVariantGetModified()&&a.SelectionVariantID){a.SelectionVariantID=""}return{selectionVariant:JSON.stringify(a),semanticDates:r,tableVariantId:t.oSmartTable&&t.oSmartTable.getCurrentVariantId(),customData:Z()}}function et(t){o.restoreCustomAppStateDataExtension(t||{})}function at(){var e=c({},t.oSmartFilterbar.getFilterData(true)),a=t.oController.getOwnerComponent().getModel("_filter");a.setData(e);t.filterBarController._updateFilterLink()}function rt(e){t.oSmartFilterbar.clearVariantSelection();t.oSmartFilterbar.clear();P=e.selectionVariant;ct(e.selectionVariant.toJSONObject(),e.semanticDates,true,false)}function it(e){var a=e.getParameterNames().concat(e.getSelectOptionsPropertyNames());for(var r=0;r<a.length;r++){t.oSmartFilterbar.addFieldToAdvancedArea(a[r])}if(t.alr_visualFilterBar&&t.bVisualFilterInitialised){t.alr_visualFilterBar.addVisualFiltersToBasicArea(a)}}function nt(){if(t._bIsStartingUp){return}if(h){return}if(d.oComponentUtils.isStateHandlingSuspended()){return}var e=sap.ui.require("sap/ushell/Container");if(!e){S.error("AnalyticalListPage.fnStoreCurrentAppStateAndAdjustURL: Can't save the app state as ushell container is not found!");return}var a=tt();var r=m.storeInnerAppStateAsync(a,true);r.done(function(e){I=e;if(t.oTemplateUtils.oComponentUtils.isComponentActive()&&I){t.oTemplateUtils.oServices.oApplication.navigateByExchangingQueryParam(T,I)}if(I&&w!==I){A.appStateKey=I;I=null}});r.fail(function(t){S.error("AnalyticalListPage.fnStoreCurrentAppStateAndAdjustURL: "+t);I=null})}function ot(){var e=t.oController.getOwnerComponent().getModel("_templPriv");if(e.getProperty("/alp/filterMode")===b){if(t.alr_visualFilterBar&&t.alr_visualFilterBar.bIsInitialised&&e.getProperty("/alp/searchable")===false){t.oSmartFilterbar.showAdaptFilterDialog("group")}}}function lt(){if(t.oSmartFilterbar.isInitialised()){t.oSmartFilterbar.checkSearchAllowed(t)}}function st(){var e=t.oController.getOwnerComponent().getModel("_filter");e.setData(c({},t.oSmartFilterbar.getFilterData(true)));t.filterBarController._updateFilterLink()}function ct(e,a,i,n){var o=new r({selectionVariant:e,semanticDates:a});t.oSmartFilterbar.setUiState(o,{replace:i,strictMode:n})}function pt(t){C=m.parseNavigation()}function ut(){try{var t=new Promise(function(t){D=t;C.done(W);C.fail(function(e,a,r){S.warning(e.getErrorCode()+"app state could not be parsed - continuing with empty state");W({},a,sap.fe.navigation.NavType.initial);t()})});return t}catch(t){mt()}}function ft(){h=false;D()}function St(){return P}function dt(e){if(!e){var a=t.oIappStateHandler.fnGetStartUpSelectionVariant();if(a){var r=a.getParameterNames().concat(a.getSelectOptionsPropertyNames());t.alr_visualFilterBar.addVisualFiltersToBasicArea(r)}}t.alr_visualFilterBar.updateVisualFilterBindings(true);if(t.oSmartFilterbar.isCurrentVariantStandard()){t.oIappStateHandler.fnCheckMandatory();t.oIappStateHandler.fnCheckToLaunchDialog()}}function mt(){R();st();if(t.alr_visualFilterBar&&t.alr_visualFilterBar.bIsInitialised){t.oIappStateHandler.fnUpdateVisualFilterBar(true)}}function gt(){var e=false;if(t.oSmartFilterbar.isCurrentVariantStandard()){t.oSmartFilterbar.checkSearchAllowed(t);if(t.oController.getView().getModel("_templPriv").getProperty("/alp/searchable")){var a=t.oController.getOwnerComponent();var r=a.getDataLoadSettings();var i=r?r.loadDataOnAppLaunch:"ifAnyFilterExist";if(i==="ifAnyFilterExist"){var n=t.oSmartFilterbar.getFiltersWithValues();e=n.length?true:false}else if(i==="always"){e=true}else if(i==="never"){e=false}if(e){t.oSmartFilterbar.getSmartVariant().setExecuteOnStandard(true);e=t.oSmartFilterbar.getSmartVariant().getExecuteOnStandard()}}}var o=t.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();if(o||e){t.oSmartFilterbar.search()}return e}function vt(e){if(E){E.setState(e&&e[t.oSmartChart.getId()])}if(_){_.setState(e&&e[t.oSmartTable.getId()])}M.setState(e&&e[U.getId()])}return{areDataShownInTable:J,getFilterState:Z,fnCheckMandatory:lt,fnCheckToLaunchDialog:ot,getCurrentAppState:tt,fnUpdateSVFB:st,fnSetDefaultFilter:R,fnRestoreFilterState:k,getUrlParameterInfo:x,onSmartFilterBarInitialise:pt,onSmartFilterBarInitialized:ut,fnStoreCurrentAppStateAndAdjustURL:nt,fnSetFiltersUsingUIState:ct,fnResolveStartUpPromise:ft,fnGetStartUpSelectionVariant:St,fnUpdateVisualFilterBar:dt,fnOnError:mt,getInitialNavigationContext:$}}return t.extend("sap.suite.ui.generic.template.listTemplates.controller.IappStateHandler",{constructor:function(t,e,a){s(this,d(t,e,a))}})});
//# sourceMappingURL=IappStateHandler.js.map