/*!
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/base/i18n/Localization","sap/ui/thirdparty/jquery","./library","sap/m/library","sap/ui/core/Control","sap/m/FlexBox","sap/ui/core/ResizeHandler","sap/base/Log","sap/m/IllustratedMessage","./InteractiveBarChartRenderer","sap/ui/core/Core","sap/ui/core/Theming","./InteractiveBarChartBar"],function(t,jQuery,e,i,a,s,r,n,l,o,h,p,d){"use strict";var _=a.extend("sap.suite.ui.microchart.InteractiveBarChart",{metadata:{library:"sap.suite.ui.microchart",properties:{displayedBars:{type:"int",group:"Appearance",defaultValue:3},labelWidth:{type:"sap.ui.core.Percentage",group:"Appearance",defaultValue:"40%"},selectionEnabled:{type:"boolean",group:"Behavior",defaultValue:true},min:{type:"float",group:"Appearance"},max:{type:"float",group:"Appearance"},showError:{type:"boolean",group:"Appearance",defaultValue:false},errorMessageTitle:{type:"string",group:"Appearance"},errorMessage:{type:"string",group:"Appearance"}},defaultAggregation:"bars",aggregations:{bars:{type:"sap.suite.ui.microchart.InteractiveBarChartBar",defaultClass:d,multiple:true,bindable:"bindable"}},events:{selectionChanged:{parameters:{selectedBars:{type:"sap.suite.ui.microchart.InteractiveBarChartBar[]"},bar:{type:"sap.suite.ui.microchart.InteractiveBarChartBar"},selected:{type:"boolean"}}},press:{}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}}},renderer:o});_.MIN_BAR_WIDTH_IN_PX=1;_.BAR_VALUE_PADDING_LEFT_IN_PX=4;_.BAR_VALUE_PADDING_RIGHT_IN_PX=4;_.SELECTION_AREA_BORDER_IN_PX=1;_.DIVIDER_WIDTH_IN_PX=1;_.AREA_HEIGHT_MINVALUE=18;_.BAR_HEIGHT_FONT_SMALLER=20;_.BAR_HEIGHT_MINVALUE=6;_.BAR_HEIGHT_LABEL_HIDE=16;_.CHART_WIDTH_FONT_SMALLER=286;_.LABEL_WIDTH_MINVALUE=80;_.CHART_WIDTH_MINVALUE=130;_.AREA_HEIGHT_INTERACTIVE_MINVALUE=44;_.AREA_HEIGHT_INTERACTIVE_MINVALUE_COMPACT=32;_.AREA_HEIGHT_PADDING_STAGE1=34;_.AREA_HEIGHT_PADDING_STAGE1_COMPACT=32;_.AREA_HEIGHT_PADDING_STAGE2=28;_.AREA_HEIGHT_PADDING_STAGE2_COMPACT=31;_.prototype.init=function(){this._iVisibleBars=0;this._bInteractiveMode=true;this._bMinMaxValid=null;this._fDividerPositionRight=0;this._oRb=h.getLibraryResourceBundle("sap.suite.ui.microchart");this._fMin=null;this._fMax=null;this._bThemeApplied=false;this._oIllustratedMessageControl=new l({illustrationSize:i.IllustratedMessageSize.Base,illustrationType:i.IllustratedMessageType.NoData});h.ready(this._handleCoreInitialized.bind(this))};_.prototype._handleCoreInitialized=function(){p.attachApplied(this._handleThemeApplied.bind(this))};_.prototype.onBeforeRendering=function(){this._bCompact=this._isCompact();this._bInteractiveMode=true;this._setResponsivenessData();this._setInternalMinMax();this._errorMessage=this.getErrorMessage();this._errorMessageTitle=this.getErrorMessageTitle();this._oIllustratedMessageControl.setTitle(this._errorMessageTitle);this._oIllustratedMessageControl.setDescription(this._errorMessage);this._bMinMaxValid=this._checkIfMinMaxValid();if(this.getAggregation("bars")&&this.getDisplayedBars()){this._iVisibleBars=Math.min(this.getAggregation("bars").length,this.getDisplayedBars())}if(!this.data("_parentRenderingContext")&&typeof this.getParent==="function"){this.data("_parentRenderingContext",this.getParent())}this._deregisterResizeHandler();this._updateUseSemanticTooltip()};_.prototype.onAfterRendering=function(){this._adjustToParent();e._checkControlIsVisible(this,this._onControlIsVisible);this._bindMouseEnterLeaveHandler()};_.prototype._updateUseSemanticTooltip=function(){var t=this.getBars();this._bUseSemanticTooltip=false;for(var e=0;e<this._iVisibleBars;e++){if(t[e].getColor()!==i.ValueColor.Neutral){this._bUseSemanticTooltip=true;return}}};_.prototype._onControlIsVisible=function(){this._sResizeHandlerId=r.register(this,this._onResize.bind(this));this._calcBarsWidth();this._onResize();if(this.$().length>0){var t=this._isCompact();if(t!==this._bCompact){this._bCompact=t;this.invalidate()}}};_.prototype.exit=function(){this._deregisterResizeHandler();this._oIllustratedMessageControl.destroy()};_.prototype.onclick=function(t){if(!this.getSelectionEnabled()){return}if(this._bInteractiveMode){var e=jQuery(t.target).attr("id")||jQuery(t.target).parents(".sapSuiteIBCBarInteractionArea").attr("id"),i=this.$().find(".sapSuiteIBCBarInteractionArea"),a,s;if(e){a=e.substring(e.lastIndexOf("-")+1);if(isNaN(a)){return}else{a=parseInt(a)}this._toggleSelected(a);s=i.index(this.$().find(".sapSuiteIBCBarInteractionArea[tabindex='0']"));this._switchTabindex(s,a,i)}}else{this.firePress()}};_.prototype.onsapenter=function(t){if(this._bInteractiveMode){var e=this.$().find(".sapSuiteIBCBarInteractionArea").index(t.target);if(e!==-1){this._toggleSelected(e)}t.preventDefault();t.stopImmediatePropagation()}else{this.firePress()}};_.prototype.onsapspace=_.prototype.onsapenter;_.prototype.onsapup=function(t){var e=this.$().find(".sapSuiteIBCBarInteractionArea");var i=e.index(t.target);if(e.length>0){this._switchTabindex(i,i-1,e)}t.preventDefault();t.stopImmediatePropagation()};_.prototype.onsapdown=function(t){var e=this.$().find(".sapSuiteIBCBarInteractionArea");var i=e.index(t.target);if(e.length>0){this._switchTabindex(i,i+1,e)}t.preventDefault();t.stopImmediatePropagation()};_.prototype.onsaphome=function(t){var e=this.$().find(".sapSuiteIBCBarInteractionArea");var i=e.index(t.target);if(i!==0&&e.length>0){this._switchTabindex(i,0,e)}t.preventDefault();t.stopImmediatePropagation()};_.prototype.onsapend=function(t){var e=this.$().find(".sapSuiteIBCBarInteractionArea"),i=e.index(t.target),a=e.length;if(i!==a-1&&a>0){this._switchTabindex(i,a-1,e)}t.preventDefault();t.stopImmediatePropagation()};_.prototype.onsapleft=_.prototype.onsapup;_.prototype.onsapright=_.prototype.onsapdown;_.prototype.getSelectedBars=function(){var t=this.getAggregation("bars"),e=[],i;for(i=0;i<t.length;i++){if(t[i].getSelected()){e.push(t[i])}}return e};_.prototype.setSelectedBars=function(t){var e=this.getAggregation("bars"),i,a;this._deselectAllSelectedBars();if(!t){return this}if(t instanceof d){t=[t]}if(Array.isArray(t)){for(i=0;i<t.length;i++){a=this.indexOfAggregation("bars",t[i]);if(a>=0){e[a].setProperty("selected",true,true)}else{n.warning("setSelectedBars method called with invalid InteractiveBarChartBar element")}}}this.invalidate();return this};_.prototype.getTooltip_AsString=function(t){if(this._isChartEnabled()){i=this._createTooltipText(t,true);if(!i&&e._isTooltipSuppressed(i)){i=null}}else{var i=this.getTooltip_Text();if(!i){i=this._createTooltipText()}else if(e._isTooltipSuppressed(i)){i=null}}return i};_.prototype._isCompact=function(){return jQuery("body").hasClass("sapUiSizeCompact")||this.$().is(".sapUiSizeCompact")||this.$().closest(".sapUiSizeCompact").length>0};_.prototype._setResponsivenessData=function(){if(this._bCompact){this._iAreaHeightInteractiveMinValue=_.AREA_HEIGHT_INTERACTIVE_MINVALUE_COMPACT;this._iAreaHeightPaddingStage1=_.AREA_HEIGHT_PADDING_STAGE1_COMPACT;this._iAreaHeightPaddingStage2=_.AREA_HEIGHT_PADDING_STAGE2_COMPACT}else{this._iAreaHeightInteractiveMinValue=_.AREA_HEIGHT_INTERACTIVE_MINVALUE;this._iAreaHeightPaddingStage1=_.AREA_HEIGHT_PADDING_STAGE1;this._iAreaHeightPaddingStage2=_.AREA_HEIGHT_PADDING_STAGE2}};_.prototype._handleThemeApplied=function(){this._bThemeApplied=true;this._bCompact=this._isCompact();this.invalidate();p.detachApplied(this._handleThemeApplied.bind(this))};_.prototype._adjustToParent=function(){var t=this.$();if(this.data("_parentRenderingContext")&&this.data("_parentRenderingContext")instanceof s){var e=this.data("_parentRenderingContext").$();var i=e.width()-2;var a=e.height()-2;t.outerWidth(i);t.outerHeight(a)}};_.prototype._calcBarsWidth=function(){var e=this.$(),i=e.find(".sapSuiteIBCBarLabel"),a=_.DIVIDER_WIDTH_IN_PX,s=parseFloat(this.getLabelWidth()),r,n,l,o,h,p,d,u,c,f,g=t.getRTL();if(!this._bMinMaxValid){return this}if(this._bFullWidth){s=100;r=100}else{r=100-s}n=Math.abs(this._fMax-this._fMin);if(this._fMin>=0&&this._fMax>=0){l=0;o=1}else if(this._fMin<0&&this._fMax<0){l=1;o=0}else{l=Math.abs(this._fMin/n);o=Math.abs(this._fMax/n)}if(this._bFullWidth){if(o>=l){h=o*100;p=l*100}else{h=l*100;p=0}i.css("width",h+"%");i.css(g?"right":"left",p+"%")}else{i.css("width",s+"%");i.css(g?"right":"left","")}e.find(".sapSuiteIBCBarWrapper").css("width",r+"%");if(l>0){e.find(".sapSuiteIBCBarWrapperNegative").width("calc("+l*100+"% - "+a+"px)")}else{e.find(".sapSuiteIBCBarWrapperNegative").width("0%")}if(o>0){e.find(".sapSuiteIBCBarWrapperPositive").width("calc("+o*100+"% - "+a+"px)")}else{e.find(".sapSuiteIBCBarWrapperPositive").width("0%")}for(var I=0;I<this._iVisibleBars;I++){d=this.getBars()[I].getValue();c=this.$("bar-negative-"+I);f=this.$("bar-positive-"+I);if(this.getBars()[I]._bNullValue||d===0){f.add(c).css("min-width",0)}else if(!this.getBars()[I]._bNullValue){if(d>0){u=Math.min(Math.max(d,this._fMin),this._fMax);f.css({width:this._calcPercent(u,n,Math.max(0,this._fMin),o),"min-width":1});c.css("min-width",0)}else{u=Math.max(Math.min(d,this._fMax),this._fMin);c.css({width:this._calcPercent(u,n,Math.min(0,this._fMax),l),"min-width":1});f.css("min-width",0)}}}};_.prototype._calcPercent=function(t,e,i,a){return Math.abs((t-i)/(e*a)*100).toFixed(5)+"%"};_.prototype._deselectAllSelectedBars=function(){var t=this.getAggregation("bars"),e=t.length,i;for(i=0;i<e;i++){t[i].setProperty("selected",false,true)}};_.prototype._toggleSelected=function(t){var e=this.getAggregation("bars"),i=e[t];if(t<0||t>=e.length){return}var a=this.$("interactionArea-"+t);if(i.getSelected()){a.removeClass("sapSuiteIBCBarSelected");i.setProperty("selected",false,true)}else{a.addClass("sapSuiteIBCBarSelected");i.setProperty("selected",true,true)}a.attr("aria-selected",i.getSelected());this.fireSelectionChanged({selectedBars:this.getSelectedBars(),bar:i,selected:i.getSelected()})};_.prototype._showValueOutsideBar=function(){var e=this.$(),i,a,s,r,n,l,o,h,p=this.$("bar-positive-0").parent().width(),d=this.$("bar-negative-0").parent().width(),u=t.getRTL();i=e.find(".sapSuiteIBCBarValue");if(i.length===0){return}for(var c=0;c<this._iVisibleBars;c++){r=this.getBars()[c].getValue();s=i.eq(c).width()+_.BAR_VALUE_PADDING_LEFT_IN_PX+_.BAR_VALUE_PADDING_RIGHT_IN_PX;n=this.$("bar-positive-"+c).width();l=this.$("bar-negative-"+c).width();o=p-n;h=d-l;if(r>0||(this.getBars()[c]._bNullValue||r===0)&&this._fMin+this._fMax>=0){if(s>n&&s>o){i.eq(c).css("visibility","hidden")}else{i.eq(c).css("visibility","inherit")}if(s>n){a=this.$("bar-positive-"+c).width()+_.BAR_VALUE_PADDING_LEFT_IN_PX+"px";i.eq(c).addClass("sapSuiteIBCBarValueOutside")}else{a="";i.eq(c).removeClass("sapSuiteIBCBarValueOutside")}if(u){i.eq(c).css({right:a})}else{i.eq(c).css({left:a})}}else{if(s>l&&s>h){i.eq(c).css("visibility","hidden")}else{i.eq(c).css("visibility","inherit")}if(s>l){a=this.$("bar-negative-"+c).width()+_.BAR_VALUE_PADDING_RIGHT_IN_PX+"px";i.eq(c).addClass("sapSuiteIBCBarValueOutside")}else{a="";i.eq(c).removeClass("sapSuiteIBCBarValueOutside")}if(u){i.eq(c).css({left:a})}else{i.eq(c).css({right:a})}}}};_.prototype._checkIfMinMaxValid=function(){if(this._fMin>this._fMax){n.warning("Min value for InteractiveBarChart is larger than Max value.");return false}return true};_.prototype._setInternalMinMax=function(){var t=null,e=null,i,a=this.getBars(),s=Math.min(this.getDisplayedBars(),a.length);for(var r=0;r<s;r++){if(!a[r]._bNullValue){i=a[r].getValue();t=Math.min(t,i);e=Math.max(e,i)}}this._fMin=this.getMin();this._fMax=this.getMax();if(!Number.isFinite(Number(this._fMin))||!Number.isFinite(Number(this._fMax))){if(t>=0&&e>=0){if(!Number.isFinite(Number(this._fMin))){this._fMin=0}if(!Number.isFinite(Number(this._fMax))){this._fMax=e}}else if(t<0&&e<0){if(!Number.isFinite(Number(this._fMin))){this._fMin=t}if(!Number.isFinite(Number(this._fMax))){this._fMax=0}}else{if(!Number.isFinite(Number(this._fMin))){this._fMin=t}if(!Number.isFinite(Number(this._fMax))){this._fMax=e}}}};_.prototype.validateProperty=function(t,e){if(t==="labelWidth"&&(e!==null||e!==undefined)){var i=parseFloat(e);if(i<0||i>100){n.warning("LabelWidth for InteractiveBarChart is not between 0 and 100.");e=null}}return a.prototype.validateProperty.apply(this,[t,e])};_.prototype._switchTabindex=function(t,e,i){if(t>=0&&t<i.length&&e>=0&&e<i.length){i.eq(t).removeAttr("tabindex");i.eq(e).attr("tabindex","0");i.eq(e).trigger("focus")}};_.prototype._isChartEnabled=function(){return this.getSelectionEnabled()&&this._bInteractiveMode};_.prototype._resizeVertically=function(t){var e,i,a,s=this.$(),r=false,n=s.find(".sapSuiteIBCBarInteractionArea"),l=Math.round(s.height()),o=0,h=this._iVisibleBars;if(this._bInteractiveMode){o=1}i=parseInt(n.css("margin-bottom"))+parseInt(n.css("margin-top"));const p=Number.parseFloat(n.css("border-bottom-width"));e=(l-(i+2*p)*h)/h;if(e+o<this._iAreaHeightInteractiveMinValue){if(this._bInteractiveMode){this._bInteractiveMode=false;r=true;s.addClass("sapSuiteIBCNonInteractive");if(this.getSelectionEnabled()){var d=this.$().find(".sapSuiteIBCBarInteractionArea[tabindex='0']");this._iActiveElement=n.index(d);d.removeAttr("tabindex");this.$().attr("tabindex","0")}this.$().attr({role:"button","aria-multiselectable":"false","aria-disabled":!this._isChartEnabled()})}}else if(!this._bInteractiveMode){this._bInteractiveMode=true;r=true;s.removeClass("sapSuiteIBCNonInteractive");if(this.getSelectionEnabled()){this.$().removeAttr("tabindex");if(!this._iActiveElement||this._iActiveElement<0){this._iActiveElement=0}n.eq(this._iActiveElement).attr("tabindex","0")}this.$().attr({role:"listbox","aria-multiselectable":"true","aria-disabled":!this._isChartEnabled()})}if(r){if(this._isChartEnabled()){s.removeAttr("title");this._addInteractionAreaTooltip(n)}else{n.removeAttr("title");s.attr("title",this.getTooltip_AsString())}}n.height(e);if(e<=this._iAreaHeightPaddingStage2){s.addClass("sapSuiteIBCStage2")}else{s.removeClass("sapSuiteIBCStage2");if(e<=this._iAreaHeightPaddingStage1){s.addClass("sapSuiteIBCStage1")}else{s.removeClass("sapSuiteIBCStage1")}}var u=this.$().find(".sapSuiteIBCBar");if(u.length>0&&u[0].getBoundingClientRect()){a=u[0].getBoundingClientRect().height}if(a<=_.BAR_HEIGHT_FONT_SMALLER){s.addClass("sapSuiteIBCSmallFont")}if(a<=_.BAR_HEIGHT_LABEL_HIDE){s.find(".sapSuiteIBCBarValue").css("visibility","hidden");t.labelsVisible=false}else{s.find(".sapSuiteIBCBarValue").css("visibility","inherit")}if(e<_.AREA_HEIGHT_MINVALUE){s.css("visibility","hidden");t.labelsVisible=false;t.chartVisible=false}};_.prototype._resizeHorizontally=function(t){if(!t.chartVisible){return}var e=this.$(),i=e.find(".sapSuiteIBCBarInteractionArea"),a=e.find(".sapSuiteIBCBarLabel"),s=parseFloat(this.getLabelWidth())/100*i.eq(0).width(),r=0,n=e.width(),l,o=false;if(n<_.CHART_WIDTH_FONT_SMALLER){e.addClass("sapSuiteIBCSmallFont");s=parseFloat(this.getLabelWidth())/100*i.eq(0).width()}if(this._bFullWidth){r=6}for(var h=0;h<a.length;h++){a.eq(h).css("width",s+"px");if(a.eq(h).children(".sapSuiteIBCBarLabelText").prop("clientWidth")<a.eq(h).children(".sapSuiteIBCBarLabelText").prop("scrollWidth")-r){o=true}a.eq(h).css("width","100%")}if(s<_.LABEL_WIDTH_MINVALUE&&o){e.addClass("sapSuiteIBCFullWidth");this._bFullWidth=true;this._calcBarsWidth()}else{e.removeClass("sapSuiteIBCFullWidth");this._bFullWidth=false;this._calcBarsWidth()}var p=this.$().find(".sapSuiteIBCBar");if(p.length>0&&p[0].getBoundingClientRect()){l=p[0].getBoundingClientRect().height}if(n<_.CHART_WIDTH_MINVALUE||l<_.BAR_HEIGHT_MINVALUE){e.css("visibility","hidden");t.labelsVisible=false;t.chartVisible=false}else if(l<=_.BAR_HEIGHT_LABEL_HIDE){e.find(".sapSuiteIBCBarValue").css("visibility","hidden");t.labelsVisible=false}};_.prototype._onResize=function(){var t=this.$(),e={chartVisible:true,labelsVisible:true};if(this.getBars().length!==0){t.css("visibility","visible");t.removeClass("sapSuiteIBCSmallFont");this._resizeVertically(e);this._resizeHorizontally(e);if(e.labelsVisible){this._showValueOutsideBar()}}};_.prototype._deregisterResizeHandler=function(){if(this._sResizeHandlerId){r.deregister(this._sResizeHandlerId);this._sResizeHandlerId=null}};_.prototype._addInteractionAreaTooltip=function(t){var e=this.getBars(),i,a;t.each(function(t,s){i=jQuery(s);a=parseInt(i.attr("data-sap-ui-ibc-selection-index"));i.attr("title",e[a].getTooltip_AsString())})};_.prototype._createTooltipText=function(t,e){var i=true,a=this.getBars(),s,r="";for(var n=0;n<this._iVisibleBars;n++){if(e){if(t&&t-1===n){s=a[n].getTooltip_AsString();if(s){r+=(i?"":"\n")+s;i=false;break}}}else{s=a[n]._getBarTooltip(this._bUseSemanticTooltip);if(s){r+=(i?"":"\n")+s;i=false}}}return r};_.prototype._bindMouseEnterLeaveHandler=function(){this.$().find(".sapSuiteIBCBarInteractionArea").on("mouseenter.tooltip",this._addTitleAttribute.bind(this));this.$().find(".sapSuiteIBCBarInteractionArea").on("mouseleave.tooltip",this._removeTitleAttribute.bind(this))};_.prototype._addTitleAttribute=function(t){if(this._isChartEnabled()&&this._hasData()){var e=this.getDomRef().querySelectorAll(".sapSuiteIBCBarInteractionArea");var i=t.target.getAttribute("aria-posinset");if(i&&e[parseInt(i)-1]&&!e[parseInt(i)-1].getAttribute("title")){e[parseInt(i)-1].setAttribute("title",this.getTooltip_AsString(parseInt(i)))}else{var a=t.target;var s=a.closest(".sapSuiteIBCBarInteractionArea");if(s&&!s.getAttribute("title")){s.setAttribute("title",this.getTooltip_AsString(parseInt(s.getAttribute("aria-posinset"))))}}}};_.prototype._removeTitleAttribute=function(t){var e=t.target.getAttribute("aria-posinset");var i=this.getDomRef().querySelectorAll(".sapSuiteIBCBarInteractionArea");if(e&&i[parseInt(e)-1]&&i[parseInt(e)-1].getAttribute("title")){i[parseInt(e)-1].removeAttribute("title")}else{var a=t.target;var s=a.closest(".sapSuiteIBCBarInteractionArea");if(s&&s.getAttribute("title")){s.removeAttribute("title")}}};_.prototype._hasData=function(){return this.getBars().length>0};return _});
//# sourceMappingURL=InteractiveBarChart.js.map