/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/ui/base/Object","sap/ui/core/Element","../windowmessages/CollaborationMessageConsumer"],function(e,t,n,i){"use strict";var r="sap-url-hash";var s="&sap-ui-cardTitle";var a="&sap-stageview-hash";var o="&sap-ui-cardId";var c="&sap-ui-xx-cardId";var l="&info=";var u="sap-ushell-config";var f="sap-collaboration-teams";var p="sap-ui-fesr-env";var h="transient";var d=e.getLogger("sap.suite.ui.commons.collaboration.CollaborationHelper");var m=t.extend("sap.suite.ui.commons.collaboration.CollaborationHelper");m.compactHash=function(e){const t=sap.ui.require("sap/ushell/Container");if(!t){return{url:e}}return t&&t.getServiceAsync("AppState").then(async function(t){var n=t.createEmptyAppState(undefined,false);var i=this._getNextKey(n);if(!this._isEligibleForBackendPersistency(t)){d.warning("Transient flag is true. URL will not be shortened");return{url:e}}var s=this._extractURLBeforeHash(e);var a=await this._extractSemanticObjectAndAction(e);var o=false;try{o=await this._isMinificationFeasible(e)}catch(e){d.error("isMinificationPossible check failed. URL will not be shortened")}if(!a||!o){return{url:e}}return this._storeUrl(e,n).then(function(){return{url:s+"#"+a+"&/"+r+"="+i}}).catch(function(t){d.warning("URL is not shortened due to an error."+t.toString());return{url:e}})}.bind(this))};m._getCurrentUrl=function(){const e=sap.ui.require("sap/ushell/Container");return e&&e?new Promise(function(t){e.getFLPUrlAsync(true).then(function(e){t(e)})}):Promise.resolve(document.URL)};m.processAndExpandHash=function(){this._hideAvatarFromShellbar();return this._getCurrentUrl().then(async function(e){if(e.indexOf(r)>-1){var t=e.split(r)[1].split("=")[1];if(e.indexOf(a)>0){t=t.split(a)[0]}else if(e.includes("info=")){t=t.includes(",")?t.split(",")[0]:t.split("&")[0]}else if(e.indexOf(o)>0||e.indexOf(c)>0){if(e.indexOf(o)>0){t=t.split(o)[0]}else{t=t.split(c)[0]}}else if(e.indexOf(s)>0){t=t.split(s)[0]}return this._retrieveURL(t).then(function(t){if(t.getData()){window.location.replace(t.getData())}else{const t=e.split(r)[0];window.location.replace(t)}return Promise.resolve()})}else if(e.indexOf(o)>-1){const t=e.split(o)[0];window.location.replace(t)}else if(e.indexOf(s)>-1){const t=e.split(s)[0];await this._redirectBasedOnRuntime(t)}else if(e.includes(l)&&this._isFromTeams(e)){const t=e.split(l)[0];await this._redirectBasedOnRuntime(t)}return Promise.resolve()}.bind(this))};m._isFromTeams=function(e){const t=new URL(e);const n=t.searchParams.get("sap-collaboration-teams");return n==="true"};m._redirectBasedOnRuntime=async function(e){const t=sap.ui.require("sap/ushell/Container");if(t&&t.inAppRuntime()){await i.updateTopLevelURLforAppRuntime(e)}else{const t=this._stripTeamsParams(e);window.location.replace(t)}};m._removeTeamsParams=function(e){try{const t=e.split("#");const n=t[0];const i=t[1]?"#"+t[1]:"";const[r,s]=n.split("?");if(!s){return e}const a=new URLSearchParams(s);a.delete(u);a.delete(f);a.delete(p);const o=a.toString()?`${r}?${a.toString()}`:r;return o+i}catch(t){return e}};m._stripTeamsParams=function(e){if(this._isTopWindow()){return this._removeTeamsParams(e)}return e};m._isTopWindow=function(){return window.self===window.top};m._hideAvatarFromShellbar=function(){this.isTeamsModeActive().then(function(e){if(e){var t=n.getElementById("userActionsMenuHeaderButton");if(t){t.setVisible(false)}}})};m.isTeamsModeActive=function(){var e=false;const t=sap.ui.require("sap/ushell/Container");if(t){return t.getServiceAsync("URLParsing").then(function(t){return this._getCurrentUrl().then(function(n){var i=n.split("#")[0];if(i.indexOf("?")!==-1){var r=t&&t.parseParameters(i.substring(i.indexOf("?")));if(r&&r["sap-collaboration-teams"]&&r["sap-collaboration-teams"][0]&&r["sap-collaboration-teams"][0]==="true"){e=true}var s=false;if(r&&r["sap-ushell-config"]&&r["sap-ushell-config"][0]&&r["sap-ushell-config"][0]==="lean"){s=true}return Promise.resolve(e&&s)}else{return Promise.resolve(false)}})}.bind(this))}else{return Promise.resolve(false)}};m._retrieveURL=function(e){const t=sap.ui.require("sap/ushell/Container");return t&&t.getServiceAsync("AppState").then(function(t){return t.getAppState(e)})};m._isEligibleForBackendPersistency=function(e){return e&&e._oConfig&&h in e._oConfig&&!e._oConfig[h]};m._getNextKey=function(e){return e.getKey()};m._extractSemanticObjectAndAction=function(e){const t=sap.ui.require("sap/ushell/Container");return t&&t.getServiceAsync("URLParsing").then(function(t){var n=t.parseShellHash(this._extractURLHash(e));if(n){return Promise.resolve(n.contextRaw?n.semanticObject+"-"+n.action+"~"+n.contextRaw:n.semanticObject+"-"+n.action)}}.bind(this))};m._isMinificationFeasible=async function(e){const t=sap.ui.require("sap/ushell/Container");if(t){const r=await t.getServiceAsync("NavTargetResolution");const s=await t.getServiceAsync("URLParsing");var n=s.parseShellHash(this._extractURLHash(e));var i=Object.keys(n.params).length;if(i>0){return r.resolveHashFragment(`#${n.semanticObject}-${n.action}`).then(function(e){return true}).catch(function(e){return false})}else{return Promise.resolve(true)}}return Promise.resolve(false)};m._extractURLBeforeHash=function(e){var t=e.split("#")[0];return t};m._extractURLHash=function(e){var t=e.substring(e.indexOf("#"));return t};m._storeUrl=function(e,t){t.setData(e);return t.save()};return m});
//# sourceMappingURL=CollaborationHelper.js.map