/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./SvgBase","sap/ui/core/ResizeHandler","sap/ui/core/Lib","sap/ui/core/Element","sap/base/i18n/Localization","sap/ui/core/RenderManager","./GraphMapRenderer"],function(jQuery,t,e,i,r,s,o,a){"use strict";var h=4;var n=i.getResourceBundleFor("sap.suite.ui.commons");var p=t.extend("sap.suite.ui.commons.networkgraph.GraphMap",{metadata:{library:"sap.suite.ui.commons",properties:{height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:""},width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:""},directRenderNodeLimit:{type:"int",group:"Behavior",defaultValue:250},title:{type:"string",group:"Misc",defaultValue:""}},associations:{graph:{type:"sap.suite.ui.commons.networkgraph.Graph",multiple:false,singularName:"graph"}},events:{mapReady:{}}}});p.prototype.init=function(){this._oResizeListener=null;this.setBusyIndicatorDelay(0)};p.prototype.onAfterRendering=function(){var t=this.getGraph();if(t&&t._bIsLayedOut){this._renderMap()}else{this.setBusy(true)}};p.prototype._renderMap=function(){var t=this.getGraph();if(!t){return}var e,i,r,a,p,d,u,l=this,g=t._fZoomLevel,f=t.getNodes().length===0,c=t._isUseNodeHtml(),m="";var v=function(t,e){if(e){t.forEach(function(t){t._render({mapRender:true,idSufix:l.getId(),renderManager:e})})}else{t.forEach(function(t){m+=t._render({mapRender:true,idSufix:l.getId()})})}};var _=function(t,e){var i=new o;t.forEach(function(t){t._render({mapRender:true,renderManager:i,idSufix:l.getId()})});i.flush(e);i.destroy()};var y=function(){var e=new o;t.getGroups().forEach(function(t){t._render({mapRender:true,renderManager:e,idSufix:l.getId()})});e.flush(this.getDomRef("divgroups"));e.destroy()}.bind(this);var G=function(e,i){if(!i){a+=this._renderControl("rect",{x:h/2,y:h/2,width:Math.min((t.$scroller.width()-h/2)/g,(t.$svg.width()-h/2)/g),height:Math.min((t.$scroller.height()-h/2)/g,(t.$svg.height()-h/2)/g),class:e,id:this._getDomId("mapNavigator")})}else{this._renderControl("rect",{x:h/2,y:h/2,width:Math.min((t.$scroller.width()-h/2)/g,(t.$svg.width()-h/2)/g),height:Math.min((t.$scroller.height()-h/2)/g,(t.$svg.height()-h/2)/g),class:e,id:this._getDomId("mapNavigator")},null,i)}}.bind(this);if(!t._iWidth||!t._iHeight||f){if(t._bIsInvalid||f){this.setBusy(false);this.$().find(".sapSuiteUiCommonsNetworkGraphMapContent").html("");this.fireMapReady()}return}e=t.$("networkGraphSvg").attr("viewBox");if(!e){e="0 0 "+t._iWidth+" "+t._iHeight}var w=new o;w.openStart("svg",this._getDomId("svg"));w.attr("width","100%");w.attr("height","100%");w.class("sapSuiteUiCommonsNetworkGraphMapSvg");w.attr("aria-label",n.getText("NETWORK_GRAPH_OVERVIEW_SVG_ACCESSIBILITY_LABEL"));w.attr("viewBox",e);w.attr("aria-hidden","true");if(t._bIsRtl){w.attr("direction","rtl")}w.openEnd();if(this._useGraphClone()){this._renderControl("use",{"xlink:href":"#"+t._getDomId("svgbody")},null,w)}else{v(t.getLines(),w);if(!c){v(t.getNodes(),w)}}this._renderControl("rect",{x:0,y:0,width:t._iWidth,height:t._iHeight,class:"sapSuiteUiCommonsNetworkGraphMapBoundary","pointer-events":"fill"},null,w);if(!c){G("sapSuiteUiCommonsNetworkGraphMapNavigator",w)}w.close("svg");w.openStart("div",this._getDomId("divgroups"));w.class("sapSuiteUiCommonsNetworkGraphMapDivGroups");if(s.getRTL()){w.class("sapSuiteUiCommonsNetworkGraphMapDivGroupsLeft")}w.openEnd();w.close("div");if(c){w.openStart("div",this._getDomId("divnodes"));w.class("sapSuiteUiCommonsNetworkGraphMapDivNodes");if(s.getRTL()){w.class("sapSuiteUiCommonsNetworkGraphMapDivGroupsLeft")}w.openEnd();w.close("div");w.openStart("svg");w.class("sapSuiteUiCommonsNetworkGraphSvgNavigator");w.attr("aria-label",n.getText("NETWORK_GRAPH_NAVIGATOR_SVG_ACCESSIBILITY_LABEL"));w.attr("width","100%");w.attr("height","100%");w.attr("viewBox",e);w.openEnd();G("sapSuiteUiCommonsNetworkGraphMapNavigator",w);w.close("svg")}var L=this.$();w.flush(L.find(".sapSuiteUiCommonsNetworkGraphMapContent")[0],true,false);w.destroy();y();if(c){var N=this.getDomRef("divnodes");_(t.getNodes(),N)}p=this.$("svg");i=t._iWidth;r=t._iHeight;d=Math.max(i/p.width(),r/p.height());this._setHtmlNodesPosition(d);u=Math.ceil(d/5);this._iStrokeWidth=u;this._correctLineWidth();this.$("svg").find("circle").css("stroke-width",u+"px");this._setupEvents();this._correctPosition();this.setBusy(false);this.fireMapReady()};p.prototype._setHtmlNodesPosition=function(t){var e=this.getGraph(),i=this.$("svg"),r=1/t,s,o;s=Math.floor(i.width()/2-e._iWidth/2*r);o=Math.floor(i.height()/2-e._iHeight/2*r);this.$("divgroups").css("transform","matrix("+r+", 0, 0, "+r+", "+s+", "+o+")");if(e._isUseNodeHtml){this.$("divnodes").css("transform","matrix("+r+", 0, 0, "+r+", "+s+", "+o+")")}};p.prototype._useGraphClone=function(){var t=this.getDirectRenderNodeLimit(),e=this.getGraph();if(e){return t>e.getNodes().length&&!e._isUseNodeHtml()}return false};p.prototype._correctLineWidth=function(t){var t=this.getGraph(),e=this._isMSBrowser()||(!this._useGraphClone()||t._preventZoomToChangeLineWidth());this.$("svg").css("stroke-width",e?this._iStrokeWidth+"px":"1px")};p.prototype._correctMapNavigator=function(){var t=this.$("mapNavigator"),e=parseFloat(t.attr("width")),i=parseFloat(t.attr("height")),r=parseFloat(t.attr("x")),s=parseFloat(t.attr("y")),o=this.getGraph(),a=o._iWidth,h=o._iHeight;if(e+r>a){t.attr("width",a-r)}if(i+s>h){t.attr("height",h-s)}};p.prototype._resize=function(){var t=this.getGraph(),e=t.$scroller,i=this.$("mapNavigator");i.attr("x",Math.max(h/2,e[0].scrollLeft/t._fZoomLevel));i.attr("y",Math.max(h/2,e[0].scrollTop/t._fZoomLevel));i.attr("width",e.width()/t._fZoomLevel);i.attr("height",e.height()/t._fZoomLevel);this._correctLineWidth();this._correctMapNavigator()};p.prototype._resizeHandler=function(){this._resize();var t=this.getGraph();if(t._isUseNodeHtml()){var e=this.$("svg"),i=this.getGraph().$svg;if(i){var r=Math.max(i.width()/e.width(),i.height()/e.height())*(1/t._fZoomLevel);this._setHtmlNodesPosition(r)}}};p.prototype._correctPosition=function(){var t=this.getGraph(),e=t&&t.$scroller,i=this.$("mapNavigator");if(t&&e[0]){i.attr("x",Math.max(h/2,e[0].scrollLeft/t._fZoomLevel));i.attr("y",Math.max(h/2,e[0].scrollTop/t._fZoomLevel));this._correctMapNavigator()}};p.prototype._setupEvents=function(){var t=false,e=this.getGraph(),i=this.$("svg"),r=e.$scroller;var s=function(t){var s=e.$svg,o=Math.max(s.width()/i.width(),s.height()/i.height()),a=i.find(".sapSuiteUiCommonsNetworkGraphMapBoundary"),h=r[0],n=a.offset().left,p=a.offset().top;h.scrollLeft=(t.pageX-n)*o-r.width()/2;h.scrollTop=(t.pageY-p)*o-r.height()/2};var o=function(){i.removeClass("sapSuiteUiCommonsNetworkGraphPanning");t=false};r.on("scroll",function(){this._correctPosition()}.bind(this));i.off();i.on("mousedown",function(e){t=true;s(e);e.preventDefault()});i.on("mousemove",function(e){if(t){if(!i.hasClass("sapSuiteUiCommonsNetworkGraphPanning")){i.addClass("sapSuiteUiCommonsNetworkGraphPanning")}s(e)}});i.on("mouseleave",function(t){o()});i.on("mouseup",function(t){o()})};p.prototype._onBeforeDataProcess=function(){if(this.getDomRef("svg")){this.$("svg").html("");this.setBusy(true)}};p.prototype._onGraphReady=function(){if(this.getVisible()){setTimeout(this._renderMap.bind(this),0);if(this._oResizeListener){e.deregister(this._oResizeListener)}this._oResizeListener=e.register(this.getGraph().$("wrapper")[0],this._resizeHandler.bind(this))}};p.prototype._removeListeners=function(){var t=this.getGraph();if(t){t.detachBeforeLayouting(this._onBeforeDataProcess,this);t.detachGraphReady(this._onGraphReady,this);t.detachZoomChanged(this._resize,this)}};p.prototype.destroy=function(){this._removeListeners();t.prototype.destroy.apply(this,arguments)};p.prototype.exit=function(){if(this._oResizeListener){e.deregister(this._oResizeListener);this._oResizeListener=null}};p.prototype.getTitle=function(){var t=this.getProperty("title");return t?t:n.getText("NETWORK_GRAPH_MAP_TITLE")};p.prototype.getGraph=function(){var t=this.getAssociation("graph");return t?r.getElementById(t):null||null};p.prototype.setGraph=function(t){this._removeListeners();this.setAssociation("graph",t);var e=this.getGraph();if(e){e.attachBeforeLayouting(this._onBeforeDataProcess,this);e.attachGraphReady(this._onGraphReady,this);e.attachZoomChanged(this._resize,this);if(e._isLayedOut()){this._onGraphReady()}}return this};return p});
//# sourceMappingURL=GraphMap.js.map