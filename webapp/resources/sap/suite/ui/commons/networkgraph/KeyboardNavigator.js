/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/Object","./Group","./Node","./Line","sap/ui/events/KeyCodes","sap/ui/dom/containsOrEquals","sap/base/Log","sap/ui/core/Lib"],function(jQuery,t,e,o,i,s,n,r,u){"use strict";var a={LEFT:"left",RIGHT:"right",UP:"up",DOWN:"down"};var l=/^on.*|setFocus|setItems$/;function h(t){var e,o=t.prototype;for(e in o){if(o.hasOwnProperty(e)&&typeof o[e]==="function"&&l.test(e)){o[e]=f(o[e])}}}function f(t){return function(){try{return t.apply(this,arguments)}catch(t){this._handleError(t)}return undefined}}var c=t.extend("sap.suite.ui.commons.networkgraph.KeyboardNavigator",{constructor:function(e){t.apply(this,arguments);this._oGraph=e;this._aItems=[[]];this._iRows=0;this._iColumns=0;this._iPageSize=5;this._oFocus=null;this._oFocusPosition=null;this._oWrapperDom=null;this.isFromFullscreen=null}});c.prototype.getFocus=function(){var t=this._oGraph.getFocus();if(this._oFocus!==t){this._oFocus=t?{item:t.item,button:t.button}:null;this._oFocusPosition=null}if(this._oFocus!=null&&this._oFocus.item===null&&this._oFocus.button===null){return null}return this._oFocus?{item:this._oFocus.item,button:this._oFocus.button}:null};c.prototype.getFocusPosition=function(){var t=this.getFocus();if(!this._oFocusPosition){var e,o;this._oFocusPosition={iX:null,iY:null};if(!t){return this._oFocusPosition}for(o=0;o<this._aItems.length;o++){for(e=0;e<this._aItems[o].length;e++){if(this._aItems[o][e]===t.item){this._oFocusPosition={iX:e,iY:o};return this._oFocusPosition}}}}return this._oFocusPosition};c.prototype.setItems=function(t){this._aItems=t;this._iRows=t.length;this._iColumns=0;t.forEach(function(t){if(this._iColumns<t.length){this._iColumns=t.length}},this)};c.prototype.setWrapperDom=function(t){this._oWrapperDom=t};c.prototype.setPageSize=function(t){this._iPageSize=t};c.prototype.onsapend=function(t){this._moveThroughMatrix(t,true,true)};c.prototype.onsaphome=function(t){this._moveThroughMatrix(t,true,false)};c.prototype.onsapendmodifiers=function(t){if(t.ctrlKey){this._moveThroughMatrix(t,false,true)}};c.prototype.onsaphomemodifiers=function(t){if(t.ctrlKey){this._moveThroughMatrix(t,false,false)}};c.prototype.onsappagedown=function(t){this._moveThroughMatrix(t,false,true,this._iPageSize)};c.prototype.onsappageup=function(t){this._moveThroughMatrix(t,false,false,this._iPageSize)};c.prototype.onsappagedownmodifiers=function(t){if(t.altKey){this._moveThroughMatrix(t,true,true,this._iPageSize)}};c.prototype.onsappageupmodifiers=function(t){if(t.altKey){this._moveThroughMatrix(t,true,false,this._iPageSize)}};c.prototype.onsapspacemodifiers=function(t){if(t.ctrlKey&&this._oGraph.getFocusDomRef()===document.activeElement){this._selectElement(true);t.stopPropagation();t.preventDefault()}};c.prototype.onkeyup=function(t){if(t.keyCode===s.SPACE){this._handleEnter();if(this._oGraph.getFocusDomRef()===document.activeElement){t.stopPropagation();t.preventDefault()}}};c.prototype.onsapenter=function(t){this._handleEnter()};c.prototype.onsaptabnext=function(t){this._handleTab(t,a.RIGHT)};c.prototype.onsaptabprevious=function(t){this._handleTab(t,a.LEFT)};c.prototype.onsapleft=function(t){this._handleArrow(t,a.LEFT)};c.prototype.onsapright=function(t){this._handleArrow(t,a.RIGHT)};c.prototype.onsapup=function(t){this._handleArrow(t,a.UP)};c.prototype.onsapdown=function(t){this._handleArrow(t,a.DOWN)};c.prototype.onkeydown=function(t){var n,r,u=this.getFocus();if(!u){return}n=u.item;r=u.button;if(t.ctrlKey&&t.keyCode===s.A){this._onCtrlA(t)}else if(t.keyCode===s.F2){if(n instanceof o){if(n.hasVisibleActionButtons()&&n.getShowDetailButton()){n._detailClick(n.getDomRef().querySelector("#"+n.getId()+"-actionDetail").querySelector(".sapSuiteUiCommonsNetworkGraphDivActionButton"))}}else if(n instanceof i){n.getParent()._tooltip.openDetail({item:n,point:n._getArrowFragmentVector().apex})}else if(n instanceof e){var l=n.fireEvent("showDetail",{},true);if(l){n._openDetail()}}t.stopPropagation()}else if(t.keyCode===s.F6){if(n&&r){u.button=null;this._oGraph.setFocus(u)}this._handleArrow(t,t.shiftKey?a.LEFT:a.RIGHT)}else if(t.keyCode===s.F7&&!t.shiftKey){if(n&&r){u.button=null;this._oGraph.setFocus(u)}}else if(t.ctrlKey&&(t.keyCode===s.DIGIT_0||t.keyCode===s.NUMPAD_0)){this._onCtrl0(t)}else if(t.ctrlKey&&(t.keyCode===s.PLUS||t.keyCode===s.NUMPAD_PLUS)){this._onCtrlPlus(t)}else if(t.ctrlKey&&(t.keyCode===s.SLASH||t.keyCode===s.NUMPAD_MINUS)){this._onCtrlMinus(t)}};c.prototype._handleEnter=function(){var t,s,n=this.getFocus();if(!n){return}if(n.button=="menu"){n.item._setMenuButtonFocus(false)}t=n.item;s=n.button;if(t instanceof o){if(s){this._oGraph._isUseNodeHtml()?jQuery(s).trigger("click"):jQuery(s).children().first().trigger("click")}else{t._onClick(false);if(!t.getSelected()){t.$().removeClass(t.HIGHLIGHT_CLASS);t._setStatusColors("")}}}else if(t instanceof i){var r=t._getArrowFragmentVector();t._click({ctrlKey:false,clientX:r.apex.x,clientY:r.apex.y,skipConversion:true})}else if(t instanceof e){if(s===e.BUTTONS.MENU){var u=t.fireEvent("showDetail",{},true);if(u){t._openDetail()}}else if(s===e.BUTTONS.COLLAPSE){t._collapse()}else{t._openDetail()}}};c.prototype._handleTab=function(t,e){var o=u.getResourceBundleFor("sap.suite.ui.commons");this._oWrapperDom.setAttribute("aria-live","assertive");this._oGraph._setAriaLabelForWrapper(o.getText("NETWORK_GRAPH_ACCESSIBILITY_LABEL"));if(this._ignoreEvent(t)){this._oWrapperDom.setAttribute("aria-live","off");this._oWrapperDom.classList.remove("sapSuiteUiCommonsNetworkGraphContentFocusHidden");if(t.target.getAttribute("title")===o.getText("CALCULATION_BUILDER_ENTER_FULL_SCREEN_BUTTON")){this.isFromFullscreen=true}else{this.isFromFullscreen=false}return}else{this._oWrapperDom.classList.add("sapSuiteUiCommonsNetworkGraphContentFocusHidden")}if(this._handleTabOverNodeWithButtons(t,e)||this._handleTabOverGroupWithButtons(t,e)||this._handleTabOverLinesWithButtons(t,e)){t.preventDefault();t.stopPropagation();return}this._moveItemFocus(t,e)};c.prototype._handleTabOverLinesWithButtons=function(t,e){var o=this.getFocus(),s,n,r,u=false,a;if(!o){return false}s=o.item;n=o.button;r=s&&s._getEnabledActionButtons?s._getEnabledActionButtons():[];if(!(s instanceof i)||!s._hasVisibleActionButtons()||r.length===0){return false}return this._checkActionHandled(t,n,r,u,a,e)};c.prototype._handleTabOverNodeWithButtons=function(t,e){var i=this.getFocus(),s,n,r,u=false,a;if(!i){return false}s=i.item;n=i.button;r=s&&s.getEnabledActionButtons?s.getEnabledActionButtons():[];if(!(s instanceof o)||!s.hasVisibleActionButtons()||r.length===0){return false}return this._checkActionHandled(t,n,r,u,a,e)};c.prototype._handleTabOverGroupWithButtons=function(t,o){var i=this.getFocus(),s,n;if(!i){return false}s=i.item;n=i.button;if(s instanceof e){if(!n){if(o===a.RIGHT){this._oGraph.setFocus(i);return true}else if(o===a.LEFT){return false}}if(n){if(n===e.BUTTONS.MENU){if(o===a.RIGHT){i.button=e.BUTTONS.COLLAPSE;this._oGraph.setFocus(i);return true}else if(o===a.LEFT){i.button=undefined;this._oGraph.setFocus(i);return true}}else if(n===e.BUTTONS.COLLAPSE){if(o===a.RIGHT){return false}else if(o===a.LEFT){i.button=e.BUTTONS.MENU;this._oGraph.setFocus(i);return true}}}}return false};c.prototype._checkActionHandled=function(t,e,o,i,s,n){if(e){s=0;for(var r=0;r<o.length;r++){if(o[r].isEqualNode(e)){s=r;break}}if(n===a.RIGHT){if(s===o.length-1){return false}else{this._setActionButtonFocus(o[s+1])}i=true}else if(n===a.LEFT){if(s===0){this._moveItemFocus(t,this.getFocusPosition())}else{this._setActionButtonFocus(o[s-1])}i=true}}else if(n===a.RIGHT){this._setActionButtonFocus(o[0]);i=true}return i};c.prototype._setActionButtonFocus=function(t){var e=this.getFocus();if(!e){return}e.button=t;this._oGraph.setFocus(e)};c.prototype._selectElement=function(t){var e=this.getFocus(),s;if(!e){return}s=e.item;if(s instanceof o){s.getParent()._selectNode({element:s,setFocus:false,renderActionButtons:false,preventDeselect:t})}else if(s instanceof i){s.getParent()._selectLine({element:s,setFocus:false,preventDeselect:t})}};c.prototype._moveThroughMatrix=function(t,e,o,i){var s=this.getFocus(),n,r,u,a,l=this.getFocusPosition().iX,h=this.getFocusPosition().iY;if(this._ignoreEvent(t)||!s){return}n=s.item;u=0;i=i||Number.POSITIVE_INFINITY;do{for(var f=(e?l:h)+(o?1:-1);o&&f<(e?this._iColumns:this._iRows)||!o&&f>=0;f+=o?1:-1){r=e&&h>=0&&h<this._iRows||!e&&l>=0&&l<this._iColumns?this._aItems[e?h:f][e?f:l]:null;if(r&&u<i){a=r;u++;if(u>=i){break}}}if(i<Number.POSITIVE_INFINITY&&u<i){if(e){if(o){l=-1;h++}else{l=this._iColumns;h--}}else if(o){l++;h=-1}else{l--;h=this._iRows}}}while(i<Number.POSITIVE_INFINITY&&u<i&&h>=-1&&h<=this._iRows&&l>=-1&&l<=this._iColumns);if(a&&a!==n){s.item=a;s.button=null;this._oGraph.setFocus(s);t.stopPropagation()}};c.prototype._handleArrow=function(t,e){if(this._ignoreEvent(t)||!this.getFocus()){return}this._moveItemFocus(t,e,true)};c.prototype._moveItemFocus=function(t,s,n){var r,u=s===a.LEFT&&t.key==="Tab",l,h,f;if(typeof s==="string"){l=this._findNextPosition(s)}else{l=s}h=this._getItemAtPosition(l);r={item:h,button:null};if(u&&h!==null){if(h instanceof o&&h.hasVisibleActionButtons()){f=h.getEnabledActionButtons();if(f.length>0){r.button=f[f.length-1]}}else if(h instanceof i&&h._hasVisibleActionButtons()){f=h._getEnabledActionButtons();if(f.length>0){r.button=f[f.length-1]}}else if(h instanceof e){r.button=e.BUTTONS.COLLAPSE}}if(h||!n){this._oGraph.setFocus(r)}if(t&&h){t.preventDefault();t.stopPropagation()}};c.prototype._getItemAtPosition=function(t){var e;if(!t||t.iX===null){return null}else{e=this._aItems[t.iY];return e?e[t.iX]:null}};c.prototype._findNextPosition=function(t){var e,o,i=true;if(this.getFocusPosition().iX===null){if(t===a.LEFT&&!this.isFromFullscreen){e=this._iColumns-1;o=this._iRows-1}else if(t===a.LEFT&&this.isFromFullscreen){e=0;o=0;i=false}else{e=0;o=0}if(this._aItems[o][e]!==null&&i){return{iX:e,iY:o}}}else{e=this.getFocusPosition().iX;o=this.getFocusPosition().iY}do{switch(t){case a.RIGHT:e+=1;if(e>=this._iColumns){o+=1;e=0}break;case a.LEFT:e-=1;if(e<0){o-=1;e=this._iColumns-1}break;case a.UP:o-=1;if(o<0&&e>0){e-=1;o=this._iRows-1}break;case a.DOWN:o+=1;if(o>=this._iRows&&e<this._iColumns-1){e+=1;o=0}break;default:throw new Error("Unexpected direction: "+t)}}while(o>=0&&o<this._iRows&&this._aItems[o][e]===null);if(o<0||o>=this._iRows){this.isFromFullscreen=false;return null}else{return{iX:e,iY:o}}};c.prototype._onCtrlA=function(t){if(this._ignoreEvent(t)){return}var o=true;this._forEach(function(t){if(t instanceof e){return false}if(!t.getSelected()){o=false;return true}return false});o=!o;this._forEach(function(t){if(!(t instanceof e)){t.setSelected(o)}});t.preventDefault();t.stopPropagation()};c.prototype._forEach=function(t){var e,o,i,s;for(o=0;o<this._iRows;o++){for(e=0;e<this._iColumns;e++){i=this._aItems[o][e];if(i){s=t.call(this,i,e,o);if(s){return}}}}};c.prototype._onCtrl0=function(t){this._oGraph._zoom({zoomLevel:this._oGraph.ZOOM_100});t.preventDefault();t.stopPropagation()};c.prototype._onCtrlPlus=function(t){this._oGraph._zoom({deltaY:1});t.preventDefault();t.stopPropagation()};c.prototype._onCtrlMinus=function(t){this._oGraph._zoom({deltaY:-1});t.preventDefault();t.stopPropagation()};c.prototype._ignoreEvent=function(t){return!n(this._oWrapperDom,t.target)};c.prototype._handleError=function(t){r.error("An error in KeyboardNavigator: "+t)};h(c);return c});
//# sourceMappingURL=KeyboardNavigator.js.map