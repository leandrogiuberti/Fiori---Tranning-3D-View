/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/ui/base/Object","sap/ui/core/Control","sap/m/MessageBox","sap/base/security/encodeXML","./Utils","sap/ui/core/Lib","sap/ui/thirdparty/jqueryui/jquery-ui-core","sap/ui/thirdparty/jqueryui/jquery-ui-widget","sap/ui/thirdparty/jqueryui/jquery-ui-mouse","sap/ui/thirdparty/jqueryui/jquery-ui-draggable"],function(jQuery,t,e,i,r,a,n,s){"use strict";var o=t.CalculationBuilderItemType,l=t.CalculationBuilderOperatorType,u=t.CalculationBuilderLogicalOperatorType;var p=s.getResourceBundleFor("sap.suite.ui.commons");var c=i.extend("sap.suite.ui.commons.CalculationBuilderItem",{constructor:function(t,e){if(typeof t!=="string"&&t!==undefined){e=t}if(e&&e.key){e.key=this._sanitizeKey(e.key)}i.apply(this,arguments)},metadata:{library:"sap.suite.ui.commons",properties:{key:{type:"string",group:"Misc",defaultValue:null}}},renderer:{apiVersion:2,render:function(t,e){e._render(t)}}});c.prototype._innerRender=function(t,e){var i=this._bReadOnly?"sapMBtnDisabled":"",r=this._getLabel(),n={"!=":"NOT_EQUAL","-":"MINUS",",":"COMMA"};var s=function(t){t.openStart("div");t.class("sapCalculationBuilderItemFocusWrapper");t.openEnd();t.openStart("div");t.class("sapCalculationBuilderItemFocus");t.openEnd();t.close("div");t.close("div")};var o=function(t){t.openStart("div");t.class("sapCalculationBuilderItemExpandButtonWrapper");t.attr("title",p.getText("CALCULATION_BUILDER_EXPAND_BUTTON_TITLE"));t.openEnd();t.openStart("div");t.attr("id",this.getId()+"-expandbutton");t.class("sapCalculationBuilderItemExpandButton").class(i);t.attr("tabindex","-1");t.openEnd();if(!this._bReadOnly){t.openStart("div");t.class("sapCalculationBuilderItemExpandButtonFocus");t.openEnd();t.close("div")}l(t,"");t.close("div");t.close("div")}.bind(this);var l=function(t,e){t.openStart("span");t.attr("aria-hidden","true");t.attr("data-sap-ui-icon-content",e);t.class("sapCalculationBuilderEmptyItemIcon").class("sapUiIcon").class("sapUiIconMirrorInRTL").class("sapCalculationBuilderExpressionSAPFont");t.openEnd();t.close("span")};var u=function(t,e){t.attr("aria-label",p.getText(e))};t.openStart("div");t.class("sapCalculationBuilderItemContentWrapper");t.openEnd();t.openStart("div");t.attr("id",this.getId()+"-content");t.class("sapCalculationBuilderItemContent");t.attr("title",this.getParent()._operatorTooltip[r]?p.getText(this.getParent()._operatorTooltip[r]):"");if(this._bIsNew||this._isEmpty()){t.attr("title",p.getText("CALCULATION_BUILDER_NEW_ITEM_TITLE"))}else if(n[r]){u(t,"CALCULATION_BUILDER_"+n[r]+"_ARIA_LABEL")}t.attr("aria-haspopup","dialog");t.openEnd();s(t);if(this._isEmpty()){l(t,"");t.close("div")}else if(this._bIsNew){l(t,"");t.close("div")}else if(this._isFunction()){var c=this._getFunction();t.openStart("span");t.class("sapCalculationBuilderItemLabel").class("sapCalculationBuilderItemFunctionLabel");t.openEnd();t.unsafeHtml(a(c.title||this.getKey()));t.close("span");t.openStart("span");t.class("sapCalculationBuilderItemLabel").class("sapCalculationBuilderItemFunctionBracket");t.openEnd();t.unsafeHtml("(");t.close("span");t.close("div")}else{t.openStart("span");t.class("sapCalculationBuilderItemLabel");t.openEnd();t.unsafeHtml(a(r));t.close("span");t.close("div")}t.close("div");if(this._isVariable()&&this.isExpandable()){o(t)}if(e){t.flush(e)}};c.prototype._getClass=function(t,e,i){var r="",a=this._isEmpty();r+=this._bIsNew?"sapCalculationBuilderNewItem  sapCalculationBuilderCancelSelectable":"sapCalculationBuilderItem";if(a){r+=" sapCalculationBuilderNewItem "}if(this._isBracket()){r+=" sapCalculationBuilderItemBracket "}else if(this._isOperator()){r+=" sapCalculationBuilderItemOperator sapCalculationBuilderItemOperatorLength-"+this._getLabel().length+" ";if(this._isLogicalOperator()){r+=" sapCalculationBuilderItemLogicalOperator "}}else if(this._isCustomOperator()){r+=" sapCalculationBuilderItemOperator sapCalculationBuilderItemCustomOperator "}else if(this._isFunction()){r+=" sapCalculationBuilderItemFunction "}else if(this._isLiteral()){r+=" sapCalculationBuilderItemLiteral "}else if(this._isVariable()){r+=" sapCalculationBuilderItemVariable ";if(this.isExpandable()){r+=" sapCalculationBuilderItemVariableSeparator "}}else{r+=" sapCalculationBuilderUnknownItem "}if(t){r+=" sapCalculationBuilderItemErrorSyntax "}if(i){return r}var n=r.split(" "),s;for(s=0;s<n.length;s++){e.class(n[s])}};c.prototype._render=function(t){if(!this.getParent()){return}var e=this._hasCorrectParent(),i=this._getItemError(),r=this._getTooltip(),a=r?'"'+r+'"':"",n=this._bIsNew?"button":"",s=e?"-1":"0";t.openStart("div");this._getClass(!!i,t);t.attr("id",this.getId());t.attr("tabindex",s);t.attr("title",a);t.attr("role",n);t.openEnd();this._innerRender(t);t.close("div")};c.prototype.init=function(){this._bIsNew=false};c.prototype.onBeforeRendering=function(){this._oVariable=this.getVariable()};c.prototype.onAfterRendering=function(){this._afterRendering()};c.prototype._afterRendering=function(){var t=this.getParent();if(!t){return}this._setEvents();if(!this._bIsNew&&!this._bReadOnly){this._setupDraggable()}if(this._hasCorrectParent(t)){if(!t._bIsCalculationBuilderRendering){t._setupKeyboard();t.getParent()._enableOrDisableExpandAllButton()}}};c.prototype._setEvents=function(){if(this.isExpandable()){this.$("expandbutton").on("click",this._expandButtonPress.bind(this));this.$("expandbutton").on("mousedown",function(t){t.stopPropagation()})}if(!this._bReadOnly){this.$("content").on("click",this._buttonPress.bind(this))}if(this._isBracket()||this._isFunction()){this._setBracketHover()}};c.prototype._buttonPress=function(t){var e=this.getParent();if(this._hasCorrectParent(e)&&!e._bDragging){if(t.ctrlKey){e._selectItem(this.$())}else if(t.shiftKey){e._selectItemsTo(this.$())}else{e._deselect();e._openDialog({opener:this,currentItem:this})}}};c.prototype._expandButtonPress=function(t){if(!this._bReadOnly){this._openExpandConfirmMessageBox()}};c.prototype.isExpandable=function(){var t=this._oVariable?this._oVariable:this.getVariable();return t&&t.getItems().length>0};c.prototype.getVariable=function(){var t=this.getParent();return this._hasCorrectParent(t)&&t._getVariableByKey(this.getKey())};c.prototype.getType=function(){return this._getType()};c.prototype._setupDraggable=function(){var t=this.getParent(),e=t.$(),i=this.$();i.draggable({revert:"invalid",axis:"x",delay:100,cursor:"move",helper:function(t){var e=i.clone();e.addClass("sapCalculationBuilderDragging");e.css("pointer-events","none");return e},scope:t.getId()+"-scope",start:function(){e.find(".sapCalculationBuilderBracket").removeClass("sapCalculationBuilderBracket");e.find(".sapCalculationBuilderItemContent").css("cursor","move");jQuery(this).addClass("sapCalculationBuilderDragging");t._bDragging=true;if(!jQuery(this).hasClass("ui-selected")){t._deselect()}},stop:function(){jQuery(this).removeClass("sapCalculationBuilderDragging");e.find(".sapCalculationBuilderItemContent").css("cursor","pointer");t._bDragging=false}});n._setupMobileDraggable(i)};c.prototype._setBracketHover=function(){var t=this.$("content"),e=this._isFunction()?l["("]:this.getKey(),i=e===l[")"],r=i?l["("]:l[")"],a;t.mouseenter(function(t){var n,s,o=0,l=this._hasCorrectParent()&&this.getParent().getItems()||[],u=i?l.length:0;for(;i?u>=0:u<l.length;i?u--:u++){n=l[u];if(n===this){s=true}if(s){if(n.getKey()===r||n._isFunction()&&i){o--;if(o===0){a=n;break}}else if(n.getKey()===e||n._isFunction()&&!i){o++}}}if(a){this.$().addClass("sapCalculationBuilderBracket");a.$().addClass("sapCalculationBuilderBracket")}}.bind(this));t.on("mouseleave",function(t){this.$().removeClass("sapCalculationBuilderBracket");if(a){a.$().removeClass("sapCalculationBuilderBracket")}}.bind(this))};c.prototype._expandVariable=function(t){var e=this.getParent(),i,r;if(e){i=e.getItems().indexOf(this);r=e._getVariableByKey(this.getKey());e.insertItem(new c({key:"("}),i++);r.getItems().forEach(function(t){e.insertItem(t._cloneItem(),i++)});e.insertItem(new c({key:")"}),i++);e.removeItem(this);if(t){e._aErrors=e._validateSyntax();e._fireChange()}}};c.prototype._cloneItem=function(){return new c({key:this.getKey()})};c.prototype._openExpandConfirmMessageBox=function(){r.show(p.getText("CALCULATION_BUILDER_EXPAND_MESSAGE_TEXT",[this._getLabel()]),{icon:r.Icon.WARNING,title:p.getText("CALCULATION_BUILDER_EXPAND_MESSAGE_TITLE"),actions:[r.Action.OK,r.Action.CANCEL],onClose:function(t){var e;if(t===r.Action.OK){this._expandVariable(true)}else{e=this.getParent();if(e){e._setCorrectFocus()}}}.bind(this)})};c.prototype._getItemError=function(){var t=this.getParent(),e;if(this._hasCorrectParent(t)){e=jQuery.grep(t._aErrors,function(t){return t.index===this._iIndex}.bind(this))[0]}return e};c.prototype._getLabel=function(){var t=function(){var t=this._getItem();if(!t){return this.getKey()}if(t.title){return t.title}if(t._getLabel){return t._getLabel()}return t.getText()||t.getKey()}.bind(this);if(!this._sLabel){this._sLabel=t();if(this._isFunction()){this._sLabel+=" ("}}return this._sLabel};c.prototype._sanitizeKey=function(t){if(!t||typeof t!=="string"){return t}t=t.replace(/{/g,"&#125;");t=t.replace(/}/g,"&#123;");return t};c.prototype._reset=function(){this._sType="";this._sLabel="";this._oVariable=""};c.prototype.setKey=function(t,e){this._reset();this.setProperty("key",this._sanitizeKey(t),e);var i=this.getParent();if(i&&i._bRendered){i.getParent()&&i.getParent()._expressionChanged()}return this};c.prototype.getKey=function(){var t=this.getProperty("key");t=t.replace(/&#125;/g,"{");t=t.replace(/&#123;/g,"}");return t};c.prototype._getType=function(){var t=this.getParent();if(!this._sType&&t){this._sType=t._getType(this.getKey())}return this._sType};c.prototype._isEmpty=function(){return!this._bIsNew&&!this.getKey()};c.prototype._isOperator=function(){return this._getType()===o.Operator};c.prototype._isSecondaryOperator=function(){var t=this._getType();if(this._getType()===o.Operator){return["+","-","/","*","(",")",","].indexOf(this.getKey())===-1}return t===o.CustomOperator};c.prototype._isCustomOperator=function(){return this._getType()===o.CustomOperator};c.prototype._isVariable=function(){return this._getType()===o.Variable};c.prototype._isLiteral=function(){return this._getType()===o.Literal};c.prototype._isFunction=function(){var t=this._getType();return t===o.Function||t===o.CustomFunction};c.prototype._getFunction=function(){var t=this._getType();if(t===o.Function||t===o.CustomFunction){var e=this.getParent().getParent();return e._createFunctionObject(e._getFunctionDefinition(this.getKey()))}return null};c.prototype._getItemInstance=function(t,e){if(this._getType()===t){var i=this.getKey().toLowerCase();var r;var a=this.getParent();switch(e){case"getVariables":r=a?._mVariableMap;break;case"getFunctions":r=a?._mFunctionMap;break;case"getOperators":r=a?._mOperatorMap;break;default:r={};break}return r?r[i]:null}return null};c.prototype._getItem=function(){var t=this._getType();switch(t){case o.Variable:return this._getVariable();case o.CustomFunction:return this._getCustomFunction();case o.CustomOperator:return this._getCustomOperator()}return null};c.prototype._getTooltip=function(){var t=this._getItem();return t&&t.getTooltip_AsString?t.getTooltip_AsString():""};c.prototype._getVariable=function(){return this._getItemInstance(o.Variable,"getVariables")};c.prototype._getCustomFunction=function(){return this._getItemInstance(o.CustomFunction,"getFunctions")};c.prototype._getCustomOperator=function(){return this._getItemInstance(o.CustomOperator,"getOperators")};c.prototype._isBracket=function(){return this._isOperator()&&(this.getKey()==="("||this.getKey()===")")};c.prototype._isAddition=function(){return this._isOperator()&&this.getKey()==="+"};c.prototype._isSubtraction=function(){return this._isOperator()&&this.getKey()==="-"};c.prototype._isDivision=function(){return this._isOperator()&&this.getKey()==="/"};c.prototype._isMultiplication=function(){return this._isOperator()&&this.getKey()==="*"};c.prototype._isComma=function(){return this._isOperator()&&this.getKey()===","};c.prototype._isLogicalOperator=function(){return this._isOperator()&&!!u[this.getKey()]};c.prototype._hasCorrectParent=function(t){t=t||this.getParent();return e.isA(t,"sap.suite.ui.commons.CalculationBuilderExpression")};return c});
//# sourceMappingURL=CalculationBuilderItem.js.map