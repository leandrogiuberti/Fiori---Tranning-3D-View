/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ovp/cards/CommonUtils","sap/base/util/merge"],function(a,o){"use strict";var t=function(a,o,t,r){this.uiModel=a;this.setColCount(o);this.aCards=[];this.oLayoutVars=null;this.iDisplaceRow=null;this.iDummyRow=999;this.iRowHeightPx=t;this.iCardBorderPx=r};t.prototype.setColCount=function(a){if(!a){this.iColCount=5}else if(a!==this.iColCount){this.iColCount=a}};t.prototype.setLayoutVars=function(a){if(Array.isArray(a)&&a.length>0){this.oLayoutVars=a}this._buildGrid()};t.prototype.updateCardVisibility=function(a){var o,t;function r(o){return o.id===a[s].id}for(var s=0;s<a.length;s++){o=this.oLayoutVars.filter(r);t=this.aCards.filter(r);if(!a[s].visibility){o[0].dashboardLayout["C"+this.iColCount].row=this._findHighestOccupiedRow();t[0].dashboardLayout.row=o[0].dashboardLayout["C"+this.iColCount].row}o[0].visibility=a[s].visibility;t[0].dashboardLayout.visible=a[s].visibility}};t.prototype.getColCount=function(){return this.iColCount};t.prototype.getCards=function(a){if(this.aCards.length===0||a&&a!==this.iColCount){if(a){this.setColCount(a)}this._buildGrid()}return this.aCards};t.prototype.getCardById=function(a){var o=null,t=0;for(t=0;t<this.aCards.length;t++){o=this.aCards[t];if(o.id===a){break}}return o};t.prototype.getLayoutVariants4Pers=function(){return JSON.parse(JSON.stringify(this.oLayoutVars))};t.prototype._readVariants=function(){var a,o,t=this.uiModel.getProperty("/dashboardLayout");function r(a){return a.id===o}if(!!t){for(var s in t){if(t.hasOwnProperty(s)&&t[s]){a=t[s];a.id=s;for(o in a){var e=this.oLayoutVars.filter(r);if(e.length>0){var d="C"+ +a.id.replace(/[^0-9\.]/g,"");var i=e[0].dashboardLayout[d];var n=this.aCards.filter(r);if(Array.isArray(n)&&n.length>0){if(i){i.row=a[o].row;i.col=a[o].col;i.colSpan=n[0].template==="sap.ovp.cards.stack"?1:Math.min(a[o].colSpan,this.iColCount);i.maxColSpan=a[o].maxColSpan;i.noOfItems=a[o].rowSpan}else{e[0].dashboardLayout[d]={row:a[o].row,col:a[o].col,colSpan:n[0].template==="sap.ovp.cards.stack"?1:Math.min(a[o].colSpan,this.iColCount),maxColSpan:a[o].maxColSpan,noOfItems:a[o].rowSpan,autoSpan:n[0].template==="sap.ovp.cards.stack"?false:true}}e[0].visibility=true;if(a[o].visible!==undefined){e[0].visibility=a[o].visible}}}}}}}};t.prototype.resetToManifest=function(){this.oLayoutVars=null;for(var a=0;a<this.aCards.length;a++){this.aCards[a].dashboardLayout={}}this._buildGrid(true)};t.prototype._buildGrid=function(a){if(this.aCards.length===0||a){this.aCards=o([],this.uiModel.getProperty("/cards"))}if(a||!this.oLayoutVars||this.oLayoutVars[0]&&!this.oLayoutVars[0].dashboardLayout){this.oLayoutVars=[];this._sliceSequenceSausage()}else{this._sliceSequenceSausage(this.oLayoutVars)}this._readVariants()};t.prototype._displaceCardToEnd=function(a){a.dashboardLayout.column=1;if(!this.iDisplaceRow){this.iDisplaceRow=this._findHighestOccupiedRow()}a.dashboardLayout.row=this.iDisplaceRow;this.iDisplaceRow+=a.dashboardLayout.rowSpan;var o=this.oLayoutVars.filter(function(o){return o.id===a.id});if(o.length>0){o[0].dashboardLayout["C"+this.iColCount].row=a.dashboardLayout.row}};t.prototype._setCardSpanFromDefault=function(a){if(!a.dashboardLayout){a.dashboardLayout={}}var o=this._getDefaultCardItemHeightAndCount(a);if(!a.settings.defaultSpan){if(a.template!=="sap.ovp.cards.linklist"&&a.template!=="sap.ovp.cards.v4.linklist"){a.dashboardLayout.rowSpan=12}else if(a.template==="sap.ovp.cards.linklist"||a.template==="sap.ovp.cards.v4.linklist"){a.dashboardLayout.rowSpan=1}a.dashboardLayout.colSpan=1;a.dashboardLayout.maxColSpan=1;a.dashboardLayout.noOfItems=o.noOfItems;a.dashboardLayout.autoSpan=a.template==="sap.ovp.cards.stack"?false:true;a.dashboardLayout.showOnlyHeader=false}else{if(a.settings.defaultSpan.showOnlyHeader){a.dashboardLayout.rowSpan=Math.ceil((o.headerHeight+2*this.iCardBorderPx)/this.iRowHeightPx);a.dashboardLayout.noOfItems=0;a.dashboardLayout.autoSpan=false;a.dashboardLayout.showOnlyHeader=true}else{if(a.template==="sap.ovp.cards.linklist"||a.template==="sap.ovp.cards.v4.linklist"){a.dashboardLayout.rowSpan=a.settings.defaultSpan.rows?a.settings.defaultSpan.rows:1;a.dashboardLayout.autoSpan=false}else{a.dashboardLayout.rowSpan=8;a.dashboardLayout.autoSpan=true}a.dashboardLayout.noOfItems=a.settings.defaultSpan.rows?a.settings.defaultSpan.rows:o.noOfItems;a.dashboardLayout.showOnlyHeader=false}if(a.template==="sap.ovp.cards.stack"){a.dashboardLayout.colSpan=1;a.dashboardLayout.autoSpan=false}else{a.dashboardLayout.colSpan=a.settings.defaultSpan.cols?Math.min(a.settings.defaultSpan.cols,this.iColCount):1}a.dashboardLayout.maxColSpan=a.settings.defaultSpan.cols?a.settings.defaultSpan.cols:1}a.dashboardLayout.visible=true;a.dashboardLayout.itemHeight=o.itemHeight;a.dashboardLayout.headerHeight=o.headerHeight};t.prototype._sliceSequenceSausage=function(a){var o=0,t=0,r=0,s=0,e=0,d={},i=[],n="C"+this.iColCount,u;for(o=0;o<this.iColCount;o++){i.push({col:o+1,rows:0})}function h(a){return a.id===d.id}function l(a,o){return o!==a}for(o=0;o<this.aCards.length;o++){d=this.aCards[o];if(!d.dashboardLayout){d.dashboardLayout={}}if(!a){this._setCardSpanFromDefault(d)}else{var y=a.filter(h);if(y.length>0){var p=y[0].dashboardLayout,L=p[n],b=Object.keys(p),c=b.filter(l.bind(this,n));if(c.length>0){u=p[c];if(u){this._mergeLayoutVariants(d.dashboardLayout,u)}}else{this._mergeLayoutVariants(d.dashboardLayout,L);continue}}else{d.dashboardLayout.row=this.iDummyRow;d.dashboardLayout.column=1;var f={};var C={row:d.dashboardLayout.row,col:d.dashboardLayout.column,rowSpan:d.dashboardLayout.rowSpan,colSpan:d.dashboardLayout.colSpan,maxColSpan:d.dashboardLayout.maxColSpan,noOfItems:d.dashboardLayout.noOfItems,autoSpan:d.dashboardLayout.autoSpan,showOnlyHeader:d.dashboardLayout.showOnlyHeader};f[n]=C;a.push({id:d.id,visibility:d.dashboardLayout.visible,selectedKey:d.settings.selectedKey,dashboardLayout:f});continue}}d.dashboardLayout.colSpan=d.dashboardLayout.maxColSpan;d.dashboardLayout.colSpan=d.dashboardLayout.colSpan>this.iColCount?this.iColCount:d.dashboardLayout.colSpan;r=s<this.iColCount?s+1:1;if(r+d.dashboardLayout.colSpan-1>this.iColCount){d.dashboardLayout.colSpan=this.iColCount-r+1}s=r+d.dashboardLayout.colSpan-1;d.dashboardLayout.column=r;e=0;if(Array.isArray(y)&&y.length>0&&!y[0].visibility){d.dashboardLayout.row=this.iDummyRow}else{for(t=d.dashboardLayout.column;t<d.dashboardLayout.column+d.dashboardLayout.colSpan;t++){if(i[t-1].rows>e){e=i[t-1].rows}}d.dashboardLayout.row=e+1;for(t=d.dashboardLayout.column;t<d.dashboardLayout.column+d.dashboardLayout.colSpan;t++){i[t-1].rows=e+d.dashboardLayout.rowSpan}}}this.extractCurrentLayoutVariant()};t.prototype._mergeLayoutVariants=function(a,o){if(o.rowSpan){a.rowSpan=o.rowSpan}if(o.colSpan){a.colSpan=o.colSpan}if(o.maxColSpan){a.maxColSpan=o.maxColSpan}if(o.noOfItems){a.noOfItems=o.noOfItems}if(o.hasOwnProperty("autoSpan")){a.autoSpan=o.autoSpan}if(o.row){a.row=o.row}if(o.col){a.column=o.col}if(o.hasOwnProperty("showOnlyHeader")){a.showOnlyHeader=o.showOnlyHeader}};t.prototype._sortCardsByRow=function(a){a.sort(function(a,o){if(!a.dashboardLayout&&o.dashboardLayout){return 1}else if(a.dashboardLayout&&!o.dashboardLayout){return-1}if(a.dashboardLayout.column&&a.dashboardLayout.row&&a.dashboardLayout.row===o.dashboardLayout.row){if(a.dashboardLayout.column<o.dashboardLayout.column){return-1}else if(a.dashboardLayout.column>o.dashboardLayout.column){return 1}}else if(a.dashboardLayout.row){return a.dashboardLayout.row-o.dashboardLayout.row}else{return 0}})};t.prototype.resizeCard=function(a,o,t,r){var s=this.getCardById(a);if(!s){return[]}var e=o.colSpan-s.dashboardLayout.colSpan;var d=o.rowSpan-s.dashboardLayout.rowSpan;s.dashboardLayout.showOnlyHeader=o.showOnlyHeader;if(e===0&&d===0){return{resizeCard:s,affectedCards:[]}}else if(t&&s.dashboardLayout.autoSpan){s.dashboardLayout.autoSpan=false}if(!t||d&&e===0){this._arrangeCards(s,{row:o.rowSpan,column:s.dashboardLayout.colSpan},"resize",r)}else{this._arrangeCards(s,{row:o.rowSpan,column:o.colSpan},"resize",r)}return{resizeCard:s,affectedCards:this._removeSpaceBeforeCard(r)}};t.prototype._removeSpaceBeforeCard=function(a){this._sortCardsByRow(this.aCards);var o={};for(var t=1;t<=this.iColCount;t++){o[t]=1}for(var r=0;r<this.aCards.length;r++){var s=this.aCards[r].dashboardLayout.column,e=this.aCards[r].dashboardLayout.column+this.aCards[r].dashboardLayout.colSpan-1;if(this.aCards[r].dashboardLayout.visible){if(e>this.iColCount){e=this.iColCount;var d=this.iColCount-this.aCards[r].dashboardLayout.column+1;if(a){a.push({changeType:"dragOrResize",content:{cardId:this.aCards[r].id,dashboardLayout:{colSpan:d,oldColSpan:this.aCards[r].dashboardLayout.colSpan}},isUserDependent:true})}this.aCards[r].dashboardLayout.colSpan=d}if(this.aCards[r].dashboardLayout.colSpan>1){var i=[];for(var n=s;n<=e;n++){i.push(o[n])}var u=Math.max.apply(Math,i);for(var h=s;h<=e;h++){o[h]=u+this.aCards[r].dashboardLayout.rowSpan}if(a&&u!==this.aCards[r].dashboardLayout.row){a.push({changeType:"dragOrResize",content:{cardId:this.aCards[r].id,dashboardLayout:{row:u,oldRow:this.aCards[r].dashboardLayout.row}},isUserDependent:true})}this.aCards[r].dashboardLayout.row=u}else{if(this.aCards[r].dashboardLayout.row!==o[s]){if(a){a.push({changeType:"dragOrResize",content:{cardId:this.aCards[r].id,dashboardLayout:{row:o[s],oldRow:this.aCards[r].dashboardLayout.row}},isUserDependent:true})}this.aCards[r].dashboardLayout.row=o[s]}o[s]=this.aCards[r].dashboardLayout.row+this.aCards[r].dashboardLayout.rowSpan}}}return this.aCards};t.prototype._arrangeCards=function(a,t,r,s){var e=o({},a);var d=false;if(r==="drag"&&a.dashboardLayout.column===t.column&&t.row!==a.dashboardLayout.row){d=true}this._sortCardsByRow(this.aCards);var i=[];var n=false;var u;if(r==="drag"){a.dashboardLayout.row=t.row;a.dashboardLayout.column=t.column}else if(r==="resize"){a.dashboardLayout.rowSpan=t.row;a.dashboardLayout.colSpan=t.column}i.push(a);for(var h=0;h<i.length;h++){for(var l=0;l<this.aCards.length;l++){if(i[h].id===this.aCards[l].id||!i[h].dashboardLayout.visible){continue}else{n=this._checkOverlapOfCards(i[h],this.aCards[l]);if(n===true){if(d){if(t.row<e.dashboardLayout.row&&t.row===this.aCards[l].dashboardLayout.row){i[h].dashboardLayout.row=this.aCards[l].dashboardLayout.row;u=this.aCards[l].dashboardLayout.row;this.aCards[l].dashboardLayout.row=i[h].dashboardLayout.row+i[h].dashboardLayout.rowSpan;if(s){s.push({changeType:"dragOrResize",content:{cardId:this.aCards[l].id,dashboardLayout:{row:this.aCards[l].dashboardLayout.row,oldRow:u}},isUserDependent:true})}}else if(t.row>e.dashboardLayout.row+this.aCards[l].dashboardLayout.rowSpan){u=this.aCards[l].dashboardLayout.row;this.aCards[l].dashboardLayout.row=e.dashboardLayout.row;i[h].dashboardLayout.row=this.aCards[l].dashboardLayout.row+this.aCards[l].dashboardLayout.rowSpan;i.push(i[h]);if(s){s.push({changeType:"dragOrResize",content:{cardId:this.aCards[l].id,dashboardLayout:{row:this.aCards[l].dashboardLayout.row,oldRow:u}},isUserDependent:true})}}}else{u=this.aCards[l].dashboardLayout.row;this.aCards[l].dashboardLayout.row=i[h].dashboardLayout.row+i[h].dashboardLayout.rowSpan;i.push(this.aCards[l]);if(s){s.push({changeType:"dragOrResize",content:{cardId:this.aCards[l].id,dashboardLayout:{row:this.aCards[l].dashboardLayout.row,oldRow:u}},isUserDependent:true})}}}}}}};t.prototype._checkOverlapOfCards=function(a,o){var t=a.dashboardLayout.row;var r=a.dashboardLayout.row+a.dashboardLayout.rowSpan;var s=a.dashboardLayout.column;var e=a.dashboardLayout.column+a.dashboardLayout.colSpan;var d=o.dashboardLayout.row;var i=o.dashboardLayout.row+o.dashboardLayout.rowSpan;var n=o.dashboardLayout.column;var u=o.dashboardLayout.column+o.dashboardLayout.colSpan;var h=false,l=false;if(n>=s&&n<e||u>s&&u<=e||n<=s&&u>=e){h=true}if(d>=t&&d<r||i>t&&i<=r||d<=t&&i>=r){l=true}return h&&l};t.prototype.extractCurrentLayoutVariant=function(){var a=0;var o={};var t=[];function r(a){return a.id===o.id}for(a=0;a<this.aCards.length;a++){o=this.aCards[a];t=this.oLayoutVars.filter(r);var s={};var e={row:o.dashboardLayout.row,col:o.dashboardLayout.column,rowSpan:o.dashboardLayout.rowSpan,colSpan:o.dashboardLayout.colSpan,maxColSpan:o.dashboardLayout.maxColSpan,noOfItems:o.dashboardLayout.noOfItems,autoSpan:o.dashboardLayout.autoSpan,showOnlyHeader:o.dashboardLayout.showOnlyHeader};s["C"+this.iColCount]=e;if(!(Array.isArray(t)&&t.length!==0)){this.oLayoutVars.push({id:o.id,visibility:o.dashboardLayout.visible,selectedKey:o.settings.selectedKey,dashboardLayout:s})}else{t[0].selectedKey=o.settings.selectedKey||t[0].selectedKey;t[0].dashboardLayout={};t[0].dashboardLayout["C"+this.iColCount]=e}}};t.prototype._findHighestOccupiedRow=function(){var a=0,o=[];function t(a){return a.dashboardLayout.column===s}function r(a,o,t){return a.dashboardLayout.row===Math.max.apply(Math,t.map(function(a){return a.dashboardLayout.row}))}for(var s=1;s<=this.iColCount;s++){var e=this.aCards.filter(t);if(!!e){var d=e.filter(r)[0];if(!!d){var i=d.dashboardLayout.row===undefined?0:+d.dashboardLayout.row;var n=d.dashboardLayout.rowSpan===undefined?0:+d.dashboardLayout.rowSpan;o.push(i+n)}}}a=Math.max.apply(Math,o.map(function(a){return a}));return a};t.prototype._getDefaultCardItemHeightAndCount=function(o){var t=a._setCardpropertyDensityAttribute();var r={List_condensed:{itemLength:5,itemHeight:64},List_condensed_imageSupported_cozy:{itemLength:5,itemHeight:72},List_condensed_imageSupported_compact:{itemLength:5,itemHeight:60},List_extended:{itemLength:3,itemHeight:97},List_condensed_bar:{itemLength:5,itemHeight:65},List_extended_bar:{itemLength:3,itemHeight:95},Table:{itemLength:5,itemHeight:48},Linklist:{itemLength:6,itemHeight:0}};var s={KPIHeader:{1:{1:158,2:174},2:{1:179,2:195},3:{1:201,2:223}},NormalHeader:{1:{1:82,2:98},2:{1:103,2:119},3:{1:125,2:141}}};var e=22;var d=21;var i=0;if(o){var n=o.template,u=o.settings.listType,h=o.settings.listFlavor,l=o.settings.imageSupported,y=0,p=0;if(n=="sap.ovp.cards.list"||n=="sap.ovp.cards.v4.list"){if(u=="extended"){if(h=="bar"){y=r["List_extended_bar"]["itemLength"];p=r["List_extended_bar"]["itemHeight"]}else{y=r["List_extended"]["itemLength"];p=r["List_extended"]["itemHeight"]}}else{if(h=="bar"){y=r["List_condensed_bar"]["itemLength"];p=r["List_condensed_bar"]["itemHeight"]}else{if(l==="true"){if(t==="cozy"){p=r["List_condensed_imageSupported_cozy"]["itemHeight"]}else{p=r["List_condensed_imageSupported_compact"]["itemHeight"]}}else{p=r["List_condensed"]["itemHeight"]}y=r["List_condensed"]["itemLength"]}}}else if(n=="sap.ovp.cards.table"||n=="sap.ovp.cards.v4.table"){y=r["Table"]["itemLength"];p=r["Table"]["itemHeight"]}else if(n==="sap.ovp.cards.linklist"||n.template==="sap.ovp.cards.v4.linklist"){y=r["Linklist"]["itemLength"];p=r["Linklist"]["itemHeight"]}var L=o.settings.defaultSpan&&o.settings.defaultSpan.minimumTitleRow?o.settings.defaultSpan.minimumTitleRow:1;var b=o.settings.defaultSpan&&o.settings.defaultSpan.minimumSubTitleRow?o.settings.defaultSpan.minimumSubTitleRow:1;var c=o.settings.dataPointAnnotationPath||o.settings.tabs&&o.settings.tabs[0].dataPointAnnotationPath?"KPIHeader":"NormalHeader";i=s[c][L][b];if(c==="KPIHeader"){if(o.settings.showFilterInHeader===true){i+=e}if(o.settings.showSortingInHeader===true){i+=d}}return{noOfItems:y,itemHeight:p,headerHeight:i}}};return t},true);
//# sourceMappingURL=DashboardLayoutModel.js.map