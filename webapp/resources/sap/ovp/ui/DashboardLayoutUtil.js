/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ovp/ui/DashboardLayoutRearrange","sap/ovp/ui/DashboardLayoutModel","sap/ovp/cards/CommonUtils","sap/ui/Device","sap/ui/thirdparty/jquery","sap/base/util/merge","sap/ovp/app/OVPLogger","sap/ovp/cards/jUtils","sap/ovp/ui/cardPositionHelper","sap/ui/core/Element","sap/base/i18n/Localization"],function(t,a,o,e,jQuery,s,r,i,d,n,h){"use strict";var l=new r("OVP.ui.DashboardLayoutUtil");var u=function(t){this.aCards=null;this.ROW_HEIGHT_PX=16;this.MIN_COL_WIDTH_PX=320;this.CARD_BORDER_PX=8;this.EXTRA_MARGIN=8;this.oLayoutData={layoutWidthPx:1680,contentWidthPx:1600,colCount:5,previousColCount:0,colWidthPx:this.MIN_COL_WIDTH_PX,rowHeightPx:this.ROW_HEIGHT_PX,marginPx:this.convertRemToPx(3)-this.CARD_BORDER_PX};this.dashboardLayoutModel=new a(t,this.oLayoutData.colCount,this.ROW_HEIGHT_PX,this.CARD_BORDER_PX);this.layoutDomId="";this.oLayoutCtrl={};this.componentDomId="";this.lastTriggeredColWidth=0;this.changedCards={};this.isRTLEnabled=h.getRTL();switch(true){case e.browser.webkit:this.cssVendorTransition="-webkit-transition";this.cssVendorTransform="-webkit-transform";break;case e.browser.msie:this.cssVendorTransition="-ms-transition";this.cssVendorTransform="-ms-transform";break;case e.browser.mozilla:this.cssVendorTransition="-moz-transition";this.cssVendorTransform="-moz-transform";break;default:this.cssVendorTransition="transition";this.cssVendorTransform="transform"}};u.prototype.setLayout=function(t){this.oLayoutCtrl=t;this.layoutDomId=t.getId();var a=this.layoutDomId.indexOf("---")+3;var o=this.layoutDomId.substring(0,a);var e=this.layoutDomId.substring(a);this.componentDomId=o+e.split("--")[0]};u.prototype.getDashboardLayoutModel=function(){return this.dashboardLayoutModel};u.prototype.updateCardVisibility=function(t){this.dashboardLayoutModel.updateCardVisibility(t);this.aCards=this.dashboardLayoutModel.getCards(this.oLayoutData.colCount);this.dashboardLayoutModel._removeSpaceBeforeCard();this._setCardsCssValues(this.aCards);this._positionCards(this.aCards)};u.prototype.updateLayoutData=function(t){var a=this.oLayoutData.marginPx,o=0,s=320,r=1024,i=this.CARD_BORDER_PX,d=this.EXTRA_MARGIN,n=t+a,h,l;this.oLayoutData.layoutWidthPx=t;if(n<=s){a=this.convertRemToPx(.5)-i;o=e.system.desktop?16:0}else if(n<=r){a=this.convertRemToPx(1)-i;o=e.system.desktop?8:0}else{a=this.convertRemToPx(3)-i}if(a!==this.oLayoutData.marginPx){this.oLayoutData.marginPx=a;jQuery(".sapUshellEasyScanLayout").css({"margin-left":a+"px"})}this.oLayoutData.contentWidthPx=t-a-o;this.oLayoutData.previousColCount=this.oLayoutData.colCount;this.oLayoutData.colCount=Math.round(this.oLayoutData.contentWidthPx/this.MIN_COL_WIDTH_PX);if(this.oLayoutData.colCount===0){this.oLayoutData.colCount=1}this.oLayoutData.colWidthPx=this.oLayoutData.contentWidthPx/this.oLayoutData.colCount;if(jQuery(".sapOvpDashboardDragAndDrop").length>0&&jQuery(".easyScanLayoutItemWrapper").length>0){h=jQuery(".sapOvpDashboardDragAndDrop")[0].offsetLeft+d;if(jQuery(".sapOvpDashboardDragAndDrop")[0].offsetLeft<40){l=h+8}else{l=h}}else{h=a+d;l=a+o+d}if(e.system.desktop){jQuery(".ovpWrapper .sapFDynamicPageTitle").css({"margin-left":h+"px","margin-right":l+"px"});jQuery(".ovpWrapper .sapFDynamicPageHeader").css({"margin-left":h+"px","margin-right":l+"px"})}return this.oLayoutData};u.prototype.getRearrange=function(a){var o={containerSelector:".sapUshellEasyScanLayoutInner",wrapper:".sapUshellEasyScanLayout",draggableSelector:".easyScanLayoutItemWrapper",placeHolderClass:"dashboardLayoutItemWrapper-placeHolder",cloneClass:"easyScanLayoutItemWrapperClone",moveTolerance:10,switchModeDelay:500,isTouch:!e.system.desktop,debug:false,aCards:this.aCards,layoutUtil:this,rowHeight:this.oLayoutData.rowHeightPx,colWidth:this.oLayoutData.colWidthPx};return new t(s(o,a))};u.prototype.resizeLayout=function(t){var a=this.oLayoutData.colCount;var o=false;if(this.oLayoutData.layoutWidthPx!==t&&t!==0&&Math.abs(t-this.oLayoutData.layoutWidthPx)>20){this.updateLayoutData(t);o=Math.abs(this.lastTriggeredColWidth-this.oLayoutData.colWidthPx)>this.convertRemToPx(.5);this.aCards=this.dashboardLayoutModel.getCards(this.oLayoutData.colCount);for(var e=0;e<this.aCards.length;e++){var s=this.aCards[e];this.setCardCssValues(s);var r=document.getElementById(this.getCardDomId(s.id));if(r){r.style.width=s.dashboardLayout.width;r.style.height=s.dashboardLayout.height;if(a!==this.oLayoutData.colCount){r.style[this.cssVendorTransition]="all 0.25s ease"}else{r.style[this.cssVendorTransition]=""}r.style[this.cssVendorTransform]="translate3d("+s.dashboardLayout.left+" ,"+s.dashboardLayout.top+", 0px)";this.setKpiNumericContentWidth(r)}if(a!==this.oLayoutData.colCount&&o){this._triggerCardResize(s)}}this.dashboardLayoutModel._removeSpaceBeforeCard();this.oLayoutCtrl.fireAfterDragEnds();if(o){this.lastTriggeredColWidth=this.oLayoutData.colWidthPx}this.setAriaPos()}};u.prototype.getCards=function(t){if(this.aCards&&this.oLayoutData.previousColCount===t){return this.aCards}this._setColCount(t);this.aCards=this.dashboardLayoutModel.getCards(t);this._setCardsCssValues(this.aCards);return this.aCards};u.prototype.resetToManifest=function(){this.aCards=[];this.dashboardLayoutModel.resetToManifest()};u.prototype.getCardDomId=function(t){return this.layoutDomId+"--"+t};u.prototype.getCardId=function(t){var a=t.indexOf("---")+3;var o=t.substring(a);return o?o.split("--")[2]:""};u.prototype.getCardIdFromComponent=function(t){var a=t.indexOf("---")+3;var o=t.substring(a);return o?o.split("--")[1]:""};u.prototype.isCardAutoSpan=function(t){return this.dashboardLayoutModel.getCardById(t).dashboardLayout.autoSpan};u.prototype.setAutoCardSpanHeight=function(t,a,o){var e,s,r;if(!a&&t&&t.target.parentElement){var i=t.target.parentElement.parentElement.id;var d=i.indexOf("---")+3;var n=i.substring(d);a=n.split("--")[1]}var h=o;if(!h&&t){h=t.size.height}if(this.isCardAutoSpan(a)){r=this.dashboardLayoutModel.getCardById(a);if(r.dashboardLayout.showOnlyHeader){e=Math.ceil((h+2*this.CARD_BORDER_PX)/this.getRowHeightPx())}else{e=Math.round((h+2*this.CARD_BORDER_PX)/this.getRowHeightPx())}s=this.dashboardLayoutModel.resizeCard(a,{rowSpan:e,colSpan:1},false);this._sizeCard(s.resizeCard);this._positionCards(s.affectedCards);this.setAriaPos()}};u.prototype.calculateCardProperties=function(t){var a=this._getCardController(t);var o=this.dashboardLayoutModel.getCardById(t);var e=250,s,r,d,n,h;if(a){h=a.getItemHeight(a,"ovpCardHeader");s=h===0?o.dashboardLayout.headerHeight:h;r=a.getItemHeight(a,"toolbar");if(o.template==="sap.ovp.cards.list"||o.template==="sap.ovp.cards.v4.list"){h=a.getItemHeight(a,"ovpList",true);d=h===0?o.dashboardLayout.itemHeight:h;n=s+r+d}else if(o.template==="sap.ovp.cards.table"||o.template==="sap.ovp.cards.v4.table"){d=o.dashboardLayout.itemHeight;n=s+r+2*d}else if(o.template==="sap.ovp.cards.linklist"||o.template==="sap.ovp.cards.v4.linklist"){if(o.settings.listFlavor==="carousel"){n=s+i.getOuterHeight(document.querySelector(".sapOvpCarouselContentHeader"))+240+i.getOuterHeight(document.querySelector(".sapMCrslControlsBottom.sapMCrslControls"))}else{d=a.getItemHeight(a,"ovpLinkList",true);var l=a.getView().getModel("ovpCardProperties").getProperty("/densityStyle");if(l==="cozy"){n=s+r+d+8}else{n=s+r+d+4}}}else if(o.template==="sap.ovp.cards.charts.analytical"){var u=a.getView().byId("bubbleText")?43:0;n=s+r+e+u+50}else{n=s+r}return{headerHeight:s,dropDownHeight:r,itemHeight:d,minCardHeight:n,leastHeight:s}}};u.prototype._sizeCard=function(t){if(!t){return}var a=document.getElementById(this.getCardDomId(t.id));t.dashboardLayout.width=t.dashboardLayout.colSpan*this.oLayoutData.colWidthPx+"px";t.dashboardLayout.height=t.dashboardLayout.rowSpan*this.oLayoutData.rowHeightPx+"px";if(a){a.style.height=t.dashboardLayout.height;a.style.width=t.dashboardLayout.width;this._triggerCardResize(t)}this.dashboardLayoutModel._removeSpaceBeforeCard();var o=this.dashboardLayoutModel._findHighestOccupiedRow()+32;jQuery(".sapUshellEasyScanLayoutInner").css({height:o+"px"});jQuery(".sapUshellEasyScanLayout").css({height:o+"px"})};u.prototype._triggerCardResize=function(t){var a=t.dashboardLayout,o=t.id,e=this._getCardComponentDomId(o),s=document.getElementById(e),r=this._getCardController(o),i,d,n;try{if((a.autoSpan||!a.visible)&&r){d=r.getCardItemsBinding();i=this.calculateCardProperties(o);if(d&&i){var h=d.getLength();var u=h?Math.min(h,t.dashboardLayout.noOfItems):t.dashboardLayout.noOfItems;var p=h===0?t.dashboardLayout.noOfItems:u;var y=a.rowSpan*this.ROW_HEIGHT_PX;var c=y-(i.headerHeight+2*this.CARD_BORDER_PX);if(t.template==="sap.ovp.cards.table"||t.template==="sap.ovp.cards.v4.table"){r.addColumnInTable(s,a)}else if(t.template==="sap.ovp.cards.list"||t.template==="sap.ovp.cards.v4.list"){n=p*i.itemHeight+i.dropDownHeight;s.style.height=Math.min(n,c)+t.dashboardLayout.headerHeight+"px"}}return}}catch(t){l.warning("Card auto span failed for card "+o+" and error is  "+t.toString())}a.iRowHeightPx=this.getRowHeightPx();a.iCardBorderPx=this.CARD_BORDER_PX;try{if(r){i=this.calculateCardProperties(o);r.resizeCard(a,i)}else{l.warning("OVP resize: no controller found for "+o)}}catch(t){l.warning("OVP resize: "+o+" catch "+t.toString())}};u.prototype._positionCards=function(t){if(!t){return}var a={},o=false;t.forEach(function(t){if(!t.dashboardLayout.visible){return}a=this._mapGridToPositionPx(t.dashboardLayout);t.dashboardLayout.top=a.top;t.dashboardLayout.left=a.left;var e=document.getElementById(this.getCardDomId(t.id));if(e){e.classList.remove("sapOvpNotResizableLeftRight","sapOvpNotResizableRight","sapOvpNotResizableDown");e.style[this.cssVendorTransition]="all 0.15s ease";e.style[this.cssVendorTransform]="translate3d("+a.left+" ,"+a.top+", 0px)";o=t.dashboardLayout.column+t.dashboardLayout.colSpan===this.oLayoutData.colCount+1;if(o){if(t.dashboardLayout.colSpan===1){e.classList.add("sapOvpNotResizableLeftRight")}else{e.classList.add("sapOvpNotResizableRight")}}if((t.template==="sap.ovp.cards.list"||t.template==="sap.ovp.cards.v4.list")&&t.dashboardLayout.colSpan===2||(t.template==="sap.ovp.cards.linklist"||t.template==="sap.ovp.cards.v4.linklist")&&t.settings.listFlavor==="carousel"&&t.dashboardLayout.colSpan===3){e.classList.add("sapOvpNotResizableRight")}if((t.template==="sap.ovp.cards.linklist"||t.template==="sap.ovp.cards.v4.linklist")&&t.settings.listFlavor==="carousel"&&t.dashboardLayout.rowSpan===45){e.classList.add("sapOvpNotResizableDown")}}}.bind(this))};u.prototype.updateCardSize=function(t,a,o){var e=this.dashboardLayoutModel.getCardById(t);var s=this._getCardController(t);var r=document.getElementById(this.getCardDomId(t));r.style.height=a+"px";r.style.width=o+"px";r.style[this.cssVendorTransition]="none";r.style.zIndex=10;if((e.template==="sap.ovp.cards.linklist"||e.template==="sap.ovp.cards.v4.linklist")&&e.settings.listFlavor==="carousel"){s.getView().byId("pictureCarousel").$().css("height",a-(e.dashboardLayout.headerHeight+2*this.CARD_BORDER_PX)+"px")}};u.prototype.resizeCard=function(t,a,o){this.changedCards=this.dashboardLayoutModel.resizeCard(this.getCardId(t),a,true,o);this._positionCards(this.changedCards.affectedCards)};u.prototype._mapGridToPositionPx=function(t){var a=(t.column-1)*this.getColWidthPx();var o={top:(t.row-1)*this.getRowHeightPx()+"px",left:(this.isRTLEnabled?-a:a)+"px"};return o};u.prototype._getCardComponentDomId=function(t){return this.componentDomId+"--"+t};u.prototype._getCardController=function(t){var a=null;var o=n.getElementById(this._getCardComponentDomId(t));if(o){var e=o.getComponentInstance();if(e){a=e.getAggregation("rootControl").getController()}}return a};u.prototype._setCardsCssValues=function(t){var a=0;for(a=0;a<t.length;a++){this.setCardCssValues(t[a])}};u.prototype.setCardCssValues=function(t){var a=(t.dashboardLayout.column-1)*this.oLayoutData.colWidthPx;t.dashboardLayout.top=(t.dashboardLayout.row-1)*this.oLayoutData.rowHeightPx+"px";t.dashboardLayout.width=t.dashboardLayout.colSpan*this.oLayoutData.colWidthPx+"px";t.dashboardLayout.height=t.dashboardLayout.rowSpan*this.oLayoutData.rowHeightPx+"px";t.dashboardLayout.left=(this.isRTLEnabled?-a:a)+"px"};u.prototype.convertRemToPx=function(t){var a=t;if(typeof t==="string"||t instanceof String){a=t.length>0?parseInt(t.split("rem")[0],10):0}return a*o.getPixelPerRem()};u.prototype.convertPxToRem=function(t){var a=t;if(typeof t==="string"||t instanceof String){a=t.length>0?parseFloat(t.split("px")[0],10):0}return a/o.getPixelPerRem()};u.prototype.setKpiNumericContentWidth=function(t){var a=t.getElementsByClassName("sapOvpKpiContent");if(!!a&&a.length>0){var o=a[0];var e=8;var s=16;o.style.width=this.getColWidthPx()-(2*e+2*s)+"px"}};u.prototype.getLayoutWidthPx=function(){return this.oLayoutData.colCount*this.oLayoutData.colWidthPx};u.prototype.getColWidthPx=function(){return this.oLayoutData.colWidthPx};u.prototype.getRowHeightPx=function(){return this.oLayoutData.rowHeightPx};u.prototype._setColCount=function(t){this.oLayoutData.colCount=t};u.prototype.setAriaPos=function(){var t=[];this.ariaPos={};this.aCards.forEach(function(a){if(a.dashboardLayout.visible===true){a.visited=false;if(t[a.dashboardLayout.column-1]){t[a.dashboardLayout.column-1].push(a)}else{t[a.dashboardLayout.column-1]=[a]}}});t.forEach(function(t){t.sort(function(t,a){if(t.dashboardLayout.row<a.dashboardLayout.row){return-1}else if(t.dashboardLayout.row>a.dashboardLayout.row){return 1}else{return 0}})});d.setAriaPosition(t,this)};return u},true);
//# sourceMappingURL=DashboardLayoutUtil.js.map