/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/Device","sap/ui/core/Control","sap/m/Dialog","sap/ovp/app/resources","sap/ui/events/KeyCodes","sap/base/util/uid","sap/m/Button","./ObjectStreamRenderer","sap/base/i18n/Localization","sap/ui/core/Element","sap/ui/dom/jquery/Selectors"],function(jQuery,t,e,s,a,i,r,o,n,l,p){"use strict";var c=null;var h=function(t){this.init(t)};h.prototype.init=function(t){this.objectStream=t;this.keyCodes=i;this.jqElement=t.$();var e=this;this.jqElement.on("keydown.keyboardNavigation",function(t){e.keydownHandler.call(e,t)});this.jqElement.on("focus.keyboardNavigation",".sapOvpObjectStreamItem",this.ObjectStreamFocusAccessabilityHandler)};h.prototype.destroy=function(){if(this.jqElement){this.jqElement.off(".keyboardNavigation")}delete this.jqElement;delete this.objectStream};h.prototype._scrollItemToView=function(t,e){var s=t&&t.currentTarget&&t.currentTarget.id;if(s){var a=p.getElementById(s),i=a&&a.wrapper,r=e&&e.get()&&e.get()[0];if(r&&i){var o=r.getBoundingClientRect(),n=i.getBoundingClientRect(),l=o&&o.left,c=o&&o.right,h=n&&n.left,d=n&&n.right;if(d<c||h>l){r.scrollIntoView()}}}};h.prototype._swapItemsFocus=function(t,e,s){s=s.length===1?s.get(0):s;e=e.length===1?e.get(0):e;t.preventDefault();e.setAttribute("tabindex","-1");s.setAttribute("tabindex","0");s.focus()};h.prototype.ObjectStreamFocusAccessabilityHandler=function(){var t=document.activeElement;t=jQuery(t);if(t){var e=t.find("[aria-label]");var s,a="";for(s=0;s<e.length;s++){if(e[s].getAttribute("role")=="heading"){a+=e[s].id+" "}}if(a.length){t.attr("aria-labelledby",a)}if(t.hasClass("sapOvpCardHeader")){t.closest(".sapOvpObjectStreamItem").removeAttr("aria-labelledby")}}};h.prototype.tabButtonHandler=function(t){var e=jQuery(document.activeElement);if(e.hasClass("sapOvpObjectStreamItem")){return}if(e.hasClass("sapOvpObjectStreamClose")){t.preventDefault();this.jqElement.find(".sapOvpObjectStreamItem:sapTabbable").focus();return}var s=e.closest(".sapOvpObjectStreamItem");if(!s.length){return}var a=s.find(":sapTabbable");if(a.eq(a.length-1).is(e)){t.preventDefault();this.jqElement.find("a.sapOvpObjectStreamHeader").focus()}};h.prototype.shiftTabButtonHandler=function(t){var e=jQuery(document.activeElement);if(e.hasClass("sapOvpObjectStreamItem")){t.preventDefault();this.jqElement.find(".sapOvpObjectStreamClose").focus()}if(e.hasClass("sapOvpObjectStreamClose")){t.preventDefault();this.jqElement.find("a.sapOvpObjectStreamHeader").focus()}if(e.hasClass("sapOvpObjectStreamHeader")){t.preventDefault();this.jqElement.find(".sapOvpObjectStreamItem:sapTabbable *:sapTabbable").last().focus();return}};h.prototype.enterHandler=function(t){var e=jQuery(document.activeElement);if(e.hasClass("sapOvpObjectStreamClose")){t.preventDefault();this.objectStream.getParent().close();if(c){c.focus()}return}if(e.hasClass("sapOvpObjectStreamItem")&&!e.next().length){e.children().click();return}};h.prototype.f6Handler=function(t){var e=jQuery(document.activeElement);t.preventDefault();if(e.hasClass("sapOvpObjectStreamClose")){this.jqElement.find(".sapOvpObjectStreamItem").attr("tabindex","-1").first().attr("tabindex","0").focus()}else{this.jqElement.find(".sapOvpObjectStreamClose").focus()}};h.prototype.f7Handler=function(t){var e=jQuery(document.activeElement);if(e.hasClass("sapOvpObjectStreamItem")){e.find(":sapTabbable").first().focus()}else{e.closest(".sapOvpObjectStreamItem").focus()}t.preventDefault()};h.prototype.leftRightHandler=function(t,e){var s=e?"next":"prev";var a=jQuery(document.activeElement);if(!a.hasClass("sapOvpObjectStreamItem")){return false}var i=a[s]();if(!i.length){return}this._swapItemsFocus(t,a,i);this._scrollItemToView(t,i)};h.prototype.homeEndHandler=function(t,e){var s=e?"first":"last";var a=jQuery(document.activeElement);if(!a.hasClass("sapOvpObjectStreamItem")){return false}t.preventDefault();var i=this.jqElement.find(".sapOvpObjectStreamItem")[s]();this._swapItemsFocus(t,a,i)};h.prototype.pageUpDownHandler=function(t,e){var s=e?"prev":"next";var a=jQuery(document.activeElement);if(!a.hasClass("sapOvpObjectStreamItem")){return}if(!a[s]().length){return}var i=false;var r=a;var o=window.innerWidth;while(!i){var n=r[s]();if(!n.length){i=r;break}if(!e&&n.offset().left>o){i=n;break}if(e&&n.offset().left+n.outerHeight()<=0){i=n;break}r=n}this._swapItemsFocus(t,a,i)};h.prototype.keydownHandler=function(t){switch(t.keyCode){case this.keyCodes.TAB:t.shiftKey?this.shiftTabButtonHandler(t):this.tabButtonHandler(t);break;case this.keyCodes.ENTER:case this.keyCodes.SPACE:this.enterHandler(t);break;case this.keyCodes.F6:this.f6Handler(t);break;case this.keyCodes.F7:this.f7Handler(t);break;case this.keyCodes.ARROW_UP:case this.keyCodes.ARROW_LEFT:this.leftRightHandler(t,false);break;case this.keyCodes.ARROW_DOWN:case this.keyCodes.ARROW_RIGHT:this.leftRightHandler(t,true);break;case this.keyCodes.HOME:this.homeEndHandler(t,true);break;case this.keyCodes.END:this.homeEndHandler(t,false);break;case this.keyCodes.PAGE_UP:this.pageUpDownHandler(t,true);break;case this.keyCodes.PAGE_DOWN:this.pageUpDownHandler(t,false);break;default:break}};var d=e.extend("sap.ovp.ui.ObjectStream",{metadata:{library:"sap.ovp",aggregations:{content:{type:"sap.ui.core.Control",multiple:true},placeHolder:{type:"sap.ui.core.Control",multiple:false},title:{type:"sap.ui.core.Control",multiple:false}}},renderer:n});d.prototype.init=function(){var t=this;this._closeButton=new o({icon:"sap-icon://decline",tooltip:a.getText("close"),type:"Transparent",press:function(){t.getParent().close()}}).addStyleClass("sapOvpObjectStreamClose")};d.prototype._startScroll=function(t){this._direction=t;var e=this.wrapper.scrollWidth-this.wrapper.offsetWidth-Math.abs(this.wrapper.scrollLeft);var s;if(t=="left"){s=this.rtl&&!this.scrollReverse?e:this.wrapper.scrollLeft;if(s<=0){return}this.jqRightEdge.css("opacity",1)}else{s=this.rtl&&!this.scrollReverse?Math.abs(this.wrapper.scrollLeft):e;if(s<=0){return}this.jqLeftEdge.css("opacity",1)}var a=s*3;var i=t=="left"?s:~s+1;var r=this;jQuery(this.container).one("transitionend",function(){r._mouseLeave({data:r})});this.container.style.transition="transform "+a+"ms linear";this.container.style.transform="translate("+i+"px, 0px) scale(1) translateZ(0px) "};d.prototype._mouseLeave=function(e){var s=window.getComputedStyle(e.data.container).transform;e.data.container.style.transform=s;e.data.container.style.transition="";this.rtl=l.getRTL();var a;var i=s.split(",");if(s.substr(0,8)=="matrix3d"){a=parseInt(i[12],10)}else if(s.substr(0,6)=="matrix"){a=parseInt(i[4],10)}if(isNaN(a)){return}e.data.container.style.transform="none";if(t.browser.msie){a=this.rtl?~a:a}e.data.wrapper.scrollLeft+=~a+(e.data._direction=="left"?-5:5);e.data._checkEdgesVisibility()};var f;d.prototype.debounceScrollHandler=function(){window.clearTimeout(f);var t=this;f=window.setTimeout(function(){t._checkEdgesVisibility.call(t)},150)};d.prototype._initScrollVariables=function(){var e=this.$();this.container=e.find(".sapOvpObjectStreamScroll").get(0);this.rtl=l.getRTL();this.wrapper=e.find(".sapOvpObjectStreamCont").get(0);this.scrollReverse=this.scrollReverse||this.wrapper.scrollLeft>0;this.shouldShowScrollButton=!t.system.phone&&!t.system.tablet||t.system.combi;this.jqRightEdge=e.find(".sapOvpOSEdgeRight");this.jqLeftEdge=e.find(".sapOvpOSEdgeLeft");if(this.shouldShowScrollButton){var s=this;this.jqRightEdge.add(this.jqLeftEdge).on("mouseenter.objectStream",this,this._mouseEnter).on("mouseleave.objectStream",this,this._mouseLeave);jQuery(this.wrapper).on("scroll.objectStream",function(){s.debounceScrollHandler.call(s)})}else{this.jqLeftEdge.css("display","none");this.jqRightEdge.css("display","none")}this._checkEdgesVisibility()};d.prototype._afterOpen=function(){if(t.os.ios&&this.$().length){this.$().on("touchmove.scrollFix",function(t){t.stopPropagation()})}var e=this.$().find("a.sapOvpObjectStreamHeader");e.removeAttr("aria-describedby");e.removeAttr("href");e.focus();if(this.keyboardNavigation){this.keyboardNavigation.destroy()}this.keyboardNavigation=new h(this);this._initScrollVariables();this.jqBackground=jQuery("<div id='objectStreamBackgroundId' class='objectStreamNoBackground'></div>");jQuery("#sap-ui-static").prepend(this.jqBackground);var s=this;this.jqBackground.on("click.closePopup",function(){s._oPopup.close()});jQuery(".sapUshellEasyScanLayout").addClass("bluredLayout");var a=this.$().find(".sapOvpObjectStreamItem");for(var i=0;i<a.length;i++){var r=jQuery(a[i]).find(".sapOvpActionFooter");if(r.find("button").length==0){r.attr("tabindex","-1")}}};d.prototype._beforeClose=function(){if(t.os.ios&&this.$().length){this.$().off(".scrollFix")}this.keyboardNavigation.destroy();this.jqBackground.remove();this.jqLeftEdge.add(this.jqRightEdge).add(this.wrapper).off(".objectStream");jQuery(".sapUshellEasyScanLayout").removeClass("bluredLayout");this._oPopup=undefined;if(c){c.focus()}};d.prototype._mouseEnter=function(t){var e="right";if(t.target==t.data.jqRightEdge.get(0)||t.currentTarget==t.data.jqRightEdge.get(0)){e=l.getRTL()?"left":"right"}if(t.target==t.data.jqLeftEdge.get(0)||t.currentTarget==t.data.jqLeftEdge.get(0)){e=l.getRTL()?"right":"left"}t.data._startScroll(e)};d.prototype._checkEdgesVisibility=function(){var t=this.wrapper.scrollLeft;var e=this.wrapper.scrollWidth-this.wrapper.offsetWidth-this.wrapper.scrollLeft;var s=t==0?0:1;var a=e==0?0:1;if(l.getRTL()&&this.scrollReverse){this.jqLeftEdge.css("opacity",a);this.jqRightEdge.css("opacity",s);this.jqRightEdge.css("z-index",s===0?0:1)}else{this.jqLeftEdge.css("opacity",s);this.jqRightEdge.css("opacity",a);this.jqRightEdge.css("z-index",a===0?0:1)}};d.prototype._createPopup=function(){this._oPopup=new s({showHeader:false,afterOpen:this._afterOpen.bind(this),beforeClose:this._beforeClose.bind(this),content:[this],stretch:t.system.phone}).removeStyleClass("sapUiPopupWithPadding").addStyleClass("sapOvpStackedCardPopup");this._oPopup.oPopup.setModal(false)};d.prototype.open=function(t,e){if(!this._oPopup){this._createPopup()}this._cardWidth=t;c=e;this.setCardsSize(this._cardWidth);this._oPopup.open()};d.prototype.onBeforeRendering=function(){var t=this.getBinding("content");var e=this.getPlaceHolder();if(t&&t.getLength()<=20){this.setPlaceHolder(null);if(e){e.destroy()}}};d.prototype.onAfterRendering=function(){if(!this._oPopup||!this._oPopup.isOpen()||!this.getContent().length){return}setTimeout(function(){this._initScrollVariables()}.bind(this))};d.prototype.exit=function(){if(this._oPopup){this._oPopup.destroy()}if(this.jqBackground){this.jqBackground.remove()}this._closeButton.destroy();if(this._oScroller){this._oScroller.destroy();this._oScroller=null}};d.prototype.setCardsSize=function(e){var s=parseInt(window.getComputedStyle(document.documentElement).fontSize,10);var a=t.system.phone?document.body.clientHeight/s-4.5:28.75;var i=this.getContent();i.map(function(t){t.setWidth(e+"px");t.setHeight(a+"rem")});var r=this.getPlaceHolder();if(r){r.setWidth(e+"px");r.setHeight(a+"rem")}};d.prototype.getNewContentAvailable=function(){return this.onRefreshNewContent};d.prototype.setNewContentAvailable=function(t){this.onRefreshNewContent=t};d.prototype.updateContent=function(t){var e=this.mBindingInfos["content"],s=e.binding,a=s.getContexts(e.startIndex,e.length);if(t==="change"){e.clearQuickViewCard();var i=e.factory,o=0,n=this.getContent(),l=function(t){var s=this.getId()+"-"+r(),a=i(s,t);a.setBindingContext(t,e.model);this.addContent(a)};var p=l.bind(this);if(n.length<a.length){for(o=0;o<n.length;++o){n[o].destroy()}n.length=0;this.setNewContentAvailable(true);for(o=0;o<a.length;o++){p(a[o])}}if(!this.getNewContentAvailable()){for(o=0;o<a.length;++o){n[o].setBindingContext(a[o],e.model)}}if(n.length>=a.length){for(o=0;o<n.length;++o){n[o].destroy()}n.length=a.length;this.setNewContentAvailable(true);for(o=0;o<a.length;o++){p(a[o])}}}};return d});
//# sourceMappingURL=ObjectStream.js.map