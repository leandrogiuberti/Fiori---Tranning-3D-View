/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ovp/cards/CommonUtils","sap/ui/core/ElementRegistry","sap/ui/core/Element","sap/m/MessageBox","sap/ovp/app/resources","sap/m/Dialog"],function(e,r,t,n,a,i){"use strict";var o=0;function d(){return{changeHandler:{},layers:{VENDOR:true,CUSTOMER_BASE:true,CUSTOMER:true,USER:true}}}function s(r){var t=r.getContent();var n={card:{id:e.removePrefixAndReturnLocalId(t.id),idIsLocal:true}};return n}var l={changeHandler:{applyChange:function(r,t,n){var a=e.getApp();a.appendIncomingDeltaChange(r);return},completeChangeContent:function(e,r,t){return},revertChange:function(e,r,t){return}},layers:{CUSTOMER_BASE:true,CUSTOMER:true,USER:true}};var u={changeHandler:"default",layers:{CUSTOMER_BASE:true,CUSTOMER:true,USER:true}};var g=d();var c=d();g.changeHandler.applyChange=function(e,r,t){var n=e.getContent();if(!n.card){e.setContent(s(e),true)}return f(e,r,t,false)};g.changeHandler.revertChange=function(e,r,t){return C(e,r,t,true)};g.changeHandler.completeChangeContent=function(r,t,n){var a=e.removePrefixAndReturnLocalId(t.removedElement.id);var i={card:{id:a,idIsLocal:true}};return Promise.resolve().then(function(){r.setContent(i,true)})};c.changeHandler.applyChange=function(d,l,u){var g=e.getApp();var c=r.filter(function(e){return e instanceof i});var C=c.filter(function(e){return e.getButtons()&&e.getButtons()[0].sId.includes("rta_addDialogOkButton")})[0];var v=C&&C.sId;var p=t.getElementById(v);var m=p&&p.getModel()&&p.getModel().getData().elements;var h=m&&m.filter(function(e){return e.selected});var y=l.getVisibleLayoutItems()&&l.getVisibleLayoutItems().length;var b=h&&h.length;if(b){y=y+b;y=y-o}var I=g.getAllowedNumberOfCards()&&g.getAllowedNumberOfCards().numberOfCards;var O=y>I;var A=g&&g.getAllowedNumberOfCards();var E=A&&A.errorMessage;E=a.getText("CARD_LIMIT_EXCEEDED")+" "+E;C&&C.attachAfterOpen(function(){g.bWarningDisplayedOnUnhidingCards=false;o=0});if(O){var M=g.getUIModel().getProperty("/bRTAActive");if(!g.bWarningDisplayedOnUnhidingCards&&M&&b){n.warning(E,{actions:n.Action.OK,emphasizedAction:n.Action.OK});g.bWarningDisplayedOnUnhidingCards=true}return Promise.resolve(false)}else{if(M&&b){o++}var R=d.getContent();if(!R.card){d.setContent(s(d),true)}return f(d,l,u,true)}};c.changeHandler.revertChange=function(e,r,t){return C(e,r,t,false)};c.changeHandler.completeChangeContent=function(r,t,n){var a=e.removePrefixAndReturnLocalId(t.revealedElementId);var i={card:{id:a,idIsLocal:true}};return Promise.resolve().then(function(){r.setContent(i,true)})};function C(r,t,n,a){var i=n.modifier,o=n.appComponent,d=e.getApp(),s=d.getUIModel(),l=d.getLayout(),u=o.createId(r.getRevertData().id),g=i.bySelector(r.getRevertData(),o);i.setVisible(g,a);r.resetRevertData();if(s.getProperty("/containerLayout")==="resizable"){var c=l.getDashboardLayoutUtil();c.updateCardVisibility([{id:c.getCardIdFromComponent(u),visibility:a}])}l.invalidate();return Promise.resolve(true)}function f(r,t,n,a){var i=n.modifier,o=e.getApp(),d=o&&o.getView();if(!d){throw new Error("Main view is not initialized yet.")}var s=o.getUIModel(),l=o.getLayout(),u=r.getContent(),g=n.appComponent,c=g.createId(u.card.id),C=i.bySelector(u.card,g,d);var f=o.deltaChanges.filter(function(e){return e.getSelector().id===u.card.id&&e.getChangeType()==="visibility"});if(o.aManifestOrderedCards){for(var v=0;v<o.aManifestOrderedCards.length;v++){var p=c;var m=p.indexOf("---")+3;var h=p.substring(m);if(o.aManifestOrderedCards[v].id===h.split("--")[1]){o.oView.oController.aManifestOrderedCards[v].visibility=r.getChangeType()==="hideCardContainer"?false:true}}}if((!o.aManifestOrderedCards||f.length===0)&&C){r.setRevertData(u.card);i.setVisible(C,a);if(s.getProperty("/containerLayout")==="resizable"){var y=l.getDashboardLayoutUtil();if(y.aCards){y.updateCardVisibility([{id:y.getCardIdFromComponent(c),visibility:a}])}o.appendIncomingDeltaChange(r)}if(a){var b=d.byId(c);if(!b.getComponentInstance()&&o.bFinishedCardsCreationProcess){var I=o._getCardFromManifest(o._getCardId(c));o.recreateRTAClonedCard(I)}}l.invalidate();return Promise.resolve(true)}return Promise.resolve(false)}return{HideCardContainer:g,UnhideCardContainer:c,PersonalizationDefaultConfig:l,UnhideControlConfig:u,_testOnly:{getAddedCardsPerSession:function(){return o},resetAddedCardsPerSession:function(){o=0}}}});
//# sourceMappingURL=CardChangeHandler.js.map