/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ovp/flexibility/changeHandler/CardChangeHandler","sap/ovp/flexibility/changeHandler/RemoveCardContainer","sap/ui/dt/OverlayRegistry","sap/ui/core/ComponentContainer","sap/m/MessageToast","sap/ovp/cards/rta/SettingsDialogConstants","sap/ovp/cards/SettingsUtils","sap/ovp/cards/CommonUtils","sap/ovp/app/resources","sap/base/util/merge","sap/ui/model/odata/v2/ODataModel","sap/ui/model/odata/CountMode"],function(e,t,a,o,r,n,d,s,i,l,u,g){"use strict";return{moveControls:{changeHandler:"default",layers:{CUSTOMER_BASE:true,CUSTOMER:true,USER:true}},unhideControl:e.UnhideControlConfig,unhideCardContainer:e.UnhideCardContainer,hideCardContainer:e.HideCardContainer,removeCardContainer:t,editCardSettings:{changeHandler:{applyChange:function(e,t,a){var o=s.getApp(),r=o.getView(),d=e.getContent(),i=d.newAppDescriptor,l=r.byId(i.id),u=o.getLayout(),g=u.getDashboardLayoutModel(),C=u.getDashboardLayoutUtil(),p=g.getCardById(i.id),c=C.calculateCardProperties(i.id),y=i.settings.defaultSpan&&i.settings.defaultSpan.rows,f=i.settings.defaultSpan&&i.settings.defaultSpan.cols,h=g.getColCount()+1,S=[],v=false;e.setRevertData(d.oldAppDescriptor);if(l){if(i.settings.tabs){var b=i.settings.selectedKey;if(!b||b<1){b=1}n.tabFields.forEach(function(e){var t=i.settings.tabs[b-1][e];if(e!=="entitySet"||e==="entitySet"&&t){delete i.settings[e]}if(t){i.settings[e]=t}})}if(typeof y==="number"){if(y===0){p.dashboardLayout.showOnlyHeader=true;y=Math.ceil((c.headerHeight+2*C.CARD_BORDER_PX)/C.getRowHeightPx())}else{p.dashboardLayout.showOnlyHeader=false;if(i.template==="sap.ovp.cards.list"||i.template==="sap.ovp.cards.table"){p.dashboardLayout.noOfItems=y}}}if(f){if(p.dashboardLayout.column+f>h){p.dashboardLayout.maxColSpan=f;f=h-p.dashboardLayout.column}v=true}if(v){g._arrangeCards(p,{row:y,column:f},"resize",S);g._removeSpaceBeforeCard(S);C._positionCards(g.aCards);v=false}var m=l.getComponentInstance();m.destroy()}o.recreateRTAClonedCard(i);return true},revertChange:function(e,t,a){var o=s.getApp(),r=o.getView(),n=e.getRevertData(),d=r.byId(n.id),i=o.getLayout(),l=i.getDashboardLayoutModel(),u=i.getDashboardLayoutUtil(),g=l.getCardById(n.id),C=n.settings.defaultSpan&&n.settings.defaultSpan.rowSpan,p=n.settings.defaultSpan&&n.settings.defaultSpan.colSpan,c=n.settings.defaultSpan&&n.settings.defaultSpan.showOnlyHeader,y=[];if(d){g.dashboardLayout.rowSpan=C;g.dashboardLayout.colSpan=p;g.dashboardLayout.showOnlyHeader=c;l._arrangeCards(g,{row:C,column:p},"resize",y);l._removeSpaceBeforeCard(y);u._positionCards(l.aCards);var f=d.getComponentInstance();f.destroy()}o.recreateRTAClonedCard(n);e.resetRevertData();return true},completeChangeContent:function(e,t,a){return}},layers:{CUSTOMER_BASE:true,CUSTOMER:true,USER:true}},newCardSettings:{changeHandler:{applyChange:function(e,t,n){var C=s.getApp(),p=C.getView(),c=e.getContent();e.setRevertData(c.id);var y=new o(p.getId()+"--"+c.id),f=n.appComponent,h=C.getUIModel(),S=h.getProperty("/cards"),v=C.getLayout(),b=v.getDashboardLayoutUtil(),m=v.getDashboardLayoutModel(),L=c.id.indexOf("newStaticLinkListCard_N")!==-1&&!d.checkClonedCard(c.id),R=c.id.indexOf("newKPICard_N")!==-1&&!d.checkClonedCard(c.id),D=c.id.indexOf("newCard_N")!==-1&&!d.checkClonedCard(c.id),w=d.newDataSource;if(R){var M=c.settings.selectedKPI,U=new u(M.ODataURI,{annotationURI:M.ModelURI,defaultCountMode:g.None}),_=c.model;if(c.settings["sAnnoKey"]){d.setDataSources(c.settings["sAnnoKey"],M.ModelURI)}p.setModel(U,_);f.setModel(U,_)}if(w&&!f.getModel(c.model)){var I=new u(d.newDataSourceModel.serviceURI,{annotationURI:d.newDataSourceModel.serviceAnnotationURI,defaultCountMode:g.None}),_=c.model;d.setDataSources(d.newDataSourceModel.serviceAnnotation,d.newDataSourceModel.serviceAnnotationURI);p.setModel(I,_);f.setModel(I,_)}c.settings.baseUrl=C._getBaseUrl();if(L||R||D){c.settings.newCard=true;m._setCardSpanFromDefault(c);c.dashboardLayout.row=1;c.dashboardLayout.column=1}else{c.settings.cloneCard=true}var O=-1,A;for(A=0;A<S.length;A++){if(c.id.lastIndexOf(s._getLayerNamespace()+"."+S[A].id,0)===0){O=A;var E=m.getCardById(S[A].id);c.dashboardLayout=l({},E.dashboardLayout);var T=c.dashboardLayout.column+c.dashboardLayout.colSpan;c.dashboardLayout.column=T<m.getColCount()?T:1;break}}S.splice(O+1,0,c);b.getCards().splice(O+1,0,c);h.setProperty("/cards",S);v.insertContent(y,O+1);setTimeout(function(){var e=a.getOverlay(y);e.setSelected(true);e.focus();var t=L||R||D?i.getText("OVP_KEYUSER_TOAST_MESSAGE_FOR_NEW"):i.getText("OVP_KEYUSER_TOAST_MESSAGE_FOR_CLONE");r.show(t,{duration:1e4})},0);C.recreateRTAClonedCard(c);return true},revertChange:function(e,t,a){var o=a.appComponent,r=s.getApp(),n=r.getView(),i=e.getRevertData(),l=e.getContent();var u=n.byId(i),g=r.getUIModel(),C=g.getProperty("/cards"),p=r.getLayout(),c=p.getDashboardLayoutUtil(),y=p.getDashboardLayoutModel(),f=c.getCards();var h=-1,S,v,b=-1;for(S=0;S<C.length;S++){if(i===C[S].id){h=S;break}}C.splice(h,1);for(v=0;v<f.length;v++){if(i===f[v].id){b=v;break}}f.splice(b,1);y._removeSpaceBeforeCard();g.setProperty("/cards",C);if(u){var m=u.getComponentInstance(),L=m.getComponentData(),R=L.cardId.indexOf("newKPICard_N")!==-1&&!d.checkClonedCard(i);if(R){var D=L.modelName,w=n.getModel(D);w.destroy();if(l.settings["sAnnoKey"]){d.removeDataSources(l.settings["sAnnoKey"])}n.setModel(null,D);o.setModel(null,D)}m.destroy()}p.removeContent(h);u.destroy();e.resetRevertData();return true},completeChangeContent:function(e,t,a){return}},layers:{CUSTOMER_BASE:true,CUSTOMER:true,USER:true}},dragAndDropUI:{changeHandler:{applyChange:function(e,t,a){var o=s.getApp(),r=e.getContent(),n=o.getLayout(),d=n.getDashboardLayoutUtil(),i=n.getDashboardLayoutModel(),l=i.getCardById(r.cardId),u="C"+i.getColCount(),g=[];e.setRevertData(r);i._arrangeCards(l,{row:r.dashboardLayout[u].row,column:r.dashboardLayout[u].column},"drag",g);i._removeSpaceBeforeCard(g);d._positionCards(i.aCards);return true},revertChange:function(e,t,a){var o=s.getApp(),r=e.getContent(),n=o.getLayout(),d=n.getDashboardLayoutUtil(),i=n.getDashboardLayoutModel(),l=i.getCardById(r.cardId),u="C"+i.getColCount(),g=[];i._arrangeCards(l,{row:r.dashboardLayout[u].oldRow,column:r.dashboardLayout[u].oldColumn},"drag",g);if(r.dashboardLayout[u].oldColSpan){i._arrangeCards(l,{row:r.dashboardLayout[u].rowSpan,column:r.dashboardLayout[u].oldColSpan},"resize",g)}i._removeSpaceBeforeCard(g);d._positionCards(i.aCards);e.resetRevertData();return true},completeChangeContent:function(e,t,a){return}},layers:{CUSTOMER_BASE:true,CUSTOMER:true,USER:true}},viewSwitch:e.PersonalizationDefaultConfig,visibility:e.PersonalizationDefaultConfig,dragOrResize:e.PersonalizationDefaultConfig,position:e.PersonalizationDefaultConfig}},true);
//# sourceMappingURL=DashboardLayout.flexibility.js.map