/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/fe/navigation/SelectionVariant","sap/ui/model/Filter","sap/ovp/insights/helpers/Filters","sap/ovp/app/FilterHelper","sap/base/security/encodeURL","sap/ovp/cards/CommonUtils","sap/ui/model/odata/ODataUtils","sap/ui/model/FilterProcessor","sap/ovp/cards/MetadataAnalyser","sap/ovp/handlers/SmartFilterbarHandler"],function(t,e,a,r,n,i,l,o,s,u){"use strict";var f={contentDataUrlUpdated:false,headerDataUrlUpdated:false};function v(t,e){var a=t.split(/\?/);var r=a[1]&&a[1].replace(/^.*\?/,"").split(/&/);var n="";r&&r.forEach(function(t){if(t.indexOf(e)===-1){if(n.length===0){n+=t}else{n+="&"+t}}});return a[0]+(n!==""?"?"+n:"")}function d(t,e){if(t&&e){if(t.indexOf("?")===-1){t+="?"+e}else{t+="&"+e}}return t}function p(t,e){var a=t.split(/\?/);if(a.length>1){var r=a[1].replace(/^.*\?/,"").split(/&/);var n=r.filter(function(t){return t.includes(e)});return n.length===1?n[0]:""}return""}function g(t,e,a,r){if(r){var n=a&&a._oFilterProvider;var l=n&&n._oParameterization;var o=l&&l.getNavigationPropertyToQueryResult();return{_entitySet:{value:l&&l.getName()},_urlSuffix:{value:"/"+o}}}else{var s=e&&e.getModel(),u=s&&s.getMetaModel(),f="";if(!i.isODataV4(s)){var v=u&&u.getODataEntityContainer(),d=t&&t.startsWith("/")?t.substr(1):t,p=v&&v["entitySet"];p=p.filter(function(t){return t&&t.name&&d&&d.startsWith(t.name)});f=p[0]&&p[0].name}else{f=e.oCardComponentData.settings.entitySet}var g=t.split("/").length>2?t.substring(t.lastIndexOf("/")):"";return{_entitySet:{value:f},_urlSuffix:{value:g}}}}function c(t){var e=t.cardComponentData.mainComponent;var a=t.view.getController();var r=e.getGlobalFilter();var n=a.getCardItemsBinding().getPath();var i;if(r&&r.getConsiderAnalyticalParameters()){var l=r.getAnalyticBindingPath();var o=a.getEntitySet().entityType;var f=u.getEntityType(r);if(l&&l.length>0){if(o===f){i=g(l,a,r,true);return{sPath:l,_entitySet:i._entitySet,_urlSuffix:i._urlSuffix}}}else{var v=a.getCardPropertiesModel().getProperty("/selectionAnnotationPath");var d=t.entityType[v];var p=s.resolveParameterizedEntitySet(a.getModel(),t.entitySet,d);i=g(p,a,r,false);return{sPath:p,_entitySet:i._entitySet,_urlSuffix:i._urlSuffix}}}i=g(n,a,r,false);return{sPath:"",_entitySet:i._entitySet,_urlSuffix:i._urlSuffix}}function h(t,e){var a=e.oMainComponent,r=a.getGlobalFilter(),n=r&&r.getAnalyticBindingPath();var l=e.getModel();var o=l.getMetaModel();if(!i.isODataV4(l)){var s=e.getEntityType().name;var f=o.getODataEntityContainer();var v=f.entitySet.filter(function(t){return t.entityType===f.namespace+"."+s});var d=v.length>0?v[0]:{}}else{var s=e.oCardComponentData.settings.entitySet;var f=o.getObject("/");var d=f[s];d.entityType=d.$Type}if(r&&r.getConsiderAnalyticalParameters()){var n=r.getAnalyticBindingPath();var p,g,c;if(n&&n.length>0){if(d.entityType===u.getEntityType(r)){g=t;p=t.indexOf("$");if(p>0){g=t.substring(0,p-1)}c=n;if(c.startsWith("/")){c=c.slice(1)}if(g!==c){t=t.replace(g,c)}}else{var h=a._getParametersFromEntityPath(t);var m=a._getParametersFromEntityPath(n);var y,_,U;var D={};if(h&&h.length>0){var S=a._getEntityTypeFromPath(l,t,D.context,true);for(var P=0;P<m.length;P++){y=a._getPropertyMapping(h,m[P].name,S.name,u.getEntityType(r),l,r.getModel());if(y){_=y+"=.*?[,)]";U=t.match(new RegExp(_));if(U&&U.length>0){g=U[0].slice(0,-1);c=y+"="+m[P].sValue;if(g!==c){t=t.replace(g,c)}}}}}}}}return t}function m(t,e,a,r){var i=t.view.getModel("ovpCardProperties");var l=i&&i.getProperty("/bInsightRTEnabled");var o="";if(l||r){o+=D(t)}else{o+=y(t,e)}var s=p(a,"$filter");if(s.length>0){s=decodeURIComponent(s);s=s.replace("$filter=","");s=!s.startsWith("(")?"("+s+")":s}if(o.length>0&&s.length>0){o=!o.startsWith("(")?"("+o+")":o;o+=" and "}o+=s;if(o.length!==0){return"$filter="+n(o)}return""}function y(r,n){var i=r.cardComponentData.mainComponent;var l=i.getGlobalFilter();var o=l&&l.getUiState();var s=l&&l.determineMandatoryFilterItems();var u=n.parameters._mandatoryODataFilters.value;var f=new t(o&&o.getSelectionVariant());if(!s||s.length===0||(!u||u.length===0)){return""}else{var v=[];for(var d=0;d<u.length;d++){var p=u[d];var g=f.getSelectOption(p);var c=new e(g);var h=c.aFilters&&c.aFilters.length||0;var m=[];for(var y=0;y<h;y++){var _=c.aFilters[y];var U=a.getSingleFilterValue(_,p);if(U.length>0){m.push(U)}}if(m.length>0){var D=m.join(" or ");D="("+D+")";v.push(D)}}return v.length>0?v.join(" and "):""}}function _(t,e){t&&t.forEach(function(t){if(t&&t.getFilters()){_(t.getFilters(),e)}else if(t&&t.getPath()&&e.indexOf(t.getPath())===-1){e.push(t.getPath())}});return e}function U(t,e){if(t&&e){var a=t&&t.property.filter(function(t){return e.indexOf(t.name)>-1})||[];a.forEach(function(t){var e=t.type||"";if(!e.startsWith("Edm")){t.type="Edm."+t.type}})}}function D(t){var e=t.view;var a=e.getController();var n=a.getEntityType(),i=a.oMainComponent.getGlobalFilter(),s=i&&i.getModel(),u=a.getView().getModel("ovpCardProperties"),f=u&&u.getProperty("/entityType"),v=f&&f.name,d=a.oMainComponent.aFilters;if(n&&s&&v){var p=r.getEntityRelevantFilters(n,d,v,s);if(p.length){var g=o.groupFilters(p),c=_(p,[]),h=e&&e.getModel()&&e.getModel().oMetadata;U(n,c);var m=l.createFilterParams(g,h,n);if(m.length){m=m.replace("$filter=","");m=decodeURIComponent(m);return m}return""}}return""}function S(t,e,a,r){var n=t.view;if(!n){return{}}var l=t.cardComponentData.model.sServiceUrl;var o=n.getController();var s=a?o.getKPIBinding():o.getCardItemsBinding();var u=s&&s.sRangeParams||"";if(t.cardComponentName==="List"||t.cardComponentName==="Table"){u="$skip=0&$top=13"}var f=c(t);var g=s&&s.getDownloadUrl()||"";var y;if(g){g=v(g,"sap-client");g=v(g,"_requestFrom");if(!i.isODataV4(n.getModel())){g=g.split(l+"/")[1]}else{g=g.split(l)[1]}g=h(g,o);y=m(t,e,g,r);if(y.length>0){g=v(g,"$filter");g=d(g,y)}var _=p(g,"$inlinecount");if(_.length===0&&(t.cardComponentName==="List"||t.cardComponentName==="Table")&&!i.isODataV4(n.getModel())){var U="$inlinecount=allpages";g=d(g,U)}if(u){g=d(g,u)}}return{sPath:g,_entitySet:f._entitySet,_urlSuffix:f._urlSuffix}}function P(t,e,a){if(!f.headerDataUrlUpdated){var r=this._getRequestUrlAndEntityInfo(t,e,true,a);e["parameters"]["_headerDataUrl"]={value:r.sPath}}if(!f.contentDataUrlUpdated){var n=this._getRequestUrlAndEntityInfo(t,e,false,a)||"";e["parameters"]["_contentDataUrl"]={value:n.sPath}}f.contentDataUrlUpdated=false;f.headerDataUrlUpdated=false}function C(t,e){var a=t.cardComponentData.settings,r=t.entitySet.name||a.entitySet,n={};if(r.endsWith("Results")){r=r.replace("Results","")}if(a.dataPointAnnotationPath||a.kpiAnnotationPath){var i=this._getRequestUrlAndEntityInfo(t,e,true)||"";e["parameters"]["_headerDataUrl"]={value:i.sPath};if(i.sPath){n.header={method:"GET",url:i.sPath,headers:{Accept:"application/json","Accept-Language":"{{parameters.LOCALE}}"},retryAfter:30}}}var l=this._getRequestUrlAndEntityInfo(t,e,false)||"";e["parameters"]["_contentDataUrl"]={value:l.sPath};if(l.sPath){n.content={method:"GET",url:l.sPath,headers:{Accept:"application/json","Accept-Language":"{{parameters.LOCALE}}"}}}if(l._entitySet||l._urlSuffix){e["parameters"]["_entitySet"]=l._entitySet;e["parameters"]["_urlSuffix"]=l._urlSuffix}return n}function F(t){var e=t.configuration.parameters;var a=e._mandatoryODataParameters.value;var r=e._mandatoryODataFilters.value;var n=r.some(function(t){var a=e[t]&&e[t].value;var r=true;if(a&&i.isJSONData(a)){a=JSON.parse(a);var n=a&&a["SelectOptions"];n.forEach(function(t){if(t&&t["Ranges"]&&t["Ranges"].length>0){r=false}});return r}return false});var l=a.some(function(t){return e[t]&&!e[t].value});if(n||l){if(!e._headerDataUrl){e._headerDataUrl={value:""}}if(!e._contentDataUrl){e._contentDataUrl={value:""}}e._headerDataUrl.value="";e._contentDataUrl.value="";f.headerDataUrlUpdated=true;f.contentDataUrlUpdated=true}}function E(t){var e=t&&t.data&&t.data.request,a=t&&t.configuration.parameters._headerDataUrl,r=t&&t.configuration.parameters._contentDataUrl,n=t.configuration.parameters._semanticDateRangeSetting;if(e&&e.batch&&n){var i=e.batch.header||{},l=e.batch.content||{};i.url="{= extension.formatters.formatHeaderDataUrlForSemanticDate() }";a.value="";l.url="{= extension.formatters.formatContentDataUrlForSemanticDate() }";r.value="";f.headerDataUrlUpdated=true;f.contentDataUrlUpdated=true}else if(e&&e.url&&n){e.url="{= extension.formatters.formatContentDataUrlForSemanticDate() }";r.value="";f.contentDataUrlUpdated=true}}function O(t,e){if(!i.isODataV4(e)){return t}else{return t.replace("d/results","value")}}function x(t,e){if(!i.isODataV4(e)){return t}else{return t.replace("d/__count","@odata.count")}}return{_getQueryParam:p,_removeQueryParam:v,_getRequestUrlAndEntityInfo:S,getBatchObject:C,enhanceHeaderAndContentURL:F,updateBatchObject:P,enhanceHeaderAndContentURLForSemanticDate:E,getBatchRequestPath:O,getBatchResultCount:x}},true);
//# sourceMappingURL=Batch.js.map