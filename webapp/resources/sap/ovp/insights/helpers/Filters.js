/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ovp/cards/MetadataAnalyser","sap/ovp/cards/CommonUtils","sap/fe/navigation/SelectionVariant","sap/ovp/insights/helpers/i18n","sap/m/DynamicDateUtil","sap/ui/core/Element"],function(e,t,a,r,n,i){"use strict";var o={};function l(){o={}}function s(e){if(e){if(e.hasOwnProperty("SelectionVariantID")){delete e.SelectionVariantID}else if(e.hasOwnProperty("PresentationVariantID")){delete e.PresentationVariantID}delete e.Text;delete e.ODataFilterExpression;delete e.Version;delete e.FilterContextUrl;delete e.ParameterContextUrl;return e}return e}function u(e,t,a){var r;e.forEach(function(e){r=e&&e.Ranges;t.massAddSelectOption(a,r)})}function f(e){var r,n,i;var o=0;for(var l in e){var f=new a;if(e.hasOwnProperty(l)&&e[l]){r=e[l].value;if(r&&typeof r==="string"&&t.isJSONData(r)){r=JSON.parse(r);if(typeof r!=="object"){e[l].value=r.toString();continue}n=r.SelectOptions&&r.SelectOptions[0];if(n&&n.Ranges&&n.Ranges.length===1){i=n.Ranges[0]||{};if(i.Option==="EQ"&&!i.Low){n.Ranges=[];e[l].value=JSON.stringify(r)}}}else if(r&&Array.isArray(r)){var c,g;for(o=0;o<r.length;o++){c=JSON.parse(r[o]);g=c&&c.SelectOptions||[];u(g,f,l)}f=s(f&&f.toJSONObject());e[l].value=JSON.stringify(f)}}}}function c(e,t){var a,r="";t&&t.getAllFiltersWithValues().filter(function(n){a=n.getName();if(a.includes(e)||a===e){r=t&&t.getFilterData()&&t.getFilterData()[a]||""}});return r}function g(t,a,r,n){var i=t.getMetaModel().getODataEntityType(a.entityType)||{};var o=n.view.getModel("ovpCardProperties");var l=i[o.getProperty("/selectionAnnotationPath")]||{};var s=o.getProperty("/parameters")||[];var u=n.cardComponentData.mainComponent.oGlobalFilter;var f=[];var c=e.checkAnalyticalParameterisedEntitySet(t,a.name);if(c){f=e.resolveAnalyticalParameterizedEntitySet(t,a,l,s,u,true)||[]}else{var g=e.getParametersByEntitySet(t,a.name);if(g&&g.entitySetName){f=e.getPropertyOfEntitySet(t,g.entitySetName)||[]}}return f.filter(function(e){return e&&e.name===r})}function p(e,t,a,r){if(a){var n=g(e,t,a,r)||[],i=n[0]||{},o=i["com.sap.vocabularies.Common.v1.FilterDefaultValue"]||{},l=Object.keys(o)||[];return o[l[0]]||i.defaultValue}}function v(e,t){var a=t&&t.getFilterData();return a&&(a["$Parameter."+e]||a[e])||""}function m(e,t,a){if(e){var r=t&&t.property&&t.property.filter(function(t){return t&&t.name===e})||[];if(!r.length){r=a&&a.property&&a.property.filter(function(t){return t&&t.name===e})}}var n=r&&r.length?r[0]:{};var i=n&&n["com.sap.vocabularies.Common.v1.FilterDefaultValue"]||{};var o=Object.keys(i);return n&&(o&&o.length&&i[o[0]]||n.defaultValue)}function d(e){var a;var r=[];if(e&&Array.isArray(e)){e.forEach(function(e){if(e){a=s(JSON.parse(e));r.push(JSON.stringify(a))}});return r}else if(e&&t.isJSONData(e)){a=s(JSON.parse(e));return JSON.stringify(a)}}function S(e){var t="";if(!e){return null}if(e.type){t=e.type.startsWith("Edm.")?e.type.split("Edm.")[1]:e.type}var a={Boolean:"boolean",Byte:"integer",SByte:"integer",Int16:"integer",Int32:"integer",Int64:"number",Single:"number",Double:"number",Float:"number",Decimal:"number",Guid:"string",String:"string",Date:"date",DateTime:"datetime",DateTimeOffset:"datetime",Time:"datetime",Binary:"",Stream:"",TimeOfDay:"",Duration:""};if(t&&t==="string"){return t}else if(t&&a[t]){return a[t]}else{return"string"}}function y(e){var t=[];var a=e&&e.RequestAtLeast||undefined;if(a){for(var r=0;r<a.length;r++){if(a[r].PropertyPath){t.push(a[r].PropertyPath)}}}return t}function T(e,t,a,r){var n="";if(Array.isArray(t)){t.filter(function(t){if(t&&t.includes(e.Low)){n=t}})}else if(typeof t==="string"){n=t}if(!n&&e.Low&&e.High){var i=a&&a.getFilterData()||{},o=i[r]||{};if(o.ranges){var l=o.ranges||[];var s=l.filter(function(t){return t.value1===e.Low});var u=s[0]||{};n=u.tokenText||""}}return n}function O(e,t,a,r){var n=e&&e.getUiState(),i=n&&n.getSelectionVariant(),o=i&&i.SelectOptions||[],l=false;o.filter(function(e){return e&&e["PropertyName"]===t}).map(function(n){l=true;var i=n&&n.Ranges||[];i.forEach(function(n){var i=T(n,r,e,t);a.addSelectOption(t,n.Sign,n.Option,n.Low,n.High,i)})});if(!l){a.addSelectOption(t,"I","EQ","")}}function E(e,t){var a;var r=/'/g;switch(e.Option){case"BT":a=t+" ge "+"'"+e.Low.replace(r,"''")+"'"+" and "+t+" le "+"'"+e.High.replace(r,"''")+"'";break;case"NB":a=t+" lt "+"'"+e.Low.replace(r,"''")+"'"+" or "+t+" gt "+"'"+e.High.replace(r,"''")+"'";break;case"EQ":case"GE":case"GT":case"LE":case"LT":case"NE":a=t+" "+e.Option.toLowerCase()+" "+"'"+e.Low.replace(r,"''")+"'";break;case"Contains":case"EndsWith":case"NotContains":case"NotEndsWith":case"NotStartsWith":case"StartsWith":a=e.Option.toLowerCase().replace("not","not ")+"("+t+","+"'"+e.Low.replace(r,"''")+"'"+")";break;default:throw new Error("Unsupported operator: "+e.Option)}return a}function D(e){var t=e&&e.cardComponentData,a=t&&t.appComponent,r=a&&a.ovpConfig,n=r&&r.datePropertiesSettings;if(n){return n}}function A(e,t){if(e&&t){var a=t.getAllFilterItems()||[];return a.filter(function(t){var a=t&&t.getProperty("name");return a==="$Parameter."+e||a===e})[0]}}function R(e,t){if(t&&!e["sap:filter-restriction"]){var a=["DATE","YESTERDAY","TODAY","TOMORROW","FIRSTDAYWEEK","LASTDAYWEEK","FIRSTDAYMONTH","LASTDAYMONTH","FIRSTDAYQUARTER","LASTDAYQUARTER","FIRSTDAYYEAR","LASTDAYYEAR"],r=n.getAllOptionKeys(),i=r.filter(function(e){return a.indexOf(e)===-1}),o=t.getStandardOptions(),l=o.some(function(e){return i.indexOf(e)>-1});e["_filterRestriction"]=l?"interval":"single-value"}}function h(e,t){var a=false;if(e&&t){var r=e.cardComponentData.mainComponent.oGlobalFilter,n=t.name,i=A(n,r),o=i&&i.getControl(),a=o&&o.getMetadata()&&o.getMetadata().getName()==="sap.m.DynamicDateRange";if(a){R(t,o)}}return a}function P(e){var t=D(e);var a=t&&Object.keys(t);if(a&&a.length){a.forEach(function(e){if(o[e]){var a=t[e]&&Object.keys(t[e])||[];a.forEach(function(a){if(a&&a!=="defaultValue"&&a!=="customDateRangeImplementation"){o[e][a]=t[e][a]}})}})}return o}function C(e,t){if(t){o[e.name]={"sap:filter-restriction":"single-value"}}else{o[e.name]={"sap:filter-restriction":e["sap:filter-restriction"]||e["_filterRestriction"]}}}function b(e,t){var a=D(e);if(a&&a[t]&&a[t]["defaultValue"]){return a[t]["defaultValue"]["operation"]}else{var r=e.cardComponentData.appComponent.getManifestObject().getRawJson();var n=r&&r["sap.ovp"];var i=n&&n.filterSettings&&n.filterSettings.dateSettings&&n.filterSettings.dateSettings.fields;return i&&i[t]&&i[t]["defaultValue"]&&i[t]["defaultValue"]["operation"]}}function N(e,t){var a=e&&e.getUiState(),r=a&&a.getSelectionVariant(),n=r&&r.SelectOptions||[];var i=n.filter(function(e){return e&&e["PropertyName"]===t});i=i&&i[0]||[];var o=i.Ranges||[];return o&&o[0]}function I(e){var t=["DATE","DATETIME"];return t.indexOf(e)>-1}function L(e){if(e){var t=e.conditionTypeInfo,a=t&&t.data;if(I(a.operation)&&a.value1){return JSON.stringify(a.value1)}return a.operation}}function V(e,t,a){var r=v(e.name,t);var n=r&&r.conditionTypeInfo;var i=n&&n.data&&n.data["operation"];var o=r&&r["ranges"];var l=o&&o[0];if(i){switch(i){case"DATE":case"DATERANGE":case"SPECIFICMONTH":case"FROM":case"TO":case"DATETIME":case"DATETIMERANGE":case"FROMDATETIME":case"TODATETIME":var s=T({Low:l.Low},a,t,e.name);var u=N(t,e.name);if(u){u.Text=s;return u}break;case"LASTDAYS":case"LASTWEEKS":case"LASTMONTHS":case"LASTQUARTERS":case"LASTYEARS":case"NEXTDAYS":case"NEXTWEEKS":case"NEXTMONTHS":case"NEXTQUARTERS":case"NEXTYEARS":var f=n&&n.data&&n.data.value1;var s=T({Low:f},a,t,e.name);return{Low:i,High:f.toString(),Option:"BT",Text:s};case"TODAYFROMTO":var c=n&&n.data&&n.data.value1;var g=n&&n.data&&n.data.value2;var s=T({Low:c},a,t,e.name);return{Low:i,High:c.toString()+","+g.toString(),Option:"BT",Text:s};default:var s=T({Low:i},a,t,e.name)||"";s=s.substring(0,s.indexOf("(")-1);return{Low:i,High:null,Option:"EQ",Text:s}}}}function w(e,t){var a=t.cardComponentData.mainComponent.oGlobalFilter;var r=A(e,a);var n=r&&r.getControl();var i=n&&n.getValue();var o=n&&n.getMetadata()&&n.getMetadata().getName()==="sap.m.DynamicDateRange";var l=t.view.getModel("ovpCardProperties");var s=l&&l.getProperty("/bInsightRTEnabled");if(i&&o&&s){return JSON.stringify(i)}else{var u=b(t,e)||"";return JSON.stringify({operator:u,values:[]})}}function F(e,t,a,r,n){var i=e.view.getModel("ovpCardProperties"),o=i&&i.getProperty("/bInsightRTEnabled"),l=e.cardComponentData.mainComponent.oGlobalFilter,s=b(e,t.name)||a;if(o){var u=V(t,l,n);if(u){r.addSelectOption(t.name,"I",u.Option,u.Low,u.High,u.Text)}else{r.addSelectOption(t.name,"I","EQ","",null,"")}}else if(s){r.addSelectOption(t.name,"I","EQ",s,null,s)}else{r.addSelectOption(t.name,"I","EQ","",null,"")}}function M(e,t){if(t&&e){var a=t.getFiltersWithValues()||[],r="",n=a.filter(function(t){r=t&&t.getName();return r===e||"$Parameter."+e===r});var o=n&&n[0]&&n[0].getControl();if(o&&o.getMetadata()&&o.getMetadata().getName()==="sap.m.DynamicDateRange"){var l=o.getIdForLabel()||"";l=l.substring(0,l.lastIndexOf("-"));if(l){var s=i.getElementById(l);return s&&s.getValue()}}else if(o&&o.getProperty("value")){return o.getProperty("value")}else if(o&&typeof o.getTokens==="function"){var u=o.getTokens()||[],f=u.map(function(e){return e.getText()});return{type:"filters",value:f}}}}function x(e,t,a,n,i,o){var l=M(e,t);var s=n.view.getModel("ovpCardProperties");var u=s&&s.getProperty("/bInsightRTEnabled");if(l&&typeof l==="string"&&(u||i)){if(!a[e]){a[e]={}}a[e]["label"]=l;if(i&&!u){var f="configuration.parameters."+e+".label",c=n.cardComponentData.cardId,g=c+"_configuration_parameters_"+e+"_label";r.seti18nValueToMap(f,"{{"+g+"}}",true);l=o?i:l;r.inserti18nPayLoad(c,g,l,"Label","Configuration Parameter label")}return l}else if(l&&l.value&&l.type==="filters"){return l.value}}function Y(e,t){var a=e.cardComponentData.mainComponent.oGlobalFilter;if(a&&a.getConsiderAnalyticalParameters()){var r=e.view.getController().getCardItemsBinding(),n=r&&r.getPath()||"",i=a.getAnalyticalParameters()||[];i.forEach(function(e){var a=t.some(function(t){return t.name===e.name});if(!a&&n.indexOf(e.name)>-1){t.push(e)}})}}return{enhanceVariant:d,updateRangeValue:f,getPropertyType:S,getParameterValue:c,getRequestAtLeastFields:y,getFilterDefaultValue:m,getParameterDefaultValue:p,addFiltervalues:O,getParameterActualValue:v,removeExtraInfoVariant:s,getSingleFilterValue:E,getSemanticDateConfiguration:P,IsSemanticDateRangeValid:h,getDateRangeValueForParameters:L,getDateRangeControlValue:w,getDateOperationValue:I,getLabelForConfigParams:x,getRelatedTextToRange:T,setFilterRestrictionToSemanticDateRange:C,addDateRangeValueToSV:F,getDateRangeDefaultValue:b,resetSemanticDateRangeConfig:l,handleConsiderAnalyticalParameters:Y}});
//# sourceMappingURL=Filters.js.map