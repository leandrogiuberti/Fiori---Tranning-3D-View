/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 * Any function that needs to be exported(used outside this file) via namespace should be defined as
 * a function and then added to the return statement at the end of this file
 */
sap.ui.define(["sap/ovp/cards/CommonUtils","sap/ui/model/odata/v4/AnnotationHelper","sap/ovp/cards/MetadataAnalyser","sap/ovp/helpers/V4/MetadataAnalyzer","sap/ovp/cards/AnnotationHelper","sap/ovp/cards/Filterhelper","sap/ui/core/format/DateFormat"],function(e,t,a,r,i,n,o){"use strict";var l={TEXT:"com.sap.vocabularies.Common.v1.Text",TEXT_ARRANGEMENT:"com.sap.vocabularies.UI.v1.TextArrangement",UOM:"Org.OData.Measures.V1.Unit",ISO_CURRENCY:"Org.OData.Measures.V1.ISOCurrency"};var u={TEXT_LAST:"com.sap.vocabularies.UI.v1.TextArrangementType/TextLast",TEXT_FIRST:"com.sap.vocabularies.UI.v1.TextArrangementType/TextFirst",TEXT_ONLY:"com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly",TEXT_SEPARATE:"com.sap.vocabularies.UI.v1.TextArrangementType/TextSeparate"};function g(e,t,a){var r=i.getSortedDataFields(e,t)[a];if(r){return p(e,r)}return""}function c(e,t,a,r){var n=i.getSortedDataPoints(e,t)[a];if(!n){return""}var o=e.getSetting("ovpCardProperties");var l=o.getProperty("/entityType");var u=o.getProperty("/metaModel");return s(e,n,l,u,r)}function s(e,t,a,r,i){if(!t||!t.Value){return""}var n=e.getSetting("ovpCardProperties");var o=false;if(n){var u=n.getProperty("/ignoreSapText");o=u==undefined?o:u}var g=r.getData()["$Annotations"][a.$Type+"/"+t.Value.$Path];var c=false;if(o==true){if(g&&(g["@com.sap.vocabularies.Analytics.v1.Measure"]||g["sap:aggregation-role"]=="measure")){c=true}}if(!c&&g){var s;if(g[l.TEXT]){s=g[l.TEXT]?g[l.TEXT]:g[l.TEXT].$Path}else if(g["sap:text"]){s=g["sap:text"]}if(s){t={Value:{$Path:s}}}}return p(e,t,i)}function f(){var e=arguments[arguments.length-1],t=arguments[0];var a=this.mBindingInfos;var r=o.getInstance(e.dateFormat);if(!t){t="";return t}else if(a&&a.text&&a.text.binding){t=a.text.binding.getRawValue()[0]}return r.format(new Date(t),e.bUTC)}function p(e,a,r,i){if(a.Value.Apply){return t.format(e,a.Value)}var n=e.getSetting("ovpCardProperties");var o=n.getProperty("/entityType");var l=n.getProperty("/metaModel");return h(e,a,o,l,r,i)}p.requiresIContext=true;function v(e,a,r,i){var e=!e.getPath()?e.getInterface(0):e;if(!r||typeof i!=="string"){return i}var n=r.annotations&&r.annotations["@"+l.TEXT]||r["@"+l.TEXT];var o=[];var g=false;var c=a&&a.$NavigationPropertyBinding?true:false;if(c){o=Object.keys(a.$NavigationPropertyBinding);g=o&&o.indexOf(n&&n.$Path&&n.$Path.split("/")[0])===-1}if(!n||g){return i}var s,f;var p="@"+l.TEXT+"@"+l.TEXT_ARRANGEMENT;s=r.annotations&&r.annotations[p]||r[p];f=s&&s.$EnumMember;if(!f){s=n&&n["@"+l.TEXT_ARRANGEMENT];f=s&&s.$EnumMember}if(!f){s=a&&a[l.TEXT_ARRANGEMENT];f=s&&s.$EnumMember}var v=t.format(n,{context:e});if(!v||v===" "){return i}if(!f){return i+" ("+v+")"}var h;switch(f){case u.TEXT_FIRST:h=v+" ("+i+")";break;case u.TEXT_LAST:h=i+" ("+v+")";break;case u.TEXT_ONLY:h=v;break;case u.TEXT_SEPARATE:h=i+" ("+v+")";break;default:h=i;break}return h}function h(e,a,n,o,u,g,c){if(a.Value.Apply){return t.format(e,a.Value)}var s=a.Value.$Path||a.Value.String;var f=i._getEntityTypeForODataV4Model(o,n,s),p="",h,y;var m=e.getSetting("ovpCardProperties");var P=m&&m.getProperty("/contentFragment");if(!g){if(a.Value.$Path&&a.Value.$Path.split("/").length>1){f=i._getNavigationSuffix(o,n,a.Value.$Path,e)}if(!f){return""}if(f.$Type==="Edm.DateTime"||f.$Type==="Edm.DateTimeOffset"){var C={relative:true,relativeScale:"auto"},T=m&&m.getProperty("/showDateInRelativeFormat");if(T!==undefined&&!T){C={style:"medium"}}y={dateFormat:C,bUTC:f.$Type==="Edm.DateTime"?true:false};h="CardAnnotationhelperV4.formatDate";p=i._generatePathForField([a.Value.$Path||s.split("/")[s.split("/").length-1]],h,y,"String",true)}else if(a.ValueFormat&&a.ValueFormat.NumberOfFractionalDigits>=0||f["scale"]){var d=a.ValueFormat&&a.ValueFormat.NumberOfFractionalDigits||0,$=a.ValueFormat&&a.ValueFormat.ScaleFactor&&a.ValueFormat.ScaleFactor.$Decimal,V;if(f&&f["@"+l.ISO_CURRENCY]){V=f["@"+l.ISO_CURRENCY].$Path||f["@"+l.ISO_CURRENCY]}else if(f&&f["@"+l.UOM]){V=f["@"+l.UOM].$Path||f["@"+l.UOM]}else if(f&&f["@sap:unit"]){V=f["@sap:unit"]}var O=r.getODataPropertyFromV4Metadata(o,n.$Type,V),A=[a.Value.$Path||s.split("/")[s.split("/").length-1]];if(d>2){d=2}y={numberOfFractionalDigits:d,scaleFactor:$,bODataV4:i.isODataV4Context(e)};if(f&&f["@"+l.ISO_CURRENCY]){var x=f["@"+l.ISO_CURRENCY];if(x.$Path){h="CardAnnotationhelper.formatCurrency";A.push(x.$Path)}else if(x.String){y.currencyString=x.String;h="CardAnnotationhelper.formatCurrency"}}else if(O&&(O[l.ISO_CURRENCY]||O["sap:semantics"]==="currency-code")){h="CardAnnotationhelper.formatCurrency";A.push(V)}else{h="CardAnnotationhelper.formatNumberCalculation"}y.functionName=h;p=i._generatePathForField(A,h,y)}else{if(c){p=t.format(a.Value,{context:e})}else{var E=t.format(a.Value,e.getModel()?{context:e}:{context:e.getInterface(0)});var R=E.split(",");var D=[];if(R.length>1){for(var S=0;S<R.length;S++){if(R[S].indexOf("path:")>=0||R[S].indexOf("type:")>=0){D.push(R[S])}}if(D.length>0){p=p+D.join(",");if(p.substring(p.length-1)!=="}"){p=p+"}"}}}else{p=E}}}if(P){p=v(e,n,f,p)}if(f&&f["@"+l.UOM]){var F=f["@"+l.UOM];if(F.$Path){p+=" "+i._generatePathForField([F.$Path]);p+=" "+i.getSapTextPathForUOM(F.$Path,o,n,e)}else if(F){if(F!=="%"){p+=" "}p+=F}}}if(!u){if(f&&f["@"+l.ISO_CURRENCY]){var x=f["@"+l.ISO_CURRENCY];if(x){if(x.$Path){p+=" "+i._generatePathForField([x.$Path])}else{p+=" "+x}p+=" "+i.getSapTextPathForUOM(x.$Path,o,n,e)}}}if(p[0]===" "){p=p.substring(1)}p=p.replace("\\","");p=p.replace("\\","");p=p.replace("Unsupported: ","");p=p.replace("$P","p");return p}function y(e,t){var r=e.getSetting("ovpCardProperties");var o=r.getProperty("/metaModel");var l=o.getData();var u=t;var g,c,s,f;if(r.getProperty("/selectionAnnotationPath")){g="@"+r.getProperty("/selectionAnnotationPath");c=l["$Annotations"][u.$Type][g]}if(r.getProperty("/presentationAnnotationPath")){s=r.getProperty("/presentationAnnotationPath");s="@"+s;f=l["$Annotations"][u.$Type][s]}var p="/"+r.getProperty("/entitySet");var v=Array.prototype.slice.call(arguments,2);var h=e.getSetting("ovpCardProperties"),y=h.getProperty("/parameters");if(c||!!y){if(c&&c.Parameters&&c.Parameters.length>0||!!y){p=a.resolveParameterizedEntitySet(e.getSetting("dataModel"),t,c,y)}}if(r.getProperty("/cardLayout")&&r.getProperty("/cardLayout/noOfItems")){var P="{path: '"+p+"', length: "+ +r.getProperty("/cardLayout/noOfItems")}else{var P="{path: '"+p+"', length: "+i._getItemsLength(r)}var C=m(o,u.$Type,v,e);var T=i.checkFilterPreference(r);if(T||C.length>0){P=P+", parameters: {"}if(C.length>0){if(C.length>0){P=P+"$expand: '"+C.join(",")+"'"}if(T){P=P+", "}}if(T){P=P+"custom: {cardId: '"+r.getProperty("/cardId")+"'}"}if(T||C.length>0){P=P+", $count: true}"}else{P=P+", parameters: {$count:true}"}var d=i.getSorters(r,f,true);if(d.length>0){P=P+", sorter:"+JSON.stringify(d)}var $=n.getFilters(r,c,true);if($.length>0){$=n.createExcludeFilters($,r);P=P+", filters:"+JSON.stringify($)}P=P+"}";return P}y.requiresIContext=true;function m(e,t,a,r){var n=[];var o,l;for(var u=0;u<a.length;u++){if(!a[u]){continue}o=e.getData()["$Annotations"][t]["@"+a[u]];o=o?o:[];for(var g=0;g<o.length;g++){if(o[g].Value&&o[g].Value.$Path){l=i._getNavigationPrefix(e,t,o[g].Value.$Path,r);if(l&&n.indexOf(l)===-1){n.push(l)}}}}return n}function P(e,t,a){return g(e,t,a)}P.requiresIContext=true;function C(e,t,a){return c(e,t,a)}C.requiresIContext=true;function T(e,t,a,r){var n=i.getDataPointsCount(e,t);if(n>0){return C(e,t,a)}else{return P(e,t,r)}}T.requiresIContext=true;function d(e,t,a,r){return c(e,t,a,r)}d.requiresIContext=true;function $(e,t){if(!t){return""}return p(e,t)}$.requiresIContext=true;function V(e,t,a){if(!t){return""}var r=e.getSetting("ovpCardProperties");var n=r.getProperty("/entityType");var o=r.getProperty("/metaModel");var l=Object.assign({},t);var u=Object.assign({},e);t=i._formatValueFromTarget(u,l);return s(e,t,n,o,a)}V.requiresIContext=true;function O(e){var t=e.getObject();var a=e.getModel();var r=a.getProperty("/metaModel");var i="/"+a.getProperty("/entitySet");var n=r.getObject(i);t="/"+n.$Type+"/@"+t;return r.createBindingContext(t)}function A(t,o,l,u){var g;if(l&&l.Value&&l.Value.$Path){g=l.Value.$Path}else if(l&&l.Description&&l.Description.Value&&l.Description.Value.$Path){g=l.Description.Value.$Path}var c="";var s=u&&u.Parameters;var f="";var p=t.getSetting("ovpCardProperties"),v=p.getProperty("/parameters");s=s||!!v;var h=t.getSetting("dataModel");var y=t.getModel(0);var m=r.getEntitySetName(y,o.$Type);if(s){var P=a.resolveParameterizedEntitySet(h,o,u,v);c+="{path: '"+P+"'"}else{c+="{path: '/"+m+"'"}c+=", length: 1";var C=t.getSetting("ovpCardProperties");var T=C.getProperty("/entityType");var d=y.getObject("/"+m+"/");var $,V;for($ in d){if($.startsWith("$")){continue}V=T.$Type.concat("/",$);d[$].annotations=y.getData($).$Annotations[V]}var O=n.getFilters(C,u,true);if(O.length>0){O=n.createExcludeFilters(O,C);f+=", filters: "+JSON.stringify(O)}var A=[];var x=h.oMetaModel.getData().$Annotations;var R;var D=C.getProperty("/measureAggregate");if(D&&D.hasOwnProperty(g)){R=D[g]}else{R=E(g,x,o.$Type)}A.push("'"+g+"Agg' : { 'name' : '"+g+"', 'with' : '"+R+"'}");if(l&&l.Criticality&&l.Criticality.$Path){R=E(l.Criticality.$Path,x,o.$Type);A.push("'"+l.Criticality.$Path+"Agg' : { 'name' : '"+l.Criticality.$Path+"', 'with' : '"+R+"'}")}if(l&&l.CriticalityCalculation&&l.CriticalityCalculation.DeviationRangeLowValue&&l.CriticalityCalculation.DeviationRangeLowValue.$Path){R=E(l.CriticalityCalculation.DeviationRangeLowValue.$Path,x,o.$Type);A.push("'"+l.CriticalityCalculation.DeviationRangeLowValue.$Path+"Agg' : { 'name' : '"+l.CriticalityCalculation.DeviationRangeLowValue.$Path+"', 'with' : '"+R+"'}")}if(l&&l.CriticalityCalculation&&l.CriticalityCalculation.ToleranceRangeLowValue&&l.CriticalityCalculation.ToleranceRangeLowValue.$Path){var R=E(l.CriticalityCalculation.ToleranceRangeLowValue.$Path,x,o.$Type);A.push("'"+l.CriticalityCalculation.ToleranceRangeLowValue.$Path+"Agg' : { 'name' : '"+l.CriticalityCalculation.ToleranceRangeLowValue.$Path+"', 'with' : '"+R+"'}")}if(l&&l.CriticalityCalculation&&l.CriticalityCalculation.DeviationRangeHighValue&&l.CriticalityCalculation.DeviationRangeHighValue.$Path){var R=E(l.CriticalityCalculation.DeviationRangeHighValue.$Path,x,o.$Type);A.push("'"+l.CriticalityCalculation.DeviationRangeHighValue.$Path+"Agg' : { 'name' : '"+l.CriticalityCalculation.DeviationRangeHighValue.$Path+"', 'with' : '"+R+"'}")}if(l&&l.CriticalityCalculation&&l.CriticalityCalculation.ToleranceRangeHighValue&&l.CriticalityCalculation.ToleranceRangeHighValue.$Path){var R=E(l.CriticalityCalculation.ToleranceRangeHighValue.$Path,x,o.$Type);A.push("'"+l.CriticalityCalculation.ToleranceRangeHighValue.$Path+"Agg' : { 'name' : '"+l.CriticalityCalculation.ToleranceRangeHighValue.$Path+"', 'with' : '"+R+"'}")}if(l&&l.TrendCalculation&&l.TrendCalculation.ReferenceValue&&l.TrendCalculation.ReferenceValue.$Path){var R=E(l.TrendCalculation.ReferenceValue.$Path,x,o.$Type);A.push("'"+l.TrendCalculation.ReferenceValue.$Path+"Agg' : { 'name' : '"+l.TrendCalculation.ReferenceValue.$Path+"', 'with' : '"+R+"'}")}var S=i.checkFilterPreference(p);var F=S?", custom: {cardId: '"+p.getProperty("/cardId")+"'}":"";var I=e.getUnitColumnForODataV4(g,y,m);var b=I?", group: {"+I+": {}}":"";var M="parameters:{'$$aggregation' : {'aggregate' : {"+A.join(",")+"}"+b+"}"+F+"}";return c+", "+M+f+"}"}A.requiresIContext=true;function x(e,a){var r=a.$Path;var i=t.format(a,{context:e});return i.replace(r,r+"Agg")}x.requiresIContext=true;function E(e,t,a){var r=t[a+"/"+e];var i=t[a];var n=i&&i["@com.sap.vocabularies.Analytics.v1.AggregatedProperty"];if(n&&n.AggregatableProperty&&n.AggregatableProperty.$PropertyPath===e){return n.AggregationMethod}else if(r["@Org.OData.Aggregation.V1.RecommendedAggregationMethod"]){return r["@Org.OData.Aggregation.V1.RecommendedAggregationMethod"].toLowerCase()}else if(r["@Org.OData.Aggregation.V1.default"]){return r["@Org.OData.Aggregation.V1.default"].$EnumMember.split("/")[1].toLowerCase()}return"sum"}function R(e,a){for(var r=0;r<a.length;r++){if(a[r].type.$EnumMember.indexOf("ContactInformationType/work")>=0){var i=t.format(a[r].address,{context:e});return i}}return""}R.requiresIContext=true;function D(e,a){for(var r=0;r<a.length;r++){if(a[r].type.$EnumMember.indexOf("PhoneType/work")>=0){var i=t.format(a[r].uri,{context:e});return i}}return""}D.requiresIContext=true;function S(e,a){for(var r=0;r<a.length;r++){if(a[r].type.$EnumMember.indexOf("PhoneType/cell")>=0){var i=t.format(a[r].uri,{context:e});return i}}return""}S.requiresIContext=true;function F(e,a){for(var r=0;r<a.length;r++){if(a[r].type.$EnumMember.indexOf("PhoneType/fax")>=0){var i=t.format(a[r].uri,{context:e});return i}}return""}F.requiresIContext=true;return{TextArrangementType:u,formatField:p,formatItems:y,formatDataFieldValueOnIndex:P,formatDataPointValueOnIndex:C,formatDataPointOrField:T,formatObjectNumber:d,formatDataFieldValueGeneric:$,formatDataPointValue:V,resolveEntityTypePath:O,getAggregateNumber:A,getEmail:R,getPhone:D,getDevice:S,getPhoneType:F,getTextArrangementBinding:v,formatDate:f,formatDynamicSubtitle:x}},true);
//# sourceMappingURL=V4AnnotationHelper.js.map