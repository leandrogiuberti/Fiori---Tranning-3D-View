/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/model/json/JSONModel","sap/ovp/cards/generic/base/analytical/Utils","sap/ovp/app/resources","sap/base/util/each","sap/base/util/merge","sap/ovp/cards/generic/base/analytical/OVPVizDatahelper"],function(e,t,a,r,s,i,n){"use strict";return e.extend("sap.ovp.cards.v4.charts.OVPVizDataHandler",{metadata:{aggregations:{data:{type:"sap.ui.core.Element"},aggregateData:{type:"sap.ui.core.Element"},content:{multiple:false}},properties:{chartType:{defaultValue:false},dependentDataReceived:{defaultValue:false},scale:{defaultValue:""},entitySet:{}}},renderer:function(e,t){e.openStart("div",t).openEnd();if(t.getContent()){e.renderControl(t.getContent())}e.close("div")},mergeDatasets:function(e,a,o){var l=this;var u=this.getModel();var p=e.mParameters;var c=i([],this.dataSet);if(p){var d=p["$apply"]}var g=e.getPath().substring(1);var v=-1;if(g){v=g.indexOf("Parameters")}if(v>=0){g=g.substr(0,g.indexOf("Parameters"))}var f=u.getMetaModel();var m=this.getEntitySet();var h=f.getData("/")["$Annotations"];var y=[];var C=[];for(var D in h){if(h[D]["@com.sap.vocabularies.Analytics.v1.Measure"]){if(d&&d.includes(D.split("/")[1])){y.push(D.split("/")[1])}}else{if(d&&d.includes(D.split("/")[1])){C.push(D.split("/")[1])}}}if(c){for(var b=0;b<c.length-2;b++){for(var S=0;S<y.length;S++){if(c[0]){c[0][y[S]]=Number(c[0][y[S]])+Number(c[b+1][y[S]])}}}c.__count=c.length;var P=c.__count-c.length;var A={};A.results=[];A.results[0]=c[0];var M;if(c.__count>c.length){var O=i({},this.aggregateSet);if(O&&O.results&&c.results.length<c.__count){s(y,function(e){O.results[0][y[e]]=String(Number(l.aggregateSet.results[0][y[e]])-Number(A.results[0][y[e]]))});s(C,function(e){O.results[0][C[e]]=r.getText("OTHERS_DONUT",[P+1])});O.results[0].$isOthers=true;M=O.results[0];if(M){a.results.splice(-1,1)}}}if(M){a.results.push(M)}var E=o.getModel("ovpCardProperties");var T=E&&E.getProperty("/bEnableStableColors");var V=E&&E.getProperty("/colorPalette");var x=h[m]["@"+(E&&E.getProperty("/chartAnnotationPath"))];if(x.DimensionAttributes.length===1&&T&&o.getVizType()==="donut"&&V&&V instanceof Object){var R=x.DimensionAttributes[0].Dimension.$PropertyPath;var _=o.getVizProperties();if(!_){var B={plotArea:{dataPointStyle:{rules:[]}}};_=B}else if(_&&!_.plotArea){_.plotArea={dataPointStyle:{rules:[]}}}_.legend={itemMargin:1.25};if(o&&_&&_.plotArea){if(!_.plotArea.dataPointStyle){_.plotArea.dataPointStyle={rules:[]}}else{_.plotArea.dataPointStyle.rules=[]}var $=E.getProperty("/entityType");var z=f.getData()["$Annotations"][$.$Type+"/"+R];if(z){var I=z["@com.sap.vocabularies.Common.v1.Label"]?z["@com.sap.vocabularies.Common.v1.Label"]:R;var N;if(z["@com.sap.vocabularies.Common.v1.Text"]){N=z["@com.sap.vocabularies.Common.v1.Text"]["$Path"]}else if(z["sap:text"]){N=z["sap:text"]}else{N=z}n.cacheValues(V,R,N,I);n.addColorRulesToVizProperties(a,_);n.handleOthersSectionForCharts(O,_)}}o.setVizProperties(_);n.setVizPropertiesForInsightCards(E,o,_)}}var j=new t;var k=[];for(var b=0;b<a.results.length;b++){var Y={};for(var w=0;w<C.length;w++){Y[C[w]]=a.results[b]&&a.results[b][C[w]]}for(var F=0;F<y.length;F++){Y[y[F]]=a.results[b]&&(a.results[b][y[F]+"Aggregate"]||a.results[b][y[F]])}k.push(Y)}j.setData(k);o.setModel(j,"analyticalmodel")},updateBindingContext:function(){var r=this.getBinding("data");var o=this;if(this.chartBinding==r){return}else{this.chartBinding=r;if(r){var o=this;r.attachEvent("dataReceived",function(e){if(a.checkIfDataExistInEvent(e)){o.dataSet=e&&e.getSource().getCurrentContexts().map(function(e){return e&&e.getObject()});o.oDataClone={results:i([],o.dataSet)};if(o.getChartType()=="donut"&&o.getBinding("aggregateData")!==undefined){if(o.getDependentDataReceived()===true||o.getDependentDataReceived()==="true"){o.mergeDatasets(r,o.oDataClone,o.getContent());o.setDependentDataReceived(false)}else{o.setDependentDataReceived(true)}}else{var l=new t;if(o.dataSet){var u=o.getEntitySet().split(".")[o.getEntitySet().split(".").length-1];var p=r.getModel();var c=a.cacheODataMetadata(p);var d=[];var g={};var v=c[u];if(v){var f=Object.keys(v)}if(f&&f.length){s(f,function(e,t){if(v[t].$Type==="Edm.String"){var a=o.getModel().getMetaModel().getObject("/"+o.getEntitySet()+"/"+t+"@");if(a["@com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]){d.push(t);g[t]={semantics:"yearmonth"}}else if(a["@com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]){d.push(t);g[t]={semantics:"yearquarter"}}else if(a["@com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]){d.push(t);g[t]={semantics:"yearweek"}}else if(a["@com.sap.vocabularies.Common.v1.IsFiscalYearPeriod"]){d.push(t);g[t]={semantics:"fiscalyearperiod"}}}})}n.formatDateBasedOnSemantics(d,g,o.dataSet);l.setData(o.dataSet);o.oDataClone={results:i([],o.dataSet)}}o.getContent().setModel(l,"analyticalmodel");o.mergeDatasets(r,o.oDataClone,o.getContent())}}})}e.prototype.updateBindingContext.apply(this,arguments)}n.attachDataReceivedToAggregationBinding.bind(this)()}})});
//# sourceMappingURL=OVPVizDataHandler.js.map