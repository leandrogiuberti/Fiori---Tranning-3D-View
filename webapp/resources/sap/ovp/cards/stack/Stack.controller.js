/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ovp/cards/generic/Card.controller","sap/m/library","sap/ui/thirdparty/jquery","sap/ovp/ui/ObjectStream","sap/ovp/cards/AnnotationHelper","sap/ui/Device","sap/ui/base/BindingParser","sap/ui/core/ComponentContainer","sap/m/Link","sap/ovp/ui/CustomData","sap/ui/core/Icon","sap/m/FlexItemData","sap/m/Text","sap/m/VBox","sap/ovp/app/resources","sap/base/util/merge","sap/ovp/app/OVPLogger","sap/ui/core/Component","sap/ovp/cards/NavigationHelper","sap/ui/core/Element"],function(t,e,jQuery,i,a,o,r,n,s,d,l,c,p,h,C,u,v,g,m,f){"use strict";var b=new v("OVP.stack.Stack");var y=e.LinkAccessibleRole;return t.extend("sap.ovp.cards.stack.Stack",{onInit:function(){t.prototype.onInit.apply(this,arguments);var e=this._oCard=this.getView().byId("stackContent");e.addEventDelegate({onclick:this.openStack.bind(this),onkeydown:function(t){if(!t.shiftKey&&(t.keyCode==13||t.keyCode==32)){t.preventDefault();this.openStack()}}.bind(this)});if(o.system.phone){this.bAfterColumnUpdateAttached=false;this.bDeviceOrientationAttached=false}this.quickViewCardContextArray=[];this.bQuickViewCardRendered=false;this.initialLoadCardLength=10;this.quickViewCardCount=0;this._createObjectStream()},onExit:function(){if(this.oObjectStream){this.oObjectStream.destroy()}},addPlaceHolder:function(t){var e=this.getView();var i=e.getModel("ovpCardProperties");var a=i.getProperty("/objectStreamCardsNavigationProperty");var o=a?true:false;if(!o){var r=m.getEntityNavigationEntries(null,this.getModel(),this.getEntityType(),i);if(r.length>0){var n=r[0].label;if(this.sPlaceHolderText==undefined){this.sPlaceHolderText=C.getText("PlaceHolder_default")}var s=this._createPlaceHolder(t,this.sPlaceHolderText,n);var d=this;s.addEventDelegate({onclick:function(){d.doNavigation(null)}});this.oObjectStream.setPlaceHolder(s)}}},onAfterRendering:function(){t.prototype.onAfterRendering.apply(this,arguments);this.ovpLayout=f.getElementById(this.oCardComponent._sOwnerId+"---mainView--ovpLayout");if(o.system.phone){this._cardWidth=this.getView().$().width();if(!this.bAfterColumnUpdateAttached){var e=this.getOwnerComponent().getComponentData();if(e&&e.mainComponent&&e.appComponent.oOvpConfig&&e.appComponent.oOvpConfig.containerLayout!=="resizable"){var i=e.mainComponent,a=i.byId("ovpLayout"),r=this;a.attachAfterColumnUpdate(function(){r._setObjectStreamCardsSize.call(r,false)});this.bAfterColumnUpdateAttached=true}}if(!this.bDeviceOrientationAttached){var r=this;o.orientation.attachHandler(function(){r._setObjectStreamCardsSize.call(r,true)})}}if(this.bSetErrorState&&this.bSetErrorState===true){this.setErrorState();return}var n=this.getView();if(this.oObjectStream){var s=this.oObjectStream.getBinding("content");s.attachDataRequested(function(){if(this.getView().byId("stackSize")!==undefined&&this.getView().byId("stackTotalSize")!==undefined){jQuery(this.getView().byId("stackSize").getDomRef()).css("visibility","hidden");jQuery(this.getView().byId("stackTotalSize").getDomRef()).css("visibility","hidden")}},this);s.attachDataReceived(function(){var t=this.getView().getModel("ovpCardProperties").getObject("/category"),e=s.getCurrentContexts().length,i=s.getLength();n.byId("stackSize").setText(e);n.byId("stackTotalSize").setText(C.getText("Total_Size_Stack_Card",[i]));var a=this.getView().byId("stackContent").getDomRef();jQuery(a).attr("aria-label",C.getText("stackCardContent",[e,i,t]));var o=this.getView().byId("stackSize").getDomRef();jQuery(o).attr("aria-label",C.getText("stackCard",[e]));this.addPlaceHolder(i);if(this.getView().byId("stackSize")!==undefined&&this.getView().byId("stackTotalSize")!==undefined){jQuery(this.getView().byId("stackSize").getDomRef()).css("visibility","visible");jQuery(this.getView().byId("stackTotalSize").getDomRef()).css("visibility","visible")}var r=this.getView().getDomRef();var d=jQuery(r).find(".sapOvpCardContentContainer");if(i!==0){if(d.length!==0){d.addClass("sapOvpCardNavigable")}}else{if(d.length!==0){var l=d.find("[role='button']");if(l.length!==0){l.removeAttr("role")}}}},this);this.addPlaceHolder("");if(s.bPendingRequest===false){s.fireDataReceived()}if(m.checkNavigation(this.getModel(),this.getEntityType(),this.getCardPropertiesModel())){this.oObjectStream.getTitle().addStyleClass("sapOvpCardNavigable")}}},getCardItemsBinding:function(){return this&&this.oObjectStream&&this.oObjectStream.getBinding("content")},_setObjectStreamCardsSize:function(t){var e=this.getView().$().width();if(this._cardWidth!=e||t){this.oObjectStream.setCardsSize(e);this._cardWidth=e}},_createObjectStream:function(){if(this.oObjectStream instanceof i){return}var t=this.getOwnerComponent();var e=t.getComponentData&&t.getComponentData();var o;var l;if(e.i18n){this.oi18n=e.i18n}if(e&&e.mainComponent){o=e.mainComponent._getOvplibResourceBundle()}else{o=t.getOvplibResourceBundle()}l=t.getPreprocessors(o);this.oModel=e.model;this.oCardPropsModel=l.xml.ovpCardProperties;var c=this.oCardPropsModel.getProperty("/entitySet");var p=this.oCardPropsModel.getProperty("/objectStreamCardsSettings");this.oObjectStreamCardsSettings=p;var h=this.oModel.getMetaModel();var C=h.getODataEntitySet(c);var u=h.getODataEntityType(C.entityType);var v=this.oCardPropsModel.getProperty("/annotationPath");var g=v?v.split(","):[];if(e){this.oAppComponent=e.appComponent;this.oOwner=e.mainComponent}if(this.oOwner){this.oGlobalFilter=this.oOwner.getView().byId("ovpGlobalFilter")}function m(t){if(t==="ovpCardProperties"){return this.oCardPropsModel}else if(t==="dataModel"){return this.oModel}else if(t==="_ovpCache"){return{}}}var f=[{getSetting:m.bind(this),bDummyContext:true},C].concat(g);var S=a.formatItems.apply(this,f);var w=r.complexParser(S);var k=this.oCardPropsModel.getProperty("/objectStreamCardsNavigationProperty");this.bStackFlavorAssociation=k?true:false;this.oStackFilterMapping;var O=this.oCardPropsModel.getProperty("/objectStreamCardsTemplate");if(this.bStackFlavorAssociation){if(O==="sap.ovp.cards.quickview"){b.error("objectStreamCardsTemplate cannot be 'sap.ovp.cards.quickview' when objectStreamCardsNavigationProperty is provided");this.bSetErrorState=true;return}this.oStackFilterMapping=this._determineFilterPropertyId(this.oModel,C,u,k);p.entitySet=this.oModel.getMetaModel().getODataAssociationSetEnd(u,k).entitySet}else{if(O!=="sap.ovp.cards.quickview"){b.error("objectStreamCardsTemplate must be 'sap.ovp.cards.quickview' when objectStreamCardsNavigationProperty is not provided");this.bSetErrorState=true;return}var P=null;var x=this.oCardPropsModel.getProperty("/identificationAnnotationPath");var j=x?x.split(","):[];if(j&&j.length>1){P=j[1]}if(P){p.identificationAnnotationPath=P}if(u["com.sap.vocabularies.UI.v1.HeaderInfo"]&&u["com.sap.vocabularies.UI.v1.HeaderInfo"].TypeName&&u["com.sap.vocabularies.UI.v1.HeaderInfo"].TypeName.String){p.title=u["com.sap.vocabularies.UI.v1.HeaderInfo"].TypeName.String}else{p.title=u.name}p.entitySet=c}p.isObjectStream=true;w.factory=function(t,e){var i=new n;this.quickViewCardContextArray.push({sId:t,oContext:e,oComponentContainer:i});return i}.bind(this);w.clearQuickViewCard=function(){this.quickViewCardContextArray=[]}.bind(this);var V=this.oCardPropsModel.getObject("/title");this.sPlaceHolderText=this.oCardPropsModel.getObject("/itemText");var A=new s({text:V,subtle:true,accessibleRole:y.Button,press:this.handleObjectStreamTitlePressed.bind(this)}).addStyleClass("sapOvpObjectStreamHeader");A.addCustomData(new d({key:"tabindex",value:"0",writeToDom:true}));A.addCustomData(new d({key:"aria-label",value:V,writeToDom:true}));this.oObjectStream=new i(this.getView().getId()+"_ObjectStream",{title:A,content:w});this.getOwnerComponent().combineBatch(this.oModel,this.getOwnerComponent().oComponentData);this.oObjectStream.setModel(this.oModel)},_renderQuickViewCards:function(t,e,i){return new Promise(function(a,o){var r=this.oCardPropsModel.getProperty("/objectStreamCardsSettings"),n;if(this.bStackFlavorAssociation){n={filters:[{path:this.oStackFilterMapping.foreignKey,operator:"EQ",value1:e.getProperty(this.oStackFilterMapping.key)}]};r=u({},n,this.oObjectStreamCardsSettings)}var s={name:this.oCardPropsModel.getProperty("/objectStreamCardsTemplate"),componentData:{cardId:t,model:this.oModel,settings:r,appComponent:this.oAppComponent,mainComponent:this.oOwner},manifest:false};if(this.oGlobalFilter){s.componentData.globalFilter={getUiState:this.oGlobalFilter.getUiState.bind(this.oGlobalFilter)}}var d=this.oi18n;g.create(s).then(function(t){t.setBindingContext(e);if(d){t.setModel(d,"@i18n")}i.setComponent(t);a();i.setBindingContext=function(e){t.setBindingContext(e)}})}.bind(this))},_determineFilterPropertyId:function(t,e,i,o){var r,n=i.namespace,s,d;for(var l=0;l<i.navigationProperty.length;l++){if(i.navigationProperty[l].name===o){r=i.navigationProperty[l];break}}s=r.relationship;d=a.getAssociationObject(t,s,n);var c=d.referentialConstraint,p={};if(c){p.foreignKey=c.dependent.propertyRef[0].name;p.key=c.principal.propertyRef[0].name;return p}},_createPlaceHolder:function(t,i,a){var o=new l({src:"sap-icon://display-more",useIconTooltip:false,layoutData:new c({alignSelf:e.FlexAlignSelf.Center,styleClass:"sapOvpStackPlaceHolderIconContainer"})});o.addStyleClass("sapOvpStackPlaceHolderIcon");var r=t+" "+i;var n=C.getText("SeeMoreContentAppName",[r,a]);var s=new p({text:n,textAlign:"Center",layoutData:new c({alignSelf:e.FlexAlignSelf.Center,maxWidth:"14rem"})});s.addCustomData(new d({key:"role",value:"heading",writeToDom:true}));s.addCustomData(new d({key:"aria-label",value:n,writeToDom:true}));s.addStyleClass("sapOvpStackPlaceHolderTextLine");var u=new h({items:[s]});u.addStyleClass("sapOvpStackPlaceHolderLabelsContainer");u.addCustomData(new d({key:"tabindex",value:"0",writeToDom:true}));u.addCustomData(new d({key:"role",value:"button",writeToDom:true}));var v=new h({items:[o,u]});v.addStyleClass("sapOvpStackPlaceHolder");v.addEventDelegate({onkeydown:function(t){if(!t.shiftKey&&(t.keyCode==13||t.keyCode==32)){t.preventDefault();t.srcControl.$().click()}}});return v},_openStack:function(){if(this.oObjectStream){var t=this.oObjectStream.getBinding("content");if(t.getCurrentContexts().length>0){var e=this.getView().$().width();this.getView().addDependent(this.oObjectStream);this.oObjectStream.setModel(this.getView().getModel("@i18n"),"@i18n");this.oObjectStream.open(e,this._oCard)}}if(this.ovpLayout){this.ovpLayout.setActive(true)}if(this.oObjectStream.getNewContentAvailable()){if(this.quickViewCardContextArray.length>10){var i=[];for(var a=this.initialLoadCardLength;a<this.quickViewCardContextArray.length;a++){i.push(this._renderQuickViewCards(this.quickViewCardContextArray[a].sId,this.quickViewCardContextArray[a].oContext,this.quickViewCardContextArray[a].oComponentContainer))}}this.oObjectStream.setNewContentAvailable(false)}},openStack:function(){if(this.ovpLayout){this.ovpLayout.setActive(false)}if(this.oObjectStream.getNewContentAvailable()){var t=[];var e=this.quickViewCardContextArray.length<=this.initialLoadCardLength?this.quickViewCardContextArray.length:this.initialLoadCardLength;for(var i=this.quickViewCardCount;i<e;i++){t.push(this._renderQuickViewCards(this.quickViewCardContextArray[i].sId,this.quickViewCardContextArray[i].oContext,this.quickViewCardContextArray[i].oComponentContainer))}Promise.all(t).then(function(){this.bQuickViewCardRendered=true;this._openStack()}.bind(this))}else{this._openStack()}},handleObjectStreamTitlePressed:function(t){this.doNavigation(null)}})});
//# sourceMappingURL=Stack.controller.js.map