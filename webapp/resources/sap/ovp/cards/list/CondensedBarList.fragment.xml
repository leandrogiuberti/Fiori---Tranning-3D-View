<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:template="http://schemas.sap.com/sapui5/extension/sap.ui.core.template/1"
    xmlns:build="sap.build"
    xmlns:sfi="sap.ui.comp.smartfield"
    xmlns:navpopover="sap.ui.comp.navpopover"
    xmlns:micro="sap.suite.ui.microchart"
    template:require="{
		CardAnnotationhelper: 'sap/ovp/cards/AnnotationHelper',
        ModelAnnotationhelper: 'sap/ui/model/odata/AnnotationHelper'
	}"    
>
    <items>
        <CustomListItem
            core:require="{CardAnnotationhelper: 'sap/ovp/cards/AnnotationHelper'}"
            id="listItem"
            type="Active"
            press="onListItemPress"
            class="sapOvpBarList sapOvpBarCondensedList">
            <!-- if manifest Property showLineItemDetail is set to true then the first data field will be a Link to show the Line Item Details -->
            <template:if test="{= ${ovpCardProperties>/showLineItemDetail} === true}">
            <template:then>
                <VBox>
                    <core:Fragment fragmentName="sap.ovp.cards.generic.LineItemDetails" type="XML"/>
                    <Link
                        id="DataField"
                        class="sapOvpBarListDataField sapOvpOverflowEllipsisDataField sapOvpBarListTitle"
                        text="{parts:[{path:'lineItem>'}, {path:'ovpConstants>/firstDataFieldIndex'}], formatter: 'CardAnnotationhelper.formatDataFieldValueOnIndex'}"
                        press="onContactDetailsLinkPress"
                        reactiveAreaMode="Overlay">
                    </Link>
                </VBox>
            </template:then>
                <!-- if first data field contain semantic object then smartlink to show semantic object info else  first data field value -->
            <template:elseif test="{parts:[{path:'entitySet>'}, {path:'lineItem>'}], formatter: 'CardAnnotationhelper.semanticObjectOfFirstDataField'}">
                <navpopover:SmartLink
                    id="DataField"
                    class="sapOvpBarListDataField sapOvpOverflowEllipsisDataField sapOvpBarListTitle"
                    text="{parts:[{path:'lineItem>'}, {path:'ovpConstants>/firstDataFieldIndex'}], formatter: 'CardAnnotationhelper.formatDataFieldValueOnIndex'}"
                    semanticObject="{parts:[{path:'entitySet>'}, {path:'lineItem>'}], formatter: 'CardAnnotationhelper.semanticObjectOfFirstDataField'}"
                    contactAnnotationPath="{parts:[{path:'lineItem>'}, {path:'ovpConstants>/firstDataFieldIndex'}], formatter: 'CardAnnotationhelper.checkNavTargetForContactAnno'}" enableAvailableActionsPersonalization="false"
                    forceLinkRendering="{parts: [{path: 'entitySet>'}], formatter: 'CardAnnotationhelper.checkForContactAnnotation'}">
                </navpopover:SmartLink>
            </template:elseif>
                <template:else>
                    <Text
                        id="DataField"
                        class="sapOvpBarListDataField sapOvpOverflowEllipsisDataField sapOvpBarListTitle"
                        text="{parts:[{path:'lineItem>'}, {path:'ovpConstants>/firstDataFieldIndex'}], formatter: 'CardAnnotationhelper.formatDataFieldValueOnIndex'}"/>
                </template:else>
            </template:if>
            <HBox class="sapOvpBarListHBox sapOvpBarStandardList">
                <micro:ComparisonMicroChart 
                    id= "BarChartDataPoint"
                    class="sapOvpBarListComparisonMicroChartAlignment" 
                    width="100%"
                    shrinkable="true"
                    colorPalette="{path: 'lineItem>', formatter: 'CardAnnotationhelper.colorPaletteForComparisonMicroChart'}"
                    minValue="{minMaxModel>/minValue}"
                    maxValue="{minMaxModel>/maxValue}"> 
                    <micro:data> 
                        <micro:ComparisonMicroChartData 
                            displayValue=" "
                            value="{= '{path: \'' + ${path: 'lineItem>', formatter: 'CardAnnotationhelper.getFirstDataPointValue'} + '\', formatter: \'.returnBarChartValue\'}' }"
                            color="{path: 'lineItem>', formatter: 'CardAnnotationhelper.formatFirstDataPointColor'}">
                        </micro:ComparisonMicroChartData>
                    </micro:data>
                </micro:ComparisonMicroChart>
                <template:if test="{= ${path: 'lineItem>', formatter: 'CardAnnotationhelper.getDataPointsCount'} > 0}" >
                    <template:if test="{= ${path: 'lineItem>', formatter: 'CardAnnotationhelper.isFirstDataPointPercentageUnit'}}" >
                        <template:then>
                            <ObjectNumber
                                    id="DataPoint1"
                                    class="sapOvpBarListObjectNumber sapOvpBarListSubDataField sapOvpBarListObjectNumberPercentage"
                                    textAlign="End"
                                    number="{parts:[{path:'lineItem>'}, {path:'ovpConstants>/firstDataPointIndex'}], formatter: 'CardAnnotationhelper.formatDataPointValueOnIndex'}"/>
                        </template:then>
                        <template:else>
                            <ObjectNumber
                                    id="DataPoint1"
                                    class="sapOvpBarListObjectNumber sapOvpBarListSubDataField sapOvpObjectNumber"
                                    textAlign="End"
                                    state="{path: 'lineItem>', formatter: 'CardAnnotationhelper.formatFirstDataPointState'}"
                                    number="{parts:[{path:'lineItem>'}, {path:'ovpConstants>/firstDataPointIndex'}, {path:'ovpConstants>/dontIncludeUOM'}], formatter: 'CardAnnotationhelper.formatObjectNumber'}"
                                    unit="{parts:[{path:'lineItem>'}, {path:'ovpConstants>/firstDataPointIndex'}], formatter: 'CardAnnotationhelper.formatUnit'}"/>
                        </template:else>
                    </template:if>
                </template:if>

                <template:if test="{= ${path: 'lineItem>', formatter: 'CardAnnotationhelper.isFirstContactAnnotation'} === true}">
                    <template:then>
                        <template:repeat 
                            list="{path:'lineItem>'}" 
                            var="dataField">
                            <template:if test="{= ${dataField>RecordType} === 'com.sap.vocabularies.UI.v1.DataFieldForAnnotation'}">
                                <template:then>
                                    <template:if test="{= ${dataField>Target/AnnotationPath}.indexOf('com.sap.vocabularies.Communication.v1.Contact') >= 0}">
                                        <template:then>
                                            <template:with 
                                                path="dataField>Target"
                                                helper="ModelAnnotationhelper.resolvePath"
                                                var="contact">
                                                <VBox class="textAlignRight">
                                                    <core:Fragment fragmentName="sap.ovp.cards.generic.ContactDetails" type="XML"/>
                                                    <Link 
                                                        id = "contactLink"
                                                        binding="{= ${ path: 'dataField>Target/AnnotationPath'}.indexOf('/') > -1 ? '{' + ${path: 'dataField>Target/AnnotationPath'}.slice(0, ${ path: 'dataField>Target/AnnotationPath'}.indexOf('/')) + '}' : null}"
                                                        text="{path: 'contact>fn', formatter: 'ModelAnnotationhelper.format'}"
                                                        press="onContactDetailsLinkPress"
                                                        reactiveAreaMode="Overlay">
                                                    </Link>
                                                </VBox>
                                            </template:with>
                                        </template:then>
                                    </template:if>
                                </template:then>
                            </template:if>
                        </template:repeat>
                    </template:then>
                    <template:else>
                        <template:if test="{= ${path: 'lineItem>', formatter: 'CardAnnotationhelper.getDataPointsCount'} > 1}" >
                            <ObjectNumber
                                id="DataPoint2"
                                class="{= ${path: 'lineItem>', formatter: 'CardAnnotationhelper.formatFirstDataPointState'} === 'None' ?
                                        'sapOvpBarListObjectNumber sapOvpBarListSubDataField' : 'sapOvpBarListObjectNumber sapOvpBarListSubDataField sapOvpBarListObjectNumberWithoutState'} sapOvpObjectNumber"
                                textAlign="End"
                                number="{parts:[{path:'lineItem>'}, {path:'ovpConstants>/secondDataPointIndex'}, {path:'ovpConstants>/dontIncludeUOM'}], formatter: 'CardAnnotationhelper.formatObjectNumber'}"
                                state="{path: 'lineItem>', formatter: 'CardAnnotationhelper.formatSecondDataPointState'}"
                                unit="{parts:[{path:'lineItem>'}, {path:'ovpConstants>/secondDataPointIndex'}], formatter: 'CardAnnotationhelper.formatUnit'}"/>
                        </template:if>
                    </template:else>
                </template:if>
            </HBox>
        </CustomListItem>
    </items>
</core:FragmentDefinition>
