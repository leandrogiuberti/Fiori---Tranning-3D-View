/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ovp/cards/CommonUtils","sap/ovp/cards/rta/SettingsDialogConstants","sap/ovp/app/OVPUtils","sap/base/util/merge","sap/ui/model/odata/CountMode"],function(jQuery,t,e,i,a,s){"use strict";function n(t,e,i,a){return t+"_sap.ovp.cards."+e+"."+i+"."+a}function r(t){return{type:"XTIT",maxLength:40,value:{"":t}}}function o(){return{i18n:"../i18n/i18n.properties"}}function d(t,e,i){var a=t+"["+e+"]";if(i){a+="/"+i}return a}function f(t,e){var i=e._getCardsModel();for(var a=0;a<i.length;a++){if(i[a].id===t){return true}}return false}function l(t,e,i){var a={propertyPath:t,operation:e};if(i){a["propertyValue"]=i}return a}function g(t){delete t.id;delete t.dashboardLayout;delete t.settings.baseUrl;delete t.settings.cloneCard;delete t.settings.newCard;delete t["customer.settings"];delete t["customer_base.settings"];delete t["vendor.settings"];if(t.settings["staticContent"]){for(var e=0;e<t.settings["staticContent"].length;e++){delete t.settings["staticContent"][e].id}}}function c(e,i,a,s){if(a){if(e===t._getLayerNamespace()+".settings"){a[s]={operation:"DELETE"}}}else{if(e===t._getLayerNamespace()+".settings"){K.aEntityPropertyChange.push(l(i,"UPSERT",{operation:"DELETE"}))}else{K.aEntityPropertyChange.push(l(i,"DELETE"))}}}function p(e){K.aEntityPropertyChange.push(l(t._getLayerNamespace()+".settings","UPSERT",e[t._getLayerNamespace()+".settings"]))}function u(e,a,s,o,d,f){var g;var c=t._getLayer();if(!K.oText){K.oText={}}if(!c||c===i.Layers.customer){g=n(K.sApplicationId,K.sCardId,e,s);K.oText[g]=r(o)}else{var p=false;for(var u in d.ai18nProperties){if(d.ai18nProperties[u].value===o){g=d.ai18nProperties[u].key;p=true;break}}if(!p){g=n(K.sApplicationId,K.sCardId,e,s)}K.oText[g]=r(o)}if(f){f[s]="{{"+g+"}}"}else{var h=a+"/"+s;K.aEntityPropertyChange.push(l(h,"UPSERT","{{"+g+"}}"))}}function h(a,s,n,r){var o=this._oCardManifestSettings,d=this._oOriginalCardManifestSettings;for(var f=0;f<n.length;f++){if(!d[n[f]]&&o[n[f]]||d[n[f]]&&o[n[f]]&&d[n[f]]!=o[n[f]]){if(r){u(a,a,n[f],o[n[f]],o,s[a])}else{u(a,a,n[f],o[n[f]],o)}var l=t._getLayer();if(!l||l===i.Layers.customer){s.settings[n[f]]=o[n[f]]}else{var g=e.oI18nValueProperty;if(g[n[f]]){s.settings[n[f]]=this._oCardManifestSettings[g[n[f]]]}else{s.settings[n[f]]=o[n[f]]}}}else if(!o[n[f]]&&d[n[f]]){if(r){c(a,a+"/"+n[f],s[a],n[f])}else{c(a,a+"/"+n[f])}delete s.settings[n[f]]}}}function C(t,e,i,a){var s=t+"/"+e;if(a){a[e]=i}else{K.aEntityPropertyChange.push(l(s,"UPSERT",i))}}function v(t,e,i,a){var s=this._oCardManifestSettings,n=this._oOriginalCardManifestSettings;for(var r=0;r<i.length;r++){if(!n[i[r]]&&s[i[r]]||n[i[r]]&&s[i[r]]&&n[i[r]]!=s[i[r]]||typeof n[i[r]]==="boolean"&&typeof s[i[r]]==="boolean"&&n[i[r]]!=s[i[r]]){if(a){C(t,i[r],s[i[r]],e[t])}else{C(t,i[r],s[i[r]])}e.settings[i[r]]=s[i[r]]}else if(!s[i[r]]&&n[i[r]]){if(a){c(t,t+"/"+i[r],e[t],i[r])}else{c(t,t+"/"+i[r])}delete e.settings[i[r]]}}}function m(i,a){var s=e.cardSettings["settings"],n=e.cardSettings["text"];if(i===t._getLayerNamespace()+".settings"){if(a[t._getLayerNamespace()+".settings"]){h.bind(this)(i,a,n,false);v.bind(this)(i,a,s,false)}else{a[t._getLayerNamespace()+".settings"]={};h.bind(this)(i,a,n,true);v.bind(this)(i,a,s,true);p(a)}}else{h.bind(this)(i,a,n,false);v.bind(this)(i,a,s,false)}}function y(t,e,i,a,s,n){var r=this._oCardManifestSettings;var o=r[s];for(var f=0;f<o.length;f++){for(var l=0;l<a.length;l++){if(o[f][a[l]]){var g=d(t+"/"+s,f),c=t+"."+s+"."+f;if(n){u(c,g,a[l],o[f][a[l]],r,e[t][s][f])}else{u(c,g,a[l],o[f][a[l]],r,i[f])}}}}if(!n){C(t,s,i)}}function S(t,i){var a=e.cardSettingsArrayLevel[i]["onlyTabLevelProps"],s=false;for(var n=0;a&&n<a.length;n++){if(a[n]===t){s=true;break}}return s}function _(t,e,i,a,s,n){var r=this._oCardManifestSettings,o;for(o=0;o<i.length;o++){if(r[i[o]]&&!S(i[o],s)){if(n){u(t,t,i[o],r[i[o]],r,e[t])}else{u(t,t,i[o],r[i[o]],r)}e.settings[i[o]]=r[i[o]]}}for(o=0;o<a.length;o++){if(r[a[o]]&&!S(a[o],s)){if(n){C(t,a[o],r[a[o]],e[t])}else{C(t,a[o],r[a[o]])}e.settings[a[o]]=r[a[o]]}}if(n){c(t,t+"/"+s,e[t],s)}else{c(t,t+"/"+s)}delete e.settings[s]}function b(t,e,i,a,s,n,r){var o;for(o=0;o<a.length;o++){if(e[t][a[o]]){if(r){c(t,t+"/"+a[o],e[t],a[o])}else{c(t,t+"/"+a[o])}delete e.settings[a[o]]}}for(o=0;o<s.length;o++){if(e[t][s[o]]){if(r){c(t,t+"/"+s[o],e[t],s[o])}else{c(t,t+"/"+s[o])}delete e.settings[s[o]]}}y.bind(this)(t,e,i,a,n,r)}function M(t,i){return jQuery.map(a({},t),function(t){var a=e.cardSettingsArrayLevel[i]["text"],s,n=e.cardSettingsArrayLevel[i]["settings"],r={};for(s=0;s<a.length;s++){if(t[a[s]]){r[a[s]]=t[a[s]]}}for(s=0;s<n.length;s++){if(t[n[s]]||t[n[s]]===""){r[n[s]]=t[n[s]]}}return r})}function P(t,i,a,s){var n=e.cardSettingsArrayLevel[a]["checkForRemoval"],r,o;for(r=0;r<n.length;r++){if(!i[0][n[r]]){o=t.indexOf(n[r]);if(s==="remove"){if(o>-1){t.splice(o,1)}}else if(s==="add"){if(o===-1){t.push(n[r])}}}}return t}function I(i,a,s,n,r,o){var d=e.cardSettingsArrayLevel[r]["text"],f=e.cardSettingsArrayLevel[r]["settings"],l=M(s,r);if(s&&n){a.settings[r]=M(s,r);if(i===t._getLayerNamespace()+".settings"){a[i][r]=M(s,r)}y.bind(this)(i,a,l,d,r,o)}else if(!s&&n){_.bind(this)(i,a,d,f,r,o)}else if(s&&!n){a.settings[r]=M(s,r);if(i===t._getLayerNamespace()+".settings"){a[i][r]=M(s,r)}f=P(f,l,r,"remove");b.bind(this)(i,a,l,d,f,r,o);f=P(f,l,r,"add")}}function L(t,e,i){var a=this._oCardManifestSettings["staticContent"],s=this._oOriginalCardManifestSettings["staticContent"],n=this._oCardManifestSettings["tabs"],r=this._oOriginalCardManifestSettings["tabs"];if(a||s){I.bind(this)(t,e,a,s,"staticContent",i)}else if(n||r){I.bind(this)(t,e,n,r,"tabs",i)}}function A(i,a){var s=e.cardSettingsForComplex["settings"],n=e.cardSettingsForComplex["text"];if(i===t._getLayerNamespace()+".settings"){if(a[t._getLayerNamespace()+".settings"]){h.bind(this)(i,a,n,false);v.bind(this)(i,a,s,false);L.bind(this)(i,a,false)}else{a[t._getLayerNamespace()+".settings"]={};h.bind(this)(i,a,n,true);v.bind(this)(i,a,s,true);L.bind(this)(i,a,true);p(a)}}else{h.bind(this)(i,a,n,false);v.bind(this)(i,a,s,false);L.bind(this)(i,a,false)}}function x(t,e){var i=this._oCardManifestSettings["staticContent"],a=this._oOriginalCardManifestSettings["staticContent"],s=this._oCardManifestSettings["tabs"],n=this._oOriginalCardManifestSettings["tabs"];if(i||a||s||n){A.bind(this)(t,e)}else{m.bind(this)(t,e)}}function N(i){var a=e.AllCardSettingsForKPICard,s,n=this._oCardManifestSettings,r={model:t._getLayerNamespace()+".kpi_card_model_"+i.getTrimmedDataURIName(n.selectedKPI.ODataURI),template:"sap.ovp.cards.charts.analytical",settings:{}};for(s=0;s<a.length;s++){if(n[a[s]]){r.settings[a[s]]=n[a[s]]}}if(n["addCustomParameters"]){r.settings.staticParameters={};var o=n["aAllStaticParameters"];if(Array.isArray(o)&&o.length>0){for(var d=0;d<o.length;d++){var f=o[d];r.settings.staticParameters[f.key]=f.value}}}return r}function w(){var t=this._oCardManifestSettings["staticContent"],i=e.cardSettingsArrayLevel["staticContent"]["text"],a,s,n=e.cardSettingsArrayLevel["staticContent"]["settings"],r=this._oCardManifestSettings,o=e.cardSettingsForStaticLinkListCard,d={template:"sap.ovp.cards.linklist",settings:{staticContent:[]}};for(s=0;s<o.length;s++){if(r[o[s]]){d.settings[o[s]]=r[o[s]]}}for(s=0;s<t.length;s++){d.settings["staticContent"].push({});for(a=0;a<i.length;a++){if(t[s][i[a]]){d.settings["staticContent"][s][i[a]]=t[s][i[a]]}}for(a=0;a<n.length;a++){if(t[s][n[a]]){d.settings["staticContent"][s][n[a]]=t[s][n[a]]}}}return d}function D(t){var i=e.NewCardSettings,a;var s=this._oCardManifestSettings;i.forEach(function(t){if(t.template===this._oCardManifestSettings.template){a=t}}.bind(this));var n={model:this._oCardManifestSettings.model,template:a.template,settings:{}};if(!this._oCardManifestSettings["tabs"]){var r=a.cardSettings;var o=e.oI18nValueProperty;for(var d=0;d<r.length;d++){if(!t.bAddNewCardFlag){if(s[r[d]]){n.settings[r[d]]=s[r[d]]}}else{if(s[r[d]]){if(o[r[d]]){n.settings[r[d]]=this._oCardManifestSettings[o[r[d]]]}else{n.settings[r[d]]=s[r[d]]}}}}}else{var f=a.text;for(var d=0;d<f.length;d++){if(s[f[d]]){n.settings[f[d]]=s[f[d]]}}var l=this._oCardManifestSettings["tabs"],g=M(l,"tabs"),c=this._oCardManifestSettings.defaultViewSelected;n.settings["tabs"]=g;n.settings.selectedKey=c}return n}function T(t,e){var i=[];if(e){for(var a in e){var s=e[a];i.push({key:a,value:s.value[""],textType:s.type})}if(i.length){writeToI18n("/"+t+"/webapp/i18n",i)}}}function E(t,i,a,s){var o,d,f,l,g,c=a.settings["staticContent"],p=a.settings["tabs"];var u=e.cardSettingsWithText;var h=e.oI18nKeyValueProperty;for(d=0;d<u.length;d++){var C;if(typeof u[d]=="string"){if(a.settings[u[d]]){if(!o){o={}}if(s){if(!s.bAddNewCardFlag){C=n(t,i,"settings",u[d])}else{for(var v in h){if(u[d]===v){C=this._oCardManifestSettings[h[v]]?this._oCardManifestSettings[h[v]]:n(t,i,"settings",u[d]);break}}}}else{C=n(t,i,"settings",u[d])}o[C]=r(a.settings[u[d]]);a.settings[u[d]]="{{"+C+"}}"}}else if(typeof u[d]=="object"){if(u[d].hasOwnProperty("staticContent")){if(c){for(f=0;f<c.length;f++){for(l=0;l<u[d]["staticContent"].length;l++){g=u[d]["staticContent"][l];if(c[f][g]){if(!o){o={}}C=n(t,i,"settings.staticContent."+f,g);o[C]=r(c[f][g]);a.settings["staticContent"][f][g]="{{"+C+"}}"}}}}}else if(u[d].hasOwnProperty("tabs")){if(p){for(f=0;f<p.length;f++){for(l=0;l<u[d]["tabs"].length;l++){g=u[d]["tabs"][l];if(p[f][g]){if(!o){o={}}C=n(t,i,"settings.tabs."+f,g);o[C]=r(p[f][g]);a.settings["tabs"][f][g]="{{"+C+"}}"}}}}}}}return o}function F(t,e,i){var a=false;for(var s=0;s<i.length;s++){if(i[s].id!==e&&i[s].model===t){a=true;break}}return a}function O(t,e,i,a,s){var n={};n["appDescriptorChange"]={parameters:t};if(e){n["appDescriptorChange"]["texts"]=e}if(a){n["flexibilityChange"]={newAppDescriptor:i,oldAppDescriptor:a}}else{n["flexibilityChange"]=i}if(s){n["viewSwitchChange"]=s}return n}function U(e,i){var s={card:{}},n={},r=e.oMainComponent,d=r._getApplicationId(),l,c={},p=t.getQueryParameterValue("fiori-tools-rta-mode");if(e.bAddNewCardFlag){l=D.bind(this)(e)}else if(e.bNewStaticLinkListCardFlag){l=w.bind(this)(e)}else if(e.bNewKPICardFlag){l=N.bind(this)(e)}var u=t._getLayerNamespace()+i,h=1;while(f(u+"_N"+h,r)){h++}u=u+"_N"+h;g(l);n=a({},l);n.id=u;if(this._oCardManifestSettings.selectedKPI){n.settings.selectedKPI=a({},this._oCardManifestSettings.selectedKPI)}c.oFlexCardManifest=n;c.oText=E.bind(this)(d,u,l,e);if(p){T(d,a({},c.oText));c.oText=o()}s.card[u]=l;c.oParameters=s;return c}var K={sApplicationId:"",sCardId:"",aEntityPropertyChange:[],oText:undefined,getPayLoadForEditCard:function(e){var i=e.oAppDescriptor.id,s={cardId:i},n,r,d=a({},e.oAppDescriptor),f=a({},e.oAppDescriptor),l,g,c=t.getQueryParameterValue("fiori-tools-rta-mode");l=i.lastIndexOf(t._getLayerNamespace()+".",0)===0?"settings":t._getLayerNamespace()+".settings";K.sApplicationId=e.sApplicationId;K.sCardId=i;K.aEntityPropertyChange=[];K.oText=undefined;x.bind(this)(l,d);n=a({},K.oText);if(c){T(K.sApplicationId,K.oText);n=o()}r=K.aEntityPropertyChange;if(r.length===1){s["entityPropertyChange"]=r[0]}else{s["entityPropertyChange"]=r}if(this._oCardManifestSettings["tabs"]){var p=this._oCardManifestSettings.defaultViewSelected,u=this._oOriginalCardManifestSettings.selectedKey;u=u&&u>0?u:1;if(p&&p>0&&p!==u){g={cardId:i,selectedKey:p,oldKey:u}}d.settings.selectedKey=p}return O(s,n,d,f,g)},getPayLoadForCloneCard:function(e){return new Promise(function(i,s){var n={card:{}},r,d={},l=e.getComponentInstance().getComponentData(),c=l.mainComponent,p=c._getApplicationId(),u=a({},c._getCardFromManifest(l.cardId)),h=t.getQueryParameterValue("fiori-tools-rta-mode");var C=t._getLayerNamespace()+"."+u.id,v=1;while(f(C+"_C"+v,c)){v++}C=C+"_C"+v;g(u);d=a({},u);d.id=C;d.settings.title=d.settings.title+" "+v;u.settings.title=u.settings.title+" "+v;if(u.settings.defaultSpan&&u.settings.defaultSpan.showOnlyHeader){u.settings.defaultSpan.rows=12}r=E(p,C,u);if(h){T(p,a({},r));r=o()}n.card[C]=u;i(O(n,r,d))})},getPayLoadForNewStaticLinkListCard:function(t){var e=U.bind(this)(t,".newStaticLinkListCard");return O(e.oParameters,e.oText,e.oFlexCardManifest)},getPayLoadForNewKPICard:function(t){var e=U.bind(this)(t,".newKPICard"),i=t.oAppComponent,a=e.oFlexCardManifest,n=e.oParameters,r=a.model+"_ANNO",o=t.getDataSources(r),d=true,f=0;if(o[r]){if(o[r].uri!==this._oCardManifestSettings.selectedKPI.ModelURI){while(o[r+"_"+f]){f++}r=r+"_"+f}else{d=false}}var l=i.getModel(a.model);if(!l){n["model"]={};n["model"][a.model]={dataSource:a.model,settings:{defaultCountMode:s.None}};n["dataSource"]={};n["dataSource"][a.model]={uri:this._oCardManifestSettings.selectedKPI.ODataURI,type:"OData",settings:{annotations:[r],localUri:""}};if(d){n["dataSource"][r]={uri:this._oCardManifestSettings.selectedKPI.ModelURI,type:"ODataAnnotation",settings:{localUri:""}};a.settings["sAnnoKey"]=r}}var g=O(n,e.oText,e.oFlexCardManifest);if(d&&l){g["addODataAnnotation"]={parameters:{dataSourceId:a.model,annotations:[r],dataSource:{}}};g["addODataAnnotation"].parameters.dataSource[r]={uri:this._oCardManifestSettings.selectedKPI.ModelURI,type:"ODataAnnotation",settings:{localUri:""}};g["flexibilityChange"].settings["sAnnoKey"]=r}return g},getPayLoadForNewCard:function(t){var e=U.bind(this)(t,".newCard"),i=e.oParameters;if(t.newDataSource){var a=t.oAppComponent,n=e.oFlexCardManifest,r=t.newDataSourceModel.serviceAnnotation,o=t.getDataSources(r),d=true,f=0;if(o[r]){if(o[r].uri!==t.newDataSourceModel.serviceAnnotationURI){while(o[r+"_"+f]){f++}r=r+"_"+f}else{d=false}}var l=a.getModel(n.model);if(!l){i["model"]={};i["model"][n.model]={dataSource:n.model,settings:{defaultCountMode:s.None}};i["dataSource"]={};i["dataSource"][n.model]={uri:t.newDataSourceModel.serviceURI,type:"OData",settings:{annotations:[r],localUri:""}};if(d){i["dataSource"][r]={uri:t.newDataSourceModel.serviceAnnotationURI,type:"ODataAnnotation",settings:{localUri:""}}}}}return O(e.oParameters,e.oText,e.oFlexCardManifest)},getPayLoadForRemoveCard:function(t){var e={},i={},a=t.getComponentInstance().getComponentData(),s=a.cardId;e["cardId"]=s;i.id=t.getId();var n=O(e,null,i),r=a.mainComponent.getUIModel().getProperty("/cards");if(!F(a.modelName,s,r)&&!!a.modelName){n["removeDataSourceChange"]=[];var o=a.appComponent,d=o.getManifestEntry("sap.ui5").models[a.modelName].dataSource,f=o.getManifestEntry("sap.app").dataSources[d].settings.annotations;f.forEach(function(t){n["removeDataSourceChange"].push({parameters:{dataSourceId:t}})})}return n}};return K},true);
//# sourceMappingURL=PayLoadUtils.js.map