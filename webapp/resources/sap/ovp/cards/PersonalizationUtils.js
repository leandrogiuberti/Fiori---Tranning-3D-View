/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ovp/cards/CommonUtils","sap/ui/fl/write/api/ControlPersonalizationWriteAPI","sap/ovp/app/OVPLogger"],function(n,a,t){"use strict";var e=new t("OVP.cards.PersonanlizationUtils");function r(n,a){a.every(function(a){if(a.id===n.cardId){a.selectedKey=n.selectedKey;return false}return true});return a}function o(n,a){a.every(function(a){if(a.id===n.cardId){a.visibility=n.visibility;return false}return true});return a}function i(a,t,e){var r=n.getApp(),o=r._getCardId(a.id);t.every(function(n){if(n.id===o){n.visibility=e;return false}return true});return t}function d(n,a){var t=[];var e,r;e=a.filter(function(n){return n.visibility});a.forEach(function(n,a){if(!n.visibility){t.push({card:n,index:a})}});if(!e[n.position]){return a}if(e[n.position].id!==n.cardId){var o=a.findIndex(function(a){return a.id===n.cardId});r=e[o];if(r){e[o]=e[n.position];e[n.position]=r}}t.forEach(function(n){e.splice(n.index,0,n.card)});a=e;return a}function u(n,a){a.every(function(a){if(a.id===n.cardId&&a.dashboardLayout){Object.keys(n.dashboardLayout).forEach(function(t){if(!a.dashboardLayout[t]){a.dashboardLayout[t]={}}if(n.dashboardLayout[t].rowSpan){a.dashboardLayout[t].rowSpan=n.dashboardLayout[t].rowSpan}if(n.dashboardLayout[t].colSpan){a.dashboardLayout[t].colSpan=n.dashboardLayout[t].colSpan}if(n.dashboardLayout[t].maxColSpan){a.dashboardLayout[t].maxColSpan=n.dashboardLayout[t].maxColSpan}if(n.dashboardLayout[t].noOfItems){a.dashboardLayout[t].noOfItems=n.dashboardLayout[t].noOfItems}if(n.dashboardLayout[t].hasOwnProperty("autoSpan")){a.dashboardLayout[t].autoSpan=n.dashboardLayout[t].autoSpan}if(n.dashboardLayout[t].row){a.dashboardLayout[t].row=n.dashboardLayout[t].row}if(n.dashboardLayout[t].column){a.dashboardLayout[t].col=n.dashboardLayout[t].column}if(n.dashboardLayout[t].hasOwnProperty("showOnlyHeader")){a.dashboardLayout[t].showOnlyHeader=n.dashboardLayout[t].showOnlyHeader}});return false}return true});return a}function s(n,a){if(!Array.isArray(a)||!n){return n}var t=[];n.forEach(function(n){var a={};Object.keys(n).forEach(function(t){a[t]=n[t]});t.push(a)});var e={VENDOR:[],CUSTOMER_BASE:[],CUSTOMER:[],USER:[]};var s=a.reduce(function(n,a){n[a.getLayer()].push(a);return n},e);var c=[].concat(s["VENDOR"],s["CUSTOMER_BASE"],s["CUSTOMER"],s["USER"]);c.forEach(function(n){switch(n.getChangeType()){case"viewSwitch":t=r(n.getContent(),t);break;case"visibility":t=o(n.getContent(),t);break;case"hideCardContainer":t=i(n.getContent().card,t,false);break;case"unhideCardContainer":t=i(n.getContent().card,t,true);break;case"position":t=d(n.getContent(),t);break;case"dragOrResize":t=u(n.getContent(),t);break;default:break}});return t}function c(n,a){var t=n.filter(function(n){var t=false;a.forEach(function(a){if(n.id===a.id){t=true;return}});return!t});return a.concat(t)}function f(n,a){return n.some(function(n){return n.changeType==="position"&&n.content.cardId===a.cardId})}function h(a){var t=n.getApp();var e=t.deltaChanges;var r=e.filter(function(n){return n.getChangeType()==="position"});for(var o=0;o<r.length;o++){var i=r[o].getContent();var d=f(a,i);if(!d){a.push({content:r[o].getContent(),changeType:"position",isUserDependent:true})}}}function y(a){if(!a||!a.content||!a.content.cardId){return}var t=a.content.cardId;var e=n.getApp();var r=e.getUIModel().getProperty("/aOrderedCards");var o=r.findIndex(function(n){return n.id===t&&n.visibility});if(o!==-1&&a.content.position!==o){a.content.position=o}}function p(t,r){var o=n.getApp();var i={};if(o.getOwnerComponent()){i=o.getOwnerComponent().oOvpConfig}if(o.getUIModel().getProperty("/bRTAActive")||i.bInsightDTEnabled){return}var d=r?r.byId("ovpLayout"):null;var u=[],s=[],c=[];if(!Array.isArray(t)){t=[t]}if(t.length){h(t)}t.forEach(function(n){var a=n.content.cardId;if(n.changeType==="position"){y(n)}n.jsOnly=true;u.push({selectorElement:r.byId(a),changeSpecificData:n});s.push(r.byId(a));c.push(n.changeType)});a.isCondensingEnabled().then(function(n){if(n){return b(u,d)}else{return l(s,c).finally(function(){return b(u,d)})}}).then(function(){e.info("Personalization changes have been saved in lrep backend")}).catch(function(n){e.error("Personalization changes were not saved",n)})}function l(n,t){return a.reset({selectors:n,changeTypes:t})}function b(n,t){return a.add({changes:n},true).then(function(n){return a.save({changes:n,selector:t})})}var v={mergeChanges:s,addMissingCardsFromManifest:c,savePersonalization:p,applyPositionChange:d};return v},true);
//# sourceMappingURL=PersonalizationUtils.js.map