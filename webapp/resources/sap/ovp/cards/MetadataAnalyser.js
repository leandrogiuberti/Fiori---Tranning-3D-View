/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 * @fileoverview
 * This file is intended to do all the operations like, property extraction, parsing on Metadata(OData V2) of the application.
 */
sap.ui.define(["sap/ovp/app/OVPLogger","sap/base/security/encodeURL","sap/ui/model/analytics/odata4analytics","sap/fe/navigation/SelectionVariant","sap/base/util/each"],function(e,t,a,r,n){"use strict";var i=new e("OVP.cards.MetadataAnalyser");function o(e,t){if(!e||!e.getMetaModel){throw new Error("OData Model needs to be passed as an argument")}var a=e.getMetaModel();var r=a.getODataEntitySet(t);var n=a.getODataEntityType(r.entityType);return n.property?Array.from(n.property):[]}function s(e,t,a){if(!e||!e.getMetaModel){throw new Error("OData Model needs to be passed as an argument")}var r=e.getMetaModel();var n={entitySetName:null,parameters:[],navPropertyName:null};var i=r.getODataEntitySet(t);var o=r.getODataEntityType(i.entityType);var s=o.navigationProperty;if(!s){return n}s.filter(function(e){var t=r.getODataAssociationEnd(o,e.name);var s=r.getODataEntityType(t.type);if(s["sap:semantics"]==="parameters"&&s.key){n.entitySetName=r.getODataAssociationSetEnd(o,e.name).entitySet;for(var m=0;m<s.key.propertyRef.length;m++){if(a){var p=s.property;for(var y=0;y<p.length;y++){if(p[y].name===s.key.propertyRef[m].name){n.parameters.push(p[y]);n.entitySetName=r.getODataAssociationSetEnd(o,e.name).entitySet}}}else{n.parameters.push(s.key.propertyRef[m].name)}}var l=s.navigationProperty;var u=l.some(function(e){var t=r.getODataAssociationEnd(s,e.name).type;t===i.entityType?n.navPropertyName=e.name:Function.prototype();return n.navPropertyName});return u&&n.navPropertyName&&n.entitySetName}return false});return n}function m(e,t){if(!e||!e.getMetaModel){throw new Error("OData Model needs to be passed as an argument")}var a=e.getMetaModel();var r=a.getODataEntitySet(t);if(r&&r.entityType){var n=a.getODataEntityType(r.entityType);if(n["sap:semantics"]&&n["sap:semantics"]==="aggregate"){return true}}return false}function p(e,t){if(t&&t.property){return t.property.filter(function(t){return t.name===e})}return[]}function y(e,t){return e.filter(function(e){if(e.name===t){return e}})}function l(e,a,r,n){var m="";var p=[];if(n&&n.Parameters){e.parameters.forEach(function(r){n.Parameters.forEach(function(n){var i=n.PropertyName.PropertyPath.split("/");i=i[i.length-1];if(i===r){var o=n.PropertyValue.String;o=t(a.formatValue(o,e["parameterType"][r]));p.push(i+"="+o)}})});var l=n.Parameters.map(function(e){return e&&e.PropertyName&&e.PropertyName.PropertyPath});var u=s(a,r.name);if(u.entitySetName){var f=o(a,u.entitySetName);var v=u.parameters.filter(function(e){return!l.includes(e)});for(var g=0;g<v.length;g++){var P=v[g].split("/");var c=P[P.length-1];var h=y(f,c);var d=false;if(h.length>0){var S=h[0];d=S.type==="Edm.String"&&S["sap:parameter"]==="optional"}if(d){p.push(c+"="+"")}}}}else{m="/"+r.name;i.error("SelectionParameters","There are no parameters to resolve");return m}try{m="/"+e.entitySetName+"("+p.join(",")+")/"+e.navPropertyName}catch(e){m="/"+r.name;i.error("getEntitySetPathWithParameters","binding path with parameters failed - "+e||e.message)}return m}function u(e,t,m,p,l,u){var f=[];var v="";var g=new a.Model(a.Model.ReferenceByModel(e));var P=g.findQueryResultByName(t.name);var c=new a.QueryResultRequest(P);var h=P.getParameterization();if(!h){v="/"+t.name;return u?f:v}if(l){var d=l.getAnalyticalParameters()}if(h){var S;c.setParameterizationRequest(new a.ParameterizationRequest(h));if(m&&m.Parameters){n(m.Parameters,function(){if(this.RecordType==="com.sap.vocabularies.UI.v1.IntervalParameter"){S=this.PropertyNameFrom.PropertyPath.split("/");c.getParameterizationRequest().setParameterValue(S[S.length-1],this.PropertyValueFrom.String,this.PropertyValueTo.String)}else{S=this.PropertyName.PropertyPath.split("/");c.getParameterizationRequest().setParameterValue(S[S.length-1],this.PropertyValue.String)}});var E=m.Parameters.map(function(e){return e&&e.PropertyName&&e.PropertyName.PropertyPath});var N=s(e,t.name);if(N.entitySetName){var M=o(e,N.entitySetName);var O=N.parameters.filter(function(e){return!E.includes(e)});for(var R=0;R<O.length;R++){S=O[R].split("/");var T=S[S.length-1];var w=y(M,T);var D=false;if(w.length>0){var V=w[0];D=V.type==="Edm.String"&&V["sap:parameter"]==="optional";f.push(V)}if(D){c.getParameterizationRequest().setParameterValue(T,"")}}}}else if(p&&p.length>0){n(p,function(){c.getParameterizationRequest().setParameterValue(this.path,this.value)})}else if(d&&d.length>0){var z=l&&l.getUiState({allFilters:false});var A=z?JSON.stringify(z.getSelectionVariant()):"{}";var m=new r(A);for(var b in h.getAllParameters()){for(var R=0;R<d.length;R++){if(d[R]&&d[R].name==b){var q=d[R].name;var k=m.getParameter(q);if(!k){var F=m.getSelectOption(q);k=F&&F[0]&&F[0].Low}c.getParameterizationRequest().setParameterValue(b,k)}}}}else{v="/"+t.name;i.error("SelectionParameters","There are no parameters to resolve");return u?f:v}}try{v=c.getURIToQueryResultEntitySet()}catch(e){P=c.getQueryResult();v="/"+P.getEntitySet().getQName();i.error("getEntitySetPathWithParameters","binding path with parameters failed - "+e||e.message)}return u?f:v}function f(e,t,a,r,n){var i="";if(m(e,t.name)){i=u(e,t,a,r,n)}else{var p=s(e,t.name);var y=o(e,t.name);var f={};if(p){p["parameters"].forEach(function(e){y.forEach(function(t){if(t["name"]==e){f[e]=t["type"]}})});p["parameterType"]=f;i=l(p,e,t,a)}else{i="/"+t.name}}return i}return{getPropertyOfEntitySet:o,getParametersByEntitySet:s,checkAnalyticalParameterisedEntitySet:m,getPropertyFromEntityType:p,resolveTransactionalParameterizedEntitySet:l,resolveAnalyticalParameterizedEntitySet:u,resolveParameterizedEntitySet:f}});
//# sourceMappingURL=MetadataAnalyser.js.map