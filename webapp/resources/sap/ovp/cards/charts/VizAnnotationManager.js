/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 * @fileOverview Library to Manage rendering of Viz Charts.
 * Any function that needs to be exported(used outside this file) via namespace should be defined as
 * a function and then added to the return statement at the end of this file
 */
sap.ui.define(["sap/ovp/cards/generic/base/analytical/Utils","sap/ui/model/odata/CountMode","sap/ovp/cards/AnnotationHelper","sap/ui/core/format/NumberFormat","sap/ui/core/format/DateFormat","sap/viz/ui5/controls/VizTooltip","sap/ovp/cards/CommonUtils","sap/ovp/cards/OVPCardAsAPIUtils","sap/viz/ui5/data/DimensionDefinition","sap/viz/ui5/data/MeasureDefinition","sap/viz/ui5/controls/common/feeds/FeedItem","sap/ui/core/Element","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/base/util/each","sap/base/util/merge","sap/ovp/app/OVPLogger","sap/ovp/insights/helpers/AnalyticalCard","sap/ovp/cards/NavigationHelper","sap/ovp/cards/Constants","sap/ovp/cards/MetadataAnalyser","sap/ovp/cards/Filterhelper","sap/ovp/cards/generic/base/analytical/VizAnnotationManagerHelper","sap/ui/thirdparty/jquery"],function(e,t,r,a,i,n,o,s,l,u,f,v,p,c,g,m,h,P,d,y,A,E,_,jQuery){"use strict";var T=y.Annotations;var C=y.errorMessages;var b=[T.COLUMNSTACKED_CHARTTYPE,T.DONUT_CHARTTYPE,T.COLUMN_CHARTTYPE,T.BAR_CHARTTYPE,T.VERTICALBULLET_CHARTTYPE,T.LINE_CHARTTYPE,T.COMBINATION_CHARTTYPE,T.BUBBLE_CHARTTYPE];var S=[T.COLUMNSTACKED_CHARTTYPE];var N;var D=new h("OVP.charts.VizAnnotationManager");function I(a,i,n,o,s,l,u){var f="{";if(!a||!a.getSetting("ovpCardProperties")){D.error(C.ANALYTICAL_CONFIG_ERROR);f+="}";return f}var v=a.getSetting("dataModel");var p;if(u&&u.EnumMember){p=u.EnumMember.split("/");if(p&&p[1]==="Donut"){v.setDefaultCountMode(t.Inline)}if(p&&p[1]!="Donut"&&s===undefined){return null}}var c=[];var h=[];var P=[];var d=[];var y=[];var _=[];var b=[];var S=n&&n.Parameters;var N=o&&o.SortOrder;var I=o&&o.MaxItems,M=null;var x;var V;var Y;var L=null;var F=T.TEXT_KEY;var U=T.TEXT_KEY_V4;var K=T.UNIT_KEY;var k=T.UNIT_KEY_V4_ISOCurrency;var w=T.UNIT_KEY_V4_Unit;var B={};if(I){M=I.Int32?I.Int32:I.Int}if(M){if(M==="0"){D.error("OVP-AC: Analytic card Error: maxItems is configured as "+M);f+="}";return f}if(!/^\d+$/.test(M)){D.error("OVP-AC: Analytic card Error: maxItems is Invalid. Please enter an Integer.");f+="}";return f}}var z=a.getSetting("ovpCardProperties"),j=z.getProperty("/parameters"),H=z.getProperty("/metaModel");S=S||!!j;if(S){var G=A.resolveParameterizedEntitySet(v,i,n,j);f+="path: '"+G+"'"}else{f+="path: '/"+i.name+"'"}var W=[];L=a.getSetting("ovpCardProperties").getProperty("/entitySet");if(!v||!L){return f}var X=e.getMetadata(v,L);var q=a.getSetting("ovpCardProperties").getProperty("/cardLayout");var Q=1,$;var J=e.getConfig();var Z;var ee;if(s&&q&&q.colSpan&&q.colSpan>1){$=q.colSpan-Q;for(var te in J){if((ee=J[te].reference)&&J[ee]){var re=m({},J[ee]);J[te]=re}if(te===p[1]||J[te].time&&J[te].time.type===p[1].toLowerCase()){Z=J[te];break}}var ae=e.hasTimeSemantics(s,Z,v,L);if(ae){Z=Z.time}else{Z=Z.default}var ie=a.getSetting("ovpCardProperties").getProperty("/dataStep");if(!ie){if(Z.resize&&Z.resize.hasOwnProperty("dataStep")&&!isNaN(Z.resize.dataStep)){ie=Z.resize.dataStep}}ie=parseInt(ie,10);if($>0&&ie&&!isNaN(ie)){M=parseInt(M,10)+ie*$}}if(n){var z=a.getSetting("ovpCardProperties");W=E.getFilters(z,n)}if(W.length>0){W=E.createExcludeFilters(W,z);f+=", filters: "+JSON.stringify(W)}if(N){var ne=o.SortOrder;if(!ne.length){ne=e.getSortAnnotationCollection(v,o,i)}if(ne.length<1){D.warning(C.CARD_WARNING+C.SORTORDER_WARNING)}else{var oe="";var se;var le;var ue;for(var fe=0;fe<ne.length;fe++){se=ne[fe];ue=se.Property.PropertyPath;b.push(ue);if(typeof se.Descending==="undefined"){le="true"}else{var ve=se.Descending.Bool||se.Descending.Boolean;if(!ve){D.warning(C.CARD_WARNING+C.BOOLEAN_ERROR);le="true"}else{le=ve.toLowerCase()==="true"?"true":"false"}}oe=oe+"{path: '"+ue+"',descending: "+le+"},"}f+=", sorter: ["+oe.substring(0,oe.length-1)+"]"}}var pe=a.getSetting("ovpCardProperties").getProperty("/entityType");g(l,function(e,t){x=t.Measure.PropertyPath;if(t.DataPoint&&t.DataPoint.AnnotationPath){var r=pe[t.DataPoint.AnnotationPath.substring(1)];if(r.ForecastValue&&(r.ForecastValue.PropertyPath||r.ForecastValue.Path)){var a=r.ForecastValue.PropertyPath||r.ForecastValue.Path;y.push(a);if(X&&X[a]){var i;if(X[a][k]){i=X[a][k].Path?X[a][k].Path:undefined}else if(X[a][w]){i=X[a][w].Path?X[a][w].Path:undefined}else if(X[a][K]){i=X[a][K]}if(i){if((y?Array.prototype.indexOf.call(y,i):-1)===-1){y.push(i)}}}}if(r.TargetValue&&(r.TargetValue.PropertyPath||r.TargetValue.Path)){var n=r.TargetValue.PropertyPath||r.TargetValue.Path;y.push(n);if(X&&X[n]){var i;if(X[n][k]){i=X[n][k].Path?X[n][k].Path:undefined}else if(X[n][w]){i=X[n][w].Path?X[n][w].Path:undefined}else if(X[n][K]){i=X[n][K]}if(i){if((y?Array.prototype.indexOf.call(y,i):-1)===-1){y.push(i)}}}}}y.push(x);if(X&&X[x]){if(X[x][U]){if(X[x][U].String&&x!=X[x][U].String){y.push(X[x][U].String?X[x][U].String:x)}else if(X[x][U].Path&&x!=X[x][U].Path){y.push(X[x][U].Path?X[x][U].Path:x)}}else if(X[x][F]&&x!=X[x][F]){y.push(X[x][F]?X[x][F]:x)}}if(X&&X[x]){var i;if(X[x][k]){i=X[x][k].Path?X[x][k].Path:undefined}else if(X[x][w]){i=X[x][w].Path?X[x][w].Path:undefined}else if(X[x][K]){i=X[x][K]}if(i){if((y?Array.prototype.indexOf.call(y,i):-1)===-1){y.push(i)}}}});g(s,function(e,t){x=t.Dimension.PropertyPath;c.push(x);if(X&&X[x]){if(X[x][U]){if(X[x][U].String&&x!=X[x][U].String){c.push(X[x][U].String?X[x][U].String:x)}else if(X[x][U].Path&&x!=X[x][U].Path){Y=X[x][U].Path;var r=Y.split("/");if(r.length>1){V=R(H,pe,Y);if(V!==""){c.push(Y);h.push(V);d=O(H,pe,Y);if(d.length>0){P=P.concat(d)}}}else{c.push(Y?Y:x)}}}else if(X[x][F]&&x!=X[x][F]){c.push(X[x][F]?X[x][F]:x)}}});if(P.length>0){var ce=0;while(ce<P.length){if(c.indexOf(P[ce])!==-1){P.splice(ce,1)}else{ce++}}}if(y.length>0){g(y,function(e,t){B[t]=true})}if(c.length>0){g(c,function(e,t){B[t]=true})}f+=", parameters: {select:'"+[].concat(c,y).join(",");var ge=H.getODataEntityType(i.entityType);if(ge){var me=r.getRequestFields(o);if(me&&me.length>0){g(me,function(e,t){if(!B.hasOwnProperty(t)){B[t]=true;_.push(t)}});if(_.length>0){f+=","+_.join(",")}}}if(b.length>0){var he=[];g(b,function(e,t){if(!B.hasOwnProperty(t)){he.push(t)}});if(he.length>0){f+=","+he.join(",")}}if(h.length>0){f+="'"+","+" expand:'"+h.join(",")}var Pe=r.checkFilterPreference(a.getSetting("ovpCardProperties"));if(Pe){f+="', custom: {cardId: '"+a.getSetting("ovpCardProperties").getProperty("/cardId")+"', _requestFrom: 'ovp_internal'}}"}else{f+="', custom: {_requestFrom: 'ovp_internal'}}"}if(p&&p[1]==="Donut"&&s===undefined){f+=", length: 1"}else if(p&&p[1]==="Donut"&&s&&M){f+=", length: "+(parseInt(M,10)+1)}else if(M){f+=", length: "+M}f+="}";return f}I.requiresIContext=true;function R(e,t,r){var a="";var i=r.split("/");if(i.length>1){for(var n=0;n<i.length-1;n++){var o=e.getODataAssociationEnd(t,i[n]);if(o){t=e.getODataEntityType(o.type);if(a){a=a+"/"}a=a+i[n]}else{return a}}}return a}function O(e,t,r){var a=[];var i=[];var n;var o=r.split("/");if(o.length>1){for(var s=0;s<o.length-1;s++){var l=e.getODataAssociationEnd(t,o[s]);if(l){t=e.getODataEntityType(l.type);if(t){i=t&&t.key&&t.key.propertyRef;for(var u=0;u<i.length;u++){n=o[s]+"/"+i[u].name;a.push(n)}}}}}return a}function M(e,t){var r=false;var a;if(e.DataPoint&&e.DataPoint.AnnotationPath){var i=t[e.DataPoint.AnnotationPath.substring(1)];if(i&&i.ForecastValue&&(i.ForecastValue.PropertyPath||i.ForecastValue.Path)){r=true;a=e}}if(r===true){return a}else{D.warning(C.CARD_WARNING+C.INVALID_FORECAST);return undefined}}function x(e,t){var r=false;var a;if(e.DataPoint&&e.DataPoint.AnnotationPath){var i=t[e.DataPoint.AnnotationPath.substring(1)];if(i&&i.TargetValue&&(i.TargetValue.PropertyPath||i.TargetValue.Path)){r=true;a=e}}if(r===true){return a}else{D.warning(C.CARD_WARNING+C.INVALID_TARGET);return undefined}}function V(e,t){var r;g(t,function(t,a){if(a.name===e){if(a["com.sap.vocabularies.Common.v1.Label"]){r=a["com.sap.vocabularies.Common.v1.Label"].String?a["com.sap.vocabularies.Common.v1.Label"].String:a["com.sap.vocabularies.Common.v1.Label"].Path}else if(a["sap:label"]){r=a["sap:label"]}return false}});return r}function Y(e,t){var r=true;if(t==="line"||t==="column"||t==="bar"){g(e,function(e,t){if(t.getUid()==="valueAxis"||t.getUid()==="categoryAxis"){if(t.getValues().length!=1){r=false;D.warning(C.CARD_WARNING+C.INVALID_DIMMEAS);return false}}})}else if(t==="vertical_bullet"){g(e,function(e,t){if(t.getUid()==="actualValues"||t.getUid()==="categoryAxis"){if(t.getValues().length!=1){r=false;D.warning(C.CARD_WARNING+C.INVALID_DIMMEAS);return false}}})}if(r===true){return true}}function L(t,r){var a=t.getModel();var i=t.getVizType();if(i!="line"&&i!="bubble"){return}if(!r){r=i==="line"?"categoryAxis":"valueAxis"}var n=t.getModel("ovpCardProperties").getProperty("/entitySet");if(!a||!n){return}var o=e.getMetadata(a,n);var s=t.getFeeds();for(var l=0;l<s.length;l++){if(s[l].getUid()===r){var u=s[l].getValues();if(!u){return}for(var f=0;f<u.length;f++){var v=o[u[f]];if(v&&v[T.TYPE_KEY]!="Edm.DateTime"){return}}var p={categoryAxis:{title:{visible:false}},legend:{itemMargin:1.25}};t.setVizProperties(p);var c=t&&t.getModel("ovpCardProperties");if(c&&c.getProperty("/bInsightEnabled")){var g=t&&t.getId();P.setVizPropertyMap(g,p)}return}}}function F(e,t,r){}function U(t,a,i){var n=r.isODataV4Context(t);var o="";var s=e.getConfig(a,n);var l,u;if(!s){return o}o=s.default.type;l=t.getSetting("dataModel");u=t.getSetting("ovpCardProperties").getProperty("/entitySet");if(e.hasTimeSemantics(i,s,l,u,n)){o=s.time.type}return o}U.requiresIContext=true;function K(e,t){var r={boolFlag:false};g(e,function(e,a){if(a.DataPoint&&a.DataPoint.AnnotationPath){var i=t[a.DataPoint.AnnotationPath.substring(1)];_.updateFlagValueForDataPoint(i,r)}});if(r.boolFlag===true&&e.length>1){D.warning(C.CARD_WARNING+C.INVALID_SEMANTIC_MEASURES)}return r.boolFlag}function k(e,t,r,a){var i=_.getMeasureName(e,r,a);var n=e.DataPoint.AnnotationPath;var o=t[n.substring(1)];return _.getSemanticLegends(o,true,i,a)}function w(e,t,r){if(e[t[r].PropertyPath][T.EDM_TYPE]===T.EDM_INT32){return true}return false}function B(e,t,r){if(e[t[r].PropertyPath][T.EDM_TYPE]===T.EDM_INT64){return true}return false}function z(e,t,r){if(!e.length){return}var a=r==="dimension"?"Dimension":"Measure";var i=[];g(e,function(e,t){if(!t||!t[a]||!t[a].PropertyPath){D.error(C.INVALID_CHART_ANNO);return false}i.push(t[a].PropertyPath)});var n=jQuery.map(t.feeds,function(e){if(e.type===r){if(e.role){return e.role.split("|")}return[]}});n=jQuery.grep(n,function(e,t){return(n?Array.prototype.indexOf.call(n,e):-1)===t}).join(", ");D.error(C.CARD_ERROR+C.INVALID_REDUNDANT+r+"(s) "+i.join(", ")+". "+C.ALLOWED_ROLES+t.type+C.CHART_IS+n)}function j(t,r,a){var i,o,v,c,h;var d,A,E,I,R,O=false;var L;var F,U,j;var X,$=[],J=[];var Z=[];var ee;var te;var re=a&&a.getView();var ae,se;var le=re&&re.getModel("ui");var ue=le&&le.getProperty("/chartSettings");i=t.getModel("ovpCardProperties");if(s.checkIfAPIIsUsed(a)){O=i&&i.getData()&&i.getData().showDataLabel}h=ue?ue.showDataLabel:O;d=t.getVizType();A=e.getConfig();for(var fe in A){if((te=A[fe].reference)&&A[te]){var ve=m({},A[te]);A[fe]=ve}if(A[fe].default.type===d||A[fe].time&&A[fe].time.type===d){E=A[fe];break}}if(!E){D.error(C.CARD_ERROR+"in "+C.CARD_CONFIG+C.CARD_CONFIG_ERROR+d+" "+C.CARD_CONFIG_JSON);return}if(!i){D.error(C.CARD_ERROR+"in "+C.CARD_CONFIG+C.NO_CARD_MODEL);return}var pe=t.getModel();var ce=i.getProperty("/entitySet");if(!pe||!ce){return}o=i.getProperty("/entityType");if(!o){D.error(C.CARD_ANNO_ERROR+"in "+C.CARD_ANNO);return}var ge=e.getMetadata(pe,ce);v=i.getProperty("/chartAnnotationPath");if(!v||!(c=o[v])){D.error(C.CARD_ANNO_ERROR+"in "+C.CARD_ANNO);return}var me=G(o,v,t);if(!(I=c.DimensionAttributes)||!I.length){D.error(C.CHART_ANNO_ERROR+"in "+C.CHART_ANNO+" "+C.DIMENSIONS_MANDATORY);return}var he;if(!(R=c.MeasureAttributes)||!R.length){D.error(C.CHART_ANNO_ERROR+"in "+C.CHART_ANNO+" "+C.MEASURES_MANDATORY);return}else{var Pe=R[0].DataPoint?o[R[0].DataPoint.AnnotationPath.substring(1)]:null;var de=Pe&&Pe.ValueFormat&&Pe.ValueFormat.NumberOfFractionalDigits&&Pe.ValueFormat.NumberOfFractionalDigits.Int;he=de?de:0}ee=e.hasTimeSemantics(I,E,pe,ce);if(ee){E=E.time}else{E=E.default}var ye=i.getProperty("/ChartProperties")||i.getProperty("/chartProperties");if(i&&i.getProperty("/tabs")&&ye===undefined){ae=re.byId("ovp_card_dropdown");se=parseInt(ae.getSelectedKey(),10);ye=i.getProperty("/tabs")&&i.getProperty("/tabs")[se-1]&&(i.getProperty("/tabs")[se-1]["ChartProperties"]||i.getProperty("/tabs")[se-1]["chartProperties"])}var Ae=false;var Ee=he>0?"tooltipNoScaleFormatter/"+he.toString()+"/":"tooltipNoScaleFormatter/-1/";var _e=new n({formatString:Ee});_e.connect(t.getVizUid());_e.connect(t.getVizUid());t._oOvpVizFrameTooltip=_e;var Te=[];var Ce=S.indexOf(c.ChartType.EnumMember)>=0;if(Ce&&t&&t.getModel("analyticalmodel")){Te=t.getModel("analyticalmodel").getData()||[]}[E.dimensions,E.measures].forEach(function(e,t){var r=t?R:I;var a=t?"measure(s)":"dimension(s)";if(e.min&&r.length<e.min){D.error(C.CARD_ERROR+"in "+d+" "+C.CARD_LEAST+e.min+" "+a);Ae=true}if(e.max&&r.length>e.max){D.error(C.CARD_ERROR+"in "+d+C.CARD_MOST+e.max+" "+a);Ae=true}});if(Ae){return}var be=true;if(E.properties&&E.properties.hasOwnProperty("hideLabel")&&!E.properties["hideLabel"]){be=false}if(E.type&&(E.type==="timeseries_bullet"||E.type==="timeseries_stacked_column")){_.enableTimeAxisForChart(E,i)}var Se=true;var Ne=false;if(d==="donut"){Ne=true}t.removeAllAggregation();L={legend:{isScrollable:false,itemMargin:1.25},title:{visible:true},interaction:{noninteractiveMode:Se?false:true,selectability:{legendSelection:Ne?true:false,axisLabelSelection:false,mode:"EXCLUSIVE",plotLassoSelection:false,plotStdSelection:true},zoom:{enablement:"disabled"}},plotArea:{window:{start:"firstDataPoint",end:"lastDataPoint"},dataLabel:{visible:h||Ne?true:false,type:"value"},dataPoint:{invalidity:"ignore"},alignment:{vertical:"top"}},categoryAxis:{label:{truncatedLabelRatio:.15}},general:{groupData:false,showAsUTC:true}};if(E.properties&&E.properties.semanticColor===true&&K(R,o)){var De=p.getText("GOOD");var Ie=p.getText("BAD");var Re=p.getText("CRITICAL");var Oe=p.getText("OTHERS");if(R.length===1){var Me=k(R[0],o,ge,t);var De=Me[0]||De,Ie=Me[1]||Ie,Re=Me[2]||Re,Oe=p.getText("OTHERS")}L.plotArea.dataPointStyle={rules:[{callback:function(r){var a=e.mapMeasures(r,ge,R);if(!a){return false}var i=o[a.substring(1)];var n=_.formThePathForCriticalityStateCalculation(r,i,t);if(n===y.Criticality.StateValues.Positive){return true}else if(n==="Positive"){return true}},properties:{color:"sapUiChartPaletteSemanticGoodLight1"},displayName:De},{callback:function(r){var a=e.mapMeasures(r,ge,R);if(!a){return false}var i=o[a.substring(1)];var n=_.formThePathForCriticalityStateCalculation(r,i,t);if(n===y.Criticality.StateValues.Critical){return true}else if(n==="Critical"){return true}},properties:{color:"sapUiChartPaletteSemanticCriticalLight1"},displayName:Re},{callback:function(r){var a=e.mapMeasures(r,ge,R);if(!a){return false}var i=o[a.substring(1)];var n=_.formThePathForCriticalityStateCalculation(r,i,t);if(n===y.Criticality.StateValues.Negative){return true}else if(n==="Negative"){return true}},properties:{color:"sapUiChartPaletteSemanticBadLight1"},displayName:Ie},{callback:function(r){var a=e.mapMeasures(r,ge,R);if(!a){return false}var i=o[a.substring(1)];var n=_.formThePathForCriticalityStateCalculation(r,i,t);if(n===y.Criticality.StateValues.None){return true}else if(n==="Neutral"){return true}},properties:{color:"sapUiChartPaletteSemanticNeutralLight1"},displayName:Oe}]}}var xe=i.getProperty("/bEnableStableColors");var Ve=i.getProperty("/colorPalette");var Ye;if(!xe&&b.indexOf(c.ChartType.EnumMember)>=0&&Ve&&Object.keys(Ve).length>=2&&Object.keys(Ve).length<=4){g(I,function(e,t){if(t&&t.Role&&t.Role.EnumMember==="com.sap.vocabularies.UI.v1.ChartDimensionRoleType/Series"){Ye=t.Dimension&&t.Dimension.PropertyPath;return}});var Le;if(Ye){if(ge&&ge[Ye]){if(ge[Ye][T.LABEL_KEY_V4]){Le=_.getLabelFromAnnotationPath(ge[Ye][T.LABEL_KEY_V4].String?ge[Ye][T.LABEL_KEY_V4].String:ge[Ye][T.LABEL_KEY_V4].Path,t,ge)}else if(ge[Ye][T.LABEL_KEY]){Le=ge[Ye][T.LABEL_KEY]}else if(Ye){Le=Ye}}if(Ve instanceof Array){var Fe=Ve.map(function(e){return e.color});var Ue=Ve.map(function(e){return e.legendText});var Ke=Ue[0]!=undefined?Ue[0]:p.getText("OTHERS");var ke=Ue[1]!=undefined?Ue[1]:p.getText("BAD");var we=Ue[2]!=undefined?Ue[2]:p.getText("CRITICAL");var Be=Ue[3]!=undefined?Ue[3]:p.getText("GOOD")}L.plotArea.dataPointStyle={rules:[{callback:function(e){if(e&&(e[Le]==="3"||e[Le]===3)){if(Ve instanceof Array){if(Ve.length<4){return false}}else if(Ve&&!Ve.hasOwnProperty(3)){return false}return true}},properties:{color:Ve instanceof Array&&Fe.length?Fe[3]:Ve[3]&&Ve[3]["color"]},displayName:Be||Ve[3]&&Ve[3]["legendText"]},{callback:function(e){if(e&&(e[Le]==="2"||e[Le]===2)){if(Ve instanceof Array){if(Ve.length<3){return false}}else if(Ve&&!Ve.hasOwnProperty(2)){return false}return true}},properties:{color:Ve instanceof Array&&Fe.length?Fe[2]:Ve[2]&&Ve[2]["color"]},displayName:we||Ve[2]&&Ve[2]["legendText"]},{callback:function(e){if(e&&(e[Le]==="1"||e[Le]===1)){return true}},properties:{color:Ve instanceof Array&&Fe.length?Fe[1]:Ve[1]&&Ve[1]["color"]},displayName:ke||Ve[1]&&Ve[1]["legendText"]},{callback:function(e){if(e&&(e[Le]==="0"||e[Le]===0)){return true}},properties:{color:Ve instanceof Array&&Fe.length?Fe[0]:Ve[0]&&Ve[0]["color"]},displayName:Ke||Ve[0]&&Ve[0]["legendText"]}]};var ze;if(i&&i.getProperty("/bInsightEnabled")){ze=m({},L.plotArea.dataPointStyle);var je=ge&&ge[Ye]&&ge[Ye].type||"";ze.rules.forEach(function(e,t,r){delete e["callback"];e.dataContext={};if(je){e.dataContext[Le]=je==="Edm.String"?r.length-1-t+"":r.length-1-t}else{e.dataContext[Le]=r.length-1-t+""}})}}}var He=false;var Ge=false;if(c.ChartType.EnumMember===T.SCATTER_CHARTTYPE||c.ChartType.EnumMember===T.BUBBLE_CHARTTYPE||c.ChartType.EnumMember===T.LINE_CHARTTYPE){if(c&&c.AxisScaling&&c.AxisScaling.RecordType=="com.sap.vocabularies.UI.v1.ChartAxisScalingType"){var We=c.AxisScaling;if(We.AutoScaleBehavior&&We.AutoScaleBehavior.RecordType=="com.sap.vocabularies.UI.v1.ChartAxisAutoScaleBehaviorType"){var Xe=We.AutoScaleBehavior;if(Xe.ZeroAlwaysVisible&&Xe.ZeroAlwaysVisible.Bool=="true"){L.plotArea.adjustScale=false;He=true}else if(Xe.DataScope){L.plotArea.adjustScale=true;He=true}}else if(We.RecordType=="com.sap.vocabularies.UI.v1.ChartAxisScalingType"&&We.ScaleBehavior&&We.ScaleBehavior.EnumMember){var qe=We.ScaleBehavior.EnumMember;var Qe=qe.substring(qe.lastIndexOf("/")+1,qe.length);if(Qe=="FixedScale"){Ge=true}}}else if(c&&c.AxisScaling&&c.AxisScaling.EnumMember){var $e=c.AxisScaling.EnumMember.substring(c.AxisScaling.EnumMember.lastIndexOf("/")+1,c.AxisScaling.EnumMember.length);switch($e){case"AdjustToDataIncluding0":L.plotArea.adjustScale=false;He=true;break;case"AdjustToData":L.plotArea.adjustScale=true;He=true;break;case"MinMaxValues":Ge=true;break;default:break}}if(Ge){var Je=[];if(c["MeasureAttributes"][0]&&c["MeasureAttributes"][0].DataPoint&&c["MeasureAttributes"][0].DataPoint.AnnotationPath){var Ze=c["MeasureAttributes"][0].DataPoint.AnnotationPath;var et=Ze.substring(Ze.lastIndexOf("@")+1,Ze.length);if(o&&o[et]){var tt=o[et];if(tt&&tt.MaximumValue&&tt.MaximumValue.Decimal&&tt.MinimumValue&&tt.MinimumValue.Decimal){Je.push({feed:"valueAxis",max:tt.MaximumValue.Decimal,min:tt.MinimumValue.Decimal});He=true}else{D.error(C.ERROR_MISSING_AXISSCALES)}}}if(c.ChartType.EnumMember!==T.LINE_CHARTTYPE&&c["MeasureAttributes"][1]&&c["MeasureAttributes"][1].DataPoint&&c["MeasureAttributes"][1].DataPoint.AnnotationPath){var Ze=c["MeasureAttributes"][1].DataPoint.AnnotationPath;var et=Ze.substring(Ze.lastIndexOf("@")+1,Ze.length);if(o&&o[et]){var tt=o[et];if(tt&&tt.MaximumValue&&tt.MaximumValue.Decimal&&tt.MinimumValue&&tt.MinimumValue.Decimal){Je.push({feed:"valueAxis2",max:tt.MaximumValue.Decimal,min:tt.MinimumValue.Decimal});He=true}else{D.error(C.ERROR_MISSING_AXISSCALES)}}}t.setVizScales(Je)}}U=I.slice();j=R.slice();var rt=0;var at=0;var it;var nt;var ot=false;var st=false;var lt;var ut=[];var ft=[],vt=[];if((d==="column"||d==="bar"||d==="vertical_bullet")&&E.feeds&&E.feeds.length>0){var pt;for(pt=0;pt<E.feeds.length;pt++){if(E.feeds[pt].uid==="color"){E.feeds.splice(pt,1);break}}for(pt=0;pt<E.feeds.length;pt++){if(E.feeds[pt].uid==="categoryAxis"){delete E.feeds[pt].role;break}}if(i.getProperty("/colorPalette")){for(pt=0;pt<E.feeds.length;pt++){if(E.feeds[pt].uid==="categoryAxis"){E.feeds[pt].role="Category";break}}E.feeds.push({uid:"color",min:1,type:"dimension",role:"Series"})}}g(E.feeds,function(r,a){var n=a.uid;var s=[];if(a.type){var v,p,c;if(a.type==="dimension"){v=I.length;p="Dimension";c="dimensions";F=U;X=$}else{v=R.length;p="Measure";c="measures";F=j;X=J}var m=0,h=v;if(a.min){m=m>a.min?m:a.min}if(a.max){h=h<a.max?h:a.max}if(!a.role){var y=F.length;for(var A=0;A<y&&s.length<h;++A){var b=F[A];F.splice(A,1);--y;--A;s.push(b);if(ge[b[p].PropertyPath][T.UNIT_KEY_V4_ISOCurrency]){lt=ge[b[p].PropertyPath][T.UNIT_KEY_V4_ISOCurrency].Path?ge[b[p].PropertyPath][T.UNIT_KEY_V4_ISOCurrency].Path:undefined}else if(ge[b[p].PropertyPath][T.UNIT_KEY_V4_Unit]){lt=ge[b[p].PropertyPath][T.UNIT_KEY_V4_Unit].Path?ge[b[p].PropertyPath][T.UNIT_KEY_V4_Unit].Path:undefined}else if(ge[b[p].PropertyPath][T.UNIT_KEY]){lt=ge[b[p].PropertyPath][T.UNIT_KEY]}if(e.isMeasureCurrency(ge,lt)){ot=true}else{st=true}if(!ot){rt=e.checkNumberFormat(rt,b,o);it=e.getMaxScaleFactor(it,b,o)}else{at=e.checkNumberFormat(at,b,o);nt=e.getMaxScaleFactor(nt,b,o)}}}else{var S=a.role.split("|");g(S,function(t,r){if(s.length===h){return false}var a=F.length;for(var i=0;i<a&&s.length<h;++i){var n=F[i];if(n&&n.Role&&n.Role.EnumMember&&n.Role.EnumMember.split("/")&&n.Role.EnumMember.split("/")[1]){var l=n.Role.EnumMember.split("/")[1];if(l===r){F.splice(i,1);--a;--i;s.push(n);if(ge[n[p].PropertyPath][T.UNIT_KEY_V4_ISOCurrency]){lt=ge[n[p].PropertyPath][T.UNIT_KEY_V4_ISOCurrency].Path?ge[n[p].PropertyPath][T.UNIT_KEY_V4_ISOCurrency].Path:undefined}else if(ge[n[p].PropertyPath][T.UNIT_KEY_V4_Unit]){lt=ge[n[p].PropertyPath][T.UNIT_KEY_V4_Unit].Path?ge[n[p].PropertyPath][T.UNIT_KEY_V4_Unit].Path:undefined}else if(ge[n[p].PropertyPath][T.UNIT_KEY]){lt=ge[n[p].PropertyPath][T.UNIT_KEY]}if(e.isMeasureCurrency(ge,lt)){ot=true}else{st=true}if(!ot){rt=e.checkNumberFormat(rt,n,o);it=e.getMaxScaleFactor(it,n,o)}else{at=e.checkNumberFormat(at,n,o);nt=e.getMaxScaleFactor(nt,n,o)}}}else if((X?Array.prototype.indexOf.call(X,n):-1)===-1){X.push(n)}}});if(s.length<h){g(X,function(t,r){var a;var i;if((a=E[c].defaultRole)&&(S?Array.prototype.indexOf.call(S,a):-1)!==-1&&(i=(F?Array.prototype.indexOf.call(F,r):-1)!==-1)){F.splice(i,1);s.push(r);if(ge[r[p].PropertyPath][T.UNIT_KEY_V4_ISOCurrency]){lt=ge[r[p].PropertyPath][T.UNIT_KEY_V4_ISOCurrency].Path?ge[r[p].PropertyPath][T.UNIT_KEY_V4_ISOCurrency].Path:undefined}else if(ge[r[p].PropertyPath][T.UNIT_KEY_V4_Unit]){lt=ge[r[p].PropertyPath][T.UNIT_KEY_V4_Unit].Path?ge[r[p].PropertyPath][T.UNIT_KEY_V4_Unit].Path:undefined}else if(ge[r[p].PropertyPath][T.UNIT_KEY]){lt=ge[r[p].PropertyPath][T.UNIT_KEY]}if(e.isMeasureCurrency(ge,lt)){ot=true}else{st=true}if(!ot){rt=e.checkNumberFormat(rt,r,o);it=e.getMaxScaleFactor(it,r,o)}else{at=e.checkNumberFormat(at,r,o);nt=e.getMaxScaleFactor(nt,r,o)}if(s.length===h){return false}}})}if(s.length<m){D.error(C.CARD_ERROR+C.MIN_FEEDS+d+" "+C.FEEDS_OBTAINED+s.length+" "+C.FEEDS_REQUIRED+m+" "+C.FEEDS);return false}}if(s.length){var O=[];var M;if(!(M=t.getDataset())){D.error(C.NO_DATASET);return false}N=o;g(s,function(e,r){if(!r||!r[p]||!r[p].PropertyPath){D.error(C.INVALID_CHART_ANNO);return false}var a=r[p].PropertyPath;var o=a;var s=a;var f=null;if(ge&&ge[a]){if(ge[a][T.LABEL_KEY_V4]){if(ge[a][T.LABEL_KEY_V4].String){o=_.getLabelFromAnnotationPath(ge[a][T.LABEL_KEY_V4].String,t,ge)}else if(ge[a][T.LABEL_KEY_V4].Path){o=ge[a][T.LABEL_KEY_V4].Path}else{o=a}}else if(ge[a][T.LABEL_KEY]){o=ge[a][T.LABEL_KEY]}else if(a){o=a}if(ge[a][T.TEXT_KEY_V4]){s=ge[a][T.TEXT_KEY_V4].String?ge[a][T.TEXT_KEY_V4].String:ge[a][T.TEXT_KEY_V4].Path}else if(ge[a][T.TEXT_KEY]){s=ge[a][T.TEXT_KEY]}else if(a){s=a}f=ge[a][T.TYPE_KEY]||null}var v,c={};c[a]=s;if((f==="Edm.DateTime"||f==="Edm.DateTimeOffset")&&s===a){v="{= ${"+a+"} ? ${"+a+"} : ''}"}else{if(ge[a]&&ge[a][T.TEXT_KEY_V4]&&ge[a][T.TEXT_KEY_V4][T.TEXT_ARRANGEMENT_ANNO]){var g,m;g=ge[a][T.TEXT_ARRANGEMENT_ANNO];m=g&&g.EnumMember;if(!m){g=ge[a][T.TEXT_KEY_V4][T.TEXT_ARRANGEMENT_ANNO];m=g&&g.EnumMember}if(!m){var h=N;g=h&&h[T.TEXT_ARRANGEMENT_ANNO];m=g&&g.EnumMember}var d;switch(m){case"com.sap.vocabularies.UI.v1.TextArrangementType/TextFirst":v="{"+s+"}"+" "+"("+"{"+a+"}"+")";if(Ce&&Te.length){d=H(a,s,Te);for(var y in d){d[y]=d[y]+" "+"("+y+")"}Z[a]=d}break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextLast":v="{"+a+"}"+" "+"("+"{"+s+"}"+")";if(Ce&&Te.length){d=H(a,s,Te);for(var A in d){d[A]=A+" "+"("+d[A]+")"}Z[a]=d}break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly":v="{"+s+"}";if(Ce&&Te.length){Z[a]=H(a,s,Te)}break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextSeperate":v="{"+a+"}"+" "+"("+"{"+s+"}"+")";break;default:v="{"+a+"}";c[a]=a;break}}else{v="{"+s+"}"}if(i&&i.getProperty("/bInsightEnabled")){P.setDimensionPath(i.getData().cardId,a,v)}}O.push(o);if(p==="Dimension"){if(n==="waterfallType"){var E=new l({name:o,value:"{"+a+"}"})}else{var E=new l({name:o,value:"{"+a+"}",displayValue:v})}var b=ge[a][T.SEMANTICS_KEY];var S=ge[a]["com.sap.vocabularies.Common.v1.IsCalendarYear"]&&ge[a]["com.sap.vocabularies.Common.v1.IsCalendarYear"].Bool||ge[a]["com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]&&ge[a]["com.sap.vocabularies.Common.v1.IsCalendarYearMonth"].Bool||ge[a]["com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]&&ge[a]["com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"].Bool||ge[a]["com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]&&ge[a]["com.sap.vocabularies.Common.v1.IsCalendarYearWeek"].Bool;if(ee&&(f==="Edm.DateTime"||S||f==="Edm.DateTimeOffset"||b&&b.lastIndexOf("year",0)===0)){E.setDataType("date")}M.addDimension(E);if((vt?Array.prototype.indexOf.call(vt,o):-1)===-1){vt.push(o)}}else{M.addMeasure(new u({name:o,value:"{"+a+"}"}));if((ft?Array.prototype.indexOf.call(ft,o):-1)===-1&&n!="bubbleWidth"){ft.push(o)}}});t.addFeed(new f({uid:n,type:p,values:O}));if(n==="categoryAxis"){L[n]={title:{visible:be?false:true,text:O.join(", ")},label:{formatString:ot?"CURR":"axisFormatter",truncatedLabelRatio:.15}}}else{L[n]={title:{visible:be?false:true,text:O.join(", ")},label:{formatString:ot?"CURR":"axisFormatter"}}}ut.push(L[n]);if(E.hasOwnProperty("vizProperties")){var x=0;var V=E.vizProperties.length;var Y;var K;for(;x<V;x++){if(E.vizProperties[x].hasOwnProperty("value")){K=E.vizProperties[x].value}if(E.vizProperties[x].hasOwnProperty("path")){Y=E.vizProperties[x].path.split(".");var k=Y.length;var w,B;var z;for(var G=0,z=Y[0],w=L,B=ye;G<k;++G){if(G===k-1){if(B&&B.hasOwnProperty(z)){if(d==="donut"&&(B[z]==="value"||B[z]==="percentage")){K=B[z]}else if(d!="donut"){K=B[z]}}if(He&&z!="adjustScale"||!He&&z==="adjustScale"||!He&&z!="adjustScale"){w[z]=K}break}w[z]=w[z]||{};w=w[z];if(B){B[z]=B[z]||{};B=B[z]}z=Y[G+1]}}}}if(a.hasOwnProperty("vizProperties")){var r=0;var W=a.vizProperties.length;var q;var Q;var te;for(;r<W;r++){if(a.vizProperties[r].hasOwnProperty("method")){Q=a.vizProperties[r].method;switch(Q){case"count":q=O.length;if(a.vizProperties[r].hasOwnProperty("min")&&q<=a.vizProperties[r].min){q=a.vizProperties[r].min}else if(a.vizProperties[r].hasOwnProperty("max")&&q>=a.vizProperties[r].max){q=a.vizProperties[r].max}break;default:break}}else if(a.vizProperties[r].hasOwnProperty("value")){q=a.vizProperties[r].value}if(a.vizProperties[r].hasOwnProperty("path")){te=a.vizProperties[r].path.split(".");var re=te.length;for(var A=0,ae=te[0],ie=L;A<re;++A){if(A===re-1){ie[ae]=q;break}ie[ae]=ie[ae]||{};ie=ie[ae];ae=te[A+1]}}}}}}});var ct=t.getFeeds();if(E.properties&&E.properties.semanticPattern===true&&Y(ct,d)){g(ct,function(e,r){if(ct[e].getType()==="Measure"&&(ct[e].getUid()==="valueAxis"||ct[e].getUid()==="actualValues")){var a;g(R,function(t,r){var i=V(r.Measure.PropertyPath,ge);if(i===ct[e].getValues()[0]){a=M(r,o);return false}});if(a){var i=V(a.Measure.PropertyPath,ge);var n=o[a.DataPoint.AnnotationPath.substring(1)].ForecastValue.PropertyPath||o[a.DataPoint.AnnotationPath.substring(1)].ForecastValue.Path;var s=V(n,ge);var l=p.getText("ACTUAL",[i]);var f=p.getText("FORECAST",[s]);L.plotArea.dataPointStyle={rules:[{dataContext:{MeasureNamesDimension:i},properties:{color:"sapUiChartPaletteSequentialHue1Light1",lineType:"line",lineColor:"sapUiChartPaletteSequentialHue1Light1"},displayName:l},{dataContext:{MeasureNamesDimension:s},properties:{color:"sapUiChartPaletteSequentialHue1Light1",lineType:"dotted",lineColor:"sapUiChartPaletteSequentialHue1Light1",pattern:"diagonalLightStripe"},displayName:f}]};t.getDataset().addMeasure(new u({name:s,value:"{"+n+"}"}));var v=ct[e].getValues();v.push(s);ct[e].setValues(v)}return false}})}var gt=false;if(Ve&&Ve.dimensionSettings&&Object.keys(Ve.dimensionSettings).length>0){var mt=Object.keys(Ve.dimensionSettings);for(var ht=0;ht<mt.length;ht++){var Pt=mt[ht];var dt=Ve.dimensionSettings[Pt];if(Object.keys(dt).length>10){gt=true;break}}}if(xe&&Ce&&!gt){var yt=[];var At=true;for(var ht=0;ht<I.length;ht++){var Et=I[ht].Dimension.PropertyPath;yt.push(Et)}for(var ht=0;ht<yt.length;ht++){var Pt=yt[ht];if(mt.indexOf(Pt)>-1){var _t=Ve.dimensionSettings[Pt];var Tt=Object.keys(_t);var Ct=[];for(var ht=0;ht<Tt.length;ht++){var bt=_t[Tt[ht]];Ct.push(bt)}At=At&&Ct.every(ne)}}if(At){var St=[];for(var ht=0;ht<yt.length;ht++){var Pt=yt[ht];if(mt.indexOf(Pt)>-1){var _t=Ve.dimensionSettings[Pt];var Tt=Object.keys(_t);var Ct=[];for(var ht=0;ht<Tt.length;ht++){var bt=_t[Tt[ht]];Ct.push(bt)}ie(Ct);for(var Nt=0;Nt<Ct.length;Nt++){var Dt=Ct[Nt].dimensionValue;var It=Ct[Nt].color;var bt={properties:{color:It}};bt.dataContext={};var Rt=W(ge,t,Pt);bt.dataContext[Rt]=Dt;var Ot=Z[Pt]?Z[Pt][Dt]:Dt;bt.displayName=Ot;St.push(bt)}}}L.plotArea.dataPointStyle=L.plotArea.dataPointStyle||{};L.plotArea.dataPointStyle["rules"]=St}else{var St=[];for(var ht=0;ht<yt.length;ht++){var Pt=yt[ht];if(mt.indexOf(Pt)>-1){var _t=Ve.dimensionSettings[Pt];var Tt=Object.keys(_t);var Ct=[];for(var ht=0;ht<Tt.length;ht++){var bt=_t[Tt[ht]];Ct.push(bt)}ie(Ct);var Mt=Ct.map(oe)}}L.legend.order=function(e,t){var r=Mt.indexOf(e);var a=Mt.indexOf(t);return r>a?1:-1}}}if(E.properties&&E.properties.semanticPattern===true&&Y(ct,d)&&t.getVizType()==="vertical_bullet"){g(ct,function(e,r){if(ct[e].getType()==="Measure"&&(ct[e].getUid()==="valueAxis"||ct[e].getUid()==="actualValues")){var a;g(R,function(t,r){var i=V(r.Measure.PropertyPath,ge);if(i===ct[e].getValues()[0]){a=x(r,o);return false}});if(a){var i=o[a.DataPoint.AnnotationPath.substring(1)].TargetValue.PropertyPath||o[a.DataPoint.AnnotationPath.substring(1)].TargetValue.Path;var n=V(i,ge);t.getDataset().addMeasure(new u({name:n,value:"{"+i+"}"}));t.addFeed(new f({uid:"targetValues",type:"Measure",values:[n]}))}return false}})}if(ot&&st){D.warning(p.getText("Currency_non_currency_measure"))}g(ct,function(e,t){var r=t.getProperty("type");if(r==="Measure"){var a=t.getProperty("values");var i=true;var n=c.MeasureAttributes.filter(function(e){return a.indexOf(ge[e[r]["PropertyPath"]][T.LABEL_KEY])>=0||a.indexOf(ge[e[r]["PropertyPath"]][T.LABEL_KEY_V4])>=0});g(n,function(e,t){if(w(ge,t,r)||B(ge,t,r)){i=false}else{i=true;return false}});if(!i){L[t.getProperty("uid")]["label"]["allowDecimals"]=false}}});var xt;if(nt===undefined){nt=""}if(it===undefined){it=""}if(ot){xt=Q(nt,ot)}else{xt=Q(it,ot)}if(r){r.setScale(xt)}var Vt=q(ft,vt,me);var Yt="";g(ct,function(e,t){var r="-1";var a=t.getProperty("type");if(a==="Measure"){var i=ut.filter(function(e){var r=e["title"]["text"].split(",").filter(function(e){if(t.getValues().indexOf(e.trim())>=0){return true}else{return false}});if(r.length>0){return true}else{return false}});if(i&&i.length){var n=t.getValues();if(n&&n.length){g(n,function(e,t){var i=t.trim();var n=R.filter(function(e){if(e["Measure"]&&e["Measure"]["PropertyPath"]){var t=e["Measure"]["PropertyPath"];if(ge[t]&&ge[t][T.LABEL_KEY]===i||ge[t]&&ge[t][T.LABEL_KEY_V4]===i){return true}else{return false}}});if(n&&n.length){var s=n[0];if(!w(ge,s,a)&&!B(ge,s,a)){var l="";if(s&&s["DataPoint"]&&s["DataPoint"]["AnnotationPath"]&&s["DataPoint"]["AnnotationPath"]){l=s["DataPoint"]["AnnotationPath"]&&s["DataPoint"]["AnnotationPath"].substring(1);if(l!=""){var u;u=o[l]&&o[l]["ValueFormat"]&&o[l]["ValueFormat"]["NumberOfFractionalDigits"]&&o[l]["ValueFormat"]["NumberOfFractionalDigits"]["Int"];r=u>r?u:r}}}else{r=r<"0"?"0":r}}})}}if(i&&i[0]&&i[0].label&&i[0].label.formatString){var s=i[0].label.formatString}Yt="";if(ot){if(s==="CURR"){Yt="CURR/"+r.toString()+"/"}else{Yt="axisFormatter/"+r.toString()+"/"}}else{Yt="axisFormatter/"+r.toString()+"/"}if(i&&i[0]){i[0].label.formatString=Yt}}});if(d==="vertical_bullet"){L["valueAxis"]={title:{visible:be?false:true},label:{formatString:Yt}}}var Lt="";var Ft="";if(ot){Lt=at.toString();Ft="CURR/"+at.toString()+"/"}else{Lt=rt.toString();Ft="axisFormatter/"+rt.toString()+"/"}if(d==="donut"||h){L.plotArea.dataLabel.formatString=Ft;if(L.plotArea.dataLabel.type==="percentage"){L.plotArea.dataLabel.formatString="0.0%/"+Lt+"/"}}z(U,E,"dimension");z(j,E,"measure");if(ee){var Ut=I[0].Dimension.PropertyPath;if(ge[Ut][T.SEMANTICS_KEY]==="yearmonth"||ge[Ut]["com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]){L.timeAxis.levels=["year","month"]}else if(ge[Ut][T.SEMANTICS_KEY]==="yearquarter"||ge[Ut]["com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]){L.timeAxis.levels=["year","quarter"]}else if(ge[Ut][T.SEMANTICS_KEY]==="yearweek"||ge[Ut]["com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]){L.timeAxis.levels=["year","week"]}else if(ge[Ut][T.SEMANTICS_KEY]==="year"||ge[Ut]["com.sap.vocabularies.Common.v1.IsCalendarYear"]){L.timeAxis.levels=["year"]}}L.title={text:me?me:Vt,alignment:"left",layout:{respectPlotPosition:false},style:{fontFamily:"72, 72full, Arial, Helvetica, sans-serif !important",fontSize:".875rem",fontWeight:"normal"}};t.setVizProperties(L);if(i&&i.getProperty("/bInsightEnabled")){var Kt=t&&t.getId();var kt=m({},L);if(ze!==undefined){kt.plotArea.dataPointStyle=ze}P.setVizPropertyMap(Kt,kt)}}function H(e,t,r){var a={};for(var i=0;i<r.length;i++){var n=r[i];if(n.hasOwnProperty(e)&&n.hasOwnProperty(t)){a[n[e]]=n[t]}}return a}function G(t,r,a){var i="";var n=t&&t[r]&&t[r].Title;if(n){i=n.String}return e.resolvei18nKeyToChartTitle(a,i)}function W(e,t,r){var a="";if(e&&e[r]){if(e[r][T.LABEL_KEY_V4]){a=_.getLabelFromAnnotationPath(e[r][T.LABEL_KEY_V4].String?e[r][T.LABEL_KEY_V4].String:e[r][T.LABEL_KEY_V4].Path,t,e)}else if(e[r][T.LABEL_KEY]){a=e[r][T.LABEL_KEY]}else if(r){a=r}}return a}function X(t,r){if(t&&(t.getVizType()==="bubble"||t.getVizType()==="scatter")){return}var a,i,n,o;var s;var l=T.UNIT_KEY;var u=T.UNIT_KEY_V4_ISOCurrency;var f=T.UNIT_KEY_V4_Unit;var v;var c=[];if(!(a=t.getModel("ovpCardProperties"))){D.error(C.CARD_ERROR+"in "+C.CARD_CONFIG+C.NO_CARD_MODEL);return}var m=t.getModel();var h=a.getProperty("/entitySet");if(!m||!h){return}i=a.getProperty("/entityType");if(!i){D.error(C.CARD_ANNO_ERROR+"in "+C.CARD_ANNO);return}var P=e.getMetadata(m,h);n=a.getProperty("/chartAnnotationPath");if(!n||!(o=i[n])){D.error(C.CARD_ANNO_ERROR+"in "+C.CARD_ANNO);return}if(!(s=o.MeasureAttributes)||!s.length){D.error(C.CHART_ANNO_ERROR+"in "+C.CHART_ANNO+" "+C.MEASURES_MANDATORY);return}g(s,function(e,t){v=t.Measure.PropertyPath;if(t.DataPoint&&t.DataPoint.AnnotationPath){var r=i[t.DataPoint.AnnotationPath.substring(1)];if(r.ForecastValue&&(r.ForecastValue.PropertyPath||r.ForecastValue.Path)){c.push(r.ForecastValue.PropertyPath||r.ForecastValue.Path)}}c.push(v)});var d=r?r.results:null;var y="";var A=true;var E=[];var _=t.getFeeds();g(_,function(e,t){if(t.getType()==="Measure"){E=E.concat(t.getValues())}});if(d){g(c,function(e,r){var a=W(P,t,r);if((E?Array.prototype.indexOf.call(E,a):-1)!=-1){if(P&&P[r]){var i;if(P[r][u]){i=P[r][u].Path?P[r][u].Path:P[r][u].String}else if(P[r][f]){i=P[r][f].Path?P[r][f].Path:P[r][f].String}else if(P[r][l]){i=P[r][l]}if(!i){A=false;return false}if(i&&P[i]){for(var e=0;e<d.length;e++){var n=d[e];if(A){if(y&&n[i]&&n[i]!=""&&y!=""&&y!=n[i]){A=false;break}}y=n[i];if(!y){A=false;break}}}}}})}var b="";if(A){if(y!=""){b=p.getText("IN_NO_SCALE",[y]);b=" "+b}var S=t.data("aria-label");if(S&&b&&S.indexOf(b)===-1){var N=S+b;t.data("aria-label",N,true)}var I=t.getVizProperties().title&&t.getVizProperties().title.text;if(I){var R=I.indexOf("|");if(R!==-1){var O=I.slice(R+2);if(O!==y){I=I.slice(0,R-1)}}var M={title:{visible:true,text:O===y?I:I+b,alignment:"left",layout:{respectPlotPosition:false},style:{fontFamily:"72, 72full, Arial, Helvetica, sans-serif !important",fontSize:".875rem",fontWeight:"normal"}}};t.setVizProperties(M)}}}function q(e,t,r){var a="",i="",n="";if(r){a=r}if(e&&e.length>1){for(var o=0;o<e.length-1;o++){if(i!=""){i+=", "}i+=e[o]}i=p.getText("MEAS_DIM_TITLE",[i,e[o]])}else if(e){i=e[0]}if(t&&t.length>1){for(var o=0;o<t.length-1;o++){if(n!=""){n+=", "}n+=t[o]}n=p.getText("MEAS_DIM_TITLE",[n,t[o]])}else if(t){n=t[0]}if(a===""){r=p.getText("NO_CHART_TITLE",[i,n])}return r}function Q(e,t){var r=1;var i;if(t){var n=a.getCurrencyInstance({style:"short",currencyCode:false,shortRefNumber:e});i=n.format(Number(r))}else{var o=a.getFloatInstance({style:"short",shortRefNumber:e});i=o.format(Number(r))}var s=i.slice(-1);return s}function $(t,a){t.attachSelectData(function(n){var l=c.bCRTLPressed?c.constants.explace:c.constants.inplace;c.bCRTLPressed=false;var u=t.getModel("ovpCardProperties");var f=t.getModel();var v=u.getProperty("/entitySet");var p=e.getMetadata(f,v);var m=[],h=[];var P={},y={};var A=t.getDataset().getDimensions();var E;for(var _=0;_<A.length;_++){m.push(A[_].getName())}var C=t.getDataset().getBinding("data").getCurrentContexts().map(function(e){return e.getObject()});if(n.getParameter("data")&&n.getParameter("data")[0]&&n.getParameter("data")[0].data){h=Object.keys(n.getParameter("data")[0].data);E=n.getParameter("data")[0].data._context_row_number;var b=t.getDataset().getBinding("data").getContexts()[E];var S=d.getEntityNavigationEntries(b,f,a.getEntityType(),a.getCardPropertiesModel())[0];if(C[E].$isOthers&&C[E].$isOthers===true){var N={},D=[];for(var I=0;I<m.length;I++){for(var R=0;R<h.length;R++){if(m[I]===h[R]){for(var O in p){if(p.hasOwnProperty(O)){var M=p[O][T.LABEL_KEY]||p[O][T.NAME_KEY]||p[O][T.NAME_CAP_KEY];if(M===h[R]){D.push(O)}}}}}}for(var _=0;_<D.length;_++){N[D[_]]=[];for(var I=0;I<C.length-1;I++){if(I!=E){N[D[_]].push(C[I][D[_]])}}}var x={$isOthers:true};var V={getObject:function(){return x},getOtherNavigationDimensions:function(){return N}};if(s.checkIfAPIIsUsed(a)){if(a.checkAPINavigation()){o.onContentClicked(V)}}else{if(S){t.vizSelection([],{clearSelection:true});a.doNavigation(V,S,l)}}}else{for(var I=0;I<m.length;I++){for(var R=0;R<h.length;R++){if(m[I]===h[R]){for(var O in p){if(p.hasOwnProperty(O)){var M=p[O][T.LABEL_KEY_V4]&&p[O][T.LABEL_KEY_V4].String||p[O][T.LABEL_KEY]||p[O][T.NAME_KEY]||p[O][T.NAME_CAP_KEY];if(M.match(/{@i18n>.+}/gi)){var Y=this.getModel("@i18n").getResourceBundle();M=Y.getText(M.substring(M.indexOf(">")+1,M.length-1))}if(M===h[R]){P[O]=C[E][O]}}}}for(var O in C[E]){if(p.hasOwnProperty(O)){y[O]=C[E][O]}}}}if(P){g(Object.keys(P),function(e,t){if(p[t]["type"]==="Edm.String"){if(p[t]["sap:semantics"]==="yearmonth"||p[t]["com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]){P[t]=P[t].constructor===Date?i.getDateTimeInstance({pattern:"YYYYMM"}).format(P[t]):P[t]}else if(p[t]["sap:semantics"]==="yearquarter"||p[t]["com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]){P[t]=P[t].constructor===Date?i.getDateTimeInstance({pattern:"YYYYQ"}).format(P[t]):P[t]}else if(p[t]["sap:semantics"]==="yearweek"||p[t]["com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]){P[t]=P[t].constructor===Date?i.getDateTimeInstance({pattern:"YYYYww"}).format(P[t]):P[t]}else if(p[t]["com.sap.vocabularies.Common.v1.IsFiscalYearPeriod"]&&p[t]["com.sap.vocabularies.Common.v1.IsFiscalYearPeriod"].Bool){var r=P[t];if(r.includes(".")){P[t]=r.split(".").reverse().join("")}else if(r.includes("/")){P[t]=r.split("/").reverse().join("")}}}})}if(y){g(Object.keys(y),function(e,t){if(p[t]["type"]==="Edm.String"){if(p[t]["sap:semantics"]==="yearmonth"||p[t]["com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]){y[t]=y[t].constructor===Date?i.getDateTimeInstance({pattern:"YYYYMM"}).format(y[t]):y[t]}else if(p[t]["sap:semantics"]==="yearquarter"||p[t]["com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]){y[t]=y[t].constructor===Date?i.getDateTimeInstance({pattern:"YYYYQ"}).format(y[t]):y[t]}else if(p[t]["sap:semantics"]==="yearweek"||p[t]["com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]){y[t]=y[t].constructor===Date?i.getDateTimeInstance({pattern:"YYYYww"}).format(y[t]):y[t]}else if(p[t]["com.sap.vocabularies.Common.v1.IsFiscalYearPeriod"]&&p[t]["com.sap.vocabularies.Common.v1.IsFiscalYearPeriod"].Bool){var r=y[t];if(r.includes(".")){y[t]=r.split(".").reverse().join("")}else if(r.includes("/")){y[t]=r.split("/").reverse().join("")}}}})}var L=u.getProperty("/entityType"),F=L[u.getProperty("/presentationAnnotationPath")];if(L){var U=r.getRequestFields(F);if(U&&U.length>0){g(U,function(e,t){if(!P.hasOwnProperty(t)){P[t]=C[E][t]}})}}var V={getObject:function(){return P},getAllData:function(){return y}};if(s.checkIfAPIIsUsed(a)){if(a.checkAPINavigation()){o.onContentClicked(V)}}else{if(S){t.vizSelection([],{clearSelection:true});a.doNavigation(V,S,l)}}}}})}function J(e){return e.EnumMember.endsWith("Bubble")}function Z(e){var t=false;if(!e||e.constructor!=Array||e.length<1||e[0].constructor!=Object||!e[0].Dimension||!e[0].Dimension.PropertyPath){D.error(C.CHART_ANNO_ERROR+"in "+C.CHART_ANNO+" "+C.DIMENSIONS_MANDATORY);return t}t=true;return t}function ee(e){var t=false;if(!e||e.constructor!=Array||e.length<1||e[0].constructor!=Object||!e[0].Measure||!e[0].Measure.PropertyPath){D.error(C.CHART_ANNO_ERROR+"in "+C.CHART_ANNO+" "+C.MEASURES_MANDATORY);return t}t=true;return t}function te(e){return e.name}function re(t,r,a){var i=r.getModel("ovpCardProperties");var n=e.getMaxItems(r,a);var o=+n.itemsLength;var s=+i.getProperty("/dataStep");if(o&&s){var l=t.colSpan-1;if(l>=0){o+=s*l;ae(r,o)}}}function ae(e,t){var r,a={},i=[];var n=e.getVizType();var o=e.getModel("ovpCardProperties");var s=o.getProperty("/entityType");var l=o.getProperty("/chartAnnotationPath");var u=s[l];var f=e.getParent();var p=f.getBinding("data");a.path=p.getPath();a.parameters={};if(p.mParameters&&p.mParameters.select){a.parameters.select=p.mParameters.select}a.parameters.custom=a.parameters.custom||{};a.parameters.custom._requestFrom="ovp_internal";a.filters=p.aApplicationFilters;a.sorter=p.aSorters;a.length=n==="donut"?t+1:t;a.template=new v;f.bindAggregation("data",a);if(n==="donut"){g(u.MeasureAttributes,function(e,t){i.push(t.Measure.PropertyPath)});r={};r.path=p.getPath();r.parameters={};r.parameters.select=i.join(",");r.filters=p.aApplicationFilters;r.sorter=p.aSorters;r.length=1;r.template=new v;f.bindAggregation("aggregateData",r)}f.updateBindingContext()}function ie(e){e.sort(function(e,t){if(e.index<t.index){return-1}if(e.index>t.index){return 1}return 0})}function ne(e){return e.color!==undefined}function oe(e){return e.dimensionValue}return{constants:T,errorMessages:C,formatItems:I,hideDateTimeAxis:L,checkNoData:F,getChartType:U,checkFlag:K,buildVizAttributes:j,setChartUoMTitle:X,getSelectedDataPoint:$,checkBubbleChart:J,dimensionAttrCheck:Z,measureAttrCheck:ee,getEntitySet:te,reprioritizeContent:re,getChartTitle:G,getNavigationPrefix:R,getAssociationKeys:O,getSapLabel:V,getMeasureDimCheck:Y,getPropertyTextColumnMap:H,getScaleUnit:Q,_sortColorsByIndex:ie,_checkRolesForProperty:z}},true);
//# sourceMappingURL=VizAnnotationManager.js.map