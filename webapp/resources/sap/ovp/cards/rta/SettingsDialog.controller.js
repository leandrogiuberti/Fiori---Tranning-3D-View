/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/cards/SettingsUtils","sap/ovp/cards/PayLoadUtils","sap/ovp/cards/rta/SettingsDialogConstants","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/ChangeReason","sap/ovp/cards/linklist/AnnotationHelper","sap/ovp/cards/v4/V4AnnotationHelper","sap/ovp/cards/AnnotationHelper","sap/ui/core/IconPool","sap/ui/core/mvc/ViewType","sap/m/Dialog","sap/m/Button","sap/ovp/cards/CommonUtils","sap/ui/Device","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/base/util/deepEqual","sap/base/util/merge","sap/ovp/app/OVPLogger","sap/ui/base/Event","sap/ui/model/odata/v2/ODataModel","sap/ui/model/odata/CountMode","sap/ui/core/mvc/View"],function(e,t,i,a,s,n,o,r,l,d,h,g,u,c,f,p,S,P,v,C,b,m,y,_,I,V,E,O){"use strict";var w=new _("OVP.rta.SettingDialog");return e.extend("sap.ovp.cards.rta.SettingsDialog",{_oCardManifestSettings:{},_aRefreshNotRequired:n._aRefreshNotRequired,_aRefreshRequired:n._aRefreshRequired,_updateManifestProperties:n._updateManifestProperties,aVariantNames:n.aVariantNames,oOvpResourceBundle:C,oMandatoryPropertiesKey:n.oMandatoryPropertiesKey,onInit:function(){a.oSaveButton.attachPress(this.onSaveButtonPress,this);a.oResetButton.attachPress(this.onResetButton,this);a.oMessagePopOverButton.attachPress(this.handleMessagePopoverPress,this)},onAfterRendering:function(){a.dialogBox.addStyleClass("sapOvpSettingsDialogBox");this.setEnablePropertyForResetAndSaveButton(false);this._oCardManifestSettings=this.getView().getModel().getData();this._oOriginalCardManifestSettings=y({},this._oCardManifestSettings);var e=this.getView(),t=e.getModel();if(!this._oCardManifestSettings.addNewCard){var i=e.byId("dialogCard");if(!i.getVisible()){i=e.byId("dialogCardNoPreview")}i.getDomRef().style.minHeight=this._oCardManifestSettings.dialogBoxHeight+"px";e.byId("dialogCardOverlay").getDomRef().style.minHeight=this._oCardManifestSettings.dialogBoxHeight+"px";a.settingFormWidth(e,"calc(100% - "+(this._oCardManifestSettings.dialogBoxWidth+1)+"rem)");setTimeout(function(){var e=this.getView().byId("dialogCard");if(e&&e.getVisible()){e.setBusy(false)}}.bind(this),2e3)}if(this._oCardManifestSettings.staticContent){this.handleErrorHandling(t,"title","/staticContent");this.handleErrorHandling(t,"targetUri","/staticContent")}if(a.bNewKPICardFlag){var s=e.getModel();var n=e.byId("sapOvpKPITable").getBinding("items").getLength();s.setProperty("/NoOfKPIItem",n);s.setProperty("/NoKPI",n)}},validateInputField:function(e){var t=e.getSource();var i=t.getValue().trim().length;if(!i){t.setValue(t.getValue().trim())}if(!this._oCardManifestSettings.addNewCard){this.updateCard(e)}else{this.setEnablePropertyForResetAndSaveButton(true)}},addView:function(e){this._oCardManifestSettings.showViewSwitchButton=true;this.setEnablePropertyForResetAndSaveButton(true);var t,i=this._oCardManifestSettings,a=this.getView().getModel();if(!i.addNewCard){if(i.dataPointAnnotationPath&&i.dataPoint&&i.dataPoint.length){t=i.dataPoint[0].value}}if(i.tabs&&i.tabs.length){i.newViewCounter++;if(!i.addNewCard){if(i.template==="sap.ovp.cards.charts.analytical"||i.template==="sap.ovp.cards.charts.smart.chart"){i.tabs.push({chartAnnotationPath:i.chart[0].value,dataPointAnnotationPath:t,value:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter})}else{i.tabs.push({annotationPath:i.lineItem[0].value,dataPointAnnotationPath:t,value:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter})}}else{i.tabs.push({entitySet:"",value:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter})}var s=i.tabs.length;i.aViews.push({text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter,key:s,isLaterAddedView:true,isViewResetEnabled:false});if(!i.addNewCard){var o=i.defaultViewSelected;if(i.tabs[o-1].entitySet){i.tabs[s-1].entitySet=i.allEntitySet[0].value}}this.selectViewSwitch(e,s)}else{i.tabs=[{}];n.tabFields.forEach(function(e){if(!i.addNewCard){if(e!=="entitySet"){i.tabs[0][e]=i[e]}}else{i.tabs[0][e]=i[e]}});i.tabs[0].value=this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 1";if(!i.addNewCard){if(i.template==="sap.ovp.cards.charts.analytical"||i.template==="sap.ovp.cards.charts.smart.chart"){i.tabs.push({chartAnnotationPath:i.chart[0].value,dataPointAnnotationPath:t,value:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2"})}else{i.tabs.push({annotationPath:i.lineItem[0].value,dataPointAnnotationPath:t,value:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2"})}}else{i.tabs.push({entitySet:"",value:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2"})}i.selectedKey=1;i.defaultViewSelected=1;i.aViews=[{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_MAIN_VIEW"),key:0,isLaterAddedView:false,isViewResetEnabled:false},{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 1 ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")",key:1,initialSelectedKey:1,isLaterAddedView:false,isViewResetEnabled:false},{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2",key:2,isLaterAddedView:true,isViewResetEnabled:false}];i.newViewCounter=2;this.selectViewSwitch(e,1)}this.handleErrorHandling(a,"value","/tabs")},deleteView:function(e){this.setEnablePropertyForResetAndSaveButton(true);var t=this._oCardManifestSettings,i=parseInt(t.selectedKey,10),s=this.getView().getModel();t.tabs.splice(i-1,1);t.aViews.splice(i,1);if(i===t.defaultViewSelected){t.defaultViewSelected=1;t.aViews[i].text=t.aViews[i].text+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")"}t.aViews.forEach(function(e,t){if(t>=i){e.key--}});this.handleErrorHandling(s,"value","/tabs");if(t.tabs.length==1){n.tabFields.forEach(function(e){var i=t.tabs[0][e];if(e!=="entitySet"||e==="entitySet"&&i){t[e]=i}});delete t.selectedKey;delete t.defaultViewSelected;delete t.tabs;delete t.aViews;t.aViews=[{text:this.oOvpResourceBundle.getText("OVP_KEYUSER_SHOWS_DIFFERENT_VIEWS"),key:0,initialSelectedKey:0,isLaterAddedView:false,isViewResetEnabled:false}];a.addManifestSettings(t);a.setVisibilityForFormElements(t);this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();if(!t.addNewCard){this._fCardWithRefresh()}}else{t.selectedKey=1;this.selectViewSwitch(e,t.selectedKey)}},resetView:function(){var e=this._oCardManifestSettings,t=this.getView().getModel(),i=parseInt(e.selectedKey,10),s=e.aViews[i],o=e.defaultViewSelected;if(!s.isLaterAddedView){var r=e.dataPointAnnotationPath?true:false,l=this._oOriginalCardManifestSettings.dataPointAnnotationPath?true:false;if(i){var d=e.aViews[i].initialSelectedKey;n.tabFields.forEach(function(t){if(t!=="dataPointAnnotationPath"||r){if(this._oOriginalCardManifestSettings.tabs&&this._oOriginalCardManifestSettings.tabs.length){var a=this._oOriginalCardManifestSettings.tabs[d-1][t];if(t!=="entitySet"||t==="entitySet"&&a){e[t]=a;e.tabs[i-1][t]=e[t]}}else{if(t!=="entitySet"){e[t]=this._oOriginalCardManifestSettings[t];e.tabs[i-1][t]=e[t]}}}}.bind(this));if(!this._oOriginalCardManifestSettings.tabs||!this._oOriginalCardManifestSettings.tabs.length){e.newViewCounter++;e.tabs[i-1].value=this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+e.newViewCounter}if(i===e.defaultViewSelected){e.aViews[i].text=e.tabs[i-1].value+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")"}else{e.aViews[i].text=e.tabs[i-1].value}}else{n.mainFields.forEach(function(t){e[t]=this._oOriginalCardManifestSettings[t]}.bind(this));if(r!==l){if(l){e.tabs.forEach(function(t){if(t.prevDataPointAnnotationPath){t.dataPointAnnotationPath=t.prevDataPointAnnotationPath}else{t.dataPointAnnotationPath=e.dataPoint[0].value}});e.dataPointAnnotationPath=e.tabs[o].dataPointAnnotationPath}else{e.tabs.forEach(function(e){e.prevDataPointAnnotationPath=e.dataPointAnnotationPath;e.dataPointAnnotationPath=undefined})}}}}else{var h;if(e.dataPointAnnotationPath){h=e.dataPoint[0].value}e.newViewCounter++;if(e.template==="sap.ovp.cards.charts.analytical"||e.template==="sap.ovp.cards.charts.smart.chart"){e.tabs[i-1]={chartAnnotationPath:e.chart[0].value,dataPointAnnotationPath:h,value:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+e.newViewCounter}}else{e.tabs[i-1]={annotationPath:e.lineItem[0].value,dataPointAnnotationPath:h,value:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+e.newViewCounter}}if(i===e.defaultViewSelected){e.aViews[i].text=this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+e.newViewCounter+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")"}else{e.aViews[i].text=this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+e.newViewCounter}n.tabFields.forEach(function(t){var a=e.tabs[i-1][t];if(t!=="entitySet"||t==="entitySet"&&a){e[t]=a}})}this.handleErrorHandling(t,"value","/tabs");e.isViewResetEnabled=false;e.aViews[i].isViewResetEnabled=false;a.addManifestSettings(e);a.setVisibilityForFormElements(e);this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();if(!e.addNewCard){this._fCardWithRefresh()}},selectViewSwitch:function(e,t){var i=this._oCardManifestSettings,s=this.getView().getModel();if(!t){t=e.getSource().getSelectedIndex()}if(this.defaultViewSwitch){this.defaultViewSwitch.setEnabled(true)}this.setEnablePropertyForResetAndSaveButton(true);var o=i.metaModel,r,l=i.defaultViewSelected;if(!t){i.selectedKey=t;i.mainViewSelected=true;i.isViewResetEnabled=i.aViews[t].isViewResetEnabled;n.tabFields.forEach(function(e){var t=i.tabs[l-1][e];if(e!=="entitySet"||e==="entitySet"&&t){i[e]=t}});this.handleErrorHandling(s,"value","/tabs");if(i.tabs[l-1].entitySet){r=o.getODataEntitySet(i.tabs[l-1].entitySet);i.entityType=o.getODataEntityType(r.entityType);this.resetSupportingObjectsOnEntitySetChange(i,l)}a.addManifestSettings(i);a.setVisibilityForFormElements(i);this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();if(!i.addNewCard){this._fCardWithRefresh()}}else{i.mainViewSelected=false;i.isViewResetEnabled=i.aViews[t].isViewResetEnabled;if(!i.addNewCard){var d=this.getView().byId("dialogCard");if(d.getVisible()){var h=d.getComponentInstance().getRootControl();var g=h.getController();g.changeSelection(t,true,i);this.handleErrorHandling(s,"value","/tabs");if(i.tabs[t-1].entitySet){r=o.getODataEntitySet(i.tabs[t-1].entitySet);i.entityType=o.getODataEntityType(r.entityType);this.resetSupportingObjectsOnEntitySetChange(i,l)}n.tabFields.forEach(function(e){var a=i.tabs[t-1][e];if(e!=="entitySet"||e==="entitySet"&&a){i[e]=a}});a.addManifestSettings(i);a.setVisibilityForFormElements(i);if(!!i.kpiAnnotationPath){this.setAnnotationPathInModel(i,"sapOvpSettingsKPIAnnotation",i.kpiAnnotationPath)}if(!!i.selectionPresentationAnnotationPath){this.setAnnotationPathInModel(i,"sapOvpSettingsFilterAndPresentedBy",i.selectionPresentationAnnotationPath)}this.getView().getModel("visibility").refresh();this.getView().getModel().refresh()}}else{if(!!i.tabs[t-1].entitySet){r=o.getODataEntitySet(i.tabs[t-1].entitySet);i.entityType=o.getODataEntityType(r.entityType);a.addManifestSettings(i)}this.aVariantNames.forEach(function(e){if(this._oCardManifestSettings[e.sPath]){this._oCardManifestSettings[e.sPath]=[]}}.bind(this));this.resetSupportingObjectsOnEntitySetChange(i,l);i.selectedKey=t;n.tabFields.forEach(function(e){var a=i.tabs[t-1][e];i[e]=a});a.setVisibilityForFormElements(i);this.getView().byId("sapOVPEntitySetList").setValue(i.tabs[t-1].entitySet);this.getView().getModel().refresh();this.getView().getModel("visibility").refresh()}}},resetSupportingObjectsOnEntitySetChange:function(e,t){e=a.addSupportingObjects(e);var i=e.defaultViewSelected;if(i){e.aViews[i].text=e.tabs[i-1].value}e.aViews[t].text+=" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";e.defaultViewSelected=t},setAnnotationPathInModel:function(e,t,i){if(e.entityType[i]){this.setVariant(e,i)}if(t==="sapOvpSettingsKPIAnnotation"){a.addKPINavApplicationName(e)}},setCurrentActivePageForCarouselCard:function(e){var t=this.getView().byId("dialogCard");if(t.getVisible()){var i=t.getComponentInstance(),a=i.getRootControl(),s=a.byId("pictureCarousel");if(s){var n=s.getPages(),o=n[e];s.setActivePage(o)}}},onSelectionChange:function(e){var t=e.getSource(),i=t.getModel(),a=i.getData().staticContent,s=t.getSelectedItem(),n=s.getBindingContext().getObject(),o=t.getModel("visibility");for(var r=0;r<a.length;r++){if(a[r].id===n.id){o.setProperty("/moveToTheTop",!(a.length===1||r===0));o.setProperty("/moveUp",!(a.length===1||r===0));o.setProperty("/moveDown",!(a.length===1||r===a.length-1));o.setProperty("/moveToTheBottom",!(a.length===1||r===a.length-1));o.setProperty("/delete",true);i.setProperty("/selectedItemIndex",r);o.refresh(true);if(e.getParameter("listItem")){this.setCurrentActivePageForCarouselCard(r)}break}}},handleErrorForProperty:function(e,t,i){e.firePropertyChange({context:e.getContext(i?i:"/"),path:t,value:e.getProperty(i?i+"/"+t:t),reason:d.Change})},handleErrorHandling:function(e,t,i){var a=e.getProperty(i);e.firePropertyChange({context:e.getContext(i),path:i+","+t,value:e.getProperty(i),reason:d.Change});for(var s=0;s<a.length;s++){var n=i+"/"+s;e.firePropertyChange({context:e.getContext(n),path:t,value:e.getProperty(n+"/"+t),reason:d.Change})}},setEnablePropertyForResetAndSaveButton:function(e){a.enableResetButton(e);a.enableSaveButton(e)},getValueInRemString:function(e){return e+"rem"},_getSelectedItemIndex:function(e){return e.getProperty("/selectedItemIndex")},_getLastItemIndex:function(e){return this._getStaticContentArray(e).length-1},_getStaticContentArray:function(e){return e.getProperty("/staticContent")},_setStaticContentArray:function(e,t){e.setProperty("/staticContent",t)},_setSelectedItemAndScrollToElement:function(e,t){var i=this.getView(),a=i.byId("sapOvpStaticLinkListLineItem"),s=i.byId("scrollContainer"),n=i.getModel();this.handleErrorHandling(n,"title","/staticContent");this.handleErrorHandling(n,"targetUri","/staticContent");var o=a.getItems()[e];if(t){this._oList=a;this._oItem=o;this._oScrollContainer=s;var r={onAfterRendering:function(e){this._oList.removeEventDelegate(this._oDelegateOnAfter);this._oScrollContainer.scrollToElement(this._oItem);delete this._oDelegateOnAfter;delete this._oList;delete this._oScrollContainer;delete this._oItem}};this._oDelegateOnAfter=r;a.addEventDelegate(r,this)}else{s.scrollToElement(o)}a.setSelectedItem(o);a.fireSelectionChange()},_arrangeStaticContent:function(e,t,i){var a=this._getStaticContentArray(e);a.splice(i,0,a.splice(t,1)[0]);this._setStaticContentArray(e,a);this._setSelectedItemAndScrollToElement(i)},getIndexFromIdForStaticLinkList:function(e){var t=e.split("-");return t[t.length-1]},_getImageData:function(){var e=[];e.push({Name:"AW.png",Image:h.formUrl(this.getView().getModel().getProperty("/baseUrl"),"img/AW.png")});return e},_getIconData:function(e){var t=c.getIconNames(),i=[];if(e){var a=e.split("://")[1],s=t.indexOf(a);t.splice(s,1);i.push({Name:a,Icon:c.getIconURI(a)})}for(var n=0;n<t.length;n++){i.push({Name:t[n],Icon:c.getIconURI(t[n])})}return i},_getLinkListItemId:function(e,t){return e.getProperty("/staticContent/"+t+"/index")},_makeLinkListItemId:function(e){return"linkListItem--"+e},_makeLinkListItemIndex:function(e){return"Index--"+e},getIconAndImageDataModel:function(e){var i=this._getIconData(e),a=this._getImageData();return new t({Icons:i,Images:a,NoOfIcons:i.length,NoOfImages:a.length})},destroyTemplatesAndObjects:function(){var e=this.getView();var t=e.byId("tableFilterImage");if(t){t.destroy()}var i=e.byId("tableFilter");if(i){i.destroy()}var a=e.byId("tableFilterLinks");if(a){a.destroy()}delete this._oEvent;delete this._iCurrentRow;delete this._oModel;delete this._oVisibilityModel;delete this._oIconsDialogContentView;delete this._oLinksDialogContentView;delete this._oLineItemDialogContentView;delete this._oKPIItemDialogContentView},onExternalUrlChange:function(e){this.setEnablePropertyForResetAndSaveButton(true)},onLinkSourceChange:function(e){var t=e.getSource(),i=t.getModel(),a=t.getModel("visibility"),s=this.getIndexFromIdForStaticLinkList(t.getId()),n=e.getParameter("selectedIndex"),o=a.getProperty("/staticLink"),r=a.getProperty("/links"),l=this._getLinkListItemId(i,parseInt(s,10));if(n===0){o[l]=false;r[l]=true;i.setProperty("/staticContent/"+s+"/targetUri",undefined)}else{o[l]=true;r[l]=false;i.setProperty("/staticContent/"+s+"/semanticObject",undefined);i.setProperty("/staticContent/"+s+"/action",undefined);i.setProperty("/staticContent/"+s+"/targetUri","")}a.setProperty("/staticLink",o);a.setProperty("/links",r);a.refresh(true);i.refresh(true);this.handleErrorForProperty(i,"targetUri","/staticContent/"+s);this.setEnablePropertyForResetAndSaveButton(true)},onRemoveVisualPress:function(e){var t=e.getSource(),i=t.getModel(),a=t.getModel("visibility"),s=this.getIndexFromIdForStaticLinkList(t.getId()),n=this._getLinkListItemId(i,parseInt(s,10)),o=a.getProperty("/removeVisual");o[n]=false;a.setProperty("/removeVisual",o);a.refresh(true);i.setProperty("/staticContent/"+s+"/imageUri",undefined);i.refresh(true);this.updateCard(e,"sapOvpSettingsStaticLinkListRemoveVisual")},createValueHelpDialogForInternalUrl:function(e){var t=e.getSource(),i=t.getModel(),a=t.getModel("staticCardProperties"),s=t.getModel("visibility"),n=this.getIndexFromIdForStaticLinkList(t.getId());this.attachBrowserHeightChangeHandler();var o=new I;this._oEvent=Object.assign(o,e);this._iCurrentRow=n;this._oModel=i;this._oVisibilityModel=s;var r=new S("linksCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.linksDialog=new p({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_SELECT_APPLICATION_DIALOG"),buttons:[r]}).addStyleClass("sapOvpSettingsDialogBox");a.setProperty("/densityStyle",this.getDensityStyle());a.setProperty("/NoOfLinks",a.getProperty("/links").length);var l={id:"linksDialogContent",viewName:"sap.ovp.cards.rta.SelectLinks",type:f.XML,preprocessors:{xml:{bindingContexts:{tableRows:a.createBindingContext("/")},models:{tableRows:a}}}};O.create(l).then(function(e){e.setModel(a);e.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.linksDialog.addContent(e);this._oLinksDialogContentView=e;e.getController().updateLinkPath=function(e){var t=e.slice(1).split(/-(.+)/),i=t[0],a=t[1];this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/semanticObject",i);this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/action",a);this._oModel.refresh(true);this.setEnablePropertyForResetAndSaveButton(true);this.cleanAndCloseDialog(r)}.bind(this);r.attachPress(function(){this.cleanAndCloseDialog(r)}.bind(this));this.linksDialog.open();setTimeout(function(){this.browserHeightChange()}.bind(this),0)}.bind(this))},onChangeVisualPress:function(e){var t=e.getSource(),i=t.getModel(),a=t.getModel("visibility"),s=this.getIndexFromIdForStaticLinkList(t.getId()),n=i.getProperty("/staticContent/"+s+"/imageUri"),o=h.isImageUrlStaticData(n);this.attachBrowserHeightChangeHandler();var r=new I;this._oEvent=Object.assign(r,e);this._iCurrentRow=s;this._oModel=i;this._oVisibilityModel=a;var l=new S("iconsCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.iconsDialog=new p({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_SELECT_VISUAL_DIALOG"),buttons:[l]}).addStyleClass("sapOvpSettingsDialogBox");var d=o?this.getIconAndImageDataModel():this.getIconAndImageDataModel(n);d.setProperty("/densityStyle",this.getDensityStyle());var g={id:"iconsDialogContent",viewName:"sap.ovp.cards.rta.SelectIcons",type:f.XML,preprocessors:{xml:{bindingContexts:{tableRows:d.createBindingContext("/")},models:{tableRows:d}}}};O.create(g).then(function(e){d.setProperty("/tableName","IconTable");e.setModel(d);e.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.iconsDialog.addContent(e);this._oIconsDialogContentView=e;e.getController().updateIconPath=function(e){var t=this._getLinkListItemId(this._oModel,parseInt(this._iCurrentRow,10)),i=this._oVisibilityModel.getProperty("/removeVisual");i[t]=true;this._oVisibilityModel.setProperty("/removeVisual",i);this._oVisibilityModel.refresh(true);this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/imageUri",e);this._oModel.refresh(true);this.updateCard(this._oEvent,"sapOvpSettingsStaticLinkListChangeVisual");this.cleanAndCloseDialog(l)}.bind(this);l.attachPress(function(){this.cleanAndCloseDialog(l)}.bind(this));this.iconsDialog.open();setTimeout(function(){this.browserHeightChange()}.bind(this),0)}.bind(this))},getDensityStyle:function(){if(!v.support.touch){return"compact"}else{return"cozy"}},cleanAndCloseDialog:function(e){if(this._oIconsDialogContentView){this._oIconsDialogContentView.destroy()}if(this._oLinksDialogContentView){this._oLinksDialogContentView.destroy()}if(this._oLineItemDialogContentView){this._oLineItemDialogContentView.destroy()}if(this._oKPIItemDialogContentView){this._oKPIItemDialogContentView.destroy()}this.destroyTemplatesAndObjects();if(this.iconsDialog){this.iconsDialog.close()}if(this.linksDialog){this.linksDialog.close()}if(this.lineItemDialog){this.lineItemDialog.close()}if(this.KPIItemDialog){this.KPIItemDialog.close()}e.destroy();this.detachBrowserHeightChangeHandler()},attachBrowserHeightChangeHandler:function(){v.resize.attachHandler(this.browserHeightChange,this)},detachBrowserHeightChangeHandler:function(){v.resize.detachHandler(this.browserHeightChange,this)},browserHeightChange:function(e){var t,i,s;if(this.iconsDialog&&this._oIconsDialogContentView){t=this.iconsDialog;i=this._oIconsDialogContentView;s="iconsScrollContainer"}else if(this.linksDialog&&this._oLinksDialogContentView){t=this.linksDialog;i=this._oLinksDialogContentView;s="linksScrollContainer"}else if(this.lineItemDialog&&this._oLineItemDialogContentView){t=this.lineItemDialog;i=this._oLineItemDialogContentView;s="lineItemScrollContainer"}else if(this.KPIItemDialog&&this._oKPIItemDialogContentView){t=this.KPIItemDialog;i=this._oKPIItemDialogContentView;s="KPIItemScrollContainer"}if(t&&i&&s){var n=t.getDomRef(),o=e?e.height*93/100:a.dialogBox.getDomRef().getBoundingClientRect().height,r=n.getBoundingClientRect().height,l=Math.max(o,r)-P.getPixelPerRem()*9,d=i.byId(s);d.setHeight(l+"px")}},handleMessagePopoverPress:function(e){a.oMessagePopOver.openBy(e.getSource())},onShowMorePress:function(e){var t=e.getSource(),i=t.getModel(),a=t.getModel("visibility"),s=this.getIndexFromIdForStaticLinkList(t.getId()),n=this._getLinkListItemId(i,parseInt(s,10)),o=a.getProperty("/showMore/"+n);if(o){a.setProperty("/showMore/"+n,false)}else{a.setProperty("/showMore/"+n,true)}a.refresh(true)},onPressDelete:function(e){var t=new I;this._oEvent=Object.assign(t,e);o.confirm(this.oOvpResourceBundle.getText("OVP_KEYUSER_MESSAGE_BOX_INFORMATION_MESSAGE_INFO"),{actions:[o.Action.OK,o.Action.CANCEL],icon:o.Icon.INFORMATION,title:this.oOvpResourceBundle.getText("OVP_KEYUSER_MESSAGE_BOX_TITLE_INFO"),initialFocus:o.Action.CANCEL,onClose:function(e){if(e==="OK"){var t=this._oEvent.getSource(),i=t.getModel("visibility"),a=t.getModel(),s=this._getStaticContentArray(a),n=this._getSelectedItemIndex(a),o=this._getLinkListItemId(a,n),r=i.getProperty("/staticLink"),l=i.getProperty("/links"),d=i.getProperty("/removeVisual"),h=i.getProperty("/showMore");delete r[o];delete l[o];delete d[o];delete h[o];i.setProperty("/staticLink",r);i.setProperty("/links",l);i.setProperty("/removeVisual",d);i.setProperty("/showMore",h);s.splice(n,1);this._setStaticContentArray(a,s);a.refresh(true);if(s.length>0){this._setSelectedItemAndScrollToElement(Math.min(parseInt(n,10),s.length-1),true)}if(s.length<=1){i.setProperty("/delete",false)}i.refresh(true);this.updateCard(this._oEvent,"sapOvpSettingsStaticLinkListDelete")}delete this._oEvent}.bind(this)})},onPressAdd:function(e){var t=e.getSource(),i=t.getModel("visibility"),a=t.getModel(),s=this._getStaticContentArray(a),n=a.getProperty("/lineItemIdCounter"),o=this._makeLinkListItemId(n+1),r=this._makeLinkListItemIndex(n+1),l=i.getProperty("/staticLink"),d=i.getProperty("/links"),h=i.getProperty("/removeVisual"),g=i.getProperty("/showMore");a.setProperty("/lineItemIdCounter",n+1);s.unshift({id:o,index:r,title:"Default Title",subTitle:"Default SubTitle",imageUri:"",imageAltText:"",targetUri:"",openInNewWindow:""});l[r]=true;d[r]=false;h[r]=false;g[r]=false;i.setProperty("/staticLink",l);i.setProperty("/links",d);i.setProperty("/removeVisual",h);i.setProperty("/showMore",g);i.refresh(true);this._setStaticContentArray(a,s);a.refresh(true);this._setSelectedItemAndScrollToElement(0);this.updateCard(e,"sapOvpSettingsStaticLinkListAdd")},onPressMoveToTheTop:function(e){var t=e.getSource().getModel();this._arrangeStaticContent(t,this._getSelectedItemIndex(t),0);this.updateCard(e,"sapOvpSettingsStaticLinkListSort")},onPressMoveUp:function(e){var t=e.getSource().getModel(),i=this._getSelectedItemIndex(t);this._arrangeStaticContent(t,i,i-1);this.updateCard(e,"sapOvpSettingsStaticLinkListSort")},onPressMoveDown:function(e){var t=e.getSource().getModel(),i=this._getSelectedItemIndex(t);this._arrangeStaticContent(t,i,i+1);this.updateCard(e,"sapOvpSettingsStaticLinkListSort")},onPressMoveToTheBottom:function(e){var t=e.getSource().getModel(),i=this._getSelectedItemIndex(t),a=this._getLastItemIndex(t);this._arrangeStaticContent(t,i,a);this.updateCard(e,"sapOvpSettingsStaticLinkListSort")},onResetButton:function(){this._oCardManifestSettings=y({},this._oOriginalCardManifestSettings);var e=this.getView().getModel();e.setProperty("/",this._oCardManifestSettings);a.setVisibilityForFormElements(this._oCardManifestSettings);this.getView().getModel("visibility").refresh();if(this._oCardManifestSettings.layoutDetail==="resizable"){if(this._oCardManifestSettings.stopResizing){this.getView().byId("sapOvpSettingsStopResize").setState(false)}else if(!this._oCardManifestSettings.stopResizing){this.getView().byId("sapOvpSettingsStopResize").setState(true)}}a.resetErrorHandling();this.setEnablePropertyForResetAndSaveButton(false);if(!this._oCardManifestSettings.addNewCard){this._fCardWithRefresh()}},handleValueStateofComboBox:function(e,t,i,s){var n=a.oMessagePopOver.getModel(),o=n.getProperty("/Messages"),r=n.getProperty("/Counter/All"),l=n.getProperty("/Counter/Error");this.bError=true;var d=true;if(s){for(var h=0;h<o.length;h++){if(o[h].fieldName===t){d=false}}if(d){o.push({type:"Error",title:e,fieldName:t,counter:l+1});r++;l++;this.getView().byId(i).setValueState("Error")}}else{this.bError=false;for(var h=0;h<o.length;h++){if(o[h].fieldName===t){o.splice(h,1);r--;l--;h--}}this.getView().byId(i).setValueState("None")}if(!o.length){this.setEnablePropertyForResetAndSaveButton(true)}n.setProperty("/Messages",o);n.setProperty("/Counter/All",r);n.setProperty("/Counter/Error",l);n.refresh(true)},validateComboBox:function(e,t,i){var a;if(t==="KPICheckBox"&&i&&e.entitySet||t==="entitySet"&&e.addKPIHeaderCheckBox){if(e.title===""){a=C.getText("OVP_KEYUSER_INPUT_ERROR");this.handleValueStateofComboBox(a,b.Annotations.title,"sapOvpCardTitle",true)}else{this.handleValueStateofComboBox("",b.Annotations.title,"sapOvpCardTitle",false)}if(e.subTitle===""){a=C.getText("OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SUBTITLE");this.handleValueStateofComboBox(a,b.Annotations.subTitle,"sapOvpCardSubTitle",true)}else{this.handleValueStateofComboBox("",b.Annotations.subTitle,"sapOvpCardSubTitle",false)}if(e.valueSelectionInfo===""){a=C.getText("OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SELECTIONVALUEINFO");this.handleValueStateofComboBox(a,b.Annotations.valueSelectionInfo,"sapOvpValueSelectionInfo",true)}else{this.handleValueStateofComboBox("",b.Annotations.valueSelectionInfo,"sapOvpValueSelectionInfo",false)}if(e.dataPointAnnotationPath===""){a=C.getText("OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_DATAPOINT");this.handleValueStateofComboBox(a,b.Annotations.dataPoint,"sapOvpDataPoint",true)}else{this.handleValueStateofComboBox("",b.Annotations.dataPoint,"sapOvpDataPoint",false)}}else if(t==="entitySet"){a=C.getText("OVP_KEYUSER_INPUT_ERROR");this.handleValueStateofComboBox(a,b.Annotations.title,"sapOvpCardTitle",true);if(e.template==="sap.ovp.cards.linklist"||e.template==="sap.ovp.cards.v4.linklist"){a=C.getText("OVP_KEYUSER_LISTFLAVOR_ERROR");this.handleValueStateofComboBox(a,b.Annotations.listFlavor,"sapOVPLinkListFlavor",true)}}else if(t==="KPICheckBox"&&!i&&e.entitySet){this.handleValueStateofComboBox("",b.Annotations.subTitle,"sapOvpCardSubTitle",false);this.handleValueStateofComboBox("",b.Annotations.valueSelectionInfo,"sapOvpValueSelectionInfo",false);this.handleValueStateofComboBox("",b.Annotations.dataPoint,"sapOvpDataPoint",false)}else{if(t==="title"){this.onComboBoxSelection(e,t,"OVP_KEYUSER_INPUT_ERROR",b.Annotations.title,"sapOvpCardTitle")}if(t==="subTitle"){this.onComboBoxSelection(e,t,"OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SUBTITLE",b.Annotations.subTitle,"sapOvpCardSubTitle")}if(t==="valueSelectionInfo"){this.onComboBoxSelection(e,t,"OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SELECTIONVALUEINFO",b.Annotations.valueSelectionInfo,"sapOvpValueSelectionInfo")}if(t==="dataPointAnnotationPath"){this.onComboBoxSelection(e,t,"OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_DATAPOINT",b.Annotations.dataPoint,"sapOvpDataPoint")}if(t==="listFlavor"){this.onComboBoxSelection(e,t,"OVP_KEYUSER_LISTFLAVOR_ERROR",b.Annotations.listFlavor,"sapOVPLinkListFlavor")}}},onComboBoxSelection:function(e,t,i,a,s){var n;if(e[t]===""){n=C.getText(i);this.handleValueStateofComboBox(n,a,s,true)}else{this.handleValueStateofComboBox(n,a,s,false)}},onSaveButtonPress:function(){if(!this._oCardManifestSettings.addNewCard){if(a.bError||this.bError){a.oMessagePopOverButton.firePress()}else{this.createAndSubmitChange.bind(this)()}}else{this.createAndSubmitChange.bind(this)()}},onResizingChange:function(e){var t=e.getParameter("state");this._oCardManifestSettings.stopResizing=!t;this.updateCard(e)},onNumberOfRowsChanged:function(e){var t=+this._oCardManifestSettings.defaultSpan.rows;this._oCardManifestSettings.defaultSpan.rows=t;this._oCardManifestSettings.defaultSpan.showOnlyHeader=t===0;this._oCardManifestSettings.cardLayout.showOnlyHeader=t===0;var i=["sap.ovp.cards.list","sap.ovp.cards.table"];if(i.indexOf(this._oCardManifestSettings.template)!==-1){this._oCardManifestSettings.cardLayout.noOfItems=t}else{this._oCardManifestSettings.cardLayout.rowSpan=t}this.updateCard(e)},onNumberOfColumnsChanged:function(e){this._oCardManifestSettings.defaultSpan.cols=+this._oCardManifestSettings.defaultSpan.cols;this.updateCard(e)},setBusy:function(e){if(e){this.getView().addStyleClass("dialogContainerOverlay");var t=this.getView().byId("dialogCard");if(t.getVisible()&&t.getComponentInstance()){t.getComponentInstance().getRootControl().setBusy(e)}}else{this.getView().removeStyleClass("dialogContainerOverlay");setTimeout(function(){var t=this.getView().byId("dialogCard");if(t.getVisible()&&t.getComponentInstance()){t.getComponentInstance().getRootControl().setBusy(e)}}.bind(this),2e3)}},_fCardWithoutRefresh:function(e,t){var i=this.getView(),a=this._oCardManifestSettings,s=i.byId("dialogCard").getComponentInstance(),n=s.getRootControl(),o=n.getController(),r=o.getCardPropertiesModel(),l,d,h=false,g;if(a.tabs&&a.tabs.length){h=true;g=parseInt(a.selectedKey,10)}if(t.formElementId==="sapOvpSettingsLineItemTitle"||t.formElementId==="sapOvpSettingsLineItemSubTitle"){l=n.byId(t.cardElementId+"--"+i.getModel().getProperty("/lineItemId"))}else{l=n.byId(t.cardElementId);if(!l){this._fCardWithRefresh(e,t.cardElementId)}}switch(t.formElementId){case"sapOvpSettingsLineItemTitle":case"sapOvpSettingsLineItemSubTitle":case"sapOvpSettingsTitle":case"sapOvpSettingsValueSelectionInfo":if(l){l.setText(e.getSource().getValue())}break;case"sapOvpSettingsSubTitle":r.setProperty("/subTitle",e.getSource().getValue());o._setSubTitleWithUnitOfMeasure(undefined,true);break;case"sapOvpSettingsViewName":var u=a.viewName;d=i.getModel();l.getItems()[g-1].setText(u);a.tabs[g-1].value=u;if(a.defaultViewSelected===g){u=u+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")"}a.aViews[g].text=u;d.refresh();break;case"sapOvpDefaultViewSwitch":if(e.getSource().getState()){var c=a.defaultViewSelected;d=i.getModel();a.defaultViewSelected=g;a.aViews[c].text=a.tabs[c-1].value;a.aViews[g].text+=" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";d.refresh();this.defaultViewSwitch=e.getSource();this.defaultViewSwitch.setEnabled(false)}break;case"sapOvpSettingsIdentification":if(h){a.tabs[g-1][t.updateProperty]=a[t.updateProperty]}break;case"sapOvpSettingsKPIHeaderSwitch":var f=i.getModel("visibility"),p=f.getData();p.dataPoint=false;p.valueSelectionInfo=false;if(h){a.tabs.forEach(function(e){e.prevDataPointAnnotationPath=e.dataPointAnnotationPath;e.dataPointAnnotationPath=undefined})}else{var S=a.dataPointAnnotationPath;if(S){a.prevDataPointAnnotationPath=S}a.dataPointAnnotationPath=undefined}f.refresh(true);l.destroy();break;default:break}},_fCardWithRefresh:function(e,t){var s,o,r,l,d,h=this._oCardManifestSettings,g=this.getView(),u=g.byId("dialogCard"),c=!u.getComponentInstance()?undefined:u.getComponentInstance().getComponentData(),f=!c?"Dialog":c.cardId,p=!c?undefined:c.manifest.cards[f].model,S={cards:{}},v=false,C;if(h.tabs&&h.tabs.length){v=true;C=parseInt(h.selectedKey,10)}switch(t){case"subTitleSwitch":r=this.getView();l=r.getModel("visibility");if(e.getSource().getState()){if(v){o=h.defaultViewSelected;h.tabs.forEach(function(e){s=e.prevDynamicSubtitleAnnotationPath;if(s){e.dynamicSubtitleAnnotationPath=s}else{e.dynamicSubtitleAnnotationPath=h.dynamicSubTitle[0].value}});h.dynamicSubtitleAnnotationPath=h.tabs[o-1].dynamicSubtitleAnnotationPath}else{s=h.prevDynamicSubtitleAnnotationPath;if(s){h.dynamicSubtitleAnnotationPath=s}else{h.dynamicSubtitleAnnotationPath=h.dynamicSubTitle[0].value}}if(c.template!=="sap.ovp.cards.linklist"&&c.template!=="sap.ovp.cards.v4.linklist"){g.byId("sapOvpSettingsDynamicSubTitle").setSelectedKey(h.dynamicSubtitleAnnotationPath)}}else{if(v){h.tabs.forEach(function(e){e.prevDynamicSubtitleAnnotationPath=e.dynamicSubtitleAnnotationPath;e.dynamicSubtitleAnnotationPath=undefined});h.dynamicSubtitleAnnotationPath=undefined}else{var b=h.dynamicSubtitleAnnotationPath;if(b){h.prevDynamicSubtitleAnnotationPath=b}h.dynamicSubtitleAnnotationPath=undefined}}l.setProperty("/subTitle",a.getVisibilityOfElement(h,"subTitle",v));l.setProperty("/dynamicSubTitle",a.getVisibilityOfElement(h,"dynamicSubTitle",v)&&!!h["dynamicSubTitle"]&&!!h["dynamicSubTitle"].length);l.refresh(true);break;case"enableAddToInsights":h[t]=e.getSource().getState()?true:false;break;case"toleranceRangeHighValue":case"toleranceRangeLowValue":case"deviationRangeHighValue":case"deviationRangeLowValue":if(v){h.tabs[C-1][t]=h[t]}break;case"kpiHeader":r=this.getView();l=r.getModel("visibility");d=l.getData();d.valueSelectionInfo=true;d.dataPoint=true;if(h.tabs&&h.tabs.length){d.dataPoint=a.getVisibilityOfElement(h,"dataPoint",true)}if(!h.valueSelectionInfo){h.valueSelectionInfo=" "}if(v){o=h.defaultViewSelected;h.tabs.forEach(function(e){s=e.prevDataPointAnnotationPath;if(s){e.dataPointAnnotationPath=s}else{e.dataPointAnnotationPath=h.dataPoint[0].value}});h.dataPointAnnotationPath=h.tabs[o-1].dataPointAnnotationPath}else{s=h.prevDataPointAnnotationPath;if(s){h.dataPointAnnotationPath=s}else{h.dataPointAnnotationPath=h.dataPoint[0].value}}l.refresh(true);break;case"listType":h[t]=e.getSource().getState()?"extended":"condensed";break;case"listFlavor":h[t]=e.getSource().getState()?"bar":"";break;case"entitySet":if(v){h.tabs[C-1][t]=h[t];n.resetTabFields.forEach(function(e){delete h.tabs[C-1][e];delete h[e]});var m=h.metaModel,y=m.getODataEntitySet(h.tabs[C-1].entitySet),_=h.defaultViewSelected;h.entityType=m.getODataEntityType(y.entityType);this.resetSupportingObjectsOnEntitySetChange(h,_)}break;case"kpiAnnotationPath":if(v){h.tabs[C-1][t]=h[t]}var I=g.byId("sapOvpSettingsKPIAnnotation").getSelectedKey();if(h.entityType[I]){this.setVariant(h,I)}a.addKPINavApplicationName(h);this.getView().getModel().refresh(true);break;case"selectionPresentationAnnotationPath":if(v){h.tabs[C-1][t]=h[t]}var I=g.byId("sapOvpSettingsFilterAndPresentedBy").getSelectedKey();if(h.entityType[I]){this.setVariant(h,I)}this.getView().getModel().refresh(true);break;case"listFlavorForLinkList":case"annotationPath":case"chartAnnotationPath":case"presentationAnnotationPath":case"selectionAnnotationPath":case"dynamicSubtitleAnnotationPath":case"dataPointAnnotationPath":if(v){h.tabs[C-1][t]=h[t]}break;case"noOfRows":case"ovpHeaderTitle":case"add":case"removeVisual":case"changeVisual":case"sort":case"delete":break;default:break}S.cards[f]={settings:h};if(a.bNewKPICardFlag){S.cards[f].template=h.template}else{S.cards[f].template=c.template}if(a.bNewKPICardFlag){if(p&&g.getModel(p)){g.getModel(p).destroy();g.setModel(null,p)}var O=this._oCardManifestSettings.selectedKPI,M=new V(O.ODataURI,{annotationURI:O.ModelURI,defaultCountMode:E.None});p=P._getLayerNamespace()+".kpi_card_model_"+a.getTrimmedDataURIName(O.ODataURI);g.setModel(M,p)}if(!!p){S.cards[f].model=p}if(a.bNewKPICardFlag){M.getMetaModel().loaded().then(function(){var e=i.createCardComponent(g,S,"dialogCard");e.then(function(){g.setBusy(false);this.setBusy(false)}.bind(this)).catch(function(){a.setErrorMessage(S.cards[f].settings,"OVP_KEYUSER_ANNOTATION_FAILURE");a.createErrorCard(g,S,f)})}.bind(this),function(e){w.error(e);this.setBusy(false);g.setBusy(false)}.bind(this));M.attachMetadataFailed(function(){a.setErrorMessage(S.cards[f].settings,"OVP_KEYUSER_METADATA_FAILURE");a.createErrorCard(g,S,f)})}else{this.createCard(g,S)}},setVariant:function(e,t){var i=e.entityType[t];var a=i.SelectionVariant&&i.SelectionVariant.Path;if(/^@/.test(a)){a=a.slice(1)}e.selectionAnnotationPath=a;var s;if(t.indexOf(".KPI")!==-1){s=i.Detail&&i.Detail.DefaultPresentationVariant&&i.Detail.DefaultPresentationVariant.Path}else if(t.indexOf(".SelectionPresentationVariant")!==-1){s=i.PresentationVariant&&i.PresentationVariant.Path}if(/^@/.test(s)){s=s.slice(1)}e.presentationAnnotationPath=s;var n=e.entityType[e.presentationAnnotationPath]&&e.entityType[e.presentationAnnotationPath].Visualizations;for(var o=0;o<n.length;o++){var r=n[o].AnnotationPath;if(r){if(/^@/.test(r)){r=r.slice(1)}if(/.Chart/.test(r)){e.chartAnnotationPath=r;break}}}},createCard:function(e,t){this.setBusy(true);var a=i.createCardComponent(e,t,"dialogCard");a.then(function(){this.setBusy(false);var e=this.getView().byId("sapOvpStaticLinkListLineItem");if(e){var t=e.getSelectedItem();if(t){var i=t.getId(),a=this.getIndexFromIdForStaticLinkList(i);this.setCurrentActivePageForCarouselCard(a)}}}.bind(this));a.catch(function(){this.setBusy(false)}.bind(this))},updateCard:function(e,t){var i=this._oCardManifestSettings,a=this.getView().byId("dialogCard");this.setEnablePropertyForResetAndSaveButton(true);if(a.getVisible()){if(i.tabs&&i.tabs.length){var s=parseInt(i.selectedKey,10);i.isViewResetEnabled=true;i.aViews[s].isViewResetEnabled=true}var n=e.getSource(),o=t?t:n.getId(),r=false;if(o.indexOf("sapOvpStaticLinkListLineItem")!==-1){var l=n.getModel(),d=l.getData().staticContent,h=this.getIndexFromIdForStaticLinkList(o);this.setCurrentActivePageForCarouselCard(h);l.setProperty("/lineItemId",d[h].id);if(o.indexOf("sapOvpSettingsLineItemTitle")!==-1){o="sapOvpSettingsLineItemTitle"}else if(o.indexOf("sapOvpSettingsLineItemSubTitle")!==-1){o="sapOvpSettingsLineItemSubTitle"}}for(var g=0;g<this._aRefreshNotRequired.length;g++){if(o.indexOf(this._aRefreshNotRequired[g].formElementId)>-1){if(this._aRefreshNotRequired[g].isKpiSwitch&&e.getSource().getState()){break}this._fCardWithoutRefresh(e,this._aRefreshNotRequired[g]);r=true;break}}if(!r){for(var u=0;u<this._aRefreshRequired.length;u++){if(o.indexOf(this._aRefreshRequired[u].formElementId)>-1){this.setBusy(true);this._fCardWithRefresh(e,this._aRefreshRequired[u].updateProperty);break}}}var c=P.getQueryParameterValue("fiori-tools-rta-mode");if(c){for(var f in this.oMandatoryPropertiesKey){if(o.indexOf(this.oMandatoryPropertiesKey[f])>-1){var p=false,S=f+"Key",v=f+"Property";i[f]=e.getParameter("value");i[v]=e.getParameter("value");for(var f in i.ai18nProperties){if(i.ai18nProperties[f].value===e.getParameter("value")){i[S]=i.ai18nProperties[f].key;p=true;break}}if(!p){i[S]=""}break}}}}},onExit:function(){a.oSaveButton.detachPress(this.onSaveButtonPress,this);a.oResetButton.detachPress(this.onResetButton,this);a.oMessagePopOverButton.detachPress(this.handleMessagePopoverPress,this)},getListItems:function(){var e=[],t=this._oCardManifestSettings,i=this.getView(),s=i.byId("dialogCard"),n=s.getComponentInstance().getComponentData();var o=n.model.getMetaModel();var r=P.isODataV4(n.model);var l=r?"/"+t.entityType.$Type+"/@"+t.annotationPath:t.entityType.$path+"/"+t.annotationPath;var d=o.getContext(o.resolve(l,this.oView.getBindingContext()));var h=2,g=1,c=0;if(t.listFlavor==="bar"){h=1;g=2}if(t.listType&&t.listType.toLowerCase()==="extended"){h=6;g=3;c=3;if(t.listFlavor==="bar"){h=5}}else if(t.contentFragment==="sap.ovp.cards.table.Table"||t.contentFragment==="sap.ovp.cards.table.v4.Table"){h=3;g=1;c=1}t.lineItem.forEach(function(t){var i=u.getSortedDataPoints(d,t.fields);var s=u.getSortedDataFields(d,t.fields);var n=[],o=[],l=a.getQualifier(t.value);i.forEach(function(e){if(e.Title){var t=r?e.Title:e.Title.String;o.push(a.checkForEmptyString(t,""))}else{o.push(C.getText("OVP_KEYUSER_LABEL_DEFAULT_LABEL_WITH_QUALIFIER",[l]))}});s.forEach(function(e){if(e.Label){var t=r?e.Label:e.Label.String;n.push(t)}else{n.push(C.getText("OVP_KEYUSER_LABEL_DEFAULT_LABEL_WITH_QUALIFIER",[l]))}});var f=Math.min(o.length,g),p=Math.min(c,f),S=n.slice(0,h-p).concat(o.slice(0,f));S.map(function(e){return e.charAt(0).toUpperCase()+e.substr(1)});e.push({Value:t.value,Label:t.name,VisibleFields:S.toString()})});return e},onSearch:function(e){var t=this.getView(),i=t.getModel(),a;this._filterTable(e,["GroupTitle","KPITitle","GroupID","KPIID","KPIQualifier"],"sapOvpKPITable");a=t.byId("sapOvpKPITable").getBinding("items").getLength();i.setProperty("/NoOfKPIItem",a);i.refresh(true)},_filterTable:function(e,t,i){var a=e.getParameter("query"),s=null,n=[];for(var o=0;o<t.length;o++){n.push(new r(t[o],l.Contains,a))}if(a){s=new r(n,false)}this.getView().byId(i).getBinding("items").filter(s,"Application")},onItemPress:function(e){this.getView().setBusy(true);this.getView().setBusyIndicatorDelay(0);var t=e.getSource(),i=t.getBindingContext(),a=i.getObject();this.getView().byId("sapOvpSettingsTitle").setValue(a.GroupTitle);this.getView().byId("sapOvpSettingsSubTitle").setValue(a.KPITitle);this.onKPIUpdate(a);this.updateCard(e,"sapOvpSettingsNewKPICard")},onKPIUpdate:function(e){this._oCardManifestSettings.entitySet=e.ODataEntityset;this._oCardManifestSettings.kpiAnnotationPath="com.sap.vocabularies.UI.v1.KPI#"+e.KPIQualifier;this._oCardManifestSettings.title=e.GroupTitle;this._oCardManifestSettings.subTitle=e.KPITitle;this._oCardManifestSettings.template="sap.ovp.cards.charts.analytical";this._oCardManifestSettings.selectedKPI=e},onSeePress:function(){this.attachBrowserHeightChangeHandler();var e=new S("KPIItemCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.KPIItemDialog=new p({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_KPI_DIALOG_TITLE"),buttons:[e]}).addStyleClass("sapOvpSettingsDialogBox");var i=new t({KPIItem:this._oCardManifestSettings.KPIData});i.setSizeLimit(this._oCardManifestSettings.KPIData.length);i.setProperty("/densityStyle",this.getDensityStyle());i.setProperty("/NoOfKPIItem",i.getProperty("/KPIItem").length);var a={id:"KPIItemDialogContent",viewName:"sap.ovp.cards.rta.SelectKPI",type:f.XML,preprocessors:{xml:{bindingContexts:{tableRows:i.createBindingContext("/")},models:{tableRows:i}}}};O.create(a).then(function(t){t.setModel(i);t.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.KPIItemDialog.addContent(t);this._oKPIItemDialogContentView=t;t.getController().updateKPIItemPath=function(t,i){this.getView().setBusy(true);this.getView().setBusyIndicatorDelay(0);this.getView().byId("sapOvpSettingsTitle").setValue(t.GroupTitle);this.getView().byId("sapOvpSettingsSubTitle").setValue(t.KPITitle);this.onKPIUpdate(t);this.updateCard(i,"sapOvpSettingsNewKPICard");this.cleanAndCloseDialog(e)}.bind(this);e.attachPress(function(){this.cleanAndCloseDialog(e)}.bind(this));this.KPIItemDialog.open();setTimeout(function(){this.browserHeightChange()}.bind(this),0)}.bind(this))},openLineItemValueHelpDialog:function(e){this.attachBrowserHeightChangeHandler();var i=new I;this._oEvent=Object.assign(i,e);var s=new S("lineItemCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.lineItemDialog=new p({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LINEITEM_ANNO"),buttons:[s]}).addStyleClass("sapOvpSettingsDialogBox");var n=new t({lineItem:this.getListItems()});n.setProperty("/densityStyle",this.getDensityStyle());n.setProperty("/NoOfLineItem",n.getProperty("/lineItem").length);var o={id:"lineItemDialogContent",viewName:"sap.ovp.cards.rta.SelectLineItem",type:f.XML,preprocessors:{xml:{bindingContexts:{tableRows:n.createBindingContext("/")},models:{tableRows:n}}}};O.create(o).then(function(e){e.setModel(n);e.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.lineItemDialog.addContent(e);this._oLineItemDialogContentView=e;e.getController().updateLineItemPath=function(e){var t=e.Value,i=this._oCardManifestSettings,n;if(i.tabs&&i.tabs.length){n=parseInt(i.selectedKey,10)}i.lineItemQualifier=a.getQualifier(t);i.annotationPath=t;if(i.tabs&&i.tabs.length){i.tabs[n-1].annotationPath=i.annotationPath}this.getView().byId("sapOvpSettingsLineItem").setValue(e.Label);this._fCardWithRefresh(this._oEvent,"annotationPath");this.setEnablePropertyForResetAndSaveButton(true);if(i.tabs&&i.tabs.length){i.isViewResetEnabled=true;i.aViews[n].isViewResetEnabled=true}this.cleanAndCloseDialog(s)}.bind(this);s.attachPress(function(){this.cleanAndCloseDialog(s)}.bind(this));this.lineItemDialog.open();setTimeout(function(){this.browserHeightChange()}.bind(this),0)}.bind(this))},createAndSubmitChange:function(){var e;if(a.bNewStaticLinkListCardFlag){e=s.getPayLoadForNewStaticLinkListCard.bind(this)(a)}else if(a.bNewKPICardFlag){e=s.getPayLoadForNewKPICard.bind(this)(a)}else if(a.bAddNewCardFlag){e=s.getPayLoadForNewCard.bind(this)(a)}else{e=s.getPayLoadForEditCard.bind(this)(a)}this.settingsResolve(e);a.dialogBox.close()},setMandatoryFieldState:function(e,t){t.setProperty("/dataPoint",e);t.setProperty("/valueSelectionInfo",e);t.setProperty("/requiredSubTitle",e);var i=t.getData(),s=false;for(var n=0;n<a.aVisiblePropertiesForAnnotation.length;n++){if(i[a.aVisiblePropertiesForAnnotation[n].sProperty]){s=true;break}}t.setProperty("/setAnnotationCardProperties",s)},EnableKPIHeaderFields:function(e){var t=this.getView().getModel("visibility");if(!e){this.setMandatoryFieldState(false,t)}else{this.setMandatoryFieldState(true,t)}},onCardTypeSelected:function(e){var t=e.getParameters().id;this._oCardManifestSettings.template=e.getSource().getSelectedKey();this.getView().byId("sapOVPAddKpiCheckBoxID").setSelected(false);this.getView().byId("sapOVPAddODataSelect").setSelected(false);this._oCardManifestSettings.addKPIHeaderCheckBox=false;this.EnableKPIHeaderFields(this._oCardManifestSettings.addKPIHeaderCheckBox);this.resetPropertiesVisibility(t,this._oCardManifestSettings)},onDatasourceComboboxChanged:function(e){var t=e.getParameters().id;this._oCardManifestSettings.model=e.getParameters().value;this._oCardManifestSettings.allEntitySet="";if(!a.newDataSource){var i=this._oCardManifestSettings.datasources;for(var s=0;s<i.length;s++){if(i[s].Title===this._oCardManifestSettings.model){this._oCardManifestSettings.metaModel=i[s].oMetaModel}}a.addSupportingObjects(this._oCardManifestSettings);if(this._oCardManifestSettings.allEntitySet.length===0){this._oCardManifestSettings.model="";this.resetPropertiesVisibility(t,this._oCardManifestSettings);var n=C.getText("OVP_KEYUSER_NO_RELEVANT_ANNOTATION");this.handleValueStateofComboBox(n,"datasSourceExisting","sapOVPDataSourceExistingComboBox",true)}else{this.handleValueStateofComboBox("","datasSourceExisting","sapOVPDataSourceExistingComboBox",false);this.resetPropertiesVisibility(t,this._oCardManifestSettings)}}else{var o=this._oCardManifestSettings.datasources.filter(function(e){return e.Title===this._oCardManifestSettings.model}.bind(this));getMetaModelForNewDataSource(o,a.sApplicationId).then(function(e){if(e){a.newDataSourceModel=e.modelInformation;e.getODataEntityContainer=function(){return e.oEntityContainers};e.getObject=function(t){return e.oSchema};e.getODataEntityType=function(t){var i=e.oSchema[0].entityType.filter(function(i){var a=t.substr((e.oEntityContainers.namespace+".").length);return i.name===a});return i[0]};this._oCardManifestSettings.metaModel=e;a.addSupportingObjects(this._oCardManifestSettings);if(this._oCardManifestSettings.allEntitySet.length===0){this._oCardManifestSettings.model="";this.resetPropertiesVisibility(t,this._oCardManifestSettings);var i=C.getText("OVP_KEYUSER_NO_RELEVANT_ANNOTATION");this.handleValueStateofComboBox(i,"datasSourceNew","sapOVPDataSourceNewInput",true)}else{this.handleValueStateofComboBox("","datasSourceNew","sapOVPDataSourceNewInput",false);this.resetPropertiesVisibility(t,this._oCardManifestSettings)}}else{this._oCardManifestSettings.model="";this.resetPropertiesVisibility(t,this._oCardManifestSettings);var i=C.getText("OVP_KEYUSER_UNAVAILABLE_DATASOURCE");this.handleValueStateofComboBox(i,"datasSourceNew","sapOVPDataSourceNewInput",true)}}.bind(this))}},onEntitySetChanged:function(e,t){var i=this._oCardManifestSettings.metaModel.getObject("/dataServices/schema")[0].entityType;this.aVariantNames.forEach(function(e){if(this._oCardManifestSettings[e.sPath]){this._oCardManifestSettings[e.sPath]=[]}}.bind(this));for(var s in i){if(i[s].name===e){this._oCardManifestSettings.entityType=i[s];break}}a.addSupportingObjects(this._oCardManifestSettings);this.getView().byId("sapOVPAddODataSelect").setSelected(false);this.resetPropertiesVisibility(t,this._oCardManifestSettings)},addStaticParameterRow:function(){var e=this.getView().getModel();var t=e.getProperty("/aAllStaticParameters");if(t&&t.length){t.push({key:"",value:""})}else{t=[];t.push({key:"",value:""})}e.setProperty("/aAllStaticParameters",t)},addActionRow:function(){var e=this.getView().getModel();var t=e.getProperty("/objectStreamCardsSettings/customActions");if(t&&t.length){t.push({text:"",press:"",position:""})}else{t=[];t.push({text:"",press:"",position:""})}e.setProperty("/objectStreamCardsSettings/customActions",t)},onParameterDelete:function(e){var t=this.getView().getModel();var i=t.getProperty("/aAllStaticParameters");var a=e.getSource().getBindingContext().getObject()&&e.getSource().getBindingContext().getObject()["key"];i=i.filter(function(e){return e["key"]!=a});t.setProperty("/aAllStaticParameters",i);if(!m(this._oCardManifestSettings.staticParameters,this._oOriginalCardManifestSettings.staticParameters)){this.setEnablePropertyForResetAndSaveButton(true)}this.getView().getModel().refresh()},onActionDelete:function(e){var t=this.getView().getModel();var i=t.getProperty("/objectStreamCardsSettings/customActions");var a=e.getSource().getBindingContext().getObject()&&e.getSource().getBindingContext().getObject()["text"];i=i.filter(function(e){return e["text"]!=a});t.setProperty("/objectStreamCardsSettings/customActions",i);if(!m(this._oCardManifestSettings.objectStreamCardsSettings,this._oOriginalCardManifestSettings.objectStreamCardsSettings)){this.setEnablePropertyForResetAndSaveButton(true)}},updateProperty:function(e){var t=e.getSource().getId();var i=false,s;if(this._oCardManifestSettings.tabs&&this._oCardManifestSettings.tabs.length){i=true;s=parseInt(this._oCardManifestSettings.selectedKey,10);this._oCardManifestSettings.isViewResetEnabled=true;this._oCardManifestSettings.aViews[s].isViewResetEnabled=true}for(var n=0;n<this._updateManifestProperties.length;n++){if(t.indexOf(this._updateManifestProperties[n].formElementId)>-1){var o=this._updateManifestProperties[n].formElement;switch(o){case"entitySet":var r=e.getSource().getSelectedKey();if(!i){this._oCardManifestSettings["entitySet"]=e.getParameter("value")}else{this._oCardManifestSettings.tabs[s-1]["entitySet"]=e.getParameter("value")}this.onEntitySetChanged(r,t);if(this._oCardManifestSettings["entitySet"].length!==0){this.validateComboBox(this._oCardManifestSettings,"entitySet")}break;case"identificationAnnotationPath":if(!i){this._oCardManifestSettings["identificationAnnotationPath"]=e.getParameter("value")}else{this._oCardManifestSettings.tabs[s-1]["identificationAnnotationPath"]=e.getParameter("value")}break;case"selectionPresentationAnnotationPath":if(!i){this._oCardManifestSettings["selectionPresentationAnnotationPath"]=e.getParameter("value")}else{this._oCardManifestSettings.tabs[s-1]["selectionPresentationAnnotationPath"]=e.getParameter("value")}break;case"selectionAnnotationPath":if(!i){this._oCardManifestSettings["selectionAnnotationPath"]=e.getParameter("value")}else{this._oCardManifestSettings.tabs[s-1]["selectionAnnotationPath"]=e.getParameter("value")}break;case"presentationAnnotationPath":if(!i){this._oCardManifestSettings["presentationAnnotationPath"]=e.getParameter("value")}else{this._oCardManifestSettings.tabs[s-1]["presentationAnnotationPath"]=e.getParameter("value")}break;case"annotationPath":if(!i){this._oCardManifestSettings["annotationPath"]=e.getParameter("value")}else{this._oCardManifestSettings.tabs[s-1]["annotationPath"]=e.getParameter("value")}break;case"listType":this._oCardManifestSettings.listType=e.getSource().getSelectedKey();break;case"listFlavor":this._oCardManifestSettings.listFlavor=e.getSource().getSelectedKey();if(t.indexOf("sapOVPLinkListFlavor")!==-1){this.validateComboBox(this._oCardManifestSettings,"listFlavor")}break;case"KPICheckBox":this._oCardManifestSettings.addKPIHeaderCheckBox=e.getParameter("selected");this.EnableKPIHeaderFields(this._oCardManifestSettings.addKPIHeaderCheckBox);this.validateComboBox(this._oCardManifestSettings,"KPICheckBox",this._oCardManifestSettings.addKPIHeaderCheckBox);break;case"dataPointAnnotationPath":if(!i){this._oCardManifestSettings["dataPointAnnotationPath"]=e.getParameter("value")}else{this._oCardManifestSettings.tabs[s-1]["dataPointAnnotationPath"]=e.getParameter("value")}this.validateComboBox(this._oCardManifestSettings,"dataPointAnnotationPath");break;case"addODataSelectCheckBox":this._oCardManifestSettings.addODataSelectCheckBox=e.getParameter("selected");break;case"requireAppAuthorization":this._oCardManifestSettings.requireAppAuthorization=e.getParameter("value");break;case"kpiAnnotationPath":if(!i){this._oCardManifestSettings["kpiAnnotationPath"]=e.getParameter("value")}else{this._oCardManifestSettings.tabs[s-1]["kpiAnnotationPath"]=e.getParameter("value")}this._oCardManifestSettings.kpiAnnotationPath=e.getParameter("value");break;case"navigationPath":this._oCardManifestSettings.navigationPath=e.getParameter("value");break;case"title":case"subTitle":case"valueSelectionInfo":var l=false;var d=o+"Key";var h=o+"Property";this._oCardManifestSettings[o]=e.getParameter("value");this._oCardManifestSettings[h]=e.getParameter("value");for(var g in this._oCardManifestSettings.ai18nProperties){if(this._oCardManifestSettings.ai18nProperties[g].value===e.getParameter("value")){this._oCardManifestSettings[d]=this._oCardManifestSettings.ai18nProperties[g].key;l=true;break}}if(!l){this._oCardManifestSettings[d]=""}this.validateComboBox(this._oCardManifestSettings,o);break;case"existingDatasSource":if(e.mParameters.selected){a.newDataSource=false;this._oCardManifestSettings.newDataSource=false;this.handleValueStateofComboBox("","datasSourceExisting","sapOVPDataSourceExistingComboBox",false);this.resetPropertiesVisibility(t,this._oCardManifestSettings);var u=this.getView().getModel();u.setProperty("/datasources",this._oCardManifestSettings.datasourcesFromManifest)}break;case"newDatasSource":if(e.mParameters.selected){a.newDataSource=true;this._oCardManifestSettings.newDataSource=true;this.handleValueStateofComboBox("","datasSourceNew","sapOVPDataSourceNewInput",false);this.resetPropertiesVisibility(t,this._oCardManifestSettings);this.getView().setBusy(true);getNewDataSources(a.sApplicationId).then(function(e){this.getView().setBusy(false);var t=e.results;var i=this.getView().getModel();i.setSizeLimit(t.length);i.setProperty("/datasources",t)}.bind(this))}break;default:break}}}},resetPropertiesVisibility:function(e,t){if(e.indexOf("sapOVPExistingDataSource")!==-1||e.indexOf("sapOVPNewDataSource")!==-1){this._updateManifestProperties.forEach(function(e){if(!e.formElementId.includes("sapOVPExistingDataSource")&&!e.formElementId.includes("sapOVPNewDataSource")){if(e.formElementId.includes("sapOVPAddODataSelect")){t[e.formElement]=false}else{t[e.formElement]=""}}});t.model=""}else if(e.indexOf("sapOVPDataSource")!==-1){this._updateManifestProperties.forEach(function(i){if(!i.formElementId.includes("sapOVPExistingDataSource")&&!i.formElementId.includes("sapOVPNewDataSource")&&!e.includes(i.formElementId)){if(i.formElementId.includes("sapOVPAddODataSelect")){t[i.formElement]=false}else{t[i.formElement]=""}}})}else if(e.indexOf("sapOVPCardType")!==-1){this._updateManifestProperties.forEach(function(e){if(!(e.formElementId.includes("sapOVPDataSource")||e.formElementId.includes("sapOVPCardType"))){if(e.formElementId.includes("sapOVPAddODataSelect")){t[e.formElement]=false}else{t[e.formElement]=""}}})}else if(e.indexOf("sapOVPEntitySetList")!==-1){var i=this.getView().getModel("visibility").getData().showViewSwitch;this._updateManifestProperties.forEach(function(e){if(!(e.formElementId.includes("sapOVPDataSource")||e.formElementId.includes("sapOVPCardType")||e.formElementId.includes("sapOVPEntitySetList"))){if(e.formElementId.includes("sapOVPAddODataSelect")){t[e.formElement]=false}else{if(!i){t[e.formElement]=""}else{n.tabFields.forEach(function(e){if(e!=="entitySet"&&e!=="value"){t[e]=""}})}}}})}a.resetErrorHandling();this.setEnablePropertyForResetAndSaveButton(false);a.setVisibilityForFormElements(t);this.getView().getModel().refresh();this.getView().getModel("visibility").refresh()}})});
//# sourceMappingURL=SettingsDialog.controller.js.map