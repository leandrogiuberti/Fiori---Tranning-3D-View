<core:FragmentDefinition 
    xmlns="sap.m"
    xmlns:core="sap.ui.core" 
    xmlns:ovp="sap.ovp.ui"
    xmlns:template="http://schemas.sap.com/sapui5/extension/sap.ui.core.template/1" 
    template:require="{
		CardAnnotationhelper: 'sap/ovp/cards/AnnotationHelper'
	}"    
>
    <template:with 
        path="ovpCardProperties>/dataPointAnnotationPath"
        helper="CardAnnotationhelper.resolveEntityTypePath" 
        var='dataPoint'>
        <template:with 
            path="ovpCardProperties>/selectionAnnotationPath"
            helper="CardAnnotationhelper.resolveEntityTypePath" 
            var='selVar'>
            <template:with 
                path="ovpCardProperties>/presentationAnnotationPath"
                helper="CardAnnotationhelper.resolveEntityTypePath" 
                var='preVar'>
                <template:if test="{dataPoint>}">
                    <VBox id="kpiHeader" 
                        class="sapOVPKpiHeaderVbox tabindex-1" 
                        core:require="{CardAnnotationhelper: 'sap/ovp/cards/AnnotationHelper'}">
                        <template:if test="{dataPoint>Value/Path}">
                            <FlexBox 
                                items="{parts:[{path:'entitySet>'}, {path:'dataPoint>'}, {path:'selVar>'}], formatter: 'CardAnnotationhelper.getAggregateNumber'}"
                                id="kpiHBoxNumeric" 
                                class="numericContentHbox sapUiTinyMarginTop sapOvpKPIHeaderAggregateNumber" >
                                <items>
                                    <HBox class="innerNumericContentHbox sapOvpKpiContent" alignItems="End" justifyContent="SpaceBetween">
                                        <NumericContent 
                                            id="kpiNumberValue" 
                                            truncateValueTo="8"
                                            indicator="{parts:[{path:'dataPoint>'}], formatter:'CardAnnotationhelper.formThePathForTrendIcon'}"
                                            value="{path:'dataPoint>', formatter: 'CardAnnotationhelper.formThePathForAggregateNumber'}"
                                            formatterValue="true"
                                            valueColor="{path:'dataPoint>', formatter: 'CardAnnotationhelper.formatKPIHeaderState'}"
                                            state="Loaded" class="sapOvpKPIHeaderNumberValueStyle kpiHeaderClass"               
                                            withMargin="false">
                                            <customData>
                                                <ovp:CustomData 
                                                    key="aria-label"
                                                    value="{path:'dataPoint>', formatter: 'CardAnnotationhelper.getKPIHeaderAggregateNumber'} {path:'dataPoint>', formatter: 'CardAnnotationhelper.formatKPIHeaderState'}"
                                                    writeToDom="true"/>
                                            </customData>
                                        </NumericContent>
                                        <template:if test="{= ${path:'dataPoint>', formatter: 'CardAnnotationhelper.formPathForPercentageChange'} !== ''}">
                                            <FlexBox class="TargetDeviationFlexbox">
                                                <VBox class="KpiTargetContainer">
                                                    <Text id = "ovpKpiTarget" text="{ovplibResourceBundle>KPI_Target_Text}" class="KpiTargetText tabindex-1 cardHeaderText">
                                                        <customData>
                                                            <ovp:CustomData key="aria-label" value="{ovplibResourceBundle>KPI_Target_Text}" writeToDom="true" />
                                                        </customData>
                                                    </Text>
                                                    <Text id = "ovpTargetValue" text="{path:'dataPoint>', formatter: 'CardAnnotationhelper.formPathForTargetValue'}"
                                                          class="sapOvpKPIHeaderTrendPercentStyle tabindex-1 cardHeaderText">
                                                        <customData>
                                                            <ovp:CustomData key="aria-label" value="{path:'dataPoint>', formatter: 'CardAnnotationhelper.formPathForTargetValue'}" writeToDom="true" />
                                                        </customData>
                                                        <layoutData>
                                                            <FlexItemData growFactor="1"/>
                                                        </layoutData>
                                                    </Text>
                                                </VBox>
                                                <VBox class="KpiDeviationContainer">
                                                    <Text id= "ovpKPIDeviation" text="{ovplibResourceBundle>KPI_Deviation_Text}" class="KpiDeviationText tabindex-1 cardHeaderText">
                                                        <customData>
                                                            <ovp:CustomData key="aria-label" value="{ovplibResourceBundle>KPI_Deviation_Text}" writeToDom="true" />
                                                        </customData>
                                                    </Text>
                                                    <Text
                                                        id="kpiNumberPercentage"
                                                        text="{path:'dataPoint>', formatter: 'CardAnnotationhelper.formPathForPercentageChange'}"
                                                        class="sapOvpKPIHeaderTrendPercentStyle tabindex-1 cardHeaderText">
                                                        <customData>
                                                            <ovp:CustomData key="aria-label" value="{path:'dataPoint>', formatter: 'CardAnnotationhelper.formPathForPercentageChange'}" writeToDom="true" />
                                                        </customData>
                                                        <layoutData>
                                                            <FlexItemData growFactor="1"/>
                                                        </layoutData>
                                                    </Text>
                                                </VBox>
                                            </FlexBox>
                                        </template:if>
                                    </HBox>
                                </items>
                            </FlexBox>
                        </template:if>
                        <template:if test="{dataPoint>Value/Path}">
                            <template:if test="{ovpCardProperties>/valueSelectionInfo}">
                                <FlexBox class="UOMFlexbox">
                                    <Text
                                        id="ovpValueSelectionInfo"
                                        maxLines="1"
                                        text="{ovpCardProperties>/valueSelectionInfo}"
                                        class="sapOvpKPIHeaderUnitOfMeasureStyle sapOvpCardSubtitle tabindex-1 cardHeaderText">
                                        <customData>
                                            <ovp:CustomData 
                                                key="aria-label"
                                                value="{ovpCardProperties>/valueSelectionInfo}"
                                                writeToDom="true"/>
                                            <!--Temporary fix, this field must not typically have role "heading" - we need to fix the
                                            aria-labelledby logic used to retrieve all aria-labels on focus of a card  -->
                                            <ovp:CustomData key="role" value="heading" writeToDom="true" />
                                            <ovp:CustomData key="aria-level" value="2" writeToDom="true"/>
                                        </customData>
                                    </Text>
                                </FlexBox>
                            </template:if>
                        </template:if>
                        <template:if  test="{= (${ovpCardProperties>/showSortingInHeader} === true) &amp;&amp; ${path:'preVar>', formatter: 'CardAnnotationhelper.isPresentationVarientPresent'} === true}">
                            <FlexBox 
                                alignItems="Start" 
                                justifyContent="SpaceBetween" 
                                class="KpiPreVarFlex" 
                                visible="{ovpCardProperties>/showSortingInHeader}">
                                <Text 
                                    id="headerGroupByText" 
                                    maxLines="1"
                                    text="{path:'preVar>', formatter:'CardAnnotationhelper.listGroupBy'}"
                                    class="sapOvpKPIHeaderDimensionStyle tabindex-1 cardHeaderText">
                                    <customData>
                                        <ovp:CustomData 
                                            key="aria-label" 
                                            value="{path:'preVar>', formatter:'CardAnnotationhelper.listGroupBy'}" 
                                            writeToDom="true" />
                                    </customData>
                                </Text>
                            </FlexBox>
                        </template:if>
                        <template:if test="{= (${ovpCardProperties>/showFilterInHeader} === true) &amp;&amp; {parts:[{path:'selectionVar>'}, {path:'selVar>'}], formatter:'CardAnnotationhelper.formTheFilterByString'} !== ''}">
                            <template:if test="{= !${ovpCardProperties>/ignoreSelectionVariant} === true}">
                                <template:then>
                                    <FlexBox 
                                        alignItems="Start" 
                                        justifyContent="Start" 
                                        class="KpiSelVarFlex" 
                                        visible="{ovpCardProperties>/showFilterInHeader}">
                                        <template:repeat 
                                            list="{path:'selVar>SelectOptions'}" 
                                            var="selectionVar">
                                            <Text 
                                                id="{path:'selectionVar>', formatter:'CardAnnotationhelper.formTheIdForFilter'}" 
                                                text="{parts:[{path:'selectionVar>'}, {path:'selVar>'}], formatter:'CardAnnotationhelper.formTheFilterByString'}" 
                                                class="sapOvpKPIHeaderFilterStyle tabindex-1 cardHeaderText" >
                                                <customData>
                                                    <ovp:CustomData 
                                                        key="aria-label" 
                                                        value="{parts:[{path:'selectionVar>'}, {path:'selVar>'}], formatter:'CardAnnotationhelper.formTheFilterByString'}" 
                                                        writeToDom="true" />
                                                </customData>
                                            </Text>
                                        </template:repeat>
                                    </FlexBox>
                                </template:then>
                                <template:else>
                                    <FlexBox 
                                        alignItems="Start" 
                                        justifyContent="Start" 
                                        class="KpiSelVarFlex" 
                                        visible="{ovpCardProperties>/showFilterInHeader}">
                                        <template:repeat 
                                            list="{path:'ovpCardProperties>/idForExternalFilters'}" 
                                            var="selectionVar">
                                            <Text 
                                                id="{path:'selectionVar>', formatter:'CardAnnotationhelper.formTheIdForFilterNotFromSelVar'}" 
                                                text="{parts:[{path:'selectionVar>'}, {path:'ovpCardProperties>/filters'}], formatter:'CardAnnotationhelper.formTheFilterByStringNotFromSelVar'}" 
                                                class="sapOvpKPIHeaderFilterStyle tabindex-1 cardHeaderText" >
                                                <customData>
                                                    <ovp:CustomData 
                                                        key="aria-label" 
                                                        value="{parts:[{path:'selectionVar>'}, {path:'ovpCardProperties>/filters'}], formatter:'CardAnnotationhelper.formTheFilterByStringNotFromSelVar'}" 
                                                        writeToDom="true" />
                                                </customData>
                                            </Text>
                                        </template:repeat>
                                    </FlexBox>
                                </template:else>
                            </template:if>
                        </template:if>
                    </VBox>
                </template:if>
            </template:with>
        </template:with>
    </template:with>
</core:FragmentDefinition>
