/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ovp/cards/generic/Card.controller","sap/ui/thirdparty/jquery","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/cards/CommonUtils","sap/m/List","sap/ui/core/ResizeHandler","sap/m/MessageToast","sap/m/Image","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/ovp/app/OVPLogger","sap/ui/util/openWindow","sap/ovp/cards/NavigationHelper"],function(t,jQuery,e,i,s,a,r,n,o,d,h,l,g){"use strict";var c=27,f=8,p=8,u=8,v="ovpLinkList",I="pictureCarousel",L="ovpCardHeader",C="sapMCrslActive";var m={onBeforeRendering:function(t){this.itemOnBeforeRendering(t)}};var y={onAfterRendering:function(t){this.itemOnAfterRendering(t)}};var P=new h("ovp.cards.generic.base.linklist.BaseLinklist");return t.extend("sap.ovp.cards.generic.base.linklist",{onInit:function(){t.prototype.onInit.apply(this,arguments);this.oListRow=this.byId("ovpListRow");if(this.oListRow){this.oListRow.addStyleClass("ovpListRowNoData")}this._bInitialLoad=true;this._bListenerAttached=false;this._bListeningPopOver=false},onBeforeRendering:function(t){var e=this.getCardPropertiesModel();if(e.getProperty("/listFlavor")==="standard"&&!e.getProperty("/staticContent")){var i=this.byId("ovpCLI");if(i){i.addEventDelegate(m,this)}}},onAfterRendering:function(i){t.prototype.onAfterRendering.apply(this,arguments);this.attachingListenerToTheEventRefresh();var s=this.getCardPropertiesModel();var a=s.getProperty("/cardLayout/rowSpan");var r=s.getProperty("/cardLayout/colSpan");var n=this.getCardItemsBinding();if(n&&n.getPath()){var o=this;n.attachDataReceived(function(t){o.onDataReceived.call(o,t)})}switch(s.getProperty("/listFlavor")){case"standard":if(s.getProperty("/staticContent")){if(r&&a){if(!this._bInitialLoad&&this._aLinkListIds){this._mergeAllTheDataInOneList()}if(a===1){this._aLinkListIds=[v];this._setListColumnWidthInStandardCard(1)}else{this._itemOnEventBuildStandard(s,r,a,true)}}else{this._aLinkListIds=[v];this._setListColumnWidthInStandardCard(1)}}break;case"carousel":var d=this.byId(I);if(d.getId().indexOf(".")!==-1){var h=d.$();h.off("beforeSlide");h.on("beforeSlide",this.onBeforeSlide);h.trigger("beforeSlide",[1,1])}if(s.getProperty("/staticContent")){if(a&&!(!s.getProperty("/defaultSpan")&&s.getProperty("/cardLayout/autoSpan"))){this._setListHeightInCarouselCard(a)}else{this._setListHeightInCarouselCard(-1)}this._setCarouselImageProperties()}else{d.addEventDelegate(y,this)}break;default:break}if(!e.checkIfAPIIsUsed(this)&&s.getProperty("/layoutDetail")==="resizable"){var l=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var g=this.oDashboardLayoutUtil.getCardDomId(this.cardId);var c=document.getElementById(g);l.dashboardLayout.showOnlyHeader?c.classList.add("sapOvpMinHeightContainer"):c.classList.remove("sapOvpMinHeightContainer")}var f=this.byId("ovpLinkList");if(f){f.attachBrowserEvent("click",this.updateControlPressed)}},onBeforeSlide:function(t,e,i){if(t.target!=this){return}var s=this.id+"-pageIndicator",a=document.getElementById(s);var r=a.querySelector("[data-slide='"+e+"']");r.classList.remove(C);r=a.querySelector("[data-slide='"+i+"']");r.classList.add(C)},getCardItemsBinding:function(){var t=this.getView().byId("ovpLinkList");var e=this.getView().byId("pictureCarousel");if(t){return t.getBinding("items")}else if(e){return e.getBinding("pages")}else{return null}},attachingListenerToTheEventRefresh:function(){var t=this.getCardItemsBinding();var e=this.getCardPropertiesModel();if(t){if(!this._bListenerAttached){t.attachRefresh(function(){if(this._aLinkListIds){for(var t=1;t<this._aLinkListIds.length;t++){var e=this.byId(this._aLinkListIds[t]);var i=e.getItems().length;e.getItems().splice(0,i);e.destroy()}this._aLinkListIds.splice(0,this._aLinkListIds.length)}if(this._oListRest){this._oListRest.destroy()}}.bind(this));t.attachChange(function(){this.settingHeightAndWidthOfLinkListCardsOnManageCardAndFilter();if(e.getProperty("/listFlavor")==="carousel"){var i=this.byId(I);i.addEventDelegate(y,this)}if(e.getProperty("/listFlavor")==="standard"){var s=t.getLength();if(s===0){var a=this.byId(v).$().parent();a.width("100%")}}}.bind(this))}else if(this._aLinkListIds){this.settingHeightAndWidthOfLinkListCardsOnManageCardAndFilter()}this._bListenerAttached=true}},settingHeightAndWidthOfLinkListCardsOnManageCardAndFilter:function(){if(this._aLinkListIds){var t=this.getCardPropertiesModel();var e=t.getProperty("/cardLayout/rowSpan");if(!t.getProperty("/defaultSpan")&&t.getProperty("/cardLayout/autoSpan")){e=this.getSpansWhenNoDefaultSpanMentioned()}var i=t.getProperty("/cardLayout/colSpan");if(e){this._setListHeightInStandardCard(e)}if(i){this._setListColumnWidthInStandardCard(this._iVisibleColums)}else{this._setListColumnWidthInStandardCard(1)}}},itemOnBeforeRendering:function(t){var e,i=this.getCardPropertiesModel();switch(i.getProperty("/listFlavor")){case"standard":if(!i.getProperty("/defaultSpan")&&!i.getProperty("/staticContent")&&i.getProperty("/cardLayout/autoSpan")){e=this.getSpansWhenNoDefaultSpanMentioned()}else{e=i.getProperty("/cardLayout/rowSpan")}var s=i.getProperty("/cardLayout/colSpan");var a=this.byId(v);var r=a.getItems();for(var n=0;n<r.length;n++){r[n].removeEventDelegate(m)}if(this._bInitialLoad){this._itemOnEventBuildStandard(i,s,e,true)}else{this._itemOnEventBuildStandard(i,s,e,false)}break;case"carousel":P.info("FYI: currently nothing special to handle here");break;default:break}},getSpansWhenNoDefaultSpanMentioned:function(){var t=this.getCardPropertiesModel();var e=t.getProperty("/staticContent");var i=e&&e.length||this.getCardItemsBinding()&&this.getCardItemsBinding().getLength()||0;var s=e?this.getItemHeight(this,v,true):t.getProperty("/cardLayout/itemHeight");var a=0;var r=this.byId(L);if(r){a=r.$().outerHeight()}var n=t.getProperty("/cardLayout/iRowHeightPx");return Math.ceil((s*Math.min(i,6)+(a+p+u))/n)},itemOnAfterRendering:function(t){var e=this.getCardPropertiesModel();var i=e.getProperty("/cardLayout/rowSpan");var s=e.getProperty("/cardLayout/colSpan");switch(e.getProperty("/listFlavor")){case"standard":try{var a=this.byId(v);var r=a.getItems(this._aLinkListIds[this._aLinkListIds.length-1]);r[r.length-1].removeEventDelegate(y)}catch(t){P.info("FYI: Unable to remove the delagted event at the last item of the last list")}if(!e.getProperty("/defaultSpan")&&e.getProperty("/cardLayout/autoSpan")){i=this.getSpansWhenNoDefaultSpanMentioned()}if(i){this._setListHeightInStandardCard(i)}if(s){this._setListColumnWidthInStandardCard(this._iVisibleColums)}else{this._setListColumnWidthInStandardCard(1)}break;case"carousel":try{var n=this.byId(I);n.removeEventDelegate(y)}catch(t){P.info("FYI: Unable to remove the delagted event on the carousel")}if(i&&!(!e.getProperty("/defaultSpan")&&e.getProperty("/cardLayout/autoSpan"))){this._setListHeightInCarouselCard(i)}else{this._setListHeightInCarouselCard(-1)}this._setCarouselImageProperties();break;default:break}this._bInitialLoad=false},_itemOnEventBuildStandard:function(t,e,i,a){var r;var n=this.byId(v);var o=this.getView().byId(this.getView().getId()+"--RestOfData");if(o){o.destroy()}if(a&&this._oListRest===undefined){this._oListRest=new s(this.getView().getId()+"--RestOfData",{})}this._aLinkListIds=[v];this._iAvailableItems=n.getItems().length;var d=t.getProperty("/cardLayout/items");if(d!==undefined){this._iNoOfItemsPerColumn=d;r=d;this._iVisibleColums=1}else{var h=t.getProperty("/staticContent")?this.getItemHeight(this,v,true):t.getProperty("/cardLayout/itemHeight");var l=this._getListHeightInStandardCard(i);this._iNoOfItemsPerColumn=Math.floor(l/h);var g=Math.ceil(this._iAvailableItems/this._iNoOfItemsPerColumn);this._iVisibleColums=Math.min(g,e);r=this._iVisibleColums*this._iNoOfItemsPerColumn}if(r>this._iAvailableItems){r=this._iAvailableItems}else{for(var c=r;c<this._iAvailableItems;c++){n.getItems()[c].setVisible(false)}}if(this._iVisibleColums>1){var f=this.byId("ovpListRow");var p=this._iNoOfItemsPerColumn;var u=0;for(var I=this._iNoOfItemsPerColumn;I<r;I++){if(p>=this._iNoOfItemsPerColumn){p=0;u++;var L=v+u;var C=new s(this.getView().getId()+"--"+L,{showSeparators:n.getProperty("showSeparators")});this._aLinkListIds.push(L);if(n.hasStyleClass("_iNoOfItemsPerColumnPaddingCozy")){C.addStyleClass("sapOvpLinkListStandardPaddingCozy")}else{C.addStyleClass("sapOvpLinkListStandardPaddingCompact")}f.addItem(C)}C.addItem(n.getItems()[this._iNoOfItemsPerColumn]);p++}if(C){var m=C.getItems();m[m.length-1].addEventDelegate(y,this)}}else{if(a){this.itemOnAfterRendering(null)}else{var P=n.getItems();P[P.length-1].addEventDelegate(y,this)}}},resizeCard:function(t,e){var i=this.getCardPropertiesModel();i.setProperty("/cardLayout/rowSpan",t.rowSpan);i.setProperty("/cardLayout/colSpan",t.colSpan);i.setProperty("/cardLayout/itemHeight",e.itemHeight);switch(i.getProperty("/listFlavor")){case"standard":this._resizeStandard(t,i);break;case"carousel":this._resizeCarousel(t);break;default:break}if(this.resizeHandlerId){a.deregister(this.resizeHandlerId);this.resizeHandlerId=null}var s=this.getView().byId("ovpCardContentContainer").getDomRef();if(s){if(t.showOnlyHeader){s.classList.add("sapOvpContentHidden")}else{s.classList.remove("sapOvpContentHidden")}}},_mergeAllTheDataInOneList:function(){var t=this._aLinkListIds.length;var e=this.getView().byId("ovpLinkList");var i=-1;for(var s=0;s<e.getItems().length;s++){if(!e.getItems()[s].getVisible()){i=s;break}}for(var a=1;a<t;a++){var r=this.getView().byId(this._aLinkListIds[a]);var n=r.getItems().length;for(var o=0;o<n;o++){if(i===-1){e.addItem(r.getItems()[0])}else{e.insertItem(r.getItems()[0],i);i++}}r.destroy()}},_resizeStandard:function(t,e){if(this._aLinkListIds){this._mergeAllTheDataInOneList();var i=this.getView().byId("ovpLinkList");this._aLinkListIds.splice(0,this._aLinkListIds.length);var s=this._oListRest.getItems().length;try{for(var a=0;a<s;a++){i.addItem(this._oListRest.getItems()[0])}}catch(t){P.info("Error: "+t)}for(var r=0;r<i.getItems().length;r++){i.getItems()[r].setVisible(true)}if(!i){var n=this.byId(v).$().parent();n.width("100%");var o=e.getProperty("/cardLayout/rowSpan");if(o){this._setListHeightInStandardCard(o)}}var d=i.getBindingInfo("items");var h=e.getProperty("/staticContent")?this.getItemHeight(this,v,true):e.getProperty("/cardLayout/itemHeight");var l=this._getListHeightInStandardCard(t.rowSpan);var g=Math.floor(l/h)*t.colSpan;this._bInitialLoad=false;jQuery(this.getView().$()).find(".sapOvpWrapper").css({height:l+"px"});if(d){if(g>this._iAvailableItems&&d.length<=this._iAvailableItems){d.length=g;i.bindItems(d);this._bListenerAttached=false;this.attachingListenerToTheEventRefresh()}else{this._itemOnEventBuildStandard(e,t.colSpan,t.rowSpan,false)}}else{this._itemOnEventBuildStandard(e,t.colSpan,t.rowSpan,false)}}},_resizeCarousel:function(t){this._setListHeightInCarouselCard(t.rowSpan);this._setCarouselImageProperties()},_setListHeightInCarouselCard:function(t){var e=0,i=this.byId(I);if(t!==-1){var s=0;var a=this.byId(L);if(a){s=a.$().outerHeight()}var r=this.getCardPropertiesModel();var n=r.getProperty("/cardLayout/iRowHeightPx");e=t*n-(s+c+f);i.$().height(e+16)}else{var o=i.$().width(),d=null,h=i.getPages(),l=0;for(var g=0;g<h.length;g++){d=h[g];if(d&&d.getItems().length>1){l=Math.max(l,d.getItems()[0].$().outerHeight())}}var p=i.$().find(".sapMCrslControlsBottom.sapMCrslControls").outerHeight();e=o+(l+p);i.$().height(e)}},_setCarouselImageProperties:function(){var t=this.byId(I),e=t.getPages(),i=t.$().height(),s=e.length>1?t.$().find(".sapMCrslControlsBottom.sapMCrslControls").outerHeight():0,a=null,r=null,o=0,d,h;for(var l=0;l<e.length;l++){a=e[l];if(a){d=a.getAggregation("items")&&a.getItems()[0];if(d){o=d.hasStyleClass("sapOvpCarouselContentHeader")?d.$().outerHeight():0;h=a.getItems()[a.getItems().length-1];r=h.getAggregation("items")&&h.getItems()[0];if(r instanceof n){this._setCarouselImageHeight(r,i-o-s)}}}}},_setCarouselImageHeight:function(t,e){var i=t.getDomRef().naturalHeight;if(i!==0){i<e?t.setHeight(i+"px"):t.setHeight(e+"px")}},_setListHeightInStandardCard:function(t){var e=0;var i;var s;i=this.byId(v);if(i){e=this._getListHeightInStandardCard(t);s=i.$().parent();s.height(e)}if(this._aLinkListIds){for(var a=1;a<this._aLinkListIds.length;a++){i=this.byId(this._aLinkListIds[a]);e=this._getListHeightInStandardCard(t);s=i.$().parent();s.height(e)}}},_getListHeightInStandardCard:function(t){var e=0;var i=this.getCardPropertiesModel();if(t){var s=0;var a=this.byId(L);if(a){s=a.$().outerHeight()}var r=i.getProperty("/cardLayout/iRowHeightPx");e=t*r-(s+p+u)}return e},_setListColumnWidthInStandardCard:function(t){var e;var i;var s="100%";if(this._aLinkListIds){if(this._aLinkListIds.length>1){for(var a=0;a<this._aLinkListIds.length;a++){e=this.byId(this._aLinkListIds[a]);i=e.$().parent();s=100/t+"%";i.width(s)}}else{e=this.byId(this._aLinkListIds[0]);if(e){i=e.$().parent();i.width(s)}}}},onLinkListItemPressLocalData:function(t){if(e.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){i.onContentClicked(t)}}else{var s=t.getSource().data("targetUri");var a=t.getSource().data("openInNewWindow");var r=this.getView().getModel("ovpCardProperties").getProperty("/baseUrl");if(s){s=this.buildUrl(r,s);if(a==="true"){l(s,"newWindow")}else{window.location.href=s}}}},onLinkListActionPressLocalData:function(t){if(e.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){i.onContentClicked(t)}}else{var s=t.getSource().data("dataAction");this.getView().getModel().callFunction(s,{method:"POST",urlParameters:{FunctionImport:s},success:this.onFuImpSuccess.bind(this),error:this.onFuImpFailed.bind(this)})}},onFuImpSuccess:function(t){r.show(o.getText("Toast_Action_Success"),{duration:3e3})},onFuImpFailed:function(t){r.show(o.getText("Toast_Action_Error"),{duration:3e3})},onLinkListItemPress:function(t){var s=d.bCRTLPressed?d.constants.explace:d.constants.inplace;d.bCRTLPressed=false;if(e.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){i.onContentClicked(t)}}else{var a=g.getEntityNavigationEntries(t.getSource().getBindingContext(),this.getModel(),this.getEntityType(),this.getCardPropertiesModel(),this.getCardPropertiesModel().getProperty("/annotationPath"));this.doNavigation(t.getSource().getBindingContext(),a[0],s)}},onLinkPopover:function(t){if(e.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){i.onContentClicked(t)}}else{var s;switch(this.getCardPropertiesModel().getProperty("/listFlavor")){case"standard":s=t.getSource().getParent().getAggregation("items")[0];break;case"carousel":s=t.getSource().getParent().getAggregation("items")[0];break;default:break}var a=this.getCardPropertiesModel();if(a.getProperty("/listFlavor")==="carousel"){var r=this.byId(I);r.addEventDelegate(y,this)}s.bindElement(t.getSource().getBindingContext().getPath());s.openBy(t.getSource());if(!this._bListeningPopOver){s.attachAfterOpen(function(){this.settingHeightAndWidthOfLinkListCardsOnManageCardAndFilter()}.bind(this))}this._bListeningPopOver=true}},onLinkListLineItemUrl:function(t){if(e.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){i.onContentClicked(t)}}else{var s,a="com.sap.vocabularies.UI.v1.LineItem",r;if(i.isODataV4(this.getView().getModel())){r=this.entityType["@"+a][0].Url}else{r=this.entityType[a][0].Url}if(r.hasOwnProperty("String")){s=r.String}else{var n=g.getEntityNavigationEntries(t.getSource().getBindingContext(),this.getModel(),this.getEntityType(),this.getCardPropertiesModel(),a)[0];s=n.url}if(s){window.location.href=s}else{P.info("LinkList Standard Card: No Navigation on line item")}}},onLinkNavigationSingleTarget:function(t){var s=d.bCRTLPressed?d.constants.explace:d.constants.inplace;d.bCRTLPressed=false;if(e.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){i.onContentClicked(t)}}else{var a=g.getEntityNavigationEntries(t.getSource().getBindingContext(),this.getModel(),this.getEntityType(),this.getCardPropertiesModel(),undefined);this.doNavigation(t.getSource().getBindingContext(),a[0],s)}},buildUrl:function(t,e){if(e.lastIndexOf(t,0)===0||e.indexOf("://")>0){return e}else if(e.lastIndexOf("/",0)===0){return t+e}else{return t+"/"+e}},onLinkListActionPress:function(t){if(e.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){i.onContentClicked(t)}}else{var s=t.getSource().data("dataAction");this.getView().getModel().callFunction(s,{method:"POST",urlParameters:{FunctionImport:s},success:this.onFuImpSuccess.bind(this),error:this.onFuImpFailed.bind(this)})}},onLinkListSemanticObjectPressLocalData:function(t){var s=d.bCRTLPressed?d.constants.explace:d.constants.inplace;d.bCRTLPressed=false;if(e.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){i.onContentClicked(t)}}else{var a=parseInt(t.getSource().data("contentRowIndex"),10);this._oStaticContent=this.getCardPropertiesModel().getProperty("/staticContent");if(this._oStaticContent[a].semanticObject&&this._oStaticContent[a].action){var n={semanticObject:this._oStaticContent[a].semanticObject,action:this._oStaticContent[a].action,iStaticLinkListIndex:a};this.doIntentBasedNavigation(null,n,false,s)}else{r.show(o.getText("Toast_Action_Error"),{duration:3e3})}}},onExit:function(){t.prototype.onExit.apply(this,arguments)},onDataReceived:function(){this.bdataLoadedToEnableAddToInsight=false}})});
//# sourceMappingURL=BaseLinklist.controller.js.map