/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 * @fileOverview Miscellaneous utility functions for legacy cards.
 * See VizAnnotationManager.js for generic card methods.
 * This file can be safely deleted when legacy cards deprecate.
 */
sap.ui.define(["sap/base/util/each","sap/base/util/merge","sap/ovp/app/OVPLogger","sap/ovp/cards/generic/base/analytical/config","sap/ovp/cards/CommonUtils","sap/base/util/isEmptyObject","sap/ovp/cards/AnnotationHelper","sap/ovp/cards/Constants","sap/ui/core/format/NumberFormat"],function(e,t,r,a,n,i,o,s,u){"use strict";var l=["year","yearweek","yearmonth","yearquarter"];var f={};var m=t({CHART_QUALIFIER_KEY:"chartAnnotationPath",SELVAR_QUALIFIER_KEY:"selectionAnnotationPath",PREVAR_QUALIFIER_KEY:"presentationAnnotationPath",ERROR_NO_CHART:'Analytic cards require valid "chartAnnotationPath" '+"configured in manifest.json",LABEL_KEY:"sap:label",TEXT_KEY:"sap:text",TYPE_KEY:"type"},s.Annotations);var c=s.errorMessages;var p=new r("ovp.cards.generic.base.analytical.Utils");function v(e,t){if(!t){return""}var r=e.getSetting("ovpCardProperties");if(!r){return""}var a=r.oData;if(!a){return""}var n=a&&a[t]?a[t]:"";return n===""?"":n.split("#")[1]}function g(e,t){if(e&&e.Boolean){if(e.Boolean.toLowerCase()==="true"){return true}else if(e.Boolean.toLowerCase()==="false"){return false}}else if(e&&e.Bool){if(e.Bool.toLowerCase()==="true"){return true}else if(e.Bool.toLowerCase()==="false"){return false}}return t}f.getNumberValue=function(e,t){var r;if(e){if(e.String){r=Number(e.String)}else if(e.Int){r=Number(e.Int)}else if(e.Decimal){r=Number(e.Decimal)}else if(e.Double){r=Number(e.Double)}else if(e.Single){r=Number(e.Single)}}if(t){var a=u.getFloatInstance({style:"short",minFractionDigits:2,maxFractionDigits:2});if(r){r=a.format(Number(r))}}return r};f.getAllColumnTexts=function(e){return P("sap:text",e)};f.formDimensionPath=function(e){var t="{"+e+"}";var r=this.getModel("ovpCardProperties").getProperty("/entityType");if(!r){return t}var a=C(r);if(!a||!a[e]){return t}var n=a[e];if(n=="Edm.DateTime"){return"{= ${"+e+"} ? ${"+e+"} : ''}"}var i=f.getAllColumnTexts(r);if(!i){return t}t="{"+(i[e]||e)+"}";return t};function P(e,t){var r={};var a=t.property;for(var n=0,i=a.length;n<i;n++){if(a[n].hasOwnProperty(e)&&e=="com.sap.vocabularies.Common.v1.Label"){r[a[n].name]=a[n][e].String}else if(a[n].hasOwnProperty(e)){r[a[n].name]=a[n][e]}else{r[a[n].name]=a[n].name}}return r}function h(e){return P("com.sap.vocabularies.Common.v1.Label",e)}function C(e){return P("type",e)}var d={};f.LineChart=function(){function t(t,n,i){var o=r(t,i).split(",");var s=a(t,n).split(",");var u=[];e(o,function(e,t){u.push(t)});var l=[];e(s,function(e,t){l.push(t)});var f=true;var m=t.getSetting("ovpCardProperties").getProperty("/navigation");if(m=="chartNav"){f=false}var f=f?false:true;return"{ valueAxis:{  layout: { maxWidth : 0.4 }, title:{   visible:false,   text: '"+u.join(",")+"'  },  label:{   formatString:'axisFormatter'  } }, categoryAxis:{  title:{   visible:false,   text: '"+l.join(",")+"'  },  label:{   formatString:'axisFormatter'  } }, legend: {  isScrollable: false, itemMargin: 1.25 }, title: {  visible: false }, general: { groupData: false }, interaction:{  noninteractiveMode: "+f+",  selectability: {   legendSelection: false,   axisLabelSelection: false,   mode: 'EXCLUSIVE',   plotLassoSelection: false,   plotStdSelection: true  }, zoom:{   enablement: 'disabled'} } }"}t.requiresIContext=true;function r(t,r){var a=t.getSetting("ovpCardProperties").getProperty("/entityType");if(!a){return""}var n=h(a);var i=[];e(r,function(e,t){i.push(n[t.Measure.PropertyPath]||t.Measure.PropertyPath)});return i.join(",")}r.requiresIContext=true;function a(t,r){var a=t.getSetting("ovpCardProperties").getProperty("/entityType");if(!a){return""}var n=h(a);var i=[];var o;var s;e(r,function(e,t){if(t.Role.EnumMember.split("/")[1]==="Category"){s=n[t.Dimension.PropertyPath];i.push(s?s:t.Dimension.PropertyPath)}});if(i.length<1){s=n[r[0].Dimension.PropertyPath];i.push(s?s:r[0].Dimension.PropertyPath)}o=v(t,m.CHART_QUALIFIER_KEY);d[o]=i;return i.join(",")}a.requiresIContext=true;function n(t,r){var a=[];var n;var i=t.getSetting("ovpCardProperties").getProperty("/entityType");if(!i){return""}var o=h(i);var s;e(r,function(e,t){if(t.Role.EnumMember.split("/")[1]==="Series"){s=o[t.Dimension.PropertyPath];a.push(s?s:t.Dimension.PropertyPath)}});n=v(t,m.CHART_QUALIFIER_KEY);a=a.filter(function(e){if(!d[n]){return true}return e!==d[n][0]});return a.join(",")}n.requiresIContext=true;function i(e,t){return n(e,t)!==""}i.requiresIContext=true;return{getVizProperties:t,getValueAxisFeed:r,getCategoryAxisFeed:a,getColorFeed:n,testColorFeed:i}}();f.BubbleChart=function(){function t(t,r,i){var o=a(t,i).split(",");var s=n(t,i).split(",");var u=[];e(o,function(e,t){u.push(t)});var l=[];e(s,function(e,t){l.push(t)});var f=true;var m=t.getSetting("ovpCardProperties").getProperty("/navigation");if(m=="chartNav"){f=false}var f=f?false:true;return"{ valueAxis:{  layout: { maxWidth : 0.4 }, title:{ visible:true, text: '"+u.join(",")+"'  },  label:{ formatString:'axisFormatter'  } }, valueAxis2:{  title:{ visible:true, text: '"+l.join(",")+"'  },  label:{ formatString:'axisFormatter'  } }, categoryAxis:{  title:{ visible:true  },  label:{ formatString:'axisFormatter'  } }, legend: {  isScrollable: false, itemMargin: 1.25 }, title: {  visible: false }, interaction:{  noninteractiveMode: "+f+",  selectability: { legendSelection: false, axisLabelSelection: false, mode: 'EXCLUSIVE', plotLassoSelection: false, plotStdSelection: true  }, zoom:{   enablement: 'disabled'} } }"}t.requiresIContext=true;function r(t,r){var a;if(!t||!t.getSetting||!(a=t.getSetting("ovpCardProperties"))){return[""]}var n=a.getProperty("/entityType");if(!n){return[""]}var i=h(n);var o=[null,null,null];var s=["Axis1","Axis2","Axis3"];e(r,function(e,t){if(s.indexOf(t.Role.EnumMember.split("/")[1])>-1){if(o[0]===null){o[0]=i[t.Measure.PropertyPath]||t.Measure.PropertyPath}else if(o[1]===null){o[1]=i[t.Measure.PropertyPath]||t.Measure.PropertyPath}else if(o[2]==null){o[2]=i[t.Measure.PropertyPath]||t.Measure.PropertyPath}}});return o}r.requiresIContext=true;function a(e,t){return r(e,t)[0]}a.requiresIContext=true;function n(e,t){return r(e,t)[1]}n.requiresIContext=true;function i(e,t){return r(e,t)[2]}i.requiresIContext=true;function o(t,r){var a=t.getSetting("ovpCardProperties").getProperty("/entityType");if(!a){return""}var n=h(a);var i=[];var o;e(r,function(e,t){if(t.Role.EnumMember.split("/")[1]==="Series"){o=n[t.Dimension.PropertyPath];i.push(o?o:t.Dimension.PropertyPath)}});return i.join(",")}o.requiresIContext=true;function s(t,r){var a=t.getSetting("ovpCardProperties").getProperty("/entityType");if(!a){return""}var n=h(a);var i=[];var o;e(r,function(e,t){if(t.Role.EnumMember.split("/")[1]==="Category"){o=n[t.Dimension.PropertyPath];i.push(o?o:t.Dimension.PropertyPath)}});return i.join(",")}s.requiresIContext=true;function u(e,t){return o(e,t)!==""}u.requiresIContext=true;function l(e,t){return s(e,t)!==""}l.requiresIContext=true;return{getVizProperties:t,getMeasurePriorityList:r,getValueAxisFeed:a,getValueAxis2Feed:n,getBubbleWidthFeed:i,getColorFeed:o,getShapeFeed:s,testColorFeed:u,testShapeFeed:l}}();f.validateMeasuresDimensions=function(e,t){var r=null;var a=null;if(!e.getDataset()){p.error("OVP-AC: "+t+" Card Error: No Dataset defined for chart.");return false}r=e.getDataset().getMeasures();a=e.getDataset().getDimensions();switch(t){case"Bubble":if(r.length!==3||a.length<1||!r[0].getName()||!r[1].getName()||!r[2].getName()||!a[0].getName()){p.error("OVP-AC: Bubble Card Error: Enter exactly 3 measures and at least 1 dimension.");return false}break;case"Donut":if(r.length!==1||a.length!==1||!r[0].getName()||!a[0].getName()){p.error("OVP-AC: Donut Card Error: Enter exactly 1 measure and 1 dimension.");return false}break;case"Line":if(r.length<1||a.length<1||!r[0].getName()||!a[0].getName()){p.error("OVP-AC: Line Card Error: Configure at least 1 dimensions and 1 measure.");return false}break}return true};f.getSortAnnotationCollection=function(e,t,r){if(t&&t.SortOrder&&t.SortOrder.Path&&t.SortOrder.Path.indexOf("@")>=0){var a=t.SortOrder.Path.split("@")[1];var n=e.getServiceAnnotations()[r.entityType];return n[a]}return t.SortOrder};f.oFullConfig=null;f.getConfig=function(e,r){if(!this.oFullConfig){try{this.oFullConfig=t({},a.getChartsConfiguration())}catch(e){p.error(c.CONFIG_LOAD_ERROR+e)}}if(!e){return this.oFullConfig}var n;try{n=r?e.$EnumMember.split("/")[1]:e.EnumMember.split("/")[1]}catch(e){p.error(c.CARD_ERROR+c.INVALID_CHARTTYPE+c.ANNO_REF);return{}}if(!this.oFullConfig[n]){p.error(c.INVALID_CONFIG+n+" "+c.CONFIG_JSON);return{}}var i;if((i=this.oFullConfig[n].reference)&&this.oFullConfig[i]){var o=t({},this.oFullConfig[i]);this.oFullConfig[n]=o}return this.oFullConfig[n]};f.oCachedMetaModel={};f.cacheODataMetadata=function(t){if(!t){p.error(c.CARD_ERROR+c.CACHING_ERROR);return}var r=this.oCachedMetaModel[t.getId()];if(!r){r={};var a=t.getMetaModel();var i=n.isODataV4(t);if(i){var o=a&&a.getObject("/");var s,u;e(o,function(t,n){if(t!="$kind"){s=a.getObject("/"+n.$Type);u={};e(s,function(e,t){if(t.$kind&&t.$kind=="Property"){u[e]=t}});r[t]=u}})}else{var o=a&&a.getODataEntityContainer();var s,u;e(o.entitySet,function(t,n){s=a.getODataEntityType(n.entityType);u={};e(s.property,function(e,t){u[t.name]=t});r[n.name]=u})}this.oCachedMetaModel[t.getId()]=r}return r};f.checkIfDataExistInEvent=function(e){if(e&&e.getSource()&&e.getSource().getCurrentContexts()){var t=e.getSource().getCurrentContexts().some(function(e){return typeof e==="undefined"});return!t}return false};f.isDataSetEmpty=function(e){if(e&&e.getSource()&&e.getSource().getCurrentContexts()){return e.getSource().getCurrentContexts().length===0}};f.getSemanticProperties=function(t){var r={aTimeAxisProperties:[],oTimeAxisPropertiesAndSemantics:{},propertyType:""};if(t){var a=Object.keys(t);if(a&&a.length){e(a,function(e,a){if(t[a]["type"]==="Edm.String"){if(t[a]["sap:semantics"]==="yearmonth"||t[a]["com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]){r.aTimeAxisProperties.push(a);r.oTimeAxisPropertiesAndSemantics[a]={semantics:"yearmonth"};r.propertyType="yearmonth"}else if(t[a]["sap:semantics"]==="yearquarter"||t[a]["com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]){r.aTimeAxisProperties.push(a);r.oTimeAxisPropertiesAndSemantics[a]={semantics:"yearquarter"};r.propertyType="yearquarter"}else if(t[a]["sap:semantics"]==="yearweek"||t[a]["com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]){r.aTimeAxisProperties.push(a);r.oTimeAxisPropertiesAndSemantics[a]={semantics:"yearweek"};r.propertyType="yearweek"}else if(t[a]["sap:semantics"]==="fiscalyearperiod"||t[a]["com.sap.vocabularies.Common.v1.IsFiscalYearPeriod"]){r.aTimeAxisProperties.push(a);r.oTimeAxisPropertiesAndSemantics[a]={semantics:"fiscalyearperiod"}}}})}}return r};f.getMetadata=function(e,t){var r=this.cacheODataMetadata(e)||{};return r[t]};f.isV4TimeSeriesSemantics=function(e,t,r,a){if(a){var n=e.getMetaModel().getObject("/"+t+"/"+r+"@");return n["@com.sap.vocabularies.Common.v1.IsCalendarYear"]||n["@com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]||n["@com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]||n["@com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]}var i=this.getMetadata(e,t);return i[r]["com.sap.vocabularies.Common.v1.IsCalendarYear"]||i[r]["com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]||i[r]["com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]||i[r]["com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]};f.hasTimeSemantics=function(e,t,r,a,n){var o=false;var s;var u;var f;var c;var p;var v;if(!t.time||i(t.time)){return o}if(!e){return o}for(var g=0;g<e.length;g++){if(e[g].Dimension){v=n?e[g].Dimension.$PropertyPath:e[g].Dimension.PropertyPath}if(!e[g].Dimension){return o}s=this.getMetadata(r,a);if(s&&s[v]){u=s[v][m.TYPE_KEY]||s[v]["$Type"];f=s[v][m.DISPLAY_FORMAT_KEY];c=s[v][m.SEMANTICS_KEY];p=this.isV4TimeSeriesSemantics(r,a,v,n)}if(u&&u.lastIndexOf("Edm.Date",0)===0){if(u.toLowerCase()==="edm.datetime"){o=f&&f.toLowerCase()==="date"}else{o=true}}if(u==="Edm.String"&&(p||c&&l.indexOf(c)>-1)){o=true}if(o){e.unshift(e.splice(g,1)[0]);break}}return o};f.mapMeasures=function(t,r,a,n){var i,o,s;e(r,function(e,r){if(r["com.sap.vocabularies.Common.v1.Label"]&&r["com.sap.vocabularies.Common.v1.Label"].String===t.measureNames){i=r.name;return false}else if(r["com.sap.vocabularies.Common.v1.Label"]&&r["com.sap.vocabularies.Common.v1.Label"].Path===t.measureNames){i=r.name;return false}else if(r["sap:label"]===t.measureNames){i=r.name;return false}});e(a,function(e,t){if(t.Measure.PropertyPath===i){s=n?t.DataPoint.$AnnotationPath:t.DataPoint.AnnotationPath;if(!t.DataPoint||!s){return false}o=s;return false}});return o};f.validateCardConfiguration=function(e,t){var r=false;if(!e){return r}var a;var n;var s;var u;var l;var f;var m;var v="";var g;var P=e.getView();if(P){v="["+P.getId()+"] "}if(!(g=e.getCardPropertiesModel())){p.error(v+c.CARD_ERROR+"in "+c.CARD_CONFIG+c.NO_CARD_MODEL);return r}m=g.getProperty("/entityType");if(t){var h=e.getMetaModel();m=h.getData().$Annotations[m.$Type]}if(!m||i(m)){p.error(v+c.CARD_ERROR+"in "+c.CARD_ANNO);return r}a=g.getProperty("/selectionAnnotationPath");n=g.getProperty("/chartAnnotationPath");u=g.getProperty("/presentationAnnotationPath");l=g.getProperty("/identificationAnnotationPath");f=g.getProperty("/dataPointAnnotationPath");s=g.getProperty("/contentFragment");r=o.checkExists(a,m,"Selection Variant",false,v,s,t);r=o.checkExists(n,m,"Chart Annotation",true,v,s,t)&&r;r=o.checkExists(u,m,"Presentation Variant",false,v,s,t)&&r;r=o.checkExists(l,m,"Identification Annotation",true,v,s,t)&&r;r=o.checkExists(f,m,"Data Point",false,v,s,t)&&r;return r};f.getPrimitiveValue=function(e,t){var r;if(e){if(e.String){r=e.String}else if(e.Boolean||e.Bool){r=g(e)}else{r=this.getNumberValue(e,t)}}return r};f.getPathFormedOrPrimitiveValue=function(e){if(e){if(e.Path){return"{path:'"+e.Path+"'}"}else{return this.getPrimitiveValue(e)}}else{return""}};f.getPathOrPrimitiveValue=function(e,t){if(e){if(e.Path){return e.Path}else{return this.getPrimitiveValue(e,t)}}else{return""}};f.checkNumberFormat=function(e,t,r,a){var n=e;if(t&&t.DataPoint){var i=a?t.DataPoint.$AnnotationPath:t.DataPoint.AnnotationPath.substring(1),o=r[i],s,u;if(o&&o.ValueFormat){s=o.ValueFormat}else if(o&&o.NumberFormat){s=o.NumberFormat}var l=s&&s.NumberOfFractionalDigits;if(l){u=a?l:l.Int;if(n<Number(u)){n=Number(u)}}}return n};f.getMaxScaleFactor=function(e,t,r,a){var n=e;if(t&&t.DataPoint){var i=a?t.DataPoint.$AnnotationPath:t.DataPoint.AnnotationPath;var o=r[i];var s,u;if(o&&o.ValueFormat){s=o.ValueFormat}else if(o&&o.NumberFormat){s=o.NumberFormat}if(s){if(s.ScaleFactor&&s.ScaleFactor.Decimal){u=Number(s.ScaleFactor.Decimal)}else if(s.ScaleFactor&&s.ScaleFactor.Int){u=Number(s.ScaleFactor.Int)}if(!isNaN(u)){if(n===undefined){n=Number(u)}else if(n>Number(u)){n=Number(u)}}}}return n};f.isMeasureCurrency=function(e,t){return e&&e[t]&&(e[t]["Org.OData.Measures.V1.ISOCurrency"]||e[t][m.SEMANTICS_KEY]&&e[t][m.SEMANTICS_KEY]===m.CURRENCY_CODE)};f.getMaxItems=function(e,t){var r=e.getModel("ovpCardProperties"),a=r.getProperty("/entityType"),n=r.getProperty("/presentationAnnotationPath"),i=a.hasOwnProperty(n)&&a[n],o=i&&i.MaxItems;var s;if(t&&(typeof o==="number"||typeof o==="string"&&!isNaN(o))){s=parseInt(o,10)}else if(o&&!t){s=o.Int32?o.Int32:o.Int}return{itemsLength:+s,dataStep:+r.getProperty("/dataStep")}};f.resolvei18nKeyToChartTitle=function(e,t){var r=e.getModel("@i18n")?e.getModel("@i18n"):e.getModel("i18n");var a=t||"";if(a.match(/{[@]?i18n>.+}/gi)||a.match(/{[@]?i18n&gt;.+}/gi)){var n=r.getResourceBundle();var i=a.indexOf(">")>-1?a.indexOf(">"):a.indexOf("&gt;")+3;var o=a.substring(i+1,a.length-1);a=n.getText(o)}return a};return f},true);
//# sourceMappingURL=Utils.js.map