/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ovp/cards/generic/Card.controller","sap/ovp/cards/charts/VizAnnotationManager","sap/ovp/cards/v4/charts/VizAnnotationManager","sap/viz/ui5/data/FlattenedDataset","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/app/resources","sap/base/util/each","sap/ovp/app/OVPLogger","sap/ui/core/Fragment","sap/ovp/insights/IntegrationCard","sap/ui/Device","sap/ui/dom/units/Rem","sap/m/MessageBox","sap/ovp/cards/CommonUtils","sap/ovp/cards/charts/OVPChartFormatter","sap/ovp/cards/generic/base/analytical/Utils"],function(t,e,a,i,r,s,o,n,d,h,l,p,u,g,c,v){"use strict";var y=new n("sap.ovp.cards.generic.base.analytical.BaseAnalyticalChart");return t.extend("sap.ovp.cards.generic.base.analytical.BaseAnalyticalChart",{onInit:function(){t.prototype.onInit.apply(this,arguments);c.registerCustomFormatters();this.iPreviousRowSpan=0;this.iRowSpan=0;this.bResized=false;this.bdataLoadedToEnableAddToInsight=false},onBeforeRendering:function(){if(this.bCardProcessed){return}var t=g.isODataV4(this.getModel());v.validateCardConfiguration(this,t);var r=this.getView().byId("analyticalChart");var s=this.getOwnerComponent().getComponentData();if(r){r.setHeight("21rem")}if(this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"&&s&&s.appComponent){var o=s.appComponent.getDashboardLayoutUtil();var n=o.dashboardLayoutModel.getCardById(s.cardId);if(n.dashboardLayout.autoSpan&&r){r.setHeight("21rem")}}var h=this.getView().byId("vbLayout");var l;var p=false;var u=new i({data:{path:"/"}});this.isVizPropSet=p;this.oDataSet=u;this.vizFrame=r;this.vbLayout=h;if(!r){y.error(e.constants.ERROR_NO_CHART+": ("+this.getView().getId()+")")}else{this.vbLayout.setBusy(true);l=r.getModel("ovpCardProperties").getProperty("/navigation");if(l===undefined||l=="datapointNav"||l!="headerNav"){if(t){a.getSelectedDataPoint(r,this)}else{e.getSelectedDataPoint(r,this)}}r.destroyDataset();var c=r.getParent().getBinding("data");this._handleKPIHeader();if(c&&c.getPath()){c.attachDataReceived(this.onDataReceived.bind(this));c.attachDataRequested(this.onDataRequested.bind(this))}else{d.load("sap.ovp.cards.charts.generic.noData").then(function(t){var e=this.getCardContentContainer();e.removeAllItems();e.addItem(t)}.bind(this))}r.addEventDelegate({onmouseover:function(){var t=r._oOvpVizFrameTooltip;if(t){t._oPopup.close()}}})}this.bCardProcessed=true},onAfterRendering:function(){t.prototype.onAfterRendering.apply(this,arguments);var e=this.iRowSpan;if(!r.checkIfAPIIsUsed(this)&&this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"){var a=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var i=this.oDashboardLayoutUtil.getCardDomId(this.cardId);if(!this.bResized){a.dashboardLayout.rowSpan=Math.max(a.dashboardLayout.rowSpan,e);this.iRowSpan=a.dashboardLayout.rowSpan}var s=document.getElementById(i);var o=this.getHeaderHeight();if(!a.dashboardLayout.autoSpan){if(s){var n=s.getElementsByClassName("sapOvpWrapper")[0];if(n){n.style.height=a.dashboardLayout.rowSpan*this.oDashboardLayoutUtil.ROW_HEIGHT_PX+2-(o+2*this.oDashboardLayoutUtil.CARD_BORDER_PX)+"px"}}}if(a.dashboardLayout.showOnlyHeader){s.classList.add("sapOvpMinHeightContainer")}var d=this.getView().byId("analyticalChart");if(d){d.setHeight(this._calculateVizFrameHeight()+"px");this._calculateWidth();d.attachBrowserEvent("click",this.updateControlPressed.bind(this))}}},onDataRequested:function(){this.vbLayout.setBusy(true)},getCardItemsBinding:function(){var t=this.getView().byId("analyticalChart");if(t&&t.getParent()){return t.getParent().getBinding("data")}return null},resizeCard:function(t){var i=this.getCardPropertiesModel();this.newCardLayout=t;i.setProperty("/cardLayout/rowSpan",t.rowSpan);i.setProperty("/cardLayout/colSpan",t.colSpan);var r=this.getCardPropertiesModel().getProperty("/cardLayout");var n=this.getHeaderHeight();var d=this.getView().getDomRef().querySelectorAll(".sapOvpWrapper");for(var h=0;h<d.length;h++){d[h].style.height=t.rowSpan*r.iRowHeightPx+2-(n+2*r.iCardBorderPx)+"px"}var l=this.getView().byId("analyticalChart");var p=this.getView().byId("bubbleText");if(l){if(l.getVizType()==="timeseries_bubble"||l.getVizType()==="bubble"){if(r.colSpan>1){p.setVisible(false)}else{p.setVisible(true)}}l.setHeight(this._calculateVizFrameHeight()+"px");this._calculateWidth()}var u=this.getView().byId("ovpCardContentContainer").getDomRef();if(u){if(!t.showOnlyHeader){u.classList.remove("sapOvpContentHidden")}else{u.classList.add("sapOvpContentHidden")}}var c=s.getText("BUBBLESIZE");this.oDataSet.bindData("analyticalmodel>/","");this.vizFrame.setDataset(this.oDataSet);var v=l.getParent();var y=g.isODataV4(this.getModel());if(!this.isVizPropSet){if(y){a.buildVizAttributes(l,v,this)}else{e.buildVizAttributes(l,v,this)}this.isVizPropSet=true;if(p!=undefined){var b=l.getFeeds();o(b,function(t,e){if(b[t].getUid()=="bubbleWidth"){p.setText(c+" "+b[t].getValues())}})}e.hideDateTimeAxis(l)}e.reprioritizeContent(this.newCardLayout,l,y);this.bResized=true},_calculateVizFrameHeight:function(){var t;if(this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"){var e=this.getView().byId("analyticalChart");var a=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var i=this.getView().getController();var r=this.getItemHeight(i,"toolbar");var s=this.getHeaderHeight();var o=(e.getVizType()==="timeseries_bubble"||e.getVizType()==="bubble")&&a.dashboardLayout.colSpan===1?43:0;var n=l.system.phone&&this.iPreviousRowSpan>0?this.iPreviousRowSpan:a.dashboardLayout.rowSpan;t=n*this.oDashboardLayoutUtil.ROW_HEIGHT_PX+2-(s+2*this.oDashboardLayoutUtil.CARD_BORDER_PX+r+o+14);var d=e.sId;var h=this._calculateVizLegendGroupHeight(t);var u=this.getView().byId(d);if(u){u.setVizProperties(h)}}else{t=p.toPx(21)}return t},_calculateVizLegendGroupHeight:function(t){var e;if(t<=270){e=.1}else{var a=240;e=(t-a)/t}var i={legendGroup:{layout:{height:e}}};return i},_calculateWidth:function(){var t=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var e=this.getView().byId("analyticalChart");if(t){var a=parseInt(t.dashboardLayout.width,10);var i=e.getVizType();var r=e.sId;if(i==="donut"){var s=this._calculateVizLegendGroupWidth(a);var o=this.getView().byId(r);if(o){o.setVizProperties(s)}}}},_calculateVizLegendGroupWidth:function(t){var e;if(t<=600){e=.25}else if(t<=900){e=.55}else if(t>=1200){e=.7}else{e=.65}var a={legendGroup:{layout:{maxWidth:e}}};return a},refreshCard:function(){this.getView().invalidate()},onShowInsightCardPreview:function(){var t=this.getView();var e=t.getController();var a=e.oCardComponentData;var i=this;if(this.checkIBNNavigationExistsForCard()){h.showCard({vizFrame:e.vizFrame,entitySet:e.entitySet,entityType:e.entityType,cardComponentName:"Analytical",cardComponentData:a,cardComponent:e.oCardComponent,view:t}).then(function(t){i.saveGeneratedCardManifest(t)})}else{u.error(s.getText("INT_IBN_NAVIGATION_NOT_FOUND_ERROR_MESSAGE_TEXT"),{details:s.getText("INT_IBN_NAVIGATION_NOT_FOUND_ERROR_MESSAGE_VIEW_DETAILS_TEXT")})}}})});
//# sourceMappingURL=BaseAnalyticalChart.controller.js.map