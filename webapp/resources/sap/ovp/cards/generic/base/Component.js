/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ui/core/UIComponent","sap/ui/model/json/JSONModel","sap/ovp/cards/CommonUtils","sap/ui/Device","sap/ui/model/resource/ResourceModel","sap/ui/core/mvc/ViewType","sap/base/util/merge","sap/ovp/app/OVPUtils","sap/ovp/app/OVPLogger","sap/ui/base/Object","sap/ui/core/Component","sap/ui/core/Lib","sap/ui/core/mvc/View"],function(e,t,a,n,i,o,r,s,l,p,d,c,u){"use strict";var v=new l("OVP.generic.base.Component");return e.extend("sap.ovp.cards.generic.base.Component",{metadata:{properties:{contentFragment:{type:"string"},controllerName:{type:"string",defaultValue:"sap.ovp.cards.generic.Card"},headerExtensionFragment:{type:"string"},contentPosition:{type:"string",defaultValue:"Middle"},headerFragment:{type:"string",defaultValue:"sap.ovp.cards.generic.Header"},footerFragment:{type:"string"},identificationAnnotationPath:{type:"string",defaultValue:"com.sap.vocabularies.UI.v1.Identification"},selectionAnnotationPath:{type:"string"},filters:{type:"object"},parameters:{type:"object"},addODataSelect:{type:"boolean",defaultValue:false},enableAddToInsights:{type:"boolean",defaultValue:false}},version:"1.141.0",library:"sap.ovp",includes:[],dependencies:{libs:[],components:[]},config:{},interfaces:["sap.ui.core.IAsyncContentCreation"]},setSelectionVariant:function(e,t){if(/^@/.test(e)){e=e.slice(1)}t.selectionAnnotationPath=e},getCustomizing:function(e){return d.getCustomizing(this,{type:e})},setPresentationVariant:function(e,t,a,n){if(/^@/.test(e)&&!n){e=e.slice(1)}t.presentationAnnotationPath=e;var i=e.split("/");var o=i.length===1?a[e].Visualizations:a[i[0]][i[1]][i[2]].Visualizations;var r;for(r=0;r<o.length;r++){var s=n?o[r].$AnnotationPath:o[r].AnnotationPath;if(s){if(/^@/.test(s)){s=s.slice(1)}if(/.LineItem/.test(s)){t.annotationPath=s;break}}}for(r=0;r<o.length;r++){var s=n?o[r].$AnnotationPath:o[r].AnnotationPath;if(s){if(/^@/.test(s)){s=s.slice(1)}if(/.Chart/.test(s)){t.chartAnnotationPath=s;break}}}},setDataPointAnnotationPath:function(e,t){if(/^@/.test(e)){e=e.slice(1)}t.dataPointAnnotationPath=e},getCustomPreprocessor:function(){},getPreprocessors:function(e){var i=this.getComponentData(),o=i.settings,l=i.model,p,d,c,u,v;if(o.description&&!o.subTitle){o.subTitle=o.description}var f=a.isODataV4(l);if(l&&f){p=l&&l.getMetaModel();var h="/"+o.entitySet;var d=p.getObject(h);v=p.createBindingContext(h);if(d&&d["$Type"]){c=p.createBindingContext("/"+d["$Type"]);var g="/"+d["$Type"]+"/@";u=p.getObject(g)}}else if(l&&o.entitySet){p=l&&l.getMetaModel();var m=p.getODataEntitySet(o.entitySet);var y=p.getODataEntitySet(o.entitySet,true);d=p.getODataEntityType(m.entityType);v=p.createBindingContext(y);c=p.createBindingContext(d.$path)}var C=this._getCardPropertyDefaults();var b=this._completeLayoutDefaults(C,o);var P,D;if(i.appComponent&&i.appComponent.getModel("ui")&&i.appComponent.getModel("ui").oData){var A=i.appComponent.getModel("ui").oData;P=A.showDateInRelativeFormat;D=A.disableTableCardFlexibility}else{if(i.showDateInRelativeFormat){P=i.showDateInRelativeFormat}if(i.disableTableCardFlexibility){D=i.disableTableCardFlexibility}}if(i.ovpCardsAsApi&&i.parentView&&typeof i.parentView.getViewName==="function"&&i.parentView.getViewName()!=="sap.ovp.cards.rta.SettingsDialog"){i.settings.enableAddToInsights=false}var I=i&&i.appComponent&&i.appComponent.ovpConfig||{};var T=true;if(i.ovpCardsAsApi){T=false}var V=I.bInsightDTEnabled||I.bInsightRTEnabled||false;if(I.isTeamsModeActive){V=false}var M={metaModel:p,entityType:d,webkitSupport:n.browser.webkit,layoutDetail:b&&b.cardLayout?b.cardLayout.containerLayout:"fixed",bInsightDTEnabled:I.bInsightDTEnabled||false,bInsightRTEnabled:I.bInsightRTEnabled||false,bInsightEnabled:V,showDateInRelativeFormat:P,disableTableCardFlexibility:D,cardId:i.cardId,enableAdditionalActionsManageCards:T};var S=null;var O={v2:["sap.ovp.cards.charts.analytical","sap.ovp.cards.table","sap.ovp.cards.list"],v4:["sap.ovp.cards.v4.charts.analytical","sap.ovp.cards.v4.table","sap.ovp.cards.v4.list"]};if(!!i&&!!i.cardId){var L=i.mainComponent;if(!!L){S=L._getCardFromManifest(i.cardId)?L._getCardFromManifest(i.cardId).template:null}else{S=i.template}if(!!S){M.template=S}if(M.template==="sap.ovp.cards.charts.analytical"){M.enableOVPCardAsAPI=i.ovpCardsAsApi||false}if(I.enableV4Insight&&O.v4.includes(S)){i.settings.enableAddToInsights=true}}C.densityStyle=a._setCardpropertyDensityAttribute();if(i.errorReason){var w=i.errorReason;var x=w.getParameters?w.getParameters():w.mParameters;var R="sap-icon://message-error";var F="sapIllus-UnableToLoad";if(x&&x.response){C.errorStatusCode=x.response.statusCode;if(x.response.sTitle){C.sTitle=x.response.sTitle;C.sIllustration=x.response.sIllustration?x.response.sIllustration:F;C.sDescription=x.response.sDescription}else if(x.response.statusText){C.errorStatusText=x.response.statusText;C.sMessageIcon=x.response.sIcon?x.response.sIcon:R}C.responseText=x.response.responseText}var k=function(e){return O.v2.indexOf(e)!==-1||O.v4.indexOf(e)!==-1};if(i.settings.enableAddToInsights!==false&&k(i.settings.oldTemplate)){C.enableAddToInsights=true}}if(b){M.cardLayout=b.cardLayout}if(C.state!=="Error"){if(o&&o.kpiAnnotationPath){var B=d&&d[o.kpiAnnotationPath];var _=C.contentFragment;if(B&&["sap.ovp.cards.charts.analytical.analyticalChart","sap.ovp.cards.v4.charts.analytical.analyticalChart","sap.ovp.cards.charts.smart.analyticalChart"].includes(_)){var E=B.SelectionVariant&&B.SelectionVariant.Path?B.SelectionVariant.Path:o.kpiAnnotationPath+"/SelectionVariant";if(E){this.setSelectionVariant(E,o)}var j=B.Detail&&B.Detail.DefaultPresentationVariant&&B.Detail.DefaultPresentationVariant.Path?B.Detail.DefaultPresentationVariant.Path:o.kpiAnnotationPath+"/Detail/DefaultPresentationVariant";if(j){this.setPresentationVariant(j,o,d,f)}var N=B.DataPoint&&B.DataPoint.Path?B.DataPoint.Path:o.kpiAnnotationPath+"/DataPoint";if(N){this.setDataPointAnnotationPath(N,o)}}}else if(o&&o.selectionPresentationAnnotationPath){var U=f?"@"+o.selectionPresentationAnnotationPath:o.selectionPresentationAnnotationPath;var $=f?u[U]:d[U];if($){var E=$.SelectionVariant&&(f?$.SelectionVariant.$Path:$.SelectionVariant.Path);if(E){this.setSelectionVariant(E,o)}var j=$.PresentationVariant&&(f?$.PresentationVariant.$Path:$.PresentationVariant.Path);if(j){var H=f?u:d;this.setPresentationVariant(j,o,H,f)}}}}if(i.ovpCardsAsApi&&o.ignoreSelectionVariant){o.selectionAnnotationPath="";var z=[];for(var K=0;!!o.filters&&K<o.filters.length;K++){z.push({id:"headerFilterText--"+(K+1),index:K})}o.idForExternalFilters=z}if(!!M.entityType&&!!o.selectionAnnotationPath&&!!M.entityType[o.selectionAnnotationPath]){var X=M.entityType[o.selectionAnnotationPath].SelectOptions;for(var q=0;!!X&&q<X.length;q++){X[q].id="headerFilterText--"+(q+1)}M.entityType[o.selectionAnnotationPath].SelectOptions=X}if((M.template==="sap.ovp.cards.linklist"||M.template==="sap.ovp.cards.v4.linklist")&&!!o.staticContent){for(var G=0;G<o.staticContent.length;G++){o.staticContent[G].id="linkListItem--"+(G+1)}if(o.staticContent){C.showRefresh=false}}else if(M.template==="sap.ovp.cards.charts.analytical"||M.template==="sap.ovp.cards.v4.charts.analytical"){o.dataStep=o.dataStep?o.dataStep:10}C=s.merge(true,{},M,C,o);var J=new t(C);var Q={xml:{bindingContexts:{entityType:c,entitySet:v},models:{device:a.deviceModel,entityType:p,entitySet:p,ovpMeta:p,ovpCardProperties:J,ovplibResourceBundle:e,ovpConstants:a.ovpConstantModel},ovpCardProperties:J,dataModel:l,_ovpCache:{}}};return r({},this.getCustomPreprocessor(),Q)},_completeLayoutDefaults:function(e,t){var a={},n=this.getComponentData(),i=null,o=null;if(n.appComponent){i=n.appComponent.getOvpConfig()}if(!i){return null}if(i.containerLayout==="resizable"&&n.cardId&&e.contentFragment!=="sap.ovp.cards.quickview.Quickview"){o=n.appComponent.getDashboardLayoutUtil();var r=n.cardId;var s=o.aCards.filter(function(e){return e.id===r});a.cardLayout=s[0].dashboardLayout;a.cardLayout.containerLayout=i.containerLayout;a.cardLayout.iRowHeightPx=o.ROW_HEIGHT_PX;a.cardLayout.iCardBorderPx=o.CARD_BORDER_PX;a.cardLayout.headerHeight=s[0].dashboardLayout.headerHeight}return a},_getCardPropertyDefaults:function(){var e={};var t=this.getMetadata().getAllProperties();var a;for(var n in t){a=t[n];if(a.defaultValue!==undefined){e[a.name]=a.defaultValue}}return e},getOvplibResourceBundle:function(){if(!this.ovplibResourceBundle){var e=c.getResourceBundleFor("sap.ovp");this.ovplibResourceBundle=e?new i({bundleUrl:e.oUrlInfo.url}):null}return this.ovplibResourceBundle},_getCacheKeys:function(){var e=this.getComponentData&&this.getComponentData();if(e.ovpCardsAsApi){return}if(e.appComponent&&!p.isObjectA(e.appComponent,"sap.ui.base.ManagedObject")){return}var t=e&&e.settings&&e.settings.isObjectStream;if(t){return}var a=e&&e.model;if(a){var n=[];if(a.metadataLoaded&&typeof a.metadataLoaded==="function"){var i=a.metadataLoaded().then(function(e){var t;if(e&&e.lastModified){t=new Date(e.lastModified).getTime()+""}else{v.error("No valid cache key segment last modification date provided by the OData Model");t=(new Date).getTime()+""}return t});n.push(i)}if(a.annotationsLoaded&&typeof a.metadataLoaded==="function"){var o=a.annotationsLoaded().then(function(e){var t=0;if(e){for(var a=0;a<e.length;a++){if(e[a].lastModified){var n=new Date(e[a].lastModified).getTime();if(n>t){t=n}}}}if(t===0){v.error("No valid cache key segment last modification date provided by OData annotations");t=(new Date).getTime()}return t+""});n.push(o)}return n}},combineBatch:function(e,t){var a=t&&t.mainComponent;var n=a&&a.oModelViewMap;var i=t&&t.modelName;if(e&&i){e.bIncludeInCurrentBatch=false;if(n&&i&&n[i]&&n[i][t.cardId]){delete n[i][t.cardId];if(Object.keys(n[i]).length>0){e.bIncludeInCurrentBatch=true}}}},createContent:function(){var e=this.getComponentData&&this.getComponentData();var t=e.model;var n;var i;if(e&&e.mainComponent){n=e.mainComponent._getOvplibResourceBundle()}else{n=this.getOvplibResourceBundle()}i=this.getPreprocessors(n);var r=this._getCardPropertyDefaults().state;var s=e.cardId+(r?r:"Original");if(!r){s=s+(e.settings.selectedKey?"_Tab"+e.settings.selectedKey:"")}if(e.appComponent&&typeof e.appComponent.createId==="function"){s=e.appComponent.createId(s)}var l={preprocessors:i,type:o.XML,viewName:a.isODataV4(t)?"sap.ovp.cards.v4.generic.Card":"sap.ovp.cards.generic.Card",async:true,id:s};var p=this._getCacheKeys();if(p&&p.length&&p.length>0){l.cache={keys:p}}var d=this;return u.create(l).then(function(a){var o=a&&a.getControllerName()==="sap.ovp.cards.stack.Stack";if(t&&t.bUseBatch&&!o){d.combineBatch(t,e)}t&&a.setModel(t);if(e.i18n){a.setModel(e.i18n,"@i18n")}a.setModel(i.xml.ovpCardProperties,"ovpCardProperties");a.setModel(n,"ovplibResourceBundle");return a})}})});
//# sourceMappingURL=Component.js.map