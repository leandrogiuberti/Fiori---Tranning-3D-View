/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ovp/cards/ActionUtils","sap/ovp/cards/CommonUtils","sap/ovp/cards/OVPCardAsAPIUtils","sap/ui/core/ResizeHandler","sap/ui/core/format/NumberFormat","sap/m/MessageBox","sap/fe/navigation/NavError","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/ui/thirdparty/jquery","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/ui/events/KeyCodes","sap/base/util/merge","sap/ovp/app/OVPLogger","sap/ovp/cards/jUtils","sap/base/util/isEmptyObject","sap/ui/util/openWindow","sap/ovp/placeholder/placeholderHelper","sap/ui/core/Component","sap/ui/core/Fragment","sap/ovp/app/NavigationHelper","sap/ovp/cards/NavigationHelper","sap/ovp/helpers/V4/MetadataAnalyzer","sap/ovp/insights/helpers/AnalyticalCard","sap/ovp/filter/FilterUtils","sap/ovp/handlers/IAppStateHandler","sap/ovp/insights/CardProvider","sap/ui/core/EventBus","sap/ui/core/Element"],function(t,e,a,i,n,r,o,s,d,l,p,jQuery,g,h,c,v,f,u,C,m,y,b,I,P,D,M,w,T,S,V,O,N){"use strict";var A=new f("ovp.generic.Card");return t.extend("sap.ovp.cards.generic.Card",{initKeyboardNavigation:function(){var t=function(t){this.init(t)};t.prototype.layoutItemFocusHandler=function(){var t=jQuery(document.activeElement);if(t){var e=t.find("[aria-label]");var a,i="";if(t.find(".valueStateText").length==1){var n=t.find(".valueStateText").find(".sapMObjectNumberText").text();var r=t.find(".valueStateText").find(".sapUiInvisibleText").text();t.find(".valueStateText").attr("aria-label",n+" "+r);t.find(".valueStateText").attr("aria-labelledby","")}t.find("[role='listitem']").attr("aria-label","");if(t.hasClass("sapOvpCardHeader")&&!t.hasClass("sapOvpStackCardContent")){var o="";var s=t.find(".cardHeaderType");if(s.length===0){var d=g.getText("CardHeaderType");o="cardHeaderType_"+(new Date).getTime();var l='<div id="'+o+'" class="cardHeaderType" aria-label="'+d+'" hidden></div>';t.append(l)}else{o=s[0].id}i+=o+" "}for(a=0;a<e.length;a++){if(e[a].getAttribute("role")==="heading"){i+=e[a].id+" "}}if(t.hasClass("sapOvpCardHeader")){var p=t.find(".cardHeaderText");if(p.length!==0){for(var a=0;a<p.length;a++){if(i.indexOf(p[a].id)===-1){i+=p[a].id+" "}}}}if(i.length){t.attr("aria-labelledby",i)}if(t.prop("nodeName")==="LI"&&t.find(".linkListHasPopover").length!==0){if(t.find("#hasDetails").length===0){t.append("<div id='hasDetails' hidden>"+g.getText("HAS_DETAILS")+"</div>");t.attr("aria-describedby","hasDetails")}}var h=t.attr("id");if(h&&h.indexOf("ovpTable")!=-1&&t.find("[role='Link']")&&!t.hasClass("sapUiCompSmartLink")){var c=t.closest("td").attr("data-sap-ui-column"),v=t.closest("tbody").siblings().children().filter("tr").children();for(var a=0;a<v.length;a++){if(v[a].getAttribute("data-sap-ui")==c&&v[a].hasChildNodes("span")){var f=v[a].firstElementChild.getAttribute("id");t.attr("aria-labelledby",f)}}}}};t.prototype.init=function(t){this.cardLayout=t;this.keyCodes=c;this.jqElement=jQuery(t.getView().$());this.jqElement=this.jqElement.parent().parent().parent();this.jqElement.on("focus.keyboardNavigation",this.layoutItemFocusHandler)};this.keyboardNavigation=new t(this)},onInit:function(){this.enableClick=true;this.oCardComponent=this.getOwnerComponent();this.oCardComponentData=this.oCardComponent&&this.oCardComponent.getComponentData();this.oMainComponent=this.oCardComponentData&&this.oCardComponentData.mainComponent;this.sCardId=this.oCardComponentData.cardId;var t=this.getView().mPreprocessors.xml[0].ovpCardProperties.oData;var e=t.state;var i=t.sIllustration==="sapIllus-NoEntries";var n=t.errorStatusText;if(e!=="Error"||i||n){var r=this.getView().byId("ovpCardHeader");if(!!r){r.attachBrowserEvent("click",this.onHeaderClick.bind(this));r.addEventDelegate({onkeydown:function(t){if(!t.shiftKey&&t.keyCode==13){t.preventDefault();this.onHeaderClick(t)}else if(!t.shiftKey&&t.keyCode==32){t.preventDefault()}}.bind(this)});r.addEventDelegate({onkeyup:function(t){if(!t.shiftKey&&t.keyCode==32){t.preventDefault();this.onHeaderClick(t)}}.bind(this)})}}var o=this.getView().byId("kpiNumberValue");if(o){o.addEventDelegate({onAfterRendering:function(){var t=o.$();var e=t.find(".sapMNCValueScr");var a=t.find(".sapMNCScale");e.attr("aria-label",e.text());a.attr("aria-label",a.text());var i=this.getView().byId("ovpCardHeader").getDomRef();var n=this.getOwnerComponent().getComponentData();if(!!n&&!!n.appComponent){var r=n.appComponent;if(!!r.getModel("ui")){var s=r.getModel("ui");if(!!s.getProperty("/containerLayout")&&s.getProperty("/containerLayout")==="resizable"){var d=n.appComponent.getDashboardLayoutUtil();if(!!d){d.setKpiNumericContentWidth(i)}}}}}.bind(this)})}var s;var d=this.oCardComponentData;var l=a.isODataV4(d.model);if(l){if(this.oMainComponent&&this.oMainComponent.oCards){s=this.oMainComponent.oCards.filter(function(t){return t.id===d.cardId})[0]}var p=s&&s.template;var g=p&&p.startsWith("sap.ovp.cards.v4");var h=p&&p.startsWith("sap.ovp.cards");if(g||!h){var c=this;this.eventhandler=function(t,e,a){if(p.startsWith("sap.ovp.cards.v4.charts")||!h&&s.settings.chartAnnotationPath){T.applyFiltersToV4AnalyticalCard(a,c)}else{T.applyFiltersToV4Card(a,c)}};this.GloabalEventBus=O.getInstance();if(this.oMainComponent&&(this.oMainComponent.isMacroFilterBar||this.oMainComponent.oGlobalFilter)){this.GloabalEventBus.subscribe("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",c.eventhandler)}}}},updateControlPressed:function(t){h.bCRTLPressed=t.ctrlKey||t.metaKey},exit:function(){if(this.resizeHandlerId){n.deregister(this.resizeHandlerId)}},onExit:function(){if(this.GloabalEventBus){var t=this;this.GloabalEventBus.unsubscribe("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",t.eventhandler)}},onAfterRendering:function(){var t=this.getView().byId("ovpCardHeader");var e=t&&t.getDomRef();var r=this.getView().byId("ovpHeaderTitle");var o=this.getView().byId("ovpQuickviewCardHeader");if(e&&!e.getAttribute("ariaLabelledBy")){if(r&&r.getText()){var s=r.getDomRef().getAttribute("id");e.setAttribute("arialabelledby",s)}else if(o&&o.getText()){var d=o.getDomRef().getAttribute("id");e.setAttribute("arialabelledby",d)}}var l=this.getCardPropertiesModel();this.updateTitleFromRTA(r,l);var p=l.getProperty("/contentFragment"),g=this.getOwnerComponent().getComponentData(),h=this.getCardItemsBinding();if(!h&&y.hidePlaceholderNeeded()){y.hidePlaceholder()}this._handleCountHeader();this._handleKPIHeader();var c=a.isODataV4(g&&g.model);var v=this.oMainComponent&&this.oMainComponent.aFilters;if(c&&v&&v.length>0){this.eventhandler("","",v)}var f=l.getProperty("/selectedKey");if(f&&l.getProperty("/state")!=="Loading"){var C=this.getView().byId("ovp_card_dropdown");if(C){C.setSelectedKey(f);var m=this.getView().getModel("ui");if(m&&m.getProperty("/bSelectionChanged")){var b=document.getElementById(C.sId);b&&b.focus();m.setProperty("/bSelectionChanged",false)}}}try{var g=this.getOwnerComponent().getComponentData();var I=g&&g.appComponent;if(I){if(I.getModel("ui")){var P=I.getModel("ui");if(P.getProperty("/containerLayout")==="resizable"){var M=I.getDashboardLayoutUtil();if(M){this.oDashboardLayoutUtil=M;this.cardId=g.cardId;if(M.isCardAutoSpan(g.cardId)){this.resizeHandlerId=n.register(this.getView(),function(t){A.info("DashboardLayout autoSize:"+t.target.id+" -> "+t.size.height);M.setAutoCardSpanHeight(t)})}}}}}}catch(t){A.error("DashboardLayout autoSpan check failed.")}if(this.oDashboardLayoutUtil&&this.oDashboardLayoutUtil.isCardAutoSpan(this.cardId)){var w=jQuery("#"+this.oDashboardLayoutUtil.getCardDomId(this.cardId));if(this.oView.$().outerHeight()>w.innerHeight()){this.oDashboardLayoutUtil.setAutoCardSpanHeight(null,this.cardId,this.oView.$().height())}}var T=false;var S=this.getModel();var V=this.getEntityType();if(g&&g.mainComponent){var O=g.mainComponent;if(O.bGlobalFilterLoaded){T=!D.checkHeaderNavigationDisabledForAnalyticalCard(l)&&D.checkNavigation(S,V,l)}}else if(i.checkIfAPIIsUsed(this)){T=this.checkAPINavigation()}var N=l.getProperty("/state");if(N!=="Loading"&&N!=="Error"){var E=l.getProperty("/template");if(E==="sap.ovp.cards.stack"){if(!T){var H=this.getView().byId("ViewAll");if(H){H=H.getDomRef();H&&H.parentNode.removeChild(H)}}}}if(p==="sap.ovp.cards.stack.Stack"){var k=this.getView().getDomRef();var F=k&&k.querySelector(".sapOvpCardContentContainer");if(F){F.style.borderTop="none"}}if(T){if(p?p!=="sap.ovp.cards.quickview.Quickview":true){if(p==="sap.ovp.cards.stack.Stack"){var k=this.getView().getDomRef();var x=k.querySelectorAll(".sapOvpCardContentRightHeader");if(x.length!==0){u.addClassToAllElements(x,"sapOvpCardNavigable")}}else{this.getView().addStyleClass("sapOvpCardNavigable")}}if(p&&p==="sap.ovp.cards.quickview.Quickview"){var L=this.byId("ovpCardHeader");if(L){L.addStyleClass("sapOvpCardNavigable")}}}else{if(p){this.getView().addStyleClass("ovpNonNavigableItem");var L=this.byId("ovpCardHeader");if(L){L.$().attr("role","heading");L.$().attr("aria-level","1");L.addStyleClass("ovpNonNavigableItem")}var R=D.checkLineItemNavigation(S,V,l);if(!R){switch(p){case"sap.ovp.cards.list.List":case"sap.ovp.cards.v4.list.List":var B=this.getView().byId("listItem");if(B){B.setType("Inactive")}break;case"sap.ovp.cards.table.Table":case"sap.ovp.cards.v4.table.Table":var B=this.getView().byId("tableItem");if(B){B.setType("Inactive")}break;case"sap.ovp.cards.linklist.LinkList":case"sap.ovp.cards.v4.linklist.LinkList":if(!D.checkNavigationForLinkedList(S,V)){var B=this.getView().byId("ovpCLI");if(B){B.setType("Inactive")}}break}}}}var U=this.getView().byId("ovp_card_dropdown");var _=this.getView().byId("ovp_card_dropdown_label");if(U){U.addAriaLabelledBy(_.getId())}if(i.checkIfAPIIsUsed(this)){this.initKeyboardNavigation()}if(this.getView()&&this.getView().byId("sapOvpCardAdditionalActions")){this.getView().byId("sapOvpCardAdditionalActions").setEnabled(true)}var K=this.getOwnerComponent().getComponentData(),j=K&&K.appComponent&&K.appComponent.ovpConfig&&K.appComponent.ovpConfig.bInsightRTEnabled;if(j){this.addInsightCardToCardProvider(K)}this.updateUIModelWithRenderedCards(K)},updateUIModelWithRenderedCards:function(t){if(t&&t.appComponent&&t.appComponent.getModel("ui")){var e=t.appComponent.getModel("ui"),a=e.getProperty("/visibleCardCount"),i=e.getProperty("/renderedOvpCards");if(i===a-1){var n=t.mainComponent;n.applyFiltersForCustomCards()}e.setProperty("/renderedOvpCards",++i)}},updateTitleFromRTA:function(t,e){var i=t&&t.getText();var n=e.getProperty("/cardId");var r=this.getOwnerComponent().getModel("ui");var o=r&&r.getProperty("/bRTAActive");if(!o){a.updateCardTitle(i,n)}},addInsightCardToCardProvider:function(t){if(t&&t.appComponent&&t.appComponent.getModel("ui")){var e=t.appComponent.getModel("ui"),a=e.getProperty("/visibleCardCount"),i=e.getProperty("/renderedCardCount"),n=this.getView().getModel("ovpCardProperties"),r=t.appComponent.getManifest()&&t.appComponent.getManifest()["sap.app"].id,o=t.appComponent.getManifestObject().getRawJson(),s=o&&o["sap.fiori"]&&o["sap.fiori"].registrationIds&&o["sap.fiori"].registrationIds[0]||r;V.addInsightCard(n,s);if(i===a-1){var d=t&&t.mainComponent;d.initializeCardProvider()}e.setProperty("/renderedCardCount",++i)}},checkAPINavigation:function(){var t=this.getOwnerComponent().getComponentData(),e=t.fnCheckNavigation&&typeof t.fnCheckNavigation==="function",a=e?t.fnCheckNavigation:null;if(a){if(a()){return true}}else{var i=this.getCardPropertiesModel();return!D.checkHeaderNavigationDisabledForAnalyticalCard(i)&&D.checkNavigation(this.getModel(),this.getEntityType(),i)}return false},onHeaderClick:function(t){var e=t&&t.target&&t.target.id;if(e&&e.indexOf("sapOvpCardAdditionalActions")>-1){return}var n=t.ctrlKey||t.metaKey?h.constants.explace:h.constants.inplace;if(i.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onHeaderClicked()}}else{var r=this.getCardPropertiesModel();var o=r.getProperty("/template");var s=r.getProperty("/targetUri");if((o=="sap.ovp.cards.linklist"||o=="sap.ovp.cards.v4.linklist")&&r.getProperty("/staticContent")!==undefined&&s){window.location.href=s}else if(r.getProperty("/staticContent")!==undefined&&s===""){return}else if(D.checkHeaderNavigationDisabledForAnalyticalCard(r)){return}else{this.doNavigation(this.getView().getBindingContext(),null,n)}}},resizeCard:function(t){A.info(t);if(this.resizeHandlerId){n.deregister(this.resizeHandlerId);this.resizeHandlerId=null}},_handleCountHeader:function(){var t=this.getView().byId("ovpCountHeader");if(t){var e=this.getCardItemsBinding();if(e){if(e.isLengthFinal()&&e.getLength()>0){this.setHeaderCounter(e,t)}e.attachDataReceived(function(a){if(y.hidePlaceholderNeeded()){y.hidePlaceholder()}this.setHeaderCounter(e,t,a)}.bind(this));e.attachChange(function(a){this.setHeaderCounter(e,t,a)}.bind(this))}}else{var e=this.getCardItemsBinding();if(e){e.attachDataReceived(function(){if(y.hidePlaceholderNeeded()){y.hidePlaceholder()}})}}},setHeaderCounter:function(t,e,a){var i;if(t.isLengthFinal()){i=t.getLength()}else{if(a&&a.getParameters().data&&a.getParameters().data.results){i=a.getParameters().data.results.length}}var n=t.getCurrentContexts().length;var o,s="";var d=r.getIntegerInstance({minFractionDigits:0,maxFractionDigits:1,decimalSeparator:".",style:"short"});n=parseFloat(n,10);var l=this.getOwnerComponent().getComponentData();if(l&&l.appComponent){var p=l.appComponent;if(p.getModel("ui")){var h=p.getModel("ui");if(h.getProperty("/containerLayout")!=="resizable"){if(i!==0){i=d.format(Number(i))}if(n!==0){n=d.format(Number(n))}}else{o=p.getDashboardLayoutUtil().dashboardLayoutModel.getCardById(l.cardId)}}}if(n===0||i===0){s=""}else if(o&&o.dashboardLayout.showOnlyHeader){s=g.getText("Count_Header_Total",[i])}else if(i!=n){s=g.getText("Count_Header",[n,i])}e.setText(s);e.addEventDelegate({onAfterRendering:function(){var t=e.$();t.attr("aria-label",s)}})},getKPIBinding:function(){var t=this.byId("kpiHBoxNumeric"),e=t&&t.getBindingInfo("items")&&t.getBindingInfo("items").binding;return e},getSubTitleBinding:function(){var t=this.getView().getDomRef();var e=t&&t.getElementsByClassName("sapOvpCardSubtitleContainer")[0];var a=e&&e.id;var i=N.getElementById(a);var n=i&&i.getBinding("items");return n},getCardItemsBinding:function(){},onActionPress:function(t){var e=t.getSource(),a=this._getActionObject(e),i=e.getBindingContext();if(a.type.indexOf("DataFieldForAction")!==-1){this.doAction(i,a)}else{this.doNavigation(i,a)}},_getActionObject:function(t){var e=t.getCustomData();var a={};for(var i=0;i<e.length;i++){a[e[i].getKey()]=e[i].getValue()}return a},doNavigation:function(t,e,a){if(!a){a=h.constants.inplace}if(!this.enableClick){return}this.enableClick=false;setTimeout(function(){this.enableClick=true}.bind(this),1e3);if(!this.oMainComponent){return}if(!e){e=D.getEntityNavigationEntries(t,this.getModel(),this.getEntityType(),this.getCardPropertiesModel())[0]}var i=v({},t);var n=v({},e);var r=this.oMainComponent.doCustomNavigation&&this.oMainComponent.doCustomNavigation(this.sCardId,i,n);var o=this.oMainComponent.templateBaseExtension&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation(this.sCardId,i,n);var s;if(r){s=r}if(o){s=o}if(s){var d=s.type;if(d&&typeof d==="string"&&d.length>0){d=d.split(".").pop().split("/").pop().toLowerCase();switch(d){case"datafieldwithurl":s.type="com.sap.vocabularies.UI.v1.DataFieldWithUrl";break;case"datafieldforintentbasednavigation":s.type="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation";break}e=s}}function l(a){if(!a){a=h.constants.inplace}if(e){switch(e.type){case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":this.doNavigationWithUrl(t,e,a);break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":this.doIntentBasedNavigation(t,e,false,a);break;case"com.sap.vocabularies.UI.v1.KPIDetailType":this.doIntentBasedNavigation(t,e,false,a);break}}}if(!S.oAppStatePromise){l.call(this,a)}else{S.oAppStatePromise.then(l.bind(this,a))}},doNavigationWithUrl:function(t,e,i){var n=a.getUshellContainer();if(!i){i=h.constants.inplace}if(!n){if(e&&e.url){m(e.url,"newWindow")}return}n.getServiceAsync("URLParsing").then(function(a){a.isIntentUrlAsync(e.url).then(function(n){if(!n){m(e.url,"newWindow")}else{var r=a.parseShellHash(e.url);var o=r.appSpecificRoute?true:false;this.doIntentBasedNavigation(t,r,o,i)}}.bind(this))}.bind(this))},fnHandleError:function(t){if(t instanceof s){if(t.getErrorCode()==="NavigationHandler.isIntentSupported.notSupported"){o.show(g.getText("OVP_NAV_ERROR_NOT_AUTHORIZED_DESC"),{title:g.getText("OVP_GENERIC_ERROR_TITLE")})}else{o.show(t.getErrorCode(),{title:g.getText("OVP_GENERIC_ERROR_TITLE")})}}},doCrossApplicationNavigation:function(t,e){var i="#"+t.semanticObject+"-"+t.action;var n=[];var r=a.getUshellContainer();if(t.params){var o=this.oCardComponent&&this.oCardComponent.getComponentData();var d=o&&o.appComponent;if(d){var l=d._formParamString(t.params);i=i+l;n.push({target:{shellHash:i}})}}var p=this;if(!r){return}r.getServiceAsync("Navigation").then(function(t){t.isNavigationSupported(n).then(function(a){var i=a[0];if(i&&i.supported){if(!!e.params){if(typeof e.params=="string"){try{e.params=JSON.parse(e.params)}catch(t){A.error("Could not parse the Navigation parameters");return}}}var n=p.getOwnerComponent().getComponentData();var r=n?n.globalFilter:undefined;var o=r&&r.getUiState({allFilters:false});var d=o?JSON.stringify(o.getSelectionVariant()):"{}";r=JSON.parse(d);var l=D.getFilterPreference(n);r=D.removeFilterFromGlobalFilters(l,r);if(!e.params){e.params={}}if(!!r&&!!r.SelectOptions){for(var g=0;g<r.SelectOptions.length;g++){var h=r.SelectOptions[g].Ranges;if(!!h){var c=[];for(var v=0;v<h.length;v++){if(h[v].Sign==="I"&&h[v].Option==="EQ"){c.push(h[v].Low)}}e.params[r.SelectOptions[g].PropertyName]=c}}}return t.navigate(e)}else{var f=new s("NavigationHandler.isIntentSupported.notSupported");p.fnHandleError(f)}}).then(function(){A.error("Could not get authorization from isIntentSupported")})})},doIntentBasedNavigation:function(t,e,i,n){if(!n){n=h.constants.inplace}var r=this.oCardComponent&&this.oCardComponent.getComponentData();if(r&&r.appComponent&&r.appComponent.ovpConfig&&r.appComponent.ovpConfig.isTeamsModeActive){n=h.constants.explace}var o=a.getUshellContainer();if(!o){return}var s,d,l=t?t.getObject():null;var p=this.getCardPropertiesModel(),g=p.getProperty("/customParams");if(t&&typeof t.getAllData==="function"&&g){d=t.getAllData()}else if(p.getProperty("/staticContent")){d={iStaticLinkListIndex:e.iStaticLinkListIndex,bStaticLinkListIndex:true}}if(l&&l.__metadata){delete l.__metadata}var c=a.getNavigationHandler();if(c){if(e){var r=this.getOwnerComponent().getComponentData();var v=this.getEntityType();var f=this.oMainComponent;var u=this.getModel();var C=r.mainComponent&&r.mainComponent.oMacroFilterBar;var m=this;if(C){D.getEntityNavigationParameters(f,u,r,p,v,l,d,t).then(function(t){m.handleNavigation(t,e,i,n,c)})}else{s=D.getEntityNavigationParameters(f,u,r,p,v,l,d,t);this.handleNavigation(s,e,i,n,c)}}}},handleNavigation:function(t,e,a,i,n){var r=this.fnHandleError;var o={target:{semanticObject:e.semanticObject,action:e.action},appSpecificRoute:e.appSpecificRoute,params:t.sNavSelectionVariant};var s={};if(t.sNavPresentationVariant){s.presentationVariant=t.sNavPresentationVariant}if(a){if(e&&e.semanticObject&&e.action){var d=this.getCardPropertiesModel().getProperty("/staticParameters");o.params=!!d?d:{};this.doCrossApplicationNavigation(e,o)}}else{n.navigate(o.target.semanticObject,o.target.action,o.params,null,r,s,i)}},doAction:function(t,a){this.actionData=e.getActionInfo(t,a,this.getEntityType());if(this.actionData.allParameters.length>0){this._loadParametersForm()}else{D.callFunction(this.actionData)}},getModel:function(){if(this.getView()){return this.getView().getModel()}},getMetaModel:function(){if(this.getModel()){return this.getModel().getMetaModel()}},getCardPropertiesModel:function(){if(!this.oCardPropertiesModel||C(this.oCardPropertiesModel)){this.oCardPropertiesModel=this.getView().getModel("ovpCardProperties")}return this.oCardPropertiesModel},getCardContentContainer:function(){if(!this.cardContentContainer){this.cardContentContainer=this.getView().byId("ovpCardContentContainer")}return this.cardContentContainer},_loadParametersForm:function(){var t=new d;t.setData(this.actionData.parameterData);var a=this;var i=new l("ovpCardActionDialog",{title:this.actionData.sFunctionLabel,afterClose:function(){i.destroy()}}).addStyleClass("sapUiNoContentPadding");var n=new p({text:this.actionData.sFunctionLabel,press:function(t){var n=e.getParameters(t.getSource().getModel(),a.actionData.oFunctionImport);i.close();D.callFunction(a.actionData,n)}});var r=new p({text:"Cancel",press:function(){i.close()}});i.setBeginButton(n);i.setEndButton(r);var o=function(t){var i=e.mandatoryParamsMissing(t.getSource().getModel(),a.actionData.oFunctionImport);n.setEnabled(!i)};var s=e.buildParametersForm(this.actionData,o);i.addContent(s);i.setModel(t);i.open()},setErrorState:function(){var t=this.getOwnerComponent();if(!t||!t.oContainer){return}var e=t.oContainer;var a=this.getCardPropertiesModel();var i={name:"sap.ovp.cards.loading",componentData:{model:this.getView().getModel(),settings:{category:a.getProperty("/category"),title:a.getProperty("/title"),description:a.getProperty("/description"),entitySet:a.getProperty("/entitySet"),state:h.loadingState.ERROR,template:a.getProperty("/template")}}};b.create(i).then(function(a){e.setComponent(a);setTimeout(function(){t.destroy()},0)})},changeSelection:function(t,e,a){if(!e){var n=this.getView().byId("ovp_card_dropdown");t=parseInt(n.getSelectedKey(),10);if(this.getView()){this.getView().getModel("ui").setProperty("/bSelectionChanged",true)}}var r={};if(!e){r=this.getCardPropertiesModel().getProperty("/tabs")[t-1]}else{r=a.tabs[t-1]}var o={cardId:this.getOwnerComponent().getComponentData().cardId,selectedKey:t};for(var s in r){o[s]=r[s]}if(i.checkIfAPIIsUsed(this)){i.recreateCard(o,this.getOwnerComponent().getComponentData())}else{this.getOwnerComponent().getComponentData().mainComponent.recreateCard(o);this.getOwnerComponent().getComponentData().mainComponent.setOrderedCardsSelectedKey(this.getOwnerComponent().getComponentData().cardId,t)}},getItemHeight:function(t,e,a){if(!!t){var i=t.getView().byId(e);var n=0;if(!!i){if(a){if(i.getItems()[0]&&i.getItems()[0].getDomRef()){n=u.getOuterHeight(i.getItems()[0].getDomRef())}}else{if(i.getDomRef()){n=u.getOuterHeight(i.getDomRef())}}}return n}},getEntitySet:function(){if(!this.entitySet){var t=this.getCardPropertiesModel().getProperty("/entitySet");if(a.isODataV4(this.getView().getModel())){this.entitySet=this.getMetaModel()&&this.getMetaModel().getObject("/"+t)}else{this.entitySet=this.getMetaModel().getODataEntitySet&&this.getMetaModel().getODataEntitySet(t)}}return this.entitySet},getEntityType:function(){if(!this.entityType){if(a.isODataV4(this.getView().getModel())){var t=this.getMetaModel();var e=this.getEntitySet();if(t&&e){var i=t.getData().$Annotations[e.$Type];var n={property:t.getObject("/"+e.$Type+"/")};this.entityType=h.merge(true,{},i,n)}}else{if(this.getMetaModel()&&this.getEntitySet()){this.entityType=this.getMetaModel().getODataEntityType(this.getEntitySet().entityType)}}}return this.entityType},_handleKPIHeader:function(){if(a.isODataV4(this.getView().getModel())){this._handleKPIHeaderForODataV4()}else{this._handleKPIHeaderForODataV2()}},_handleKPIHeaderForODataV2:function(){var t,e;if(this.getView()&&this.getView().getDomRef()){t=this.getView().getDomRef().getElementsByClassName("numericContentHbox");e=this.getView().getDomRef().getElementsByClassName("noDataSubtitle")}else{return}if(t||e){var a=this.getKPIBinding();if(a){a.attachDataReceived(function(i){var n=i.getParameter("data")&&i.getParameter("data").results&&i.getParameter("data").results[0];var r=a.getLength();if(t[0]){t[0].style.visibility=null;if(r===0){this._setSubTitleWithUnitOfMeasureForODataV2(n,false);t[0].style.visibility="hidden"}else{this._setSubTitleWithUnitOfMeasureForODataV2(n,true);t[0].style.visibility="visible"}}if(e.length!==0){e[0].style.display="none";if(r===0){e[0].style.display="flex"}}}.bind(this))}}},_handleKPIHeaderForODataV4:function(){var t,e;if(this.getView()&&this.getView().getDomRef()){t=this.getView().getDomRef().getElementsByClassName("numericContentHbox");e=this.getView().getDomRef().getElementsByClassName("noDataSubtitle")}else{return}if(t||e){var a=this.getKPIBinding();if(a){a.attachDataReceived(function(i){var n=i.getSource().getCurrentContexts().map(function(t){return t&&t.getObject()})[0];var r=a.getLength();if(t[0]){t[0].style.visibility=null;if(r===0){t[0].style.visibility="hidden"}else{this._setSubTitleWithUnitOfMeasureForODataV4(n);t[0].style.visibility="visible"}}if(e.length!==0){e[0].style.display="none";if(r===0){e[0].style.display="flex"}}}.bind(this))}}},_setSubTitleWithUnitOfMeasureForODataV2:function(t,e){var i=this.getCardPropertiesModel();if(!!i){var n=i.getData();var r=this.getView().byId("SubTitle-Text");var o="";if(!!r){r.setText(n.subTitle);if(!!n&&!!n.entityType&&!!n.dataPointAnnotationPath&&e){var s=i.getData().entityType;var d=n.dataPointAnnotationPath.split("/");var l=d.length===1?s[n.dataPointAnnotationPath]:s[d[0]][d[1]];var p;if(l&&l.Value&&l.Value.Path){p=l.Value.Path}else if(l&&l.Description&&l.Description.Value&&l.Description.Value.Path){p=l.Description.Value.Path}if(!!p){var h=a.getUnitColumn(p,s);var c;if(!!h&&!!t){o=h;c=t[h]}else{c=a.getUnitColumn(p,s,true);o=c}if(i.getProperty("/bInsightEnabled")){w.setUoMForSubTitle(i.getData().cardId,o)}var v=g.getText("SubTitle_IN");if(!!n.subTitle&&!!v&&!!c){r.setText(n.subTitle+" "+v+" "+c);var f=r.getAggregation("customData");if(f){var u;for(u in f){var C=f[u];if(C.getKey()==="aria-label"){C.setValue(n.subTitle+" "+v+" "+c);break}}}}}}}}},_setSubTitleWithUnitOfMeasureForODataV4:function(t){var e=this.getCardPropertiesModel();if(!!e){var i=e.getData();var n=this.getView().byId("SubTitle-Text");var r="";if(!!n){n.setText(i.subTitle);if(!!i&&!!i.entityType&&!!i.dataPointAnnotationPath){var o=this.getEntityType();var s=i.dataPointAnnotationPath.split("/");var d=s.length===1?o["@"+i.dataPointAnnotationPath]:o["@"+s[0]]["@"+s[1]];var l;if(d&&d.Value&&d.Value.$Path){l=d.Value.$Path}else if(d&&d.Description&&d.Description.Value&&d.Description.Value.$Path){l=d.Description.Value.$Path}var p=this.getMetaModel();var h=this.getEntitySet();var c=M.getEntitySetName(p,h.$Type);if(!!l){var v=a.getUnitColumnForODataV4(l,p,c);var f;if(!!v&&!!t){r=v;f=t[v]}else{f=a.getUnitColumnForODataV4(l,p,c,true);r=f}if(e.getProperty("/bInsightEnabled")){w.setUoMForSubTitle(e.getData().cardId,r)}var u=g.getText("SubTitle_IN");if(!!i.subTitle&&!!u&&!!f){n.setText(i.subTitle+" "+u+" "+f);var C=n.getAggregation("customData");if(C){var m;for(m in C){var y=C[m];if(y.getKey()==="aria-label"){y.setValue(i.subTitle+" "+u+" "+f);break}}}}}}}}},getHeaderHeight:function(){var t=this.getItemHeight(this,"ovpCardHeader"),e=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;if(e&&e.appComponent){var a=e.appComponent.getDashboardLayoutUtil(),i=a.getDashboardLayoutModel().getCardById(e.cardId);if(t!==0){i.dashboardLayout.headerHeight=t}}return t},onShowInsightCardPreview:function(){},onShowAdditionalCardActions:function(t){var e=t.getSource();t.cancelBubble();if(!this.additionalCardActionsMenu){this.additionalCardActionsMenu=I.load({id:this.getView().getId(),name:"sap.ovp.cards.generic.HeaderActions",controller:this}).then(function(t){this.getView().addDependent(t);return t}.bind(this))}var a=this;this.additionalCardActionsMenu.then(function(t){var i=a.getView(),n=i.byId("ovpAddToInsightButton"),r=n&&n.getEnabled();if(!r&&a.bdataLoadedToEnableAddToInsight){n.setEnabled(true)}t.openBy(e)})},checkIBNNavigationExistsForCard:function(){var t=this.getCardPropertiesModel(),e=this.getEntityType(),a=t.getProperty("/contentFragment"),i=this.getView().getModel();if(t&&e&&a){var n=["sap.ovp.cards.list.List","sap.ovp.cards.v4.list.List","sap.ovp.cards.table.Table","sap.ovp.cards.v4.table.Table"];if(n.includes(a)){var r=P.checkIdentificationAnnotationNavigation(t,e,i),o=P.checkLineItemNavigation(t,e,i);return r||o}if(a==="sap.ovp.cards.charts.analytical.analyticalChart"||a==="sap.ovp.cards.v4.charts.analytical.analyticalChart"){var s=D.checkHeaderNavigationDisabledForAnalyticalCard(t),d=P.checkIdentificationAnnotationNavigation(t,e,i),l=P.checkKPIAnnotationNavigation(t,e),p=s&&d;return p||d||l}}return false},saveGeneratedCardManifest:function(t){var e=this.oCardComponentData.cardId,a=this.oCardComponentData.settings.selectedKey,i=this.getView(),n=i.getModel("ovpCardProperties"),r=n&&n.getProperty("/bInsightDTEnabled");if(r){var o=a?e+"/tab_"+a:e;jQuery.ajax({type:"POST",url:"/editor/card/"+o+"/manifest",headers:{"Content-Type":"application/json"},data:JSON.stringify(t),success:function(t){A.info("Success:",t)},error:function(t){A.error("Error:",t)}})}},refreshCardContent:function(){var t=this.getCardPropertiesModel();if(t){var e=t.getProperty("/template");var a=e==="sap.ovp.cards.error"||e==="sap.ovp.cards.v4.error";var i=e&&!e.startsWith("sap.ovp.cards");if(i||a){if(typeof this.onRefresh==="function"){if(a){var n=t.getProperty("/cardId");n&&this.onRefresh(n)}else{this.onRefresh()}}return}}if(this.getKPIBinding()){this.getKPIBinding().refresh()}if(this.getCardItemsBinding()){this.getCardItemsBinding().refresh()}},onCardManage:function(){this.oMainComponent.oManageCardsUtils.onManageCardsMenuButtonPress()}})});
//# sourceMappingURL=Card.controller.js.map