/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/FilterOperator","sap/ui/model/odata/ODataUtils","sap/ovp/cards/generic/Component","sap/ovp/cards/v4/generic/Component","sap/fe/navigation/NavigationHandler","sap/ovp/cards/CommonUtils","sap/ovp/cards/PersonalizationUtils","sap/ui/model/Filter","sap/fe/navigation/SelectionVariant","sap/ui/comp/state/UIState","sap/ui/Device","sap/ovp/ui/SmartphoneHeaderToggle","sap/ui/model/odata/v2/ODataModel","sap/ui/model/odata/ODataMetadata","sap/ui/model/analytics/odata4analytics","sap/ovp/support/lib/CommonMethods","sap/ovp/app/resources","sap/ovp/app/TemplateBaseExtension","sap/ui/core/mvc/ControllerExtension","sap/ovp/app/OVPUtils","sap/ovp/app/ShareUtils","sap/base/security/encodeURL","sap/ui/thirdparty/jquery","sap/base/util/merge","sap/ui/fl/apply/api/FlexRuntimeInfoAPI","sap/ui/core/CustomData","sap/ovp/app/OVPLogger","sap/base/util/isEmptyObject","sap/ovp/cards/semanticDateRangeTypeHelper","sap/ovp/placeholder/placeholderHelper","sap/ui/core/Component","sap/ui/base/Event","sap/ovp/app/ManageCardsUtils","sap/ovp/handlers/IAppStateHandler","sap/ovp/handlers/SmartFilterbarHandler","sap/ovp/insights/CardProvider","sap/ui/core/EventBus","sap/ui/core/Lib","sap/ui/core/Element","sap/ovp/filter/FilterUtils"],function(e,t,a,r,i,s,n,o,l,d,h,f,g,u,c,p,v,y,m,b,C,F,P,jQuery,S,M,O,w,A,V,I,_,E,L,D,T,R,x,B,G,U){"use strict";var N=new w("OVP.app.Main");var k="sap.ovp.app.customData",j="sap.ovp.app.extensionData",H;return e.extend("sap.ovp.app.Main",{getCustomAppStateDataExtension:function(e){},restoreCustomAppStateDataExtension:function(e){},getCustomFilters:function(){},onCustomActionPress:function(e){},onCustomParams:function(e){},getAllowedNumberOfCards:function(){},modifyStartupExtension:function(e){},getCustomMessage:function(e,t){},onBeforeRebindPageExtension:function(){},telemetry:{storeAction:function(){}},oRefreshTimer:null,nRefreshInterval:0,filterItemInFocus:null,bFinishedCardsCreationProcess:false,storeIncomingDeltaChanges:function(e){this.deltaCardsInfo=e?e:[]},appendIncomingDeltaChange:function(e){this.deltaChanges.push(e)},templateBaseExtension:m,onInit:function(){this.bDeltaChangesEnabled=false;this.bResetChartAxisFormatter=false;this.deltaChanges=[];this.bInitialApplicationLoad=false;this.bWarningDisplayedOnUnhidingCards=false;this._initFlexibilityPersonalization();this.globalEventBus=x.getInstance();this.oShareUtils=new F(this);this.oManageCardsUtils=new L(this);this.getView().loaded().then(function(){var e=this.getOwnerComponent();var t=e.getMetadata();if(e&&t&&t.getManifest()){v.setAppComponent(this.getOwnerComponent())}v.setApplicationStatus(v.mApplicationStatus.LOADING);v.publishEvent("elements","ViewRenderingStarted",{});this.oContainer=n.getUshellContainer();this.aErrorCards=[];this.oCardsModels={};this.aFilters=[];this.errorHandlingObject={atLeastOneRequestSuccess:false,errorLoadingTimeout:{}};this.sPreviousEntityType="";this.sCurrentEntityType="";this.oLoadedComponents={};this.bGlobalFilterLoaded=false;this.bGoButtonPressed=false;this.bSearchButtonPressed=false;this.fnMacroFilterBarLoaded=undefined;this.isInitialLoading=true;this.bLoadDataOnMFBSearch=true;this.isMacroFilterBar;this.bSearchTriggeredManually=false;this.bInitialMacroFilterBarSearch=false;this.bSkipIAppStateGeneration=false;var a=this.getUIModel();this.bDisableErrorPage=a&&a.getProperty("/disableErrorPage");this.oNavigationHandler=this.oNavigationHandler||new s(this,"ODataV2");this.getLayout().addStyleClass("ovpLayoutElement");this.oState={};this.oState.oSmartFilterbar=this.byId("ovpGlobalFilter");this._initGlobalFilter();this.oShareUtils.init();n.enable(this,this.oNavigationHandler);this._loadCardComponent("sap.ovp.cards.error");this._loadCardComponent("sap.ovp.cards.v4.error");H=this.getView().byId("sapOvpShareButton");if(H){H.addEventDelegate({onsapspace:function(e){e.preventDefault();this.onShareButtonPress()},onsapenter:function(e){this.onShareButtonPress()}},this);H.attachBrowserEvent("click",function(){this.onShareButtonPress()}.bind(this))}}.bind(this))},onShareButtonPress:function(){if(H&&H.getVisible()&&H.getEnabled()){this.oShareUtils.onShareButtonAvailableAndPressed(H)}},performRecreationOfCard:function(e){e.settings.baseUrl=this._getBaseUrl();this._clearStoredEntities();this._initCardModel(e.model);e=this._getTemplateForChart(e);this._loadCardComponent(e.template);this._createModelViewMap(e);if(e.settings.tabs&&e.settings.selectedKey){var t=e.settings.selectedKey-1;e.settings.measureAggregate=e.settings.tabs[t].measureAggregate}jQuery.when(this.createCard(e)).then(function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var t=this.getLayout().getDashboardLayoutUtil();if(t){var a=t.getDashboardLayoutModel();var r=a.getCardById(e.id);t._sizeCard(r);a.extractCurrentLayoutVariant()}}}.bind(this))},onExit:function(){this.bResetChartAxisFormatter=true;var e=this.getOwnerComponent().oOvpConfig;if(e&&e.bInsightRTEnabled){R.unregisterProvider(this.getOwnerComponent().getId())}},_getOriginalCardDescriptorById:function(e){if(!e){return null}var t=this.getView().byId(e);var a=t.getComponentInstance();var r=a.getComponentData();var i=r.appComponent;return i._getOvpCardOriginalConfig(e)},recreateCard:function(e){var t=e.cardId;var a=this._getCardFromManifest(t);var r=this._getOriginalCardDescriptorById(t);if(a.template=="sap.ovp.cards.charts.analytical"||a.template=="sap.ovp.cards.charts.smart.chart"||a.template=="sap.ovp.cards.v4.charts.analytical"){a.settings.chartAnnotationPath=e.chartAnnotationPath;a.settings.colorPalette=e.colorPalette;a.settings.bEnableStableColors=e.bEnableStableColors;if(e.navigation){a.settings.navigation=e.navigation}}if(e.entitySet){a.settings.entitySet=e.entitySet}a.settings.annotationPath=e.annotationPath;a.settings.dynamicSubtitleAnnotationPath=e.dynamicSubtitleAnnotationPath;a.settings.presentationAnnotationPath=e.presentationAnnotationPath;a.settings.selectionAnnotationPath=e.selectionAnnotationPath;a.settings.selectionPresentationAnnotationPath=e.selectionPresentationAnnotationPath;a.settings.kpiAnnotationPath=e.kpiAnnotationPath;a.settings.dataPointAnnotationPath=e.dataPointAnnotationPath;a.settings.identificationAnnotationPath=e.identificationAnnotationPath;a.settings.headerAnnotationPath=e.headerAnnotationPath;a.settings.staticParameters=r&&r.settings&&r.settings.staticParameters;if(e.staticParameters){a.settings.staticParameters=e.staticParameters}if(e.customParams){a.settings.customParams=e.customParams}var i=a.settings.selectedKey;a.settings.selectedKey=e.selectedKey;if(a){var s=this.aErrorCards.indexOf(t);if(s>-1){this.aErrorCards.splice(s,1)}this.performRecreationOfCard(a)}var n={changeType:"viewSwitch",content:{cardId:e.cardId,selectedKey:e.selectedKey,oldKey:i},isUserDependent:true};o.savePersonalization(n,this.getView())},recreateRTAClonedCard:function(e){var t=this._getCardFromManifest(e.id);if(t){t.settings=e.settings;this.performRecreationOfCard(t)}},onBeforeRendering:function(){},onRequestCompleted:function(e){if(e&&e.getParameters()&&e.getParameters().success){var t=e.getParameters().response&&e.getParameters().response.responseText?JSON.parse(e.getParameters().response.responseText):"";if(t&&t.d&&t.d.results&&t.d.results.length==0){this.fVerifyAndSetErrorOrCustomMessageCard(e,true)}}else if(e&&e.getParameters()&&e.getParameters().response&&e.getParameters().response.statusCode!==0){this.fVerifyAndSetErrorOrCustomMessageCard(e,false)}},fVerifyAndSetErrorOrCustomMessageCard:function(e,t){var r;var i=this.getView().getModel("ui").getProperty("/aOrderedCards");for(r in i){var s=this.getView().byId(i[r].id);var o=s&&s.getComponentInstance();var l=o&&o.getComponentData();var d=o&&o.getRootControl();var h=d&&d.getController();var f=h&&h.getCardItemsBinding();if(f&&!n.isODataV4(h.oView.getModel())){var g=e.getParameters().url;var u=f.sCustomParams;var c=f.sFilterParams;var p=f.sPath.replace("/","");var v=f.sCountMode&&f.sCountMode.indexOf("Inline");var y=f.sSortParams;var m=e.getSource().sServiceUrl;var b=e.oSource&&e.oSource.oMetadata;var C=h.getEntityType();var F=this.getView().getModel();var P=h.oView.getModel();var M=this._getEntityRelevantFilters(C,this.aFilters,P,F);var O;try{O=a.createFilterParams(M,b,C)}catch(e){N.error("applying filter on a card which is not valid")}if(c&&O){c="("+c.replaceAll("$filter=","")+")";O="("+O.replaceAll("$filter=","")+")";c="$filter="+c+"%20and%20"+O}if(u.indexOf("_requestFrom")>-1){u=this._removeOVPInternalParam(u)}g=g.split(p).join("").split(u).join("").split(c).join("").split(y).join("").split(m).join("").split(O).join("").split("?").join("").split("&").join("").split("/").join("");if(!v){g=g.split("$inlinecount=allpages").join("")}var w=l&&l.cardId;var A=this._getCardFromManifest(w);if(g){var V=/sap-client=[0-9][0-9][0-9]/i;g=g.replace(V,"");var I=/\$skip=\d+\$top=\d+/;g=g.replace(I,"")}if(A&&!g){var _=S({},e);var E=S({},A);var L=this.getCustomMessage(_,E.id);L=L&&typeof L==="object"?L:"";if(t&&!L){return}if(L){if(t&&L.hasOwnProperty("sMessage")&&L.sMessage&&typeof L.sMessage==="string"){e.getParameters().response.statusText=L.sMessage;if(L.hasOwnProperty("sIcon")&&L.sIcon&&typeof L.sIcon==="string"&&L.sIcon.indexOf("sap-icon")!==-1){e.getParameters().response.sIcon=L.sIcon}}else if(t&&L.hasOwnProperty("sTitle")&&L.sTitle&&typeof L.sTitle==="string"){e.getParameters().response.sTitle=L.sTitle;if(L.hasOwnProperty("sIllustration")&&L.sIllustration&&typeof L.sIllustration==="string"&&L.sIllustration.indexOf("sapIllus")!==-1){e.getParameters().response.sIllustration=L.sIllustration}if(L.hasOwnProperty("sDescription")&&L.sDescription&&typeof L.sDescription==="string"){e.getParameters().response.sDescription=L.sDescription}}else if(!t&&L.hasOwnProperty("sMessage")&&L.sMessage&&typeof L.sMessage==="string"){e.getParameters().response.statusText=L.sMessage}else if(!t&&L.hasOwnProperty("sTitle")&&L.sTitle&&typeof L.sTitle==="string"){e.getParameters().response.sTitle=L.sTitle}if(this.aErrorCards.indexOf(w)==-1){this.aErrorCards.push(A.id);this.createErrorCard(A,e)}else{o.destroy()}}}}}},onAfterRendering:function(){var e=this.getView().getModel("ui");var t=e.getProperty("/enableLazyRendering")||this.getOwnerComponent().inLazyLoadingTestMode();if(t){this.aObservedCards=[];this.observeCardSection()}v.setApplicationStatus(v.mApplicationStatus.RENDERED);v.publishEvent("elements","ViewRendered",{});this.oModelViewMap={};D.oAppStatePromise=null;if(e.getProperty("/refreshIntervalInMinutes")){this.nRefreshInterval=e.getProperty("/refreshIntervalInMinutes");this.nRefreshInterval=(this.nRefreshInterval<=1?1:this.nRefreshInterval)*6e4}var a=this._getCardsModel();var r=[];var i;for(i in a){if(r.indexOf(a[i].model)==-1){r.push(a[i].model)}}var s=this.getOwnerComponent();if(s){for(i in r){var o=s.getModel(r[i]);if(o&&!n.isODataV4(o)){o.attachRequestCompleted(this.onRequestCompleted.bind(this))}}}if(this.initialized){return}this.initialized=true;this.getView().byId("ovpCardPage").addStyleClass("hideOvpCardPage");if(this.getMacroFilterBar()!==undefined){I.hidePlaceholder();var l=this.getMacroFilterBar();if(this.getUIModel()){var d=this.getUIModel().getProperty("/enableLiveFilter");var h=this.getDataLoadSettings();if(l&&!d&&h==="ifAnyFilterExist"){this.verifyMacroFilterLoaded(l)}}}Promise.all([this.oFlexibilityPersonalizationPromise,this.oGlobalFilterLoadedPromise]).then(function(){this.isMacroFilterBar=this.getMacroFilterBar()!==undefined;this.getView().byId("ovpFilterNotFulfilledPage").setVisible(false);this.getView().byId("ovpCardPage").removeStyleClass("hideOvpCardPage");this.persistencyVariantLoaded=true;var t;var a=[],r=[];this.aManifestOrderedCards=this._getCardArrayAsVariantFormat(this.getLayout().getContent());for(var i=0;i<this.aManifestOrderedCards.length;i++){t=this._getCardFromManifest(this.aManifestOrderedCards[i].id);if(t&&t.settings&&t.settings.requireAppAuthorization){a.push({id:t.id,cardIntent:t.settings.requireAppAuthorization});r.push(t.settings.requireAppAuthorization)}}var s=this._mergeLREPContent(this.aManifestOrderedCards);e.setProperty("/aOrderedCards",s);var n=s.some(function(e){return e.visibility});this.organizeCards(s);jQuery(".ovpWrapper .sapFDynamicPageTitle .sapFDynamicPageTitleMainActionsHasContent").css({visibility:"visible"});if(!n){I.hidePlaceholder()}}.bind(this));if(f.system.phone){g.enable(this)}},organizeCards:function(e){var t;var a=[];var r=this.getView().getModel("ui");var i=r.getProperty("/enableLazyRendering")||this.getOwnerComponent().inLazyLoadingTestMode();this.updateLayoutWithOrderedCards();this.updateDashboardLayoutCards(e);if(this.isDragAndDropEnabled()){var s=n.getUshellContainer();if(s){this.initShowHideCardsButton()}}this._clearStoredEntities();e=r.getProperty("/aOrderedCards");for(var o=0;o<e.length;o++){if(e[o].visibility){t=this._getCardFromManifest(e[o].id);if(t){a.push(t)}}}r.setProperty("/visibleCardCount",a.length);r.setProperty("/renderedOvpCards",0);r.setProperty("/renderedCardCount",0);r.setProperty("/updateView",false);if(!i){for(var o=0;o<a.length;o++){this._initCardModel(a[o].model);this._loadCardComponent(a[o].template);this._createModelViewMap(a[o])}}setTimeout(function(){this.getLayout().addStyleClass("ovpLayoutElementShow")}.bind(this),0);var l=this.fGetViewSwitchIndex(a);var d=[];for(var o=0,h=0;h<a.length;o++,h++){while(a[h].id!==e[o].id){o++}t=a[h];if(!t.settings.title){N.error("title is mandatory for card ID : "+t.id)}if(t.settings.tabs){var f=0;var g=l&&l.hasOwnProperty(t.id)?l[t.id]:"";if(g&&typeof g=="number"&&g>0&&g<=t.settings.tabs.length){f=g>=1?g-1:g;this.setOrderedCardsSelectedKey(t.id,g)}else if(e[o].selectedKey&&t.settings.tabs.length>=e[o].selectedKey){f=e[o].selectedKey-1}this.initializeTabbedCard(t,f)}t=this._getTemplateForChart(t);this._loadCardComponent(t.template);t.settings.baseUrl=this._getBaseUrl();if(i){d.push(this.observeCardSection(t))}else{d.push(this.createCard(t))}}Promise.all(d).then(function(){this.bFinishedCardsCreationProcess=true}.bind(this));if(this.busyDialog){this.busyDialog.close()}},initializeCardProvider:function(){var e=this.getView().getModel("ui");var t=e&&e.getProperty("/updateView");var a=this.getOwnerComponent()&&this.getOwnerComponent().getId();if(t){R.onViewUpdate(a)}else{R.init(a)}},_getTemplateForChart:function(e){if(e.template==="sap.ovp.cards.charts.smart.chart"){var t=this.getView();var a=t.getModel(e.model);var r=a.getMetaModel();var i=r.getODataEntitySet(e.settings.entitySet);var s=r.getODataEntityType(i.entityType);var n;var o;var l;var d=false;var h;if(e&&e.settings){if(!d&&e.settings.kpiAnnotationPath){var f=s[e.settings.kpiAnnotationPath];h=f.Detail.DefaultPresentationVariant&&f.Detail.DefaultPresentationVariant.Path;if(h){l=this._getTemplateForChartFromVisualization(h,e,a,i,s);d=l.bTemplateUpdated;if(d){e=l.oCard;return e}}}if(!d&&e.settings.selectionPresentationAnnotationPath){var g=s[e.settings.selectionPresentationAnnotationPath];if(g){h=g.PresentationVariant&&g.PresentationVariant.Path;if(h){l=this._getTemplateForChartFromVisualization(h,e,a,i,s);d=l.bTemplateUpdated;if(d){e=l.oCard;return e}}}}if(!d&&e.settings.presentationAnnotationPath){h=e.settings.presentationAnnotationPath;l=this._getTemplateForChartFromVisualization(h,e,a,i,s);d=l.bTemplateUpdated;if(d){e=l.oCard;return e}}if(!d&&e.settings.chartAnnotationPath){n=s[e.settings.chartAnnotationPath];o=n&&n.ChartType&&n.ChartType.EnumMember;if(o&&o.split("/")[1]==="Donut"){e.template="sap.ovp.cards.charts.analytical"}else{e.template="sap.ovp.cards.charts.smart.chart"}}}}return e},_getTemplateForChartFromVisualization:function(e,t,a,r,i){if(/^@/.test(e)){e=e.slice(1)}t.settings.presentationAnnotationPath=e;var s=i[e]&&i[e].Visualizations;var n;var o;var l;var d=false;if(s&&s.length>0){for(n=0;n<s.length;n++){var h=s[n].AnnotationPath;if(!h){return{oCard:t,bTemplateUpdated:d}}h.trim();if(h.startsWith("@")){h=h.slice(1)}if(h.indexOf("Chart")!=-1){t.settings.chartAnnotationPath=h;o=i[h];l=o&&o.ChartType&&o.ChartType.EnumMember;if(l&&l.split("/")[1]==="Donut"){t.template="sap.ovp.cards.charts.analytical"}else{t.template="sap.ovp.cards.charts.smart.chart"}}d=true}}return{oCard:t,bTemplateUpdated:d}},_createModelViewMap:function(e){if(!e||!e.settings||!e.model){return}if(!e.settings.entitySet||e.settings.entitySet===""){return}if(!e.template.startsWith("sap.ovp.cards")){return}var t=e.model;if(!this.oModelViewMap[t]){this.oModelViewMap[t]={}}this.oModelViewMap[t][e.id]=true},setTabIndex:function(e){if(typeof e=="object"){this.oTabIndexList=e}else{this.oTabIndexList={}}},getTabIndex:function(){return this.oTabIndexList},fnPresetFiltersAppliedInMFB:function(e){var t=e.getFilters();if(t&&t.filters){return t.filters.length>0}return false},fnExecuteOnSelectForCurrentVariant:function(e,t){var a=e.find(function(e){return e&&e.key===t});return a&&a.executeOnSelect||false},verifyMacroFilterLoaded:function(e){var t=this.getView().byId("ovpGlobalMacroFilterVariantMGMT");if(t){var a=t.getCurrentVariantKey();var r=t.getVariants();var i=this.fnExecuteOnSelectForCurrentVariant(r,a);var s=this.fnPresetFiltersAppliedInMFB(e);if(i&&!s){this.bLoadDataOnMFBSearch=false}}},getDataLoadSettings:function(){var e=this.getUIModel();var t=e&&e.getProperty("/dataLoadSettings");var a=t?t.loadDataOnAppLaunch:"ifAnyFilterExist";if(!["ifAnyFilterExist","always","never"].includes(a)){N.error("dataLoadSetting is incorrect. It should be one of ifAnyFilterExist,always,never")}return a},fGetViewSwitchIndex:function(e){var t=this.getGlobalFilter();var a=t&&t.getUiState();var r=a&&a.getSelectionVariant()?JSON.stringify(a.getSelectionVariant()):"{}";var i=JSON.parse(r);var s=S({},i);var n=[];if(e&&e.length>0){for(var o=0;o<e.length;o++){var l=S({},e[o]);n.push(l)}}this.onBeforeRebindPageExtension(n,s);return this.getTabIndex()},changeViewSwitchForVisibleCard:function(){var e=this.getView().getModel("ui").getProperty("/aOrderedCards");if(e&&e.length>0){var t=[],a=[];for(var r=0;r<e.length;r++){t.push(this._getCardFromManifest(e[r].id))}var i=this.fGetViewSwitchIndex(t);if(i&&typeof i=="object"){a=Object.keys(i)}if(a&&a.length>0){for(var r=0;r<e.length;r++){if(e[r]&&e[r].visibility==true){var s=this._getCardFromManifest(e[r].id);if(s&&s.settings&&s.settings.tabs&&s.settings.hasOwnProperty("selectedKey")){var n=i&&i.hasOwnProperty(s.id)?i[s.id]:"";var o=s.settings.selectedKey;if(n&&typeof n=="number"&&n<=s.settings.tabs.length&&n!==o){this.setOrderedCardsSelectedKey(s.id,n);var l={};l=s.settings.tabs[n-1];var d={cardId:s.id,selectedKey:n};for(var h in l){d[h]=l[h]}this.recreateCard(d)}}}}}}},setOrderedCardsSelectedKey:function(e,t){var a=this.getView().getModel("ui").getProperty("/aOrderedCards");for(var r=0;r<a.length;r++){if(a[r]&&a[r].id==e){a[r].selectedKey=t;break}}this.getView().getModel("ui").setProperty("/aOrderedCards",a)},getOrderedCardsSelectedKey:function(e){var t=this.getView().getModel("ui").getProperty("/aOrderedCards");for(var a=0;a<t.length;a++){if(t[a]&&t[a].id==e){return t[a].selectedKey}}},initializeTabbedCard:function(e,t){if(e.template=="sap.ovp.cards.charts.analytical"||e.template=="sap.ovp.cards.charts.smart.chart"||e.template=="sap.ovp.cards.v4.charts.analytical"){e.settings.chartAnnotationPath=e.settings.tabs[t].chartAnnotationPath;e.settings.colorPalette=e.settings.tabs[t].colorPalette;e.settings.bEnableStableColors=e.settings.tabs[t].bEnableStableColors;if(e.settings.tabs[t].navigation){e.settings.navigation=e.settings.tabs[t].navigation}}if(e.settings.tabs[t].entitySet){e.settings.entitySet=e.settings.tabs[t].entitySet}e.settings.annotationPath=e.settings.tabs[t].annotationPath;e.settings.dynamicSubtitleAnnotationPath=e.settings.tabs[t].dynamicSubtitleAnnotationPath;e.settings.presentationAnnotationPath=e.settings.tabs[t].presentationAnnotationPath;e.settings.selectionAnnotationPath=e.settings.tabs[t].selectionAnnotationPath;e.settings.selectionPresentationAnnotationPath=e.settings.tabs[t].selectionPresentationAnnotationPath;e.settings.kpiAnnotationPath=e.settings.tabs[t].kpiAnnotationPath;e.settings.dataPointAnnotationPath=e.settings.tabs[t].dataPointAnnotationPath;e.settings.identificationAnnotationPath=e.settings.tabs[t].identificationAnnotationPath;e.settings.params=e.settings.tabs[t].params;e.settings.measureAggregate=e.settings.tabs[t].measureAggregate;e.settings.selectedKey=t+1;if(!e.settings.staticParameters){e.settings.staticParameters=e.settings.tabs[t].staticParameters}if(!e.settings.customParams){e.settings.customParams=e.settings.tabs[t].customParams}},_getLibraryResourceBundle:function(){if(!this.oLibraryResourceBundle){this.oLibraryResourceBundle=B.getResourceBundleFor("sap.ovp")}return this.oLibraryResourceBundle},_getOvplibResourceBundle:function(){return this.getOwnerComponent()._getOvpLibResourceBundle()},_getCardsModel:function(){if(!this.oCards){var e=this.getUIModel();this.oCards=e.getProperty("/cards")}return this.oCards},_getBaseUrl:function(){var e=this.getUIModel();if(!this.sBaseUrl){this.sBaseUrl=e.getProperty("/baseUrl")}return this.sBaseUrl},_getApplicationId:function(){var e=this.getUIModel();return e.getProperty("/applicationId")},_getCardFromManifest:function(e){var t=this._getCardsModel();for(var a=0;a<t.length;a++){if(t[a].id===e){return t[a]}}if(e&&e.indexOf("ObjectStream")===-1){N.error("Card id "+e+" is not available in the manifest")}return null},_getCardArrayAsVariantFormat:function(e){var t=[];for(var a=0;a<e.length;a++){var r=this._getCardId(e[a].getId());t.push({id:r,visibility:e[a].getVisible()});var i;if(this.getView()&&this.getView().byId){if(this.getView().byId(r).getComponentInstance()){i=this.getView().byId(r).getComponentInstance().getComponentData().settings.selectedKey}}if(i){t[t.length-1].selectedKey=i}}return t},_mergeLREPContent:function(e){var t=[];var a=false;if(this.bDeltaChangesEnabled&&Array.isArray(this.deltaCardsInfo)&&this.deltaCardsInfo.length>0){e=o.addMissingCardsFromManifest(e,this.deltaCardsInfo);a=true}if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(!a){e=this.getLayout().getLayoutDataJSON()}t=o.mergeChanges(e,this.deltaChanges);this._bDashboardLayoutLrepActive=true;this.getLayout().getDashboardLayoutModel().setLayoutVars(t)}else{t=o.mergeChanges(e,this.deltaChanges)}return t?t:[]},updateLayoutWithOrderedCards:function(){var e=this.getLayout();var t=this.getView().getModel("ui");var a=t.getProperty("/aOrderedCards");var r=a.filter(function(e){return e.visibility===true}).length;var i=this.getView().byId("ovpAllCardsHiddenPage");if(i){i.setVisible(r===0)}e.removeAllContent();var s,n=false;if(t&&t.getProperty("/cards")){s=t.getProperty("/cards");for(var o=0;o<s.length;o++){n=false;for(var l=0;l<a.length;l++){if(s[o].id==a[l].id){n=true;break}}if(!n&&this.getView().byId(s[o].id)){this.getView().byId(s[o].id).destroy()}}}var d=this.getAllowedNumberOfCards();var h=d&&d.numberOfCards;var f=a.filter(function(e){return e.visibility===true});if(h&&f.length>h&&!this.bInitialApplicationLoad){for(var o=h;o<a.length;o++){a[o].visibility=false}this.bInitialApplicationLoad=true}for(var o=0;o<a.length;o++){var g=this.getView().byId(a[o].id);if(g){g.setVisible(a[o].visibility);e.addContent(g)}}},_updateErrorCardsArray:function(e){var t;for(t=0;t<e.length;t++){var a=this.aErrorCards.indexOf(e[t].id);if(a>-1&&e[t].visibility==false){this.aErrorCards.splice(a,1)}}},updateDashboardLayoutCards:function(e){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this.getLayout().getDashboardLayoutUtil()){this.getLayout().getDashboardLayoutUtil().updateCardVisibility(e)}}},updateCardVisibiltyForCM:function(e){var t=e.filter(function(e){return e.visible});var a=this.getView().getModel("ui");a.setProperty("/visibleCardCount",t.length);a.setProperty("/renderedCardCount",0);a.setProperty("/updateView",true);R.resetInsightCards();if(!t.length){R.onViewUpdate(this.getOwnerComponent().getId())}},applyFiltersForCustomCards:function(){if(this.oGlobalFilter){var e=n.getCustomCards(this.oCards);if(e.length>0){var t=this.getView().getId();if(t){for(var a=0;a<e.length;a++){var r=t+"--"+e[a].id;var i=this.byId(r);var s=i&&i.getModel(e[a].model);if(s){var o=n.isODataV4(s);if(!o){var d=i.getComponentInstance()&&i.getComponentInstance().getRootControl()&&i.getComponentInstance().getRootControl().getController();if(d){if(typeof d.setRelevantFilters==="function"){var h=new l;if(this.oGlobalFilter&&typeof this.oGlobalFilter.getFilters==="function"){var f=this.oGlobalFilter.getFilters();h=U.getFiltersForV2CustomCard(f,d);var g=this.oGlobalFilter.getBasicSearchValue();var u=d.getCardPropertiesModel()&&d.getCardPropertiesModel().getProperty("/includeSearchWithRelevantFilters");if(u&&g!==undefined&&g.length>0){var c=d.getCardPropertiesModel();var p=c&&c.getProperty("/entityType/property");if(p){p=this.getEDMStringTypeProperties(p);var v=d.getCardItemsBinding();var y=v&&v.mParameters;if(y&&y.select){var m=y.select;p=this.updateFilterProperties(m,p)}h=this.updateFilterFormed(h,g,p)}}}d.setRelevantFilters(h)}}}}}}}}},getEDMStringTypeProperties:function(e){return e.filter(function(e){return e&&e.type=="Edm.String"})},updateFilterProperties:function(e,t){var a=e.split(",");var r=t.filter(function(e){return a.some(function(t){return t===e.name})});return r},updateFilterFormed:function(e,a,r){var i=[];for(var s=0;s<r.length;s++){var n=r[s];if(n.name&&n.type==="Edm.String"){var o=new l(n.name,t.Contains,a);i.push(o)}}var d=new l({filters:i,and:false});if(e&&e[0]&&e[0].aFilters){e.push(d);return e}return d},resetDashboardLayout:function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this.getLayout().getDashboardLayoutUtil()){this.getLayout().getDashboardLayoutUtil().resetToManifest()}this.getLayout().invalidate()}},_getCardArrayAsVariantFormatDashboard:function(){var e=[];var t=this.getLayout();var a=t.dashboardLayoutUtil.aCards;t.dashboardLayoutUtil.dashboardLayoutModel._sortCardsByRow(a);a.forEach(function(t){e.push({id:t.id,visibility:t.dashboardLayout.visible})});e.sort(function(e,t){return t.visibility-e.visibility});return e},_fnIsLoadDataOnGoButton:function(e){var t=this.getView().byId("ovpFilterNotFulfilledPage");var a;t.setVisible(true);var r=this.getUIModel().getProperty("/smartVariantRequired");if(!r){I.hidePlaceholder();return false}var i=this&&this.getView().byId("ovpMain");if(!this.oState.oSmartFilterbar.isCurrentVariantStandard()){a=this.oState.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();I.hidePlaceholder();if(!a){i.setHeaderExpanded(true)}return false}var s=this.getDataLoadSettings();var n=false,o=true;if(s==="ifAnyFilterExist"){var l=this.oState.oSmartFilterbar.getFiltersWithValues();n=true;o=l.length?true:false}else if(s==="always"){n=true}else if(s==="never"){n=false}if(n){var d=this.oState.oSmartFilterbar.getSmartVariant();if(d){d.setExecuteOnStandard(true);n=d.getExecuteOnStandard();a=this.oState.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();if(a){this.oState.oSmartFilterbar.search()}}}if(!a||!n){i.setHeaderExpanded(true)}C.loadingState.GLOBALFILTERFILLED=n;if(!n||!e||!o){I.hidePlaceholder()}return n&&e&&o},verifyGlobalFilterLoaded:function(){var e=this.getUIModel().getProperty("/enableLiveFilter");var t=this.getGlobalFilter();var a=true;var r=t.determineMandatoryFilterItems();var i,s=t.getFilterData(),n;if(r&&s){var o=r.length;while(o--){i=r[o];n=G.getElementById(i.getId());if(n){if(!t._checkForValues(s,i,n)){a=false;break}}}}if(!this.bGlobalFilterLoaded&&e===false){if(!a){var l=f&&f.system&&f.system.phone;if(l){var d=this&&this.getView().byId("ovpMain"),h=d&&d.getHeaderExpanded();if(!h){d.setHeaderExpanded(true)}}if(I.hidePlaceholderNeeded()){I.hidePlaceholder()}}return this._fnIsLoadDataOnGoButton(a)}if(a){if(t.validateMandatoryFields()){C.loadingState.GLOBALFILTERFILLED=true;return true}}else if(!a){if(I.hidePlaceholderNeeded()){I.hidePlaceholder()}}this.getView().byId("ovpMain").setHeaderExpanded(true);this.getView().byId("ovpFilterNotFulfilledPage").setVisible(true);C.loadingState.GLOBALFILTERFILLED=false;return false},onGlobalFilterChange:function(e){this.filterChanged=true;this.bSkipIAppStateGeneration=false;if(this.bGlobalFilterInitialized){var t=this.getGlobalFilter();var a=t.getLiveMode();var r=this.getLayout();var i=e.getParameter("afterFilterDataUpdate");if(!a&&r&&!i){r.setActive(false)}else{r.setActive(true);this.changeViewSwitchForVisibleCard()}}},destroyErrorCardsAndReplaceWithOriginal:function(){if(this.isModelRefreshTriggered||this.filterChanged||this.bGoButtonPressed||this.bSearchButtonPressed){var e;var t=Object.assign({},this.aErrorCards);var a=this.getView().getModel("ui").getProperty("/enableLazyRendering")||this.getOwnerComponent().inLazyLoadingTestMode();for(e in t){var r=this.getView().byId(t[e]);var i=r&&r.getComponentInstance();var s=i&&i.getComponentData();var n=s&&s.cardId;var o=this._getCardFromManifest(n);this._initCardModel(o.model);this._loadCardComponent(o.template);this._createModelViewMap(o);i&&i.destroy();var l=this.aErrorCards.indexOf(n);if(l>-1){this.aErrorCards.splice(l,1)}if(a){this.observeCardSection(o)}else{this.createCard(o)}}this.isModelRefreshTriggered=false}},onTriggerFilterSearch:function(){var e=this.getGlobalFilter();if(e&&e.validateMandatoryFields()&&A(e.verifySearchAllowed())){this.onGlobalFilterSearch()}if(this.getMacroFilterBar()){this.onMacroFilterBarSearch()}},onGlobalFilterSearch:function(){if(this.filterChanged||this.bGoButtonPressed||this.bSearchButtonPressed){var e=this.getGlobalFilter();var t=this.getLayout();if(t){t.setActive(true)}if(this.aErrorCards&&this.aErrorCards.length>0){this.destroyErrorCardsAndReplaceWithOriginal()}if(e&&!e.isDialogOpen()){this._storeCurrentAppStateAndAdjustURL()}if(e&&e.getLiveMode()&&e._bResetFiltersDialogTriggered){this._storeCurrentAppStateAndAdjustURL()}this._clearStoredEntities();var a=[];if(this.oGlobalFilter["_aFields"].length>0){a=this.oGlobalFilter["_aFields"]}else{var r=this.oGlobalFilter["_aFilterBarViewMetadata"];for(var i=0;i<r.length;i++){var s=r[i];for(var o=0;o<s.fields.length;o++){a.push(s.fields[o])}}}for(var i=0;i<a.length;i++){if(a[i].control){var l=document.getElementById(a[i].control.sId);if(jQuery(l).hasClass("sapMFocus")){this.filterItemInFocus=a[i].control;break}}}var d="ovp-"+(new Date).getTime();this._processFilters();this.globalEventBus.publish("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",this.aFilters);if(this.nRefreshInterval!==0){if(this.oRefreshTimer!==null){clearTimeout(this.oRefreshTimer)}this.attachRefreshInterval(this.nRefreshInterval)}for(var h in this.oCardsModels){if(this.oCardsModels.hasOwnProperty(h)&&!n.isODataV4(this.oCardsModels[h])){try{this.oCardsModels[h].refresh(false,false,d)}catch(e){N.warning(e)}}}this.applyFiltersForCustomCards();this.filterChanged=false;this.bGoButtonPressed=false;this.bSearchButtonPressed=false;this._clearStoredEntities()}},_clearStoredEntities:function(){if(this.sPreviousEntityType){this.sPreviousEntityType=""}if(this.sCurrentEntityType){this.sCurrentEntityType=""}},_processSFBFilters:function(){var e=this.getGlobalFilter();var t=e.getFilters();var a=this.getCustomFilters();var r=true;var i;var s=function(e,t){if(!(e instanceof b)){throw new Error("State must always be set with respect to a ControllerExtension")}if(!r){throw new Error("State must always be provided synchronously")}if(t){i=t}};this.templateBaseExtension.addFilters(s);r=false;var n=[];if(a&&a instanceof l){n.push(a)}if(i&&i instanceof l){n.push(i)}if(n.length!==0){var o=[];if(t&&t.length>0){n.push(t[0])}o.push(new l(n,true));if(o.length>0){t=o}}this.aFilters=t},_processFilters:function(){if(this.getGlobalFilter()){this.aFilters=[];this._processSFBFilters()}else if(this.getMacroFilterBar()){this.aFilters=this.aFilters||[]}else{this.aFilters=[]}},_processSearch:function(){var e,t;var a=this.getGlobalFilter();if(!a){return}var r=a.getParameters();var t=r&&r["custom"];if(!t){return}for(var i in t){e=i+"="+P(t[i])}return e},_collapseHeaderForPage:function(){var e=f&&f.system&&f.system.phone;if(e){var t=this.getGlobalFilter();var a=this&&this.getView().byId("ovpMain"),r=a&&a.getHeaderExpanded();if(r&&t.validateMandatoryFields()){a.setHeaderExpanded(false)}}},_initGlobalFilter:function(){var e=this.getGlobalFilter();if(!e){var t=this.getLayout();var a=this.getOwnerComponent().oOvpConfig;if(t&&a&&(a.globalFilterEntitySet||a.globalFilterEntityType)){t.setActive(false)}var r=this.getMacroFilterBar();this._parseNavigationVariant();if(!r){this.bGlobalFilterLoaded=true;return}this.getView().byId("ovpMain").setHeaderExpanded(true);this.getView().byId("ovpFilterNotFulfilledPage").setVisible(true);C.loadingState.GLOBALFILTERFILLED=false;this.oGlobalFilterLoadedPromise=new Promise(function(e,t){this.fnMacroFilterBarLoaded=e}.bind(this));var i=this;if(this.oParseNavigationPromise){this.bInitialMacroFilterBarSearch=true;this.oParseNavigationPromise.then(function(e){var t=e&&e[0];if(t&&t.oSelectionVariant){r.setSelectionVariant(t.oSelectionVariant).then(function(){i.bSearchTriggeredManually=true;r.triggerSearch()}).catch(function(e){N.error(e+"while setting selection variant")})}}).catch(function(){N.error("Could not parse navigation variant from URL")})}return}e.attachFiltersDialogClosed(this._storeCurrentAppStateAndAdjustURL.bind(this));var s=e.getVariantManagement();if(s){s.attachAfterSave(function(e){this._storeCurrentAppStateAndAdjustURL(undefined,true)}.bind(this))}this.oGlobalFilterLoadedPromise=new Promise(function(t,a){e.attachInitialized(function(){this._parseNavigationVariant();this.bSkipIAppStateGeneration=true;if(this.oParseNavigationPromise){var a;this.oParseNavigationPromise.then(function(e){var t=e&&e[0];var r=e&&e[1];var i=e&&e[2];if(t){a=Promise.resolve(this._setNavigationVariantToGlobalFilter(t,r,i)).then(function(){this.filterChanged=false}.bind(this))}}.bind(this)).catch(function(e){N.error("Error during parse navigation"+e)});this.oParseNavigationPromise.catch(function(){N.error("Could not parse navigation variant from URL")});this.oParseNavigationPromise.finally(function(){Promise.all([a]).then(function(){this.bGlobalFilterInitialized=true;if(e&&this.verifyGlobalFilterLoaded()){t()}}.bind(this))}.bind(this))}else if(e&&this.verifyGlobalFilterLoaded()){t()}},this);e.attachSearch(function(){if(e.validateMandatoryFields()){if(!this.bGlobalFilterLoaded){t();this.bGlobalFilterLoaded=true;if(!e.isDialogOpen()){this._storeCurrentAppStateAndAdjustURL()}var a=this.getLayout();if(a){a.setActive(true)}return}this.onGlobalFilterSearch()}},this);e.attachFilterChange(this.onGlobalFilterChange,this);var r=this.getView()&&this.getView().byId("ovpGlobalFilter-btnGo");r&&r.attachPress(function(){this.bGoButtonPressed=true;this._collapseHeaderForPage();var e=this.getLayout();if(e){e.setActive(true)}}.bind(this))}.bind(this));this.oGlobalFilterLoadedPromise.then(function(t){this.bGlobalFilterLoaded=true;this._collapseHeaderForPage();e._oBasicSearchField&&e._oBasicSearchField.attachSearch(function(){this.bSearchButtonPressed=true}.bind(this))}.bind(this))},_loadCardComponent:function(e){var t=e.replace(/\./g,"/");var a=sap.ui.require.toUrl(t);if(!this.oLoadedComponents[e]){this.oLoadedComponents[e]=_.load({name:e,url:a,manifest:false}).then(function(e){return e})}},_initCardModel:function(e){var t=false;if(this.oCardsModels[e]||!e){return}this.oCardsModels[e]=this.getView().getModel(e);if(!n.isODataV4(this.getView().getModel(e))){if(!this.oCardsModels[e].bUseBatch){this.oCardsModels[e].setUseBatch(false)}else{this.oCardsModels[e].setUseBatch(true)}}if(this.getGlobalFilter()||this.getMacroFilterBar()){t=true}if(!n.isODataV4(this.oCardsModels[e])){this._overrideCardModelRead(this.oCardsModels[e],t)}},getVisibleCustomFields:function(){var e=this.getGlobalFilter();var t=e.getAllFilterItems(true);var a,r,i=[];if(t){a=t.length;while(a--){r=t[a];if(r&&r.getVisibleInFilterBar()){i.push(r.getName())}}}var s,n,o,l=e.getFilterBarViewMetadata();var d=[];if(l){s=l.length;while(s--){o=l[s].fields;if(o){n=o.length;while(n--){if(o[n].isCustomFilterField&&i.indexOf(o[n].fieldName)>-1){d.push({name:o[n].fieldName})}}}}}return d},_showErrorPage:function(e){if(this.bDisableErrorPage){return}var t=this.getView().byId("ovpErrorPage");var a=this.getView().byId("ovpMain");if(e){t.setVisible(true);a.setVisible(false);return}t.setVisible(false);a.setVisible(true)},_removeFilter:function(e,t){var a=e.lastIndexOf(t);var r=e.indexOf(t);if(a===-1||r===-1){return e}var i="%20and%20";var s=e.substring(a).indexOf(i);s=s!==-1?a+s:s;var n=e.substring(0,r).lastIndexOf(i);if(s===-1&&n===-1){if(e.lastIndexOf("$filter=")===0){return e.slice(0,8)}else{return""}}else if(n===-1){if(e.lastIndexOf("$filter=")===0){return e.slice(0,8)+e.slice(s+i.length)}else{return e.slice(s+i.length)}}else if(s===-1){return e.slice(0,n)}else{return e.slice(0,n)+e.slice(s)}},_removeRelevantFilterRecursively:function(e,t){if(!e._bMultiFilter){if(e.sPath===t){return undefined}return e}else{e.aFilters.forEach(function(a,r){e.aFilters[r]=this._removeRelevantFilterRecursively(a,t)}.bind(this));for(var a=0;a<e.aFilters.length;a++){if(!e.aFilters[a]){e.aFilters.splice(a,1);a--}}if(e.aFilters.length>0){return e}else{return undefined}}},_removeRelevantFilter:function(e,t){if(!e||e.length===0){return e}e[0]=this._removeRelevantFilterRecursively(e[0],t);return!e[0]?undefined:e},_getFilterPreference:function(e){var t;var a=this._getCardFromManifest(e);if(a){if(a.settings.tabs){var r=0;var i=a.settings.selectedKey;if(i&&a.settings.tabs.length>=i){r=i-1}t=a.settings.tabs[r].mFilterPreference}else{t=a.settings.mFilterPreference}}return t},_getFilterPreferenceFromUrlParams:function(e){var t=e.urlParameters;var a;var r="cardId=";var i=-1;if(t){for(var s=0;s<t.length;s++){if(t[s].lastIndexOf(r)>=0){i=s;break}}if(i>=0){var n=t[i].lastIndexOf(r);var o=t[i].slice(n+r.length);a=this._getFilterPreference(o);if(n>0){t[i]=t[i].slice(0,n-1)}else{t.splice(i,1)}}}return a},_addRelevantFilters:function(e,t,r,i){var s=e.urlParameters;var n=-1;if(s){for(var o=0;o<s.length;o++){if(s[o].lastIndexOf("$filter=",0)===0){n=o;break}}}if(this.aRelevantFilters&&this.aRelevantFilters.length>0){if(n>=0){var l=a.createFilterParams(this.aRelevantFilters,t.oMetadata,r).substr(8);if(i&&i.filterAll==="card"){s[n]=s[n]}else if(i&&i.filterAll==="global"){s[n]=s[n].slice(0,8)+l}else if(i&&(i.cardFilter||i.globalFilter)){if(Array.isArray(i.cardFilter)&&i.cardFilter.length>0){i.cardFilter.forEach(function(e){l=this._removeFilter(l,e)}.bind(this))}if(Array.isArray(i.globalFilter)&&i.globalFilter.length>0){i.globalFilter.forEach(function(e){s[n]=this._removeFilter(s[n],e)}.bind(this))}if(l===""&&s[n].length===8){s.splice(n,1)}else if(l===""){s[n]=s[n]}else if(s[n].length===8){s[n]=s[n]+l}else{if(this.aRelevantFilters.length===1){l="("+l+")"}s[n]=s[n].slice(0,8)+"("+s[n].slice(8,s[n].length)+")%20and%20"+l}}else{if(this.aRelevantFilters.length===1){l="("+l+")"}s[n]=s[n].slice(0,8)+"("+s[n].slice(8,s[n].length)+")%20and%20"+l}}else{if(i&&i.filterAll==="card"){e.filters=undefined}else if(i&&i.filterAll==="global"){e.filters=this.aRelevantFilters}else if(i&&(i.cardFilter||i.globalFilter)){if(Array.isArray(i.cardFilter)&&i.cardFilter.length>0){i.cardFilter.forEach(function(e){this.aRelevantFilters=this._removeRelevantFilter(this.aRelevantFilters,e)}.bind(this))}if(this.aRelevantFilters&&this.aRelevantFilters.length>0){e.filters=this.aRelevantFilters}}else{e.filters=this.aRelevantFilters}}}else{if(n>=0){if(i&&i.filterAll==="card"){s[n]=s[n]}else if(i&&i.filterAll==="global"){s.splice(n,1)}else if(i&&i.globalFilter){if(Array.isArray(i.globalFilter)&&i.globalFilter.length>0){i.globalFilter.forEach(function(e){s[n]=this._removeFilter(s[n],e)}.bind(this))}if(s[n].length===8){s.splice(n,1)}}}}return e},removeInternalParamValue:function(e,t){return e&&e.reduce(function(e,a){if(a&&a.includes(t)){a=a.substring(0,a.indexOf(t)-1)}if(a){e.push(a)}return e},[])},_overrideCardModelRead:function(e,t){var a=e.read;var r=this;e.read=function(){var i=arguments[1];if(!i){i={};Array.prototype.push.call(arguments,i)}var s=r._getEntityTypeFromPath(e,arguments[0],i.context,false);var n=r._getEntitySetFromEntityType(e,s);var o=i&&i.urlParameters;var l=false;if(o&&Array.isArray(o)){l=o.some(function(e){return e&&e.indexOf("_requestFrom=ovp_internal")>-1})}else if(o&&typeof o==="object"){l=o["_requestFrom"]==="ovp_internal"}if(!l){return a.apply(e,arguments)}if(o&&Array.isArray(o)){o=r.removeInternalParamValue(o,"_requestFrom=ovp_internal");i.urlParameters=o}else if(o&&typeof o==="object"&&l){delete o["_requestFrom"]}var d=r._getFilterPreferenceFromUrlParams(i);if(t){r._processFilters();var h=r.getGlobalFilter();var f=r.getMacroFilterBar();var g=h!==undefined?h.getModel():f.getModel();if(!r.aFilters){r.aFilters=[]}var u=false;var c;var p=n["Org.OData.Capabilities.V1.SearchRestrictions"];if(n["sap:searchable"]==="true"||p&&p.Searchable&&p.Searchable.Bool&&p.Searchable.Bool==="true"){c=r._processSearch()}r.sCurrentEntityType=s.entityType;if(r.sPreviousEntityType!==r.sCurrentEntityType){r.sPreviousEntityType=r.sCurrentEntityType;u=true}if(!r.aRelevantFilters){r.aRelevantFilters=[];u=true}if(u){r.aRelevantFilters=[];if(s){r.aRelevantFilters=r._getEntityRelevantFilters(s,r.aFilters,e,g)}}i=r._addRelevantFilters(i,e,s,d);var v=i.urlParameters;if(c){v[v.length]=c}if(h&&h.getConsiderAnalyticalParameters()){var y=h.getAnalyticBindingPath();var m,b,C;if(y&&y.length>0){if(s.entityType===T.getEntityType(h)){b=arguments[0];m=arguments[0].indexOf("$");if(m>0){b=arguments[0].substring(0,m-1)}C=y;if(b!==C){arguments[0]=arguments[0].replace(b,C)}}else{var F=r._getParametersFromEntityPath(arguments[0]);var P=r._getParametersFromEntityPath(y);var S,M,O;if(F&&F.length>0){var w=r._getEntityTypeFromPath(e,arguments[0],i.context,true);for(var A=0;A<P.length;A++){S=r._getPropertyMapping(F,P[A].name,w.name,T.getEntityType(h),e,h.getModel());if(S){M=S+"=.*?[,)]";O=arguments[0].match(new RegExp(M));if(O&&O.length>0){b=O[0].slice(0,-1);C=S+"="+P[A].sValue;if(b!==C){arguments[0]=arguments[0].replace(b,C)}}}}}}}}}var V=e.getMetaModel();var I=V.getODataEntityType(n.entityType);v=r._getExpandPropertiesForSmartCharts(v,V,I);var _=arguments[1].success;arguments[1].success=function(e,t){return function(){if(!t.errorHandlingObject.atLeastOneRequestSuccess){t.errorHandlingObject.atLeastOneRequestSuccess=true;t._showErrorPage(false)}if(t.filterItemInFocus!=null){t.filterItemInFocus.focus();t.filterItemInFocus=null}if(t.nRefreshInterval!==0){if(t.oRefreshTimer!==null){clearTimeout(t.oRefreshTimer)}t.attachRefreshInterval(t.nRefreshInterval)}return e.apply(this,arguments)}}(_,r);var E=arguments[1].error;arguments[1].error=function(e,t){return function(){if(!t.errorHandlingObject.atLeastOneRequestSuccess){clearTimeout(t.errorHandlingObject.errorLoadingTimeout);t.errorHandlingObject.errorLoadingTimeout=setTimeout(function(){if(!t.errorHandlingObject.atLeastOneRequestSuccess){t._showErrorPage(true)}},9e3)}return e.apply(this,arguments)}}(E,r);var L=a.apply(e,arguments);return L}},showErrorCardForMissingParam:function(e,t){var a=e[0];var r=e[1].urlParameters;for(var i in r){a=a+r[i]}var s=new E;s.mParameters={url:a,response:{statusText:y.getText("Missing_Param_Text")}};s.oSource=t;setTimeout(function(){this.fVerifyAndSetErrorOrCustomMessageCard(s,false)}.bind(this),0)},_checkMandatoryParams:function(e,t,a){var r=new p.Model(p.Model.ReferenceByModel(e));var i=r.findQueryResultByName(t);var s=i&&i.getParameterization();if(!s){return true}var n=s.getAllParameterNames();var o=a.match(/\(.*\)/g);if(n.length>0&&o===null){return false}var l=o[0].replace("(","").replace(")","").split(",");if(l.length===n.length){for(var d in l){var h=l[d].split("=")[1];if(h.indexOf("%27")>-1){h=h.split("%27")[1]}if(h.length===0){return false}}}else{return false}},_getExpandPropertiesForSmartCharts:function(e,t,a){var r;var i="";var s;var n;var o;var l="$expand";var d=false;var h=false;var f;var g;var u;var c="com.sap.vocabularies.Common.v1.Text";var p=a&&a.property;if(!e||!(e.length>0)){return e}for(var v=0;v<e.length;v++){if(e[v].indexOf("$expand")>-1){return e}}for(var y=0;y<e.length;y++){if(e[y].indexOf("$select")>-1){h=true;g=e[y];o=e[y].split("$select=");if(o&&o[1]){f=decodeURIComponent(o[1]);r=f.split(",");if(!r||!(r.length>1)){return e}}break}}if(!h){return e}if(!r||!(r.length>0)||!p||!(p.length>0)){return e}for(var m=0;m<r.length;m++){for(var b=0;b<p.length;b++){if(r[m]==(p[b]&&p[b].name)){if(p[b]&&p[b]["sap:aggregation-role"]&&p[b]["sap:aggregation-role"]=="dimension"){if(!p[b][c]||!p[b][c].Path||!(p[b][c].Path.indexOf("/")>0)){break}i=p[b][c].Path;s=i.split("/");if(!s.length){break}n=t.getODataAssociationEnd(a,s[0]);if(!n){break}if(!d){l=l+"="+s[0];d=true}else if(d){l=l+","+s[0]}u=g+","+i}break}}}if(u&&l){e[y]=u;e.push(l)}return e},attachRefreshInterval:function(e){this.oRefreshTimer=setTimeout(function(){this._processFilters();this.globalEventBus.publish("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",this.aFilters);var e=this.getLayout();if(e&&e.getActive()){for(var t in this.oCardsModels){this.isModelRefreshTriggered=true;var a=this.oCardsModels[t];if(a){a.refresh()}}}}.bind(this),e)},_getEntityTypeFromPath:function(e,t,a,r){var i=u.prototype._normalizePath.apply(e,[t,a]);if(r){i=t.replace(/^\/|\/$/g,"").split("/")[0];if(i.indexOf("(")!=-1){i=i.substring(0,i.indexOf("("))}}var s=c.prototype._getEntityTypeByPath.apply(e.oMetadata,[i]);return s},_getEntitySetFromEntityType:function(e,t){if(!e||!t){return}var a=e.getMetaModel();var r=a&&a.getODataEntityContainer();var i=r&&r.entitySet;if(!i||!Array.isArray(i)){return}var s=i.length;for(var n=0;n<s;n++){if(i[n].entityType===t.entityType){return i[n]}}},_getPropertyMapping:function(e,t,a,r,i,s){var n,o;for(n=0;n<e.length;n++){if(e[n].name===t){o=e[n].name;return o}if("P_"+e[n].name===t||e[n].name==="P_"+t){o=e[n].name;return o}}if(!a||!r||!i||!s){return}var l=i.oMetadata._getEntityTypeByName(a);var d=s.oMetadata._getEntityTypeByName(r);if(!l||!d){return}var h="com.sap.vocabularies.Common.v1.SemanticObject";var f="com.sap.vocabularies.Common.v1.SemanticObjectMapping";var g=i.oAnnotations.getData();if(!g||!g.propertyAnnotations){return}var u=g.propertyAnnotations[l.namespace+"."+l.name];var c=s.oAnnotations.getData();if(!c||!c.propertyAnnotations){return}var p=c.propertyAnnotations[d.namespace+"."+d.name];var v=p&&p[t];if(!v||!v[h]){return}var y,m,b,C,F;for(y in u){m=u[y];if(m[h]&&m[h].String===v[h].String){b=m[f];if(!b){continue}C=b.length;F="";while(C--){if(b[C].SemanticObjectProperty.String===t){F=b[C].LocalProperty.PropertyPath;break}}if(F!==""){for(n=0;n<e.length;n++){if(e[n].name===F){o=e[n].name;return o}}}}}return o},_getParametersFromEntityPath:function(e){e=e.split("?")[0];var t=e.match(/\(.*=.*\)/);var a=[];if(!t){return a}var r=t[0].slice(1,-1).trim().split(/\=|\,/);for(var i=0;i<r.length;i=i+2){a.push({name:r[i],sValue:r[i+1]})}return a},_checkRelevantFiltersRecursive:function(e,t,a,r,i,s){if(!t._bMultiFilter){t.sPath=t.sPath.split("/").pop();var n=this._getPropertyMapping(e,t.sPath,a,r,i,s);if(n){t.sPath=n;return t}}else{var o=t.aFilters;var d,h=[];if(o){for(var f=0;f<o.length;f++){d=this._checkRelevantFiltersRecursive(e,o[f],a,r,i,s);if(d){h.push(d)}}if(h.length>0){return new l(h,t.bAnd)}}}},_removeOVPInternalParam:function(e){return e.split("&").filter(function(e){return e.indexOf("_requestFrom")===-1}).join("&")},_getEntityRelevantFilters:function(e,t,a,r){var i=[];if(t.length>0&&e){var s=this.isMacroFilterBar?e.entityType:T.getEntityType(this.getGlobalFilter());var n=this._checkRelevantFiltersRecursive(e.property,t[0],e.name,s,a,r);if(n){i.push(n)}}return i},_checkIsCardValid:function(e,t){var a=e+".Component";var s=a.replace(/\./g,"/");var n=sap.ui.require(s)||t;if(!n){return false}if(n!==r&&!(n.prototype instanceof r||n.prototype instanceof i)){return false}var o=n.prototype.getCustomizing("sap.ui.viewReplacements");if(o&&o["sap.ovp.cards.generic.Card"]){return false}if(n.prototype.createContent!=r.prototype.createContent&&n.prototype.createContent!=i.prototype.createContent){return false}if(n.prototype.getPreprocessors!=r.prototype.getPreprocessors&&n.prototype.getPreprocessors!=i.prototype.getPreprocessors){return false}return true},_createCardComponent:function(e,t,a){var r=e.getModel("@i18n");if(a.template&&this._checkIsCardValid(a.template)){var i={name:a.template,manifest:false,componentData:{model:t,modelName:a.model,i18n:r,cardId:a.id,settings:a.settings,appComponent:this.getOwnerComponent(),mainComponent:this}};var s=this.getGlobalFilter();if(a.errorReason){i.componentData.errorReason=a.errorReason}if(s){i.componentData.globalFilter={getUiState:s.getUiState.bind(s)}}var n=e;this.getOwnerComponent().runAsOwner(function(){_.create(i).then(function(e){var t=e.getComponentData().cardId;var a=n.byId(t);a&&a.setPropagateModel(true);var r=a&&a.getComponentInstance();a.setComponent(e);if(r){setTimeout(function(){r.destroy()},0)}})})}else{N.error("Could not create Card from '"+a.template+"' template. Card is not valid.")}},createNoDataCard:function(e){var t=this._getCardFromManifest(e);if(e&&this.aErrorCards.indexOf(e)===-1){this.aErrorCards.push(e);var a={mParameters:{response:{sTitle:y.getText("CARDS_NODATA_ERROR_PAGE"),sIllustration:"sapIllus-NoEntries",sDescription:y.getText("CARDS_NODATA_ERROR_CONTENT")}}};this.createErrorCard(t,a)}},onCardManage:function(){this.oManageCardsUtils.onManageCardsMenuButtonPress()},createErrorCard:function(e,t){var a=this.getView();var r=a.getModel(e.model);var i=n.isODataV4(r);var s=i?"sap.ovp.cards.v4.error":"sap.ovp.cards.error";var o=S({},e,{template:s});o.errorReason=Object.assign({},t);o.settings.oldTemplate=e.template;o.settings.template=s;this.createCard(o)},observeCardSection:function(e){if(e){this.aObservedCards.push(e);var t=this.getView().byId(e.id).getDomRef()}if(!this._cardIntersectionObserver){this._cardIntersectionObserver=new window.IntersectionObserver(function(e){e.forEach(function(e){if(e.isIntersecting){var t=this.aObservedCards.filter(function(t){var a=this.getView().byId(t.id);return a&&a.getDomRef()===e.target}.bind(this))[0];if(t){this._initCardModel(t.model);this._loadCardComponent(t.template);this._createModelViewMap(t);this.createCard(t);var a=this.getView().byId(t.id).getDomRef();this._cardIntersectionObserver.unobserve(a)}}}.bind(this))}.bind(this),{threshold:0})}if(t){this._cardIntersectionObserver.observe(t)}},createCard:function(e){var t=this.getView();var a=t.getModel(e.model);var r;if(n.isODataV4(a)){r=[a.getMetaModel().requestObject("/"+e.settings.entitySet),this.oGlobalFilterLoadedPromise,this.oLoadedComponents[e.template],this.oLoadedComponents["sap.ovp.cards.v4.error"]]}else{r=[a.getMetaModel().loaded(),this.oGlobalFilterLoadedPromise,this.oLoadedComponents[e.template],this.oLoadedComponents["sap.ovp.cards.error"]]}return Promise.all(r).then(function(){this._createCardComponent(t,a,e)}.bind(this),function(t){N.error("Can't load card with id:'"+e.id+"' and type:'"+e.template+"', reason:"+t)})},_getCardId:function(e){var t=this.getView().getId()+"--";var a="mainView--";if(e.indexOf(t)!=-1){var r=e.indexOf(t)+t.length;return e.substring(r)}if(e.indexOf(a)!==-1){var r=e.indexOf(a)+a.length;return e.substring(r)}return e},_initFlexibilityPersonalization:function(){var e=this.getLayout();var t="sap/ovp/flexibility/changeHandler/PersonalizationChangeHandler";var a=e.getContent();if(a&&a.length){a.push(e);for(var r=0;r<a.length;r++){a[r].addCustomData(new O({key:"sap-ui-custom-settings",value:{"sap.ui.fl":{flexibility:t}}}))}this.oFlexibilityPersonalizationPromise=new Promise(function(e,t){M.waitForChanges({selectors:a}).then(function(){if(this.deltaChanges.length>0){this.bDeltaChangesEnabled=true}e()}.bind(this),function(t){e()})}.bind(this))}},layoutChanged:function(e){var t=e.getParameter("positionChanges");var a=[],r=[];var i,s;if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var n=this.getLayout().dashboardLayoutUtil.dashboardLayoutModel.iColCount;if(t){for(var l=t.length-1;l>=0;l--){i=t[l];s=i.content.cardId;if(i.content.dashboardLayout.oldRow===i.content.dashboardLayout.row&&i.content.dashboardLayout.oldColumn===i.content.dashboardLayout.column&&i.content.dashboardLayout.oldRowSpan===i.content.dashboardLayout.rowSpan&&i.content.dashboardLayout.oldColSpan===i.content.dashboardLayout.colSpan){continue}if(r[s]){r[s].content.dashboardLayout.oldRow=i.content.dashboardLayout.oldRow;continue}r[s]=i}Object.keys(r).forEach(function(e){var t=r[e];if(t.content.dashboardLayout.oldRow===t.content.dashboardLayout.row&&t.content.dashboardLayout.oldColumn===t.content.dashboardLayout.column&&t.content.dashboardLayout.oldRowSpan===t.content.dashboardLayout.rowSpan&&t.content.dashboardLayout.oldColSpan===t.content.dashboardLayout.colSpan){return}a.push(r[e])});a.forEach(function(e){var t=e.content.dashboardLayout;e.content.dashboardLayout={};e.content.dashboardLayout["C"+n]=t})}}else{var d=this.getLayout().getContent();var h=this._getCardArrayAsVariantFormat(d);this.getView().getModel("ui").setProperty("/aOrderedCards",h);a=t}if(a.length>0){o.savePersonalization(a,this.getView())}},saveVariant:function(e){var t=this;this.smartVariandManagement.getVariantsInfo(function(e){var a=null;if(e&&e.length>0){a=e[0].key}var r=a!==null;var i={name:"Personalisation",global:false,overwrite:r,key:a,def:true};t.smartVariandManagement.fireSave(i)})},getLayout:function(){return this.getView()?this.getView().byId("ovpLayout"):null},initShowHideCardsButton:function(){var e=n.getUshellContainer();e.getServiceAsync("Extension").then(function(e){var t={icon:"sap-icon://dimension",id:this.createId("managecards"),text:y.getText("MANAGE_CARDS_TITLE"),tooltip:y.getText("MANAGE_CARDS_TITLE"),press:this.oManageCardsUtils.onManageCardsMenuButtonPress.bind(this.oManageCardsUtils)};var a={controlType:"sap.ushell.ui.launchpad.ActionItem"};e.createUserAction(t,a).then(function(e){e.showForCurrentApp()})}.bind(this))},createOrDestroyCards:function(e,t,a){var r=-1,i=[],s=[];for(var n=0;n<t.length;n++){if(e[n].id==t[n].id){r=n}else{r=this.getCardIndexInArray(e,t[n].id)}var o=this.getView().byId(t[n].id);var l=o.getComponentInstance();if(a){if(l){l.destroy()}}if(t[n].visibility!=e[r].visibility||a){if(t[n].visibility===true){var d=this._getCardFromManifest(t[n].id);i.push({oCard:d,sCreateOrDestroy:"create"});s.push(d)}else if(l){i.push({oCard:l,sCreateOrDestroy:"destroy"})}}}var h=this.fGetViewSwitchIndex(s);if(i&&i.length>0){var f=this.getView().getModel("ui").getProperty("/aOrderedCards");for(var g=0;g<i.length;g++){if(i[g]&&i[g].oCard&&i[g].hasOwnProperty("sCreateOrDestroy")&&i[g].sCreateOrDestroy=="create"){var u=i[g].oCard;if(u){u.settings.baseUrl=this._getBaseUrl();this._clearStoredEntities();this._initCardModel(u.model);u=this._getTemplateForChart(u);this._loadCardComponent(u.template);this._createModelViewMap(u);if(u.settings.tabs){var c=0;var p=[];p.push(u);var v=h&&h.hasOwnProperty(u.id)?h[u.id]:"";var y=this.getOrderedCardsSelectedKey(u.id);if(v&&typeof v=="number"&&v<=u.settings.tabs.length&&v!==y){c=v>=1?v-1:v;this.setOrderedCardsSelectedKey(u.id,v)}else if(f[g].selectedKey&&u.settings.tabs.length>=f[g].selectedKey){c=f[g].selectedKey-1}this.initializeTabbedCard(u,c)}this.createCard(u)}}else if(i[g]&&i[g].oCard&&i[g].hasOwnProperty("sCreateOrDestroy")&&i[g].sCreateOrDestroy=="destroy"){i[g].oCard.destroy()}}}},getCardIndexInArray:function(e,t){for(var a=0;a<e.length;a++){if(e[a].id==t){return a}}return-1},rerenderCards:function(e){var t=this.getView().getModel("ui").getProperty("/aOrderedCards");this.createOrDestroyCards.apply(this,[t,e,false]);this.getView().getModel("ui").setProperty("/aOrderedCards",e);this.updateDashboardLayoutCards(e);this.updateLayoutWithOrderedCards();o.savePersonalization(this.visibilityChanges,this.getView());for(var a=0;a<e.length;a++){var r=e[a];var i=this.aErrorCards.indexOf(r.id);if(i>-1&&r.visibility==false){this.aErrorCards.splice(i,1)}}},isDragAndDropEnabled:function(){return!f.system.phone},getGlobalFilter:function(){if(!this.oGlobalFilter){this.oGlobalFilter=this.getView().byId("ovpGlobalFilter")}return this.oGlobalFilter},getMacroFilterBar:function(){if(!this.oMacroFilterBar){this.oMacroFilterBar=this.getView().byId("ovpGlobalMacroFilter")}return this.oMacroFilterBar},getUIModel:function(){if(!this.oUIModel){var e=this.getOwnerComponent();this.oUIModel=e&&e.getModel("ui")}return this.oUIModel},_parseNavigationVariant:function(){if(!this.oContainer){this.oParseNavigationPromise=Promise.resolve();return}var e=this.oNavigationHandler;this.oParseNavigationPromise=new Promise(function(t,a){return e.parseNavigation().done(function(e,a,r){t([e,a,r])}).fail(function(){a()})})},_setUiStateToGlobalFilter:function(e,t,a){var r=this.getGlobalFilter();var i=new h({selectionVariant:e.toJSONObject()});r.setUiState(i,{replace:a,strictMode:false});t=t.concat(e.getParameterNames().concat(e.getSelectOptionsPropertyNames()));t=t.filter(function(e,t,a){return a.indexOf(e)==t});return t},_processModifyStartupExtension:function(e){if(!e){e=[]}var t=this.getGlobalFilter();var a=t.getUiState();var r=new d(a.getSelectionVariant());var i=JSON.parse(JSON.stringify(r));return new Promise(function(t,a){Promise.all([this.modifyStartupExtension(r),this.templateBaseExtension.provideStartupExtension(r)]).then(function(){if(JSON.stringify(r)!==JSON.stringify(i)){try{e=this._setUiStateToGlobalFilter(r,e,true)}catch(t){N.error("Error with modifyStartupExtension, falling back to default behavior"+t);e=this._setUiStateToGlobalFilter(i,e,true)}}t(e)}.bind(this))}.bind(this))},_addFieldsToSFBAdvancedArea:function(e){var t;var a=this.getGlobalFilter();if(e&&e.length>0){t=e.length;while(t--){a.addFieldToAdvancedArea(e[t])}}},_restoreAppState:function(e){this.restoreCustomAppStateDataExtension(e._CUSTOM);var t=e._EXTENSION;if(!t){return}var a=true;var r=function(e){if(!(e instanceof b)){throw new Error("State must always be retrieved with respect to a ControllerExtension")}var r=e.getMetadata().getNamespace();if(!a){throw new Error("State must always be restored synchronously")}return t[r]};this.templateBaseExtension.restoreExtensionAppStateData(r);a=false},_setNavigationVariantToGlobalFilter:function(e,t,a){return new Promise(function(r,i){var s=this.getGlobalFilter();var n=this.getUIModel()&&this.getUIModel().oData;var o=this.oState&&this.oState.oSmartFilterbar;var l=this.oGlobalFilter&&this.oGlobalFilter.getUiState().getSemanticDates();if(!s){return}switch(a){case"iAppState":if(this.getUIModel()&&this.getUIModel().getProperty("/bRTAActive")){r();break}if(e.selectionVariant){var f=JSON.parse(e.selectionVariant);if(f.SelectionVariantID.length!==0){var g=s.getVariantManagement().getVariantItems().map(function(e){return e.getKey()});var u=f.SelectionVariantID;if(g.indexOf(u)===-1){r();break}}var c,p,v=false;var y,m,b,C;var F,P,S;s.clearVariantSelection();f=JSON.parse(e.selectionVariant);s.setCurrentVariantId(f.SelectionVariantID);P=s.getUiState({allFilters:false});m=P&&JSON.stringify(P.getSelectionVariant());C=s.getFilterData()._CUSTOM;C=typeof C=="undefined"?{}:C;F=new h({selectionVariant:e.oSelectionVariant.toJSONObject(),semanticDates:e.semanticDates});s.setUiState(F,{replace:true,strictMode:false});c=new d(e.selectionVariant);p=c.getParameterNames().concat(c.getSelectOptionsPropertyNames());for(var M=0;M<p.length;M++){s.addFieldToAdvancedArea(p[M])}S=s.getUiState({allFilters:false});y=S&&JSON.stringify(S.getSelectionVariant());if(m!==y){v=true}if(e.customData&&Object.keys(e.customData).length>0){var b=e.customData;this._restoreAppState(b);if(JSON.stringify(C)!==JSON.stringify(b)){v=true}}s.getSmartVariant().currentVariantSetModified(v);s._updateToolbarText()}r();break;case"xAppState":case"URLParams":var O=[];var w=new d(e.oSelectionVariant.toJSONObject());var A=new d(e.oDefaultedSelectionVariant.toJSONObject());if(!e.bNavSelVarHasDefaultsOnly&&!w.isEmpty()){s.clearVariantSelection();s.clear();O=this._setUiStateToGlobalFilter(w,O,true)}if(e.bNavSelVarHasDefaultsOnly&&!A.isEmpty()&&s.getCurrentVariantId()===""){var I=this._mergeDefaultWithSFBVariant(A,new d(JSON.stringify(s.getUiState().getSelectionVariant())));O=this._setUiStateToGlobalFilter(I,O,true)}if(s.getCurrentVariantId()!==""){this._setDisplayCurrency(A)}Promise.resolve(this._processModifyStartupExtension(O)).then(function(a){this._addFieldsToSFBAdvancedArea(a);if(this.oGlobalFilter.isCurrentVariantStandard()&&e.bNavSelVarHasDefaultsOnly!==false&&this.oGlobalFilter.getSmartVariant()){V.setSemanticDateRangeDefaultValue(n,o,l,t||{});this.oGlobalFilter.getSmartVariant().currentVariantSetModified(false)}r()}.bind(this));break;case"initial":Promise.resolve(this._processModifyStartupExtension()).then(function(a){this._addFieldsToSFBAdvancedArea(a);if(this.oGlobalFilter.isCurrentVariantStandard()&&e.bNavSelVarHasDefaultsOnly!==false&&this.oGlobalFilter.getSmartVariant()){V.setSemanticDateRangeDefaultValue(n,o,l,t||{});this.oGlobalFilter.getSmartVariant().currentVariantSetModified(false)}r()}.bind(this));break;default:break}}.bind(this))},_mergeDefaultWithSFBVariant:function(e,t){if(e.isEmpty()){return t}var a=new d;var r,i;[t,e].forEach(function(e){r=e.getSelectOptionsPropertyNames();r.forEach(function(t){a.removeSelectOption(t);if(!a.getParameter(t)){a.massAddSelectOption(t,e.getSelectOption(t))}});i=e.getParameterNames();i.forEach(function(t){a.removeParameter(t);if(!a.getSelectOption(t)){a.addParameter(t,e.getParameter(t))}})});return a},_setDisplayCurrency:function(e){var t=this.getGlobalFilter();if(!t){return}var a,r;var i=t.getAnalyticalParameters();if(i&&i.length>0){a=i.length;while(a--){if(i[a].name==="P_DisplayCurrency"||i[a].name==="DisplayCurrency"){r=i[a];break}}}if(!r){return}var s=t.getFilters([r.fieldName]);var n=s&&s[0]&&s[0].oValue1;if(n&&n!==" "){return}var o,l;if(r.name.indexOf("P_")===0){l=r.name;o=r.name.substr(2)}else{l="P_"+r.name;o=r.name}if(e&&!e.isEmpty()){var f;n=e.getParameter(o);if(!n||n===" "){n=e.getParameter(l)}if(!n||n===" "){f=e.getSelectOption(o);n=f&&f[0]&&f[0].Low}if(!n||n===" "){f=e.getSelectOption(l);n=f&&f[0]&&f[0].Low}}if(!n||n===" "){n=r.defaultPropertyValue}if(!n||n===" "){return}var g=new d;g.addParameter(r.name,n);var u=new h({selectionVariant:g.toJSONObject()});t.setUiState(u,{replace:false,strictMode:false})},_getCustomAppState:function(){var e={},t={};this.getCustomAppStateDataExtension(e);if(!A(e)){t[k]=e}var a;var r=true;var i=function(e,t){if(!(e instanceof b)){throw new Error("State must always be set with respect to a ControllerExtension")}if(!r){throw new Error("State must always be provided synchronously")}if(t){a=a||Object.create(null);var i=e.getMetadata().getNamespace();a[i]=t}};this.templateBaseExtension.provideExtensionAppStateData(i);r=false;if(a){t[j]=a}return t},onBeforeSFBVariantSave:function(){var e=this._getCustomAppState();var t,a=this.getGlobalFilter().getBasicSearchControl();if(a&&a.getValue){t=a.getValue()}var r=Object.keys(e).length;if(r){var i=this.getGlobalFilter().getFilterData();i._CUSTOM=e[k];i._EXTENSION=e[j];this.getGlobalFilter().setFilterData(i,true)}if(t){this.getGlobalFilter().getBasicSearchControl().setValue(t)}if(t||r){this.getGlobalFilter().fireFilterChange()}},onAfterSFBVariantLoad:function(){var e=this.getGlobalFilter().getFilterData();var t=this.getUIModel().getProperty("/enableLiveFilter");if(t){this.getGlobalFilter().fireFilterChange()}if(e){this._restoreAppState(e)}},onAssignedFiltersChanged:function(e){if(e.getSource()&&this.getView().byId("ovpFilterText")){this.getView().byId("ovpFilterText").setText(e.getSource().retrieveFiltersWithValuesAsText())}},_CustomFilterField:function(e,t){for(var a in e){if(e.hasOwnProperty(a)){t[a]=e[a]}}},_storeCurrentAppStateAndAdjustURL:function(e,t){if(this.getUIModel()&&this.getUIModel().getProperty("/bRTAActive")){return}if(e&&!e.oSource._bDirtyViaDialog){return}if(!this.bGlobalFilterLoaded){return}if(!this.oNavigationHandler){return}if(!this.bSkipIAppStateGeneration){var a=function(e){D.oAppStatePromise=null;if(e&&e.length>0){this.oNavigationHandler.replaceHash(e);return}throw"AppState key is empty"};var r=function(e){D.oAppStatePromise=null;if(e==="skip"){throw e}throw"Something went wrong while storing AppState - "+e};D.getCurrentAppStatePromise(t,this).then(a.bind(this),r.bind(this)).catch(function(e){if(e==="skip"){return}})}this.bSkipIAppStateGeneration=false},setTitle:function(e,t,a){var r="";if(e){r=e}else if(t){r=t}else{r=a}return r},onMacroFilterBarSearch:function(e){if(!this.bLoadDataOnMFBSearch){this.bLoadDataOnMFBSearch=true;return}this._collapseHeaderForPage();if(this.fnMacroFilterBarLoaded!==undefined){this.fnMacroFilterBarLoaded();C.loadingState.GLOBALFILTERFILLED=true;this.getView().byId("ovpFilterNotFulfilledPage").setVisible(false);this.bGlobalFilterLoaded=true}this.bGoButtonPressed=true;var t=this.getLayout();if(t){t.setActive(true)}if(this.aErrorCards&&this.aErrorCards.length>0){this.destroyErrorCardsAndReplaceWithOriginal()}this._clearStoredEntities();var a=this.byId("ovpGlobalMacroFilter"),r=a&&a.getFilters()&&a.getFilters().filters;this.aFilters=e&&e.getParameter("filters")||r;var i="ovp-"+(new Date).getTime();for(var s in this.oCardsModels){if(this.oCardsModels.hasOwnProperty(s)&&!n.isODataV4(this.oCardsModels[s])){try{this.oCardsModels[s].refresh(false,false,i)}catch(e){N.warning(e)}}}this.globalEventBus.publish("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",this.aFilters);var o=this.getUIModel().getProperty("/enableLiveFilter");if(!this.bSearchTriggeredManually&&(!this.bInitialMacroFilterBarSearch||!o)){this._storeCurrentAppStateAndAdjustURL()}else{this.bSearchTriggeredManually=false;this.bInitialMacroFilterBarSearch=false}}})});
//# sourceMappingURL=Main.controller.js.map