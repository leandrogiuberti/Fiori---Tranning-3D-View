/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/fe/core/AppComponent","sap/fe/core/buildingBlocks/IBuildingBlockOwnerComponent","sap/fe/navigation/NavigationHandler","sap/base/util/ObjectPath","sap/ui/model/json/JSONModel","sap/ovp/ui/DashboardLayoutUtil","sap/ui/core/mvc/ViewType","sap/ui/model/resource/ResourceModel","sap/ovp/app/resources","sap/ui/core/CustomData","sap/base/util/merge","sap/base/util/isEmptyObject","sap/ovp/app/OVPLogger","sap/ui/Device","sap/ovp/cards/CommonUtils","sap/ovp/placeholder/placeholderHelper","sap/m/App","sap/m/DynamicDateUtil","sap/ovp/cards/MetadataAnalyser","sap/insights/CardHelper","sap/ui/VersionInfo","sap/ui/core/mvc/View","sap/suite/ui/commons/collaboration/CollaborationHelper","sap/ovp/cards/charts/OVPChartFormatter","sap/ovp/insights/CardProvider","sap/ui/core/Lib","sap/ui/base/DesignTime","sap/ui/core/ResizeHandler","sap/ui/rta/RuntimeAuthoring"],function(e,t,i,n,r,a,o,s,l,u,g,p,c,f,d,h,v,y,m,b,C,P,E,T,S,O,F,D,R){"use strict";var w=new c("OVP.app.Component");return e.extend("sap.ovp.app.Component",{metadata:{manifest:"json",routing:{config:{routerClass:"sap.m.routing.Router"},targets:{},routes:[]},interfaces:["sap.fe.core.buildingBlocks.IBuildingBlockOwnerComponent"],properties:{},designtime:{actions:{},tool:{start:function(e){var t=e.getModel("ui");if(t){t.setProperty("/bRTAActive",true)}},stop:function(e){var t=e.getModel("ui");if(t){t.setProperty("/bRTAActive",false)}}},aggregations:{rootControl:{actions:{},propagateMetadata:function(){return{}}}}},version:"1.141.0",library:"sap.ovp.app",dependencies:{libs:["sap.ovp"],components:[]},config:{fullWidth:true,hideLightBackground:true}},onServicesStarted:function(){if(E&&E.processAndExpandHash&&typeof E.processAndExpandHash==="function"){E.processAndExpandHash().catch(function(e){w.error(e)}).finally(function(){this._createContent()}.bind(this))}else{this._createContent()}},getRoutingService:function(){return{beforeExit:function(){}}},getDashboardLayoutUtil:function(){return this.oDashboardLayoutUtil},_getOvpCardOriginalConfig:function(e){var t=this.getOvpConfig();return t.cards[e]},suspend:function(){if(this.ovpConfig.bInsightRTEnabled){S.unregisterProvider(this.getId())}var e=this.createId("mainView"),t=this.byId(e);var i=t.getController();var n=i.getLayout().resizeHandlerId;if(n){D.deregister(n)}},isCollaborationManagerServiceEnabled:function(){return false},restore:function(){var e=this.ovpConfig.cards,t=this.createId("mainView"),n=this.byId(t);var r=this.ovpConfig.refreshStrategyOnAppRestore&&this.ovpConfig.refreshStrategyOnAppRestore.entitySets;var a=n.getController();var o=new i(a,"ODataV2");d.enable(a,o);if(a.isDragAndDropEnabled()){var s=d.getUshellContainer();if(s){a.initShowHideCardsButton()}}if(typeof r==="object"){var l=Object.keys(r);var u=e.filter(function(e){return l.includes(e.settings.entitySet)});for(var g=0;g<u.length;g++){var p=u[g];var c=n.createId(p.id);var f=this.byId(c);var h=f.getComponentInstance()&&f.getComponentInstance().getRootControl()&&f.getComponentInstance().getRootControl().getController();if(h){h.refreshCardContent()}}}T.registerCustomFormatters();if(this.ovpConfig.bInsightRTEnabled){var v=this.getManifestEntry("sap.app").id,y=this.getManifestObject().getRawJson(),m=y["sap.fiori"]&&y["sap.fiori"].registrationIds&&y["sap.fiori"].registrationIds[0]||v;e.forEach(function(e){var t=n.createId(e.id),i=this.byId(t),r=i.getComponentInstance()&&i.getComponentInstance().getRootControl()&&i.getComponentInstance().getRootControl().getController(),a=r&&r.getView()&&r.getView().getModel("ovpCardProperties");S.addInsightCard(a,m)}.bind(this));S.init(this.getId())}a.applyFiltersForCustomCards();if(a.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){a.getLayout().initResizeHandler()}else{var b=a.getLayout().getColumnResolutionList();a.getLayout().initResizeHandlerOrMediaListeners(b)}},getOvpConfig:function(){var e;var t=[];var i=this.getMetadata();while(i&&i.getComponentName()!=="sap.ovp.app"){e=this.getManifestEntry("sap.ovp");if(e){t.unshift(e)}i=i.getParent()}t.unshift({});t.unshift(true);e=g.apply(g,t);return e},_removeExtraArrayElements:function(e,t){var i=e["staticContent"],n=t["staticContent"],r=e["tabs"],a=t["tabs"];if(i&&n){if(i.length>n.length){e["staticContent"].splice(n.length,i.length-n.length)}}if(r&&a){if(r.length>a.length){e["tabs"].splice(a.length,r.length-a.length)}}},_emptyAllArrayElements:function(e,t){var i=e["staticContent"],n=t["staticContent"],r=e["tabs"],a=t["tabs"];if(i&&n){for(var o=0;o<i.length;o++){e["staticContent"][o]={}}}if(r&&a){for(var o=0;o<r.length;o++){e["tabs"][o]={}}}},_mergeObjects:function(e,t){for(var i in t){if(t.hasOwnProperty(i)){var n=t[i];if(typeof n=="object"&&e[i]){if(n.operation==="DELETE"){delete e[i]}else{this._mergeObjects(e[i],n)}}else{if(typeof n=="object"&&!e[i]&&n.operation==="DELETE"){continue}e[i]=n}}}return e},_mergeLayerObject:function(e,t){if(!e[t+".settings"]){return e}var i=g({},e["settings"]),n=g({},e[t+".settings"]);this._removeExtraArrayElements(i,n);this._emptyAllArrayElements(i,n);e["settings"]=this._mergeObjects(i,n);return e},_mergeKeyUserChanges:function(e){if(!e.hasOwnProperty("customer.settings")&&!e.hasOwnProperty("customer_base.settings")&&!e.hasOwnProperty("vendor.settings")){return e}e=this._mergeLayerObject(e,"vendor");e=this._mergeLayerObject(e,"customer_base");e=this._mergeLayerObject(e,"customer");return e},_getFullyQualifiedNameForEntity:function(e,t){var i="",n;if(!e){return""}if(e.indexOf(".")>-1){return e}var r=t.getMetaModel();if(d.isODataV4(t)){var a=r.getObject("/");var o=a[e];i=o.$Type;return i}else{var s=r&&r.getODataEntityContainer();i=s&&s.namespace;if(i&&!(e.indexOf(i)>-1)){n=i+"."+e}else{n=e}return n}},_getDatePropertiesFromEntitySet:function(e,t,i){var n=[],r=[];var a=e.getMetaModel();var o=a&&a.getODataEntityContainer();var s=o.entitySet.filter(function(e){return e.entityType===i});var l=s.length>0?s[0]:{};var u=m.checkAnalyticalParameterisedEntitySet(e,l.name);if(u){var g=m.getParametersByEntitySet(e,l.name);if(g.entitySetName){n=m.getPropertyOfEntitySet(e,g.entitySetName);n.forEach(function(e){e._filterRestriction="single-value"})}}n=n.concat(t.property);for(var c in n){var f={};if(d.isDate(n[c])){f.PropertyPath=n[c].name}if(!p(f)){r.push(f)}}return r},_getAllControlConfiguration:function(e,t,i){for(var n=0;n<e.length;n++){if(i[e[n].PropertyPath]){var r=false;for(var a=0;a<t.length;a++){if(t[a].PropertyPath===e[n].PropertyPath){r=true}}if(!r){e[n].bNotPartOfSelectionField=true;t.push(e[n])}}}return t},_getSettingsForDateProperties:function(e,t){var i={};for(var n in e){if(t.fields&&t.fields[e[n].PropertyPath]){i[e[n].PropertyPath]=this.getConditionTypeForDateSetting(t.fields[e[n].PropertyPath])}else{if(t.customDateRangeImplementation||t.filter||t.selectedValues){i[e[n].PropertyPath]=this.getConditionTypeForDateSetting(t)}}}return i},getConditionTypeForDateSetting:function(e){if(e.customDateRangeImplementation){return{customDateRangeImplementation:e.customDateRangeImplementation}}else if(e.filter){return{filter:e.filter}}else if(e.selectedValues){return{selectedValues:e.selectedValues,exclude:e.exclude!==undefined?e.exclude:true}}else if(e.defaultValue){return{defaultValue:e.defaultValue}}return undefined},getEntitySetFromEntityType:function(e,t,i){if(i){var n=e.getObject("/")||{},r=Object.keys(n),a=r.filter(function(e){return t===(n[e]&&n[e]["$Type"])});return a&&a[0]||""}else{var n=e&&e.getODataEntityContainer(),o=n&&n.entitySet||[],a=o.filter(function(e){return t===(e&&e.entityType)}).map(function(e){return e&&e.name});return a&&a[0]||""}},getViewSettings:function(e){if(this.getRouter()){this.getRouter().initialize()}var t=this.getManifestEntry("sap.app");var i=this.getManifestEntry("sap.ui");var s=n.get("icons.icon",i);var l=this.getModel(e.globalFilterModel);var c=l&&l.getMetaModel();this.setModel(l);var h=this.getMetadata().getComponentName();var v=h.replace(/\./g,"/");e.baseUrl=sap.ui.require.toUrl(v);e.useMacroFilterBar=l?d.isODataV4(l):false;if(e.smartVariantRequired===undefined||e.smartVariantRequired===null){e.smartVariantRequired=true}if(e.enableLiveFilter===undefined||e.enableLiveFilter===null){e.enableLiveFilter=true}if(e.showDateInRelativeFormat===undefined||e.showDateInRelativeFormat===null){e.showDateInRelativeFormat=true}if(e.filterSettings&&e.filterSettings.dateSettings&&e.filterSettings.dateSettings.useDateRange!==undefined&&e.useDateRangeType!==undefined){throw new Error("Defining both useDateRange and useDateRangeType in the manifest is not allowed")}e.useDateRangeType=e.filterSettings&&e.filterSettings.dateSettings&&e.filterSettings.dateSettings.useDateRange!==undefined?e.filterSettings.dateSettings.useDateRange:e.useDateRangeType;if(e.useDateRangeType===undefined||e.useDateRangeType===null){e.useDateRangeType=false}if(e.bHeaderExpanded===undefined||e.bHeaderExpanded===null){e.bHeaderExpanded=f.system.desktop?true:false}if(e.chartSettings===undefined||e.chartSettings===null){e.chartSettings={}}if(e.chartSettings.showDataLabel===undefined||e.chartSettings.showDataLabel===null){e.chartSettings.showDataLabel=false}if(e.globalFilterEntitySet&&e.globalFilterEntitySet!==" "){var m=d.isODataV4(l);if(c){var b=m?c.getObject("/"+e.globalFilterEntitySet):c.getODataEntitySet(e.globalFilterEntitySet);if(b){e.globalFilterEntityType=m?b.$Type:b.entityType}}}var C=e.globalFilterEntitySet?e.globalFilterEntitySet:e.globalFilterEntityType;if(e.globalFilterEntityType&&e.globalFilterEntityType!==" "&&e.globalFilterEntityType.length>0){e.globalFilterEntityType=this._getFullyQualifiedNameForEntity(e.globalFilterEntityType,l);e.globalFilterEntityTypeNQ=e.globalFilterEntityType.split(".").pop()}var P=new r(e);var E=R.willRTAStartAfterReload();P.setProperty("/bRTAActive",E);P.setProperty("/applicationId",n.get("id",t));P.setProperty("/title",n.get("title",t));P.setProperty("/description",n.get("description",t));if(e.globalFilterEntityType){var T,S;if(!e.globalFilterEntitySet){e.globalFilterEntitySet=this.getEntitySetFromEntityType(c,e.globalFilterEntityType,d.isODataV4(l))}if(d.isODataV4(l)){T=c.getObject("/"+e.globalFilterEntityType+"@com.sap.vocabularies.UI.v1.SelectionFields");S=c.getObject("/"+e.globalFilterEntityType);P.setProperty("/mainEntityVersion","ODataV4")}else{S=c.getODataEntityType(e.globalFilterEntityType);T=g([],S["com.sap.vocabularies.UI.v1.SelectionFields"]);P.setProperty("/mainEntityVersion","ODataV2");if(e.filterSettings&&e.filterSettings.dateSettings){var O=this._getDatePropertiesFromEntitySet(l,S,e.globalFilterEntityType);var F=this._getSettingsForDateProperties(O,e.filterSettings.dateSettings);if(P.getProperty("/useDateRangeType")&&F&&!p(F)){P.setProperty("/useDateRangeType",false);O.forEach(function(e){if(!F.hasOwnProperty(e["PropertyPath"])||!F[e["PropertyPath"]]){var t=e["PropertyPath"];F[t]={selectedValues:y.getAllOptionKeys().toString(),exclude:false}}})}T=this._getAllControlConfiguration(O,T,F);P.setProperty("/datePropertiesSettings",F)}}P.setProperty("/allControlConfiguration",T);P.setProperty("/mainEntityType",S)}if(s){if(s.indexOf("sap-icon")<0&&s.charAt(0)!=="/"){s=e.baseUrl+"/"+s}P.setProperty("/icon",s)}var D=e.cards;var w=[];var M;for(var _ in D){if(D.hasOwnProperty(_)&&D[_]){M=this._mergeKeyUserChanges(D[_]);M.id=_;w.push(M)}}w.sort(function(e,t){if(e.id<t.id){return-1}else if(e.id>t.id){return 1}else{return 0}});P.setProperty("/cards",w);if(this.inResizableTestMode()===true){e.containerLayout="resizable"}if(e.containerLayout&&e.containerLayout==="resizable"){P.setProperty("/cardContainerFragment","sap.ovp.app.DashboardCardContainer");P.setProperty("/dashboardLayout",e.resizableLayout);var A=new a(P);this.oDashboardLayoutUtil=A}else{P.setProperty("/cardContainerFragment","sap.ovp.app.CardContainer")}this.setModel(P,"ui");var I=this._getOvpLibResourceBundle();this.setModel(I,"ovplibResourceBundle");this.setModel(I,"sap.fe.i18n");var S;if(d.isODataV4(l)){S="/"+e.globalFilterEntityType}else{S=c&&c.getODataEntityType(e.globalFilterEntityType,true)}var V=this.createId("mainView");var L=new r({});return{id:V,height:"100%",preprocessors:{xml:{bindingContexts:{ui:P.createBindingContext("/"),meta:c.createBindingContext(S),contextPath:c.createBindingContext("/"+C),entitySet:C,converterContext:L.createBindingContext("/")},models:{ui:P,meta:c,contextPath:c,metaModel:c,converterContext:L},appComponent:this}},type:o.XML,viewName:"sap.ovp.app.Main",async:true,customData:[new u({key:"sap-ui-custom-settings",value:{"sap.ui.dt":{designtime:"sap/ovp/ui/OVPWrapper.designtime"}}})]}},_showErrorPage:function(){var e=this._getOvpLibResourceBundle();P.create({height:"100%",type:o.XML,viewName:"sap.ovp.app.Error"}).then(function(t){t.setModel(e,"ovplibResourceBundle");this.setAggregation("rootControl",t);if(this.oContainer){this.oContainer.invalidate()}}.bind(this))},_formParamString:function(e){var t=Object.keys(e);var i;var n="?";for(i=0;i<t.length;i++){n=n+t[i]+"="+e[t[i]]+"&"}return n.slice(0,-1)},_checkForAuthorizationForCards:function(e){var t=F.isDesignModeEnabled();if(t){return Promise.resolve(e)}var i=[];var n=[];for(var r in e.cards){var a=e.cards[r];if(a&&a.settings&&a.settings.requireAppAuthorization){n.push(r);i.push({target:{shellHash:a.settings.requireAppAuthorization}})}}var o=d.getUshellContainer();if(i.length>0&&o){return o.getServiceAsync("Navigation").then(function(e){return e.isNavigationSupported(i)}).then(function(t){var i=n.filter(function(e,i){if(!t[i].supported){return e}});for(var r=0;r<i.length;r++){for(var a in e.cards){if(i[r]===a){delete e.cards[a];break}}}return Promise.resolve(e)}).catch(function(e){w.error(e);return Promise.reject(e)})}else{return Promise.resolve(e)}},_checkForAuthorizationForLineItems:function(){return new Promise(function(e,t){var i=[],n=[],r=[];var a=this.getOvpConfig();var o=a["cards"];for(var s in o){if(o.hasOwnProperty(s)&&o[s]){var l=o[s];var u=l.settings;if((l.template==="sap.ovp.cards.linklist"||l.template==="sap.ovp.cards.v4.linklist")&&u.listFlavor==="standard"&&u.staticContent){var g=u.staticContent;for(var p=0;p<g.length;p++){if(g[p].semanticObject||g[p].action){var c="#"+g[p].semanticObject+"-"+g[p].action;if(g[p].params){var f=this._formParamString(g[p].params);c=c+f}if(n.indexOf(s)===-1){n.push(s)}if(i.indexOf(c)===-1){i.push(c);r.push({target:{shellHash:c}})}}}}}}var h=d.getUshellContainer();if(h){return h.getServiceAsync("Navigation").then(function(t){t.isNavigationSupported(r).then(function(t){var r=this.getOvpConfig();this._aCardsWithStaticContent=n;for(var a=0;a<t.length;a++){if(t[a].supported===false&&this._aCardsWithStaticContent){for(var o=0;o<this._aCardsWithStaticContent.length;o++){var s=r["cards"][this._aCardsWithStaticContent[o]].settings.staticContent;for(var l=s.length-1;l>=0;l--){var u="#"+s[l].semanticObject+"-"+s[l].action;if(s[l].params){var g=this._formParamString(s[l].params);u=u+g}if(i[a]===u){s.splice(l,1)}}r["cards"][this._aCardsWithStaticContent[o]].settings.staticContent=s}}}delete this._aCardsWithStaticContent;e(r)}.bind(this)).catch(function(e){w.error(e);return Promise.reject(e)})}.bind(this))}else{e(a)}}.bind(this))},createContent:function(){},_createContent:function(){var e=this.getOvpConfig();var t=this.getModel(e.globalFilterModel);var i=d.isODataV4(t);var n=[this._checkForAuthorizationForLineItems(e),l.pResourcePromise,this._isInsightRTEnabled(),C.load({library:"sap.ui.core"}),this._isTeamsModeActive()];if(i){n.unshift(t&&t.getMetaModel().requestObject("/"+e.globalFilterModel))}else{n.unshift(t&&t.getMetaModel().loaded())}if(t&&!this.getAggregation("rootControl")){Promise.all(n).then(function(e){var t=e[3];this.ovpConfig=e[1];this.ovpConfig.sapUICoreVersionInfo=e[4];this.ovpConfig.isTeamsModeActive=e[5];this.ovpConfig.enableV4Insight=this._isInsightEnabledForV4Cards();if(this._isInsightDTEnabled()){this.ovpConfig.bInsightDTEnabled=true;return Promise.resolve(this.ovpConfig)}else{this.ovpConfig.bInsightRTEnabled=t?true:false;return this._checkForAuthorizationForCards(this.ovpConfig)}}.bind(this)).then(function(e){this.oOvpConfig=e;if(i){this.oMacrosLoaded=O.load({name:"sap.fe.macros"});this.oMacrosLoaded.then(function(){w.info("FE Macros loaded successfully");this.runCreateViewAsOwner()}.bind(this)).catch(function(e){w.error("Error while loading sap.fe.macros",e)})}else{this.runCreateViewAsOwner()}}.bind(this));if(!i){t.attachMetadataFailed(function(){this._showErrorPage()}.bind(this))}}},runCreateViewAsOwner:function(){this.runAsOwner(function(){this.createView()}.bind(this))},createView:function(){var e=this.createId("host"),t=new v(e),i=this.getViewSettings(this.oOvpConfig);P.create(i).then(function(e){e.bindElement({path:"/",model:"internal"});var i=new r({});e.setModel(i,"viewData");e.setModel(new r(e),"$view");if(h.isPlaceHolderEnabled()){t.addPage(e);this.setAggregation("rootControl",t);h.showPlaceholder(t)}else{this.setAggregation("rootControl",e)}this.oContainer.invalidate()}.bind(this)).catch(function(e){w.error("Error during view creation"+e)})},_getOvpLibResourceBundle:function(){if(!this.ovplibResourceBundle){var e=O.getResourceBundleFor("sap.ovp");this.ovplibResourceBundle=e?new s({bundleUrl:e.oUrlInfo.url,bundle:e}):null}return this.ovplibResourceBundle},createMapForEntityContainer:function(e){var t={};var i=e.entitySet;for(var n=0;n<i.length;n++){t[i[n].name]=i[n].entityType}return t},inResizableTestMode:function(){return this._getQueryParamUpToTop("resizableTest")=="true"},inLazyLoadingTestMode:function(){return this._getQueryParamUpToTop("sap-ovp-xx-lazyloadingtest")=="true"||this._getQueryParamUpToTop("sap-fe-xx-lazyloadingtest")=="true"},_isInsightEnabledForV4Cards:function(){return this._getQueryParamUpToTop("enable-v4-insight")==="true"},_isInsightDTEnabled:function(){return this._getQueryParamUpToTop("mode")==="myInsight"||this._getQueryParamUpToTop("mode")==="DT"},_isInsightRTEnabled:function(){var e=this._getQueryParamUpToTop("mode")==="RT";return new Promise(function(t,i){if(!b||!b.getServiceAsync){t(e);return}return b.getServiceAsync().then(function(i){t(!!i||e)}).catch(function(i){w.info("Failed to get CardHelperServiceInstance."+i);t(e)})})},_isTeamsModeActive:function(){var e=false;return new Promise(function(t,i){if(E&&E.isTeamsModeActive&&typeof E.isTeamsModeActive==="function"){return E.isTeamsModeActive().then(function(t){e=t}).catch(function(e){w.error("Failed to get Collaboration Helper."+e)}).finally(function(){t(e)})}else{t(e)}})},_getQueryParamUpToTop:function(e){var t=window;var i=this.getQueryParam(t.location.search,e);if(i!=null){return i}if(t==t.parent){return null}t=t.parent;return null},getQueryParam:function(e,t){var i=null;if(!e){return i}if(e.indexOf("?")!=-1){e=e.substring(e.indexOf("?"))}if(e.length>1&&e.indexOf(t)!=-1){e=e.substring(1);var n=e.split("&");for(var r=0;r<n.length;r++){var a=n[r].split("=");if(a[0]==t){i=a[1];break}}}return i},getAppComponent:function(){return this},getRootController:function(){return undefined},getFullContextPath:function(){return undefined},getMetaModel:function(e){var t=this.getModel(e);if(t){return t.getMetaModel()}}})});
//# sourceMappingURL=Component.js.map