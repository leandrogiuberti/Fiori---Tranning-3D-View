/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/model/json/JSONModel","sap/ui/fl/write/api/ControlPersonalizationWriteAPI","sap/ui/core/Fragment","sap/ovp/cards/PersonalizationUtils","sap/ovp/cards/CommonUtils"],function(a,e,r,t,i,s){"use strict";return a.extend("sap.ovp.app.ManageCardsUtils",{constructor:function(a){if(!a){throw new Error("Main Controller is required to initialize ManageCardsUtil")}},onManageCardsMenuButtonPress:function(){this.aManageCardsDialogModelState=[];var a=s.getApp();var n=this;var d={onManageCardOkButtonPressed:function(e){if(e.getParameters().reason==="Ok"){var r=a.byId("manageCardsSelectionPanel").getP13nData();var t=a.getUIModel().getProperty("/aOrderedCards");var s=[];var d=r.length;for(var o=0;o<d;o++){if(r[o].visible!==t[o].visible){s.push({changeType:"visibility",content:{cardId:r[o].id,visibility:r[o].visible},isUserDependent:true})}r[o].visibility=r[o].visible}a.createOrDestroyCards.apply(a,[n.aManageCardsDialogModelState,r,false]);a.getUIModel().setProperty("/aOrderedCards",r);a.updateDashboardLayoutCards(r);var l=a.getOwnerComponent().oOvpConfig,g=l&&l.bInsightRTEnabled;if(g){a.updateCardVisibiltyForCM(r)}a.updateLayoutWithOrderedCards();i.savePersonalization(s,a.getView());for(var o=0;o<r.length;o++){var v=r[o];var u=a.aErrorCards.indexOf(v.id);if(u>-1&&v.visibility==false){a.aErrorCards.splice(u,1)}}if(document.querySelector(".sapFAvatar")){document.querySelector(".sapFAvatar").focus()}}var p=a.byId("manageCardsSelectionPanel");var f=a.byId("manageCardsDialog");if(p&&f){p.destroy();f.destroy()}},onManageCardResetButtonPressed:function(){var e=a.getLayout().getMetadata().getName();var t=a.getUIModel();var i=t.getProperty("/aOrderedCards");a.aErrorCards=[];var s=a.aManifestOrderedCards;a.createOrDestroyCards.apply(a,[i,s,e==="sap.ovp.ui.DashboardLayout"?true:false]);var d=a.getAllowedNumberOfCards();var o=d&&d.numberOfCards;var l=s.filter(function(a){return a.visibility===true});if(o&&l.length>o){for(var g=o;g<s.length;g++){s[g].visibility=false}}t.setProperty("/aOrderedCards",s);a.resetDashboardLayout();a.updateDashboardLayoutCards(s);a.updateLayoutWithOrderedCards();n.manageCardsDialog.getModel().setProperty("/cards",s);var v=[];for(var g=0;g<i.length;g++){v.push(a.getView().byId(i[g].id))}var u=n.enhanceOrderedCardsForP13NDialog(i);var p=a.byId("manageCardsSelectionPanel");p.setP13nData(u);if(d){n.setMsgStripAndOkButton(p,a)}r.reset({selectors:v}).finally(function(){if(document.querySelector(".sapFAvatar")){document.querySelector(".sapFAvatar").focus()}})},onCardVisibilityChange:function(){var e=a.byId("manageCardsSelectionPanel");var r=a.getAllowedNumberOfCards();if(r){n.setMsgStripAndOkButton(e,a)}}};this._oManageCardsFragmentController=d;this.oManageCardsFragment=t.load({id:a.getView().getId(),name:"sap.ovp.app.ManageCard",controller:d}).then(function(r){n.manageCardsDialog=r;var t=a.getUIModel().getProperty("/aOrderedCards");var i=Object.assign([],t);n.aManageCardsDialogModelState=n.getManageCardsDialogModelState(t);var s=new e({cards:i});n.manageCardsDialog.setModel(s);a.getView().addDependent(n.manageCardsDialog);n.openManageCardsDialog(t)})},openManageCardsDialog:function(a){var e=s.getApp();var r=this.enhanceOrderedCardsForP13NDialog(a);var t=e.byId("manageCardsDialog");var i=e.byId("manageCardsSelectionPanel");i.setP13nData(r);var n=this.getAllowedNumberOfCardsAndSetMessageStripText(e);var d=a.filter(function(a){return a.visibility===true});var o=e.byId("manageCardsPanelWarningMessage");if(n&&a.length>=n&&d.length>=n){o.setVisible(true)}t.open()},enhanceOrderedCardsForP13NDialog:function(a){var e=[];var r=s.getApp();a.forEach(function(a){e.push(a["id"])});var t=r._getCardsModel();var i=[];var n=r.getLayout().getMetadata().getName();if(n==="sap.ovp.ui.DashboardLayout"){var d=r._getCardArrayAsVariantFormatDashboard();d.forEach(function(a){var r=t.find(function(e){return e.id===a.id});var n=s.getUpdatedTitle(a.id);if(e.indexOf(a.id)!=-1){i.push({id:a.id,visibility:a.visibility,visible:a.visibility,name:a.id,label:n||r.settings.title})}});a=i}else if(n==="sap.ovp.ui.EasyScanLayout"){var o=r.getLayout().getContent();var t=r._getCardsModel();o.forEach(function(a){var r=a.getId();var n=r.split("--").pop();var d=t.find(function(a){return a.id===n});var o=s.getUpdatedTitle(n);if(e.indexOf(n)!=-1){i.push({id:n,visibility:a.getVisible(),visible:a.getVisible(),name:n,label:o||d.settings.title})}});a=i}this.aManageCardsDialogModelState=this.getManageCardsDialogModelState(a);r.getUIModel().setProperty("/aOrderedCards",a);this.manageCardsDialog.getModel().setProperty("/cards",a);return a},getManageCardsDialogModelState:function(a){var e=[];for(var r=0;r<a.length;r++){e.push({id:a[r].id,visibility:a[r].visibility})}return e},getAllowedNumberOfCardsAndSetMessageStripText:function(a){var e=a.getAllowedNumberOfCards();var r=e&&e.numberOfCards;var t=e&&e.errorMessage;var i=a.byId("manageCardsPanelWarningMessage");i.setText(t);i.setVisible(false);return r},setMsgStripAndOkButton:function(a,e){var r=a.getSelectedFields().length;var t=this.getAllowedNumberOfCardsAndSetMessageStripText(e);var i=e.byId("manageCardsPanelWarningMessage");var s=e.byId("manageCardsDialog").sId;var n=e.byId(s+"-confirmBtn");n.setEnabled(true);if(t&&r>=t){i.setVisible(true)}if(t&&r>t){n.setEnabled(false)}}})});
//# sourceMappingURL=ManageCardsUtils.js.map