/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ovp/cards/Filterhelper","sap/ovp/app/FilterHelper","sap/ovp/app/OVPLogger","sap/ui/base/SyncPromise","sap/ui/model/FilterOperator","sap/ui/model/Filter"],function(e,t,r,a,i,n){"use strict";var l=new r("sap.ovp.filter.filterUtils");var o={applyFiltersToV2Card:function(e,r){var a=r.getEntityType(),i=r.oMainComponent.getMacroFilterBar()||r.oMainComponent.getGlobalFilter(),n=i&&i.getModel(),o=r.getView().getModel("ovpCardProperties"),s=o&&o.getProperty("/entityType"),p=s&&s.name;if(a&&n&&p){var g=t.getEntityRelevantFilters(a,e,p,n);var d=t.mergeFilters(g,r.selectionVaraintFilter,o);try{var c=r.getCardItemsBinding();if(c){c.filter(d)}if(r.getKPIBinding()){r.getKPIBinding().filter(d)}if(r.getSubTitleBinding()){r.getSubTitleBinding().filter(d)}}catch(e){l.error(e)}}},getFiltersForV2CustomCard:function(e,r){var a=r.getEntityType(),i=r.oMainComponent.getMacroFilterBar()||r.oMainComponent.getGlobalFilter(),l=i&&i.getModel(),o=r.getView().getModel("ovpCardProperties"),s=o&&o.getProperty("/entityType"),p=s&&s.name;var g=new n;if(a&&l&&p){var d=t.getEntityRelevantFilters(a,e,p,l);g=t.mergeFilters(d,r.selectionVaraintFilter,o)}return g},applyFiltersToV4Card:function(t,r){if(r.getView().getModel().getMetaModel().getData){var a=r.getView().getModel().getMetaModel().getData();var i=r.getView().getModel("ovpCardProperties");var n=i.getProperty("/entityType");var o=n&&n["$Type"];if(o){var s=e._getEntityRelevantFilters(a[o],t);s=e.mergeFilters(s,r.selectionVaraintFilter,i);try{r.getCardItemsBinding().filter(s);if(r.getKPIBinding()){r.getKPIBinding().filter(s)}if(r.getSubTitleBinding()){r.getSubTitleBinding().filter(s)}}catch(e){l.error(e)}}}},applyFiltersToV4AnalyticalCard:function(t,r){if(r.getView().getModel().getMetaModel().getData){var a=r.getView().getModel().getMetaModel().getData();var i=r.getView().getModel("ovpCardProperties");var n=i.getData().entityType.$Type;var o=e._getEntityRelevantFilters(a[n],t);o=e.mergeFilters(o,r.selectionVaraintFilter,i);var s=r.getCardItemsBinding();var p=s&&s.mParameters&&s.mParameters.$apply;var g=p&&p.split("/").length||0;try{if(o&&o.aFilters){this.fetchFilter(o,s,{}).then(function(e){var t=g>1?p.split("/")[g-1]:p.split("/")[0];s.changeParameters({$apply:"filter("+e+")/"+t})}).catch(function(e){l.error(e)})}else{if(g>1){s.changeParameters({$apply:p.split("/")[g-1]})}}if(r.getKPIBinding()){r.getKPIBinding().filter(o)}if(r.getSubTitleBinding()){r.getSubTitleBinding().filter(o)}}catch(e){l.error(e)}}},fetchFilter:function(e,t,r,n){var l;var o=t.oModel.getMetaModel();var s=o.getMetaContext(t.oModel.resolve(t.sPath,t.oContext));if(!e){return a.resolve()}if(e.aFilters){return a.all(e.aFilters.map(function(a){return this.fetchFilter(a,t,r,e.bAnd)},this)).then(function(t){return this.wrap(t.join(e.bAnd?" and ":" or "),n&&!e.bAnd)}.bind(this))}l=o.resolve(this.replaceLambdaVariables(e.sPath,r),s);return o.fetchObject(l).then(function(t){var a,o,s;if(!t){throw new Error("Type cannot be determined, no metadata for path: "+l)}s=e.sOperator;if(s===i.All||s===i.Any){a=e.oCondition;o=e.sVariable;if(s===i.Any&&!a){return e.sPath+"/any()"}r=Object.create(r);r[o]=this.replaceLambdaVariables(e.sPath,r);return this.fetchFilter(a,r).then(function(t){return e.sPath+"/"+e.sOperator.toLowerCase()+"("+o+":"+t+")"})}return this.getSingleFilterValue(e,t.$Type,n)}.bind(this))},wrap:function(e,t){return t?"("+e+")":e},replaceLambdaVariables:function(e,t){var r=e.split("/");r[0]=t[r[0]];return r[0]?r.join("/"):e},getSingleFilterValue:function(t,r,a){var n,l,o,s;function p(e){return o?"tolower("+e+")":e}o=r==="Edm.String"&&t.bCaseSensitive===false;l=p(decodeURIComponent(t.sPath));s=p(e.formatLiteral(t.oValue1,r));switch(t.sOperator){case i.BT:n=l+" ge "+s+" and "+l+" le "+p(e.formatLiteral(t.oValue2,r));break;case i.NB:n=this.wrap(l+" lt "+s+" or "+l+" gt "+p(e.formatLiteral(t.oValue2,r)),a);break;case i.EQ:case i.GE:case i.GT:case i.LE:case i.LT:case i.NE:n=l+" "+t.sOperator.toLowerCase()+" "+s;break;case i.Contains:case i.EndsWith:case i.NotContains:case i.NotEndsWith:case i.NotStartsWith:case i.StartsWith:n=t.sOperator.toLowerCase().replace("not","not ")+"("+l+","+s+")";break;default:throw new Error("Unsupported operator: "+t.sOperator)}return n}};return{applyFiltersToV2Card:o.applyFiltersToV2Card,getFiltersForV2CustomCard:o.getFiltersForV2CustomCard,applyFiltersToV4Card:o.applyFiltersToV4Card,applyFiltersToV4AnalyticalCard:o.applyFiltersToV4AnalyticalCard,fetchFilter:o.fetchFilter,wrap:o.wrap,replaceLambdaVariables:o.replaceLambdaVariables,getSingleFilterValue:o.getSingleFilterValue}});
//# sourceMappingURL=FilterUtils.js.map