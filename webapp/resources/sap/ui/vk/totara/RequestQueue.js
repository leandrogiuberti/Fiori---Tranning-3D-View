/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./TotaraUtils","./Command"],function(t,e){"use strict";function i(t){this.getBatchSize=t;this.globalList=new Set;this.waitingList=new Map;this.requestedList=new Set}i.prototype.push=function(t,e){if(this.globalList.has(t)){return false}this.globalList.add(t);this.waitingList.set(t,e);this.requestedList.add(t);return true};i.prototype.setBatchSizeInfo=function(t){this.batchSizeInfo=t};i.prototype.fetchBatch=function(){var t=this.getBatchSize?this.getBatchSize:1;if(typeof this.getBatchSize==="function"){t=this.getBatchSize()}var e=this.batchSizeInfo;var i=e?e.maxBatchStringLength:Number.MAX_SAFE_INTEGER;var s=e?e.separatorLength:0;var n=[];var a=0;var r=this.requestedList.keys();var h=r.next();for(var o=0;o<t&&!h.done;o++,h=r.next()){var c=h.value;a+=c.toString().length+(o==0?0:s);if(a>i){break}this.requestedList.delete(c);n.push(c)}return n};i.prototype.pop=function(t){this.requestedList.delete(t);return this.waitingList.delete(t)};i.prototype.isReady=function(t){return this.globalList.has(t)&&!this.waitingList.has(t)};i.prototype.clear=function(t){this.globalList.clear();this.waitingList.clear();this.requestedList.clear()};i.prototype.isEmpty=function(){return this.requestedList.size===0};i.prototype.isWaiting=function(){return this.waitingList.size>0};i.prototype.isInitialViewCompleted=function(){var t=this.waitingList;for(var e=t.values(),i=e.next();!i.done;i=e.next()){var s=i.value;if(s&&s.isInitial){return false}}return true};function s(t,e){i.call(this,t);this.getMaxBatchDataSize=e;this.priorityMap=new Map;this.sortedList=null}s.prototype=Object.create(i.prototype);s.prototype.constructor=s;s.prototype.push=function(t,e){if(i.prototype.push.call(this,t,e)){this.priorityMap.set(t,{});this.sortedList=null;return true}return false};s.prototype.pop=function(t){this.priorityMap.delete(t);return i.prototype.pop.call(this,t)};s.prototype.clear=function(){i.prototype.clear.call(this);this.priorityMap.clear();this.sortedList=null};s.prototype.setData=function(t,e){var i=this.priorityMap.get(t);if(i!=null){Object.assign(i,e);this.sortedList=null;return true}return false};s.prototype.fetchBatch=function(){var t=this.priorityMap;var e=this.requestedList;var i=this.sortedList;if(i==null){i=this.sortedList=Array.from(e.keys()).sort(function(e,i){return t.get(e).priority-t.get(i).priority})}var s=this.batchSizeInfo;var n=s?s.maxBatchStringLength:Number.MAX_SAFE_INTEGER;var a=this.getMaxBatchDataSize?this.getMaxBatchDataSize():10*1024*1024;var r=1e3;var h=s?s.separatorLength:0;var o=[];var c=0;var u=this.getBatchSize?this.getBatchSize():1;var p=0;var l=0;for(var m=0;m<u&&i.length>0;m++){var g=i[i.length-1];var d=t.get(g);c+=d.dataSize;l+=d.submeshCount;p+=g.toString().length+(m==0?0:h);if(m>0&&(p>n||c>a||l>r)){break}e.delete(g);t.delete(g);i.pop();o.push(g)}return o};var n=function(e,n){this.context=e;this.sceneId=n;this.token=e.token||t.generateToken();var a=e.loader;this.meshes=new i(a.getMeshesBatchSize.bind(a));this.materials=new i(a.getMaterialsBatchSize.bind(a));this.textures=new i;this.geomMeshes=new s(a.getGeomMeshesBatchSize.bind(a),a.getGeomMeshesMaxBatchDataSize.bind(a));this.annotations=new i(a.getAnnotationsBatchSize.bind(a));this.views=new i;this.thumbnails=new i;this.images=new i};n.prototype.isEmpty=function(){return this.meshes.isEmpty()&&this.annotations.isEmpty()&&this.materials.isEmpty()&&this.textures.isEmpty()&&this.geomMeshes.isEmpty()&&this.views.isEmpty()&&this.thumbnails.isEmpty()&&this.images.isEmpty()};n.prototype.isWaitingForContent=function(){return this.meshes.isWaiting()||this.textures.isWaiting()||this.materials.isWaiting()||this.geomMeshes.isWaiting()||this.annotations.isWaiting()||this.views.isWaiting()||this.thumbnails.isWaiting()||this.images.isWaiting()};n.prototype.clearContent=function(){this.meshes.clear();this.annotations.clear();this.materials.clear();this.textures.clear();this.geomMeshes.clear();this.views.clear();this.thumbnails.clear();this.images.clear()};n.prototype.createGetContentCommand=function(e,i,s){var n={sceneId:this.sceneId,ids:i.map(function(t){return parseInt(t,10)}),token:this.token};return t.createRequestCommand(e,s?Object.assign(n,s):n)};function a(t){var e=t.keys().next();if(e.done){return null}var i=e.value;t.delete(i);return i}n.prototype.generateRequestCommand=function(){var i;var s;var n;var r=null;if(!this.meshes.isEmpty()){s=this.meshes.fetchBatch();var h=s.map(function(t){return t.id?t.id:t});r=this.createGetContentCommand(e.getMesh,h);r.sceneId=this.sceneId;r.meshIds=h}else if(!this.geomMeshes.isEmpty()){s=this.geomMeshes.fetchBatch();r=this.createGetContentCommand(e.getGeomMesh,s);r.sceneId=this.sceneId;r.meshIds=s}else if(!this.annotations.isEmpty()){s=this.annotations.fetchBatch();r={method:e.getAnnotation,parameters:{sceneId:this.sceneId,annotationIds:s}}}else if(!this.materials.isEmpty()){s=this.materials.fetchBatch();r={method:e.getMaterial,parameters:{sceneId:this.sceneId,materialIds:s}}}else if(!this.textures.isEmpty()){i=a(this.textures.requestedList);n=this.textures.waitingList.get(i);r=this.createGetContentCommand(e.getImage,[i]);r.sceneId=this.sceneId;r=Object.assign(r,n)}else if(!this.views.isEmpty()){i=a(this.views.requestedList);r={method:e.getView,parameters:{sceneId:this.sceneId,viewId:i,query:t.configureSceneViewQuery(this.context)}}}else if(!this.thumbnails.isEmpty()){i=a(this.thumbnails.requestedList);n=this.thumbnails.waitingList.get(i);r=this.createGetContentCommand(e.getImage,[i]);r.sceneId=this.sceneId;r=Object.assign(r,n)}else if(!this.images.isEmpty()){i=a(this.images.requestedList);n=this.images.waitingList.get(i);r=this.createGetContentCommand(e.getImage,[i]);r.sceneId=this.sceneId;r=Object.assign(r,n)}return r};return n});
//# sourceMappingURL=RequestQueue.js.map