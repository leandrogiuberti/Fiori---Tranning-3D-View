/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","./CallbackHandler","./TotaraUtils","./GeometryFactory","./ProgressCounter","./RequestQueue","../getResourceBundle","../AnimationRotateType"],function(e,t,i,s,r,n,a,o){"use strict";var d=function(e,i,s){this.root=null;this.onActiveCameraCallbacks=new t;this.onInitialSceneFinishedCallbacks=new t;this.onPartialRetrievalFinishedCallbacks=new t;this.onSceneCompletedCallbacks=new t;this.onSetPlaybackCallbacks=new t;this.onViewFinishedCallbacks=new t;this.onViewGroupFinishedCallbacks=new t;this.onContentChangesProgressCallbacks=new t;this.onInitialViewCompletedCallbacks=new t;Object.assign(this,i);this.sceneId=e;this.loader=s;this.sceneBuilder=s.sceneBuilder;this.requestQueue=new n(this,e);this.phase=d.Phase.Started;this.retrievalType=d.RetrievalType.Initial;this.rootNodeId=null;this.parametricNodeMap=new Map;this.dynamicContentNodeMap=new Map;this.annotationNodeMap=new Map;this.leaderLineMaterialIdMap=new Map;this.imageNoteMaterialIdMap=new Map;this.thumbnailViewMap=new Map;this.viewThumbnailMap=new Map;this.viewAnimatedThumbnailMap=new Map;this.progressCount=new r;this.treeNodes=[];this.viewIdTreeNodesMap=new Map;this.viewIdBoxMap=new Map;this.nodeSidsForPartialTree=new Set;this.replacedNodes=new Map;this.updatedNodes=new Set;this.currentViewId=null;this.initialViewId=null;this.initialViewDecided=false;this.initialViewFired=false;this.eventObject={};this.eventObject.percentage=0;this.loadingGeometry=0};d.Phase={Started:0,FinishedHierarchy:1,FinishedMesh:2,FinishedGeometry:3};d.RetrievalType={Initial:0,Partial:1};d.ProgressPhase={FinishedTree:a().getText("SCENE_CONTEXT_FINISHED_TREE"),FinishedMeshes:a().getText("SCENE_CONTEXT_FINISHED_MESHES"),FinishedMaterials:a().getText("SCENE_CONTEXT_FINISHED_MATERIALS"),FinishedGeomMeshes:a().getText("SCENE_CONTEXT_FINISHED_GEOMETRIES"),LoadingGeomMeshes:a().getText("SCENE_CONTEXT_LOADING_GEOMETRIES"),FinishedTextures:a().getText("SCENE_CONTEXT_FINISHED_TEXTURES"),FinishedImages:a().getText("SCENE_CONTEXT_FINISHED_IMAGES")};d.prototype.setOnProgressChanged=function(e){this.progressCount.setOnProgressChanged(e)};d.prototype.isLoadingFinished=function(){if(!this.requestQueue.isEmpty()||this.requestQueue.isWaitingForContent()||this.thumbnailViewMap.size>0||this.viewThumbnailMap.size>0||this.viewAnimatedThumbnailMap.size>0||this.annotationNodeMap.size>0||this.parametricNodeMap.size>0||this.dynamicContentNodeMap.size>0||this.leaderLineMaterialIdMap.size>0||this.imageNoteMaterialIdMap.size>0||this.viewIdTreeNodesMap.size>0||this.nodeSidsForPartialTree.size>0){return false}return true};d.prototype.isSceneCompleted=function(){return!this.requestQueue.meshes.isWaiting()&&!this.requestQueue.annotations.isWaiting()&&!this.requestQueue.materials.isWaiting()&&!this.requestQueue.geomMeshes.isWaiting()&&!this.requestQueue.textures.isWaiting()&&!this.requestQueue.images.isWaiting()};d.prototype.isInitialViewCompleted=function(){var e=this.requestQueue.textures.isInitialViewCompleted();var t=this.requestQueue.meshes.isInitialViewCompleted();var i=this.requestQueue.geomMeshes.isInitialViewCompleted();var s=this.requestQueue.images.isInitialViewCompleted();return e&&t&&i&&s};d.prototype._checkSceneCompletion=function(){if(!this.initialViewFired&&this.isInitialViewCompleted()){e.info("initialView completed.");this.initialViewFired=true;this.onInitialViewCompletedCallbacks.execute()}if(this.isSceneCompleted()){if(this.eventObject.percentage<100){this.eventObject.percentage=100;this.onContentChangesProgressCallbacks.execute(this.eventObject)}this.onSceneCompletedCallbacks.execute();e.info("Scene completed.");i.mark("sceneCompleted");this.logPerformance("sceneCompleted")}};d.prototype._fireProgress=function(e){switch(e){case d.ProgressPhase.FinishedTree:this.eventObject.percentage+=10;this.eventObject.phase=d.ProgressPhase.FinishedTree;this.onContentChangesProgressCallbacks.execute(this.eventObject);break;case d.ProgressPhase.FinishedMeshes:if(!this.requestQueue.meshes.isWaiting()){this.eventObject.percentage+=10;this.eventObject.phase=d.ProgressPhase.FinishedMeshes;this.onContentChangesProgressCallbacks.execute(this.eventObject)}break;case d.ProgressPhase.FinishedMaterials:if(!this.requestQueue.materials.isWaiting()){this.eventObject.percentage+=10;this.eventObject.phase=d.ProgressPhase.FinishedMaterials;this.onContentChangesProgressCallbacks.execute(this.eventObject)}break;case d.ProgressPhase.LoadingGeomMeshes:this.eventObject.percentage+=51*(1/this.requestQueue.geomMeshes.globalList.size);if(this.eventObject.percentage>100){this.eventObject.percentage=100}this.loadingGeometry+=51*(1/this.requestQueue.geomMeshes.globalList.size);if(this.loadingGeometry>=50){this.eventObject.phase=d.ProgressPhase.FinishedGeomMeshes}else{this.eventObject.phase=d.ProgressPhase.LoadingGeomMeshes}this.onContentChangesProgressCallbacks.execute(this.eventObject);break;case d.ProgressPhase.FinishedTextures:if(!this.requestQueue.textures.isWaiting()){this.eventObject.percentage+=10;this.eventObject.phase=d.ProgressPhase.FinishedTextures;this.onContentChangesProgressCallbacks.execute(this.eventObject)}break;case d.ProgressPhase.FinishedImages:if(!this.requestQueue.images.isWaiting()){this.eventObject.percentage+=10;this.eventObject.phase=d.ProgressPhase.FinishedImages;this.onContentChangesProgressCallbacks.execute(this.eventObject)}break;default:}};d.prototype.dispose=function(){this.sceneId=null;this.progressCount=null;this.requestQueue=null;this.suppressedBoundingBoxListMap=null;this.treeNodes=null;this.nodeSidsForPartialTree=null;this.annotationNodeMap=null;this.parametricNodeMap=null;this.dynamicContentNodeMap=null;this.leaderLineMaterialIdMap=null;this.imageNoteMaterialIdMap=null;this.thumbnailViewMap=null;this.viewThumbnailMap=null;this.viewAnimatedThumbnailMap=null;this.replacedNodes=null;this.updatedNodes=null;this.viewIdTreeNodesMap=null;this.viewIdBoxMap=null;this.onActiveCameraCallbacks=null;this.onInitialSceneFinishedCallbacks=null;this.onPartialRetrievalFinishedCallbacks=null;this.onSceneCompletedCallbacks=null;this.onViewFinishedCallbacks=null;this.onSetPlaybackCallbacks=null;this.onContentChangesProgressCallbacks=null;this.onInitialViewCompletedCallbacks=null};d.prototype.logPerformance=function(e){if(this.progressLogger&&this.token){this.progressLogger.logPerformance(e,this.token)}};d.prototype.setCameraSingle=function(e){this.sceneBuilder.createCamera(e,this.sceneId);return this.sceneBuilder.getCamera(e.id)};d.prototype.getPartialTreeNodes=function(e){var t=[];var i=[];var s,r,n;if(e&&e.length){for(s=0;s<e.length;s++){n=e[s];if(n==null){continue}if(n&&n.children){if(n.entityId!=null&&n.children.length===1){var a=e[n.children[0]];if(a.entityId==null){a.visualisable=false;if(a.visible===false){n.visible=false}else if(n.visible===false){a.visible=false}}}if(n.children){for(r=0;r<n.children.length;r++){var o=n.children[r];e[o].parentNode=n;if(n.renderOrder){e[o].renderOrder=n.renderOrder}}}}}for(s=0;s<e.length;s++){n=e[s];if(n==null){continue}if(n.parent){t.push(n)}else if(!n.parentNode){t.push(n);if(this.rootNodeId){n.parent=this.rootNodeId}}if(this.nodeSidsForPartialTree.has(n.sid)){i.push(n)}}}this.nodeSidsForPartialTree.clear();if(!i.length){return t}t=[];for(r=0;r<i.length;r++){var d=i[r];var l=d.parentNode;while(l){if(this.sceneBuilder.getNode(l.sid,this.sceneId)){d.parent=l.sid;t.push(d);break}else{d=l;l=l.parentNode}}}return t.length?t:i};d.prototype.buildTree=function(e){var t={};if(!this.treeNodes||!this.treeNodes.length){t.error="no tree information";return t}var i=this.treeNodes;var s=this.getPartialTreeNodes(i);this.replacedNodes.clear();var r=[];var n;var a;for(n=0;n<s.length;n++){a=s[n].parent;if(this.sceneBuilder.getNode(a,this.sceneId)){this.buildNode(s[n],a,true,e)}else{r.push(s[n])}}for(n=0;n<r.length;n++){a=r[n].parent;if(this.sceneBuilder.getNode(a,this.sceneId)){this.buildNode(s[n],a,true,e)}else{t.error=(t.error||"")+"parent ${parentSid} does not exist in the scene. \n"}}if(this.retrievalType===d.RetrievalType.Partial){this.sceneBuilder.updateViewsForReplacedNodes(this.treeNodes)}this.treeNodes=[];this.progressCount.mesh.total=this.requestQueue.meshes.globalList.size;return t};d.prototype.buildNode=function(e,t,i,s){if(!e||!t){this.loader.reportError(this,"SceneContext - buildNode - invalid args");return null}var r=this.sceneBuilder.getNode(e.sid,this.sceneId);if(r){this.sceneBuilder.remove(e.sid,this.sceneId)}if(e.suppressed===true){return null}if(!e.sid){this.loader.reportError(this,"sid is missing in treeNode");return null}e.parentId=t;this.sceneBuilder.createNode(e,this.sceneId);var n=e.parametricId;var a=e.meshId;const o=e.imageId;const d=e.dynamicContentId;if(n&&a){if(this.sceneBuilder.preferMeshes()){n=null}else{a=null}}if(n){if(this.parametricNodeMap.get(n)==null){this.parametricNodeMap.set(n,[e.sid])}else{this.parametricNodeMap.get(n).push(e.sid)}}else if(d){if(this.dynamicContentNodeMap.get(d)==null){this.dynamicContentNodeMap.set(d,[e.sid])}else{this.dynamicContentNodeMap.get(d).push(e.sid)}}else if(a&&!this.sceneBuilder.hasMesh(a)){if(this.loader.getSkipLowLODRendering()){this.requestQueue.geomMeshes.push(a,{id:a,isInitial:s})}else{this.requestQueue.meshes.push(a,{id:a,isInitial:s})}}else if(o){this.requestQueue.images.push("image_"+o,{imageId:o,usedBy:"SvgImage",isInitial:s})}if(e.annotationId&&!this.sceneBuilder.hasAnnotation(e.annotationId)){this._requestAnnotationForNode(e.annotationId,e.sid)}var l=this.sceneBuilder.getNode(e.sid,this.sceneId);if(r&&l){this.replacedNodes.set(r,l)}if(i&&e.children){for(var h=0;h<e.children.length;h++){this.buildNode(this.treeNodes[e.children[h]],e.sid,i,s)}}return l};d.prototype.setTree=function(e){if(e.sid){var t=this.sceneBuilder.getNode(e.sid,this.sceneId);if(!t||t!==this.root){var s=this.root;s.userData.treeNode={sid:e.sid,name:this.root.name?this.root.name:"root"};s.userData.skipIt=!this.root.name;this.sceneBuilder.setRootNode(s,e.sid,this.sceneId,this.vkScene);this.rootNodeId=e.sid;s.userData.entityId=this.defaultRootEntityId}}if(e.camera){e.camera.id="initial";var r=this.setCameraSingle(e.camera);if(r){this.onActiveCameraCallbacks.execute(r)}}i.measure("setTreeMeasure-"+this.sceneId,"setTree-"+this.sceneId)};d.prototype.setTreeNode=function(e){if(!Array.isArray(e.nodes)){return{error:"setTreeNode error: nodes are not properly defined"}}this.treeNodes=this.treeNodes.concat(e.nodes);return{}};d.prototype.suppressSendRequests=function(){this.loader.setSuppressSendRequests(true)};d.prototype.unsuppressSendRequests=function(){this.loader.setSuppressSendRequests(false);this.loader.sendRequest(this.requestQueue)};d.prototype.notifyFinishedTree=function(e,t){this.buildTree(t);this.phase=d.Phase.FinishedHierarchy;this._fireProgress(d.ProgressPhase.FinishedTree);if(this.retrievalType===d.RetrievalType.Initial){this.onInitialSceneFinishedCallbacks.execute(this.initialView)}else if(this.retrievalType===d.RetrievalType.Partial){this.onPartialRetrievalFinishedCallbacks.execute()}this._checkSceneCompletion()};d.prototype.setViewGroup=function(e){this.sceneBuilder.insertViewGroup(e,this.sceneId);if(!Array.isArray(e.views)){return}var t=e.id;var s,r;if(!this.currentViewGroupId){if(this.currentViewId){for(s=0;s<e.views.length;s++){r=e.views[s];if(r.id===this.currentViewId){this.currentViewGroupId=t;break}}}else{this.currentViewGroupId=t}}if(this.currentViewGroupId!==t){return}if(!this.currentViewId){this.currentViewId=e.views[0].id}for(s=0;s<e.views.length;s++){r=e.views[s];var n=this.sceneBuilder.getView(r.id,this.sceneId);for(var a=0;a<2;a++){var o=["thumbnailId","animatedThumbnailId"][a];var d=r[o];if(d!==undefined){r[o]=d=d.toString();if(this.sceneBuilder.hasImage(d)){this.sceneBuilder.setViewThumbnail(d,r.id,this.sceneId);this.loader.onViewGroupUpdatedCallbacks.execute()}else{this.thumbnailViewMap.set(d,r.id);this.requestQueue.thumbnails.push(d,{imageId:d,viewId:r.id})}if(!n){this[["viewThumbnailMap","viewAnimatedThumbnailMap"][a]].set(r.id,d)}}}if(n){n.userData.viewInfo.thumbnailId=r.thumbnailId;n.userData.viewInfo.animatedThumbnailId=r.animatedThumbnailId;continue}this.requestQueue.views.push(r.id,{viewId:r.id,viewGroupId:t})}if(!this.requestQueue.views.isWaiting()){this.sceneBuilder.finalizeViewGroups(this.sceneId);this.loader.onViewGroupUpdatedCallbacks.execute();this.onViewGroupFinishedCallbacks.execute()}i.measure("setViewGroupMeasure-"+t,"setViewGroup-"+t)};d.prototype.setView=function(e){var t=e.viewId;this.viewIdBoxMap.set(t!==undefined?t:"default",e.box);if(!t){this.setTree(e);this.initialViewDecided=true;return}if(!this.initialViewId&&!this.initialViewDecided){this.initialViewId=t;this.currentViewId=t;this.initialViewDecided=true}var s;if(this.initialViewId===t){if(e.camera){s=e.camera.id}this.setTree(e)}var r=this.viewThumbnailMap.get(t);if(r){this.viewThumbnailMap.delete(t);e.thumbnailId=r}var n=this.viewAnimatedThumbnailMap.get(t);if(n){this.viewAnimatedThumbnailMap.delete(t);e.animatedThumbnailId=n}this.sceneBuilder.insertView(e,this.sceneId);var a=this.sceneBuilder.getView(e.viewId,e.sceneId);if(a&&this.initialViewId===e.viewId){this.initialView=a}var o=[];this.viewIdTreeNodesMap.set(t,o);this.viewIdBoxMap.set(t,e.box);if(e.camera){if(s){e.camera.id=s}this.setCameraSingle(e.camera);this.sceneBuilder.setViewCamera(e.camera.id,t,this.sceneId)}this.logPerformance("setView");i.measure("setViewMeasure-"+t,"setView-"+t)};d.prototype.setViewNode=function(e,t,i){var s={context:this};if(!e.viewId){this.setTreeNode(e,i);return s}if(this.initialViewId===e.viewId){this.setTreeNode(e,i)}var r=this.sceneBuilder.getView(e.viewId,e.sceneId);if(!r){s.error="setViewNode error: setViewNode - no setView was in the chain";return s}if(this.initialViewId===e.viewId){this.initialView=r}var n=this.viewIdTreeNodesMap.get(e.viewId);n=n.concat(e.nodes);this.viewIdTreeNodesMap.set(e.viewId,n);return s};d.prototype.notifyFinishedView=function(e){var t=e.viewId;if(!t){this.notifyFinishedTree(e);return undefined}this.requestQueue.views.pop(t);if(this.initialViewId===t){this.notifyFinishedTree(e,true);this.initialViewId=null}var i=this.sceneBuilder.getView(t,this.sceneId);if(!i){return{error:"notifyFinishedView error: setViewNode - no setView was in the chain"}}if(i.activeCameraId!==undefined){i.setCamera(this.sceneBuilder.getCamera(i.activeCameraId))}this.updatedNodes.clear();var s=this.buildView(t);this.sceneBuilder.setViewNodeInfos(s.nodeInfos,t,this.sceneId);i.updatedNodes=Array.from(this.updatedNodes);if(!this.requestQueue.views.isWaiting()){this.sceneBuilder.finalizeViewGroups(this.sceneId);this.loader.onViewGroupUpdatedCallbacks.execute();this.onViewGroupFinishedCallbacks.execute()}this.onViewFinishedCallbacks.execute(i);this.logPerformance("notifyFinishedView");return undefined};d.prototype.buildView=function(e){var t={};this.treeNodes=this.viewIdTreeNodesMap.get(e);var i=this.getPartialTreeNodes(this.treeNodes);var s=[];for(var r=0;r<i.length;r++){var n=i[r].parent;this.processNodeRecursively(e,i[r],s,n,true)}t.nodeInfos=s;this.treeNodes=[];this.viewIdTreeNodesMap.delete(e);return t};d.prototype.processNodeRecursively=function(e,t,s,r,n){var a=this.sceneBuilder.getNode(t.sid,this.sceneId);var o="annotationId"in t?t.annotationId:null;if(o!=null&&a!=null&&a.userData.annotationType==="html"&&!this.sceneBuilder.hasAnnotation(o)){this._requestAnnotationForNode(o,t.sid)}if(!a){a=this.buildNode(t,r,false);if(!a){return}if(!a.userData.skipIt){a.visible=false}}if(t.materialId){this._checkIfNeededAndOrderMaterial(t.materialId,true)}var d=t.visible==undefined?true:t.visible;s.push({target:a,visible:d,materialId:t.materialId,opacity:t.opacity,meshId:t.meshId,annotationId:t.annotationId,transform:Array.isArray(t.transform)?i.arrayToColumnMajorMatrixArray16(t.transform):[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]});var l=this.treeNodes;var h=this.sceneBuilder.getChildNodeIds(t.sid,this.sceneId);var u=t.children?t.children.map(function(e){return l[e].sid}):[];var c;var p;for(p=0;p<h.length;p++){c=h[p];for(var f=0;f<u.length;f++){if(c===u[f]){h[p]=undefined;break}}}for(p=0;p<h.length;p++){var g=h[p];if(g!==undefined){var m=this.sceneBuilder.getNode(g,this.sceneId);var I=false;s.push({target:m,visible:I})}}if(t.children){for(p=0;p<t.children.length;p++){this.processNodeRecursively(e,l[t.children[p]],s,t.sid,d)}}if(t.highlightStyleId){this.sceneBuilder.recordHighlightedNodeInView(t.highlightStyleId,t.sid,e,this.sceneId)}};d.prototype.setAnnotationSingle=function(e){var t=this.annotationNodeMap.get(e.id)||[];this.annotationNodeMap.delete(e.id);var s=function(t){var s=JSON.parse(JSON.stringify(e));if(t){s.nodeId=t}if(s.detailView||s.cutaway){this.sceneBuilder.createDetailView(s,this.sceneId)}else if(s.labelMaterialId||s.label&&s.label.materialId){var r=s.labelMaterialId||s.label.materialId;if(this.sceneBuilder.checkMaterialExists(r,false)){this.sceneBuilder.createImageNote(s,this.sceneId);this.loader.onAnnotationFinishedCallbacks.execute(s.id)}else{this.requestQueue.materials.push(r);i.pushElementIntoMapArray(this.imageNoteMaterialIdMap,r,s)}}else{this.sceneBuilder.createAnnotation(s,this.sceneId);var n=s.leaderLines;if(n){for(var a=0,o=n.length;a<o;a++){var d=n[a];d.annotationId=s.id;if(this.sceneBuilder.checkMaterialExists(d.materialId,false)){this.sceneBuilder.insertLeaderLine(d,this.sceneId)}else{this.requestQueue.materials.push(d.materialId);i.pushElementIntoMapArray(this.leaderLineMaterialIdMap,d.materialId,d)}}}}}.bind(this);if(t.length>0){for(var r=0;r<t.length;r++){s(t[r])}}else{s()}this.requestQueue.annotations.pop(e.id)};d.prototype.setCamera=function(e){if(!Array.isArray(e.cameras)){return{error:"setCamera error: cameras are not properly defined"}}e.cameras.forEach(this.setCameraSingle.bind(this));return undefined};d.prototype.allocateMeshBuffer=function(e){var t=e.meshes;var i=this.sceneBuilder;if(i.preprocessMeshes){i.preprocessMeshes(t)}var s=t.length;var r,n,a,o,d,l,h,u;for(r=0;r<s;++r){n=t[r];a=n.id;if(n.skipPointCloud===true){this.requestQueue.geomMeshes.pop(a)}else if(!i.hasMesh(a)){o=n.submeshes;d=o.length;u=0;for(l=0;l<d;++l){h=o[l];h.meshId=a;if(h.clusterIndex!=null){u+=h.clusterIndex}this._checkIfNeededAndOrderMaterial(h.materialId,true);i.insertSubmesh(h)}this.requestQueue.geomMeshes.setData(a,{priority:u/d,dataSize:n.geometrySize,submeshCount:d});this.progressCount.mesh.count++}}};d.prototype.setMesh=function(e,t){var s=e.meshes;if(!Array.isArray(s)){return{error:"setMesh error: meshes are not properly defined"}}var r=this.requestQueue.geomMeshes;s.forEach(function(e){r.pop(e.id)});if(t){var n=new DataView(t.buffer,t.byteOffset,t.byteLength);var a=n.getUint16(2,true),o=0;while(a-- >0&&o<t.byteLength){var l={sceneId:this.sceneId,id:n.getUint32(o+4,true).toString(),box:[n.getFloat32(o+14,true),n.getFloat32(o+18,true),n.getFloat32(o+22,true),n.getFloat32(o+26,true),n.getFloat32(o+30,true),n.getFloat32(o+34,true)]};var h=n.getUint16(o+12,true);o+=38;if(h!==3){l.flags=n.getUint16(o,true);l.quality=n.getFloat32(o+4,true);l.pointCount=n.getUint16(o+8,true);l.elementCount=n.getUint16(o+10,true);l.encodingType=n.getUint16(o+12,true);o+=14}var u=n.getUint32(o,true);var c=t.subarray(o+4,o+4+u);o+=u;this.setGeometry(l,c)}}i.measure("setMeshMeasure-"+this.sceneId,"setMesh-"+this.sceneId);if(!r.isWaiting()){this.phase=d.Phase.FinishedGeometry;this.logPerformance("geometryFinished")}this._checkSceneCompletion();return undefined};d.prototype.setMaterialSingle=function(e,t){var i=e.id;this.requestQueue.materials.pop(i);var s;var r=this.sceneBuilder.createMaterial(e);for(s=0;s<r.length;s++){var n=r[s].imageId;this.requestQueue.textures.push(n,{imageId:n,materialId:i,isInitial:t})}var a=this.leaderLineMaterialIdMap.get(i);if(a){this.leaderLineMaterialIdMap.delete(i);for(s=0;s<a.length;s++){this.sceneBuilder.insertLeaderLine(a[s],this.sceneId)}}var o=this.imageNoteMaterialIdMap.get(i);if(o){this.imageNoteMaterialIdMap.delete(i);for(s=0;s<o.length;s++){this.sceneBuilder.createImageNote(o[s],this.sceneId)}}this.loader.onMaterialFinishedCallbacks.execute(i)};d.prototype.setMaterial=function(e,t,s){if(!Array.isArray(e.materials)){return{error:"setMaterial error: materials are not properly defined"}}e.materials.forEach(function(e){this.setMaterialSingle(e,s)}.bind(this));i.measure("setMaterialMeasure-"+this.sceneId,"setMaterial-"+this.sceneId);this._fireProgress(d.ProgressPhase.FinishedMaterials);this._checkSceneCompletion();return undefined};d.prototype.setGeometry=function(e,t){var r=e.id;if(e.data&&!t){t=i.base64ToUint8Array(e.data)}if(!t||t.length===0){return{error:"setGeometry error: no data for geometry "+r}}var n=this.sceneBuilder.getTempGeometryBuffer?this.sceneBuilder.getTempGeometryBuffer():undefined;var a=s.getGeometryInfo(e,t,n);if(!a){return{error:"setGeometry error: failed to parse geometry "+r+" data"}}this.sceneBuilder.setGeometry(a);this.progressCount.geometry.count++;i.measure("setGeometryMeasure-"+r,"setGeometry-"+r);return undefined};d.prototype.setImage=function(t,s){var r=t.id;if(!s){return{error:"setImage error: no image content for "+r}}t.binaryData=s;this.sceneBuilder.createImage(t);if(this.requestQueue.textures.pop(r)){e.info("Received texture image id: "+r);this.loader.onImageFinishedCallbacks.execute({id:r});this._fireProgress(d.ProgressPhase.FinishedTextures);this._checkSceneCompletion()}else if(this.requestQueue.thumbnails.pop(r)){var n=this.thumbnailViewMap.get(r);if(n){this.thumbnailViewMap.delete(r);this.sceneBuilder.setViewThumbnail(r,n,this.sceneId,t.tileWidth);this.loader.onViewGroupUpdatedCallbacks.execute()}}i.measure("setImageMeasure-"+r,"setImage-"+r);return undefined};d.prototype.setSvgImage=function(e){const t=e.id;const i=e.svgContent;if(!i){return{error:"setImage error: no image content for "+t}}for(const e of this.sceneBuilder._nodes.values()){if(e.nodeContentType=="SvgImage"&&e.imageId==t){const t="data:image/svg+xml;base64,"+btoa(i);e.setImageData(t)}}this.requestQueue.images.pop("image_"+t);this._fireProgress(d.ProgressPhase.FinishedImages);this._checkSceneCompletion();return undefined};d.prototype.setAnnotation=function(e){if(!Array.isArray(e.annotations)){return{error:"setAnnotation error: annotations are not properly defined"}}e.annotations.forEach(this.setAnnotationSingle,this);this._checkSceneCompletion();return undefined};d.prototype.setHighlightStyle=function(e){e.id=e.id.toString();this.sceneBuilder.insertHighlightStyle(e)};d.prototype.setLineStyle=function(e){e.lineStyles.forEach(function(e){this.sceneBuilder.insertLineStyle(e)},this)};d.prototype.setFillStyle=function(e){e.fillStyles.forEach(function(e){this.sceneBuilder.insertFillStyle(e)},this)};d.prototype.setTextStyle=function(e){e.textStyles.forEach(function(e){this.sceneBuilder.insertTextStyle(e)},this)};d.prototype._checkIfNeededAndOrderMaterial=function(e,t,i){if(e&&this.sceneBuilder.materialNeeded(i)&&this.sceneBuilder.checkMaterialExists(e,t)===false){this.requestQueue.materials.push(e)}};d.prototype.setParametric=function(e){for(var t=0;t<e.parametrics.length;t++){var i=e.parametrics[t];var s=i.id.toString();var r=this.parametricNodeMap.get(s);this.parametricNodeMap.delete(s);for(var n=0;r&&n<r.length;n++){if(i.shapes!=null){for(var a=0;a<i.shapes.length;a++){this._checkIfNeededAndOrderMaterial(i.shapes[a].materialID,false,i)}}else{this._checkIfNeededAndOrderMaterial(i.materialID,false,i)}this.sceneBuilder.setParametricContent(r[n],i,this.sceneId)}}};d.prototype.setMarker=function(e){if(!Array.isArray(e.markers)){return}e.markers.forEach(e=>{this.sceneBuilder.bindMarkerNodeTransformationToReferenceNode(e.referenceNode,e.makrerNodeSid,e.coordinateSpace)});this._checkSceneCompletion()};d.prototype.setPointCloudGroup=function(e){this.sceneBuilder.setPointCloudGroups(e.pointCloudGroups,this.sceneId)};d.prototype.setDynamicContent=function(e){for(const t of e.dynamicContents){const e=t.id.toString();const i=this.dynamicContentNodeMap.get(e);if(i){this.dynamicContentNodeMap.delete(e);for(const e of i){this.sceneBuilder.setDynamicContent(e,t,this.sceneId)}}}};d.prototype.setPlayback=function(e){if(!Array.isArray(e.playbacks)){return{error:"setPlayback error: playbacks are not properly defined"}}var t=this.sceneBuilder.getView(e.viewId,this.sceneId);var i=false;var s,r;if(this.playbackIds){for(s=0;s<e.playbacks.length;s++){r=e.playbacks[s];for(var n=0;n<this.playbackIds.length;n++){if(r.id===this.playbackIds[n]){r.notLoading=false;break}}if(r.notLoading===undefined){r.notLoading=true}}delete this.playbackIds;i=true;if(!t.sortPlaybacks(true)){t.resetPlaybacksStartTimes(true)}}if(Array.isArray(e.joints)){this.sceneBuilder.insertJoints(e.joints,this.sceneId)}for(s=0;s<e.playbacks.length;s++){r=e.playbacks[s];if(r.notLoading){continue}if(r.id==null){r.id=e.viewId+"-playback";r.sequence.id=e.viewId+"-cont";r.sequenceId=r.sequence.id;this.setSequence({sequences:[r.sequence]})}this.sceneBuilder.insertPlayback(r,e.viewId,this.sceneId)}this.sceneBuilder.finalizeAnimation();this.sceneBuilder.finalizePlaybacks();if(i){this.onSetPlaybackCallbacks.execute(t)}return undefined};d.prototype.setSequenceSingle=function(e,t){function i(e){for(var t in e){if(e.hasOwnProperty(t)){return false}}return true}if(e.nodes){var s=[];for(var r=0;r<e.nodes.length;r++){var n=e.nodes[r];var a=n.rrotate||n.rotate;if(a){var o={};if(a.trackId){o.trackId=a.trackId}else if(t&&a.track!==undefined){o.trackId=t[a.track].id}o.sid=n.sid;o.binding="ROTATE";if(a.pivot){o.pivot=a.pivot}if(n.rotate){o.isAbsoluteValue=true}if(i(a)){o.empty=true}s.push(o)}var d=n.rtranslate||n.translate;if(d){var l={};if(d.trackId){l.trackId=d.trackId}else if(t&&d.track!==undefined){l.trackId=t[d.track].id}l.sid=n.sid;l.binding="TRANSLATE";if(d.pivot){l.pivot=d.pivot}if(n.translate){l.isAbsoluteValue=true}if(i(d)){l.empty=true}s.push(l)}var h=n.rscale||n.scale;if(h){var u={};if(h.trackId){u.trackId=h.trackId}else if(t&&h.track!==undefined){u.trackId=t[h.track].id}u.sid=n.sid;u.binding="SCALE";if(h.pivot){u.pivot=h.pivot}if(n.scale){u.isAbsoluteValue=true}if(i(h)){u.empty=true}s.push(u)}if(n.opacity!==undefined||n.ropacity!==undefined){var c;if(n.opacity){c=n.opacity}else{c=n.ropacity}var p={};if(c.trackId){p.trackId=c.trackId}else if(t&&c.track!==undefined){p.trackId=t[c.track].id}p.sid=n.sid;p.binding="OPACITY";if(n.opacity){p.isAbsoluteValue=true}if(i(c)){p.empty=true}s.push(p)}}e.nodes=s}this.sceneBuilder.insertSequence(e,this.sceneId)};d.prototype.setSequence=function(e){if(!Array.isArray(e.sequences)){return{error:"setSequence error: sequences are not properly defined"}}if(Array.isArray(e.joints)){this.sceneBuilder.insertJoints(e.joints,this.sceneId)}for(var t=0;t<e.sequences.length;t++){this.setSequenceSingle(e.sequences[t],e.tracks)}if(e.tracks){this.setTrack(e)}this.loader.onSetSequenceCallbacks.execute();return undefined};d.prototype.setTrack=function(e){if(!Array.isArray(e.tracks)){return{error:"setTrack error: tracks are not properly defined"}}var t=[];for(var i=0;i<e.tracks.length;i++){var s=e.tracks[i];s.times=s.time;if(s.vector3){s.values=s.vector3}else if(s.quaternion){s.values=s.quaternion;s.rotateType=o.Quaternion}else if(s.angleAxis){s.values=s.angleAxis;s.rotateType=o.AngleAxis}else if(s.euler){s.values=s.euler;s.rotateType=o.Euler}else if(s.scalar){s.values=s.scalar}s.cyclicInfo={};s.cyclicInfo.cyclicStart=s.cyclicStart;s.cyclicInfo.cyclicEnd=s.cyclicEnd;t.push(s)}this.sceneBuilder.insertTracks(t);return undefined};d.prototype.notifyError=function(e){if(!e.error){e.error="Unknown error"}return e};d.prototype._requestAnnotationForNode=function(e,t){var i=this.annotationNodeMap.get(e);if(i==null){this.annotationNodeMap.set(e,[t]);this.requestQueue.annotations.push(e)}else if(!i.includes(t)){i.push(t)}return this};return d});
//# sourceMappingURL=SceneContext.js.map