/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","./SceneContext","./CallbackHandler","./Command","./TotaraUtils","../helpers/WorkerScriptLoader"],function(e,t,i,n,s,a){"use strict";var r=s.mark;var o=function(){this._performanceTimingMsg=[];this._isPostable=true;this._suppressSendRequests=false;this._loadingFinishedSent=false;this.currentSceneInfo={};this.contextMap=new Map;this.tokenContextMap=new Map;this._skipLowLODRendering=true;this._maxUrlLength=2048;this._maxActiveRequests=4;this._consumptionScenario=null;this._meshesBatchSize=1024;this._materialsBatchSize=128;this._geomMeshesBatchSize=1024;this._geomMeshesMaxBatchDataSize=10*1024*1024;this._annotationsBatchSize=128;this._voxelThreshold=.03;this.onErrorCallbacks=new i;this.onImageFinishedCallbacks=new i;this.onImageDetailsFinishedCallbacks=new i;this.onMaterialFinishedCallbacks=new i;this.onAnnotationFinishedCallbacks=new i;this.onSetSequenceCallbacks=new i;this.onSetTrackCallbacks=new i;this.onViewGroupUpdatedCallbacks=new i;this.onLoadingFinishedCallbacks=new i};o.prototype.running=function(){return this._worker!==null&&this._worker!==undefined};o.prototype.run=function(){if(!this._worker){this._worker=a.loadScript("sap/ui/vk/totara/TotaraLoaderWorker.js");var e=this;this._worker.onmessage=function(t){var i=t.data;i.jsonContent=i.jsonContent||{};if(i.jsonString){var n=JSON.parse(i.jsonString);delete i.jsonString;i.jsonContent=Object.assign(n,i.jsonContent)}var s=e.processCommand(i.name,i.jsonContent,i.binaryContent,i.isInitial);if(s){e.sendRequest(s.requestQueue)}};this._worker.onerror=function(e){}}return Promise.resolve("TotaraLoader is ready")};o.prototype.getUrl=function(){return this._url};o.prototype.setUrl=function(e){this._url=e;if(!this._url.endsWith("/")){this._url+="/"}return this};o.prototype.getSessionId=function(){return this._sessionId};o.prototype.setSessionId=function(e){this._sessionId=e;return this};o.prototype.getSkipLowLODRendering=function(){return this._skipLowLODRendering};o.prototype.setSkipLowLODRendering=function(e){this._skipLowLODRendering=e;return this};o.prototype.getMaxUrlLength=function(){return this._maxUrlLength};o.prototype.setMaxUrlLength=function(e){this._maxUrlLength=e;return this};o.prototype.getMaxActiveRequests=function(){return this._maxActiveRequests};o.prototype.setMaxActiveRequests=function(e){this._maxActiveRequests=e;this.postMessage({method:n.setMaxActiveRequests,maxActiveRequests:e})};o.prototype.getConsumptionScenario=function(){return this._consumptionScenario};o.prototype.setConsumptionScenario=function(e){this._consumptionScenario=e;this.postMessage({method:n.setConsumptionScenario,consumptionScenario:e})};o.prototype.getMeshesBatchSize=function(){return this._meshesBatchSize};o.prototype.setMeshesBatchSize=function(e){this._meshesBatchSize=e;return this};o.prototype.getMaterialsBatchSize=function(){return this._materialsBatchSize};o.prototype.setMaterialsBatchSize=function(e){this._materialsBatchSize=e;return this};o.prototype.getGeomMeshesBatchSize=function(){return this._geomMeshesBatchSize};o.prototype.setGeomMeshesBatchSize=function(e){this._geomMeshesBatchSize=e;return this};o.prototype.getGeomMeshesMaxBatchDataSize=function(){return this._geomMeshesMaxBatchDataSize};o.prototype.setGeomMeshesMaxBatchDataSize=function(e){this._geomMeshesMaxBatchDataSize=e;return this};o.prototype.getAnnotationsBatchSize=function(){return this._annotationsBatchSize};o.prototype.setAnnotationsBatchSize=function(e){this._annotationsBatchSize=e;return this};o.prototype.getVoxelThreshold=function(){return this._voxelThreshold};o.prototype.setVoxelThreshold=function(e){this._voxelThreshold=e;if(this.sceneBuilder){this.sceneBuilder.setVoxelThreshold(e)}return this};o.prototype.setSceneBuilder=function(e){this.sceneBuilder=e;this.sceneBuilder.setVoxelThreshold(this.getVoxelThreshold())};o.prototype.removeContext=function(e){this.contextMap.delete(e);return this};o.prototype.dispose=function(){this.contextMap.forEach(function(e){e.dispose()});this.contextMap.clear();this.tokenContextMap.clear();if(this._worker!=null){this.postMessage({method:"close"});this._worker=this._worker.onmessage=this._worker.onerror=null}this.currentSceneInfo=null;if(this.sceneBuilder){this.sceneBuilder.cleanup();this.sceneBuilder=null}this.onErrorCallbacks=null;this.onMaterialFinishedCallbacks=null;this.onImageFinishedCallbacks=null;this.onImageDetailsFinishedCallbacks=null;this.onSetTrackCallbacks=null;this.onSetSequenceCallbacks=null;this.onAnnotationFinishedCallbacks=null};o.prototype.cleanup=function(){this.currentSceneInfo={};this.contextMap.clear();this.tokenContextMap.clear();this.sceneBuilder.cleanup()};o.prototype.getSceneBuilder=function(){return this.sceneBuilder};o.prototype.getContext=function(e){return this.contextMap.get(e)};o.prototype.createContext=function(e,i){var n=new t(e,i,this);this.contextMap.set(e,n);this.tokenContextMap.set(n.requestQueue.token,n);if(n.onActiveCamera){n.onActiveCameraCallbacks.attach(n.onActiveCamera);delete n.onActiveCamera}if(n.onInitialSceneFinished){n.onInitialSceneFinishedCallbacks.attach(n.onInitialSceneFinished);delete n.onInitialSceneFinished}if(n.onPartialRetrievalFinished){n.onPartialRetrievalFinishedCallbacks.attach(n.onPartialRetrievalFinished);delete n.onPartialRetrievalFinished}if(n.onViewFinished){n.onViewFinishedCallbacks.attach(n.onViewFinished);delete n.onViewFinished}if(n.onSceneCompleted){n.onSceneCompletedCallbacks.attach(n.onSceneCompleted);delete n.onSceneCompleted}if(n.onProgressChanged){n.setOnProgressChanged(n.onProgressChanged);delete n.onProgressChanged}if(n.onLoadingFinished){this.onLoadingFinishedCallbacks.detachAll();this.onLoadingFinishedCallbacks.attach(n.onLoadingFinished);delete n.onLoadingFinished}if(n.onContentChangesProgress){n.onContentChangesProgressCallbacks.attach(n.onContentChangesProgress);delete n.onContentChangesProgress}if(n.onInitialViewCompleted){n.onInitialViewCompletedCallbacks.attach(n.onInitialViewCompleted);delete n.onInitialViewCompleted}return n};o.prototype.isLoadingFinished=function(){var e=this.contextMap.values();var t=e.next();while(!t.done){if(!t.value.isLoadingFinished()){return false}t=e.next()}return true};o.prototype.decrementResourceCountersForDeletedTreeNode=function(e,t){if(e){this.sceneBuilder.decrementResourceCountersForDeletedTreeNode(t,e.sceneId)}};function c(e,t){if(e.progressLogger){e.progressLogger.logPerformance(t,e.token)}}o.prototype.request=function(e,i,a){if(!i.root){throw"Context must include root where loaded objects are attached to"}var o=this.createContext(e,i);o.token=o.requestQueue.token;this.currentSceneInfo.id=e;o.retrievalType=t.RetrievalType.Initial;o.authorizationHandler=a;o.initialRequestTime=Date.now();if(o.enableLogger){s.createLogger(e,o,this)}var l;if(sap.ui.Device.browser.mobile){l=Math.min(8*1024,this.getMaxUrlLength())}else{l=Math.min(64*1024,this.getMaxUrlLength())}var u=h(this.getUrl()+"streaming-http",this.getUrl(),e,this.getSessionId(),l);var d=o.requestQueue;d.meshes.setBatchSizeInfo(u[n.getMesh]);d.materials.setBatchSizeInfo(u[n.getMaterial]);d.geomMeshes.setBatchSizeInfo(u[n.getGeomMesh]);d.annotations.setBatchSizeInfo(u[n.getAnnotation]);var p=this;(a&&a(this.getUrl())||Promise.resolve()).then(function(t){c(o,"modelRequested");r("modelRequested");p.postMessage({method:"useAccessTokenResponse",accessTokenResponse:t});p.postMessage({method:"initializeConnection",url:p.getUrl(),sessionId:p.getSessionId(),maxActiveRequests:p.getMaxActiveRequests(),consumptionScenario:p.getConsumptionScenario()});p.postMessage({method:n.getScene,sceneId:e})})};o.prototype.postMessage=function(e){this._worker?.postMessage(e)};o.prototype.processSetSceneCommand=function(e){var t=this.getContext(e.id);if(t){t.defaultViewId=e.defaultViewId;t.defaultViewGroupId=e.defaultViewGroupId;t.sceneThumbnailId=e.thumbnailId;t.dimension=e.dimension;t.defaultRootEntityId=e.defaultRootEntityId;if(t.defaultViewGroupId){t.currentViewGroupId=t.defaultViewGroupId}if(this.sceneBuilder){this.sceneBuilder.setSceneMetadata(e.metadata)}var i;if(t.activateView){i=t.activateView}else if(t.defaultViewId){i=t.defaultViewId}if(i){t.initialViewId=t.currentViewId=i;t.initialViewDecided=true}this.postMessage({method:n.getView,parameters:{sceneId:t.sceneId,viewId:i,query:s.configureSceneViewQuery(t)},pushViewGroups:t.pushViewGroups,isInitial:true})}};o.prototype.update=function(e,i,a){this.currentSceneInfo.id=e;var r=this.getContext(e);if(!r){return Promise.reject("no context for ${sceneVeId}")}var o=this;return new Promise(function(l,u){r.nodeSidsForPartialTree=new Set(i);r.retrievalType=t.RetrievalType.Partial;var h=function(){r.onPartialRetrievalFinishedCallbacks.detach(h);c(r,"updateFinished(mesh)");var t=[];var n=[];r.replacedNodes.forEach(function(e,i){n.push(e);t.push(i)});var s=t;var a=n;l({sceneVeId:e,sids:i,replacedNodeRefs:s,replacementNodeRefs:a})};r.onPartialRetrievalFinishedCallbacks.attach(h);c(r,"updateRequested");o.postMessage({method:n.getView,parameters:{sceneId:e,viewId:a,query:Object.assign(s.configureSceneViewQuery(r),{breadcrumbs:true}),sids:i},isPartialTree:true})})};o.prototype.requestViewGroup=function(e,t,i,n){if(!t){return Promise.reject("invalid arg: viewGroupId undefined")}var s=this.getContext(e);if(!s){return Promise.reject("no context for ${sceneVeId}")}if(i!==undefined){s.includeAnimation=i}var a=this;var r=new Promise(function(i,r){if(!n){var o=a.sceneBuilder.getViewGroup(t,e);if(o&&o.length){i(o);return}}var l=function(){s.onViewGroupFinishedCallbacks.detach(l);c(s,"onViewGroupFinished");var n=a.sceneBuilder.getViewGroup(t,e);if(n&&n.length){i(n)}else{r("no view ground data")}};s.onViewGroupFinishedCallbacks.attach(l);s.currentViewGroupId=t;a.postMessage({method:"getViewGroups",parameters:{sceneId:e,viewGroupId:t}})});return r};o.prototype.requestView=function(e,t,i,a,r){this.currentSceneInfo.id=e;if(t!=="static"){return Promise.reject("invalid arg: supported type - static")}if(!i){return Promise.reject("invalid arg: viewId undefined")}var o=this.getContext(e);if(!o){return Promise.reject("no context for ${sceneVeId}")}o.currentViewId=i;var l;var u;if(a&&a.length>0){u=n.getViewAnimations;l={$expand:[]};o.playbackIds=a}else{u=n.getView;l=s.configureSceneViewQuery(o)}var h=this;var d=new Promise(function(e,t){o.onSetPlaybackCallbacks.detachAll();var n=function(i){o.onSetPlaybackCallbacks.detach(n);c(o,"onSetPlayback");if(i){e(i)}else{t("no view data")}};o.onSetPlaybackCallbacks.attach(n);o.onViewFinishedCallbacks.detachAll();var s=function(i){o.onViewFinishedCallbacks.detach(s);c(o,"onViewFinished");if(i){e(i)}else{t("no view data")}};o.onViewFinishedCallbacks.attach(s);h.onSetSequenceCallbacks.detachAll();var a=function(){h.onSetSequenceCallbacks.detach(a);c(o,"onSetSequence");if(o.currentView){e(o.currentView)}};h.onSetSequenceCallbacks.attach(a);h.onSetTrackCallbacks.detachAll();var r=function(t){h.onSetTrackCallbacks.detach(r);c(o,"onSetTrack");if(o.currentView){e(o.currentView)}};h.onSetTrackCallbacks.attach(r);c(o,"viewRequested");h.postMessage({method:u,parameters:{sceneId:o.sceneId,viewId:i,query:l}})});return d};o.prototype.requestMaterial=function(e,t){if(!t){return Promise.reject("invalid arg: requestedMaterial undefined")}var i=this.getContext(e);if(!i){return Promise.reject("no context for ${sceneVeId}")}var n=this;var s=new Promise(function(e,s){var a="";if(typeof t=="string"){a=t}else if(typeof t=="object"){if(typeof t.getMaterialRef==="function"){e(t.getMaterialRef());return}else if(t.id){a=t.id}else if(t.veId){a=t.veId}else{s("invalid arg: invalid requestedMaterial object");return}}else{s("invalid arg: requestedMaterial must be an object or a string");return}var r=i.sceneBuilder.getMaterial(a);if(r){e(r);return}i.requestQueue.materials.push(a);var o=function(t){if(a!==t.materialId){return}var i=n.sceneBuilder.getMaterial(a);if(i&&!i.userData.imageIdsToAddAsTexture){n.sceneBuilder.detachImageAddedToMaterial(o);e(i)}};var c=function(t){if(a!=t){return}n.onMaterialFinishedCallbacks.detach(c);var i=n.sceneBuilder.getMaterial(a);if(!i){n.sceneBuilder.detachImageAddedToMaterial(o);s("no material data")}if(i.userData.imageIdsToAddAsTexture){return}n.sceneBuilder.detachImageAddedToMaterial(o);e(i)};n.onMaterialFinishedCallbacks.attach(c);n.sceneBuilder.attachImageAddedToMaterial(o);n.sendRequest(i.requestQueue)});return s};o.prototype.requestAnnotation=function(e,t){if(!t){return Promise.reject("invalid arg: annotationId undefined")}var i=this.getContext(e);if(!i){return Promise.reject("no context for ${sceneVeId}")}var n=this;var s=new Promise(function(e,s){var a=function(e){return i.sceneBuilder.getAnnotation?i.sceneBuilder.getAnnotation(e):null};var r=a(t);if(r){e(r);return}i.requestQueue.annotations.push(t);var o;var c;var l=function(i){n.onAnnotationFinishedCallbacks.detach(o);var s=a(t);var r=n.sceneBuilder._getMaterial(s.label.materialId);if(r&&r.userData.imageDetailsToLoad&&!r.userData.imageDetailsToLoad.size){n.onImageDetailsFinishedCallbacks.detach(l);if(r.userData.imageIdsToLoad&&r.userData.imageIdsToLoad.size){return}e(s)}};var u=function(i){n.onAnnotationFinishedCallbacks.detach(o);var s=a(t);var r=n.sceneBuilder._getMaterial(s.label.materialId);if(r&&r.userData.imageIdsToLoad&&!r.userData.imageIdsToLoad.size){n.onImageFinishedCallbacks.detach(u);if(r.userData.imageDetailsToLoad&&r.userData.imageDetailsToLoad.size){return}e(s)}};c=function(i){n.onAnnotationFinishedCallbacks.detach(o);var r=a(t);if(r.label.materialId!=i){return}n.onMaterialFinishedCallbacks.detach(c);if(!n.sceneBuilder.checkMaterialExists(i,false)){n.onImageFinishedCallbacks.detach(u);s("no material data")}var h=n.sceneBuilder._getMaterial(i);if(h.userData.imageIdsToLoad&&h.userData.imageIdsToLoad.size||h.userData.imageDetailsToLoad&&h.userData.imageDetailsToLoad.size){return}n.onImageFinishedCallbacks.detach(u);n.onImageDetailsFinishedCallbacks.detach(l);e(r)};o=function(i){if(t!==i){return}n.onAnnotationFinishedCallbacks.detach(o);var a=n.sceneBuilder.getAnnotation?n.sceneBuilder.getAnnotation(t):null;if(!a){n.onMaterialFinishedCallbacks.detach(c);n.onImageFinishedCallbacks.detach(u);n.onImageDetailsFinishedCallbacks.detach(l);s("no annotation data")}n.onMaterialFinishedCallbacks.detach(c);n.onImageFinishedCallbacks.detach(u);n.onImageDetailsFinishedCallbacks.detach(l);e(a)};n.onAnnotationFinishedCallbacks.attach(o);n.onMaterialFinishedCallbacks.attach(c);n.onImageFinishedCallbacks.attach(u);n.onImageDetailsFinishedCallbacks.attach(l);n.sendRequest(i.requestQueue)});return s};o.prototype.setSuppressSendRequests=function(e){this._suppressSendRequests=e};o.prototype.sendRequest=function(e){if(!this._worker||this._suppressSendRequests){return false}var t=false;while(!e.isEmpty()){var i=e.generateRequestCommand();this.postMessage(i);t=true}return t};o.prototype.timestamp=function(e){};o.prototype.performanceTiming=function(e){};o.prototype.checkError=function(e){if(!e){return true}var t=e.result==="failure";if(t){if(e.message){e.error=e.message;delete e.message}else{e.error="Unknown error"}}return t};o.prototype.reportError=function(e,t){this.onErrorCallbacks.execute({error:t,context:e})};o.prototype.processContextCommand=function(t,i,n,s,a){if(!t){var r=i+" error: unknown context - "+JSON.stringify(n);this.contextMap.forEach(function(e){e[i].call(e,n,s)});return{error:r}}var o;try{o=t[i].call(t,n,s,a)}catch(t){e.error("An error happened while processing an HTTP response",t);o={error:t}}return o};o.prototype.processCommand=function(t,i,s,a){if(this.checkError(i)){if(t===n.setTree){if(i.events&&i.events.length){var r=i.events[0];if(r.values&&r.values.id){this.contextMap.delete(r.values.id)}}}this.onErrorCallbacks.execute(i);return null}var o=null;if(i.sceneId!==undefined){o=this.getContext(i.sceneId)}else if(i.token!==undefined){o=this.tokenContextMap.get(i.token)}if(o){this.currentSceneInfo.id=o.sceneId}this.setPerformance(t,i,o?o.sceneId:null);var c;switch(t){case n.setScene:this.processSetSceneCommand(i);break;case n.setTree:case n.setTreeNode:case n.notifyFinishedTree:case n.setView:case n.setViewNode:case n.setViewGroup:case n.notifyFinishedView:case n.setCamera:case n.allocateMeshBuffer:case n.setMesh:case n.setMaterial:case n.setGeometry:case n.setImage:case n.setSvgImage:case n.setAnnotation:case n.setLineStyle:case n.setFillStyle:case n.setTextStyle:case n.setParametric:case n.setPointCloudGroup:case n.setDynamicContent:case n.setPlayback:case n.setHighlightStyle:case n.setSequence:case n.setTrack:case n.suppressSendRequests:case n.unsuppressSendRequests:case n.setMarker:c=this.processContextCommand(o,t,i,s,a);break;case n.notifyError:c={error:i.errorText};break;case n.timestamp:c=this.timestamp(i);break;case n.performanceTiming:c=this.performanceTiming(i);break;default:c={error:"Unknown command: "+t};break}if(this.isLoadingFinished()){if(t!==n.setScene&&t!==n.setView&&t!==n.setViewNode&&t!==n.timestamp&&t!==n.performanceTiming&&t!==n.suppressSendRequests&&t!==n.unsuppressSendRequests&&this._loadingFinishedSent===false){this.onLoadingFinishedCallbacks.execute();this._loadingFinishedSent=true;e.info("Loading is finished - all streaming requests are fulfilled.")}}else if(this._loadingFinishedSent){this._loadingFinishedSent=false}if(c&&c.error){e.error(c.error);this.onErrorCallbacks.execute(c)}return o};o.prototype.setPerformance=function(e,t,i){var s;switch(e){case n.setGeometry:s=t.id;r("setGeometry-"+s);break;case n.setImage:s=t.id;r("setImage-"+s);break;case n.setView:s=t.viewId;r("setView-"+s);break;case n.setViewGroup:s=t.id;r("setViewGroup-"+s);break;case n.setMesh:r("setMesh-"+i);break;case n.setMaterial:r("setMaterial-"+i);break;case n.setTree:r("setTree-"+i);break;case n.performanceTiming:this._isPostable=true;this.postPerformanceTiming();break;default:break}};o.prototype.postPerformanceTiming=function(e){if(e){this._performanceTimingMsg.push(e)}if(this._isPostable&&this._performanceTimingMsg.length>0){this.postMessage(this._performanceTimingMsg.shift());this._isPostable=false}};o.prototype.printLogTokens=function(){this.contextMap.forEach(function(t,i){e.info("log tokens for scene => "+i);e.info("---------------------------------------");if(t.progressLogger){t.progressLogger.getTokens().forEach(function(t){e.info(t)})}e.info("---------------------------------------")})};function l(e,t,i,n,s,a){var r;var o;switch(e){case"getGeomMesh":o=a-(i+"scenes/"+n+"/meshes?types=box&ids="+r).length;break;default:r="?request="+encodeURI(e+"["+a+"]"+JSON.stringify({sceneId:n,ids:[],token:s}));o=a-(t+r).length;break}return o}function u(e){return",".length}function h(e,t,i,n,s){e=e.indexOf("?")===-1?e:e.substring(0,e.indexOf("?"));var a=["getAnnotation","getGeomMesh","getMaterial","getMesh","getParametric","getSequence","getTrack"];var r={};a.forEach(function(a){r[a]={maxBatchStringLength:l(a,e,t,i,n,s),separatorLength:u(a)}});return r}return o});
//# sourceMappingURL=TotaraLoader.js.map