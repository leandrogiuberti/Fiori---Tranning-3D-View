/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
(function(){"use strict";var e={};["initializeConnection","getScene","getGeomMesh","getAnnotation","getMaterial","getImage","getView"].reverse().forEach(function(n,t){e[n]=t});var n=new Map;var t;var s;var a;var i;var r;var o=[];var c=4;var u=0;function d(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=Math.random()*16|0,t=e=="x"?n:n&3|8;return t.toString(16).toLowerCase()})}function l(n,s,a){return new Promise(function(i,r){o.push({url:t+n,context:s,priority:e[s&&s.method]||0,responseType:a,resolve:i,reject:r});if(u<c){f()}})}function f(){if(!o.length){return}o.sort(function(e,n){return e.priority-n.priority});var e=o.pop();u++;m(encodeURI(e.url),e.responseType).then(function(n){e.resolve(n)}).catch(function(n){R({errorText:"Could not connect to server: "+t,error:n.status,reason:n.message?n.message:n,context:e.context});if(e.reject){e.reject(n)}}).finally(function(){u--;f()})}function m(e,t){return new Promise(function(o,c){var u=new XMLHttpRequest;u.onload=function(){if(this.status>=200&&this.status<300){if(this.getAllResponseHeaders().includes("tile-width")){var e=this.getResponseHeader("tile-width");var t=new RegExp("[^/]+$");var s=this.responseURL.match(t);n.set(s[0],e)}o(this.response)}else{c({status:this.status,statusText:this.statusText})}};u.onerror=function(){c({status:this.status,statusText:this.statusText})};u.open("GET",e,true);if(a){u.setRequestHeader("Authorization",a)}if(i){u.setRequestHeader("X-TenantUuid",i)}if(r){u.setRequestHeader("X-ConsumptionScenario",r.toUpperCase())}u.setRequestHeader("X-CorrelationID",d());u.setRequestHeader("X-SessionId",s);u.responseType=t||"arraybuffer";u.send()})}var h="TextDecoder"in self?function(){var e=new TextDecoder;return function(n,t,s){return e.decode(new DataView(n,t,s-t))}}():function(e,n,t){var s="";var a=1e3;try{while(n<t){var i=Math.min(a,t-n);var r=new Uint8Array(e,n,i);s+=String.fromCharCode.apply(null,r);n+=i}}catch(e){return""}return decodeURIComponent(escape(s))};function p(e){var n=e.split(",");if(n.length<0||n.length>2){throw"invalid content length"}var t=0;var s=0;try{t=parseInt(n[0],10);if(n.length===2){s=parseInt(n[1],10)}}catch(e){throw"invalid content length"}return{jsonContentLength:t,binaryContentLength:s}}function v(e,n){var t="[".charCodeAt(0);var s="]".charCodeAt(0);var a=[];var i=0;var r=0;var o;var c;var u;var d=new Uint8Array(e);while(r<e.byteLength){r=d.indexOf(t,i);if(r===-1){break}var l=h(e,i,r).replace(/\n|\r|\s/g,"");i=r+1;r=d.indexOf(s,i);if(r===-1){throw"No matching [] for command length. abort"}o=p(h(e,i,r));i=r+1;r=i+o.jsonContentLength;c=h(e,i,r);if(o.binaryContentLength){i=r;r=i+o.binaryContentLength;u=new Uint8Array(e,i,o.binaryContentLength)}else{u=undefined}i=r;var f={name:l,jsonString:c,isInitial:n};if(u){f.binaryContent=u}a.push(f)}return a}function I(e){var t;var s=-1;var a,i;var r=false;var o=false;var c=false;for(i=0;i<e.length;i++){t=e[i];if(t.name==="setView"){if(!r){if(!t.jsonContent.viewId){r=true}}o=true}else if(t.name==="setViewNode"){if(a===undefined){a=t.jsonContent.viewId}}else if(t.name==="setSequence"&&o){c=true}}if(a&&r){for(i=0;i<e.length;i++){t=e[i];if(t.name==="setView"){t.jsonContent={viewId:a};break}}}for(i=0;i<e.length;i++){t=e[i];if(t.name==="setPlayback"&&c){s=i;continue}if(t.name==="setImage"){var u=t.jsonContent.id;var d=u?n.get(u):null;if(d){t.jsonContent.tileWidth=d}}if(t.name==="setScene"&&e.length>1){continue}g(t)}if(s!==-1){t=e[s];g(t)}}function g(e){if(e.binaryContent){self.postMessage({name:e.name,jsonString:e.jsonString,jsonContent:e.jsonContent,binaryContent:e.binaryContent,isInitial:"isInitial"in e?e.isInitial:false},[e.binaryContent.buffer])}else{self.postMessage({name:e.name,jsonString:e.jsonString,jsonContent:e.jsonContent,isInitial:"isInitial"in e?e.isInitial:false})}}function y(e){var n="";for(var t in e){if(e[t]==null){continue}if(n.length!==0){n+="&"}n+=t+"="+e[t]}return n}async function C(e){const[n,t]=await Promise.all([l(`scenes/${e.sceneId}/info?includeInMetering=true`,e,"json"),l(`scenes/${e.sceneId}?sid=9223372036854775807`,e,"json")]);n.metadata=t.scene.metadata;I([{name:"setScene",jsonContent:n}])}function x(e){var n=e.parameters.sceneId;var t=e.parameters.viewId;var s=e.parameters.sids;var a=e.isInitial;var i="scenes/"+n;if(t){i+="/views/"+t}i+="?"+y(e.parameters.query);if(s&&s.length>0){i+="&sid="+s.join("&sid=")}var r=e.isPartialTree;l(i,e,"text").then(function(s){var i;try{i=JSON.parse(s)}catch(e){R({errorText:"Failed to parse JSON"});return}var o=[];var c=t?i.views[0]:i.tree;var u=c.nodes;delete c.nodes;var d=i.highlightStyles;var l=i.annotations;var f=i.parametrics;var m=i.textStyles;var h=i.linestyles;var p=i.fillstyles;var v=i.meshes;var g=i.markers;var y=i.images;const C=i.pointCloudGroups;const x=i.dynamicContents;function w(e){if("style"in e&&m){e["style_id"]=m[e.style].veid}if("stroke"in e&&h){e["stroke_id"]=h[e.stroke].veid}if("fill"in e&&p){e["fill_id"]=p[e.fill].veid}}if(u){u.forEach(function(e){if("highlightStyle"in e&&d){e.highlightStyleId=d[e.highlightStyle].id}if("annotation"in e&&l){e.annotationId=l[e.annotation].id}if("parametric"in e&&f){e.parametricId=f[e.parametric].id}if("marker"in e&&g){g[e.marker].makrerNodeSid=e.sid}if("pointCloudGroup"in e&&C){const n=C[e.pointCloudGroup];e.pointCloudGroupId=n.id;n.nodeId=e.sid}if("dynamicContent"in e&&x){e.dynamicContentId=x[e.dynamicContent].id}if("image"in e&&y){const n=y[e.image];e.imageId=n.id;e.width=n.width;e.height=n.height}})}if(f){f.forEach(function(e){if("shapes"in e){e.shapes.forEach(w)}else{w(e)}})}o.push({name:"suppressSendRequests",jsonContent:{sceneId:n}});if(!r){c.sceneId=n;c.viewId=t;o.push({name:"setView",jsonContent:c,isInitial:a})}if(u){o.push({name:r?"setTreeNode":"setViewNode",jsonContent:{sceneId:n,viewId:t,nodes:u},isInitial:a})}o.push({name:r?"notifyFinishedTree":"notifyFinishedView",jsonContent:{sceneId:n,viewId:t},isInitial:a});if(d){d.forEach(function(e){e.sceneId=n;o.push({name:"setHighlightStyle",jsonContent:e,isInitial:a})})}if(m){o.push({name:"setTextStyle",jsonContent:{sceneId:n,textStyles:m},isInitial:a})}if(h){o.push({name:"setLineStyle",jsonContent:{sceneId:n,lineStyles:h},isInitial:a})}if(p){o.push({name:"setFillStyle",jsonContent:{sceneId:n,fillStyles:p},isInitial:a})}if(f){o.push({name:"setParametric",jsonContent:{sceneId:n,parametrics:i.parametrics},isInitial:a})}if(l){o.push({name:"setAnnotation",jsonContent:{sceneId:n,annotations:l},isInitial:a})}if(v){o.push({name:"allocateMeshBuffer",jsonContent:{sceneId:n,meshes:v},isInitial:a})}if(g){o.push({name:"setMarker",jsonContent:{sceneId:n,markers:g},isInitial:a})}if(C){o.push({name:"setPointCloudGroup",jsonContent:{sceneId:n,pointCloudGroups:i.pointCloudGroups},isInitial:a})}if(x){o.push({name:"setDynamicContent",jsonContent:{sceneId:n,dynamicContents:i.dynamicContents},isInitial:a})}var k=i.animation;if(k&&k.sequences&&k.playbacks){var b={sceneId:n,viewId:t,tracks:k.tracks,sequences:k.sequences};if(k.joints){b.joints=k.joints}o.push({name:"setSequence",jsonContent:b,isInitial:a});k.playbacks.forEach(function(e){var n=k.sequences[e.sequence];e.sequenceId=n&&n.id});k.playbacks=k.playbacks.filter(function(e){return e.sequenceId!=null});o.push({name:"setPlayback",jsonContent:{sceneId:n,viewId:t,playbacks:k.playbacks},isInitial:a})}o.push({name:"unsuppressSendRequests",jsonContent:{sceneId:n}});I(o);if(e.pushViewGroups){j({method:"getViewGroups",parameters:{sceneId:n}})}})}function w(e){var n=e.parameters.sceneId;var t=e.parameters.viewId;var s="scenes/"+n+"/views/"+t+"/animations?"+y(e.parameters.query);l(s,e,"text").then(function(e){var s;try{s=JSON.parse(e)}catch(e){R({errorText:"Failed to parse JSON"});return}I([{name:"setPlayback",jsonContent:{sceneId:n,viewId:t,playbacks:s.playbacks}}])})}function j(e){var n=e.parameters.sceneId;var t=e.parameters.viewGroupId;var s="scenes/"+n+"/viewGroups";if(t){s+="/"+t}l(s,e,"text").then(function(e){var n;try{n=JSON.parse(e)}catch(e){R({errorText:"Failed to parse JSON"});return}I(n.groups.map(function(e){return{name:"setViewGroup",jsonContent:e}}))})}function k(e){var n=e.parameters.sceneId;var t=e.parameters.materialIds;var s=t.map(function(e){return"id="+e}).join("&");var a="scenes/"+n+"/materials?"+s;l(a,e,"text").then(function(e){var t;try{t=JSON.parse(e)}catch(e){R({errorText:"Failed to parse JSON"});return}t.sceneId=n;I([{name:"setMaterial",jsonContent:t}])})}function b(e){var n=e.parameters.sceneId;var t=e.parameters.annotationIds;var s=t.map(function(e){return"id="+e}).join("&");var a="scenes/"+n+"/annotations?"+s;l(a,e,"text").then(function(e){var t;try{t=JSON.parse(e)}catch(e){R({errorText:"Failed to parse JSON"});return}t.sceneId=n;I([{name:"setAnnotation",jsonContent:t}])})}function S(e){var n;const t=e.usedBy=="SvgImage";if(e.materialId){n="scenes/"+e.sceneId+"/materials/"+e.materialId+"/images/"+e.imageId}else if(e.viewId){n="scenes/"+e.sceneId+"/views/"+e.viewId+"/images/"+e.imageId}else if(t){n="scenes/"+e.sceneId+"/images/"+e.imageId;l(n,e,"text").then(function(n){I([{name:"setSvgImage",jsonContent:{sceneId:e.sceneId,id:e.imageId,isInitial:e.isInitial,svgContent:n}}])});return}else{return}l(n,e,"arraybuffer").then(function(n){I([{name:"setImage",jsonContent:{sceneId:e.sceneId,id:e.imageId,isInitial:e.isInitial},binaryContent:new Uint8Array(n)}])})}function T(e){var n="scenes/"+e.sceneId+"/meshes?ids="+e.meshIds.join(",");l(n,e,"arraybuffer").then(function(n){var t=v(n);t.forEach(function(n){n.jsonContent={sceneId:e.sceneId}});I(t)})}function q(e){var n="scenes/"+e.sceneId+"/meshes?ids="+e.meshIds.join(",")+"&types=box";l(n,e,"arraybuffer").then(function(n){var t=v(n);t.forEach(function(n){n.jsonContent={sceneId:e.sceneId}});I(t)})}function R(e){self.postMessage({name:"notifyError",jsonContent:e})}self.onmessage=function(e){var n=e.data;switch(n.method){case"getAnnotation":{b(n);break}case"getGeomMesh":{T(n);break}case"getMesh":{q(n);break}case"getImage":{S(n);break}case"getMaterial":{k(n);break}case"getScene":{C(n);break}case"getView":{x(n);break}case"getViewAnimations":{w(n);break}case"getViewGroups":{j(n);break}case"initializeConnection":{t=n.url;s=n.sessionId;c=n.maxActiveRequests;r=n.consumptionScenario;break}case"close":{self.close();break}case"useAccessTokenResponse":{if(n.accessTokenResponse){a=n.accessTokenResponse.token_type+" "+n.accessTokenResponse.access_token;i=n.accessTokenResponse.tenant_uuid}else{a=null;i=null}break}case"setMaxActiveRequests":{c=n.maxActiveRequests;break}case"setConsumptionScenario":r=n.consumptionScenario;break;case"addClientLog":{break}default:{console.warn("Unknown TotaraLoader command: "+n.method);break}}}})();
//# sourceMappingURL=TotaraLoaderWorker.js.map