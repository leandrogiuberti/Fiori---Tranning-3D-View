/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./library","sap/ui/core/Control","sap/ui/core/Element","sap/ui/table/TreeTable","sap/ui/table/rowmodes/Auto","sap/ui/table/Column","sap/ui/model/json/JSONModel","sap/ui/core/Core","sap/ui/core/ResizeHandler","sap/m/Label","sap/m/Title","sap/m/SearchField","sap/m/Toolbar","sap/m/ToolbarLayoutData","sap/m/ToolbarSpacer","sap/m/Text","sap/ui/core/Icon","./Core","./ViewStateManager","./SceneTreeRenderer","./getResourceBundle","sap/ui/core/library","sap/m/library"],function(e,t,i,n,a,s,r,o,h,l,d,c,u,g,p,_,f,S,y,C,T,E,b){"use strict";var w=t.extend("sap.ui.vk.SceneTree",{metadata:{library:"sap.ui.vk",properties:{title:{type:"string",defaultValue:T().getText("SCENETREE_TITLE")},showTitle:{type:"boolean",defaultValue:true},showSearchField:{type:"boolean",defaultValue:true},legacyVisibilityMode:{type:"boolean",defaultValue:false}},aggregations:{treeTable:{type:"sap.ui.table.TreeTable",multiple:false}},associations:{contentConnector:{type:"sap.ui.vk.ContentConnector",multiple:false},viewStateManager:{type:"sap.ui.vk.ViewStateManagerBase",multiple:false}},events:{contentChanged:{enableEventBubbling:true}}},constructor:function(e,i){t.apply(this,arguments);S.observeAssociations(this)}});var m="sap-icon://show",v="sap-icon://hide";var x=T().getText("SCENETREE_VISIBILITYSTATEVISIBLE"),I=T().getText("SCENETREE_VISIBILITYSTATEHIDDEN");w.prototype._createNodeForSceneTree=function(e,t,i){var n=i.getVisibilityState(t);return{name:e,id:t,visible:n}};w.prototype.setScene=function(e,t){this.setViewStateManager(t);this._setScene(e)};w.prototype._setScene=function(e){this._scene=e;this.refresh()};w.prototype.init=function(){if(t.prototype.init){t.prototype.init.apply(this)}var e=this;this._title=new d({width:"100%",textAlign:E.TextAlign.Center,text:this.getTitle()});this._searchField=new c({layoutData:new g({shrinkable:true,maxWidth:"400px"}),search:function(t){var i=t.getParameter("query"),n=e._scene.getDefaultNodeHierarchy(),a=e._viewStateManager;if(n&&a){var s=!i?[]:n.findNodesByName({value:i,predicate:"contains"});var r=new Set(s);var o=[];a.enumerateSelection(function(e){if(!r.has(e)){o.push(e)}});a.setSelectionStates(s,o,false);e._treeItemCountText.setText(T().getText("SCENETREE_SELECTED_SCENE_TREE_ITEM_INFO",[s.length]))}}});this._toolbar=new u({content:[this._title,new p,this._searchField]});var i=new f({src:m,tooltip:x,press:function(t){var i=this.getSrc()!==m;this.setSrc(i?m:v);this.setTooltip(i?T().getText("SCENETREE_VISIBILITYSTATEVISIBLEALL"):T().getText("SCENETREE_VISIBILITYSTATEHIDDENALL"));e._toggleVisibilityForAllChildren(e._model.getData(),i)}});this._tree=new n({extension:this._toolbar,columnHeaderHeight:32,columns:[new s({label:new l({text:T().getText("SCENETREE_NAME")}),tooltip:T().getText("SCENETREE_NAME"),template:new _({text:"{name}",maxLines:1,tooltip:"{name}"}),resizable:false}),new s(this.getId()+"-visibilityColumn",{label:i,template:new f({src:{path:"",formatter:function(e){if(!e){return null}return e.visible?m:v}},tooltip:{path:"",formatter:function(e){if(!e){return null}return e.visible?x:I}},press:function(t){var i=e._tree.getContextByIndex(this.getParent().getIndex());var n=i?i.getObject():null;if(n){e._viewStateManager.setVisibilityState(n.id,!n.visible,e.getLegacyVisibilityMode(),e.getLegacyVisibilityMode())}}}),width:"2.25em",resizable:false,hAlign:"Center"})],enableSelectAll:false,selectionMode:"MultiToggle",selectionBehavior:"RowSelector",rowMode:new a});this.setAggregation("treeTable",this._tree);this._treeItemCountText=new _({text:T().getText("SCENETREE_SELECTED_SCENE_TREE_ITEM_INFO",[this._tree.getSelectedIndices().length])}).addStyleClass("sapUiTinyMargin");const o=new u({design:b.ToolbarDesign.Info,content:[this._treeItemCountText]});this._tree.addExtension(o);this.attachContentChanged(function(e){i.setSrc(m);i.setTooltip(x)});this._scene=null;this._syncing=false;this._updateSelectionTimer=0;this._updateVisibilityTimer=0;this._model=new r;this._tree.setModel(this._model);this._tree.bindRows({path:"/"});this._tree.attachRowSelectionChange(this._handleRowSelectionChange.bind(this));this._tree.attachFirstVisibleRowChanged(this._updateSelection.bind(this));this._tree.getBinding("rows").attachChange(this._dataChange.bind(this))};w.prototype.setTitle=function(e){this.setProperty("title",e,true);this._title.setText(e);return this};w.prototype.setShowTitle=function(e){this.setProperty("showTitle",e,true);this._title.setVisible(e);this._updateTitleBar();return this};w.prototype.setShowSearchField=function(e){this.setProperty("showSearchField",e,true);this._searchField.setVisible(e);this._updateTitleBar();return this};w.prototype._updateTitleBar=function(){this._tree.removeExtension(this._toolbar);if(this.getShowTitle()||this.getShowSearchField()){this._tree.addExtension(this._toolbar)}this._handleResize()};w.prototype.onBeforeRendering=function(){this._tree.setVisible(true);if(!this._resizeListenerId){this._resizeListenerId=h.register(this,this._handleResize.bind(this))}};w.prototype._handleRowSelectionChange=function(e){if(this._syncing||this._tree.getBinding("rows")._aSelectedContexts!=undefined){return}var t=[];var i=[];var n=e.getParameter("rowIndices");for(var a in n){var s=n[a];var r=this._tree.getContextByIndex(s);var o=r?r.getObject().id:null;if(o){(this._tree.isIndexSelected(s)?t:i).push(o)}}this._viewStateManager.setSelectionStates(t,i);const h=this._tree.getBinding("rows").getSelectedContexts();this._treeItemCountText.setText(T().getText("SCENETREE_SELECTED_SCENE_TREE_ITEM_INFO",[h.length]))};w.prototype._onSelectionChanged=function(e){if(this._syncing){return}function t(e,t){var i=e.getBinding("rows");if(i){for(var n=e.getFirstVisibleRow(),a=Math.min(n+e.getRowMode().getComputedRowCounts().count,i.getLength());n<a;n++){var s=i.getContextByIndex(n);if(s&&s.getObject().id===t){return true}}}return false}var i=e.getParameter("selected");this._treeItemCountText.setText(T().getText("SCENETREE_SELECTED_SCENE_TREE_ITEM_INFO",[i.length]));if(i.length===1&&!t(this._tree,i[0])){if(this._updateSelectionTimer>0){clearTimeout(this._updateSelectionTimer);this._updateSelectionTimer=0}this._expandToNode(i[0],this._updateSelection.bind(this))}else if(this._updateSelectionTimer===0){this._updateSelectionTimer=setTimeout(this._updateSelection.bind(this),0)}};w.prototype._updateSelection=function(){this._updateSelectionTimer=0;if(this._syncing){return}this._syncing=true;var e=this._viewStateManager,t=this._tree,i=t.getBinding("rows");if(e&&i){for(var n=t.getFirstVisibleRow(),a=Math.min(n+t.getRowMode().getComputedRowCounts().count,i.getLength());n<a;n++){var s=i.getContextByIndex(n);if(s){var r=s.getObject().id;if(r){var o=e.getSelectionState(r);if(o!=t.isIndexSelected(n)){t[o?"addSelectionInterval":"removeSelectionInterval"](n,n)}}}}}this._syncing=false};w.prototype._expandToNode=function(e,t){var i={tree:this._tree,rows:this._tree.getBinding("rows"),index:0,nodeRef:e,ancestors:new Set(this._scene.getDefaultNodeHierarchy().getAncestors(e)),callback:t};function n(e,t,i){var n=e.getFirstVisibleRow(),a=e.getRowMode().getComputedRowCounts().count;if(t<n||t>=n+a){n=Math.min(Math.max(t-(a>>1),0),i-a);e.setFirstVisibleRow(n)}}function a(e,t){if(t&&t.getParameter("reason")!=="expand"){return}var i=e.rows.getLength();while(e.index<i){var a=e.rows.getContextByIndex(e.index);if(!a){break}var s=a.getObject().id;if(s===e.nodeRef){n(e.tree,e.index,i);break}if(e.ancestors.has(s)&&!e.tree.isExpanded(e.index)){e.tree.expand(e.index++);return}e.index++}e.rows.detachChange(e.expandHandlerProxy);e.callback()}i.expandHandlerProxy=a.bind(this,i);i.rows.attachChange(i.expandHandlerProxy);a(i)};w.prototype._dataChange=function(e){var t=e.getParameter("reason");if((t==="expand"||t==="collapse")&&this._updateSelectionTimer===0){this._updateSelectionTimer=setTimeout(this._updateSelection.bind(this),0)}};w.prototype._toggleVisibilityForAllChildren=function(e,t){var i=e.hasOwnProperty("children")?e.children:e;for(var n=0;i[n]!=null;n++){this._viewStateManager.setVisibilityState(i[n].id,t,true)}};w.prototype._onVisibilityChanged=function(e){if(this._updateVisibilityTimer===0){this._updateVisibilityTimer=setTimeout(this._updateVisibility.bind(this),0)}};w.prototype._updateVisibility=function(){this._updateVisibilityTimer=0;this._getNodeVisibilityRecursive(this._model.getData());this._tree.getModel().refresh(true)};w.prototype._getNodeVisibilityRecursive=function(e){if(e.id!=null){e.visible=this._viewStateManager.getVisibilityState(e.id)}var t=e.hasOwnProperty("children")?e.children:e;for(var i=0;t[i]!=null;i++){this._getNodeVisibilityRecursive(t[i])}};w.prototype._handleResize=function(e){this._updateSelection()};w.prototype.refresh=function(){const e=this._scene?.getDefaultNodeHierarchy?.();if(!e||!this._viewStateManager?.getNodeHierarchy()){this._model.setData([]);return}var t=[];var i=function(t,n){n.forEach(function(n){if(n.userData&&n.userData.skipIt){i(t,e.getChildren(n))}else{var a=e.createNodeProxy(n);var s=this._createNodeForSceneTree(a.getName(),a.getNodeRef(),this._viewStateManager);t.push(s);e.destroyNodeProxy(a);s.children=[];i(s.children,e.getChildren(n))}}.bind(this))}.bind(this);i(t,e.getChildren());this._model.setData(t);this._tree.setModel(this._model);this._tree.bindRows({path:"/",parameters:{arrayNames:["children"]}});this._tree.getBinding("rows").attachChange(this._dataChange.bind(this));this.fireContentChanged()};w.prototype.onSetViewStateManager=function(e){this._viewStateManager=e;e.attachNodeHierarchyReplaced(this._onNodeHierarchyReplaced,this);e.attachSelectionChanged(this._onSelectionChanged,this);e.attachVisibilityChanged(this._onVisibilityChanged,this);this.refresh()};w.prototype.onUnsetViewStateManager=function(e){this._viewStateManager=null;e.detachVisibilityChanged(this._onVisibilityChanged,this);e.detachSelectionChanged(this._onSelectionChanged,this);e.detachNodeHierarchyReplaced(this._onNodeHierarchyReplaced,this);this.refresh()};w.prototype._onNodeHierarchyReplaced=function(e){this.refresh()};w.prototype._setContent=function(e){if(e&&!this.getViewStateManager()){var t=i.getElementById(this.getContentConnector());if(t){var n=t.getDefaultViewStateManager();if(n){this.setViewStateManager(n)}}}this._setScene(e);return this};w.prototype.onSetContentConnector=function(e){e.attachContentReplaced(this._onContentReplaced,this);e.attachContentChangesFinished(this._onContentChangesFinished,this);this._setContent(e.getContent())};w.prototype.onUnsetContentConnector=function(e){this._setContent(null);e.detachContentChangesFinished(this._onContentChangesFinished,this);e.detachContentReplaced(this._onContentReplaced,this)};w.prototype._onContentReplaced=function(e){this._setContent(e.getParameter("newContent"))};w.prototype._onContentChangesFinished=function(e){this.refresh()};return w});
//# sourceMappingURL=SceneTree.js.map