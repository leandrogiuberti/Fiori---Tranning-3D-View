/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/m/VBox","sap/m/Button","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/m/Label","sap/m/Input","sap/m/Table","sap/m/table/ColumnWidthController","sap/m/table/columnmenu/Menu","sap/m/table/columnmenu/QuickGroup","sap/m/table/columnmenu/QuickGroupItem","sap/m/table/columnmenu/QuickSort","sap/m/table/columnmenu/QuickSortItem","sap/m/Column","sap/m/ColumnListItem","sap/m/plugins/ColumnResizer","sap/m/MultiComboBox","sap/m/IllustratedMessage","sap/m/IllustratedMessageType","sap/m/p13n/Engine","sap/m/p13n/SelectionController","sap/m/p13n/GroupController","sap/m/p13n/SortController","sap/m/p13n/MetadataHelper","sap/ui/core/Control","sap/ui/core/CustomData","sap/ui/core/Element","sap/ui/core/Icon","sap/ui/core/Lib","sap/ui/core/library","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","../Core","./VisibilityType","../getResourceBundle","sap/m/library"],function(e,t,n,s,i,a,o,r,l,h,p,c,u,d,g,_,m,f,y,E,b,S,T,C,w,N,P,L,M,v,B,k,x,I,A,V,O,F){"use strict";const D=v.SortOrder;const R={Hidden:"sap-icon://hide",Partial:"sap-icon://vk-icons/partially-visible-element",Visible:"sap-icon://show"};const H={RefDes:"refdes",Type:"type",Device:"deviceref",Visibility:"visibility"};const U={Component:"2",Net:"4"};const z={FilterSummary:"FilterSummary",ElementType:"ElementType"};function G(e){return e.data("key")}function W(e,t){return e.find(e=>G(e)===t)}function Y(e,t){for(let n=t.getParent();n!=null;n=n.getParent()){if(n===e){return true}}return false}function K(e){if(e.hiddenParts.size===0){return V.Visible}else if(e.hiddenParts.size<e.parts.size){return V.Partial}return V.Hidden}function j(e){const t=e?.userData?.metadata??{};if(t.length!=undefined){const e=new Map;t.forEach(t=>{if(t.category==="ecad"){e.set(t.tag,t.value)}});return e}return null}function Q(e){switch(e.type){case U.Component:return O().getText("ELEMENTS_PANEL_TYPE_COMPONENT");case U.Net:return O().getText("ELEMENTS_PANEL_TYPE_NET");default:return O().getText("ELEMENTS_PANEL_TYPE_UNKNOWN")}}var q=w.extend("sap.ui.vk.ecad.ElementsPanel",{metadata:{library:"sap.ui.vk",properties:{width:{type:"sap.ui.core.CSSSize",defaultValue:"auto"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"}},aggregations:{content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},associations:{contentConnector:{type:"sap.ui.vk.ContentConnector",multiple:false},viewStateManager:{type:"sap.ui.vk.ViewStateManagerBase",multiple:false}},events:{contentChanged:{enableEventBubbling:true}}},renderer:{apiVersion:2,render:function(e,t){e.openStart("div",t);e.class("sapUiSizeCompact");const n=t.getWidth();if(n!=null){e.style("width",n)}const s=t.getHeight();if(s!=null){e.style("height",s)}e.openEnd();e.renderControl(t.getAggregation("content"));e.close("div")}},constructor:function(e,t){w.apply(this,arguments);A.observeAssociations(this)}});q.prototype.onSetViewStateManager=function(e){this._manager=e;e.attachSelectionChanged(this._onViewportSelectionChanged,this);e.attachVisibilityChanged(this._onVisibilityChanged,this);this._refresh()};q.prototype.onUnsetViewStateManager=function(e){this._manager=null;e.detachSelectionChanged(this._onViewportSelectionChanged,this);e.detachVisibilityChanged(this._onVisibilityChanged,this);this._refresh()};q.prototype.onSetContentConnector=function(e){e.attachContentReplaced(this._onContentReplaced,this);this._setContent(e.getContent())};q.prototype.onUnsetContentConnector=function(e){this._setContent(null);e.detachContentReplaced(this._onContentReplaced,this)};q.prototype.init=function(){w.prototype.init?.apply(this);const r={expandedFilterSummary:"",snappedFilterSummary:""};const b=[U.Component,U.Net];this._scene=null;this._model=new B;this._skipEvent=false;this._filterSummaryModel=new B(r);this._elementTypeModel=new B(b);this.setModel(this._filterSummaryModel,z.FilterSummary);this.setModel(this._elementTypeModel,z.ElementType);this.setAggregation("content",new f({illustrationType:y.NoData,enableVerticalResponsiveness:true}));this._promise=Promise.all([M.load("sap.f"),M.load("sap.ui.comp")]).then(()=>new Promise(r=>{sap.ui.require(["sap/f/DynamicPage","sap/f/DynamicPageTitle","sap/f/DynamicPageHeader","sap/ui/comp/filterbar/FilterBar","sap/ui/comp/filterbar/FilterGroupItem"],(b,S,T,C,w)=>{this._showButton=new t({enabled:false,icon:R.Visible,text:O().getText("ELEMENTS_PANEL_SHOW_BUTTON"),tooltip:O().getText("ELEMENTS_PANEL_SHOW_BUTTON_TOOLTIP"),press:this._onShowElements.bind(this)});this._hideButton=new t({enabled:false,icon:R.Hidden,text:O().getText("ELEMENTS_PANEL_HIDE_BUTTON"),tooltip:O().getText("ELEMENTS_PANEL_HIDE_BUTTON_TOOLTIP"),press:this._onHideElements.bind(this)});this._settingsButton=new t({icon:"sap-icon://action-settings",tooltip:O().getText("ELEMENTS_PANEL_SETTINGS_BUTTON_TOOLTIP"),press:this._onSettings.bind(this)});const P=new l({showTableSettingsButton:true,beforeOpen:this._onBeforeOpenColumnMenu.bind(this),tableSettingsPressed:this._onSettings.bind(this),quickActions:[new c({change:this._onSort.bind(this),items:[new u]})]});const M=new l({showTableSettingsButton:true,beforeOpen:this._onBeforeOpenColumnMenu.bind(this),tableSettingsPressed:this._onSettings.bind(this),quickActions:[new c({change:this._onSort.bind(this),items:[new u]}),new h({change:this._onGroup.bind(this),items:[new p]})]});this._rowTemplate=new g({vAlign:"Middle",cells:[new i({text:"{refdes}",customData:new N({key:"key",value:H.RefDes})}),new i({text:{path:"",formatter:Q,customData:new N({key:"key",value:H.Type})}}),new i({text:"{deviceref}",customData:new N({key:"key",value:H.Device})}),new L({src:{path:"",formatter:function(e){switch(K(e)){case V.Hidden:return R.Hidden;case V.Partial:return R.Partial;default:return R.Visible}}},tooltip:{path:"",formatter:function(e){switch(K(e)){case V.Hidden:return O().getText("ELEMENTS_PANEL_VISIBLE_COLUMN_HIDDEN_TOOLTIP");case V.Partial:return O().getText("ELEMENTS_PANEL_VISIBLE_COLUMN_PARTIAL_TOOLTIP");default:return O().getText("ELEMENTS_PANEL_VISIBLE_COLUMN_VISIBLE_TOOLTIP")}}},customData:new N({key:"key",value:H.Visibility})})]});this._table=new o({id:"elements-table",mode:"MultiSelect",fixedLayout:"Strict",autoPopinMode:true,popinLayout:"GridSmall",includeItemInSelection:true,sticky:[F.Sticky.HeaderToolbar,F.Sticky.ColumnHeaders],selectionChange:this._onTableSelectionChanged.bind(this),headerToolbar:new n({content:[new s,this._showButton,this._hideButton,this._settingsButton]}),dependents:[new _({columnResize:this._onColumnResize.bind(this)})],columns:[new d({headerMenu:P,hAlign:v.TextAlign.Begin,customData:new N({key:"key",value:H.RefDes}),header:new i({text:O().getText("ELEMENTS_PANEL_NAME_COLUMN")})}),new d({headerMenu:M,hAlign:v.TextAlign.Begin,customData:new N({key:"key",value:H.Type}),header:new i({text:O().getText("ELEMENTS_PANEL_TYPE_COLUMN")})}),new d({headerMenu:M,hAlign:v.TextAlign.Begin,customData:new N({key:"key",value:H.Device}),header:new i({text:O().getText("ELEMENTS_PANEL_DEVICE_REFERENCE_COLUMN")})}),new d({hAlign:v.TextAlign.Center,customData:new N({key:"key",value:H.Visibility}),header:new i({text:O().getText("ELEMENTS_PANEL_VISIBLE_COLUMN")})})],items:{path:"/",template:this._rowTemplate}});this._table.setModel(this._model);this._filterBar=new C({useToolbar:false,persistencyKey:"Filters",search:this._onSearch.bind(this),filterChange:this._onFilterChange.bind(this),assignedFiltersChanged:this._onAssignedFiltersChanged.bind(this),filterGroupItems:[new w({name:H.RefDes,label:O().getText("REFDES_FILTER_LABEL"),groupName:"basic",visible:true,visibleInFilterBar:true,control:new a({change:this._onFilterChange.bind(this)})}),new w({name:H.Type,label:O().getText("TYPE_FILTER_LABEL"),groupName:"basic",visible:true,visibleInFilterBar:true,control:new m({selectionChange:this._onFilterChange.bind(this),items:{path:z.ElementType+">/",templateShareable:false,template:new sap.ui.core.Item({key:"{"+z.ElementType+">}",text:{path:z.ElementType+">",formatter:function(e){switch(e){case U.Component:return O().getText("ELEMENTS_PANEL_TYPE_COMPONENT");case U.Net:return O().getText("ELEMENTS_PANEL_TYPE_NET");default:return O().getText("ELEMENTS_TYPE_FILTER_ALL")}}}})}})}),new w({name:H.Device,label:O().getText("DEVICE_REF_FILTER_LABEL"),groupName:"basic",visible:true,visibleInFilterBar:true,control:new a({change:this._onFilterChange.bind(this)})})]});this._page=new b({visible:false,fitContent:true,showFooter:false,headerExpanded:false,title:new S({heading:this._filterTitle,expandedContent:new i({text:"{"+z.FilterSummary+">/expandedFilterSummary}"}),snappedContent:new i({text:"{"+z.FilterSummary+">/snappedFilterSummary}"})}),header:new T({content:this._filterBar}),content:this._table});this._message=new f({illustrationType:y.NoData,enableVerticalResponsiveness:true});const B=new e({height:"100%",renderType:F.FlexRendertype.Bare,items:[this._page,this._message]});this.destroyAggregation("content");this.setAggregation("content",B);this._p13nEngine=E.getInstance();this._registerForP13n();this._filterBar.addEventDelegate({onsapenter:e=>{const t=e.srcControl;if(this._filterBar.getFilterGroupItems().some(e=>{const n=e.getControl();return n===t||Y(n,t)})){this._onAssignedFiltersChanged();this._updateFilterBarToolbarText();this._onSearch()}}});this._filterBar.registerGetFiltersWithValues(this._getFiltersWithValues.bind(this));this._onAssignedFiltersChanged();this._updateFilterBarToolbarText();r()})}))};q.prototype.exit=function(){this._promise=this._promise.then(()=>{this._p13nEngine.detachStateChange(this._onTableStateChange);this._p13nEngine.deregister(this._table);this._p13nEngine=null;this._metadataHelper.destroy();this._metadataHelper=null;this._model.destroy();this._model=null;this._elementTypeModel.destroy();this._elementTypeModel=null;this._filterSummaryModel.destroy();this._filterSummaryModel=null;w.prototype.exit?.apply(this)})};q.prototype._updateMessage=function(e){const t=this._table.getItems().length>0;const n=e===true?this._table:this._page;n.setVisible(t);this._message.setVisible(!t);this._message.setIllustrationType(e===true?y.NoFilterResults:sap.m.IllustratedMessageType.NoData)};q.prototype._refresh=async function(){await this._promise;if(!this._scene||!this._manager){this._model?.setData([]);this._updateMessage(false);return}const e=new Map;this._scanTree(e,this._scene.getRootElement());const t=e.values().toArray();this._model.setSizeLimit(t.length);this._model.setData(t);this._table.setModel(this._model);this._updateMessage(false);this.fireContentChanged()};q.prototype._registerForP13n=function(){this._metadataHelper=new C([{groupable:false,key:H.RefDes,path:H.RefDes,label:O().getText("ELEMENTS_PANEL_NAME_COLUMN")},{key:H.Type,path:H.Type,label:O().getText("ELEMENTS_PANEL_TYPE_COLUMN")},{key:H.Device,path:H.Device,label:O().getText("ELEMENTS_PANEL_DEVICE_REFERENCE_COLUMN")},{sortable:false,groupable:false,key:H.Visibility,path:H.Visibility,label:O().getText("ELEMENTS_PANEL_VISIBLE_COLUMN")}]);this._p13nEngine.register(this._table,{helper:this._metadataHelper,controller:{columnStates:new b({control:this._table,targetAggregation:"columns",getKeyForItem:G}),columnWidthStates:new r({control:this._table}),sortStates:new T({control:this._table}),groupStates:new S({control:this._table})}});this._p13nEngine.attachStateChange(this._onTableStateChange.bind(this));const e={columnStates:this._metadataHelper.getProperties().map(({key:e})=>({key:e})),sortStates:[{key:H.RefDes,descending:false}]};this._p13nEngine.applyState(this._table,e)};q.prototype._onSettings=function(){this._p13nEngine.show(this._table,["columnStates","sortStates","groupStates"],{source:this._table})};q.prototype._setScene=function(e){this._scene=e?.isECADScene()?e:null;this._refresh()};q.prototype._addElement=function(e,t,n){const s=n.get("type");const i=n.get("refdes");const a=n.get("deviceref");var o=e.get(i);if(!o){o={refdes:i,type:s,deviceref:a,parts:new Map,hiddenParts:new Set};e.set(i,o)}switch(s){case U.Component:o.parts.set(t.uid,t);if(this._manager.getVisibilityState(t)===false){o.hiddenParts.add(t.uid)}break;case U.Net:t.children.forEach(e=>{o.parts.set(e.uid,e);if(this._manager.getVisibilityState(e)===false){o.hiddenParts.add(e.uid)}});break;default:break}};q.prototype._scanTree=function(e,t){const n=j(t);if(n){const s=n.get("refdes");if(s){this._addElement(e,t,n);return}}t.children.forEach(t=>this._scanTree(e,t))};q.prototype._onTableSelectionChanged=function(e){const t=e.getParameter("listItems");const n=e.getParameter("selected");const s=[];t.forEach(e=>{const t=e.getBindingContext().getObject();switch(t.type){case U.Component:s.push(t.parts.values().toArray()[0]);break;case U.Net:s.push(t.parts.values().toArray()[0].parent);break;default:break}});this._manager.setSelectionState(s,n,true,true);this._updateButtons()};q.prototype._onViewportSelectionChanged=function(e){const t=this._table.getItems();const n=e.getParameter("selected");const s=e.getParameter("unselected");const i=(e,t,n)=>{const s=t.getBindingContext().getObject();e.forEach(e=>{const i=j(e);const a=i?.get("refdes");if(a===s.refdes){this._table.setSelectedItem(t,n,false)}})};t.forEach(e=>{i(n,e,true);i(s,e,false)});this._updateButtons()};q.prototype._setContent=function(e){if(e&&!this.getViewStateManager()){const e=P.getElementById(this.getContentConnector());if(e){const t=e.getDefaultViewStateManager();if(t){this.setViewStateManager(t)}}}this._setScene(e);return this};q.prototype._onContentReplaced=function(e){this._setContent(e.getParameter("newContent"))};q.prototype._updateButtons=function(){let e=false;let t=false;const n=this._table.getSelectedItems();n.forEach(n=>{const s=n.getBindingContext().getObject();const i=K(s);if(i===V.Visible){e=true}else if(i===V.Hidden){t=true}else{e=t=true}});this._showButton.setEnabled(t);this._hideButton.setEnabled(e)};q.prototype._onShowElements=function(){const e=[];const t=this._table.getSelectedItems();t.forEach(t=>{const n=t.getBindingContext().getObject();if(n.hiddenParts.size>0){const t=n.parts.values().toArray()[0];n.hiddenParts.clear();if(n.type===U.Component){e.push(t)}else if(n.type===U.Net){e.push(t.parent)}}});this._skipEvent=true;this._manager.setVisibilityState(e,true,true,true);this._model.updateBindings(true);this._updateButtons()};q.prototype._onHideElements=function(){const e=[];const t=this._table.getSelectedItems();t.forEach(t=>{const n=t.getBindingContext().getObject();if(n.hiddenParts.size<n.parts.size){const t=n.parts.values().toArray()[0];n.parts.forEach(e=>n.hiddenParts.add(e.uid));if(n.type===U.Component){e.push(t)}else if(n.type===U.Net){e.push(t.parent)}}});this._skipEvent=true;this._manager.setVisibilityState(e,false,true,true);this._model.updateBindings(true);this._updateButtons()};q.prototype._onVisibilityChanged=async function(e){if(this._skipEvent){this._skipEvent=false;return}const t=e.getParameter("hidden");const n=e.getParameter("visible");await this._promise;const s=(e,t,n)=>{e.forEach(e=>{const s=j(e);const i=s?.get("refdes");if(i===t.refdes){switch(s.get("type")){case U.Component:if(n){t.hiddenParts.delete(e.uid)}else{t.hiddenParts.add(e.uid)}break;case U.Net:if(n){e.children.forEach(e=>t.hiddenParts.delete(e.uid))}else{e.children.forEach(e=>t.hiddenParts.add(e.uid))}break;default:break}}else{const i=s?.get("layer");if(i){if(t.parts.has(e.uid)){if(n){t.hiddenParts.delete(e.uid)}else{t.hiddenParts.add(e.uid)}}}}})};this._model.getData().forEach(e=>{s(t,e,false);s(n,e,true)});this._model.updateBindings(true);this._updateButtons()};q.prototype._onSearch=function(){this._table.setShowOverlay(true);const e=this._getFiltersWithValues().reduce((e,t)=>{var n=t.getControl();const s=t.getName();var i=[];switch(s){case H.RefDes:case H.Device:const e=n.getValue();i.push(new k({path:t.getName(),operator:x.Contains,value1:e}));break;case H.Type:const s=n.getSelectedKeys();s.forEach(e=>i.push(new k({path:t.getName(),operator:x.Contains,value1:e})));break;default:break}if(i.length>0){e.push(new k({filters:i,and:false}))}return e},[]);this._table.getBinding("items").filter(e);this._table.setShowOverlay(false);this._updateMessage(true)};q.prototype._onFilterChange=function(){this._table.setShowOverlay(true)};q.prototype._onAssignedFiltersChanged=function(){this._filterSummaryModel.setProperty("/snappedFilterSummary",this._filterBar.retrieveFiltersWithValuesAsText());this._filterSummaryModel.setProperty("/expandedFilterSummary",this._filterBar.retrieveFiltersWithValuesAsTextExpanded())};q.prototype._getFiltersWithValues=function(){return this._filterBar.getFilterGroupItems().filter(e=>{const t=e.getControl();if(t instanceof m){return t.getSelectedItems().length>0}else if(t instanceof a){return t.getValue().length>0}else{return false}})};q.prototype._updateFilterBarToolbarText=function(){this._filterBar._updateToolbarText?.()};q.prototype._onBeforeOpenColumnMenu=function(e){const t=e.getSource();const n=e.getParameter("openBy");const s=t.getQuickActions();const i=s.find(e=>e instanceof c);if(i!=null){const e=i.getItems()[0];e.setKey(G(n));e.setLabel(n.getHeader().getText(false));e.setSortOrder(n.getSortIndicator())}const a=s.find(e=>e instanceof h);if(a!=null){const e=a.getItems()[0];e.setKey(G(n));e.setLabel(n.getHeader().getText(false));e.setGrouped(n.data("grouped"))}};q.prototype._onColumnResize=function(e){};q.prototype._onSort=function(e){this._p13nEngine.retrieveState(this._table).then(t=>{const n=t.sortStates;for(const e of n){e.sorted=false}const s=e.getParameter("item");const i=s.getKey();const a=s.getSortOrder();if(a!==D.None){n.push({key:i,descending:a===D.Descending})}this._p13nEngine.applyState(this._table,t)})};q.prototype._onGroup=function(e){this._p13nEngine.retrieveState(this._table).then(t=>{const n=t.groupStates;for(const e of n){e.grouped=false}const s=e.getParameter("item");const i=s.getKey();if(s.getGrouped()){n.push({key:i})}this._p13nEngine.applyState(this._table,t)})};q.prototype._onTableStateChange=function(e){if(e.getParameter("control")!==this._table){return}const t=e.getParameter("state");if(t==null){return}const n=this._table.getBindingInfo("items");const s={path:n.path,model:n.model,factory:n.factory};const i=this._table.getColumns();for(const e of i){e.setVisible(false);e.setSortIndicator(D.None);e.data("grouped",false);const n=t.columnWidthStates[G(e)];if(n!==undefined){e.setWidth()}}const a=this._rowTemplate.getCells();t.columnStates.forEach((e,t)=>{const n=W(this._table.getColumns(),e.key);n.setVisible(true);this._table.removeColumn(n);this._table.insertColumn(n,t);const s=W(a,e.key);this._rowTemplate.removeCell(s);this._rowTemplate.insertCell(s,t)});s.sorter=[];if(t.groupStates.length===1){const e=t.groupStates[0].key;const n=this._metadataHelper.getProperty(e).path;const a=t.sortStates.find(t=>t.key===e);const o=a?.descending??false;const r=e=>{switch(n){case H.Type:return Q(e.getObject());default:return e.getProperty(n)}};s.sorter.push(new I(n,o,r));const l=W(i,e);l.data("grouped",true)}for(let e of t.sortStates){const n=W(i,e.key);n.setSortIndicator(e.descending?D.Descending:D.Ascending);if(t.groupStates[0]?.key===e.key){continue}const a=this._metadataHelper.getProperty(e.key).path;s.sorter.push(new I(a,e.descending))}this._table.bindItems(s)};return q});
//# sourceMappingURL=ElementsPanel.js.map