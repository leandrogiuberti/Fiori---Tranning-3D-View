/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Element","sap/ui/core/delegate/ScrollEnablement","sap/ui/core/ResizeHandler","../abgrToColor","../cssColorToColor","../Loco","../SelectionMode","../ViewportBase","../svg/Element","./ViewportRenderer","./Utils"],(t,e,n,s,o,i,a,r,l,c,h,p)=>{"use strict";const u="http://www.w3.org/2000/svg";const d=1.1;const g=.01;const f=100;const _=10;const m="scrollContainer";const C="document";const v="page";const y="pdfCanvas";const w="pdfStretchedCanvas";const H="pdfHighResCanvas";const R="hotspotSurface";const S=0;const P=1;const x=2;const b=l.extend("sap.ui.vk.pdf.Viewport",{metadata:{library:"sap.ui.vk",properties:{currentPageIndex:{type:"int",defaultValue:0}},events:{pageChanged:{parameters:{newPageIndex:"int",oldPageIndex:"int"}},documentReplaced:{parameters:{oldDocument:"sap.ui.vk.pdf.Document",newDocument:"sap.ui.vk.pdf.Document"}}}},renderer:h});const D=b.getMetadata().getName();b.prototype.init=function(){l.prototype.init?.call(this);this._document=null;this._page=null;this._scene=null;const t=document.createElementNS(u,"svg");t.id=`${this.getId()}-${R}`;t.classList.add("sapVizKitPDFHotspotSurface");t.setAttribute("viewBox","0 0 1 1");this._hotspotSurface=t;this._currentHotspotElement=null;this._normalCanvas=null;this._stretchedCanvas=null;this._highResCanvas=null;this._renderTasks=[];this._contentReplaced=false;this.attachBrowserEvent("wheel",this._onWheel,this);this._onScroll=this._onScroll.bind(this);this._onResize=this._onResize.bind(this);this._resizeListenerId=null;this._scale=1;this._scrolling=false;this._resizing=false;this._scrollContainer=new n(this,`${this.getId()}-${C}`,{horizontal:true,vertical:true,scrollContainerId:`${this.getId()}-${m}`});this._pageNavigationEnabled=true;const e=this._loco=new a(this);this._camera={zoom:this._scale,_screenToWorld:(t,e)=>{const n=this._page;if(n==null){return{x:0,y:0}}const{pageX:s,pageY:o,pageWidth:i,pageHeight:a}=n.rawDimensions;const{width:r,height:l}=this.getDomRef(v).getBoundingClientRect();return{x:t/r*i+s,y:e/l*a+o}},_worldToScreen:(t,e)=>{const n=this._page;if(n==null){return{x:0,y:0}}const{pageX:s,pageY:o,pageWidth:i,pageHeight:a}=n.rawDimensions;const{width:r,height:l}=this.getDomRef(v).getBoundingClientRect();return{x:(t-s)/i*r,y:(e-o)/a*l}},_transformRect:t=>{const e=this._page;if(e==null){return{x1:0,y1:0,x2:0,y2:0}}const{x:n,y:s}=this._camera._screenToWorld(t.x1,t.y1);const{x:o,y:i}=this._camera._screenToWorld(t.x2,t.y2);return{x1:Math.min(n,o),y1:Math.min(s,i),x2:Math.max(n,o),y2:Math.max(s,i)}}};const s=this._gestureHandler={click:t=>{if(this._document!=null){const{event:e}=t;const n=this.hitTest(e.clientX,e.clientY);const s={picked:n?[n]:[]};this.fireNodesPicked(s);if(this.getSelectionMode()===r.Exclusive){this.exclusiveSelectionHandler(s.picked)}else if(this.getSelectionMode()===r.Sticky){this.stickySelectionHandler(s.picked)}}},hover:t=>{if(this._document!=null&&!this.getDisableHotspotHovering()){const{event:e}=t;const n=this._currentHotspotElement;const s=this.hitTest(e.clientX,e.clientY);if(s!=n){if(!this.getShowAllHotspots()){n?.setHotspotColor(1,null);s?.setHotspotColor(1,"#bb000059")}this._currentHotspotElement=s}}}};e.addHandler(s)};b.prototype.exit=function(){this._loco.removeHandler(this._gestureHandler).destroy();this._loco=null;this._gestureHandler=null;this.detachBrowserEvent("wheel",this._onWheel,this);this._scrollContainer.destroy();this._scrollContainer=null;this._unsubscribeFromEvents();this._highResCanvas=null;this._stretchedCanvas=null;this._normalCanvas=null;this._hotspotSurface=null;this._currentHotspotElement=null;this._scene=null;this._page=null;this._document=null;l.prototype.exit?.call(this)};b.prototype.getIdForLabel=function(){return`${this.getId()}-${v}`};b.prototype.getScrollDelegate=function(){return this._scrollContainer};b.prototype._subscribeToEvents=function(){this.$(m).on("scroll",this._onScroll);this._resizeListenerId=s.register(this,this._onResize)};b.prototype._unsubscribeFromEvents=function(){s.deregister(this._resizeListenerId);this._resizeListenerId=null;this.$(m).off("scroll",this._onScroll)};b.prototype.onSetContentConnector=function(t){l.prototype.onSetContentConnector.call(this,t);t.attachEvent("_contentUpdated",this._onContentUpdated,this)};b.prototype.onUnsetContentConnector=function(t){t.detachEvent("_contentUpdated",this._onContentUpdated,this);l.prototype.onUnsetContentConnector.call(this,t)};b.prototype._setContent=function(t){l.prototype._setContent.call(this,t);const e=this._document;if(t===e){return}this._document=t;this._scene=t?.scene;this._page=null;this._deleteHighResCanvas();this._deleteStretchedCanvas();this._deleteNormalCanvas();this._scale=this._camera.zoom=1;this._currentHotspotElement=null;this.fireEvent("documentReplaced",{oldDocument:e,newDocument:t},false,true);if(t!=null){this._applyHotspotHoveringClass(this.getDisableHotspotHovering());this._applyShowAllHotspots(this.getShowAllHotspots());this._contentReplaced=true;this.setCurrentPageIndex(this.getCurrentPageIndex())}this.invalidate()};b.prototype._onContentUpdated=function(t){this._applyHotspotHoveringClass(this.getDisableHotspotHovering());this._applyShowAllHotspots(this.getShowAllHotspots())};b.prototype._createNormalCanvas=function(){const t=document.createElement("canvas");t.id=`${this.getId()}-${y}`;t.classList.add("sapVizKitPDFNormalCanvas");return t};b.prototype._createStretchedCanvas=function(){const t=document.createElement("canvas");t.id=`${this.getId()}-${w}`;t.classList.add("sapVizKitPDFStretchedCanvas");return t};b.prototype._createHighResCanvas=function(){const t=document.createElement("canvas");t.id=`${this.getId()}-${H}`;t.classList.add("sapVizKitPDFHighResCanvas");return t};b.prototype._deleteNormalCanvas=function(){this._normalCanvas?.remove();this._normalCanvas=null};b.prototype._deleteStretchedCanvas=function(){this._stretchedCanvas?.remove();this._stretchedCanvas=null};b.prototype._deleteHighResCanvas=function(){this._highResCanvas?.remove();this._highResCanvas=null};b.prototype._layoutPage=function({page:t,scale:n=this._scale,firstTimePageRendering:s=false,zoomCenter:o=null}){const i=this.getDomRef(v);if(i==null){return null}const a={};const{cssWidth:r,cssHeight:l,width:c,height:h}=this._calculatePDFCanvasSize(t,n);const p=Math.max(screen.width,screen.height);const u=r>p||l>p;const d=this._normalCanvas!=null?P:this._stretchedCanvas!=null?x:S;const g=u?x:P;const f=this.getDomRef(m);if(d===S){const t=this._createNormalCanvas();const{style:e}=t;e.width=`${r}px`;e.height=`${l}px`;this._normalCanvas=t;i.appendChild(t)}if(g===P){const t=this._createNormalCanvas();t.width=c;t.height=h;const{style:e}=t;e.width=`${r}px`;e.height=`${l}px`;a.normal={canvas:t,scale:n}}else if(d!==x||s){const e=this._createStretchedCanvas();const{width:n,height:s}=this._calculatePDFCanvasSize(t,1);let o;if(n>s){e.width=p;e.height=p*s/n;o=p/n}else{e.width=p*n/s;e.height=p;o=p/s}const{style:i}=e;i.width=`${r}px`;i.height=`${l}px`;a.stretched={canvas:e,scale:o}}if(o!=null){const s=this._screenToPage(t,o[0],o[1]);this._scale=this._camera.zoom=n;this.getTools().map(t=>e.getElementById(t)).filter(t=>t.isA("sap.ui.vk.tools.TransformSvgElementTool")).map(t=>t.getGizmoForContainer(this)).filter(t=>t?.hasDomElement()).forEach(t=>t.rerender());i.style.setProperty("--sapUiVizKitRedlineScale",n);const{style:a}=this._normalCanvas??this._stretchedCanvas;a.width=`${r}px`;a.height=`${l}px`;const c=this._pageToScreen(t,s[0],s[1]);f.scrollBy({left:c[0]-o[0],top:c[1]-o[1],behavior:"instant"})}else{const{style:t}=this._normalCanvas??this._stretchedCanvas;t.width=`${r}px`;t.height=`${l}px`}if(g===x){const t=f.getBoundingClientRect();const e=i.getBoundingClientRect();const s=E(t,e);const{devicePixelRatio:o}=window;const r=this._createHighResCanvas();r.width=Math.round(s.width*o);r.height=Math.round(s.height*o);const{style:l}=r;l.width=`${s.width/e.width*100}%`;l.height=`${s.height/e.height*100}%`;l.left=`${(s.left-e.left)/e.width*100}%`;l.top=`${(s.top-e.top)/e.height*100}%`;a.highRes={canvas:r,scale:n,offsetX:Math.min(e.left-t.left,0),offsetY:Math.min(e.top-t.top,0)}}this._redlineHandler?._tool.getGizmo().rerender();return a};b.prototype._cancelRenderTasks=async function(){const t=this._renderTasks;for(const e of t){e.cancel()}try{await Promise.all(t.map(({promise:t})=>t))}catch(t){}t.splice(0)};b.prototype._renderPage=async function({page:e,canvases:n}){if(this.getDomRef(v)==null){return}await this._cancelRenderTasks();const s=this._renderTasks;try{const{normal:t,stretched:o,highRes:i}=n;if(t!=null){const{canvas:n,scale:o}=t;s.push(e.renderToCanvas(n,o))}else{if(o!=null){const{canvas:t,scale:n}=o;s.push(e.renderToCanvas(t,n))}const{canvas:t,scale:n,offsetX:a,offsetY:r}=i;s.push(e.renderToCanvas(t,n,a,r))}await Promise.all(s.map(({promise:t})=>t));const a=this.getDomRef(v);if(a==null){return}if(t!=null){this._deleteHighResCanvas();this._deleteStretchedCanvas();this._deleteNormalCanvas();const{canvas:e}=t;this._normalCanvas=e;a.appendChild(e)}else{this._deleteNormalCanvas();if(o!=null){this._deleteStretchedCanvas();const{canvas:t}=o;this._stretchedCanvas=t;a.appendChild(t)}this._deleteHighResCanvas();const{canvas:t}=i;this._highResCanvas=t;a.appendChild(t)}}catch(e){if(e instanceof p.getPdfjsLib().RenderingCancelledException){t.debug("Rendering cancelled",e,D)}else{t.error("Failed to render PDF page",e,D)}}finally{s.splice(0)}};b.prototype._render=async function({page:t,scale:e=this._scale,firstTimePageRendering:n=false,zoomCenter:s=null}={}){const o=this._layoutPage({page:t,scale:e,firstTimePageRendering:n,zoomCenter:s});await this._renderPage({page:t,canvases:o})};b.prototype.onAfterRendering=function(t){this._subscribeToEvents();const e=this.getDomRef(v);e.appendChild(this._hotspotSurface);if(this._normalCanvas!=null){e.appendChild(this._normalCanvas)}if(this._stretchedCanvas!=null){e.appendChild(this._stretchedCanvas)}if(this._highResCanvas!=null){e.appendChild(this._highResCanvas)}};b.prototype.onBeforeRendering=function(t){this._unsubscribeFromEvents()};b.prototype.setCurrentPageIndex=function(t){const e=this._document;if(e==null){this.setProperty("currentPageIndex",t,true);return this}const n=Math.max(0,Math.min(t,e.pageCount-1));const s=this.getCurrentPageIndex();if(n===s&&!this._contentReplaced){return this}this._contentReplaced=false;this.setProperty("currentPageIndex",n,true);(async()=>{const t=await e.getPage(n);this._page=t;const s=this._normalCanvas??this._stretchedCanvas;if(s!=null){p.clearCanvas(s)}this._updateHotspotSurface();await this._render({page:t,firstTimePageRendering:true})})();this.fireEvent("pageChanged",{newPageIndex:n,oldPageIndex:s},false,true);return this};b.prototype.setPageNavigationEnabled=function(t){this._pageNavigationEnabled=t;this.getContent().find(t=>t.isA("sap.ui.vk.DrawerToolbar"))?.setPageNavigationEnabled(t);return this};b.prototype._calculatePDFCanvasSize=function(t,e){const n=t.userUnit*e*96/72;const{pageWidth:s,pageHeight:o}=t.rawDimensions;const i=s*n;const a=o*n;const{devicePixelRatio:r}=window;return{cssWidth:Math.round(i),cssHeight:Math.round(a),width:Math.round(i*r),height:Math.round(a*r)}};b.prototype._screenToPage=function(t,e,n){const{left:s,top:o}=this.getDomRef(v).getBoundingClientRect();return t.cssPixelToPDFPoint(e-s,n-o,this._scale)};b.prototype._pageToScreen=function(t,e,n){const{left:s,top:o}=this.getDomRef(v).getBoundingClientRect();const[i,a]=t.pdfPointToCSSPixel(e,n,this._scale);return[s+i,o+a]};b.prototype._isKeyboardPageNavigationPossible=function(t){return t.srcControl===this&&this._page!=null&&this._pageNavigationEnabled};b.prototype.onsappageup=function(t){if(!this._isKeyboardPageNavigationPossible(t)){return}t.preventDefault();this.setCurrentPageIndex(this.getCurrentPageIndex()-1)};b.prototype.onsappagedown=function(t){if(!this._isKeyboardPageNavigationPossible(t)){return}t.preventDefault();this.setCurrentPageIndex(this.getCurrentPageIndex()+1)};b.prototype.onsaphome=function(t){if(!this._isKeyboardPageNavigationPossible(t)){return}t.preventDefault();this.setCurrentPageIndex(0)};b.prototype.onsapend=function(t){if(!this._isKeyboardPageNavigationPossible(t)){return}t.preventDefault();this.setCurrentPageIndex(this._document.pageCount-1)};b.prototype._onWheel=function(t){if(this._page==null){return}if(!t.ctrlKey){return}t.preventDefault();const e=Math.min(Math.max(-t.originalEvent.deltaY,-20),20);this.zoom(Math.pow(2,e/100),t.clientX,t.clientY)};b.prototype._onScroll=function(t){if(this._page==null){return}if(this._highResCanvas!=null&&!this._scrolling){this._scrolling=true;setTimeout(()=>{this._scrolling=false;this._render({page:this._page})},500)}};b.prototype._onResize=function(t){if(this._page!=null){if(this._highResCanvas!=null&&!this._resizing){this._resizing=true;setTimeout(()=>{this._resizing=false;this._render({page:this._page})},500)}}const{width:e,height:n}=t.size;this.fireResize({size:{width:e,height:n}})};b.prototype.onkeydown=function(t){if(t.srcControl!==this||this._page==null){return}if(t.ctrlKey){let e=true;let n=1;switch(t.key){case"+":case"=":n=d;break;case"-":case"_":n=1/d;break;case"0":n=1/this._scale;break;default:e=false;break}if(e){t.preventDefault();const{left:e,top:s,right:o,bottom:i}=this.getDomRef(v).getBoundingClientRect();this.zoom(n,(e+o)/2,(s+i)/2)}}else if(!t.altKey){let e=0;let n=0;let s=true;switch(t.key){case"ArrowLeft":e=-_;break;case"ArrowRight":e=_;break;case"ArrowUp":n=-_;break;case"ArrowDown":n=_;break;default:s=false;break}if(s){t.preventDefault();this.pan(e,n)}}};b.prototype.pan=function(t,e){if(this._page==null){return}const n=this.getDomRef(m);if(n==null){return}const{scrollLeft:s,scrollTop:o}=n;this._scrollContainer.scrollTo(s+t,o+e);if(this._highResCanvas!=null){this._render({page:this._page})}};b.prototype.zoom=function(t,e,n){if(this._page==null){return}const s=this._page;if(s==null||t===1){return}const o=this._scale;const i=Math.min(Math.max(o*t,g),f);if(i!=o){this._render({page:s,scale:i,zoomCenter:[e,n]})}};b.prototype.zoomToFitPage=function(){const t=this._page;const e=this.getDomRef();if(t==null||e==null){return}const{cssWidth:n,cssHeight:s}=this._calculatePDFCanvasSize(t,1);const o=n/s;const{clientWidth:i,clientHeight:a}=e;const{paddingLeft:r,paddingRight:l,paddingTop:c,paddingBottom:h}=getComputedStyle(this.getDomRef(m));const p=i-parseFloat(r)-parseFloat(l);const u=a-parseFloat(c)-parseFloat(h);const d=p/u;const g=d<o?p:u*o;this._render({page:t,scale:g/n,zoomCenter:[i/2,a/2]})};b.prototype.zoomToFitPageWidth=function(){const t=this._page;const e=this.getDomRef();if(t==null||e==null){return}const{cssWidth:n,cssHeight:s}=this._calculatePDFCanvasSize(t,1);const{clientWidth:o,clientHeight:i}=e;const{paddingLeft:a,paddingRight:r,paddingTop:l,paddingBottom:c}=getComputedStyle(this.getDomRef(m));const h=o-parseFloat(a)-parseFloat(r);const p=i-parseFloat(l)-parseFloat(c);let u=h;const d=s*u/n;if(d>p){u-=z()}this._render({page:t,scale:u/n,zoomCenter:[o/2,i/2]})};b.prototype.setShouldRenderFrame=function(){};b.prototype.getOutputSize=function(){const{width:t,height:e}=this.getDomRef(v).getBoundingClientRect();const n=Math.min(t,e);return{left:(t-n)*.5,top:(e-n)*.5,sideLength:n}};b.prototype.onmousedown=function(t){const e=this._redlineHandler;if(e!=null&&t.srcControl.isA("sap.ui.vk.RedlineElementText")&&e._tool.getGizmo()?._textEditingElement==null){t.preventDefault();this.focus();return}};function E(t,e){if(t.right<e.left||e.right<t.left||t.bottom<e.top||e.bottom<t.top){return new DOMRect(0,0,0,0)}const n=Math.max(t.left,e.left);const s=Math.max(t.top,e.top);const o=Math.min(t.right,e.right);const i=Math.min(t.bottom,e.bottom);return new DOMRect(n,s,o-n,i-s)}function z(){const t=document.createElement("div");t.style.visibility="hidden";t.style.overflow="scroll";document.body.appendChild(t);const e=document.createElement("div");t.appendChild(e);const n=t.offsetWidth-e.offsetWidth;t.remove();return n}b.prototype.getScene=function(){return this._document?.scene};b.prototype._getViewBox=function(){const t=this._page;if(t==null){return[0,0,1,1]}const{pageX:e,pageY:n,pageWidth:s,pageHeight:o}=t.rawDimensions;return[e,n,s,o]};b.prototype._updateHotspotSurface=function(){this._cleanupHotspotSurface();this._populateHotspotSurface()};b.prototype._cleanupHotspotSurface=function(){const t=this._hotspotSurface;for(let e=t.lastElementChild;e!=null;e=t.lastElementChild){e.remove()}};b.prototype._populateHotspotSurface=function(){const t=this._hotspotSurface;const e=new Map;const n=t=>e.set(c._hotspotEffectName(t),t);n(o(this._viewStateManager.getHighlightColor(true)));n(o(this.getHotspotColorABGR()));n(i(this.getShowAllHotspotsTintColor()));for(const t of this._document.scene.getDefaultNodeHierarchy().getHotspotNodeRefs()){const{name:n,color:s}=t.getHotspotEffectDef();e.set(n,s)}for(const[n,s]of e){const e=document.createElementNS(u,"filter");e.id=n;const o=document.createElementNS(u,"feColorMatrix");o.setAttribute("in","SourceGraphic");o.setAttribute("type","matrix");o.setAttribute("values",`0 0 0 0 ${s.red/255}, 0 0 0 0 ${s.green/255}, 0 0 0 0 ${s.blue/255}, 0 0 0 ${s.alpha} 0`);e.appendChild(o);t.appendChild(e)}t.setAttribute("viewBox",`${this._getViewBox().join(" ")}`);const{scene:s}=this._document;const a=s.getRootElement();const r=a.children[0];const{pageY:l,pageHeight:h}=this._page.rawDimensions;r.setMatrix([1,0,0,-1,0,h+2*l]);const p=this._createDomSvgElement(a);t.appendChild(p)};b.prototype._createDomSvgElement=function(t){const e=t.getPageIndex();if(e!=null&&e!==this.getCurrentPageIndex()){return null}const n=t.domRef=t._createDomElement();for(const e of t.children){const t=this._createDomSvgElement(e);if(t!=null){n.appendChild(t)}}return n};b.prototype.setDisableHotspotHovering=function(t){this.setProperty("disableHotspotHovering",t,true);this._applyHotspotHoveringClass(t);return this};b.prototype._applyHotspotHoveringClass=function(t){const e=this._document;if(e!=null){const n=t?"addClass":"removeClass";const s=e.scene.getDefaultNodeHierarchy().getHotspotNodeRefs();for(const t of s){t[n]("sapUiVizKitNonInteractiveHotspot")}}return this};b.prototype.setShowAllHotspots=function(t){this.setProperty("showAllHotspots",t,true);this._applyShowAllHotspots(t);return this};b.prototype._applyShowAllHotspots=function(t){const e=this._document;if(e==null){return}const n=e.scene.getDefaultNodeHierarchy().getHotspotNodeRefs();const s=this._currentHotspotElement;const o=this.getShowAllHotspotsTintColor();for(const e of n){if(t){e.setHotspotColor(1,o)}else if(e===s){e.setHotspotColor(1,this.getHotspotColorABGR())}else{e.setHotspotColor(1,null)}}};b.prototype.hitTest=function(t,e){const n=document.elementFromPoint(t,e);if(n!=null){const t=this._document.scene.getRootElement().getElementById(n.id);if(t!=null){return t._getSceneTreeElement()}}return null};b.prototype.onSetViewStateManager=function(t){this._viewStateManager=t;t.attachOutliningChanged(this._onOutliningOrSelectionChanged,this);t.attachSelectionChanged(this._onOutliningOrSelectionChanged,this)};b.prototype.onUnsetViewStateManager=function(t){t.detachOutliningChanged(this._onOutliningOrSelectionChanged,this);t.detachSelectionChanged(this._onOutliningOrSelectionChanged,this);this._viewStateManager=null};b.prototype._onOutliningOrSelectionChanged=function(t){for(const n of this.getTools()){const s=e.getElementById(n);const o=s.getGizmoForContainer(this);if(o&&o.handleSelectionChanged){o.handleSelectionChanged(t)}}};b.prototype.showHotspots=function(t,e,n){if(t==null){return this}if(!Array.isArray(t)){t=[t]}const s=e?n??this.getHotspotColorABGR():null;for(const e of t){e.setCustomHotspotColor(1,s)}this._updateHotspotSurface();return this};b.prototype.attachCameraChanged=function(){};b.prototype.detachCameraChanged=function(){};return b});
//# sourceMappingURL=Viewport.js.map