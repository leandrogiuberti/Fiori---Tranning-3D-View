/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","sap/m/library","sap/m/Slider","sap/m/VBox","sap/ui/core/Control","sap/ui/core/delegate/ItemNavigation","sap/ui/core/EnabledPropagator","../Core","./Utils","../getResourceBundle"],(e,t,s,n,i,o,a,r,l,h)=>{"use strict";const{FlexRendertype:u}=t;const c="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'></svg>";const g=sap.ui.require.toUrl("sap/ui/vk/themes/base/images/vk-pdf-page-error.svg");const d="thumbnail";const p="pageIndex";const _=25;const m=140;const f=206;const b=5;const y=5e3;const P=i.extend("sap.ui.vk.pdf.PageGalleryItem",{metadata:{library:"sap.ui.vk"},renderer:{apiVersion:2,render(e,t){const s=t.getId();e.openStart("div",s);e.class("sapVizKitPageGalleryItem");e.attr("tabindex",0);e.attr("data-sap-ui-vk-page-index",t._pageIndex);if(t._selected){e.class("sapVizKitPageGalleryItemSelected")}e.openEnd();{e.openStart("img",`${s}-${d}`);e.attr("src",t._thumbnail);e.attr("alt",h().getText("PAGE_ALT_TEXT",[t._pageIndex+1]));e.style("width",`${t._width}px`);e.style("height",`${t._height}px`);e.openEnd();e.close("img")}{e.openStart("div",`${s}-${p}`);e.class("sapMLabel");e.openEnd();const n=t._pageIndex;e.text(n!=null?n+1:"0");e.close("div")}e.close("div")}},init(){i.prototype.init?.call(this);this._pageIndex=null;this._selected=false;this._thumbnail=c;this._width=m;this._height=f;this._isDirty=true},setPageIndex(e){this._pageIndex=e;const t=this.getDomRef(p);if(t!=null){t.textContent=e}return this},setSelected(e){this._selected=e;const t=this.getDomRef();if(t!=null){if(e){t.classList.add("sapVizKitPageGalleryItemSelected")}else{t.classList.remove("sapVizKitPageGalleryItemSelected")}}return this},setThumbnail(e,t,s){this._thumbnail=e;this._width=t;this._height=s;const n=this.getDomRef(d);if(n!=null){n.src=e;const{style:i}=n;i.width=`${t}px`;i.height=`${s}px`}return this},setThumbnailSideLength(e){const{_width:t,_height:s,_thumbnail:n}=this;if(e===Math.max(t,s)){return this}if(t>s){this.setThumbnail(n,e,e*s/t)}else{this.setThumbnail(n,e*t/s,e)}this.setDirty(true);return this},getDirty(){return this._isDirty},setDirty(e){this._isDirty=e;return this}});const v=i.extend("sap.ui.vk.pdf.PageGallery",{metadata:{library:"sap.ui.vk",properties:{width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},currentPageIndex:{type:"int",defaultValue:0},thumbnailScale:{type:"float",defaultValue:_}},aggregations:{_slider:{type:"sap.m.Slider",multiple:false,visibility:"hidden"},_pages:{type:"sap.m.VBox",multiple:false,visibility:"hidden"}},associations:{contentConnector:{type:"sap.ui.vk.ContentConnector",multiple:false}},events:{pageChanged:{parameters:{newPageIndex:"int",oldPageIndex:"int"}},thumbnailScaleChanged:{parameters:{value:"float"}}}},renderer:{apiVersion:2,render(e,t){e.openStart("div",t);e.class("sapVizKitPageGallery");if(!t.getEnabled()){e.class("sapVizKitPageGalleryDisabled")}e.style("width",t.getWidth());e.style("height",t.getHeight());e.openEnd();e.renderControl(t._getSliderControl());e.renderControl(t._getPagesControl());e.close("div")}},constructor:function(e,t){i.apply(this,arguments);r.observeAssociations(this)}});const C=v.getMetadata().getName();a.call(v.prototype);v.prototype.init=function(){i.prototype.init?.call(this);const e=this.getId();this._document=null;this._visiblePages=new Set;this._queue=new Set;this._processingQueueScheduled=false;this._tasks=new Map;this._thumbnailSideLength=f;this._scrollToCurrentPageIndexAfterRendering=false;this.setAggregation("_slider",new s(`${e}-slider`,{tooltip:h().getText("SLIDER_TOOLTIP"),width:"auto",min:5,max:100,value:_,enabled:false,liveChange:[false,this._onSliderValueChanged,this],change:[true,this._onSliderValueChanged,this]}).addStyleClass("sapVizKitPageGallerySlider"));this.setAggregation("_pages",new n(`${e}-pages`,{renderType:u.Bare}).addStyleClass("sapVizKitPageGalleryPages"));const t=this._itemNavigation=new o;this.addEventDelegate(t);this._intersectionObserver=null;this._intersectionObserverCallback=this._intersectionObserverCallback.bind(this);this._onkeydown=this._onkeydown.bind(this)};v.prototype.exit=function(){this._unsubscribeFromEvents();this._intersectionObserver?.disconnect();this._intersectionObserver=null;this.removeEventDelegate(this._itemNavigation);this._itemNavigation.destroy();this._itemNavigation=null;this._clearQueue();this._visiblePages.clear();this._document=null;i.prototype.exit?.call(this)};v.prototype.onSetContentConnector=function(e){e.attachContentReplaced(this._onContentReplaced,this);this._setContent(e.getContent())};v.prototype.onUnsetContentConnector=function(e){e.detachContentReplaced(this._onContentReplaced,this);this._setContent(null)};v.prototype._onContentReplaced=function(e){this._setContent(e.getParameter("newContent"))};v.prototype._setContent=function(e){if(e===this._document){return}this._intersectionObserver?.disconnect();this._document=e;const t=this._getSliderControl();t.setEnabled(false);const s=this._getPagesControl();s.destroyItems();this._clearQueue();if(e!=null){this._scrollToCurrentPageIndexAfterRendering=true;t.setEnabled(true);const n=this._thumbnailSideLength;const i=this.getId();const o=e.pageCount;const a=Math.max(0,Math.min(this.getCurrentPageIndex(),o-1));for(let e=0;e<o;++e){const t=new P(`${i}-page-${e}`);t.setPageIndex(e);t.setSelected(e===a);t.setThumbnailSideLength(n);s.addItem(t)}this.setCurrentPageIndex(a)}this.invalidate()};v.prototype._subscribeToEvents=function(){this.$().on("keydown",this._onkeydown)};v.prototype._unsubscribeFromEvents=function(){this.$().off("keydown",this._onkeydown)};v.prototype.onBeforeRendering=function(){this._intersectionObserver?.disconnect();this._intersectionObserver=null;this._unsubscribeFromEvents()};v.prototype.onAfterRendering=function(){const e=this._getPagesControl();const t=e.getDomRef();const s=e.getItems();const n=Math.max(this.getCurrentPageIndex(),0);this._itemNavigation.setRootDomRef(t).setItemDomRefs(s.map(e=>e.getDomRef())).setColumns(1,true).setCycling(false).setPageSize(1).setSelectedIndex(n).setFocusedIndex(n);const i=this._intersectionObserver=new IntersectionObserver(this._intersectionObserverCallback,{root:t,threshold:0});for(const e of s){i.observe(e.getDomRef())}if(this._scrollToCurrentPageIndexAfterRendering){this._scrollToCurrentPageIndexAfterRendering=false;const e=this.getCurrentPageIndex();if(e>=0&&e<s.length){s[e].getDomRef()?.scrollIntoView({block:"nearest"})}}this._subscribeToEvents()};v.prototype._intersectionObserverCallback=function(t){const s=this._getPagesControl().getItems();const n=this._visiblePages;for(const{target:i,isIntersecting:o}of t){const t=i.dataset.sapUiVkPageIndex;if(t==null){continue}const a=parseInt(t,10);const r=s[a];if(o){e.debug(`IntersectionObserver: page ${a} became visible`,null,C);n.add(a);if(r.getDirty()){this._enqueueThumbnailGeneration(a)}}else{e.debug(`IntersectionObserver: page ${a} became invisible`,null,C);n.delete(a)}}this._itemNavigation.setPageSize(Math.max(1,n.size-1))};v.prototype._onSliderValueChanged=function(e,t){this._changeThumbnailScale(e.getParameter("value"),t)};v.prototype._changeThumbnailScale=function(e,t){i.prototype.setProperty.call(this,"thumbnailScale",e,true);this.getAggregation("_slider").setValue(e);const s=this._thumbnailSideLength=e*f/_;this.fireThumbnailScaleChanged({value:e});if(this._document==null){return}const n=this._getPagesControl();const o=n.getDomRef();const{scrollTop:a,scrollHeight:r}=o;const l=a/r;const h=n.getItems();const u=h.length;const c=this._visiblePages;for(let e=0;e<u;++e){h[e].setThumbnailSideLength(s);if(t&&c.has(e)){this._enqueueThumbnailGeneration(e)}}const{scrollHeight:g}=o;const d=l*g;o.scrollTo({top:d,behavior:"instant"})};v.prototype._activatePage=function(e){if(this._document==null){return}const t=e.target.closest("[data-sap-ui-vk-page-index]");if(t!=null){const e=t.dataset.sapUiVkPageIndex;if(e!=null){const t=parseInt(e,10);this.setCurrentPageIndex(t)}}};v.prototype.ontap=function(e){this._activatePage(e)};v.prototype.onsapenter=function(e){this._activatePage(e)};v.prototype._onkeydown=function(e){if(!this.getEnabled()&&e.key!=="Tab"){e.preventDefault();e.stopPropagation()}};v.prototype.setCurrentPageIndex=function(e){const t=this.getCurrentPageIndex();if(t===e){return this}const s=this._getPagesControl().getItems();const n=s.length;if(n===0){this.setProperty("currentPageIndex",e,true)}else{if(t>=0&&t<n){s[t].setSelected(false)}e=Math.max(0,Math.min(e,n-1));this._itemNavigation.setSelectedIndex(e).setFocusedIndex(e);this.setProperty("currentPageIndex",e,true);const i=s[e];i.setSelected(true);i.getDomRef()?.scrollIntoView({block:"nearest"})}this.firePageChanged({newPageIndex:e,oldPageIndex:t});return this};v.prototype._enqueueThumbnailGeneration=function(e){const t=this._queue;if(t.has(e)){return}const s=this._thumbnailSideLength;const n=this._tasks;const i=n.get(e);if(i!=null){const{renderTask:t}=i;if(t==null||i.sideLength===s){return}n.delete(e);t.cancel()}t.add(e);this._getPagesControl().getItems()[e].setBusy(true);this._scheduleProcessingThumbnailQueue()};v.prototype._scheduleProcessingThumbnailQueue=function(){if(!this._processingQueueScheduled){this._processingQueueScheduled=true;queueMicrotask(()=>{this._processThumbnailQueue()})}};v.prototype._processThumbnailQueue=async function(){this._processingQueueScheduled=false;const t=this._tasks;if(t.size>=b){e.debug("Too many simultaneous thumbnail tasks",null,C);return}const s=this._queue;if(s.size===0){e.debug("No more pages to process",null,C);return}for(const n of s){s.delete(n);if(this._visiblePages.has(n)){e.debug(`Processing page ${n}`,null,C);const s={};t.set(n,s);const i=await this._document.getPage(n);const o=this._thumbnailSideLength;const{devicePixelRatio:a}=window;const{renderTask:r,canvas:h}=i.renderToImage(o*a);s.sideLength=o;s.renderTask=r;s.canvas=h;s.timedOut=false;s.timeoutId=setTimeout(()=>{s.renderTask.cancel();s.timedOut=true},y);try{await r.promise;clearTimeout(s.timeoutId);e.debug(`Page ${n} rendered successfully`,null,C);const t=h.toDataURL("image/png");const i=this._getPagesControl().getItems()[n];if(s.sideLength===this._thumbnailSideLength){i.setThumbnail(t,h.width/a,h.height/a);i.setDirty(false)}else{e.debug(`Page ${n} thumbnail was generated for a different size, enqueuing a new task`,null,C);this._enqueueThumbnailGeneration(n)}}catch(t){if(t instanceof l.getPdfjsLib().RenderingCancelledException){e.debug(`Page ${n} rendering cancelled`,t,C);if(s.timedOut){e.error(`Page ${n} rendering timed out`,t,C);this._getPagesControl().getItems()[n].setThumbnail(g,h.width/a,h.height/a).setDirty(false)}}else{e.error("Page ${pageIndex} rendering failed",t,C)}}t.delete(n);if(!this.isDestroyStarted()){this._getPagesControl().getItems()[n]?.setBusy(false);this._scheduleProcessingThumbnailQueue()}break}else{this._getPagesControl().getItems()[n].setBusy(false);e.debug(`Page ${n} is not visible anymore, trying to process another page`,null,C)}}};v.prototype._clearQueue=function(){this._queue.clear();const e=this._tasks;for(const{renderTask:t}of e.values()){t?.cancel()}e.clear()};v.prototype._getSliderControl=function(){return this.getAggregation("_slider")};v.prototype._getPagesControl=function(){return this.getAggregation("_pages")};v.prototype.setProperty=function(e,t,s){if(e==="thumbnailScale"){this._changeThumbnailScale(t,true)}else{i.prototype.setProperty.apply(this,arguments)}return this};return v});
//# sourceMappingURL=PageGallery.js.map