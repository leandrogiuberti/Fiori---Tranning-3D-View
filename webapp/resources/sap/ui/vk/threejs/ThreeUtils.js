/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/base/Log","./MarchingCubes","../ObjectType"],function(e,r,t,n){"use strict";var a=new Float32Array(1);var i={};i.createWebGLImageRenderer=function(r,t,n){var a=new e.WebGLRenderer({canvas:r,preserveDrawingBuffer:true,antialias:true,alpha:true});a.setSize(t,n);a.outputColorSpace=e.LinearSRGBColorSpace;return a};i.createWebGLRenderer=function(r,t){var n=new e.WebGLRenderer({antialias:true,alpha:true});n.setPixelRatio(r);n.setSize(1,1);if(t){n.shadowMap.enabled=true}n.outputColorSpace=e.LinearSRGBColorSpace;return n};i._disposeMaterial=function(e){if(e.map){e.map.dispose()}if(e.lightMap){e.lightMap.dispose()}if(e.bumpMap){e.bumpMap.dispose()}if(e.normalMap){e.normalMap.dispose()}if(e.envMap){e.envMap.dispose()}if(e.alphaMap){e.alphaMap.dispose()}if(e.emissiveMap){e.emissiveMap.dispose()}if(e.aoMap){e.aoMap.dispose()}e.dispose()};i.disposeMaterial=function(e){if(e){i._disposeMaterial(e)}};i.disposeObject=function(r){if(r instanceof e.Mesh||r instanceof e.Line||r instanceof e.Box3Helper){if(r.geometry){r.geometry.dispose()}if(r.material){i._disposeMaterial(r.material)}}};i.disposeGeometry=function(r){if(r instanceof e.Mesh||r instanceof e.Line||r instanceof e.Box3Helper){if(r.geometry){r.geometry.dispose()}}};i.getAllTHREENodes=function(t,n,a){if(!t){return}if(!n||!a){r.error("getAllTHREENodes input parameters - all3DNodes and/or allGroupNodes are undefined.");return}t.forEach(function(r){if(r instanceof e.Mesh){n.push(r)}else if(r instanceof e.Light){n.push(r)}else if(r instanceof e.Camera){n.push(r)}else if(r instanceof e.Box3Helper){n.push(r)}else if(r instanceof e.Group){a.push(r)}if(r.children&&r.children.length>0){i.getAllTHREENodes(r.children,n,a)}})};var o=new e.Vector3;var s=function(e,r){if(e.userData.pcgBoundingBox){r.copy(e.userData.pcgBoundingBox)}else{r.makeEmpty()}e.updateMatrixWorld(true);e.traverse(function(e){if(e.userData.objectType===n.Hotspot||e.userData.objectType===n.PMI){return}var t;var a;var i=e.geometry;if(i!=null){if(i.isGeometry){var s=i.vertices;for(t=0,a=s.length;t<a;t++){o.copy(s[t]);o.applyMatrix4(e.matrixWorld);r.expandByPoint(o)}}else if(i.isBufferGeometry){var u=i.attributes.position;if(u!=null){var f=e.userData.renderGroup;for(t=f?f.firstVertex:0,a=f?f.lastVertex:u.count;t<a;t++){o.fromBufferAttribute(u,t).applyMatrix4(e.matrixWorld);r.expandByPoint(o)}}}}});return r};i.computeObjectOrientedBoundingBox=function(e,r){var t=e.parent;var n=e.matrix.clone();var a=e.matrixAutoUpdate;e.parent=null;e.matrix.identity();e.matrixAutoUpdate=false;s(e,r);e.matrixAutoUpdate=a;e.matrix.copy(n);e.parent=t;e.updateMatrixWorld(true);return r};function u(e,r,t){r[0]=e[t+8];r[4]=e[t+9];r[8]=e[t+10];r[12]=e[t+11];r[1]=e[t+12];r[5]=e[t+13];r[9]=e[t+14];r[13]=e[t+15];r[2]=e[t+16];r[6]=e[t+17];r[10]=e[t+18];r[14]=e[t+19]}i.computeClusterBoundingBoxes=function(r,t,n,a){var i=new Uint8Array(t.buffer);var o,s,f,l,d,c,p,v,m,h,x,b,g;var y;var M=new e.Matrix4;var I=M.elements;var C=new e.Vector3;for(var B=0,w=r.length;B<w;++B){if(a[3+B]===0){continue}var U=new e.Box3;var A=new e.Vector3;y=0;x=r[B].additionalRenderables;o=r[B].geometry;f=o.userData.renderInstanceCount||1;s=o.contents;for(h=0;h<2;++h){for(l=0,d=s.length;l<d;++l){c=s[l].instanceIndex;for(p=0;p<f;++p){v=c*20;c++;if((i[v*4+3]&3)>0){u(t,I,v);for(m=0;m<8;++m){C.x=t[v+((m&1)>0?3:2)];C.y=t[v+((m&2)>0?5:4)];C.z=t[v+((m&4)>0?7:6)];C.applyMatrix4(M);if(h>0){y=Math.max(y,A.distanceToSquared(C))}else{U.expandByPoint(C)}}}}}for(l=0,d=x.length;l<d;++l){b=x[l];g=b.userData.renderGroup;if(g.instanceIndex===null){for(m=0;m<8;++m){C.x=g.boundingBox[v+((m&1)>0?3:0)];C.y=g.boundingBox[v+((m&2)>0?4:1)];C.z=g.boundingBox[v+((m&4)>0?5:2)];C.applyMatrix4(b.matrixWorld);if(h>0){y=Math.max(y,A.distanceToSquared(C))}else{U.expandByPoint(C)}}}}const r=o.userData.pointCloudInstances;if(r){for(const e of r){v=e*20;u(t,I,v);for(m=0;m<8;++m){C.x=t[v+((m&1)>0?3:2)];C.y=t[v+((m&2)>0?5:4)];C.z=t[v+((m&4)>0?7:6)];C.applyMatrix4(M);if(h>0){y=Math.max(y,A.distanceToSquared(C))}else{U.expandByPoint(C)}}}}if(h===0){if(U.isEmpty()){o.boundingBox=null;o.boundingSphere=null;break}U.getCenter(A)}else{o.boundingBox=U;o.boundingSphere=new e.Sphere(A,Math.sqrt(y))}}}};i.initClustersBeforeProcessingHierarchy=function(e){e.forEach(e=>{e.additionalRenderables.length=0;if(e.material.userData.isPointCloud){e.material.transparent=false}})};i.processUpdatedDataTexture=function(e,r,t){var n=e.userData.textureUpdateParams;if(n){r=Math.min(r,n.updatedFrom);t=Math.max(t,n.updatedTo)}var a=4;var i=a*e.image.width;var o=Math.floor(r/i);var s=Math.ceil(t/i);var u=s-o;var f=0;var l=e.image.width;var d=o*i;if(u===1){f=Math.floor((r-i*o)/a);d+=f*a;l=Math.ceil((t-d)/a)}e.userData.textureUpdateParams={xOffset:f,yOffset:o,width:l,height:u,dataOffset:d,updatedFrom:r,updatedTo:t};e.needsUpdate=true};i.prepareTextureUpdateResults=function(e,r){var t=3+e;if(!r){var n=new Uint32Array(t);n[0]=4294967295;return n}if(r.length>=t){return r}var a=new Uint32Array(t);a.set(r);return a};function f(e,r,t,n,a){for(var i=0,o=t.instanceIndex*20;i<a;++i,++o){if(e[o]!=n[i]){e[o]=n[i];r[3+t.clusterIndex]=1;if(o<r[0]){r[0]=o}if(o>r[1]){r[1]=o}}}}function l(e,r,t,n){var a=e.userData.renderGroup;if(a&&a.instanceIndex!==null){f(t,n,a,r,1)}var i=e.children;for(var o=0,s=i.length;o<s;o++){l(i[o],r,t,n)}}i.removeNodeFromClusterRenderingRecursive=function(e,r,t){l(e,a,r,t)};const d=(new e.Matrix4).elements;i.updateNodeClusterRenderingInfo=function(e,r,t,n,a,i){var o=e.userData;var s=o.renderGroup;if(s&&s.clusterIndex!==undefined){var u=r[s.clusterIndex];if(s.instanceIndex===null){u.additionalRenderables.push(e)}else if(n){var l=new Uint8Array(t.buffer);l[0]=0;l[1]=0;l[2]=0;if(!u.isPoints&&(o.initialMaterialId!==o.materialId||e.renderOrder!=0||o.customMaterial||o.defaultMaterial||e.material.transparent===true)){l[3]=2;u.additionalRenderables.push(e)}else if(o.customMaterial&&e.material.userData.customColor){const r=e.material.color;l[0]=255*r.r;l[1]=255*r.g;l[2]=255*r.b;l[3]=3}else{l[3]=1}t[1]=u.isPoints?e.material.opacity:1;if(u.isPoints&&e.material.opacity<1){s.clusterSet?.forEach(e=>{r[e].material.transparent=true})}var c=s.boundingBox;if(c){t[2]=c[0];t[3]=c[3];t[4]=c[1];t[5]=c[4];t[6]=c[2];t[7]=c[5]}const p=i&&u.isPoints?d:e.matrixWorld.elements;t[8]=p[0];t[9]=p[4];t[10]=p[8];t[11]=p[12];t[12]=p[1];t[13]=p[5];t[14]=p[9];t[15]=p[13];t[16]=p[2];t[17]=p[6];t[18]=p[10];t[19]=p[14];f(n,a,s,t,20)}}else if(e.isMesh||e.isLine||e.isPoints||e._vkUpdate){a[2]=1}};function c(e,r,t,n,a,i,o,s,u){if(i===o){r[a*u*u+n*u+t]=1}if(i<o){var f=e[s[0]];s[0]++;t*=2;n*=2;a*=2;var l,d,p;for(p=0;p<2;++p){for(d=0;d<2;++d){for(l=0;l<2;++l){if((f&1<<p*4+d*2+l)!==0){c(e,r,t+l,n+d,a+p,i+1,o,s,u)}}}}}}function p(e,r){var t,n,a,i;var o=r*r;var s=true;var u;while(s){s=false;u=0;for(a=0;a<r;++a){for(n=0;n<r;++n){for(t=0;t<r;++t){if(e[a*o+n*r+t]>0){t++;for(i=r-1;i>t;--i){if(e[a*o+n*r+i]>0){for(;t<i;++t){if(e[a*o+n*r+t]===0){e[a*o+n*r+t]=1;s=true}}break}}u++;break}}}}for(a=0;a<r;++a){for(t=0;t<r;++t){for(n=0;n<r;++n){if(e[a*o+n*r+t]>0){n++;for(i=r-1;i>n;--i){if(e[a*o+i*r+t]>0){for(;n<i;++n){if(e[a*o+n*r+t]===0){e[a*o+n*r+t]=1;s=true}}break}}u++;break}}}}for(n=0;n<r;++n){for(t=0;t<r;++t){for(a=0;a<r;++a){if(e[a*o+n*r+t]>0){a++;for(i=r-1;i>a;--i){if(e[i*o+n*r+t]>0){for(;a<i;++a){if(e[a*o+n*r+t]===0){e[a*o+n*r+t]=1;s=true}}break}}u++;break}}}}}return u*2}function v(e,r,t,n){var a=r*4;var i,o,s,u;switch(e){case 0:i=[t[0],t[1],t[5],t[3],t[1],t[5],t[0],t[4],t[5],t[3],t[4],t[5]];o=0;s=0;u=1;break;case 1:i=[t[0],t[1],t[2],t[0],t[4],t[2],t[3],t[1],t[2],t[3],t[4],t[2]];o=0;s=0;u=-1;break;case 2:i=[t[0],t[4],t[5],t[3],t[4],t[5],t[0],t[4],t[2],t[3],t[4],t[2]];o=0;s=1;u=0;break;case 3:i=[t[0],t[1],t[5],t[0],t[1],t[2],t[3],t[1],t[5],t[3],t[1],t[2]];o=0;s=-1;u=0;break;case 4:i=[t[3],t[1],t[5],t[3],t[1],t[2],t[3],t[4],t[5],t[3],t[4],t[2]];o=1;s=0;u=0;break;default:i=[t[0],t[1],t[5],t[0],t[4],t[5],t[0],t[1],t[2],t[0],t[4],t[2]];o=-1;s=0;u=0;break}n.points.set(i,a*3);if(n.normals!==undefined){n.normals.set([o,s,u,o,s,u,o,s,u,o,s,u],a*3)}n.indices.set([a+0,a+1,a+2,a+2,a+1,a+3],r*6)}function m(e,r,t,n,a,i){e[0]=a[0]+r*i[0];e[1]=a[1]+t*i[1];e[2]=a[2]+n*i[2];e[3]=e[0]+i[0];e[4]=e[1]+i[1];e[5]=e[2]+i[2]}function h(e,r,t,n,a,i){var o,s,u,f;var l=r*t;var d=0;var c=[(a[3]-a[0])/r,(a[4]-a[1])/t,(a[5]-a[2])/n];var p=[0,0,0,0,0,0];for(u=0;u<n;++u){for(s=0;s<t;++s){for(o=0;o<r;++o){if(e[u*l+s*r+o]>0){m(p,o,s,u,a,c);v(5,d,p,i);d++;for(f=r-1;f>=o;--f){if(e[u*l+s*r+f]>0){m(p,f,s,u,a,c);v(4,d,p,i);d++;break}}break}}}}for(u=0;u<n;++u){for(o=0;o<r;++o){for(s=0;s<t;++s){if(e[u*l+s*r+o]>0){m(p,o,s,u,a,c);v(3,d,p,i);d++;for(f=t-1;f>=s;--f){if(e[u*l+f*r+o]>0){m(p,o,f,u,a,c);v(2,d,p,i);d++;break}}break}}}}for(s=0;s<t;++s){for(o=0;o<r;++o){for(u=0;u<n;++u){if(e[u*l+s*r+o]>0){m(p,o,s,u,a,c);v(1,d,p,i);d++;for(f=n-1;f>=u;--f){if(e[f*l+s*r+o]>0){m(p,o,s,f,a,c);v(0,d,p,i);d++;break}}break}}}}return d*4}function x(e,r,t,n,a,i,o,s){const u=t==null;let f;if(i>0){f=false}else if(i<0){f=true}else if(u){f=r>n}else{f=r>n||t>a}const l=f?r:n;const d=f?t:a;const c=u?0:o*d;const p=e.tempBuffer;e.points=p.points.subarray(0,l*3);if(c>0){const r=s*o;if(p.indices.length<c){p.indices=new Uint16Array(c)}else if(r<p.previousIndexCount){p.indices.fill(0,r,p.previousIndexCount)}p.previousIndexCount=c;e.indices=p.indices.subarray(0,c)}else{e.indices=undefined}if(e.normals!==undefined){e.normals=p.normals.subarray(0,l*3)}if(e.colors!==undefined){e.colors=p.colors.subarray(0,l*3);e.colors.fill(1)}if(e.uvs!==undefined){e.uvs=p.uvs.subarray(0,l*2)}}function b(e,r,t,n){var a=t[0]<=2?Infinity:(n[3]-n[0])/t[0];var i=t[1]<=2?Infinity:(n[4]-n[1])/t[1];var o=t[2]<=2?Infinity:(n[5]-n[2])/t[2];var s=-1;if(a<=i&&a<=o){if(a!==Infinity){s=0}}else if(i<=a&&i<=o){if(i!==Infinity){s=1}}else if(o<=a&&o<=i){if(o!==Infinity){s=2}}if(s<0){return 0}a=t[0];i=t[1];o=t[2];var u=a*i;var f=a,l=i,d=o;var c=f*l;var p,v,m;if(s===0){t[0]=t[0]>>1;f=t[0];c=f*l;for(m=0;m<o;++m){for(v=0;v<i;++v){for(p=0;p<a;++p){r[m*c+v*f+p]=e[m*u+v*a+p*2]|e[m*u+v*a+p*2+1]}}}}if(s===1){t[1]=t[1]>>1;l=t[1];c=f*l;for(m=0;m<o;++m){for(v=0;v<i;++v){for(p=0;p<a;++p){r[m*c+v*f+p]=e[m*u+v*2*a+p]|e[m*u+(v*2+1)*a+p]}}}}if(s===2){t[2]=t[2]>>1;d=t[2];c=f*l;for(m=0;m<o;++m){for(v=0;v<i;++v){for(p=0;p<a;++p){r[m*c+v*f+p]=e[m*2*u+v*a+p]|e[(m*2+1)*u+v*a+p]}}}}var h=0;for(m=0;m<d;++m){for(v=0;v<l;++v){for(p=0;p<f;++p){if(r[m*c+v*f+p]>0){h++;break}}}}for(m=0;m<d;++m){for(p=0;p<f;++p){for(v=0;v<l;++v){if(r[m*c+v*f+p]>0){h++;break}}}}for(v=0;v<l;++v){for(p=0;p<f;++p){for(m=0;m<d;++m){if(r[m*c+v*f+p]>0){h++;break}}}}return h*2}i.buildEmptyMesh=function(e,r,t,n,a){var i={tempBuffer:a,points:null,normals:(r&3)>0?null:undefined,colors:(r&32)>0?null:undefined,uvs:(r&4)>0?null:undefined,indices:null};x(i,t,n,t,n,-1,3-(r&1),0);var o=i.points;o[0]=e[0];o[1]=e[1];o[2]=e[2];for(var s=1;s<t;++s){o[s*3]=e[3];o[s*3+1]=e[4];o[s*3+2]=e[5]}return i};i.buildTemporaryMesh=function(e,r,n,a,i,o,s,u){var f=s<=0;var l={tempBuffer:u,points:null,normals:(r&3)>0?null:undefined,colors:(r&32)>0?null:undefined,uvs:(r&4)>0?null:undefined,indices:null};var d=0;var m=0;var g=null;var y=0;if(!o&&i&&(f||n>=384&&a>=192)){var M=atob(i);var I=M.length;g=new Uint8Array(I);for(var C=0;C<I;++C){g[C]=M.charCodeAt(C)}y=g[0]}var B=null;var w=0;if(y>0){B=new Uint8Array(Math.pow(Math.pow(2,y),3));w=Math.pow(2,y);var U=new Uint32Array(2);U[0]=1;c(g,B,0,0,0,0,y,U,w);var A=t.count(B,w);var k=f?21845:Math.min(n/3,a);if(!f&&A>k){m=p(B,w);A=t.count(B,w)}if(A<=k){x(l,A*3,A,n,a,s,3,A);t.march(B,w,e,l.points,l.normals,l.indices);d=A*3}}if(d===0&&w>=2){var D=Math.floor(Math.min(n/4,a/2));if(f){D=m}var G=new Uint8Array(w*w*w/2);var S=[w,w,w];var R=false;var P=0;for(;;){if(m<=D){x(l,m*4,m*2,n,a,s,3,m*2);d=h(R?G:B,S[0],S[1],S[2],e,l);break}m=P===4?0:b(R?G:B,R?B:G,S,e);if(!m){break}R=!R;P++}}if(d===0){x(l,24,12,n,a,s,3,12);for(;d<6;++d){v(d,d,e,l)}d=24}var T=l.points;for(var E=d,L=T.length/3;E<L;++E){T[E*3]=T[0];T[E*3+1]=T[1];T[E*3+2]=T[2]}return l};i.updateClusterAttrib=function(e,r,t,n){var a=e.getAttribute(r);a.array.set(n,t);a.addUpdateRange(t,n.length)};i.updateClusterIndices=function(e,r,t,n,a){var i=e.getIndex();i.addUpdateRange(n,a);var o=i.array;for(var s=0;s<a;++s){o[n+s]=t+r[s]}};const g=new e.Vector3;i._updateClusterInstanceAttribute=function(r,t,n,a,i){const o=r.getAttribute("clusterInstance");const s=r.getAttribute("position").array;const u=r.userData;const f=u.clusterIndex;const l=t+n;const d=o.array;const c=new Set;const p=new Set;for(let e=t,r=t*3;e<l;e++,r+=3){g.fromArray(s,r);let t;c.clear();for(let e=0;e<i.length;e++){const r=i[e];if(r.containsPoint(g)&&!c.has(r.node)){if(r.type!==1){t=r;break}else{c.add(r.node)}}}if(t){p.add(t.node);const e=t.node.userData;e.renderGroup.clusterIndex=f;e.renderGroup.clusterSet.add(f);u.pointCloudInstances??=new Set;u.pointCloudInstances.add(t.instanceIndex);e.pcgBoundingBox.expandByPoint(g)}d[e]=t?t.instanceIndex:a}o.addUpdateRange(t,n);o.needsUpdate=true;p.forEach(r=>{const t=r.userData.pcgBoundingBox;r.userData.renderGroup.boundingBox=[t.min.x,t.min.y,t.min.z,t.max.x,t.max.y,t.max.z];const n=t.getCenter(new e.Vector3);r.userData.renderGroup.boundingSphere=[n.x,n.y,n.z,n.sub(t.min).length()]})};i._updateGeometryClusterInstance=function(e,r){const t=e.geometry;if(t.userData.isPointCloud){this._updateClusterInstanceAttribute(t,e.vertexStart,e.vertexCount,e.instanceIndex,r)}};i.updateClusterGeometry=function(e,r,t,n,a,o,s){if(r.length===e.vertexCount*3&&(!o||!o.length||o.length===e.indexCount)){var u=e.geometry;var f=!u.userData.isPolyline;var l=e.instanceIndex;var d=u.contents;for(var c=0,p=d.length;c<p;++c){if(d[c].instanceIndex===l){if(d[c].isFinal!==true){d[c].isFinal=true;var v=e.vertexStart;i.updateClusterAttrib(u,"position",v*3,r);if(t&&t.length&&f){i.updateClusterAttrib(u,"normal",v*3,t)}if(n&&n.length){i.updateClusterAttrib(u,"color",v*3,n)}if(a&&a.length){i.updateClusterAttrib(u,"uv",v*2,a)}if(o&&o.length){i.updateClusterIndices(u,o,v,e.indexStart,e.indexCount)}if(s?.length>0){i._updateGeometryClusterInstance(e,s)}if(u.shouldUpload<1){u.shouldUpload=1}}return true}}}return false};i.prepareClustersForGpuUpload=function(e){var r,t,n,a,i;var o=e.length;var s=0;for(var u=0;u<o;++u){r=e[u].geometry;t=r.shouldUpload;if(t===1&&o>=100){n=r.contents;i=n.length;for(a=0;a<i;++a){if(!n[a].isFinal){t=0;s++;break}}}if(t>0){r.shouldUpload=0;t=r.getIndex();if(t){t.needsUpdate=true}t=r.attributes;t.position.needsUpdate=true;if(t.normal){t.normal.needsUpdate=true}if(t.color){t.color.needsUpdate=true}if(t.uv){t.uv.needsUpdate=true}if(t.clusterInstance){t.clusterInstance.needsUpdate=true}}}return s};i.increaseCurrentInstance=function(e){if(e.currentInstanceIndex<e.maxInstanceIndex){e.currentInstanceIndex++}else{r.error("Maximum number of instances in a texture reached!")}};i.partitionCluster=function(e,r,t,n){var a;var i=null;var o=r.length-1;for(var s=0,u=e.length;s<u;++s){a=e[s];if(!i||i.verts+a.verts>65536){i={verts:0,elems:0};r.push(i);o++}t.set(a.submeshId,o);n[a.meshIndex].submeshes[a.submeshIndex].clusterIndex=o;i.verts+=a.verts;i.elems+=a.elems}};return i});
//# sourceMappingURL=ThreeUtils.js.map