/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./utils/arrayDiff","sap/base/Log","../thirdparty/three","../ContentManager","./Scene","../TransformationMatrix","./PerspectiveCamera","./OrthographicCamera","../Messages","../getResourceBundle","./ContentDeliveryService","./ThreeUtils","./Viewport","./ViewStateManager"],function(e,t,r,a,o,n,i,s,d,l,u,c){"use strict";var h=function(e){Object.defineProperties(this,{source:{value:e.getSource()},sourceType:{value:e.getSourceType()},sourceId:{value:null,writable:true},name:{value:null,writable:true},localMatrix:{value:null,writable:true},children:{value:[]},nodeProxy:{value:null,writable:true},loader:{value:null,writable:true},builder:{value:null,writable:true}});e._shadowContentResource=this};var f=a.extend("sap.ui.vk.threejs.ContentManager",{metadata:{library:"sap.ui.vk"}});var g=f.getMetadata().getParent().getClass().prototype;f.prototype.init=function(){if(g.init){g.init.call(this)}this._shadowContentResources=[]};f.prototype.exit=function(){if(this.defaultCdsLoader){this.defaultCdsLoader.destroy();this.defaultCdsLoader=null}if(this.defaultMataiLoader){this.defaultMataiLoader.destroy();this.defaultMataiLoader=null}if(g.exit){g.exit.call(this)}this._shadowContentResources=null};f.prototype._handleContentChangesProgress=function(e){this.fireContentChangesProgress({phase:e.getParameter("phase"),source:e.getParameter("source"),percentage:e.getParameter("percentage")})};f.prototype._handleContentLoadingFinished=function(e){this.fireContentLoadingFinished({source:e.getParameter("source"),node:e.getParameter("node")})};function p(e){if(e&&e.isMesh){e.castShadow=true;e.receiveShadow=false}if(e&&e.children){for(var t=0;t<e.children.length;t++){p(e.children[t])}}}function v(e,t){if(e){var a=new r.Group;e.add(a);a.name="DefaultLights";a.userData.defaultLights=true;a.private=true;var o=(new r.Box3).setFromObject(e);var n=o.getSize(new r.Vector3);var i=o.getCenter(new r.Vector3);var s=n.length();const v=[new r.Color(.72,.72,.81),new r.Color(.2,.2,.2),new r.Color(.32,.32,.36),new r.Color(.36,.36,.36)];const C=[new r.Vector3,new r.Vector3(2,-.5,-1.5),new r.Vector3(-2,-2.5,1.1),new r.Vector3(-.04,2,.01)];for(var d=0,l=v.length;d<l;d++){const e=new r.DirectionalLight(v[d],Math.PI);e.position.copy(C[d]);e.private=true;e.updateWorldMatrix(false,false);a.add(e)}if(t){p(e);var u=new r.DirectionalLight;u.color.setRGB(.5,.5,.5);u.position.set(0,1,0);u.castShadow=true;u.shadow.mapSize.width=512;u.shadow.mapSize.height=512;var c=2e3;u.shadow.camera.left=-c;u.shadow.camera.right=c;u.shadow.camera.top=c;u.shadow.camera.bottom=-c;u.shadow.camera.far=3500;u.shadow.bias=-1e-4;u.private=true;a.add(u);var h=new r.PlaneGeometry(n.x,n.z);var f=new r.ShadowMaterial;f.opacity=.2;var g=new r.Mesh(h,f);g.rotation.x=-Math.PI/2;g.position.x=i.x;g.position.y=o.min.y-s*.1;g.position.z=i.z;e.add(g);g.receiveShadow=true}}}f.prototype.loadContent=function(e,a){this.fireContentChangesStarted();var n=e||new o(new r.Scene);var i=this;this._loadContentResources(n,a).then(function(r){t.info("Content loading resolved");if(r){for(var a=0;a<r.length;++a){if(!n.getInitialView()&&r[a].initialView){n.setInitialView(r[a].initialView)}n.camera=n.camera||r[a].camera;var o=r[a].contentResource?r[a].contentResource._shadowContentResource:null;if(r[a].loader){if(o){o.loader=r[a].loader}n.loaders=n.loaders||[];n.loaders.push(r[a].loader)}if(r[a].builder){if(o){o.builder=r[a].builder}n.builders=n.builders||[];n.builders.push(r[a].builder)}}if(r.length>0){var s=r[0];n.backgroundTopColor=s.backgroundTopColor;n.backgroundBottomColor=s.backgroundBottomColor;n.renderMode=s.renderMode;n.upAxis=s.upAxis;n.outputSettings=s.outputSettings}}n.getSceneRef().updateMatrixWorld();if(!e){v(n.getSceneRef(),false)}if(n.loaders){i._initSceneWithCDSLoaderIfExists(n,n.loaders)}i.fireContentChangesFinished({content:n})},function(e){t.info("Content loading rejected:",e);var r;if(typeof e==="string"){r=e}else if(e.errorText){r=e.errorText}else if(e.message){r=e.message}r=r||l().getText(d.VIT37.summary);t.error(l().getText("CONTENTMANAGER_MSG_CONTENTRESOURCESFAILEDTOLOAD"),r);i.fireContentChangesFinished({content:null,failureReason:[{error:e,errorMessage:r}]})});return this};f.prototype._findLoader=function(e){if(e._contentManagerResolver&&e._contentManagerResolver.settings&&e._contentManagerResolver.settings.loader){return Promise.resolve(e._contentManagerResolver.settings.loader)}if(e.getSource()){var t=e.getEffectiveSourceType().toLowerCase();var r=this;switch(t){case"stream":{if(this.defaultCdsLoader==null){return new Promise(function(e){var t="sap/ui/vk/threejs/ContentDeliveryService";sap.ui.require([t],function(t){e(r.defaultCdsLoader=new t({authorizationHandler:r._authorizationHandler,consumptionScenario:r._consumptionScenario}))})})}return Promise.resolve(this.defaultCdsLoader)}case"vds":case"vds4":{if(this.defaultMataiLoader==null){return new Promise(function(e){var t="sap/ui/vk/matai/MataiLoader";sap.ui.require([t],function(t){e(r.defaultMataiLoader=new t)})})}return Promise.resolve(this.defaultMataiLoader)}default:break}}return Promise.resolve(null)};const C=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];f.prototype._loadContentResources=function(t,a){function o(e,t){if(typeof t==="string"){return(e||"")+t}return null}function i(e,t){e??=C;t??=C;return e===t||e.every((e,r)=>e===t[r])}function s(e,t){if(!e&&!t){return true}else if(!!e^!!t){return false}else{return e.source===t.getSource()&&e.sourceType===t.getSourceType()&&e.sourceId===t.getSourceId()&&e.name===t.getName()&&i(e.localMatrix,t.getLocalMatrix())}}function d(e,t){t._shadowContentResource=e;var r=e.nodeProxy.getNodeRef();e.name=t.getName();r.name=e.name;e.sourceId=t.getSourceId();r.sourceId=e.sourceId;if(!i(e.localMatrix,t.getLocalMatrix())){e.localMatrix=t.getLocalMatrix();r.matrix.fromArray(n.convertTo4x4(e.localMatrix));r.matrix.decompose(r.position,r.quaternion,r.scale);r.matrixWorldNeedsUpdate=true}}var l=[];var u=new Map;function f(e){var t=o(e.sourceType,e.source);var r=u.get(t);if(!r){r=[];u.set(t,r)}r.push(e);var a=e.nodeProxy.getNodeRef();a.parent.remove(a);e.children.forEach(function(e){f(e)});e.children.length=0}function g(e,a){var o=new h(e);var n=new r.Group;a.add(n);n.matrixWorldNeedsUpdate=true;o.nodeProxy=t.getDefaultNodeHierarchy().createNodeProxy(n);d(o,e);l.push(e);return o}(function t(r,a,o){var n=0;var i=e(r,a,s,true);i.forEach(function(e){for(;n<e.index;++n){d(r[n],a[n]);t(r[n].children,a[n].getContentResources(),r[n].nodeProxy.getNodeRef())}if(e.type==="delete"){f(r[e.index]);r.splice(e.index,1)}else if(e.type==="insert"){var i=g(a[e.index],o);r.splice(e.index,0,i);t(i.children,a[e.index].getContentResources(),i.nodeProxy.getNodeRef())}++n});for(;n<r.length;++n){d(r[n],a[n]);t(r[n].children,a[n].getContentResources(),r[n].nodeProxy.getNodeRef())}})(this._shadowContentResources,a,t.getSceneRef());var p=[];l.forEach(function(e){var r=e._shadowContentResource.nodeProxy.getNodeRef();var a=o(e.getSourceType(),e.getSource());var n=u.get(a);if(a&&n&&n.length>0){var i=n.pop();var s=i.nodeProxy.getNodeRef();for(var d=0;d<s.children.length;++d){r.add(s.children[d])}if(i.loader){e._shadowContentResource.loader=i.loader}if(i.builder){e._shadowContentResource.builder=i.builder}t.getDefaultNodeHierarchy().destroyNodeProxy(i.nodeProxy);i.nodeProxy=null}else{var l=this;p.push(this._findLoader(e).then(function(t){if(t){if(t.attachContentChangesProgress){t.attachContentChangesProgress(l._handleContentChangesProgress,l)}if(t.attachContentLoadingFinished){t.attachContentLoadingFinished(l._handleContentLoadingFinished,l)}else if(t.attachLoadingFinished){t.attachLoadingFinished(l._handleContentLoadingFinished,l)}}if(typeof t==="function"){return t(r,e,l._authorizationHandler,l._retryCount)}else if(t&&t.load){return t.load(r,e,l._authorizationHandler,l._retryCount)}else{return Promise.resolve({node:r,contentResource:e})}}))}},this);function v(e,t){if(t){t.removeNode(e);return}var a=[];var o=[];c.getAllTHREENodes([e],a,o);var n=new Map;var i=new Map;a.forEach(function(e){if(e instanceof r.Mesh){if(!i.has(e.geometry.uuid)){c.disposeGeometry(e);i.set(e.geometry.uuid,true)}if(e.material){if(!n.has(e.material.uuid)){c.disposeMaterial(e.material);n.set(e.material.uuid,true)}}if(e.userData&&e.userData.originalMaterial&&e.userData.originalMaterial.uuid!==e.material.uuid&&!n.has(e.userData.originalMaterial.uuid)){c.disposeMaterial(e.userData.originalMaterial);n.set(e.userData.originalMaterial.uuid,true)}}if(e.parent){e.parent.remove(e)}});o.forEach(function(e){if(e.parent){e.parent.remove(e)}});n.clear();i.clear()}u.forEach(function(e,t){for(var r=0;r<e.length;++r){var a=e[r];v(a.nodeProxy.getNodeRef(),a.builder);if(a.builder){a.builder.cleanup()}if(a.loader){if(a.loader._loader&&a.loader._loader.sceneBuilder){a.loader._loader.removeContext(a.loader._loader.currentSceneInfo.id);a.loader._loader.sceneBuilder.cleanup()}if(a.loader.detachContentChangesProgress){a.loader.detachContentChangesProgress(this._handleContentChangesProgress,this)}if(a.loader.detachContentLoadingFinished){a.loader.detachContentLoadingFinished(this._handleContentLoadingFinished,this)}if(a.loader.detachLoadingFinished){a.loader.detachLoadingFinished(this._handleContentLoadingFinished,this)}}}},this);if(a.length===1&&a[0].getName()==null&&a[0].getLocalMatrix()==null){a[0]._shadowContentResource.nodeProxy.getNodeRef().userData.skipIt=true}else{a.forEach(function(e){e._shadowContentResource.nodeProxy.getNodeRef().userData.skipIt=false})}return Promise.all(p)};f.prototype._initSceneWithCDSLoaderIfExists=function(e,t){if(t){var r;for(var a=0;a<t.length;a++){if(t[a]instanceof u){r=t[a].getSceneBuilder();break}}if(r){e.setSceneBuilder(r);e.getDefaultNodeHierarchy().attachNodeRemoving(function(e){var t=e.getParameter("nodeRef");if(t.userData.treeNode&&t.userData.treeNode.sid){r.decrementResourceCountersForDeletedTreeNode(t.userData.treeNode.sid)}});return true}}return false};f.prototype.destroyContent=function(e){if(e){e.destroy();this._shadowContentResources=[];if(e.loaders&&Array.isArray(e.loaders)&&e.loaders.length>0){if(e.loaders[0]._loader&&e.loaders[0]._loader.sceneBuilder){e.loaders[0]._loader.removeContext(e.loaders[0]._loader.currentSceneInfo.id);e.loaders[0]._loader.sceneBuilder.cleanup()}if(e.loaders[0].detachContentChangesProgress){e.loaders[0].detachContentChangesProgress(this._handleContentChangesProgress,this)}if(e.loaders[0].detachContentLoadingFinished){e.loaders[0].detachContentLoadingFinished(this._handleContentLoadingFinished,this)}else if(e.loaders[0].detachLoadingFinished){e.loaders[0].detachLoadingFinished(this._handleContentLoadingFinished,this)}}else if(e.builders&&Array.isArray(e.builders)){e.builders.forEach(function(e){if(e){e.cleanup()}})}}return this};f.prototype.createOrthographicCamera=function(){return new s};f.prototype.createPerspectiveCamera=function(){return new i};return f});
//# sourceMappingURL=ContentManager.js.map