/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","../Scene","./NodeHierarchy","../RenderMode","../thirdparty/three","./PolylineGeometry","./PolylineMaterial","./PolylineMesh","./ThreeUtils","../totara/TotaraUtils","sap/base/util/uid"],function(e,t,r,i,n,a,o,s,l,u,c){"use strict";var d=t.extend("sap.ui.vk.threejs.Scene",{metadata:{library:"sap.ui.vk"},PoiCoordinateSpaces:{WorldSpace:0,ReferenceNodeSpace:1},constructor:function(e){t.call(this);this._id=c();this._scene=e;this._sceneBuilder=null;this._defaultNodeHierarchy=null;this._currentViewStateManager=null;this._animationSequenceMap=new Map;this._initialView=null;this._materialMap=new Map;this._outlineGeometryToNodes=new Map;this._annotationMap=new Map}});d.prototype.init=function(){this._outlineColor=new n.Vector4(0,0,0,1);this._illustrationLineWidth=1/640;this._outlineThickMaterial=new o({color:16777215,lineColor:new n.Color(this._outlineColor.x,this._outlineColor.y,this._outlineColor.z),linewidth:this._illustrationLineWidth,illustration:true,depthWrite:false,depthFunc:n.LessEqualDepth,polygonOffset:true,polygonOffsetFactor:-4,blending:n.NormalBlending,clipping:true});this._outlineMaterial=new n.ShaderMaterial({uniforms:{color:{value:this._outlineColor}},vertexShader:["attribute vec3 normal1;","attribute vec3 normal2;","#include <clipping_planes_pars_vertex>","uniform vec4 color;","varying vec4 vColor;","void main() {","\t#include <begin_vertex>","\t#include <project_vertex>","\t#include <clipping_planes_vertex>","\tvec3 eyeDirection = mvPosition.xyz;","\tvec3 n1 = normalMatrix * normal1;","\tvec3 n2 = normalMatrix * normal2;","\tvColor = color;","\tvColor.a *= dot(normal1, normal2) <= 0.5 ? 1.0 : step(dot(eyeDirection, n1) * dot(eyeDirection, n2), 0.0);","}"].join("\n"),fragmentShader:["#include <clipping_planes_pars_fragment>","varying vec4 vColor;","void main() {","\t#include <clipping_planes_fragment>","\tif (vColor.a < 0.01) discard;","\tgl_FragColor = vColor;","}"].join("\n"),depthWrite:false,depthFunc:n.LessEqualDepth,polygonOffset:true,polygonOffsetFactor:-4,blending:n.NormalBlending,clipping:true});this._solidWhiteMaterial=new n.MeshBasicMaterial({color:16777215})};d.prototype.clearThreeScene=function(){if(!this._scene){return}var e=[];var t=[];l.getAllTHREENodes([this._scene],e,t);var r=this._scene.userData;if(r.geometryClusters){e=e.concat(r.geometryClusters);delete r.geometryClusters}if(r.currentClusters){r.currentClusters.clear()}r.instanceDataTexture?.dispose();r.instanceDataTexture=null;r.currentInstanceIndex=0;var i=new Map;var a=new Map;e.forEach(function(e){if(e instanceof n.Mesh){if(!i.has(e.geometry.uuid)){l.disposeGeometry(e);i.set(e.geometry.uuid,true)}if(e.material){if(!a.has(e.material.uuid)){l.disposeMaterial(e.material);a.set(e.material.uuid,true)}}if(e.userData&&e.userData.originalMaterial&&e.userData.originalMaterial.uuid!==e.material.uuid&&!a.has(e.userData.originalMaterial.uuid)){l.disposeMaterial(e.userData.originalMaterial);a.set(e.userData.originalMaterial.uuid,true)}}if(e.parent){e.parent.remove(e)}});t.forEach(function(e){e.parent.remove(e)});i.clear();a.clear()};d.prototype.destroy=function(){this._outlineGeometryToNodes.clear();this.clearThreeScene();if(this._defaultNodeHierarchy){this._defaultNodeHierarchy.destroy();this._defaultNodeHierarchy=null}l.disposeMaterial(this._solidWhiteMaterial);l.disposeMaterial(this._outlineMaterial);l.disposeMaterial(this._outlineThickMaterial);this._sceneBuilder=null;this._scene=null;this._currentViewStateManager=null;this._animationSequenceMap.clear();this._materialMap.clear();t.prototype.destroy.call(this)};d.prototype.setDoubleSided=function(e){this.setProperty("doubleSided",e,true);this._scene.traverse(function(t){if(t.material!==undefined){var r=t.userData;var i=n.FrontSide;var a;if(r.originalMaterial){a=r.originalMaterial.userData;if(a.originalMaterialSide===undefined){a.originalMaterialSide=r.originalMaterial.side}i=a.originalMaterialSide}else{a=t.material.userData;if(a.originalMaterialSide===undefined){a.originalMaterialSide=t.material.side}i=a.originalMaterialSide}t.material.side=e?n.DoubleSide:i}});return this};d.prototype.setViewStateManager=function(e){this._currentViewStateManager=e;return this};d.prototype.getViewStateManager=function(){return this._currentViewStateManager};d.prototype.getId=function(){return this._id};d.prototype.getDefaultNodeHierarchy=function(){if(!this._defaultNodeHierarchy){this._defaultNodeHierarchy=new r(this)}return this._defaultNodeHierarchy};d.prototype._computeBoundingBox=function(e,t,r,i){var a=new n.Box3;if(this._scene){var o=this._scene.userData;var s=o.geometryClusters;if(e&&s&&s.length>100&&!i){var l;for(var u=0,c=s.length;u<c;++u){l=s[u].geometry.boundingBox;if(l){a.union(l)}}}else{this._scene._expandBoundingBox(a,e,t,r)}}return a};d.prototype.getSceneRef=function(){return this._scene};d.prototype.setSceneBuilder=function(e){this._sceneBuilder=e};d.prototype.getSceneBuilder=function(){return this._sceneBuilder};d.prototype.nodeRefToPersistentId=function(e){return Array.isArray(e)?e.map(function(e){return e._vkPersistentId()}):e._vkPersistentId()};d.prototype.persistentIdToNodeRef=function(e){var t=this._sceneBuilder;if(Array.isArray(e)){return e.map(function(e){return t?t.getNode(e):null})}else{return t?t.getNode(e):null}};d.prototype.setNodePersistentId=function(e,t,r){return this._sceneBuilder?this._sceneBuilder.setNodePersistentId(e,t,r):false};d.prototype._addAnnotation=function(e,t){this._annotationMap.set(e,t)};d.prototype._hasAnnotation=function(e){return this._annotationMap.has(e)};d.prototype._getAnnotations=function(){return this._annotationMap};d.prototype._removeAnnotationsForNode=function(e){this._annotationMap.forEach(function(t){if(t.node===e){this._annotationMap.delete(t.annotation.id)}},this)};d.prototype.setAnnotationPersistentId=function(e,t,r){var i=this._annotationMap.get(e.id);if(i){this._annotationMap.delete(e.id);i.annotation.id=t;this._annotationMap.set(t,i);return true}return false};d.prototype.getPointCloudGroups=function(){this._pointCloudGroups??=new Map;return this._pointCloudGroups};d.prototype.enumerateMaterials=function(){if(!this._defaultNodeHierarchy){return[]}var e=this._defaultNodeHierarchy.createNodeProxy(this._scene);if(e){return e.enumerateMaterials(true)}else{return[]}};var f=0;function p(e,t){var r=e.x-t.x;if(r<-f){return true}if(r>f){return false}var i=e.y-t.y;if(i<-f){return true}if(i>f){return false}return e.z-t.z<-f}function h(e,t,r){if(t<r){var i=y(e,t,r);h(e,t,i-1);h(e,i+1,r)}return e}function y(e,t,r){var i=e[r],n=t;for(var a=t;a<r;a++){if(p(e[a],i)){_(e,a,n);n++}}_(e,r,n);return n}function _(e,t,r){if(t!=r){var i=e[t];e[t]=e[r];e[r]=i}}function m(e,t){var r=new n.BufferGeometry;Object.setPrototypeOf(r,m.prototype);r.type="OutlineGeometry";var i=e&&e.isBufferGeometry&&e.getAttribute("position");if(!i||!e.index){return}e.computeBoundingBox();var a=new n.Vector3;e.boundingBox.getSize(a);f=Math.max(a.x,a.y,a.z)*1e-4;var o=i.count;var s=e.index.array;var l=s.length;if(o===0||l<3){return}var u,c,d,y;var _=new Array(o);for(u=0;u<o;u++){_[u]=(new n.Vector3).fromArray(i.array,u*i.itemSize);_[u].index=u}h(_,0,_.length-1);var M=[],g=[];M.push(_[0]);g[_[0].index]=M.length-1;for(u=1;u<o;u++){if(p(M[M.length-1],_[u])){M.push(_[u])}g[_[u].index]=M.length-1}var v=[];for(d=0;d<l;d+=3){var x=g[s[d]];var w=g[s[d+1]];var b=g[s[d+2]];if(x!==w&&w!==b&&b!==x){v.push(x,w,b)}}s=v;_=M;l=s.length;var B={},S;var N=new n.Vector3,D=new n.Vector3,A=new n.Vector3;var C=new Array(l/3);for(d=0,y=0;d<l;d+=3,y++){D.copy(_[s[d+1]]).sub(_[s[d]]);A.copy(_[s[d+2]]).sub(_[s[d]]);C[y]=(new n.Vector3).crossVectors(D,A).normalize();for(u=0,c=2;u<3;c=u++){var I=s[d+c];var k=s[d+u];S=Math.min(I,k)+","+Math.max(I,k);if(B[S]===undefined){B[S]={index1:I,index2:k,face1:y,face2:undefined}}else{B[S].face2=y}}}var T=Math.cos(n.MathUtils.DEG2RAD*(t!==undefined?t:1));var V=[];var G=[];var O=[];for(S in B){var z=B[S];if(z.face2===undefined||C[z.face1].dot(C[z.face2])<=T&&N.copy(_[z.index2]).sub(_[z.index1]).cross(C[z.face1]).dot(C[z.face2])>0){var P=_[z.index1];V.push(P.x,P.y,P.z);P=_[z.index2];V.push(P.x,P.y,P.z);var R=C[z.face1];G.push(R.x,R.y,R.z);G.push(R.x,R.y,R.z);if(z.face2!==undefined){var F=C[z.face2];O.push(F.x,F.y,F.z);O.push(F.x,F.y,F.z)}else{O.push(0,0,0);O.push(0,0,0)}}}r.setAttribute("position",new n.Float32BufferAttribute(V,3));r.setAttribute("normal1",new n.Float32BufferAttribute(G,3));r.setAttribute("normal2",new n.Float32BufferAttribute(O,3));return r}m.prototype=Object.create(n.BufferGeometry.prototype);m.prototype.constructor=m;function M(e){const t=e.userData.renderGroup?.boundingBox;if(t){return t[0]>=t[3]&&t[1]>=t[4]&&t[2]>=t[5]}const r=e.geometry.boundingBox;return r===null||r.min.x>=r.max.x&&r.min.y>=r.max.y&&r.min.z>=r.max.z}function g(e,t){const r=e.isMesh&&!!e.userData.skipIt===t&&!M(e)&&e.geometry;const i=r&&r.isBufferGeometry&&r.getAttribute("position");if(!i){return[0,0]}const n=e.userData.renderGroup;return n?[n.lastVertex-n.firstVertex,n.count]:[i.count,r.index?r.index.array.length:i.count]}function v(e,t,r,i,a,o){const s=i.isMesh&&!!i.userData.skipIt===a&&!M(i)&&i.geometry;const l=s&&s.isBufferGeometry&&s.getAttribute("position");if(!l){return}let c=null;if(a){i.updateMatrix();c=i.matrix}if(o){u.pushElementIntoMapArray(o,i.userData.geometryId,a?i.parent:i)}const d=i.userData.renderGroup;const f=d?d.firstVertex:0;const p=d?d.lastVertex-f:l.count;const h=l.array;const y=f*3;const _=r[0];const m=_*3;const g=new n.Vector3;for(let t=0,r=p*3;t<r;t+=3){g.set(h[y+t],h[y+t+1],h[y+t+2]);if(c){g.applyMatrix4(c)}e[m+t]=g.x;e[m+t+1]=g.y;e[m+t+2]=g.z}const v=r[1];const x=s?.index?.array;const w=d?d.start:0;let b;if(x){b=d?d.count:x.count;const e=f-_;for(let r=0;r<b;++r){t[v+r]=x[w+r]-e}}else{b=p;for(let e=0;e<b;++e){t[v+e]=_+e}}r[0]+=p;r[1]+=b}function x(t,r,i,o){try{let e,l=t.children.length;let[u,c]=g(t,false);for(e=0;e<l;++e){const[r,i]=g(t.children[e],true);u+=r;c+=i}if(!u){return}const d=new Float32Array(u*3);const f=new Uint32Array(c);let p=[0,0];v(d,f,p,t,false,o);for(e=0;e<l;++e){v(d,f,p,t.children[e],true,o)}const h=new n.BufferGeometry;h.setAttribute("position",new n.BufferAttribute(d,3));h.setIndex(new n.BufferAttribute(f,1));const y=new m(h);const _=y.getAttribute("position");if(_&&_.count>0){let e;if(r){const t=new a(y);t.boundingBox=new n.Box3;e=new s(t,i)}else{y.boundingBox=new n.Box3;e=new n.LineSegments(y,i)}e.isOutline=true;e.userData.skipIt=true;e.renderOrder=t.renderOrder+.5;e.matrixWorldNeedsUpdate=true;t.add(e);t.hasOutline=true}}catch(r){e.error("Unable to create outline geometry for node "+t.name,r)}}function w(e,t){var r=e.userData;if(r.defaultMaterial===undefined){r.defaultMaterial=r.originalMaterial||e.material}e.material=t;r.originalMaterial=null}function b(e){var t=e.userData;if(t.defaultMaterial){e.material=t.defaultMaterial;delete t.defaultMaterial;t.originalMaterial=null}}d.prototype._createOutlineGeometry=function(e){if(this._scene){this._scene._vkTraverseMeshNodes(function(t){if(t.isOutline){t.visible=true}else{if(!t.hasOutline){const e=this._illustrationLineWidth>0;x(t,e,e?this._outlineThickMaterial:this._outlineMaterial,this._outlineGeometryToNodes)}if(t.isMesh&&t.material&&!t.material.isLineBasicMaterial&&!t.material.isLineMaterial){switch(e){case i.LineIllustration:w(t,this._solidWhiteMaterial);break;case i.ShadedIllustration:var r=(t.userData.defaultMaterial||t.userData.originalMaterial||t.material).clone();if(r.emissive){r.color.multiplyScalar(.5);r.emissive.multiplyScalar(.5).addScalar(.5)}else{r.color.multiplyScalar(.5).addScalar(.5)}w(t,r);break;default:b(t);break}}}}.bind(this))}};d.prototype._hideOutlineGeometry=function(){if(this._scene){this._scene._vkTraverseMeshNodes(function(e){if(e.isOutline){e.visible=false}if(e.isMesh){b(e)}})}};d.prototype.onGeometryUpdated=function(e){const t=this._outlineGeometryToNodes.get(e);if(t){for(let e=0;e<t.length;++e){const r=t[e];const i=r.children;for(let e=i.length-1;e>=0;--e){const t=i[e];if(t.isOutline){const e=t.isPolylineMesh;const i=t.material;r.remove(t);x(r,e,i,null);break}}}}};d.prototype.getInitialView=function(){return this._initialView};d.prototype.setInitialView=function(e){this._initialView=e};d.prototype.getMaterial=function(e){return this._materialMap.get(e)};d.prototype.setMaterial=function(e,t){this._materialMap.set(e,t)};d.prototype.clearUnusedMaterials=function(){const e=new Set;this._scene?.traverse(t=>{if(t.material){e.add(t.material);if(t.userData.originalMaterial){e.add(t.userData.originalMaterial)}}});const t=[];this._materialMap.forEach(function(r,i){if(e.has(r.getMaterialRef())){t.push([i,r])}else{r.destroy()}});this._materialMap=new Map(t)};d.prototype._getNativeMaterial=function(e){var t=e?this._materialMap.get(e):null;return t?t.getMaterialRef():null};d.prototype._setNodeMaterial=function(e,t){var r=this._getNativeMaterial(t);e.children.forEach(function(e){if(e.material){if(r){if(e.userData.materialId!==t){this._sceneBuilder._setSubmeshMaterial(e,r,t)}}else{var i=e.userData.initialMaterialId;if(i&&e.userData.materialId!==i){var n=this._getNativeMaterial(i);if(n){this._sceneBuilder._setSubmeshMaterial(e,n,i)}}}}}.bind(this))};d.prototype.bindMarkerNodeTransformationToReferenceNode=function(e,t){if(this._sceneBuilder){this._sceneBuilder.bindMarkerNodeTransformationToReferenceNode(e,t,this.PoiCoordinateSpaces.ReferenceNodeSpace)}};d.prototype.unbindMarkerNodeTransformationFromReferenceNode=function(e,t){if(this._sceneBuilder){this._sceneBuilder.unbindMarkerNodeTransformationFromReferenceNode(e,t)}};d.prototype.getReferenceNodeFromMarkerNodeId=function(e){if(this._sceneBuilder){return this._sceneBuilder.getReferenceNodeFromMarkerNodeId(e)}return null};d.prototype.updateMarkerCoordinateSpace=function(e,t,r){if(!e||!t||!r){return}if(this._sceneBuilder){this._sceneBuilder.updateMarkerCoordinateSpace(e,t,r)}};return d});
//# sourceMappingURL=Scene.js.map