/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../Core","../ViewportBase","../abgrToColor","sap/ui/core/Element","sap/ui/core/ResizeHandler","sap/ui/events/KeyCodes","../Loco","../thirdparty/three","../ViewStateManager","./ViewportGestureHandler","./OrthographicCamera","./PerspectiveCamera","./OutlineRenderer","../Messages","sap/ui/base/ManagedObjectObserver","../CameraProjectionType","../CameraFOVBindingType","../VisibilityMode","../ZoomTo","../SelectionMode","../RenderMode","../getResourceBundle","../cssColorToColor","../ViewStateManager","./ViewStateManager","./HitTester","./Scene","./ContentDeliveryService","./ThreeUtils","../Annotation","../measurements/Surface","../NodeContentType","../SelectionDisplayMode","sap/base/assert","sap/base/Log","../findIndexInArray","sap/base/i18n/Localization"],function(e,t,i,r,a,n,o,s,l,h,d,u,c,p,f,g,m,v,_,y,C,w,S,b,R,x,M,k,B,T,A,V,F,N,D,O,G){"use strict";s.ColorManagement.enabled=false;var L=t.extend("sap.ui.vk.threejs.Viewport",{metadata:{library:"sap.ui.vk",events:{cameraChanged:{parameters:{position:"float[]",quaternion:"float[]",zoom:"float"},enableEventBubbling:true},frameRenderingFinished:{}}}});var I=L.getMetadata().getParent().getClass().prototype;s.PropertyBinding.prototype.GetterByBindingType[0]=function(e,t){e[t]=this.targetObject[this.propertyName]};L.prototype.init=function(){if(I.init){I.init.call(this)}this._measurementSurface=new A;this._renderer=null;this._totalGpuAllocated=0;this._totalGpuUpdated=0;this._imageCanvas=null;this._canvas=null;this._registryEntry=null;this._width=1;this._height=1;this._resizeListenerId=null;this._handleResize=this._handleResize.bind(this);this._renderLoopRequestId=0;this._renderLoop=this._renderLoop.bind(this);this._shouldProcessHierarchy=true;this._shouldDoTraversalRendering=false;this._clippingPlanes=[];this._hitTester=new x;this._scene=null;this._camera=new u;this._upAxis=2;var t=new s.Vector4;var i=new s.Vector4;this._updateColor(t,this.getBackgroundColorTop());this._updateColor(i,this.getBackgroundColorBottom());this._checkBackgroundColor();this._backgroundMaterial=new s.ShaderMaterial({uniforms:{topColor:{value:t},bottomColor:{value:i}},vertexShader:["varying float vPos;","void main() {","\tgl_Position = vec4(position, 1.0);","\tvPos = position.y * -0.5 + 0.5;","}"].join("\n"),fragmentShader:["uniform vec4 topColor;","uniform vec4 bottomColor;","varying float vPos;","void main() {","\tgl_FragColor = mix(topColor, bottomColor, vPos);","}"].join("\n"),side:s.DoubleSide,depthTest:false,depthWrite:false,blending:s.NoBlending});this._backgroundCamera=new s.Camera;this._backgroundScene=new s.Scene;this._backgroundScene.add(new s.Mesh(new s.PlaneGeometry(2,2,1,1),this._backgroundMaterial));this._underlayGroup=new s.Group;this._overlayGroup=new s.Group;this._outlineRenderer=new c(1);this._showPMI=true;this._xrayColor1=new s.Vector4(0,.75,1,.45);this._xrayColor2=new s.Vector4(0,0,1,0);this._xrayMaterial=new s.ShaderMaterial({uniforms:{color1:{value:this._xrayColor1},color2:{value:this._xrayColor2}},vertexShader:["#include <clipping_planes_pars_vertex>","varying vec3 vNormal;","void main() {","#include <beginnormal_vertex>","#include <defaultnormal_vertex>","#include <begin_vertex>","#include <project_vertex>","#include <clipping_planes_vertex>","\tvNormal = normalize( transformedNormal );","}"].join("\n"),fragmentShader:["#include <clipping_planes_pars_fragment>","uniform vec4 color1;","uniform vec4 color2;","varying vec3 vNormal;","void main() {","#include <clipping_planes_fragment>","\tgl_FragColor = mix(color1, color2, abs(normalize(vNormal).z));","}"].join("\n"),side:s.DoubleSide,depthWrite:false,depthFunc:s.LessDepth,blending:s.NormalBlending,clipping:true,transparent:true});this._viewportGestureHandler=new h(this);this._loco=new o(this);this._loco.addHandler(this._viewportGestureHandler,-1);this._zoomedObject=null;this._cdsLoader=null;this.attachCameraChanged(function(e){this.setShouldRenderFrame(true)});this._sceneObserver=new f(this.setShouldRenderFrame.bind(this));this._currentViewIndex=0;this._currentView=null;e.getEventBus().subscribe("sap.ui.vk","viewStateApplied",this._onViewStateApplied,this);G.attachChange(this._onLocalizationChanged.bind(this))};L.prototype.cameraUpdateCompleted=function(e){this.fireViewFinished({viewIndex:this._currentViewIndex})};L.prototype.exit=function(){this._stopRenderLoop();G.detachChange(this._onLocalizationChanged);e.getEventBus().unsubscribe("sap.ui.vk","viewStateApplied",this._onViewStateApplied,this);this._loco.removeHandler(this._viewportGestureHandler);this._viewportGestureHandler.destroy();if(this._resizeListenerId){a.deregister(this._resizeListenerId);this._resizeListenerId=null}var t=this.getTools();for(var i=0;i<t.length;i++){var n=r.getElementById(t[i]);if(n){n.setActive(false)}}this._measurementSurface.destroy();this._measurementSurface=null;this._setContent(null);this.setCamera(null);this._outlineRenderer?.dispose();this._outlineRenderer=null;this._backgroundCamera=null;this._backgroundMaterial=null;this._backgroundScene=null;this._loco.destroy();this._loco=null;this._viewportGestureHandler=null;this._cameraLight=null;this._hitTester=null;this._imageCanvas=null;if(this._cdsLoader){this._cdsLoader.detachSceneUpdated(this._handleCdsSceneUpdate,this)}if(I.exit){I.exit.call(this)}};L.prototype._onLocalizationChanged=function(e){var t=this._measurementSurface;if(t&&t.getMeasurements().length>0){t.update(this,this.getCamera())}};L.prototype.onSetViewStateManager=function(e){this._viewStateManager=e;e.attachVisibilityChanged(this._onVisibilityChanged,this);e.attachOpacityChanged(this.setShouldRenderFrame,this);e.attachTintColorChanged(this.setShouldRenderFrame,this);e.attachHighlightColorChanged(this.setShouldRenderFrame,this);e.attachTransformationChanged(this.setShouldRenderFrame,this);e.attachOutlineColorChanged(this.setShouldRenderFrame,this);e.attachOutlineWidthChanged(this.setShouldRenderFrame,this);e.attachOutliningChanged(this._onOutliningOrSelectionChanged,this);e.attachSelectionChanged(this._onOutliningOrSelectionChanged,this)};L.prototype.onUnsetViewStateManager=function(e){e.detachOutliningChanged(this._onOutliningOrSelectionChanged,this);e.detachSelectionChanged(this._onOutliningOrSelectionChanged,this);e.detachVisibilityChanged(this._onVisibilityChanged,this);e.detachOpacityChanged(this.setShouldRenderFrame,this);e.detachTintColorChanged(this.setShouldRenderFrame,this);e.detachHighlightColorChanged(this.setShouldRenderFrame,this);e.detachTransformationChanged(this.setShouldRenderFrame,this);e.detachOutlineColorChanged(this.setShouldRenderFrame,this);e.detachOutlineWidthChanged(this.setShouldRenderFrame,this);this._viewStateManager=null};L.prototype._startRenderLoop=function(){if(this._renderLoopRequestId===0){this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoop)}return this};L.prototype._stopRenderLoop=function(){if(this._renderLoopRequestId!==0){window.cancelAnimationFrame(this._renderLoopRequestId);this._renderLoopRequestId=0}return this};L.prototype.setBackgroundColorTop=function(e){I.setBackgroundColorTop.call(this,e);if(this._backgroundMaterial!==null){this._updateColor(this._backgroundMaterial.uniforms.topColor.value,e);this._checkBackgroundColor()}return this};L.prototype.setBackgroundColorBottom=function(e){I.setBackgroundColorBottom.call(this,e);if(this._backgroundMaterial!==null){this._updateColor(this._backgroundMaterial.uniforms.bottomColor.value,e);this._checkBackgroundColor()}return this};L.prototype.setClippingPlanes=function(e){this._clippingPlanes=e;return this};L.prototype.onBeforeRendering=function(){if(this._resizeListenerId){a.deregister(this._resizeListenerId);this._resizeListenerId=null}this._stopRenderLoop()};L.prototype.onAfterRendering=function(){var e=this.getDomRef();if(this._canvas){e.append(this._canvas)}e.append(this._measurementSurface.getDomRef());this._resizeListenerId=a.register(this,this._handleResize);this._handleResize({size:{width:e.clientWidth,height:e.clientHeight}});this._startRenderLoop()};L.prototype._handleResize=function(e){if(!this._camera||!this._renderer){return false}if(this.getSafeArea()){this.getSafeArea().resize()}var t=e.size.width;var i=e.size.height;this._width=t;this._height=i;if(this._camera){this._camera.update(t,i)}var r=this._canvas;var a=this._renderer.domElement;if(r!==a){var n=window.devicePixelRatio;r.width=Math.floor(t*n);r.height=Math.floor(i*n);r.style.width=t+"px";r.style.height=i+"px"}K(this._registryEntry);var o=this._measurementSurface.getDomRef();o.style.width=t+"px";o.style.height=i+"px";this.fireResize({size:{width:t,height:i}});this.setShouldRenderFrame(true);return true};L.prototype.setScene=function(e){return this._setScene(e)};L.prototype._setScene=function(e){var t;if(this._scene){t=this._scene.getDefaultNodeHierarchy();t.detachNodeRemoving(this._onNodeRemoving,this);t.detachNodeCreated(this._onNodeCreated,this);Y(this,this._scene)}this._scene=e;this._homeCamera=null;this._currentViewIndex=0;this._currentView=null;this._sceneObserver.disconnect();var i=this._getNativeScene();if(i){this._sceneObserver.observe(this._scene,{properties:["doubleSided"]});this._backgroundNode=this._findBackgroundNode();var r;for(var a=0;a<i.children.length;a++){r=i.children[a];if(r.private&&r.userData.defaultLights&&r.children.length&&r.children[0].isDirectionalLight){this._cameraLight=r.children[0]}}}if(this._scene){t=this._scene.getDefaultNodeHierarchy();t.attachNodeCreated(this._onNodeCreated,this);t.attachNodeRemoving(this._onNodeRemoving,this)}if(this._scene){var n=this._scene.getInitialView();if(n&&this._getViewStateManagerThreeJS()){this.activateView(n,false,true)}}this._clearAnnotations(true);this.setShouldRenderFrame();return this};L.prototype.getScene=function(){return this._scene};L.prototype._getNativeScene=function(){return this._scene?this._scene.getSceneRef():null};L.prototype._getNativeCamera=function(){return this._camera?this._camera.getCameraRef():null};L.prototype._clearAnnotations=function(e){if(e){this.destroyAnnotations()}else{this.getAnnotations().forEach(function(e){if(e.autoGenerated){this.removeAnnotation(e);e.destroy()}},this)}this._annotationsCreated=false};L.prototype._onNodeCreated=function(e){var t=e.getParameter("nodeRef");if(t._vkGetNodeContentType()==V.Annotation){var i=this.getCurrentView();if(i){i.getNodeInfos().push({target:t,visible:true,annotationId:t.userData.treeNode.annotationId})}const e=this._getViewStateManagerThreeJS();var r=this._scene&&this._scene._getAnnotations();if(r){r.forEach(function(i){if(i.node===t){var r=T.createAnnotation(i,this);r.autoGenerated=true;this.addAnnotation(r);r.setDisplay(e?.getVisibilityState(t)??t.visible)}},this)}}};L.prototype._onNodeRemoving=function(e){var t=e.getParameter("nodeRef");if(t._vkGetNodeContentType()===V.Annotation){this.getAnnotations().forEach(function(e){if(e.getNodeRef()===t){this.removeAnnotation(e);e.destroy()}},this)}};L.prototype.setCamera=function(e){if(I.setCamera){I.setCamera.call(this,e)}var t=this.getCamera();if(t&&this._renderer){t.update(this._width,this._height);if(!this._homeCamera&&t.getCameraRef()&&!t._dummyCamera){this._homeCamera=t.getCameraRef().clone()}}this.setShouldRenderFrame(true);return this};L.prototype.getRenderer=function(){return this._renderer};L.prototype._getViewStateManagerThreeJS=function(){if(this._viewStateManager){if(this._viewStateManager instanceof R){return this._viewStateManager}if(this._viewStateManager instanceof b&&this._viewStateManager._implementation instanceof R){return this._viewStateManager._implementation}}return null};L.prototype._updateColor=function(e,t){var i=S(t);e.color=new s.Color(i.red/255,i.green/255,i.blue/255);e.alpha=i.alpha;e.x=e.color.r*e.alpha;e.y=e.color.g*e.alpha;e.z=e.color.b*e.alpha;e.w=e.alpha};L.prototype._checkBackgroundColor=function(){var e=this.getBackgroundColorTop();if(e===this.getBackgroundColorBottom()){if(this._backgroundColor===null){this._backgroundColor=new s.Vector4}this._updateColor(this._backgroundColor,e)}else{this._backgroundColor=null}this.setShouldRenderFrame(true)};L.prototype._handleCdsSceneUpdate=function(){this.setShouldRenderFrame()};L.prototype.setShouldRenderFrame=function(e){if(e!==true){this._shouldProcessHierarchy=true}this._startRenderLoop();return this};L.prototype.shouldRenderFrame=function(){return this._renderLoopRequestId!==0};L.prototype.setRenderMode=function(e){this.setProperty("renderMode",e,true);if(this._scene){switch(e){case C.LineIllustration:case C.ShadedIllustration:case C.SolidOutline:this._scene._createOutlineGeometry(e);break;default:this._scene._hideOutlineGeometry();break}}this.setShouldRenderFrame(false);return this};L.prototype.hitTest=function(e,t,i){var r=this._getNativeScene();var a=this._getNativeCamera();if(!a||!r){return null}var n=this._getViewStateManagerThreeJS();n?.applyNodeStates?.();try{var o=this._canvas;return this._hitTester.hitTest(e-o.clientLeft,t-o.clientTop,o.clientWidth,o.clientHeight,this._renderer,r,a,this._clippingPlanes,i)}finally{n?.revertNodeStates?.()}};L.prototype._isRedlineActivated=function(){var e=this._getNativeCamera();return e?e.userData.isRedlineActivated:false};var P={sphere:"spherical",plane:"planar"};L.prototype._findBackgroundNode=function(){var e=this._getNativeScene();const t=this._getViewStateManagerThreeJS();if(e==null||t==null){return null}var i=function(e){for(var r=0;r<e.length;r++){var a=e[r];if(a._vkGetNodeContentType()===V.Background&&t.getVisibilityState(a)===true&&(a.name==="plane"||a.name==="sphere")){if(a.parent.name==="Background"&&t.getVisibilityState(a.parent)===false){return null}return a}else{var n=i(a.children);if(n!=null){return n}}}return null};return i(e.children)};L.prototype._onVisibilityChanged=function(){this._backgroundNode=this._findBackgroundNode();this.setShouldRenderFrame()};L.prototype.getBackgroundProjection=function(){return P[this._backgroundNode&&this._backgroundNode.name]};L.prototype._isPanoramicActivated=function(){return this.getBackgroundProjection()==="spherical"};L.prototype._isPlanarActivated=function(){return this.getBackgroundProjection()==="planar"};L.prototype.tap=function(e,t,i){if(!i){if(this._viewStateManager){var r=this.hitTest(e,t);var a=r&&r.object;this.tapObject(a);if(a!==null){this.fireNodeClicked({nodeRef:a,x:e,y:t},true,true)}}}else if(!this.getFreezeCamera()){var n=this.hitTest(e,t);if(n&&(this._zoomedObject===null||this._zoomedObject!==n.object)){this._zoomedObject=n.object;this._viewportGestureHandler.zoomObject(this._zoomedObject,true)}else{this._viewportGestureHandler.zoomObject(this._zoomedObject,false);this._zoomedObject=null}}return this};L.prototype.tapObject=function(e){var t={picked:e?[e]:[]};this.fireNodesPicked(t);if(e&&e._vkGetNodeContentType()===V.Background){this.exclusiveSelectionHandler([]);return this}if(this.getSelectionMode()===y.Exclusive){this.exclusiveSelectionHandler(t.picked)}else if(this.getSelectionMode()===y.Sticky){this.stickySelectionHandler(t.picked)}return this};var E={x:-2,y:-2};var z=2;var U=5;L.prototype.onkeydown=function(e){if(!e.isMarked()){var t;switch(e.keyCode){case n.ARROW_LEFT:case n.ARROW_RIGHT:case n.ARROW_UP:case n.ARROW_DOWN:if(e.ctrlKey||e.altKey||e.metaKey){break}var i={x:0,y:0};switch(e.keyCode){case n.ARROW_LEFT:i.x=-1;break;case n.ARROW_RIGHT:i.x=+1;break;case n.ARROW_UP:i.y=-1;break;case n.ARROW_DOWN:i.y=+1;break;default:break}t=this._viewportGestureHandler._cameraController;t.beginGesture(E.x,E.y);if(e.shiftKey){t.pan(U*i.x,U*i.y)}else{t.rotate(z*i.x,z*i.y,true)}t.endGesture();this.setShouldRenderFrame(true);e.preventDefault();e.stopPropagation();break;case 189:case n.PLUS:case n.NUMPAD_MINUS:case n.NUMPAD_PLUS:t=this._viewportGestureHandler._cameraController;t.beginGesture(this.$().width()/2,this.$().height()/2);t.zoom(e.keyCode===n.PLUS||e.keyCode===n.NUMPAD_PLUS?1.02:.98);t.endGesture();this.setShouldRenderFrame(true);e.preventDefault();e.stopPropagation();break;default:break}}};L.prototype._onOutliningOrSelectionChanged=function(e){var t=this.getTools();for(var i=0;i<t.length;i++){var a=r.getElementById(t[i]);var n=a.getGizmoForContainer(this);if(n&&n.handleSelectionChanged){n.handleSelectionChanged(e)}}this.setShouldRenderFrame()};L.prototype.setSelectionRect=function(e){this.setShouldRenderFrame();if(!e){this._selectionRect=null;return}var t=e.x1/this._width*2-1;var i=e.y1/this._height*-2+1;var r=e.x2/this._width*2-1;var a=e.y2/this._height*-2+1;var n=[t,a,-1,r,a,-1,r,i,-1,t,i,-1];if(!this._selectionRect){var o=new s.BufferGeometry;o.setAttribute("position",new s.Float32BufferAttribute(n,3));this._selectionRect=new s.LineLoop(o,new s.LineBasicMaterial({color:12632064,linewidth:window.devicePixelRatio}))}else{var l=this._selectionRect.geometry.getAttribute("position");l.array.set(n);l.needsUpdate=true}};L.prototype.isViewport3D=function(){return this.getMetadata().getName()==="sap.ui.vk.threejs.Viewport"};L.prototype.isView3D=function(){var e=this.getCurrentView&&this.getCurrentView();var t=e&&e.getDimension();return this.isViewport3D()&&!this._redlineHandler&&!this._isPlanarActivated()&&t!==2};L.prototype._renderLoop=function(){this._renderLoopRequestId=0;if(!this._renderer||!this.getDomRef()){return}let e=false;if(this._viewportGestureHandler?.animateCameraUpdate()){e=true}if(this.getCamera()?.getIsModified()){this.getCamera().setIsModified(false);e=true}const t=this._getViewStateManagerThreeJS();if(t!=null){if(t._playTransition()||t._playHighlight()){e=true}}if(this.getAutoStartRendering()){if(t!=null){t._setJointNodeMatrix();const e=this.isView3D();const i=this.isViewport3D()&&this._isPanoramicActivated();if(e&&!i){t.updateAssociatedMarkerMatrix()}}this.render();for(const e of this.getAnnotations()){e.update()}this._measurementSurface.update(this,this.getCamera())}if(e){this.setShouldRenderFrame()}};function j(e,t,i,r,a){var n=new s.Vector2(r._width,r._height);var o=r.getBackgroundProjection();let l=false;e.userData??={};e.userData.outputSettings=r._outputSettings;i.children.forEach(function(i){if(i.userData._vkDynamicObjects){i.userData._vkDynamicObjects.forEach(function(i){if(i.parent){i._vkUpdate(e,t,n,o,a);l=true}})}});return l}function H(e,t,i,r,a){i.children.forEach(function(n){if(n.userData._vkDetailViews){n.userData._vkDetailViews.sort(function(e,t){return e.renderOrder-t.renderOrder});n.userData._vkDetailViews.forEach(function(n){if(n.node.visible){n.detailView._render(e,t,i,r,a)}})}})}const W=(new s.Matrix4).elements;function J(e,t){const i=e.userData.renderGroup?.clusterIndex;if(i!==undefined){const r=t[i];if(r.isPoints&&e.matrixWorld.elements.some((e,t)=>e!==W[t])){return true}}return e.children.some(e=>J(e,t))}L.prototype._setPointCloudTransformationDisabled=function(e){this._disablePointCloudTransformation=e;this.setShouldRenderFrame();var t=this._getNativeScene();return e&&t?.userData.geometryClusters&&J(t,t.userData.geometryClusters)};L.prototype._prepareForRenderingRecursive=function(e,t,i,r,a,n,o,s){if(e.visible===false||s&&e._vkGetNodeContentType()===V.PMI){if(r){B.removeNodeFromClusterRenderingRecursive(e,r,a)}return}if(e.userData.renderStage){(e.userData.renderStage<0?this._underlayGroup:this._overlayGroup).children.push(e);if(!o&&r){o=true;B.removeNodeFromClusterRenderingRecursive(e,r,a)}}e.matrixAutoUpdate=false;if(e.matrixWorldNeedsUpdate||n){if(e.parent===null){e.matrixWorld.copy(e.matrix)}else{e.matrixWorld.multiplyMatrices(e.parent.matrixWorld,e.matrix)}e.matrixWorldNeedsUpdate=true;n=true}if(!o){B.updateNodeClusterRenderingInfo(e,t,i,r,a,this._disablePointCloudTransformation)}var l=e.children;for(var h=0,d=l.length;h<d;h++){this._prepareForRenderingRecursive(l[h],t,i,r,a,n,o,s)}};function q(e,t){e.children.forEach(function(e){if(!e.userData.defaultLights){e.visible=t}})}function Q(e,t){if(e?.isDirectionalLight&&t){t.updateMatrixWorld();e.position.setFromMatrixColumn(t.matrixWorld,2);e.updateMatrix();e.updateMatrixWorld(true)}}L.prototype.render=function(){var e=this._renderer;if(!e){return}var t=performance.now();var i=this._getViewStateManagerThreeJS();i?.applyNodeStates?.(this.getSelectionDisplayMode()===F.Outline);try{e.setViewport(0,0,this._canvas.width/window.devicePixelRatio,this._canvas.height/window.devicePixelRatio);var a=this._getNativeScene();var n=this._getNativeCamera();if(!a||!n){return}var o=a.userData;var l=this.getScene();Q(this._cameraLight,n);if(o.pointScale){this._renderer.pointScale=o.pointScale}var h=o.geometryClusters;var d=h?o.instanceDataTexture:null;var u=d?d.image.data:null;var c=B.prepareTextureUpdateResults(h?h.length:0,o.textureUpdateResults);o.textureUpdateResults=null;var p=new Float32Array(20);var f=performance.now();var g=false;const te=this._showPMI===false;if(this._shouldProcessHierarchy){this._shouldProcessHierarchy=false;g=true;this._underlayGroup.children.length=0;this._overlayGroup.children.length=0;if(h){B.initClustersBeforeProcessingHierarchy(h)}this._prepareForRenderingRecursive(a,h,p,u,c,false,false,te);this._shouldDoTraversalRendering=c[2]===1;if(this._underlayGroup.children.length>0||this._overlayGroup.children.length>0){for(let e=0,t=a.children.length;e<t;++e){const t=a.children[e];if(t.userData.defaultLights){if(this._underlayGroup.children.length>0){this._underlayGroup.children.push(t)}if(this._overlayGroup.children.length>0){this._overlayGroup.children.push(t)}}}}}var m=performance.now();a.matrixWorldAutoUpdate=false;o.doTraversalRendering=this._shouldDoTraversalRendering;var v=performance.now();if(d&&c[1]>=c[0]){B.processUpdatedDataTexture(d,c[0],c[1]+1);B.computeClusterBoundingBoxes(h,u,a,c)}var _=h?B.prepareClustersForGpuUpload(h):0;var y=performance.now();var w=this.getTools();var S,b,R,x;const ie=j(e,n,a,this,i);const re=ie&&(n.near<=0||n.far<=0);if(i&&(g||ie)){i._updateBoundingBoxes()}var M=performance.now();var k=M;if(this._camera.getUsingDefaultClipPlanes()||n.isOrthographicCamera&&n.zoom<=0){x=l._computeBoundingBox(true,false,true);if(i){i._expandBoundingBoxWithSelected(x)}k=performance.now();if(re&&x.isEmpty()){x=l._computeBoundingBox(false,false,true)}if(!x.isEmpty()){if(n.isOrthographicCamera&&n.zoom<=0){this._camera.adjustZoom(x)}if(this._camera.getUsingDefaultClipPlanes()){for(S=0;S<w.length;S++){b=r.getElementById(w[S]);R=b.getGizmoForContainer(this);if(R&&R.expandBoundingBox){R.expandBoundingBox(x)}}this._camera.adjustClipPlanes(x)}if(re){j(e,n,a,this,i)}var T=new s.Vector3;x.getSize(T);var A=this._camera._nativeCamera.position;var V,N,O;for(var G=0;G<3;++G){O=Math.abs(T.getComponent(G));if(!G||O>V){V=O}O=Math.abs(A.getComponent(G));if(!G||O>N){N=O}}if(N/V>100&&!o.totalPointCount){o.useGeometryClusters=false}}}e.autoClear=false;if(this._backgroundColor!==null){e.setClearColor(this._backgroundColor.color,this._backgroundColor.alpha);e.clear(true,true,false)}else{e.render(this._backgroundScene,this._backgroundCamera);e.clearDepth()}if(this._underlayGroup.children.length>0){e.render(this._underlayGroup,n);e.clearDepth();q(this._underlayGroup,false)}q(this._overlayGroup,false);e.clippingPlanes=this._clippingPlanes;switch(this.getRenderMode()){case C.XRay:if(i){var L=a.children[a.children.length-1].clone();i._selectedNodes.forEach(function(t){if(t.visible){t.add(L);e.render(t,n);t.remove(L)}})}this._xrayMaterial.specularMap=d;a.overrideMaterial=this._xrayMaterial;break;default:break}var I=performance.now();e.render(a,n);var P=performance.now();var E=e.info.render;var z=E.frame;var U={calls:a.userData.doTraversalRendering?-E.calls:E.calls,tris:E.triangles,tMatrix:(m-f).toFixed(1),tBBox:(k-M).toFixed(1),tRender:(P-I).toFixed(1),tTexture:(y-v).toFixed(1),lines:E.lines,points:E.points,vramAllocated:E.vramAllocated,vramUpdated:E.vramUpdated};e.clippingPlanes=[];a.overrideMaterial=null;if(this.getShowSelectionBoundingBoxes()&&i){var W=i._boundingBoxesScene;if(W){e.render(W,n)}}if(this._overlayGroup.children.length>0){q(this._overlayGroup,true);e.clearDepth();e.render(this._overlayGroup,n)}q(this._underlayGroup,true);H(e,n,a,x,this._cameraLight);if(i?._outlinedNodes.size>0){this._renderOutline(a,n,Array.from(i._outlinedNodes),i._outlineColorABGR,i)}if(this.getSelectionDisplayMode()===F.Outline&&i?._selectedNodes.size>0){this._renderOutline(a,n,Array.from(i._selectedNodes),i._highlightColorABGR,i)}for(S=0;S<w.length;S++){b=r.getElementById(w[S]);R=b.getGizmoForContainer(this);if(R&&R.render){R.render(this)}}if(this._selectionRect){e.render(this._selectionRect,this._backgroundCamera)}var J=this._registryEntry.webGLRenderer.domElement;var X=this._canvas;if(X!==J){var Z=X.getContext("2d");var Y=X.width;var K=X.height;Z.drawImage(J,0,J.height-K,Y,K,0,0,Y,K)}var $=performance.now();var ee="";if(U.vramAllocated>0){this._totalGpuAllocated+=U.vramAllocated;ee+=", allocated="+(U.vramAllocated/1048576).toFixed(1)+"MB ("+(this._totalGpuAllocated/1048576).toFixed(1)+"MB total)"}if(U.vramUpdated>0){this._totalGpuUpdated+=U.vramUpdated;ee+=", updated="+(U.vramUpdated/1048576).toFixed(1)+"MB ("+(this._totalGpuUpdated/1048576).toFixed(1)+"MB total)"}if(_>0){ee+=", partialClusters="+_}D.debug("Frame #"+z+": "+($-t).toFixed(1)+"ms","Calls="+U.calls+", Tris="+U.tris+", tMatrix="+U.tMatrix+", tBBox="+U.tBBox+", tRender="+U.tRender+", tTexture="+U.tTexture+", lines="+U.lines+", points="+U.points+ee)}finally{i?.revertNodeStates?.()}this.fireFrameRenderingFinished()};L.prototype._renderOutline=function(e,t,r,a,n){const o=i(a);const l=new s.Color(o.red/255,o.green/255,o.blue/255);this._outlineRenderer.render(this._renderer,e,t,r,l,n.getOutlineWidth(),n._jointCollection)};L.prototype.getImage=function(e,t,i,r,a){var n=this._getNativeScene();if(!n){return null}e=Math.min(e||16,2048);t=Math.min(t||16,2048);this._imageCanvas=this._imageCanvas||document.createElementNS("http://www.w3.org/1999/xhtml","canvas");var o=B.createWebGLImageRenderer(this._imageCanvas,e,t);var s=this.getBackgroundColorTop();var l=this.getBackgroundColorBottom();if(i&&!r){o.setClearColor(i,1)}else if(!i&&r){o.setClearColor(r,1)}else{if(i&&r){this.setBackgroundColorTop(i);this.setBackgroundColorBottom(r)}o.render(this._backgroundScene,this._backgroundCamera);o.autoClear=false}document.body.appendChild(o.domElement);var h=this.getCamera();var c=h instanceof u?new u:new d;c.getCameraRef().copy(h.getCameraRef());c.update(e,t);Q(this._cameraLight,c.getCameraRef());var p=[];var f=this._getViewStateManagerThreeJS();if(!a){if(f!==null){f.enumerateSelection(function(e){p.push(e)});f.setSelectionStates([],p,false,true)}}var g=n.userData.useGeometryClusters;n.userData.useGeometryClusters=false;o.render(n,c.getCameraRef());n.userData.useGeometryClusters=g;var m=o.getContext().canvas.toDataURL();if(f!==null&&p.length>0){f.setSelectionStates(p,[],false,true)}document.body.removeChild(o.domElement);o.dispose();if(l&&i){this.setBackgroundColorBottom(l)}if(s&&r){this.setBackgroundColorTop(s)}return m};L.prototype.getMaterialImage=function(e,t,i,r,a,n){t=s.MathUtils.clamp(t||256,8,2048);i=s.MathUtils.clamp(i||256,8,2048);this._imageCanvas=this._imageCanvas||document.createElementNS("http://www.w3.org/1999/xhtml","canvas");var o=B.createWebGLImageRenderer(this._imageCanvas,t,i);var l=this.getBackgroundColorTop();var h=this.getBackgroundColorBottom();if(r&&!a){o.setClearColor(r,1)}else if(!r&&a){o.setClearColor(a,1)}else if(r&&a){this.setBackgroundColorTop(r);this.setBackgroundColorBottom(a);o.render(this._backgroundScene,this._backgroundCamera);o.autoClear=false}else{o.setClearColor("#000000",0)}document.body.appendChild(o.domElement);var u=new d;var c=u.getCameraRef();u.update(t,i);var p=new s.SphereGeometry(1,64,32);var f=new s.Mesh(p);var g=new s.Box3;f._expandBoundingBox(g,false,false,false);c._vkZoomTo(g,n);u.adjustClipPlanes(g);const m=new s.DirectionalLight(16777215,Math.PI);Q(m,c);f.add(m);var v=Array.isArray(e)?e:[e];var _=[];for(var y in v){f.material=v[y];o.render(f,c);_.push(o.getContext().canvas.toDataURL())}f.remove(m);document.body.removeChild(o.domElement);o.dispose();if(h&&r){this.setBackgroundColorBottom(h)}if(l&&a){this.setBackgroundColorTop(l)}return Array.isArray(e)?_:_[0]};L.prototype.getObjectImage=function(e,t,i,r,a,n,o){return this.getObjectImageEx(e,t,i,r,a,{quaternion:n,margin:o,includeOverlay:true})};L.prototype.getObjectImageEx=function(e,t,i,r,a,n){var o=this._getNativeScene();if(!o){return null}n=n||{};t=s.MathUtils.clamp(t||256,8,2048);i=s.MathUtils.clamp(i||256,8,2048);this._imageCanvas=this._imageCanvas||document.createElementNS("http://www.w3.org/1999/xhtml","canvas");var l=B.createWebGLImageRenderer(this._imageCanvas,t,i);var h=this.getBackgroundColorTop();var c=this.getBackgroundColorBottom();if(r&&!a){l.setClearColor(r,1)}else if(!r&&a){l.setClearColor(a,1)}else{if(r&&a){this.setBackgroundColorTop(r);this.setBackgroundColorBottom(a)}l.render(this._backgroundScene,this._backgroundCamera);l.autoClear=false}document.body.appendChild(l.domElement);var p=this._getViewStateManagerThreeJS();p?.applyNodeStates?.();try{if(e==null){e=o.children.slice().filter(function(e){return!e.userData.defaultLights})}else if(!Array.isArray(e)){e=[e]}var f=this.getCamera();var g=f instanceof u?new u:new d;var m=g.getCameraRef();m.copy(f.getCameraRef());if(n.quaternion&&!n.useViewportCamera){m.quaternion.copy(n.quaternion);m.updateMatrixWorld();m.up.setFromMatrixColumn(m.matrixWorld,1).normalize()}g.update(t,i);if(!n.useViewportCamera){e[0].getWorldPosition(m.position);m.position.sub(m.getWorldDirection(new s.Vector3).multiplyScalar(1e3))}m.updateMatrixWorld();m.updateProjectionMatrix();var v=new s.Vector2;l.getSize(v);var _=[];e.forEach(function(e){e.traverseVisible(function(e){e._vkUpdate?.(l,m,v,null,p);if(!n.includeOverlay&&e.userData.renderStage>0||!n.includeUnderlay&&e.userData.renderStage<0){_.push(e);e.visible=false}})});var y=new s.Scene;y.children=e;var C=new s.Box3;y._expandBoundingBox(C,false,false,false);if(!n.useViewportCamera){m._vkZoomTo(C,n.margin)}g.adjustClipPlanes(C);var w=o.children[o.children.length-1].clone();Q(w.children[0],m);y.add(w);var S=[];if(p!=null){p.enumerateSelection(function(e){S.push(e)});p.setSelectionStates([],S,false,true)}var b=y.userData.useGeometryClusters;y.userData.useGeometryClusters=false;l.render(y,m);y.userData.useGeometryClusters=b;if(p!=null&&S.length>0){p.setSelectionStates(S,[],false,true)}if(_.length>0){_.forEach(function(e){e.visible=true})}y.remove(w);y.children=[]}finally{p?.revertNodeStates?.()}var R=l.getContext().canvas.toDataURL(n.type,n.encoderOptions);document.body.removeChild(l.domElement);l.dispose();if(c&&r){this.setBackgroundColorBottom(c)}if(h&&a){this.setBackgroundColorTop(h)}return R};L.prototype._initDummyCamera=function(e){const t=this.getScene()._computeBoundingBox(true,true,false,true);if(!t.isEmpty()){e._dummyCamera=false;e.setFov(14.27);const i=this._upAxis===4?new s.Euler(s.MathUtils.degToRad(90-30),0,s.MathUtils.degToRad(55-90),"ZXY"):new s.Euler(s.MathUtils.degToRad(-30),s.MathUtils.degToRad(55-90),0,"YXZ");this.setCamera(e);this._viewportGestureHandler.zoomTo(t,(new s.Quaternion).setFromEuler(i),0,0,null,false)}};L.prototype._setContent=function(e){I._setContent.apply(this,arguments);var t=null;if(this._scene){Y(this,this._scene)}if(e){t=e;if(!(t instanceof M)){t=null}var i;if(e.loaders){for(i=0;i<e.loaders.length;i++){if(e.loaders[i]instanceof k){this._cdsLoader=e.loaders[i];this._cdsLoader.getSceneBuilder()._fireSceneUpdated=this.setShouldRenderFrame.bind(this);this._cdsLoader.attachSceneUpdated(this._handleCdsSceneUpdate,this);this._cdsLoader.attachInitialViewCompleted(this.setShouldRenderFrame,this);this._contentLoadingFinished=false;break}}}if(e.builders){for(i=0;i<e.builders.length;i++){e.builders[i]._fireSceneUpdated=this.setShouldRenderFrame.bind(this)}}}else if(this._cdsLoader){this._cdsLoader.detachSceneUpdated(this._handleCdsSceneUpdate,this);this._cdsLoader.detachInitialViewCompleted(this.setShouldRenderFrame,this);this._cdsLoader=null}if(t){Z(this,t)}this._setScene(t);if(e){this._upAxis=e.upAxis||2;let t=e.camera;if(!(t instanceof d)&&!(t instanceof u)){t=new u;t._dummyCamera=true;if(e.builders&&e.builders.length>0){this._initDummyCamera(t)}}this.setCamera(t);if(e.backgroundTopColor!==undefined){this.setBackgroundColorTop(new s.Color(e.backgroundTopColor).getStyle())}if(e.backgroundBottomColor!==undefined){this.setBackgroundColorBottom(new s.Color(e.backgroundBottomColor).getStyle())}if(e.renderMode!==undefined){this.setRenderMode(e.renderMode)}this._outputSettings=e.outputSettings}if(this._measurementSurface!=null){this._measurementSurface.setScale(1)}return this};L.prototype.onSetContentConnector=function(e){t.prototype.onSetContentConnector.call(this,e);e.attachContentChangesFinished(this.setShouldRenderFrame,this);e.attachContentLoadingFinished(this._onContentLoadingFinished,this)};L.prototype.onUnsetContentConnector=function(e){e.detachContentChangesFinished(this.setShouldRenderFrame,this);e.detachContentLoadingFinished(this._onContentLoadingFinished,this);t.prototype.onUnsetContentConnector.call(this,e)};L.prototype._onContentLoadingFinished=function(e){this._contentLoadingFinished=true;if(this.getCamera()?._dummyCamera){this._initDummyCamera(this.getCamera())}this._createAnnotations();this.setRenderMode(this.getRenderMode());this.setShouldRenderFrame()};L.prototype.getCurrentView=function(){return this._currentView};L.prototype._onViewStateApplied=function(e,t,i){if(i.source!=this._getViewStateManagerThreeJS()||!this._scene){return}this._ignoreAnimationPosition=i.ignoreAnimationPosition;this.activateView(i.view,i.playViewGroup,i.skipCameraTransitionAnimation)};L.prototype._activateSingleView=function(t,i,r){var a=this._scene.getViewGroups();var n=this;if(a){a.forEach(function(e){e.getViews().forEach(function(i){if(i===t){n._currentViewIndex=e.getViews().indexOf(i)}})})}this.fireViewActivated({viewIndex:this._currentViewIndex,view:t});e.getEventBus().publish("sap.ui.vk","viewActivated",{source:this,view:t,viewIndex:this._currentViewIndex});this._currentView=t;this._backgroundNode=this._findBackgroundNode();var o=t.getTopColor();if(o!=null){if(Array.isArray(o)&&o.length>2){this.setBackgroundColorTop(new s.Color(o[0],o[1],o[2]).getStyle())}else{this.setBackgroundColorTop(new s.Color(o).getStyle())}}var l=t.getBottomColor();if(l!=null){if(Array.isArray(l)&&l.length>2){this.setBackgroundColorBottom(new s.Color(l[0],l[1],l[2]).getStyle())}else{this.setBackgroundColorBottom(new s.Color(l).getStyle())}}if(t.renderMode!==undefined){this.setRenderMode(t.renderMode)}this._outputSettings=t.outputSettings;var h=t.getCamera();var d=this._getViewStateManagerThreeJS();var u=t.flyToTime!=null?t.flyToTime:2e3;var c;if(d&&d._fadeOutBackground&&d._fadeInBackground&&d._fadeOutBackground!==d._fadeInBackground&&d._fadeOutBackground.name==="sphere"){c="zoomIn";h=h||this.getCamera()}var p=0;if(h){var f=i&&!t.hasAnimation();p=this._viewportGestureHandler.activateCamera(h.getCameraRef(),r?0:u,f,c)}else{this.cameraUpdateCompleted()}var g=0;if(!r){g=d._startTransition(p>0?p:u,t)}if(this.getSafeArea()){this.getSafeArea().resize()}if(this._readyForAnimationTimer){clearTimeout(this._readyForAnimationTimer)}this._readyForAnimationTimer=setTimeout(function(){this._readyForAnimationTimer=0;if(d){if(this._contentLoadingFinished!==false){this._createAnnotations()}d.fireReadyForAnimation({view:t,ignoreAnimationPosition:this._ignoreAnimationPosition});e.getEventBus().publish("sap.ui.vk","readyForAnimation",{source:d,view:t,ignoreAnimationPosition:this._ignoreAnimationPosition});d._startHighlight()}}.bind(this),Math.max(g,p)+100)};L.prototype.resetCurrentView=function(){if(!this._currentView){return this}this._getViewStateManagerThreeJS()._resetNodesMaterialAndOpacityByCurrentView(this._currentView);this._getViewStateManagerThreeJS()._resetNodesStatusByCurrentView(this._currentView,true);this.setShouldRenderFrame();return this};L.prototype.activateView=function(e,t,i){this._clearAnnotations();this._activateSingleView(e,t,i);return this};L.prototype.zoomTo=function(e,t,i,r){var a=this._getNativeScene();var n=this._getNativeCamera();if(!n||!a){return this}r=r||0;var o=new s.Box3;var l=null;var h=null;(Array.isArray(e)?e:[e]).forEach(function(e){switch(e){case _.All:a._expandBoundingBox(o,false,true);break;case _.Visible:a._expandBoundingBox(o,true,true);break;case _.Selected:var i=this._getViewStateManagerThreeJS();if(i){i.enumerateSelection(function(e){e._expandBoundingBox(o,false,true)})}break;case _.Node:if(!t){return}h=t;if(Array.isArray(t)){t.forEach(function(e){e._expandBoundingBox(o,false,true)})}else{t._expandBoundingBox(o,false,true)}break;case _.Restore:D.error(w().getText("VIEWPORT_MSG_RESTORENOTIMPLEMENTED"));return;case _.NodeSetIsolation:D.error(w().getText("VIEWPORT_MSG_NODESETISOLATIONNOTIMPLEMENTED"));return;case _.RestoreRemoveIsolation:D.error(w().getText("VIEWPORT_MSG_RESTOREREMOVEISOLATIONNOTIMPLEMENTED"));return;case _.ViewLeft:l=(new s.Quaternion).setFromAxisAngle(new s.Vector3(0,1,0),-Math.PI/2);break;case _.ViewRight:l=(new s.Quaternion).setFromAxisAngle(new s.Vector3(0,1,0),Math.PI/2);break;case _.ViewTop:l=(new s.Quaternion).setFromAxisAngle(new s.Vector3(1,0,0),-Math.PI/2);break;case _.ViewBottom:l=(new s.Quaternion).setFromAxisAngle(new s.Vector3(1,0,0),Math.PI/2);break;case _.ViewBack:l=(new s.Quaternion).setFromAxisAngle(new s.Vector3(0,1,0),Math.PI);break;case _.ViewFront:l=(new s.Quaternion).setFromAxisAngle(new s.Vector3(0,1,0),0);break;default:break}},this);if(!o.isEmpty()){this._viewportGestureHandler.zoomTo(o,l,r,i*1e3,h,h!==null)}return this};L.prototype.pan=function(e,t){this._viewportGestureHandler._cameraController.pan(e,t)};L.prototype.rotate=function(e,t,i){this._viewportGestureHandler._cameraController.rotate(e,t,i)};L.prototype.zoom=function(e){this._viewportGestureHandler._cameraController.zoom(e)};L.prototype.getViewInfo=function(e){var t={};if(e==null){e={}}if(e.camera==null){e.camera=true}var i=this._getNativeCamera();if(e.camera&&i){var r=i.rotation.clone();r.reorder("YXZ");t.camera={rotation:{yaw:s.MathUtils.radToDeg(r.y),pitch:s.MathUtils.radToDeg(r.x),roll:s.MathUtils.radToDeg(r.z)},position:{x:i.position.x,y:i.position.y,z:i.position.z},projectionType:i.isOrthographicCamera?g.Orthographic:g.Perspective,bindingType:m.Vertical};var a=i.view;if(a&&a.enabled){t.camera.view={fullWidth:a.fullWidth,fullHeight:a.fullHeight,offsetX:a.offsetX,offsetY:a.offsetY,width:a.width,height:a.height}}if(t.camera.projectionType===g.Perspective){t.camera.fieldOfView=i.fov}else if(t.camera.projectionType===g.Orthographic){t.camera.zoomFactor=i.zoom}if(e.camera.matrices){t.camera.matrices={view:i.matrixWorldInverse.elements.slice(),projection:i.projectionMatrix.elements.slice()}}}if(e.visibility&&this._viewStateManager){var n=e.visibility.mode==null?v.Complete:e.visibility.mode;t.visibility={mode:n};if(n===v.Complete){var o=this._viewStateManager.getVisibilityComplete();t.visibility.visible=o.visible;t.visibility.hidden=o.hidden}else if(this._viewStateManager.getShouldTrackVisibilityChanges()){t.visibility.changes=this._viewStateManager.getVisibilityChanges()}else{D.warning(w().getText(p.VIT32.summary),p.VIT32.code,"sap.ui.vk.threejs.Viewport")}}var l=this._getViewStateManagerThreeJS();if(e.selection&&l){t.selection=l._getSelectionComplete()}return t};L.prototype.setViewInfo=function(e,t){var i=this._getNativeCamera();if(e.camera&&i){var r=e.camera;var a=r.projectionType===g.Orthographic?new s.OrthographicCamera:new s.PerspectiveCamera;a.userData=i.userData;a.aspect=i.aspect;a.position.copy(r.position);var n=r.rotation;a.quaternion.setFromEuler(new s.Euler(s.MathUtils.degToRad(n.pitch),s.MathUtils.degToRad(n.yaw),s.MathUtils.degToRad(n.roll),"YXZ"));a.fov=r.fieldOfView||a.fov;a.zoom=r.zoomFactor||a.zoom;a.updateMatrix();a.up.setFromMatrixColumn(a.matrix,1).normalize();if(i.view&&i.view.enabled){var o=r.view||i.view;a.setViewOffset(o.fullWidth,o.fullHeight,o.offsetX,o.offsetY,o.width,o.height);if(i.isPerspectiveCamera){a.aspect=o.fullWidth/o.fullHeight;a.zoom=Math.min(a.aspect,1)}}this._viewportGestureHandler.activateCamera(a,(t||0)*1e3)}var l=new Map;if(e.visibility||e.selection){var h=this._viewStateManager.getNodeHierarchy();if(h){var d=h.findNodesByName();d.forEach(function(e){var t=h.createNodeProxy(e);var i=t.getVeId();h.destroyNodeProxy(t);if(i){l.set(i,e)}})}}if(e.visibility){switch(e.visibility.mode){case v.Complete:var u=e.visibility.visible,c=e.visibility.hidden;u.forEach(function(e){this._viewStateManager.setVisibilityState(l.get(e),true,false)},this);c.forEach(function(e){this._viewStateManager.setVisibilityState(l.get(e),false,false)},this);break;case v.Differences:this._viewStateManager.resetVisibility();e.visibility.changes.forEach(function(e){var t=l.get(e);if(t){this._viewStateManager.setVisibilityState(t,!this._viewStateManager.getVisibilityState(t),false)}},this);break;default:D.error(w().getText(p.VIT28.summary),p.VIT28.code,"sap.ui.vk.threejs.Viewport");break}}var f=this._getViewStateManagerThreeJS();var m=e.selection;if(m&&f){var _=f._getSelectionComplete();if(Array.isArray(m.selected)){var y=[];var C=[];m.selected.forEach(function(e){var t=l.get(e);if(t){y.push(t)}});_.selected.forEach(function(e){var t=l.get(e);if(t&&m.selected.indexOf(e)<0){C.push(t)}});f.setSelectionStates(y,C,false,false)}if(Array.isArray(m.outlined)){var S=[];var b=[];m.outlined.forEach(function(e){var t=l.get(e);if(t){S.push(t)}});_.outlined.forEach(function(e){var t=l.get(e);if(t&&m.outlined.indexOf(e)<0){b.push(t)}});f.setOutliningStates(S,b,false,false)}}this.setShouldRenderFrame();return this};L.prototype.queueCommand=function(e){if(this instanceof L){e()}return this};L.prototype.getOutputSize=function(){var e=this.getDomRef().getBoundingClientRect();var t=e.width;var i=e.height;var r;r=Math.min(t,i);return{left:(t-r)/2,top:(i-r)/2,sideLength:r}};L.prototype.projectToScreen=function(e,t,i,r){var a=this.getDomRef().getBoundingClientRect();var n=a.width/2;var o=a.height/2;var l=new s.Vector3(e,t,i).project(r.getCameraRef());return{x:n+l.x*n,y:o-l.y*o,depth:l.z}};L.prototype._createAndAddAnnotation=function(e){var t=T.createAnnotation(e,this);t.autoGenerated=true;t.setDisplay(this._viewStateManager.getVisibilityState(e.node));this.addAnnotation(t);return t};L.prototype._createAnnotations=function(){if(this._annotationsCreated){return this}this._annotationsCreated=true;var e=this._scene&&this._scene._getAnnotations();if(e==null||e.size===0){return this}var t=this.getCurrentView();if(t){t.getNodeInfos().filter(function(e){var t=e.target;return e.annotationId!=null&&t._vkGetNodeContentType()===V.Annotation&&t.userData.annotationType==="html"}).forEach(function(t){var i=t.target;var r=e.get(t.annotationId);N(r!=null,"Cannot find annotation for node with sid="+this._scene.nodeRefToPersistentId(i));if(r!=null){N(i===r.node,"Annotation found for node with sid="+this._scene.nodeRefToPersistentId(t.target)+" references other node with sid="+this._scene.nodeRefToPersistentId(r.node));if(i===r.node){this._createAndAddAnnotation(r)}}},this)}else{e.forEach(function(e){this._createAndAddAnnotation(e)},this)}var i=0;this.getAnnotations().forEach(function(e){if(e.getAnimate()&&e.getDisplay()&&e.getAnimationDelay()===-1){e.setAnimationDelay(i++)}});return this};L.prototype.setBackgroundNode=function(e){var t=this._viewStateManager.getNodeHierarchy();var i;var r=t.findNodesByName().reduce(function(e,t){if(t._vkGetNodeContentType()===V.Background){if(this._viewStateManager.getVisibilityState(t)){i=t}e.push(t)}return e}.bind(this),[]);if(!e){this._viewStateManager.setVisibilityState(r,true,false);this._viewStateManager.setVisibilityState(i,false,false);this._viewportGestureHandler.setView(null,1e3)}else{var a=e.parametricContent;var n=a.materialId;var o=e.sceneId;var l=t.createNode(i&&i.parent,a.type,null,V.Background,{parametricContent:a});this._viewStateManager.setVisibilityState(r,false,false);r.push(l);if(this._cdsLoader){this._cdsLoader.assignMaterialToNodes(o,n,l.children)}var h=a.type==="plane"?(new s.Quaternion).setFromAxisAngle(new s.Vector3(0,1,0),0):null;this._viewportGestureHandler.setView(h,1e3)}return r};L.prototype.normalizeRectangle=function(e,t,i,r){var a=this.getSafeArea().getDomRef();if(a==null){a=this.getDomRef()}var n=window.getComputedStyle(a);var o=parseFloat(n.width);var s=parseFloat(n.left);var l=(e-s)/o-.5;var h=parseFloat(n.height);var d=parseFloat(n.top);var u=(t-d)/h-.5;return{x:l,y:u,width:i/o,height:r/h}};L.prototype.deNormalizeRectangle=function(e,t,i,r){var a=this.getSafeArea().getDomRef();if(a==null){a=this.getDomRef()}var n=window.getComputedStyle(a);var o=parseFloat(n.width);var s=parseFloat(n.left);var l=o/2;var h=s+l;var d=Math.abs(e)*2;if(e<0){d=1-d;d*=l;d+=s}else if(e>0){d*=l;d+=h}else{d=h}var u=Math.abs(i)*2*l;var c=parseFloat(n.height);var p=parseFloat(n.top);var f=c/2;var g=p+f;var m=Math.abs(t)*2;if(t<0){m=1-m;m*=f;m+=p}else if(t>0){m*=f;m+=g}else{m=g}var v=Math.abs(r)*2*f;return{x:d,y:m,width:u,height:v}};var X=[];function Z(e,t){var i=O(X,function(e){return e.scene===t});if(i<0){var r=B.createWebGLRenderer(window.devicePixelRatio,true);e._registryEntry={scene:t,webGLRenderer:r,viewports:[e]};X.push(e._registryEntry);e._renderer=r;e._canvas=r.domElement;e.invalidate()}else{var a=X[i];var n=a.viewports;var o=n.indexOf(e);if(o<0){if(n.length==1){var s=n[0];s._canvas=document.createElement("canvas");s.invalidate()}n.push(e);e._registryEntry=a;e._renderer=a.webGLRenderer;e._canvas=document.createElement("canvas");e.invalidate()}}}function Y(e,t){var i=O(X,function(e){return e.scene===t});if(i<0){return}var r=X[i];var a=r.viewports;var n=a.indexOf(e);if(n<0){return}a.splice(n,1);if(a.length==1){var o=a[0];o._canvas=r.webGLRenderer.domElement;o.invalidate()}else if(a.length===0){r.webGLRenderer.renderLists.dispose();r.webGLRenderer.dispose();X.splice(i,1)}e._registryEntry=null;e._canvas=null;e._renderer=null;e.invalidate()}function K(e){var t=0;var i=0;e.viewports.forEach(function(e){t=Math.max(t,e._width);i=Math.max(i,e._height)});e.webGLRenderer.setSize(t,i,true)}L.prototype.getMeasurementSurface=function(){return this._measurementSurface};L.prototype.setShowPMI=function(e){this._showPMI=e;return this};return L});
//# sourceMappingURL=Viewport.js.map