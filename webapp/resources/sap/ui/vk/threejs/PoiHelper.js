/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../ContentConnector","../ContentResource","./ContentDeliveryService","../NodeContentType","../TransformationMatrix","../thirdparty/three","sap/base/assert","sap/base/util/uid"],function(e,r,t,n,o,a,i,s){"use strict";var d=new a.Vector3(1,1,1);function c(e){e.userData={skipIt:true};e.children.forEach(c)}var m=function(){this._symbolSceneCache=[]};m.prototype.createPOI=function(e,r,t,m,u,l,f){m=m._implementation||m;if(!("sid"in l)){l.sid=s()}if(!("transform"in l)){i(f!=null,"If nodeInfo.transform is not defined then getNearestEntityOrVisibleElementNodes must be defined.");var v=m.getDomRef().getBoundingClientRect();var y=u.x-v.left;var p=u.y-v.top;var h=m.hitTest(y,p,{ignoreOverlay:true});if(h==null){return Promise.reject("Cannot locate an object for the marker.")}var x=(new a.Matrix4).compose(h.point,m._getNativeCamera().quaternion,d);var g=f(h.object);var N=g.length>0?(new a.Matrix4).copy(g[0].matrixWorld).invert():new a.Matrix4;x.premultiply(N);l.transform=o.convertTo4x3(x.elements);l.referenceNode=(g.length>0?g[0]:h.object).userData.nodeId}l.transformType="BILLBOARD_VIEW";var I=r.getDefaultNodeHierarchy();var w=I.createNode(null,l.name,null,n.Symbol,l);var b=m.getCurrentView()||r.getViews()[0];return this.loadSymbolScene(e,t).then(function(e){var r=e.userData.entityId;w.add.apply(w,e.children);w.children.forEach(c);w.userData.treeNode.entityId=r;b.updateNodeInfos([{target:w,visible:true,transform:l.transform}]);m.setShouldRenderFrame();return{transform:l.transform.slice(),veId:l.sid,entityId:r,name:l.name,transformType:"BILLBOARD_VIEW",contentType:"SYMBOL",referenceNode:l.referenceNode,symbolNode:w}})};m.prototype.updatePOI=function(e,r,t,n,o,a){var i=r.persistentIdToNodeRef(n);if("name"in a){i.name=a.name}if("transform"in a){if(i.userData.treeNode.transform){i.userData.treeNode.transform=a.transform.slice()}else{i.position.set(a.transform[9],a.transform[10],a.transform[11])}}if(o){var s=r.getDefaultNodeHierarchy();s.removeNode(i.children);return this.loadSymbolScene(e,o).then(function(e){var r=e.userData.entityId;i.add.apply(i,e.children);i.children.forEach(c);i.userData._symbolCenterFixed=false;i.userData.treeNode.entityId=r;t.setShouldRenderFrame();return r})}else{t.setShouldRenderFrame();return Promise.resolve(i.userData.treeNode.entityId)}};m.prototype.removePOI=function(e,r){var t=e.getDefaultNodeHierarchy();var n=e.getViewStateManager();n.setVisibilityState(r,false,true);var o=Array.isArray(r)?r:[r];if(o&&o.length){o.forEach(function(r){var t=r.userData.nodeId;var n=e.getReferenceNodeFromMarkerNodeId(t);if(n){e.unbindMarkerNodeTransformationFromReferenceNode(n.userData.nodeId,t)}})}t.removeNode(r)};m.prototype.getPoiRect=function(e,r){var t=e._getNativeCamera();var n=new a.Box3;n.setFromObject(r);var o=[new a.Vector3(n.min.x,n.min.y,n.min.z),new a.Vector3(n.max.x,n.max.y,n.max.z),new a.Vector3(n.min.x,n.min.y,n.max.z),new a.Vector3(n.min.x,n.max.y,n.max.z),new a.Vector3(n.max.x,n.min.y,n.max.z),new a.Vector3(n.max.x,n.max.y,n.min.z),new a.Vector3(n.min.x,n.max.y,n.min.z),new a.Vector3(n.max.x,n.min.y,n.min.z)];var i=new a.Frustum;i.setFromProjectionMatrix((new a.Matrix4).multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse));if(!i.intersectsBox(n)){return false}var s=new a.Vector3(1,1,1);var d=new a.Vector3(-1,-1,-1);var c=new a.Vector3;for(var m=0;m<o.length;++m){if(!i.containsPoint(o[m])){return false}var u=c.copy(o[m]);var l=u.project(t);s.min(l);d.max(l)}var f=new a.Box2(s,d);var v=e.getDomRef().getBoundingClientRect();var y=new a.Vector2(v.width/2,v.height/2);var p=f.min.clone().multiply(y);var h=f.max.clone().multiply(y);var x=h.x-p.x;var g=h.y-p.y;return{width:x,height:g}};m.prototype.adjustPoi=function(e,r){if(e.getBackgroundProjection()!=="planar"){var t=r.getWorldPosition(new a.Vector3).project(e._getNativeCamera());var n=e.hitTest((t.x*.5+.5)*e._width,(t.y*-.5+.5)*e._height,{ignoreOverlay:true});if(n){r.position.copy(n.point)}r.quaternion.copy(e._getNativeCamera().quaternion);r.updateMatrix();r.updateMatrixWorld();r.userData.direction=(new a.Vector3).setFromMatrixColumn(r.matrixWorld,2).normalize()}r.userData.transform=o.convertTo4x3(r.matrix.elements)};m.prototype.updateNodeId=function(e,r,t){var n=e.persistentIdToNodeRef(r);if(n!=null){var o=e.getReferenceNodeFromMarkerNodeId(r);if(o){e.unbindMarkerNodeTransformationFromReferenceNode(o.userData.nodeId,r);e.bindMarkerNodeTransformationToReferenceNode(o.userData.nodeId,t)}e.setNodePersistentId(n,t)}return n};m.prototype.findSymbolSceneInCache=function(e,r){return this._symbolSceneCache.find(function(t){return t.url===e&&t.sceneId===r})};m.prototype.loadSymbolScene=function(n,o){var a=this.findSymbolSceneInCache(n,o);if(a!=null){return Promise.resolve(a.rootNodeRef.clone())}return new Promise(function(a,i){var d="marker-"+s();var c=new r({sourceType:d,source:n,veid:o,sourceId:"abc"});var m=new e;var u=new t;var l=function(){e.removeContentManagerResolver(d);setTimeout(function(){m.destroy();u.destroy()},0)};u.attachEventOnce("sceneCompleted",function(){var e=c.getNodeProxy().getNodeRef();if(this.findSymbolSceneInCache(n,o)==null){this._symbolSceneCache.push({url:n,sceneId:o,rootNodeRef:e.clone()})}a(e.clone());l()},this);u.attachEventOnce("errorReported",function(e){i(e.getParameter("error"));l()});e.addContentManagerResolver({pattern:d,dimension:3,contentManagerClassName:"sap.ui.vk.threejs.ContentManager",settings:{loader:u}});m.addContentResource(c)}.bind(this))};return m});
//# sourceMappingURL=PoiHelper.js.map