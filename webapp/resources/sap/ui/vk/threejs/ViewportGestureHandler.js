/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["sap/base/Log","sap/ui/base/EventProvider","./PerspectiveCamera","./OrthographicCamera","../thirdparty/three","../getResourceBundle","../NodeContentType"],function(e,t,a,i,r,o,n){"use strict";var s=t.extend("sap.ui.vk.threejs.ViewportGestureHandler",{metadata:{library:"sap.ui.vk"},constructor:function(t){this._matProj=null;this._viewport=t;this._rect=null;this._evt={x:0,y:0,z:0,d:0};this._gesture=false;this._viewport.attachEvent("resize",this,this._onresize);this._nomenu=false;var a=function(t){var a=t;var i=new r.Vector3;var s=new r.Vector2;var h=.001;var l=-Math.PI/2+h;var m=Math.PI/2-h;this.isTurnTableMode=true;this._timeIntervalForCameraAnimation=500;this._startTimeForCameraAnimation=0;this._newCamera=null;this._oldCamera=null;this._animationType=null;this._zoomedNodeRef=null;this._isZoomIn=true;this.beginGesture=function(e,t){var o=a.getScene();if(o==null){return}var n=a.getCamera().getCameraRef();var h=a.getRenderer().getSize(new r.Vector2);s.x=e/h.width*2-1;s.y=t/h.height*-2+1;a._gesturePoint={x:e,y:t};var l=n.userData.isRedlineActivated?null:a.hitTest(e,t,o.getSceneRef(),n);if(l){i.copy(l.point)}else{var m=o._computeBoundingBox(true,true);if(!m.isEmpty()){m.getCenter(i)}else{i.setScalar(0)}}};this.endGesture=function(){};this.pan=function(e,t){if(a.getFreezeCamera()||a.getCamera()===null||e===0&&t===0){return}if(a._redlineHandler){a._redlineHandler.pan(e,t)}else if(a._isPanoramicActivated()){this.rotate(e,t);return}var o=a.getCamera().getCameraRef();var n=a.getRenderer().getSize(new r.Vector2);if(o.view&&o.view.enabled){o.view.offsetX-=e*o.view.width/o.view.fullWidth;o.view.offsetY-=t*o.view.height/o.view.fullHeight;o.updateProjectionMatrix()}else{var s=i.clone().project(o);s.x-=e*2/n.width;s.y+=t*2/n.height;s.unproject(o).sub(i);o.position.add(s);o.updateMatrixWorld()}a.fireCameraChanged({position:o.position.toArray()})};var d=[new r.Vector3(+1,0,0),new r.Vector3(-1,0,0),new r.Vector3(0,+1,0),new r.Vector3(0,-1,0),new r.Vector3(0,0,+1),new r.Vector3(0,0,-1)];this.rotate=function(e,t,o){if(a.getFreezeCamera()||a.getCamera()===null||e===0&&t===0){return}if(a._redlineHandler||a._isPlanarActivated()){this.pan(e,t);return}if(o!==undefined){this.isTurnTableMode=o}var n=a.getCamera().getCameraRef();var s=-.01;if(a._isPanoramicActivated()){var h=a.getRenderer().getSize(new r.Vector2);s=2/(h.x*n.projectionMatrix.elements[0]);i.copy(n.position)}var c=e*s,p=t*s;var u=n.position.clone().sub(i);var f=new r.Vector3,_=(new r.Vector3).setFromMatrixColumn(n.matrixWorld,1).normalize(),v=(new r.Vector3).setFromMatrixColumn(n.matrixWorld,0).normalize();n.getWorldDirection(f);f.normalize();var C=new r.Quaternion;if(this.isTurnTableMode){var w=d[a._upAxis]||d[2];v.sub(w.clone().multiplyScalar(w.dot(v))).normalize();var g=v.clone().cross(f);var y=Math.acos(Math.min(Math.max(g.dot(_),-1),1));if(y!==0){var x=Math.abs(c)+Math.abs(p);if(Math.abs(y)>x){y=Math.sign(y)*x}var M=_.clone().cross(g).normalize();_.applyQuaternion((new r.Quaternion).setFromAxisAngle(M,y))}C.setFromAxisAngle(w,c);var b=Math.atan2(f.y,Math.sqrt(f.x*f.x+f.z*f.z));p=r.MathUtils.clamp(p,l-b,m-b)}else{C.setFromAxisAngle(_,c)}C.multiply((new r.Quaternion).setFromAxisAngle(v,p));u.applyQuaternion(C);f.applyQuaternion(C);_.applyQuaternion(C);u.add(i);if(!n.userData.rotate){n.position.copy(u)}n.up.copy(_);n.lookAt(u.add(f));n.updateMatrixWorld();a.fireCameraChanged({position:n.position.toArray(),quaternion:n.quaternion.toArray()})};this.zoom=function(t){if(t===0||t===1||a.getFreezeCamera()||a.getCamera()===null||a.getScene()===null){return}var n=a.getCamera().getCameraRef();var h=new r.Vector3;if(!n.userData.isRedlineActivated){var l=100;var m=new r.Vector3;var d=!a.getBackgroundProjection();var c=a.getScene()._computeBoundingBox(true,d);c.applyMatrix4(n.matrixWorldInverse);c.min.z=Math.max(c.min.z,n.near);c.max.z=Math.max(c.max.z,n.near);c.applyMatrix4(n.projectionMatrix);c.getSize(m);var p=a.getRenderer().getSize(new r.Vector2);var u=m.x*p.width*.5;var f=m.y*p.height*.5;if(u<l&&f<l&&t<1){return}}var _=a._redlineHandler;if(_){t=Math.min(Math.max(_._zoomFactor*t,1/8),32)/_._zoomFactor;_._zoomFactor*=t;_.zoom(t)}if(n.view&&n.view.enabled){var v=a.getDomRef();var C=a._gesturePoint.x/v.clientWidth;var w=a._gesturePoint.y/v.clientHeight;var g=1/t;n.view.offsetX+=C*n.view.width;n.view.offsetY+=w*n.view.height;n.view.width*=g;n.view.height*=g;n.view.offsetX-=C*n.view.width;n.view.offsetY-=w*n.view.height}else if(n.isPerspectiveCamera){if(a._isPanoramicActivated()){n.fov=Math.min(Math.max(5,n.fov/Math.pow(t,.5)),90)}else{h.set(s.x,s.y,1).unproject(n);h.sub(new r.Vector3(s.x,s.y,-1).unproject(n));var y=i.clone().sub(n.position).length()*(1-1/t);h.setLength(y);n.position.add(h)}}else if(n.isOrthographicCamera){h.set(s.x,s.y,1).unproject(n);h.sub(new r.Vector3(0,0,1).unproject(n));h.multiplyScalar(1-1/t);n.zoom*=t;n.position.add(h)}else{e.error(o().getText("VIEWPORTGESTUREHANDLER_MSG_UNSUPPORTEDCAMERATYPE"))}n.updateProjectionMatrix();n.updateMatrixWorld();var x={position:n.position.toArray()};if(n.isOrthographicCamera){x.zoom=n.zoom}a.fireCameraChanged(x)};this.animateCameraUpdate=function(){if(this._newCamera===null||this._oldCamera===null){return false}if(a.getCamera()==null){this._newCamera=null;this._oldCamera=null;return false}function e(e,t,a){a=r.MathUtils.clamp((a-e)/(t-e),0,1);return a*a*a*(a*(a*6-15)+10)}var t=Math.min((Date.now()-this._startTimeForCameraAnimation)/this._timeIntervalForCameraAnimation,1);t=e(0,1,t);var i=a.getCamera().getCameraRef();if(i.view&&i.view.enabled){var o=i.view.width;var n=i.view.height;var s=i.view.offsetX+i.view.width*.5;var h=i.view.offsetY+i.view.height*.5;i.view.offsetX=r.MathUtils.lerp(this._oldCamera.view.offsetX,this._newCamera.view.offsetX,t);i.view.offsetY=r.MathUtils.lerp(this._oldCamera.view.offsetY,this._newCamera.view.offsetY,t);i.view.width=r.MathUtils.lerp(this._oldCamera.view.width,this._newCamera.view.width,t);i.view.height=r.MathUtils.lerp(this._oldCamera.view.height,this._newCamera.view.height,t);var l=i.view.offsetX+i.view.width*.5;var m=i.view.offsetY+i.view.height*.5;var d=a._redlineHandler;if(d){var c=o/i.view.width;var p=(s-l)*i.view.fullWidth/o;var u=(h-m)*i.view.fullHeight/n;d._zoomFactor*=c;d.pan(p,u);d.zoom(c,i.view.fullWidth*.5,i.view.fullHeight*.5)}}if(i.isOrthographicCamera&&this._newCamera.isOrthographicCamera&&this._oldCamera.isOrthographicCamera){i.left=r.MathUtils.lerp(this._oldCamera.left,this._newCamera.left,t);i.right=r.MathUtils.lerp(this._oldCamera.right,this._newCamera.right,t);i.top=r.MathUtils.lerp(this._oldCamera.top,this._newCamera.top,t);i.bottom=r.MathUtils.lerp(this._oldCamera.bottom,this._newCamera.bottom,t);if(this._transitionEffect==="zoomIn"){var f=Math.max(this._oldCamera.zoom,this._newCamera.zoom)*5;i.zoom=t<.5?r.MathUtils.lerp(this._oldCamera.zoom,f,t*2):r.MathUtils.lerp(f,this._newCamera.zoom,(t-.5)*2)}else{i.zoom=r.MathUtils.lerp(this._oldCamera.zoom,this._newCamera.zoom,t)}}if(i.isPerspectiveCamera&&this._newCamera.isPerspectiveCamera&&this._oldCamera.isPerspectiveCamera){if(this._transitionEffect==="zoomIn"){var _=Math.min(this._oldCamera.fov,this._newCamera.fov)*.1;i.fov=t<.5?r.MathUtils.lerp(this._oldCamera.fov,_,t*2):r.MathUtils.lerp(_,this._newCamera.fov,(t-.5)*2)}else{i.fov=r.MathUtils.lerp(this._oldCamera.fov,this._newCamera.fov,t)}}i.far=r.MathUtils.lerp(this._oldCamera.far,this._newCamera.far,t);i.near=r.MathUtils.lerp(this._oldCamera.near,this._newCamera.near,t);i.updateProjectionMatrix();i.position.lerpVectors(this._oldCamera.position,this._newCamera.position,t);i.scale.lerpVectors(this._oldCamera.scale,this._newCamera.scale,t);i.up.lerpVectors(this._oldCamera.up,this._newCamera.up,t);var v=this._oldCamera.getWorldDirection(new r.Vector3);var C=this._newCamera.getWorldDirection(new r.Vector3);var w=(new r.Vector3).lerpVectors(v,C,t);i.lookAt(w.add(i.position));var g=a.getDomRef();a.getCamera().update(g.clientWidth,g.clientHeight);let y=true;if(t===1){y=false;this._newCamera=null;this._oldCamera=null;if(this._animationType==="zooming"&&this._zoomedNodeRef){a.fireNodeZoomed({zoomed:this._zoomedNodeRef,isZoomIn:this._isZoomIn})}a.cameraUpdateCompleted({position:i.position.toArray(),quaternion:i.quaternion.toArray()})}a.fireCameraChanged({position:i.position.toArray(),quaternion:i.quaternion.toArray()});return y};this.startCameraAnimation=function(e,t){this._startTimeForCameraAnimation=Date.now();this._timeIntervalForCameraAnimation=e!==undefined?e:500;this._transitionEffect=t;a.setShouldRenderFrame()};this.lookAtObject=function(e,t){if(e._vkGetNodeContentType()!==n.Background){this.prepareForCameraUpdateAnimation();var i=a.getCamera().getCameraRef();this._newCamera=i.clone();this._newCamera.lookAt(e.getWorldPosition(new r.Vector3));this._newCamera.up.set(0,1,0);this._newCamera.updateMatrixWorld();this.startCameraAnimation(t)}};this.zoomObject=function(e,t,i){if(a.getScene()==null){return}var o;if(t&&e){o=new r.Box3;e._expandBoundingBox(o,true,true)}else{o=a.getScene()._computeBoundingBox(true,true)}if(e&&(e._vkGetNodeContentType()===n.Background||e._vkGetNodeContentType()===n.Symbol)){o.setFromObject(e)}var s=e&&e._vkGetNodeContentType()===n.Symbol?10:0;this.zoomBox(o,s,i,e,t)};this.zoomBox=function(e,t,i,r,o){this._zoomedNodeRef=r;this._isZoomIn=o;this._animationType="zooming";this._newCamera=a.getCamera().getCameraRef().clone();this._newCamera._vkZoomTo(e,t);if(a.getBackgroundProjection()==="spherical"){this._newCamera.position.setScalar(0)}this.startCameraAnimation(i)};this.prepareForCameraUpdateAnimation=function(){this._oldCamera=a.getCamera().getCameraRef().clone()};this.startAnimatingCameraUpdate=function(e,t,i){var r=a.getCamera().getCameraRef();if(!this._oldCamera){return 0}var o=!!i;var n=1e-4;if(r.isOrthographicCamera&&this._oldCamera.isOrthographicCamera){if(Math.abs(r.left-this._oldCamera.left)>n||Math.abs(r.right-this._oldCamera.right)>n||Math.abs(r.top-this._oldCamera.top)>n||Math.abs(r.bottom-this._oldCamera.bottom)>n||Math.abs(r.zoom-this._oldCamera.zoom)>n){o=true}}else if(r.isPerspectiveCamera&&this._oldCamera.isPerspectiveCamera){if(Math.abs(r.fov-this._oldCamera.fov)>n||Math.abs(r.aspect-this._oldCamera.aspect)>n){o=true}}if(!o){if(Math.abs(r.position.x-this._oldCamera.position.x)>n||Math.abs(r.position.y-this._oldCamera.position.y)>n||Math.abs(r.position.z-this._oldCamera.position.z)>n||Math.abs(r.scale.x-this._oldCamera.scale.x)>n||Math.abs(r.scale.y-this._oldCamera.scale.y)>n||Math.abs(r.scale.z-this._oldCamera.scale.z)>n||Math.abs(r.quaternion.x-this._oldCamera.quaternion.x)>n||Math.abs(r.quaternion.y-this._oldCamera.quaternion.y)>n||Math.abs(r.quaternion.z-this._oldCamera.quaternion.z)>n||Math.abs(r.quaternion.w-this._oldCamera.quaternion.w)>n){o=true}}if(!o){if(!t){a.cameraUpdateCompleted({position:r.position.toArray(),quaternion:r.quaternion.toArray()});return 0}else{e=500}}this._newCamera=a.getCamera().getCameraRef().clone();this.startCameraAnimation(e,i);return e}};this._cameraController=new a(t)}});s.prototype._activateRedline=function(){var e=this._viewport.getCamera().getCameraRef();e.userData.isRedlineActivated=true;var t=this._viewport.getDomRef();e.setViewOffset(t.clientWidth,t.clientHeight,0,0,t.clientWidth,t.clientHeight)};s.prototype._deactivateRedline=function(){var e=this._viewport&&this._viewport.getCamera();if(e){var t=e.getCameraRef();t.userData.isRedlineActivated=false;t.clearViewOffset()}};s.prototype.destroy=function(){this._viewport=null;this._rect=null;this._evt=null;this._gesture=false};s.prototype._getOffset=function(e){var t=e.getBoundingClientRect();var a={x:t.left+window.pageXOffset,y:t.top+window.pageYOffset};return a};s.prototype._inside=function(e){var t=this._viewport.getIdForLabel();var a=document.getElementById(t);if(!a){return false}var i=this._getOffset(a);this._rect={x:i.x,y:i.y,w:a.offsetWidth,h:a.offsetHeight};return e.x>=this._rect.x&&e.x<=this._rect.x+this._rect.w&&e.y>=this._rect.y&&e.y<=this._rect.y+this._rect.h};s.prototype._onresize=function(e){this._gesture=false;this._rect=null};s.prototype.beginGesture=function(t){if(this._inside(t)&&!this._gesture){this._gesture=true;var a=t.x-this._rect.x,i=t.y-this._rect.y;this._evt.x=a;this._evt.y=i;this._evt.d=t.d;e.debug("Loco: beginGesture: "+a+", "+i);this._cameraController.beginGesture(a,i);t.handled=true;if(document.activeElement){try{document.activeElement.blur()}catch(e){}}var r=document.getElementById(this._viewport.getIdForLabel());r.focus()}this._nomenu=false};s.prototype.move=function(t){if(this._gesture){var a=t.x-this._rect.x,i=t.y-this._rect.y;const n=t.d;var r=a-this._evt.x;var o=i-this._evt.y;this._evt.x=a;this._evt.y=i;this._evt.d=n;switch(t.n){case 1:e.debug("Loco: Rotate: "+r+", "+o);this._cameraController.rotate(r,o);break;case 2:e.debug("Loco: Pan: "+r+", "+o);if(n!=0&&n!=1){e.debug("Loco: Zoom: "+n)}this._cameraController.pan(r,o);if(n!=0&&n!=1){this._cameraController.zoom(n)}break;default:break}this._nomenu=true;t.handled=true}};s.prototype.endGesture=function(t){if(this._gesture){var a=t.x-this._rect.x,i=t.y-this._rect.y;e.debug("Loco: endGesture: "+a+", "+i);this._cameraController.endGesture();this._gesture=false;t.handled=true}};s.prototype.click=function(t){if(this._inside(t)&&t.buttons<=1){var a=t.x-this._rect.x,i=t.y-this._rect.y;e.debug("Loco: click: "+a+", "+i);if(this._viewport){this._viewport.tap(a,i,false)}t.handled=true}};s.prototype.doubleClick=function(t){if(this._inside(t)&&t.buttons<=1){var a=t.x-this._rect.x,i=t.y-this._rect.y;e.debug("Loco: doubleClick: "+a+", "+i);if(this._viewport){this._viewport.tap(a,i,true)}t.handled=true}};s.prototype.contextMenu=function(e){if(this._inside(e)||this._nomenu||e.buttons===5){this._nomenu=false;e.handled=true}};s.prototype.keyEventHandler=function(e){};s.prototype.getViewport=function(){return this._viewport};s.prototype.activateCamera=function(e,t,r,o){var n=0;this._cameraController.prepareForCameraUpdateAnimation();const s=this._viewport;const h=s.getCamera();if(h.getCameraRef().isPerspectiveCamera!==e.isPerspectiveCamera){var l=e.isPerspectiveCamera?new a:new i;l.getCameraRef().copy(e);s.setCamera(l)}else{h.getCameraRef().copy(e);h.update(s._width,s._height);delete h._dummyCamera}if(t>0){n=this._cameraController.startAnimatingCameraUpdate(t,r,o)}else{s.cameraUpdateCompleted({position:e.position.toArray(),quaternion:e.quaternion.toArray()})}return n};s.prototype.setView=function(t,i){var o=this._viewport.getCamera().getCameraRef();if(o.userData.isRedlineActivated){e.error("setView() method is disabled when Redlining is activated");return this}this._cameraController.prepareForCameraUpdateAnimation();if(t){o.quaternion.copy(t);o.updateMatrixWorld();o.up.setFromMatrixColumn(o.matrixWorld,1).normalize();this._cameraController.zoomObject(null,false,i)}else{o.copy(this._viewport._homeCamera?this._viewport._homeCamera:(new a).getCameraRef());var n=this._viewport.getRenderer().getSize(new r.Vector2);this._viewport.getCamera().update(n.width,n.height);this._cameraController.startAnimatingCameraUpdate(i)}this._viewport.setShouldRenderFrame();return this};s.prototype.zoomTo=function(t,a,i,r,o,n){if(this._viewport._isPanoramicActivated()||this._viewport._isPlanarActivated()){e.error("zoomTo() method is disabled in navigation scene");return this}var s=this._viewport.getCamera().getCameraRef();this._cameraController.prepareForCameraUpdateAnimation();if(a){s.quaternion.copy(a);s.updateMatrixWorld();s.up.setFromMatrixColumn(s.matrixWorld,1).normalize()}this._cameraController.zoomBox(t,i,r,o,n);return this};s.prototype.zoomObject=function(e,t,a){if(this._viewport._isPanoramicActivated()){this._cameraController.lookAtObject(e,a)}else{this._cameraController.prepareForCameraUpdateAnimation();this._cameraController.zoomObject(e,t,a)}return this};s.prototype.animateCameraUpdate=function(){return this._cameraController.animateCameraUpdate()};s.prototype.prepareForCameraUpdateAnimation=function(){this._cameraController.prepareForCameraUpdateAnimation()};s.prototype.startAnimatingCameraUpdate=function(e){this._cameraController.startAnimatingCameraUpdate(e)};return s});
//# sourceMappingURL=ViewportGestureHandler.js.map