/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["sap/base/assert","../Core","../ViewStateManagerBase","../thirdparty/three","../cssColorToColor","../colorToCSSColor","../abgrToColor","../colorToABGR","./Scene","../ObjectType","../RotationType","./HighlightPlayer","../HighlightDisplayState","../Highlight","../AnimationTrackType","../AnimationTrackValueType","../AnimationMath","../NodeContentType","./ThreeUtils","sap/ui/base/DataType","../TransformationMatrix","sap/ui/core/Element"],function(t,e,i,r,n,a,o,s,l,u,c,h,f,d,p,y,g,v,_,m,A,S){"use strict";var w;class C{cloneMaterial(t,e){const i=t.clone();i.userData.prototypeMaterial=t;return i}releaseMaterial(t){_.disposeMaterial(t);return this}}var b=i.extend("sap.ui.vk.threejs.ViewStateManager",{metadata:{library:"sap.ui.vk"}});var N=b.getMetadata().getParent().getClass().prototype;b.prototype.init=function(){N.init?.call(this);this._nodeHierarchy=null;this._nodeStates=new Map;this._selectedNodes=new Set;this._needsMaterialUpdate=new Set;this._outlinedNodes=new Set;this.setOutlineColor("rgba(255, 0, 255, 1.0)");this.setOutlineWidth(1);this._materialCache=new C;this._showSelectionBoundingBox=true;this._visibilityTracker=new w;this._boundingBoxesScene=new r.Scene;this._selectedNodesBoundingBox=new r.Box3;this._boundingBoxColor=new r.Color(12632064);this.setHighlightColor("rgba(255, 0, 0, 1.0)");this._joints=[];this._highlightPlayer=new h;this._highlightPlayer.setViewStateManager(this);this._transitionPlayer=new h;this._transitionPlayer.setViewStateManager(this);e.getEventBus().subscribe("sap.ui.vk","activateView",this._onActivateView,this)};b.prototype._clearBoundingBoxScene=function(){var t=[];var e=[];_.getAllTHREENodes([this._boundingBoxesScene],t,e);t.forEach(function(t){_.disposeObject(t);t.parent.remove(t)});e.forEach(function(t){t.parent.remove(t)})};b.prototype._clearNodeStates=function(){var t=this._nodeStates;t.forEach(function(t,e){if(t.material!=null){_.disposeMaterial(t.material)}if(t.material2!=null){_.disposeMaterial(t.material2)}if(t.boundingBoxNode){_.disposeObject(t.boundingBoxNode)}},this);t.clear()};b.prototype.exit=function(){e.getEventBus().unsubscribe("sap.ui.vk","activateView",this._onActivateView,this);this._clearNodeStates();this._selectedNodes.clear();this._outlinedNodes.clear();if(this._boundingBoxesScene){this._clearBoundingBoxScene();this._boundingBoxesScene=null}this._nodeHierarchy=null;N.exit?.call(this)};b.prototype._setContent=function(t){if(t===this._scene){return this}var e=null;if(t&&t instanceof l){e=t}this._setScene(e);if(e){var i=e.getInitialView();if(i){this._currentView=i;this._resetNodesMaterialAndOpacityByCurrentView(this._currentView)}}return this};b.prototype._setScene=function(t){this._clearNodeStates();if(this._boundingBoxesScene){this._clearBoundingBoxScene()}this._boundingBoxesScene=new r.Scene;this._setNodeHierarchy(t?t.getDefaultNodeHierarchy():null);if(t){t.setViewStateManager(this)}this._scene=t;if(this._scene){var e=this._scene.getInitialView();if(e){this.activateView(e)}}return this};b.prototype._setNodeHierarchy=function(t){var e=this._nodeHierarchy;if(this._nodeHierarchy){this._nodeHierarchy.detachNodeReplaced(this._handleNodeReplaced,this);this._nodeHierarchy.detachNodeUpdated(this._handleNodeUpdated,this);this._nodeHierarchy.detachNodeRemoving(this._handleNodeRemoving,this);this._nodeHierarchy=null;this._clearNodeStates();this._selectedNodes.clear();this._outlinedNodes.clear();this._visibilityTracker.clear()}if(t){this._nodeHierarchy=t;this._nodeHierarchy.attachNodeReplaced(this._handleNodeReplaced,this);this._nodeHierarchy.attachNodeUpdated(this._handleNodeUpdated,this);this._nodeHierarchy.attachNodeRemoving(this._handleNodeRemoving,this);const e=[];const i=[];t.getSceneRef().traverse(function(t){(t.visible?e:i).push(t)});this.fireVisibilityChanged({visible:e,hidden:i})}if(t!==e){this.fireNodeHierarchyReplaced({oldNodeHierarchy:e,newNodeHierarchy:t})}return this};b.prototype._getJointByChildNode=function(t){var e;if(this._jointCollection){for(var i=0;i<this._jointCollection.length;i++){if(this._jointCollection[i].node===t){e=this._jointCollection[i];break}}}return e};b.prototype._handleNodeReplaced=function(t){var e=t.getParameter("ReplacedNodeRef");var i=t.getParameter("ReplacementNodeRef");if(this.getSelectionState(e)){this.setSelectionStates(i,e)}};b.prototype._handleNodeUpdated=function(t){var e=t.getParameter("nodeRef");if(this.getSelectionState(e)){this.setSelectionStates([],e);this.setSelectionStates(e,[])}};b.prototype._handleNodeRemoving=function(t){var e=t.getParameter("nodeRef");if(this._jointCollection){for(var i=0;i<this._jointCollection.length;i++){if(this._jointCollection[i].node===e){this._jointCollection[i].node=null;break}if(this._jointCollection[i].parent===e){this._jointCollection[i].parent=null;break}}}if(this.getSelectionState(e)){this.setSelectionStates([],e,true,true)}};b.prototype.getNodeHierarchy=function(){return this._nodeHierarchy};b.prototype.getVisibilityChanges=function(){return this.getShouldTrackVisibilityChanges()?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null};b.prototype.getCurrentView=function(){var t=S.getElementById(this.getViewManager());if(!t){return null}var e=t.getActiveView();return e};b.prototype.resetNodeProperty=function(t,e){const i=this.getCurrentView()?.getNodeInfos();if(i){var n=[];n.push(t);if(this._jointCollection&&this._jointCollection.length>0){for(var a=0;a<this._jointCollection.length;a++){var o=this._jointCollection[a];if(!o.node||!o.parent){continue}var s=o.parent;if(s!==t){break}n.push(o.node)}}i.forEach(function(a){if(!n.includes(a.target)){return}if(!e||e!==p.Opacity){var o={nodeRefs:[],positions:[]};var s;var l;var u;if(a.transform){var c=new r.Vector3;var h=new r.Quaternion;var f=new r.Vector3;var d=R(a.transform);d.decompose(c,h,f);s=c.toArray();l=h.toArray();u=f.toArray()}else if(a[p.Scale]&&a[p.Rotate]&&a[p.Translate]){s=a[p.Translate].slice();l=a[p.Rotate].slice();u=a[p.Scale].slice()}if(s){o.nodeRefs.push(a.target);o.positions.push({translation:s,quaternion:l,scale:u});this.setTransformation(o.nodeRefs,o.positions)}}else{this.setOpacity(t,a.opacity);var y={changed:t,opacity:i.opacity};this.fireOpacityChanged(y)}},this)}};b.prototype.getVisibilityComplete=function(){var t=this.getNodeHierarchy(),e=t.findNodesByName(),i=[],r=[];e.forEach(function(e){var n=t.createNodeProxy(e);var a=n.getVeId();t.destroyNodeProxy(n);if(a){if(this.getVisibilityState(e)){i.push(a)}else{r.push(a)}}},this);return{visible:i,hidden:r}};b.prototype.resetVisibility=function(){const t=[];const e=[];this._nodeStates.forEach(function(i,r){const n=i.visible;if(n===true){e.push(r)}else if(n===false){t.push(r)}i.visible=null});this._deleteUnusedNodeStates();this._visibilityTracker.clear();this.fireVisibilityChanged({visible:t,hidden:e});return this};b.prototype.getVisibilityState=function(t){if(Array.isArray(t)){return t.map(t=>E(t,this._nodeStates.get(t)))}else{return E(t,this._nodeStates.get(t))}};b.prototype.setVisibilityState=function(t,e,i,r){if(!Array.isArray(t)){t=[t]}var n=Array.isArray(e);var a=[];var o=t;if(i){o=[];t.forEach(function(t,i){var r=this._collectNodesRecursively(t);o=o.concat(r);var s=a.length;a.length+=r.length;a.fill(n?e[i]:e,s)},this)}else if(!n){a.length=o.length;a.fill(e)}else{a=e}if(r){var s=[];o.forEach(function(t,e){var i=a[e];if(i){for(var r=t;r&&!r.isScene;r=r.parent){s.push(r)}}});o=o.concat(s);var l=a.length;a.length+=s.length;a.fill(true,l)}var u=[];var c=new Set;var h=o.filter(function(t,e){if(t==null||t.userData.skipIt||c.has(t)){return false}c.add(t);const i=this._nodeStates.get(t);var r=E(t,i);var n=a[e];var o=r!==n;if(o){u.push(n)}return o},this);if(h.length>0){this._applyVisibilityNodeState(h,u);this._deleteUnusedNodeStates();var f={visible:[],hidden:[]};h.forEach(function(t,e){f[u[e]?"visible":"hidden"].push(t)});if(this.getShouldTrackVisibilityChanges()){h.forEach(this._visibilityTracker.trackNodeRef,this._visibilityTracker)}this.fireVisibilityChanged(f)}return this};b.prototype.enumerateSelection=function(t){this._selectedNodes.forEach(t);return this};b.prototype.enumerateOutlinedNodes=function(t){this._outlinedNodes.forEach(t);return this};b.prototype.getSelectionState=function(t){const e=this._selectedNodes.has.bind(this._selectedNodes);return Array.isArray(t)?t.map(e):e(t)};b.prototype._getSelectionComplete=function(){var t=this.getNodeHierarchy(),e=[],i=[];function r(e){var i=t.createNodeProxy(e);var r=i.getVeId();t.destroyNodeProxy(i);return r}this._selectedNodes.forEach(function(t){var i=r(t);if(i){e.push(i)}});this._outlinedNodes.forEach(function(t){var e=r(t);if(e){i.push(e)}});return{selected:e,outlined:i}};b.prototype._addBoundingBox=function(t){t._vkCalculateObjectOrientedBoundingBox()};b.prototype._removeBoundingBox=function(t){delete t.userData.boundingBox};b.prototype._expandBoundingBoxWithSelected=function(t){if(!this._selectedNodesBoundingBox.isEmpty()){t.union(this._selectedNodesBoundingBox)}};b.prototype._updateBoundingBoxes=function(){var t;var e=new r.Vector3;var i=new r.Vector3;var n=new r.Quaternion;var a=new r.Matrix4;var o,s;this._selectedNodesBoundingBox.makeEmpty();var l=null;var u=this._selectedNodes.size;if(u>0){l=new Float32Array(u*16);u=0;this._selectedNodes.forEach(function(r){r._vkCalculateObjectOrientedBoundingBox();t=r.userData.boundingBox;if(t&&!t.isEmpty()){t.getCenter(e);t.getSize(i);i.multiplyScalar(.5);a.compose(e,n,i);a.premultiply(r.matrixWorld);s=a.elements;for(o=0;o<16;++o){l[u++]=s[o]}for(o=0;o<8;++o){e.x=(o&1)>0?1:-1;e.y=(o&2)>0?1:-1;e.z=(o&4)>0?1:-1;e.applyMatrix4(a);this._selectedNodesBoundingBox.expandByPoint(e)}}},this);if(u!==l.length){l=l.slice(0,u)}}var c=this._boundingBoxesScene.children.length>0?this._boundingBoxesScene.children[0]:null;var h=false;var f=false;if(u>0){if(!c){f=true}else{var d=c.geometry.attributes.itm;if(u===d.array.length){s=d.array;for(o=0;o<u;++o){if(l[o]!==s[o]){d.set(l);d.version++;break}}}else{h=true;f=true}}}else if(c){h=true}var p=null;if(h){if(f){p=c.material}this._boundingBoxesScene.remove(c);_.disposeObject(c);c=null}if(f){if(!p){p=new r.LineBasicMaterial({color:this._boundingBoxColor,onBeforeCompile:function(t){t.vertexShader=("attribute mat4 itm;\n"+t.vertexShader).replace("#include <begin_vertex>","#include <begin_vertex>\ntransformed = (itm * vec4(transformed, 1.0)).xyz;\n")}})}var y=new r.InstancedBufferGeometry;y.setIndex(new r.BufferAttribute(new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),1));y.setAttribute("position",new r.Float32BufferAttribute([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3));y.setAttribute("itm",new r.InstancedBufferAttribute(l,16));c=new r.LineSegments(y,p);c.frustumCulled=false;this._boundingBoxesScene.add(c)}};b.prototype.setShowSelectionBoundingBox=function(t){this._showSelectionBoundingBox=t;this._selectedNodes.forEach(t?this._addBoundingBox:this._removeBoundingBox,this)};b.prototype.getShowSelectionBoundingBox=function(){return this._showSelectionBoundingBox};b.prototype.setSelectionState=function(t,e,i,r){if(!Array.isArray(t)){t=[t]}t=(i||this.getRecursiveSelection()?this._collectNodesRecursively(t):t).filter(function(t,e,i){return i.indexOf(t)===e});if(this.getRecursiveSelection()&&!e){t=this._nodeHierarchy._appendAncestors(t)}const n=this._selectedNodes;const a=t.filter(t=>n.has(t)!==e);if(a.length>0){this._applySelectionNodeState(a,e);if(!e){this._deleteUnusedNodeStates()}if(!r){this.fireSelectionChanged({selected:e?a:[],unselected:e?[]:a})}}return this};b.prototype.setSelectionStates=function(t,e,i,r){if(!Array.isArray(t)){t=[t]}if(!Array.isArray(e)){e=[e]}t=i||this.getRecursiveSelection()?this._collectNodesRecursively(t):t;e=i||this.getRecursiveSelection()?this._collectNodesRecursively(e):e;if(this.getRecursiveSelection()){e=this._nodeHierarchy._appendAncestors(e,t)}var n=t.filter(function(t){return this._selectedNodes.has(t)===false},this);var a=e.filter(function(t){return this._selectedNodes.has(t)===true},this);if(n.length>0||a.length>0){this._applySelectionNodeState(n,true);this._applySelectionNodeState(a,false);if(a.length>0){this._deleteUnusedNodeStates()}if(!r){this.fireSelectionChanged({selected:n,unselected:a})}}return this};b.prototype.setOutlineColor=function(t){switch(typeof t){case"number":this._outlineColorABGR=t;break;case"string":const e=m.getType("sap.ui.core.CSSColor");if(e.isValid(t)){this._outlineColorABGR=s(n(t))}break;default:return this}this.fireOutlineColorChanged({outlineColor:a(o(this._outlineColorABGR)),outlineColorABGR:this._outlineColorABGR});return this};b.prototype.getOutlineColor=function(t){return t?this._outlineColorABGR:a(o(this._outlineColorABGR))};b.prototype.getOutliningState=function(t){var e=this._outlinedNodes;function i(t){return e.has(t)}return Array.isArray(t)?t.map(i):i(t)};b.prototype.setOutliningStates=function(t,e,i,r){if(!Array.isArray(t)){t=[t]}if(!Array.isArray(e)){e=[e]}t=i||this.getRecursiveOutlining()?this._collectNodesRecursively(t):t;e=i||this.getRecursiveOutlining()?this._collectNodesRecursively(e):e;if(this.getRecursiveOutlining()){e=this._nodeHierarchy._appendAncestors(e,t)}var n=t.filter(function(t){return this._outlinedNodes.has(t)===false},this);var a=e.filter(function(t){return this._outlinedNodes.has(t)===true},this);if(n.length>0||a.length>0){n.forEach(function(t){this._outlinedNodes.add(t)},this);a.forEach(function(t){this._outlinedNodes.delete(t)},this);if(!r){this.fireOutliningChanged({outlined:n,unoutlined:a})}}return this};b.prototype.setOutlineWidth=function(t){this._outlineWidth=t;this.fireOutlineWidthChanged({width:t});return this};b.prototype.getOutlineWidth=function(){return this._outlineWidth};b.prototype._collectNodesRecursively=function(t){var e=[];var i=this._nodeHierarchy;(Array.isArray(t)?t:[t]).forEach(function t(r){e.push(r);i.enumerateChildren(r,t,false,true)});return e};b.prototype._getOpacity=function(t){const e=this._nodeStates.get(t);return e?.opacity??null};b.prototype.getOpacity=function(t){if(Array.isArray(t)){return t.map(this._getOpacity,this)}else{return this._getOpacity(t)}};b.prototype.setOpacity=function(t,e,i){if(!Array.isArray(t)){t=[t]}var r=Array.isArray(e);var n=[];var a=t;if(i){a=[];t.forEach(function(t,i){var o=this._collectNodesRecursively(t);a=a.concat(o);var s=n.length;n.length+=o.length;n.fill(r?e[i]:e,s)},this)}else if(!r){n.length=a.length;n.fill(e)}else{n=e}var o=[];var s=new Set;var l=a.filter(function(t,e){if(s.has(t)){return false}s.add(t);const i=this._nodeStates.get(t);var r=n[e];var a=i==null&&r!=null||i!=null&&i.opacity!==r;if(a){o.push(r)}return a},this);if(l.length>0){this._applyOpacityNodeState(l,o);this._deleteUnusedNodeStates();var u={changed:l,opacity:r?o:o[0]};this.fireOpacityChanged(u)}return this};b.prototype._getTintColorABGR=function(t){const e=this._nodeStates.get(t);return e?.tintColor};b.prototype._getTintColor=function(t){const e=this._getTintColorABGR(t);return e!=null?a(o(e)):null};b.prototype.getTintColor=function(t,e){var i=e?this._getTintColorABGR:this._getTintColor;if(Array.isArray(t)){return t.map(i,this)}else{return i.call(this,t)}};function x(t){switch(typeof t){case"number":return t;case"string":const e=m.getType("sap.ui.core.CSSColor");return e.isValid(t)?s(n(t)):null;default:return null}}b.prototype.setTintColor=function(t,e,i){if(!Array.isArray(t)){t=[t]}var r=Array.isArray(e);var n=[];var a=t;if(i){a=[];t.forEach(function(t,i){var o=this._collectNodesRecursively(t);a=a.concat(o);var s=n.length;n.length+=o.length;n.fill(r?e[i]:e,s)},this)}else if(!r){n.length=a.length;n.fill(e)}else{n=e}var o=[];var s=[];var l=new Set;var u=a.filter(function(t,e){if(l.has(t)){return false}l.add(t);const i=this._nodeStates.get(t);var r=n[e];var a=x(n[e]);var u=i==null&&r!=null||i!=null&&i.tintColor!==a;if(u){o.push(r);s.push(a)}return u},this);if(u.length>0){this._applyTintColorNodeState(u,s);this._deleteUnusedNodeStates();var c={changed:u,tintColor:r?o:o[0],tintColorABGR:r?s:s[0]};this.fireTintColorChanged(c)}return this};b.prototype.setNodesHighlightColor=function(t,e,i){if(!Array.isArray(t)){t=[t]}const r=i?this._collectNodesRecursively(t):t;const n=Array.from(new Set(r));if(n.length>0){n.forEach(function(t){const i=this._getNodeState(t,e!=null);if(i!=null){i.highlightColor=e;this._setNeedsMaterialUpdate(t);t.children.forEach(this._setAncestorHighlightColorRecursively.bind(this,e!=null?e:i.ancestorHighlightColor),this)}},this);this._deleteUnusedNodeStates()}return this};b.prototype.setHighlightColor=function(t){switch(typeof t){case"number":this._highlightColorABGR=t;break;case"string":const e=m.getType("sap.ui.core.CSSColor");if(e.isValid(t)){this._highlightColorABGR=s(n(t))}break;default:return this}if(this._selectedNodes.size>0){this._nodeStates.forEach(function(t,e){if(t.selected||t.ancestorSelected){this._setNeedsMaterialUpdate(e)}},this)}this.fireHighlightColorChanged({highlightColor:a(o(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this};b.prototype.getHighlightColor=function(t){return t?this._highlightColorABGR:a(o(this._highlightColorABGR))};b.prototype.getRestTransformationUsingJoint=function(t){var e=this._getJointByChildNode(t);if(e&&e.translation&&e.scale&&e.quaternion){return e}else{return this.getRestTransformation(t)}};b.prototype.getRelativeTransformation=function(t){var e=function(t){var e=this.getRestTransformation(t);var i=[t.position.x-e.translation[0],t.position.y-e.translation[1],t.position.z-e.translation[2]];var n=(new r.Quaternion).fromArray(e.quaternion).invert().premultiply(t.quaternion).toArray();var a=[t.scale.x/e.scale[0],t.scale.y/e.scale[1],t.scale.z/e.scale[2]];return{translation:i,quaternion:n,scale:a}}.bind(this);if(!Array.isArray(t)){return e(t)}var i=[];t.forEach(function(t){i.push(e(t))});return i};b.prototype.getTransformationWorld=function(t){var e=function(t){var e=new r.Vector3;var i=new r.Vector3;var n=new r.Quaternion;t.updateMatrixWorld();t.matrixWorld.decompose(e,n,i);return{translation:e.toArray(),quaternion:n.toArray(),scale:i.toArray()}};if(!Array.isArray(t)){return e(t)}var i=[];t.forEach(function(t){i.push(e(t))});return i};b.prototype.getTransformation=function(t){var e=function(t){return{translation:this.getTranslation(t),quaternion:this.getRotation(t,c.Quaternion),scale:this.getScale(t)}}.bind(this);if(!Array.isArray(t)){return e(t)}var i=[];t.forEach(function(t){i.push(e(t))});return i};b.prototype.getTranslation=function(t){var e=function(t){return t.position.toArray()};if(!Array.isArray(t)){return e(t)}var i=[];t.forEach(function(t){i.push(e(t))});return i};b.prototype.getScale=function(t){var e=function(t){return t.scale.toArray()};if(!Array.isArray(t)){return e(t)}var i=[];t.forEach(function(t){i.push(e(t))});return i};b.prototype._convertQuaternionToAngleAxis=function(t){if(t.w>1){t.normalize()}if(t.w>.9999&&t.x<1e-4&&t.y<1e-4&&t.z<1e-4){t.w=1;t.x=0;t.y=0;t.z=0}var e=2*Math.acos(t.w);var i;var r;var n;var a=Math.sqrt(1-t.w*t.w);if(a<1e-4){i=1;r=0;n=0}else{i=t.x/a;r=t.y/a;n=t.z/a}return[i,r,n,e]};b.prototype.getRotation=function(t,e){var i=function(t){var i=t.quaternion;var n;switch(e){case c.AngleAxis:n=this._convertQuaternionToAngleAxis(i);break;case c.Euler:var a=new r.Euler;a.setFromQuaternion(i);n=a.toArray();break;default:n=i.toArray()}return n};if(!Array.isArray(t)){return i(t)}var n=[];t.forEach(function(t){n.push(i(t))});return n};b.prototype.setTransformation=function(t,e){var i=Array.isArray(t);if(!Array.isArray(t)){t=[t]}var n={changed:[],transformation:[]};var a=function(t){return{position:t.position.toArray(),quaternion:t.quaternion.toArray(),scale:t.scale.toArray()}};if(!e){t.forEach(function(t){if(t.userData.position&&t.userData.quaternion&&t.userData.scale){t.position=t.userData.position;t.quaternion=t.userData.quaternion;t.scale=t.userData.scale;t.updateMatrix();delete t.userData.position;delete t.userData.quaternion;delete t.userData.scale}n.changed.push(t);n.transformation.push(a(t))},this)}else{if(!Array.isArray(e)){e=[e]}t.forEach(function(t,i){var o=t.userData;if(!o){return}if(!o.position){o.position=t.position.clone()}if(!o.quaternion){o.quaternion=t.quaternion.clone()}if(!o.scale){o.scale=t.scale.clone()}var s=e[i];if(s.transform){var l=R(s.transform);l.decompose(t.position,t.quaternion,t.scale)}else{t.position.fromArray(s.translation);t.scale.fromArray(s.scale);if(s.quaternion){t.quaternion.fromArray(s.quaternion)}else if(s.angleAxis){var u=new r.Vector3(s.angleAxis[0],s.angleAxis[1],s.angleAxis[2]);t.quaternion.setFromAxisAngle(u,s.angleAxis[3])}else if(s.euler){var c=new r.Euler;c.fromArray(s.euler[0],s.euler[1],s.euler[2],s.euler[3]);t.quaternion.setFromEuler(c)}}t.updateMatrix();n.changed.push(t);n.transformation.push(a(t))},this)}if(!i){n.changed=n.changed[0];n.transformation=n.transformation[0]}this.fireTransformationChanged(n);return this};b.prototype.getJoints=function(){return this._jointCollection};b.prototype.setJoints=function(t,e){this._jointCollection=[];this._playbackAssociatedWithJoints=null;if(!t){return this}var i=new Set;var r=new Map;t.forEach(function(t){if(!t.node||!t.parent){return}i.add(t.node);r.set(t.node,t)});while(i.size>0){var n=i.values().next().value;i.delete(n);var a=r.get(n);var o=[a];var s=[];var l=a.parent;while(l){a=r.get(l);if(a!==undefined){if(i.delete(l)){o.push(a)}if(s.length>0){a.nodesToUpdate=a.nodesToUpdate||[];while(s.length>0){var u=s.pop();if(a.nodesToUpdate.indexOf(u)>=0){break}a.nodesToUpdate.push(u)}}s.length=0;l=a.parent}else{s.push(l);l=l.parent}}while(o.length>0){this._jointCollection.push(o.pop())}}if(this._jointCollection&&this._jointCollection.length>0){this._playbackAssociatedWithJoints=e;this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}t.translation=null;t.scale=null;t.quaternion=null;t.opacity=null;if(t.node.userData){t.node.userData.offsetTranslation=null;t.node.userData.offsetQuaternion=null;t.node.userData.offsetScale=null;t.node.userData.originalRotationType=null;t.node.userData.offsetOpacity=null}});this._jointCollection.forEach(function(t){this._updateJointNode(t,this._playbackAssociatedWithJoints)}.bind(this))}return this};b.prototype._updateJointNode=function(t,e){if(!t.node||!t.parent){return}if(t.translation&&t.quaternion&&t.scale&&t.opacity){return}var i=new Map;if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}i.set(t.node,t)})}var n,a,o,s,l,u;var c=t.node;var h=new r.Matrix4;var f,d=1;while(c){u=this.getRestOpacity(c);l=this.getRestTransformation(c);if(!l){c=c.parent;continue}n=new r.Vector3(l.translation[0],l.translation[1],l.translation[2]);a=new r.Vector3(l.scale[0],l.scale[1],l.scale[2]);o=new r.Quaternion(l.quaternion[0],l.quaternion[1],l.quaternion[2],l.quaternion[3]);f=u;if(e){var y=this._getEndPropertyInPreviousPlayback(c,p.Translate,e,true);if(y){n.x+=y[0];n.y+=y[1];n.z+=y[2]}var g=this._getEndPropertyInPreviousPlayback(c,p.Scale,e,true);if(g){a.x*=g[0];a.y*=g[1];a.z*=g[2]}var v=this._getEndPropertyInPreviousPlayback(c,p.Rotate,e,true);if(v){var _=new r.Quaternion(v[0],v[1],v[2],v[3]);o=_.multiply(o)}var m=this._getEndPropertyInPreviousPlayback(c,p.Opacity,e,true);if(m!=null){f*=m}}s=(new r.Matrix4).compose(n,o,a);h.premultiply(s);d*=f;c=c.parent}var A=t.parent;var S=new r.Matrix4;var w=1;while(A){var C=i.get(A);if(C){if(!C.translation){this._updateJointNode(C)}n=new r.Vector3(C.translation[0],C.translation[1],C.translation[2]);a=new r.Vector3(C.scale[0],C.scale[1],C.scale[2]);o=new r.Quaternion(C.quaternion[0],C.quaternion[1],C.quaternion[2],C.quaternion[3]);f=C.opacity;A=C.parent}else{u=this.getRestOpacity(A);l=this.getRestTransformation(A);if(!l){A=A.parent;continue}n=new r.Vector3(l.translation[0],l.translation[1],l.translation[2]);a=new r.Vector3(l.scale[0],l.scale[1],l.scale[2]);o=new r.Quaternion(l.quaternion[0],l.quaternion[1],l.quaternion[2],l.quaternion[3]);f=u;if(e){var b=this._getEndPropertyInPreviousPlayback(A,p.Translate,e,true);if(b){n.x+=b[0];n.y+=b[1];n.z+=b[2]}var N=this._getEndPropertyInPreviousPlayback(A,p.Scale,e,true);if(N){a.x*=N[0];a.y*=N[1];a.z*=N[2]}var x=this._getEndPropertyInPreviousPlayback(A,p.Rotate,e,true);if(x){var T=new r.Quaternion(x[0],x[1],x[2],x[3]);o=T.multiply(o)}var R=this._getEndPropertyInPreviousPlayback(A,p.Opacity,e,true);if(R!=null){f*=R}}A=A.parent}s=(new r.Matrix4).compose(n,o,a);S.premultiply(s);w*=f}var V=S.copy(S).invert().multiply(h);V.decompose(n,o,a);t.translation=n.toArray();t.quaternion=o.toArray();t.scale=a.toArray();var k=function(t,e){if(t===e){return 1}else if(Math.abs(e)<1e-4){return 1}return t/e};t.opacity=k(d,w)};b.prototype._propagateOpacityToJointChildren=function(t,e){if(!t||!e||t.length!==e.length){return this}if(!this._jointCollection||!this._jointCollection.length){return this}var i=new Map;this._jointCollection.forEach(function(t){var e=i.get(t.parent);if(!e){e=[];i.set(t.parent,e)}e.push(t)});const r=this;var n=function(t,e){if(t.opacity!=null&&t.node){let i=t.opacity*e;if(t.node.userData.offsetOpacity!=null){i*=t.node.userData.offsetOpacity}r.setOpacity(t.node,i)}};t.forEach(function(t,r){var a=i.get(t);if(a){a.forEach(function(t){n(t,e[r])})}});return this};b.prototype.getSymbolNodes=function(t){var e=this.getCurrentView()||this._scene.getViews()[0];var i=e?e.getNodeInfos().reduce(function(e,i){if(i.target._vkGetNodeContentType()===v.Symbol&&i.target.parent){if(!t||t===i.target.userData.treeNode.sid){e.push(i.target)}}return e},[]):[];return i};var T={sphere:"360Image",plane:"2DImage"};b.prototype._getBackgroundNodeInfos=function(){var t=null,e=[];const i=e=>{if(this.getVisibilityState(e)){if(e._vkGetNodeContentType()===v.Background&&T[e.name]){t=e;return}var r=e.children;for(var n=0,a=r.length;n<a&&t===null;n++){i(r[n])}}};i(this._scene.getSceneRef());if(t){e=t.parent.children.filter(function(t){return t._vkGetNodeContentType()===v.Background})}return{current:t,all:e}};b.prototype.getBackgroundImageType=function(){var t=this._getBackgroundNodeInfos().current;return t?T[t.name]:null};b.prototype.setBackgroundImageType=function(t){var e=this._getBackgroundNodeInfos();var i=e.all.find(function(e){return t===T[e.name]});if(i&&!this.getVisibilityState(i)){if(e.current){this.setVisibilityState(e.current,false,false)}this.setVisibilityState(e.all,false,false);this.setVisibilityState(i,true,false)}return i};function R(t){var e=new r.Matrix4;if(t.length===3){e.setPosition((new r.Vector3).fromArray(t))}else if(t.length===12){e.fromArray(A.convertTo4x4(t))}else if(t.length===16){e.fromArray(t.slice())}else{throw"Invalid matrix format"}return e}b.prototype._resetNodesStatusByCurrentView=function(t,e){var i=this.getNodeHierarchy();if(i){var n=t.getNodeInfos();if(n){var a={nodeRefs:[],positions:[]};var o=new r.Vector3;var s=new r.Quaternion;var l=new r.Vector3;for(const t of n){if(t.target===null){return}if(t.transform){var u=R(t.transform);if(!g.equalMatrices(u,t.target.matrix,1e-6)){u.decompose(o,s,l);a.nodeRefs.push(t.target);a.positions.push({translation:o.toArray(),quaternion:s.toArray(),scale:l.toArray()})}}else if(t[p.Scale]&&t[p.Rotate]&&t[p.Translate]){a.nodeRefs.push(t.target);a.positions.push({translation:t[p.Translate].slice(),quaternion:t[p.Rotate].slice(),scale:t[p.Scale].slice()})}}if(t.userData&&t.userData.nodeStartDataByAnimation){t.userData.nodeStartDataByAnimation.forEach(function(t,e){if(t[p.Translate]&&t[p.Rotate]&&t[p.Scale]){a.nodeRefs.push(e);a.positions.push({translation:t[p.Translate].slice(),quaternion:t[p.Rotate].slice(),scale:t[p.Scale].slice()})}},this)}if(a.nodeRefs.length){this.setTransformation(a.nodeRefs,a.positions)}if(e){var c=[];var h=[];n.forEach(function(t){if(!t.target.userData.skipIt){(t.visible?c:h).push(t.target)}});this.setVisibilityState(i.getChildren()[0].children,false,true);if(this.getSymbolNodes().length){this.getSymbolNodes().forEach(function(t){t.traverse(function(t){t.visible=true})})}this.setVisibilityState(c,true,false);this.setVisibilityState(h,false,false)}}}};b.prototype._resetNodesMaterialAndOpacityByCurrentView=function(t){t?.getNodeInfos()?.forEach(function(t){if(t.target){this.setOpacity(t.target,t.opacity)}},this)};b.prototype._onActivateView=function(t,e,i){var r=this.getViewManager();if(!r||i.source.getId()!==r){return}this.activateView(i.view,false,i.playViewGroup,i.skipCameraTransitionAnimation)};b.prototype.activateView=function(t,i,r,n){this.fireViewStateApplying({view:t});this.setJoints(undefined);this._resetNodesMaterialAndOpacityByCurrentView(t);this._prepareTransition(t);this._resetNodesStatusByCurrentView(t,true);this._highlightPlayer.reset(t,this._scene);this.fireViewStateApplied({view:t,ignoreAnimationPosition:i,skipCameraTransitionAnimation:n,playViewGroup:r});e.getEventBus().publish("sap.ui.vk","viewStateApplied",{source:this,view:t,ignoreAnimationPosition:i,skipCameraTransitionAnimation:n,playViewGroup:r});return this};b.prototype.setHighlightDisplayState=function(t){if(t===f.playing){this._highlightPlayer.start(Date.now())}else if(t===f.stopped){this._highlightPlayer.stop()}else if(t===f.pausing){this._highlightPlayer.pause(Date.now())}this.fireHighlightColorChanged({highlightColor:a(o(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this};b.prototype._startHighlight=function(){this._highlightPlayer.start(Date.now());return this};b.prototype._playHighlight=function(){return this._highlightPlayer.play(Date.now())};b.prototype._prepareTransition=function(t){this._transitionPlayer.reset();this._transitionPlayer.fadeInNodes=[];this._transitionPlayer.fadeOutNodes=[];this._fadeInBackground=null;this._fadeOutBackground=null;var e=t.getNodeInfos();if(!e){return}var i=new Set;var r=new Set;e.forEach(function(t){(t.visible?i:r).add(t.target)});var n=this._transitionPlayer.fadeInNodes;var a=this._transitionPlayer.fadeOutNodes;var o=this._nodeHierarchy;var s=function(t,e,r){if(!t.userData.skipIt){e=e&&i.has(t);r=r&&this.getVisibilityState(t)}if(t.geometry&&e!==r){if(t.parent&&t.parent.userData.symbolContent){t.renderOrder=2}(e?n:a).push(t)}if(t._vkGetNodeContentType()===v.Background){if(e){this._fadeInBackground=t}else if(r){this._fadeOutBackground=t}}t.children.forEach(function(t){s(t,e,r)})}.bind(this);o.getChildren()[0].children.forEach(function(t){s(t,true,true)});if(this._fadeInBackground){this._fadeInBackground.traverse(function(t){if(t.material){t.renderOrder=-2}})}if(this._fadeOutBackground){this._fadeOutBackground.traverse(function(t){if(t.material){t.renderOrder=1}})}};b.prototype._startTransition=function(t){var e=this._transitionPlayer.fadeInNodes;var i=this._transitionPlayer.fadeOutNodes;if(e&&e.length){var r=new d("FadeIn",{duration:t/500,opacities:[1,0],cycles:.5,type:"FadeIn"});this._transitionPlayer.addHighlights(r,e)}if(i&&i.length){var n=new d("FadeOut",{duration:t/500,opacities:[0,1],cycles:.5,type:"FadeOut"});this._transitionPlayer.addHighlights(n,i)}if(e&&e.length||i&&i.length){this._transitionPlayer.start(Date.now());this._transitionPlayer.play(Date.now());return t}return 0};b.prototype._playTransition=function(){return this._transitionPlayer.play(Date.now())};b.prototype.updateNodesRestTransformation=function(t){for(var e=0;e<t.length;e++){this.updateRestTransformation(t[e],true);if(this._playbackAssociatedWithJoints&&e===t.length-1){var i=this._playbackAssociatedWithJoints.getSequence();if(i){i._fireSequenceChanged()}}}return this};b.prototype.updateRestTransformation=function(t,e){var i=this.getCurrentView();if(!i){return this}i.getNodeInfos()?.forEach(function(e){if(e.target===t){t.updateMatrix();e.transform=t.matrix.elements.slice()}});if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.parent===t||e.node===t){e.translation=null;e.scale=null;e.quaternion=null;if(e.node.userData){e.node.userData.offsetTranslation=null;e.node.userData.offsetQuaternion=null;e.node.userData.offsetScale=null;e.node.userData.originalRotationType=null}}});this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.parent===t){this._updateJointNode(e,this._playbackAssociatedWithJoints);this.restoreRestTransformation(e.node)}}.bind(this));this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.node===t){this._updateJointNode(e,this._playbackAssociatedWithJoints)}},this);if(this._playbackAssociatedWithJoints&&!e){var r=this._playbackAssociatedWithJoints.getSequence();if(r){r._fireSequenceChanged()}}}return this};b.prototype.restoreRestTransformation=function(t){var e=this.getCurrentView();if(!e){return this}var i=e.getNodeInfos();if(i){i.forEach(function(e){if(e.target!==t){return}if(e.transform){var i=R(e.transform);i.decompose(t.position,t.quaternion,t.scale)}else if(e[p.Scale]&&e[p.Rotate]&&e[p.Translate]){t.position.set(e[p.Translate][0],e[p.Translate][1],e[p.Translate][2]);t.quaternion.set(e[p.Rotate][0],e[p.Rotate][1],e[p.Rotate][2],e[p.Rotate][3]);t.scale.set(e[p.Scale][0],e[p.Scale][1],e[p.Scale][2])}t.updateMatrix()})}var r={changed:[t],transformation:[{position:t.position.toArray(),quaternion:t.quaternion.toArray(),scale:t.scale.toArray()}]};this.fireTransformationChanged(r);return this};b.prototype.setRestTransformation=function(t,e,i,n){var a=this.getCurrentView();if(!a){return this}var o=a.getNodeInfos();if(o){o.forEach(function(a){if(a.target!==t){return}if(!e||!i||!n){if(a.transform){var o=new r.Vector3;var s=new r.Quaternion;var l=new r.Vector3;var u=R(a.transform);u.decompose(o,s,l);if(!e){e=[o.x,o.y,o.z]}if(!n){n=[l.x,l.y,l.z]}if(!i){i=[s.x,s.y,s.z,s.w]}}else if(a[p.Scale]&&a[p.Rotate]&&a[p.Translate]){if(!e){e=a[p.Translate].slice()}if(!n){n=a[p.Scale].slice()}if(!i){i=a[p.Rotate].slice()}}}var c=new r.Vector3(e[0],e[1],e[2]);var h=new r.Quaternion(i[0],i[1],i[2],i[3]);var f=new r.Vector3(n[0],n[1],n[2]);var d=new r.Matrix4;d.compose(c,h,f);a.transform=d.elements.slice()})}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.parent===t||e.node===t){e.translation=null;e.scale=null;e.quaternion=null;if(e.node.userData){e.node.userData.offsetTranslation=null;e.node.userData.offsetQuaternion=null;e.node.userData.offsetScale=null;e.node.userData.originalRotationType=null}}});this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.parent===t){this._updateJointNode(e,this._playbackAssociatedWithJoints);this.restoreRestTransformation(e.node)}},this);this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.node===t){this._updateJointNode(e,this._playbackAssociatedWithJoints)}},this);if(this._playbackAssociatedWithJoints){var s=this._playbackAssociatedWithJoints.getSequence();if(s){s._fireSequenceChanged()}}}return this};b.prototype.getRestOpacity=function(t){const e=this.getCurrentView()?.getNodeInfos();var i=1;if(e?.length){for(var r=0;r<e.length;r++){var n=e[r];if(n.target!==t){continue}if(n.opacity!==undefined&&n.opacity!==null){i=n.opacity}break}}return i};b.prototype.setRestOpacity=function(t,e){const i=this.getCurrentView()?.getNodeInfos();i?.forEach(function(i){if(i.target!==t){return}i.opacity=e});return this};b.prototype.restoreRestOpacity=function(t){const e=this.getCurrentView()?.getNodeInfos();if(e){e.forEach(function(e){if(e.target!==t){return}var i=1;if(e.opacity!==undefined){i=e.opacity}this.setOpacity(t,i)}.bind(this))}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.parent===t||e.node===t){e.opacity=null;if(e.node.userData){e.node.userData.offsetOpacity=null}}});this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.parent===t){this._updateJointNode(e,this._playbackAssociatedWithJoints);this.restoreRestOpacity(e.node)}},this);this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.node===t){this._updateJointNode(e,this._playbackAssociatedWithJoints)}},this);if(this._playbackAssociatedWithJoints){var i=this._playbackAssociatedWithJoints.getSequence();if(i){i._fireSequenceChanged()}}}return this};b.prototype.updateRestOpacity=function(t){const e=this.getCurrentView();if(!e){return this}e.getNodeInfos()?.forEach(function(e){if(e.target===t){const i=this._getOpacity(t);if(i!=null){e.opacity=i}else{delete e.opacity}}},this);if(this._jointCollection?.length>0){this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.parent===t||e.node===t){e.opacity=null;if(e.node.userData){e.node.userData.offsetOpacity=null}}});this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.node===t){this._updateJointNode(e,this._playbackAssociatedWithJoints)}},this);if(this._playbackAssociatedWithJoints){var i=this._playbackAssociatedWithJoints.getSequence();if(i){i._fireSequenceChanged()}}}return this};b.prototype.getRestTransformationWorld=function(t){const e=this.getCurrentView()?.getNodeInfos();var i;if(e){var n=new r.Matrix4;while(t){for(var a=0;a<e.length;a++){var o=e[a];if(o.target!==t){continue}var s;if(o.transform){s=R(o.transform)}else if(o[p.Scale]&&o[p.Rotate]&&o[p.Translate]){var l=new r.Vector3(o[p.Translate][0],o[p.Translate][1],o[p.Translate][2]);var u=new r.Quaternion(o[p.Rotate][0],o[p.Rotate][1],o[p.Rotate][2],o[p.Rotate][3]);var c=new r.Vector3(o[p.Scale][0],o[p.Scale][1],o[p.Scale][2]);s=(new r.Matrix4).compose(l,u,c)}if(s){n.premultiply(s)}break}t=t.parent}var h=new r.Vector3;var f=new r.Quaternion;var d=new r.Vector3;n.decompose(h,f,d);i={};i.translation=h.toArray();i.quaternion=f.toArray();i.scale=d.toArray()}if(!i){i=this.getTransformationWorld(t)}return i};b.prototype.getRestTransformation=function(t){const e=this.getCurrentView()?.getNodeInfos();var i;if(e){e.forEach(function(e){if(e.target!==t){return}if(e.transform){var n=new r.Vector3;var a=new r.Quaternion;var o=new r.Vector3;var s=R(e.transform);s.decompose(n,a,o);i={};i.translation=n.toArray();i.quaternion=a.toArray();i.scale=o.toArray()}else if(e[p.Scale]&&e[p.Rotate]&&e[p.Translate]){i={};i.translation=e[p.Translate].slice();i.quaternion=e[p.Rotate].slice();i.scale=e[p.Scale].slice()}})}if(!i&&t){i={};i.translation=t.userData.position?t.userData.position.toArray():t.position.toArray();i.quaternion=t.userData.quaternion?t.userData.quaternion.toArray():t.quaternion.toArray();i.scale=t.userData.scale?t.userData.scale.toArray():t.scale.toArray();i.matrix=t.matrix.clone()}return i};b.prototype._addToTransformation=function(t,e,i,n,a,o){var s={};var l;if(e){s.translation=[];for(l=0;l<3;l++){s.translation.push(e[l]+t.translation[l])}}else{s.translation=t.translation}if(n){s.scale=[];for(l=0;l<3;l++){s.scale.push(n[l]*t.scale[l])}}else{s.scale=t.scale}if(i){var u=new r.Quaternion(t.quaternion[0],t.quaternion[1],t.quaternion[2],t.quaternion[3]);var h=new r.Quaternion(i[0],i[1],i[2],i[3]);if(a===c.Euler){var f=o?o[3]:6;var d=g.threeQuatToNeutralEuler(u,f);var p=o?o:g.threeQuatToNeutralEuler(h,f);d[0]+=p[0];d[1]+=p[1];d[2]+=p[2];s.quaternion=g.glMatrixQuatToNeutral(g.neutralEulerToGlMatrixQuat(d))}else{var y=(new r.Matrix4).makeRotationFromQuaternion(u);var v=(new r.Matrix4).makeRotationFromQuaternion(h);y.premultiply(v);u.setFromRotationMatrix(y);s.quaternion=[u.x,u.y,u.z,u.w]}}else{s.quaternion=t.quaternion}return s};b.prototype.setInterpolatedRelativeValues=function(t,e){if(e.rtranslate){t.userData.offsetTranslation=e.rtranslate}else{t.userData.offsetTranslation=null}if(e.rscale){t.userData.offsetScale=e.rscale}else{t.userData.offsetScale=null}if(e.rrotate){t.userData.offsetQuaternion=e.rrotate;t.userData.originalRotationType=e.originalRotationType}else{t.userData.offsetQuaternion=null;t.userData.originalRotationType=null}if(e.Euler){t.userData.Euler=e.Euler}else{t.userData.Euler=null}if(e.ropacity!=null){t.userData.offsetOpacity=e.ropacity}else{t.userData.offsetOpacity=null}return this};b.prototype._setJointNodeMatrix=function(){if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}var e=t.node;if(e.userData.skipUpdateJointNode){return}var i={};i.translation=t.translation.slice();i.scale=t.scale.slice();i.quaternion=t.quaternion.slice();var n=this._addToTransformation(i,e.userData.offsetTranslation,e.userData.offsetQuaternion,e.userData.offsetScale,e.userData.originalRotationType,e.userData.Euler);e.position.fromArray(n.translation);e.scale.fromArray(n.scale);e.quaternion.fromArray(n.quaternion);e.updateMatrix();var a=e.quaternion.clone();var o=new r.Matrix4;if(t.parent){t.parent.updateMatrixWorld();o=t.parent.matrixWorld.clone();e.matrixWorld.multiplyMatrices(t.parent.matrixWorld,e.matrix)}else{e.matrixWorld.copy(e.matrix)}var s=new r.Matrix4;if(e.parent){e.parent.updateWorldMatrix(true,false);s.copy(e.parent.matrixWorld);e.matrix.copy(e.parent.matrixWorld).invert().multiply(e.matrixWorld)}else{e.matrix.copy(e.matrixWorld)}e.matrix.decompose(e.position,e.quaternion,e.scale);var l=[e.scale.x,e.scale.y,e.scale.z];this._adjustQuaternionAndScale(o,s,a,e.quaternion,n.scale,l);e.scale.x=l[0];e.scale.y=l[1];e.scale.z=l[2];e.children.forEach(function(t){t.updateMatrixWorld(true)});if(t.nodesToUpdate){t.nodesToUpdate.forEach(function(t){if(t.matrixAutoUpdate){t.updateMatrix()}t.matrixWorld.multiplyMatrices(t.parent.matrixWorld,t.matrix)})}},this)}};b.prototype._getEndPropertyInLastPlayback=function(t,e){var i;var r=this.getCurrentView();if(!r){return i}var n=r.getPlaybacks();if(!n||!n.length){return i}for(var a=n.length-1;a>=0;a--){var o=n[a];var s=o.getSequence();if(s._convertedFromAbsolute){return i}i=o.getNodeBoundaryProperty(t,e,true);if(i){break}}return i};b.prototype._getEndPropertyInPreviousPlayback=function(t,e,i,r){var n;var a=this._getJointByChildNode(t);if(a&&!r){return n}var o=i.getSequence();if(o&&o._convertedFromAbsolute){return n}var s=this.getCurrentView();if(!s){return n}var l=s.getPlaybacks();for(var u=1;u<l.length;u++){var c=l[u];if(c!==i){continue}for(var h=u-1;h>=0;h--){var f=l[h];n=f.getNodeBoundaryProperty(t,e,true);if(n){break}}}return n};b.prototype._convertTracksToRelative=function(t,e){if(e&&t._conversionDoneForReversed||!e&&t._conversionDone){return this}t._convertedFromAbsolute=false;var i=this.getCurrentView();if(!i){return this}var n=t.getNodeAnimation();if(!n||!n.length){return this}var a=i.getNodeInfos();if(a){a.forEach(function(e){var i;for(var a=0;a<n.length;a++){if(e.target===n[a].nodeRef){i=n[a];break}}if(!i){return}var o=[0,0,0];var s=[1,1,1];var l=new r.Quaternion;var u=new r.Vector3;var c=new r.Vector3;if(e.transform){var h=R(e.transform);h.decompose(u,l,c);o=u.toArray();s=c.toArray()}else if(e[p.Scale]&&e[p.Rotate]&&e[p.Translate]){o=e[p.Translate].slice();l=new r.Quaternion(e[p.Rotate][0],e[p.Rotate][1],e[p.Rotate][2],e[p.Rotate][3]);s=e[p.Scale].slice()}else{e.target.matrix.decompose(u,l,c);o=u.toArray();s=c.toArray()}var f,d,v,_;var m=i[p.Translate];if(m&&m.getIsAbsoluteValue()){d=m.getKeysCount();for(f=0;f<d;f++){v=m.getKey(f);_=[v.value[0]-o[0],v.value[1]-o[1],v.value[2]-o[2]];m.updateKey(f,_,true)}m.setIsAbsoluteValue(false);t._convertedFromAbsolute=true}var A=i[p.Scale];if(A&&A.getIsAbsoluteValue()){d=A.getKeysCount();for(f=0;f<d;f++){v=A.getKey(f);_=[v.value[0]/s[0],v.value[1]/s[1],v.value[2]/s[2]];A.updateKey(f,_,true)}A.setIsAbsoluteValue(false);t._convertedFromAbsolute=true}var S=i[p.Opacity];if(S&&S.getIsAbsoluteValue()){var w=this.getRestOpacity(e.target);if(!w){w=1}d=S.getKeysCount();for(f=0;f<d;f++){v=S.getKey(f);_=v.value/w;S.updateKey(f,_,true)}S.setIsAbsoluteValue(false);t._convertedFromAbsolute=true}var C=i[p.Rotate];if(C&&C.getIsAbsoluteValue()){var b;var N=(new r.Matrix4).makeRotationFromQuaternion(l);var x=(new r.Matrix4).copy(N).invert();var T=new r.Matrix4;var V=new r.Matrix4;d=C.getKeysCount();var k=C.getKeysType();for(f=0;f<d;f++){v=C.getKey(f);if(k===y.Quaternion){b=new r.Quaternion(v.value[0],v.value[1],v.value[2],v.value[3]);T.makeRotationFromQuaternion(b);V.multiplyMatrices(T,x);b.setFromRotationMatrix(V);_=b.toArray();C.updateKey(f,_,true)}else if(k===y.Euler){var B=v.value;var E=g.threeQuatToNeutralEuler(l,B[3]);_=[B[0]-E[0]+g.getModulatedAngularValue(B[0]),B[1]-E[1]+g.getModulatedAngularValue(B[1]),B[2]-E[2]+g.getModulatedAngularValue(B[2]),B[3]];C.updateKey(f,_,true)}else if(f===0){var M=new r.Vector3(v.value[0],v.value[1],v.value[2]);T.makeRotationAxis(M,v.value[3]);V.multiplyMatrices(T,x);b=(new r.Quaternion).setFromRotationMatrix(V);_=this._convertQuaternionToAngleAxis(b);C.updateKey(f,_,true);break}}C.setIsAbsoluteValue(false);t._convertedFromAbsolute=true}}.bind(this))}if(!e){t._conversionDone=true;t._conversionDoneForReversed=false}else{t._conversionDone=false;t._conversionDoneForReversed=true}return this};b.prototype._getTrackKeys=function(t){var e=[];var i=t.getKeysCount();for(var r=0;r<i;r++){var n=t.getKey(r);var a;if(Array.isArray(n.value)){a=n.value.slice()}else{a=n.value}e.push({time:n.time,value:a})}return e};b.prototype._setJointNodeOffsets=function(t,e){var i=this._getJointByChildNode(t);if(i){var n=new r.Matrix4;if(t.parent){n=t.parent.matrixWorld.clone()}var a=new r.Matrix4;t.updateMatrixWorld();var o=new r.Matrix4;if(i.parent){i.parent.updateMatrixWorld();o=i.parent.matrixWorld.clone();a.copy(i.parent.matrixWorld).invert().multiply(t.matrixWorld)}else{a.copy(t.matrixWorld)}var s=new r.Vector3;var l=new r.Vector3;var u=new r.Quaternion;a.decompose(s,u,l);if(e===p.Translate){var c=s.toArray();t.userData.offsetTranslation=[c[0]-i.translation[0],c[1]-i.translation[1],c[2]-i.translation[2]]}else if(e===p.Scale){var h=l.toArray();this._adjustQuaternionAndScale(n,o,t.quaternion,u,t.scale.toArray(),h);t.userData.offsetScale=[h[0]/i.scale[0],h[1]/i.scale[1],h[2]/i.scale[2]]}else{this._adjustQuaternionAndScale(n,o,t.quaternion,u,t.scale.toArray(),l.toArray());var f=new r.Quaternion(i.quaternion[0],i.quaternion[1],i.quaternion[2],i.quaternion[3]);var d=(new r.Matrix4).makeRotationFromQuaternion(f);var y=(new r.Matrix4).copy(d).invert();var g=(new r.Matrix4).makeRotationFromQuaternion(u);var v=(new r.Matrix4).multiplyMatrices(g,y);var _=(new r.Quaternion).setFromRotationMatrix(v);t.userData.offsetQuaternion=_.toArray()}}return this};b.prototype.setTranslationKey=function(t,e,i,n){var a=i.getSequence();if(!a){return null}var o;var s=new r.Vector3;t.matrix.decompose(s,new r.Quaternion,new r.Vector3);var l=this._getJointByChildNode(t);if(l){o=l.translation.slice();t.updateMatrixWorld();var u=new r.Matrix4;if(l.parent){l.parent.updateMatrixWorld();u.copy(l.parent.matrixWorld).invert().multiply(t.matrixWorld)}else{u.matrix.copy(t.matrixWorld)}u.decompose(s,new r.Quaternion,new r.Vector3)}else{var c=this.getRestTransformation(t);o=c.translation}var h=s.toArray();var f=[h[0]-o[0],h[1]-o[1],h[2]-o[2]];var d=this._getEndPropertyInPreviousPlayback(t,p.Translate,i);if(d){f[0]-=d[0];f[1]-=d[1];f[2]-=d[2]}var g=a.getNodeAnimation(t,p.Translate);var v;if(!g){g=this._scene.createTrack(null,{trackValueType:y.Vector3,isAbsoluteValue:false});a.setNodeAnimation(t,p.Translate,g,true)}else{v=this._getTrackKeys(g)}g.insertKey(e,f,n);var _=this._getTrackKeys(g);return{KeyValue:f,absoluteValue:h,offset:d,PreviousTrack:v,CurrentTrack:_}};b.prototype._adjustQuaternionAndScale=function(t,e,i,n,a,o){function s(t,e,i,r){var n=Math.abs(t.dot(e));var a=Math.abs(t.dot(i));var o=Math.abs(t.dot(r));if(n>=a&&n>=o){return 0}else if(a>=n&&a>=o){return 1}else{return 2}}if(a[0]>0&&a[1]>0&&a[2]>0){return}var l=t.clone().multiply((new r.Matrix4).makeRotationFromQuaternion(i));var u=(new r.Matrix4).makeRotationFromQuaternion(n);var c=e.clone().multiply(u);var h=new r.Vector3;var f=new r.Vector3;var d=new r.Vector3;l.extractBasis(h,f,d);var p=[h,f,d];var y=new r.Vector3;var g=new r.Vector3;var v=new r.Vector3;c.extractBasis(y,g,v);var _=[1,1,1];for(var m=0;m<3;m++){var A=s(p[m],y,g,v);if(a[m]*o[A]<0){_[A]=-1;o[A]=-o[A]}}u.scale(new r.Vector3(_[0],_[1],_[2]));var S=(new r.Quaternion).setFromRotationMatrix(u);n.x=S.x;n.y=S.y;n.z=S.z;n.w=S.w};b.prototype.setScaleKey=function(t,e,i,n){var a=i.getSequence();if(!a){return null}var o;var s=t.scale.toArray();var l=t.quaternion.clone();var u=this._getJointByChildNode(t);if(u){var c=new r.Matrix4;if(t.parent){c=t.parent.matrixWorld.clone()}o=u.scale.slice();t.updateMatrixWorld();var h=new r.Matrix4;var f=new r.Matrix4;if(u.parent){u.parent.updateMatrixWorld();f=u.parent.matrixWorld.clone();h.copy(u.parent.matrixWorld).invert().multiply(t.matrixWorld)}else{h.copy(t.matrixWorld)}var d=new r.Quaternion;var g=new r.Vector3;h.decompose(new r.Vector3,d,g);var v=g.toArray();this._adjustQuaternionAndScale(c,f,l,d,s,v);s=v}else{var _=this.getRestTransformation(t);o=_.scale}var m=[s[0]/o[0],s[1]/o[1],s[2]/o[2]];var A=this._getEndPropertyInPreviousPlayback(t,p.Scale,i);if(A){m[0]/=A[0];m[1]/=A[1];m[2]/=A[2]}var S=a.getNodeAnimation(t,p.Scale);var w;if(!S){S=this._scene.createTrack(null,{trackValueType:y.Vector3,isAbsoluteValue:false});a.setNodeAnimation(t,p.Scale,S,true)}else{w=this._getTrackKeys(S)}S.insertKey(e,m,n);var C=this._getTrackKeys(S);return{KeyValue:m,absoluteValue:s,offset:A,PreviousTrack:w,CurrentTrack:C}};b.prototype.setRotationKey=function(t,e,i,n,a){var o=n.getSequence();if(!o){return null}var s=36;var l=[i[0],i[1],i[2],s];var u=o.getNodeAnimation(t,p.Rotate);if(u&&u.getKeysType()!==y.Euler){return null}var c;if(!u){u=this._scene.createTrack(null,{trackValueType:y.Euler,isAbsoluteValue:false});o.setNodeAnimation(t,p.Rotate,u,true)}else{c=this._getTrackKeys(u)}u.insertKey(e,l,a);var h=this._getTrackKeys(u);var f=new r.Quaternion;var d=new r.Euler(i[0],i[1],i[2]);f.setFromEuler(d);var g=this._getEndPropertyInPreviousPlayback(t,p.Rotate,n);if(g){var v=new r.Quaternion(g[0],g[1],g[2],g[3]);f.multiply(v)}var _=this._getJointByChildNode(t);var m=new r.Quaternion;if(_){m.fromArray(_.quaternion)}else{var A=this.getRestTransformation(t);m.fromArray(A.quaternion)}f.multiply(m);return{KeyValue:l,absoluteValue:f.toArray(),offset:g,PreviousTrack:c,CurrentTrack:h}};b.prototype.setAxisAngleRotationKey=function(t,e,i,r,n){var a=r.getSequence();if(!a){return null}var o=a.getNodeAnimation(t,p.Rotate);if(o&&o.getKeysType()!==y.AngleAxis){if(!o.setKeysType(y.AngleAxis)){return null}}var s=[i[0],i[1],i[2],i[3]];var l;if(!o){o=this._scene.createTrack(null,{trackValueType:y.AngleAxis,isAbsoluteValue:false});a.setNodeAnimation(t,p.Rotate,o,true)}else{l=this._getTrackKeys(o)}o.insertKey(e,s,n);var u=this._getTrackKeys(o);return{KeyValue:s,PreviousTrack:l,CurrentTrack:u}};b.prototype.getTotalOpacity=function(t){return t._vkGetTotalOpacity(this._jointCollection,this)};b.prototype.setTotalOpacity=function(t,e){var i=1;var r=this._getJointByChildNode(t);if(r&&r.parent){i=r.parent._vkGetTotalOpacity(this._jointCollection,this)}else if(t.parent){i=t.parent._vkGetTotalOpacity(this._jointCollection,this)}let n=this._getOpacity(t);if(i!==0){n=e/i}else{e=0}this.setOpacity(t,n);var a={changed:t,opacity:n};this.fireOpacityChanged(a);return{opacity:n,totalOpacity:e}};b.prototype.setOpacityKey=function(t,e,i,r){var n=i.getSequence();if(!n){return null}let a=this.getOpacity(t)??1;var o=this.getRestOpacity(t);if(!o&&n._convertedFromAbsolute){o=1}a/=o;var s=this._getEndPropertyInPreviousPlayback(t,p.Opacity,i);if(s){a/=s}var l=n.getNodeAnimation(t,p.Opacity);var u;if(!l){l=this._scene.createTrack(null,{trackValueType:y.Opacity});n.setNodeAnimation(t,p.Opacity,l,true)}else{u=this._getTrackKeys(l)}l.insertKey(e,a,r);var c=this._getTrackKeys(l);return{KeyValue:a,totalOpacity:this.getTotalOpacity(t),PreviousTrack:u,CurrentTrack:c}};w=function(){this._visibilityChanges=new Set};w.prototype.getInfo=function(t){var e=[];this._visibilityChanges.forEach(function(i){var r=t.createNodeProxy(i);var n=r.getVeId();t.destroyNodeProxy(r);if(n){e.push(n)}else{e.push(t.getScene().nodeRefToPersistentId(i))}});return e};w.prototype.clear=function(){this._visibilityChanges.clear()};w.prototype.trackNodeRef=function(t){if(this._visibilityChanges.has(t)){this._visibilityChanges.delete(t)}else{this._visibilityChanges.add(t)}};function V(t){while(!t.isScene){var e=t.userData.selectable;if(e!=null){return e}t=t.parent}return true}b.prototype.getSelectable=function(t){if(Array.isArray(t)){return t.map(V)}else{return V(t)}};b.prototype.setSelectable=function(t,e){if(!Array.isArray(t)){t=[t]}t.forEach(function(t){t.userData.selectable=e});return this};b.prototype.updateAssociatedMarkerMatrix=function(){var t=this._scene?this._scene.getSceneBuilder():null;if(t){let e=t.getAllNodesWithBoundMarkers();if(e){e.forEach((t,e)=>{const i=this._scene.persistentIdToNodeRef(e);if(i){var r=i.matrixWorld;t.forEach((t,e)=>{if(t.coordinateSpace!==this._scene.PoiCoordinateSpaces.ReferenceNodeSpace){return}const i=this._scene.persistentIdToNodeRef(e);if(i?.visible){const t=i.userData.treeNode?.transform;if(t){let e=R(t);e.premultiply(r);e.decompose(i.position,i.quaternion,i.scale);i.updateMatrix()}}})}})}}};b.prototype._getNodeState=function(t,e){const i=this._nodeStates;let r=i.get(t);if(r==null&&e){r={visible:null,originalVisible:null,selected:false,ancestorSelected:false,tintColor:null,ancestorTintColor:null,highlightColor:null,ancestorHighlightColor:null,opacity:null,ancestorOverridesOpacity:false,boundingBoxNode:null,material:null,material2:null,originalMaterial:null};i.set(t,r)}return r};b.prototype._deleteUnusedNodeStates=function(){const t=this._materialCache;this._nodeStates.forEach(function(e,i,r){if(e.visible==null&&!e.selected&&!e.ancestorSelected&&e.tintColor==null&&e.ancestorTintColor==null&&e.highlightColor==null&&e.ancestorHighlightColor==null&&e.opacity==null&&!e.ancestorOverridesOpacity){r.delete(i);if(e.material!=null){t.releaseMaterial(e.material)}if(e.material2!=null){t.releaseMaterial(e.material2)}}});return this};b.prototype._applyVisibilityNodeState=function(t,e){t.forEach(function(t,i){const r=e[i];const n=t.visible;const a=r!==n;const o=this._getNodeState(t,a);if(o){if(a){o.visible=r}else{o.visible=null}}},this)};b.prototype._applySelectionNodeState=function(t,e){if(e){t.forEach(function(t){this._selectedNodes.add(t);if(this._showSelectionBoundingBox){this._addBoundingBox(t)}const e=this._getNodeState(t,true);const i=B(e);e.selected=true;if(B(e)!==i){this._setNeedsMaterialUpdate(t)}if(!e.ancestorSelected){t.children.forEach(this._setAncestorSelectedRecursively.bind(this,true),this)}},this)}else{t.forEach(function(t){this._selectedNodes.delete(t);if(this._showSelectionBoundingBox){this._removeBoundingBox(t)}const e=this._nodeStates.get(t);if(e!=null){const i=B(e);e.selected=false;if(B(e)!==i){this._setNeedsMaterialUpdate(t)}if(!e.ancestorSelected){t.children.forEach(this._setAncestorSelectedRecursively.bind(this,false),this)}}},this)}return this};b.prototype._setAncestorSelectedRecursively=function(t,e){const i=this._getNodeState(e,t);if(i!=null&&i.ancestorSelected!==t){const r=B(i);i.ancestorSelected=t;if(B(i)!==r){this._setNeedsMaterialUpdate(e)}if(!i.selected){e.children.forEach(this._setAncestorSelectedRecursively.bind(this,t),this)}}return this};b.prototype._applyTintColorNodeState=function(t,e){t.forEach(function(t,i){const r=e[i];const n=this._getNodeState(t,r!=null);if(n!=null){n.tintColor=r;this._setNeedsMaterialUpdate(t);t.children.forEach(this._setAncestorTintColorRecursively.bind(this,r!=null?r:n.ancestorTintColor),this)}},this);return this};b.prototype._setAncestorTintColorRecursively=function(t,e){const i=this._getNodeState(e,t!=null);if(i!=null&&i.ancestorTintColor!==t){const r=M(i);i.ancestorTintColor=t;if(M(i)!==r){this._setNeedsMaterialUpdate(e)}if(i.tintColor==null){e.children.forEach(this._setAncestorTintColorRecursively.bind(this,t),this)}}return this};b.prototype._setAncestorHighlightColorRecursively=function(t,e){const i=this._getNodeState(e,t!=null);if(i!=null&&i.ancestorHighlightColor!==t){const r=O(i);i.ancestorHighlightColor=t;if(O(i)!==r){this._setNeedsMaterialUpdate(e)}if(i.highlightColor==null){e.children.forEach(this._setAncestorHighlightColorRecursively.bind(this,t),this)}}return this};b.prototype._applyOpacityNodeState=function(t,e){t.forEach(function(t,i){const r=e[i];const n=this._getNodeState(t,r!=null);if(n!=null){n.opacity=r;this._setNeedsMaterialUpdate(t);t.children.forEach(this._setAncestorOverridesOpacityRecursively.bind(this,r!=null),this)}},this);return this};b.prototype._setAncestorOverridesOpacityRecursively=function(t,e){const i=this._getNodeState(e,t);if(i!=null){i.ancestorOverridesOpacity=t;this._setNeedsMaterialUpdate(e);e.children.forEach(this._setAncestorOverridesOpacityRecursively.bind(this,i.opacity!=null||t),this)}return this};b.prototype._computeWorldOpacity=function(t,e){e??=this._nodeStates.get(t);const i=e?.opacity??t.userData.opacity??1;return t.parent?i*this._computeWorldOpacity(t.parent):i};b.prototype._setNeedsMaterialUpdate=function(t){if(t.material!=null){this._needsMaterialUpdate.add(t)}};function k(t,e,i,n){t.color.copy(e.color);t.emissive?.copy(e.emissive);t.specular?.copy(e.specular);t.userData.customColor=i.w>0;if(t.userData.customColor){const e=new r.Color(i.x,i.y,i.z);t.color.lerp(e,i.w);t.emissive?.lerp(e,i.w*.5);t.specular?.multiplyScalar(1-.5*i.w)}const a=t.transparent;t.opacity=n;t.transparent=n<1;t.needsUpdate=t.transparent!==a}b.prototype._updateNodeStateMaterials=function(){if(this._needsMaterialUpdate.size===0){return this}const e=this._materialCache;const i=o(this._highlightColorABGR);const n=new r.Vector4(i.red/255,i.green/255,i.blue/255,1);this._needsMaterialUpdate.forEach(function(a){t(a.material!=null,"Node should have a material to update its state");const s=this._nodeStates.get(a);if(s==null){return}const l=this._computeWorldOpacity(a,s);const u=new r.Vector4(0,0,0,0);const c=O(s);if(c!=null){u.fromArray(c)}const h=M(s);if(h!=null){const t=o(h);u.lerp(new r.Vector4(t.red/255,t.green/255,t.blue/255,1),t.alpha)}if(s.selected||s.ancestorSelected){s.material2??=e.cloneMaterial(a.material);k(s.material2,a.material,u,l);u.lerp(n,i.alpha)}s.material??=e.cloneMaterial(a.material);k(s.material,a.material,u,l);s.customMaterial=u.w>0||l<1},this);this._needsMaterialUpdate.clear();return this};b.prototype.applyNodeStates=function(t){this._updateNodeStateMaterials();this._nodeStates.forEach(function(e,i){if(e.material!=null&&e.customMaterial){e.originalMaterial=i.material;i.material=t&&(e.selected||e.ancestorSelected)?e.material2??e.material:e.material;i.userData.customMaterial=true}if(e.visible!=null){e.originalVisible=i.visible;i.visible=e.visible}})};b.prototype.revertNodeStates=function(){this._nodeStates.forEach(function(t,e){if(t.originalMaterial){e.material=t.originalMaterial;t.originalMaterial=null;e.userData.customMaterial=false}if(t.originalVisible!=null){e.visible=t.originalVisible;t.originalVisible=null}})};function B(e){t(e!=null,"Node state should not be null");return e.selected||e.ancestorSelected}function E(t,e){return e?.visible??t?.visible??false}function M(t){return t.tintColor||t.ancestorTintColor}function O(t){return t.highlightColor||t.ancestorHighlightColor}return b});
//# sourceMappingURL=ViewStateManager.js.map