/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/base/Log","./UsageCounter","../totara/TotaraUtils","./OrthographicCamera","./PerspectiveCamera","./DetailView","./AnimationHelper","./Thrustline","./Billboard","./Callout","../BillboardCoordinateSpace","../BillboardTextEncoding","../BillboardStyle","../BillboardBorderLineStyle","../BillboardHorizontalAlignment","../LeaderLineMarkStyle","../DetailViewType","../DetailViewShape","../AnimationPlayback","../AnimationRotateType","../RenderMode","./Material","./MaterialType","./SphericalMapMaterial","../ObjectType","./ParametricGenerators","../NodeContentType","../NavigationMode","sap/base/util/uid","./ThreeUtils","sap/base/assert","../colorToCSSColor","../TransformationMatrix","./PointCloudGroup"],function(e,t,r,i,a,n,s,o,d,u,l,c,h,p,f,m,v,g,y,_,I,S,b,w,D,M,x,T,C,A,k,N,R,P,B){"use strict";var V=function(e,t,r,i){this._rootNode=e;this._contentResource=t;this._resolve=r;this._reject=i;this._callouts=new Map;this._cameras=new Map;this._images=new Map;this._imageIdsAndTileWidths=new Map;this._imageTextures=new Map;this._geometries=new Map;this._meshNodes=new Map;this._meshSubmeshes=new Map;this._geometryProxies=new Map;this._geometrySubmeshIndices=new Map;this._materialMeshes=new Map;this._materialClones=new Map;this._joints=[];this._pointCloudGroups=[];this._imageAddedToMaterialHandlers=[];this._isSmallScene=null;this._preprocessedClusterDefinitions=null;this._preprocessedSubmeshToClusterMap=null;this._temporaryGeometryBuffer={points:new Float32Array(65536*3),normals:new Float32Array(65536*3),colors:new Float32Array(65536*3),uvs:new Float32Array(65536*2),indices:new Uint16Array(65536),previousIndexCount:0};this._nodeWithAssocicatedMarkers=new Map;this._markNodeIdsToRefNodeIds=new Map;if(e){this._nodes=new Map;this._tracks=new Map;this._trackIdSequenceNodeMap=new Map;this._viewGroups=new Map;this._views=new Map}else{this._nodes=null;this._tracks=null;this._trackIdSequenceNodeMap=null;this._viewGroups=null;this._views=null}this._currentSceneId=null;this._sceneIdTreeNodesMap=new Map;this._sceneIdRootNodeMap=new Map;this._animationHelper=new o(this);if(t){var a=t.getNodeProxy();var n=a.getNodeHierarchy();this._vkScene=n.getScene();var s=t.getSource();if(s&&s.name){this._sceneIdTreeNodesMap.set(s.name,this._nodes);this._sceneIdRootNodeMap.set(s.name,e);this._currentSceneId=s.name}}this._viewThumbnails=new Map;this._thrustlines=new Map;this._animations=new Map;this._animationTracks=new Map;this._jointNodesMap=new Map;this._jointParentsMap=new Map;this._upAxis=2;this._voxelThreshold=0;this._maximumRenderedPointsBudget=20*1e6};V.prototype.getVoxelThreshold=function(){return this._voxelThreshold};V.prototype.setVoxelThreshold=function(e){this._voxelThreshold=e;return this};var O=[S.Default,S.Default,S.Default,S.LineIllustration,S.SolidOutline,S.ShadedIllustration];V.prototype.setScene=function(e){this._vkScene.setSceneBuilder(this);var t=this._cameras.get(e.cameraId);this._upAxis=e.upAxis;this._resolve({node:this._rootNode,camera:t,backgroundTopColor:e.backgroundTopColor,backgroundBottomColor:e.backgroundBottomColor,upAxis:e.upAxis,dimension:e.dimension,outputSettings:e.showPaperFrame?e.outputSettings:null,contentResource:this._contentResource,builder:this})};V.prototype.setRootNode=function(e,t,r,i){this._rootNode=e;this._nodes=new Map;this._nodes.set(t,e);this._tracks=new Map;this._trackIdSequenceNodeMap=new Map;this._sequenceIdToPlaybacks=new Map;this._viewGroups=new Map;this._views=new Map;if(r){this._sceneIdTreeNodesMap.set(r,this._nodes);this._sceneIdRootNodeMap.set(r,e);this._currentSceneId=r}if(i){this._vkScene=i;if(this._sceneMetadata){this._vkScene.setSceneMetadata(this._sceneMetadata)}}return this};V.prototype._resetCurrentScene=function(e){if(e&&e!==this._currentSceneId){var t=this._sceneIdTreeNodesMap.get(e);if(t){this._nodes=t}else{this._nodes=null}var r=this._sceneIdRootNodeMap.get(e);if(r){this._rootNode=r}else{this._rootNode=null}this._currentSceneId=e}};V.prototype.getNode=function(e,t){if(t){this._resetCurrentScene(t);if(this._nodes){return this._nodes.get(e)}}else{var r=this._sceneIdTreeNodesMap.values();var i=r.next();while(!i.done){var a=i.value.get(e);if(a){return a}i=r.next()}}return null};V.prototype.hasMesh=function(e){return this._meshSubmeshes.has(e)};V.prototype.hasImage=function(e){return this._images.has(e)};V.prototype.hasAnnotation=function(e){return this._vkScene._hasAnnotation(e)};V.prototype.setNodePersistentId=function(e,t,r){var i=e.userData;var a=i.treeNode;if(a==null){a=i.treeNode={}}var n=a.sid;this._resetCurrentScene(r);i.nodeId=a.sid=t;if(this._nodes){if(n){this._nodes.delete(n)}this._nodes.set(t,e);return true}return false};var E=function(t){var r=new e.Matrix4;if(t.length===3){r.setPosition((new e.Vector3).fromArray(t))}else if(t.length===12){r.fromArray(P.convertTo4x4(t))}else if(t.length===16){r.fromArray(t)}else{throw"Invalid matrix format"}return r};V.prototype._createTemporaryMaterial=function(t,r){var i=new b(r||w.MeshPhongMaterial);var a=i.getMaterialRef();a.vertexColors=true;a.userData.materialUsed=0;a.userData.materialId=t;a.userData.toBeUpdated=true;if(this._vkScene.getDoubleSided()){a.side=e.DoubleSide;a.userData.originalMaterialSide=e.FrontSide}this._vkScene.setMaterial(t,i);var n=this._materialMeshes.get(t);if(n){n.forEach(function(e){this._updateMeshSubmeshesMaterial(e,t,a)},this)}var s=this._vkScene.getSceneRef().userData;if(!s.instanceDataTexture){var o=2048;var d=2048;s.maxInstanceIndex=Math.floor(2048*2048*4/20)-1;s.instanceDataTexture=new e.DataTexture(new Float32Array(o*d*4),o,d,e.RGBAFormat,e.FloatType);s.instanceDataTexture.version=1;s.instanceDataTexture.image.needsUpdate=true;s.instanceDataTexture.onUpdate=function(e){e.userData.textureUpdateParams=null};s.textureUpdateResults=null}a.specularMap=s.instanceDataTexture;return a};V.prototype._getMaterialRef=function(e){var t=this._vkScene.getMaterial(e);return t?t.getMaterialRef():null};V.prototype.checkMaterialExists=function(e,t){if(this._getMaterialRef(e)===null){if(t){this._createTemporaryMaterial(e)}return false}return true};V.prototype.materialNeeded=function(e){return true};V.prototype.attachImageAddedToMaterial=function(e,t){this._imageAddedToMaterialHandlers.push({func:e,listener:t});return this};V.prototype.detachImageAddedToMaterial=function(e,t){for(var r=0;r<this._imageAddedToMaterialHandlers.length;r++){var i=this._imageAddedToMaterialHandlers[r];if(i.func===e&&i.listener===t){this._imageAddedToMaterialHandlers.splice(r,1);return this}}return this};V.prototype.fireImageAddedToMaterial=function(e){var t=this._imageAddedToMaterialHandlers.slice();t.forEach(function(t){t.func.call(t.listener,e)});return this};V.prototype._attachMaterialClone=function(e,t){i.pushElementIntoMapArray(this._materialClones,e,t)};V.prototype._addDynamicObject=function(e,t,r){var i=this._rootNode.userData;if(!i._vkDynamicObjects){i._vkDynamicObjects=[]}if(i._vkDynamicObjects.indexOf(e)<0){i._vkDynamicObjects.push(e)}e._vkUpdate=t;if(r){e.userData.is2D=true}};const G={REFERENCE:T.Reference,ANNOTATION:T.Annotation,BACKGROUND:T.Background,SYMBOL:T.Symbol,PMI:T.PMI,POINT_CLOUD_GROUP:T.PointCloudGroup};V.prototype.createNode=function(t,r){this._resetCurrentScene(r);var i=new e.Group;this._nodes.set(t.sid,i);var a;var n=this._jointNodesMap.get(t.sid);if(n&&n.length){for(a=0;a<n.length;a++){n[a].node=i}}var s=this._jointParentsMap.get(t.sid);if(s&&s.length){for(a=0;a<s.length;a++){s[a].parent=i}}var o=this._nodes.get(t.parentId);(o||this._rootNode).add(i);var d=i.userData;d.treeNode=t;if(t.closed){d.closed=true}if(t.selectable===false){d.selectable=false}if(t.visualisable===false&&t.contentType!=="SYMBOL"){d.skipIt=true}if(t.metadata){d.metadata=t.metadata}if(t.veids){d.veids=t.veids}if(t.usageIds){d.usageIds=t.usageIds}if(t.sid){d.nodeId=t.sid}if(t.name){i.name=t.name}if(t.visible!==undefined){i.visible=!!t.visible}if(o){var l;if(d.skipIt||o.name&&i.name===o.name+" offset geometry"){d.skipIt=true}else{l=o;while(l){if(l.userData.closed){d.skipIt=true;d.skipItClosed=true}l=l.parent}}if(o.userData.symbolContent){d.skipIt=true;if(d.skipItClosed===true){d.skipItClosed=false}d.symbolContent=true}if(i.visible&&!d.skipIt&&this._contentResource){l=o;while(l){l.visible=true;l=l.parent}}}if(t.renderOrder){i.renderOrder=t.renderOrder}if(t.renderMethod){d.renderMethod=t.renderMethod}if(t.renderStage){if(typeof t.renderStage==="string"){t.renderStage={UNDERLAY_2D:-1,OVERLAY_2D:1}[t.renderStage]||0}d.renderStage=t.renderStage}d.opacity=t.opacity;if(t.transform){i.applyMatrix4(E(t.transform));if(!isFinite(i.quaternion.x)||!isFinite(i.quaternion.y)||!isFinite(i.quaternion.z)||!isFinite(i.quaternion.w)){i.quaternion.set(0,0,0,1)}}i.updateMatrixWorld(true);if(t.objectTransform){d.objectTransform=(new e.Matrix4).fromArray(t.objectTransform)}if(t.transformType){d.transformType=t.transformType;switch(t.transformType){case"ORTHO2D":d.originalTransform={p:i.position.clone(),q:i.quaternion.clone(),s:i.scale.clone()};this._addDynamicObject(i,u.prototype._ortho2DUpdate,true);break;case"BILLBOARD_VIEW":this._addDynamicObject(i,u.prototype._billboardViewUpdate,false);break;case"LOCK_TOVIEWPORT":this._addDynamicObject(i,u.prototype._lockToViewportUpdate,true);break;default:break}}if(t.materialId){d.materialId=t.materialId}if(t.geometryType){d.geometryType=t.geometryType}if(t.meshId){this.setMeshNode(t.sid,t.meshId)}if(t.parametricId){this.setParametricNode(t.sid,t.parametricId,t.visible)}if(t.dynamicContentId){const e=this._nodes.get(t.sid);if(e){const r=t.visible;e.userData.parametricVisible=r!==undefined?r:true}}if(i.parent.userData.objectType===M.Hotspot){d.objectType=M.Hotspot}else if(i.parent.userData.objectType===M.PMI){d.objectType=M.PMI}else if(t.contentType==="HOTSPOT"){d.objectType=M.Hotspot}else if(t.contentType==="DYNAMIC_CONTENT"){d.objectType=M.DynamicContent}else if(t.contentType==="PMI"){d.objectType=M.PMI}const c=G[t.contentType];if(c){i._vkSetNodeContentType(c)}return i};V.prototype.removeNode=function(e){this._nodes.delete(e._vkPersistentId());this._vkScene._removeAnnotationsForNode(e);this._vkScene.getPointCloudGroups().delete(e);this.setPointCloudGroups([],this._currentSceneId);var t=false;if(!this._forbiddenTextureUpdate){this._forbiddenTextureUpdate=true;t=true;var r=this._vkScene.getSceneRef().userData;if(r.instanceDataTexture){var i=r.geometryClusters;var a=k.prepareTextureUpdateResults(i?i.length:0,r.textureUpdateResults);k.removeNodeFromClusterRenderingRecursive(e,r.instanceDataTexture.image.data,a);r.textureUpdateResults=a}}e.children.forEach(this.removeNode,this);if(t){delete this._forbiddenTextureUpdate}};V.prototype.hasNode=function(e){return this._nodes.has(e._vkPersistentId())};V.prototype.getChildNodeIds=function(e,t,r){this._resetCurrentScene(t);var i=this._nodes.get(e);var a=[];if(!i){return a}if(i&&i.children){for(var n=0;n<i.children.length;n++){var s=i.children[n];if(s.userData.treeNode&&s.userData.treeNode.sid){a.push(s.userData.treeNode.sid)}else if(r&&s.userData.submeshInfo&&s.userData.submeshInfo.id){a.push(s.userData.submeshInfo.id)}}}return a};function L(e){for(var t=0;t<e.length;t++){if(e[t].type==="box"&&e[t].data){return e[t]}}return null}function U(e){if(Array.isArray(e)){for(var t=0;t<e.length;t++){if(e[t].type===undefined||e[t].type==="mesh"||e[t].type==="line"){return e[t]}}}return null}V.prototype._addGeometryToCluster=function(t,r,i,a,n,s,o,d,u,l,c){var h=this._vkScene.getSceneRef().userData;var p=65536;var f=3*p;var m=r.length/3;var v=s?s.length:0;const g=v===0;const y=o?"l":"t";const _=!o&&(i&&i.length===m*3);const I=!o&&!g&&(n&&n.length===m*2);const S=a&&a.length===m*3||g;let b=d+":"+(g?"p":y)+(_?"N":"n")+(S?"C":"c")+(I?"U":"u")+l;if(!h.currentClusters){h.currentClusters=new Map}var w=this._preprocessedSubmeshToClusterMap?this._preprocessedSubmeshToClusterMap.get(u):-1;var D=w>=0?this._preprocessedClusterDefinitions[w]:null;if(D){b="pre"+w;p=D.verts;f=D.elems*(o?2:3)}var M=D?D.cluster:h.currentClusters.get(b);if(!M||M.freeVertices<m||M.freeIndices<v){M=new e.BufferGeometry;if(D){D.cluster=M}else{h.currentClusters.set(b,M)}if(l>1){M.userData.renderInstanceCount=l}M.freeVertices=p;M.freeIndices=f;M.contents=[];M.userData.geometryUsed=0;if(!g){M.setIndex(new e.BufferAttribute(new Uint16Array(f),1))}M.setAttribute("position",new e.BufferAttribute(new Float32Array(p*3),3));M.setAttribute("clusterInstance",new e.BufferAttribute(new Float32Array(p),1));if(g){M.userData.isPointCloud=true}else if(o){M.userData.isPolyline=true}if(_){M.setAttribute("normal",new e.BufferAttribute(new Float32Array(p*3),3))}if(S){M.setAttribute("color",new e.BufferAttribute(new Float32Array(p*3),3))}if(I){M.setAttribute("uv",new e.BufferAttribute(new Float32Array(p*2),2))}let t=this._getMaterialRef(d);var x;if(g){t=t.clone();t.userData.isPointCloud=true;x=new e.Points(M,t)}else if(o){x=new e.LineSegments(M,t)}else{x=new e.Mesh(M,t);if(!_){t.side=e.DoubleSide;t.userData.originalMaterialSide=e.DoubleSide}}t.needsUpdate=true;x.additionalRenderables=[];if(h.geometryClusters){h.geometryClusters.push(x)}else{h.geometryClusters=[x];h.currentInstanceIndex??=0}x.userData.isGeometryCluster=true;M.userData.clusterIndex=h.geometryClusters.length-1}var T=p-M.freeVertices;k.updateClusterAttrib(M,"position",T*3,r);if(M.userData.isPointCloud&&this._pointCloudGroups.length>0){k._updateClusterInstanceAttribute(M,T,m,h.currentInstanceIndex,this._pointCloudGroups)}else{const e=M.getAttribute("clusterInstance");e.array.fill(h.currentInstanceIndex,T,T+m);e.addUpdateRange(T,m);e.needsUpdate=true}if(_){k.updateClusterAttrib(M,"normal",T*3,i)}if(S){if(!a){a=new Float32Array(m*3);a.fill(.7)}k.updateClusterAttrib(M,"color",T*3,a)}if(I){k.updateClusterAttrib(M,"uv",T*2,n)}var C=f-M.freeIndices;if(!g){k.updateClusterIndices(M,s,T,C,v)}M.freeVertices-=m;M.freeIndices-=v;M.drawRange.count=g?T+m:C+v;M.contents.push({instanceIndex:h.currentInstanceIndex,vertexLast:(T+m)*3,isFinal:c});M.shouldUpload=2;if(t){M.boundingBox=e.Box3.newFromPackedArray(t)}else{M.computeBoundingBox(T,T+m)}M.computeBoundingSphere(T,T+m,true);const A={geometry:M,vertexStart:T,vertexCount:m,indexStart:g?undefined:C,indexCount:g?undefined:v,boundingBox:M.boundingBox,boundingSphere:M.boundingSphere,instanceIndex:h.currentInstanceIndex};M.boundingBox=null;M.boundingSphere=null;return A};function q(e,t){var r=e.boundingBox.min;var i=e.boundingBox.max;var a=e.boundingSphere;return{firstVertex:e.vertexStart,lastVertex:e.vertexStart+e.vertexCount,start:e.indexStart===undefined?e.vertexStart:e.indexStart,count:e.indexCount===undefined?e.vertexCount:e.indexCount,instanceIndex:t,clusterIndex:e.geometry.userData.clusterIndex,boundingBox:[r.x,r.y,r.z,i.x,i.y,i.z],boundingSphere:[a.center.x,a.center.y,a.center.z,a.radius]}}V.prototype._cloneSubmesh=function(t,r){var a=t instanceof e.Mesh?t._vkClone():t.clone();if(r.userData.transformType==="ORTHO2D"){a.position.setScalar(0);a.scale.setScalar(1)}a.userData.skipIt=true;a.renderOrder=r.renderOrder;if(r.userData.materialId){k.disposeMaterial(a.material);a.material=this._getMaterialRef(r.userData.materialId)||t.material;a.userData.materialId=r.userData.materialId;i.pushElementIntoMapArray(this._materialMeshes,r.userData.materialId,t.userData.meshId)}return a};V.prototype.preprocessMeshes=function(e){if(this._preprocessedSubmeshToClusterMap){return}this._preprocessedClusterDefinitions=[];this._preprocessedSubmeshToClusterMap=new Map;var r=performance.now();var a=new Set;var n=new Map;var s=0,o=0,d=0;var u=0,l=0;var c=0,h=0,p=0,f=0;var m=0,v=0;var g,y,_,I,S,b,w,D,M,x;var T,C,A;var N,R,P,B,V,O;var E,G;var L=e.length;var q,F;var W=[];for(g=0;g<L;++g){y=e[g];_=y.id;I=y.submeshes;N=false;W.length=0;for(S=0,b=I.length;S<b;++S){M=I[S].lods[0];W.push(M.boundingBox);if(!M.elementCount){N=true}}E=this._meshNodes.get(_);if(E){y.priority=this._computeMeshPriority(E,W);if(N){F=E[0].name;F=F?F.split(":"):null;if(F&&F[1]&&F[0]==="_machete.pointsSubMesh"){y.priority0=Number(F[1])}}}else{y.priority=0}}e.sort(function(e,t){if(e.priority0!==undefined&&t.priority0!==undefined){if(e.priority0<t.priority0){return-1}else if(e.priority0>t.priority0){return 1}}return t.priority-e.priority});for(g=0;g<L;++g){y=e[g];_=y.id;if(a.has(_)){continue}a.add(_);E=this._meshNodes.get(_);G=E?E.length:0;d+=G;if(G===0){o++;continue}s++;I=y.submeshes;for(S=0,b=I.length;S<b;++S){w=I[S];D=w.materialId;q=false;M=U(w.lods);x=!M?null:M.id;if(x==null){continue}T=M.pointCount;C=M.elementCount||0;A=M.flags;if(T>0&&A!=null){N=C===0;R=(A&1)>0;P=!R&&(A&2)>0;V=!R&&!N&&(A&4)>0;B=(A&32)>0;O=R?"l":"t";u++;if(N){if(y.priority0===0||m<this._maximumRenderedPointsBudget){m+=T}else{for(F=0;F<G;++F){E[F].visible=false}q=true;y.skipPointCloud=true;v+=T}}else if(R){f+=2*2*C;c+=T;p+=C}else{f+=2*3*C;c+=T;h+=C}if(!q){f+=(3+1+(P?3:0)+(B?3:0)+(V?2:0))*4*T;i.pushElementIntoMapArray(n,D+":"+(N?"p":O)+(P?"N":"n")+(B?"C":"c")+(V?"U":"u")+G,{submeshId:w.id,verts:T,elems:C,meshIndex:g,submeshIndex:S})}}else{l++}}}n.forEach(function(t){k.partitionCluster(t,this._preprocessedClusterDefinitions,this._preprocessedSubmeshToClusterMap,e)},this);this._isSmallScene=u<2e3&&c<1e6&&m<1e6;t.info(n.size+" unique cluster types detected in "+(performance.now()-r).toFixed(1)+"ms.  "+"Scene frame classification: "+(this._isSmallScene?"small.  ":"large.  ")+s+" meshes ("+o+" undefined).  "+d+" mesh instances.  "+(d/s).toFixed(1)+"X instancing.  "+u+" geometries ("+l+" undefined).  "+c.toLocaleString()+" unique vertices.  "+h.toLocaleString()+" unique triangles.  "+p.toLocaleString()+" unique lines.  "+m.toLocaleString()+" unique points.  "+v.toLocaleString()+" skipped points.  "+(f/1048576).toFixed(1)+"MB VRAM in "+this._preprocessedClusterDefinitions.length+" clusters expected.")};V.prototype.getTempGeometryBuffer=function(){return this._temporaryGeometryBuffer};V.prototype.setSubmeshes=function(e){this.preprocessMeshes(e);var t,r,i,a,n;for(var s=0,o=e.length;s<o;++s){t=e[s];r=t.submeshes;for(a=0,n=r.length;a<n;++a){i=r[a];this.insertSubmesh(i)}}};V.prototype.insertSubmesh=function(t){var r=this._getMaterialRef(t.materialId)||this._createTemporaryMaterial(t.materialId);var a=t.id;var n=U(t.lods);if(!n){return false}var s=n.pointCount;var o=n.elementCount===0?null:n.elementCount;var d=s>0&&o>0;var u=n.id;var l=n.flags;var c=n.boundingBox;var h=this._meshNodes.get(t.meshId);var p=null;var f;var m=h?h.length:0;if(!c){var v=new e.BufferGeometry;var g=new e.BufferAttribute(new Uint16Array(0),1);var y=new e.BufferAttribute(new Float32Array(0),3);v.setIndex(g);v.setAttribute("position",y);f=new e.Mesh(v,r)}else if(l!=null&&s>0&&o==null){const i=k.buildEmptyMesh(c,l,s,o,this._temporaryGeometryBuffer);p=this._addGeometryToCluster(c,i.points,i.normals,i.colors,undefined,undefined,false,t.materialId,a,m,false);f=new e.Points(p.geometry,r)}else if(l!=null&&(l&1)>0&&d){const i=k.buildEmptyMesh(c,l,s,o,this._temporaryGeometryBuffer);p=this._addGeometryToCluster(c,i.points,undefined,undefined,undefined,i.indices,true,t.materialId,a,m,false);f=new e.LineSegments(p.geometry,r)}else{var _=L(t.lods);var I=_?_.data:null;if(this._isSmallScene==null){this._isSmallScene=this._meshNodes.size<2e3&&this._nodes.size<5e3}var S=!I;var b=!d||m<1;var w=d&&(s<24||o<12);if(w&&this._isSmallScene){b=true;w=false}var D=1;if(b){D=-1}else if(this._isSmallScene||S){D=0}if(l==null){l=0}var M=w?k.buildEmptyMesh(c,l,s,o,this._temporaryGeometryBuffer):k.buildTemporaryMesh(c,l,s,o,I,S,D,this._temporaryGeometryBuffer);if(b||M.points.length>s*3||M.indices.length>o*3){var x=new e.BufferGeometry;var T=new e.BufferAttribute(M.indices.slice(),1);var C=new e.BufferAttribute(M.points.slice(),3);x.setIndex(T);x.setAttribute("position",C);if(M.normals){var A=new e.BufferAttribute(M.normals.slice(),3);x.setAttribute("normal",A)}x.boundingBox=e.Box3.newFromPackedArray(c);f=new e.Mesh(x,r)}else{p=this._addGeometryToCluster(c,M.points,M.normals,M.colors,M.uvs,M.indices,false,t.materialId,a,m,false);f=new e.Mesh(p.geometry,r)}}f.userData.geometryId=u;f.userData.lodInfo=n;if(t.transform){f.applyMatrix4(E(t.transform))}f.updateMatrixWorld(true);f.userData.submeshId=a;f.userData.initialMaterialId=t.materialId;f.userData.meshId=t.meshId;f.userData.materialId=t.materialId;f.userData.submeshInfo=t;i.pushElementIntoMapArray(this._materialMeshes,t.materialId,t.meshId);var N=i.pushElementIntoMapArray(this._meshSubmeshes,t.meshId,f)-1;if(p){i.pushElementIntoMapArray(this._geometries,n.id,p)}else{i.pushElementIntoMapArray(this._geometryProxies,n.id,{meshId:t.meshId,submeshId:a,submeshIndex:N,materialId:t.materialId})}if(h){var R=this._vkScene.getSceneRef().userData;h.forEach(function(t){var r=this._cloneSubmesh(f,t);if(r.material&&t.userData&&t.userData.geometryType&&(t.userData.geometryType==="PLANE"||t.userData.geometryType==="SURFACE")){r.material.side=e.DoubleSide;if(this._vkScene.getDoubleSided()){r.material.userData.originalMaterialSide=e.DoubleSide}}if(p){r.userData.renderGroup=q(p,R.currentInstanceIndex);R._instanceIndexToNodeMap??=new Map;R._instanceIndexToNodeMap.set(R.currentInstanceIndex,t);k.increaseCurrentInstance(R)}this._geometrySubmeshIndices.set(t.userData.nodeId+":"+u,t.children.length);t.add(r);r.updateMatrixWorld(true);W(r,this._materialClones)},this)}return true};function F(i,a,n,s,o,d){var u=s.geometry;var l=i[a];if(!l||l.userData.geometryId!==n){t.error("Invalid submesh index in replaceSubmeshGeometry");return}if(l.geometry!==u){var c=q(s,o.currentInstanceIndex);if(d){k.increaseCurrentInstance(o)}if(l.isMesh&&!u.userData.isPolyline){if(l.geometry){k.disposeGeometry(l)}l.geometry=u;l.userData.renderGroup=c;l.updateMatrixWorld(true);r.increaseGeometryUsed(u)}else{var h=new e.LineSegments(u,l.material);r.increaseGeometryUsed(u);h.position.copy(l.position);h.quaternion.copy(l.quaternion);h.scale.copy(l.scale);h.matrix.copy(l.matrix);h.updateMatrixWorld(true);h.userData=l.userData;h.userData.renderGroup=c;h.renderOrder=l.renderOrder;h.parent=l.parent;i[a]=h;l.parent=null}}}V.prototype._setSubmeshMaterial=function(e,t,a){r.increaseMaterialUsed(t);e.material=t;e.userData.materialId=a;delete e.userData.originalMaterial;if(e.material!==t){i.pushElementIntoMapArray(this._materialClones,a,e.material)}};V.prototype._updateMaterial=function(e,t,r){e.children.forEach(function(e){if(e.material&&e.userData.materialId===t){this._setSubmeshMaterial(e,r,t)}},this)};V.prototype._updateMeshSubmeshesMaterial=function(e,t,r){var i=this._meshSubmeshes.get(e);if(i){i.forEach(function(e){if(e.material&&e.material.userData.materialId===t){e.material=r}})}};function W(e,t){if(e.material){var r=e.material;if(e.material!==r){i.pushElementIntoMapArray(t,e.material.userData.materialId,e.material)}}}V.prototype.setGeometry=function(r){var a=r.id;var n=r.data;if(r.isPointCloud){const t=this._vkScene.getSceneRef().userData;const r=n.points;const i=(new e.Box3).setFromArray(r);t.pointCloudBoundingBox??=new e.Box3;t.pointCloudBoundingBox.union(i);t.totalPointCount??=0;t.totalPointCount+=r.length/3;const a=t.pointCloudBoundingBox.getSize(new e.Vector3);t.pointScale=Math.sqrt((a.x*a.z*2+a.x*a.y+a.y*a.z)/t.totalPointCount)*700}var s=this._geometries.get(a);if(s){s.forEach(e=>{if(!k.updateClusterGeometry(e,n.points,n.normals,n.colors,n.uvs,n.indices,this._pointCloudGroups)){t.error("Invalid geometry in setGeometry")}})}var o=true;var d=this._geometryProxies.get(a);if(d){o=false;var u=0;d.forEach(function(e){var t=this._meshNodes.get(e.meshId);if(t){u+=t.length}},this);if(u<1){u=1}var l=this._vkScene.getSceneRef().userData;d.forEach(function(e){var t=this._addGeometryToCluster(null,n.points,n.normals,n.colors,n.uvs,n.indices,r.isPolyline,e.materialId,e.submeshId,u,true);i.pushElementIntoMapArray(this._geometries,a,t);var s=e.meshId;var o=this._meshNodes.get(s);if(o){for(let e=0;e<o.length;++e){F(o[e].children,this._geometrySubmeshIndices.get(o[e].userData.nodeId+":"+a),a,t,l,true)}}var d=this._meshSubmeshes.get(s);if(d){F(d,e.submeshIndex,a,t,l,false)}},this);this._geometryProxies.delete(a)}this._vkScene.onGeometryUpdated(a);if(this._fireSceneUpdated){this._fireSceneUpdated(o)}return this};V.prototype.setMeshNode=function(e,t){var r=this._nodes.get(e);if(r){i.pushElementIntoMapArray(this._meshNodes,t,r);var a=this._meshSubmeshes.get(t);if(a){a.forEach(function(e){var t=this._cloneSubmesh(e,r);var i=this._geometries.get(e.userData.geometryId);if(i){t.userData.renderGroup=q(i[0],null)}this._geometrySubmeshIndices.set(r.userData.nodeId+":"+e.userData.geometryId,r.children.length);r.add(t);W(t,this._materialClones)},this)}}};V.prototype.setParametricNode=function(e,t,r){var i=this._nodes.get(e);if(i){i.userData.parametricVisible=r!==undefined?r:true}};V.prototype.progress=function(e){t.log("reading progress:",e)};V.prototype.getGeometry=function(e){var t=this._geometries.get(e);return t?t[0].geometry:null};var j={rect:p.RectangularShape,circle:p.CircularShape,none:p.None,textGlow:p.TextGlow};var z={none:f.None,solid:f.Solid,dash:f.Dash,dot:f.Dot,dashdot:f.DashDot,dashdotdot:f.DashDotDot};var H={left:m.Left,center:m.Center,right:m.Right};var Y={none:v.None,point:v.Point,arrow:v.Arrow};var K=new e.Color;function J(t){var r=new e.Matrix4;var i=new e.Matrix4;var a=t;while(a&&a.userData.originalTransform){N(a.userData.transformType==="ORTHO2D");var n=a.userData.originalTransform;r.compose(n.p,n.q,n.s);i.premultiply(r);a=a.parent}i.decompose(t.position,t.quaternion,t.scale)}V.prototype.createAnnotation=function(r,i){this._resetCurrentScene(i);var a=this._nodes.get(r.nodeId);if(!a){t.warning("Annotation node not found",r);return}if(a.userData.originalTransform){J(a)}var n=r.type;if(n===undefined){this.createLegacyAnnotation(r,a);return}a.userData.annotationType=n;if(n==="html"){r.id=r.id||A();var s=[];if(r.leaderLines){r.leaderLines.forEach(function(e){if(e.start&&e.start.sid){s.push(this._nodes.get(e.start.sid))}},this)}this._vkScene._addAnnotation(r.id,{annotation:r,node:a,attachment:r.attachment&&r.attachment.sid?this._nodes.get(r.attachment.sid):null,targetNodes:s});return}var o=r.label||{};var d=r.text||{};var c=o.colour||[1,1,1,1];var m=o.borderColour||[0,0,0,1];var v={node:a,renderOrder:a.renderOrder||0,style:j[o.shape]||p.RectangularShape,width:o.width||64,height:o.height||64,backgroundColor:K.fromArray(c).getStyle(),backgroundOpacity:c[3],borderColor:K.fromArray(m).getStyle(),borderOpacity:m[3],borderWidth:o.borderColour?o.borderWidth||0:0,borderLineStyle:z[o.borderLineStyle]||f.Solid,horizontalAlignment:H[d.align]};if(d.html){v.encoding=h.HtmlText;v.text=d.html}else{v.encoding=h.PlainText;v.text=d.text;v.font=d.fontFace||"Arial";v.fontSize=Math.abs(d.fontSize)||16;v.fontWeight=Math.min(d.fontWeight,900);v.fontItalic=d.fontItalic;v.textColor=K.fromArray(d.colour||[0,0,0]).getStyle()}if(n==="text"){var g=a.position;v.position=new e.Vector3(g.x*2,g.y*2,g.z);var y=new u(v);y.setText(v.text);this._addDynamicObject(a,y._update.bind(y),true)}else if(n==="note"){var _=r.attachment||{};v.position=(new e.Vector3).fromArray(_.position||[0,0,0]);v.anchorNode=this._nodes.get(_.sid)||this._rootNode;v.depthTest=false;var I=new l(v);I.setText(v.text);this._callouts.set(r.id,I);this._addDynamicObject(a,I._update.bind(I),false)}else{t.warning("Unsupported annotation type",r)}};var X=[p.RectangularShape,p.CircularShape,p.None,p.TextGlow];var Z=[c.Viewport,c.Screen,c.World];var Q=[f.None,f.Solid,f.Dash,f.Dot,f.DashDot,f.DashDotDot];var $=[v.None,v.Point,v.Arrow];var ee=[m.Left,m.Center,m.Right];function te(e){var t=e.toString(16);if(e.length>=3){t=(e[0]*255<<16|e[1]*255<<8|e[2]*255).toString(16)}return"#"+"000000".substring(t.length)+t}function re(e){if(!e){return false}for(var t=0,r=e.length;t<r;t++){if(!isFinite(e[t])){return false}}return true}V.prototype.createLegacyAnnotation=function(r,i){var a=r.position;if(!re(a)){t.warning("Incorrect annotation position",r);return}r.coordinateSpace|=0;var n=r.backgroundOpacity;if(!n){n=r.backgroundColour?r.backgroundColour[3]:0}var s=r.borderOpacity;if(!s){s=r.borderColour?r.borderColour[3]:0}var o={node:i,coordinateSpace:Z[r.coordinateSpace],style:X[r.shape||0],width:r.width,height:r.height,backgroundColor:r.backgroundColour?te(r.backgroundColour):"#fff",backgroundOpacity:n,borderColor:r.borderColour?te(r.borderColour):"#000",borderOpacity:s,borderWidth:r.borderWidth,borderLineStyle:Q[r.borderLineStyle]};if(r.encoding!==undefined){o.encoding=r.encoding?h.HtmlText:h.PlainText;o.font=r.font;o.fontSize=r.fontSize;o.fontWeight=Math.min(r.fontWeight,900);o.fontItalic=r.fontItalic;o.textColor=te(r.textColour);o.link=r.link;o.horizontalAlignment=ee[r.textHorizontalAlignment];o.position=(new e.Vector3).fromArray(a)}else if(r.fontFace){o.encoding=h.PlainText;o.font=r.fontFace;o.fontSize=Math.abs(r.fontSize);o.fontWeight=Math.min(r.fontWeight,900);o.textColor=te(r.textColour)}else{o.encoding=h.HtmlText}if(r.coordinateSpace<2){if(!o.positions){o.position=new e.Vector3(a[0]*2-1,a[1]*-2+1,a[2])}o.renderOrder=(r.order|0)+1e3;var d=new u(o);d.setText(r.text);this._addDynamicObject(i,d._update.bind(d),true)}else{o.anchorNode=this._nodes.get(r.sid)||this._rootNode;if(!o.position){o.position=(new e.Vector3).fromArray(a)}o.depthTest=false;o.renderOrder=r.order|0;if(r.alwaysOnTop){o.renderOrder=1}var c=new l(o);c.setText(r.text);this._callouts.set(r.id,c);this._addDynamicObject(i,c._update.bind(c),false)}};function ie(e){while(e){if(e.userData.transformType){return e.userData.transformType}e=e.parent}return undefined}V.prototype.createImageNote=function(r,i){this._resetCurrentScene(i);var a=this._nodes.get(r.nodeId);if(!a){t.warning("Image annotation node not found",r);return}if(a.userData.originalTransform){J(a)}if(r.type==="image"){var n=r.label||{};var s=n.materialId;var o=this._getMaterialRef(s);if(!o){t.warning("Image annotation material not found",r);return}if(n.projection==="spherical"){a.position.setScalar(0);a.scale.setScalar(1);n.width=-1;n.height=-1;a.userData.transformType="LOCK_TOVIEWPORT";a.userData.renderStage=-1;var d=o;o=new D({upAxis:this._upAxis,map:d.map,color:d.color});o.userData=d.userData;this._vkScene.getMaterial(s)._nativeMaterial=o}o.depthTest=false;o.depthWrite=false;o.blending=e.CustomBlending;o.side=e.DoubleSide;if(a.userData.renderStage===undefined){if(r.order){a.userData.renderStage=Math.sign(r.order)}else if(r.order===undefined&&ie(a)!==undefined){a.userData.renderStage=1}}switch(a.userData.transformType){case"ORTHO2D":case"LOCK_TOVIEWPORT":var l=new u({node:a,renderOrder:a.renderOrder||0,coordinateSpace:c.Screen,position:new e.Vector3(a.position.x,a.position.y,0),width:(n.width||200)*a.scale.x*.5,height:(n.height||200)*a.scale.y*.5});l.setMaterial(o);a.position.setScalar(0);a.scale.setScalar(1);this._addDynamicObject(a,l._update.bind(l),true);break;case"BILLBOARD_VIEW":default:var h=new e.Mesh(u.prototype._planeGeometry,o);h.scale.set(n.width,n.height,1);h.updateMatrix();a.add(h);break}}else{this.createLegacyImageNote(r,a)}};V.prototype.createLegacyImageNote=function(t,r){var i=(new e.Vector3).fromArray(t.position);var a=t.width;var n=t.height;if(!t.properlyAligned){i.x+=t.width*.5;i.y+=t.height*.5;i.applyMatrix4(r.matrix);a=t.width*.5*r.matrix.elements[0];n=t.height*.5*r.matrix.elements[5]}var s=this._getMaterialRef(t.labelMaterialId);s.depthTest=false;s.depthWrite=false;s.blending=e.CustomBlending;if(ie(r)==="LOCK_TOVIEWPORT"){var o=new u({node:r,coordinateSpace:c.Screen,renderOrder:(t.order|0)+1e3,position:i,width:a,height:n});o.setMaterial(s);this._addDynamicObject(r,o._update.bind(o),true)}else{var d=new e.Mesh(u.prototype._planeGeometry,s);d.renderOrder=(t.order|0)+1e3;d.position.copy(i);d.scale.set(a*2,n*2,1);d.updateMatrix();r.add(d);r.scale.setScalar(1);r.updateMatrix()}};V.prototype.insertLeaderLine=function(r,i){this._resetCurrentScene(i);var a=this._callouts.get(r.annotationId);if(a){var n=this._getMaterialRef(r.materialId);if(!n){t.warning("Leader line material not found",r);return}var s=[];var o=r.points;for(var d=0,u=o.length;d<u;d++){s.push((new e.Vector3).fromArray(o[d]))}var l;if(r.start){var c=r.start||{};var h=r.end||{};var p=r.extension||{};l=this._nodes.get(r.start.sid)||this._rootNode;a.addLeaderLine(s,l,n,Y[c.style]||v.None,Y[h.style]||v.None,c.size,p.length||0)}else{l=this._nodes.get(r.startPointSid)||this._rootNode;a.addLeaderLine(s,l,n,$[r.startPointHeadStyle],$[r.endPointHeadStyle],r.pointHeadConstant,r.extensionLength)}}};V.prototype._findDetailViewNodes=function(e){var r=[];if(e){e.forEach(function(e){var i=this._nodes.get(e);if(i){r.push(i)}else{t.warning("Unknown detailView node reference",e)}},this)}return r};V.prototype.createDetailView=function(r,i){this._resetCurrentScene(i);var a=this._nodes.get(r.nodeId);if(!a){t.warning("Detail view node not found",r);return}var n=r.label;if(!n){this.createLegacyDetailView(r,a);return}var o=r.attachment;var d={name:r.name,camera:n.camera?this.createCamera(n.camera):null,type:r.cutaway?g.Cutaway:g.DetailView,borderWidth:n.borderWidth||0,backgroundColor:K.fromArray(n.colour||[1,1,1]).getStyle(),borderColor:K.fromArray(n.borderColour||[1,1,1]).getStyle(),origin:new e.Vector2(a.position.x*2-1+a.scale.x,a.position.y*-2+1-a.scale.x),size:new e.Vector2(a.scale.x,a.scale.y),attachmentPoint:(new e.Vector3).fromArray(o.position||[0,0,0]),veId:r.veid,visibleNodes:this._findDetailViewNodes(r.visibleNodes),targetNodes:this._findDetailViewNodes(r.targetNodes)};if(n.shape==="rect"){d.shape=!n.leaderStyle||n.leaderStyle==="none"?y.Box:y.BoxLine}else{d.shape={none:y.Circle,line:y.CircleLine,pointer:y.CirclePointer,arrow:y.CircleArrow,bubbles:y.CircleBubbles}[n.leaderStyle]||y.Circle}var u=new s(d);if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[]}this._rootNode.userData._vkDetailViews.push({detailView:u,node:a,renderOrder:r.renderOrder||a.renderOrder||0})};V.prototype.createLegacyDetailView=function(t,r){if(!t.properlyAligned){if(!t.shape){t.shape=t.leaderStyle?y.BoxLine:y.Box}else{t.shape=[y.Circle,y.CircleLine,y.CirclePointer,y.CircleArrow,y.CircleBubbles][t.leaderStyle||0]}t.type=t.cutaway?g.Cutaway:g.DetailView;t.camera=t.camera?this.createCamera(t.camera):null;t.origin=new e.Vector2(r.position.x*2-1+r.scale.x,r.position.y*-2+1-r.scale.x);t.size=new e.Vector2(r.scale.x,r.scale.y);t.renderOrder=r.renderOrder}else{t.type=[g.DetailView,g.Cutaway][t.type];t.shape=[y.Box,y.Circle,y.CircleLine,y.CirclePointer,y.CircleArrow,y.CircleBubbles,y.BoxLine,y.BoxNoOutline,y.SolidPointer,y.SolidArrow][t.shape];t.camera=this._cameras.get(t.cameraId);t.origin=(new e.Vector2).fromArray(t.origin);t.size=(new e.Vector2).fromArray(t.size)}var i=new s({name:t.name,camera:t.camera,type:t.type,shape:t.shape,borderWidth:t.borderWidth||0,backgroundColor:t.backgroundColour?te(t.backgroundColour):"#fff",borderColor:t.borderColour?te(t.borderColour):"#000",origin:t.origin,size:t.size,attachmentPoint:(new e.Vector3).fromArray(t.attachment),metadata:t.metadata,veId:t.veid,visibleNodes:this._findDetailViewNodes(t.visibleNodes),targetNodes:this._findDetailViewNodes(t.targetNodes)});if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[]}this._rootNode.userData._vkDetailViews.push({detailView:i,node:r,renderOrder:t.renderOrder||0})};V.prototype.insertThrustline=function(t){var r=this._nodes.get(t.thrustlineId);if(r&&!this._thrustlines.get(t.thrustlineId)){var i=new d({node:r,principleAxis:(new e.Vector3).fromArray(t.principleAxis),material:this._getMaterialRef(t.materialId)});var a=[];var n=0;var s=0;var o=0;for(var u=0;u<t.itemCount;u++){var l={};l.target=this._nodes.get(t.targets[u]);l.majorAxisIndex=t.itemMajorAxisesIndices[u];var c;l.basisAxises=[];o=n+t.itemBasisAxisesCounts[u];for(c=n;c<o;c++){var h={};h.x=t.itemBasisAxisesCoordinates[c*3];h.y=t.itemBasisAxisesCoordinates[c*3+1];h.z=t.itemBasisAxisesCoordinates[c*3+2];l.basisAxises.push(h)}n=o;l.dimension={};l.dimension.x=t.itemDimensionsCoordinates[u*3];l.dimension.y=t.itemDimensionsCoordinates[u*3+1];l.dimension.z=t.itemDimensionsCoordinates[u*3+2];l.center={};l.center.x=t.itemCentersCoordinates[u*3];l.center.y=t.itemCentersCoordinates[u*3+1];l.center.z=t.itemCentersCoordinates[u*3+2];l.boundPoints=[];o=s+t.itemBoundPointsCounts[u];for(c=s;c<o;c++){var p={};p.x=t.itemBoundPointsCoordinates[c*3];p.y=t.itemBoundPointsCoordinates[c*3+1];p.z=t.itemBoundPointsCoordinates[c*3+2];l.boundPoints.push(p)}s=o;a.push(l)}i.setItems(a);var f=0;var m=[];for(var v=0;v<t.segmentCount;v++){var g={};g.startItemIndex=t.segmentsStartItemIndices[v];g.endItemIndex=t.segmentsEndItemIndices[v];g.startBoundIndex=t.segmentsStartBoundIndices[v];g.endBoundIndex=t.segmentsEndBoundIndices[v];g.ratios=[];o=f+t.segmentRatioCounts[v];for(var y=0;y<o;y++){var _={};_.x=t.segmentRatiosCoordinates[y*2];_.y=t.segmentRatiosCoordinates[y*2+1];g.ratios.push(_)}f=o;m.push(g)}i.setSegments(m);this._thrustlines.set(t.thrustlineId,i);this._addDynamicObject(r,i._update.bind(i),false)}};V.prototype.updateViewsForReplacedNodes=function(e){var t=new Map;e.forEach(function(e){var r=this._nodes.get(e.sid);if(r){t.set(e.sid,r)}},this);function r(e,t){var r=e.getNodeInfos();r.forEach(function(e){var r=e.target;if(r&&r.userData&&r.userData.treeNode&&r.userData.treeNode.sid){var i=t.get(r.userData.treeNode.sid);if(i){e.target=i;i.updateMatrixWorld()}}})}function i(t,r){var i;var a=t.getPlaybacks();for(var n=0;n<a.length;n++){var s=a[n];var o=s.getSequence();if(o){var d=false;var u=o.getNodeAnimation();for(var l=0;l<u.length;l++){var c=u[l];var h=c.nodeRef;if(h&&h.userData&&h.userData.treeNode&&h.userData.treeNode.sid){i=r.get(h.userData.treeNode.sid);if(i){o.removeNodeAnimation(h,null,true);for(var p in c){if(p==="nodeRef"){continue}o.setNodeAnimation(i,p,c[p],true)}d=true}}}var f=o.getJoint();for(var m=0;f&&m<f.length;m++){var v=f[m];if(v.parentSid){i=r.get(v.parentSid);if(i){v.parent=i;d=true}}if(v.nodeSid){i=r.get(v.nodeSid);if(i){v.node=i;d=true}}}if(d){o._fireSequenceChanged()}}}e.forEach(function(e){var t=e.target;if(t&&t.userData&&t.userData.treeNode&&t.userData.treeNode.sid){var i=r.get(t.userData.treeNode.sid);if(i){e.target=i;i.updateMatrixWorld()}}})}this._views.forEach(function(e,a){r(e,t);i(e,t)})};V.prototype._decrementResourceCounters=function(e){e.traverse(function(e){if(e.isMesh){r.decreaseMaterialUsed(e.material);r.decreaseGeometryUsed(e.geometry)}})};V.prototype.decrementResourceCountersForDeletedTreeNode=function(e,t){this._resetCurrentScene(t);var r=this;e=[].concat(e);e.forEach(function(e){var t=r._nodes.get(e);if(t){r._decrementResourceCounters(t);r._nodes.delete(e)}});return this};V.prototype.remove=function(e,t){this._resetCurrentScene(t);var r=this;e=[].concat(e);e.forEach(function(e){var i=r._nodes.get(e);if(i){r._decrementResourceCounters(i);if(i.parent){i.parent.remove(i)}r._nodes.delete(e);var a=false;if(!r._forbiddenTextureUpdate){r._forbiddenTextureUpdate=true;a=true;var n=r._vkScene.getSceneRef().userData;if(n.instanceDataTexture){var s=n.geometryClusters;var o=k.prepareTextureUpdateResults(s?s.length:0,n.textureUpdateResults);k.removeNodeFromClusterRenderingRecursive(i,n.instanceDataTexture.image.data,o);n.textureUpdateResults=o}}for(var d=0;d<i.children.length;d++){var u=i.children[d];if(u.userData&&u.userData.treeNode&&u.userData.treeNode.sid){r.remove(u.userData.treeNode.sid,t)}}if(a){delete r._forbiddenTextureUpdate}}});return this};V.prototype.resourcesCleanUp=function(){var e=this._geometries;e.forEach(function(e){e.forEach(function(e){var t=e.geometry.userData.geometryUsed;if(t<=0){e.dispose()}})});return this};V.prototype.createCamera=function(t,r){this._resetCurrentScene(r);var i=t.near||1;var s=t.far||2e5;if(t.origin.length===3&&t.origin[0]===0&&t.origin[1]===0&&t.origin[2]===0){t.ortho=false;t.rotate=true}var o;if(t.ortho){o=new e.OrthographicCamera(-1,1,1,-1,i,s);o.zoom=t.zoom||-1}else{o=new e.PerspectiveCamera(e.MathUtils.radToDeg(t.fov),1,i,s)}if(t.origin){o.position.fromArray(t.origin)}if(t.up){o.up.fromArray(t.up);if(t.notUseDirectionVector){o.up.sub(o.position)}o.up.normalize()}if(t.rotate){o.userData.rotate=t.rotate;o.up.set(0,1,0)}if(t.target){var d=(new e.Vector3).fromArray(t.target);if(!t.notUseDirectionVector){d.add(o.position)}o.lookAt(d)}this._rootNode.userData.camera=o;var u=null;if(o.isOrthographicCamera){u=new a}else if(o.isPerspectiveCamera){u=new n}u.setCameraRef(o);u.setUsingDefaultClipPlanes(true);var l=t.id;if(l){this._cameras.set(l,u)}this._rootNode.userData.camera=u;return u};V.prototype.insertCamera=function(e,t,r){this._resetCurrentScene(r);var i=this._nodes.get(e);var a=this._cameras.get(t);var n=a&&a.getCameraRef();if(i&&n){(i||this._rootNode).add(n.parent?n.clone():n)}return this};V.prototype.getCamera=function(e){return this._cameras.get(e)};V.prototype.createMaterial=function(t){var r=[];var a=t.id;var n=this._getMaterialRef(a);var s=null;if(t.textureEmissive){if(!n||!n.isMeshBasicMaterial){s=n;n=this._createTemporaryMaterial(a,w.MeshBasicMaterial)}}if(!n){n=this._createTemporaryMaterial(a)}if(t.lineWidth>0){if(t.lineColour){n.color.fromArray(t.lineColour)}n.linewidth=t.lineWidth;n.userData.lineStyle={width:t.lineWidth,haloWidth:t.lineHaloWidth||0,endCapStyle:t.lineEndRound?1:0,dashPattern:t.lineDashPattern||[],dashPatternScale:t.lineDashPatternScale,widthCoordinateSpace:t.lineWidthCoordinateSpace}}delete n.userData.toBeUpdated;n.userData.materialInfo=t;if(t.diffuseColour){n.color.fromArray(t.diffuseColour)}if(t.specularColour&&n.specular){n.specular.fromArray(t.specularColour);if(t.specularLevel){n.specular.multiplyScalar(t.specularLevel)}}var o=true;if(t.emissiveColour){if(n.emissive){n.emissive.fromArray(t.emissiveColour);if(n.emissive.r!==0||n.emissive.g!==0||n.emissive.b!==0){o=false;n.depthFunc=e.LessDepth}}else{n.color.fromArray(t.emissiveColour)}}if(o&&t.ambientColour&&n.emissive){n.emissive.fromArray(t.ambientColour);n.emissive.multiplyScalar(.2)}if(t.opacity!==undefined){n.opacity=t.opacity;n.transparent=t.opacity<.99}var d=t.glossiness?t.glossiness:0;var u=Math.pow(2,d*10)*2;if(u<0){u=0}if(u>128){u=128}n.shininess=u;n.userData.imageIdsToAddAsTexture=new Set;var l,c;if(t.textureDiffuse){c=t.textureDiffuse;l=c[0]||c;n.userData.imageIdsToAddAsTexture.add(l.imageId)}else if(t.textureDecal){c=t.textureDecal;l=c[0]||c;n.userData.imageIdsToAddAsTexture.add(l.imageId)}if(t.textureBump){c=t.textureBump;l=c[0]||c;n.userData.imageIdsToAddAsTexture.add(l.imageId)}if(t.textureEmissive){c=t.textureEmissive;l=c[0]||c;n.userData.imageIdsToAddAsTexture.add(l.imageId)}if(t.textureAmbientOcclusion){c=t.textureAmbientOcclusion;l=c[0]||c;n.userData.imageIdsToAddAsTexture.add(l.imageId)}if(t.textureReflection){c=t.textureReflection;l=c[0]||c;n.userData.imageIdsToAddAsTexture.add(l.imageId)}if(n.userData.imageIdsToAddAsTexture.size===0){delete n.userData.imageIdsToAddAsTexture}r=this.updateTextureMaps(a);if(r.length>0){n.userData.imageIdsToLoad=new Set;for(var h=0;h<r.length;h++){var p=r[h];i.pushElementIntoMapArray(this._imageTextures,p.imageId,{textureType:p.textureType,materialId:a});n.userData.imageIdsToLoad.add(p.imageId)}}var f=this._materialMeshes.get(a);if(f){for(var m=0;m<f.length;m++){var v=f[m];var g=this._meshNodes.get(v);if(g){for(var y=0;y<g.length;y++){this._updateMaterial(g[y],a,n)}}if(s){this._updateMeshSubmeshesMaterial(v,a,n)}}}if(s){k.disposeMaterial(s)}return r};V.prototype.getMaterial=function(e){return this._getMaterialRef(e)};var ae=function(e){var t="";try{var r=32768;var i=0;var a=e.length;var n;while(i<a){n=e.slice(i,Math.min(i+r,a));t+=String.fromCharCode.apply(null,n);i+=r}}catch(e){t=""}return t};V.prototype.createImage=function(e){if(e.binaryData.length<32){t.warning("SceneBuilder.createImage()","Can't create image from empty data");return this}var r=new DataView(e.binaryData.buffer);var i=true;if(r.getUint8(0,true)===parseInt("0xFF",16)&&r.getUint8(1,true)===parseInt("0xD8",16)){i=false}var a=ae(e.binaryData);var n="data:image/"+(i?"png":"jpeg")+";base64,"+btoa(a);this._images.set(e.id,n);var s=this._imageTextures.get(e.id);if(s){this._imageTextures.delete(e.id);for(var o=0;o<s.length;o++){var d=s[o];this.updateTextureMap(d.materialId,d.textureType)}}return this};var ne=new e.TextureLoader;var se={Diffuse:0,Bump:1,Opacity:2,Reflection:3,Refraction:4,Specular:5,Ambient:6,Emissive:7,SpecularLevel:8,Glossiness:9,AmbientOcclusion:10,Decal:11};V.prototype.updateTextureMaps=function(e){var t=[];var r=this._getMaterialRef(e);if(!r){return t}var i=r.userData.materialInfo;if(!i){return t}if(i.textureDiffuse){var a=this.updateTextureMap(e,se.Diffuse);if(a.imageId){t.push(a)}}else if(i.textureDecal){var n=this.updateTextureMap(e,se.Decal);if(n.imageId){t.push(n)}}if(i.textureBump){var s=this.updateTextureMap(e,se.Bump);if(s.imageId){t.push(s)}}if(i.textureEmissive){var o=this.updateTextureMap(e,se.Emissive);if(o.imageId){r[r.emissive?"emissive":"color"].setRGB(1,1,1);t.push(o)}}if(i.textureAmbientOcclusion){var d=this.updateTextureMap(e,se.AmbientOcclusion);if(d.imageId){t.push(d)}}if(i.textureReflection){var u=this.updateTextureMap(e,se.Reflection);if(u.imageId){t.push(u)}}return t};V.prototype.updateTextureMap=function(t,r){var i={textureType:r,imageId:null};var a=this._getMaterialRef(t);if(!a){return i}var n=a.userData.materialInfo;if(!n){return i}var s=null;switch(r){case se.Diffuse:s=n.textureDiffuse;break;case se.Decal:s=n.textureDecal;break;case se.Bump:s=n.textureBump;break;case se.Reflection:s=n.textureReflection;break;case se.Emissive:s=n.textureEmissive;break;case se.AmbientOcclusion:s=n.textureAmbientOcclusion;break;default:break}if(!s){return i}var o=s[0]||s;var d=this._images.get(o.imageId);if(!d){i.imageId=o.imageId;return i}if(a.userData.imageIdsToLoad){a.userData.imageIdsToLoad.delete(o.imageId);if(a.userData.imageIdsToLoad.size===0){delete a.userData.imageIdsToLoad}}if(a.userData.parametricType==="sphere"){o.uvHorizontalScale=-1}var u=o.influence!==undefined?o.influence:0;function l(t,i){switch(r){case se.Diffuse:case se.Decal:t.map=i;if(d.startsWith("data:image/png")){t.transparent=true}break;case se.Bump:t.bumpMap=i;t.bumpScale=u;break;case se.Opacity:t.alphaMap=i;break;case se.Reflection:i.mapping=e.EquirectangularReflectionMapping;t.envMap=i;t.combine=e.AddOperation;t.reflectivity=u;break;case se.Emissive:t[t.emissiveMap!==undefined?"emissiveMap":"map"]=i;if(t.isSphericalMapMaterial){i.minFilter=e.LinearFilter}break;case se.AmbientOcclusion:t.aoMap=i;break;default:}t.needsUpdate=true}ne.load(d,function(r){r.wrapS=o.uvHorizontalTilingEnabled?e.RepeatWrapping:e.ClampToEdgeWrapping;r.wrapT=o.uvVerticalTilingEnabled?e.RepeatWrapping:e.ClampToEdgeWrapping;r.magFilter=o.filterMode===1?e.NearestFilter:e.LinearFilter;r.minFilter=o.filterMode===1?e.NearestFilter:e.LinearMipMapLinearFilter;r.anisotropy=4;var i=o.uvHorizontalOffset||0;var n=o.uvVerticalOffset||0;r.repeat.set(o.uvHorizontalScale||1,o.uvVerticalScale||1);r.center.set(-i,-n);r.offset.set(i,n);r.rotation=-o.uvRotationAngle;if(a.isMeshBasicMaterial){r.generateMipmaps=false;r.minFilter=o.filterMode===1?e.NearestFilter:e.LinearFilter}l(a,r);if(a.userData.imageIdsToAddAsTexture&&o.imageId){a.userData.imageIdsToAddAsTexture.delete(o.imageId);if(a.userData.imageIdsToAddAsTexture.size===0){delete a.userData.imageIdsToAddAsTexture}}var s=this._materialClones.get(t);if(s){s.forEach(function(e){l(e,r)})}this.fireImageAddedToMaterial({materialId:t});if(this._fireSceneUpdated){this._fireSceneUpdated()}}.bind(this));return i};V.prototype.insertPlayback=function(e,t,r){this._resetCurrentScene(r);var a=this._vkScene.findSequence(e.sequenceId);var n=new _(e.id,{sequence:a,timeScale:e.speed?1/e.speed:1,preDelay:e.preDelay?e.preDelay:0,postDelay:e.postDelay?e.postDelay:0,repeats:e.repeat?Math.abs(e.repeat):0,reversed:e.reversed?true:false,startTime:e.start?e.start:0});var s=this._views.get(t);if(s){s.addPlayback(n)}if(!a){i.pushElementIntoMapArray(this._sequenceIdToPlaybacks,e.sequenceId,n)}return this};V.prototype.insertSequence=function(e,t){var r=this._vkScene.findSequence(e.id);if(r){this._vkScene.removeSequence(r)}var a;if(e.endTime){if(e.startTime){a=e.endTime-e.startTime}else{a=e.endTime}}else{a=1}r=this._vkScene.createSequence(e.id,{name:e.name,duration:a});if(Array.isArray(e.joints)){e.joints.forEach(function(e){var t=this._joints[e];if(t){r.setJoint(t,true)}},this)}if(e.nodes&&e.nodes.length>0){for(var n=0;n<e.nodes.length;n++){var s=e.nodes[n];if(s.empty){s.type=s.binding;var o=this._nodes.get(s.sid);this._animationHelper.insertEmptyTrack(s,r,o,this._vkScene);continue}i.pushElementIntoMapArray(this._trackIdSequenceNodeMap,s.trackId,{sequenceId:e.id,targetId:s.sid,type:s.binding,pivot:s.pivot,isAbsoluteValue:s.isAbsoluteValue})}}var d=this._sequenceIdToPlaybacks.get(e.id);if(d){d.forEach(function(e){e.setSequence(r)})}return this};V.prototype.insertTracks=function(e){this._animationHelper.insertTracks(e,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);return this};V.prototype.insertJoints=function(e,t){this._resetCurrentScene(t);this._joints=[];e.forEach(function(e){var t=this._nodes.get(e.childSid);var r=this._nodes.get(e.parentSid);var i={id:e.id,node:t,parent:r,translation:new Float32Array(e.t?e.t:[0,0,0]),quaternion:new Float32Array(e.q?e.q:[0,0,0,1]),scale:new Float32Array(e.s?e.s:[1,1,1])};if(!t){var a=this._jointNodesMap.get(e.childSid);if(!a){a=[]}a.push(i);this._jointNodesMap.set(e.childSid,a)}if(!r){var n=this._jointParentsMap.get(e.parentSid);if(!n){n=[]}n.push(i);this._jointParentsMap.set(e.parentSid,n)}this._joints.push(i)},this);return this};V.prototype.finalizeAnimation=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent}e.userData.tracks=this._tracks}return this};V.prototype.finalizePlaybacks=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent}}else{return this}if(!e.userData.animationNodeOriginalData){e.userData.animationNodeOriginalData=new Map}var t;var r=this._viewGroups.entries();var i=r.next();while(!i.done){t=i.value[1];i=r.next();var a=[];for(var n=0;n<t.getViews().length;n++){if(t.getViews()[n].id){var s=this._views.get(t.getViews()[n].id);if(s){a.push(s)}}}}return this};V.prototype.finalizeViewGroups=function(e){this._resetCurrentScene(e);var t=this._viewGroups.entries();var r=t.next();while(!r.done){var i=r.value[1];var a=r.value[0];if(!i||!i.views||!i.views.length){r=t.next();continue}i.removeViews();for(var n=0;n<i.views.length;n++){var s=i.views[n].id;var o=this._views.get(s);if(o&&o.userData.viewInfo.thumbnailId&&!o.thumbnailData){var d=this._images.get(o.userData.viewInfo.thumbnailId);if(d){o.thumbnailData=d}}if(o){o.viewGroupId=a;i.addView(o)}}r=t.next()}return this};V.prototype.insertViewGroup=function(e,t){this._resetCurrentScene(t);var r=this._viewGroups.get(e.id);if(!r){r=this._vkScene.createViewGroup({viewGroupId:e.id,name:e.name,description:e.description});this._viewGroups.set(e.id,r)}else{r.setViewGroupId(e.id);r.setName(e.name);r.setDescription(e.description)}r.type=e.type;r.metadata=e.metadata;r.veids=e.veids;r.views=e.views;r.sceneId=e.sceneId;return this};V.prototype.getViewGroup=function(e,t){this._resetCurrentScene(t);var r=this._viewGroups.get(e);var i=[];if(r&&r.views){for(var a=0;a<r.views.length;a++){var n=r.views[a].id;var s=this._views.get(n);if(s){i.push(s)}}}return i};var oe={turntable:C.Turntable,orbit:C.Orbit,pan:C.Pan,zoom:C.Zoom};V.prototype.insertView=function(e,t){this._resetCurrentScene(t);var r=e.description;if(r){var i=new RegExp("^<[^>]*?>");if(i.test(r)){var a=new RegExp("(^(<[^>]*?>s*)+)|((<[^>]*?>s*)+$)","g");var n=r.replace(a,"");if(!n){r=n}}r='<pre class="sapThemeVizKitViewGalleryStepDescriptionPre">'+r+"</pre>"}var s=this._views.get(e.viewId);if(s==null){s=this._vkScene.createView({viewId:e.viewId,name:e.name,description:r,aspectRatio:e.safeAreaAspectRatio,autoPlayAnimation:e.autoPlayAnimation,navigationMode:oe[e.navigationMode]||C.NoChange,dimension:e.dimension||3});this._views.set(e.viewId,s)}else{s.removePlaybacks(true);s.setName(e.name);s.setDescription(r);s.setAspectRatio(e.safeAreaAspectRatio);s.setAutoPlayAnimation(e.autoPlayAnimation);s.setNavigationMode(oe[e.navigationMode]||C.NoChange);s.setDimension(e.dimension||3)}s.userData={viewInfo:e};if(e.thumbnailId){var o=this._images.get(e.thumbnailId);if(o){s.thumbnailData=o}else{this._viewThumbnails.set(e.thumbnailId,s)}}if(e.animatedThumbnailId){var d=this._images.get(e.animatedThumbnailId);if(d){s.animatedThumbnailData=d;s.tileWidth=this._imageIdsAndTileWidths.get(e.animatedThumbnailId)}}if(e.cameraId){s.setCamera(this._cameras.get(e.cameraId))}s.type=e.type;s.flyToTime=e.flyToTime;s.preDelay=e.preDelay;s.postDelay=e.postDelay;s.navigationMode=e.navigationMode;var u=this._getSavedColor(e.topColour,localStorage.getItem("color.backgroundTop"));if(u!=null){s.setTopColor(u)}var l=this._getSavedColor(e.bottomColour,localStorage.getItem("color.backgroundBottom"));if(l!=null){s.setBottomColor(l)}s.renderMode=O[e.renderMethod]??S.Default;s.dimension=e.dimension;if(e.showPaperFrame){s.outputSettings=e.outputSettings}s.query=e.query;s.metadata=e.metadata;s.veids=e.veids;s.viewGroupId=e.viewGroupId;s.id=e.viewId;if(s.viewGroupId){var c=this._viewGroups.get(s.viewGroupId);if(c){var h=c.indexOfView(s);if(h<0){c.addView(s)}}}return this};V.prototype.setModelViewVisibilitySet=function(e){var r=this._views.get(e.viewId);var i=new Set;var a=[];e.visibleNodes.forEach(function(e){var r=this._nodes.get(e);if(r){i.add(r);a.push({target:r,visible:true})}else{t.warning("Unknown modelView visible node reference",e)}},this);Array.from(i).forEach(function(e){e=e.parent;while(e&&!i.has(e)){i.add(e);a.push({target:e,visible:true});e=e.parent}});if(r){r.updateNodeInfos(a)}};V.prototype.recordHighlightedNodeInView=function(e,t,r,i){this._resetCurrentScene(i);var a=this._views.get(r);if(!a){return this}var n=this._nodes.get(t);if(!n){return this}a.addHighlightedNodes(e,n);return this};V.prototype.insertHighlightStyle=function(e){var t=this._vkScene.getHighlight(e.id);if(t){return this}if(e.duration>0){if(e.colours&&e.colours.length===1&&(!e.opacities||e.opacities.length===1)){var r=e.colours[0];e.colours.push([r[0],r[1],r[2],0])}else if(!e.colours&&e.opacities&&e.opacities.length===1){e.opacities.push(0)}}this._vkScene.createHighlight(e.id,e);return this};V.prototype.insertModelViewHighlight=function(t){var r=this._views.get(t.viewId);if(r){var i=[];t.highlightNodes.forEach(function(e){var t=this._nodes.get(e);if(t){i.push(t)}else{}},this);var a={duration:t.duration,cycles:t.cycles};if(!t.id){t.id=e.MathUtils.generateUUID().toLowerCase()}var n=new e.Color(t.color1).toArray();var s=new e.Color(t.color2).toArray();n[3]=(t.color1>>>24&255)/255;s[3]=(t.color2>>>24&255)/255;a.colours=[n,s];a.opacities=[e.MathUtils.clamp(t.opacity1,0,1),e.MathUtils.clamp(t.opacity2,0,1)];this._vkScene.createHighlight(t.id,a);r.addHighlightedNodes(t.id,i)}};V.prototype.createThumbnail=function(e){var t=this._viewThumbnails.get(e.imageId);if(t){t.thumbnailData="data:image/"+"jpeg"+";base64,"+window.btoa(String.fromCharCode.apply(null,e.data));if(this._fireThumbnailLoaded){this._fireThumbnailLoaded({modelView:t})}}};V.prototype.highlightStyleExists=function(e){var t=this._vkScene.getHighlight(e);return t!==undefined};V.prototype.getView=function(e,t){this._resetCurrentScene(t);return this._views.get(e)};V.prototype.getSequence=function(e){return this._vkScene.findSequence(e)};V.prototype.setViewCamera=function(e,t,r){this._resetCurrentScene(r);var i=this._cameras.get(e);var a=this._views.get(t);if(i&&a){a.setCamera(i)}return this};V.prototype.setViewNodeInfos=function(e,t,r){this._resetCurrentScene(r);var i=this._views.get(t);i.setNodeInfos(e);return this};V.prototype.setViewThumbnail=function(e,t,r,i){this._resetCurrentScene(r);var a=this._views.get(t);var n=this._images.get(e);if(i){this._imageIdsAndTileWidths.set(e,i)}if(a&&n){if(a.userData!==undefined){if(a.userData.viewInfo.thumbnailId===e){a.thumbnailData=n}else if(a.userData.viewInfo.animatedThumbnailId===e){a.animatedThumbnailData=n;a.tileWidth=i}}}return this};V.prototype.cleanup=function(){this._rootNode?.removeFromParent();this._rootNode=null;this._currentSceneId=null;this._contentResource=null;this._resolve=null;this._reject=null;this._vkScene?.clearUnusedMaterials();this._callouts.forEach(function(e){e.destroy()});this._callouts.clear();this._cameras.forEach(function(t){if(!t instanceof e.Camera){t.destroy()}});this._cameras.clear();this._images.clear();this._imageIdsAndTileWidths.clear();this._imageTextures.clear();this._geometries.clear();this._meshNodes.clear();this._meshSubmeshes.clear();this._geometryProxies.clear();this._geometrySubmeshIndices.clear();this._materialMeshes.clear();this._materialClones.clear();this._joints=[];this._pointCloudGroups=[];this._imageAddedToMaterialHandlers=[];this._isSmallScene=null;this._preprocessedClusterDefinitions=null;this._preprocessedSubmeshToClusterMap=null;if(this._nodes){this._nodes.clear()}if(this._tracks){this._tracks.clear()}if(this._trackIdSequenceNodeMap){this._trackIdSequenceNodeMap.clear()}if(this._viewGroups){this._viewGroups.clear()}if(this._views){this._views.clear()}this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._viewThumbnails.clear();this._thrustlines.clear();this._animations.clear();this._animationTracks.clear();this._jointNodesMap.clear();this._jointParentsMap.clear()};V.prototype.insertAnimationGroup=function(e){var t=this._vkScene.findSequence(e.animationGroupRef.toString());if(!t){var r;if(e.endTime){r=e.endTime-e.startTime;if(!e.startTime){e.startTime=0}}t=this._vkScene.createSequence(e.animationGroupRef.toString(),{name:e.name,duration:r});if(!t.userData){t.userData={}}t.userData.animations=[]}if(e.modelViewRef){var i=this._views.get(e.modelViewRef);if(i){var a=this._vkScene.findSequence(e.animationGroupRef.toString());var n=new _({sequence:a,timeScale:e.playbackSpeed?1/e.playbackSpeed:1,preDelay:e.playbackPreDelay?e.playbackPreDelay:0,postDelay:e.playbackPostDelay?e.playbackPostDelay:0,repeat:e.playbackRepeat?Math.abs(e.playbackRepeat):0,reversed:e.playbackReversed?true:false,startTime:0});i.addPlayback(n)}}};V.prototype.insertAnimation=function(e){var t=this._animations.get(e.animationRef);if(!t){t={};t.type=e.animationType;t.targetRefs=[];t.targetPivots=[];t.sequenceId=e.animationGroupRef.toString();t.trackIds=new Set;t.tracks=[];this._animations.set(e.animationRef,t)}if(e.animationGroupRef){var r=this._vkScene.findSequence(e.animationGroupRef.toString());if(!r.userData.animations.includes(e.animationRef)){r.userData.animations.push(e.animationRef)}}};V.prototype.insertAnimationTarget=function(e){var t=this._animations.get(e.animationRef);if(t){if(!t.targetRefs.includes(e.targetRef)){t.targetRefs.push(e.targetRef);t.targetPivots.push({x:e.targetPivotX,y:e.targetPivotY,z:e.targetPivotZ})}}};V.prototype.insertAnimationTrack=function(e){var t=this._animationTracks.get(e.animationTrackRef);var r=e.animationRef;if(!t){delete e.animationRef;t=e;this._animationTracks.set(e.animationTrackRef,t)}if(!r){return}var a=this._animations.get(r);if(!a||!a.sequenceId){return}if(a.trackIds.has(t.animationTrackRef)){return}a.trackIds.add(t.animationTrackRef);for(var n=0;a.targetRefs&&n<a.targetRefs.length;n++){var s=a.targetRefs[n];var o=a.targetPivots[n];var d=this._nodes.get(s);if(!d){continue}var u;if(o.x!==0||o.y!==0||o.z!==0){u=[o.x,o.y,o.z]}var l=["OPACITY","COLOUR","TRANSLATE","SCALE","ROTATE"][t.type]||"";i.pushElementIntoMapArray(this._trackIdSequenceNodeMap,e.animationTrackRef,{sequenceId:a.sequenceId,targetId:s,type:l,pivot:u,isAbsoluteValue:true});var c={};c.times=Array.prototype.slice.call(t.times);c.values=Array.prototype.slice.call(t.values);c.id=e.animationTrackRef;c.cyclicInfo={};c.cyclicInfo.cyclicStart=t.cyclicStart;c.cyclicInfo.cyclicEnd=t.cyclicEnd;var h;if(a.type===0){if(t.dataType===0){if(t.values.length!==t.keyCount||t.times.length!==t.keyCount){continue}if(t.type===3){c.values=[];for(h=0;h<t.keyCount;h++){c.values.push(t.values[h]);c.values.push(t.values[h]);c.values.push(t.values[h])}}}else if(t.dataType===1||t.dataType===3){if(t.values.length!==3*t.keyCount||t.times.length!==t.keyCount){continue}}else if(t.dataType===4||t.dataType===5||t.dataType===6){if(t.values.length!==4*t.keyCount||t.times.length!==t.keyCount){continue}if(t.dataType===4){c.rotateType=I.AngleAxis}else if(t.dataType===6){c.rotateType=I.Euler}else{c.rotateType=I.Quaternion;for(var p=3;p<c.values.length;p=p+4){c.values[p]=-c.values[p]}}}}a.tracks.push(c)}};V.prototype.setAnimationTracks=function(e){var t=this._animations.get(e);if(t){this._animationHelper.insertTracks(t.tracks,this._trackIdSequenceNodeMap,this._nodes,this._vkScene)}};V.prototype.setAnimationPlaybacks=function(e){var t=this._viewGroups.get(e.viewGroupId);this._animationHelper.setInitialNodePositionsFromSubsequentViews(t.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromPreviousViews(t.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromCurrenetViews(t.getViews(),this._vkScene);this._animationHelper.setPlaybackStartTimes(t.getViews(),this._vkScene);this._animationHelper.buildViewsInitialState(t.getViews(),this._vkScene)};V.prototype.preferMeshes=function(){return true};V.prototype.setParametricContent=function(e,r,i){this._resetCurrentScene(i);const a={sphere:"generateSphere",box:"generateBox",plane:"generatePlane"};const n=r.type;if(n in a===false){t.warning("Attempt to load unknown parametric type: "+n);return}var s=this.getNode(e,this.sceneId);var o=r.materialID;var d=null;if(o){d=this._getMaterialRef(o)||this._createTemporaryMaterial(o);if(s.userData.parametricVisible){d.userData.parametricType=n}}const u=x[a[n]](r,d);if(s.userData.nodeContentType){u.userData.nodeContentType=s.userData.nodeContentType}u.userData.skipIt=true;u.renderOrder=s.renderOrder;s.add(u)};V.prototype.insertFillStyle=function(e){};V.prototype.insertLineStyle=function(e){};V.prototype.insertTextStyle=function(e){};V.prototype.setPointCloudGroups=function(t,r){this._resetCurrentScene(r);const i=this._vkScene.getSceneRef().userData;const a=this._vkScene.getPointCloudGroups();t.forEach(t=>{const n=this.getNode(t.nodeId,r);if(n){const r=n.userData;if(t.items?.length>0){n.material??=new e.MeshPhongMaterial;r.pointCloudGroupId=t.id;r.pcgBoundingBox??=new e.Box3;t.node=n;if(!r.renderGroup){i.currentInstanceIndex??=0;r.renderGroup={instanceIndex:i.currentInstanceIndex,clusterSet:new Set};i._instanceIndexToNodeMap??=new Map;i._instanceIndexToNodeMap.set(i.currentInstanceIndex,n);k.increaseCurrentInstance(i)}const s=t.items.map(e=>{const t=new B(e);t.sequence=parseInt(e.sequence,10);t.type=e.type||0;t.node=n;t.instanceIndex=r.renderGroup.instanceIndex;return t});a.set(n,s)}else{a.delete(n)}}});const n=this._pointCloudGroups=[];a.forEach(e=>{e.forEach(e=>{e.node.userData.renderGroup.clusterSet.clear();n.push(e)})});n.sort((e,t)=>t.sequence-e.sequence);this._geometries.forEach(e=>{e.forEach(e=>{k._updateGeometryClusterInstance(e,n)})})};V.prototype._getSavedColor=function(e,t){if(e&&e.length>2){return R({red:Math.floor(e[0]*255),green:Math.floor(e[1]*255),blue:Math.floor(e[2]*255),alpha:e.length>3?e[3]:1})}else if(t){return t}return undefined};var de=[];V.prototype._computeMeshPriority=function(e,t){de[0]=de[1]=de[2]=Infinity;de[3]=de[4]=de[5]=-Infinity;for(var r=0,i=t.length;r<i;++r){var a=t[r];de[0]=Math.min(de[0],a[0]);de[1]=Math.min(de[1],a[1]);de[2]=Math.min(de[2],a[2]);de[3]=Math.max(de[3],a[3]);de[4]=Math.max(de[4],a[4]);de[5]=Math.max(de[5],a[5])}var n=e[0];var s=n.matrixWorld.getMaxScaleOnAxis();var o=0;var d=0;var u=0;if(de[3]>=de[0]&&de[4]>=de[1]&&de[5]>=de[2]){o=de[3]-de[0];d=de[4]-de[1];u=de[5]-de[2]}var l=o*(d+u)+d*u;return l*s*e.length};V.prototype.bindMarkerNodeTransformationToReferenceNode=function(e,t,r){if(!e||!t){return}var i=this._nodeWithAssocicatedMarkers.get(e);if(i==null){i=new Map;this._nodeWithAssocicatedMarkers.set(e,i)}i.set(t,{coordinateSpace:r});this._markNodeIdsToRefNodeIds.set(t,e)};V.prototype.unbindMarkerNodeTransformationFromReferenceNode=function(e,t){if(!e||!t){return}var r=this._nodeWithAssocicatedMarkers.get(e);if(r==null){return}r.delete(t);this._markNodeIdsToRefNodeIds.delete(t)};V.prototype.getBoundMarkerNodes=function(e){if(!e){return null}return this._nodeWithAssocicatedMarkers.get(e)};V.prototype.getAllNodesWithBoundMarkers=function(){return this._nodeWithAssocicatedMarkers};V.prototype.getReferenceNodeFromMarkerNodeId=function(e){var t=this._markNodeIdsToRefNodeIds.get(e);if(t){return this.getNode(t,this.sceneId)}return null};V.prototype.updateMarkerCoordinateSpace=function(e,t,r){if(!e||!t||!r){return}var i=this._nodeWithAssocicatedMarkers.get(t);if(i==null){return}i.set(r,{coordinateSpace:this._vkScene.PoiCoordinateSpaces.ReferenceNodeSpace})};V.prototype.setSceneMetadata=function(e){if(this._vkScene){this._vkScene.setSceneMetadata(e)}else{this._sceneMetadata=e}};return V});
//# sourceMappingURL=SceneBuilder.js.map