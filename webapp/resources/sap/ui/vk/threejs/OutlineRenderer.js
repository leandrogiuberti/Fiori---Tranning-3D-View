/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/base/Log","./ThreeUtils"],function(e,t,r){"use strict";var a=function(){this._copyMaterial=new e.MeshBasicMaterial({transparent:true,fog:false});this._maskMaterial=new e.MeshBasicMaterial({side:e.DoubleSide,fog:false});this._outlineMaterial=new e.ShaderMaterial({uniforms:{mask:{value:null},offset:{value:new e.Vector2(1,0,0,1)}},vertexShader:["varying vec2 vTC;","void main() {","\tvTC = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["varying vec2 vTC;","uniform sampler2D mask;","uniform vec4 offset;","float delta(vec3 c1,  vec3 c2) {","\tvec3 dc = c1 - c2;","\treturn dot(dc, dc);","}","void main() {","\tvec3 c = texture2D(mask, vTC).rgb;","\tvec3 c1 = texture2D(mask, vTC + offset.xy).rgb;","\tvec3 c2 = texture2D(mask, vTC - offset.xy).rgb;","\tvec3 c3 = texture2D(mask, vTC + offset.zw).rgb;","\tvec3 c4 = texture2D(mask, vTC - offset.yw).rgb;","\tvec4 a = vec4(delta(c, c1), delta(c, c2), delta(c, c3), delta(c, c4));","\tgl_FragColor = vec4(1.0, 1.0, 1.0, sign(dot(a, a)));","}"].join("\n")});this._expandMaterial=new e.ShaderMaterial({uniforms:{mask:{value:null},offset:{value:new e.Vector2(1,0,0,1)}},vertexShader:["varying vec2 vTC;","void main() {","\tvTC = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["varying vec2 vTC;","uniform sampler2D mask;","uniform vec4 offset;","void main() {","\tfloat a = texture2D(mask, vTC).a;","\ta += texture2D(mask, vTC + offset.xy).a;","\ta += texture2D(mask, vTC - offset.xy).a;","\ta += texture2D(mask, vTC + offset.zw).a;","\ta += texture2D(mask, vTC - offset.yw).a;","\tgl_FragColor = vec4(1.0, 1.0, 1.0, a * 0.5);","}"].join("\n")});this._screenCamera=new e.OrthographicCamera(-1,1,1,-1,0,1);this._screenMesh=new e.Mesh(new e.PlaneGeometry(2,2))};a.prototype.render=function(t,r,a,i,s,n,l){if(!i||!i.length){return}var o=t.getSize(new e.Vector2);var v=2;var h=o.width*v;var c=o.height*v;if(!this._renderTarget1||this._renderTarget1.width!==h||this._renderTarget1.height!==c){var f={minFilter:e.NearestFilter,magFilter:e.NearestFilter};this._renderTarget1=new e.WebGLRenderTarget(h,c,f);this._renderTarget1.texture.generateMipmaps=false;this._renderTarget2=new e.WebGLRenderTarget(h,c,f);this._renderTarget2.texture.generateMipmaps=false}var u;var d;if(l){u=new Map;d=new Map;l.forEach(function(e){if(!e.node||!e.parent){return}u.set(e.node,e);if(e.parent){var t=d.get(e.parent)||[];t.push(e);d.set(e.parent,t)}})}var m;var M=new Set;var _=function(e){if(e.isMesh){var t=e;while(t){if(!t.visible){return}t=t.parent}M.add({mesh:e,color:m})}};var g;for(g=0;g<i.length;g++){var p=i[g];m=new e.Color((g+1&255)/255,(g+1>>8&255)/255,(g+1>>16&255)/255);p._vkTraverseNodes(_,u,d)}if(M.size===0){return}var C=new e.Color;t.getClearColor(C);var T=t.getClearAlpha();var x=t.autoClear;t.autoClear=false;t.setClearColor(0,0);var w;var k=this._renderTarget1;var y=this._renderTarget2;t.setRenderTarget(k);t.clear(true,true,false);var D=M.values();var b=D.next();while(!b.done){var S=b.value.mesh;this._maskMaterial.color=b.value.color;b=D.next();w=S.material;S.material=this._maskMaterial;t.render(S,a);S.material=w}var j=new e.Vector4(1/h,0,0,1/c);w=this._outlineMaterial;w.uniforms.mask.value=k.texture;w.uniforms.offset.value=j;this._screenMesh.material=w;t.setRenderTarget(y);t.render(this._screenMesh,this._screenCamera);if(n>1){w=this._expandMaterial;w.uniforms.offset.value=j;this._screenMesh.material=w;for(g=1;g<n;g++){var F=k;k=y;y=F;w.uniforms.mask.value=k.texture;t.setRenderTarget(y);t.render(this._screenMesh,this._screenCamera)}}w=this._copyMaterial;w.map=y.texture;w.color=s;this._screenMesh.material=w;t.setRenderTarget(null);t.render(this._screenMesh,this._screenCamera);t.setClearColor(C,T);t.autoClear=x};a.prototype.dispose=function(){if(this._copyMaterial){r.disposeMaterial(this._copyMaterial);this._copyMaterial=null}if(this._maskMaterial){r.disposeMaterial(this._maskMaterial);this._maskMaterial=null}if(this._outlineMaterial){r.disposeMaterial(this._outlineMaterial);this._outlineMaterial=null}if(this._expandMaterial){r.disposeMaterial(this._expandMaterial);this._expandMaterial=null}if(this._screenMesh){r.disposeObject(this._screenMesh);this._screenMesh=null}};return a});
//# sourceMappingURL=OutlineRenderer.js.map