/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Element","./Core","sap/ui/vk/tools/RedlineTool","./RedlineConversation","sap/ui/vk/uuidv4","sap/ui/vk/RedlineUpgradeManager"],function(e,t,i,n,o,r){"use strict";var s=e.extend("sap.ui.vk.RedlineCollaboration",{metadata:{library:"sap.ui.vk",aggregations:{conversations:{singularName:"conversation",type:"sap.ui.vk.RedlineConversation",multiple:true}},associations:{viewport:{type:"sap.ui.vk.Viewport",multiple:false},activeConversation:{type:"sap.ui.vk.RedlineConversation",multiple:false},activeComment:{type:"sap.ui.vk.RedlineComment",multiple:false}},events:{elementCreated:{parameters:{element:"object"}},elementClicked:{parameters:{elementId:"string"}},elementHovered:{parameters:{elementId:"string"}},conversationActivating:{parameters:{conversation:"sap.ui.vk.RedlineConversation"}},conversationActivated:{parameters:{conversation:"sap.ui.vk.RedlineConversation",viewportLocked:"boolean"}}}},constructor:function(t,i){e.apply(this,arguments);if(typeof t==="object"){i=t;t=undefined}this._elementId=i&&i.elementId?i.elementId:o()}});s.prototype.init=function(){this._header=new Map};s.prototype.exit=function(){if(this._tool){this._tool.setActive(false);this._tool.destroy();this._tool=null}var t=e.getElementById(this.getViewport());if(t){if(t.dettachCameraChanged){t.dettachCameraChanged(this._onCameraChanged,this)}var i=t.getMeasurementSurface();i.detachMeasurementsAdded(this._onmMeasurementsAdded,this);i.detachMeasurementsRemoving(this._onMeasurementsRemoving,this);i.detachScaleChanged(this._onMeasurementsScaleChanged,this)}};s.prototype.getElementId=function(){return this._elementId};s.prototype.setViewport=function(e){this.setAssociation("viewport",e);if(!this._tool){this._tool=new i;this._tool.attachElementCreated(this._onElementCreated,this);this._tool.attachElementClicked(this._onElementClicked,this);this._tool.attachElementHovered(this._onElementHovered,this)}else{this._tool.setActive(false,e)}e.addTool(this._tool);if(e.attachCameraChanged){e.attachCameraChanged(this._onCameraChanged,this)}var t=e.getMeasurementSurface();t?.attachMeasurementsAdded(this._onMeasurementsAdded,this);t?.attachMeasurementsRemoving(this._onMeasurementsRemoving,this);t?.attachScaleChanged(this._onMeasurementsScaleChanged,this);return this};s.prototype._onCameraChanged=function(){const t=e.getElementById(this.getActiveConversation());if(t?.getViewInfo()){t.setViewInfo(this._getViewInfo())}};s.prototype._onMeasurementsAdded=function(t){var i=t.getParameter("measurements");if(this.getActiveConversation()){var n=e.getElementById(this.getActiveConversation());var o;if(this.getActiveComment()){o=e.getElementById(this.getActiveComment())}i.forEach(function(e){var t=e.toJSON();n.addMeasurement(t);if(o){o.addMeasurement(t.id)}},this)}};s.prototype._onMeasurementsRemoving=function(t){var i=t.getParameter("measurements");if(this.getActiveConversation()){var n=e.getElementById(this.getActiveConversation());i.forEach(function(e){var t=e.getId();n.removeMeasurement(t);var i=n.getComments();i.forEach(function(e){e.removeMeasurement(t)})})}};s.prototype._onMeasurementsScaleChanged=function(t){var i=t.getParameter("newScale");if(this.getActiveConversation()){var n=e.getElementById(this.getActiveConversation());n.setMeasurementScale(i)}};s.prototype._onElementHovered=function(e){this.fireElementHovered({elementId:e.getParameter("elementId")})};s.prototype._onElementCreated=function(t){var i=t.getParameter("element");if(i){if(this.getActiveConversation()){var n=e.getElementById(this.getActiveConversation());n.addContent(i);this._tool.destroyRedlineElements();n._activate(this._tool)}if(this.getActiveComment()){var o=e.getElementById(this.getActiveComment());o.addContent(i)}}this.fireElementCreated({element:i})};s.prototype._onElementClicked=function(e){this.fireElementClicked({elementId:e.getParameter("elementId")})};s.prototype.setHeaderProperty=function(e,t){this._header.set(e,t);return this};s.prototype.getHeaderProperty=function(e){return this._header.get(e)};s.prototype.removeHeaderProperty=function(e){this._header.delete(e);return this};s.prototype.createConversation=function(e){var t=new n({conversationName:e});this.addConversation(t);this.setActiveConversation(t);return t};s.prototype.setActiveConversation=function(i,n=true){var o=e.getElementById(this.getActiveConversation());if(o){if(n&&o.getViewInfo()){o.setViewInfo(this._getViewInfo())}o._deactivate()}this.setAssociation("activeConversation",i);var r=e.getElementById(this.getViewport());if(!r){return this}if(!i){this._tool.setActive(false,r);return this}this.fireConversationActivating({conversation:i});this._tool.destroyRedlineElements();if(r.isA("sap.ui.vk.pdf.Viewport")){const e=i.getPageId();if(e>=0){r.setCurrentPageIndex(e)}if(!this._tool.getActive()){this._tool.setActive(true,r)}}else if(i.getViewInfo()){var s=e.getElementById(r.getContentConnector()).getContent();const o=s.getViews().find(e=>e.getViewId()===i.getViewId());if(o&&n){t.getEventBus().subscribe("sap.ui.vk","readyForAnimation",this._readyForAnimation,this);var a=e.getElementById(r.getViewStateManager());var l=e.getElementById(a.getViewManager());this._activatingView=true;if(this._tool.getActive()){this._tool.setActive(false,r)}l.activateView(o,true,true);this._tool.setActive(true,r)}else{if(!this._tool.getActive()){this._tool.setActive(true,r)}r.setViewInfo(i.getViewInfo())}}else if(this._tool.getActive()){this._tool.setActive(false,r)}if(i.getContent()){i._activate(this._tool)}if(i.getMeasurements()){var h=i.getMeasurements();r.getMeasurementSurface()?.fromJSON({measurements:h,scale:i.getMeasurementScale()},true);r.setShouldRenderFrame()}this.fireConversationActivated({conversation:i,viewportLocked:this._tool.getActive()});return this};s.prototype._readyForAnimation=function(){var i=e.getElementById(this.getViewport());if(!i){return}var n=e.getElementById(this.getActiveConversation());if(n){var o=e.getElementById(i.getViewStateManager()).getAnimationPlayer();o.setTime(n.getAnimationOffset());var r=n.getViewInfo();if(i.getCamera()&&i.getCamera().getCameraRef()){var s=i.getCamera().getCameraRef();if(r.camera.view&&s&&!s.view){s.view=r.camera.view;s.view.enabled=true}}i.setViewInfo(r)}this._activatingView=false;t.getEventBus().unsubscribe("sap.ui.vk","readyForAnimation",this._readyForAnimation,this)};s.prototype.createElement=function(t){var i=e.getElementById(this.getActiveConversation());var n=e.getElementById(this.getViewport());if(!n){return t}if(i){if(n.isA("sap.ui.vk.pdf.Viewport")){i.setPageId(n.getCurrentPageIndex())}else if(!i.getViewInfo()){i.setViewId(n.getCurrentView().getViewId());i.setViewInfo(this._getViewInfo());i.setAnimationOffset(e.getElementById(n.getViewStateManager()).getAnimationPlayer().getTime())}}if(!this._tool.getActive()){this._tool.setActive(true,n)}this._tool.startAdding(t);return t};s.prototype.deactivateRedlineDrawing=function(){if(this._tool){this._tool.stopAdding()}return this};s.prototype.removeElement=function(t){var i=e.getElementById(this.getActiveConversation());if(i){i.removeContent(t);this._tool.destroyRedlineElements();i._activate(this._tool)}return this};s.prototype._normalizeElementsArray=function(e){var t=[];var i=this.getActiveRedlineElements();if(Array.isArray(e)){for(var n=0;n<e.length;n++){if(e[n]instanceof sap.ui.vk.RedlineElement){t.push(e[n])}else{for(var o=0;o<i.length;o++){if(e[n]===i[o].getElementId()){t.push(i[o])}}}}}else if(e instanceof sap.ui.vk.RedlineElement){t.push(e)}else{for(var r=0;r<i.length;r++){if(e===i[r].getElementId()){t.push(i[r])}}}return t};s.prototype.setHighlight=function(e,t){if(!e){return this}var i=this._normalizeElementsArray(e);for(var n=0;n<i.length;n++){var o=i[n];o.setHalo(true);if(t){o.setHaloColor(t)}else if(this._tool._haloColor){o.setHaloColor(this._tool._haloColor)}else{o.setHaloColor("rgba(255, 0, 0, 1)")}}this._tool.getGizmo().rerender();return this};s.prototype.setDefaultHighlightColor=function(e){if(e){this._tool._haloColor=e}return this};s.prototype.clearHighlight=function(e){if(!e){return this}var t=this._normalizeElementsArray(e);for(var i=0;i<t.length;i++){t[i].setHalo(false)}this._tool.getGizmo().rerender();return this};s.prototype.addStyleClass=function(e){if(e&&this._tool){this._tool.getGizmo().addStyleClass(e)}return this};s.prototype.removeStyleClass=function(e){if(e&&this._tool){this._tool.getGizmo().removeStyleClass(e)}return this};s.prototype.toggleStyleClass=function(e){if(e&&this._tool){this._tool.getGizmo().toggleStyleClass(e)}return this};s.prototype._getViewInfo=function(){var t=e.getElementById(this.getViewport());if(!t||t.isA("sap.ui.vk.pdf.Viewport")){return null}var i={camera:{matrices:true},visibility:true,selection:true};var n=t.getViewInfo(i);return n};s.prototype.freezeView=function(){var t=e.getElementById(this.getActiveConversation());var i=e.getElementById(this.getViewport());if(!i){return this}if(!this._tool.getActive()){this._tool.setActive(true,i)}if(t){if(i.isA("sap.ui.vk.pdf.Viewport")){t.setPageId(i.getCurrentPageIndex())}else if(!t.getViewInfo()){t.setViewId(i.getCurrentView().getViewId());t.setViewInfo(this._getViewInfo());t.setAnimationOffset(e.getElementById(i.getViewStateManager()).getAnimationPlayer().getTime())}}return this};s.prototype.unfreezeView=function(){var t=e.getElementById(this.getActiveConversation());if(t){var i=t.getComments();if(this._tool.getActive()&&this._tool.getRedlineElements().length===0&&(i.length===0||i.length===1&&!i[0].getText())){this._tool.setActive(false);t.setViewInfo(null)}}return this};s.prototype.getActiveRedlineElements=function(){if(this._tool){var e=this._tool.getRedlineElements();return e}return[]};s.prototype._createConversationFromJSON=function(e){var t=new n;var i=t.importJSON(e);this.addConversation(t);return i};s.prototype.importJSON=function(e){e=r.upgrade(e);var t=new Set;this.setActiveConversation(null);this.destroyConversations();this.setActiveComment(null);var i=Object.entries(e.header);for(var n=0;n<i.length;n++){this.setHeaderProperty(i[n][0],i[n][1])}this._elementId=this.getHeaderProperty("elementId");var o=e.conversations;if(o){for(var s=0;s<o.length;s++){var a=this._createConversationFromJSON(o[s]);a.forEach(t.add,t)}}var l=this.getHeaderProperty("initialConversation");var h=this.getConversations();var v;if(h){for(var g=0;g<h.length;g++){if(h[g].getElementId()===l){v=h[g];break}}}this.setActiveConversation(v);return t};s.prototype.exportJSON=function(){const t=e.getElementById(this.getActiveConversation())?.getElementId()??"";this.setHeaderProperty("initialConversation",t);if(!this.getHeaderProperty("elementId")){this.setHeaderProperty("elementId",this._elementId)}var i={schemaVersion:"1.0",header:Object.fromEntries(this._header),conversations:this.getConversations().map(e=>e.exportJSON())};return i};return s});
//# sourceMappingURL=RedlineCollaboration.js.map