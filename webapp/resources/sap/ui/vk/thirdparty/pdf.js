/**
 * @licstart The following is the entire license notice for the
 * JavaScript code in this page
 *
 * Copyright 2024 Mozilla Foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * @licend The above is the entire license notice for the
 * JavaScript code in this page
 */var __webpack_require__={};(()=>{__webpack_require__.d=(t,e)=>{for(var i in e){if(__webpack_require__.o(e,i)&&!__webpack_require__.o(t,i)){Object.defineProperty(t,i,{enumerable:true,get:e[i]})}}}})();(()=>{__webpack_require__.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e)})();var __webpack_exports__={};const isNodeJS=typeof process==="object"&&process+""==="[object process]"&&!process.versions.nw&&!(process.versions.electron&&process.type&&process.type!=="browser");const FONT_IDENTITY_MATRIX=[.001,0,0,.001,0,0];const LINE_FACTOR=1.35;const LINE_DESCENT_FACTOR=.35;const BASELINE_FACTOR=LINE_DESCENT_FACTOR/LINE_FACTOR;const RenderingIntentFlag={ANY:1,DISPLAY:2,PRINT:4,SAVE:8,ANNOTATIONS_FORMS:16,ANNOTATIONS_STORAGE:32,ANNOTATIONS_DISABLE:64,IS_EDITING:128,OPLIST:256};const AnnotationMode={DISABLE:0,ENABLE:1,ENABLE_FORMS:2,ENABLE_STORAGE:3};const AnnotationEditorPrefix="pdfjs_internal_editor_";const AnnotationEditorType={DISABLE:-1,NONE:0,FREETEXT:3,HIGHLIGHT:9,STAMP:13,INK:15,POPUP:16,SIGNATURE:101,COMMENT:102};const AnnotationEditorParamsType={RESIZE:1,CREATE:2,FREETEXT_SIZE:11,FREETEXT_COLOR:12,FREETEXT_OPACITY:13,INK_COLOR:21,INK_THICKNESS:22,INK_OPACITY:23,HIGHLIGHT_COLOR:31,HIGHLIGHT_THICKNESS:32,HIGHLIGHT_FREE:33,HIGHLIGHT_SHOW_ALL:34,DRAW_STEP:41};const PermissionFlag={PRINT:4,MODIFY_CONTENTS:8,COPY:16,MODIFY_ANNOTATIONS:32,FILL_INTERACTIVE_FORMS:256,COPY_FOR_ACCESSIBILITY:512,ASSEMBLE:1024,PRINT_HIGH_QUALITY:2048};const TextRenderingMode={FILL:0,STROKE:1,FILL_STROKE:2,INVISIBLE:3,FILL_ADD_TO_PATH:4,STROKE_ADD_TO_PATH:5,FILL_STROKE_ADD_TO_PATH:6,ADD_TO_PATH:7,FILL_STROKE_MASK:3,ADD_TO_PATH_FLAG:4};const util_ImageKind={GRAYSCALE_1BPP:1,RGB_24BPP:2,RGBA_32BPP:3};const AnnotationType={TEXT:1,LINK:2,FREETEXT:3,LINE:4,SQUARE:5,CIRCLE:6,POLYGON:7,POLYLINE:8,HIGHLIGHT:9,UNDERLINE:10,SQUIGGLY:11,STRIKEOUT:12,STAMP:13,CARET:14,INK:15,POPUP:16,FILEATTACHMENT:17,SOUND:18,MOVIE:19,WIDGET:20,SCREEN:21,PRINTERMARK:22,TRAPNET:23,WATERMARK:24,THREED:25,REDACT:26};const AnnotationReplyType={GROUP:"Group",REPLY:"R"};const AnnotationFlag={INVISIBLE:1,HIDDEN:2,PRINT:4,NOZOOM:8,NOROTATE:16,NOVIEW:32,READONLY:64,LOCKED:128,TOGGLENOVIEW:256,LOCKEDCONTENTS:512};const AnnotationFieldFlag={READONLY:1,REQUIRED:2,NOEXPORT:4,MULTILINE:4096,PASSWORD:8192,NOTOGGLETOOFF:16384,RADIO:32768,PUSHBUTTON:65536,COMBO:131072,EDIT:262144,SORT:524288,FILESELECT:1048576,MULTISELECT:2097152,DONOTSPELLCHECK:4194304,DONOTSCROLL:8388608,COMB:16777216,RICHTEXT:33554432,RADIOSINUNISON:33554432,COMMITONSELCHANGE:67108864};const AnnotationBorderStyleType={SOLID:1,DASHED:2,BEVELED:3,INSET:4,UNDERLINE:5};const AnnotationActionEventType={E:"Mouse Enter",X:"Mouse Exit",D:"Mouse Down",U:"Mouse Up",Fo:"Focus",Bl:"Blur",PO:"PageOpen",PC:"PageClose",PV:"PageVisible",PI:"PageInvisible",K:"Keystroke",F:"Format",V:"Validate",C:"Calculate"};const DocumentActionEventType={WC:"WillClose",WS:"WillSave",DS:"DidSave",WP:"WillPrint",DP:"DidPrint"};const PageActionEventType={O:"PageOpen",C:"PageClose"};const VerbosityLevel={ERRORS:0,WARNINGS:1,INFOS:5};const OPS={dependency:1,setLineWidth:2,setLineCap:3,setLineJoin:4,setMiterLimit:5,setDash:6,setRenderingIntent:7,setFlatness:8,setGState:9,save:10,restore:11,transform:12,moveTo:13,lineTo:14,curveTo:15,curveTo2:16,curveTo3:17,closePath:18,rectangle:19,stroke:20,closeStroke:21,fill:22,eoFill:23,fillStroke:24,eoFillStroke:25,closeFillStroke:26,closeEOFillStroke:27,endPath:28,clip:29,eoClip:30,beginText:31,endText:32,setCharSpacing:33,setWordSpacing:34,setHScale:35,setLeading:36,setFont:37,setTextRenderingMode:38,setTextRise:39,moveText:40,setLeadingMoveText:41,setTextMatrix:42,nextLine:43,showText:44,showSpacedText:45,nextLineShowText:46,nextLineSetSpacingShowText:47,setCharWidth:48,setCharWidthAndBounds:49,setStrokeColorSpace:50,setFillColorSpace:51,setStrokeColor:52,setStrokeColorN:53,setFillColor:54,setFillColorN:55,setStrokeGray:56,setFillGray:57,setStrokeRGBColor:58,setFillRGBColor:59,setStrokeCMYKColor:60,setFillCMYKColor:61,shadingFill:62,beginInlineImage:63,beginImageData:64,endInlineImage:65,paintXObject:66,markPoint:67,markPointProps:68,beginMarkedContent:69,beginMarkedContentProps:70,endMarkedContent:71,beginCompat:72,endCompat:73,paintFormXObjectBegin:74,paintFormXObjectEnd:75,beginGroup:76,endGroup:77,beginAnnotation:80,endAnnotation:81,paintImageMaskXObject:83,paintImageMaskXObjectGroup:84,paintImageXObject:85,paintInlineImageXObject:86,paintInlineImageXObjectGroup:87,paintImageXObjectRepeat:88,paintImageMaskXObjectRepeat:89,paintSolidColorImageMask:90,constructPath:91,setStrokeTransparent:92,setFillTransparent:93,rawFillPath:94};const DrawOPS={moveTo:0,lineTo:1,curveTo:2,closePath:3};const PasswordResponses={NEED_PASSWORD:1,INCORRECT_PASSWORD:2};let verbosity=VerbosityLevel.WARNINGS;function setVerbosityLevel(t){if(Number.isInteger(t)){verbosity=t}}function getVerbosityLevel(){return verbosity}function info(t){if(verbosity>=VerbosityLevel.INFOS){console.log(`Info: ${t}`)}}function warn(t){if(verbosity>=VerbosityLevel.WARNINGS){console.log(`Warning: ${t}`)}}function unreachable(t){throw new Error(t)}function assert(t,e){if(!t){unreachable(e)}}function _isValidProtocol(t){switch(t?.protocol){case"http:":case"https:":case"ftp:":case"mailto:":case"tel:":return true;default:return false}}function createValidAbsoluteUrl(t,e=null,i=null){if(!t){return null}if(i&&typeof t==="string"){if(i.addDefaultProtocol&&t.startsWith("www.")){const e=t.match(/\./g);if(e?.length>=2){t=`http://${t}`}}if(i.tryConvertEncoding){try{t=stringToUTF8String(t)}catch{}}}const s=e?URL.parse(t,e):URL.parse(t);return _isValidProtocol(s)?s:null}function updateUrlHash(t,e,i=false){const s=URL.parse(t);if(s){s.hash=e;return s.href}if(i&&createValidAbsoluteUrl(t,"http://example.com")){return t.split("#",1)[0]+`${e?`#${e}`:""}`}return""}function shadow(t,e,i,s=false){Object.defineProperty(t,e,{value:i,enumerable:!s,configurable:true,writable:false});return i}const BaseException=function t(){function e(t,e){this.message=t;this.name=e}e.prototype=new Error;e.constructor=e;return e}();class PasswordException extends BaseException{constructor(t,e){super(t,"PasswordException");this.code=e}}class UnknownErrorException extends BaseException{constructor(t,e){super(t,"UnknownErrorException");this.details=e}}class InvalidPDFException extends BaseException{constructor(t){super(t,"InvalidPDFException")}}class ResponseException extends BaseException{constructor(t,e,i){super(t,"ResponseException");this.status=e;this.missing=i}}class FormatError extends BaseException{constructor(t){super(t,"FormatError")}}class AbortException extends BaseException{constructor(t){super(t,"AbortException")}}function bytesToString(t){if(typeof t!=="object"||t?.length===undefined){unreachable("Invalid argument for bytesToString")}const e=t.length;const i=8192;if(e<i){return String.fromCharCode.apply(null,t)}const s=[];for(let n=0;n<e;n+=i){const r=Math.min(n+i,e);const a=t.subarray(n,r);s.push(String.fromCharCode.apply(null,a))}return s.join("")}function stringToBytes(t){if(typeof t!=="string"){unreachable("Invalid argument for stringToBytes")}const e=t.length;const i=new Uint8Array(e);for(let s=0;s<e;++s){i[s]=t.charCodeAt(s)&255}return i}function string32(t){return String.fromCharCode(t>>24&255,t>>16&255,t>>8&255,t&255)}function objectSize(t){return Object.keys(t).length}function isLittleEndian(){const t=new Uint8Array(4);t[0]=1;const e=new Uint32Array(t.buffer,0,1);return e[0]===1}function isEvalSupported(){try{new Function("");return true}catch{return false}}class util_FeatureTest{static get isLittleEndian(){return shadow(this,"isLittleEndian",isLittleEndian())}static get isEvalSupported(){return shadow(this,"isEvalSupported",isEvalSupported())}static get isOffscreenCanvasSupported(){return shadow(this,"isOffscreenCanvasSupported",typeof OffscreenCanvas!=="undefined")}static get isImageDecoderSupported(){return shadow(this,"isImageDecoderSupported",typeof ImageDecoder!=="undefined")}static get platform(){const{platform:t,userAgent:e}=navigator;return shadow(this,"platform",{isAndroid:e.includes("Android"),isLinux:t.includes("Linux"),isMac:t.includes("Mac"),isWindows:t.includes("Win"),isFirefox:e.includes("Firefox")})}static get isCSSRoundSupported(){return shadow(this,"isCSSRoundSupported",globalThis.CSS?.supports?.("width: round(1.5px, 1px)"))}}const hexNumbers=Array.from(Array(256).keys(),t=>t.toString(16).padStart(2,"0"));class Util{static makeHexColor(t,e,i){return`#${hexNumbers[t]}${hexNumbers[e]}${hexNumbers[i]}`}static domMatrixToTransform(t){return[t.a,t.b,t.c,t.d,t.e,t.f]}static scaleMinMax(t,e){let i;if(t[0]){if(t[0]<0){i=e[0];e[0]=e[2];e[2]=i}e[0]*=t[0];e[2]*=t[0];if(t[3]<0){i=e[1];e[1]=e[3];e[3]=i}e[1]*=t[3];e[3]*=t[3]}else{i=e[0];e[0]=e[1];e[1]=i;i=e[2];e[2]=e[3];e[3]=i;if(t[1]<0){i=e[1];e[1]=e[3];e[3]=i}e[1]*=t[1];e[3]*=t[1];if(t[2]<0){i=e[0];e[0]=e[2];e[2]=i}e[0]*=t[2];e[2]*=t[2]}e[0]+=t[4];e[1]+=t[5];e[2]+=t[4];e[3]+=t[5]}static transform(t,e){return[t[0]*e[0]+t[2]*e[1],t[1]*e[0]+t[3]*e[1],t[0]*e[2]+t[2]*e[3],t[1]*e[2]+t[3]*e[3],t[0]*e[4]+t[2]*e[5]+t[4],t[1]*e[4]+t[3]*e[5]+t[5]]}static multiplyByDOMMatrix(t,e){return[t[0]*e.a+t[2]*e.b,t[1]*e.a+t[3]*e.b,t[0]*e.c+t[2]*e.d,t[1]*e.c+t[3]*e.d,t[0]*e.e+t[2]*e.f+t[4],t[1]*e.e+t[3]*e.f+t[5]]}static applyTransform(t,e,i=0){const s=t[i];const n=t[i+1];t[i]=s*e[0]+n*e[2]+e[4];t[i+1]=s*e[1]+n*e[3]+e[5]}static applyTransformToBezier(t,e,i=0){const s=e[0];const n=e[1];const r=e[2];const a=e[3];const o=e[4];const l=e[5];for(let e=0;e<6;e+=2){const h=t[i+e];const c=t[i+e+1];t[i+e]=h*s+c*r+o;t[i+e+1]=h*n+c*a+l}}static applyInverseTransform(t,e){const i=t[0];const s=t[1];const n=e[0]*e[3]-e[1]*e[2];t[0]=(i*e[3]-s*e[2]+e[2]*e[5]-e[4]*e[3])/n;t[1]=(-i*e[1]+s*e[0]+e[4]*e[1]-e[5]*e[0])/n}static axialAlignedBoundingBox(t,e,i){const s=e[0];const n=e[1];const r=e[2];const a=e[3];const o=e[4];const l=e[5];const h=t[0];const c=t[1];const d=t[2];const u=t[3];let p=s*h+o;let g=p;let f=s*d+o;let m=f;let b=a*c+l;let A=b;let y=a*u+l;let w=y;if(n!==0||r!==0){const t=n*h;const e=n*d;const i=r*c;const s=r*u;p+=i;m+=i;f+=s;g+=s;b+=t;w+=t;y+=e;A+=e}i[0]=Math.min(i[0],p,f,g,m);i[1]=Math.min(i[1],b,y,A,w);i[2]=Math.max(i[2],p,f,g,m);i[3]=Math.max(i[3],b,y,A,w)}static inverseTransform(t){const e=t[0]*t[3]-t[1]*t[2];return[t[3]/e,-t[1]/e,-t[2]/e,t[0]/e,(t[2]*t[5]-t[4]*t[3])/e,(t[4]*t[1]-t[5]*t[0])/e]}static singularValueDecompose2dScale(t,e){const i=t[0];const s=t[1];const n=t[2];const r=t[3];const a=i**2+s**2;const o=i*n+s*r;const l=n**2+r**2;const h=(a+l)/2;const c=Math.sqrt(h**2-(a*l-o**2));e[0]=Math.sqrt(h+c||1);e[1]=Math.sqrt(h-c||1)}static normalizeRect(t){const e=t.slice(0);if(t[0]>t[2]){e[0]=t[2];e[2]=t[0]}if(t[1]>t[3]){e[1]=t[3];e[3]=t[1]}return e}static intersect(t,e){const i=Math.max(Math.min(t[0],t[2]),Math.min(e[0],e[2]));const s=Math.min(Math.max(t[0],t[2]),Math.max(e[0],e[2]));if(i>s){return null}const n=Math.max(Math.min(t[1],t[3]),Math.min(e[1],e[3]));const r=Math.min(Math.max(t[1],t[3]),Math.max(e[1],e[3]));if(n>r){return null}return[i,n,s,r]}static pointBoundingBox(t,e,i){i[0]=Math.min(i[0],t);i[1]=Math.min(i[1],e);i[2]=Math.max(i[2],t);i[3]=Math.max(i[3],e)}static rectBoundingBox(t,e,i,s,n){n[0]=Math.min(n[0],t,i);n[1]=Math.min(n[1],e,s);n[2]=Math.max(n[2],t,i);n[3]=Math.max(n[3],e,s)}static#t(t,e,i,s,n,r,a,o,l,h){if(l<=0||l>=1){return}const c=1-l;const d=l*l;const u=d*l;const p=c*(c*(c*t+3*l*e)+3*d*i)+u*s;const g=c*(c*(c*n+3*l*r)+3*d*a)+u*o;h[0]=Math.min(h[0],p);h[1]=Math.min(h[1],g);h[2]=Math.max(h[2],p);h[3]=Math.max(h[3],g)}static#e(t,e,i,s,n,r,a,o,l,h,c,d){if(Math.abs(l)<1e-12){if(Math.abs(h)>=1e-12){this.#t(t,e,i,s,n,r,a,o,-c/h,d)}return}const u=h**2-4*c*l;if(u<0){return}const p=Math.sqrt(u);const g=2*l;this.#t(t,e,i,s,n,r,a,o,(-h+p)/g,d);this.#t(t,e,i,s,n,r,a,o,(-h-p)/g,d)}static bezierBoundingBox(t,e,i,s,n,r,a,o,l){l[0]=Math.min(l[0],t,a);l[1]=Math.min(l[1],e,o);l[2]=Math.max(l[2],t,a);l[3]=Math.max(l[3],e,o);this.#e(t,i,n,a,e,s,r,o,3*(-t+3*(i-n)+a),6*(t-2*i+n),3*(i-t),l);this.#e(t,i,n,a,e,s,r,o,3*(-e+3*(s-r)+o),6*(e-2*s+r),3*(s-e),l)}}const PDFStringTranslateTable=null&&[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,728,711,710,729,733,731,730,732,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8226,8224,8225,8230,8212,8211,402,8260,8249,8250,8722,8240,8222,8220,8221,8216,8217,8218,8482,64257,64258,321,338,352,376,381,305,322,339,353,382,0,8364];function stringToPDFString(t,e=false){if(t[0]>="Ã¯"){let i;if(t[0]==="Ã¾"&&t[1]==="Ã¿"){i="utf-16be";if(t.length%2===1){t=t.slice(0,-1)}}else if(t[0]==="Ã¿"&&t[1]==="Ã¾"){i="utf-16le";if(t.length%2===1){t=t.slice(0,-1)}}else if(t[0]==="Ã¯"&&t[1]==="Â»"&&t[2]==="Â¿"){i="utf-8"}if(i){try{const s=new TextDecoder(i,{fatal:true});const n=stringToBytes(t);const r=s.decode(n);if(e||!r.includes("")){return r}return r.replaceAll(/\x1b[^\x1b]*(?:\x1b|$)/g,"")}catch(t){warn(`stringToPDFString: "${t}".`)}}}const i=[];for(let s=0,n=t.length;s<n;s++){const r=t.charCodeAt(s);if(!e&&r===27){while(++s<n&&t.charCodeAt(s)!==27){}continue}const a=PDFStringTranslateTable[r];i.push(a?String.fromCharCode(a):t.charAt(s))}return i.join("")}function stringToUTF8String(t){return decodeURIComponent(escape(t))}function utf8StringToString(t){return unescape(encodeURIComponent(t))}function isArrayEqual(t,e){if(t.length!==e.length){return false}for(let i=0,s=t.length;i<s;i++){if(t[i]!==e[i]){return false}}return true}function getModificationDate(t=new Date){if(!(t instanceof Date)){t=new Date(t)}const e=[t.getUTCFullYear().toString(),(t.getUTCMonth()+1).toString().padStart(2,"0"),t.getUTCDate().toString().padStart(2,"0"),t.getUTCHours().toString().padStart(2,"0"),t.getUTCMinutes().toString().padStart(2,"0"),t.getUTCSeconds().toString().padStart(2,"0")];return e.join("")}let NormalizeRegex=null;let NormalizationMap=null;function normalizeUnicode(t){if(!NormalizeRegex){NormalizeRegex=/([\u00a0\u00b5\u037e\u0eb3\u2000-\u200a\u202f\u2126\ufb00-\ufb04\ufb06\ufb20-\ufb36\ufb38-\ufb3c\ufb3e\ufb40-\ufb41\ufb43-\ufb44\ufb46-\ufba1\ufba4-\ufba9\ufbae-\ufbb1\ufbd3-\ufbdc\ufbde-\ufbe7\ufbea-\ufbf8\ufbfc-\ufbfd\ufc00-\ufc5d\ufc64-\ufcf1\ufcf5-\ufd3d\ufd88\ufdf4\ufdfa-\ufdfb\ufe71\ufe77\ufe79\ufe7b\ufe7d]+)|(\ufb05+)/gu;NormalizationMap=new Map([["ï¬…","Å¿t"]])}return t.replaceAll(NormalizeRegex,(t,e,i)=>e?e.normalize("NFKC"):NormalizationMap.get(i))}function getUuid(){if(typeof crypto.randomUUID==="function"){return crypto.randomUUID()}const t=new Uint8Array(32);crypto.getRandomValues(t);return bytesToString(t)}const AnnotationPrefix="pdfjs_internal_id_";function _isValidExplicitDest(t,e,i){if(!Array.isArray(i)||i.length<2){return false}const[s,n,...r]=i;if(!t(s)&&!Number.isInteger(s)){return false}if(!e(n)){return false}const a=r.length;let o=true;switch(n.name){case"XYZ":if(a<2||a>3){return false}break;case"Fit":case"FitB":return a===0;case"FitH":case"FitBH":case"FitV":case"FitBV":if(a>1){return false}break;case"FitR":if(a!==4){return false}o=false;break;default:return false}for(const t of r){if(typeof t==="number"||o&&t===null){continue}return false}return true}function MathClamp(t,e,i){return Math.min(Math.max(t,e),i)}function toHexUtil(t){if(Uint8Array.prototype.toHex){return t.toHex()}return Array.from(t,t=>hexNumbers[t]).join("")}function toBase64Util(t){if(Uint8Array.prototype.toBase64){return t.toBase64()}return btoa(bytesToString(t))}function fromBase64Util(t){if(Uint8Array.fromBase64){return Uint8Array.fromBase64(t)}return stringToBytes(atob(t))}if(typeof Promise.try!=="function"){Promise.try=function(t,...e){return new Promise(i=>{i(t(...e))})}}if(typeof Math.sumPrecise!=="function"){Math.sumPrecise=function(t){return t.reduce((t,e)=>t+e,0)}}const SVG_NS="http://www.w3.org/2000/svg";class PixelsPerInch{static CSS=96;static PDF=72;static PDF_TO_CSS_UNITS=this.CSS/this.PDF}async function fetchData(t,e="text"){if(isValidFetchUrl(t,document.baseURI)){const i=await fetch(t);if(!i.ok){throw new Error(i.statusText)}switch(e){case"arraybuffer":return i.arrayBuffer();case"blob":return i.blob();case"json":return i.json()}return i.text()}return new Promise((i,s)=>{const n=new XMLHttpRequest;n.open("GET",t,true);n.responseType=e;n.onreadystatechange=()=>{if(n.readyState!==XMLHttpRequest.DONE){return}if(n.status===200||n.status===0){switch(e){case"arraybuffer":case"blob":case"json":i(n.response);return}i(n.responseText);return}s(new Error(n.statusText))};n.send(null)})}class PageViewport{constructor({viewBox:t,userUnit:e,scale:i,rotation:s,offsetX:n=0,offsetY:r=0,dontFlip:a=false}){this.viewBox=t;this.userUnit=e;this.scale=i;this.rotation=s;this.offsetX=n;this.offsetY=r;i*=e;const o=(t[2]+t[0])/2;const l=(t[3]+t[1])/2;let h,c,d,u;s%=360;if(s<0){s+=360}switch(s){case 180:h=-1;c=0;d=0;u=1;break;case 90:h=0;c=1;d=1;u=0;break;case 270:h=0;c=-1;d=-1;u=0;break;case 0:h=1;c=0;d=0;u=-1;break;default:throw new Error("PageViewport: Invalid rotation, must be a multiple of 90 degrees.")}if(a){d=-d;u=-u}let p,g;let f,m;if(h===0){p=Math.abs(l-t[1])*i+n;g=Math.abs(o-t[0])*i+r;f=(t[3]-t[1])*i;m=(t[2]-t[0])*i}else{p=Math.abs(o-t[0])*i+n;g=Math.abs(l-t[1])*i+r;f=(t[2]-t[0])*i;m=(t[3]-t[1])*i}this.transform=[h*i,c*i,d*i,u*i,p-h*i*o-d*i*l,g-c*i*o-u*i*l];this.width=f;this.height=m}get rawDims(){const t=this.viewBox;return shadow(this,"rawDims",{pageWidth:t[2]-t[0],pageHeight:t[3]-t[1],pageX:t[0],pageY:t[1]})}clone({scale:t=this.scale,rotation:e=this.rotation,offsetX:i=this.offsetX,offsetY:s=this.offsetY,dontFlip:n=false}={}){return new PageViewport({viewBox:this.viewBox.slice(),userUnit:this.userUnit,scale:t,rotation:e,offsetX:i,offsetY:s,dontFlip:n})}convertToViewportPoint(t,e){const i=[t,e];Util.applyTransform(i,this.transform);return i}convertToViewportRectangle(t){const e=[t[0],t[1]];Util.applyTransform(e,this.transform);const i=[t[2],t[3]];Util.applyTransform(i,this.transform);return[e[0],e[1],i[0],i[1]]}convertToPdfPoint(t,e){const i=[t,e];Util.applyInverseTransform(i,this.transform);return i}}class RenderingCancelledException extends BaseException{constructor(t,e=0){super(t,"RenderingCancelledException");this.extraDelay=e}}function isDataScheme(t){const e=t.length;let i=0;while(i<e&&t[i].trim()===""){i++}return t.substring(i,i+5).toLowerCase()==="data:"}function isPdfFile(t){return typeof t==="string"&&/\.pdf$/i.test(t)}function getFilenameFromUrl(t){[t]=t.split(/[#?]/,1);return t.substring(t.lastIndexOf("/")+1)}function getPdfFilenameFromUrl(t,e="document.pdf"){if(typeof t!=="string"){return e}if(isDataScheme(t)){warn('getPdfFilenameFromUrl: ignore "data:"-URL for performance reasons.');return e}const i=t=>{try{return new URL(t)}catch{try{return new URL(decodeURIComponent(t))}catch{try{return new URL(t,"https://foo.bar")}catch{try{return new URL(decodeURIComponent(t),"https://foo.bar")}catch{return null}}}}};const s=i(t);if(!s){return e}const n=t=>{try{let e=decodeURIComponent(t);if(e.includes("/")){e=e.split("/").at(-1);if(e.test(/^\.pdf$/i)){return e}return t}return e}catch{return t}};const r=/\.pdf$/i;const a=s.pathname.split("/").at(-1);if(r.test(a)){return n(a)}if(s.searchParams.size>0){const t=Array.from(s.searchParams.values()).reverse();for(const e of t){if(r.test(e)){return n(e)}}const e=Array.from(s.searchParams.keys()).reverse();for(const t of e){if(r.test(t)){return n(t)}}}if(s.hash){const t=/[^/?#=]+\.pdf\b(?!.*\.pdf\b)/i;const e=t.exec(s.hash);if(e){return n(e[0])}}return e}class StatTimer{started=Object.create(null);times=[];time(t){if(t in this.started){warn(`Timer is already running for ${t}`)}this.started[t]=Date.now()}timeEnd(t){if(!(t in this.started)){warn(`Timer has not been started for ${t}`)}this.times.push({name:t,start:this.started[t],end:Date.now()});delete this.started[t]}toString(){const t=[];let e=0;for(const{name:t}of this.times){e=Math.max(t.length,e)}for(const{name:i,start:s,end:n}of this.times){t.push(`${i.padEnd(e)} ${n-s}ms\n`)}return t.join("")}}function isValidFetchUrl(t,e){const i=e?URL.parse(t,e):URL.parse(t);return i?.protocol==="http:"||i?.protocol==="https:"}function noContextMenu(t){t.preventDefault()}function stopEvent(t){t.preventDefault();t.stopPropagation()}function deprecated(t){console.log("Deprecated API usage: "+t)}class PDFDateString{static#i;static toDateObject(t){if(t instanceof Date){return t}if(!t||typeof t!=="string"){return null}this.#i||=new RegExp("^D:"+"(\\d{4})"+"(\\d{2})?"+"(\\d{2})?"+"(\\d{2})?"+"(\\d{2})?"+"(\\d{2})?"+"([Z|+|-])?"+"(\\d{2})?"+"'?"+"(\\d{2})?"+"'?");const e=this.#i.exec(t);if(!e){return null}const i=parseInt(e[1],10);let s=parseInt(e[2],10);s=s>=1&&s<=12?s-1:0;let n=parseInt(e[3],10);n=n>=1&&n<=31?n:1;let r=parseInt(e[4],10);r=r>=0&&r<=23?r:0;let a=parseInt(e[5],10);a=a>=0&&a<=59?a:0;let o=parseInt(e[6],10);o=o>=0&&o<=59?o:0;const l=e[7]||"Z";let h=parseInt(e[8],10);h=h>=0&&h<=23?h:0;let c=parseInt(e[9],10)||0;c=c>=0&&c<=59?c:0;if(l==="-"){r+=h;a+=c}else if(l==="+"){r-=h;a-=c}return new Date(Date.UTC(i,s,n,r,a,o))}}function getXfaPageViewport(t,{scale:e=1,rotation:i=0}){const{width:s,height:n}=t.attributes.style;const r=[0,0,parseInt(s),parseInt(n)];return new PageViewport({viewBox:r,userUnit:1,scale:e,rotation:i})}function getRGB(t){if(t.startsWith("#")){const e=parseInt(t.slice(1),16);return[(e&16711680)>>16,(e&65280)>>8,e&255]}if(t.startsWith("rgb(")){return t.slice(4,-1).split(",").map(t=>parseInt(t))}if(t.startsWith("rgba(")){return t.slice(5,-1).split(",").map(t=>parseInt(t)).slice(0,3)}warn(`Not a valid color format: "${t}"`);return[0,0,0]}function getColorValues(t){const e=document.createElement("span");e.style.visibility="hidden";e.style.colorScheme="only light";document.body.append(e);for(const i of t.keys()){e.style.color=i;const s=window.getComputedStyle(e).color;t.set(i,getRGB(s))}e.remove()}function getCurrentTransform(t){const{a:e,b:i,c:s,d:n,e:r,f:a}=t.getTransform();return[e,i,s,n,r,a]}function getCurrentTransformInverse(t){const{a:e,b:i,c:s,d:n,e:r,f:a}=t.getTransform().invertSelf();return[e,i,s,n,r,a]}function setLayerDimensions(t,e,i=false,s=true){if(e instanceof PageViewport){const{pageWidth:s,pageHeight:n}=e.rawDims;const{style:r}=t;const a=util_FeatureTest.isCSSRoundSupported;const o=`var(--total-scale-factor) * ${s}px`,l=`var(--total-scale-factor) * ${n}px`;const h=a?`round(down, ${o}, var(--scale-round-x))`:`calc(${o})`,c=a?`round(down, ${l}, var(--scale-round-y))`:`calc(${l})`;if(!i||e.rotation%180===0){r.width=h;r.height=c}else{r.width=c;r.height=h}}if(s){t.setAttribute("data-main-rotation",e.rotation)}}class OutputScale{constructor(){const{pixelRatio:t}=OutputScale;this.sx=t;this.sy=t}get scaled(){return this.sx!==1||this.sy!==1}get symmetric(){return this.sx===this.sy}limitCanvas(t,e,i,s,n=-1){let r=Infinity,a=Infinity,o=Infinity;i=OutputScale.capPixels(i,n);if(i>0){r=Math.sqrt(i/(t*e))}if(s!==-1){a=s/t;o=s/e}const l=Math.min(r,a,o);if(this.sx>l||this.sy>l){this.sx=l;this.sy=l;return true}return false}static get pixelRatio(){return globalThis.devicePixelRatio||1}static capPixels(t,e){if(e>=0){const i=Math.ceil(window.screen.availWidth*window.screen.availHeight*this.pixelRatio**2*(1+e/100));return t>0?Math.min(t,i):i}return t}}const SupportedImageMimeTypes=["image/apng","image/avif","image/bmp","image/gif","image/jpeg","image/png","image/svg+xml","image/webp","image/x-icon"];class EditorToolbar{#s=null;#n=null;#r;#a=null;#o=null;#l=null;#h=null;static#c=null;constructor(t){this.#r=t;EditorToolbar.#c||=Object.freeze({freetext:"pdfjs-editor-remove-freetext-button",highlight:"pdfjs-editor-remove-highlight-button",ink:"pdfjs-editor-remove-ink-button",stamp:"pdfjs-editor-remove-stamp-button",signature:"pdfjs-editor-remove-signature-button"})}render(){const t=this.#s=document.createElement("div");t.classList.add("editToolbar","hidden");t.setAttribute("role","toolbar");const e=this.#r._uiManager._signal;if(e instanceof AbortSignal&&!e.aborted){t.addEventListener("contextmenu",noContextMenu,{signal:e});t.addEventListener("pointerdown",EditorToolbar.#d,{signal:e})}const i=this.#a=document.createElement("div");i.className="buttons";t.append(i);const s=this.#r.toolbarPosition;if(s){const{style:e}=t;const i=this.#r._uiManager.direction==="ltr"?1-s[0]:s[0];e.insetInlineEnd=`${100*i}%`;e.top=`calc(${100*s[1]}% + var(--editor-toolbar-vert-offset))`}return t}get div(){return this.#s}static#d(t){t.stopPropagation()}#u(t){this.#r._focusEventsAllowed=false;stopEvent(t)}#p(t){this.#r._focusEventsAllowed=true;stopEvent(t)}#g(t){const e=this.#r._uiManager._signal;if(!(e instanceof AbortSignal)||e.aborted){return false}t.addEventListener("focusin",this.#u.bind(this),{capture:true,signal:e});t.addEventListener("focusout",this.#p.bind(this),{capture:true,signal:e});t.addEventListener("contextmenu",noContextMenu,{signal:e});return true}hide(){this.#s.classList.add("hidden");this.#n?.hideDropdown()}show(){this.#s.classList.remove("hidden");this.#o?.shown();this.#l?.shown()}addDeleteButton(){const{editorType:t,_uiManager:e}=this.#r;const i=document.createElement("button");i.classList.add("basic","deleteButton");i.tabIndex=0;i.setAttribute("data-l10n-id",EditorToolbar.#c[t]);if(this.#g(i)){i.addEventListener("click",t=>{e.delete()},{signal:e._signal})}this.#a.append(i)}get#f(){const t=document.createElement("div");t.className="divider";return t}async addAltText(t){const e=await t.render();this.#g(e);this.#a.append(e,this.#f);this.#o=t}addComment(t){if(this.#l){return}const e=t.render();if(!e){return}this.#g(e);this.#a.append(e,this.#f);this.#l=t;t.toolbar=this}addColorPicker(t){if(this.#n){return}this.#n=t;const e=t.renderButton();this.#g(e);this.#a.append(e,this.#f)}async addEditSignatureButton(t){const e=this.#h=await t.renderEditButton(this.#r);this.#g(e);this.#a.append(e,this.#f)}async addButton(t,e){switch(t){case"colorPicker":this.addColorPicker(e);break;case"altText":await this.addAltText(e);break;case"editSignature":await this.addEditSignatureButton(e);break;case"delete":this.addDeleteButton();break;case"comment":this.addComment(e);break}}updateEditSignatureButton(t){if(this.#h){this.#h.title=t}}remove(){this.#s.remove();this.#n?.destroy();this.#n=null}}class FloatingToolbar{#a=null;#s=null;#m;constructor(t){this.#m=t}#b(){const t=this.#s=document.createElement("div");t.className="editToolbar";t.setAttribute("role","toolbar");const e=this.#m._signal;if(e instanceof AbortSignal&&!e.aborted){t.addEventListener("contextmenu",noContextMenu,{signal:e})}const i=this.#a=document.createElement("div");i.className="buttons";t.append(i);if(this.#m.hasCommentManager()){this.#A("commentButton",`pdfjs-comment-floating-button`,"pdfjs-comment-floating-button-label",()=>{this.#m.commentSelection("floating_button")})}this.#A("highlightButton",`pdfjs-highlight-floating-button1`,"pdfjs-highlight-floating-button-label",()=>{this.#m.highlightSelection("floating_button")});return t}#y(t,e){let i=0;let s=0;for(const n of t){const t=n.y+n.height;if(t<i){continue}const r=n.x+(e?n.width:0);if(t>i){s=r;i=t;continue}if(e){if(r>s){s=r}}else if(r<s){s=r}}return[e?1-s:s,i]}show(t,e,i){const[s,n]=this.#y(e,i);const{style:r}=this.#s||=this.#b();t.append(this.#s);r.insetInlineEnd=`${100*s}%`;r.top=`calc(${100*n}% + var(--editor-toolbar-vert-offset))`}hide(){this.#s.remove()}#A(t,e,i,s){const n=document.createElement("button");n.classList.add("basic",t);n.tabIndex=0;n.setAttribute("data-l10n-id",e);const r=document.createElement("span");n.append(r);r.className="visuallyHidden";r.setAttribute("data-l10n-id",i);const a=this.#m._signal;if(a instanceof AbortSignal&&!a.aborted){n.addEventListener("contextmenu",noContextMenu,{signal:a});n.addEventListener("click",s,{signal:a})}this.#a.append(n)}}function bindEvents(t,e,i){for(const s of i){e.addEventListener(s,t[s].bind(t))}}class IdManager{#w=0;get id(){return`${AnnotationEditorPrefix}${this.#w++}`}}class ImageManager{#E=getUuid();#w=0;#v=null;static get _isSVGFittingCanvas(){const t=`data:image/svg+xml;charset=UTF-8,<svg viewBox="0 0 1 1" width="1" height="1" xmlns="http://www.w3.org/2000/svg"><rect width="1" height="1" style="fill:red;"/></svg>`;const e=new OffscreenCanvas(1,3);const i=e.getContext("2d",{willReadFrequently:true});const s=new Image;s.src=t;const n=s.decode().then(()=>{i.drawImage(s,0,0,1,1,0,0,1,3);return new Uint32Array(i.getImageData(0,0,1,1).data.buffer)[0]===0});return shadow(this,"_isSVGFittingCanvas",n)}async#x(t,e){this.#v||=new Map;let i=this.#v.get(t);if(i===null){return null}if(i?.bitmap){i.refCounter+=1;return i}try{i||={bitmap:null,id:`image_${this.#E}_${this.#w++}`,refCounter:0,isSvg:false};let t;if(typeof e==="string"){i.url=e;t=await fetchData(e,"blob")}else if(e instanceof File){t=i.file=e}else if(e instanceof Blob){t=e}if(t.type==="image/svg+xml"){const e=ImageManager._isSVGFittingCanvas;const s=new FileReader;const n=new Image;const r=new Promise((t,r)=>{n.onload=()=>{i.bitmap=n;i.isSvg=true;t()};s.onload=async()=>{const t=i.svgUrl=s.result;n.src=await e?`${t}#svgView(preserveAspectRatio(none))`:t};n.onerror=s.onerror=r});s.readAsDataURL(t);await r}else{i.bitmap=await createImageBitmap(t)}i.refCounter=1}catch(t){warn(t);i=null}this.#v.set(t,i);if(i){this.#v.set(i.id,i)}return i}async getFromFile(t){const{lastModified:e,name:i,size:s,type:n}=t;return this.#x(`${e}_${i}_${s}_${n}`,t)}async getFromUrl(t){return this.#x(t,t)}async getFromBlob(t,e){const i=await e;return this.#x(t,i)}async getFromId(t){this.#v||=new Map;const e=this.#v.get(t);if(!e){return null}if(e.bitmap){e.refCounter+=1;return e}if(e.file){return this.getFromFile(e.file)}if(e.blobPromise){const{blobPromise:t}=e;delete e.blobPromise;return this.getFromBlob(e.id,t)}return this.getFromUrl(e.url)}getFromCanvas(t,e){this.#v||=new Map;let i=this.#v.get(t);if(i?.bitmap){i.refCounter+=1;return i}const s=new OffscreenCanvas(e.width,e.height);const n=s.getContext("2d");n.drawImage(e,0,0);i={bitmap:s.transferToImageBitmap(),id:`image_${this.#E}_${this.#w++}`,refCounter:1,isSvg:false};this.#v.set(t,i);this.#v.set(i.id,i);return i}getSvgUrl(t){const e=this.#v.get(t);if(!e?.isSvg){return null}return e.svgUrl}deleteId(t){this.#v||=new Map;const e=this.#v.get(t);if(!e){return}e.refCounter-=1;if(e.refCounter!==0){return}const{bitmap:i}=e;if(!e.url&&!e.file){const t=new OffscreenCanvas(i.width,i.height);const s=t.getContext("bitmaprenderer");s.transferFromImageBitmap(i);e.blobPromise=t.convertToBlob()}i.close?.();e.bitmap=null}isValidId(t){return t.startsWith(`image_${this.#E}_`)}}class CommandManager{#_=[];#T=false;#S;#C=-1;constructor(t=128){this.#S=t}add({cmd:t,undo:e,post:i,mustExec:s,type:n=NaN,overwriteIfSameType:r=false,keepUndo:a=false}){if(s){t()}if(this.#T){return}const o={cmd:t,undo:e,post:i,type:n};if(this.#C===-1){if(this.#_.length>0){this.#_.length=0}this.#C=0;this.#_.push(o);return}if(r&&this.#_[this.#C].type===n){if(a){o.undo=this.#_[this.#C].undo}this.#_[this.#C]=o;return}const l=this.#C+1;if(l===this.#S){this.#_.splice(0,1)}else{this.#C=l;if(l<this.#_.length){this.#_.splice(l)}}this.#_.push(o)}undo(){if(this.#C===-1){return}this.#T=true;const{undo:t,post:e}=this.#_[this.#C];t();e?.();this.#T=false;this.#C-=1}redo(){if(this.#C<this.#_.length-1){this.#C+=1;this.#T=true;const{cmd:t,post:e}=this.#_[this.#C];t();e?.();this.#T=false}}hasSomethingToUndo(){return this.#C!==-1}hasSomethingToRedo(){return this.#C<this.#_.length-1}cleanType(t){if(this.#C===-1){return}for(let e=this.#C;e>=0;e--){if(this.#_[e].type!==t){this.#_.splice(e+1,this.#C-e);this.#C=e;return}}this.#_.length=0;this.#C=-1}destroy(){this.#_=null}}class KeyboardManager{constructor(t){this.buffer=[];this.callbacks=new Map;this.allKeys=new Set;const{isMac:e}=util_FeatureTest.platform;for(const[i,s,n={}]of t){for(const t of i){const i=t.startsWith("mac+");if(e&&i){this.callbacks.set(t.slice(4),{callback:s,options:n});this.allKeys.add(t.split("+").at(-1))}else if(!e&&!i){this.callbacks.set(t,{callback:s,options:n});this.allKeys.add(t.split("+").at(-1))}}}}#D(t){if(t.altKey){this.buffer.push("alt")}if(t.ctrlKey){this.buffer.push("ctrl")}if(t.metaKey){this.buffer.push("meta")}if(t.shiftKey){this.buffer.push("shift")}this.buffer.push(t.key);const e=this.buffer.join("+");this.buffer.length=0;return e}exec(t,e){if(!this.allKeys.has(e.key)){return}const i=this.callbacks.get(this.#D(e));if(!i){return}const{callback:s,options:{bubbles:n=false,args:r=[],checker:a=null}}=i;if(a&&!a(t,e)){return}s.bind(t,...r,e)();if(!n){stopEvent(e)}}}class ColorManager{static _colorsMapping=new Map([["CanvasText",[0,0,0]],["Canvas",[255,255,255]]]);get _colors(){const t=new Map([["CanvasText",null],["Canvas",null]]);getColorValues(t);return shadow(this,"_colors",t)}convert(t){const e=getRGB(t);if(!window.matchMedia("(forced-colors: active)").matches){return e}for(const[t,i]of this._colors){if(i.every((t,i)=>t===e[i])){return ColorManager._colorsMapping.get(t)}}return e}getHexCode(t){const e=this._colors.get(t);if(!e){return t}return Util.makeHexColor(...e)}}class AnnotationEditorUIManager{#M=new AbortController;#I=null;#P=null;#k=new Map;#R=new Map;#L=null;#F=null;#O=null;#N=new CommandManager;#B=null;#H=null;#U=null;#G=0;#z=new Set;#W=null;#$=null;#V=new Set;_editorUndoBar=null;#j=false;#K=false;#X=false;#q=null;#Y=null;#J=null;#Q=null;#Z=false;#tt=null;#et=new IdManager;#it=false;#st=false;#nt=false;#rt=null;#at=null;#ot=null;#lt=null;#ht=null;#ct=AnnotationEditorType.NONE;#dt=new Set;#ut=null;#pt=null;#gt=null;#ft=null;#mt=null;#bt={isEditing:false,isEmpty:true,hasSomethingToUndo:false,hasSomethingToRedo:false,hasSelectedEditor:false,hasSelectedText:false};#At=[0,0];#yt=null;#wt=null;#Et=null;#vt=null;#xt=null;static TRANSLATE_SMALL=1;static TRANSLATE_BIG=10;static get _keyboardManager(){const t=AnnotationEditorUIManager.prototype;const e=t=>t.#wt.contains(document.activeElement)&&document.activeElement.tagName!=="BUTTON"&&t.hasSomethingToControl();const i=(t,{target:e})=>{if(e instanceof HTMLInputElement){const{type:t}=e;return t!=="text"&&t!=="number"}return true};const s=this.TRANSLATE_SMALL;const n=this.TRANSLATE_BIG;return shadow(this,"_keyboardManager",new KeyboardManager([[["ctrl+a","mac+meta+a"],t.selectAll,{checker:i}],[["ctrl+z","mac+meta+z"],t.undo,{checker:i}],[["ctrl+y","ctrl+shift+z","mac+meta+shift+z","ctrl+shift+Z","mac+meta+shift+Z"],t.redo,{checker:i}],[["Backspace","alt+Backspace","ctrl+Backspace","shift+Backspace","mac+Backspace","mac+alt+Backspace","mac+ctrl+Backspace","Delete","ctrl+Delete","shift+Delete","mac+Delete"],t.delete,{checker:i}],[["Enter","mac+Enter"],t.addNewEditorFromKeyboard,{checker:(t,{target:e})=>!(e instanceof HTMLButtonElement)&&t.#wt.contains(e)&&!t.isEnterHandled}],[[" ","mac+ "],t.addNewEditorFromKeyboard,{checker:(t,{target:e})=>!(e instanceof HTMLButtonElement)&&t.#wt.contains(document.activeElement)}],[["Escape","mac+Escape"],t.unselectAll],[["ArrowLeft","mac+ArrowLeft"],t.translateSelectedEditors,{args:[-s,0],checker:e}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],t.translateSelectedEditors,{args:[-n,0],checker:e}],[["ArrowRight","mac+ArrowRight"],t.translateSelectedEditors,{args:[s,0],checker:e}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],t.translateSelectedEditors,{args:[n,0],checker:e}],[["ArrowUp","mac+ArrowUp"],t.translateSelectedEditors,{args:[0,-s],checker:e}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],t.translateSelectedEditors,{args:[0,-n],checker:e}],[["ArrowDown","mac+ArrowDown"],t.translateSelectedEditors,{args:[0,s],checker:e}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],t.translateSelectedEditors,{args:[0,n],checker:e}]]))}constructor(t,e,i,s,n,r,a,o,l,h,c,d,u,p,g,f){const m=this._signal=this.#M.signal;this.#wt=t;this.#Et=e;this.#vt=i;this.#L=s;this.#B=n;this.#pt=r;this.#mt=o;this._eventBus=a;a._on("editingaction",this.onEditingAction.bind(this),{signal:m});a._on("pagechanging",this.onPageChanging.bind(this),{signal:m});a._on("scalechanging",this.onScaleChanging.bind(this),{signal:m});a._on("rotationchanging",this.onRotationChanging.bind(this),{signal:m});a._on("setpreference",this.onSetPreference.bind(this),{signal:m});a._on("switchannotationeditorparams",t=>this.updateParams(t.type,t.value),{signal:m});window.addEventListener("pointerdown",()=>{this.#st=true},{capture:true,signal:m});window.addEventListener("pointerup",()=>{this.#st=false},{capture:true,signal:m});this.#_t();this.#Tt();this.#St();this.#F=o.annotationStorage;this.#q=o.filterFactory;this.#gt=l;this.#Q=h||null;this.#j=c;this.#K=d;this.#X=u;this.#ht=p||null;this.viewParameters={realScale:PixelsPerInch.PDF_TO_CSS_UNITS,rotation:0};this.isShiftKeyDown=false;this._editorUndoBar=g||null;this._supportsPinchToZoom=f!==false}destroy(){this.#xt?.resolve();this.#xt=null;this.#M?.abort();this.#M=null;this._signal=null;for(const t of this.#R.values()){t.destroy()}this.#R.clear();this.#k.clear();this.#V.clear();this.#lt?.clear();this.#I=null;this.#dt.clear();this.#N.destroy();this.#L?.destroy();this.#B?.destroy();this.#pt?.destroy();this.#tt?.hide();this.#tt=null;this.#ot?.destroy();this.#ot=null;this.#P=null;if(this.#Y){clearTimeout(this.#Y);this.#Y=null}if(this.#yt){clearTimeout(this.#yt);this.#yt=null}this._editorUndoBar?.destroy();this.#mt=null}combinedSignal(t){return AbortSignal.any([this._signal,t.signal])}get mlManager(){return this.#ht}get useNewAltTextFlow(){return this.#K}get useNewAltTextWhenAddingImage(){return this.#X}get hcmFilter(){return shadow(this,"hcmFilter",this.#gt?this.#q.addHCMFilter(this.#gt.foreground,this.#gt.background):"none")}get direction(){return shadow(this,"direction",getComputedStyle(this.#wt).direction)}get _highlightColors(){return shadow(this,"_highlightColors",this.#Q?new Map(this.#Q.split(",").map(t=>{t=t.split("=").map(t=>t.trim());t[1]=t[1].toUpperCase();return t})):null)}get highlightColors(){const{_highlightColors:t}=this;if(!t){return shadow(this,"highlightColors",null)}const e=new Map;const i=!!this.#gt;for(const[s,n]of t){const t=s.endsWith("_HCM");if(i&&t){e.set(s.replace("_HCM",""),n);continue}if(!i&&!t){e.set(s,n)}}return shadow(this,"highlightColors",e)}get highlightColorNames(){return shadow(this,"highlightColorNames",this.highlightColors?new Map(Array.from(this.highlightColors,t=>t.reverse())):null)}getNonHCMColor(t){if(!this._highlightColors){return t}const e=this.highlightColorNames.get(t);return this._highlightColors.get(e)||t}getNonHCMColorName(t){return this.highlightColorNames.get(t)||t}setCurrentDrawingSession(t){if(t){this.unselectAll();this.disableUserSelect(true)}else{this.disableUserSelect(false)}this.#U=t}setMainHighlightColorPicker(t){this.#ot=t}editAltText(t,e=false){this.#L?.editAltText(this,t,e)}hasCommentManager(){return!!this.#B}editComment(t,e){this.#B?.open(this,t,e)}getSignature(t){this.#pt?.getSignature({uiManager:this,editor:t})}get signatureManager(){return this.#pt}switchToMode(t,e){this._eventBus.on("annotationeditormodechanged",e,{once:true,signal:this._signal});this._eventBus.dispatch("showannotationeditorui",{source:this,mode:t})}setPreference(t,e){this._eventBus.dispatch("setpreference",{source:this,name:t,value:e})}onSetPreference({name:t,value:e}){switch(t){case"enableNewAltTextWhenAddingImage":this.#X=e;break}}onPageChanging({pageNumber:t}){this.#G=t-1}focusMainContainer(){this.#wt.focus()}findParent(t,e){for(const i of this.#R.values()){const{x:s,y:n,width:r,height:a}=i.div.getBoundingClientRect();if(t>=s&&t<=s+r&&e>=n&&e<=n+a){return i}}return null}disableUserSelect(t=false){this.#Et.classList.toggle("noUserSelect",t)}addShouldRescale(t){this.#V.add(t)}removeShouldRescale(t){this.#V.delete(t)}onScaleChanging({scale:t}){this.commitOrRemove();this.viewParameters.realScale=t*PixelsPerInch.PDF_TO_CSS_UNITS;for(const t of this.#V){t.onScaleChanging()}this.#U?.onScaleChanging()}onRotationChanging({pagesRotation:t}){this.commitOrRemove();this.viewParameters.rotation=t}#Ct({anchorNode:t}){return t.nodeType===Node.TEXT_NODE?t.parentElement:t}#Dt(t){const{currentLayer:e}=this;if(e.hasTextLayer(t)){return e}for(const e of this.#R.values()){if(e.hasTextLayer(t)){return e}}return null}highlightSelection(t="",e=false){const i=document.getSelection();if(!i||i.isCollapsed){return}const{anchorNode:s,anchorOffset:n,focusNode:r,focusOffset:a}=i;const o=i.toString();const l=this.#Ct(i);const h=l.closest(".textLayer");const c=this.getSelectionBoxes(h);if(!c){return}i.empty();const d=this.#Dt(h);const u=this.#ct===AnnotationEditorType.NONE;const p=()=>{const i=d?.createAndAddNewEditor({x:0,y:0},false,{methodOfCreation:t,boxes:c,anchorNode:s,anchorOffset:n,focusNode:r,focusOffset:a,text:o});if(u){this.showAllEditors("highlight",true,true)}if(e){i?.editComment()}};if(u){this.switchToMode(AnnotationEditorType.HIGHLIGHT,p);return}p()}commentSelection(t=""){this.highlightSelection(t,true)}#Mt(){const t=document.getSelection();if(!t||t.isCollapsed){return}const e=this.#Ct(t);const i=e.closest(".textLayer");const s=this.getSelectionBoxes(i);if(!s){return}this.#tt||=new FloatingToolbar(this);this.#tt.show(i,s,this.direction==="ltr")}addToAnnotationStorage(t){if(!t.isEmpty()&&this.#F&&!this.#F.has(t.id)){this.#F.setValue(t.id,t)}}a11yAlert(t,e=null){const i=this.#vt;if(!i){return}i.setAttribute("data-l10n-id",t);if(e){i.setAttribute("data-l10n-args",JSON.stringify(e))}else{i.removeAttribute("data-l10n-args")}}#It(){const t=document.getSelection();if(!t||t.isCollapsed){if(this.#ut){this.#tt?.hide();this.#ut=null;this.#Pt({hasSelectedText:false})}return}const{anchorNode:e}=t;if(e===this.#ut){return}const i=this.#Ct(t);const s=i.closest(".textLayer");if(!s){if(this.#ut){this.#tt?.hide();this.#ut=null;this.#Pt({hasSelectedText:false})}return}this.#tt?.hide();this.#ut=e;this.#Pt({hasSelectedText:true});if(this.#ct!==AnnotationEditorType.HIGHLIGHT&&this.#ct!==AnnotationEditorType.NONE){return}if(this.#ct===AnnotationEditorType.HIGHLIGHT){this.showAllEditors("highlight",true,true)}this.#Z=this.isShiftKeyDown;if(!this.isShiftKeyDown){const t=this.#ct===AnnotationEditorType.HIGHLIGHT?this.#Dt(s):null;t?.toggleDrawing();if(this.#st){const e=new AbortController;const i=this.combinedSignal(e);const s=i=>{if(i.type==="pointerup"&&i.button!==0){return}e.abort();t?.toggleDrawing(true);if(i.type==="pointerup"){this.#kt("main_toolbar")}};window.addEventListener("pointerup",s,{signal:i});window.addEventListener("blur",s,{signal:i})}else{t?.toggleDrawing(true);this.#kt("main_toolbar")}}}#kt(t=""){if(this.#ct===AnnotationEditorType.HIGHLIGHT){this.highlightSelection(t)}else if(this.#j){this.#Mt()}}#_t(){document.addEventListener("selectionchange",this.#It.bind(this),{signal:this._signal})}#Rt(){if(this.#J){return}this.#J=new AbortController;const t=this.combinedSignal(this.#J);window.addEventListener("focus",this.focus.bind(this),{signal:t});window.addEventListener("blur",this.blur.bind(this),{signal:t})}#Lt(){this.#J?.abort();this.#J=null}blur(){this.isShiftKeyDown=false;if(this.#Z){this.#Z=false;this.#kt("main_toolbar")}if(!this.hasSelection){return}const{activeElement:t}=document;for(const e of this.#dt){if(e.div.contains(t)){this.#at=[e,t];e._focusEventsAllowed=false;break}}}focus(){if(!this.#at){return}const[t,e]=this.#at;this.#at=null;e.addEventListener("focusin",()=>{t._focusEventsAllowed=true},{once:true,signal:this._signal});e.focus()}#St(){if(this.#rt){return}this.#rt=new AbortController;const t=this.combinedSignal(this.#rt);window.addEventListener("keydown",this.keydown.bind(this),{signal:t});window.addEventListener("keyup",this.keyup.bind(this),{signal:t})}#Ft(){this.#rt?.abort();this.#rt=null}#Ot(){if(this.#H){return}this.#H=new AbortController;const t=this.combinedSignal(this.#H);document.addEventListener("copy",this.copy.bind(this),{signal:t});document.addEventListener("cut",this.cut.bind(this),{signal:t});document.addEventListener("paste",this.paste.bind(this),{signal:t})}#Nt(){this.#H?.abort();this.#H=null}#Tt(){const t=this._signal;document.addEventListener("dragover",this.dragOver.bind(this),{signal:t});document.addEventListener("drop",this.drop.bind(this),{signal:t})}addEditListeners(){this.#St();this.#Ot()}removeEditListeners(){this.#Ft();this.#Nt()}dragOver(t){for(const{type:e}of t.dataTransfer.items){for(const i of this.#$){if(i.isHandlingMimeForPasting(e)){t.dataTransfer.dropEffect="copy";t.preventDefault();return}}}}drop(t){for(const e of t.dataTransfer.items){for(const i of this.#$){if(i.isHandlingMimeForPasting(e.type)){i.paste(e,this.currentLayer);t.preventDefault();return}}}}copy(t){t.preventDefault();this.#I?.commitOrRemove();if(!this.hasSelection){return}const e=[];for(const t of this.#dt){const i=t.serialize(true);if(i){e.push(i)}}if(e.length===0){return}t.clipboardData.setData("application/pdfjs",JSON.stringify(e))}cut(t){this.copy(t);this.delete()}async paste(t){t.preventDefault();const{clipboardData:e}=t;for(const t of e.items){for(const e of this.#$){if(e.isHandlingMimeForPasting(t.type)){e.paste(t,this.currentLayer);return}}}let i=e.getData("application/pdfjs");if(!i){return}try{i=JSON.parse(i)}catch(t){warn(`paste: "${t.message}".`);return}if(!Array.isArray(i)){return}this.unselectAll();const s=this.currentLayer;try{const t=[];for(const e of i){const i=await s.deserialize(e);if(!i){return}t.push(i)}const e=()=>{for(const e of t){this.#Bt(e)}this.#Ht(t)};const n=()=>{for(const e of t){e.remove()}};this.addCommands({cmd:e,undo:n,mustExec:true})}catch(t){warn(`paste: "${t.message}".`)}}keydown(t){if(!this.isShiftKeyDown&&t.key==="Shift"){this.isShiftKeyDown=true}if(this.#ct!==AnnotationEditorType.NONE&&!this.isEditorHandlingKeyboard){AnnotationEditorUIManager._keyboardManager.exec(this,t)}}keyup(t){if(this.isShiftKeyDown&&t.key==="Shift"){this.isShiftKeyDown=false;if(this.#Z){this.#Z=false;this.#kt("main_toolbar")}}}onEditingAction({name:t}){switch(t){case"undo":case"redo":case"delete":case"selectAll":this[t]();break;case"highlightSelection":this.highlightSelection("context_menu");break;case"commentSelection":this.commentSelection("context_menu");break}}#Pt(t){const e=Object.entries(t).some(([t,e])=>this.#bt[t]!==e);if(e){this._eventBus.dispatch("annotationeditorstateschanged",{source:this,details:Object.assign(this.#bt,t)});if(this.#ct===AnnotationEditorType.HIGHLIGHT&&t.hasSelectedEditor===false){this.#Ut([[AnnotationEditorParamsType.HIGHLIGHT_FREE,true]])}}}#Ut(t){this._eventBus.dispatch("annotationeditorparamschanged",{source:this,details:t})}setEditingState(t){if(t){this.#Rt();this.#Ot();this.#Pt({isEditing:this.#ct!==AnnotationEditorType.NONE,isEmpty:this.#Gt(),hasSomethingToUndo:this.#N.hasSomethingToUndo(),hasSomethingToRedo:this.#N.hasSomethingToRedo(),hasSelectedEditor:false})}else{this.#Lt();this.#Nt();this.#Pt({isEditing:false});this.disableUserSelect(false)}}registerEditorTypes(t){if(this.#$){return}this.#$=t;for(const t of this.#$){this.#Ut(t.defaultPropertiesToUpdate)}}getId(){return this.#et.id}get currentLayer(){return this.#R.get(this.#G)}getLayer(t){return this.#R.get(t)}get currentPageIndex(){return this.#G}addLayer(t){this.#R.set(t.pageIndex,t);if(this.#it){t.enable()}else{t.disable()}}removeLayer(t){this.#R.delete(t.pageIndex)}async updateMode(t,e=null,i=false,s=false,n=false){if(this.#ct===t){return}if(this.#xt){await this.#xt.promise;if(!this.#xt){return}}this.#xt=Promise.withResolvers();this.#U?.commitOrRemove();if(this.#ct===AnnotationEditorType.POPUP){this.#B?.hideSidebar()}this.#ct=t;if(t===AnnotationEditorType.NONE){this.setEditingState(false);this.#zt();this._editorUndoBar?.hide();this.#xt.resolve();return}if(t===AnnotationEditorType.SIGNATURE){await(this.#pt?.loadSignatures())}if(t===AnnotationEditorType.POPUP){this.#P||=await this.#mt.getAnnotationsByType(new Set(this.#$.map(t=>t._editorType)));this.#B?.showSidebar(this.#P)}this.setEditingState(true);await this.#Wt();this.unselectAll();for(const e of this.#R.values()){e.updateMode(t)}if(!e){if(i){this.addNewEditorFromKeyboard()}this.#xt.resolve();return}for(const t of this.#k.values()){if(t.annotationElementId===e||t.id===e){this.setSelected(t);if(n){t.editComment()}else if(s){t.enterInEditMode()}}else{t.unselect()}}this.#xt.resolve()}addNewEditorFromKeyboard(){if(this.currentLayer.canCreateNewEmptyEditor()){this.currentLayer.addNewEditor()}}updateToolbar(t){if(t.mode===this.#ct){return}this._eventBus.dispatch("switchannotationeditormode",{source:this,...t})}updateParams(t,e){if(!this.#$){return}switch(t){case AnnotationEditorParamsType.CREATE:this.currentLayer.addNewEditor(e);return;case AnnotationEditorParamsType.HIGHLIGHT_SHOW_ALL:this._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:{type:"highlight",action:"toggle_visibility"}}});(this.#ft||=new Map).set(t,e);this.showAllEditors("highlight",e);break}if(this.hasSelection){for(const i of this.#dt){i.updateParams(t,e)}}else{for(const i of this.#$){i.updateDefaultParams(t,e)}}}showAllEditors(t,e,i=false){for(const i of this.#k.values()){if(i.editorType===t){i.show(e)}}const s=this.#ft?.get(AnnotationEditorParamsType.HIGHLIGHT_SHOW_ALL)??true;if(s!==e){this.#Ut([[AnnotationEditorParamsType.HIGHLIGHT_SHOW_ALL,e]])}}enableWaiting(t=false){if(this.#nt===t){return}this.#nt=t;for(const e of this.#R.values()){if(t){e.disableClick()}else{e.enableClick()}e.div.classList.toggle("waiting",t)}}async#Wt(){if(!this.#it){this.#it=true;const t=[];for(const e of this.#R.values()){t.push(e.enable())}await Promise.all(t);for(const t of this.#k.values()){t.enable()}}}#zt(){this.unselectAll();if(this.#it){this.#it=false;for(const t of this.#R.values()){t.disable()}for(const t of this.#k.values()){t.disable()}}}getEditors(t){const e=[];for(const i of this.#k.values()){if(i.pageIndex===t){e.push(i)}}return e}getEditor(t){return this.#k.get(t)}addEditor(t){this.#k.set(t.id,t)}removeEditor(t){if(t.div.contains(document.activeElement)){if(this.#Y){clearTimeout(this.#Y)}this.#Y=setTimeout(()=>{this.focusMainContainer();this.#Y=null},0)}this.#k.delete(t.id);if(t.annotationElementId){this.#lt?.delete(t.annotationElementId)}this.unselect(t);if(!t.annotationElementId||!this.#z.has(t.annotationElementId)){this.#F?.remove(t.id)}}addDeletedAnnotationElement(t){this.#z.add(t.annotationElementId);this.addChangedExistingAnnotation(t);t.deleted=true}isDeletedAnnotationElement(t){return this.#z.has(t)}removeDeletedAnnotationElement(t){this.#z.delete(t.annotationElementId);this.removeChangedExistingAnnotation(t);t.deleted=false}#Bt(t){const e=this.#R.get(t.pageIndex);if(e){e.addOrRebuild(t)}else{this.addEditor(t);this.addToAnnotationStorage(t)}}setActiveEditor(t){if(this.#I===t){return}this.#I=t;if(t){this.#Ut(t.propertiesToUpdate)}}get#$t(){let t=null;for(t of this.#dt){}return t}updateUI(t){if(this.#$t===t){this.#Ut(t.propertiesToUpdate)}}updateUIForDefaultProperties(t){this.#Ut(t.defaultPropertiesToUpdate)}toggleSelected(t){if(this.#dt.has(t)){this.#dt.delete(t);t.unselect();this.#Pt({hasSelectedEditor:this.hasSelection});return}this.#dt.add(t);t.select();this.#Ut(t.propertiesToUpdate);this.#Pt({hasSelectedEditor:true})}setSelected(t){this.updateToolbar({mode:t.mode,editId:t.id});this.#U?.commitOrRemove();for(const e of this.#dt){if(e!==t){e.unselect()}}this.#dt.clear();this.#dt.add(t);t.select();this.#Ut(t.propertiesToUpdate);this.#Pt({hasSelectedEditor:true})}isSelected(t){return this.#dt.has(t)}get firstSelectedEditor(){return this.#dt.values().next().value}unselect(t){t.unselect();this.#dt.delete(t);this.#Pt({hasSelectedEditor:this.hasSelection})}get hasSelection(){return this.#dt.size!==0}get isEnterHandled(){return this.#dt.size===1&&this.firstSelectedEditor.isEnterHandled}undo(){this.#N.undo();this.#Pt({hasSomethingToUndo:this.#N.hasSomethingToUndo(),hasSomethingToRedo:true,isEmpty:this.#Gt()});this._editorUndoBar?.hide()}redo(){this.#N.redo();this.#Pt({hasSomethingToUndo:true,hasSomethingToRedo:this.#N.hasSomethingToRedo(),isEmpty:this.#Gt()})}addCommands(t){this.#N.add(t);this.#Pt({hasSomethingToUndo:true,hasSomethingToRedo:false,isEmpty:this.#Gt()})}cleanUndoStack(t){this.#N.cleanType(t)}#Gt(){if(this.#k.size===0){return true}if(this.#k.size===1){for(const t of this.#k.values()){return t.isEmpty()}}return false}delete(){this.commitOrRemove();const t=this.currentLayer?.endDrawingSession(true);if(!this.hasSelection&&!t){return}const e=t?[t]:[...this.#dt];const i=()=>{this._editorUndoBar?.show(s,e.length===1?e[0].editorType:e.length);for(const t of e){t.remove()}};const s=()=>{for(const t of e){this.#Bt(t)}};this.addCommands({cmd:i,undo:s,mustExec:true})}commitOrRemove(){this.#I?.commitOrRemove()}hasSomethingToControl(){return this.#I||this.hasSelection}#Ht(t){for(const t of this.#dt){t.unselect()}this.#dt.clear();for(const e of t){if(e.isEmpty()){continue}this.#dt.add(e);e.select()}this.#Pt({hasSelectedEditor:this.hasSelection})}selectAll(){for(const t of this.#dt){t.commit()}this.#Ht(this.#k.values())}unselectAll(){if(this.#I){this.#I.commitOrRemove();if(this.#ct!==AnnotationEditorType.NONE){return}}if(this.#U?.commitOrRemove()){return}if(!this.hasSelection){return}for(const t of this.#dt){t.unselect()}this.#dt.clear();this.#Pt({hasSelectedEditor:false})}translateSelectedEditors(t,e,i=false){if(!i){this.commitOrRemove()}if(!this.hasSelection){return}this.#At[0]+=t;this.#At[1]+=e;const[s,n]=this.#At;const r=[...this.#dt];const a=1e3;if(this.#yt){clearTimeout(this.#yt)}this.#yt=setTimeout(()=>{this.#yt=null;this.#At[0]=this.#At[1]=0;this.addCommands({cmd:()=>{for(const t of r){if(this.#k.has(t.id)){t.translateInPage(s,n);t.translationDone()}}},undo:()=>{for(const t of r){if(this.#k.has(t.id)){t.translateInPage(-s,-n);t.translationDone()}}},mustExec:false})},a);for(const i of r){i.translateInPage(t,e);i.translationDone()}}setUpDragSession(){if(!this.hasSelection){return}this.disableUserSelect(true);this.#W=new Map;for(const t of this.#dt){this.#W.set(t,{savedX:t.x,savedY:t.y,savedPageIndex:t.pageIndex,newX:0,newY:0,newPageIndex:-1})}}endDragSession(){if(!this.#W){return false}this.disableUserSelect(false);const t=this.#W;this.#W=null;let e=false;for(const[{x:i,y:s,pageIndex:n},r]of t){r.newX=i;r.newY=s;r.newPageIndex=n;e||=i!==r.savedX||s!==r.savedY||n!==r.savedPageIndex}if(!e){return false}const i=(t,e,i,s)=>{if(this.#k.has(t.id)){const n=this.#R.get(s);if(n){t._setParentAndPosition(n,e,i)}else{t.pageIndex=s;t.x=e;t.y=i}}};this.addCommands({cmd:()=>{for(const[e,{newX:s,newY:n,newPageIndex:r}]of t){i(e,s,n,r)}},undo:()=>{for(const[e,{savedX:s,savedY:n,savedPageIndex:r}]of t){i(e,s,n,r)}},mustExec:true});return true}dragSelectedEditors(t,e){if(!this.#W){return}for(const i of this.#W.keys()){i.drag(t,e)}}rebuild(t){if(t.parent===null){const e=this.getLayer(t.pageIndex);if(e){e.changeParent(t);e.addOrRebuild(t)}else{this.addEditor(t);this.addToAnnotationStorage(t);t.rebuild()}}else{t.parent.addOrRebuild(t)}}get isEditorHandlingKeyboard(){return this.getActive()?.shouldGetKeyboardEvents()||this.#dt.size===1&&this.firstSelectedEditor.shouldGetKeyboardEvents()}isActive(t){return this.#I===t}getActive(){return this.#I}getMode(){return this.#ct}get imageManager(){return shadow(this,"imageManager",new ImageManager)}getSelectionBoxes(t){if(!t){return null}const e=document.getSelection();for(let i=0,s=e.rangeCount;i<s;i++){if(!t.contains(e.getRangeAt(i).commonAncestorContainer)){return null}}const{x:i,y:s,width:n,height:r}=t.getBoundingClientRect();let a;switch(t.getAttribute("data-main-rotation")){case"90":a=(t,e,a,o)=>({x:(e-s)/r,y:1-(t+a-i)/n,width:o/r,height:a/n});break;case"180":a=(t,e,a,o)=>({x:1-(t+a-i)/n,y:1-(e+o-s)/r,width:a/n,height:o/r});break;case"270":a=(t,e,a,o)=>({x:1-(e+o-s)/r,y:(t-i)/n,width:o/r,height:a/n});break;default:a=(t,e,a,o)=>({x:(t-i)/n,y:(e-s)/r,width:a/n,height:o/r});break}const o=[];for(let t=0,i=e.rangeCount;t<i;t++){const i=e.getRangeAt(t);if(i.collapsed){continue}for(const{x:t,y:e,width:s,height:n}of i.getClientRects()){if(s===0||n===0){continue}o.push(a(t,e,s,n))}}return o.length===0?null:o}addChangedExistingAnnotation({annotationElementId:t,id:e}){(this.#O||=new Map).set(t,e)}removeChangedExistingAnnotation({annotationElementId:t}){this.#O?.delete(t)}renderAnnotationElement(t){const e=this.#O?.get(t.data.id);if(!e){return}const i=this.#F.getRawValue(e);if(!i){return}if(this.#ct===AnnotationEditorType.NONE&&!i.hasBeenModified){return}i.renderAnnotationElement(t)}setMissingCanvas(t,e,i){const s=this.#lt?.get(t);if(!s){return}s.setCanvas(e,i);this.#lt.delete(t)}addMissingCanvas(t,e){(this.#lt||=new Map).set(t,e)}}class AltText{#o=null;#Vt=false;#jt=null;#Kt=null;#Xt=null;#qt=null;#Yt=false;#Jt=null;#r=null;#Qt=null;#Zt=null;#te=false;static#ee=null;static _l10n=null;constructor(t){this.#r=t;this.#te=t._uiManager.useNewAltTextFlow;AltText.#ee||=Object.freeze({added:"pdfjs-editor-new-alt-text-added-button","added-label":"pdfjs-editor-new-alt-text-added-button-label",missing:"pdfjs-editor-new-alt-text-missing-button","missing-label":"pdfjs-editor-new-alt-text-missing-button-label",review:"pdfjs-editor-new-alt-text-to-review-button","review-label":"pdfjs-editor-new-alt-text-to-review-button-label"})}static initialize(t){AltText._l10n??=t}async render(){const t=this.#jt=document.createElement("button");t.className="altText";t.tabIndex="0";const e=this.#Kt=document.createElement("span");t.append(e);if(this.#te){t.classList.add("new");t.setAttribute("data-l10n-id",AltText.#ee.missing);e.setAttribute("data-l10n-id",AltText.#ee["missing-label"])}else{t.setAttribute("data-l10n-id","pdfjs-editor-alt-text-button");e.setAttribute("data-l10n-id","pdfjs-editor-alt-text-button-label")}const i=this.#r._uiManager._signal;t.addEventListener("contextmenu",noContextMenu,{signal:i});t.addEventListener("pointerdown",t=>t.stopPropagation(),{signal:i});const s=t=>{t.preventDefault();this.#r._uiManager.editAltText(this.#r);if(this.#te){this.#r._reportTelemetry({action:"pdfjs.image.alt_text.image_status_label_clicked",data:{label:this.#ie}})}};t.addEventListener("click",s,{capture:true,signal:i});t.addEventListener("keydown",e=>{if(e.target===t&&e.key==="Enter"){this.#Yt=true;s(e)}},{signal:i});await this.#se();return t}get#ie(){return this.#o&&"added"||this.#o===null&&this.guessedText&&"review"||"missing"}finish(){if(!this.#jt){return}this.#jt.focus({focusVisible:this.#Yt});this.#Yt=false}isEmpty(){if(this.#te){return this.#o===null}return!this.#o&&!this.#Vt}hasData(){if(this.#te){return this.#o!==null||!!this.#Qt}return this.isEmpty()}get guessedText(){return this.#Qt}async setGuessedText(t){if(this.#o!==null){return}this.#Qt=t;this.#Zt=await AltText._l10n.get("pdfjs-editor-new-alt-text-generated-alt-text-with-disclaimer",{generatedAltText:t});this.#se()}toggleAltTextBadge(t=false){if(!this.#te||this.#o){this.#Jt?.remove();this.#Jt=null;return}if(!this.#Jt){const t=this.#Jt=document.createElement("div");t.className="noAltTextBadge";this.#r.div.append(t)}this.#Jt.classList.toggle("hidden",!t)}serialize(t){let e=this.#o;if(!t&&this.#Qt===e){e=this.#Zt}return{altText:e,decorative:this.#Vt,guessedText:this.#Qt,textWithDisclaimer:this.#Zt}}get data(){return{altText:this.#o,decorative:this.#Vt}}set data({altText:t,decorative:e,guessedText:i,textWithDisclaimer:s,cancel:n=false}){if(i){this.#Qt=i;this.#Zt=s}if(this.#o===t&&this.#Vt===e){return}if(!n){this.#o=t;this.#Vt=e}this.#se()}toggle(t=false){if(!this.#jt){return}if(!t&&this.#qt){clearTimeout(this.#qt);this.#qt=null}this.#jt.disabled=!t}shown(){this.#r._reportTelemetry({action:"pdfjs.image.alt_text.image_status_label_displayed",data:{label:this.#ie}})}destroy(){this.#jt?.remove();this.#jt=null;this.#Kt=null;this.#Xt=null;this.#Jt?.remove();this.#Jt=null}async#se(){const t=this.#jt;if(!t){return}if(this.#te){t.classList.toggle("done",!!this.#o);t.setAttribute("data-l10n-id",AltText.#ee[this.#ie]);this.#Kt?.setAttribute("data-l10n-id",AltText.#ee[`${this.#ie}-label`]);if(!this.#o){this.#Xt?.remove();return}}else{if(!this.#o&&!this.#Vt){t.classList.remove("done");this.#Xt?.remove();return}t.classList.add("done");t.setAttribute("data-l10n-id","pdfjs-editor-alt-text-edit-button")}let e=this.#Xt;if(!e){this.#Xt=e=document.createElement("span");e.className="tooltip";e.setAttribute("role","tooltip");e.id=`alt-text-tooltip-${this.#r.id}`;const i=100;const s=this.#r._uiManager._signal;s.addEventListener("abort",()=>{clearTimeout(this.#qt);this.#qt=null},{once:true});t.addEventListener("mouseenter",()=>{this.#qt=setTimeout(()=>{this.#qt=null;this.#Xt.classList.add("show");this.#r._reportTelemetry({action:"alt_text_tooltip"})},i)},{signal:s});t.addEventListener("mouseleave",()=>{if(this.#qt){clearTimeout(this.#qt);this.#qt=null}this.#Xt?.classList.remove("show")},{signal:s})}if(this.#Vt){e.setAttribute("data-l10n-id","pdfjs-editor-alt-text-decorative-tooltip")}else{e.removeAttribute("data-l10n-id");e.textContent=this.#o}if(!e.parentNode){t.append(e)}const i=this.#r.getElementForAltText();i?.setAttribute("aria-describedby",e.id)}}class Comment{#ne=null;#re=false;#r=null;#ae=null;#oe=null;#le=null;#he=false;constructor(t){this.#r=t;this.toolbar=null}render(){if(!this.#r._uiManager.hasCommentManager()){return null}const t=this.#ne=document.createElement("button");t.className="comment";t.tabIndex="0";t.setAttribute("data-l10n-id","pdfjs-editor-edit-comment-button");const e=this.#r._uiManager._signal;if(!(e instanceof AbortSignal)||e.aborted){return t}t.addEventListener("contextmenu",noContextMenu,{signal:e});t.addEventListener("pointerdown",t=>t.stopPropagation(),{signal:e});const i=t=>{t.preventDefault();this.edit()};t.addEventListener("click",i,{capture:true,signal:e});t.addEventListener("keydown",e=>{if(e.target===t&&e.key==="Enter"){this.#re=true;i(e)}},{signal:e});return t}edit(){const{bottom:t,left:e,right:i}=this.#r.getClientDimensions();const s={top:t};if(this.#r._uiManager.direction==="ltr"){s.right=i}else{s.left=e}this.#r._uiManager.editComment(this.#r,s)}finish(){if(!this.#ne){return}this.#ne.focus({focusVisible:this.#re});this.#re=false}isDeleted(){return this.#he||this.#oe===""}hasBeenEdited(){return this.isDeleted()||this.#oe!==this.#ae}serialize(){return this.data}get data(){return{text:this.#oe,date:this.#le,deleted:this.#he}}set data(t){if(t===null){this.#oe="";this.#he=true;return}this.#oe=t;this.#le=new Date;this.#he=false}setInitialText(t){this.#ae=t;this.data=t}toggle(t=false){if(!this.#ne){return}this.#ne.disabled=!t}shown(){}destroy(){this.#ne?.remove();this.#ne=null;this.#oe="";this.#le=null;this.#r=null;this.#re=false;this.#he=false}}class TouchManager{#wt;#ce=false;#de=null;#ue;#pe;#ge;#fe;#me=null;#be;#Ae=null;#ye;#we=null;constructor({container:t,isPinchingDisabled:e=null,isPinchingStopped:i=null,onPinchStart:s=null,onPinching:n=null,onPinchEnd:r=null,signal:a}){this.#wt=t;this.#de=i;this.#ue=e;this.#pe=s;this.#ge=n;this.#fe=r;this.#ye=new AbortController;this.#be=AbortSignal.any([a,this.#ye.signal]);t.addEventListener("touchstart",this.#Ee.bind(this),{passive:false,signal:this.#be})}get MIN_TOUCH_DISTANCE_TO_PINCH(){return 35/OutputScale.pixelRatio}#Ee(t){if(this.#ue?.()){return}if(t.touches.length===1){if(this.#me){return}const t=this.#me=new AbortController;const e=AbortSignal.any([this.#be,t.signal]);const i=this.#wt;const s={capture:true,signal:e,passive:false};const n=t=>{if(t.pointerType==="touch"){this.#me?.abort();this.#me=null}};i.addEventListener("pointerdown",t=>{if(t.pointerType==="touch"){stopEvent(t);n(t)}},s);i.addEventListener("pointerup",n,s);i.addEventListener("pointercancel",n,s);return}if(!this.#we){this.#we=new AbortController;const t=AbortSignal.any([this.#be,this.#we.signal]);const e=this.#wt;const i={signal:t,capture:false,passive:false};e.addEventListener("touchmove",this.#ve.bind(this),i);const s=this.#xe.bind(this);e.addEventListener("touchend",s,i);e.addEventListener("touchcancel",s,i);i.capture=true;e.addEventListener("pointerdown",stopEvent,i);e.addEventListener("pointermove",stopEvent,i);e.addEventListener("pointercancel",stopEvent,i);e.addEventListener("pointerup",stopEvent,i);this.#pe?.()}stopEvent(t);if(t.touches.length!==2||this.#de?.()){this.#Ae=null;return}let[e,i]=t.touches;if(e.identifier>i.identifier){[e,i]=[i,e]}this.#Ae={touch0X:e.screenX,touch0Y:e.screenY,touch1X:i.screenX,touch1Y:i.screenY}}#ve(t){if(!this.#Ae||t.touches.length!==2){return}stopEvent(t);let[e,i]=t.touches;if(e.identifier>i.identifier){[e,i]=[i,e]}const{screenX:s,screenY:n}=e;const{screenX:r,screenY:a}=i;const o=this.#Ae;const{touch0X:l,touch0Y:h,touch1X:c,touch1Y:d}=o;const u=c-l;const p=d-h;const g=r-s;const f=a-n;const m=Math.hypot(g,f)||1;const b=Math.hypot(u,p)||1;if(!this.#ce&&Math.abs(b-m)<=TouchManager.MIN_TOUCH_DISTANCE_TO_PINCH){return}o.touch0X=s;o.touch0Y=n;o.touch1X=r;o.touch1Y=a;if(!this.#ce){this.#ce=true;return}const A=[(s+r)/2,(n+a)/2];this.#ge?.(A,b,m)}#xe(t){if(t.touches.length>=2){return}if(this.#we){this.#we.abort();this.#we=null;this.#fe?.()}if(!this.#Ae){return}stopEvent(t);this.#Ae=null;this.#ce=false}destroy(){this.#ye?.abort();this.#ye=null;this.#me?.abort();this.#me=null}}class AnnotationEditor{#_e=null;#Te=null;#o=null;#l=null;#Se=false;#Ce=null;#De="";#Me=false;#Ie=null;#Pe=null;#ke=null;#Re=null;#Le="";#Fe=false;#Oe=null;#Ne=false;#Be=false;#He=false;#Ue=null;#Ge=0;#ze=0;#We=null;#$e=null;isSelected=false;_isCopy=false;_editToolbar=null;_initialOptions=Object.create(null);_initialData=null;_isVisible=true;_uiManager=null;_focusEventsAllowed=true;static _l10n=null;static _l10nResizer=null;#Ve=false;#je=AnnotationEditor._zIndex++;static _borderLineWidth=-1;static _colorManager=new ColorManager;static _zIndex=1;static _telemetryTimeout=1e3;static get _resizerKeyboardManager(){const t=AnnotationEditor.prototype._resizeWithKeyboard;const e=AnnotationEditorUIManager.TRANSLATE_SMALL;const i=AnnotationEditorUIManager.TRANSLATE_BIG;return shadow(this,"_resizerKeyboardManager",new KeyboardManager([[["ArrowLeft","mac+ArrowLeft"],t,{args:[-e,0]}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],t,{args:[-i,0]}],[["ArrowRight","mac+ArrowRight"],t,{args:[e,0]}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],t,{args:[i,0]}],[["ArrowUp","mac+ArrowUp"],t,{args:[0,-e]}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],t,{args:[0,-i]}],[["ArrowDown","mac+ArrowDown"],t,{args:[0,e]}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],t,{args:[0,i]}],[["Escape","mac+Escape"],AnnotationEditor.prototype._stopResizingWithKeyboard]]))}constructor(t){this.parent=t.parent;this.id=t.id;this.width=this.height=null;this.pageIndex=t.parent.pageIndex;this.name=t.name;this.div=null;this._uiManager=t.uiManager;this.annotationElementId=null;this._willKeepAspectRatio=false;this._initialOptions.isCentered=t.isCentered;this._structTreeParentId=null;this.annotationElementId=t.annotationElementId||null;const{rotation:e,rawDims:{pageWidth:i,pageHeight:s,pageX:n,pageY:r}}=this.parent.viewport;this.rotation=e;this.pageRotation=(360+e-this._uiManager.viewParameters.rotation)%360;this.pageDimensions=[i,s];this.pageTranslation=[n,r];const[a,o]=this.parentDimensions;this.x=t.x/a;this.y=t.y/o;this.isAttachedToDOM=false;this.deleted=false}get editorType(){return Object.getPrototypeOf(this).constructor._type}get mode(){return Object.getPrototypeOf(this).constructor._editorType}static get isDrawer(){return false}static get _defaultLineColor(){return shadow(this,"_defaultLineColor",this._colorManager.getHexCode("CanvasText"))}static deleteAnnotationElement(t){const e=new FakeEditor({id:t.parent.getNextId(),parent:t.parent,uiManager:t._uiManager});e.annotationElementId=t.annotationElementId;e.deleted=true;e._uiManager.addToAnnotationStorage(e)}static initialize(t,e){AnnotationEditor._l10n??=t;AnnotationEditor._l10nResizer||=Object.freeze({topLeft:"pdfjs-editor-resizer-top-left",topMiddle:"pdfjs-editor-resizer-top-middle",topRight:"pdfjs-editor-resizer-top-right",middleRight:"pdfjs-editor-resizer-middle-right",bottomRight:"pdfjs-editor-resizer-bottom-right",bottomMiddle:"pdfjs-editor-resizer-bottom-middle",bottomLeft:"pdfjs-editor-resizer-bottom-left",middleLeft:"pdfjs-editor-resizer-middle-left"});if(AnnotationEditor._borderLineWidth!==-1){return}const i=getComputedStyle(document.documentElement);AnnotationEditor._borderLineWidth=parseFloat(i.getPropertyValue("--outline-width"))||0}static updateDefaultParams(t,e){}static get defaultPropertiesToUpdate(){return[]}static isHandlingMimeForPasting(t){return false}static paste(t,e){unreachable("Not implemented")}get propertiesToUpdate(){return[]}get _isDraggable(){return this.#Ve}set _isDraggable(t){this.#Ve=t;this.div?.classList.toggle("draggable",t)}get isEnterHandled(){return true}center(){const[t,e]=this.pageDimensions;switch(this.parentRotation){case 90:this.x-=this.height*e/(t*2);this.y+=this.width*t/(e*2);break;case 180:this.x+=this.width/2;this.y+=this.height/2;break;case 270:this.x+=this.height*e/(t*2);this.y-=this.width*t/(e*2);break;default:this.x-=this.width/2;this.y-=this.height/2;break}this.fixAndSetPosition()}addCommands(t){this._uiManager.addCommands(t)}get currentLayer(){return this._uiManager.currentLayer}setInBackground(){this.div.style.zIndex=0}setInForeground(){this.div.style.zIndex=this.#je}setParent(t){if(t!==null){this.pageIndex=t.pageIndex;this.pageDimensions=t.pageDimensions}else{this.#Ke()}this.parent=t}focusin(t){if(!this._focusEventsAllowed){return}if(!this.#Fe){this.parent.setSelected(this)}else{this.#Fe=false}}focusout(t){if(!this._focusEventsAllowed){return}if(!this.isAttachedToDOM){return}const e=t.relatedTarget;if(e?.closest(`#${this.id}`)){return}t.preventDefault();if(!this.parent?.isMultipleSelection){this.commitOrRemove()}}commitOrRemove(){if(this.isEmpty()){this.remove()}else{this.commit()}}commit(){if(!this.isInEditMode()){return}this.addToAnnotationStorage()}addToAnnotationStorage(){this._uiManager.addToAnnotationStorage(this)}setAt(t,e,i,s){const[n,r]=this.parentDimensions;[i,s]=this.screenToPageTranslation(i,s);this.x=(t+i)/n;this.y=(e+s)/r;this.fixAndSetPosition()}_moveAfterPaste(t,e){const[i,s]=this.parentDimensions;this.setAt(t*i,e*s,this.width*i,this.height*s);this._onTranslated()}#Xe([t,e],i,s){[i,s]=this.screenToPageTranslation(i,s);this.x+=i/t;this.y+=s/e;this._onTranslating(this.x,this.y);this.fixAndSetPosition()}translate(t,e){this.#Xe(this.parentDimensions,t,e)}translateInPage(t,e){this.#Oe||=[this.x,this.y,this.width,this.height];this.#Xe(this.pageDimensions,t,e);this.div.scrollIntoView({block:"nearest"})}translationDone(){this._onTranslated(this.x,this.y)}drag(t,e){this.#Oe||=[this.x,this.y,this.width,this.height];const{div:i,parentDimensions:[s,n]}=this;this.x+=t/s;this.y+=e/n;if(this.parent&&(this.x<0||this.x>1||this.y<0||this.y>1)){const{x:t,y:e}=this.div.getBoundingClientRect();if(this.parent.findNewParent(this,t,e)){this.x-=Math.floor(this.x);this.y-=Math.floor(this.y)}}let{x:r,y:a}=this;const[o,l]=this.getBaseTranslation();r+=o;a+=l;const{style:h}=i;h.left=`${(100*r).toFixed(2)}%`;h.top=`${(100*a).toFixed(2)}%`;this._onTranslating(r,a);i.scrollIntoView({block:"nearest"})}_onTranslating(t,e){}_onTranslated(t,e){}get _hasBeenMoved(){return!!this.#Oe&&(this.#Oe[0]!==this.x||this.#Oe[1]!==this.y)}get _hasBeenResized(){return!!this.#Oe&&(this.#Oe[2]!==this.width||this.#Oe[3]!==this.height)}getBaseTranslation(){const[t,e]=this.parentDimensions;const{_borderLineWidth:i}=AnnotationEditor;const s=i/t;const n=i/e;switch(this.rotation){case 90:return[-s,n];case 180:return[s,n];case 270:return[s,-n];default:return[-s,-n]}}get _mustFixPosition(){return true}fixAndSetPosition(t=this.rotation){const{div:{style:e},pageDimensions:[i,s]}=this;let{x:n,y:r,width:a,height:o}=this;a*=i;o*=s;n*=i;r*=s;if(this._mustFixPosition){switch(t){case 0:n=MathClamp(n,0,i-a);r=MathClamp(r,0,s-o);break;case 90:n=MathClamp(n,0,i-o);r=MathClamp(r,a,s);break;case 180:n=MathClamp(n,a,i);r=MathClamp(r,o,s);break;case 270:n=MathClamp(n,o,i);r=MathClamp(r,0,s-a);break}}this.x=n/=i;this.y=r/=s;const[l,h]=this.getBaseTranslation();n+=l;r+=h;e.left=`${(100*n).toFixed(2)}%`;e.top=`${(100*r).toFixed(2)}%`;this.moveInDOM()}static#qe(t,e,i){switch(i){case 90:return[e,-t];case 180:return[-t,-e];case 270:return[-e,t];default:return[t,e]}}screenToPageTranslation(t,e){return AnnotationEditor.#qe(t,e,this.parentRotation)}pageTranslationToScreen(t,e){return AnnotationEditor.#qe(t,e,360-this.parentRotation)}#Ye(t){switch(t){case 90:{const[t,e]=this.pageDimensions;return[0,-t/e,e/t,0]}case 180:return[-1,0,0,-1];case 270:{const[t,e]=this.pageDimensions;return[0,t/e,-e/t,0]}default:return[1,0,0,1]}}get parentScale(){return this._uiManager.viewParameters.realScale}get parentRotation(){return(this._uiManager.viewParameters.rotation+this.pageRotation)%360}get parentDimensions(){const{parentScale:t,pageDimensions:[e,i]}=this;return[e*t,i*t]}setDims(t,e){const[i,s]=this.parentDimensions;const{style:n}=this.div;n.width=`${(100*t/i).toFixed(2)}%`;if(!this.#Me){n.height=`${(100*e/s).toFixed(2)}%`}}fixDims(){const{style:t}=this.div;const{height:e,width:i}=t;const s=i.endsWith("%");const n=!this.#Me&&e.endsWith("%");if(s&&n){return}const[r,a]=this.parentDimensions;if(!s){t.width=`${(100*parseFloat(i)/r).toFixed(2)}%`}if(!this.#Me&&!n){t.height=`${(100*parseFloat(e)/a).toFixed(2)}%`}}getInitialTranslation(){return[0,0]}#Je(){if(this.#Ie){return}this.#Ie=document.createElement("div");this.#Ie.classList.add("resizers");const t=this._willKeepAspectRatio?["topLeft","topRight","bottomRight","bottomLeft"]:["topLeft","topMiddle","topRight","middleRight","bottomRight","bottomMiddle","bottomLeft","middleLeft"];const e=this._uiManager._signal;for(const i of t){const t=document.createElement("div");this.#Ie.append(t);t.classList.add("resizer",i);t.setAttribute("data-resizer-name",i);t.addEventListener("pointerdown",this.#Qe.bind(this,i),{signal:e});t.addEventListener("contextmenu",noContextMenu,{signal:e});t.tabIndex=-1}this.div.prepend(this.#Ie)}#Qe(t,e){e.preventDefault();const{isMac:i}=util_FeatureTest.platform;if(e.button!==0||e.ctrlKey&&i){return}this.#o?.toggle(false);const s=this._isDraggable;this._isDraggable=false;this.#Pe=[e.screenX,e.screenY];const n=new AbortController;const r=this._uiManager.combinedSignal(n);this.parent.togglePointerEvents(false);window.addEventListener("pointermove",this.#Ze.bind(this,t),{passive:true,capture:true,signal:r});window.addEventListener("touchmove",stopEvent,{passive:false,signal:r});window.addEventListener("contextmenu",noContextMenu,{signal:r});this.#ke={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height};const a=this.parent.div.style.cursor;const o=this.div.style.cursor;this.div.style.cursor=this.parent.div.style.cursor=window.getComputedStyle(e.target).cursor;const l=()=>{n.abort();this.parent.togglePointerEvents(true);this.#o?.toggle(true);this._isDraggable=s;this.parent.div.style.cursor=a;this.div.style.cursor=o;this.#ti()};window.addEventListener("pointerup",l,{signal:r});window.addEventListener("blur",l,{signal:r})}#ei(t,e,i,s){this.width=i;this.height=s;this.x=t;this.y=e;const[n,r]=this.parentDimensions;this.setDims(n*i,r*s);this.fixAndSetPosition();this._onResized()}_onResized(){}#ti(){if(!this.#ke){return}const{savedX:t,savedY:e,savedWidth:i,savedHeight:s}=this.#ke;this.#ke=null;const n=this.x;const r=this.y;const a=this.width;const o=this.height;if(n===t&&r===e&&a===i&&o===s){return}this.addCommands({cmd:this.#ei.bind(this,n,r,a,o),undo:this.#ei.bind(this,t,e,i,s),mustExec:true})}static _round(t){return Math.round(t*1e4)/1e4}#Ze(t,e){const[i,s]=this.parentDimensions;const n=this.x;const r=this.y;const a=this.width;const o=this.height;const l=AnnotationEditor.MIN_SIZE/i;const h=AnnotationEditor.MIN_SIZE/s;const c=this.#Ye(this.rotation);const d=(t,e)=>[c[0]*t+c[2]*e,c[1]*t+c[3]*e];const u=this.#Ye(360-this.rotation);const p=(t,e)=>[u[0]*t+u[2]*e,u[1]*t+u[3]*e];let g;let f;let m=false;let b=false;switch(t){case"topLeft":m=true;g=(t,e)=>[0,0];f=(t,e)=>[t,e];break;case"topMiddle":g=(t,e)=>[t/2,0];f=(t,e)=>[t/2,e];break;case"topRight":m=true;g=(t,e)=>[t,0];f=(t,e)=>[0,e];break;case"middleRight":b=true;g=(t,e)=>[t,e/2];f=(t,e)=>[0,e/2];break;case"bottomRight":m=true;g=(t,e)=>[t,e];f=(t,e)=>[0,0];break;case"bottomMiddle":g=(t,e)=>[t/2,e];f=(t,e)=>[t/2,0];break;case"bottomLeft":m=true;g=(t,e)=>[0,e];f=(t,e)=>[t,0];break;case"middleLeft":b=true;g=(t,e)=>[0,e/2];f=(t,e)=>[t,e/2];break}const A=g(a,o);const y=f(a,o);let w=d(...y);const E=AnnotationEditor._round(n+w[0]);const v=AnnotationEditor._round(r+w[1]);let x=1;let _=1;let T,S;if(!e.fromKeyboard){const{screenX:t,screenY:i}=e;const[s,n]=this.#Pe;[T,S]=this.screenToPageTranslation(t-s,i-n);this.#Pe[0]=t;this.#Pe[1]=i}else{({deltaX:T,deltaY:S}=e)}[T,S]=p(T/i,S/s);if(m){const t=Math.hypot(a,o);x=_=Math.max(Math.min(Math.hypot(y[0]-A[0]-T,y[1]-A[1]-S)/t,1/a,1/o),l/a,h/o)}else if(b){x=MathClamp(Math.abs(y[0]-A[0]-T),l,1)/a}else{_=MathClamp(Math.abs(y[1]-A[1]-S),h,1)/o}const C=AnnotationEditor._round(a*x);const D=AnnotationEditor._round(o*_);w=d(...f(C,D));const M=E-w[0];const I=v-w[1];this.#Oe||=[this.x,this.y,this.width,this.height];this.width=C;this.height=D;this.x=M;this.y=I;this.setDims(i*C,s*D);this.fixAndSetPosition();this._onResizing()}_onResizing(){}altTextFinish(){this.#o?.finish()}get toolbarButtons(){return null}async addEditToolbar(){if(this._editToolbar||this.#Be){return this._editToolbar}this._editToolbar=new EditorToolbar(this);this.div.append(this._editToolbar.render());const{toolbarButtons:t}=this;if(t){for(const[e,i]of t){await this._editToolbar.addButton(e,i)}}this._editToolbar.addButton("comment",this.addCommentButton());this._editToolbar.addButton("delete");return this._editToolbar}removeEditToolbar(){if(!this._editToolbar){return}this._editToolbar.remove();this._editToolbar=null;this.#o?.destroy()}addContainer(t){const e=this._editToolbar?.div;if(e){e.before(t)}else{this.div.append(t)}}getClientDimensions(){return this.div.getBoundingClientRect()}createAltText(){if(!this.#o){AltText.initialize(AnnotationEditor._l10n);this.#o=new AltText(this);if(this.#_e){this.#o.data=this.#_e;this.#_e=null}}return this.#o}get altTextData(){return this.#o?.data}set altTextData(t){if(!this.#o){return}this.#o.data=t}get guessedAltText(){return this.#o?.guessedText}async setGuessedAltText(t){await(this.#o?.setGuessedText(t))}serializeAltText(t){return this.#o?.serialize(t)}hasAltText(){return!!this.#o&&!this.#o.isEmpty()}hasAltTextData(){return this.#o?.hasData()??false}addCommentButton(){if(this.#l){return this.#l}return this.#l=new Comment(this)}get commentColor(){return null}get comment(){const t=this.#l;return{text:t.data.text,date:t.data.date,deleted:t.isDeleted(),color:this.commentColor}}set comment(t){if(!this.#l){this.#l=new Comment(this)}this.#l.data=t}setCommentData(t){if(!this.#l){this.#l=new Comment(this)}this.#l.setInitialText(t)}get hasEditedComment(){return this.#l?.hasBeenEdited()}async editComment(){if(!this.#l){this.#l=new Comment(this)}this.#l.edit()}addComment(t){if(this.hasEditedComment){const e=180;const i=100;const[,,,s]=t.rect;const[n]=this.pageDimensions;const[r]=this.pageTranslation;const a=r+n+1;const o=s-i;const l=a+e;t.popup={contents:this.comment.text,deleted:this.comment.deleted,rect:[a,o,l,s]}}}render(){const t=this.div=document.createElement("div");t.setAttribute("data-editor-rotation",(360-this.rotation)%360);t.className=this.name;t.setAttribute("id",this.id);t.tabIndex=this.#Se?-1:0;t.setAttribute("role","application");if(this.defaultL10nId){t.setAttribute("data-l10n-id",this.defaultL10nId)}if(!this._isVisible){t.classList.add("hidden")}this.setInForeground();this.#ii();const[e,i]=this.parentDimensions;if(this.parentRotation%180!==0){t.style.maxWidth=`${(100*i/e).toFixed(2)}%`;t.style.maxHeight=`${(100*e/i).toFixed(2)}%`}const[s,n]=this.getInitialTranslation();this.translate(s,n);bindEvents(this,t,["keydown","pointerdown","dblclick"]);if(this.isResizable&&this._uiManager._supportsPinchToZoom){this.#$e||=new TouchManager({container:t,isPinchingDisabled:()=>!this.isSelected,onPinchStart:this.#si.bind(this),onPinching:this.#ni.bind(this),onPinchEnd:this.#ri.bind(this),signal:this._uiManager._signal})}this._uiManager._editorUndoBar?.hide();return t}#si(){this.#ke={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height};this.#o?.toggle(false);this.parent.togglePointerEvents(false)}#ni(t,e,i){const s=.7;let n=s*(i/e)+1-s;if(n===1){return}const r=this.#Ye(this.rotation);const a=(t,e)=>[r[0]*t+r[2]*e,r[1]*t+r[3]*e];const[o,l]=this.parentDimensions;const h=this.x;const c=this.y;const d=this.width;const u=this.height;const p=AnnotationEditor.MIN_SIZE/o;const g=AnnotationEditor.MIN_SIZE/l;n=Math.max(Math.min(n,1/d,1/u),p/d,g/u);const f=AnnotationEditor._round(d*n);const m=AnnotationEditor._round(u*n);if(f===d&&m===u){return}this.#Oe||=[h,c,d,u];const b=a(d/2,u/2);const A=AnnotationEditor._round(h+b[0]);const y=AnnotationEditor._round(c+b[1]);const w=a(f/2,m/2);this.x=A-w[0];this.y=y-w[1];this.width=f;this.height=m;this.setDims(o*f,l*m);this.fixAndSetPosition();this._onResizing()}#ri(){this.#o?.toggle(true);this.parent.togglePointerEvents(true);this.#ti()}pointerdown(t){const{isMac:e}=util_FeatureTest.platform;if(t.button!==0||t.ctrlKey&&e){t.preventDefault();return}this.#Fe=true;if(this._isDraggable){this.#ai(t);return}this.#oi(t)}#oi(t){const{isMac:e}=util_FeatureTest.platform;if(t.ctrlKey&&!e||t.shiftKey||t.metaKey&&e){this.parent.toggleSelected(this)}else{this.parent.setSelected(this)}}#ai(t){const{isSelected:e}=this;this._uiManager.setUpDragSession();let i=false;const s=new AbortController;const n=this._uiManager.combinedSignal(s);const r={capture:true,passive:false,signal:n};const a=t=>{s.abort();this.#Ce=null;this.#Fe=false;if(!this._uiManager.endDragSession()){this.#oi(t)}if(i){this._onStopDragging()}};if(e){this.#Ge=t.clientX;this.#ze=t.clientY;this.#Ce=t.pointerId;this.#De=t.pointerType;window.addEventListener("pointermove",t=>{if(!i){i=true;this._onStartDragging()}const{clientX:e,clientY:s,pointerId:n}=t;if(n!==this.#Ce){stopEvent(t);return}const[r,a]=this.screenToPageTranslation(e-this.#Ge,s-this.#ze);this.#Ge=e;this.#ze=s;this._uiManager.dragSelectedEditors(r,a)},r);window.addEventListener("touchmove",stopEvent,r);window.addEventListener("pointerdown",t=>{if(t.pointerType===this.#De){if(this.#$e||t.isPrimary){a(t)}}stopEvent(t)},r)}const o=t=>{if(!this.#Ce||this.#Ce===t.pointerId){a(t);return}stopEvent(t)};window.addEventListener("pointerup",o,{signal:n});window.addEventListener("blur",o,{signal:n})}_onStartDragging(){}_onStopDragging(){}moveInDOM(){if(this.#Ue){clearTimeout(this.#Ue)}this.#Ue=setTimeout(()=>{this.#Ue=null;this.parent?.moveEditorInDOM(this)},0)}_setParentAndPosition(t,e,i){t.changeParent(this);this.x=e;this.y=i;this.fixAndSetPosition();this._onTranslated()}getRect(t,e,i=this.rotation){const s=this.parentScale;const[n,r]=this.pageDimensions;const[a,o]=this.pageTranslation;const l=t/s;const h=e/s;const c=this.x*n;const d=this.y*r;const u=this.width*n;const p=this.height*r;switch(i){case 0:return[c+l+a,r-d-h-p+o,c+l+u+a,r-d-h+o];case 90:return[c+h+a,r-d+l+o,c+h+p+a,r-d+l+u+o];case 180:return[c-l-u+a,r-d+h+o,c-l+a,r-d+h+p+o];case 270:return[c-h-p+a,r-d-l-u+o,c-h+a,r-d-l+o];default:throw new Error("Invalid rotation")}}getRectInCurrentCoords(t,e){const[i,s,n,r]=t;const a=n-i;const o=r-s;switch(this.rotation){case 0:return[i,e-r,a,o];case 90:return[i,e-s,o,a];case 180:return[n,e-s,a,o];case 270:return[n,e-r,o,a];default:throw new Error("Invalid rotation")}}getPDFRect(){return this.getRect(0,0)}onceAdded(t){}isEmpty(){return false}enableEditMode(){if(this.isInEditMode()){return false}this.parent.setEditingState(false);this.#Be=true;return true}disableEditMode(){if(!this.isInEditMode()){return false}this.parent.setEditingState(true);this.#Be=false;return true}isInEditMode(){return this.#Be}shouldGetKeyboardEvents(){return this.#He}needsToBeRebuilt(){return this.div&&!this.isAttachedToDOM}get isOnScreen(){const{top:t,left:e,bottom:i,right:s}=this.getClientDimensions();const{innerHeight:n,innerWidth:r}=window;return e<r&&s>0&&t<n&&i>0}#ii(){if(this.#Re||!this.div){return}this.#Re=new AbortController;const t=this._uiManager.combinedSignal(this.#Re);this.div.addEventListener("focusin",this.focusin.bind(this),{signal:t});this.div.addEventListener("focusout",this.focusout.bind(this),{signal:t})}rebuild(){this.#ii()}rotate(t){}resize(){}serializeDeleted(){return{id:this.annotationElementId,deleted:true,pageIndex:this.pageIndex,popupRef:this._initialData?.popupRef||""}}serialize(t=false,e=null){unreachable("An editor must be serializable")}static async deserialize(t,e,i){const s=new this.prototype.constructor({parent:e,id:e.getNextId(),uiManager:i,annotationElementId:t.annotationElementId});s.rotation=t.rotation;s.#_e=t.accessibilityData;s._isCopy=t.isCopy||false;const[n,r]=s.pageDimensions;const[a,o,l,h]=s.getRectInCurrentCoords(t.rect,r);s.x=a/n;s.y=o/r;s.width=l/n;s.height=h/r;return s}get hasBeenModified(){return!!this.annotationElementId&&(this.deleted||this.serialize()!==null)}remove(){this.#Re?.abort();this.#Re=null;if(!this.isEmpty()){this.commit()}if(this.parent){this.parent.remove(this)}else{this._uiManager.removeEditor(this)}if(this.#Ue){clearTimeout(this.#Ue);this.#Ue=null}this.#Ke();this.removeEditToolbar();if(this.#We){for(const t of this.#We.values()){clearTimeout(t)}this.#We=null}this.parent=null;this.#$e?.destroy();this.#$e=null}get isResizable(){return false}makeResizable(){if(this.isResizable){this.#Je();this.#Ie.classList.remove("hidden")}}get toolbarPosition(){return null}keydown(t){if(!this.isResizable||t.target!==this.div||t.key!=="Enter"){return}this._uiManager.setSelected(this);this.#ke={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height};const e=this.#Ie.children;if(!this.#Te){this.#Te=Array.from(e);const t=this.#li.bind(this);const i=this.#hi.bind(this);const s=this._uiManager._signal;for(const e of this.#Te){const n=e.getAttribute("data-resizer-name");e.setAttribute("role","spinbutton");e.addEventListener("keydown",t,{signal:s});e.addEventListener("blur",i,{signal:s});e.addEventListener("focus",this.#ci.bind(this,n),{signal:s});e.setAttribute("data-l10n-id",AnnotationEditor._l10nResizer[n])}}const i=this.#Te[0];let s=0;for(const t of e){if(t===i){break}s++}const n=(360-this.rotation+this.parentRotation)%360/90*(this.#Te.length/4);if(n!==s){if(n<s){for(let t=0;t<s-n;t++){this.#Ie.append(this.#Ie.firstChild)}}else if(n>s){for(let t=0;t<n-s;t++){this.#Ie.firstChild.before(this.#Ie.lastChild)}}let t=0;for(const i of e){const e=this.#Te[t++];const s=e.getAttribute("data-resizer-name");i.setAttribute("data-l10n-id",AnnotationEditor._l10nResizer[s])}}this.#di(0);this.#He=true;this.#Ie.firstChild.focus({focusVisible:true});t.preventDefault();t.stopImmediatePropagation()}#li(t){AnnotationEditor._resizerKeyboardManager.exec(this,t)}#hi(t){if(this.#He&&t.relatedTarget?.parentNode!==this.#Ie){this.#Ke()}}#ci(t){this.#Le=this.#He?t:""}#di(t){if(!this.#Te){return}for(const e of this.#Te){e.tabIndex=t}}_resizeWithKeyboard(t,e){if(!this.#He){return}this.#Ze(this.#Le,{deltaX:t,deltaY:e,fromKeyboard:true})}#Ke(){this.#He=false;this.#di(-1);this.#ti()}_stopResizingWithKeyboard(){this.#Ke();this.div.focus()}select(){if(this.isSelected&&this._editToolbar){return}this.isSelected=true;this.makeResizable();this.div?.classList.add("selectedEditor");if(!this._editToolbar){this.addEditToolbar().then(()=>{if(this.div?.classList.contains("selectedEditor")){this._editToolbar?.show()}});return}this._editToolbar?.show();this.#o?.toggleAltTextBadge(false)}unselect(){if(!this.isSelected){return}this.isSelected=false;this.#Ie?.classList.add("hidden");this.div?.classList.remove("selectedEditor");if(this.div?.contains(document.activeElement)){this._uiManager.currentLayer.div.focus({preventScroll:true})}this._editToolbar?.hide();this.#o?.toggleAltTextBadge(true)}updateParams(t,e){}disableEditing(){}enableEditing(){}get canChangeContent(){return false}enterInEditMode(){if(!this.canChangeContent){return}this.enableEditMode();this.div.focus()}dblclick(t){this.enterInEditMode();this.parent.updateToolbar({mode:this.constructor._editorType,editId:this.id})}getElementForAltText(){return this.div}get contentDiv(){return this.div}get isEditing(){return this.#Ne}set isEditing(t){this.#Ne=t;if(!this.parent){return}if(t){this.parent.setSelected(this);this.parent.setActiveEditor(this)}else{this.parent.setActiveEditor(null)}}setAspectRatio(t,e){this.#Me=true;const i=t/e;const{style:s}=this.div;s.aspectRatio=i;s.height="auto"}static get MIN_SIZE(){return 16}static canCreateNewEmptyEditor(){return true}get telemetryInitialData(){return{action:"added"}}get telemetryFinalData(){return null}_reportTelemetry(t,e=false){if(e){this.#We||=new Map;const{action:e}=t;let i=this.#We.get(e);if(i){clearTimeout(i)}i=setTimeout(()=>{this._reportTelemetry(t);this.#We.delete(e);if(this.#We.size===0){this.#We=null}},AnnotationEditor._telemetryTimeout);this.#We.set(e,i);return}t.type||=this.editorType;this._uiManager._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:t}})}show(t=this._isVisible){this.div.classList.toggle("hidden",!t);this._isVisible=t}enable(){if(this.div){this.div.tabIndex=0}this.#Se=false}disable(){if(this.div){this.div.tabIndex=-1}this.#Se=true}renderAnnotationElement(t){if(this.deleted){t.hide();return null}let e=t.container.querySelector(".annotationContent");if(!e){e=document.createElement("div");e.classList.add("annotationContent",this.editorType);t.container.prepend(e)}else if(e.nodeName==="CANVAS"){const t=e;e=document.createElement("div");e.classList.add("annotationContent",this.editorType);t.before(e)}return e}resetAnnotationElement(t){const{firstChild:e}=t.container;if(e?.nodeName==="DIV"&&e.classList.contains("annotationContent")){e.remove()}}}class FakeEditor extends AnnotationEditor{constructor(t){super(t);this.annotationElementId=t.annotationElementId;this.deleted=true}serialize(){return this.serializeDeleted()}}const SEED=3285377520;const MASK_HIGH=4294901760;const MASK_LOW=65535;class MurmurHash3_64{constructor(t){this.h1=t?t&4294967295:SEED;this.h2=t?t&4294967295:SEED}update(t){let e,i;if(typeof t==="string"){e=new Uint8Array(t.length*2);i=0;for(let s=0,n=t.length;s<n;s++){const n=t.charCodeAt(s);if(n<=255){e[i++]=n}else{e[i++]=n>>>8;e[i++]=n&255}}}else if(ArrayBuffer.isView(t)){e=t.slice();i=e.byteLength}else{throw new Error("Invalid data format, must be a string or TypedArray.")}const s=i>>2;const n=i-s*4;const r=new Uint32Array(e.buffer,0,s);let a=0,o=0;let l=this.h1,h=this.h2;const c=3432918353,d=461845907;const u=c&MASK_LOW,p=d&MASK_LOW;for(let t=0;t<s;t++){if(t&1){a=r[t];a=a*c&MASK_HIGH|a*u&MASK_LOW;a=a<<15|a>>>17;a=a*d&MASK_HIGH|a*p&MASK_LOW;l^=a;l=l<<13|l>>>19;l=l*5+3864292196}else{o=r[t];o=o*c&MASK_HIGH|o*u&MASK_LOW;o=o<<15|o>>>17;o=o*d&MASK_HIGH|o*p&MASK_LOW;h^=o;h=h<<13|h>>>19;h=h*5+3864292196}}a=0;switch(n){case 3:a^=e[s*4+2]<<16;case 2:a^=e[s*4+1]<<8;case 1:a^=e[s*4];a=a*c&MASK_HIGH|a*u&MASK_LOW;a=a<<15|a>>>17;a=a*d&MASK_HIGH|a*p&MASK_LOW;if(s&1){l^=a}else{h^=a}}this.h1=l;this.h2=h}hexdigest(){let t=this.h1,e=this.h2;t^=e>>>1;t=t*3981806797&MASK_HIGH|t*36045&MASK_LOW;e=e*4283543511&MASK_HIGH|((e<<16|t>>>16)*2950163797&MASK_HIGH)>>>16;t^=e>>>1;t=t*444984403&MASK_HIGH|t*60499&MASK_LOW;e=e*3301882366&MASK_HIGH|((e<<16|t>>>16)*3120437893&MASK_HIGH)>>>16;t^=e>>>1;return(t>>>0).toString(16).padStart(8,"0")+(e>>>0).toString(16).padStart(8,"0")}}const SerializableEmpty=Object.freeze({map:null,hash:"",transfer:undefined});class AnnotationStorage{#ui=false;#pi=null;#gi=new Map;constructor(){this.onSetModified=null;this.onResetModified=null;this.onAnnotationEditor=null}getValue(t,e){const i=this.#gi.get(t);if(i===undefined){return e}return Object.assign(e,i)}getRawValue(t){return this.#gi.get(t)}remove(t){this.#gi.delete(t);if(this.#gi.size===0){this.resetModified()}if(typeof this.onAnnotationEditor==="function"){for(const t of this.#gi.values()){if(t instanceof AnnotationEditor){return}}this.onAnnotationEditor(null)}}setValue(t,e){const i=this.#gi.get(t);let s=false;if(i!==undefined){for(const[t,n]of Object.entries(e)){if(i[t]!==n){s=true;i[t]=n}}}else{s=true;this.#gi.set(t,e)}if(s){this.#fi()}if(e instanceof AnnotationEditor&&typeof this.onAnnotationEditor==="function"){this.onAnnotationEditor(e.constructor._type)}}has(t){return this.#gi.has(t)}get size(){return this.#gi.size}#fi(){if(!this.#ui){this.#ui=true;if(typeof this.onSetModified==="function"){this.onSetModified()}}}resetModified(){if(this.#ui){this.#ui=false;if(typeof this.onResetModified==="function"){this.onResetModified()}}}get print(){return new PrintAnnotationStorage(this)}get serializable(){if(this.#gi.size===0){return SerializableEmpty}const t=new Map,e=new MurmurHash3_64,i=[];const s=Object.create(null);let n=false;for(const[i,r]of this.#gi){const a=r instanceof AnnotationEditor?r.serialize(false,s):r;if(a){t.set(i,a);e.update(`${i}:${JSON.stringify(a)}`);n||=!!a.bitmap}}if(n){for(const e of t.values()){if(e.bitmap){i.push(e.bitmap)}}}return t.size>0?{map:t,hash:e.hexdigest(),transfer:i}:SerializableEmpty}get editorStats(){let t=null;const e=new Map;for(const i of this.#gi.values()){if(!(i instanceof AnnotationEditor)){continue}const s=i.telemetryFinalData;if(!s){continue}const{type:n}=s;if(!e.has(n)){e.set(n,Object.getPrototypeOf(i).constructor)}t||=Object.create(null);const r=t[n]||=new Map;for(const[t,e]of Object.entries(s)){if(t==="type"){continue}let i=r.get(t);if(!i){i=new Map;r.set(t,i)}const s=i.get(e)??0;i.set(e,s+1)}}for(const[i,s]of e){t[i]=s.computeTelemetryFinalData(t[i])}return t}resetModifiedIds(){this.#pi=null}get modifiedIds(){if(this.#pi){return this.#pi}const t=[];for(const e of this.#gi.values()){if(!(e instanceof AnnotationEditor)||!e.annotationElementId||!e.serialize()){continue}t.push(e.annotationElementId)}return this.#pi={ids:new Set(t),hash:t.join(",")}}[Symbol.iterator](){return this.#gi.entries()}}class PrintAnnotationStorage extends AnnotationStorage{#mi;constructor(t){super();const{map:e,hash:i,transfer:s}=t.serializable;const n=structuredClone(e,s?{transfer:s}:null);this.#mi={map:n,hash:i,transfer:s}}get print(){unreachable("Should not call PrintAnnotationStorage.print")}get serializable(){return this.#mi}get modifiedIds(){return shadow(this,"modifiedIds",{ids:new Set,hash:""})}}class FontLoader{#bi=new Set;constructor({ownerDocument:t=globalThis.document,styleElement:e=null}){this._document=t;this.nativeFontFaces=new Set;this.styleElement=null;this.loadingRequests=[];this.loadTestFontId=0}addNativeFontFace(t){this.nativeFontFaces.add(t);this._document.fonts.add(t)}removeNativeFontFace(t){this.nativeFontFaces.delete(t);this._document.fonts.delete(t)}insertRule(t){if(!this.styleElement){this.styleElement=this._document.createElement("style");this._document.documentElement.getElementsByTagName("head")[0].append(this.styleElement)}const e=this.styleElement.sheet;e.insertRule(t,e.cssRules.length)}clear(){for(const t of this.nativeFontFaces){this._document.fonts.delete(t)}this.nativeFontFaces.clear();this.#bi.clear();if(this.styleElement){this.styleElement.remove();this.styleElement=null}}async loadSystemFont({systemFontInfo:t,disableFontFace:e,_inspectFont:i}){if(!t||this.#bi.has(t.loadedName)){return}assert(!e,"loadSystemFont shouldn't be called when `disableFontFace` is set.");if(this.isFontLoadingAPISupported){const{loadedName:e,src:s,style:n}=t;const r=new FontFace(e,s,n);this.addNativeFontFace(r);try{await r.load();this.#bi.add(e);i?.(t)}catch{warn(`Cannot load system font: ${t.baseFontName}, installing it could help to improve PDF rendering.`);this.removeNativeFontFace(r)}return}unreachable("Not implemented: loadSystemFont without the Font Loading API.")}async bind(t){if(t.attached||t.missingFile&&!t.systemFontInfo){return}t.attached=true;if(t.systemFontInfo){await this.loadSystemFont(t);return}if(this.isFontLoadingAPISupported){const e=t.createNativeFontFace();if(e){this.addNativeFontFace(e);try{await e.loaded}catch(i){warn(`Failed to load font '${e.family}': '${i}'.`);t.disableFontFace=true;throw i}}return}const e=t.createFontFaceRule();if(e){this.insertRule(e);if(this.isSyncFontLoadingSupported){return}await new Promise(e=>{const i=this._queueLoadingCallback(e);this._prepareFontLoadEvent(t,i)})}}get isFontLoadingAPISupported(){const t=!!this._document?.fonts;return shadow(this,"isFontLoadingAPISupported",t)}get isSyncFontLoadingSupported(){return shadow(this,"isSyncFontLoadingSupported",isNodeJS||util_FeatureTest.platform.isFirefox)}_queueLoadingCallback(t){function e(){assert(!s.done,"completeRequest() cannot be called twice.");s.done=true;while(i.length>0&&i[0].done){const t=i.shift();setTimeout(t.callback,0)}}const{loadingRequests:i}=this;const s={done:false,complete:e,callback:t};i.push(s);return s}get _loadTestFont(){const t=atob("T1RUTwALAIAAAwAwQ0ZGIDHtZg4AAAOYAAAAgUZGVE1lkzZwAAAEHAAAABxHREVGABQA"+"FQAABDgAAAAeT1MvMlYNYwkAAAEgAAAAYGNtYXABDQLUAAACNAAAAUJoZWFk/xVFDQAA"+"ALwAAAA2aGhlYQdkA+oAAAD0AAAAJGhtdHgD6AAAAAAEWAAAAAZtYXhwAAJQAAAAARgA"+"AAAGbmFtZVjmdH4AAAGAAAAAsXBvc3T/hgAzAAADeAAAACAAAQAAAAEAALZRFsRfDzz1"+"AAsD6AAAAADOBOTLAAAAAM4KHDwAAAAAA+gDIQAAAAgAAgAAAAAAAAABAAADIQAAAFoD"+"6AAAAAAD6AABAAAAAAAAAAAAAAAAAAAAAQAAUAAAAgAAAAQD6AH0AAUAAAKKArwAAACM"+"AooCvAAAAeAAMQECAAACAAYJAAAAAAAAAAAAAQAAAAAAAAAAAAAAAFBmRWQAwAAuAC4D"+"IP84AFoDIQAAAAAAAQAAAAAAAAAAACAAIAABAAAADgCuAAEAAAAAAAAAAQAAAAEAAAAA"+"AAEAAQAAAAEAAAAAAAIAAQAAAAEAAAAAAAMAAQAAAAEAAAAAAAQAAQAAAAEAAAAAAAUA"+"AQAAAAEAAAAAAAYAAQAAAAMAAQQJAAAAAgABAAMAAQQJAAEAAgABAAMAAQQJAAIAAgAB"+"AAMAAQQJAAMAAgABAAMAAQQJAAQAAgABAAMAAQQJAAUAAgABAAMAAQQJAAYAAgABWABY"+"AAAAAAAAAwAAAAMAAAAcAAEAAAAAADwAAwABAAAAHAAEACAAAAAEAAQAAQAAAC7//wAA"+"AC7////TAAEAAAAAAAABBgAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAAAAAAD/gwAyAAAAAQAAAAAAAAAAAAAAAAAA"+"AAABAAQEAAEBAQJYAAEBASH4DwD4GwHEAvgcA/gXBIwMAYuL+nz5tQXkD5j3CBLnEQAC"+"AQEBIVhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYAAABAQAADwACAQEEE/t3"+"Dov6fAH6fAT+fPp8+nwHDosMCvm1Cvm1DAz6fBQAAAAAAAABAAAAAMmJbzEAAAAAzgTj"+"FQAAAADOBOQpAAEAAAAAAAAADAAUAAQAAAABAAAAAgABAAAAAAAAAAAD6AAAAAAAAA==");return shadow(this,"_loadTestFont",t)}_prepareFontLoadEvent(t,e){function i(t,e){return t.charCodeAt(e)<<24|t.charCodeAt(e+1)<<16|t.charCodeAt(e+2)<<8|t.charCodeAt(e+3)&255}function s(t,e,i,s){const n=t.substring(0,e);const r=t.substring(e+i);return n+s+r}let n,r;const a=this._document.createElement("canvas");a.width=1;a.height=1;const o=a.getContext("2d");let l=0;function h(t,e){if(++l>30){warn("Load test font never loaded.");e();return}o.font="30px "+t;o.fillText(".",0,20);const i=o.getImageData(0,0,1,1);if(i.data[3]>0){e();return}setTimeout(h.bind(null,t,e))}const c=`lt${Date.now()}${this.loadTestFontId++}`;let d=this._loadTestFont;const u=976;d=s(d,u,c.length,c);const p=16;const g=1482184792;let f=i(d,p);for(n=0,r=c.length-3;n<r;n+=4){f=f-g+i(c,n)|0}if(n<c.length){f=f-g+i(c+"XXX",n)|0}d=s(d,p,4,string32(f));const m=`url(data:font/opentype;base64,${btoa(d)});`;const b=`@font-face {font-family:"${c}";src:${m}}`;this.insertRule(b);const A=this._document.createElement("div");A.style.visibility="hidden";A.style.width=A.style.height="10px";A.style.position="absolute";A.style.top=A.style.left="0px";for(const e of[t.loadedName,c]){const t=this._document.createElement("span");t.textContent="Hi";t.style.fontFamily=e;A.append(t)}this._document.body.append(A);h(c,()=>{A.remove();e.complete()})}}class FontFaceObject{constructor(t,e=null){this.compiledGlyphs=Object.create(null);for(const e in t){this[e]=t[e]}this._inspectFont=e}createNativeFontFace(){if(!this.data||this.disableFontFace){return null}let t;if(!this.cssFontInfo){t=new FontFace(this.loadedName,this.data,{})}else{const e={weight:this.cssFontInfo.fontWeight};if(this.cssFontInfo.italicAngle){e.style=`oblique ${this.cssFontInfo.italicAngle}deg`}t=new FontFace(this.cssFontInfo.fontFamily,this.data,e)}this._inspectFont?.(this);return t}createFontFaceRule(){if(!this.data||this.disableFontFace){return null}const t=`url(data:${this.mimetype};base64,${toBase64Util(this.data)});`;let e;if(!this.cssFontInfo){e=`@font-face {font-family:"${this.loadedName}";src:${t}}`}else{let i=`font-weight: ${this.cssFontInfo.fontWeight};`;if(this.cssFontInfo.italicAngle){i+=`font-style: oblique ${this.cssFontInfo.italicAngle}deg;`}e=`@font-face {font-family:"${this.cssFontInfo.fontFamily}";${i}src:${t}}`}this._inspectFont?.(this,t);return e}getPathGenerator(t,e){if(this.compiledGlyphs[e]!==undefined){return this.compiledGlyphs[e]}const i=this.loadedName+"_path_"+e;let s;try{s=t.get(i)}catch(t){warn(`getPathGenerator - ignoring character: "${t}".`)}const n=new Path2D(s||"");if(!this.fontExtraProperties){t.delete(i)}return this.compiledGlyphs[e]=n}}function getUrlProp(t){if(t instanceof URL){return t.href}if(typeof t==="string"){if(isNodeJS){return t}const e=URL.parse(t,window.location);if(e){return e.href}}throw new Error("Invalid PDF url data: "+"either string or URL-object is expected in the url property.")}function getDataProp(t){if(isNodeJS&&typeof Buffer!=="undefined"&&t instanceof Buffer){throw new Error("Please provide binary data as `Uint8Array`, rather than `Buffer`.")}if(t instanceof Uint8Array&&t.byteLength===t.buffer.byteLength){return t}if(typeof t==="string"){return stringToBytes(t)}if(t instanceof ArrayBuffer||ArrayBuffer.isView(t)||typeof t==="object"&&!isNaN(t?.length)){return new Uint8Array(t)}throw new Error("Invalid PDF binary data: either TypedArray, "+"string, or array-like object is expected in the data property.")}function getFactoryUrlProp(t){if(typeof t!=="string"){return null}if(t.endsWith("/")){return t}throw new Error(`Invalid factory url: "${t}" must include trailing slash.`)}const isRefProxy=t=>typeof t==="object"&&Number.isInteger(t?.num)&&t.num>=0&&Number.isInteger(t?.gen)&&t.gen>=0;const isNameProxy=t=>typeof t==="object"&&typeof t?.name==="string";const isValidExplicitDest=_isValidExplicitDest.bind(null,isRefProxy,isNameProxy);class LoopbackPort{#Ai=new Map;#yi=Promise.resolve();postMessage(t,e){const i={data:structuredClone(t,e?{transfer:e}:null)};this.#yi.then(()=>{for(const[t]of this.#Ai){t.call(this,i)}})}addEventListener(t,e,i=null){let s=null;if(i?.signal instanceof AbortSignal){const{signal:n}=i;if(n.aborted){warn("LoopbackPort - cannot use an `aborted` signal.");return}const r=()=>this.removeEventListener(t,e);s=()=>n.removeEventListener("abort",r);n.addEventListener("abort",r)}this.#Ai.set(e,s)}removeEventListener(t,e){const i=this.#Ai.get(e);i?.();this.#Ai.delete(e)}terminate(){for(const[,t]of this.#Ai){t?.()}this.#Ai.clear()}}const CallbackKind={DATA:1,ERROR:2};const StreamKind={CANCEL:1,CANCEL_COMPLETE:2,CLOSE:3,ENQUEUE:4,ERROR:5,PULL:6,PULL_COMPLETE:7,START_COMPLETE:8};function onFn(){}function wrapReason(t){if(t instanceof AbortException||t instanceof InvalidPDFException||t instanceof PasswordException||t instanceof ResponseException||t instanceof UnknownErrorException){return t}if(!(t instanceof Error||typeof t==="object"&&t!==null)){unreachable('wrapReason: Expected "reason" to be a (possibly cloned) Error.')}switch(t.name){case"AbortException":return new AbortException(t.message);case"InvalidPDFException":return new InvalidPDFException(t.message);case"PasswordException":return new PasswordException(t.message,t.code);case"ResponseException":return new ResponseException(t.message,t.status,t.missing);case"UnknownErrorException":return new UnknownErrorException(t.message,t.details)}return new UnknownErrorException(t.message,t.toString())}class MessageHandler{#wi=new AbortController;constructor(t,e,i){this.sourceName=t;this.targetName=e;this.comObj=i;this.callbackId=1;this.streamId=1;this.streamSinks=Object.create(null);this.streamControllers=Object.create(null);this.callbackCapabilities=Object.create(null);this.actionHandler=Object.create(null);i.addEventListener("message",this.#Ei.bind(this),{signal:this.#wi.signal})}#Ei({data:t}){if(t.targetName!==this.sourceName){return}if(t.stream){this.#vi(t);return}if(t.callback){const e=t.callbackId;const i=this.callbackCapabilities[e];if(!i){throw new Error(`Cannot resolve callback ${e}`)}delete this.callbackCapabilities[e];if(t.callback===CallbackKind.DATA){i.resolve(t.data)}else if(t.callback===CallbackKind.ERROR){i.reject(wrapReason(t.reason))}else{throw new Error("Unexpected callback case")}return}const e=this.actionHandler[t.action];if(!e){throw new Error(`Unknown action from worker: ${t.action}`)}if(t.callbackId){const i=this.sourceName,s=t.sourceName,n=this.comObj;Promise.try(e,t.data).then(function(e){n.postMessage({sourceName:i,targetName:s,callback:CallbackKind.DATA,callbackId:t.callbackId,data:e})},function(e){n.postMessage({sourceName:i,targetName:s,callback:CallbackKind.ERROR,callbackId:t.callbackId,reason:wrapReason(e)})});return}if(t.streamId){this.#xi(t);return}e(t.data)}on(t,e){const i=this.actionHandler;if(i[t]){throw new Error(`There is already an actionName called "${t}"`)}i[t]=e}send(t,e,i){this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:t,data:e},i)}sendWithPromise(t,e,i){const s=this.callbackId++;const n=Promise.withResolvers();this.callbackCapabilities[s]=n;try{this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:t,callbackId:s,data:e},i)}catch(t){n.reject(t)}return n.promise}sendWithStream(t,e,i,s){const n=this.streamId++,r=this.sourceName,a=this.targetName,o=this.comObj;return new ReadableStream({start:i=>{const l=Promise.withResolvers();this.streamControllers[n]={controller:i,startCall:l,pullCall:null,cancelCall:null,isClosed:false};o.postMessage({sourceName:r,targetName:a,action:t,streamId:n,data:e,desiredSize:i.desiredSize},s);return l.promise},pull:t=>{const e=Promise.withResolvers();this.streamControllers[n].pullCall=e;o.postMessage({sourceName:r,targetName:a,stream:StreamKind.PULL,streamId:n,desiredSize:t.desiredSize});return e.promise},cancel:t=>{assert(t instanceof Error,"cancel must have a valid reason");const e=Promise.withResolvers();this.streamControllers[n].cancelCall=e;this.streamControllers[n].isClosed=true;o.postMessage({sourceName:r,targetName:a,stream:StreamKind.CANCEL,streamId:n,reason:wrapReason(t)});return e.promise}},i)}#xi(t){const e=t.streamId,i=this.sourceName,s=t.sourceName,n=this.comObj;const r=this,a=this.actionHandler[t.action];const o={enqueue(t,r=1,a){if(this.isCancelled){return}const o=this.desiredSize;this.desiredSize-=r;if(o>0&&this.desiredSize<=0){this.sinkCapability=Promise.withResolvers();this.ready=this.sinkCapability.promise}n.postMessage({sourceName:i,targetName:s,stream:StreamKind.ENQUEUE,streamId:e,chunk:t},a)},close(){if(this.isCancelled){return}this.isCancelled=true;n.postMessage({sourceName:i,targetName:s,stream:StreamKind.CLOSE,streamId:e});delete r.streamSinks[e]},error(t){assert(t instanceof Error,"error must have a valid reason");if(this.isCancelled){return}this.isCancelled=true;n.postMessage({sourceName:i,targetName:s,stream:StreamKind.ERROR,streamId:e,reason:wrapReason(t)})},sinkCapability:Promise.withResolvers(),onPull:null,onCancel:null,isCancelled:false,desiredSize:t.desiredSize,ready:null};o.sinkCapability.resolve();o.ready=o.sinkCapability.promise;this.streamSinks[e]=o;Promise.try(a,t.data,o).then(function(){n.postMessage({sourceName:i,targetName:s,stream:StreamKind.START_COMPLETE,streamId:e,success:true})},function(t){n.postMessage({sourceName:i,targetName:s,stream:StreamKind.START_COMPLETE,streamId:e,reason:wrapReason(t)})})}#vi(t){const e=t.streamId,i=this.sourceName,s=t.sourceName,n=this.comObj;const r=this.streamControllers[e],a=this.streamSinks[e];switch(t.stream){case StreamKind.START_COMPLETE:if(t.success){r.startCall.resolve()}else{r.startCall.reject(wrapReason(t.reason))}break;case StreamKind.PULL_COMPLETE:if(t.success){r.pullCall.resolve()}else{r.pullCall.reject(wrapReason(t.reason))}break;case StreamKind.PULL:if(!a){n.postMessage({sourceName:i,targetName:s,stream:StreamKind.PULL_COMPLETE,streamId:e,success:true});break}if(a.desiredSize<=0&&t.desiredSize>0){a.sinkCapability.resolve()}a.desiredSize=t.desiredSize;Promise.try(a.onPull||onFn).then(function(){n.postMessage({sourceName:i,targetName:s,stream:StreamKind.PULL_COMPLETE,streamId:e,success:true})},function(t){n.postMessage({sourceName:i,targetName:s,stream:StreamKind.PULL_COMPLETE,streamId:e,reason:wrapReason(t)})});break;case StreamKind.ENQUEUE:assert(r,"enqueue should have stream controller");if(r.isClosed){break}r.controller.enqueue(t.chunk);break;case StreamKind.CLOSE:assert(r,"close should have stream controller");if(r.isClosed){break}r.isClosed=true;r.controller.close();this.#_i(r,e);break;case StreamKind.ERROR:assert(r,"error should have stream controller");r.controller.error(wrapReason(t.reason));this.#_i(r,e);break;case StreamKind.CANCEL_COMPLETE:if(t.success){r.cancelCall.resolve()}else{r.cancelCall.reject(wrapReason(t.reason))}this.#_i(r,e);break;case StreamKind.CANCEL:if(!a){break}const o=wrapReason(t.reason);Promise.try(a.onCancel||onFn,o).then(function(){n.postMessage({sourceName:i,targetName:s,stream:StreamKind.CANCEL_COMPLETE,streamId:e,success:true})},function(t){n.postMessage({sourceName:i,targetName:s,stream:StreamKind.CANCEL_COMPLETE,streamId:e,reason:wrapReason(t)})});a.sinkCapability.reject(o);a.isCancelled=true;delete this.streamSinks[e];break;default:throw new Error("Unexpected stream case")}}async#_i(t,e){await Promise.allSettled([t.startCall?.promise,t.pullCall?.promise,t.cancelCall?.promise]);delete this.streamControllers[e]}destroy(){this.#wi?.abort();this.#wi=null}}class BaseCanvasFactory{#Ti=false;constructor({enableHWA:t=false}){this.#Ti=t}create(t,e){if(t<=0||e<=0){throw new Error("Invalid canvas size")}const i=this._createCanvas(t,e);return{canvas:i,context:i.getContext("2d",{willReadFrequently:!this.#Ti})}}reset(t,e,i){if(!t.canvas){throw new Error("Canvas is not specified")}if(e<=0||i<=0){throw new Error("Invalid canvas size")}t.canvas.width=e;t.canvas.height=i}destroy(t){if(!t.canvas){throw new Error("Canvas is not specified")}t.canvas.width=0;t.canvas.height=0;t.canvas=null;t.context=null}_createCanvas(t,e){unreachable("Abstract method `_createCanvas` called.")}}class DOMCanvasFactory extends BaseCanvasFactory{constructor({ownerDocument:t=globalThis.document,enableHWA:e=false}){super({enableHWA:e});this._document=t}_createCanvas(t,e){const i=this._document.createElement("canvas");i.width=t;i.height=e;return i}}class BaseCMapReaderFactory{constructor({baseUrl:t=null,isCompressed:e=true}){this.baseUrl=t;this.isCompressed=e}async fetch({name:t}){if(!this.baseUrl){throw new Error("Ensure that the `cMapUrl` and `cMapPacked` API parameters are provided.")}if(!t){throw new Error("CMap name must be specified.")}const e=this.baseUrl+t+(this.isCompressed?".bcmap":"");return this._fetch(e).then(t=>({cMapData:t,isCompressed:this.isCompressed})).catch(t=>{throw new Error(`Unable to load ${this.isCompressed?"binary ":""}CMap at: ${e}`)})}async _fetch(t){unreachable("Abstract method `_fetch` called.")}}class DOMCMapReaderFactory extends BaseCMapReaderFactory{async _fetch(t){const e=await fetchData(t,this.isCompressed?"arraybuffer":"text");return e instanceof ArrayBuffer?new Uint8Array(e):stringToBytes(e)}}class BaseFilterFactory{addFilter(t){return"none"}addHCMFilter(t,e){return"none"}addAlphaFilter(t){return"none"}addLuminosityFilter(t){return"none"}addHighlightHCMFilter(t,e,i,s,n){return"none"}destroy(t=false){}}class DOMFilterFactory extends BaseFilterFactory{#Si;#Ci;#Di;#Mi;#Ii;#Pi;#w=0;constructor({docId:t,ownerDocument:e=globalThis.document}){super();this.#Mi=t;this.#Ii=e}get#v(){return this.#Ci||=new Map}get#ki(){return this.#Pi||=new Map}get#Ri(){if(!this.#Di){const t=this.#Ii.createElement("div");const{style:e}=t;e.visibility="hidden";e.contain="strict";e.width=e.height=0;e.position="absolute";e.top=e.left=0;e.zIndex=-1;const i=this.#Ii.createElementNS(SVG_NS,"svg");i.setAttribute("width",0);i.setAttribute("height",0);this.#Di=this.#Ii.createElementNS(SVG_NS,"defs");t.append(i);i.append(this.#Di);this.#Ii.body.append(t)}return this.#Di}#Li(t){if(t.length===1){const e=t[0];const i=new Array(256);for(let t=0;t<256;t++){i[t]=e[t]/255}const s=i.join(",");return[s,s,s]}const[e,i,s]=t;const n=new Array(256);const r=new Array(256);const a=new Array(256);for(let t=0;t<256;t++){n[t]=e[t]/255;r[t]=i[t]/255;a[t]=s[t]/255}return[n.join(","),r.join(","),a.join(",")]}#Fi(t){if(this.#Si===undefined){this.#Si="";const t=this.#Ii.URL;if(t!==this.#Ii.baseURI){if(isDataScheme(t)){warn('#createUrl: ignore "data:"-URL for performance reasons.')}else{this.#Si=updateUrlHash(t,"")}}}return`url(${this.#Si}#${t})`}addFilter(t){if(!t){return"none"}let e=this.#v.get(t);if(e){return e}const[i,s,n]=this.#Li(t);const r=t.length===1?i:`${i}${s}${n}`;e=this.#v.get(r);if(e){this.#v.set(t,e);return e}const a=`g_${this.#Mi}_transfer_map_${this.#w++}`;const o=this.#Fi(a);this.#v.set(t,o);this.#v.set(r,o);const l=this.#Oi(a);this.#Ni(i,s,n,l);return o}addHCMFilter(t,e){const i=`${t}-${e}`;const s="base";let n=this.#ki.get(s);if(n?.key===i){return n.url}if(n){n.filter?.remove();n.key=i;n.url="none";n.filter=null}else{n={key:i,url:"none",filter:null};this.#ki.set(s,n)}if(!t||!e){return n.url}const r=this.#Bi(t);t=Util.makeHexColor(...r);const a=this.#Bi(e);e=Util.makeHexColor(...a);this.#Ri.style.color="";if(t==="#000000"&&e==="#ffffff"||t===e){return n.url}const o=new Array(256);for(let t=0;t<=255;t++){const e=t/255;o[t]=e<=.03928?e/12.92:((e+.055)/1.055)**2.4}const l=o.join(",");const h=`g_${this.#Mi}_hcm_filter`;const c=n.filter=this.#Oi(h);this.#Ni(l,l,l,c);this.#Hi(c);const d=(t,e)=>{const i=r[t]/255;const s=a[t]/255;const n=new Array(e+1);for(let t=0;t<=e;t++){n[t]=i+t/e*(s-i)}return n.join(",")};this.#Ni(d(0,5),d(1,5),d(2,5),c);n.url=this.#Fi(h);return n.url}addAlphaFilter(t){let e=this.#v.get(t);if(e){return e}const[i]=this.#Li([t]);const s=`alpha_${i}`;e=this.#v.get(s);if(e){this.#v.set(t,e);return e}const n=`g_${this.#Mi}_alpha_map_${this.#w++}`;const r=this.#Fi(n);this.#v.set(t,r);this.#v.set(s,r);const a=this.#Oi(n);this.#Ui(i,a);return r}addLuminosityFilter(t){let e=this.#v.get(t||"luminosity");if(e){return e}let i,s;if(t){[i]=this.#Li([t]);s=`luminosity_${i}`}else{s="luminosity"}e=this.#v.get(s);if(e){this.#v.set(t,e);return e}const n=`g_${this.#Mi}_luminosity_map_${this.#w++}`;const r=this.#Fi(n);this.#v.set(t,r);this.#v.set(s,r);const a=this.#Oi(n);this.#Gi(a);if(t){this.#Ui(i,a)}return r}addHighlightHCMFilter(t,e,i,s,n){const r=`${e}-${i}-${s}-${n}`;let a=this.#ki.get(t);if(a?.key===r){return a.url}if(a){a.filter?.remove();a.key=r;a.url="none";a.filter=null}else{a={key:r,url:"none",filter:null};this.#ki.set(t,a)}if(!e||!i){return a.url}const[o,l]=[e,i].map(this.#Bi.bind(this));let h=Math.round(.2126*o[0]+.7152*o[1]+.0722*o[2]);let c=Math.round(.2126*l[0]+.7152*l[1]+.0722*l[2]);let[d,u]=[s,n].map(this.#Bi.bind(this));if(c<h){[h,c,d,u]=[c,h,u,d]}this.#Ri.style.color="";const p=(t,e,i)=>{const s=new Array(256);const n=(c-h)/i;const r=t/255;const a=(e-t)/(255*i);let o=0;for(let t=0;t<=i;t++){const e=Math.round(h+t*n);const i=r+t*a;for(let t=o;t<=e;t++){s[t]=i}o=e+1}for(let t=o;t<256;t++){s[t]=s[o-1]}return s.join(",")};const g=`g_${this.#Mi}_hcm_${t}_filter`;const f=a.filter=this.#Oi(g);this.#Hi(f);this.#Ni(p(d[0],u[0],5),p(d[1],u[1],5),p(d[2],u[2],5),f);a.url=this.#Fi(g);return a.url}destroy(t=false){if(t&&this.#Pi?.size){return}this.#Di?.parentNode.parentNode.remove();this.#Di=null;this.#Ci?.clear();this.#Ci=null;this.#Pi?.clear();this.#Pi=null;this.#w=0}#Gi(t){const e=this.#Ii.createElementNS(SVG_NS,"feColorMatrix");e.setAttribute("type","matrix");e.setAttribute("values","0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.3 0.59 0.11 0 0");t.append(e)}#Hi(t){const e=this.#Ii.createElementNS(SVG_NS,"feColorMatrix");e.setAttribute("type","matrix");e.setAttribute("values","0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0 0 0 1 0");t.append(e)}#Oi(t){const e=this.#Ii.createElementNS(SVG_NS,"filter");e.setAttribute("color-interpolation-filters","sRGB");e.setAttribute("id",t);this.#Ri.append(e);return e}#zi(t,e,i){const s=this.#Ii.createElementNS(SVG_NS,e);s.setAttribute("type","discrete");s.setAttribute("tableValues",i);t.append(s)}#Ni(t,e,i,s){const n=this.#Ii.createElementNS(SVG_NS,"feComponentTransfer");s.append(n);this.#zi(n,"feFuncR",t);this.#zi(n,"feFuncG",e);this.#zi(n,"feFuncB",i)}#Ui(t,e){const i=this.#Ii.createElementNS(SVG_NS,"feComponentTransfer");e.append(i);this.#zi(i,"feFuncA",t)}#Bi(t){this.#Ri.style.color=t;return getRGB(getComputedStyle(this.#Ri).getPropertyValue("color"))}}class BaseStandardFontDataFactory{constructor({baseUrl:t=null}){this.baseUrl=t}async fetch({filename:t}){if(!this.baseUrl){throw new Error("Ensure that the `standardFontDataUrl` API parameter is provided.")}if(!t){throw new Error("Font filename must be specified.")}const e=`${this.baseUrl}${t}`;return this._fetch(e).catch(t=>{throw new Error(`Unable to load font data at: ${e}`)})}async _fetch(t){unreachable("Abstract method `_fetch` called.")}}class DOMStandardFontDataFactory extends BaseStandardFontDataFactory{async _fetch(t){const e=await fetchData(t,"arraybuffer");return new Uint8Array(e)}}class BaseWasmFactory{constructor({baseUrl:t=null}){this.baseUrl=t}async fetch({filename:t}){if(!this.baseUrl){throw new Error("Ensure that the `wasmUrl` API parameter is provided.")}if(!t){throw new Error("Wasm filename must be specified.")}const e=`${this.baseUrl}${t}`;return this._fetch(e).catch(t=>{throw new Error(`Unable to load wasm data at: ${e}`)})}async _fetch(t){unreachable("Abstract method `_fetch` called.")}}class DOMWasmFactory extends BaseWasmFactory{async _fetch(t){const e=await fetchData(t,"arraybuffer");return new Uint8Array(e)}}if(isNodeJS){warn("Please use the `legacy` build in Node.js environments.")}async function node_utils_fetchData(t){const e=process.getBuiltinModule("fs");const i=await e.promises.readFile(t);return new Uint8Array(i)}class NodeFilterFactory extends BaseFilterFactory{}class NodeCanvasFactory extends BaseCanvasFactory{_createCanvas(t,e){const i=process.getBuiltinModule("module").createRequire(import.meta.url);const s=i("@napi-rs/canvas");return s.createCanvas(t,e)}}class NodeCMapReaderFactory extends BaseCMapReaderFactory{async _fetch(t){return node_utils_fetchData(t)}}class NodeStandardFontDataFactory extends BaseStandardFontDataFactory{async _fetch(t){return node_utils_fetchData(t)}}class NodeWasmFactory extends BaseWasmFactory{async _fetch(t){return node_utils_fetchData(t)}}const FORCED_DEPENDENCY_LABEL="__forcedDependency";class CanvasDependencyTracker{#Wi={__proto__:null};#$i={__proto__:null,transform:[],moveText:[],sameLineText:[],[FORCED_DEPENDENCY_LABEL]:[]};#Vi=new Map;#ji=[];#Ki=[];#Xi=[[1,0,0,1,0,0]];#qi=[-Infinity,-Infinity,Infinity,Infinity];#Yi=new Float64Array([Infinity,Infinity,-Infinity,-Infinity]);#Ji=-1;#Qi=new Set;#Zi=new Map;#ts=new Map;#es;#is;constructor(t){this.#es=t.width;this.#is=t.height}save(t){this.#Wi={__proto__:this.#Wi};this.#$i={__proto__:this.#$i,transform:{__proto__:this.#$i.transform},moveText:{__proto__:this.#$i.moveText},sameLineText:{__proto__:this.#$i.sameLineText},[FORCED_DEPENDENCY_LABEL]:{__proto__:this.#$i[FORCED_DEPENDENCY_LABEL]}};this.#qi={__proto__:this.#qi};this.#ji.push([t,null]);return this}restore(t){const e=Object.getPrototypeOf(this.#Wi);if(e===null){return this}this.#Wi=e;this.#$i=Object.getPrototypeOf(this.#$i);this.#qi=Object.getPrototypeOf(this.#qi);const i=this.#ji.pop();if(i!==undefined){i[1]=t}return this}recordOpenMarker(t){this.#ji.push([t,null]);return this}getOpenMarker(){if(this.#ji.length===0){return null}return this.#ji.at(-1)[0]}recordCloseMarker(t){const e=this.#ji.pop();if(e!==undefined){e[1]=t}return this}beginMarkedContent(t){this.#Ki.push([t,null]);return this}endMarkedContent(t){const e=this.#Ki.pop();if(e!==undefined){e[1]=t}return this}pushBaseTransform(t){this.#Xi.push(Util.multiplyByDOMMatrix(this.#Xi.at(-1),t.getTransform()));return this}popBaseTransform(){if(this.#Xi.length>1){this.#Xi.pop()}return this}recordSimpleData(t,e){this.#Wi[t]=e;return this}recordIncrementalData(t,e){this.#$i[t].push(e);return this}resetIncrementalData(t,e){this.#$i[t].length=0;return this}recordNamedData(t,e){this.#Vi.set(t,e);return this}recordFutureForcedDependency(t,e){this.recordIncrementalData(FORCED_DEPENDENCY_LABEL,e);return this}inheritSimpleDataAsFutureForcedDependencies(t){for(const e of t){if(e in this.#Wi){this.recordFutureForcedDependency(e,this.#Wi[e])}}return this}inheritPendingDependenciesAsFutureForcedDependencies(){for(const t of this.#Qi){this.recordFutureForcedDependency(FORCED_DEPENDENCY_LABEL,t)}return this}resetBBox(t){this.#Ji=t;this.#Yi[0]=Infinity;this.#Yi[1]=Infinity;this.#Yi[2]=-Infinity;this.#Yi[3]=-Infinity;return this}get hasPendingBBox(){return this.#Ji!==-1}recordClipBox(t,e,i,s,n,r){const a=Util.multiplyByDOMMatrix(this.#Xi.at(-1),e.getTransform());const o=[Infinity,Infinity,-Infinity,-Infinity];Util.axialAlignedBoundingBox([i,n,s,r],a,o);const l=Util.intersect(this.#qi,o);if(l){this.#qi[0]=l[0];this.#qi[1]=l[1];this.#qi[2]=l[2];this.#qi[3]=l[3]}else{this.#qi[0]=this.#qi[1]=Infinity;this.#qi[2]=this.#qi[3]=-Infinity}return this}recordBBox(t,e,i,s,n,r){const a=this.#qi;if(a[0]===Infinity){return this}const o=Util.multiplyByDOMMatrix(this.#Xi.at(-1),e.getTransform());if(a[0]===-Infinity){Util.axialAlignedBoundingBox([i,n,s,r],o,this.#Yi);return this}const l=[Infinity,Infinity,-Infinity,-Infinity];Util.axialAlignedBoundingBox([i,n,s,r],o,l);this.#Yi[0]=Math.min(this.#Yi[0],Math.max(l[0],a[0]));this.#Yi[1]=Math.min(this.#Yi[1],Math.max(l[1],a[1]));this.#Yi[2]=Math.max(this.#Yi[2],Math.min(l[2],a[2]));this.#Yi[3]=Math.max(this.#Yi[3],Math.min(l[3],a[3]));return this}recordCharacterBBox(t,e,i,s=1,n=0,r=0,a){const o=i.bbox;let l;let h;if(o){l=o[2]!==o[0]&&o[3]!==o[1]&&this.#ts.get(i);if(l!==false){h=[0,0,0,0];Util.axialAlignedBoundingBox(o,i.fontMatrix,h);if(s!==1||n!==0||r!==0){Util.scaleMinMax([s,0,0,-s,n,r],h)}if(l){return this.recordBBox(t,e,h[0],h[2],h[1],h[3])}}}if(!a){return this.recordFullPageBBox(t)}const c=a();if(o&&h&&l===undefined){l=h[0]<=n-c.actualBoundingBoxLeft&&h[2]>=n+c.actualBoundingBoxRight&&h[1]<=r-c.actualBoundingBoxAscent&&h[3]>=r+c.actualBoundingBoxDescent;this.#ts.set(i,l);if(l){return this.recordBBox(t,e,h[0],h[2],h[1],h[3])}}return this.recordBBox(t,e,n-c.actualBoundingBoxLeft,n+c.actualBoundingBoxRight,r-c.actualBoundingBoxAscent,r+c.actualBoundingBoxDescent)}recordFullPageBBox(t){this.#Yi[0]=Math.max(0,this.#qi[0]);this.#Yi[1]=Math.max(0,this.#qi[1]);this.#Yi[2]=Math.min(this.#es,this.#qi[2]);this.#Yi[3]=Math.min(this.#is,this.#qi[3]);return this}getSimpleIndex(t){return this.#Wi[t]}recordDependencies(t,e){const i=this.#Qi;const s=this.#Wi;const n=this.#$i;for(const t of e){if(t in this.#Wi){i.add(s[t])}else if(t in n){n[t].forEach(i.add,i)}}return this}copyDependenciesFromIncrementalOperation(t,e){const i=this.#Zi;const s=this.#Qi;for(const t of this.#$i[e]){i.get(t).dependencies.forEach(s.add,s.add(t))}return this}recordNamedDependency(t,e){if(this.#Vi.has(e)){this.#Qi.add(this.#Vi.get(e))}return this}recordOperation(t,e=false){this.recordDependencies(t,[FORCED_DEPENDENCY_LABEL]);const i=new Set(this.#Qi);const s=this.#ji.concat(this.#Ki);const n=this.#Ji===t?{minX:this.#Yi[0],minY:this.#Yi[1],maxX:this.#Yi[2],maxY:this.#Yi[3]}:null;this.#Zi.set(t,{bbox:n,pairs:s,dependencies:i});if(!e){this.#Ji=-1}this.#Qi.clear();return this}bboxToClipBoxDropOperation(t){if(this.#Ji!==-1){this.#Ji=-1;this.#qi[0]=Math.max(this.#qi[0],this.#Yi[0]);this.#qi[1]=Math.max(this.#qi[1],this.#Yi[1]);this.#qi[2]=Math.min(this.#qi[2],this.#Yi[2]);this.#qi[3]=Math.min(this.#qi[3],this.#Yi[3])}this.#Qi.clear();return this}_takePendingDependencies(){const t=this.#Qi;this.#Qi=new Set;return t}_extractOperation(t){const e=this.#Zi.get(t);this.#Zi.delete(t);return e}_pushPendingDependencies(t){for(const e of t){this.#Qi.add(e)}}take(){this.#ts.clear();return Array.from(this.#Zi,([t,{bbox:e,pairs:i,dependencies:s}])=>{i.forEach(t=>t.forEach(s.add,s));s.delete(t);return{minX:(e?.minX??0)/this.#es,maxX:(e?.maxX??this.#es)/this.#es,minY:(e?.minY??0)/this.#is,maxY:(e?.maxY??this.#is)/this.#is,dependencies:Array.from(s).sort((t,e)=>t-e),idx:t}})}}class CanvasNestedDependencyTracker{#ss;#ns;#rs=0;#as;#os=0;constructor(t,e){if(t instanceof CanvasNestedDependencyTracker){return t}this.#ss=t;this.#as=t._takePendingDependencies();this.#ns=e}save(t){this.#os++;this.#ss.save(this.#ns);return this}restore(t){if(this.#os>0){this.#ss.restore(this.#ns);this.#os--}return this}recordOpenMarker(t){this.#rs++;return this}getOpenMarker(){return this.#rs>0?this.#ns:this.#ss.getOpenMarker()}recordCloseMarker(t){this.#rs--;return this}beginMarkedContent(t){return this}endMarkedContent(t){return this}pushBaseTransform(t){this.#ss.pushBaseTransform(t);return this}popBaseTransform(){this.#ss.popBaseTransform();return this}recordSimpleData(t,e){this.#ss.recordSimpleData(t,this.#ns);return this}recordIncrementalData(t,e){this.#ss.recordIncrementalData(t,this.#ns);return this}resetIncrementalData(t,e){this.#ss.resetIncrementalData(t,this.#ns);return this}recordNamedData(t,e){return this}recordFutureForcedDependency(t,e){this.#ss.recordFutureForcedDependency(t,this.#ns);return this}inheritSimpleDataAsFutureForcedDependencies(t){this.#ss.inheritSimpleDataAsFutureForcedDependencies(t);return this}inheritPendingDependenciesAsFutureForcedDependencies(){this.#ss.inheritPendingDependenciesAsFutureForcedDependencies();return this}resetBBox(t){if(!this.#ss.hasPendingBBox){this.#ss.resetBBox(this.#ns)}return this}get hasPendingBBox(){return this.#ss.hasPendingBBox}recordClipBox(t,e,i,s,n,r){this.#ss.recordClipBox(this.#ns,e,i,s,n,r);return this}recordBBox(t,e,i,s,n,r){this.#ss.recordBBox(this.#ns,e,i,s,n,r);return this}recordCharacterBBox(t,e,i,s,n,r,a){this.#ss.recordCharacterBBox(this.#ns,e,i,s,n,r,a);return this}recordFullPageBBox(t){this.#ss.recordFullPageBBox(this.#ns);return this}getSimpleIndex(t){return this.#ss.getSimpleIndex(t)}recordDependencies(t,e){this.#ss.recordDependencies(this.#ns,e);return this}copyDependenciesFromIncrementalOperation(t,e){this.#ss.copyDependenciesFromIncrementalOperation(this.#ns,e);return this}recordNamedDependency(t,e){this.#ss.recordNamedDependency(this.#ns,e);return this}recordOperation(t){this.#ss.recordOperation(this.#ns,true);const e=this.#ss._extractOperation(this.#ns);for(const t of e.dependencies){this.#as.add(t)}this.#as.delete(this.#ns);this.#as.delete(null);return this}bboxToClipBoxDropOperation(t){this.#ss.bboxToClipBoxDropOperation(this.#ns);return this}recordNestedDependencies(){this.#ss._pushPendingDependencies(this.#as)}take(){throw new Error("Unreachable")}}const Dependencies={stroke:["path","transform","filter","strokeColor","strokeAlpha","lineWidth","lineCap","lineJoin","miterLimit","dash"],fill:["path","transform","filter","fillColor","fillAlpha","globalCompositeOperation","SMask"],imageXObject:["transform","SMask","filter","fillAlpha","strokeAlpha","globalCompositeOperation"],rawFillPath:["filter","fillColor","fillAlpha"],showText:["transform","leading","charSpacing","wordSpacing","hScale","textRise","moveText","textMatrix","font","filter","fillColor","textRenderingMode","SMask","fillAlpha","strokeAlpha","globalCompositeOperation"],transform:["transform"],transformAndFill:["transform","fillColor"]};const PathType={FILL:"Fill",STROKE:"Stroke",SHADING:"Shading"};function applyBoundingBox(t,e){if(!e){return}const i=e[2]-e[0];const s=e[3]-e[1];const n=new Path2D;n.rect(e[0],e[1],i,s);t.clip(n)}class BaseShadingPattern{isModifyingCurrentTransform(){return false}getPattern(){unreachable("Abstract method `getPattern` called.")}}class RadialAxialShadingPattern extends BaseShadingPattern{constructor(t){super();this._type=t[1];this._bbox=t[2];this._colorStops=t[3];this._p0=t[4];this._p1=t[5];this._r0=t[6];this._r1=t[7];this.matrix=null}_createGradient(t){let e;if(this._type==="axial"){e=t.createLinearGradient(this._p0[0],this._p0[1],this._p1[0],this._p1[1])}else if(this._type==="radial"){e=t.createRadialGradient(this._p0[0],this._p0[1],this._r0,this._p1[0],this._p1[1],this._r1)}for(const t of this._colorStops){e.addColorStop(t[0],t[1])}return e}getPattern(t,e,i,s){let n;if(s===PathType.STROKE||s===PathType.FILL){const r=e.current.getClippedPathBoundingBox(s,getCurrentTransform(t))||[0,0,0,0];const a=Math.ceil(r[2]-r[0])||1;const o=Math.ceil(r[3]-r[1])||1;const l=e.cachedCanvases.getCanvas("pattern",a,o);const h=l.context;h.clearRect(0,0,h.canvas.width,h.canvas.height);h.beginPath();h.rect(0,0,h.canvas.width,h.canvas.height);h.translate(-r[0],-r[1]);i=Util.transform(i,[1,0,0,1,r[0],r[1]]);h.transform(...e.baseTransform);if(this.matrix){h.transform(...this.matrix)}applyBoundingBox(h,this._bbox);h.fillStyle=this._createGradient(h);h.fill();n=t.createPattern(l.canvas,"no-repeat");const c=new DOMMatrix(i);n.setTransform(c)}else{applyBoundingBox(t,this._bbox);n=this._createGradient(t)}return n}}function drawTriangle(t,e,i,s,n,r,a,o){const l=e.coords,h=e.colors;const c=t.data,d=t.width*4;let u;if(l[i+1]>l[s+1]){u=i;i=s;s=u;u=r;r=a;a=u}if(l[s+1]>l[n+1]){u=s;s=n;n=u;u=a;a=o;o=u}if(l[i+1]>l[s+1]){u=i;i=s;s=u;u=r;r=a;a=u}const p=(l[i]+e.offsetX)*e.scaleX;const g=(l[i+1]+e.offsetY)*e.scaleY;const f=(l[s]+e.offsetX)*e.scaleX;const m=(l[s+1]+e.offsetY)*e.scaleY;const b=(l[n]+e.offsetX)*e.scaleX;const A=(l[n+1]+e.offsetY)*e.scaleY;if(g>=A){return}const y=h[r],w=h[r+1],E=h[r+2];const v=h[a],x=h[a+1],_=h[a+2];const T=h[o],S=h[o+1],C=h[o+2];const D=Math.round(g),M=Math.round(A);let I,P,k,R;let L,F,O,N;for(let t=D;t<=M;t++){if(t<m){const e=t<g?0:(g-t)/(g-m);I=p-(p-f)*e;P=y-(y-v)*e;k=w-(w-x)*e;R=E-(E-_)*e}else{let e;if(t>A){e=1}else if(m===A){e=0}else{e=(m-t)/(m-A)}I=f-(f-b)*e;P=v-(v-T)*e;k=x-(x-S)*e;R=_-(_-C)*e}let e;if(t<g){e=0}else if(t>A){e=1}else{e=(g-t)/(g-A)}L=p-(p-b)*e;F=y-(y-T)*e;O=w-(w-S)*e;N=E-(E-C)*e;const i=Math.round(Math.min(I,L));const s=Math.round(Math.max(I,L));let n=d*t+i*4;for(let t=i;t<=s;t++){e=(I-t)/(I-L);if(e<0){e=0}else if(e>1){e=1}c[n++]=P-(P-F)*e|0;c[n++]=k-(k-O)*e|0;c[n++]=R-(R-N)*e|0;c[n++]=255}}}function drawFigure(t,e,i){const s=e.coords;const n=e.colors;let r,a;switch(e.type){case"lattice":const o=e.verticesPerRow;const l=Math.floor(s.length/o)-1;const h=o-1;for(r=0;r<l;r++){let e=r*o;for(let r=0;r<h;r++,e++){drawTriangle(t,i,s[e],s[e+1],s[e+o],n[e],n[e+1],n[e+o]);drawTriangle(t,i,s[e+o+1],s[e+1],s[e+o],n[e+o+1],n[e+1],n[e+o])}}break;case"triangles":for(r=0,a=s.length;r<a;r+=3){drawTriangle(t,i,s[r],s[r+1],s[r+2],n[r],n[r+1],n[r+2])}break;default:throw new Error("illegal figure")}}class MeshShadingPattern extends BaseShadingPattern{constructor(t){super();this._coords=t[2];this._colors=t[3];this._figures=t[4];this._bounds=t[5];this._bbox=t[6];this._background=t[7];this.matrix=null}_createMeshCanvas(t,e,i){const s=1.1;const n=3e3;const r=2;const a=Math.floor(this._bounds[0]);const o=Math.floor(this._bounds[1]);const l=Math.ceil(this._bounds[2])-a;const h=Math.ceil(this._bounds[3])-o;const c=Math.min(Math.ceil(Math.abs(l*t[0]*s)),n);const d=Math.min(Math.ceil(Math.abs(h*t[1]*s)),n);const u=l/c;const p=h/d;const g={coords:this._coords,colors:this._colors,offsetX:-a,offsetY:-o,scaleX:1/u,scaleY:1/p};const f=c+r*2;const m=d+r*2;const b=i.getCanvas("mesh",f,m);const A=b.context;const y=A.createImageData(c,d);if(e){const t=y.data;for(let i=0,s=t.length;i<s;i+=4){t[i]=e[0];t[i+1]=e[1];t[i+2]=e[2];t[i+3]=255}}for(const t of this._figures){drawFigure(y,t,g)}A.putImageData(y,r,r);const w=b.canvas;return{canvas:w,offsetX:a-r*u,offsetY:o-r*p,scaleX:u,scaleY:p}}isModifyingCurrentTransform(){return true}getPattern(t,e,i,s){applyBoundingBox(t,this._bbox);const n=new Float32Array(2);if(s===PathType.SHADING){Util.singularValueDecompose2dScale(getCurrentTransform(t),n)}else if(this.matrix){Util.singularValueDecompose2dScale(this.matrix,n);const[t,i]=n;Util.singularValueDecompose2dScale(e.baseTransform,n);n[0]*=t;n[1]*=i}else{Util.singularValueDecompose2dScale(e.baseTransform,n)}const r=this._createMeshCanvas(n,s===PathType.SHADING?null:this._background,e.cachedCanvases);if(s!==PathType.SHADING){t.setTransform(...e.baseTransform);if(this.matrix){t.transform(...this.matrix)}}t.translate(r.offsetX,r.offsetY);t.scale(r.scaleX,r.scaleY);return t.createPattern(r.canvas,"no-repeat")}}class DummyShadingPattern extends BaseShadingPattern{getPattern(){return"hotpink"}}function getShadingPattern(t){switch(t[0]){case"RadialAxial":return new RadialAxialShadingPattern(t);case"Mesh":return new MeshShadingPattern(t);case"Dummy":return new DummyShadingPattern}throw new Error(`Unknown IR type: ${t[0]}`)}const PaintType={COLORED:1,UNCOLORED:2};class TilingPattern{static MAX_PATTERN_SIZE=3e3;constructor(t,e,i,s){this.color=t[1];this.operatorList=t[2];this.matrix=t[3];this.bbox=t[4];this.xstep=t[5];this.ystep=t[6];this.paintType=t[7];this.tilingType=t[8];this.ctx=e;this.canvasGraphicsFactory=i;this.baseTransform=s}createPatternCanvas(t){const{bbox:e,operatorList:i,paintType:s,tilingType:n,color:r,canvasGraphicsFactory:a}=this;let{xstep:o,ystep:l}=this;o=Math.abs(o);l=Math.abs(l);info("TilingType: "+n);const h=e[0],c=e[1],d=e[2],u=e[3];const p=d-h;const g=u-c;const f=new Float32Array(2);Util.singularValueDecompose2dScale(this.matrix,f);const[m,b]=f;Util.singularValueDecompose2dScale(this.baseTransform,f);const A=m*f[0];const y=b*f[1];let w=p,E=g,v=false,x=false;const _=Math.ceil(o*A);const T=Math.ceil(l*y);const S=Math.ceil(p*A);const C=Math.ceil(g*y);if(_>=S){w=o}else{v=true}if(T>=C){E=l}else{x=true}const D=this.getSizeAndScale(w,this.ctx.canvas.width,A);const M=this.getSizeAndScale(E,this.ctx.canvas.height,y);const I=t.cachedCanvases.getCanvas("pattern",D.size,M.size);const P=I.context;const k=a.createCanvasGraphics(P);k.groupLevel=t.groupLevel;this.setFillAndStrokeStyleToContext(k,s,r);P.translate(-D.scale*h,-M.scale*c);k.transform(0,D.scale,0,0,M.scale,0,0);P.save();k.dependencyTracker?.save();this.clipBbox(k,h,c,d,u);k.baseTransform=getCurrentTransform(k.ctx);k.executeOperatorList(i);k.endDrawing();k.dependencyTracker?.restore().recordNestedDependencies?.();P.restore();if(v||x){const e=I.canvas;if(v){w=o}if(x){E=l}const i=this.getSizeAndScale(w,this.ctx.canvas.width,A);const s=this.getSizeAndScale(E,this.ctx.canvas.height,y);const n=i.size;const r=s.size;const a=t.cachedCanvases.getCanvas("pattern-workaround",n,r);const d=a.context;const u=v?Math.floor(p/o):0;const f=x?Math.floor(g/l):0;for(let t=0;t<=u;t++){for(let i=0;i<=f;i++){d.drawImage(e,n*t,r*i,n,r,0,0,n,r)}}return{canvas:a.canvas,scaleX:i.scale,scaleY:s.scale,offsetX:h,offsetY:c}}return{canvas:I.canvas,scaleX:D.scale,scaleY:M.scale,offsetX:h,offsetY:c}}getSizeAndScale(t,e,i){const s=Math.max(TilingPattern.MAX_PATTERN_SIZE,e);let n=Math.ceil(t*i);if(n>=s){n=s}else{i=n/t}return{scale:i,size:n}}clipBbox(t,e,i,s,n){const r=s-e;const a=n-i;t.ctx.rect(e,i,r,a);Util.axialAlignedBoundingBox([e,i,s,n],getCurrentTransform(t.ctx),t.current.minMax);t.clip();t.endPath()}setFillAndStrokeStyleToContext(t,e,i){const s=t.ctx,n=t.current;switch(e){case PaintType.COLORED:const{fillStyle:t,strokeStyle:r}=this.ctx;s.fillStyle=n.fillColor=t;s.strokeStyle=n.strokeColor=r;break;case PaintType.UNCOLORED:s.fillStyle=s.strokeStyle=i;n.fillColor=n.strokeColor=i;break;default:throw new FormatError(`Unsupported paint type: ${e}`)}}isModifyingCurrentTransform(){return false}getPattern(t,e,i,s){let n=i;if(s!==PathType.SHADING){n=Util.transform(n,e.baseTransform);if(this.matrix){n=Util.transform(n,this.matrix)}}const r=this.createPatternCanvas(e);let a=new DOMMatrix(n);a=a.translate(r.offsetX,r.offsetY);a=a.scale(1/r.scaleX,1/r.scaleY);const o=t.createPattern(r.canvas,"repeat");o.setTransform(a);return o}}function convertToRGBA(t){switch(t.kind){case ImageKind.GRAYSCALE_1BPP:return convertBlackAndWhiteToRGBA(t);case ImageKind.RGB_24BPP:return convertRGBToRGBA(t)}return null}function convertBlackAndWhiteToRGBA({src:t,srcPos:e=0,dest:i,width:s,height:n,nonBlackColor:r=4294967295,inverseDecode:a=false}){const o=util_FeatureTest.isLittleEndian?4278190080:255;const[l,h]=a?[r,o]:[o,r];const c=s>>3;const d=s&7;const u=t.length;i=new Uint32Array(i.buffer);let p=0;for(let s=0;s<n;s++){for(const s=e+c;e<s;e++){const s=e<u?t[e]:255;i[p++]=s&128?h:l;i[p++]=s&64?h:l;i[p++]=s&32?h:l;i[p++]=s&16?h:l;i[p++]=s&8?h:l;i[p++]=s&4?h:l;i[p++]=s&2?h:l;i[p++]=s&1?h:l}if(d===0){continue}const s=e<u?t[e++]:255;for(let t=0;t<d;t++){i[p++]=s&1<<7-t?h:l}}return{srcPos:e,destPos:p}}function convertRGBToRGBA({src:t,srcPos:e=0,dest:i,destPos:s=0,width:n,height:r}){let a=0;const o=n*r*3;const l=o>>2;const h=new Uint32Array(t.buffer,e,l);if(FeatureTest.isLittleEndian){for(;a<l-2;a+=3,s+=4){const t=h[a];const e=h[a+1];const n=h[a+2];i[s]=t|4278190080;i[s+1]=t>>>24|e<<8|4278190080;i[s+2]=e>>>16|n<<16|4278190080;i[s+3]=n>>>8|4278190080}for(let n=a*4,r=e+o;n<r;n+=3){i[s++]=t[n]|t[n+1]<<8|t[n+2]<<16|4278190080}}else{for(;a<l-2;a+=3,s+=4){const t=h[a];const e=h[a+1];const n=h[a+2];i[s]=t|255;i[s+1]=t<<24|e>>>8|255;i[s+2]=e<<16|n>>>16|255;i[s+3]=n<<8|255}for(let n=a*4,r=e+o;n<r;n+=3){i[s++]=t[n]<<24|t[n+1]<<16|t[n+2]<<8|255}}return{srcPos:e+o,destPos:s}}function grayToRGBA(t,e){if(FeatureTest.isLittleEndian){for(let i=0,s=t.length;i<s;i++){e[i]=t[i]*65793|4278190080}}else{for(let i=0,s=t.length;i<s;i++){e[i]=t[i]*16843008|255}}}const MIN_FONT_SIZE=16;const MAX_FONT_SIZE=100;const EXECUTION_TIME=15;const EXECUTION_STEPS=10;const FULL_CHUNK_HEIGHT=16;const SCALE_MATRIX=new DOMMatrix;const XY=new Float32Array(2);const MIN_MAX_INIT=new Float32Array([Infinity,Infinity,-Infinity,-Infinity]);function mirrorContextOperations(t,e){if(t._removeMirroring){throw new Error("Context is already forwarding operations.")}t.__originalSave=t.save;t.__originalRestore=t.restore;t.__originalRotate=t.rotate;t.__originalScale=t.scale;t.__originalTranslate=t.translate;t.__originalTransform=t.transform;t.__originalSetTransform=t.setTransform;t.__originalResetTransform=t.resetTransform;t.__originalClip=t.clip;t.__originalMoveTo=t.moveTo;t.__originalLineTo=t.lineTo;t.__originalBezierCurveTo=t.bezierCurveTo;t.__originalRect=t.rect;t.__originalClosePath=t.closePath;t.__originalBeginPath=t.beginPath;t._removeMirroring=()=>{t.save=t.__originalSave;t.restore=t.__originalRestore;t.rotate=t.__originalRotate;t.scale=t.__originalScale;t.translate=t.__originalTranslate;t.transform=t.__originalTransform;t.setTransform=t.__originalSetTransform;t.resetTransform=t.__originalResetTransform;t.clip=t.__originalClip;t.moveTo=t.__originalMoveTo;t.lineTo=t.__originalLineTo;t.bezierCurveTo=t.__originalBezierCurveTo;t.rect=t.__originalRect;t.closePath=t.__originalClosePath;t.beginPath=t.__originalBeginPath;delete t._removeMirroring};t.save=function(){e.save();this.__originalSave()};t.restore=function(){e.restore();this.__originalRestore()};t.translate=function(t,i){e.translate(t,i);this.__originalTranslate(t,i)};t.scale=function(t,i){e.scale(t,i);this.__originalScale(t,i)};t.transform=function(t,i,s,n,r,a){e.transform(t,i,s,n,r,a);this.__originalTransform(t,i,s,n,r,a)};t.setTransform=function(t,i,s,n,r,a){e.setTransform(t,i,s,n,r,a);this.__originalSetTransform(t,i,s,n,r,a)};t.resetTransform=function(){e.resetTransform();this.__originalResetTransform()};t.rotate=function(t){e.rotate(t);this.__originalRotate(t)};t.clip=function(t){e.clip(t);this.__originalClip(t)};t.moveTo=function(t,i){e.moveTo(t,i);this.__originalMoveTo(t,i)};t.lineTo=function(t,i){e.lineTo(t,i);this.__originalLineTo(t,i)};t.bezierCurveTo=function(t,i,s,n,r,a){e.bezierCurveTo(t,i,s,n,r,a);this.__originalBezierCurveTo(t,i,s,n,r,a)};t.rect=function(t,i,s,n){e.rect(t,i,s,n);this.__originalRect(t,i,s,n)};t.closePath=function(){e.closePath();this.__originalClosePath()};t.beginPath=function(){e.beginPath();this.__originalBeginPath()}}class CachedCanvases{constructor(t){this.canvasFactory=t;this.cache=Object.create(null)}getCanvas(t,e,i){let s;if(this.cache[t]!==undefined){s=this.cache[t];this.canvasFactory.reset(s,e,i)}else{s=this.canvasFactory.create(e,i);this.cache[t]=s}return s}delete(t){delete this.cache[t]}clear(){for(const t in this.cache){const e=this.cache[t];this.canvasFactory.destroy(e);delete this.cache[t]}}}function drawImageAtIntegerCoords(t,e,i,s,n,r,a,o,l,h){const[c,d,u,p,g,f]=getCurrentTransform(t);if(d===0&&u===0){const m=a*c+g;const b=Math.round(m);const A=o*p+f;const y=Math.round(A);const w=(a+l)*c+g;const E=Math.abs(Math.round(w)-b)||1;const v=(o+h)*p+f;const x=Math.abs(Math.round(v)-y)||1;t.setTransform(Math.sign(c),0,0,Math.sign(p),b,y);t.drawImage(e,i,s,n,r,0,0,E,x);t.setTransform(c,d,u,p,g,f);return[E,x]}if(c===0&&p===0){const m=o*u+g;const b=Math.round(m);const A=a*d+f;const y=Math.round(A);const w=(o+h)*u+g;const E=Math.abs(Math.round(w)-b)||1;const v=(a+l)*d+f;const x=Math.abs(Math.round(v)-y)||1;t.setTransform(0,Math.sign(d),Math.sign(u),0,b,y);t.drawImage(e,i,s,n,r,0,0,x,E);t.setTransform(c,d,u,p,g,f);return[x,E]}t.drawImage(e,i,s,n,r,a,o,l,h);const m=Math.hypot(c,d);const b=Math.hypot(u,p);return[m*l,b*h]}class CanvasExtraState{alphaIsShape=false;fontSize=0;fontSizeScale=1;textMatrix=null;textMatrixScale=1;fontMatrix=FONT_IDENTITY_MATRIX;leading=0;x=0;y=0;lineX=0;lineY=0;charSpacing=0;wordSpacing=0;textHScale=1;textRenderingMode=TextRenderingMode.FILL;textRise=0;fillColor="#000000";strokeColor="#000000";patternFill=false;patternStroke=false;fillAlpha=1;strokeAlpha=1;lineWidth=1;activeSMask=null;transferMaps="none";constructor(t,e,i){i?.(this);this.clipBox=new Float32Array([0,0,t,e]);this.minMax=MIN_MAX_INIT.slice()}clone(){const t=Object.create(this);t.clipBox=this.clipBox.slice();t.minMax=this.minMax.slice();return t}getPathBoundingBox(t=PathType.FILL,e=null){const i=this.minMax.slice();if(t===PathType.STROKE){if(!e){unreachable("Stroke bounding box must include transform.")}Util.singularValueDecompose2dScale(e,XY);const t=XY[0]*this.lineWidth/2;const s=XY[1]*this.lineWidth/2;i[0]-=t;i[1]-=s;i[2]+=t;i[3]+=s}return i}updateClipFromPath(){const t=Util.intersect(this.clipBox,this.getPathBoundingBox());this.startNewPathAndClipBox(t||[0,0,0,0])}isEmptyClip(){return this.minMax[0]===Infinity}startNewPathAndClipBox(t){this.clipBox.set(t,0);this.minMax.set(MIN_MAX_INIT,0)}getClippedPathBoundingBox(t=PathType.FILL,e=null){return Util.intersect(this.clipBox,this.getPathBoundingBox(t,e))}}function putBinaryImageData(t,e){if(e instanceof ImageData){t.putImageData(e,0,0);return}const i=e.height,s=e.width;const n=i%FULL_CHUNK_HEIGHT;const r=(i-n)/FULL_CHUNK_HEIGHT;const a=n===0?r:r+1;const o=t.createImageData(s,FULL_CHUNK_HEIGHT);let l=0,h;const c=e.data;const d=o.data;let u,p,g,f;if(e.kind===util_ImageKind.GRAYSCALE_1BPP){const e=c.byteLength;const i=new Uint32Array(d.buffer,0,d.byteLength>>2);const f=i.length;const m=s+7>>3;const b=4294967295;const A=util_FeatureTest.isLittleEndian?4278190080:255;for(u=0;u<a;u++){g=u<r?FULL_CHUNK_HEIGHT:n;h=0;for(p=0;p<g;p++){const t=e-l;let n=0;const r=t>m?s:t*8-7;const a=r&~7;let o=0;let d=0;for(;n<a;n+=8){d=c[l++];i[h++]=d&128?b:A;i[h++]=d&64?b:A;i[h++]=d&32?b:A;i[h++]=d&16?b:A;i[h++]=d&8?b:A;i[h++]=d&4?b:A;i[h++]=d&2?b:A;i[h++]=d&1?b:A}for(;n<r;n++){if(o===0){d=c[l++];o=128}i[h++]=d&o?b:A;o>>=1}}while(h<f){i[h++]=0}t.putImageData(o,0,u*FULL_CHUNK_HEIGHT)}}else if(e.kind===util_ImageKind.RGBA_32BPP){p=0;f=s*FULL_CHUNK_HEIGHT*4;for(u=0;u<r;u++){d.set(c.subarray(l,l+f));l+=f;t.putImageData(o,0,p);p+=FULL_CHUNK_HEIGHT}if(u<a){f=s*n*4;d.set(c.subarray(l,l+f));t.putImageData(o,0,p)}}else if(e.kind===util_ImageKind.RGB_24BPP){g=FULL_CHUNK_HEIGHT;f=s*g;for(u=0;u<a;u++){if(u>=r){g=n;f=s*g}h=0;for(p=f;p--;){d[h++]=c[l++];d[h++]=c[l++];d[h++]=c[l++];d[h++]=255}t.putImageData(o,0,u*FULL_CHUNK_HEIGHT)}}else{throw new Error(`bad image kind: ${e.kind}`)}}function putBinaryImageMask(t,e){if(e.bitmap){t.drawImage(e.bitmap,0,0);return}const i=e.height,s=e.width;const n=i%FULL_CHUNK_HEIGHT;const r=(i-n)/FULL_CHUNK_HEIGHT;const a=n===0?r:r+1;const o=t.createImageData(s,FULL_CHUNK_HEIGHT);let l=0;const h=e.data;const c=o.data;for(let e=0;e<a;e++){const i=e<r?FULL_CHUNK_HEIGHT:n;({srcPos:l}=convertBlackAndWhiteToRGBA({src:h,srcPos:l,dest:c,width:s,height:i,nonBlackColor:0}));t.putImageData(o,0,e*FULL_CHUNK_HEIGHT)}}function copyCtxState(t,e){const i=["strokeStyle","fillStyle","fillRule","globalAlpha","lineWidth","lineCap","lineJoin","miterLimit","globalCompositeOperation","font","filter"];for(const s of i){if(t[s]!==undefined){e[s]=t[s]}}if(t.setLineDash!==undefined){e.setLineDash(t.getLineDash());e.lineDashOffset=t.lineDashOffset}}function resetCtxToDefault(t){t.strokeStyle=t.fillStyle="#000000";t.fillRule="nonzero";t.globalAlpha=1;t.lineWidth=1;t.lineCap="butt";t.lineJoin="miter";t.miterLimit=10;t.globalCompositeOperation="source-over";t.font="10px sans-serif";if(t.setLineDash!==undefined){t.setLineDash([]);t.lineDashOffset=0}const{filter:e}=t;if(e!=="none"&&e!==""){t.filter="none"}}function getImageSmoothingEnabled(t,e){if(e){return true}Util.singularValueDecompose2dScale(t,XY);const i=Math.fround(OutputScale.pixelRatio*PixelsPerInch.PDF_TO_CSS_UNITS);return XY[0]<=i&&XY[1]<=i}const LINE_CAP_STYLES=["butt","round","square"];const LINE_JOIN_STYLES=["miter","round","bevel"];const NORMAL_CLIP={};const EO_CLIP={};class CanvasGraphics{constructor(t,e,i,s,n,{optionalContentConfig:r,markedContentStack:a=null},o,l,h){this.ctx=t;this.current=new CanvasExtraState(this.ctx.canvas.width,this.ctx.canvas.height);this.stateStack=[];this.pendingClip=null;this.pendingEOFill=false;this.res=null;this.xobjs=null;this.commonObjs=e;this.objs=i;this.canvasFactory=s;this.filterFactory=n;this.groupStack=[];this.baseTransform=null;this.baseTransformStack=[];this.groupLevel=0;this.smaskStack=[];this.smaskCounter=0;this.tempSMask=null;this.suspendedCtx=null;this.contentVisible=true;this.markedContentStack=a||[];this.optionalContentConfig=r;this.cachedCanvases=new CachedCanvases(this.canvasFactory);this.cachedPatterns=new Map;this.annotationCanvasMap=o;this.viewportScale=1;this.outputScaleX=1;this.outputScaleY=1;this.pageColors=l;this._cachedScaleForStroking=[-1,0];this._cachedGetSinglePixelWidth=null;this._cachedBitmapsMap=new Map;this.dependencyTracker=h??null}getObject(t,e,i=null){if(typeof e==="string"){this.dependencyTracker?.recordNamedDependency(t,e);return e.startsWith("g_")?this.commonObjs.get(e):this.objs.get(e)}return i}beginDrawing({transform:t,viewport:e,transparency:i=false,background:s=null}){const n=this.ctx.canvas.width;const r=this.ctx.canvas.height;const a=this.ctx.fillStyle;this.ctx.fillStyle=s||"#ffffff";this.ctx.fillRect(0,0,n,r);this.ctx.fillStyle=a;if(i){const t=this.cachedCanvases.getCanvas("transparent",n,r);this.compositeCtx=this.ctx;this.transparentCanvas=t.canvas;this.ctx=t.context;this.ctx.save();this.ctx.transform(...getCurrentTransform(this.compositeCtx))}this.ctx.save();resetCtxToDefault(this.ctx);if(t){this.ctx.transform(...t);this.outputScaleX=t[0];this.outputScaleY=t[0]}this.ctx.transform(...e.transform);this.viewportScale=e.scale;this.baseTransform=getCurrentTransform(this.ctx)}executeOperatorList(t,e,i,s,n){const r=t.argsArray;const a=t.fnArray;let o=e||0;const l=r.length;if(l===o){return o}const h=l-o>EXECUTION_STEPS&&typeof i==="function";const c=h?Date.now()+EXECUTION_TIME:0;let d=0;const u=this.commonObjs;const p=this.objs;let g,f;while(true){if(s!==undefined&&o===s.nextBreakPoint){s.breakIt(o,i);return o}if(!n||n.has(o)){g=a[o];f=r[o]??null;if(g!==OPS.dependency){if(f===null){this[g](o)}else{this[g](o,...f)}}else{for(const t of f){this.dependencyTracker?.recordNamedData(t,o);const e=t.startsWith("g_")?u:p;if(!e.has(t)){e.get(t,i);return o}}}}o++;if(o===l){return o}if(h&&++d>EXECUTION_STEPS){if(Date.now()>c){i();return o}d=0}}}#ls(){while(this.stateStack.length||this.inSMaskMode){this.restore()}this.current.activeSMask=null;this.ctx.restore();if(this.transparentCanvas){this.ctx=this.compositeCtx;this.ctx.save();this.ctx.setTransform(1,0,0,1,0,0);this.ctx.drawImage(this.transparentCanvas,0,0);this.ctx.restore();this.transparentCanvas=null}}endDrawing(){this.#ls();this.cachedCanvases.clear();this.cachedPatterns.clear();for(const t of this._cachedBitmapsMap.values()){for(const e of t.values()){if(typeof HTMLCanvasElement!=="undefined"&&e instanceof HTMLCanvasElement){e.width=e.height=0}}t.clear()}this._cachedBitmapsMap.clear();this.#hs()}#hs(){if(this.pageColors){const t=this.filterFactory.addHCMFilter(this.pageColors.foreground,this.pageColors.background);if(t!=="none"){const e=this.ctx.filter;this.ctx.filter=t;this.ctx.drawImage(this.ctx.canvas,0,0);this.ctx.filter=e}}}_scaleImage(t,e){const i=t.width??t.displayWidth;const s=t.height??t.displayHeight;let n=Math.max(Math.hypot(e[0],e[1]),1);let r=Math.max(Math.hypot(e[2],e[3]),1);let a=i,o=s;let l="prescale1";let h,c;while(n>2&&a>1||r>2&&o>1){let e=a,i=o;if(n>2&&a>1){e=a>=16384?Math.floor(a/2)-1||1:Math.ceil(a/2);n/=a/e}if(r>2&&o>1){i=o>=16384?Math.floor(o/2)-1||1:Math.ceil(o)/2;r/=o/i}h=this.cachedCanvases.getCanvas(l,e,i);c=h.context;c.clearRect(0,0,e,i);c.drawImage(t,0,0,a,o,0,0,e,i);t=h.canvas;a=e;o=i;l=l==="prescale1"?"prescale2":"prescale1"}return{img:t,paintWidth:a,paintHeight:o}}_createMaskCanvas(t,e){const i=this.ctx;const{width:s,height:n}=e;const r=this.current.fillColor;const a=this.current.patternFill;const o=getCurrentTransform(i);let l,h,c,d;if((e.bitmap||e.data)&&e.count>1){const i=e.bitmap||e.data.buffer;h=JSON.stringify(a?o:[o.slice(0,4),r]);l=this._cachedBitmapsMap.get(i);if(!l){l=new Map;this._cachedBitmapsMap.set(i,l)}const s=l.get(h);if(s&&!a){const e=Math.round(Math.min(o[0],o[2])+o[4]);const i=Math.round(Math.min(o[1],o[3])+o[5]);this.dependencyTracker?.recordDependencies(t,Dependencies.transformAndFill);return{canvas:s,offsetX:e,offsetY:i}}c=s}if(!c){d=this.cachedCanvases.getCanvas("maskCanvas",s,n);putBinaryImageMask(d.context,e)}let u=Util.transform(o,[1/s,0,0,-1/n,0,0]);u=Util.transform(u,[1,0,0,1,0,-n]);const p=MIN_MAX_INIT.slice();Util.axialAlignedBoundingBox([0,0,s,n],u,p);const[g,f,m,b]=p;const A=Math.round(m-g)||1;const y=Math.round(b-f)||1;const w=this.cachedCanvases.getCanvas("fillCanvas",A,y);const E=w.context;const v=g;const x=f;E.translate(-v,-x);E.transform(...u);if(!c){c=this._scaleImage(d.canvas,getCurrentTransformInverse(E));c=c.img;if(l&&a){l.set(h,c)}}E.imageSmoothingEnabled=getImageSmoothingEnabled(getCurrentTransform(E),e.interpolate);drawImageAtIntegerCoords(E,c,0,0,c.width,c.height,0,0,s,n);E.globalCompositeOperation="source-in";const _=Util.transform(getCurrentTransformInverse(E),[1,0,0,1,-v,-x]);E.fillStyle=a?r.getPattern(i,this,_,PathType.FILL):r;E.fillRect(0,0,s,n);if(l&&!a){this.cachedCanvases.delete("fillCanvas");l.set(h,w.canvas)}this.dependencyTracker?.recordDependencies(t,Dependencies.transformAndFill);return{canvas:w.canvas,offsetX:Math.round(v),offsetY:Math.round(x)}}setLineWidth(t,e){this.dependencyTracker?.recordSimpleData("lineWidth",t);if(e!==this.current.lineWidth){this._cachedScaleForStroking[0]=-1}this.current.lineWidth=e;this.ctx.lineWidth=e}setLineCap(t,e){this.dependencyTracker?.recordSimpleData("lineCap",t);this.ctx.lineCap=LINE_CAP_STYLES[e]}setLineJoin(t,e){this.dependencyTracker?.recordSimpleData("lineJoin",t);this.ctx.lineJoin=LINE_JOIN_STYLES[e]}setMiterLimit(t,e){this.dependencyTracker?.recordSimpleData("miterLimit",t);this.ctx.miterLimit=e}setDash(t,e,i){this.dependencyTracker?.recordSimpleData("dash",t);const s=this.ctx;if(s.setLineDash!==undefined){s.setLineDash(e);s.lineDashOffset=i}}setRenderingIntent(t,e){}setFlatness(t,e){}setGState(t,e){for(const[i,s]of e){switch(i){case"LW":this.setLineWidth(t,s);break;case"LC":this.setLineCap(t,s);break;case"LJ":this.setLineJoin(t,s);break;case"ML":this.setMiterLimit(t,s);break;case"D":this.setDash(t,s[0],s[1]);break;case"RI":this.setRenderingIntent(t,s);break;case"FL":this.setFlatness(t,s);break;case"Font":this.setFont(t,s[0],s[1]);break;case"CA":this.dependencyTracker?.recordSimpleData("strokeAlpha",t);this.current.strokeAlpha=s;break;case"ca":this.dependencyTracker?.recordSimpleData("fillAlpha",t);this.ctx.globalAlpha=this.current.fillAlpha=s;break;case"BM":this.dependencyTracker?.recordSimpleData("globalCompositeOperation",t);this.ctx.globalCompositeOperation=s;break;case"SMask":this.dependencyTracker?.recordSimpleData("SMask",t);this.current.activeSMask=s?this.tempSMask:null;this.tempSMask=null;this.checkSMaskState();break;case"TR":this.dependencyTracker?.recordSimpleData("filter",t);this.ctx.filter=this.current.transferMaps=this.filterFactory.addFilter(s);break}}}get inSMaskMode(){return!!this.suspendedCtx}checkSMaskState(){const t=this.inSMaskMode;if(this.current.activeSMask&&!t){this.beginSMaskMode()}else if(!this.current.activeSMask&&t){this.endSMaskMode()}}beginSMaskMode(t){if(this.inSMaskMode){throw new Error("beginSMaskMode called while already in smask mode")}const e=this.ctx.canvas.width;const i=this.ctx.canvas.height;const s="smaskGroupAt"+this.groupLevel;const n=this.cachedCanvases.getCanvas(s,e,i);this.suspendedCtx=this.ctx;const r=this.ctx=n.context;r.setTransform(this.suspendedCtx.getTransform());copyCtxState(this.suspendedCtx,r);mirrorContextOperations(r,this.suspendedCtx);this.setGState(t,[["BM","source-over"]])}endSMaskMode(){if(!this.inSMaskMode){throw new Error("endSMaskMode called while not in smask mode")}this.ctx._removeMirroring();copyCtxState(this.ctx,this.suspendedCtx);this.ctx=this.suspendedCtx;this.suspendedCtx=null}compose(t){if(!this.current.activeSMask){return}if(!t){t=[0,0,this.ctx.canvas.width,this.ctx.canvas.height]}else{t[0]=Math.floor(t[0]);t[1]=Math.floor(t[1]);t[2]=Math.ceil(t[2]);t[3]=Math.ceil(t[3])}const e=this.current.activeSMask;const i=this.suspendedCtx;this.composeSMask(i,e,this.ctx,t);this.ctx.save();this.ctx.setTransform(1,0,0,1,0,0);this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);this.ctx.restore()}composeSMask(t,e,i,s){const n=s[0];const r=s[1];const a=s[2]-n;const o=s[3]-r;if(a===0||o===0){return}this.genericComposeSMask(e.context,i,a,o,e.subtype,e.backdrop,e.transferMap,n,r,e.offsetX,e.offsetY);t.save();t.globalAlpha=1;t.globalCompositeOperation="source-over";t.setTransform(1,0,0,1,0,0);t.drawImage(i.canvas,0,0);t.restore()}genericComposeSMask(t,e,i,s,n,r,a,o,l,h,c){let d=t.canvas;let u=o-h;let p=l-c;if(r){if(u<0||p<0||u+i>d.width||p+s>d.height){const t=this.cachedCanvases.getCanvas("maskExtension",i,s);const e=t.context;e.drawImage(d,-u,-p);e.globalCompositeOperation="destination-atop";e.fillStyle=r;e.fillRect(0,0,i,s);e.globalCompositeOperation="source-over";d=t.canvas;u=p=0}else{t.save();t.globalAlpha=1;t.setTransform(1,0,0,1,0,0);const e=new Path2D;e.rect(u,p,i,s);t.clip(e);t.globalCompositeOperation="destination-atop";t.fillStyle=r;t.fillRect(u,p,i,s);t.restore()}}e.save();e.globalAlpha=1;e.setTransform(1,0,0,1,0,0);if(n==="Alpha"&&a){e.filter=this.filterFactory.addAlphaFilter(a)}else if(n==="Luminosity"){e.filter=this.filterFactory.addLuminosityFilter(a)}const g=new Path2D;g.rect(o,l,i,s);e.clip(g);e.globalCompositeOperation="destination-in";e.drawImage(d,u,p,i,s,o,l,i,s);e.restore()}save(t){if(this.inSMaskMode){copyCtxState(this.ctx,this.suspendedCtx)}this.ctx.save();const e=this.current;this.stateStack.push(e);this.current=e.clone();this.dependencyTracker?.save(t)}restore(t){this.dependencyTracker?.restore(t);if(this.stateStack.length===0){if(this.inSMaskMode){this.endSMaskMode()}return}this.current=this.stateStack.pop();this.ctx.restore();if(this.inSMaskMode){copyCtxState(this.suspendedCtx,this.ctx)}this.checkSMaskState();this.pendingClip=null;this._cachedScaleForStroking[0]=-1;this._cachedGetSinglePixelWidth=null}transform(t,e,i,s,n,r,a){this.dependencyTracker?.recordIncrementalData("transform",t);this.ctx.transform(e,i,s,n,r,a);this._cachedScaleForStroking[0]=-1;this._cachedGetSinglePixelWidth=null}constructPath(t,e,i,s){let[n]=i;if(!s){n||=i[0]=new Path2D;this[e](t,n);return}if(this.dependencyTracker!==null){const i=e===OPS.stroke?this.current.lineWidth/2:0;this.dependencyTracker.resetBBox(t).recordBBox(t,this.ctx,s[0]-i,s[2]+i,s[1]-i,s[3]+i).recordDependencies(t,["transform"])}if(!(n instanceof Path2D)){const t=i[0]=new Path2D;for(let e=0,i=n.length;e<i;){switch(n[e++]){case DrawOPS.moveTo:t.moveTo(n[e++],n[e++]);break;case DrawOPS.lineTo:t.lineTo(n[e++],n[e++]);break;case DrawOPS.curveTo:t.bezierCurveTo(n[e++],n[e++],n[e++],n[e++],n[e++],n[e++]);break;case DrawOPS.closePath:t.closePath();break;default:warn(`Unrecognized drawing path operator: ${n[e-1]}`);break}}n=t}Util.axialAlignedBoundingBox(s,getCurrentTransform(this.ctx),this.current.minMax);this[e](t,n);this._pathStartIdx=t}closePath(t){this.ctx.closePath()}stroke(t,e,i=true){const s=this.ctx;const n=this.current.strokeColor;s.globalAlpha=this.current.strokeAlpha;if(this.contentVisible){if(typeof n==="object"&&n?.getPattern){const t=n.isModifyingCurrentTransform()?s.getTransform():null;s.save();s.strokeStyle=n.getPattern(s,this,getCurrentTransformInverse(s),PathType.STROKE);if(t){const i=new Path2D;i.addPath(e,s.getTransform().invertSelf().multiplySelf(t));e=i}this.rescaleAndStroke(e,false);s.restore()}else{this.rescaleAndStroke(e,true)}}this.dependencyTracker?.recordDependencies(t,Dependencies.stroke);if(i){this.consumePath(t,e,this.current.getClippedPathBoundingBox(PathType.STROKE,getCurrentTransform(this.ctx)))}s.globalAlpha=this.current.fillAlpha}closeStroke(t,e){this.stroke(t,e)}fill(t,e,i=true){const s=this.ctx;const n=this.current.fillColor;const r=this.current.patternFill;let a=false;if(r){const i=n.isModifyingCurrentTransform()?s.getTransform():null;this.dependencyTracker?.save(t);s.save();s.fillStyle=n.getPattern(s,this,getCurrentTransformInverse(s),PathType.FILL);if(i){const t=new Path2D;t.addPath(e,s.getTransform().invertSelf().multiplySelf(i));e=t}a=true}const o=this.current.getClippedPathBoundingBox();if(this.contentVisible&&o!==null){if(this.pendingEOFill){s.fill(e,"evenodd");this.pendingEOFill=false}else{s.fill(e)}}this.dependencyTracker?.recordDependencies(t,Dependencies.fill);if(a){s.restore();this.dependencyTracker?.restore(t)}if(i){this.consumePath(t,e,o)}}eoFill(t,e){this.pendingEOFill=true;this.fill(t,e)}fillStroke(t,e){this.fill(t,e,false);this.stroke(t,e,false);this.consumePath(t,e)}eoFillStroke(t,e){this.pendingEOFill=true;this.fillStroke(t,e)}closeFillStroke(t,e){this.fillStroke(t,e)}closeEOFillStroke(t,e){this.pendingEOFill=true;this.fillStroke(t,e)}endPath(t,e){this.consumePath(t,e)}rawFillPath(t,e){this.ctx.fill(e);this.dependencyTracker?.recordDependencies(t,Dependencies.rawFillPath).recordOperation(t)}clip(t){this.dependencyTracker?.recordFutureForcedDependency("clipMode",t);this.pendingClip=NORMAL_CLIP}eoClip(t){this.dependencyTracker?.recordFutureForcedDependency("clipMode",t);this.pendingClip=EO_CLIP}beginText(t){this.current.textMatrix=null;this.current.textMatrixScale=1;this.current.x=this.current.lineX=0;this.current.y=this.current.lineY=0;this.dependencyTracker?.recordOpenMarker(t).resetIncrementalData("sameLineText").resetIncrementalData("moveText",t)}endText(t){const e=this.pendingTextPaths;const i=this.ctx;if(this.dependencyTracker){const{dependencyTracker:i}=this;if(e!==undefined){i.recordFutureForcedDependency("textClip",i.getOpenMarker()).recordFutureForcedDependency("textClip",t)}i.recordCloseMarker(t)}if(e!==undefined){const t=new Path2D;const s=i.getTransform().invertSelf();for(const{transform:i,x:n,y:r,fontSize:a,path:o}of e){if(!o){continue}t.addPath(o,new DOMMatrix(i).preMultiplySelf(s).translate(n,r).scale(a,-a))}i.clip(t)}delete this.pendingTextPaths}setCharSpacing(t,e){this.dependencyTracker?.recordSimpleData("charSpacing",t);this.current.charSpacing=e}setWordSpacing(t,e){this.dependencyTracker?.recordSimpleData("wordSpacing",t);this.current.wordSpacing=e}setHScale(t,e){this.dependencyTracker?.recordSimpleData("hScale",t);this.current.textHScale=e/100}setLeading(t,e){this.dependencyTracker?.recordSimpleData("leading",t);this.current.leading=-e}setFont(t,e,i){this.dependencyTracker?.recordSimpleData("font",t).recordNamedDependency(t,e);const s=this.commonObjs.get(e);const n=this.current;if(!s){throw new Error(`Can't find font for ${e}`)}n.fontMatrix=s.fontMatrix||FONT_IDENTITY_MATRIX;if(n.fontMatrix[0]===0||n.fontMatrix[3]===0){warn("Invalid font matrix for font "+e)}if(i<0){i=-i;n.fontDirection=-1}else{n.fontDirection=1}this.current.font=s;this.current.fontSize=i;if(s.isType3Font){return}const r=s.loadedName||"sans-serif";const a=s.systemFontInfo?.css||`"${r}", ${s.fallbackName}`;let o="normal";if(s.black){o="900"}else if(s.bold){o="bold"}const l=s.italic?"italic":"normal";let h=i;if(i<MIN_FONT_SIZE){h=MIN_FONT_SIZE}else if(i>MAX_FONT_SIZE){h=MAX_FONT_SIZE}this.current.fontSizeScale=i/h;this.ctx.font=`${l} ${o} ${h}px ${a}`}setTextRenderingMode(t,e){this.dependencyTracker?.recordSimpleData("textRenderingMode",t);this.current.textRenderingMode=e}setTextRise(t,e){this.dependencyTracker?.recordSimpleData("textRise",t);this.current.textRise=e}moveText(t,e,i){this.dependencyTracker?.resetIncrementalData("sameLineText").recordIncrementalData("moveText",t);this.current.x=this.current.lineX+=e;this.current.y=this.current.lineY+=i}setLeadingMoveText(t,e,i){this.setLeading(t,-i);this.moveText(t,e,i)}setTextMatrix(t,e){this.dependencyTracker?.recordSimpleData("textMatrix",t);const{current:i}=this;i.textMatrix=e;i.textMatrixScale=Math.hypot(e[0],e[1]);i.x=i.lineX=0;i.y=i.lineY=0}nextLine(t){this.moveText(t,0,this.current.leading);this.dependencyTracker?.recordIncrementalData("moveText",this.dependencyTracker.getSimpleIndex("leading")??t)}#cs(t,e,i){const s=new Path2D;s.addPath(t,new DOMMatrix(i).invertSelf().multiplySelf(e));return s}paintChar(t,e,i,s,n,r){const a=this.ctx;const o=this.current;const l=o.font;const h=o.textRenderingMode;const c=o.fontSize/o.fontSizeScale;const d=h&TextRenderingMode.FILL_STROKE_MASK;const u=!!(h&TextRenderingMode.ADD_TO_PATH_FLAG);const p=o.patternFill&&!l.missingFile;const g=o.patternStroke&&!l.missingFile;let f;if((l.disableFontFace||u||p||g)&&!l.missingFile){f=l.getPathGenerator(this.commonObjs,e)}if(f&&(l.disableFontFace||p||g)){a.save();a.translate(i,s);a.scale(c,-c);this.dependencyTracker?.recordCharacterBBox(t,a,l);let e;if(d===TextRenderingMode.FILL||d===TextRenderingMode.FILL_STROKE){if(n){e=a.getTransform();a.setTransform(...n);const t=this.#cs(f,e,n);a.fill(t)}else{a.fill(f)}}if(d===TextRenderingMode.STROKE||d===TextRenderingMode.FILL_STROKE){if(r){e||=a.getTransform();a.setTransform(...r);const{a:t,b:i,c:s,d:n}=e;const o=Util.inverseTransform(r);const l=Util.transform([t,i,s,n,0,0],o);Util.singularValueDecompose2dScale(l,XY);a.lineWidth*=Math.max(XY[0],XY[1])/c;a.stroke(this.#cs(f,e,r))}else{a.lineWidth/=c;a.stroke(f)}}a.restore()}else{if(d===TextRenderingMode.FILL||d===TextRenderingMode.FILL_STROKE){a.fillText(e,i,s);this.dependencyTracker?.recordCharacterBBox(t,a,l,c,i,s,()=>a.measureText(e))}if(d===TextRenderingMode.STROKE||d===TextRenderingMode.FILL_STROKE){if(this.dependencyTracker){this.dependencyTracker?.recordCharacterBBox(t,a,l,c,i,s,()=>a.measureText(e)).recordDependencies(t,Dependencies.stroke)}a.strokeText(e,i,s)}}if(u){const e=this.pendingTextPaths||=[];e.push({transform:getCurrentTransform(a),x:i,y:s,fontSize:c,path:f});this.dependencyTracker?.recordCharacterBBox(t,a,l,c,i,s)}}get isFontSubpixelAAEnabled(){const{context:t}=this.cachedCanvases.getCanvas("isFontSubpixelAAEnabled",10,10);t.scale(1.5,1);t.fillText("I",0,10);const e=t.getImageData(0,0,10,10).data;let i=false;for(let t=3;t<e.length;t+=4){if(e[t]>0&&e[t]<255){i=true;break}}return shadow(this,"isFontSubpixelAAEnabled",i)}showText(t,e){if(this.dependencyTracker){this.dependencyTracker.recordDependencies(t,Dependencies.showText).copyDependenciesFromIncrementalOperation(t,"sameLineText").resetBBox(t);if(this.current.textRenderingMode&TextRenderingMode.ADD_TO_PATH_FLAG){this.dependencyTracker.recordFutureForcedDependency("textClip",t).inheritPendingDependenciesAsFutureForcedDependencies()}}const i=this.current;const s=i.font;if(s.isType3Font){this.showType3Text(t,e);this.dependencyTracker?.recordOperation(t).recordIncrementalData("sameLineText",t);return undefined}const n=i.fontSize;if(n===0){this.dependencyTracker?.recordOperation(t);return undefined}const r=this.ctx;const a=i.fontSizeScale;const o=i.charSpacing;const l=i.wordSpacing;const h=i.fontDirection;const c=i.textHScale*h;const d=e.length;const u=s.vertical;const p=u?1:-1;const g=s.defaultVMetrics;const f=n*i.fontMatrix[0];const m=i.textRenderingMode===TextRenderingMode.FILL&&!s.disableFontFace&&!i.patternFill;r.save();if(i.textMatrix){r.transform(...i.textMatrix)}r.translate(i.x,i.y+i.textRise);if(h>0){r.scale(c,-1)}else{r.scale(c,1)}let b,A;if(i.patternFill){r.save();const t=i.fillColor.getPattern(r,this,getCurrentTransformInverse(r),PathType.FILL);b=getCurrentTransform(r);r.restore();r.fillStyle=t}if(i.patternStroke){r.save();const t=i.strokeColor.getPattern(r,this,getCurrentTransformInverse(r),PathType.STROKE);A=getCurrentTransform(r);r.restore();r.strokeStyle=t}let y=i.lineWidth;const w=i.textMatrixScale;if(w===0||y===0){const t=i.textRenderingMode&TextRenderingMode.FILL_STROKE_MASK;if(t===TextRenderingMode.STROKE||t===TextRenderingMode.FILL_STROKE){y=this.getSinglePixelWidth()}}else{y/=w}if(a!==1){r.scale(a,a);y/=a}r.lineWidth=y;if(s.isInvalidPDFjsFont){const s=[];let n=0;for(const t of e){s.push(t.unicode);n+=t.width}const a=s.join("");r.fillText(a,0,0);if(this.dependencyTracker!==null){const e=r.measureText(a);this.dependencyTracker.recordBBox(t,this.ctx,-e.actualBoundingBoxLeft,e.actualBoundingBoxRight,-e.actualBoundingBoxAscent,e.actualBoundingBoxDescent).recordOperation(t).recordIncrementalData("sameLineText",t)}i.x+=n*f*c;r.restore();this.compose();return undefined}let E=0,v;for(v=0;v<d;++v){const i=e[v];if(typeof i==="number"){E+=p*i*n/1e3;continue}let c=false;const d=(i.isSpace?l:0)+o;const y=i.fontChar;const w=i.accent;let x,_;let T=i.width;if(u){const t=i.vmetric||g;const e=-(i.vmetric?t[1]:T*.5)*f;const s=t[2]*f;T=t?-t[0]:T;x=e/a;_=(E+s)/a}else{x=E/a;_=0}let S;if(s.remeasure&&T>0){S=r.measureText(y);const t=S.width*1e3/n*a;if(T<t&&this.isFontSubpixelAAEnabled){const e=T/t;c=true;r.save();r.scale(e,1);x/=e}else if(T!==t){x+=(T-t)/2e3*n/a}}if(this.contentVisible&&(i.isInFont||s.missingFile)){if(m&&!w){r.fillText(y,x,_);this.dependencyTracker?.recordCharacterBBox(t,r,S?{bbox:null}:s,n/a,x,_,()=>S??r.measureText(y))}else{this.paintChar(t,y,x,_,b,A);if(w){const e=x+n*w.offset.x/a;const i=_-n*w.offset.y/a;this.paintChar(t,w.fontChar,e,i,b,A)}}}const C=u?T*f-d*h:T*f+d*h;E+=C;if(c){r.restore()}}if(u){i.y-=E}else{i.x+=E*c}r.restore();this.compose();this.dependencyTracker?.recordOperation(t).recordIncrementalData("sameLineText",t);return undefined}showType3Text(t,e){const i=this.ctx;const s=this.current;const n=s.font;const r=s.fontSize;const a=s.fontDirection;const o=n.vertical?1:-1;const l=s.charSpacing;const h=s.wordSpacing;const c=s.textHScale*a;const d=s.fontMatrix||FONT_IDENTITY_MATRIX;const u=e.length;const p=s.textRenderingMode===TextRenderingMode.INVISIBLE;let g,f,m,b;if(p||r===0){return}this._cachedScaleForStroking[0]=-1;this._cachedGetSinglePixelWidth=null;i.save();if(s.textMatrix){i.transform(...s.textMatrix)}i.translate(s.x,s.y+s.textRise);i.scale(c,a);const A=this.dependencyTracker;this.dependencyTracker=A?new CanvasNestedDependencyTracker(A,t):null;for(g=0;g<u;++g){f=e[g];if(typeof f==="number"){b=o*f*r/1e3;this.ctx.translate(b,0);s.x+=b*c;continue}const t=(f.isSpace?h:0)+l;const a=n.charProcOperatorList[f.operatorListId];if(!a){warn(`Type3 character "${f.operatorListId}" is not available.`)}else if(this.contentVisible){this.save();i.scale(r,r);i.transform(...d);this.executeOperatorList(a);this.restore()}const u=[f.width,0];Util.applyTransform(u,d);m=u[0]*r+t;i.translate(m,0);s.x+=m*c}i.restore();if(A){this.dependencyTracker.recordNestedDependencies();this.dependencyTracker=A}}setCharWidth(t,e,i){}setCharWidthAndBounds(t,e,i,s,n,r,a){const o=new Path2D;o.rect(s,n,r-s,a-n);this.ctx.clip(o);this.dependencyTracker?.recordBBox(t,this.ctx,s,r,n,a).recordClipBox(t,this.ctx,s,r,n,a);this.endPath(t)}getColorN_Pattern(t,e){let i;if(e[0]==="TilingPattern"){const s=this.baseTransform||getCurrentTransform(this.ctx);const n={createCanvasGraphics:e=>new CanvasGraphics(e,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:this.optionalContentConfig,markedContentStack:this.markedContentStack},undefined,undefined,this.dependencyTracker?new CanvasNestedDependencyTracker(this.dependencyTracker,t):null)};i=new TilingPattern(e,this.ctx,n,s)}else{i=this._getPattern(t,e[1],e[2])}return i}setStrokeColorN(t,...e){this.dependencyTracker?.recordSimpleData("strokeColor",t);this.current.strokeColor=this.getColorN_Pattern(t,e);this.current.patternStroke=true}setFillColorN(t,...e){this.dependencyTracker?.recordSimpleData("fillColor",t);this.current.fillColor=this.getColorN_Pattern(t,e);this.current.patternFill=true}setStrokeRGBColor(t,e){this.dependencyTracker?.recordSimpleData("strokeColor",t);this.ctx.strokeStyle=this.current.strokeColor=e;this.current.patternStroke=false}setStrokeTransparent(t){this.dependencyTracker?.recordSimpleData("strokeColor",t);this.ctx.strokeStyle=this.current.strokeColor="transparent";this.current.patternStroke=false}setFillRGBColor(t,e){this.dependencyTracker?.recordSimpleData("fillColor",t);this.ctx.fillStyle=this.current.fillColor=e;this.current.patternFill=false}setFillTransparent(t){this.dependencyTracker?.recordSimpleData("fillColor",t);this.ctx.fillStyle=this.current.fillColor="transparent";this.current.patternFill=false}_getPattern(t,e,i=null){let s;if(this.cachedPatterns.has(e)){s=this.cachedPatterns.get(e)}else{s=getShadingPattern(this.getObject(t,e));this.cachedPatterns.set(e,s)}if(i){s.matrix=i}return s}shadingFill(t,e){if(!this.contentVisible){return}const i=this.ctx;this.save(t);const s=this._getPattern(t,e);i.fillStyle=s.getPattern(i,this,getCurrentTransformInverse(i),PathType.SHADING);const n=getCurrentTransformInverse(i);if(n){const{width:t,height:e}=i.canvas;const s=MIN_MAX_INIT.slice();Util.axialAlignedBoundingBox([0,0,t,e],n,s);const[r,a,o,l]=s;this.ctx.fillRect(r,a,o-r,l-a)}else{this.ctx.fillRect(-1e10,-1e10,2e10,2e10)}this.dependencyTracker?.resetBBox(t).recordFullPageBBox(t).recordDependencies(t,Dependencies.transform).recordDependencies(t,Dependencies.fill).recordOperation(t);this.compose(this.current.getClippedPathBoundingBox());this.restore(t)}beginInlineImage(){unreachable("Should not call beginInlineImage")}beginImageData(){unreachable("Should not call beginImageData")}paintFormXObjectBegin(t,e,i){if(!this.contentVisible){return}this.save(t);this.baseTransformStack.push(this.baseTransform);if(e){this.transform(t,...e)}this.baseTransform=getCurrentTransform(this.ctx);if(i){Util.axialAlignedBoundingBox(i,this.baseTransform,this.current.minMax);const[e,s,n,r]=i;const a=new Path2D;a.rect(e,s,n-e,r-s);this.ctx.clip(a);this.dependencyTracker?.recordClipBox(t,this.ctx,e,n,s,r);this.endPath(t)}}paintFormXObjectEnd(t){if(!this.contentVisible){return}this.restore(t);this.baseTransform=this.baseTransformStack.pop()}beginGroup(t,e){if(!this.contentVisible){return}this.save(t);if(this.inSMaskMode){this.endSMaskMode();this.current.activeSMask=null}const i=this.ctx;if(!e.isolated){info("TODO: Support non-isolated groups.")}if(e.knockout){warn("Knockout groups not supported.")}const s=getCurrentTransform(i);if(e.matrix){i.transform(...e.matrix)}if(!e.bbox){throw new Error("Bounding box is required.")}let n=MIN_MAX_INIT.slice();Util.axialAlignedBoundingBox(e.bbox,getCurrentTransform(i),n);const r=[0,0,i.canvas.width,i.canvas.height];n=Util.intersect(n,r)||[0,0,0,0];const a=Math.floor(n[0]);const o=Math.floor(n[1]);const l=Math.max(Math.ceil(n[2])-a,1);const h=Math.max(Math.ceil(n[3])-o,1);this.current.startNewPathAndClipBox([0,0,l,h]);let c="groupAt"+this.groupLevel;if(e.smask){c+="_smask_"+this.smaskCounter++%2}const d=this.cachedCanvases.getCanvas(c,l,h);const u=d.context;u.translate(-a,-o);u.transform(...s);let p=new Path2D;const[g,f,m,b]=e.bbox;p.rect(g,f,m-g,b-f);if(e.matrix){const t=new Path2D;t.addPath(p,new DOMMatrix(e.matrix));p=t}u.clip(p);if(e.smask){this.smaskStack.push({canvas:d.canvas,context:u,offsetX:a,offsetY:o,subtype:e.smask.subtype,backdrop:e.smask.backdrop,transferMap:e.smask.transferMap||null,startTransformInverse:null})}if(!e.smask||this.dependencyTracker){i.setTransform(1,0,0,1,0,0);i.translate(a,o);i.save()}copyCtxState(i,u);this.ctx=u;this.dependencyTracker?.inheritSimpleDataAsFutureForcedDependencies(["fillAlpha","strokeAlpha","globalCompositeOperation"]).pushBaseTransform(i);this.setGState(t,[["BM","source-over"],["ca",1],["CA",1]]);this.groupStack.push(i);this.groupLevel++}endGroup(t,e){if(!this.contentVisible){return}this.groupLevel--;const i=this.ctx;const s=this.groupStack.pop();this.ctx=s;this.ctx.imageSmoothingEnabled=false;this.dependencyTracker?.popBaseTransform();if(e.smask){this.tempSMask=this.smaskStack.pop();this.restore(t);if(this.dependencyTracker){this.ctx.restore()}}else{this.ctx.restore();const e=getCurrentTransform(this.ctx);this.restore(t);this.ctx.save();this.ctx.setTransform(...e);const s=MIN_MAX_INIT.slice();Util.axialAlignedBoundingBox([0,0,i.canvas.width,i.canvas.height],e,s);this.ctx.drawImage(i.canvas,0,0);this.ctx.restore();this.compose(s)}}beginAnnotation(t,e,i,s,n,r){this.#ls();resetCtxToDefault(this.ctx);this.ctx.save();this.save(t);if(this.baseTransform){this.ctx.setTransform(...this.baseTransform)}if(i){const n=i[2]-i[0];const a=i[3]-i[1];if(r&&this.annotationCanvasMap){s=s.slice();s[4]-=i[0];s[5]-=i[1];i=i.slice();i[0]=i[1]=0;i[2]=n;i[3]=a;Util.singularValueDecompose2dScale(getCurrentTransform(this.ctx),XY);const{viewportScale:t}=this;const r=Math.ceil(n*this.outputScaleX*t);const o=Math.ceil(a*this.outputScaleY*t);this.annotationCanvas=this.canvasFactory.create(r,o);const{canvas:l,context:h}=this.annotationCanvas;this.annotationCanvasMap.set(e,l);this.annotationCanvas.savedCtx=this.ctx;this.ctx=h;this.ctx.save();this.ctx.setTransform(XY[0],0,0,-XY[1],0,a*XY[1]);resetCtxToDefault(this.ctx)}else{resetCtxToDefault(this.ctx);this.endPath(t);const e=new Path2D;e.rect(i[0],i[1],n,a);this.ctx.clip(e)}}this.current=new CanvasExtraState(this.ctx.canvas.width,this.ctx.canvas.height);this.transform(t,...s);this.transform(t,...n)}endAnnotation(t){if(this.annotationCanvas){this.ctx.restore();this.#hs();this.ctx=this.annotationCanvas.savedCtx;delete this.annotationCanvas.savedCtx;delete this.annotationCanvas}}paintImageMaskXObject(t,e){if(!this.contentVisible){return}const i=e.count;e=this.getObject(t,e.data,e);e.count=i;const s=this.ctx;const n=this._createMaskCanvas(t,e);const r=n.canvas;s.save();s.setTransform(1,0,0,1,0,0);s.drawImage(r,n.offsetX,n.offsetY);this.dependencyTracker?.resetBBox(t).recordBBox(t,this.ctx,n.offsetX,n.offsetX+r.width,n.offsetY,n.offsetY+r.height).recordOperation(t);s.restore();this.compose()}paintImageMaskXObjectRepeat(t,e,i,s=0,n=0,r,a){if(!this.contentVisible){return}e=this.getObject(t,e.data,e);const o=this.ctx;o.save();const l=getCurrentTransform(o);o.transform(i,s,n,r,0,0);const h=this._createMaskCanvas(t,e);o.setTransform(1,0,0,1,h.offsetX-l[4],h.offsetY-l[5]);this.dependencyTracker?.resetBBox(t);for(let e=0,c=a.length;e<c;e+=2){const c=Util.transform(l,[i,s,n,r,a[e],a[e+1]]);o.drawImage(h.canvas,c[4],c[5]);this.dependencyTracker?.recordBBox(t,this.ctx,c[4],c[4]+h.canvas.width,c[5],c[5]+h.canvas.height)}o.restore();this.compose();this.dependencyTracker?.recordOperation(t)}paintImageMaskXObjectGroup(t,e){if(!this.contentVisible){return}const i=this.ctx;const s=this.current.fillColor;const n=this.current.patternFill;this.dependencyTracker?.resetBBox(t).recordDependencies(t,Dependencies.transformAndFill);for(const r of e){const{data:e,width:a,height:o,transform:l}=r;const h=this.cachedCanvases.getCanvas("maskCanvas",a,o);const c=h.context;c.save();const d=this.getObject(t,e,r);putBinaryImageMask(c,d);c.globalCompositeOperation="source-in";c.fillStyle=n?s.getPattern(c,this,getCurrentTransformInverse(i),PathType.FILL):s;c.fillRect(0,0,a,o);c.restore();i.save();i.transform(...l);i.scale(1,-1);drawImageAtIntegerCoords(i,h.canvas,0,0,a,o,0,-1,1,1);this.dependencyTracker?.recordBBox(t,i,0,a,0,o);i.restore()}this.compose();this.dependencyTracker?.recordOperation(t)}paintImageXObject(t,e){if(!this.contentVisible){return}const i=this.getObject(t,e);if(!i){warn("Dependent image isn't ready yet");return}this.paintInlineImageXObject(t,i)}paintImageXObjectRepeat(t,e,i,s,n){if(!this.contentVisible){return}const r=this.getObject(t,e);if(!r){warn("Dependent image isn't ready yet");return}const a=r.width;const o=r.height;const l=[];for(let t=0,e=n.length;t<e;t+=2){l.push({transform:[i,0,0,s,n[t],n[t+1]],x:0,y:0,w:a,h:o})}this.paintInlineImageXObjectGroup(t,r,l)}applyTransferMapsToCanvas(t){if(this.current.transferMaps!=="none"){t.filter=this.current.transferMaps;t.drawImage(t.canvas,0,0);t.filter="none"}return t.canvas}applyTransferMapsToBitmap(t){if(this.current.transferMaps==="none"){return t.bitmap}const{bitmap:e,width:i,height:s}=t;const n=this.cachedCanvases.getCanvas("inlineImage",i,s);const r=n.context;r.filter=this.current.transferMaps;r.drawImage(e,0,0);r.filter="none";return n.canvas}paintInlineImageXObject(t,e){if(!this.contentVisible){return}const i=e.width;const s=e.height;const n=this.ctx;this.save(t);const{filter:r}=n;if(r!=="none"&&r!==""){n.filter="none"}n.scale(1/i,-1/s);let a;if(e.bitmap){a=this.applyTransferMapsToBitmap(e)}else if(typeof HTMLElement==="function"&&e instanceof HTMLElement||!e.data){a=e}else{const t=this.cachedCanvases.getCanvas("inlineImage",i,s);const n=t.context;putBinaryImageData(n,e);a=this.applyTransferMapsToCanvas(n)}const o=this._scaleImage(a,getCurrentTransformInverse(n));n.imageSmoothingEnabled=getImageSmoothingEnabled(getCurrentTransform(n),e.interpolate);this.dependencyTracker?.resetBBox(t).recordBBox(t,n,0,i,-s,0).recordDependencies(t,Dependencies.imageXObject).recordOperation(t);drawImageAtIntegerCoords(n,o.img,0,0,o.paintWidth,o.paintHeight,0,-s,i,s);this.compose();this.restore(t)}paintInlineImageXObjectGroup(t,e,i){if(!this.contentVisible){return}const s=this.ctx;let n;if(e.bitmap){n=e.bitmap}else{const t=e.width;const i=e.height;const s=this.cachedCanvases.getCanvas("inlineImage",t,i);const r=s.context;putBinaryImageData(r,e);n=this.applyTransferMapsToCanvas(r)}this.dependencyTracker?.resetBBox(t);for(const e of i){s.save();s.transform(...e.transform);s.scale(1,-1);drawImageAtIntegerCoords(s,n,e.x,e.y,e.w,e.h,0,-1,1,1);this.dependencyTracker?.recordBBox(t,s,0,1,-1,0);s.restore()}this.dependencyTracker?.recordOperation(t);this.compose()}paintSolidColorImageMask(t){if(!this.contentVisible){return}this.dependencyTracker?.resetBBox(t).recordBBox(t,this.ctx,0,1,0,1).recordDependencies(t,Dependencies.fill).recordOperation(t);this.ctx.fillRect(0,0,1,1);this.compose()}markPoint(t,e){}markPointProps(t,e,i){}beginMarkedContent(t,e){this.dependencyTracker?.beginMarkedContent(t);this.markedContentStack.push({visible:true})}beginMarkedContentProps(t,e,i){this.dependencyTracker?.beginMarkedContent(t);if(e==="OC"){this.markedContentStack.push({visible:this.optionalContentConfig.isVisible(i)})}else{this.markedContentStack.push({visible:true})}this.contentVisible=this.isContentVisible()}endMarkedContent(t){this.dependencyTracker?.endMarkedContent(t);this.markedContentStack.pop();this.contentVisible=this.isContentVisible()}beginCompat(t){}endCompat(t){}consumePath(t,e,i){const s=this.current.isEmptyClip();if(this.pendingClip){this.current.updateClipFromPath()}if(!this.pendingClip){this.compose(i)}const n=this.ctx;if(this.pendingClip){if(!s){if(this.pendingClip===EO_CLIP){n.clip(e,"evenodd")}else{n.clip(e)}}this.pendingClip=null;this.dependencyTracker?.bboxToClipBoxDropOperation(t).recordFutureForcedDependency("clipPath",t)}else{this.dependencyTracker?.recordOperation(t)}this.current.startNewPathAndClipBox(this.current.clipBox)}getSinglePixelWidth(){if(!this._cachedGetSinglePixelWidth){const t=getCurrentTransform(this.ctx);if(t[1]===0&&t[2]===0){this._cachedGetSinglePixelWidth=1/Math.min(Math.abs(t[0]),Math.abs(t[3]))}else{const e=Math.abs(t[0]*t[3]-t[2]*t[1]);const i=Math.hypot(t[0],t[2]);const s=Math.hypot(t[1],t[3]);this._cachedGetSinglePixelWidth=Math.max(i,s)/e}}return this._cachedGetSinglePixelWidth}getScaleForStroking(){if(this._cachedScaleForStroking[0]===-1){const{lineWidth:t}=this.current;const{a:e,b:i,c:s,d:n}=this.ctx.getTransform();let r,a;if(i===0&&s===0){const i=Math.abs(e);const s=Math.abs(n);if(i===s){if(t===0){r=a=1/i}else{const e=i*t;r=a=e<1?1/e:1}}else if(t===0){r=1/i;a=1/s}else{const e=i*t;const n=s*t;r=e<1?1/e:1;a=n<1?1/n:1}}else{const o=Math.abs(e*n-i*s);const l=Math.hypot(e,i);const h=Math.hypot(s,n);if(t===0){r=h/o;a=l/o}else{const e=t*o;r=h>e?h/e:1;a=l>e?l/e:1}}this._cachedScaleForStroking[0]=r;this._cachedScaleForStroking[1]=a}return this._cachedScaleForStroking}rescaleAndStroke(t,e){const{ctx:i,current:{lineWidth:s}}=this;const[n,r]=this.getScaleForStroking();if(n===r){i.lineWidth=(s||1)*n;i.stroke(t);return}const a=i.getLineDash();if(e){i.save()}i.scale(n,r);SCALE_MATRIX.a=1/n;SCALE_MATRIX.d=1/r;const o=new Path2D;o.addPath(t,SCALE_MATRIX);if(a.length>0){const t=Math.max(n,r);i.setLineDash(a.map(e=>e/t));i.lineDashOffset/=t}i.lineWidth=s||1;i.stroke(o);if(e){i.restore()}}isContentVisible(){for(let t=this.markedContentStack.length-1;t>=0;t--){if(!this.markedContentStack[t].visible){return false}}return true}}for(const t in OPS){if(CanvasGraphics.prototype[t]!==undefined){CanvasGraphics.prototype[OPS[t]]=CanvasGraphics.prototype[t]}}class GlobalWorkerOptions{static#ds=null;static#us="";static get workerPort(){return this.#ds}static set workerPort(t){if(!(typeof Worker!=="undefined"&&t instanceof Worker)&&t!==null){throw new Error("Invalid `workerPort` type.")}this.#ds=t}static get workerSrc(){return this.#us}static set workerSrc(t){if(typeof t!=="string"){throw new Error("Invalid `workerSrc` type.")}this.#us=t}}class Metadata{#ps;#gs;constructor({parsedData:t,rawData:e}){this.#ps=t;this.#gs=e}getRaw(){return this.#gs}get(t){return this.#ps.get(t)??null}[Symbol.iterator](){return this.#ps.entries()}}const INTERNAL=Symbol("INTERNAL");class OptionalContentGroup{#fs=false;#ms=false;#bs=false;#As=true;constructor(t,{name:e,intent:i,usage:s,rbGroups:n}){this.#fs=!!(t&RenderingIntentFlag.DISPLAY);this.#ms=!!(t&RenderingIntentFlag.PRINT);this.name=e;this.intent=i;this.usage=s;this.rbGroups=n}get visible(){if(this.#bs){return this.#As}if(!this.#As){return false}const{print:t,view:e}=this.usage;if(this.#fs){return e?.viewState!=="OFF"}else if(this.#ms){return t?.printState!=="OFF"}return true}_setVisible(t,e,i=false){if(t!==INTERNAL){unreachable("Internal method `_setVisible` called.")}this.#bs=i;this.#As=e}}class OptionalContentConfig{#ys=null;#ws=new Map;#Es=null;#vs=null;constructor(t,e=RenderingIntentFlag.DISPLAY){this.renderingIntent=e;this.name=null;this.creator=null;if(t===null){return}this.name=t.name;this.creator=t.creator;this.#vs=t.order;for(const i of t.groups){this.#ws.set(i.id,new OptionalContentGroup(e,i))}if(t.baseState==="OFF"){for(const t of this.#ws.values()){t._setVisible(INTERNAL,false)}}for(const e of t.on){this.#ws.get(e)._setVisible(INTERNAL,true)}for(const e of t.off){this.#ws.get(e)._setVisible(INTERNAL,false)}this.#Es=this.getHash()}#xs(t){const e=t.length;if(e<2){return true}const i=t[0];for(let s=1;s<e;s++){const e=t[s];let n;if(Array.isArray(e)){n=this.#xs(e)}else if(this.#ws.has(e)){n=this.#ws.get(e).visible}else{warn(`Optional content group not found: ${e}`);return true}switch(i){case"And":if(!n){return false}break;case"Or":if(n){return true}break;case"Not":return!n;default:return true}}return i==="And"}isVisible(t){if(this.#ws.size===0){return true}if(!t){info("Optional content group not defined.");return true}if(t.type==="OCG"){if(!this.#ws.has(t.id)){warn(`Optional content group not found: ${t.id}`);return true}return this.#ws.get(t.id).visible}else if(t.type==="OCMD"){if(t.expression){return this.#xs(t.expression)}if(!t.policy||t.policy==="AnyOn"){for(const e of t.ids){if(!this.#ws.has(e)){warn(`Optional content group not found: ${e}`);return true}if(this.#ws.get(e).visible){return true}}return false}else if(t.policy==="AllOn"){for(const e of t.ids){if(!this.#ws.has(e)){warn(`Optional content group not found: ${e}`);return true}if(!this.#ws.get(e).visible){return false}}return true}else if(t.policy==="AnyOff"){for(const e of t.ids){if(!this.#ws.has(e)){warn(`Optional content group not found: ${e}`);return true}if(!this.#ws.get(e).visible){return true}}return false}else if(t.policy==="AllOff"){for(const e of t.ids){if(!this.#ws.has(e)){warn(`Optional content group not found: ${e}`);return true}if(this.#ws.get(e).visible){return false}}return true}warn(`Unknown optional content policy ${t.policy}.`);return true}warn(`Unknown group type ${t.type}.`);return true}setVisibility(t,e=true,i=true){const s=this.#ws.get(t);if(!s){warn(`Optional content group not found: ${t}`);return}if(i&&e&&s.rbGroups.length){for(const e of s.rbGroups){for(const i of e){if(i!==t){this.#ws.get(i)?._setVisible(INTERNAL,false,true)}}}}s._setVisible(INTERNAL,!!e,true);this.#ys=null}setOCGState({state:t,preserveRB:e}){let i;for(const s of t){switch(s){case"ON":case"OFF":case"Toggle":i=s;continue}const t=this.#ws.get(s);if(!t){continue}switch(i){case"ON":this.setVisibility(s,true,e);break;case"OFF":this.setVisibility(s,false,e);break;case"Toggle":this.setVisibility(s,!t.visible,e);break}}this.#ys=null}get hasInitialVisibility(){return this.#Es===null||this.getHash()===this.#Es}getOrder(){if(!this.#ws.size){return null}if(this.#vs){return this.#vs.slice()}return[...this.#ws.keys()]}getGroup(t){return this.#ws.get(t)||null}getHash(){if(this.#ys!==null){return this.#ys}const t=new MurmurHash3_64;for(const[e,i]of this.#ws){t.update(`${e}:${i.visible}`)}return this.#ys=t.hexdigest()}[Symbol.iterator](){return this.#ws.entries()}}class PDFDataTransportStream{constructor(t,{disableRange:e=false,disableStream:i=false}){assert(t,'PDFDataTransportStream - missing required "pdfDataRangeTransport" argument.');const{length:s,initialData:n,progressiveDone:r,contentDispositionFilename:a}=t;this._queuedChunks=[];this._progressiveDone=r;this._contentDispositionFilename=a;if(n?.length>0){const t=n instanceof Uint8Array&&n.byteLength===n.buffer.byteLength?n.buffer:new Uint8Array(n).buffer;this._queuedChunks.push(t)}this._pdfDataRangeTransport=t;this._isStreamingSupported=!i;this._isRangeSupported=!e;this._contentLength=s;this._fullRequestReader=null;this._rangeReaders=[];t.addRangeListener((t,e)=>{this._onReceiveData({begin:t,chunk:e})});t.addProgressListener((t,e)=>{this._onProgress({loaded:t,total:e})});t.addProgressiveReadListener(t=>{this._onReceiveData({chunk:t})});t.addProgressiveDoneListener(()=>{this._onProgressiveDone()});t.transportReady()}_onReceiveData({begin:t,chunk:e}){const i=e instanceof Uint8Array&&e.byteLength===e.buffer.byteLength?e.buffer:new Uint8Array(e).buffer;if(t===undefined){if(this._fullRequestReader){this._fullRequestReader._enqueue(i)}else{this._queuedChunks.push(i)}}else{const e=this._rangeReaders.some(function(e){if(e._begin!==t){return false}e._enqueue(i);return true});assert(e,"_onReceiveData - no `PDFDataTransportStreamRangeReader` instance found.")}}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}_onProgress(t){if(t.total===undefined){this._rangeReaders[0]?.onProgress?.({loaded:t.loaded})}else{this._fullRequestReader?.onProgress?.({loaded:t.loaded,total:t.total})}}_onProgressiveDone(){this._fullRequestReader?.progressiveDone();this._progressiveDone=true}_removeRangeReader(t){const e=this._rangeReaders.indexOf(t);if(e>=0){this._rangeReaders.splice(e,1)}}getFullReader(){assert(!this._fullRequestReader,"PDFDataTransportStream.getFullReader can only be called once.");const t=this._queuedChunks;this._queuedChunks=null;return new PDFDataTransportStreamReader(this,t,this._progressiveDone,this._contentDispositionFilename)}getRangeReader(t,e){if(e<=this._progressiveDataLength){return null}const i=new PDFDataTransportStreamRangeReader(this,t,e);this._pdfDataRangeTransport.requestDataRange(t,e);this._rangeReaders.push(i);return i}cancelAllRequests(t){this._fullRequestReader?.cancel(t);for(const e of this._rangeReaders.slice(0)){e.cancel(t)}this._pdfDataRangeTransport.abort()}}class PDFDataTransportStreamReader{constructor(t,e,i=false,s=null){this._stream=t;this._done=i||false;this._filename=isPdfFile(s)?s:null;this._queuedChunks=e||[];this._loaded=0;for(const t of this._queuedChunks){this._loaded+=t.byteLength}this._requests=[];this._headersReady=Promise.resolve();t._fullRequestReader=this;this.onProgress=null}_enqueue(t){if(this._done){return}if(this._requests.length>0){const e=this._requests.shift();e.resolve({value:t,done:false})}else{this._queuedChunks.push(t)}this._loaded+=t.byteLength}get headersReady(){return this._headersReady}get filename(){return this._filename}get isRangeSupported(){return this._stream._isRangeSupported}get isStreamingSupported(){return this._stream._isStreamingSupported}get contentLength(){return this._stream._contentLength}async read(){if(this._queuedChunks.length>0){const t=this._queuedChunks.shift();return{value:t,done:false}}if(this._done){return{value:undefined,done:true}}const t=Promise.withResolvers();this._requests.push(t);return t.promise}cancel(t){this._done=true;for(const t of this._requests){t.resolve({value:undefined,done:true})}this._requests.length=0}progressiveDone(){if(this._done){return}this._done=true}}class PDFDataTransportStreamRangeReader{constructor(t,e,i){this._stream=t;this._begin=e;this._end=i;this._queuedChunk=null;this._requests=[];this._done=false;this.onProgress=null}_enqueue(t){if(this._done){return}if(this._requests.length===0){this._queuedChunk=t}else{const e=this._requests.shift();e.resolve({value:t,done:false});for(const t of this._requests){t.resolve({value:undefined,done:true})}this._requests.length=0}this._done=true;this._stream._removeRangeReader(this)}get isStreamingSupported(){return false}async read(){if(this._queuedChunk){const t=this._queuedChunk;this._queuedChunk=null;return{value:t,done:false}}if(this._done){return{value:undefined,done:true}}const t=Promise.withResolvers();this._requests.push(t);return t.promise}cancel(t){this._done=true;for(const t of this._requests){t.resolve({value:undefined,done:true})}this._requests.length=0;this._stream._removeRangeReader(this)}}function getFilenameFromContentDispositionHeader(t){let e=true;let i=s("filename\\*","i").exec(t);if(i){i=i[1];let t=o(i);t=unescape(t);t=l(t);t=h(t);return r(t)}i=a(t);if(i){const t=h(i);return r(t)}i=s("filename","i").exec(t);if(i){i=i[1];let t=o(i);t=h(t);return r(t)}function s(t,e){return new RegExp("(?:^|;)\\s*"+t+"\\s*=\\s*"+"("+'[^";\\s][^;\\s]*'+"|"+'"(?:[^"\\\\]|\\\\"?)+"?'+")",e)}function n(t,i){if(t){if(!/^[\x00-\xFF]+$/.test(i)){return i}try{const s=new TextDecoder(t,{fatal:true});const n=stringToBytes(i);i=s.decode(n);e=false}catch{}}return i}function r(t){if(e&&/[\x80-\xff]/.test(t)){t=n("utf-8",t);if(e){t=n("iso-8859-1",t)}}return t}function a(t){const e=[];let i;const n=s("filename\\*((?!0\\d)\\d+)(\\*?)","ig");while((i=n.exec(t))!==null){let[,t,s,n]=i;t=parseInt(t,10);if(t in e){if(t===0){break}continue}e[t]=[s,n]}const r=[];for(let t=0;t<e.length;++t){if(!(t in e)){break}let[i,s]=e[t];s=o(s);if(i){s=unescape(s);if(t===0){s=l(s)}}r.push(s)}return r.join("")}function o(t){if(t.startsWith('"')){const e=t.slice(1).split('\\"');for(let t=0;t<e.length;++t){const i=e[t].indexOf('"');if(i!==-1){e[t]=e[t].slice(0,i);e.length=t+1}e[t]=e[t].replaceAll(/\\(.)/g,"$1")}t=e.join('"')}return t}function l(t){const e=t.indexOf("'");if(e===-1){return t}const i=t.slice(0,e);const s=t.slice(e+1);const r=s.replace(/^[^']*'/,"");return n(i,r)}function h(t){if(!t.startsWith("=?")||/[\x00-\x19\x80-\xff]/.test(t)){return t}return t.replaceAll(/=\?([\w-]*)\?([QqBb])\?((?:[^?]|\?(?!=))*)\?=/g,function(t,e,i,s){if(i==="q"||i==="Q"){s=s.replaceAll("_"," ");s=s.replaceAll(/=([0-9a-fA-F]{2})/g,function(t,e){return String.fromCharCode(parseInt(e,16))});return n(e,s)}try{s=atob(s)}catch{}return n(e,s)})}return""}function createHeaders(t,e){const i=new Headers;if(!t||!e||typeof e!=="object"){return i}for(const t in e){const s=e[t];if(s!==undefined){i.append(t,s)}}return i}function getResponseOrigin(t){return URL.parse(t)?.origin??null}function validateRangeRequestCapabilities({responseHeaders:t,isHttp:e,rangeChunkSize:i,disableRange:s}){const n={allowRangeRequests:false,suggestedLength:undefined};const r=parseInt(t.get("Content-Length"),10);if(!Number.isInteger(r)){return n}n.suggestedLength=r;if(r<=2*i){return n}if(s||!e){return n}if(t.get("Accept-Ranges")!=="bytes"){return n}const a=t.get("Content-Encoding")||"identity";if(a!=="identity"){return n}n.allowRangeRequests=true;return n}function extractFilenameFromHeader(t){const e=t.get("Content-Disposition");if(e){let t=getFilenameFromContentDispositionHeader(e);if(t.includes("%")){try{t=decodeURIComponent(t)}catch{}}if(isPdfFile(t)){return t}}return null}function createResponseError(t,e){return new ResponseException(`Unexpected server response (${t}) while retrieving PDF "${e}".`,t,t===404||t===0&&e.startsWith("file:"))}function validateResponseStatus(t){return t===200||t===206}function createFetchOptions(t,e,i){return{method:"GET",headers:t,signal:i.signal,mode:"cors",credentials:e?"include":"same-origin",redirect:"follow"}}function getArrayBuffer(t){if(t instanceof Uint8Array){return t.buffer}if(t instanceof ArrayBuffer){return t}warn(`getArrayBuffer - unexpected data format: ${t}`);return new Uint8Array(t).buffer}class PDFFetchStream{_responseOrigin=null;constructor(t){this.source=t;this.isHttp=/^https?:/i.test(t.url);this.headers=createHeaders(this.isHttp,t.httpHeaders);this._fullRequestReader=null;this._rangeRequestReaders=[]}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}getFullReader(){assert(!this._fullRequestReader,"PDFFetchStream.getFullReader can only be called once.");this._fullRequestReader=new PDFFetchStreamReader(this);return this._fullRequestReader}getRangeReader(t,e){if(e<=this._progressiveDataLength){return null}const i=new PDFFetchStreamRangeReader(this,t,e);this._rangeRequestReaders.push(i);return i}cancelAllRequests(t){this._fullRequestReader?.cancel(t);for(const e of this._rangeRequestReaders.slice(0)){e.cancel(t)}}}class PDFFetchStreamReader{constructor(t){this._stream=t;this._reader=null;this._loaded=0;this._filename=null;const e=t.source;this._withCredentials=e.withCredentials||false;this._contentLength=e.length;this._headersCapability=Promise.withResolvers();this._disableRange=e.disableRange||false;this._rangeChunkSize=e.rangeChunkSize;if(!this._rangeChunkSize&&!this._disableRange){this._disableRange=true}this._abortController=new AbortController;this._isStreamingSupported=!e.disableStream;this._isRangeSupported=!e.disableRange;const i=new Headers(t.headers);const s=e.url;fetch(s,createFetchOptions(i,this._withCredentials,this._abortController)).then(e=>{t._responseOrigin=getResponseOrigin(e.url);if(!validateResponseStatus(e.status)){throw createResponseError(e.status,s)}this._reader=e.body.getReader();this._headersCapability.resolve();const i=e.headers;const{allowRangeRequests:n,suggestedLength:r}=validateRangeRequestCapabilities({responseHeaders:i,isHttp:t.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});this._isRangeSupported=n;this._contentLength=r||this._contentLength;this._filename=extractFilenameFromHeader(i);if(!this._isStreamingSupported&&this._isRangeSupported){this.cancel(new AbortException("Streaming is disabled."))}}).catch(this._headersCapability.reject);this.onProgress=null}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._headersCapability.promise;const{value:t,done:e}=await this._reader.read();if(e){return{value:t,done:e}}this._loaded+=t.byteLength;this.onProgress?.({loaded:this._loaded,total:this._contentLength});return{value:getArrayBuffer(t),done:false}}cancel(t){this._reader?.cancel(t);this._abortController.abort()}}class PDFFetchStreamRangeReader{constructor(t,e,i){this._stream=t;this._reader=null;this._loaded=0;const s=t.source;this._withCredentials=s.withCredentials||false;this._readCapability=Promise.withResolvers();this._isStreamingSupported=!s.disableStream;this._abortController=new AbortController;const n=new Headers(t.headers);n.append("Range",`bytes=${e}-${i-1}`);const r=s.url;fetch(r,createFetchOptions(n,this._withCredentials,this._abortController)).then(e=>{const i=getResponseOrigin(e.url);if(i!==t._responseOrigin){throw new Error(`Expected range response-origin "${i}" to match "${t._responseOrigin}".`)}if(!validateResponseStatus(e.status)){throw createResponseError(e.status,r)}this._readCapability.resolve();this._reader=e.body.getReader()}).catch(this._readCapability.reject);this.onProgress=null}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._readCapability.promise;const{value:t,done:e}=await this._reader.read();if(e){return{value:t,done:e}}this._loaded+=t.byteLength;this.onProgress?.({loaded:this._loaded});return{value:getArrayBuffer(t),done:false}}cancel(t){this._reader?.cancel(t);this._abortController.abort()}}const OK_RESPONSE=200;const PARTIAL_CONTENT_RESPONSE=206;function network_getArrayBuffer(t){const e=t.response;if(typeof e!=="string"){return e}return stringToBytes(e).buffer}class NetworkManager{_responseOrigin=null;constructor({url:t,httpHeaders:e,withCredentials:i}){this.url=t;this.isHttp=/^https?:/i.test(t);this.headers=createHeaders(this.isHttp,e);this.withCredentials=i||false;this.currXhrId=0;this.pendingRequests=Object.create(null)}request(t){const e=new XMLHttpRequest;const i=this.currXhrId++;const s=this.pendingRequests[i]={xhr:e};e.open("GET",this.url);e.withCredentials=this.withCredentials;for(const[t,i]of this.headers){e.setRequestHeader(t,i)}if(this.isHttp&&"begin"in t&&"end"in t){e.setRequestHeader("Range",`bytes=${t.begin}-${t.end-1}`);s.expectedStatus=PARTIAL_CONTENT_RESPONSE}else{s.expectedStatus=OK_RESPONSE}e.responseType="arraybuffer";assert(t.onError,"Expected `onError` callback to be provided.");e.onerror=()=>{t.onError(e.status)};e.onreadystatechange=this.onStateChange.bind(this,i);e.onprogress=this.onProgress.bind(this,i);s.onHeadersReceived=t.onHeadersReceived;s.onDone=t.onDone;s.onError=t.onError;s.onProgress=t.onProgress;e.send(null);return i}onProgress(t,e){const i=this.pendingRequests[t];if(!i){return}i.onProgress?.(e)}onStateChange(t,e){const i=this.pendingRequests[t];if(!i){return}const s=i.xhr;if(s.readyState>=2&&i.onHeadersReceived){i.onHeadersReceived();delete i.onHeadersReceived}if(s.readyState!==4){return}if(!(t in this.pendingRequests)){return}delete this.pendingRequests[t];if(s.status===0&&this.isHttp){i.onError(s.status);return}const n=s.status||OK_RESPONSE;const r=n===OK_RESPONSE&&i.expectedStatus===PARTIAL_CONTENT_RESPONSE;if(!r&&n!==i.expectedStatus){i.onError(s.status);return}const a=network_getArrayBuffer(s);if(n===PARTIAL_CONTENT_RESPONSE){const t=s.getResponseHeader("Content-Range");const e=/bytes (\d+)-(\d+)\/(\d+)/.exec(t);if(e){i.onDone({begin:parseInt(e[1],10),chunk:a})}else{warn(`Missing or invalid "Content-Range" header.`);i.onError(0)}}else if(a){i.onDone({begin:0,chunk:a})}else{i.onError(s.status)}}getRequestXhr(t){return this.pendingRequests[t].xhr}isPendingRequest(t){return t in this.pendingRequests}abortRequest(t){const e=this.pendingRequests[t].xhr;delete this.pendingRequests[t];e.abort()}}class PDFNetworkStream{constructor(t){this._source=t;this._manager=new NetworkManager(t);this._rangeChunkSize=t.rangeChunkSize;this._fullRequestReader=null;this._rangeRequestReaders=[]}_onRangeRequestReaderClosed(t){const e=this._rangeRequestReaders.indexOf(t);if(e>=0){this._rangeRequestReaders.splice(e,1)}}getFullReader(){assert(!this._fullRequestReader,"PDFNetworkStream.getFullReader can only be called once.");this._fullRequestReader=new PDFNetworkStreamFullRequestReader(this._manager,this._source);return this._fullRequestReader}getRangeReader(t,e){const i=new PDFNetworkStreamRangeRequestReader(this._manager,t,e);i.onClosed=this._onRangeRequestReaderClosed.bind(this);this._rangeRequestReaders.push(i);return i}cancelAllRequests(t){this._fullRequestReader?.cancel(t);for(const e of this._rangeRequestReaders.slice(0)){e.cancel(t)}}}class PDFNetworkStreamFullRequestReader{constructor(t,e){this._manager=t;this._url=e.url;this._fullRequestId=t.request({onHeadersReceived:this._onHeadersReceived.bind(this),onDone:this._onDone.bind(this),onError:this._onError.bind(this),onProgress:this._onProgress.bind(this)});this._headersCapability=Promise.withResolvers();this._disableRange=e.disableRange||false;this._contentLength=e.length;this._rangeChunkSize=e.rangeChunkSize;if(!this._rangeChunkSize&&!this._disableRange){this._disableRange=true}this._isStreamingSupported=false;this._isRangeSupported=false;this._cachedChunks=[];this._requests=[];this._done=false;this._storedError=undefined;this._filename=null;this.onProgress=null}_onHeadersReceived(){const t=this._fullRequestId;const e=this._manager.getRequestXhr(t);this._manager._responseOrigin=getResponseOrigin(e.responseURL);const i=e.getAllResponseHeaders();const s=new Headers(i?i.trimStart().replace(/[^\S ]+$/,"").split(/[\r\n]+/).map(t=>{const[e,...i]=t.split(": ");return[e,i.join(": ")]}):[]);const{allowRangeRequests:n,suggestedLength:r}=validateRangeRequestCapabilities({responseHeaders:s,isHttp:this._manager.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});if(n){this._isRangeSupported=true}this._contentLength=r||this._contentLength;this._filename=extractFilenameFromHeader(s);if(this._isRangeSupported){this._manager.abortRequest(t)}this._headersCapability.resolve()}_onDone(t){if(t){if(this._requests.length>0){const e=this._requests.shift();e.resolve({value:t.chunk,done:false})}else{this._cachedChunks.push(t.chunk)}}this._done=true;if(this._cachedChunks.length>0){return}for(const t of this._requests){t.resolve({value:undefined,done:true})}this._requests.length=0}_onError(t){this._storedError=createResponseError(t,this._url);this._headersCapability.reject(this._storedError);for(const t of this._requests){t.reject(this._storedError)}this._requests.length=0;this._cachedChunks.length=0}_onProgress(t){this.onProgress?.({loaded:t.loaded,total:t.lengthComputable?t.total:this._contentLength})}get filename(){return this._filename}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}get contentLength(){return this._contentLength}get headersReady(){return this._headersCapability.promise}async read(){await this._headersCapability.promise;if(this._storedError){throw this._storedError}if(this._cachedChunks.length>0){const t=this._cachedChunks.shift();return{value:t,done:false}}if(this._done){return{value:undefined,done:true}}const t=Promise.withResolvers();this._requests.push(t);return t.promise}cancel(t){this._done=true;this._headersCapability.reject(t);for(const t of this._requests){t.resolve({value:undefined,done:true})}this._requests.length=0;if(this._manager.isPendingRequest(this._fullRequestId)){this._manager.abortRequest(this._fullRequestId)}this._fullRequestReader=null}}class PDFNetworkStreamRangeRequestReader{constructor(t,e,i){this._manager=t;this._url=t.url;this._requestId=t.request({begin:e,end:i,onHeadersReceived:this._onHeadersReceived.bind(this),onDone:this._onDone.bind(this),onError:this._onError.bind(this),onProgress:this._onProgress.bind(this)});this._requests=[];this._queuedChunk=null;this._done=false;this._storedError=undefined;this.onProgress=null;this.onClosed=null}_onHeadersReceived(){const t=getResponseOrigin(this._manager.getRequestXhr(this._requestId)?.responseURL);if(t!==this._manager._responseOrigin){this._storedError=new Error(`Expected range response-origin "${t}" to match "${this._manager._responseOrigin}".`);this._onError(0)}}_close(){this.onClosed?.(this)}_onDone(t){const e=t.chunk;if(this._requests.length>0){const t=this._requests.shift();t.resolve({value:e,done:false})}else{this._queuedChunk=e}this._done=true;for(const t of this._requests){t.resolve({value:undefined,done:true})}this._requests.length=0;this._close()}_onError(t){this._storedError??=createResponseError(t,this._url);for(const t of this._requests){t.reject(this._storedError)}this._requests.length=0;this._queuedChunk=null}_onProgress(t){if(!this.isStreamingSupported){this.onProgress?.({loaded:t.loaded})}}get isStreamingSupported(){return false}async read(){if(this._storedError){throw this._storedError}if(this._queuedChunk!==null){const t=this._queuedChunk;this._queuedChunk=null;return{value:t,done:false}}if(this._done){return{value:undefined,done:true}}const t=Promise.withResolvers();this._requests.push(t);return t.promise}cancel(t){this._done=true;for(const t of this._requests){t.resolve({value:undefined,done:true})}this._requests.length=0;if(this._manager.isPendingRequest(this._requestId)){this._manager.abortRequest(this._requestId)}this._close()}}const urlRegex=/^[a-z][a-z0-9\-+.]+:/i;function parseUrlOrPath(t){if(urlRegex.test(t)){return new URL(t)}const e=process.getBuiltinModule("url");return new URL(e.pathToFileURL(t))}class PDFNodeStream{constructor(t){this.source=t;this.url=parseUrlOrPath(t.url);assert(this.url.protocol==="file:","PDFNodeStream only supports file:// URLs.");this._fullRequestReader=null;this._rangeRequestReaders=[]}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}getFullReader(){assert(!this._fullRequestReader,"PDFNodeStream.getFullReader can only be called once.");this._fullRequestReader=new PDFNodeStreamFsFullReader(this);return this._fullRequestReader}getRangeReader(t,e){if(e<=this._progressiveDataLength){return null}const i=new PDFNodeStreamFsRangeReader(this,t,e);this._rangeRequestReaders.push(i);return i}cancelAllRequests(t){this._fullRequestReader?.cancel(t);for(const e of this._rangeRequestReaders.slice(0)){e.cancel(t)}}}class PDFNodeStreamFsFullReader{constructor(t){this._url=t.url;this._done=false;this._storedError=null;this.onProgress=null;const e=t.source;this._contentLength=e.length;this._loaded=0;this._filename=null;this._disableRange=e.disableRange||false;this._rangeChunkSize=e.rangeChunkSize;if(!this._rangeChunkSize&&!this._disableRange){this._disableRange=true}this._isStreamingSupported=!e.disableStream;this._isRangeSupported=!e.disableRange;this._readableStream=null;this._readCapability=Promise.withResolvers();this._headersCapability=Promise.withResolvers();const i=process.getBuiltinModule("fs");i.promises.lstat(this._url).then(t=>{this._contentLength=t.size;this._setReadableStream(i.createReadStream(this._url));this._headersCapability.resolve()},t=>{if(t.code==="ENOENT"){t=createResponseError(0,this._url.href)}this._storedError=t;this._headersCapability.reject(t)})}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._readCapability.promise;if(this._done){return{value:undefined,done:true}}if(this._storedError){throw this._storedError}const t=this._readableStream.read();if(t===null){this._readCapability=Promise.withResolvers();return this.read()}this._loaded+=t.length;this.onProgress?.({loaded:this._loaded,total:this._contentLength});const e=new Uint8Array(t).buffer;return{value:e,done:false}}cancel(t){if(!this._readableStream){this._error(t);return}this._readableStream.destroy(t)}_error(t){this._storedError=t;this._readCapability.resolve()}_setReadableStream(t){this._readableStream=t;t.on("readable",()=>{this._readCapability.resolve()});t.on("end",()=>{t.destroy();this._done=true;this._readCapability.resolve()});t.on("error",t=>{this._error(t)});if(!this._isStreamingSupported&&this._isRangeSupported){this._error(new AbortException("streaming is disabled"))}if(this._storedError){this._readableStream.destroy(this._storedError)}}}class PDFNodeStreamFsRangeReader{constructor(t,e,i){this._url=t.url;this._done=false;this._storedError=null;this.onProgress=null;this._loaded=0;this._readableStream=null;this._readCapability=Promise.withResolvers();const s=t.source;this._isStreamingSupported=!s.disableStream;const n=process.getBuiltinModule("fs");this._setReadableStream(n.createReadStream(this._url,{start:e,end:i-1}))}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._readCapability.promise;if(this._done){return{value:undefined,done:true}}if(this._storedError){throw this._storedError}const t=this._readableStream.read();if(t===null){this._readCapability=Promise.withResolvers();return this.read()}this._loaded+=t.length;this.onProgress?.({loaded:this._loaded});const e=new Uint8Array(t).buffer;return{value:e,done:false}}cancel(t){if(!this._readableStream){this._error(t);return}this._readableStream.destroy(t)}_error(t){this._storedError=t;this._readCapability.resolve()}_setReadableStream(t){this._readableStream=t;t.on("readable",()=>{this._readCapability.resolve()});t.on("end",()=>{t.destroy();this._done=true;this._readCapability.resolve()});t.on("error",t=>{this._error(t)});if(this._storedError){this._readableStream.destroy(this._storedError)}}}const INITIAL_DATA=Symbol("INITIAL_DATA");class PDFObjects{#_s=Object.create(null);#Ts(t){return this.#_s[t]||={...Promise.withResolvers(),data:INITIAL_DATA}}get(t,e=null){if(e){const i=this.#Ts(t);i.promise.then(()=>e(i.data));return null}const i=this.#_s[t];if(!i||i.data===INITIAL_DATA){throw new Error(`Requesting object that isn't resolved yet ${t}.`)}return i.data}has(t){const e=this.#_s[t];return!!e&&e.data!==INITIAL_DATA}delete(t){const e=this.#_s[t];if(!e||e.data===INITIAL_DATA){return false}delete this.#_s[t];return true}resolve(t,e=null){const i=this.#Ts(t);i.data=e;i.resolve()}clear(){for(const t in this.#_s){const{data:e}=this.#_s[t];e?.bitmap?.close()}this.#_s=Object.create(null)}*[Symbol.iterator](){for(const t in this.#_s){const{data:e}=this.#_s[t];if(e===INITIAL_DATA){continue}yield[t,e]}}}const MAX_TEXT_DIVS_TO_RENDER=1e5;const DEFAULT_FONT_SIZE=30;class TextLayer{#Ss=Promise.withResolvers();#wt=null;#Cs=false;#Ds=!!globalThis.FontInspector?.enabled;#Ms=null;#Is=null;#Ps=0;#ks=0;#Rs=null;#Ls=null;#Fs=0;#Os=0;#Ns=Object.create(null);#Bs=[];#Hs=null;#Us=[];#Gs=new WeakMap;#zs=null;static#Ws=new Map;static#$s=new Map;static#Vs=new WeakMap;static#js=null;static#Ks=new Set;constructor({textContentSource:t,container:e,viewport:i}){if(t instanceof ReadableStream){this.#Hs=t}else if(typeof t==="object"){this.#Hs=new ReadableStream({start(e){e.enqueue(t);e.close()}})}else{throw new Error('No "textContentSource" parameter specified.')}this.#wt=this.#Ls=e;this.#Os=i.scale*OutputScale.pixelRatio;this.#Fs=i.rotation;this.#Is={div:null,properties:null,ctx:null};const{pageWidth:s,pageHeight:n,pageX:r,pageY:a}=i.rawDims;this.#zs=[1,0,0,-1,-r,a+n];this.#ks=s;this.#Ps=n;TextLayer.#Xs();setLayerDimensions(e,i);this.#Ss.promise.finally(()=>{TextLayer.#Ks.delete(this);this.#Is=null;this.#Ns=null}).catch(()=>{})}static get fontFamilyMap(){const{isWindows:t,isFirefox:e}=util_FeatureTest.platform;return shadow(this,"fontFamilyMap",new Map([["sans-serif",`${t&&e?"Calibri, ":""}sans-serif`],["monospace",`${t&&e?"Lucida Console, ":""}monospace`]]))}render(){const t=()=>{this.#Rs.read().then(({value:e,done:i})=>{if(i){this.#Ss.resolve();return}this.#Ms??=e.lang;Object.assign(this.#Ns,e.styles);this.#qs(e.items);t()},this.#Ss.reject)};this.#Rs=this.#Hs.getReader();TextLayer.#Ks.add(this);t();return this.#Ss.promise}update({viewport:t,onBefore:e=null}){const i=t.scale*OutputScale.pixelRatio;const s=t.rotation;if(s!==this.#Fs){e?.();this.#Fs=s;setLayerDimensions(this.#Ls,{rotation:s})}if(i!==this.#Os){e?.();this.#Os=i;const t={div:null,properties:null,ctx:TextLayer.#Ys(this.#Ms)};for(const e of this.#Us){t.properties=this.#Gs.get(e);t.div=e;this.#Js(t)}}}cancel(){const t=new AbortException("TextLayer task cancelled.");this.#Rs?.cancel(t).catch(()=>{});this.#Rs=null;this.#Ss.reject(t)}get textDivs(){return this.#Us}get textContentItemsStr(){return this.#Bs}#qs(t){if(this.#Cs){return}this.#Is.ctx??=TextLayer.#Ys(this.#Ms);const e=this.#Us,i=this.#Bs;for(const s of t){if(e.length>MAX_TEXT_DIVS_TO_RENDER){warn("Ignoring additional textDivs for performance reasons.");this.#Cs=true;return}if(s.str===undefined){if(s.type==="beginMarkedContentProps"||s.type==="beginMarkedContent"){const t=this.#wt;this.#wt=document.createElement("span");this.#wt.classList.add("markedContent");if(s.id){this.#wt.setAttribute("id",`${s.id}`)}t.append(this.#wt)}else if(s.type==="endMarkedContent"){this.#wt=this.#wt.parentNode}continue}i.push(s.str);this.#Qs(s)}}#Qs(t){const e=document.createElement("span");const i={angle:0,canvasWidth:0,hasText:t.str!=="",hasEOL:t.hasEOL,fontSize:0};this.#Us.push(e);const s=Util.transform(this.#zs,t.transform);let n=Math.atan2(s[1],s[0]);const r=this.#Ns[t.fontName];if(r.vertical){n+=Math.PI/2}let a=this.#Ds&&r.fontSubstitution||r.fontFamily;a=TextLayer.fontFamilyMap.get(a)||a;const o=Math.hypot(s[2],s[3]);const l=o*TextLayer.#Zs(a,r,this.#Ms);let h,c;if(n===0){h=s[4];c=s[5]-l}else{h=s[4]+l*Math.sin(n);c=s[5]-l*Math.cos(n)}const d="calc(var(--total-scale-factor) *";const u=e.style;if(this.#wt===this.#Ls){u.left=`${(100*h/this.#ks).toFixed(2)}%`;u.top=`${(100*c/this.#Ps).toFixed(2)}%`}else{u.left=`${d}${h.toFixed(2)}px)`;u.top=`${d}${c.toFixed(2)}px)`}u.fontSize=`${d}${(TextLayer.#js*o).toFixed(2)}px)`;u.fontFamily=a;i.fontSize=o;e.setAttribute("role","presentation");e.textContent=t.str;e.dir=t.dir;if(this.#Ds){e.dataset.fontName=r.fontSubstitutionLoadedName||t.fontName}if(n!==0){i.angle=n*(180/Math.PI)}let p=false;if(t.str.length>1){p=true}else if(t.str!==" "&&t.transform[0]!==t.transform[3]){const e=Math.abs(t.transform[0]),i=Math.abs(t.transform[3]);if(e!==i&&Math.max(e,i)/Math.min(e,i)>1.5){p=true}}if(p){i.canvasWidth=r.vertical?t.height:t.width}this.#Gs.set(e,i);this.#Is.div=e;this.#Is.properties=i;this.#Js(this.#Is);if(i.hasText){this.#wt.append(e)}if(i.hasEOL){const t=document.createElement("br");t.setAttribute("role","presentation");this.#wt.append(t)}}#Js(t){const{div:e,properties:i,ctx:s}=t;const{style:n}=e;let r="";if(TextLayer.#js>1){r=`scale(${1/TextLayer.#js})`}if(i.canvasWidth!==0&&i.hasText){const{fontFamily:t}=n;const{canvasWidth:a,fontSize:o}=i;TextLayer.#tn(s,o*this.#Os,t);const{width:l}=s.measureText(e.textContent);if(l>0){r=`scaleX(${a*this.#Os/l}) ${r}`}}if(i.angle!==0){r=`rotate(${i.angle}deg) ${r}`}if(r.length>0){n.transform=r}}static cleanup(){if(this.#Ks.size>0){return}this.#Ws.clear();for(const{canvas:t}of this.#$s.values()){t.remove()}this.#$s.clear()}static#Ys(t=null){let e=this.#$s.get(t||="");if(!e){const i=document.createElement("canvas");i.className="hiddenCanvasElement";i.lang=t;document.body.append(i);e=i.getContext("2d",{alpha:false,willReadFrequently:true});this.#$s.set(t,e);this.#Vs.set(e,{size:0,family:""})}return e}static#tn(t,e,i){const s=this.#Vs.get(t);if(e===s.size&&i===s.family){return}t.font=`${e}px ${i}`;s.size=e;s.family=i}static#Xs(){if(this.#js!==null){return}const t=document.createElement("div");t.style.opacity=0;t.style.lineHeight=1;t.style.fontSize="1px";t.style.position="absolute";t.textContent="X";document.body.append(t);this.#js=t.getBoundingClientRect().height;t.remove()}static#Zs(t,e,i){const s=this.#Ws.get(t);if(s){return s}const n=this.#Ys(i);n.canvas.width=n.canvas.height=DEFAULT_FONT_SIZE;this.#tn(n,DEFAULT_FONT_SIZE,t);const r=n.measureText("");const a=r.fontBoundingBoxAscent;const o=Math.abs(r.fontBoundingBoxDescent);n.canvas.width=n.canvas.height=0;let l=.8;if(a){l=a/(a+o)}else{if(util_FeatureTest.platform.isFirefox){warn("Enable the `dom.textMetrics.fontBoundingBox.enabled` preference "+"in `about:config` to improve TextLayer rendering.")}if(e.ascent){l=e.ascent}else if(e.descent){l=1+e.descent}}this.#Ws.set(t,l);return l}}class XfaText{static textContent(t){const e=[];const i={items:e,styles:Object.create(null)};function s(t){if(!t){return}let i=null;const n=t.name;if(n==="#text"){i=t.value}else if(!XfaText.shouldBuildText(n)){return}else if(t?.attributes?.textContent){i=t.attributes.textContent}else if(t.value){i=t.value}if(i!==null){e.push({str:i})}if(!t.children){return}for(const e of t.children){s(e)}}s(t);return i}static shouldBuildText(t){return!(t==="textarea"||t==="input"||t==="option"||t==="select")}}const RENDERING_CANCELLED_TIMEOUT=100;function getDocument(t={}){if(typeof t==="string"||t instanceof URL){t={url:t}}else if(t instanceof ArrayBuffer||ArrayBuffer.isView(t)){t={data:t}}const e=new PDFDocumentLoadingTask;const{docId:i}=e;const s=t.url?getUrlProp(t.url):null;const n=t.data?getDataProp(t.data):null;const r=t.httpHeaders||null;const a=t.withCredentials===true;const o=t.password??null;const l=t.range instanceof PDFDataRangeTransport?t.range:null;const h=Number.isInteger(t.rangeChunkSize)&&t.rangeChunkSize>0?t.rangeChunkSize:2**16;let c=t.worker instanceof PDFWorker?t.worker:null;const d=t.verbosity;const u=typeof t.docBaseUrl==="string"&&!isDataScheme(t.docBaseUrl)?t.docBaseUrl:null;const p=getFactoryUrlProp(t.cMapUrl);const g=t.cMapPacked!==false;const f=t.CMapReaderFactory||(isNodeJS?NodeCMapReaderFactory:DOMCMapReaderFactory);const m=getFactoryUrlProp(t.iccUrl);const b=getFactoryUrlProp(t.standardFontDataUrl);const A=t.StandardFontDataFactory||(isNodeJS?NodeStandardFontDataFactory:DOMStandardFontDataFactory);const y=getFactoryUrlProp(t.wasmUrl);const w=t.WasmFactory||(isNodeJS?NodeWasmFactory:DOMWasmFactory);const E=t.stopAtErrors!==true;const v=Number.isInteger(t.maxImageSize)&&t.maxImageSize>-1?t.maxImageSize:-1;const x=t.isEvalSupported!==false;const _=typeof t.isOffscreenCanvasSupported==="boolean"?t.isOffscreenCanvasSupported:!isNodeJS;const T=typeof t.isImageDecoderSupported==="boolean"?t.isImageDecoderSupported:!isNodeJS&&(util_FeatureTest.platform.isFirefox||!globalThis.chrome);const S=Number.isInteger(t.canvasMaxAreaInBytes)?t.canvasMaxAreaInBytes:-1;const C=typeof t.disableFontFace==="boolean"?t.disableFontFace:isNodeJS;const D=t.fontExtraProperties===true;const M=t.enableXfa===true;const I=t.ownerDocument||globalThis.document;const P=t.disableRange===true;const k=t.disableStream===true;const R=t.disableAutoFetch===true;const L=t.pdfBug===true;const F=t.CanvasFactory||(isNodeJS?NodeCanvasFactory:DOMCanvasFactory);const O=t.FilterFactory||(isNodeJS?NodeFilterFactory:DOMFilterFactory);const N=t.enableHWA===true;const B=t.useWasm!==false;const H=l?l.length:t.length??NaN;const U=typeof t.useSystemFonts==="boolean"?t.useSystemFonts:!isNodeJS&&!C;const G=typeof t.useWorkerFetch==="boolean"?t.useWorkerFetch:!!(f===DOMCMapReaderFactory&&A===DOMStandardFontDataFactory&&w===DOMWasmFactory&&p&&b&&y&&isValidFetchUrl(p,document.baseURI)&&isValidFetchUrl(b,document.baseURI)&&isValidFetchUrl(y,document.baseURI));const z=null;setVerbosityLevel(d);const W={canvasFactory:new F({ownerDocument:I,enableHWA:N}),filterFactory:new O({docId:i,ownerDocument:I}),cMapReaderFactory:G?null:new f({baseUrl:p,isCompressed:g}),standardFontDataFactory:G?null:new A({baseUrl:b}),wasmFactory:G?null:new w({baseUrl:y})};if(!c){c=PDFWorker.create({verbosity:d,port:GlobalWorkerOptions.workerPort});e._worker=c}const $={docId:i,apiVersion:"5.4.149",data:n,password:o,disableAutoFetch:R,rangeChunkSize:h,length:H,docBaseUrl:u,enableXfa:M,evaluatorOptions:{maxImageSize:v,disableFontFace:C,ignoreErrors:E,isEvalSupported:x,isOffscreenCanvasSupported:_,isImageDecoderSupported:T,canvasMaxAreaInBytes:S,fontExtraProperties:D,useSystemFonts:U,useWasm:B,useWorkerFetch:G,cMapUrl:p,iccUrl:m,standardFontDataUrl:b,wasmUrl:y}};const V={ownerDocument:I,pdfBug:L,styleElement:z,loadingParams:{disableAutoFetch:R,enableXfa:M}};c.promise.then(function(){if(e.destroyed){throw new Error("Loading aborted")}if(c.destroyed){throw new Error("Worker was destroyed")}const t=c.messageHandler.sendWithPromise("GetDocRequest",$,n?[n.buffer]:null);let o;if(l){o=new PDFDataTransportStream(l,{disableRange:P,disableStream:k})}else if(!n){if(!s){throw new Error("getDocument - no `url` parameter provided.")}const t=isValidFetchUrl(s)?PDFFetchStream:isNodeJS?PDFNodeStream:PDFNetworkStream;o=new t({url:s,length:H,httpHeaders:r,withCredentials:a,rangeChunkSize:h,disableRange:P,disableStream:k})}return t.then(t=>{if(e.destroyed){throw new Error("Loading aborted")}if(c.destroyed){throw new Error("Worker was destroyed")}const s=new MessageHandler(i,t,c.port);const n=new WorkerTransport(s,e,o,V,W,N);e._transport=n;s.send("Ready",null)})}).catch(e._capability.reject);return e}class PDFDocumentLoadingTask{static#Mi=0;_capability=Promise.withResolvers();_transport=null;_worker=null;docId=`d${PDFDocumentLoadingTask.#Mi++}`;destroyed=false;onPassword=null;onProgress=null;get promise(){return this._capability.promise}async destroy(){this.destroyed=true;try{if(this._worker?.port){this._worker._pendingDestroy=true}await(this._transport?.destroy())}catch(t){if(this._worker?.port){delete this._worker._pendingDestroy}throw t}this._transport=null;this._worker?.destroy();this._worker=null}async getData(){return this._transport.getData()}}class PDFDataRangeTransport{#Ss=Promise.withResolvers();#en=[];#in=[];#sn=[];#nn=[];constructor(t,e,i=false,s=null){this.length=t;this.initialData=e;this.progressiveDone=i;this.contentDispositionFilename=s}addRangeListener(t){this.#nn.push(t)}addProgressListener(t){this.#sn.push(t)}addProgressiveReadListener(t){this.#in.push(t)}addProgressiveDoneListener(t){this.#en.push(t)}onDataRange(t,e){for(const i of this.#nn){i(t,e)}}onDataProgress(t,e){this.#Ss.promise.then(()=>{for(const i of this.#sn){i(t,e)}})}onDataProgressiveRead(t){this.#Ss.promise.then(()=>{for(const e of this.#in){e(t)}})}onDataProgressiveDone(){this.#Ss.promise.then(()=>{for(const t of this.#en){t()}})}transportReady(){this.#Ss.resolve()}requestDataRange(t,e){unreachable("Abstract method PDFDataRangeTransport.requestDataRange")}abort(){}}class PDFDocumentProxy{constructor(t,e){this._pdfInfo=t;this._transport=e}get annotationStorage(){return this._transport.annotationStorage}get canvasFactory(){return this._transport.canvasFactory}get filterFactory(){return this._transport.filterFactory}get numPages(){return this._pdfInfo.numPages}get fingerprints(){return this._pdfInfo.fingerprints}get isPureXfa(){return shadow(this,"isPureXfa",!!this._transport._htmlForXfa)}get allXfaHtml(){return this._transport._htmlForXfa}getPage(t){return this._transport.getPage(t)}getPageIndex(t){return this._transport.getPageIndex(t)}getDestinations(){return this._transport.getDestinations()}getDestination(t){return this._transport.getDestination(t)}getPageLabels(){return this._transport.getPageLabels()}getPageLayout(){return this._transport.getPageLayout()}getPageMode(){return this._transport.getPageMode()}getViewerPreferences(){return this._transport.getViewerPreferences()}getOpenAction(){return this._transport.getOpenAction()}getAttachments(){return this._transport.getAttachments()}getAnnotationsByType(t,e){return this._transport.getAnnotationsByType(t,e)}getJSActions(){return this._transport.getDocJSActions()}getOutline(){return this._transport.getOutline()}getOptionalContentConfig({intent:t="display"}={}){const{renderingIntent:e}=this._transport.getRenderingIntent(t);return this._transport.getOptionalContentConfig(e)}getPermissions(){return this._transport.getPermissions()}getMetadata(){return this._transport.getMetadata()}getMarkInfo(){return this._transport.getMarkInfo()}getData(){return this._transport.getData()}saveDocument(){return this._transport.saveDocument()}getDownloadInfo(){return this._transport.downloadInfoCapability.promise}cleanup(t=false){return this._transport.startCleanup(t||this.isPureXfa)}destroy(){return this.loadingTask.destroy()}cachedPageNumber(t){return this._transport.cachedPageNumber(t)}get loadingParams(){return this._transport.loadingParams}get loadingTask(){return this._transport.loadingTask}getFieldObjects(){return this._transport.getFieldObjects()}hasJSActions(){return this._transport.hasJSActions()}getCalculationOrderIds(){return this._transport.getCalculationOrderIds()}}class PDFPageProxy{#rn=false;constructor(t,e,i,s=false){this._pageIndex=t;this._pageInfo=e;this._transport=i;this._stats=s?new StatTimer:null;this._pdfBug=s;this.commonObjs=i.commonObjs;this.objs=new PDFObjects;this._intentStates=new Map;this.destroyed=false;this.recordedGroups=null}get pageNumber(){return this._pageIndex+1}get rotate(){return this._pageInfo.rotate}get ref(){return this._pageInfo.ref}get userUnit(){return this._pageInfo.userUnit}get view(){return this._pageInfo.view}getViewport({scale:t,rotation:e=this.rotate,offsetX:i=0,offsetY:s=0,dontFlip:n=false}={}){return new PageViewport({viewBox:this.view,userUnit:this.userUnit,scale:t,rotation:e,offsetX:i,offsetY:s,dontFlip:n})}getAnnotations({intent:t="display"}={}){const{renderingIntent:e}=this._transport.getRenderingIntent(t);return this._transport.getAnnotations(this._pageIndex,e)}getJSActions(){return this._transport.getPageJSActions(this._pageIndex)}get filterFactory(){return this._transport.filterFactory}get isPureXfa(){return shadow(this,"isPureXfa",!!this._transport._htmlForXfa)}async getXfa(){return this._transport._htmlForXfa?.children[this._pageIndex]||null}render({canvasContext:t,canvas:e=t.canvas,viewport:i,intent:s="display",annotationMode:n=AnnotationMode.ENABLE,transform:r=null,background:a=null,optionalContentConfigPromise:o=null,annotationCanvasMap:l=null,pageColors:h=null,printAnnotationStorage:c=null,isEditing:d=false,recordOperations:u=false,filteredOperationIndexes:p=null}){this._stats?.time("Overall");const g=this._transport.getRenderingIntent(s,n,c,d);const{renderingIntent:f,cacheKey:m}=g;this.#rn=false;o||=this._transport.getOptionalContentConfig(f);let b=this._intentStates.get(m);if(!b){b=Object.create(null);this._intentStates.set(m,b)}if(b.streamReaderCancelTimeout){clearTimeout(b.streamReaderCancelTimeout);b.streamReaderCancelTimeout=null}const A=!!(f&RenderingIntentFlag.PRINT);if(!b.displayReadyCapability){b.displayReadyCapability=Promise.withResolvers();b.operatorList={fnArray:[],argsArray:[],lastChunk:false,separateAnnots:null};this._stats?.time("Page Request");this._pumpOperatorList(g)}const y=!this.recordedGroups&&(u||this._pdfBug&&globalThis.StepperManager?.enabled);const w=t=>{b.renderTasks.delete(E);if(y){const t=E.gfx?.dependencyTracker.take();if(t){E.stepper?.setOperatorGroups(t);if(u){this.recordedGroups=t}}else if(u){this.recordedGroups=[]}}if(A){this.#rn=true}this.#an();if(t){E.capability.reject(t);this._abortOperatorList({intentState:b,reason:t instanceof Error?t:new Error(t)})}else{E.capability.resolve()}if(this._stats){this._stats.timeEnd("Rendering");this._stats.timeEnd("Overall");if(globalThis.Stats?.enabled){globalThis.Stats.add(this.pageNumber,this._stats)}}};const E=new InternalRenderTask({callback:w,params:{canvas:e,canvasContext:t,dependencyTracker:y?new CanvasDependencyTracker(e):null,viewport:i,transform:r,background:a},objs:this.objs,commonObjs:this.commonObjs,annotationCanvasMap:l,operatorList:b.operatorList,pageIndex:this._pageIndex,canvasFactory:this._transport.canvasFactory,filterFactory:this._transport.filterFactory,useRequestAnimationFrame:!A,pdfBug:this._pdfBug,pageColors:h,enableHWA:this._transport.enableHWA,filteredOperationIndexes:p});(b.renderTasks||=new Set).add(E);const v=E.task;Promise.all([b.displayReadyCapability.promise,o]).then(([t,e])=>{if(this.destroyed){w();return}this._stats?.time("Rendering");if(!(e.renderingIntent&f)){throw new Error("Must use the same `intent`-argument when calling the `PDFPageProxy.render` "+"and `PDFDocumentProxy.getOptionalContentConfig` methods.")}E.initializeGraphics({transparency:t,optionalContentConfig:e});E.operatorListChanged()}).catch(w);return v}getOperatorList({intent:t="display",annotationMode:e=AnnotationMode.ENABLE,printAnnotationStorage:i=null,isEditing:s=false}={}){function n(){if(a.operatorList.lastChunk){a.opListReadCapability.resolve(a.operatorList);a.renderTasks.delete(o)}}const r=this._transport.getRenderingIntent(t,e,i,s,true);let a=this._intentStates.get(r.cacheKey);if(!a){a=Object.create(null);this._intentStates.set(r.cacheKey,a)}let o;if(!a.opListReadCapability){o=Object.create(null);o.operatorListChanged=n;a.opListReadCapability=Promise.withResolvers();(a.renderTasks||=new Set).add(o);a.operatorList={fnArray:[],argsArray:[],lastChunk:false,separateAnnots:null};this._stats?.time("Page Request");this._pumpOperatorList(r)}return a.opListReadCapability.promise}streamTextContent({includeMarkedContent:t=false,disableNormalization:e=false}={}){const i=100;return this._transport.messageHandler.sendWithStream("GetTextContent",{pageIndex:this._pageIndex,includeMarkedContent:t===true,disableNormalization:e===true},{highWaterMark:i,size(t){return t.items.length}})}getTextContent(t={}){if(this._transport._htmlForXfa){return this.getXfa().then(t=>XfaText.textContent(t))}const e=this.streamTextContent(t);return new Promise(function(t,i){function s(){n.read().then(function({value:e,done:i}){if(i){t(r);return}r.lang??=e.lang;Object.assign(r.styles,e.styles);r.items.push(...e.items);s()},i)}const n=e.getReader();const r={items:[],styles:Object.create(null),lang:null};s()})}getStructTree(){return this._transport.getStructTree(this._pageIndex)}_destroy(){this.destroyed=true;const t=[];for(const e of this._intentStates.values()){this._abortOperatorList({intentState:e,reason:new Error("Page was destroyed."),force:true});if(e.opListReadCapability){continue}for(const i of e.renderTasks){t.push(i.completed);i.cancel()}}this.objs.clear();this.#rn=false;return Promise.all(t)}cleanup(t=false){this.#rn=true;const e=this.#an();if(t&&e){this._stats&&=new StatTimer}return e}#an(){if(!this.#rn||this.destroyed){return false}for(const{renderTasks:t,operatorList:e}of this._intentStates.values()){if(t.size>0||!e.lastChunk){return false}}this._intentStates.clear();this.objs.clear();this.#rn=false;return true}_startRenderPage(t,e){const i=this._intentStates.get(e);if(!i){return}this._stats?.timeEnd("Page Request");i.displayReadyCapability?.resolve(t)}_renderPageChunk(t,e){for(let i=0,s=t.length;i<s;i++){e.operatorList.fnArray.push(t.fnArray[i]);e.operatorList.argsArray.push(t.argsArray[i])}e.operatorList.lastChunk=t.lastChunk;e.operatorList.separateAnnots=t.separateAnnots;for(const t of e.renderTasks){t.operatorListChanged()}if(t.lastChunk){this.#an()}}_pumpOperatorList({renderingIntent:t,cacheKey:e,annotationStorageSerializable:i,modifiedIds:s}){const{map:n,transfer:r}=i;const a=this._transport.messageHandler.sendWithStream("GetOperatorList",{pageIndex:this._pageIndex,intent:t,cacheKey:e,annotationStorage:n,modifiedIds:s},r);const o=a.getReader();const l=this._intentStates.get(e);l.streamReader=o;const h=()=>{o.read().then(({value:t,done:e})=>{if(e){l.streamReader=null;return}if(this._transport.destroyed){return}this._renderPageChunk(t,l);h()},t=>{l.streamReader=null;if(this._transport.destroyed){return}if(l.operatorList){l.operatorList.lastChunk=true;for(const t of l.renderTasks){t.operatorListChanged()}this.#an()}if(l.displayReadyCapability){l.displayReadyCapability.reject(t)}else if(l.opListReadCapability){l.opListReadCapability.reject(t)}else{throw t}})};h()}_abortOperatorList({intentState:t,reason:e,force:i=false}){if(!t.streamReader){return}if(t.streamReaderCancelTimeout){clearTimeout(t.streamReaderCancelTimeout);t.streamReaderCancelTimeout=null}if(!i){if(t.renderTasks.size>0){return}if(e instanceof RenderingCancelledException){let i=RENDERING_CANCELLED_TIMEOUT;if(e.extraDelay>0&&e.extraDelay<1e3){i+=e.extraDelay}t.streamReaderCancelTimeout=setTimeout(()=>{t.streamReaderCancelTimeout=null;this._abortOperatorList({intentState:t,reason:e,force:true})},i);return}}t.streamReader.cancel(new AbortException(e.message)).catch(()=>{});t.streamReader=null;if(this._transport.destroyed){return}for(const[e,i]of this._intentStates){if(i===t){this._intentStates.delete(e);break}}this.cleanup()}get stats(){return this._stats}}class PDFWorker{#Ss=Promise.withResolvers();#on=null;#ds=null;#ln=null;static#hn=0;static#cn=false;static#dn=new WeakMap;static{if(isNodeJS){this.#cn=true;GlobalWorkerOptions.workerSrc||="./pdf.worker.mjs"}this._isSameOrigin=(t,e)=>{const i=URL.parse(t);if(!i?.origin||i.origin==="null"){return false}const s=new URL(e,i);return i.origin===s.origin};this._createCDNWrapper=t=>{const e=`await import("${t}");`;return URL.createObjectURL(new Blob([e],{type:"text/javascript"}))};this.fromPort=t=>{deprecated("`PDFWorker.fromPort` - please use `PDFWorker.create` instead.");if(!t?.port){throw new Error("PDFWorker.fromPort - invalid method signature.")}return this.create(t)}}constructor({name:t=null,port:e=null,verbosity:i=getVerbosityLevel()}={}){this.name=t;this.destroyed=false;this.verbosity=i;if(e){if(PDFWorker.#dn.has(e)){throw new Error("Cannot use more than one PDFWorker per port.")}PDFWorker.#dn.set(e,this);this.#un(e)}else{this.#pn()}}get promise(){return this.#Ss.promise}#gn(){this.#Ss.resolve();this.#on.send("configure",{verbosity:this.verbosity})}get port(){return this.#ds}get messageHandler(){return this.#on}#un(t){this.#ds=t;this.#on=new MessageHandler("main","worker",t);this.#on.on("ready",()=>{});this.#gn()}#pn(){if(PDFWorker.#cn||PDFWorker.#fn){this.#mn();return}let{workerSrc:t}=PDFWorker;try{if(!PDFWorker._isSameOrigin(window.location,t)){t=PDFWorker._createCDNWrapper(new URL(t,window.location).href)}const e=new Worker(t,{type:"module"});const i=new MessageHandler("main","worker",e);const s=()=>{n.abort();i.destroy();e.terminate();if(this.destroyed){this.#Ss.reject(new Error("Worker was destroyed"))}else{this.#mn()}};const n=new AbortController;e.addEventListener("error",()=>{if(!this.#ln){s()}},{signal:n.signal});i.on("test",t=>{n.abort();if(this.destroyed||!t){s();return}this.#on=i;this.#ds=e;this.#ln=e;this.#gn()});i.on("ready",t=>{n.abort();if(this.destroyed){s();return}try{r()}catch{this.#mn()}});const r=()=>{const t=new Uint8Array;i.send("test",t,[t.buffer])};r();return}catch{info("The worker has been disabled.")}this.#mn()}#mn(){if(!PDFWorker.#cn){warn("Setting up fake worker.");PDFWorker.#cn=true}PDFWorker._setupFakeWorkerGlobal.then(t=>{if(this.destroyed){this.#Ss.reject(new Error("Worker was destroyed"));return}const e=new LoopbackPort;this.#ds=e;const i=`fake${PDFWorker.#hn++}`;const s=new MessageHandler(i+"_worker",i,e);t.setup(s,e);this.#on=new MessageHandler(i,i+"_worker",e);this.#gn()}).catch(t=>{this.#Ss.reject(new Error(`Setting up fake worker failed: "${t.message}".`))})}destroy(){this.destroyed=true;this.#ln?.terminate();this.#ln=null;PDFWorker.#dn.delete(this.#ds);this.#ds=null;this.#on?.destroy();this.#on=null}static create(t){const e=this.#dn.get(t?.port);if(e){if(e._pendingDestroy){throw new Error("PDFWorker.create - the worker is being destroyed.\n"+"Please remember to await `PDFDocumentLoadingTask.destroy()`-calls.")}return e}return new PDFWorker(t)}static get workerSrc(){if(GlobalWorkerOptions.workerSrc){return GlobalWorkerOptions.workerSrc}throw new Error('No "GlobalWorkerOptions.workerSrc" specified.')}static get#fn(){try{return globalThis.pdfjsWorker?.WorkerMessageHandler||null}catch{return null}}static get _setupFakeWorkerGlobal(){const t=async()=>{if(this.#fn){return this.#fn}const t=await import(this.workerSrc);return t.WorkerMessageHandler};return shadow(this,"_setupFakeWorkerGlobal",t())}}class WorkerTransport{#bn=new Map;#An=new Map;#yn=new Map;#wn=new Map;#En=null;constructor(t,e,i,s,n,r){this.messageHandler=t;this.loadingTask=e;this.commonObjs=new PDFObjects;this.fontLoader=new FontLoader({ownerDocument:s.ownerDocument,styleElement:s.styleElement});this.loadingParams=s.loadingParams;this._params=s;this.canvasFactory=n.canvasFactory;this.filterFactory=n.filterFactory;this.cMapReaderFactory=n.cMapReaderFactory;this.standardFontDataFactory=n.standardFontDataFactory;this.wasmFactory=n.wasmFactory;this.destroyed=false;this.destroyCapability=null;this._networkStream=i;this._fullReader=null;this._lastProgress=null;this.downloadInfoCapability=Promise.withResolvers();this.enableHWA=r;this.setupMessageHandler()}#vn(t,e=null){const i=this.#bn.get(t);if(i){return i}const s=this.messageHandler.sendWithPromise(t,e);this.#bn.set(t,s);return s}get annotationStorage(){return shadow(this,"annotationStorage",new AnnotationStorage)}getRenderingIntent(t,e=AnnotationMode.ENABLE,i=null,s=false,n=false){let r=RenderingIntentFlag.DISPLAY;let a=SerializableEmpty;switch(t){case"any":r=RenderingIntentFlag.ANY;break;case"display":break;case"print":r=RenderingIntentFlag.PRINT;break;default:warn(`getRenderingIntent - invalid intent: ${t}`)}const o=r&RenderingIntentFlag.PRINT&&i instanceof PrintAnnotationStorage?i:this.annotationStorage;switch(e){case AnnotationMode.DISABLE:r+=RenderingIntentFlag.ANNOTATIONS_DISABLE;break;case AnnotationMode.ENABLE:break;case AnnotationMode.ENABLE_FORMS:r+=RenderingIntentFlag.ANNOTATIONS_FORMS;break;case AnnotationMode.ENABLE_STORAGE:r+=RenderingIntentFlag.ANNOTATIONS_STORAGE;a=o.serializable;break;default:warn(`getRenderingIntent - invalid annotationMode: ${e}`)}if(s){r+=RenderingIntentFlag.IS_EDITING}if(n){r+=RenderingIntentFlag.OPLIST}const{ids:l,hash:h}=o.modifiedIds;const c=[r,a.hash,h];return{renderingIntent:r,cacheKey:c.join("_"),annotationStorageSerializable:a,modifiedIds:l}}destroy(){if(this.destroyCapability){return this.destroyCapability.promise}this.destroyed=true;this.destroyCapability=Promise.withResolvers();this.#En?.reject(new Error("Worker was destroyed during onPassword callback"));const t=[];for(const e of this.#An.values()){t.push(e._destroy())}this.#An.clear();this.#yn.clear();this.#wn.clear();if(this.hasOwnProperty("annotationStorage")){this.annotationStorage.resetModified()}const e=this.messageHandler.sendWithPromise("Terminate",null);t.push(e);Promise.all(t).then(()=>{this.commonObjs.clear();this.fontLoader.clear();this.#bn.clear();this.filterFactory.destroy();TextLayer.cleanup();this._networkStream?.cancelAllRequests(new AbortException("Worker was terminated."));this.messageHandler?.destroy();this.messageHandler=null;this.destroyCapability.resolve()},this.destroyCapability.reject);return this.destroyCapability.promise}setupMessageHandler(){const{messageHandler:t,loadingTask:e}=this;t.on("GetReader",(t,e)=>{assert(this._networkStream,"GetReader - no `IPDFStream` instance available.");this._fullReader=this._networkStream.getFullReader();this._fullReader.onProgress=t=>{this._lastProgress={loaded:t.loaded,total:t.total}};e.onPull=()=>{this._fullReader.read().then(function({value:t,done:i}){if(i){e.close();return}assert(t instanceof ArrayBuffer,"GetReader - expected an ArrayBuffer.");e.enqueue(new Uint8Array(t),1,[t])}).catch(t=>{e.error(t)})};e.onCancel=t=>{this._fullReader.cancel(t);e.ready.catch(t=>{if(this.destroyed){return}throw t})}});t.on("ReaderHeadersReady",async t=>{await this._fullReader.headersReady;const{isStreamingSupported:i,isRangeSupported:s,contentLength:n}=this._fullReader;if(!i||!s){if(this._lastProgress){e.onProgress?.(this._lastProgress)}this._fullReader.onProgress=t=>{e.onProgress?.({loaded:t.loaded,total:t.total})}}return{isStreamingSupported:i,isRangeSupported:s,contentLength:n}});t.on("GetRangeReader",(t,e)=>{assert(this._networkStream,"GetRangeReader - no `IPDFStream` instance available.");const i=this._networkStream.getRangeReader(t.begin,t.end);if(!i){e.close();return}e.onPull=()=>{i.read().then(function({value:t,done:i}){if(i){e.close();return}assert(t instanceof ArrayBuffer,"GetRangeReader - expected an ArrayBuffer.");e.enqueue(new Uint8Array(t),1,[t])}).catch(t=>{e.error(t)})};e.onCancel=t=>{i.cancel(t);e.ready.catch(t=>{if(this.destroyed){return}throw t})}});t.on("GetDoc",({pdfInfo:t})=>{this._numPages=t.numPages;this._htmlForXfa=t.htmlForXfa;delete t.htmlForXfa;e._capability.resolve(new PDFDocumentProxy(t,this))});t.on("DocException",t=>{e._capability.reject(wrapReason(t))});t.on("PasswordRequest",t=>{this.#En=Promise.withResolvers();try{if(!e.onPassword){throw wrapReason(t)}const i=t=>{if(t instanceof Error){this.#En.reject(t)}else{this.#En.resolve({password:t})}};e.onPassword(i,t.code)}catch(t){this.#En.reject(t)}return this.#En.promise});t.on("DataLoaded",t=>{e.onProgress?.({loaded:t.length,total:t.length});this.downloadInfoCapability.resolve(t)});t.on("StartRenderPage",t=>{if(this.destroyed){return}const e=this.#An.get(t.pageIndex);e._startRenderPage(t.transparency,t.cacheKey)});t.on("commonobj",([e,i,s])=>{if(this.destroyed){return null}if(this.commonObjs.has(e)){return null}switch(i){case"Font":if("error"in s){const t=s.error;warn(`Error during font loading: ${t}`);this.commonObjs.resolve(e,t);break}const n=this._params.pdfBug&&globalThis.FontInspector?.enabled?(t,e)=>globalThis.FontInspector.fontAdded(t,e):null;const r=new FontFaceObject(s,n);this.fontLoader.bind(r).catch(()=>t.sendWithPromise("FontFallback",{id:e})).finally(()=>{if(!r.fontExtraProperties&&r.data){r.data=null}this.commonObjs.resolve(e,r)});break;case"CopyLocalImage":const{imageRef:a}=s;assert(a,"The imageRef must be defined.");for(const t of this.#An.values()){for(const[,i]of t.objs){if(i?.ref!==a){continue}if(!i.dataLen){return null}this.commonObjs.resolve(e,structuredClone(i));return i.dataLen}}break;case"FontPath":case"Image":case"Pattern":this.commonObjs.resolve(e,s);break;default:throw new Error(`Got unknown common object type ${i}`)}return null});t.on("obj",([t,e,i,s])=>{if(this.destroyed){return}const n=this.#An.get(e);if(n.objs.has(t)){return}if(n._intentStates.size===0){s?.bitmap?.close();return}switch(i){case"Image":case"Pattern":n.objs.resolve(t,s);break;default:throw new Error(`Got unknown object type ${i}`)}});t.on("DocProgress",t=>{if(this.destroyed){return}e.onProgress?.({loaded:t.loaded,total:t.total})});t.on("FetchBinaryData",async t=>{if(this.destroyed){throw new Error("Worker was destroyed.")}const e=this[t.type];if(!e){throw new Error(`${t.type} not initialized, see the \`useWorkerFetch\` parameter.`)}return e.fetch(t)})}getData(){return this.messageHandler.sendWithPromise("GetData",null)}saveDocument(){if(this.annotationStorage.size<=0){warn("saveDocument called while `annotationStorage` is empty, "+"please use the getData-method instead.")}const{map:t,transfer:e}=this.annotationStorage.serializable;return this.messageHandler.sendWithPromise("SaveDocument",{isPureXfa:!!this._htmlForXfa,numPages:this._numPages,annotationStorage:t,filename:this._fullReader?.filename??null},e).finally(()=>{this.annotationStorage.resetModified()})}getPage(t){if(!Number.isInteger(t)||t<=0||t>this._numPages){return Promise.reject(new Error("Invalid page request."))}const e=t-1,i=this.#yn.get(e);if(i){return i}const s=this.messageHandler.sendWithPromise("GetPage",{pageIndex:e}).then(i=>{if(this.destroyed){throw new Error("Transport destroyed")}if(i.refStr){this.#wn.set(i.refStr,t)}const s=new PDFPageProxy(e,i,this,this._params.pdfBug);this.#An.set(e,s);return s});this.#yn.set(e,s);return s}getPageIndex(t){if(!isRefProxy(t)){return Promise.reject(new Error("Invalid pageIndex request."))}return this.messageHandler.sendWithPromise("GetPageIndex",{num:t.num,gen:t.gen})}getAnnotations(t,e){return this.messageHandler.sendWithPromise("GetAnnotations",{pageIndex:t,intent:e})}getFieldObjects(){return this.#vn("GetFieldObjects")}hasJSActions(){return this.#vn("HasJSActions")}getCalculationOrderIds(){return this.messageHandler.sendWithPromise("GetCalculationOrderIds",null)}getDestinations(){return this.messageHandler.sendWithPromise("GetDestinations",null)}getDestination(t){if(typeof t!=="string"){return Promise.reject(new Error("Invalid destination request."))}return this.messageHandler.sendWithPromise("GetDestination",{id:t})}getPageLabels(){return this.messageHandler.sendWithPromise("GetPageLabels",null)}getPageLayout(){return this.messageHandler.sendWithPromise("GetPageLayout",null)}getPageMode(){return this.messageHandler.sendWithPromise("GetPageMode",null)}getViewerPreferences(){return this.messageHandler.sendWithPromise("GetViewerPreferences",null)}getOpenAction(){return this.messageHandler.sendWithPromise("GetOpenAction",null)}getAttachments(){return this.messageHandler.sendWithPromise("GetAttachments",null)}getAnnotationsByType(t,e){return this.messageHandler.sendWithPromise("GetAnnotationsByType",{types:t,pageIndexesToSkip:e})}getDocJSActions(){return this.#vn("GetDocJSActions")}getPageJSActions(t){return this.messageHandler.sendWithPromise("GetPageJSActions",{pageIndex:t})}getStructTree(t){return this.messageHandler.sendWithPromise("GetStructTree",{pageIndex:t})}getOutline(){return this.messageHandler.sendWithPromise("GetOutline",null)}getOptionalContentConfig(t){return this.#vn("GetOptionalContentConfig").then(e=>new OptionalContentConfig(e,t))}getPermissions(){return this.messageHandler.sendWithPromise("GetPermissions",null)}getMetadata(){const t="GetMetadata",e=this.#bn.get(t);if(e){return e}const i=this.messageHandler.sendWithPromise(t,null).then(t=>({info:t[0],metadata:t[1]?new Metadata(t[1]):null,contentDispositionFilename:this._fullReader?.filename??null,contentLength:this._fullReader?.contentLength??null}));this.#bn.set(t,i);return i}getMarkInfo(){return this.messageHandler.sendWithPromise("GetMarkInfo",null)}async startCleanup(t=false){if(this.destroyed){return}await this.messageHandler.sendWithPromise("Cleanup",null);for(const t of this.#An.values()){const e=t.cleanup();if(!e){throw new Error(`startCleanup: Page ${t.pageNumber} is currently rendering.`)}}this.commonObjs.clear();if(!t){this.fontLoader.clear()}this.#bn.clear();this.filterFactory.destroy(true);TextLayer.cleanup()}cachedPageNumber(t){if(!isRefProxy(t)){return null}const e=t.gen===0?`${t.num}R`:`${t.num}R${t.gen}`;return this.#wn.get(e)??null}}class RenderTask{#xn=null;onContinue=null;onError=null;constructor(t){this.#xn=t}get promise(){return this.#xn.capability.promise}cancel(t=0){this.#xn.cancel(null,t)}get separateAnnots(){const{separateAnnots:t}=this.#xn.operatorList;if(!t){return false}const{annotationCanvasMap:e}=this.#xn;return t.form||t.canvas&&e?.size>0}}class InternalRenderTask{#_n=null;static#Tn=new WeakSet;constructor({callback:t,params:e,objs:i,commonObjs:s,annotationCanvasMap:n,operatorList:r,pageIndex:a,canvasFactory:o,filterFactory:l,useRequestAnimationFrame:h=false,pdfBug:c=false,pageColors:d=null,enableHWA:u=false,filteredOperationIndexes:p=null}){this.callback=t;this.params=e;this.objs=i;this.commonObjs=s;this.annotationCanvasMap=n;this.operatorListIdx=null;this.operatorList=r;this._pageIndex=a;this.canvasFactory=o;this.filterFactory=l;this._pdfBug=c;this.pageColors=d;this.running=false;this.graphicsReadyCallback=null;this.graphicsReady=false;this._useRequestAnimationFrame=h===true&&typeof window!=="undefined";this.cancelled=false;this.capability=Promise.withResolvers();this.task=new RenderTask(this);this._cancelBound=this.cancel.bind(this);this._continueBound=this._continue.bind(this);this._scheduleNextBound=this._scheduleNext.bind(this);this._nextBound=this._next.bind(this);this._canvas=e.canvas;this._canvasContext=e.canvas?null:e.canvasContext;this._enableHWA=u;this._dependencyTracker=e.dependencyTracker;this._filteredOperationIndexes=p}get completed(){return this.capability.promise.catch(function(){})}initializeGraphics({transparency:t=false,optionalContentConfig:e}){if(this.cancelled){return}if(this._canvas){if(InternalRenderTask.#Tn.has(this._canvas)){throw new Error("Cannot use the same canvas during multiple render() operations. "+"Use different canvas or ensure previous operations were "+"cancelled or completed.")}InternalRenderTask.#Tn.add(this._canvas)}if(this._pdfBug&&globalThis.StepperManager?.enabled){this.stepper=globalThis.StepperManager.create(this._pageIndex);this.stepper.init(this.operatorList);this.stepper.nextBreakPoint=this.stepper.getNextBreakPoint()}const{viewport:i,transform:s,background:n,dependencyTracker:r}=this.params;const a=this._canvasContext||this._canvas.getContext("2d",{alpha:false,willReadFrequently:!this._enableHWA});this.gfx=new CanvasGraphics(a,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:e},this.annotationCanvasMap,this.pageColors,r);this.gfx.beginDrawing({transform:s,viewport:i,transparency:t,background:n});this.operatorListIdx=0;this.graphicsReady=true;this.graphicsReadyCallback?.()}cancel(t=null,e=0){this.running=false;this.cancelled=true;this.gfx?.endDrawing();if(this.#_n){window.cancelAnimationFrame(this.#_n);this.#_n=null}InternalRenderTask.#Tn.delete(this._canvas);t||=new RenderingCancelledException(`Rendering cancelled, page ${this._pageIndex+1}`,e);this.callback(t);this.task.onError?.(t)}operatorListChanged(){if(!this.graphicsReady){this.graphicsReadyCallback||=this._continueBound;return}this.stepper?.updateOperatorList(this.operatorList);if(this.running){return}this._continue()}_continue(){this.running=true;if(this.cancelled){return}if(this.task.onContinue){this.task.onContinue(this._scheduleNextBound)}else{this._scheduleNext()}}_scheduleNext(){if(this._useRequestAnimationFrame){this.#_n=window.requestAnimationFrame(()=>{this.#_n=null;this._nextBound().catch(this._cancelBound)})}else{Promise.resolve().then(this._nextBound).catch(this._cancelBound)}}async _next(){if(this.cancelled){return}this.operatorListIdx=this.gfx.executeOperatorList(this.operatorList,this.operatorListIdx,this._continueBound,this.stepper,this._filteredOperationIndexes);if(this.operatorListIdx===this.operatorList.argsArray.length){this.running=false;if(this.operatorList.lastChunk){this.gfx.endDrawing();InternalRenderTask.#Tn.delete(this._canvas);this.callback()}}}}const version="5.4.149";const build="9e2e9e209";class ColorPicker{#Sn=null;#Cn=null;#Dn;#Mn=null;#In=false;#Pn=false;#r=null;#kn;#Rn=null;#m=null;static#Ln=null;static get _keyboardManager(){return shadow(this,"_keyboardManager",new KeyboardManager([[["Escape","mac+Escape"],ColorPicker.prototype._hideDropdownFromKeyboard],[[" ","mac+ "],ColorPicker.prototype._colorSelectFromKeyboard],[["ArrowDown","ArrowRight","mac+ArrowDown","mac+ArrowRight"],ColorPicker.prototype._moveToNext],[["ArrowUp","ArrowLeft","mac+ArrowUp","mac+ArrowLeft"],ColorPicker.prototype._moveToPrevious],[["Home","mac+Home"],ColorPicker.prototype._moveToBeginning],[["End","mac+End"],ColorPicker.prototype._moveToEnd]]))}constructor({editor:t=null,uiManager:e=null}){if(t){this.#Pn=false;this.#r=t}else{this.#Pn=true}this.#m=t?._uiManager||e;this.#kn=this.#m._eventBus;this.#Dn=t?.color?.toUpperCase()||this.#m?.highlightColors.values().next().value||"#FFFF98";ColorPicker.#Ln||=Object.freeze({blue:"pdfjs-editor-colorpicker-blue",green:"pdfjs-editor-colorpicker-green",pink:"pdfjs-editor-colorpicker-pink",red:"pdfjs-editor-colorpicker-red",yellow:"pdfjs-editor-colorpicker-yellow"})}renderButton(){const t=this.#Sn=document.createElement("button");t.className="colorPicker";t.tabIndex="0";t.setAttribute("data-l10n-id","pdfjs-editor-colorpicker-button");t.ariaHasPopup="true";if(this.#r){t.ariaControls=`${this.#r.id}_colorpicker_dropdown`}const e=this.#m._signal;t.addEventListener("click",this.#Fn.bind(this),{signal:e});t.addEventListener("keydown",this.#On.bind(this),{signal:e});const i=this.#Cn=document.createElement("span");i.className="swatch";i.ariaHidden="true";i.style.backgroundColor=this.#Dn;t.append(i);return t}renderMainDropdown(){const t=this.#Mn=this.#Nn();t.ariaOrientation="horizontal";t.ariaLabelledBy="highlightColorPickerLabel";return t}#Nn(){const t=document.createElement("div");const e=this.#m._signal;t.addEventListener("contextmenu",noContextMenu,{signal:e});t.className="dropdown";t.role="listbox";t.ariaMultiSelectable="false";t.ariaOrientation="vertical";t.setAttribute("data-l10n-id","pdfjs-editor-colorpicker-dropdown");if(this.#r){t.id=`${this.#r.id}_colorpicker_dropdown`}for(const[i,s]of this.#m.highlightColors){const n=document.createElement("button");n.tabIndex="0";n.role="option";n.setAttribute("data-color",s);n.title=i;n.setAttribute("data-l10n-id",ColorPicker.#Ln[i]);const r=document.createElement("span");n.append(r);r.className="swatch";r.style.backgroundColor=s;n.ariaSelected=s===this.#Dn;n.addEventListener("click",this.#Bn.bind(this,s),{signal:e});t.append(n)}t.addEventListener("keydown",this.#On.bind(this),{signal:e});return t}#Bn(t,e){e.stopPropagation();this.#kn.dispatch("switchannotationeditorparams",{source:this,type:AnnotationEditorParamsType.HIGHLIGHT_COLOR,value:t});this.updateColor(t)}_colorSelectFromKeyboard(t){if(t.target===this.#Sn){this.#Fn(t);return}const e=t.target.getAttribute("data-color");if(!e){return}this.#Bn(e,t)}_moveToNext(t){if(!this.#Hn){this.#Fn(t);return}if(t.target===this.#Sn){this.#Mn.firstChild?.focus();return}t.target.nextSibling?.focus()}_moveToPrevious(t){if(t.target===this.#Mn?.firstChild||t.target===this.#Sn){if(this.#Hn){this._hideDropdownFromKeyboard()}return}if(!this.#Hn){this.#Fn(t)}t.target.previousSibling?.focus()}_moveToBeginning(t){if(!this.#Hn){this.#Fn(t);return}this.#Mn.firstChild?.focus()}_moveToEnd(t){if(!this.#Hn){this.#Fn(t);return}this.#Mn.lastChild?.focus()}#On(t){ColorPicker._keyboardManager.exec(this,t)}#Fn(t){if(this.#Hn){this.hideDropdown();return}this.#In=t.detail===0;if(!this.#Rn){this.#Rn=new AbortController;window.addEventListener("pointerdown",this.#d.bind(this),{signal:this.#m.combinedSignal(this.#Rn)})}this.#Sn.ariaExpanded="true";if(this.#Mn){this.#Mn.classList.remove("hidden");return}const e=this.#Mn=this.#Nn();this.#Sn.append(e)}#d(t){if(this.#Mn?.contains(t.target)){return}this.hideDropdown()}hideDropdown(){this.#Mn?.classList.add("hidden");this.#Sn.ariaExpanded="false";this.#Rn?.abort();this.#Rn=null}get#Hn(){return this.#Mn&&!this.#Mn.classList.contains("hidden")}_hideDropdownFromKeyboard(){if(this.#Pn){return}if(!this.#Hn){this.#r?.unselect();return}this.hideDropdown();this.#Sn.focus({preventScroll:true,focusVisible:this.#In})}updateColor(t){if(this.#Cn){this.#Cn.style.backgroundColor=t}if(!this.#Mn){return}const e=this.#m.highlightColors.values();for(const i of this.#Mn.children){i.ariaSelected=e.next().value===t.toUpperCase()}}destroy(){this.#Sn?.remove();this.#Sn=null;this.#Cn=null;this.#Mn?.remove();this.#Mn=null}}class BasicColorPicker{#Un=null;#r=null;#m=null;static#Ln=null;constructor(t){this.#r=t;this.#m=t._uiManager;BasicColorPicker.#Ln||=Object.freeze({freetext:"pdfjs-editor-color-picker-free-text-input",ink:"pdfjs-editor-color-picker-ink-input"})}renderButton(){if(this.#Un){return this.#Un}const{editorType:t,colorType:e,colorValue:i}=this.#r;const s=this.#Un=document.createElement("input");s.type="color";s.value=i||"#000000";s.className="basicColorPicker";s.tabIndex=0;s.setAttribute("data-l10n-id",BasicColorPicker.#Ln[t]);s.addEventListener("input",()=>{this.#m.updateParams(e,s.value)},{signal:this.#m._signal});return s}update(t){if(!this.#Un){return}this.#Un.value=t}destroy(){this.#Un?.remove();this.#Un=null}hideDropdown(){}}function makeColorComp(t){return Math.floor(Math.max(0,Math.min(1,t))*255).toString(16).padStart(2,"0")}function scaleAndClamp(t){return Math.max(0,Math.min(255,255*t))}class ColorConverters{static CMYK_G([t,e,i,s]){return["G",1-Math.min(1,.3*t+.59*i+.11*e+s)]}static G_CMYK([t]){return["CMYK",0,0,0,1-t]}static G_RGB([t]){return["RGB",t,t,t]}static G_rgb([t]){t=scaleAndClamp(t);return[t,t,t]}static G_HTML([t]){const e=makeColorComp(t);return`#${e}${e}${e}`}static RGB_G([t,e,i]){return["G",.3*t+.59*e+.11*i]}static RGB_rgb(t){return t.map(scaleAndClamp)}static RGB_HTML(t){return`#${t.map(makeColorComp).join("")}`}static T_HTML(){return"#00000000"}static T_rgb(){return[null]}static CMYK_RGB([t,e,i,s]){return["RGB",1-Math.min(1,t+s),1-Math.min(1,i+s),1-Math.min(1,e+s)]}static CMYK_rgb([t,e,i,s]){return[scaleAndClamp(1-Math.min(1,t+s)),scaleAndClamp(1-Math.min(1,i+s)),scaleAndClamp(1-Math.min(1,e+s))]}static CMYK_HTML(t){const e=this.CMYK_RGB(t).slice(1);return this.RGB_HTML(e)}static RGB_CMYK([t,e,i]){const s=1-t;const n=1-e;const r=1-i;const a=Math.min(s,n,r);return["CMYK",s,n,r,a]}}const DateFormats=null&&["m/d","m/d/yy","mm/dd/yy","mm/yy","d-mmm","d-mmm-yy","dd-mmm-yy","yy-mm-dd","mmm-yy","mmmm-yy","mmm d, yyyy","mmmm d, yyyy","m/d/yy h:MM tt","m/d/yy HH:MM"];const TimeFormats=null&&["HH:MM","h:MM tt","HH:MM:ss","h:MM:ss tt"];class BaseSVGFactory{create(t,e,i=false){if(t<=0||e<=0){throw new Error("Invalid SVG dimensions")}const s=this._createSVG("svg:svg");s.setAttribute("version","1.1");if(!i){s.setAttribute("width",`${t}px`);s.setAttribute("height",`${e}px`)}s.setAttribute("preserveAspectRatio","none");s.setAttribute("viewBox",`0 0 ${t} ${e}`);return s}createElement(t){if(typeof t!=="string"){throw new Error("Invalid SVG element type")}return this._createSVG(t)}_createSVG(t){unreachable("Abstract method `_createSVG` called.")}}class DOMSVGFactory extends BaseSVGFactory{_createSVG(t){return document.createElementNS(SVG_NS,t)}}class XfaLayer{static setupStorage(t,e,i,s,n){const r=s.getValue(e,{value:null});switch(i.name){case"textarea":if(r.value!==null){t.textContent=r.value}if(n==="print"){break}t.addEventListener("input",t=>{s.setValue(e,{value:t.target.value})});break;case"input":if(i.attributes.type==="radio"||i.attributes.type==="checkbox"){if(r.value===i.attributes.xfaOn){t.setAttribute("checked",true)}else if(r.value===i.attributes.xfaOff){t.removeAttribute("checked")}if(n==="print"){break}t.addEventListener("change",t=>{s.setValue(e,{value:t.target.checked?t.target.getAttribute("xfaOn"):t.target.getAttribute("xfaOff")})})}else{if(r.value!==null){t.setAttribute("value",r.value)}if(n==="print"){break}t.addEventListener("input",t=>{s.setValue(e,{value:t.target.value})})}break;case"select":if(r.value!==null){t.setAttribute("value",r.value);for(const t of i.children){if(t.attributes.value===r.value){t.attributes.selected=true}else if(t.attributes.hasOwnProperty("selected")){delete t.attributes.selected}}}t.addEventListener("input",t=>{const i=t.target.options;const n=i.selectedIndex===-1?"":i[i.selectedIndex].value;s.setValue(e,{value:n})});break}}static setAttributes({html:t,element:e,storage:i=null,intent:s,linkService:n}){const{attributes:r}=e;const a=t instanceof HTMLAnchorElement;if(r.type==="radio"){r.name=`${r.name}-${s}`}for(const[e,i]of Object.entries(r)){if(i===null||i===undefined){continue}switch(e){case"class":if(i.length){t.setAttribute(e,i.join(" "))}break;case"dataId":break;case"id":t.setAttribute("data-element-id",i);break;case"style":Object.assign(t.style,i);break;case"textContent":t.textContent=i;break;default:if(!a||e!=="href"&&e!=="newWindow"){t.setAttribute(e,i)}}}if(a){n.addLinkAttributes(t,r.href,r.newWindow)}if(i&&r.dataId){this.setupStorage(t,r.dataId,e,i)}}static render(t){const e=t.annotationStorage;const i=t.linkService;const s=t.xfaHtml;const n=t.intent||"display";const r=document.createElement(s.name);if(s.attributes){this.setAttributes({html:r,element:s,intent:n,linkService:i})}const a=n!=="richText";const o=t.div;o.append(r);if(t.viewport){const e=`matrix(${t.viewport.transform.join(",")})`;o.style.transform=e}if(a){o.setAttribute("class","xfaLayer xfaFont")}const l=[];if(s.children.length===0){if(s.value){const t=document.createTextNode(s.value);r.append(t);if(a&&XfaText.shouldBuildText(s.name)){l.push(t)}}return{textDivs:l}}const h=[[s,-1,r]];while(h.length>0){const[t,s,r]=h.at(-1);if(s+1===t.children.length){h.pop();continue}const o=t.children[++h.at(-1)[1]];if(o===null){continue}const{name:c}=o;if(c==="#text"){const t=document.createTextNode(o.value);l.push(t);r.append(t);continue}const d=o?.attributes?.xmlns?document.createElementNS(o.attributes.xmlns,c):document.createElement(c);r.append(d);if(o.attributes){this.setAttributes({html:d,element:o,storage:e,intent:n,linkService:i})}if(o.children?.length>0){h.push([o,-1,d])}else if(o.value){const t=document.createTextNode(o.value);if(a&&XfaText.shouldBuildText(c)){l.push(t)}d.append(t)}}for(const t of o.querySelectorAll(".xfaNonInteractive input, .xfaNonInteractive textarea")){t.setAttribute("readOnly",true)}return{textDivs:l}}static update(t){const e=`matrix(${t.viewport.transform.join(",")})`;t.div.style.transform=e;t.div.hidden=false}}const annotation_layer_DEFAULT_FONT_SIZE=9;const GetElementsByNameSet=new WeakSet;const TIMEZONE_OFFSET=(new Date).getTimezoneOffset()*60*1e3;class AnnotationElementFactory{static create(t){const e=t.data.annotationType;switch(e){case AnnotationType.LINK:return new LinkAnnotationElement(t);case AnnotationType.TEXT:return new TextAnnotationElement(t);case AnnotationType.WIDGET:const e=t.data.fieldType;switch(e){case"Tx":return new TextWidgetAnnotationElement(t);case"Btn":if(t.data.radioButton){return new RadioButtonWidgetAnnotationElement(t)}else if(t.data.checkBox){return new CheckboxWidgetAnnotationElement(t)}return new PushButtonWidgetAnnotationElement(t);case"Ch":return new ChoiceWidgetAnnotationElement(t);case"Sig":return new SignatureWidgetAnnotationElement(t)}return new WidgetAnnotationElement(t);case AnnotationType.POPUP:return new PopupAnnotationElement(t);case AnnotationType.FREETEXT:return new FreeTextAnnotationElement(t);case AnnotationType.LINE:return new LineAnnotationElement(t);case AnnotationType.SQUARE:return new SquareAnnotationElement(t);case AnnotationType.CIRCLE:return new CircleAnnotationElement(t);case AnnotationType.POLYLINE:return new PolylineAnnotationElement(t);case AnnotationType.CARET:return new CaretAnnotationElement(t);case AnnotationType.INK:return new InkAnnotationElement(t);case AnnotationType.POLYGON:return new PolygonAnnotationElement(t);case AnnotationType.HIGHLIGHT:return new HighlightAnnotationElement(t);case AnnotationType.UNDERLINE:return new UnderlineAnnotationElement(t);case AnnotationType.SQUIGGLY:return new SquigglyAnnotationElement(t);case AnnotationType.STRIKEOUT:return new StrikeOutAnnotationElement(t);case AnnotationType.STAMP:return new StampAnnotationElement(t);case AnnotationType.FILEATTACHMENT:return new FileAttachmentAnnotationElement(t);default:return new AnnotationElement(t)}}}class AnnotationElement{#Gn=null;#zn=false;#Wn=null;constructor(t,{isRenderable:e=false,ignoreBorder:i=false,createQuadrilaterals:s=false}={}){this.isRenderable=e;this.data=t.data;this.layer=t.layer;this.linkService=t.linkService;this.downloadManager=t.downloadManager;this.imageResourcesPath=t.imageResourcesPath;this.renderForms=t.renderForms;this.svgFactory=t.svgFactory;this.annotationStorage=t.annotationStorage;this.enableComment=t.enableComment;this.enableScripting=t.enableScripting;this.hasJSActions=t.hasJSActions;this._fieldObjects=t.fieldObjects;this.parent=t.parent;if(e){this.container=this._createContainer(i)}if(s){this._createQuadrilaterals()}}static _hasPopupData({contentsObj:t,richText:e}){return!!(t?.str||e?.str)}get _isEditable(){return this.data.isEditable}get hasPopupData(){return AnnotationElement._hasPopupData(this.data)}get hasCommentButton(){return this.enableComment&&this._isEditable&&this.hasPopupElement}get commentButtonPosition(){const{quadPoints:t,rect:e}=this.data;let i=-Infinity;let s=-Infinity;if(t?.length>=8){for(let e=0;e<t.length;e+=8){if(t[e+1]>s){s=t[e+1];i=t[e+2]}else if(t[e+1]===s){i=Math.max(i,t[e+2])}}return[i,s]}if(e){return[e[2],e[3]]}return null}get commentButtonColor(){if(!this.data.color){return null}const[t,e,i]=this.data.color;const s=this.data.opacity??1;const n=255*(1-s);return this.#$n(Math.min(t+n,255),Math.min(e+n,255),Math.min(i+n,255))}#$n(t,e,i){t/=255;e/=255;i/=255;const s=Math.max(t,e,i);const n=Math.min(t,e,i);const r=(s+n)/2;const a=((1+Math.sqrt(r))/2*100).toFixed(2);if(s===n){return`hsl(0, 0%, ${a}%)`}const o=s-n;let l;if(s===t){l=(e-i)/o+(e<i?6:0)}else if(s===e){l=(i-t)/o+2}else{l=(t-e)/o+4}l=(l*60).toFixed(2);const h=(o/(1-Math.abs(2*r-1))*100).toFixed(2);return`hsl(${l}, ${h}%, ${a}%)`}_normalizePoint(t){const{page:{view:e},viewport:{rawDims:{pageWidth:i,pageHeight:s,pageX:n,pageY:r}}}=this.parent;t[1]=e[3]-t[1]+e[1];t[0]=100*(t[0]-n)/i;t[1]=100*(t[1]-r)/s;return t}updateEdited(t){if(!this.container){return}if(t.rect){this.#Gn||={rect:this.data.rect.slice(0)}}const{rect:e,popup:i}=t;if(e){this.#Vn(e)}let s=this.#Wn?.popup||this.popup;if(!s&&i?.text){this._createPopup(i);s=this.#Wn.popup}if(!s){return}s.updateEdited(t);if(i?.deleted){s.remove();this.#Wn=null;this.popup=null}}resetEdited(){if(!this.#Gn){return}this.#Vn(this.#Gn.rect);this.#Wn?.popup.resetEdited();this.#Gn=null}#Vn(t){const{container:{style:e},data:{rect:i,rotation:s},parent:{viewport:{rawDims:{pageWidth:n,pageHeight:r,pageX:a,pageY:o}}}}=this;i?.splice(0,4,...t);e.left=`${100*(t[0]-a)/n}%`;e.top=`${100*(r-t[3]+o)/r}%`;if(s===0){e.width=`${100*(t[2]-t[0])/n}%`;e.height=`${100*(t[3]-t[1])/r}%`}else{this.setRotation(s)}}_createContainer(t){const{data:e,parent:{page:i,viewport:s}}=this;const n=document.createElement("section");n.setAttribute("data-annotation-id",e.id);if(!(this instanceof WidgetAnnotationElement)&&!(this instanceof LinkAnnotationElement)){n.tabIndex=0}const{style:r}=n;r.zIndex=this.parent.zIndex;this.parent.zIndex+=2;if(e.alternativeText){n.title=e.alternativeText}if(e.noRotate){n.classList.add("norotate")}if(!e.rect||this instanceof PopupAnnotationElement){const{rotation:t}=e;if(!e.hasOwnCanvas&&t!==0){this.setRotation(t,n)}return n}const{width:a,height:o}=this;if(!t&&e.borderStyle.width>0){r.borderWidth=`${e.borderStyle.width}px`;const t=e.borderStyle.horizontalCornerRadius;const i=e.borderStyle.verticalCornerRadius;if(t>0||i>0){const e=`calc(${t}px * var(--total-scale-factor)) / calc(${i}px * var(--total-scale-factor))`;r.borderRadius=e}else if(this instanceof RadioButtonWidgetAnnotationElement){const t=`calc(${a}px * var(--total-scale-factor)) / calc(${o}px * var(--total-scale-factor))`;r.borderRadius=t}switch(e.borderStyle.style){case AnnotationBorderStyleType.SOLID:r.borderStyle="solid";break;case AnnotationBorderStyleType.DASHED:r.borderStyle="dashed";break;case AnnotationBorderStyleType.BEVELED:warn("Unimplemented border style: beveled");break;case AnnotationBorderStyleType.INSET:warn("Unimplemented border style: inset");break;case AnnotationBorderStyleType.UNDERLINE:r.borderBottomStyle="solid";break;default:break}const s=e.borderColor||null;if(s){this.#zn=true;r.borderColor=Util.makeHexColor(s[0]|0,s[1]|0,s[2]|0)}else{r.borderWidth=0}}const l=Util.normalizeRect([e.rect[0],i.view[3]-e.rect[1]+i.view[1],e.rect[2],i.view[3]-e.rect[3]+i.view[1]]);const{pageWidth:h,pageHeight:c,pageX:d,pageY:u}=s.rawDims;r.left=`${100*(l[0]-d)/h}%`;r.top=`${100*(l[1]-u)/c}%`;const{rotation:p}=e;if(e.hasOwnCanvas||p===0){r.width=`${100*a/h}%`;r.height=`${100*o/c}%`}else{this.setRotation(p,n)}return n}setRotation(t,e=this.container){if(!this.data.rect){return}const{pageWidth:i,pageHeight:s}=this.parent.viewport.rawDims;let{width:n,height:r}=this;if(t%180!==0){[n,r]=[r,n]}e.style.width=`${100*n/i}%`;e.style.height=`${100*r/s}%`;e.setAttribute("data-main-rotation",(360-t)%360)}get _commonActions(){const t=(t,e,i)=>{const s=i.detail[t];const n=s[0];const r=s.slice(1);i.target.style[e]=ColorConverters[`${n}_HTML`](r);this.annotationStorage.setValue(this.data.id,{[e]:ColorConverters[`${n}_rgb`](r)})};return shadow(this,"_commonActions",{display:t=>{const{display:e}=t.detail;const i=e%2===1;this.container.style.visibility=i?"hidden":"visible";this.annotationStorage.setValue(this.data.id,{noView:i,noPrint:e===1||e===2})},print:t=>{this.annotationStorage.setValue(this.data.id,{noPrint:!t.detail.print})},hidden:t=>{const{hidden:e}=t.detail;this.container.style.visibility=e?"hidden":"visible";this.annotationStorage.setValue(this.data.id,{noPrint:e,noView:e})},focus:t=>{setTimeout(()=>t.target.focus({preventScroll:false}),0)},userName:t=>{t.target.title=t.detail.userName},readonly:t=>{t.target.disabled=t.detail.readonly},required:t=>{this._setRequired(t.target,t.detail.required)},bgColor:e=>{t("bgColor","backgroundColor",e)},fillColor:e=>{t("fillColor","backgroundColor",e)},fgColor:e=>{t("fgColor","color",e)},textColor:e=>{t("textColor","color",e)},borderColor:e=>{t("borderColor","borderColor",e)},strokeColor:e=>{t("strokeColor","borderColor",e)},rotation:t=>{const e=t.detail.rotation;this.setRotation(e);this.annotationStorage.setValue(this.data.id,{rotation:e})}})}_dispatchEventFromSandbox(t,e){const i=this._commonActions;for(const s of Object.keys(e.detail)){const n=t[s]||i[s];n?.(e)}}_setDefaultPropertiesFromJS(t){if(!this.enableScripting){return}const e=this.annotationStorage.getRawValue(this.data.id);if(!e){return}const i=this._commonActions;for(const[s,n]of Object.entries(e)){const r=i[s];if(r){const i={detail:{[s]:n},target:t};r(i);delete e[s]}}}_createQuadrilaterals(){if(!this.container){return}const{quadPoints:t}=this.data;if(!t){return}const[e,i,s,n]=this.data.rect.map(t=>Math.fround(t));if(t.length===8){const[r,a,o,l]=t.subarray(2,6);if(s===r&&n===a&&e===o&&i===l){return}}const{style:r}=this.container;let a;if(this.#zn){const{borderColor:t,borderWidth:e}=r;r.borderWidth=0;a=["url('data:image/svg+xml;utf8,",`<svg xmlns="http://www.w3.org/2000/svg"`,` preserveAspectRatio="none" viewBox="0 0 1 1">`,`<g fill="transparent" stroke="${t}" stroke-width="${e}">`];this.container.classList.add("hasBorder")}const o=s-e;const l=n-i;const{svgFactory:h}=this;const c=h.createElement("svg");c.classList.add("quadrilateralsContainer");c.setAttribute("width",0);c.setAttribute("height",0);c.role="none";const d=h.createElement("defs");c.append(d);const u=h.createElement("clipPath");const p=`clippath_${this.data.id}`;u.setAttribute("id",p);u.setAttribute("clipPathUnits","objectBoundingBox");d.append(u);for(let i=2,s=t.length;i<s;i+=8){const s=t[i];const r=t[i+1];const c=t[i+2];const d=t[i+3];const p=h.createElement("rect");const g=(c-e)/o;const f=(n-r)/l;const m=(s-c)/o;const b=(r-d)/l;p.setAttribute("x",g);p.setAttribute("y",f);p.setAttribute("width",m);p.setAttribute("height",b);u.append(p);a?.push(`<rect vector-effect="non-scaling-stroke" x="${g}" y="${f}" width="${m}" height="${b}"/>`)}if(this.#zn){a.push(`</g></svg>')`);r.backgroundImage=a.join("")}this.container.append(c);this.container.style.clipPath=`url(#${p})`}_createPopup(t=null){const{data:e}=this;let i,s;if(t){i={str:t.text};s=t.date}else{i=e.contentsObj;s=e.modificationDate}const n=this.#Wn=new PopupAnnotationElement({data:{color:e.color,titleObj:e.titleObj,modificationDate:s,contentsObj:i,richText:e.richText,parentRect:e.rect,borderStyle:0,id:`popup_${e.id}`,rotation:e.rotation,noRotate:true},linkService:this.linkService,parent:this.parent,elements:[this]});this.parent.div.append(n.render())}get hasPopupElement(){return!!(this.#Wn||this.popup||this.data.popupRef)}render(){unreachable("Abstract method `AnnotationElement.render` called")}_getElementsByName(t,e=null){const i=[];if(this._fieldObjects){const s=this._fieldObjects[t];if(s){for(const{page:t,id:n,exportValues:r}of s){if(t===-1){continue}if(n===e){continue}const s=typeof r==="string"?r:null;const a=document.querySelector(`[data-element-id="${n}"]`);if(a&&!GetElementsByNameSet.has(a)){warn(`_getElementsByName - element not allowed: ${n}`);continue}i.push({id:n,exportValue:s,domElement:a})}}return i}for(const s of document.getElementsByName(t)){const{exportValue:t}=s;const n=s.getAttribute("data-element-id");if(n===e){continue}if(!GetElementsByNameSet.has(s)){continue}i.push({id:n,exportValue:t,domElement:s})}return i}show(){if(this.container){this.container.hidden=false}this.popup?.maybeShow()}hide(){if(this.container){this.container.hidden=true}this.popup?.forceHide()}getElementsToTriggerPopup(){return this.container}addHighlightArea(){const t=this.getElementsToTriggerPopup();if(Array.isArray(t)){for(const e of t){e.classList.add("highlightArea")}}else{t.classList.add("highlightArea")}}_editOnDoubleClick(){if(!this._isEditable){return}const{annotationEditorType:t,data:{id:e}}=this;this.container.addEventListener("dblclick",()=>{this.linkService.eventBus?.dispatch("switchannotationeditormode",{source:this,mode:t,editId:e,mustEnterInEditMode:true})})}get width(){return this.data.rect[2]-this.data.rect[0]}get height(){return this.data.rect[3]-this.data.rect[1]}}class LinkAnnotationElement extends AnnotationElement{constructor(t,e=null){super(t,{isRenderable:true,ignoreBorder:!!e?.ignoreBorder,createQuadrilaterals:true});this.isTooltipOnly=t.data.isTooltipOnly}render(){const{data:t,linkService:e}=this;const i=document.createElement("a");i.setAttribute("data-element-id",t.id);let s=false;if(t.url){e.addLinkAttributes(i,t.url,t.newWindow);s=true}else if(t.action){this._bindNamedAction(i,t.action,t.overlaidText);s=true}else if(t.attachment){this.#jn(i,t.attachment,t.overlaidText,t.attachmentDest);s=true}else if(t.setOCGState){this.#Kn(i,t.setOCGState,t.overlaidText);s=true}else if(t.dest){this._bindLink(i,t.dest,t.overlaidText);s=true}else{if(t.actions&&(t.actions.Action||t.actions["Mouse Up"]||t.actions["Mouse Down"])&&this.enableScripting&&this.hasJSActions){this._bindJSAction(i,t);s=true}if(t.resetForm){this._bindResetFormAction(i,t.resetForm);s=true}else if(this.isTooltipOnly&&!s){this._bindLink(i,"");s=true}}this.container.classList.add("linkAnnotation");if(s){this.container.append(i)}return this.container}#Xn(){this.container.setAttribute("data-internal-link","")}_bindLink(t,e,i=""){t.href=this.linkService.getDestinationHash(e);t.onclick=()=>{if(e){this.linkService.goToDestination(e)}return false};if(e||e===""){this.#Xn()}if(i){t.title=i}}_bindNamedAction(t,e,i=""){t.href=this.linkService.getAnchorUrl("");t.onclick=()=>{this.linkService.executeNamedAction(e);return false};if(i){t.title=i}this.#Xn()}#jn(t,e,i="",s=null){t.href=this.linkService.getAnchorUrl("");if(e.description){t.title=e.description}else if(i){t.title=i}t.onclick=()=>{this.downloadManager?.openOrDownloadData(e.content,e.filename,s);return false};this.#Xn()}#Kn(t,e,i=""){t.href=this.linkService.getAnchorUrl("");t.onclick=()=>{this.linkService.executeSetOCGState(e);return false};if(i){t.title=i}this.#Xn()}_bindJSAction(t,e){t.href=this.linkService.getAnchorUrl("");const i=new Map([["Action","onclick"],["Mouse Up","onmouseup"],["Mouse Down","onmousedown"]]);for(const s of Object.keys(e.actions)){const n=i.get(s);if(!n){continue}t[n]=()=>{this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e.id,name:s}});return false}}if(e.overlaidText){t.title=e.overlaidText}if(!t.onclick){t.onclick=()=>false}this.#Xn()}_bindResetFormAction(t,e){const i=t.onclick;if(!i){t.href=this.linkService.getAnchorUrl("")}this.#Xn();if(!this._fieldObjects){warn(`_bindResetFormAction - "resetForm" action not supported, `+"ensure that the `fieldObjects` parameter is provided.");if(!i){t.onclick=()=>false}return}t.onclick=()=>{i?.();const{fields:t,refs:s,include:n}=e;const r=[];if(t.length!==0||s.length!==0){const e=new Set(s);for(const i of t){const t=this._fieldObjects[i]||[];for(const{id:i}of t){e.add(i)}}for(const t of Object.values(this._fieldObjects)){for(const i of t){if(e.has(i.id)===n){r.push(i)}}}}else{for(const t of Object.values(this._fieldObjects)){r.push(...t)}}const a=this.annotationStorage;const o=[];for(const t of r){const{id:e}=t;o.push(e);switch(t.type){case"text":{const i=t.defaultValue||"";a.setValue(e,{value:i});break}case"checkbox":case"radiobutton":{const i=t.defaultValue===t.exportValues;a.setValue(e,{value:i});break}case"combobox":case"listbox":{const i=t.defaultValue||"";a.setValue(e,{value:i});break}default:continue}const i=document.querySelector(`[data-element-id="${e}"]`);if(!i){continue}else if(!GetElementsByNameSet.has(i)){warn(`_bindResetFormAction - element not allowed: ${e}`);continue}i.dispatchEvent(new Event("resetform"))}if(this.enableScripting){this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:"app",ids:o,name:"ResetForm"}})}return false}}}class TextAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:true})}render(){this.container.classList.add("textAnnotation");const t=document.createElement("img");t.src=this.imageResourcesPath+"annotation-"+this.data.name.toLowerCase()+".svg";t.setAttribute("data-l10n-id","pdfjs-text-annotation-type");t.setAttribute("data-l10n-args",JSON.stringify({type:this.data.name}));if(!this.data.popupRef&&this.hasPopupData){this._createPopup()}this.container.append(t);return this.container}}class WidgetAnnotationElement extends AnnotationElement{render(){return this.container}showElementAndHideCanvas(t){if(this.data.hasOwnCanvas){if(t.previousSibling?.nodeName==="CANVAS"){t.previousSibling.hidden=true}t.hidden=false}}_getKeyModifier(t){return util_FeatureTest.platform.isMac?t.metaKey:t.ctrlKey}_setEventListener(t,e,i,s,n){if(i.includes("mouse")){t.addEventListener(i,t=>{this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:s,value:n(t),shift:t.shiftKey,modifier:this._getKeyModifier(t)}})})}else{t.addEventListener(i,t=>{if(i==="blur"){if(!e.focused||!t.relatedTarget){return}e.focused=false}else if(i==="focus"){if(e.focused){return}e.focused=true}if(!n){return}this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:s,value:n(t)}})})}}_setEventListeners(t,e,i,s){for(const[n,r]of i){if(r==="Action"||this.data.actions?.[r]){if(r==="Focus"||r==="Blur"){e||={focused:false}}this._setEventListener(t,e,n,r,s);if(r==="Focus"&&!this.data.actions?.Blur){this._setEventListener(t,e,"blur","Blur",null)}else if(r==="Blur"&&!this.data.actions?.Focus){this._setEventListener(t,e,"focus","Focus",null)}}}}_setBackgroundColor(t){const e=this.data.backgroundColor||null;t.style.backgroundColor=e===null?"transparent":Util.makeHexColor(e[0],e[1],e[2])}_setTextStyle(t){const e=["left","center","right"];const{fontColor:i}=this.data.defaultAppearanceData;const s=this.data.defaultAppearanceData.fontSize||annotation_layer_DEFAULT_FONT_SIZE;const n=t.style;let r;const a=2;const o=t=>Math.round(10*t)/10;if(this.data.multiLine){const t=Math.abs(this.data.rect[3]-this.data.rect[1]-a);const e=Math.round(t/(LINE_FACTOR*s))||1;const i=t/e;r=Math.min(s,o(i/LINE_FACTOR))}else{const t=Math.abs(this.data.rect[3]-this.data.rect[1]-a);r=Math.min(s,o(t/LINE_FACTOR))}n.fontSize=`calc(${r}px * var(--total-scale-factor))`;n.color=Util.makeHexColor(i[0],i[1],i[2]);if(this.data.textAlignment!==null){n.textAlign=e[this.data.textAlignment]}}_setRequired(t,e){if(e){t.setAttribute("required",true)}else{t.removeAttribute("required")}t.setAttribute("aria-required",e)}}class TextWidgetAnnotationElement extends WidgetAnnotationElement{constructor(t){const e=t.renderForms||t.data.hasOwnCanvas||!t.data.hasAppearance&&!!t.data.fieldValue;super(t,{isRenderable:e})}setPropertyOnSiblings(t,e,i,s){const n=this.annotationStorage;for(const r of this._getElementsByName(t.name,t.id)){if(r.domElement){r.domElement[e]=i}n.setValue(r.id,{[s]:i})}}render(){const t=this.annotationStorage;const e=this.data.id;this.container.classList.add("textWidgetAnnotation");let i=null;if(this.renderForms){const s=t.getValue(e,{value:this.data.fieldValue});let n=s.value||"";const r=t.getValue(e,{charLimit:this.data.maxLen}).charLimit;if(r&&n.length>r){n=n.slice(0,r)}let a=s.formattedValue||this.data.textContent?.join("\n")||null;if(a&&this.data.comb){a=a.replaceAll(/\s+/g,"")}const o={userValue:n,formattedValue:a,lastCommittedValue:null,commitKey:1,focused:false};if(this.data.multiLine){i=document.createElement("textarea");i.textContent=a??n;if(this.data.doNotScroll){i.style.overflowY="hidden"}}else{i=document.createElement("input");i.type=this.data.password?"password":"text";i.setAttribute("value",a??n);if(this.data.doNotScroll){i.style.overflowX="hidden"}}if(this.data.hasOwnCanvas){i.hidden=true}GetElementsByNameSet.add(i);i.setAttribute("data-element-id",e);i.disabled=this.data.readOnly;i.name=this.data.fieldName;i.tabIndex=0;const{datetimeFormat:l,datetimeType:h,timeStep:c}=this.data;const d=!!h&&this.enableScripting;if(l){i.title=l}this._setRequired(i,this.data.required);if(r){i.maxLength=r}i.addEventListener("input",s=>{t.setValue(e,{value:s.target.value});this.setPropertyOnSiblings(i,"value",s.target.value,"value");o.formattedValue=null});i.addEventListener("resetform",t=>{const e=this.data.defaultFieldValue??"";i.value=o.userValue=e;o.formattedValue=null});let u=t=>{const{formattedValue:e}=o;if(e!==null&&e!==undefined){t.target.value=e}t.target.scrollLeft=0};if(this.enableScripting&&this.hasJSActions){i.addEventListener("focus",t=>{if(o.focused){return}const{target:e}=t;if(d){e.type=h;if(c){e.step=c}}if(o.userValue){const t=o.userValue;if(d){if(h==="time"){const i=new Date(t);const s=[i.getHours(),i.getMinutes(),i.getSeconds()];e.value=s.map(t=>t.toString().padStart(2,"0")).join(":")}else{e.value=new Date(t-TIMEZONE_OFFSET).toISOString().split(h==="date"?"T":".",1)[0]}}else{e.value=t}}o.lastCommittedValue=e.value;o.commitKey=1;if(!this.data.actions?.Focus){o.focused=true}});i.addEventListener("updatefromsandbox",i=>{this.showElementAndHideCanvas(i.target);const s={value(i){o.userValue=i.detail.value??"";if(!d){t.setValue(e,{value:o.userValue.toString()})}i.target.value=o.userValue},formattedValue(i){const{formattedValue:s}=i.detail;o.formattedValue=s;if(s!==null&&s!==undefined&&i.target!==document.activeElement){i.target.value=s}const n={formattedValue:s};if(d){n.value=s}t.setValue(e,n)},selRange(t){t.target.setSelectionRange(...t.detail.selRange)},charLimit:i=>{const{charLimit:s}=i.detail;const{target:n}=i;if(s===0){n.removeAttribute("maxLength");return}n.setAttribute("maxLength",s);let r=o.userValue;if(!r||r.length<=s){return}r=r.slice(0,s);n.value=o.userValue=r;t.setValue(e,{value:r});this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:r,willCommit:true,commitKey:1,selStart:n.selectionStart,selEnd:n.selectionEnd}})}};this._dispatchEventFromSandbox(s,i)});i.addEventListener("keydown",t=>{o.commitKey=1;let i=-1;if(t.key==="Escape"){i=0}else if(t.key==="Enter"&&!this.data.multiLine){i=2}else if(t.key==="Tab"){o.commitKey=3}if(i===-1){return}const{value:s}=t.target;if(o.lastCommittedValue===s){return}o.lastCommittedValue=s;o.userValue=s;this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:s,willCommit:true,commitKey:i,selStart:t.target.selectionStart,selEnd:t.target.selectionEnd}})});const s=u;u=null;i.addEventListener("blur",t=>{if(!o.focused||!t.relatedTarget){return}if(!this.data.actions?.Blur){o.focused=false}const{target:i}=t;let{value:n}=i;if(d){if(n&&h==="time"){const t=n.split(":").map(t=>parseInt(t,10));n=new Date(2e3,0,1,t[0],t[1],t[2]||0).valueOf();i.step=""}else{n=new Date(n).valueOf()}i.type="text"}o.userValue=n;if(o.lastCommittedValue!==n){this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:n,willCommit:true,commitKey:o.commitKey,selStart:t.target.selectionStart,selEnd:t.target.selectionEnd}})}s(t)});if(this.data.actions?.Keystroke){i.addEventListener("beforeinput",t=>{o.lastCommittedValue=null;const{data:i,target:s}=t;const{value:n,selectionStart:r,selectionEnd:a}=s;let l=r,h=a;switch(t.inputType){case"deleteWordBackward":{const t=n.substring(0,r).match(/\w*[^\w]*$/);if(t){l-=t[0].length}break}case"deleteWordForward":{const t=n.substring(r).match(/^[^\w]*\w*/);if(t){h+=t[0].length}break}case"deleteContentBackward":if(r===a){l-=1}break;case"deleteContentForward":if(r===a){h+=1}break}t.preventDefault();this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:n,change:i||"",willCommit:false,selStart:l,selEnd:h}})})}this._setEventListeners(i,o,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],t=>t.target.value)}if(u){i.addEventListener("blur",u)}if(this.data.comb){const t=this.data.rect[2]-this.data.rect[0];const e=t/r;i.classList.add("comb");i.style.letterSpacing=`calc(${e}px * var(--total-scale-factor) - 1ch)`}}else{i=document.createElement("div");i.textContent=this.data.fieldValue;i.style.verticalAlign="middle";i.style.display="table-cell";if(this.data.hasOwnCanvas){i.hidden=true}}this._setTextStyle(i);this._setBackgroundColor(i);this._setDefaultPropertiesFromJS(i);this.container.append(i);return this.container}}class SignatureWidgetAnnotationElement extends WidgetAnnotationElement{constructor(t){super(t,{isRenderable:!!t.data.hasOwnCanvas})}}class CheckboxWidgetAnnotationElement extends WidgetAnnotationElement{constructor(t){super(t,{isRenderable:t.renderForms})}render(){const t=this.annotationStorage;const e=this.data;const i=e.id;let s=t.getValue(i,{value:e.exportValue===e.fieldValue}).value;if(typeof s==="string"){s=s!=="Off";t.setValue(i,{value:s})}this.container.classList.add("buttonWidgetAnnotation","checkBox");const n=document.createElement("input");GetElementsByNameSet.add(n);n.setAttribute("data-element-id",i);n.disabled=e.readOnly;this._setRequired(n,this.data.required);n.type="checkbox";n.name=e.fieldName;if(s){n.setAttribute("checked",true)}n.setAttribute("exportValue",e.exportValue);n.tabIndex=0;n.addEventListener("change",s=>{const{name:n,checked:r}=s.target;for(const s of this._getElementsByName(n,i)){const i=r&&s.exportValue===e.exportValue;if(s.domElement){s.domElement.checked=i}t.setValue(s.id,{value:i})}t.setValue(i,{value:r})});n.addEventListener("resetform",t=>{const i=e.defaultFieldValue||"Off";t.target.checked=i===e.exportValue});if(this.enableScripting&&this.hasJSActions){n.addEventListener("updatefromsandbox",e=>{const s={value(e){e.target.checked=e.detail.value!=="Off";t.setValue(i,{value:e.target.checked})}};this._dispatchEventFromSandbox(s,e)});this._setEventListeners(n,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],t=>t.target.checked)}this._setBackgroundColor(n);this._setDefaultPropertiesFromJS(n);this.container.append(n);return this.container}}class RadioButtonWidgetAnnotationElement extends WidgetAnnotationElement{constructor(t){super(t,{isRenderable:t.renderForms})}render(){this.container.classList.add("buttonWidgetAnnotation","radioButton");const t=this.annotationStorage;const e=this.data;const i=e.id;let s=t.getValue(i,{value:e.fieldValue===e.buttonValue}).value;if(typeof s==="string"){s=s!==e.buttonValue;t.setValue(i,{value:s})}if(s){for(const s of this._getElementsByName(e.fieldName,i)){t.setValue(s.id,{value:false})}}const n=document.createElement("input");GetElementsByNameSet.add(n);n.setAttribute("data-element-id",i);n.disabled=e.readOnly;this._setRequired(n,this.data.required);n.type="radio";n.name=e.fieldName;if(s){n.setAttribute("checked",true)}n.tabIndex=0;n.addEventListener("change",e=>{const{name:s,checked:n}=e.target;for(const e of this._getElementsByName(s,i)){t.setValue(e.id,{value:false})}t.setValue(i,{value:n})});n.addEventListener("resetform",t=>{const i=e.defaultFieldValue;t.target.checked=i!==null&&i!==undefined&&i===e.buttonValue});if(this.enableScripting&&this.hasJSActions){const s=e.buttonValue;n.addEventListener("updatefromsandbox",e=>{const n={value:e=>{const n=s===e.detail.value;for(const s of this._getElementsByName(e.target.name)){const e=n&&s.id===i;if(s.domElement){s.domElement.checked=e}t.setValue(s.id,{value:e})}}};this._dispatchEventFromSandbox(n,e)});this._setEventListeners(n,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],t=>t.target.checked)}this._setBackgroundColor(n);this._setDefaultPropertiesFromJS(n);this.container.append(n);return this.container}}class PushButtonWidgetAnnotationElement extends LinkAnnotationElement{constructor(t){super(t,{ignoreBorder:t.data.hasAppearance})}render(){const t=super.render();t.classList.add("buttonWidgetAnnotation","pushButton");const e=t.lastChild;if(this.enableScripting&&this.hasJSActions&&e){this._setDefaultPropertiesFromJS(e);e.addEventListener("updatefromsandbox",t=>{this._dispatchEventFromSandbox({},t)})}return t}}class ChoiceWidgetAnnotationElement extends WidgetAnnotationElement{constructor(t){super(t,{isRenderable:t.renderForms})}render(){this.container.classList.add("choiceWidgetAnnotation");const t=this.annotationStorage;const e=this.data.id;const i=t.getValue(e,{value:this.data.fieldValue});const s=document.createElement("select");GetElementsByNameSet.add(s);s.setAttribute("data-element-id",e);s.disabled=this.data.readOnly;this._setRequired(s,this.data.required);s.name=this.data.fieldName;s.tabIndex=0;let n=this.data.combo&&this.data.options.length>0;if(!this.data.combo){s.size=this.data.options.length;if(this.data.multiSelect){s.multiple=true}}s.addEventListener("resetform",t=>{const e=this.data.defaultFieldValue;for(const t of s.options){t.selected=t.value===e}});for(const t of this.data.options){const e=document.createElement("option");e.textContent=t.displayValue;e.value=t.exportValue;if(i.value.includes(t.exportValue)){e.setAttribute("selected",true);n=false}s.append(e)}let r=null;if(n){const t=document.createElement("option");t.value=" ";t.setAttribute("hidden",true);t.setAttribute("selected",true);s.prepend(t);r=()=>{t.remove();s.removeEventListener("input",r);r=null};s.addEventListener("input",r)}const a=t=>{const e=t?"value":"textContent";const{options:i,multiple:n}=s;if(!n){return i.selectedIndex===-1?null:i[i.selectedIndex][e]}return Array.prototype.filter.call(i,t=>t.selected).map(t=>t[e])};let o=a(false);const l=t=>{const e=t.target.options;return Array.prototype.map.call(e,t=>({displayValue:t.textContent,exportValue:t.value}))};if(this.enableScripting&&this.hasJSActions){s.addEventListener("updatefromsandbox",i=>{const n={value(i){r?.();const n=i.detail.value;const l=new Set(Array.isArray(n)?n:[n]);for(const t of s.options){t.selected=l.has(t.value)}t.setValue(e,{value:a(true)});o=a(false)},multipleSelection(t){s.multiple=true},remove(i){const n=s.options;const r=i.detail.remove;n[r].selected=false;s.remove(r);if(n.length>0){const t=Array.prototype.findIndex.call(n,t=>t.selected);if(t===-1){n[0].selected=true}}t.setValue(e,{value:a(true),items:l(i)});o=a(false)},clear(i){while(s.length!==0){s.remove(0)}t.setValue(e,{value:null,items:[]});o=a(false)},insert(i){const{index:n,displayValue:r,exportValue:h}=i.detail.insert;const c=s.children[n];const d=document.createElement("option");d.textContent=r;d.value=h;if(c){c.before(d)}else{s.append(d)}t.setValue(e,{value:a(true),items:l(i)});o=a(false)},items(i){const{items:n}=i.detail;while(s.length!==0){s.remove(0)}for(const t of n){const{displayValue:e,exportValue:i}=t;const n=document.createElement("option");n.textContent=e;n.value=i;s.append(n)}if(s.options.length>0){s.options[0].selected=true}t.setValue(e,{value:a(true),items:l(i)});o=a(false)},indices(i){const s=new Set(i.detail.indices);for(const t of i.target.options){t.selected=s.has(t.index)}t.setValue(e,{value:a(true)});o=a(false)},editable(t){t.target.disabled=!t.detail.editable}};this._dispatchEventFromSandbox(n,i)});s.addEventListener("input",i=>{const s=a(true);const n=a(false);t.setValue(e,{value:s});i.preventDefault();this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:o,change:n,changeEx:s,willCommit:false,commitKey:1,keyDown:false}})});this._setEventListeners(s,null,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"],["input","Action"],["input","Validate"]],t=>t.target.value)}else{s.addEventListener("input",function(i){t.setValue(e,{value:a(true)})})}if(this.data.combo){this._setTextStyle(s)}else{}this._setBackgroundColor(s);this._setDefaultPropertiesFromJS(s);this.container.append(s);return this.container}}class PopupAnnotationElement extends AnnotationElement{constructor(t){const{data:e,elements:i}=t;super(t,{isRenderable:AnnotationElement._hasPopupData(e)});this.elements=i;this.popup=null}render(){const{container:t}=this;t.classList.add("popupAnnotation");t.role="comment";const e=this.popup=new PopupElement({container:this.container,color:this.data.color,titleObj:this.data.titleObj,modificationDate:this.data.modificationDate||this.data.creationDate,contentsObj:this.data.contentsObj,richText:this.data.richText,rect:this.data.rect,parentRect:this.data.parentRect||null,parent:this.parent,elements:this.elements,open:this.data.open,eventBus:this.linkService.eventBus});const i=[];for(const t of this.elements){t.popup=e;t.container.ariaHasPopup="dialog";i.push(t.data.id);t.addHighlightArea()}this.container.setAttribute("aria-controls",i.map(t=>`${AnnotationPrefix}${t}`).join(","));return this.container}}class PopupElement{#qn=this.#On.bind(this);#Yn=this.#Jn.bind(this);#Qn=this.#Zn.bind(this);#tr=this.#er.bind(this);#ir=null;#wt=null;#sr=null;#nr=null;#rr=null;#kn=null;#ar=null;#or=null;#lr=false;#hr=null;#cr=null;#C=null;#ne=null;#dr=null;#ur=null;#pr=null;#gr=null;#fr=null;#Gn=null;#mr=false;constructor({container:t,color:e,elements:i,titleObj:s,modificationDate:n,contentsObj:r,richText:a,parent:o,rect:l,parentRect:h,open:c,eventBus:d=null}){this.#wt=t;this.#fr=s;this.#sr=r;this.#gr=a;this.#ar=o;this.#ir=e;this.#pr=l;this.#or=h;this.#rr=i;this.#kn=d;this.#nr=PDFDateString.toDateObject(n);this.trigger=i.flatMap(t=>t.getElementsToTriggerPopup());this.#br();this.#wt.hidden=true;if(c){this.#er()}}#br(){if(this.#cr){return}this.#cr=new AbortController;const{signal:t}=this.#cr;for(const e of this.trigger){e.addEventListener("click",this.#tr,{signal:t});e.addEventListener("mouseenter",this.#Qn,{signal:t});e.addEventListener("mouseleave",this.#Yn,{signal:t});e.classList.add("popupTriggerArea")}for(const e of this.#rr){e.container?.addEventListener("keydown",this.#qn,{signal:t})}this.#Ar()}#yr(){const t=this.#rr.find(t=>t.hasCommentButton);if(!t){return}this.#dr=t._normalizePoint(t.commentButtonPosition);this.#ur=t.commentButtonColor}#Ar(){if(this.#ne){return}if(!this.#dr){this.#yr()}if(!this.#dr){return}const t=this.#ne=document.createElement("button");t.className="annotationCommentButton";const e=this.#rr[0].container;t.style.zIndex=e.style.zIndex+1;t.tabIndex=0;const{signal:i}=this.#cr;t.addEventListener("hover",this.#tr,{signal:i});t.addEventListener("keydown",this.#qn,{signal:i});t.addEventListener("click",()=>{const[{data:{id:t},annotationEditorType:e}]=this.#rr;this.#kn?.dispatch("switchannotationeditormode",{source:this,editId:t,mode:e,editComment:true})},{signal:i});const{style:s}=t;s.left=`calc(${this.#dr[0]}%)`;s.top=`calc(${this.#dr[1]}% - var(--comment-button-dim))`;if(this.#ur){s.backgroundColor=this.#ur}e.after(t)}render(){if(this.#hr){return}const t=this.#hr=document.createElement("div");t.className="popup";if(this.#ir){const e=t.style.outlineColor=Util.makeHexColor(...this.#ir);t.style.backgroundColor=`color-mix(in srgb, ${e} 30%, white)`}const e=document.createElement("span");e.className="header";if(this.#fr?.str){const t=document.createElement("span");t.className="title";e.append(t);({dir:t.dir,str:t.textContent}=this.#fr)}t.append(e);if(this.#nr){const t=document.createElement("time");t.className="popupDate";t.setAttribute("data-l10n-id","pdfjs-annotation-date-time-string");t.setAttribute("data-l10n-args",JSON.stringify({dateObj:this.#nr.valueOf()}));t.dateTime=this.#nr.toISOString();e.append(t)}const i=this.#wr;if(i){XfaLayer.render({xfaHtml:i,intent:"richText",div:t});t.lastChild.classList.add("richText","popupContent")}else{const e=this._formatContents(this.#sr);t.append(e)}this.#wt.append(t)}get#wr(){const t=this.#gr;const e=this.#sr;if(t?.str&&(!e?.str||e.str===t.str)){return this.#gr.html||null}return null}get#Er(){return this.#wr?.attributes?.style?.fontSize||0}get#vr(){return this.#wr?.attributes?.style?.color||null}#xr(t){const e=[];const i={str:t,html:{name:"div",attributes:{dir:"auto"},children:[{name:"p",children:e}]}};const s={style:{color:this.#vr,fontSize:this.#Er?`calc(${this.#Er}px * var(--total-scale-factor))`:""}};for(const i of t.split("\n")){e.push({name:"span",value:i,attributes:s})}return i}_formatContents({str:t,dir:e}){const i=document.createElement("p");i.classList.add("popupContent");i.dir=e;const s=t.split(/(?:\r\n?|\n)/);for(let t=0,e=s.length;t<e;++t){const n=s[t];i.append(document.createTextNode(n));if(t<e-1){i.append(document.createElement("br"))}}return i}#On(t){if(t.altKey||t.shiftKey||t.ctrlKey||t.metaKey){return}if(t.key==="Enter"||t.key==="Escape"&&this.#lr){this.#er()}}updateEdited({rect:t,popup:e,deleted:i}){if(i||e?.deleted){this.remove();return}this.#br();this.#Gn||={contentsObj:this.#sr,richText:this.#gr};if(t){this.#C=null}if(e){this.#gr=this.#xr(e.text);this.#nr=PDFDateString.toDateObject(e.date);this.#sr=null}this.#hr?.remove();this.#hr=null}resetEdited(){if(!this.#Gn){return}({contentsObj:this.#sr,richText:this.#gr}=this.#Gn);this.#Gn=null;this.#hr?.remove();this.#hr=null;this.#C=null}remove(){this.#cr?.abort();this.#cr=null;this.#hr?.remove();this.#hr=null;this.#mr=false;this.#lr=false;for(const t of this.trigger){t.classList.remove("popupTriggerArea")}}#_r(){if(this.#C!==null){return}const{page:{view:t},viewport:{rawDims:{pageWidth:e,pageHeight:i,pageX:s,pageY:n}}}=this.#ar;let r=!!this.#or;let a=r?this.#or:this.#pr;for(const t of this.#rr){if(!a||Util.intersect(t.data.rect,a)!==null){a=t.data.rect;r=true;break}}const o=Util.normalizeRect([a[0],t[3]-a[1]+t[1],a[2],t[3]-a[3]+t[1]]);const l=5;const h=r?a[2]-a[0]+l:0;const c=o[0]+h;const d=o[1];this.#C=[100*(c-s)/e,100*(d-n)/i];const{style:u}=this.#wt;u.left=`${this.#C[0]}%`;u.top=`${this.#C[1]}%`}#er(){this.#lr=!this.#lr;if(this.#lr){this.#Zn();this.#wt.addEventListener("click",this.#tr);this.#wt.addEventListener("keydown",this.#qn)}else{this.#Jn();this.#wt.removeEventListener("click",this.#tr);this.#wt.removeEventListener("keydown",this.#qn)}}#Zn(){if(!this.#hr){this.render()}if(!this.isVisible){this.#_r();this.#wt.hidden=false;this.#wt.style.zIndex=parseInt(this.#wt.style.zIndex)+1e3}else if(this.#lr){this.#wt.classList.add("focused")}}#Jn(){this.#wt.classList.remove("focused");if(this.#lr||!this.isVisible){return}this.#wt.hidden=true;this.#wt.style.zIndex=parseInt(this.#wt.style.zIndex)-1e3}forceHide(){this.#mr=this.isVisible;if(!this.#mr){return}this.#wt.hidden=true}maybeShow(){this.#br();if(!this.#mr){return}if(!this.#hr){this.#Zn()}this.#mr=false;this.#wt.hidden=false}get isVisible(){return this.#wt.hidden===false}}class FreeTextAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:true,ignoreBorder:true});this.textContent=t.data.textContent;this.textPosition=t.data.textPosition;this.annotationEditorType=AnnotationEditorType.FREETEXT}render(){this.container.classList.add("freeTextAnnotation");if(this.textContent){const t=document.createElement("div");t.classList.add("annotationTextContent");t.setAttribute("role","comment");for(const e of this.textContent){const i=document.createElement("span");i.textContent=e;t.append(i)}this.container.append(t)}if(!this.data.popupRef&&this.hasPopupData){this._createPopup()}this._editOnDoubleClick();return this.container}}class LineAnnotationElement extends AnnotationElement{#Tr=null;constructor(t){super(t,{isRenderable:true,ignoreBorder:true})}render(){this.container.classList.add("lineAnnotation");const{data:t,width:e,height:i}=this;const s=this.svgFactory.create(e,i,true);const n=this.#Tr=this.svgFactory.createElement("svg:line");n.setAttribute("x1",t.rect[2]-t.lineCoordinates[0]);n.setAttribute("y1",t.rect[3]-t.lineCoordinates[1]);n.setAttribute("x2",t.rect[2]-t.lineCoordinates[2]);n.setAttribute("y2",t.rect[3]-t.lineCoordinates[3]);n.setAttribute("stroke-width",t.borderStyle.width||1);n.setAttribute("stroke","transparent");n.setAttribute("fill","transparent");s.append(n);this.container.append(s);if(!t.popupRef&&this.hasPopupData){this._createPopup()}return this.container}getElementsToTriggerPopup(){return this.#Tr}addHighlightArea(){this.container.classList.add("highlightArea")}}class SquareAnnotationElement extends AnnotationElement{#Sr=null;constructor(t){super(t,{isRenderable:true,ignoreBorder:true})}render(){this.container.classList.add("squareAnnotation");const{data:t,width:e,height:i}=this;const s=this.svgFactory.create(e,i,true);const n=t.borderStyle.width;const r=this.#Sr=this.svgFactory.createElement("svg:rect");r.setAttribute("x",n/2);r.setAttribute("y",n/2);r.setAttribute("width",e-n);r.setAttribute("height",i-n);r.setAttribute("stroke-width",n||1);r.setAttribute("stroke","transparent");r.setAttribute("fill","transparent");s.append(r);this.container.append(s);if(!t.popupRef&&this.hasPopupData){this._createPopup()}return this.container}getElementsToTriggerPopup(){return this.#Sr}addHighlightArea(){this.container.classList.add("highlightArea")}}class CircleAnnotationElement extends AnnotationElement{#Cr=null;constructor(t){super(t,{isRenderable:true,ignoreBorder:true})}render(){this.container.classList.add("circleAnnotation");const{data:t,width:e,height:i}=this;const s=this.svgFactory.create(e,i,true);const n=t.borderStyle.width;const r=this.#Cr=this.svgFactory.createElement("svg:ellipse");r.setAttribute("cx",e/2);r.setAttribute("cy",i/2);r.setAttribute("rx",e/2-n/2);r.setAttribute("ry",i/2-n/2);r.setAttribute("stroke-width",n||1);r.setAttribute("stroke","transparent");r.setAttribute("fill","transparent");s.append(r);this.container.append(s);if(!t.popupRef&&this.hasPopupData){this._createPopup()}return this.container}getElementsToTriggerPopup(){return this.#Cr}addHighlightArea(){this.container.classList.add("highlightArea")}}class PolylineAnnotationElement extends AnnotationElement{#Dr=null;constructor(t){super(t,{isRenderable:true,ignoreBorder:true});this.containerClassName="polylineAnnotation";this.svgElementName="svg:polyline"}render(){this.container.classList.add(this.containerClassName);const{data:{rect:t,vertices:e,borderStyle:i,popupRef:s},width:n,height:r}=this;if(!e){return this.container}const a=this.svgFactory.create(n,r,true);let o=[];for(let i=0,s=e.length;i<s;i+=2){const s=e[i]-t[0];const n=t[3]-e[i+1];o.push(`${s},${n}`)}o=o.join(" ");const l=this.#Dr=this.svgFactory.createElement(this.svgElementName);l.setAttribute("points",o);l.setAttribute("stroke-width",i.width||1);l.setAttribute("stroke","transparent");l.setAttribute("fill","transparent");a.append(l);this.container.append(a);if(!s&&this.hasPopupData){this._createPopup()}return this.container}getElementsToTriggerPopup(){return this.#Dr}addHighlightArea(){this.container.classList.add("highlightArea")}}class PolygonAnnotationElement extends PolylineAnnotationElement{constructor(t){super(t);this.containerClassName="polygonAnnotation";this.svgElementName="svg:polygon"}}class CaretAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:true,ignoreBorder:true})}render(){this.container.classList.add("caretAnnotation");if(!this.data.popupRef&&this.hasPopupData){this._createPopup()}return this.container}}class InkAnnotationElement extends AnnotationElement{#Mr=null;#Ir=[];constructor(t){super(t,{isRenderable:true,ignoreBorder:true});this.containerClassName="inkAnnotation";this.svgElementName="svg:polyline";this.annotationEditorType=this.data.it==="InkHighlight"?AnnotationEditorType.HIGHLIGHT:AnnotationEditorType.INK}#Pr(t,e){switch(t){case 90:return{transform:`rotate(90) translate(${-e[0]},${e[1]}) scale(1,-1)`,width:e[3]-e[1],height:e[2]-e[0]};case 180:return{transform:`rotate(180) translate(${-e[2]},${e[1]}) scale(1,-1)`,width:e[2]-e[0],height:e[3]-e[1]};case 270:return{transform:`rotate(270) translate(${-e[2]},${e[3]}) scale(1,-1)`,width:e[3]-e[1],height:e[2]-e[0]};default:return{transform:`translate(${-e[0]},${e[3]}) scale(1,-1)`,width:e[2]-e[0],height:e[3]-e[1]}}}render(){this.container.classList.add(this.containerClassName);const{data:{rect:t,rotation:e,inkLists:i,borderStyle:s,popupRef:n}}=this;const{transform:r,width:a,height:o}=this.#Pr(e,t);const l=this.svgFactory.create(a,o,true);const h=this.#Mr=this.svgFactory.createElement("svg:g");l.append(h);h.setAttribute("stroke-width",s.width||1);h.setAttribute("stroke-linecap","round");h.setAttribute("stroke-linejoin","round");h.setAttribute("stroke-miterlimit",10);h.setAttribute("stroke","transparent");h.setAttribute("fill","transparent");h.setAttribute("transform",r);for(let t=0,e=i.length;t<e;t++){const e=this.svgFactory.createElement(this.svgElementName);this.#Ir.push(e);e.setAttribute("points",i[t].join(","));h.append(e)}if(!n&&this.hasPopupData){this._createPopup()}this.container.append(l);this._editOnDoubleClick();return this.container}updateEdited(t){super.updateEdited(t);const{thickness:e,points:i,rect:s}=t;const n=this.#Mr;if(e>=0){n.setAttribute("stroke-width",e||1)}if(i){for(let t=0,e=this.#Ir.length;t<e;t++){this.#Ir[t].setAttribute("points",i[t].join(","))}}if(s){const{transform:t,width:e,height:i}=this.#Pr(this.data.rotation,s);const r=n.parentElement;r.setAttribute("viewBox",`0 0 ${e} ${i}`);n.setAttribute("transform",t)}}getElementsToTriggerPopup(){return this.#Ir}addHighlightArea(){this.container.classList.add("highlightArea")}get commentButtonPosition(){const{inkLists:t,rect:e}=this.data;if(t?.length>=1){let e=-Infinity;let i=-Infinity;for(const s of t){for(let t=0,n=s.length;t<n;t+=2){if(s[t+1]>i){i=s[t+1];e=s[t]}else if(s[t+1]===i){e=Math.max(e,s[t])}}}if(e!==Infinity){return[e,i]}}if(e){return[e[2],e[3]]}return null}}class HighlightAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:true,ignoreBorder:true,createQuadrilaterals:true});this.annotationEditorType=AnnotationEditorType.HIGHLIGHT}render(){const{data:{overlaidText:t,popupRef:e}}=this;if(!e&&this.hasPopupData){this._createPopup()}this.container.classList.add("highlightAnnotation");this._editOnDoubleClick();if(t){const e=document.createElement("mark");e.classList.add("overlaidText");e.textContent=t;this.container.append(e)}return this.container}}class UnderlineAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:true,ignoreBorder:true,createQuadrilaterals:true})}render(){const{data:{overlaidText:t,popupRef:e}}=this;if(!e&&this.hasPopupData){this._createPopup()}this.container.classList.add("underlineAnnotation");if(t){const e=document.createElement("u");e.classList.add("overlaidText");e.textContent=t;this.container.append(e)}return this.container}}class SquigglyAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:true,ignoreBorder:true,createQuadrilaterals:true})}render(){const{data:{overlaidText:t,popupRef:e}}=this;if(!e&&this.hasPopupData){this._createPopup()}this.container.classList.add("squigglyAnnotation");if(t){const e=document.createElement("u");e.classList.add("overlaidText");e.textContent=t;this.container.append(e)}return this.container}}class StrikeOutAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:true,ignoreBorder:true,createQuadrilaterals:true})}render(){const{data:{overlaidText:t,popupRef:e}}=this;if(!e&&this.hasPopupData){this._createPopup()}this.container.classList.add("strikeoutAnnotation");if(t){const e=document.createElement("s");e.classList.add("overlaidText");e.textContent=t;this.container.append(e)}return this.container}}class StampAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:true,ignoreBorder:true});this.annotationEditorType=AnnotationEditorType.STAMP}render(){this.container.classList.add("stampAnnotation");this.container.setAttribute("role","img");if(!this.data.popupRef&&this.hasPopupData){this._createPopup()}this._editOnDoubleClick();return this.container}}class FileAttachmentAnnotationElement extends AnnotationElement{#kr=null;constructor(t){super(t,{isRenderable:true});const{file:e}=this.data;this.filename=e.filename;this.content=e.content;this.linkService.eventBus?.dispatch("fileattachmentannotation",{source:this,...e})}render(){this.container.classList.add("fileAttachmentAnnotation");const{container:t,data:e}=this;let i;if(e.hasAppearance||e.fillAlpha===0){i=document.createElement("div")}else{i=document.createElement("img");i.src=`${this.imageResourcesPath}annotation-${/paperclip/i.test(e.name)?"paperclip":"pushpin"}.svg`;if(e.fillAlpha&&e.fillAlpha<1){i.style=`filter: opacity(${Math.round(e.fillAlpha*100)}%);`}}i.addEventListener("dblclick",this.#Rr.bind(this));this.#kr=i;const{isMac:s}=util_FeatureTest.platform;t.addEventListener("keydown",t=>{if(t.key==="Enter"&&(s?t.metaKey:t.ctrlKey)){this.#Rr()}});if(!e.popupRef&&this.hasPopupData){this._createPopup()}else{i.classList.add("popupTriggerArea")}t.append(i);return t}getElementsToTriggerPopup(){return this.#kr}addHighlightArea(){this.container.classList.add("highlightArea")}#Rr(){this.downloadManager?.openOrDownloadData(this.content,this.filename)}}class AnnotationLayer{#Lr=null;#Fr=null;#Or=new Map;#Nr=null;constructor({div:t,accessibilityManager:e,annotationCanvasMap:i,annotationEditorUIManager:s,page:n,viewport:r,structTreeLayer:a}){this.div=t;this.#Lr=e;this.#Fr=i;this.#Nr=a||null;this.page=n;this.viewport=r;this.zIndex=0;this._annotationEditorUIManager=s}hasEditableAnnotations(){return this.#Or.size>0}async#Br(t,e,i){const s=t.firstChild||t;const n=s.id=`${AnnotationPrefix}${e}`;const r=await(this.#Nr?.getAriaAttributes(n));if(r){for(const[t,e]of r){s.setAttribute(t,e)}}if(i){i.at(-1).container.after(t)}else{this.div.append(t);this.#Lr?.moveElementInDOM(this.div,t,s,false)}}async render(t){const{annotations:e}=t;const i=this.div;setLayerDimensions(i,this.viewport);const s=new Map;const n={data:null,layer:i,linkService:t.linkService,downloadManager:t.downloadManager,imageResourcesPath:t.imageResourcesPath||"",renderForms:t.renderForms!==false,svgFactory:new DOMSVGFactory,annotationStorage:t.annotationStorage||new AnnotationStorage,enableComment:t.enableComment===true,enableScripting:t.enableScripting===true,hasJSActions:t.hasJSActions,fieldObjects:t.fieldObjects,parent:this,elements:null};for(const t of e){if(t.noHTML){continue}const e=t.annotationType===AnnotationType.POPUP;if(!e){if(t.rect[2]===t.rect[0]||t.rect[3]===t.rect[1]){continue}}else{const e=s.get(t.id);if(!e){continue}n.elements=e}n.data=t;const i=AnnotationElementFactory.create(n);if(!i.isRenderable){continue}if(!e&&t.popupRef){const e=s.get(t.popupRef);if(!e){s.set(t.popupRef,[i])}else{e.push(i)}}const r=i.render();if(t.hidden){r.style.visibility="hidden"}await this.#Br(r,t.id,n.elements);if(i._isEditable){this.#Or.set(i.data.id,i);this._annotationEditorUIManager?.renderAnnotationElement(i)}}this.#Hr()}async addLinkAnnotations(t,e){const i={data:null,layer:this.div,linkService:e,svgFactory:new DOMSVGFactory,parent:this};for(const e of t){e.borderStyle||=AnnotationLayer._defaultBorderStyle;i.data=e;const t=AnnotationElementFactory.create(i);if(!t.isRenderable){continue}const s=t.render();await this.#Br(s,e.id,null)}}update({viewport:t}){const e=this.div;this.viewport=t;setLayerDimensions(e,{rotation:t.rotation});this.#Hr();e.hidden=false}#Hr(){if(!this.#Fr){return}const t=this.div;for(const[e,i]of this.#Fr){const s=t.querySelector(`[data-annotation-id="${e}"]`);if(!s){continue}i.className="annotationContent";const{firstChild:n}=s;if(!n){s.append(i)}else if(n.nodeName==="CANVAS"){n.replaceWith(i)}else if(!n.classList.contains("annotationContent")){n.before(i)}else{n.after(i)}const r=this.#Or.get(e);if(!r){continue}if(r._hasNoCanvas){this._annotationEditorUIManager?.setMissingCanvas(e,s.id,i);r._hasNoCanvas=false}else{r.canvas=i}}this.#Fr.clear()}getEditableAnnotations(){return Array.from(this.#Or.values())}getEditableAnnotation(t){return this.#Or.get(t)}static get _defaultBorderStyle(){return shadow(this,"_defaultBorderStyle",Object.freeze({width:1,rawWidth:1,style:AnnotationBorderStyleType.SOLID,dashArray:[3],horizontalCornerRadius:0,verticalCornerRadius:0}))}}const EOL_PATTERN=/\r\n?|\n/g;class FreeTextEditor extends AnnotationEditor{#ir;#Ur="";#Gr=`${this.id}-editor`;#zr=null;#Er;_colorPicker=null;static _freeTextDefaultContent="";static _internalPadding=0;static _defaultColor=null;static _defaultFontSize=10;static get _keyboardManager(){const t=FreeTextEditor.prototype;const e=t=>t.isEmpty();const i=AnnotationEditorUIManager.TRANSLATE_SMALL;const s=AnnotationEditorUIManager.TRANSLATE_BIG;return shadow(this,"_keyboardManager",new KeyboardManager([[["ctrl+s","mac+meta+s","ctrl+p","mac+meta+p"],t.commitOrRemove,{bubbles:true}],[["ctrl+Enter","mac+meta+Enter","Escape","mac+Escape"],t.commitOrRemove],[["ArrowLeft","mac+ArrowLeft"],t._translateEmpty,{args:[-i,0],checker:e}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],t._translateEmpty,{args:[-s,0],checker:e}],[["ArrowRight","mac+ArrowRight"],t._translateEmpty,{args:[i,0],checker:e}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],t._translateEmpty,{args:[s,0],checker:e}],[["ArrowUp","mac+ArrowUp"],t._translateEmpty,{args:[0,-i],checker:e}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],t._translateEmpty,{args:[0,-s],checker:e}],[["ArrowDown","mac+ArrowDown"],t._translateEmpty,{args:[0,i],checker:e}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],t._translateEmpty,{args:[0,s],checker:e}]]))}static _type="freetext";static _editorType=AnnotationEditorType.FREETEXT;constructor(t){super({...t,name:"freeTextEditor"});this.#ir=t.color||FreeTextEditor._defaultColor||AnnotationEditor._defaultLineColor;this.#Er=t.fontSize||FreeTextEditor._defaultFontSize;if(!this.annotationElementId){this._uiManager.a11yAlert("pdfjs-editor-freetext-added-alert")}}static initialize(t,e){AnnotationEditor.initialize(t,e);const i=getComputedStyle(document.documentElement);this._internalPadding=parseFloat(i.getPropertyValue("--freetext-padding"))}static updateDefaultParams(t,e){switch(t){case AnnotationEditorParamsType.FREETEXT_SIZE:FreeTextEditor._defaultFontSize=e;break;case AnnotationEditorParamsType.FREETEXT_COLOR:FreeTextEditor._defaultColor=e;break}}updateParams(t,e){switch(t){case AnnotationEditorParamsType.FREETEXT_SIZE:this.#Wr(e);break;case AnnotationEditorParamsType.FREETEXT_COLOR:this.#$r(e);break}}static get defaultPropertiesToUpdate(){return[[AnnotationEditorParamsType.FREETEXT_SIZE,FreeTextEditor._defaultFontSize],[AnnotationEditorParamsType.FREETEXT_COLOR,FreeTextEditor._defaultColor||AnnotationEditor._defaultLineColor]]}get propertiesToUpdate(){return[[AnnotationEditorParamsType.FREETEXT_SIZE,this.#Er],[AnnotationEditorParamsType.FREETEXT_COLOR,this.#ir]]}get toolbarButtons(){this._colorPicker||=new BasicColorPicker(this);return[["colorPicker",this._colorPicker]]}get colorType(){return AnnotationEditorParamsType.FREETEXT_COLOR}get colorValue(){return this.#ir}#Wr(t){const e=t=>{this.editorDiv.style.fontSize=`calc(${t}px * var(--total-scale-factor))`;this.translate(0,-(t-this.#Er)*this.parentScale);this.#Er=t;this.#Vr()};const i=this.#Er;this.addCommands({cmd:e.bind(this,t),undo:e.bind(this,i),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:true,type:AnnotationEditorParamsType.FREETEXT_SIZE,overwriteIfSameType:true,keepUndo:true})}#$r(t){const e=t=>{this.#ir=this.editorDiv.style.color=t;this._colorPicker?.update(t)};const i=this.#ir;this.addCommands({cmd:e.bind(this,t),undo:e.bind(this,i),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:true,type:AnnotationEditorParamsType.FREETEXT_COLOR,overwriteIfSameType:true,keepUndo:true})}_translateEmpty(t,e){this._uiManager.translateSelectedEditors(t,e,true)}getInitialTranslation(){const t=this.parentScale;return[-FreeTextEditor._internalPadding*t,-(FreeTextEditor._internalPadding+this.#Er)*t]}rebuild(){if(!this.parent){return}super.rebuild();if(this.div===null){return}if(!this.isAttachedToDOM){this.parent.add(this)}}enableEditMode(){if(!super.enableEditMode()){return false}this.overlayDiv.classList.remove("enabled");this.editorDiv.contentEditable=true;this._isDraggable=false;this.div.removeAttribute("aria-activedescendant");this.#zr=new AbortController;const t=this._uiManager.combinedSignal(this.#zr);this.editorDiv.addEventListener("keydown",this.editorDivKeydown.bind(this),{signal:t});this.editorDiv.addEventListener("focus",this.editorDivFocus.bind(this),{signal:t});this.editorDiv.addEventListener("blur",this.editorDivBlur.bind(this),{signal:t});this.editorDiv.addEventListener("input",this.editorDivInput.bind(this),{signal:t});this.editorDiv.addEventListener("paste",this.editorDivPaste.bind(this),{signal:t});return true}disableEditMode(){if(!super.disableEditMode()){return false}this.overlayDiv.classList.add("enabled");this.editorDiv.contentEditable=false;this.div.setAttribute("aria-activedescendant",this.#Gr);this._isDraggable=true;this.#zr?.abort();this.#zr=null;this.div.focus({preventScroll:true});this.isEditing=false;this.parent.div.classList.add("freetextEditing");return true}focusin(t){if(!this._focusEventsAllowed){return}super.focusin(t);if(t.target!==this.editorDiv){this.editorDiv.focus()}}onceAdded(t){if(this.width){return}this.enableEditMode();if(t){this.editorDiv.focus()}if(this._initialOptions?.isCentered){this.center()}this._initialOptions=null}isEmpty(){return!this.editorDiv||this.editorDiv.innerText.trim()===""}remove(){this.isEditing=false;if(this.parent){this.parent.setEditingState(true);this.parent.div.classList.add("freetextEditing")}super.remove()}#jr(){const t=[];this.editorDiv.normalize();let e=null;for(const i of this.editorDiv.childNodes){if(e?.nodeType===Node.TEXT_NODE&&i.nodeName==="BR"){continue}t.push(FreeTextEditor.#Kr(i));e=i}return t.join("\n")}#Vr(){const[t,e]=this.parentDimensions;let i;if(this.isAttachedToDOM){i=this.div.getBoundingClientRect()}else{const{currentLayer:t,div:e}=this;const s=e.style.display;const n=e.classList.contains("hidden");e.classList.remove("hidden");e.style.display="hidden";t.div.append(this.div);i=e.getBoundingClientRect();e.remove();e.style.display=s;e.classList.toggle("hidden",n)}if(this.rotation%180===this.parentRotation%180){this.width=i.width/t;this.height=i.height/e}else{this.width=i.height/t;this.height=i.width/e}this.fixAndSetPosition()}commit(){if(!this.isInEditMode()){return}super.commit();this.disableEditMode();const t=this.#Ur;const e=this.#Ur=this.#jr().trimEnd();if(t===e){return}const i=t=>{this.#Ur=t;if(!t){this.remove();return}this.#Xr();this._uiManager.rebuild(this);this.#Vr()};this.addCommands({cmd:()=>{i(e)},undo:()=>{i(t)},mustExec:false});this.#Vr()}shouldGetKeyboardEvents(){return this.isInEditMode()}enterInEditMode(){this.enableEditMode();this.editorDiv.focus()}keydown(t){if(t.target===this.div&&t.key==="Enter"){this.enterInEditMode();t.preventDefault()}}editorDivKeydown(t){FreeTextEditor._keyboardManager.exec(this,t)}editorDivFocus(t){this.isEditing=true}editorDivBlur(t){this.isEditing=false}editorDivInput(t){this.parent.div.classList.toggle("freetextEditing",this.isEmpty())}disableEditing(){this.editorDiv.setAttribute("role","comment");this.editorDiv.removeAttribute("aria-multiline")}enableEditing(){this.editorDiv.setAttribute("role","textbox");this.editorDiv.setAttribute("aria-multiline",true)}get canChangeContent(){return true}render(){if(this.div){return this.div}let t,e;if(this._isCopy||this.annotationElementId){t=this.x;e=this.y}super.render();this.editorDiv=document.createElement("div");this.editorDiv.className="internal";this.editorDiv.setAttribute("id",this.#Gr);this.editorDiv.setAttribute("data-l10n-id","pdfjs-free-text2");this.editorDiv.setAttribute("data-l10n-attrs","default-content");this.enableEditing();this.editorDiv.contentEditable=true;const{style:i}=this.editorDiv;i.fontSize=`calc(${this.#Er}px * var(--total-scale-factor))`;i.color=this.#ir;this.div.append(this.editorDiv);this.overlayDiv=document.createElement("div");this.overlayDiv.classList.add("overlay","enabled");this.div.append(this.overlayDiv);if(this._isCopy||this.annotationElementId){const[i,s]=this.parentDimensions;if(this.annotationElementId){const{position:n}=this._initialData;let[r,a]=this.getInitialTranslation();[r,a]=this.pageTranslationToScreen(r,a);const[o,l]=this.pageDimensions;const[h,c]=this.pageTranslation;let d,u;switch(this.rotation){case 0:d=t+(n[0]-h)/o;u=e+this.height-(n[1]-c)/l;break;case 90:d=t+(n[0]-h)/o;u=e-(n[1]-c)/l;[r,a]=[a,-r];break;case 180:d=t-this.width+(n[0]-h)/o;u=e-(n[1]-c)/l;[r,a]=[-r,-a];break;case 270:d=t+(n[0]-h-this.height*l)/o;u=e+(n[1]-c-this.width*o)/l;[r,a]=[-a,r];break}this.setAt(d*i,u*s,r,a)}else{this._moveAfterPaste(t,e)}this.#Xr();this._isDraggable=true;this.editorDiv.contentEditable=false}else{this._isDraggable=false;this.editorDiv.contentEditable=true}return this.div}static#Kr(t){return(t.nodeType===Node.TEXT_NODE?t.nodeValue:t.innerText).replaceAll(EOL_PATTERN,"")}editorDivPaste(t){const e=t.clipboardData||window.clipboardData;const{types:i}=e;if(i.length===1&&i[0]==="text/plain"){return}t.preventDefault();const s=FreeTextEditor.#qr(e.getData("text")||"").replaceAll(EOL_PATTERN,"\n");if(!s){return}const n=window.getSelection();if(!n.rangeCount){return}this.editorDiv.normalize();n.deleteFromDocument();const r=n.getRangeAt(0);if(!s.includes("\n")){r.insertNode(document.createTextNode(s));this.editorDiv.normalize();n.collapseToStart();return}const{startContainer:a,startOffset:o}=r;const l=[];const h=[];if(a.nodeType===Node.TEXT_NODE){const t=a.parentElement;h.push(a.nodeValue.slice(o).replaceAll(EOL_PATTERN,""));if(t!==this.editorDiv){let e=l;for(const i of this.editorDiv.childNodes){if(i===t){e=h;continue}e.push(FreeTextEditor.#Kr(i))}}l.push(a.nodeValue.slice(0,o).replaceAll(EOL_PATTERN,""))}else if(a===this.editorDiv){let t=l;let e=0;for(const i of this.editorDiv.childNodes){if(e++===o){t=h}t.push(FreeTextEditor.#Kr(i))}}this.#Ur=`${l.join("\n")}${s}${h.join("\n")}`;this.#Xr();const c=new Range;let d=Math.sumPrecise(l.map(t=>t.length));for(const{firstChild:t}of this.editorDiv.childNodes){if(t.nodeType===Node.TEXT_NODE){const e=t.nodeValue.length;if(d<=e){c.setStart(t,d);c.setEnd(t,d);break}d-=e}}n.removeAllRanges();n.addRange(c)}#Xr(){this.editorDiv.replaceChildren();if(!this.#Ur){return}for(const t of this.#Ur.split("\n")){const e=document.createElement("div");e.append(t?document.createTextNode(t):document.createElement("br"));this.editorDiv.append(e)}}#Yr(){return this.#Ur.replaceAll("Â "," ")}static#qr(t){return t.replaceAll(" ","Â ")}get contentDiv(){return this.editorDiv}getPDFRect(){const t=FreeTextEditor._internalPadding*this.parentScale;return this.getRect(t,t)}static async deserialize(t,e,i){let s=null;if(t instanceof FreeTextAnnotationElement){const{data:{defaultAppearanceData:{fontSize:e,fontColor:i},rect:n,rotation:r,id:a,popupRef:o,contentsObj:l},textContent:h,textPosition:c,parent:{page:{pageNumber:d}}}=t;if(!h||h.length===0){return null}s=t={annotationType:AnnotationEditorType.FREETEXT,color:Array.from(i),fontSize:e,value:h.join("\n"),position:c,pageIndex:d-1,rect:n.slice(0),rotation:r,annotationElementId:a,id:a,deleted:false,popupRef:o,comment:l?.str||null}}const n=await super.deserialize(t,e,i);n.#Er=t.fontSize;n.#ir=Util.makeHexColor(...t.color);n.#Ur=FreeTextEditor.#qr(t.value);n._initialData=s;if(t.comment){n.setCommentData(t.comment)}return n}serialize(t=false){if(this.isEmpty()){return null}if(this.deleted){return this.serializeDeleted()}const e=this.getPDFRect();const i=AnnotationEditor._colorManager.convert(this.isAttachedToDOM?getComputedStyle(this.editorDiv).color:this.#ir);const s={annotationType:AnnotationEditorType.FREETEXT,color:i,fontSize:this.#Er,value:this.#Yr(),pageIndex:this.pageIndex,rect:e,rotation:this.rotation,structTreeParentId:this._structTreeParentId};this.addComment(s);if(t){s.isCopy=true;return s}if(this.annotationElementId&&!this.#Jr(s)){return null}s.id=this.annotationElementId;return s}#Jr(t){const{value:e,fontSize:i,color:s,pageIndex:n}=this._initialData;return this.hasEditedComment||this._hasBeenMoved||t.value!==e||t.fontSize!==i||t.color.some((t,e)=>t!==s[e])||t.pageIndex!==n}renderAnnotationElement(t){const e=super.renderAnnotationElement(t);if(!e){return null}const{style:i}=e;i.fontSize=`calc(${this.#Er}px * var(--total-scale-factor))`;i.color=this.#ir;e.replaceChildren();for(const t of this.#Ur.split("\n")){const i=document.createElement("div");i.append(t?document.createTextNode(t):document.createElement("br"));e.append(i)}const s={rect:this.getPDFRect()};s.popup=this.hasEditedComment?this.comment:{text:this.#Ur};t.updateEdited(s);return e}resetAnnotationElement(t){super.resetAnnotationElement(t);t.resetEdited()}}class Outline{static PRECISION=1e-4;toSVGPath(){unreachable("Abstract method `toSVGPath` must be implemented.")}get box(){unreachable("Abstract getter `box` must be implemented.")}serialize(t,e){unreachable("Abstract method `serialize` must be implemented.")}static _rescale(t,e,i,s,n,r){r||=new Float32Array(t.length);for(let a=0,o=t.length;a<o;a+=2){r[a]=e+t[a]*s;r[a+1]=i+t[a+1]*n}return r}static _rescaleAndSwap(t,e,i,s,n,r){r||=new Float32Array(t.length);for(let a=0,o=t.length;a<o;a+=2){r[a]=e+t[a+1]*s;r[a+1]=i+t[a]*n}return r}static _translate(t,e,i,s){s||=new Float32Array(t.length);for(let n=0,r=t.length;n<r;n+=2){s[n]=e+t[n];s[n+1]=i+t[n+1]}return s}static svgRound(t){return Math.round(t*1e4)}static _normalizePoint(t,e,i,s,n){switch(n){case 90:return[1-e/i,t/s];case 180:return[1-t/i,1-e/s];case 270:return[e/i,1-t/s];default:return[t/i,e/s]}}static _normalizePagePoint(t,e,i){switch(i){case 90:return[1-e,t];case 180:return[1-t,1-e];case 270:return[e,1-t];default:return[t,e]}}static createBezierPoints(t,e,i,s,n,r){return[(t+5*i)/6,(e+5*s)/6,(5*i+n)/6,(5*s+r)/6,(i+n)/2,(s+r)/2]}}class FreeDrawOutliner{#Qr;#Zr=[];#ta;#ea;#ia=[];#sa=new Float32Array(18);#na;#ra;#aa;#oa;#la;#ha;#ca=[];static#da=8;static#ua=2;static#pa=FreeDrawOutliner.#da+FreeDrawOutliner.#ua;constructor({x:t,y:e},i,s,n,r,a=0){this.#Qr=i;this.#ha=n*s;this.#ea=r;this.#sa.set([NaN,NaN,NaN,NaN,t,e],6);this.#ta=a;this.#oa=FreeDrawOutliner.#da*s;this.#aa=FreeDrawOutliner.#pa*s;this.#la=s;this.#ca.push(t,e)}isEmpty(){return isNaN(this.#sa[8])}#ga(){const t=this.#sa.subarray(4,6);const e=this.#sa.subarray(16,18);const[i,s,n,r]=this.#Qr;return[(this.#na+(t[0]-e[0])/2-i)/n,(this.#ra+(t[1]-e[1])/2-s)/r,(this.#na+(e[0]-t[0])/2-i)/n,(this.#ra+(e[1]-t[1])/2-s)/r]}add({x:t,y:e}){this.#na=t;this.#ra=e;const[i,s,n,r]=this.#Qr;let[a,o,l,h]=this.#sa.subarray(8,12);const c=t-l;const d=e-h;const u=Math.hypot(c,d);if(u<this.#aa){return false}const p=u-this.#oa;const g=p/u;const f=g*c;const m=g*d;let b=a;let A=o;a=l;o=h;l+=f;h+=m;this.#ca?.push(t,e);const y=-m/p;const w=f/p;const E=y*this.#ha;const v=w*this.#ha;this.#sa.set(this.#sa.subarray(2,8),0);this.#sa.set([l+E,h+v],4);this.#sa.set(this.#sa.subarray(14,18),12);this.#sa.set([l-E,h-v],16);if(isNaN(this.#sa[6])){if(this.#ia.length===0){this.#sa.set([a+E,o+v],2);this.#ia.push(NaN,NaN,NaN,NaN,(a+E-i)/n,(o+v-s)/r);this.#sa.set([a-E,o-v],14);this.#Zr.push(NaN,NaN,NaN,NaN,(a-E-i)/n,(o-v-s)/r)}this.#sa.set([b,A,a,o,l,h],6);return!this.isEmpty()}this.#sa.set([b,A,a,o,l,h],6);const x=Math.abs(Math.atan2(A-o,b-a)-Math.atan2(m,f));if(x<Math.PI/2){[a,o,l,h]=this.#sa.subarray(2,6);this.#ia.push(NaN,NaN,NaN,NaN,((a+l)/2-i)/n,((o+h)/2-s)/r);[a,o,b,A]=this.#sa.subarray(14,18);this.#Zr.push(NaN,NaN,NaN,NaN,((b+a)/2-i)/n,((A+o)/2-s)/r);return true}[b,A,a,o,l,h]=this.#sa.subarray(0,6);this.#ia.push(((b+5*a)/6-i)/n,((A+5*o)/6-s)/r,((5*a+l)/6-i)/n,((5*o+h)/6-s)/r,((a+l)/2-i)/n,((o+h)/2-s)/r);[l,h,a,o,b,A]=this.#sa.subarray(12,18);this.#Zr.push(((b+5*a)/6-i)/n,((A+5*o)/6-s)/r,((5*a+l)/6-i)/n,((5*o+h)/6-s)/r,((a+l)/2-i)/n,((o+h)/2-s)/r);return true}toSVGPath(){if(this.isEmpty()){return""}const t=this.#ia;const e=this.#Zr;if(isNaN(this.#sa[6])&&!this.isEmpty()){return this.#fa()}const i=[];i.push(`M${t[4]} ${t[5]}`);for(let e=6;e<t.length;e+=6){if(isNaN(t[e])){i.push(`L${t[e+4]} ${t[e+5]}`)}else{i.push(`C${t[e]} ${t[e+1]} ${t[e+2]} ${t[e+3]} ${t[e+4]} ${t[e+5]}`)}}this.#ma(i);for(let t=e.length-6;t>=6;t-=6){if(isNaN(e[t])){i.push(`L${e[t+4]} ${e[t+5]}`)}else{i.push(`C${e[t]} ${e[t+1]} ${e[t+2]} ${e[t+3]} ${e[t+4]} ${e[t+5]}`)}}this.#ba(i);return i.join(" ")}#fa(){const[t,e,i,s]=this.#Qr;const[n,r,a,o]=this.#ga();return`M${(this.#sa[2]-t)/i} ${(this.#sa[3]-e)/s} L${(this.#sa[4]-t)/i} ${(this.#sa[5]-e)/s} L${n} ${r} L${a} ${o} L${(this.#sa[16]-t)/i} ${(this.#sa[17]-e)/s} L${(this.#sa[14]-t)/i} ${(this.#sa[15]-e)/s} Z`}#ba(t){const e=this.#Zr;t.push(`L${e[4]} ${e[5]} Z`)}#ma(t){const[e,i,s,n]=this.#Qr;const r=this.#sa.subarray(4,6);const a=this.#sa.subarray(16,18);const[o,l,h,c]=this.#ga();t.push(`L${(r[0]-e)/s} ${(r[1]-i)/n} L${o} ${l} L${h} ${c} L${(a[0]-e)/s} ${(a[1]-i)/n}`)}newFreeDrawOutline(t,e,i,s,n,r){return new FreeDrawOutline(t,e,i,s,n,r)}getOutlines(){const t=this.#ia;const e=this.#Zr;const i=this.#sa;const[s,n,r,a]=this.#Qr;const o=new Float32Array((this.#ca?.length??0)+2);for(let t=0,e=o.length-2;t<e;t+=2){o[t]=(this.#ca[t]-s)/r;o[t+1]=(this.#ca[t+1]-n)/a}o[o.length-2]=(this.#na-s)/r;o[o.length-1]=(this.#ra-n)/a;if(isNaN(i[6])&&!this.isEmpty()){return this.#Aa(o)}const l=new Float32Array(this.#ia.length+24+this.#Zr.length);let h=t.length;for(let e=0;e<h;e+=2){if(isNaN(t[e])){l[e]=l[e+1]=NaN;continue}l[e]=t[e];l[e+1]=t[e+1]}h=this.#ya(l,h);for(let t=e.length-6;t>=6;t-=6){for(let i=0;i<6;i+=2){if(isNaN(e[t+i])){l[h]=l[h+1]=NaN;h+=2;continue}l[h]=e[t+i];l[h+1]=e[t+i+1];h+=2}}this.#wa(l,h);return this.newFreeDrawOutline(l,o,this.#Qr,this.#la,this.#ta,this.#ea)}#Aa(t){const e=this.#sa;const[i,s,n,r]=this.#Qr;const[a,o,l,h]=this.#ga();const c=new Float32Array(36);c.set([NaN,NaN,NaN,NaN,(e[2]-i)/n,(e[3]-s)/r,NaN,NaN,NaN,NaN,(e[4]-i)/n,(e[5]-s)/r,NaN,NaN,NaN,NaN,a,o,NaN,NaN,NaN,NaN,l,h,NaN,NaN,NaN,NaN,(e[16]-i)/n,(e[17]-s)/r,NaN,NaN,NaN,NaN,(e[14]-i)/n,(e[15]-s)/r],0);return this.newFreeDrawOutline(c,t,this.#Qr,this.#la,this.#ta,this.#ea)}#wa(t,e){const i=this.#Zr;t.set([NaN,NaN,NaN,NaN,i[4],i[5]],e);return e+=6}#ya(t,e){const i=this.#sa.subarray(4,6);const s=this.#sa.subarray(16,18);const[n,r,a,o]=this.#Qr;const[l,h,c,d]=this.#ga();t.set([NaN,NaN,NaN,NaN,(i[0]-n)/a,(i[1]-r)/o,NaN,NaN,NaN,NaN,l,h,NaN,NaN,NaN,NaN,c,d,NaN,NaN,NaN,NaN,(s[0]-n)/a,(s[1]-r)/o],e);return e+=24}}class FreeDrawOutline extends Outline{#Qr;#Ea=new Float32Array(4);#ta;#ea;#ca;#la;#va;constructor(t,e,i,s,n,r){super();this.#va=t;this.#ca=e;this.#Qr=i;this.#la=s;this.#ta=n;this.#ea=r;this.lastPoint=[NaN,NaN];this.#xa(r);const[a,o,l,h]=this.#Ea;for(let e=0,i=t.length;e<i;e+=2){t[e]=(t[e]-a)/l;t[e+1]=(t[e+1]-o)/h}for(let t=0,i=e.length;t<i;t+=2){e[t]=(e[t]-a)/l;e[t+1]=(e[t+1]-o)/h}}toSVGPath(){const t=[`M${this.#va[4]} ${this.#va[5]}`];for(let e=6,i=this.#va.length;e<i;e+=6){if(isNaN(this.#va[e])){t.push(`L${this.#va[e+4]} ${this.#va[e+5]}`);continue}t.push(`C${this.#va[e]} ${this.#va[e+1]} ${this.#va[e+2]} ${this.#va[e+3]} ${this.#va[e+4]} ${this.#va[e+5]}`)}t.push("Z");return t.join(" ")}serialize([t,e,i,s],n){const r=i-t;const a=s-e;let o;let l;switch(n){case 0:o=Outline._rescale(this.#va,t,s,r,-a);l=Outline._rescale(this.#ca,t,s,r,-a);break;case 90:o=Outline._rescaleAndSwap(this.#va,t,e,r,a);l=Outline._rescaleAndSwap(this.#ca,t,e,r,a);break;case 180:o=Outline._rescale(this.#va,i,e,-r,a);l=Outline._rescale(this.#ca,i,e,-r,a);break;case 270:o=Outline._rescaleAndSwap(this.#va,i,s,-r,-a);l=Outline._rescaleAndSwap(this.#ca,i,s,-r,-a);break}return{outline:Array.from(o),points:[Array.from(l)]}}#xa(t){const e=this.#va;let i=e[4];let s=e[5];const n=[i,s,i,s];let r=i;let a=s;const o=t?Math.max:Math.min;for(let t=6,l=e.length;t<l;t+=6){const l=e[t+4],h=e[t+5];if(isNaN(e[t])){Util.pointBoundingBox(l,h,n);if(a<h){r=l;a=h}else if(a===h){r=o(r,l)}}else{const l=[Infinity,Infinity,-Infinity,-Infinity];Util.bezierBoundingBox(i,s,...e.slice(t,t+6),l);Util.rectBoundingBox(...l,n);if(a<l[3]){r=l[2];a=l[3]}else if(a===l[3]){r=o(r,l[2])}}i=l;s=h}const l=this.#Ea;l[0]=n[0]-this.#ta;l[1]=n[1]-this.#ta;l[2]=n[2]-n[0]+2*this.#ta;l[3]=n[3]-n[1]+2*this.#ta;this.lastPoint=[r,a]}get box(){return this.#Ea}newOutliner(t,e,i,s,n,r=0){return new FreeDrawOutliner(t,e,i,s,n,r)}getNewOutline(t,e){const[i,s,n,r]=this.#Ea;const[a,o,l,h]=this.#Qr;const c=n*l;const d=r*h;const u=i*l+a;const p=s*h+o;const g=this.newOutliner({x:this.#ca[0]*c+u,y:this.#ca[1]*d+p},this.#Qr,this.#la,t,this.#ea,e??this.#ta);for(let t=2;t<this.#ca.length;t+=2){g.add({x:this.#ca[t]*c+u,y:this.#ca[t+1]*d+p})}return g.getOutlines()}}class HighlightOutliner{#Qr;#_a;#Ta=[];#Sa=[];constructor(t,e=0,i=0,s=true){const n=[Infinity,Infinity,-Infinity,-Infinity];const r=4;const a=10**-r;for(const{x:i,y:s,width:r,height:o}of t){const t=Math.floor((i-e)/a)*a;const l=Math.ceil((i+r+e)/a)*a;const h=Math.floor((s-e)/a)*a;const c=Math.ceil((s+o+e)/a)*a;const d=[t,h,c,true];const u=[l,h,c,false];this.#Ta.push(d,u);Util.rectBoundingBox(t,h,l,c,n)}const o=n[2]-n[0]+2*i;const l=n[3]-n[1]+2*i;const h=n[0]-i;const c=n[1]-i;const d=this.#Ta.at(s?-1:-2);const u=[d[0],d[2]];for(const t of this.#Ta){const[e,i,s]=t;t[0]=(e-h)/o;t[1]=(i-c)/l;t[2]=(s-c)/l}this.#Qr=new Float32Array([h,c,o,l]);this.#_a=u}getOutlines(){this.#Ta.sort((t,e)=>t[0]-e[0]||t[1]-e[1]||t[2]-e[2]);const t=[];for(const e of this.#Ta){if(e[3]){t.push(...this.#Ca(e));this.#Da(e)}else{this.#Ma(e);t.push(...this.#Ca(e))}}return this.#Ia(t)}#Ia(t){const e=[];const i=new Set;for(const i of t){const[t,s,n]=i;e.push([t,s,i],[t,n,i])}e.sort((t,e)=>t[1]-e[1]||t[0]-e[0]);for(let t=0,s=e.length;t<s;t+=2){const s=e[t][2];const n=e[t+1][2];s.push(n);n.push(s);i.add(s);i.add(n)}const s=[];let n;while(i.size>0){const t=i.values().next().value;let[e,r,a,o,l]=t;i.delete(t);let h=e;let c=r;n=[e,a];s.push(n);while(true){let t;if(i.has(o)){t=o}else if(i.has(l)){t=l}else{break}i.delete(t);[e,r,a,o,l]=t;if(h!==e){n.push(h,c,e,c===r?r:a);h=e}c=c===r?a:r}n.push(h,c)}return new HighlightOutline(s,this.#Qr,this.#_a)}#Pa(t){const e=this.#Sa;let i=0;let s=e.length-1;while(i<=s){const n=i+s>>1;const r=e[n][0];if(r===t){return n}if(r<t){i=n+1}else{s=n-1}}return s+1}#Da([,t,e]){const i=this.#Pa(t);this.#Sa.splice(i,0,[t,e])}#Ma([,t,e]){const i=this.#Pa(t);for(let s=i;s<this.#Sa.length;s++){const[i,n]=this.#Sa[s];if(i!==t){break}if(i===t&&n===e){this.#Sa.splice(s,1);return}}for(let s=i-1;s>=0;s--){const[i,n]=this.#Sa[s];if(i!==t){break}if(i===t&&n===e){this.#Sa.splice(s,1);return}}}#Ca(t){const[e,i,s]=t;const n=[[e,i,s]];const r=this.#Pa(s);for(let t=0;t<r;t++){const[i,s]=this.#Sa[t];for(let t=0,r=n.length;t<r;t++){const[,a,o]=n[t];if(s<=a||o<=i){continue}if(a>=i){if(o>s){n[t][1]=s}else{if(r===1){return[]}n.splice(t,1);t--;r--}continue}n[t][2]=i;if(o>s){n.push([e,s,o])}}}return n}}class HighlightOutline extends Outline{#Qr;#ka;constructor(t,e,i){super();this.#ka=t;this.#Qr=e;this.lastPoint=i}toSVGPath(){const t=[];for(const e of this.#ka){let[i,s]=e;t.push(`M${i} ${s}`);for(let n=2;n<e.length;n+=2){const r=e[n];const a=e[n+1];if(r===i){t.push(`V${a}`);s=a}else if(a===s){t.push(`H${r}`);i=r}}t.push("Z")}return t.join(" ")}serialize([t,e,i,s],n){const r=[];const a=i-t;const o=s-e;for(const e of this.#ka){const i=new Array(e.length);for(let n=0;n<e.length;n+=2){i[n]=t+e[n]*a;i[n+1]=s-e[n+1]*o}r.push(i)}return r}get box(){return this.#Qr}get classNamesForOutlining(){return["highlightOutline"]}}class FreeHighlightOutliner extends FreeDrawOutliner{newFreeDrawOutline(t,e,i,s,n,r){return new FreeHighlightOutline(t,e,i,s,n,r)}}class FreeHighlightOutline extends FreeDrawOutline{newOutliner(t,e,i,s,n,r=0){return new FreeHighlightOutliner(t,e,i,s,n,r)}}class HighlightEditor extends AnnotationEditor{#Ra=null;#La=0;#Fa;#Oa=null;#n=null;#Na=null;#Ba=null;#Ha=0;#Ua=null;#Ga=null;#w=null;#za=false;#_a=null;#Wa;#$a=null;#oe="";#ha;#Va="";static _defaultColor=null;static _defaultOpacity=1;static _defaultThickness=12;static _type="highlight";static _editorType=AnnotationEditorType.HIGHLIGHT;static _freeHighlightId=-1;static _freeHighlight=null;static _freeHighlightClipId="";static get _keyboardManager(){const t=HighlightEditor.prototype;return shadow(this,"_keyboardManager",new KeyboardManager([[["ArrowLeft","mac+ArrowLeft"],t._moveCaret,{args:[0]}],[["ArrowRight","mac+ArrowRight"],t._moveCaret,{args:[1]}],[["ArrowUp","mac+ArrowUp"],t._moveCaret,{args:[2]}],[["ArrowDown","mac+ArrowDown"],t._moveCaret,{args:[3]}]]))}constructor(t){super({...t,name:"highlightEditor"});this.color=t.color||HighlightEditor._defaultColor;this.#ha=t.thickness||HighlightEditor._defaultThickness;this.#Wa=t.opacity||HighlightEditor._defaultOpacity;this.#Fa=t.boxes||null;this.#Va=t.methodOfCreation||"";this.#oe=t.text||"";this._isDraggable=false;this.defaultL10nId="pdfjs-editor-highlight-editor";if(t.highlightId>-1){this.#za=true;this.#ja(t);this.#Ka()}else if(this.#Fa){this.#Ra=t.anchorNode;this.#La=t.anchorOffset;this.#Ba=t.focusNode;this.#Ha=t.focusOffset;this.#Xa();this.#Ka();this.rotate(this.rotation)}if(!this.annotationElementId){this._uiManager.a11yAlert("pdfjs-editor-highlight-added-alert")}}get telemetryInitialData(){return{action:"added",type:this.#za?"free_highlight":"highlight",color:this._uiManager.getNonHCMColorName(this.color),thickness:this.#ha,methodOfCreation:this.#Va}}get telemetryFinalData(){return{type:"highlight",color:this._uiManager.getNonHCMColorName(this.color)}}get commentColor(){return this.color}static computeTelemetryFinalData(t){return{numberOfColors:t.get("color").size}}#Xa(){const t=new HighlightOutliner(this.#Fa,.001);this.#Ga=t.getOutlines();[this.x,this.y,this.width,this.height]=this.#Ga.box;const e=new HighlightOutliner(this.#Fa,.0025,.001,this._uiManager.direction==="ltr");this.#Na=e.getOutlines();const{lastPoint:i}=this.#Na;this.#_a=[(i[0]-this.x)/this.width,(i[1]-this.y)/this.height]}#ja({highlightOutlines:t,highlightId:e,clipPathId:i}){this.#Ga=t;const s=1.5;this.#Na=t.getNewOutline(this.#ha/2+s,.0025);if(e>=0){this.#w=e;this.#Oa=i;this.parent.drawLayer.finalizeDraw(e,{bbox:t.box,path:{d:t.toSVGPath()}});this.#$a=this.parent.drawLayer.drawOutline({rootClass:{highlightOutline:true,free:true},bbox:this.#Na.box,path:{d:this.#Na.toSVGPath()}},true)}else if(this.parent){const e=this.parent.viewport.rotation;this.parent.drawLayer.updateProperties(this.#w,{bbox:HighlightEditor.#qa(this.#Ga.box,(e-this.rotation+360)%360),path:{d:t.toSVGPath()}});this.parent.drawLayer.updateProperties(this.#$a,{bbox:HighlightEditor.#qa(this.#Na.box,e),path:{d:this.#Na.toSVGPath()}})}const[n,r,a,o]=t.box;switch(this.rotation){case 0:this.x=n;this.y=r;this.width=a;this.height=o;break;case 90:{const[t,e]=this.parentDimensions;this.x=r;this.y=1-n;this.width=a*e/t;this.height=o*t/e;break}case 180:this.x=1-n;this.y=1-r;this.width=a;this.height=o;break;case 270:{const[t,e]=this.parentDimensions;this.x=1-r;this.y=n;this.width=a*e/t;this.height=o*t/e;break}}const{lastPoint:l}=this.#Na;this.#_a=[(l[0]-n)/a,(l[1]-r)/o]}static initialize(t,e){AnnotationEditor.initialize(t,e);HighlightEditor._defaultColor||=e.highlightColors?.values().next().value||"#fff066"}static updateDefaultParams(t,e){switch(t){case AnnotationEditorParamsType.HIGHLIGHT_COLOR:HighlightEditor._defaultColor=e;break;case AnnotationEditorParamsType.HIGHLIGHT_THICKNESS:HighlightEditor._defaultThickness=e;break}}translateInPage(t,e){}get toolbarPosition(){return this.#_a}updateParams(t,e){switch(t){case AnnotationEditorParamsType.HIGHLIGHT_COLOR:this.#$r(e);break;case AnnotationEditorParamsType.HIGHLIGHT_THICKNESS:this.#Ya(e);break}}static get defaultPropertiesToUpdate(){return[[AnnotationEditorParamsType.HIGHLIGHT_COLOR,HighlightEditor._defaultColor],[AnnotationEditorParamsType.HIGHLIGHT_THICKNESS,HighlightEditor._defaultThickness]]}get propertiesToUpdate(){return[[AnnotationEditorParamsType.HIGHLIGHT_COLOR,this.color||HighlightEditor._defaultColor],[AnnotationEditorParamsType.HIGHLIGHT_THICKNESS,this.#ha||HighlightEditor._defaultThickness],[AnnotationEditorParamsType.HIGHLIGHT_FREE,this.#za]]}#$r(t){const e=(t,e)=>{this.color=t;this.#Wa=e;this.parent?.drawLayer.updateProperties(this.#w,{root:{fill:t,"fill-opacity":e}});this.#n?.updateColor(t)};const i=this.color;const s=this.#Wa;this.addCommands({cmd:e.bind(this,t,HighlightEditor._defaultOpacity),undo:e.bind(this,i,s),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:true,type:AnnotationEditorParamsType.HIGHLIGHT_COLOR,overwriteIfSameType:true,keepUndo:true});this._reportTelemetry({action:"color_changed",color:this._uiManager.getNonHCMColorName(t)},true)}#Ya(t){const e=this.#ha;const i=t=>{this.#ha=t;this.#Ja(t)};this.addCommands({cmd:i.bind(this,t),undo:i.bind(this,e),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:true,type:AnnotationEditorParamsType.INK_THICKNESS,overwriteIfSameType:true,keepUndo:true});this._reportTelemetry({action:"thickness_changed",thickness:t},true)}get toolbarButtons(){if(this._uiManager.highlightColors){const t=this.#n=new ColorPicker({editor:this});return[["colorPicker",t]]}return super.toolbarButtons}disableEditing(){super.disableEditing();this.div.classList.toggle("disabled",true)}enableEditing(){super.enableEditing();this.div.classList.toggle("disabled",false)}fixAndSetPosition(){return super.fixAndSetPosition(this.#Qa())}getBaseTranslation(){return[0,0]}getRect(t,e){return super.getRect(t,e,this.#Qa())}onceAdded(t){if(!this.annotationElementId){this.parent.addUndoableEditor(this)}if(t){this.div.focus()}}remove(){this.#Za();this._reportTelemetry({action:"deleted"});super.remove()}rebuild(){if(!this.parent){return}super.rebuild();if(this.div===null){return}this.#Ka();if(!this.isAttachedToDOM){this.parent.add(this)}}setParent(t){let e=false;if(this.parent&&!t){this.#Za()}else if(t){this.#Ka(t);e=!this.parent&&this.div?.classList.contains("selectedEditor")}super.setParent(t);this.show(this._isVisible);if(e){this.select()}}#Ja(t){if(!this.#za){return}this.#ja({highlightOutlines:this.#Ga.getNewOutline(t/2)});this.fixAndSetPosition();const[e,i]=this.parentDimensions;this.setDims(this.width*e,this.height*i)}#Za(){if(this.#w===null||!this.parent){return}this.parent.drawLayer.remove(this.#w);this.#w=null;this.parent.drawLayer.remove(this.#$a);this.#$a=null}#Ka(t=this.parent){if(this.#w!==null){return}({id:this.#w,clipPathId:this.#Oa}=t.drawLayer.draw({bbox:this.#Ga.box,root:{viewBox:"0 0 1 1",fill:this.color,"fill-opacity":this.#Wa},rootClass:{highlight:true,free:this.#za},path:{d:this.#Ga.toSVGPath()}},false,true));this.#$a=t.drawLayer.drawOutline({rootClass:{highlightOutline:true,free:this.#za},bbox:this.#Na.box,path:{d:this.#Na.toSVGPath()}},this.#za);if(this.#Ua){this.#Ua.style.clipPath=this.#Oa}}static#qa([t,e,i,s],n){switch(n){case 90:return[1-e-s,t,s,i];case 180:return[1-t-i,1-e-s,i,s];case 270:return[e,1-t-i,s,i]}return[t,e,i,s]}rotate(t){const{drawLayer:e}=this.parent;let i;if(this.#za){t=(t-this.rotation+360)%360;i=HighlightEditor.#qa(this.#Ga.box,t)}else{i=HighlightEditor.#qa([this.x,this.y,this.width,this.height],t)}e.updateProperties(this.#w,{bbox:i,root:{"data-main-rotation":t}});e.updateProperties(this.#$a,{bbox:HighlightEditor.#qa(this.#Na.box,t),root:{"data-main-rotation":t}})}render(){if(this.div){return this.div}const t=super.render();if(this.#oe){t.setAttribute("aria-label",this.#oe);t.setAttribute("role","mark")}if(this.#za){t.classList.add("free")}else{this.div.addEventListener("keydown",this.#to.bind(this),{signal:this._uiManager._signal})}const e=this.#Ua=document.createElement("div");t.append(e);e.setAttribute("aria-hidden","true");e.className="internal";e.style.clipPath=this.#Oa;const[i,s]=this.parentDimensions;this.setDims(this.width*i,this.height*s);bindEvents(this,this.#Ua,["pointerover","pointerleave"]);this.enableEditing();return t}pointerover(){if(!this.isSelected){this.parent?.drawLayer.updateProperties(this.#$a,{rootClass:{hovered:true}})}}pointerleave(){if(!this.isSelected){this.parent?.drawLayer.updateProperties(this.#$a,{rootClass:{hovered:false}})}}#to(t){HighlightEditor._keyboardManager.exec(this,t)}_moveCaret(t){this.parent.unselect(this);switch(t){case 0:case 2:this.#eo(true);break;case 1:case 3:this.#eo(false);break}}#eo(t){if(!this.#Ra){return}const e=window.getSelection();if(t){e.setPosition(this.#Ra,this.#La)}else{e.setPosition(this.#Ba,this.#Ha)}}select(){super.select();if(!this.#$a){return}this.parent?.drawLayer.updateProperties(this.#$a,{rootClass:{hovered:false,selected:true}})}unselect(){super.unselect();if(!this.#$a){return}this.parent?.drawLayer.updateProperties(this.#$a,{rootClass:{selected:false}});if(!this.#za){this.#eo(false)}}get _mustFixPosition(){return!this.#za}show(t=this._isVisible){super.show(t);if(this.parent){this.parent.drawLayer.updateProperties(this.#w,{rootClass:{hidden:!t}});this.parent.drawLayer.updateProperties(this.#$a,{rootClass:{hidden:!t}})}}#Qa(){return this.#za?this.rotation:0}#io(){if(this.#za){return null}const[t,e]=this.pageDimensions;const[i,s]=this.pageTranslation;const n=this.#Fa;const r=new Float32Array(n.length*8);let a=0;for(const{x:o,y:l,width:h,height:c}of n){const n=o*t+i;const d=(1-l)*e+s;r[a]=r[a+4]=n;r[a+1]=r[a+3]=d;r[a+2]=r[a+6]=n+h*t;r[a+5]=r[a+7]=d-c*e;a+=8}return r}#so(t){return this.#Ga.serialize(t,this.#Qa())}static startHighlighting(t,e,{target:i,x:s,y:n}){const{x:r,y:a,width:o,height:l}=i.getBoundingClientRect();const h=new AbortController;const c=t.combinedSignal(h);const d=e=>{h.abort();this.#no(t,e)};window.addEventListener("blur",d,{signal:c});window.addEventListener("pointerup",d,{signal:c});window.addEventListener("pointerdown",stopEvent,{capture:true,passive:false,signal:c});window.addEventListener("contextmenu",noContextMenu,{signal:c});i.addEventListener("pointermove",this.#ro.bind(this,t),{signal:c});this._freeHighlight=new FreeHighlightOutliner({x:s,y:n},[r,a,o,l],t.scale,this._defaultThickness/2,e,.001);({id:this._freeHighlightId,clipPathId:this._freeHighlightClipId}=t.drawLayer.draw({bbox:[0,0,1,1],root:{viewBox:"0 0 1 1",fill:this._defaultColor,"fill-opacity":this._defaultOpacity},rootClass:{highlight:true,free:true},path:{d:this._freeHighlight.toSVGPath()}},true,true))}static#ro(t,e){if(this._freeHighlight.add(e)){t.drawLayer.updateProperties(this._freeHighlightId,{path:{d:this._freeHighlight.toSVGPath()}})}}static#no(t,e){if(!this._freeHighlight.isEmpty()){t.createAndAddNewEditor(e,false,{highlightId:this._freeHighlightId,highlightOutlines:this._freeHighlight.getOutlines(),clipPathId:this._freeHighlightClipId,methodOfCreation:"main_toolbar"})}else{t.drawLayer.remove(this._freeHighlightId)}this._freeHighlightId=-1;this._freeHighlight=null;this._freeHighlightClipId=""}static async deserialize(t,e,i){let s=null;if(t instanceof HighlightAnnotationElement){const{data:{quadPoints:e,rect:i,rotation:n,id:r,color:a,opacity:o,popupRef:l,contentsObj:h},parent:{page:{pageNumber:c}}}=t;s=t={annotationType:AnnotationEditorType.HIGHLIGHT,color:Array.from(a),opacity:o,quadPoints:e,boxes:null,pageIndex:c-1,rect:i.slice(0),rotation:n,annotationElementId:r,id:r,deleted:false,popupRef:l,comment:h?.str||null}}else if(t instanceof InkAnnotationElement){const{data:{inkLists:e,rect:i,rotation:n,id:r,color:a,borderStyle:{rawWidth:o},popupRef:l,contentsObj:h},parent:{page:{pageNumber:c}}}=t;s=t={annotationType:AnnotationEditorType.HIGHLIGHT,color:Array.from(a),thickness:o,inkLists:e,boxes:null,pageIndex:c-1,rect:i.slice(0),rotation:n,annotationElementId:r,id:r,deleted:false,popupRef:l,comment:h?.str||null}}const{color:n,quadPoints:r,inkLists:a,opacity:o}=t;const l=await super.deserialize(t,e,i);l.color=Util.makeHexColor(...n);l.#Wa=o||1;if(a){l.#ha=t.thickness}l._initialData=s;if(t.comment){l.setCommentData(t.comment)}const[h,c]=l.pageDimensions;const[d,u]=l.pageTranslation;if(r){const t=l.#Fa=[];for(let e=0;e<r.length;e+=8){t.push({x:(r[e]-d)/h,y:1-(r[e+1]-u)/c,width:(r[e+2]-r[e])/h,height:(r[e+1]-r[e+5])/c})}l.#Xa();l.#Ka();l.rotate(l.rotation)}else if(a){l.#za=true;const t=a[0];const i={x:t[0]-d,y:c-(t[1]-u)};const s=new FreeHighlightOutliner(i,[0,0,h,c],1,l.#ha/2,true,.001);for(let e=0,n=t.length;e<n;e+=2){i.x=t[e]-d;i.y=c-(t[e+1]-u);s.add(i)}const{id:n,clipPathId:r}=e.drawLayer.draw({bbox:[0,0,1,1],root:{viewBox:"0 0 1 1",fill:l.color,"fill-opacity":l._defaultOpacity},rootClass:{highlight:true,free:true},path:{d:s.toSVGPath()}},true,true);l.#ja({highlightOutlines:s.getOutlines(),highlightId:n,clipPathId:r});l.#Ka();l.rotate(l.parentRotation)}return l}serialize(t=false){if(this.isEmpty()||t){return null}if(this.deleted){return this.serializeDeleted()}const e=this.getPDFRect();const i=AnnotationEditor._colorManager.convert(this._uiManager.getNonHCMColor(this.color));const s={annotationType:AnnotationEditorType.HIGHLIGHT,color:i,opacity:this.#Wa,thickness:this.#ha,quadPoints:this.#io(),outlines:this.#so(e),pageIndex:this.pageIndex,rect:e,rotation:this.#Qa(),structTreeParentId:this._structTreeParentId};this.addComment(s);if(this.annotationElementId&&!this.#Jr(s)){return null}s.id=this.annotationElementId;return s}#Jr(t){const{color:e}=this._initialData;return this.hasEditedComment||t.color.some((t,i)=>t!==e[i])}renderAnnotationElement(t){if(this.deleted){t.hide();return null}const e={rect:this.getPDFRect()};if(this.hasEditedComment){e.popup=this.comment}t.updateEdited(e);return null}static canCreateNewEmptyEditor(){return false}}class DrawingOptions{#ao=Object.create(null);updateProperty(t,e){this[t]=e;this.updateSVGProperty(t,e)}updateProperties(t){if(!t){return}for(const[e,i]of Object.entries(t)){if(!e.startsWith("_")){this.updateProperty(e,i)}}}updateSVGProperty(t,e){this.#ao[t]=e}toSVGProperties(){const t=this.#ao;this.#ao=Object.create(null);return{root:t}}reset(){this.#ao=Object.create(null)}updateAll(t=this){this.updateProperties(t)}clone(){unreachable("Not implemented")}}class DrawingEditor extends AnnotationEditor{#oo=null;#lo;_colorPicker=null;_drawId=null;static _currentDrawId=-1;static _currentParent=null;static#ho=null;static#co=null;static#do=null;static#uo=NaN;static#po=null;static#go=null;static#fo=NaN;static _INNER_MARGIN=3;constructor(t){super(t);this.#lo=t.mustBeCommitted||false;this._addOutlines(t)}_addOutlines(t){if(t.drawOutlines){this.#mo(t);this.#Ka()}}#mo({drawOutlines:t,drawId:e,drawingOptions:i}){this.#oo=t;this._drawingOptions||=i;if(!this.annotationElementId){this._uiManager.a11yAlert(`pdfjs-editor-${this.editorType}-added-alert`)}if(e>=0){this._drawId=e;this.parent.drawLayer.finalizeDraw(e,t.defaultProperties)}else{this._drawId=this.#bo(t,this.parent)}this.#Ao(t.box)}#bo(t,e){const{id:i}=e.drawLayer.draw(DrawingEditor._mergeSVGProperties(this._drawingOptions.toSVGProperties(),t.defaultSVGProperties),false,false);return i}static _mergeSVGProperties(t,e){const i=new Set(Object.keys(t));for(const[s,n]of Object.entries(e)){if(i.has(s)){Object.assign(t[s],n)}else{t[s]=n}}return t}static getDefaultDrawingOptions(t){unreachable("Not implemented")}static get typesMap(){unreachable("Not implemented")}static get isDrawer(){return true}static get supportMultipleDrawings(){return false}static updateDefaultParams(t,e){const i=this.typesMap.get(t);if(i){this._defaultDrawingOptions.updateProperty(i,e)}if(this._currentParent){DrawingEditor.#ho.updateProperty(i,e);this._currentParent.drawLayer.updateProperties(this._currentDrawId,this._defaultDrawingOptions.toSVGProperties())}}updateParams(t,e){const i=this.constructor.typesMap.get(t);if(i){this._updateProperty(t,i,e)}}static get defaultPropertiesToUpdate(){const t=[];const e=this._defaultDrawingOptions;for(const[i,s]of this.typesMap){t.push([i,e[s]])}return t}get propertiesToUpdate(){const t=[];const{_drawingOptions:e}=this;for(const[i,s]of this.constructor.typesMap){t.push([i,e[s]])}return t}_updateProperty(t,e,i){const s=this._drawingOptions;const n=s[e];const r=i=>{s.updateProperty(e,i);const n=this.#oo.updateProperty(e,i);if(n){this.#Ao(n)}this.parent?.drawLayer.updateProperties(this._drawId,s.toSVGProperties());if(t===this.colorType){this._colorPicker?.update(i)}};this.addCommands({cmd:r.bind(this,i),undo:r.bind(this,n),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:true,type:t,overwriteIfSameType:true,keepUndo:true})}_onResizing(){this.parent?.drawLayer.updateProperties(this._drawId,DrawingEditor._mergeSVGProperties(this.#oo.getPathResizingSVGProperties(this.#yo()),{bbox:this.#wo()}))}_onResized(){this.parent?.drawLayer.updateProperties(this._drawId,DrawingEditor._mergeSVGProperties(this.#oo.getPathResizedSVGProperties(this.#yo()),{bbox:this.#wo()}))}_onTranslating(t,e){this.parent?.drawLayer.updateProperties(this._drawId,{bbox:this.#wo()})}_onTranslated(){this.parent?.drawLayer.updateProperties(this._drawId,DrawingEditor._mergeSVGProperties(this.#oo.getPathTranslatedSVGProperties(this.#yo(),this.parentDimensions),{bbox:this.#wo()}))}_onStartDragging(){this.parent?.drawLayer.updateProperties(this._drawId,{rootClass:{moving:true}})}_onStopDragging(){this.parent?.drawLayer.updateProperties(this._drawId,{rootClass:{moving:false}})}commit(){super.commit();this.disableEditMode();this.disableEditing()}disableEditing(){super.disableEditing();this.div.classList.toggle("disabled",true)}enableEditing(){super.enableEditing();this.div.classList.toggle("disabled",false)}getBaseTranslation(){return[0,0]}get isResizable(){return true}onceAdded(t){if(!this.annotationElementId){this.parent.addUndoableEditor(this)}this._isDraggable=true;if(this.#lo){this.#lo=false;this.commit();this.parent.setSelected(this);if(t&&this.isOnScreen){this.div.focus()}}}remove(){this.#Za();super.remove()}rebuild(){if(!this.parent){return}super.rebuild();if(this.div===null){return}this.#Ka();this.#Ao(this.#oo.box);if(!this.isAttachedToDOM){this.parent.add(this)}}setParent(t){let e=false;if(this.parent&&!t){this._uiManager.removeShouldRescale(this);this.#Za()}else if(t){this._uiManager.addShouldRescale(this);this.#Ka(t);e=!this.parent&&this.div?.classList.contains("selectedEditor")}super.setParent(t);if(e){this.select()}}#Za(){if(this._drawId===null||!this.parent){return}this.parent.drawLayer.remove(this._drawId);this._drawId=null;this._drawingOptions.reset()}#Ka(t=this.parent){if(this._drawId!==null&&this.parent===t){return}if(this._drawId!==null){this.parent.drawLayer.updateParent(this._drawId,t.drawLayer);return}this._drawingOptions.updateAll();this._drawId=this.#bo(this.#oo,t)}#Eo([t,e,i,s]){const{parentDimensions:[n,r],rotation:a}=this;switch(a){case 90:return[e,1-t,i*(r/n),s*(n/r)];case 180:return[1-t,1-e,i,s];case 270:return[1-e,t,i*(r/n),s*(n/r)];default:return[t,e,i,s]}}#yo(){const{x:t,y:e,width:i,height:s,parentDimensions:[n,r],rotation:a}=this;switch(a){case 90:return[1-e,t,i*(n/r),s*(r/n)];case 180:return[1-t,1-e,i,s];case 270:return[e,1-t,i*(n/r),s*(r/n)];default:return[t,e,i,s]}}#Ao(t){[this.x,this.y,this.width,this.height]=this.#Eo(t);if(this.div){this.fixAndSetPosition();const[t,e]=this.parentDimensions;this.setDims(this.width*t,this.height*e)}this._onResized()}#wo(){const{x:t,y:e,width:i,height:s,rotation:n,parentRotation:r,parentDimensions:[a,o]}=this;switch((n*4+r)/90){case 1:return[1-e-s,t,s,i];case 2:return[1-t-i,1-e-s,i,s];case 3:return[e,1-t-i,s,i];case 4:return[t,e-i*(a/o),s*(o/a),i*(a/o)];case 5:return[1-e,t,i*(a/o),s*(o/a)];case 6:return[1-t-s*(o/a),1-e,s*(o/a),i*(a/o)];case 7:return[e-i*(a/o),1-t-s*(o/a),i*(a/o),s*(o/a)];case 8:return[t-i,e-s,i,s];case 9:return[1-e,t-i,s,i];case 10:return[1-t,1-e,i,s];case 11:return[e-s,1-t,s,i];case 12:return[t-s*(o/a),e,s*(o/a),i*(a/o)];case 13:return[1-e-i*(a/o),t-s*(o/a),i*(a/o),s*(o/a)];case 14:return[1-t,1-e-i*(a/o),s*(o/a),i*(a/o)];case 15:return[e,1-t,i*(a/o),s*(o/a)];default:return[t,e,i,s]}}rotate(){if(!this.parent){return}this.parent.drawLayer.updateProperties(this._drawId,DrawingEditor._mergeSVGProperties({bbox:this.#wo()},this.#oo.updateRotation((this.parentRotation-this.rotation+360)%360)))}onScaleChanging(){if(!this.parent){return}this.#Ao(this.#oo.updateParentDimensions(this.parentDimensions,this.parent.scale))}static onScaleChangingWhenDrawing(){}render(){if(this.div){return this.div}let t,e;if(this._isCopy){t=this.x;e=this.y}const i=super.render();i.classList.add("draw");const s=document.createElement("div");i.append(s);s.setAttribute("aria-hidden","true");s.className="internal";const[n,r]=this.parentDimensions;this.setDims(this.width*n,this.height*r);this._uiManager.addShouldRescale(this);this.disableEditing();if(this._isCopy){this._moveAfterPaste(t,e)}return i}static createDrawerInstance(t,e,i,s,n){unreachable("Not implemented")}static startDrawing(t,e,i,s){const{target:n,offsetX:r,offsetY:a,pointerId:o,pointerType:l}=s;if(DrawingEditor.#po&&DrawingEditor.#po!==l){return}const{viewport:{rotation:h}}=t;const{width:c,height:d}=n.getBoundingClientRect();const u=DrawingEditor.#co=new AbortController;const p=t.combinedSignal(u);DrawingEditor.#uo||=o;DrawingEditor.#po??=l;window.addEventListener("pointerup",t=>{if(DrawingEditor.#uo===t.pointerId){this._endDraw(t)}else{DrawingEditor.#go?.delete(t.pointerId)}},{signal:p});window.addEventListener("pointercancel",t=>{if(DrawingEditor.#uo===t.pointerId){this._currentParent.endDrawingSession()}else{DrawingEditor.#go?.delete(t.pointerId)}},{signal:p});window.addEventListener("pointerdown",t=>{if(DrawingEditor.#po!==t.pointerType){return}(DrawingEditor.#go||=new Set).add(t.pointerId);if(DrawingEditor.#ho.isCancellable()){DrawingEditor.#ho.removeLastElement();if(DrawingEditor.#ho.isEmpty()){this._currentParent.endDrawingSession(true)}else{this._endDraw(null)}}},{capture:true,passive:false,signal:p});window.addEventListener("contextmenu",noContextMenu,{signal:p});n.addEventListener("pointermove",this._drawMove.bind(this),{signal:p});n.addEventListener("touchmove",t=>{if(t.timeStamp===DrawingEditor.#fo){stopEvent(t)}},{signal:p});t.toggleDrawing();e._editorUndoBar?.hide();if(DrawingEditor.#ho){t.drawLayer.updateProperties(this._currentDrawId,DrawingEditor.#ho.startNew(r,a,c,d,h));return}e.updateUIForDefaultProperties(this);DrawingEditor.#ho=this.createDrawerInstance(r,a,c,d,h);DrawingEditor.#do=this.getDefaultDrawingOptions();this._currentParent=t;({id:this._currentDrawId}=t.drawLayer.draw(this._mergeSVGProperties(DrawingEditor.#do.toSVGProperties(),DrawingEditor.#ho.defaultSVGProperties),true,false))}static _drawMove(t){DrawingEditor.#fo=-1;if(!DrawingEditor.#ho){return}const{offsetX:e,offsetY:i,pointerId:s}=t;if(DrawingEditor.#uo!==s){return}if(DrawingEditor.#go?.size>=1){this._endDraw(t);return}this._currentParent.drawLayer.updateProperties(this._currentDrawId,DrawingEditor.#ho.add(e,i));DrawingEditor.#fo=t.timeStamp;stopEvent(t)}static _cleanup(t){if(t){this._currentDrawId=-1;this._currentParent=null;DrawingEditor.#ho=null;DrawingEditor.#do=null;DrawingEditor.#po=null;DrawingEditor.#fo=NaN}if(DrawingEditor.#co){DrawingEditor.#co.abort();DrawingEditor.#co=null;DrawingEditor.#uo=NaN;DrawingEditor.#go=null}}static _endDraw(t){const e=this._currentParent;if(!e){return}e.toggleDrawing(true);this._cleanup(false);if(t?.target===e.div){e.drawLayer.updateProperties(this._currentDrawId,DrawingEditor.#ho.end(t.offsetX,t.offsetY))}if(this.supportMultipleDrawings){const t=DrawingEditor.#ho;const i=this._currentDrawId;const s=t.getLastElement();e.addCommands({cmd:()=>{e.drawLayer.updateProperties(i,t.setLastElement(s))},undo:()=>{e.drawLayer.updateProperties(i,t.removeLastElement())},mustExec:false,type:AnnotationEditorParamsType.DRAW_STEP});return}this.endDrawing(false)}static endDrawing(t){const e=this._currentParent;if(!e){return null}e.toggleDrawing(true);e.cleanUndoStack(AnnotationEditorParamsType.DRAW_STEP);if(!DrawingEditor.#ho.isEmpty()){const{pageDimensions:[i,s],scale:n}=e;const r=e.createAndAddNewEditor({offsetX:0,offsetY:0},false,{drawId:this._currentDrawId,drawOutlines:DrawingEditor.#ho.getOutlines(i*n,s*n,n,this._INNER_MARGIN),drawingOptions:DrawingEditor.#do,mustBeCommitted:!t});this._cleanup(true);return r}e.drawLayer.remove(this._currentDrawId);this._cleanup(true);return null}createDrawingOptions(t){}static deserializeDraw(t,e,i,s,n,r){unreachable("Not implemented")}static async deserialize(t,e,i){const{rawDims:{pageWidth:s,pageHeight:n,pageX:r,pageY:a}}=e.viewport;const o=this.deserializeDraw(r,a,s,n,this._INNER_MARGIN,t);const l=await super.deserialize(t,e,i);l.createDrawingOptions(t);l.#mo({drawOutlines:o});l.#Ka();l.onScaleChanging();l.rotate();return l}serializeDraw(t){const[e,i]=this.pageTranslation;const[s,n]=this.pageDimensions;return this.#oo.serialize([e,i,s,n],t)}renderAnnotationElement(t){t.updateEdited({rect:this.getPDFRect()});return null}static canCreateNewEmptyEditor(){return false}}class InkDrawOutliner{#sa=new Float64Array(6);#Tr;#vo;#Fs;#ha;#ca;#xo="";#_o=0;#ka=new InkDrawOutline;#To;#So;constructor(t,e,i,s,n,r){this.#To=i;this.#So=s;this.#Fs=n;this.#ha=r;[t,e]=this.#Co(t,e);const a=this.#Tr=[NaN,NaN,NaN,NaN,t,e];this.#ca=[t,e];this.#vo=[{line:a,points:this.#ca}];this.#sa.set(a,0)}updateProperty(t,e){if(t==="stroke-width"){this.#ha=e}}#Co(t,e){return Outline._normalizePoint(t,e,this.#To,this.#So,this.#Fs)}isEmpty(){return!this.#vo||this.#vo.length===0}isCancellable(){return this.#ca.length<=10}add(t,e){[t,e]=this.#Co(t,e);const[i,s,n,r]=this.#sa.subarray(2,6);const a=t-n;const o=e-r;const l=Math.hypot(this.#To*a,this.#So*o);if(l<=2){return null}this.#ca.push(t,e);if(isNaN(i)){this.#sa.set([n,r,t,e],2);this.#Tr.push(NaN,NaN,NaN,NaN,t,e);return{path:{d:this.toSVGPath()}}}if(isNaN(this.#sa[0])){this.#Tr.splice(6,6)}this.#sa.set([i,s,n,r,t,e],0);this.#Tr.push(...Outline.createBezierPoints(i,s,n,r,t,e));return{path:{d:this.toSVGPath()}}}end(t,e){const i=this.add(t,e);if(i){return i}if(this.#ca.length===2){return{path:{d:this.toSVGPath()}}}return null}startNew(t,e,i,s,n){this.#To=i;this.#So=s;this.#Fs=n;[t,e]=this.#Co(t,e);const r=this.#Tr=[NaN,NaN,NaN,NaN,t,e];this.#ca=[t,e];const a=this.#vo.at(-1);if(a){a.line=new Float32Array(a.line);a.points=new Float32Array(a.points)}this.#vo.push({line:r,points:this.#ca});this.#sa.set(r,0);this.#_o=0;this.toSVGPath();return null}getLastElement(){return this.#vo.at(-1)}setLastElement(t){if(!this.#vo){return this.#ka.setLastElement(t)}this.#vo.push(t);this.#Tr=t.line;this.#ca=t.points;this.#_o=0;return{path:{d:this.toSVGPath()}}}removeLastElement(){if(!this.#vo){return this.#ka.removeLastElement()}this.#vo.pop();this.#xo="";for(let t=0,e=this.#vo.length;t<e;t++){const{line:e,points:i}=this.#vo[t];this.#Tr=e;this.#ca=i;this.#_o=0;this.toSVGPath()}return{path:{d:this.#xo}}}toSVGPath(){const t=Outline.svgRound(this.#Tr[4]);const e=Outline.svgRound(this.#Tr[5]);if(this.#ca.length===2){this.#xo=`${this.#xo} M ${t} ${e} Z`;return this.#xo}if(this.#ca.length<=6){const i=this.#xo.lastIndexOf("M");this.#xo=`${this.#xo.slice(0,i)} M ${t} ${e}`;this.#_o=6}if(this.#ca.length===4){const t=Outline.svgRound(this.#Tr[10]);const e=Outline.svgRound(this.#Tr[11]);this.#xo=`${this.#xo} L ${t} ${e}`;this.#_o=12;return this.#xo}const i=[];if(this.#_o===0){i.push(`M ${t} ${e}`);this.#_o=6}for(let t=this.#_o,e=this.#Tr.length;t<e;t+=6){const[e,s,n,r,a,o]=this.#Tr.slice(t,t+6).map(Outline.svgRound);i.push(`C${e} ${s} ${n} ${r} ${a} ${o}`)}this.#xo+=i.join(" ");this.#_o=this.#Tr.length;return this.#xo}getOutlines(t,e,i,s){const n=this.#vo.at(-1);n.line=new Float32Array(n.line);n.points=new Float32Array(n.points);this.#ka.build(this.#vo,t,e,i,this.#Fs,this.#ha,s);this.#sa=null;this.#Tr=null;this.#vo=null;this.#xo=null;return this.#ka}get defaultSVGProperties(){return{root:{viewBox:"0 0 10000 10000"},rootClass:{draw:true},bbox:[0,0,1,1]}}}class InkDrawOutline extends Outline{#Ea;#Do=0;#ta;#vo;#To;#So;#Mo;#Fs;#ha;build(t,e,i,s,n,r,a){this.#To=e;this.#So=i;this.#Mo=s;this.#Fs=n;this.#ha=r;this.#ta=a??0;this.#vo=t;this.#Io()}get thickness(){return this.#ha}setLastElement(t){this.#vo.push(t);return{path:{d:this.toSVGPath()}}}removeLastElement(){this.#vo.pop();return{path:{d:this.toSVGPath()}}}toSVGPath(){const t=[];for(const{line:e}of this.#vo){t.push(`M${Outline.svgRound(e[4])} ${Outline.svgRound(e[5])}`);if(e.length===6){t.push("Z");continue}if(e.length===12&&isNaN(e[6])){t.push(`L${Outline.svgRound(e[10])} ${Outline.svgRound(e[11])}`);continue}for(let i=6,s=e.length;i<s;i+=6){const[s,n,r,a,o,l]=e.subarray(i,i+6).map(Outline.svgRound);t.push(`C${s} ${n} ${r} ${a} ${o} ${l}`)}}return t.join("")}serialize([t,e,i,s],n){const r=[];const a=[];const[o,l,h,c]=this.#Po();let d,u,p,g,f,m,b,A,y;switch(this.#Fs){case 0:y=Outline._rescale;d=t;u=e+s;p=i;g=-s;f=t+o*i;m=e+(1-l-c)*s;b=t+(o+h)*i;A=e+(1-l)*s;break;case 90:y=Outline._rescaleAndSwap;d=t;u=e;p=i;g=s;f=t+l*i;m=e+o*s;b=t+(l+c)*i;A=e+(o+h)*s;break;case 180:y=Outline._rescale;d=t+i;u=e;p=-i;g=s;f=t+(1-o-h)*i;m=e+l*s;b=t+(1-o)*i;A=e+(l+c)*s;break;case 270:y=Outline._rescaleAndSwap;d=t+i;u=e+s;p=-i;g=-s;f=t+(1-l-c)*i;m=e+(1-o-h)*s;b=t+(1-l)*i;A=e+(1-o)*s;break}for(const{line:t,points:e}of this.#vo){r.push(y(t,d,u,p,g,n?new Array(t.length):null));a.push(y(e,d,u,p,g,n?new Array(e.length):null))}return{lines:r,points:a,rect:[f,m,b,A]}}static deserialize(t,e,i,s,n,{paths:{lines:r,points:a},rotation:o,thickness:l}){const h=[];let c,d,u,p,g;switch(o){case 0:g=Outline._rescale;c=-t/i;d=e/s+1;u=1/i;p=-1/s;break;case 90:g=Outline._rescaleAndSwap;c=-e/s;d=-t/i;u=1/s;p=1/i;break;case 180:g=Outline._rescale;c=t/i+1;d=-e/s;u=-1/i;p=1/s;break;case 270:g=Outline._rescaleAndSwap;c=e/s+1;d=t/i+1;u=-1/s;p=-1/i;break}if(!r){r=[];for(const t of a){const e=t.length;if(e===2){r.push(new Float32Array([NaN,NaN,NaN,NaN,t[0],t[1]]));continue}if(e===4){r.push(new Float32Array([NaN,NaN,NaN,NaN,t[0],t[1],NaN,NaN,NaN,NaN,t[2],t[3]]));continue}const i=new Float32Array(3*(e-2));r.push(i);let[s,n,a,o]=t.subarray(0,4);i.set([NaN,NaN,NaN,NaN,s,n],0);for(let r=4;r<e;r+=2){const e=t[r];const l=t[r+1];i.set(Outline.createBezierPoints(s,n,a,o,e,l),(r-2)*3);[s,n,a,o]=[a,o,e,l]}}}for(let t=0,e=r.length;t<e;t++){h.push({line:g(r[t].map(t=>t??NaN),c,d,u,p),points:g(a[t].map(t=>t??NaN),c,d,u,p)})}const f=new this.prototype.constructor;f.build(h,i,s,1,o,l,n);return f}#ko(t=this.#ha){const e=this.#ta+t/2*this.#Mo;return this.#Fs%180===0?[e/this.#To,e/this.#So]:[e/this.#So,e/this.#To]}#Po(){const[t,e,i,s]=this.#Ea;const[n,r]=this.#ko(0);return[t+n,e+r,i-2*n,s-2*r]}#Io(){const t=this.#Ea=new Float32Array([Infinity,Infinity,-Infinity,-Infinity]);for(const{line:e}of this.#vo){if(e.length<=12){for(let i=4,s=e.length;i<s;i+=6){Util.pointBoundingBox(e[i],e[i+1],t)}continue}let i=e[4],s=e[5];for(let n=6,r=e.length;n<r;n+=6){const[r,a,o,l,h,c]=e.subarray(n,n+6);Util.bezierBoundingBox(i,s,r,a,o,l,h,c,t);i=h;s=c}}const[e,i]=this.#ko();t[0]=MathClamp(t[0]-e,0,1);t[1]=MathClamp(t[1]-i,0,1);t[2]=MathClamp(t[2]+e,0,1);t[3]=MathClamp(t[3]+i,0,1);t[2]-=t[0];t[3]-=t[1]}get box(){return this.#Ea}updateProperty(t,e){if(t==="stroke-width"){return this.#Ya(e)}return null}#Ya(t){const[e,i]=this.#ko();this.#ha=t;const[s,n]=this.#ko();const[r,a]=[s-e,n-i];const o=this.#Ea;o[0]-=r;o[1]-=a;o[2]+=2*r;o[3]+=2*a;return o}updateParentDimensions([t,e],i){const[s,n]=this.#ko();this.#To=t;this.#So=e;this.#Mo=i;const[r,a]=this.#ko();const o=r-s;const l=a-n;const h=this.#Ea;h[0]-=o;h[1]-=l;h[2]+=2*o;h[3]+=2*l;return h}updateRotation(t){this.#Do=t;return{path:{transform:this.rotationTransform}}}get viewBox(){return this.#Ea.map(Outline.svgRound).join(" ")}get defaultProperties(){const[t,e]=this.#Ea;return{root:{viewBox:this.viewBox},path:{"transform-origin":`${Outline.svgRound(t)} ${Outline.svgRound(e)}`}}}get rotationTransform(){const[,,t,e]=this.#Ea;let i=0,s=0,n=0,r=0,a=0,o=0;switch(this.#Do){case 90:s=e/t;n=-t/e;a=t;break;case 180:i=-1;r=-1;a=t;o=e;break;case 270:s=-e/t;n=t/e;o=e;break;default:return""}return`matrix(${i} ${s} ${n} ${r} ${Outline.svgRound(a)} ${Outline.svgRound(o)})`}getPathResizingSVGProperties([t,e,i,s]){const[n,r]=this.#ko();const[a,o,l,h]=this.#Ea;if(Math.abs(l-n)<=Outline.PRECISION||Math.abs(h-r)<=Outline.PRECISION){const n=t+i/2-(a+l/2);const r=e+s/2-(o+h/2);return{path:{"transform-origin":`${Outline.svgRound(t)} ${Outline.svgRound(e)}`,transform:`${this.rotationTransform} translate(${n} ${r})`}}}const c=(i-2*n)/(l-2*n);const d=(s-2*r)/(h-2*r);const u=l/i;const p=h/s;return{path:{"transform-origin":`${Outline.svgRound(a)} ${Outline.svgRound(o)}`,transform:`${this.rotationTransform} scale(${u} ${p}) `+`translate(${Outline.svgRound(n)} ${Outline.svgRound(r)}) scale(${c} ${d}) `+`translate(${Outline.svgRound(-n)} ${Outline.svgRound(-r)})`}}}getPathResizedSVGProperties([t,e,i,s]){const[n,r]=this.#ko();const a=this.#Ea;const[o,l,h,c]=a;a[0]=t;a[1]=e;a[2]=i;a[3]=s;if(Math.abs(h-n)<=Outline.PRECISION||Math.abs(c-r)<=Outline.PRECISION){const n=t+i/2-(o+h/2);const r=e+s/2-(l+c/2);for(const{line:t,points:e}of this.#vo){Outline._translate(t,n,r,t);Outline._translate(e,n,r,e)}return{root:{viewBox:this.viewBox},path:{"transform-origin":`${Outline.svgRound(t)} ${Outline.svgRound(e)}`,transform:this.rotationTransform||null,d:this.toSVGPath()}}}const d=(i-2*n)/(h-2*n);const u=(s-2*r)/(c-2*r);const p=-d*(o+n)+t+n;const g=-u*(l+r)+e+r;if(d!==1||u!==1||p!==0||g!==0){for(const{line:t,points:e}of this.#vo){Outline._rescale(t,p,g,d,u,t);Outline._rescale(e,p,g,d,u,e)}}return{root:{viewBox:this.viewBox},path:{"transform-origin":`${Outline.svgRound(t)} ${Outline.svgRound(e)}`,transform:this.rotationTransform||null,d:this.toSVGPath()}}}getPathTranslatedSVGProperties([t,e],i){const[s,n]=i;const r=this.#Ea;const a=t-r[0];const o=e-r[1];if(this.#To===s&&this.#So===n){for(const{line:t,points:e}of this.#vo){Outline._translate(t,a,o,t);Outline._translate(e,a,o,e)}}else{const t=this.#To/s;const e=this.#So/n;this.#To=s;this.#So=n;for(const{line:i,points:s}of this.#vo){Outline._rescale(i,a,o,t,e,i);Outline._rescale(s,a,o,t,e,s)}r[2]*=t;r[3]*=e}r[0]=t;r[1]=e;return{root:{viewBox:this.viewBox},path:{d:this.toSVGPath(),"transform-origin":`${Outline.svgRound(t)} ${Outline.svgRound(e)}`}}}get defaultSVGProperties(){const t=this.#Ea;return{root:{viewBox:this.viewBox},rootClass:{draw:true},path:{d:this.toSVGPath(),"transform-origin":`${Outline.svgRound(t[0])} ${Outline.svgRound(t[1])}`,transform:this.rotationTransform||null},bbox:t}}}class InkDrawingOptions extends DrawingOptions{constructor(t){super();this._viewParameters=t;super.updateProperties({fill:"none",stroke:AnnotationEditor._defaultLineColor,"stroke-opacity":1,"stroke-width":1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-miterlimit":10})}updateSVGProperty(t,e){if(t==="stroke-width"){e??=this["stroke-width"];e*=this._viewParameters.realScale}super.updateSVGProperty(t,e)}clone(){const t=new InkDrawingOptions(this._viewParameters);t.updateAll(this);return t}}class InkEditor extends DrawingEditor{static _type="ink";static _editorType=AnnotationEditorType.INK;static _defaultDrawingOptions=null;constructor(t){super({...t,name:"inkEditor"});this._willKeepAspectRatio=true;this.defaultL10nId="pdfjs-editor-ink-editor"}static initialize(t,e){AnnotationEditor.initialize(t,e);this._defaultDrawingOptions=new InkDrawingOptions(e.viewParameters)}static getDefaultDrawingOptions(t){const e=this._defaultDrawingOptions.clone();e.updateProperties(t);return e}static get supportMultipleDrawings(){return true}static get typesMap(){return shadow(this,"typesMap",new Map([[AnnotationEditorParamsType.INK_THICKNESS,"stroke-width"],[AnnotationEditorParamsType.INK_COLOR,"stroke"],[AnnotationEditorParamsType.INK_OPACITY,"stroke-opacity"]]))}static createDrawerInstance(t,e,i,s,n){return new InkDrawOutliner(t,e,i,s,n,this._defaultDrawingOptions["stroke-width"])}static deserializeDraw(t,e,i,s,n,r){return InkDrawOutline.deserialize(t,e,i,s,n,r)}static async deserialize(t,e,i){let s=null;if(t instanceof InkAnnotationElement){const{data:{inkLists:e,rect:i,rotation:n,id:r,color:a,opacity:o,borderStyle:{rawWidth:l},popupRef:h,contentsObj:c},parent:{page:{pageNumber:d}}}=t;s=t={annotationType:AnnotationEditorType.INK,color:Array.from(a),thickness:l,opacity:o,paths:{points:e},boxes:null,pageIndex:d-1,rect:i.slice(0),rotation:n,annotationElementId:r,id:r,deleted:false,popupRef:h,comment:c?.str||null}}const n=await super.deserialize(t,e,i);n._initialData=s;if(t.comment){n.setCommentData(t.comment)}return n}get toolbarButtons(){this._colorPicker||=new BasicColorPicker(this);return[["colorPicker",this._colorPicker]]}get colorType(){return AnnotationEditorParamsType.INK_COLOR}get colorValue(){return this._drawingOptions.stroke}onScaleChanging(){if(!this.parent){return}super.onScaleChanging();const{_drawId:t,_drawingOptions:e,parent:i}=this;e.updateSVGProperty("stroke-width");i.drawLayer.updateProperties(t,e.toSVGProperties())}static onScaleChangingWhenDrawing(){const t=this._currentParent;if(!t){return}super.onScaleChangingWhenDrawing();this._defaultDrawingOptions.updateSVGProperty("stroke-width");t.drawLayer.updateProperties(this._currentDrawId,this._defaultDrawingOptions.toSVGProperties())}createDrawingOptions({color:t,thickness:e,opacity:i}){this._drawingOptions=InkEditor.getDefaultDrawingOptions({stroke:Util.makeHexColor(...t),"stroke-width":e,"stroke-opacity":i})}serialize(t=false){if(this.isEmpty()){return null}if(this.deleted){return this.serializeDeleted()}const{lines:e,points:i,rect:s}=this.serializeDraw(t);const{_drawingOptions:{stroke:n,"stroke-opacity":r,"stroke-width":a}}=this;const o={annotationType:AnnotationEditorType.INK,color:AnnotationEditor._colorManager.convert(n),opacity:r,thickness:a,paths:{lines:e,points:i},pageIndex:this.pageIndex,rect:s,rotation:this.rotation,structTreeParentId:this._structTreeParentId};this.addComment(o);if(t){o.isCopy=true;return o}if(this.annotationElementId&&!this.#Jr(o)){return null}o.id=this.annotationElementId;return o}#Jr(t){const{color:e,thickness:i,opacity:s,pageIndex:n}=this._initialData;return this.hasEditedComment||this._hasBeenMoved||this._hasBeenResized||t.color.some((t,i)=>t!==e[i])||t.thickness!==i||t.opacity!==s||t.pageIndex!==n}renderAnnotationElement(t){if(this.deleted){t.hide();return null}const{points:e,rect:i}=this.serializeDraw(false);const s={rect:i,thickness:this._drawingOptions["stroke-width"],points:e};if(this.hasEditedComment){s.popup=this.comment}t.updateEdited(s);return null}}class ContourDrawOutline extends InkDrawOutline{toSVGPath(){let t=super.toSVGPath();if(!t.endsWith("Z")){t+="Z"}return t}}const BASE_HEADER_LENGTH=8;const POINTS_PROPERTIES_NUMBER=3;class SignatureExtractor{static#Ro={maxDim:512,sigmaSFactor:.02,sigmaR:25,kernelSize:16};static#Lo(t,e,i,s){i-=t;s-=e;if(i===0){return s>0?0:4}if(i===1){return s+6}return 2-s}static#Fo=new Int32Array([0,1,-1,1,-1,0,-1,-1,0,-1,1,-1,1,0,1,1]);static#Oo(t,e,i,s,n,r,a){const o=this.#Lo(i,s,n,r);for(let n=0;n<8;n++){const r=(-n+o-a+16)%8;const l=this.#Fo[2*r];const h=this.#Fo[2*r+1];if(t[(i+l)*e+(s+h)]!==0){return r}}return-1}static#No(t,e,i,s,n,r,a){const o=this.#Lo(i,s,n,r);for(let n=0;n<8;n++){const r=(n+o+a+16)%8;const l=this.#Fo[2*r];const h=this.#Fo[2*r+1];if(t[(i+l)*e+(s+h)]!==0){return r}}return-1}static#Bo(t,e,i,s){const n=t.length;const r=new Int32Array(n);for(let e=0;e<n;e++){r[e]=t[e]<=s?1:0}for(let t=1;t<i-1;t++){r[t*e]=r[t*e+e-1]=0}for(let t=0;t<e;t++){r[t]=r[e*i-1-t]=0}let a=1;let o;const l=[];for(let t=1;t<i-1;t++){o=1;for(let i=1;i<e-1;i++){const s=t*e+i;const n=r[s];if(n===0){continue}let h=t;let c=i;if(n===1&&r[s-1]===0){a+=1;c-=1}else if(n>=1&&r[s+1]===0){a+=1;c+=1;if(n>1){o=n}}else{if(n!==1){o=Math.abs(n)}continue}const d=[i,t];const u=c===i+1;const p={isHole:u,points:d,id:a,parent:0};l.push(p);let g;for(const t of l){if(t.id===o){g=t;break}}if(!g){p.parent=u?o:0}else if(g.isHole){p.parent=u?g.parent:o}else{p.parent=u?o:g.parent}const f=this.#Oo(r,e,t,i,h,c,0);if(f===-1){r[s]=-a;if(r[s]!==1){o=Math.abs(r[s])}continue}let m=this.#Fo[2*f];let b=this.#Fo[2*f+1];const A=t+m;const y=i+b;h=A;c=y;let w=t;let E=i;while(true){const n=this.#No(r,e,w,E,h,c,1);m=this.#Fo[2*n];b=this.#Fo[2*n+1];const l=w+m;const u=E+b;d.push(u,l);const p=w*e+E;if(r[p+1]===0){r[p]=-a}else if(r[p]===1){r[p]=a}if(l===t&&u===i&&w===A&&E===y){if(r[s]!==1){o=Math.abs(r[s])}break}else{h=w;c=E;w=l;E=u}}}}return l}static#Ho(t,e,i,s){if(i-e<=4){for(let n=e;n<i-2;n+=2){s.push(t[n],t[n+1])}return}const n=t[e];const r=t[e+1];const a=t[i-4]-n;const o=t[i-3]-r;const l=Math.hypot(a,o);const h=a/l;const c=o/l;const d=h*r-c*n;const u=o/a;const p=1/l;const g=Math.atan(u);const f=Math.cos(g);const m=Math.sin(g);const b=p*(Math.abs(f)+Math.abs(m));const A=p*(1-b+b**2);const y=Math.max(Math.atan(Math.abs(m+f)*A),Math.atan(Math.abs(m-f)*A));let w=0;let E=e;for(let s=e+2;s<i-2;s+=2){const e=Math.abs(d-h*t[s+1]+c*t[s]);if(e>w){E=s;w=e}}if(w>(l*y)**2){this.#Ho(t,e,E+2,s);this.#Ho(t,E,i,s)}else{s.push(n,r)}}static#Uo(t){const e=[];const i=t.length;this.#Ho(t,0,i,e);e.push(t[i-2],t[i-1]);return e.length<=4?null:e}static#Go(t,e,i,s,n,r){const a=new Float32Array(r**2);const o=-2*s**2;const l=r>>1;for(let t=0;t<r;t++){const e=(t-l)**2;for(let i=0;i<r;i++){a[t*r+i]=Math.exp((e+(i-l)**2)/o)}}const h=new Float32Array(256);const c=-2*n**2;for(let t=0;t<256;t++){h[t]=Math.exp(t**2/c)}const d=t.length;const u=new Uint8Array(d);const p=new Uint32Array(256);for(let s=0;s<i;s++){for(let n=0;n<e;n++){const o=s*e+n;const c=t[o];let d=0;let g=0;for(let o=0;o<r;o++){const u=s+o-l;if(u<0||u>=i){continue}for(let i=0;i<r;i++){const s=n+i-l;if(s<0||s>=e){continue}const p=t[u*e+s];const f=a[o*r+i]*h[Math.abs(p-c)];d+=p*f;g+=f}}const f=u[o]=Math.round(d/g);p[f]++}}return[u,p]}static#zo(t){const e=new Uint32Array(256);for(const i of t){e[i]++}return e}static#Wo(t){const e=t.length;const i=new Uint8ClampedArray(e>>2);let s=-Infinity;let n=Infinity;for(let e=0,r=i.length;e<r;e++){const r=i[e]=t[e<<2];s=Math.max(s,r);n=Math.min(n,r)}const r=255/(s-n);for(let t=0,e=i.length;t<e;t++){i[t]=(i[t]-n)*r}return i}static#$o(t){let e;let i=-Infinity;let s=-Infinity;const n=t.findIndex(t=>t!==0);let r=n;let a=n;for(e=n;e<256;e++){const n=t[e];if(n>i){if(e-r>s){s=e-r;a=e-1}i=n;r=e}}for(e=a-1;e>=0;e--){if(t[e]>t[e+1]){break}}return e}static#Vo(t){const e=t;const{width:i,height:s}=t;const{maxDim:n}=this.#Ro;let r=i;let a=s;if(i>n||s>n){let o=i;let l=s;let h=Math.log2(Math.max(i,s)/n);const c=Math.floor(h);h=h===c?c-1:c;for(let i=0;i<h;i++){r=Math.ceil(o/2);a=Math.ceil(l/2);const i=new OffscreenCanvas(r,a);const s=i.getContext("2d");s.drawImage(t,0,0,o,l,0,0,r,a);o=r;l=a;if(t!==e){t.close()}t=i.transferToImageBitmap()}const d=Math.min(n/r,n/a);r=Math.round(r*d);a=Math.round(a*d)}const o=new OffscreenCanvas(r,a);const l=o.getContext("2d",{willReadFrequently:true});l.fillStyle="white";l.fillRect(0,0,r,a);l.filter="grayscale(1)";l.drawImage(t,0,0,t.width,t.height,0,0,r,a);const h=l.getImageData(0,0,r,a).data;const c=this.#Wo(h);return[c,r,a]}static extractContoursFromText(t,{fontFamily:e,fontStyle:i,fontWeight:s},n,r,a,o){let l=new OffscreenCanvas(1,1);let h=l.getContext("2d",{alpha:false});const c=200;const d=h.font=`${i} ${s} ${c}px ${e}`;const{actualBoundingBoxLeft:u,actualBoundingBoxRight:p,actualBoundingBoxAscent:g,actualBoundingBoxDescent:f,fontBoundingBoxAscent:m,fontBoundingBoxDescent:b,width:A}=h.measureText(t);const y=1.5;const w=Math.ceil(Math.max(Math.abs(u)+Math.abs(p)||0,A)*y);const E=Math.ceil(Math.max(Math.abs(g)+Math.abs(f)||c,Math.abs(m)+Math.abs(b)||c)*y);l=new OffscreenCanvas(w,E);h=l.getContext("2d",{alpha:true,willReadFrequently:true});h.font=d;h.filter="grayscale(1)";h.fillStyle="white";h.fillRect(0,0,w,E);h.fillStyle="black";h.fillText(t,w*(y-1)/2,E*(3-y)/2);const v=this.#Wo(h.getImageData(0,0,w,E).data);const x=this.#zo(v);const _=this.#$o(x);const T=this.#Bo(v,w,E,_);return this.processDrawnLines({lines:{curves:T,width:w,height:E},pageWidth:n,pageHeight:r,rotation:a,innerMargin:o,mustSmooth:true,areContours:true})}static process(t,e,i,s,n){const[r,a,o]=this.#Vo(t);const[l,h]=this.#Go(r,a,o,Math.hypot(a,o)*this.#Ro.sigmaSFactor,this.#Ro.sigmaR,this.#Ro.kernelSize);const c=this.#$o(h);const d=this.#Bo(l,a,o,c);return this.processDrawnLines({lines:{curves:d,width:a,height:o},pageWidth:e,pageHeight:i,rotation:s,innerMargin:n,mustSmooth:true,areContours:true})}static processDrawnLines({lines:t,pageWidth:e,pageHeight:i,rotation:s,innerMargin:n,mustSmooth:r,areContours:a}){if(s%180!==0){[e,i]=[i,e]}const{curves:o,width:l,height:h}=t;const c=t.thickness??0;const d=[];const u=Math.min(e/l,i/h);const p=u/e;const g=u/i;const f=[];for(const{points:t}of o){const e=r?this.#Uo(t):t;if(!e){continue}f.push(e);const i=e.length;const s=new Float32Array(i);const n=new Float32Array(3*(i===2?2:i-2));d.push({line:n,points:s});if(i===2){s[0]=e[0]*p;s[1]=e[1]*g;n.set([NaN,NaN,NaN,NaN,s[0],s[1]],0);continue}let[a,o,l,h]=e;a*=p;o*=g;l*=p;h*=g;s.set([a,o,l,h],0);n.set([NaN,NaN,NaN,NaN,a,o],0);for(let t=4;t<i;t+=2){const i=s[t]=e[t]*p;const r=s[t+1]=e[t+1]*g;n.set(Outline.createBezierPoints(a,o,l,h,i,r),(t-2)*3);[a,o,l,h]=[l,h,i,r]}}if(d.length===0){return null}const m=a?new ContourDrawOutline:new InkDrawOutline;m.build(d,e,i,1,s,a?0:c,n);return{outline:m,newCurves:f,areContours:a,thickness:c,width:l,height:h}}static async compressSignature({outlines:t,areContours:e,thickness:i,width:s,height:n}){let r=Infinity;let a=-Infinity;let o=0;for(const e of t){o+=e.length;for(let t=2,i=e.length;t<i;t++){const i=e[t]-e[t-2];r=Math.min(r,i);a=Math.max(a,i)}}let l;if(r>=-128&&a<=127){l=Int8Array}else if(r>=-32768&&a<=32767){l=Int16Array}else{l=Int32Array}const h=t.length;const c=BASE_HEADER_LENGTH+POINTS_PROPERTIES_NUMBER*h;const d=new Uint32Array(c);let u=0;d[u++]=c*Uint32Array.BYTES_PER_ELEMENT+(o-2*h)*l.BYTES_PER_ELEMENT;d[u++]=0;d[u++]=s;d[u++]=n;d[u++]=e?0:1;d[u++]=Math.max(0,Math.floor(i??0));d[u++]=h;d[u++]=l.BYTES_PER_ELEMENT;for(const e of t){d[u++]=e.length-2;d[u++]=e[0];d[u++]=e[1]}const p=new CompressionStream("deflate-raw");const g=p.writable.getWriter();await g.ready;g.write(d);const f=l.prototype.constructor;for(const e of t){const t=new f(e.length-2);for(let i=2,s=e.length;i<s;i++){t[i-2]=e[i]-e[i-2]}g.write(t)}g.close();const m=await new Response(p.readable).arrayBuffer();const b=new Uint8Array(m);return toBase64Util(b)}static async decompressSignature(t){try{const e=fromBase64Util(t);const{readable:i,writable:s}=new DecompressionStream("deflate-raw");const n=s.getWriter();await n.ready;n.write(e).then(async()=>{await n.ready;await n.close()}).catch(()=>{});let r=null;let a=0;for await(const t of i){r||=new Uint8Array(new Uint32Array(t.buffer,0,4)[0]);r.set(t,a);a+=t.length}const o=new Uint32Array(r.buffer,0,r.length>>2);const l=o[1];if(l!==0){throw new Error(`Invalid version: 1.141.0`)}const h=o[2];const c=o[3];const d=o[4]===0;const u=o[5];const p=o[6];const g=o[7];const f=[];const m=(BASE_HEADER_LENGTH+POINTS_PROPERTIES_NUMBER*p)*Uint32Array.BYTES_PER_ELEMENT;let b;switch(g){case Int8Array.BYTES_PER_ELEMENT:b=new Int8Array(r.buffer,m);break;case Int16Array.BYTES_PER_ELEMENT:b=new Int16Array(r.buffer,m);break;case Int32Array.BYTES_PER_ELEMENT:b=new Int32Array(r.buffer,m);break}a=0;for(let t=0;t<p;t++){const e=o[POINTS_PROPERTIES_NUMBER*t+BASE_HEADER_LENGTH];const i=new Float32Array(e+2);f.push(i);for(let e=0;e<POINTS_PROPERTIES_NUMBER-1;e++){i[e]=o[POINTS_PROPERTIES_NUMBER*t+BASE_HEADER_LENGTH+e+1]}for(let t=0;t<e;t++){i[t+2]=i[t]+b[a++]}}return{areContours:d,thickness:u,outlines:f,width:h,height:c}}catch(t){warn(`decompressSignature: ${t}`);return null}}}class SignatureOptions extends DrawingOptions{constructor(){super();super.updateProperties({fill:AnnotationEditor._defaultLineColor,"stroke-width":0})}clone(){const t=new SignatureOptions;t.updateAll(this);return t}}class DrawnSignatureOptions extends InkDrawingOptions{constructor(t){super(t);super.updateProperties({stroke:AnnotationEditor._defaultLineColor,"stroke-width":1})}clone(){const t=new DrawnSignatureOptions(this._viewParameters);t.updateAll(this);return t}}class SignatureEditor extends DrawingEditor{#jo=false;#Ko=null;#Xo=null;#qo=null;static _type="signature";static _editorType=AnnotationEditorType.SIGNATURE;static _defaultDrawingOptions=null;constructor(t){super({...t,mustBeCommitted:true,name:"signatureEditor"});this._willKeepAspectRatio=true;this.#Xo=t.signatureData||null;this.#Ko=null;this.defaultL10nId="pdfjs-editor-signature-editor1"}static initialize(t,e){AnnotationEditor.initialize(t,e);this._defaultDrawingOptions=new SignatureOptions;this._defaultDrawnSignatureOptions=new DrawnSignatureOptions(e.viewParameters)}static getDefaultDrawingOptions(t){const e=this._defaultDrawingOptions.clone();e.updateProperties(t);return e}static get supportMultipleDrawings(){return false}static get typesMap(){return shadow(this,"typesMap",new Map)}static get isDrawer(){return false}get telemetryFinalData(){return{type:"signature",hasDescription:!!this.#Ko}}static computeTelemetryFinalData(t){const e=t.get("hasDescription");return{hasAltText:e.get(true)??0,hasNoAltText:e.get(false)??0}}get isResizable(){return true}onScaleChanging(){if(this._drawId===null){return}super.onScaleChanging()}render(){if(this.div){return this.div}let t,e;const{_isCopy:i}=this;if(i){this._isCopy=false;t=this.x;e=this.y}super.render();if(this._drawId===null){if(this.#Xo){const{lines:t,mustSmooth:e,areContours:i,description:s,uuid:n,heightInPage:r}=this.#Xo;const{rawDims:{pageWidth:a,pageHeight:o},rotation:l}=this.parent.viewport;const h=SignatureExtractor.processDrawnLines({lines:t,pageWidth:a,pageHeight:o,rotation:l,innerMargin:SignatureEditor._INNER_MARGIN,mustSmooth:e,areContours:i});this.addSignature(h,r,s,n)}else{this.div.setAttribute("data-l10n-args",JSON.stringify({description:""}));this.div.hidden=true;this._uiManager.getSignature(this)}}else{this.div.setAttribute("data-l10n-args",JSON.stringify({description:this.#Ko||""}))}if(i){this._isCopy=true;this._moveAfterPaste(t,e)}return this.div}setUuid(t){this.#qo=t;this.addEditToolbar()}getUuid(){return this.#qo}get description(){return this.#Ko}set description(t){this.#Ko=t;if(!this.div){return}this.div.setAttribute("data-l10n-args",JSON.stringify({description:t}));super.addEditToolbar().then(e=>{e?.updateEditSignatureButton(t)})}getSignaturePreview(){const{newCurves:t,areContours:e,thickness:i,width:s,height:n}=this.#Xo;const r=Math.max(s,n);const a=SignatureExtractor.processDrawnLines({lines:{curves:t.map(t=>({points:t})),thickness:i,width:s,height:n},pageWidth:r,pageHeight:r,rotation:0,innerMargin:0,mustSmooth:false,areContours:e});return{areContours:e,outline:a.outline}}get toolbarButtons(){if(this._uiManager.signatureManager){return[["editSignature",this._uiManager.signatureManager]]}return super.toolbarButtons}addSignature(t,e,i,s){const{x:n,y:r}=this;const{outline:a}=this.#Xo=t;this.#jo=a instanceof ContourDrawOutline;this.description=i;let o;if(this.#jo){o=SignatureEditor.getDefaultDrawingOptions()}else{o=SignatureEditor._defaultDrawnSignatureOptions.clone();o.updateProperties({"stroke-width":a.thickness})}this._addOutlines({drawOutlines:a,drawingOptions:o});const[l,h]=this.parentDimensions;const[,c]=this.pageDimensions;let d=e/c;d=d>=1?.5:d;this.width*=d/this.height;if(this.width>=1){d*=.9/this.width;this.width=.9}this.height=d;this.setDims(l*this.width,h*this.height);this.x=n;this.y=r;this.center();this._onResized();this.onScaleChanging();this.rotate();this._uiManager.addToAnnotationStorage(this);this.setUuid(s);this._reportTelemetry({action:"pdfjs.signature.inserted",data:{hasBeenSaved:!!s,hasDescription:!!i}});this.div.hidden=false}getFromImage(t){const{rawDims:{pageWidth:e,pageHeight:i},rotation:s}=this.parent.viewport;return SignatureExtractor.process(t,e,i,s,SignatureEditor._INNER_MARGIN)}getFromText(t,e){const{rawDims:{pageWidth:i,pageHeight:s},rotation:n}=this.parent.viewport;return SignatureExtractor.extractContoursFromText(t,e,i,s,n,SignatureEditor._INNER_MARGIN)}getDrawnSignature(t){const{rawDims:{pageWidth:e,pageHeight:i},rotation:s}=this.parent.viewport;return SignatureExtractor.processDrawnLines({lines:t,pageWidth:e,pageHeight:i,rotation:s,innerMargin:SignatureEditor._INNER_MARGIN,mustSmooth:false,areContours:false})}createDrawingOptions({areContours:t,thickness:e}){if(t){this._drawingOptions=SignatureEditor.getDefaultDrawingOptions()}else{this._drawingOptions=SignatureEditor._defaultDrawnSignatureOptions.clone();this._drawingOptions.updateProperties({"stroke-width":e})}}serialize(t=false){if(this.isEmpty()){return null}const{lines:e,points:i,rect:s}=this.serializeDraw(t);const{_drawingOptions:{"stroke-width":n}}=this;const r={annotationType:AnnotationEditorType.SIGNATURE,isSignature:true,areContours:this.#jo,color:[0,0,0],thickness:this.#jo?0:n,pageIndex:this.pageIndex,rect:s,rotation:this.rotation,structTreeParentId:this._structTreeParentId};this.addComment(r);if(t){r.paths={lines:e,points:i};r.uuid=this.#qo;r.isCopy=true}else{r.lines=e}if(this.#Ko){r.accessibilityData={type:"Figure",alt:this.#Ko}}return r}static deserializeDraw(t,e,i,s,n,r){if(r.areContours){return ContourDrawOutline.deserialize(t,e,i,s,n,r)}return InkDrawOutline.deserialize(t,e,i,s,n,r)}static async deserialize(t,e,i){const s=await super.deserialize(t,e,i);s.#jo=t.areContours;s.description=t.accessibilityData?.alt||"";s.#qo=t.uuid;return s}}class StampEditor extends AnnotationEditor{#Yo=null;#Jo=null;#Qo=null;#Zo=null;#tl=null;#el="";#il=null;#sl=false;#nl=null;#rl=false;#al=false;static _type="stamp";static _editorType=AnnotationEditorType.STAMP;constructor(t){super({...t,name:"stampEditor"});this.#Zo=t.bitmapUrl;this.#tl=t.bitmapFile;this.defaultL10nId="pdfjs-editor-stamp-editor"}static initialize(t,e){AnnotationEditor.initialize(t,e)}static isHandlingMimeForPasting(t){return SupportedImageMimeTypes.includes(t)}static paste(t,e){e.pasteEditor({mode:AnnotationEditorType.STAMP},{bitmapFile:t.getAsFile()})}altTextFinish(){if(this._uiManager.useNewAltTextFlow){this.div.hidden=false}super.altTextFinish()}get telemetryFinalData(){return{type:"stamp",hasAltText:!!this.altTextData?.altText}}static computeTelemetryFinalData(t){const e=t.get("hasAltText");return{hasAltText:e.get(true)??0,hasNoAltText:e.get(false)??0}}#ol(t,e=false){if(!t){this.remove();return}this.#Yo=t.bitmap;if(!e){this.#Jo=t.id;this.#rl=t.isSvg}if(t.file){this.#el=t.file.name}this.#ll()}#hl(){this.#Qo=null;this._uiManager.enableWaiting(false);if(!this.#il){return}if(this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&this.#Yo){this.addEditToolbar().then(()=>{this._editToolbar.hide();this._uiManager.editAltText(this,true)});return}if(!this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&this.#Yo){this._reportTelemetry({action:"pdfjs.image.image_added",data:{alt_text_modal:false,alt_text_type:"empty"}});try{this.mlGuessAltText()}catch{}}this.div.focus()}async mlGuessAltText(t=null,e=true){if(this.hasAltTextData()){return null}const{mlManager:i}=this._uiManager;if(!i){throw new Error("No ML.")}if(!await i.isEnabledFor("altText")){throw new Error("ML isn't enabled for alt text.")}const{data:s,width:n,height:r}=t||this.copyCanvas(null,null,true).imageData;const a=await i.guess({name:"altText",request:{data:s,width:n,height:r,channels:s.length/(n*r)}});if(!a){throw new Error("No response from the AI service.")}if(a.error){throw new Error("Error from the AI service.")}if(a.cancel){return null}if(!a.output){throw new Error("No valid response from the AI service.")}const o=a.output;await this.setGuessedAltText(o);if(e&&!this.hasAltTextData()){this.altTextData={alt:o,decorative:false}}return o}#cl(){if(this.#Jo){this._uiManager.enableWaiting(true);this._uiManager.imageManager.getFromId(this.#Jo).then(t=>this.#ol(t,true)).finally(()=>this.#hl());return}if(this.#Zo){const t=this.#Zo;this.#Zo=null;this._uiManager.enableWaiting(true);this.#Qo=this._uiManager.imageManager.getFromUrl(t).then(t=>this.#ol(t)).finally(()=>this.#hl());return}if(this.#tl){const t=this.#tl;this.#tl=null;this._uiManager.enableWaiting(true);this.#Qo=this._uiManager.imageManager.getFromFile(t).then(t=>this.#ol(t)).finally(()=>this.#hl());return}const t=document.createElement("input");t.type="file";t.accept=SupportedImageMimeTypes.join(",");const e=this._uiManager._signal;this.#Qo=new Promise(i=>{t.addEventListener("change",async()=>{if(!t.files||t.files.length===0){this.remove()}else{this._uiManager.enableWaiting(true);const e=await this._uiManager.imageManager.getFromFile(t.files[0]);this._reportTelemetry({action:"pdfjs.image.image_selected",data:{alt_text_modal:this._uiManager.useNewAltTextFlow}});this.#ol(e)}i()},{signal:e});t.addEventListener("cancel",()=>{this.remove();i()},{signal:e})}).finally(()=>this.#hl());t.click()}remove(){if(this.#Jo){this.#Yo=null;this._uiManager.imageManager.deleteId(this.#Jo);this.#il?.remove();this.#il=null;if(this.#nl){clearTimeout(this.#nl);this.#nl=null}}super.remove()}rebuild(){if(!this.parent){if(this.#Jo){this.#cl()}return}super.rebuild();if(this.div===null){return}if(this.#Jo&&this.#il===null){this.#cl()}if(!this.isAttachedToDOM){this.parent.add(this)}}onceAdded(t){this._isDraggable=true;if(t){this.div.focus()}}isEmpty(){return!(this.#Qo||this.#Yo||this.#Zo||this.#tl||this.#Jo||this.#sl)}get toolbarButtons(){return[["altText",this.createAltText()]]}get isResizable(){return true}render(){if(this.div){return this.div}let t,e;if(this._isCopy){t=this.x;e=this.y}super.render();this.div.hidden=true;this.createAltText();if(!this.#sl){if(this.#Yo){this.#ll()}else{this.#cl()}}if(this._isCopy){this._moveAfterPaste(t,e)}this._uiManager.addShouldRescale(this);return this.div}setCanvas(t,e){const{id:i,bitmap:s}=this._uiManager.imageManager.getFromCanvas(t,e);e.remove();if(i&&this._uiManager.imageManager.isValidId(i)){this.#Jo=i;if(s){this.#Yo=s}this.#sl=false;this.#ll()}}_onResized(){this.onScaleChanging()}onScaleChanging(){if(!this.parent){return}if(this.#nl!==null){clearTimeout(this.#nl)}const t=200;this.#nl=setTimeout(()=>{this.#nl=null;this.#dl()},t)}#ll(){const{div:t}=this;let{width:e,height:i}=this.#Yo;const[s,n]=this.pageDimensions;const r=.75;if(this.width){e=this.width*s;i=this.height*n}else if(e>r*s||i>r*n){const t=Math.min(r*s/e,r*n/i);e*=t;i*=t}const[a,o]=this.parentDimensions;this.setDims(e*a/s,i*o/n);this._uiManager.enableWaiting(false);const l=this.#il=document.createElement("canvas");l.setAttribute("role","img");this.addContainer(l);this.width=e/s;this.height=i/n;if(this._initialOptions?.isCentered){this.center()}else{this.fixAndSetPosition()}this._initialOptions=null;if(!this._uiManager.useNewAltTextWhenAddingImage||!this._uiManager.useNewAltTextFlow||this.annotationElementId){t.hidden=false}this.#dl();if(!this.#al){this.parent.addUndoableEditor(this);this.#al=true}this._reportTelemetry({action:"inserted_image"});if(this.#el){this.div.setAttribute("aria-description",this.#el)}if(!this.annotationElementId){this._uiManager.a11yAlert("pdfjs-editor-stamp-added-alert")}}copyCanvas(t,e,i=false){if(!t){t=224}const{width:s,height:n}=this.#Yo;const r=new OutputScale;let a=this.#Yo;let o=s,l=n;let h=null;if(e){if(s>e||n>e){const t=Math.min(e/s,e/n);o=Math.floor(s*t);l=Math.floor(n*t)}h=document.createElement("canvas");const t=h.width=Math.ceil(o*r.sx);const i=h.height=Math.ceil(l*r.sy);if(!this.#rl){a=this.#ul(t,i)}const c=h.getContext("2d");c.filter=this._uiManager.hcmFilter;let d="white",u="#cfcfd8";if(this._uiManager.hcmFilter!=="none"){u="black"}else if(window.matchMedia?.("(prefers-color-scheme: dark)").matches){d="#8f8f9d";u="#42414d"}const p=15;const g=p*r.sx;const f=p*r.sy;const m=new OffscreenCanvas(g*2,f*2);const b=m.getContext("2d");b.fillStyle=d;b.fillRect(0,0,g*2,f*2);b.fillStyle=u;b.fillRect(0,0,g,f);b.fillRect(g,f,g,f);c.fillStyle=c.createPattern(m,"repeat");c.fillRect(0,0,t,i);c.drawImage(a,0,0,a.width,a.height,0,0,t,i)}let c=null;if(i){let e,i;if(r.symmetric&&a.width<t&&a.height<t){e=a.width;i=a.height}else{a=this.#Yo;if(s>t||n>t){const r=Math.min(t/s,t/n);e=Math.floor(s*r);i=Math.floor(n*r);if(!this.#rl){a=this.#ul(e,i)}}}const o=new OffscreenCanvas(e,i);const l=o.getContext("2d",{willReadFrequently:true});l.drawImage(a,0,0,a.width,a.height,0,0,e,i);c={width:e,height:i,data:l.getImageData(0,0,e,i).data}}return{canvas:h,width:o,height:l,imageData:c}}#ul(t,e){const{width:i,height:s}=this.#Yo;let n=i;let r=s;let a=this.#Yo;while(n>2*t||r>2*e){const i=n;const s=r;if(n>2*t){n=n>=16384?Math.floor(n/2)-1:Math.ceil(n/2)}if(r>2*e){r=r>=16384?Math.floor(r/2)-1:Math.ceil(r/2)}const o=new OffscreenCanvas(n,r);const l=o.getContext("2d");l.drawImage(a,0,0,i,s,0,0,n,r);a=o.transferToImageBitmap()}return a}#dl(){const[t,e]=this.parentDimensions;const{width:i,height:s}=this;const n=new OutputScale;const r=Math.ceil(i*t*n.sx);const a=Math.ceil(s*e*n.sy);const o=this.#il;if(!o||o.width===r&&o.height===a){return}o.width=r;o.height=a;const l=this.#rl?this.#Yo:this.#ul(r,a);const h=o.getContext("2d");h.filter=this._uiManager.hcmFilter;h.drawImage(l,0,0,l.width,l.height,0,0,r,a)}#pl(t){if(t){if(this.#rl){const t=this._uiManager.imageManager.getSvgUrl(this.#Jo);if(t){return t}}const t=document.createElement("canvas");({width:t.width,height:t.height}=this.#Yo);const e=t.getContext("2d");e.drawImage(this.#Yo,0,0);return t.toDataURL()}if(this.#rl){const[t,e]=this.pageDimensions;const i=Math.round(this.width*t*PixelsPerInch.PDF_TO_CSS_UNITS);const s=Math.round(this.height*e*PixelsPerInch.PDF_TO_CSS_UNITS);const n=new OffscreenCanvas(i,s);const r=n.getContext("2d");r.drawImage(this.#Yo,0,0,this.#Yo.width,this.#Yo.height,0,0,i,s);return n.transferToImageBitmap()}return structuredClone(this.#Yo)}static async deserialize(t,e,i){let s=null;let n=false;if(t instanceof StampAnnotationElement){const{data:{rect:r,rotation:a,id:o,structParent:l,popupRef:h,contentsObj:c},container:d,parent:{page:{pageNumber:u}},canvas:p}=t;let g,f;if(p){delete t.canvas;({id:g,bitmap:f}=i.imageManager.getFromCanvas(d.id,p));p.remove()}else{n=true;t._hasNoCanvas=true}const m=(await e._structTree.getAriaAttributes(`${AnnotationPrefix}${o}`))?.get("aria-label")||"";s=t={annotationType:AnnotationEditorType.STAMP,bitmapId:g,bitmap:f,pageIndex:u-1,rect:r.slice(0),rotation:a,annotationElementId:o,id:o,deleted:false,accessibilityData:{decorative:false,altText:m},isSvg:false,structParent:l,popupRef:h,comment:c?.str||null}}const r=await super.deserialize(t,e,i);const{rect:a,bitmap:o,bitmapUrl:l,bitmapId:h,isSvg:c,accessibilityData:d}=t;if(n){i.addMissingCanvas(t.id,r);r.#sl=true}else if(h&&i.imageManager.isValidId(h)){r.#Jo=h;if(o){r.#Yo=o}}else{r.#Zo=l}r.#rl=c;const[u,p]=r.pageDimensions;r.width=(a[2]-a[0])/u;r.height=(a[3]-a[1])/p;if(d){r.altTextData=d}r._initialData=s;if(t.comment){r.setCommentData(t.comment)}r.#al=!!s;return r}serialize(t=false,e=null){if(this.isEmpty()){return null}if(this.deleted){return this.serializeDeleted()}const i={annotationType:AnnotationEditorType.STAMP,bitmapId:this.#Jo,pageIndex:this.pageIndex,rect:this.getPDFRect(),rotation:this.rotation,isSvg:this.#rl,structTreeParentId:this._structTreeParentId};this.addComment(i);if(t){i.bitmapUrl=this.#pl(true);i.accessibilityData=this.serializeAltText(true);i.isCopy=true;return i}const{decorative:s,altText:n}=this.serializeAltText(false);if(!s&&n){i.accessibilityData={type:"Figure",alt:n}}if(this.annotationElementId){const t=this.#Jr(i);if(t.isSame){return null}if(t.isSameAltText){delete i.accessibilityData}else{i.accessibilityData.structParent=this._initialData.structParent??-1}}i.id=this.annotationElementId;if(e===null){return i}e.stamps||=new Map;const r=this.#rl?(i.rect[2]-i.rect[0])*(i.rect[3]-i.rect[1]):null;if(!e.stamps.has(this.#Jo)){e.stamps.set(this.#Jo,{area:r,serialized:i});i.bitmap=this.#pl(false)}else if(this.#rl){const t=e.stamps.get(this.#Jo);if(r>t.area){t.area=r;t.serialized.bitmap.close();t.serialized.bitmap=this.#pl(false)}}return i}#Jr(t){const{pageIndex:e,accessibilityData:{altText:i}}=this._initialData;const s=t.pageIndex===e;const n=(t.accessibilityData?.alt||"")===i;return{isSame:!this.hasEditedComment&&!this._hasBeenMoved&&!this._hasBeenResized&&s&&n,isSameAltText:n}}renderAnnotationElement(t){if(this.deleted){t.hide();return null}const e={rect:this.getPDFRect()};if(this.hasEditedComment){e.popup=this.comment}t.updateEdited(e);return null}}class AnnotationEditorLayer{#Lr;#gl=false;#fl=null;#ml=null;#bl=null;#Al=new Map;#yl=false;#wl=false;#El=false;#vl=null;#xl=null;#_l=null;#Tl=null;#Sl=null;#Cl=-1;#m;static _initialized=false;static#$=new Map([FreeTextEditor,InkEditor,StampEditor,HighlightEditor,SignatureEditor].map(t=>[t._editorType,t]));constructor({uiManager:t,pageIndex:e,div:i,structTreeLayer:s,accessibilityManager:n,annotationLayer:r,drawLayer:a,textLayer:o,viewport:l,l10n:h}){const c=[...AnnotationEditorLayer.#$.values()];if(!AnnotationEditorLayer._initialized){AnnotationEditorLayer._initialized=true;for(const e of c){e.initialize(h,t)}}t.registerEditorTypes(c);this.#m=t;this.pageIndex=e;this.div=i;this.#Lr=n;this.#fl=r;this.viewport=l;this.#_l=o;this.drawLayer=a;this._structTree=s;this.#m.addLayer(this)}get isEmpty(){return this.#Al.size===0}get isInvisible(){return this.isEmpty&&this.#m.getMode()===AnnotationEditorType.NONE}updateToolbar(t){this.#m.updateToolbar(t)}updateMode(t=this.#m.getMode()){this.#Dl();switch(t){case AnnotationEditorType.NONE:this.disableTextSelection();this.togglePointerEvents(false);this.toggleAnnotationLayerPointerEvents(true);this.disableClick();return;case AnnotationEditorType.INK:this.disableTextSelection();this.togglePointerEvents(true);this.enableClick();break;case AnnotationEditorType.HIGHLIGHT:this.enableTextSelection();this.togglePointerEvents(false);this.disableClick();break;default:this.disableTextSelection();this.togglePointerEvents(true);this.enableClick()}this.toggleAnnotationLayerPointerEvents(false);const{classList:e}=this.div;for(const i of AnnotationEditorLayer.#$.values()){e.toggle(`${i._type}Editing`,t===i._editorType)}this.div.hidden=false}hasTextLayer(t){return t===this.#_l?.div}setEditingState(t){this.#m.setEditingState(t)}addCommands(t){this.#m.addCommands(t)}cleanUndoStack(t){this.#m.cleanUndoStack(t)}toggleDrawing(t=false){this.div.classList.toggle("drawing",!t)}togglePointerEvents(t=false){this.div.classList.toggle("disabled",!t)}toggleAnnotationLayerPointerEvents(t=false){this.#fl?.div.classList.toggle("disabled",!t)}async enable(){this.#El=true;this.div.tabIndex=0;this.togglePointerEvents(true);this.#Sl?.abort();this.#Sl=null;const t=new Set;for(const e of this.#Al.values()){e.enableEditing();e.show(true);if(e.annotationElementId){this.#m.removeChangedExistingAnnotation(e);t.add(e.annotationElementId)}}if(!this.#fl){this.#El=false;return}const e=this.#fl.getEditableAnnotations();for(const i of e){i.hide();if(this.#m.isDeletedAnnotationElement(i.data.id)){continue}if(t.has(i.data.id)){continue}const e=await this.deserialize(i);if(!e){continue}this.addOrRebuild(e);e.enableEditing()}this.#El=false}disable(){this.#wl=true;this.div.tabIndex=-1;this.togglePointerEvents(false);if(this.#_l&&!this.#Sl){this.#Sl=new AbortController;const t=this.#m.combinedSignal(this.#Sl);this.#_l.div.addEventListener("pointerdown",t=>{const e=500;const{clientX:i,clientY:s,timeStamp:n}=t;const r=this.#Cl;if(n-r>e){this.#Cl=n;return}this.#Cl=-1;const{classList:a}=this.div;a.toggle("getElements",true);const o=document.elementsFromPoint(i,s);a.toggle("getElements",false);if(!this.div.contains(o[0])){return}let l;const h=new RegExp(`^${AnnotationEditorPrefix}[0-9]+$`);for(const t of o){if(h.test(t.id)){l=t.id;break}}if(!l){return}const c=this.#Al.get(l);if(c?.annotationElementId===null){t.stopPropagation();t.preventDefault();c.dblclick()}},{signal:t,capture:true})}const t=new Map;const e=new Map;for(const i of this.#Al.values()){i.disableEditing();if(!i.annotationElementId){continue}if(i.serialize()!==null){t.set(i.annotationElementId,i);continue}else{e.set(i.annotationElementId,i)}this.getEditableAnnotation(i.annotationElementId)?.show();i.remove()}if(this.#fl){const i=this.#fl.getEditableAnnotations();for(const s of i){const{id:i}=s.data;if(this.#m.isDeletedAnnotationElement(i)){s.updateEdited({deleted:true});continue}let n=e.get(i);if(n){n.resetAnnotationElement(s);n.show(false);s.show();continue}n=t.get(i);if(n){this.#m.addChangedExistingAnnotation(n);if(n.renderAnnotationElement(s)){n.show(false)}}s.show()}}this.#Dl();if(this.isEmpty){this.div.hidden=true}const{classList:i}=this.div;for(const t of AnnotationEditorLayer.#$.values()){i.remove(`${t._type}Editing`)}this.disableTextSelection();this.toggleAnnotationLayerPointerEvents(true);this.#wl=false}getEditableAnnotation(t){return this.#fl?.getEditableAnnotation(t)||null}setActiveEditor(t){const e=this.#m.getActive();if(e===t){return}this.#m.setActiveEditor(t)}enableTextSelection(){this.div.tabIndex=-1;if(this.#_l?.div&&!this.#Tl){this.#Tl=new AbortController;const t=this.#m.combinedSignal(this.#Tl);this.#_l.div.addEventListener("pointerdown",this.#Ml.bind(this),{signal:t});this.#_l.div.classList.add("highlighting")}}disableTextSelection(){this.div.tabIndex=0;if(this.#_l?.div&&this.#Tl){this.#Tl.abort();this.#Tl=null;this.#_l.div.classList.remove("highlighting")}}#Ml(t){this.#m.unselectAll();const{target:e}=t;if(e===this.#_l.div||(e.getAttribute("role")==="img"||e.classList.contains("endOfContent"))&&this.#_l.div.contains(e)){const{isMac:e}=util_FeatureTest.platform;if(t.button!==0||t.ctrlKey&&e){return}this.#m.showAllEditors("highlight",true,true);this.#_l.div.classList.add("free");this.toggleDrawing();HighlightEditor.startHighlighting(this,this.#m.direction==="ltr",{target:this.#_l.div,x:t.x,y:t.y});this.#_l.div.addEventListener("pointerup",()=>{this.#_l.div.classList.remove("free");this.toggleDrawing(true)},{once:true,signal:this.#m._signal});t.preventDefault()}}enableClick(){if(this.#ml){return}this.#ml=new AbortController;const t=this.#m.combinedSignal(this.#ml);this.div.addEventListener("pointerdown",this.pointerdown.bind(this),{signal:t});const e=this.pointerup.bind(this);this.div.addEventListener("pointerup",e,{signal:t});this.div.addEventListener("pointercancel",e,{signal:t})}disableClick(){this.#ml?.abort();this.#ml=null}attach(t){this.#Al.set(t.id,t);const{annotationElementId:e}=t;if(e&&this.#m.isDeletedAnnotationElement(e)){this.#m.removeDeletedAnnotationElement(t)}}detach(t){this.#Al.delete(t.id);this.#Lr?.removePointerInTextLayer(t.contentDiv);if(!this.#wl&&t.annotationElementId){this.#m.addDeletedAnnotationElement(t)}}remove(t){this.detach(t);this.#m.removeEditor(t);t.div.remove();t.isAttachedToDOM=false}changeParent(t){if(t.parent===this){return}if(t.parent&&t.annotationElementId){this.#m.addDeletedAnnotationElement(t.annotationElementId);AnnotationEditor.deleteAnnotationElement(t);t.annotationElementId=null}this.attach(t);t.parent?.detach(t);t.setParent(this);if(t.div&&t.isAttachedToDOM){t.div.remove();this.div.append(t.div)}}add(t){if(t.parent===this&&t.isAttachedToDOM){return}this.changeParent(t);this.#m.addEditor(t);this.attach(t);if(!t.isAttachedToDOM){const e=t.render();this.div.append(e);t.isAttachedToDOM=true}t.fixAndSetPosition();t.onceAdded(!this.#El);this.#m.addToAnnotationStorage(t);t._reportTelemetry(t.telemetryInitialData)}moveEditorInDOM(t){if(!t.isAttachedToDOM){return}const{activeElement:e}=document;if(t.div.contains(e)&&!this.#bl){t._focusEventsAllowed=false;this.#bl=setTimeout(()=>{this.#bl=null;if(!t.div.contains(document.activeElement)){t.div.addEventListener("focusin",()=>{t._focusEventsAllowed=true},{once:true,signal:this.#m._signal});e.focus()}else{t._focusEventsAllowed=true}},0)}t._structTreeParentId=this.#Lr?.moveElementInDOM(this.div,t.div,t.contentDiv,true)}addOrRebuild(t){if(t.needsToBeRebuilt()){t.parent||=this;t.rebuild();t.show()}else{this.add(t)}}addUndoableEditor(t){const e=()=>t._uiManager.rebuild(t);const i=()=>{t.remove()};this.addCommands({cmd:e,undo:i,mustExec:false})}getNextId(){return this.#m.getId()}get#Il(){return AnnotationEditorLayer.#$.get(this.#m.getMode())}combinedSignal(t){return this.#m.combinedSignal(t)}#Pl(t){const e=this.#Il;return e?new e.prototype.constructor(t):null}canCreateNewEmptyEditor(){return this.#Il?.canCreateNewEmptyEditor()}async pasteEditor(t,e){this.updateToolbar(t);await this.#m.updateMode(t.mode);const{offsetX:i,offsetY:s}=this.#kl();const n=this.getNextId();const r=this.#Pl({parent:this,id:n,x:i,y:s,uiManager:this.#m,isCentered:true,...e});if(r){this.add(r)}}async deserialize(t){return await(AnnotationEditorLayer.#$.get(t.annotationType??t.annotationEditorType)?.deserialize(t,this,this.#m))||null}createAndAddNewEditor(t,e,i={}){const s=this.getNextId();const n=this.#Pl({parent:this,id:s,x:t.offsetX,y:t.offsetY,uiManager:this.#m,isCentered:e,...i});if(n){this.add(n)}return n}#kl(){const{x:t,y:e,width:i,height:s}=this.div.getBoundingClientRect();const n=Math.max(0,t);const r=Math.max(0,e);const a=Math.min(window.innerWidth,t+i);const o=Math.min(window.innerHeight,e+s);const l=(n+a)/2-t;const h=(r+o)/2-e;const[c,d]=this.viewport.rotation%180===0?[l,h]:[h,l];return{offsetX:c,offsetY:d}}addNewEditor(t={}){this.createAndAddNewEditor(this.#kl(),true,t)}setSelected(t){this.#m.setSelected(t)}toggleSelected(t){this.#m.toggleSelected(t)}unselect(t){this.#m.unselect(t)}pointerup(t){const{isMac:e}=util_FeatureTest.platform;if(t.button!==0||t.ctrlKey&&e){return}if(t.target!==this.div){return}if(!this.#yl){return}this.#yl=false;if(this.#Il?.isDrawer&&this.#Il.supportMultipleDrawings){return}if(!this.#gl){this.#gl=true;return}const i=this.#m.getMode();if(i===AnnotationEditorType.STAMP||i===AnnotationEditorType.SIGNATURE){this.#m.unselectAll();return}this.createAndAddNewEditor(t,false)}pointerdown(t){if(this.#m.getMode()===AnnotationEditorType.HIGHLIGHT){this.enableTextSelection()}if(this.#yl){this.#yl=false;return}const{isMac:e}=util_FeatureTest.platform;if(t.button!==0||t.ctrlKey&&e){return}if(t.target!==this.div){return}this.#yl=true;if(this.#Il?.isDrawer){this.startDrawingSession(t);return}const i=this.#m.getActive();this.#gl=!i||i.isEmpty()}startDrawingSession(t){this.div.focus({preventScroll:true});if(this.#vl){this.#Il.startDrawing(this,this.#m,false,t);return}this.#m.setCurrentDrawingSession(this);this.#vl=new AbortController;const e=this.#m.combinedSignal(this.#vl);this.div.addEventListener("blur",({relatedTarget:t})=>{if(t&&!this.div.contains(t)){this.#xl=null;this.commitOrRemove()}},{signal:e});this.#Il.startDrawing(this,this.#m,false,t)}pause(t){if(t){const{activeElement:t}=document;if(this.div.contains(t)){this.#xl=t}return}if(this.#xl){setTimeout(()=>{this.#xl?.focus();this.#xl=null},0)}}endDrawingSession(t=false){if(!this.#vl){return null}this.#m.setCurrentDrawingSession(null);this.#vl.abort();this.#vl=null;this.#xl=null;return this.#Il.endDrawing(t)}findNewParent(t,e,i){const s=this.#m.findParent(e,i);if(s===null||s===this){return false}s.changeParent(t);return true}commitOrRemove(){if(this.#vl){this.endDrawingSession();return true}return false}onScaleChanging(){if(!this.#vl){return}this.#Il.onScaleChangingWhenDrawing(this)}destroy(){this.commitOrRemove();if(this.#m.getActive()?.parent===this){this.#m.commitOrRemove();this.#m.setActiveEditor(null)}if(this.#bl){clearTimeout(this.#bl);this.#bl=null}for(const t of this.#Al.values()){this.#Lr?.removePointerInTextLayer(t.contentDiv);t.setParent(null);t.isAttachedToDOM=false;t.div.remove()}this.div=null;this.#Al.clear();this.#m.removeLayer(this)}#Dl(){for(const t of this.#Al.values()){if(t.isEmpty()){t.remove()}}}render({viewport:t}){this.viewport=t;setLayerDimensions(this.div,t);for(const t of this.#m.getEditors(this.pageIndex)){this.add(t);t.rebuild()}this.updateMode()}update({viewport:t}){this.#m.commitOrRemove();this.#Dl();const e=this.viewport.rotation;const i=t.rotation;this.viewport=t;setLayerDimensions(this.div,{rotation:i});if(e!==i){for(const t of this.#Al.values()){t.rotate(i)}}}get pageDimensions(){const{pageWidth:t,pageHeight:e}=this.viewport.rawDims;return[t,e]}get scale(){return this.#m.viewParameters.realScale}}class DrawLayer{#ar=null;#Rl=new Map;#Ll=new Map;static#w=0;constructor({pageIndex:t}){this.pageIndex=t}setParent(t){if(!this.#ar){this.#ar=t;return}if(this.#ar!==t){if(this.#Rl.size>0){for(const e of this.#Rl.values()){e.remove();t.append(e)}}this.#ar=t}}static get _svgFactory(){return shadow(this,"_svgFactory",new DOMSVGFactory)}static#Fl(t,[e,i,s,n]){const{style:r}=t;r.top=`${100*i}%`;r.left=`${100*e}%`;r.width=`${100*s}%`;r.height=`${100*n}%`}#Ol(){const t=DrawLayer._svgFactory.create(1,1,true);this.#ar.append(t);t.setAttribute("aria-hidden",true);return t}#Nl(t,e){const i=DrawLayer._svgFactory.createElement("clipPath");t.append(i);const s=`clip_${e}`;i.setAttribute("id",s);i.setAttribute("clipPathUnits","objectBoundingBox");const n=DrawLayer._svgFactory.createElement("use");i.append(n);n.setAttribute("href",`#${e}`);n.classList.add("clip");return s}#Bl(t,e){for(const[i,s]of Object.entries(e)){if(s===null){t.removeAttribute(i)}else{t.setAttribute(i,s)}}}draw(t,e=false,i=false){const s=DrawLayer.#w++;const n=this.#Ol();const r=DrawLayer._svgFactory.createElement("defs");n.append(r);const a=DrawLayer._svgFactory.createElement("path");r.append(a);const o=`path_p${this.pageIndex}_${s}`;a.setAttribute("id",o);a.setAttribute("vector-effect","non-scaling-stroke");if(e){this.#Ll.set(s,a)}const l=i?this.#Nl(r,o):null;const h=DrawLayer._svgFactory.createElement("use");n.append(h);h.setAttribute("href",`#${o}`);this.updateProperties(n,t);this.#Rl.set(s,n);return{id:s,clipPathId:`url(#${l})`}}drawOutline(t,e){const i=DrawLayer.#w++;const s=this.#Ol();const n=DrawLayer._svgFactory.createElement("defs");s.append(n);const r=DrawLayer._svgFactory.createElement("path");n.append(r);const a=`path_p${this.pageIndex}_${i}`;r.setAttribute("id",a);r.setAttribute("vector-effect","non-scaling-stroke");let o;if(e){const t=DrawLayer._svgFactory.createElement("mask");n.append(t);o=`mask_p${this.pageIndex}_${i}`;t.setAttribute("id",o);t.setAttribute("maskUnits","objectBoundingBox");const e=DrawLayer._svgFactory.createElement("rect");t.append(e);e.setAttribute("width","1");e.setAttribute("height","1");e.setAttribute("fill","white");const s=DrawLayer._svgFactory.createElement("use");t.append(s);s.setAttribute("href",`#${a}`);s.setAttribute("stroke","none");s.setAttribute("fill","black");s.setAttribute("fill-rule","nonzero");s.classList.add("mask")}const l=DrawLayer._svgFactory.createElement("use");s.append(l);l.setAttribute("href",`#${a}`);if(o){l.setAttribute("mask",`url(#${o})`)}const h=l.cloneNode();s.append(h);l.classList.add("mainOutline");h.classList.add("secondaryOutline");this.updateProperties(s,t);this.#Rl.set(i,s);return i}finalizeDraw(t,e){this.#Ll.delete(t);this.updateProperties(t,e)}updateProperties(t,e){if(!e){return}const{root:i,bbox:s,rootClass:n,path:r}=e;const a=typeof t==="number"?this.#Rl.get(t):t;if(!a){return}if(i){this.#Bl(a,i)}if(s){DrawLayer.#Fl(a,s)}if(n){const{classList:t}=a;for(const[e,i]of Object.entries(n)){t.toggle(e,i)}}if(r){const t=a.firstChild;const e=t.firstChild;this.#Bl(e,r)}}updateParent(t,e){if(e===this){return}const i=this.#Rl.get(t);if(!i){return}e.#ar.append(i);this.#Rl.delete(t);e.#Rl.set(t,i)}remove(t){this.#Ll.delete(t);if(this.#ar===null){return}this.#Rl.get(t).remove();this.#Rl.delete(t)}destroy(){this.#ar=null;for(const t of this.#Rl.values()){t.remove()}this.#Rl.clear();this.#Ll.clear()}}{globalThis._pdfjsTestingUtils={HighlightOutliner:HighlightOutliner}}globalThis.pdfjsLib={AbortException:AbortException,AnnotationEditorLayer:AnnotationEditorLayer,AnnotationEditorParamsType:AnnotationEditorParamsType,AnnotationEditorType:AnnotationEditorType,AnnotationEditorUIManager:AnnotationEditorUIManager,AnnotationLayer:AnnotationLayer,AnnotationMode:AnnotationMode,AnnotationType:AnnotationType,build:build,ColorPicker:ColorPicker,createValidAbsoluteUrl:createValidAbsoluteUrl,DOMSVGFactory:DOMSVGFactory,DrawLayer:DrawLayer,FeatureTest:util_FeatureTest,fetchData:fetchData,getDocument:getDocument,getFilenameFromUrl:getFilenameFromUrl,getPdfFilenameFromUrl:getPdfFilenameFromUrl,getRGB:getRGB,getUuid:getUuid,getXfaPageViewport:getXfaPageViewport,GlobalWorkerOptions:GlobalWorkerOptions,ImageKind:util_ImageKind,InvalidPDFException:InvalidPDFException,isDataScheme:isDataScheme,isPdfFile:isPdfFile,isValidExplicitDest:isValidExplicitDest,MathClamp:MathClamp,noContextMenu:noContextMenu,normalizeUnicode:normalizeUnicode,OPS:OPS,OutputScale:OutputScale,PasswordResponses:PasswordResponses,PDFDataRangeTransport:PDFDataRangeTransport,PDFDateString:PDFDateString,PDFWorker:PDFWorker,PermissionFlag:PermissionFlag,PixelsPerInch:PixelsPerInch,RenderingCancelledException:RenderingCancelledException,ResponseException:ResponseException,setLayerDimensions:setLayerDimensions,shadow:shadow,SignatureExtractor:SignatureExtractor,stopEvent:stopEvent,SupportedImageMimeTypes:SupportedImageMimeTypes,TextLayer:TextLayer,TouchManager:TouchManager,updateUrlHash:updateUrlHash,Util:Util,VerbosityLevel:VerbosityLevel,version:version,XfaLayer:XfaLayer};export{AbortException,AnnotationEditorLayer,AnnotationEditorParamsType,AnnotationEditorType,AnnotationEditorUIManager,AnnotationLayer,AnnotationMode,AnnotationType,ColorPicker,DOMSVGFactory,DrawLayer,util_FeatureTest as FeatureTest,GlobalWorkerOptions,util_ImageKind as ImageKind,InvalidPDFException,MathClamp,OPS,OutputScale,PDFDataRangeTransport,PDFDateString,PDFWorker,PasswordResponses,PermissionFlag,PixelsPerInch,RenderingCancelledException,ResponseException,SignatureExtractor,SupportedImageMimeTypes,TextLayer,TouchManager,Util,VerbosityLevel,XfaLayer,build,createValidAbsoluteUrl,fetchData,getDocument,getFilenameFromUrl,getPdfFilenameFromUrl,getRGB,getUuid,getXfaPageViewport,isDataScheme,isPdfFile,isValidExplicitDest,noContextMenu,normalizeUnicode,setLayerDimensions,shadow,stopEvent,updateUrlHash,version};
//# sourceMappingURL=pdf.js.map