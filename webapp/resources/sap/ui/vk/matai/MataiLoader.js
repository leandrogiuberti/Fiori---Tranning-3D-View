/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","sap/ui/base/ManagedObject","../getResourceBundle","../helpers/WorkerScriptLoader","../DownloadManager"],function(e,t,r,a,n){"use strict";var o={FinishedTree:r().getText("SCENE_CONTEXT_FINISHED_TREE"),LoadingGeometries:r().getText("SCENE_CONTEXT_LOADING_GEOMETRIES"),LoadingTextures:r().getText("SCENE_CONTEXT_LOADING_TEXTURES"),LoadingModelViews:r().getText("SCENE_CONTEXT_LOADING_MODEL_VIEWS")};var s=t.extend("sap.ui.vk.matai.MataiLoader",{metadata:{library:"sap.ui.vk",events:{contentChangesProgress:{parameters:{source:"any",phase:"string",percent:"float"}},contentLoadingFinished:{parameters:{source:"any",node:"any"}}}}});var i=s.getMetadata().getName();function u(e,t,r){var a=performance.now();var n=e._progress;var o=a-n.lastUpdateTime>=500||t!==n.phase||r>=n.totalCount;n.phase=t;n.count=r;if(o){var s=40+60*(n.totalCount?n.count/n.totalCount:1);e._loader.fireContentChangesProgress({source:e._contentResource&&e._contentResource.getSource(),phase:t,percentage:Math.min(s,100)});n.lastUpdateTime=a}}var c=1;var d=new Map;var g=function(){var t;return function(){return t||(t=new Promise(function(t,n){var s=a.loadScript("sap/ui/vk/matai/MataiLoaderWorker.js",["sap/ui/vk/ve/matai.js"]);var c=0;var g=-1;var l=-2;var E=-3;var f=-4;var v=-5;var p=-6;var R=-7;var _=-8;function T(e){var t=r();switch(e){case g:return t.getText("LOADER_FILENOTFOUND");case l:return t.getText("LOADER_WRONGFILEFORMAT");case E:return t.getText("LOADER_WRONGPASSWORD");case f:return t.getText("LOADER_ERRORREADINGFILE");case v:return t.getText("LOADER_FILECONTENT");case p:return t.getText("LOADER_NODEFAULTVIEW");case R:return t.getText("LOADER_FILECONTENT");case _:return t.getText("LOADER_ERRORREADINGREFERENCEDFILE");default:return t.getText("LOADER_UNKNOWNERROR")}}function m(t,r,a){var n=T(r);t._reject({status:r,errorText:n});e.error(n,a,i);L(t,r)}function L(t,r){e.info("Matai loading finished");u(t,"",t._progress.totalCount);t._loader.fireContentLoadingFinished({source:t._contentResource,node:t._rootNode});t._loader=null;var a=t._id;s.postMessage({method:"destroyContext",args:{sceneBuilderId:a}});d.delete(a)}s.onmessage=function(a){var n=a.data;if(n.event==="runtimeCreated"){t(this);return}if("event"in n){var g=n.sceneBuilderId;var l=d.get(g);var E=l.sceneBuilder;switch(n.event){case"contextCreated":if(n.result===c){s.postMessage({method:"loadFile",args:{sceneBuilderId:g}})}else{m(E,n.result)}break;case"fileLoaded":if(n.result===c){l.waitingCount-=1;if(l.waitingCount===0){s.postMessage({method:"buildScene",args:{sceneBuilderId:g}})}}else{m(E,n.result)}break;case"referencedFileLoaded":l.waitingCount-=1;if(n.result!==c){e.error(T(n.result),n.fileName,i)}if(l.waitingCount===0){s.postMessage({method:"buildScene",args:{sceneBuilderId:g}})}break;case"referencedFileRequested":var f=l.dependencyLoader;if(f==null){e.error(r().getText("LOADER_NODEPENDENCYLOADER"),null,i)}else{var v=n.fileName;var p=n.veId;var R=n.veVersion;var _=l.files;var O=_.get(v);if(O==null){O=f.load(v);_.set(v,O)}l.waitingCount+=1;O.then(function(e){var t=e.buffer;e.buffer=null;s.postMessage({method:"loadReferencedFile",args:{sceneBuilderId:g,buffer:t,fileName:v,veId:p,veVersion:R}},t==null?[]:[t])},function(){l.waitingCount-=1;e.error(r().getText("LOADER_ERRORREADINGREFERENCEDFILE"),v,i);if(l.waitingCount===0){s.postMessage({method:"buildScene",args:{sceneBuilderId:g}})}})}break;case"sceneBuilt":L(E,n.result);break;default:break}}else{n.forEach(function(t){var r=t.sceneBuilderId;var a=d.get(r);var n=a.sceneBuilder;try{n[t.method].apply(n,t.args)}catch(r){e.error("SceneBuilder."+t.method+"()",r)}switch(t.method){case"setScene":var s=t.args[0];n._progress.totalCount=s.meshCount+s.imageCount+s.modelViewCount;u(n,o.FinishedTree,0);break;case"setGeometry":u(n,o.LoadingGeometries,n._progress.count+1);break;case"createImage":u(n,o.LoadingTextures,n._progress.count+1);break;case"createThumbnail":u(n,o.LoadingModelViews,n._progress.count+1);break;default:break}})}};s.onerror=function(e){n(e)};var O=a.absoluteUri("sap/ui/vk/ve/").toString();s.postMessage({method:"createRuntime",args:{scriptDirectory:O}})}))}}();function l(t,a,n,o,s,i,u){var l=s.getDependencyLoader();sap.ui.require([o.isObject3D?"sap/ui/vk/threejs/SceneBuilder":"sap/ui/vk/svg/SceneBuilder","sap/base/i18n/Localization"],function(E,f){g().then(function(g){g.onerror=function(t){e.error("Error in WebWorker",t);u(r().getText("LOADER_ERRORREADINGFILE"))};var v=new E(o,s,i,u);v._loader=t;v._progress={lastUpdateTime:performance.now()};v._id=c++;d.set(v._id,{sceneBuilder:v,dependencyLoader:l,files:new Map,waitingCount:1});g.postMessage({method:"createContext",args:{sceneBuilderId:v._id,buffer:a,fileName:n,locale:f.getLanguageTag().toString()}},[a])},function(e){u(e)})})}s.prototype.load=function(e,t,a,o){var s=this;return new Promise(function(i,u){if(typeof t.getSource()==="string"){var c=t.getSource();new n([c],undefined,a,o).attachItemSucceeded(function(r){var a=r.getParameter("source");var n=r.getParameter("response");l(s,n,a,e,t,i,u)},this).attachItemFailed(function(e){var t=e.getParameter("statusText");if(t===""){t=r().getText("VIEWER_SOURCE_FAILED_TO_DOWNLOAD_CAUSE")}u(t)},this).start()}else if(t.getSource()instanceof File){var d=new FileReader;d.onload=function(r){l(s,r.target.result,t.getSource().name,e,t,i,u)};d.onerror=function(e){u(e)};d.readAsArrayBuffer(t.getSource())}})};return s});
//# sourceMappingURL=MataiLoader.js.map