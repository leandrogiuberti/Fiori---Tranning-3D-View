/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","sap/ui/base/ManagedObjectObserver","sap/ui/core/Element","./ContentResource","./ContentType","./Core","./getResourceBundle","./Messages"],function(e,t,n,a,s,o,r,i){"use strict";var c=n.prototype;var u=n.extend("sap.ui.vk.ContentConnector",{metadata:{library:"sap.ui.vk",aggregations:{contentResources:{type:"sap.ui.vk.ContentResource",bindable:"bindable"},viewStateManagers:{type:"sap.ui.vk.ViewStateManagerBase"},defaultViewStateManager:{type:"sap.ui.vk.ViewStateManagerBase",multiple:false,visibility:"hidden"},contentManagers:{type:"sap.ui.vk.ContentManager",visibility:"hidden"}},defaultAggregation:"contentResources",events:{contentChangesStarted:{parameters:{}},contentChangesFinished:{parameters:{content:{type:"any"},failureReason:{type:"any"}}},contentChangesProgress:{parameters:{phase:{type:"string"},percentage:{type:"float"},source:{type:"any"}}},contentLoadingFinished:{parameters:{source:{type:"any"},node:{type:"any"}}},contentReplaced:{parameters:{newContent:{type:"any"},oldContent:{type:"any"}}},contentDestroying:{parameters:{content:{type:"any"},preventGarbageCollection:{type:"function"}}}}},constructor:function(e,t){this._inLoading=false;this._delayContentResourcesUpdate=false;this._scheduleContentResourcesUpdateTimerId=null;this._content=null;this._contentManager=null;this._decryptionHandler=null;this._authorizationHandler=null;this._consumptionScenario=null;this._retryCount=1;c.constructor.apply(this,arguments);o.observeLifetime(this)}});u.prototype.isTreeBinding=function(e){return e==="contentResources"};u.prototype.init=function(){if(c.init){c.init.call(this)}this._selfObserver=new t(this._observeChanges.bind(this));this._selfObserver.observe(this,{aggregations:["contentResources","viewStateManagers"]})};u.prototype.destroy=function(){this._selfObserver.disconnect();this._selfObserver=null;if(this._scheduleContentResourcesUpdateTimerId){clearTimeout(this._scheduleContentResourcesUpdateTimerId);this._scheduleContentResourcesUpdateTimerId=null}this._delayContentResourcesUpdate=false;this._setContent(null,null);c.destroy.call(this)};u.prototype._observeChanges=function(e){if(e.name==="contentResources"){this._scheduleContentResourcesUpdate()}else if(e.name==="viewStateManagers"){if(e.mutation==="insert"){e.child.setContentConnector(this)}else if(e.mutation==="remove"){e.child.setContentConnector(null)}}};u.prototype.invalidate=function(e){if(e instanceof a){this._scheduleContentResourcesUpdate();return}c.invalidate.apply(this,arguments)};u.prototype._scheduleContentResourcesUpdate=function(){if(this._inLoading){this._delayContentResourcesUpdate=true;return this}if(!this._scheduleContentResourcesUpdateTimerId){this._scheduleContentResourcesUpdateTimerId=setTimeout(function(){this._scheduleContentResourcesUpdateTimerId=null;var t=this.getContentResources();if(t.length>0){this._collectContentResourceSourceTypeInformation(t).then(function(n){if(n.dimensions.length>1){setTimeout(function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null,failureReason:{errorMessage:r().getText(i.VIT17.cause)}});e.error(r().getText(i.VIT17.summary),i.VIT17.code,"sap.ui.vk.ContentConnector")}.bind(this),0)}else if(n.contentManagerClassNames.length>1){setTimeout(function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null,failureReason:{errorMessage:r().getText(i.VIT35.cause)}});e.error(r().getText(i.VIT35.summary),i.VIT35.code,"sap.ui.vk.ContentConnector")}.bind(this),0)}else if(n.contentManagerClassNames.length===0){setTimeout(function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null,failureReason:{errorMessage:r().getText(i.VIT36.cause)}});e.error(r().getText(i.VIT36.summary),i.VIT36.code,"sap.ui.vk.ContentConnector")}.bind(this),0)}else if(n.contentManagerClassNames.length===1){var a=this;this._getContentManagerByClassName(n.contentManagerClassNames[0]).then(function(e){if(a._contentManager&&e!==a._contentManager){a.fireContentChangesStarted();a._setContent(null,null);a.fireContentChangesFinished({content:null})}e.loadContent(a._content,t)})}}.bind(this))}else{setTimeout(function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null})}.bind(this),0)}}.bind(this),0)}return this};u.prototype._handleContentChangesStarted=function(e){this._inLoading=true;this.fireContentChangesStarted()};u.prototype._handleContentChangesFinished=function(e){var t=e.getParameter("content");this._setContent(t,e.getSource());this.fireContentChangesFinished({content:t,failureReason:e.getParameter("failureReason")});this._inLoading=false;if(this._delayContentResourcesUpdate){this._delayContentResourcesUpdate=false;this._scheduleContentResourcesUpdate()}};u.prototype._handleContentChangesProgress=function(e){this.fireContentChangesProgress({phase:e.getParameter("phase"),source:e.getParameter("source"),percentage:e.getParameter("percentage")})};u.prototype._handleContentLoadingFinished=function(e){this.fireContentLoadingFinished({source:e.getParameter("source"),node:e.getParameter("node")})};u.prototype._getContentManagerByClassName=function(e){var t;var n=this.getAggregation("contentManagers",[]);for(var a=0,s=n.length;a<s;++a){t=n[a];if(t.getMetadata().getName()===e){return Promise.resolve(t)}}var o=this;return new Promise(function(t,n){sap.ui.require([e.replaceAll(".","/")],function(e){var n=new e;o.addAggregation("contentManagers",n);n.attachContentChangesStarted(o._handleContentChangesStarted,o);n.attachContentChangesFinished(o._handleContentChangesFinished,o);n.attachContentChangesProgress(o._handleContentChangesProgress,o);n.attachContentLoadingFinished(o._handleContentLoadingFinished,o);o._assignDecryptionHandler([n]);o._assignAuthorizationHandler([n]);o._assignConsumptionScenario([n]);o._assignRetryCount([n]);t(n)})})};u.prototype.getContent=function(){return this._content};u.prototype.getContentManager=function(){return this._contentManager};u.prototype.getDefaultViewStateManager=function(){return this.getAggregation("defaultViewStateManager")};u.prototype._assignDecryptionHandler=function(e){for(var t=0;t<e.length;t++){e[t].setDecryptionHandler(this._decryptionHandler)}};u.prototype._assignAuthorizationHandler=function(e){for(var t=0;t<e.length;t++){e[t].setAuthorizationHandler(this._authorizationHandler)}};u.prototype._assignConsumptionScenario=function(e){for(var t=0;t<e.length;t++){e[t].setConsumptionScenario(this._consumptionScenario)}};u.prototype._assignRetryCount=function(e){for(var t=0;t<e.length;t++){e[t].setRetryCount(this._retryCount)}};u.prototype.setDecryptionHandler=function(e){this._decryptionHandler=e;this._assignDecryptionHandler(this.getAggregation("contentManagers",[]));return this};u.prototype.setAuthorizationHandler=function(e){this._authorizationHandler=e;this._assignAuthorizationHandler(this.getAggregation("contentManagers",[]));return this};u.prototype.setConsumptionScenario=function(e){this._consumptionScenario=e;this._assignConsumptionScenario(this.getAggregation("contentManagers",[]));return this};u.prototype.setRetryCount=function(e){this._retryCount=Math.max(e,0);this._assignRetryCount(this.getAggregation("contentManagers",[]));return this};u.prototype._setContent=function(e,t){var n=this._content;var a=this._contentManager;if(n!==e){this._content=e;this._contentManager=t;this.destroyAggregation("defaultViewStateManager");if(t){var s=t.getMetadata().getName();var o;switch(s){case"sap.ui.vk.threejs.ContentManager":o="sap.ui.vk.threejs.ViewStateManager";break;case"sap.ui.vk.dvl.ContentManager":o="sap.ui.vk.dvl.ViewStateManager";break;case"sap.ui.vk.svg.ContentManager":o="sap.ui.vk.svg.ViewStateManager";break;case"sap.ui.vk.pdf.ContentManager":o="sap.ui.vk.pdf.ViewStateManager";break;default:break}if(o){var r=sap.ui.require(o.replaceAll(".","/"));var i=new r(this.getId()+"-defaultviewstatemanager",{contentConnector:this});this.setAggregation("defaultViewStateManager",i)}}this.fireContentReplaced({oldContent:n,newContent:e});if(n){var c=false;this.fireContentDestroying({content:n,preventGarbageCollection:function(e){c=e}});a.destroyContent(n);if(!c){a.collectGarbage()}}}return this};u.prototype.updateContent=async function(e){const t=this.getContentResources();const n=this.getContentManager();const a=this.getContent();if(t.length===0||n==null||a==null){throw new Error("No content is loaded.")}const s=await n.updateContent(t,a,e);this.fireEvent("_contentUpdated",{result:s});return s};async function l(t){const n=t.getSourceType()?.toLowerCase();const a=t.getSource();const o=t.getVeid()??"";if(n!=="auto"||typeof a!=="string"||o===""){return null}const r=`${a}${a.endsWith("/")?"":"/"}scenes/${o}/info`;try{const e=await fetch(r);if(!e.ok){return null}const{contentType:n}=await e.json();switch(n){case s.IMAGE2D:case s.IMAGE360:case s.MATERIAL:case s.MODEL3D:case s.NAVIGATION:case s.SYMBOL:t.setEffectiveSourceType("stream");return{dimension:3,contentManagerClassName:"sap.ui.vk.threejs.ContentManager"};case s.DRAWING2D:case s.ECAD:t.setEffectiveSourceType(n===s.ECAD?"ecad":"stream2d");return{dimension:2,contentManagerClassName:"sap.ui.vk.svg.ContentManager"};case s.PDF:t.setEffectiveSourceType("stream");return{dimension:2,contentManagerClassName:"sap.ui.vk.pdf.ContentManager"};default:return null}}catch(t){e.error("Failed to resolve content resource type automatically.",t,"sap.ui.vk.ContentConnector")}return null}const g=[{pattern:/(^threejs[:.])|(^(threejs|stream|vds4)$)/,dimension:3,contentManagerClassName:"sap.ui.vk.threejs.ContentManager"},{pattern:/^vdsl?$/,dimension:3,contentManagerClassName:"sap.ui.vk.threejs.ContentManager"},{pattern:/^(png|jpg|jpeg|gif|bmp|tiff?|svg)$/,dimension:2,contentManagerClassName:"sap.ui.vk.ImageContentManager"},{pattern:/^(stream2d|vds4-2d|ecad)$/,dimension:2,contentManagerClassName:"sap.ui.vk.svg.ContentManager"},{pattern:/^(pdf)$/,dimension:2,contentManagerClassName:"sap.ui.vk.pdf.ContentManager"},l];(function(){g[1].contentManagerClassName="sap.ui.vk.dvl.ContentManager"})();async function h(e){const t=e.getSourceType()?.toLowerCase();let n=null;for(const a of g.slice()){if(typeof a==="function"){try{n=await a(e);break}catch{continue}}else if(typeof a.pattern==="string"){if(a.pattern.toLowerCase()===t){n=a;break}}else if(a.pattern instanceof RegExp){if(a.pattern.test(t)){n=a;break}}}if(n==null){return null}else{return{dimension:n.dimension,contentManagerClassName:n.contentManagerClassName,settings:n.settings}}}u.addContentManagerResolver=function(e){if(typeof e==="function"){g.unshift(e)}else{g.unshift({pattern:e.pattern,dimension:e.dimension,contentManagerClassName:e.contentManagerClassName,settings:e.settings})}return this};u.removeAllContentManagerResolvers=function(){g=[];return this};u.removeContentManagerResolver=function(e){var t=typeof e==="function",n=typeof e==="string",a=e instanceof RegExp,s=typeof e==="object"&&!a;for(var o=0,r=g.length;o<r;++o){if(t&&g[o]===e){g.splice(o,1);return true}else if(typeof g[o]==="object"){if(s){if(e.pattern&&g[o].pattern===e.pattern){g.splice(o,1);return true}}else if(a){if(g[o].pattern.source===e.source){g.splice(o,1);return true}}else if(n){if(g[o].pattern instanceof RegExp){if(g[o].pattern.source===e){g.splice(o,1);return true}}else if(g[o].pattern===e){g.splice(o,1);return true}}}}return false};u.prototype._collectContentResourceSourceTypeInformation=async function(e){var t=false;var n=false;var a={};var s={};var o=[];e.forEach(function e(t){o.push(t);t.getContentResources().forEach(e)});const r=await Promise.all(o.map(async function(e){const o=await h(e);if(o==null){if(e.getSourceType()){n=true}else{t=true}}else{a[o.dimension]=true;s[o.contentManagerClassName]=true}return o}));for(const[e,t]of r.entries()){if(t!=null){o[e]._contentManagerResolver=t}}return{noSourceTypes:t,unknownSourceTypes:n,dimensions:Object.getOwnPropertyNames(a).toSorted().map(Number),contentManagerClassNames:Object.getOwnPropertyNames(s)}};return u});
//# sourceMappingURL=ContentConnector.js.map