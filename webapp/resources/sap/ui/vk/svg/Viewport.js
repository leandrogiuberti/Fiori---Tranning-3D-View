/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../Core","../ViewportBase","sap/ui/core/Element","sap/ui/core/ResizeHandler","sap/ui/events/KeyCodes","../Loco","../ViewStateManager","./ViewStateManager","../ViewportHandler","../VisibilityMode","../ZoomTo","../SelectionMode","../NodeContentType","../getResourceBundle","../Messages","./Scene","./OrthographicCamera","../measurements/Surface","./Rectangle","./HotspotHelper","../colorToCSSColor","../cssColorToColor","../colorToABGR","../abgrToColor","./MiniMap","./Element","sap/m/Dialog","sap/base/Log","sap/base/i18n/Localization"],function(t,e,i,s,o,n,a,r,h,l,c,u,f,d,m,p,g,_,v,y,w,C,S,b,x,R,M,E,T){"use strict";var V=e.extend("sap.ui.vk.svg.Viewport",{metadata:{library:"sap.ui.vk",aggregations:{miniMap:{type:"sap.m.Dialog",multiple:false}},events:{cameraChanged:{parameters:{offset:"float[]",zoom:"float"},enableEventBubbling:true},hotspotEnter:{parameters:{nodeRef:"any"},enableEventBubbling:true},hotspotLeave:{parameters:{nodeRef:"any"},enableEventBubbling:true}}}});const A={Top:"Top",Inner:"Inner",Bottom:"Bottom",Unknown:""};var B=V.getMetadata().getParent().getClass().prototype;V.prototype.init=function(){if(B.init){B.init.call(this)}this._measurementSurface=new _;this._resizeListenerId=null;this._animLoopRequestId=0;this._animLoopFunction=this._animLoop.bind(this);this._width=this._height=0;this._camera=new g;this._gestureX=0;this._gestureY=0;this._scene=null;this._selectionRect=new v({material:{lineColor:[.75,.75,0,1],lineStyle:{dashPattern:[2,2]}}});this._styles=new Map;this.raster={rasterImage:document.createElement("canvas"),vectorImage:new Image,bmpCanvas:null,rasterMode:false,useRasterMode:false,delayEnd:false,endRasterModeTimer:null,updateImageTimer:null,bmpDrawRequestId:null,nodesThreshold:2500};this.raster.vectorImage.onload=function(){var t=this.raster.vectorImage;var e=this.raster.rasterImage;e.viewBox=t.viewBox;D(e,t.width,t.height);var i=e.getContext("2d");i.clearRect(0,0,e.width,e.height);i.drawImage(t,0,0,e.width,e.height);this._requestBmpDraw()}.bind(this);this._viewportHandler=new h(this);this._loco=new n(this);this._loco.addHandler(this._viewportHandler,-1);this._hotspotHelper=new y;this._currentViewIndex=0;this._currentView=null;this._pcbRotateAngle=0;this._pcbVisibleSurface=A.Unknown;this._topElements=[];this._bottomElements=[];t.getEventBus().subscribe("sap.ui.vk","viewStateApplied",this._onViewStateApplied,this);T.attachChange(this._onLocalizationChanged.bind(this));const e=this._miniMap=new x({viewport:this});const i=new M({showHeader:false,horizontalScrolling:false,verticalScrolling:false,content:e,escapeHandler:function(){}}).addStyleClass("sapUiVkMiniMapDialog");i.attachBeforeOpen(function(){i.oPopup.setModal(false)});i._calcPosition=()=>{const t=this.getDomRef()?.getBoundingClientRect()??{top:0,right:0};const s=i.getDomRef()?.getBoundingClientRect()??{width:0,height:0};const o=e._lockPosition;return{top:(o.y>=0?t.top+o.y:Math.max(t.bottom+o.y-s.height,t.top))+"px",left:(o.x>=0?t.left+o.x:Math.max(t.right+o.x-s.width,t.left))+"px"}};e.attachSizeChanged(t=>{i.setContentWidth(t.getParameter("width")+4+"px");i.setContentHeight(t.getParameter("height")+4+"px")});this.setMiniMap(i)};V.prototype.exit=function(){T.detachChange(this._onLocalizationChanged);t.getEventBus().unsubscribe("sap.ui.vk","viewStateApplied",this._onViewStateApplied,this);this._loco.removeHandler(this._viewportHandler);this._viewportHandler.destroy();if(this._resizeListenerId){s.deregister(this._resizeListenerId);this._resizeListenerId=null}this._setScene(null);this._renderer=null;this._loco.destroy();this._loco=null;this._viewportHandler=null;this._miniMap=null;B.exit?.call(this);var e=this.getTools();for(var o=0;o<e.length;o++){var n=i.getElementById(e[o]);if(n){n.setActive(false)}}this._measurementSurface.destroy();this._measurementSurface=null;this.raster.rasterMode=false;this.raster.useRasterMode=false};V.prototype._onLocalizationChanged=function(t){var e=this._measurementSurface;if(e&&e.getMeasurements().length>0){e.update(this,this.getCamera())}};V.prototype.onBeforeRendering=function(){if(this._resizeListenerId){s.deregister(this._resizeListenerId);this._resizeListenerId=null}};V.prototype._updateCustomText=function(){const t=this._scene.getRootElement();const e=[];t.traverse(function(t){if(t.type==="Text"){const i=t.style.size;const s=parseFloat(i);if(s>0){let o=1;if(typeof i==="string"){if(i.endsWith("em")){o=16}else if(i.endsWith("pt")){o=1.333}}const n=t._matrixWorld();e.push(s*o*Math.sqrt(n[2]*n[2]+n[3]*n[3]))}}});let i;if(e.length>0){e.sort();i=e[e.length>>1]}else{const e=t.domRef.getBBox();i=Math.max(e.width,e.height)*.01}i=Math.round(i*100)/100;t.traverse(function(t){if(t.customText?.style.size==="0px"){t.customText.style.size=i+"px"}})};V.prototype._updateCustomTextFilters=function(){const t=this._scene?.getRootElement()?.domRef;if(t){const e=this.getHotspotCustomTextHaloWidth();const i=e*.1;const s=this.getHotspotCustomTextOutlineWidth();const o=Math.max(e+i,s*2);const n=C(this.getHotspotCustomTextOutlineColor());for(const a of t.parentNode.getElementsByTagName("filter")){if(a.id.endsWith("-custom-text")){if(sap.ui.Device.browser.firefox){a.setAttribute("x","-25%");a.setAttribute("y","-100%");a.setAttribute("width","150%");a.setAttribute("height","300%")}else{a.setAttribute("x",-o+"px");a.setAttribute("y",-o+"px");a.setAttribute("width",`calc(100% + ${o*2}px)`);a.setAttribute("height",`calc(100% + ${o*2}px)`)}a.childNodes[0].setAttribute("radius",i);a.childNodes[2].setAttribute("stdDeviation",e);a.childNodes[3].setAttribute("radius",s);a.childNodes[5].setAttribute("stdDeviation",s);a.childNodes[4].setAttribute("values",`0 0 0 0 ${n.red/255}, 0 0 0 0 ${n.green/255}, 0 0 0 0 ${n.blue/255}, 0 0 0 ${n.alpha} 0`)}}}};V.prototype.setHotspotCustomTextOutlineColor=function(t){this.setProperty("hotspotCustomTextOutlineColor",t,true);this._updateCustomTextFilters();return this};V.prototype.setHotspotCustomTextOutlineWidth=function(t){this.setProperty("hotspotCustomTextOutlineWidth",t,true);this._updateCustomTextFilters();return this};V.prototype.setHotspotCustomTextHaloWidth=function(t){this.setProperty("hotspotCustomTextHaloWidth",t,true);this._updateCustomTextFilters();return this};V.prototype.onAfterRendering=function(){this._resizeListenerId=s.register(this,this._handleResize.bind(this));var t=this.getDomRef();t.append(this._measurementSurface.getDomRef());if(this._scene){var e=this._scene.getRootElement();e._setDomRef(document.getElementById(e.uid));this._svgElement=e.domRef.parentNode;this._updateCustomText()}this._handleResize({size:{width:t.clientWidth,height:t.clientHeight}});this._miniMap._onContentUpdate()};V.prototype._handleResize=function(t){var e=this._width;var i=this._height;this._width=t.size.width;this._height=t.size.height;this._camera.update(this._width,this._height,false);if((e===0||i===0)&&(!this._camera._initialZoom||this._camera._initialZoom<0||!this._camera._initialPosition)){this.zoomTo(c.All,null,0,0)}else{this._updateViewBox();this.fireCameraChanged({viewBox:this._getViewBox()})}var s=this._measurementSurface.getDomRef();s.style.width=this._width+"px";s.style.height=this._height+"px";const o=this.getMiniMap();o.$().css(o._calcPosition());this.fireResize({size:{width:this._width,height:this._height}});if(this._svgElement!=null){this.raster.bmpCanvas=this._svgElement.previousSibling;this._invalidateRasterImage()}return true};V.prototype.setScene=function(t){return this._setScene(t)};V.prototype._setScene=function(t){if(this._scene){this._scene.getDefaultNodeHierarchy().detachNodeCreated(this._nodeCreatedHandler,this)}this._scene=t;this._currentViewIndex=0;this._currentView=null;this._styles.clear();if(t){this.setCamera(new g);if(this.isECAD()){const t=this._extractLayersZone();this._topElements=[];this._bottomElements=[];this._scanTree(t,this._scene.getRootElement())}var e=this._scene.getDefaultNodeHierarchy();this.raster.useRasterMode=e.findNodesByName().length>this.raster.nodesThreshold;e.attachNodeCreated(this._nodeCreatedHandler,this);var i=t.getInitialView();if(i){this.activateView(i)}this._onContentLoadingFinished()}return this};V.prototype.setCamera=function(t){if(!(t instanceof g)){return this}if(B.setCamera){B.setCamera.call(this,t)}if(t){t.update(this._width,this._height,true);this._updateViewBox()}return this};V.prototype._nodeCreatedHandler=function(t){var e=t.getParameter("nodeRef");if(e._vkGetNodeContentType()===f.Annotation&&e.children&&e.children.length&&e.children[0].type==="Image"){this.invalidate()}};V.prototype.getScene=function(){return this._scene};V.prototype.onSetViewStateManager=function(t){this._viewStateManager=t;this._miniMap.setViewStateManager(t);t.attachOutliningChanged(this._onOutliningOrSelectionChanged,this);t.attachSelectionChanged(this._onOutliningOrSelectionChanged,this)};V.prototype.onUnsetViewStateManager=function(t){t.detachOutliningChanged(this._onOutliningOrSelectionChanged,this);t.detachSelectionChanged(this._onOutliningOrSelectionChanged,this);this._viewStateManager=null;this._miniMap?.setViewStateManager(null)};V.prototype._getViewStateManagerSVG=function(){if(this._viewStateManager){if(this._viewStateManager instanceof r){return this._viewStateManager}if(this._viewStateManager instanceof a&&this._viewStateManager._implementation instanceof r){return this._viewStateManager._implementation}}return null};V.prototype.hitTest=function(t,e,i,s,o){var n=this._getViewStateManagerSVG();if(!n||!this._scene){return null}var a=this._scene.getRootElement();var r=this.getDomRef().getBoundingClientRect();t+=r.x;e+=r.y;function h(t){while(t&&!t.id){t=t.parentElement}if(!t){return null}const e=a.getElementById(t.id);const i=e?._getSceneTreeElement();if(!i){return null}if(o&&i._vkGetNodeContentType()===f.Hotspot||e.userData.customText){return undefined}return e}function l(t,e){const i=document.elementFromPoint(t,e);const s=h(i);if(s!==undefined){return s}for(const i of document.elementsFromPoint(t,e)){const t=h(i);if(t!==undefined){return t}}return null}var c=l(t,e);if(i){var u=3;var d=3;for(var m=e-d;m<e+d&&!c;m++){for(var p=t-u;p<t+u&&!c;p++){c=l(p,m)}}}if(s){return c}return c?c._getSceneTreeElement():null};V.prototype.tap=function(t,e,i){var s=this.getDomRef();if(s){s.focus()}var o=this.hitTest(t,e,true);if(this.isECAD()&&o){const t=this.findElement(o);if(t==null){return this}o=t}if(!i){this.tapObject(o);if(o!=null){this.fireNodeClicked({nodeRef:o,x:t,y:e},true,true)}}else if(!this.getFreezeCamera()){if(o&&this._camera.zoomedObject!==o){this._camera.zoomedObject=o;this.zoomTo(c.Node,this._camera.zoomedObject,.5,.1)}else{this._camera.zoomedObject=null;this.zoomTo(c.Visible,null,.5,0)}}return this};V.prototype.tapObject=function(t){var e={picked:t?[t]:[]};this.fireNodesPicked(e);if(this.isECAD()&&t){const i=t=>{if(t!=null){e.picked.push(t);t.children.forEach(i)}};e.picked=[];i(t)}if(this.getSelectionMode()===u.Exclusive){this.exclusiveSelectionHandler(e.picked)}else if(this.getSelectionMode()===u.Sticky){this.stickySelectionHandler(e.picked)}return this};var I={x:-2,y:-2};var H=2;var z=5;V.prototype.onkeydown=function(t){if(!t.isMarked()){switch(t.keyCode){case o.ARROW_LEFT:case o.ARROW_RIGHT:case o.ARROW_UP:case o.ARROW_DOWN:if(t.ctrlKey||t.altKey||t.metaKey){break}var e={x:0,y:0};switch(t.keyCode){case o.ARROW_LEFT:e.x=-1;break;case o.ARROW_RIGHT:e.x=+1;break;case o.ARROW_UP:e.y=-1;break;case o.ARROW_DOWN:e.y=+1;break;default:break}this.beginGesture(I.x,I.y);if(t.shiftKey){this.pan(z*e.x,z*e.y)}else{this.rotate(H*e.x,H*e.y,true)}this.endGesture();t.preventDefault();t.stopPropagation();break;case 189:case o.PLUS:case o.NUMPAD_MINUS:case o.NUMPAD_PLUS:this.beginGesture(this._width*.5,this._height*.5);this.zoom(t.keyCode===o.PLUS||t.keyCode===o.NUMPAD_PLUS?1.02:.98);this.endGesture();t.preventDefault();t.stopPropagation();break;case o.D:if(t.ctrlKey){this._dumpSceneData()}break;default:break}}};V.prototype._onOutliningOrSelectionChanged=function(t){var e=this.getTools();for(var s=0;s<e.length;s++){var o=i.getElementById(e[s]);var n=o.getGizmoForContainer(this);if(n&&n.handleSelectionChanged){n.handleSelectionChanged(t)}}this._invalidateRasterImage()};V.prototype.setSelectionRect=function(t){var e=document.getElementById(this._selectionRect.uid);if(e){if(t){e.removeAttribute("display");t=this._camera._transformRect(t);e.setAttribute("x",t.x1,t.x2);e.setAttribute("y",t.y1,t.y2);e.setAttribute("width",t.x2-t.x1);e.setAttribute("height",t.y2-t.y1)}else{e.setAttribute("display","none")}}};V.prototype._select=function(t){var e=this._getViewStateManagerSVG();if(e&&this._scene){t=this._camera._transformRect(t);var i=new Set;this._scene.getRootElement()._findRectElementsRecursive(i,t,e._mask);if(this.isECAD()&&i.size!==0){const t=new Set;const e=(t,i)=>{if(t!=null){i.add(t);t.children.forEach(t=>e(t,i))}};i.forEach(i=>{const s=this.findElement(i);if(s!=null){e(s,t)}});return Array.from(t)}return Array.from(i)}return[]};V.prototype.getImage=function(t,e,i,s,o){return null};V.prototype._setContent=function(t){B._setContent.apply(this,arguments);this._setScene(t instanceof p?t:null);if(this._measurementSurface!=null){this._measurementSurface.setScale(1)}return this};V.prototype.onSetContentConnector=function(t){e.prototype.onSetContentConnector.call(this,t);t.attachContentLoadingFinished(this._onContentLoadingFinished,this)};V.prototype.onUnsetContentConnector=function(t){t.detachContentLoadingFinished(this._onContentLoadingFinished,this);e.prototype.onUnsetContentConnector.call(this,t)};V.prototype._onContentLoadingFinished=function(t){if(this._scene){var e=this._scene.getDefaultNodeHierarchy();if(e){var i=this._getViewStateManagerSVG();var s=i&&i._mask||1;var o=this.getShowAllHotspots()?this.getShowAllHotspotsTintColor():null;var n=e.getHotspotNodeRefs();n.forEach(function(t){this._hotspotHelper.updateHotspot(t);if(o!=null){t.setHotspotColor(s,o)}if(this.getDisableHotspotHovering()){t.addClass("sapUiVizKitNonInteractiveHotspot")}},this)}if(this.isECAD()){this._pcbVisibleSurface=A.Bottom;this.flipPcb(true)}if(t&&(!this._camera._initialZoom||this._camera._initialZoom===-1)){this.zoomTo(c.All,null,0,0);this._camera._initialZoom=this._camera.getZoomFactor();this._camera._initialPosition=this._camera.getPosition()}this.invalidate()}};function N(t,e,i){return t+(e-t)*i}function k(t,e,i){i=Math.min(Math.max((i-t)/(e-t),0),1);return i*i*i*(i*(i*6-15)+10)}V.prototype._animLoop=function(){this._animLoopRequestId=0;var t=this._anim;if(t){var e=t.start;var i=t.end;var s=Date.now();var o=Math.min(k(0,1,(s-e.time)/t.duration),1);var n=this._camera.offsetX;var a=this._camera.offsetY;var r=this._camera.zoom;this._camera.offsetX=N(e.offsetX,i.offsetX,o);this._camera.offsetY=N(e.offsetY,i.offsetY,o);this._camera.zoom=N(e.zoom,i.zoom,o);if(this._redlineHandler){this._redlineHandler.pan(this._camera.offsetX-n,this._camera.offsetY-a);this._redlineHandler.zoom(this._camera.zoom/r,this._camera.offsetX,this._camera.offsetY)}this.fireCameraChanged({viewBox:this._getViewBox()});if(this._updateViewBox()&&s-e.time<t.duration){this._animLoopRequestId=window.requestAnimationFrame(this._animLoopFunction)}else{delete this._anim;this._endRasterMode()}}};V.prototype.getCurrentView=function(){return this._currentView};V.prototype._onViewStateApplied=function(t,e,i){if(i.source===this._getViewStateManagerSVG()){this.activateView(i.view)}};V.prototype.activateView=function(e){if(!this._scene){return this}var i=this._scene.getViewGroups();var s=this;if(i){i.forEach(function(t){t.getViews().forEach(function(i){if(i===e){s._currentViewIndex=t.getViews().indexOf(i)}})})}this.fireViewActivated({viewIndex:this._currentViewIndex,view:e});t.getEventBus().publish("sap.ui.vk","viewActivated",{source:this,view:e,viewIndex:this._currentViewIndex});this._currentView=e;var o=e.getCamera();if(o){this.setCamera(o)}var n=e.getTopColor();if(n!=null){if(Array.isArray(n)&&n.length>2){this.setBackgroundColorTop(w({red:Math.floor(n[0]*255),green:Math.floor(n[1]*255),blue:Math.floor(n[2]*255),alpha:n.length>3?n[3]:1}))}else{this.setBackgroundColorTop(n)}}var a=e.getBottomColor();if(a!=null){if(Array.isArray(a)&&a.length>2){this.setBackgroundColorBottom(w({red:Math.floor(a[0]*255),green:Math.floor(a[1]*255),blue:Math.floor(a[2]*255),alpha:a.length>3?a[3]:1}))}else{this.setBackgroundColorBottom(a)}}t.getEventBus().publish("sap.ui.vk","readyForAnimation",{source:this._getViewStateManagerSVG(),view:e,ignoreAnimationPosition:false});this.rerender();if(o?.zoom<=g._MIN_ZOOM){this.zoomTo(c.Visible,null,0,0)}this.fireViewFinished({viewIndex:this._currentViewIndex});return this};V.prototype.resetCurrentView=function(){if(this._currentView){this._getViewStateManagerSVG()._resetNodesStatusByCurrentView(this._currentView);this.rerender()}return this};V.prototype.zoomTo=function(t,e,i,s){if(this._width===0||this._height===0||this._scene==null){return this}var o={min:{x:Infinity,y:Infinity},max:{x:-Infinity,y:-Infinity}};var n=this._getViewStateManagerSVG();(Array.isArray(t)?t:[t]).forEach(function(t){switch(t){case c.All:this._scene.getRootElement()._expandBoundingBoxRecursive(o,-1>>>0);break;case c.Visible:if(n){this._scene.getRootElement()._expandBoundingBoxRecursive(o,n._mask)}break;case c.Selected:if(n){n.enumerateSelection(function(t){t._expandBoundingBoxRecursive(o,-1>>>0)})}break;case c.Node:if(!e){return}if(Array.isArray(e)){e.forEach(function(t){t._expandBoundingBoxRecursive(o,-1>>>0)})}else{e._expandBoundingBoxRecursive(o,-1>>>0)}break;case c.Restore:E.error(d().getText("VIEWPORT_MSG_RESTORENOTIMPLEMENTED"));return;case c.NodeSetIsolation:E.error(d().getText("VIEWPORT_MSG_NODESETISOLATIONNOTIMPLEMENTED"));return;case c.RestoreRemoveIsolation:E.error(d().getText("VIEWPORT_MSG_RESTOREREMOVEISOLATIONNOTIMPLEMENTED"));return;case c.ViewLeft:case c.ViewRight:case c.ViewTop:case c.ViewBottom:case c.ViewBack:case c.ViewFront:return;default:break}}.bind(this));if(o.min.x>=o.max.x||o.min.y>=o.max.y){o={min:{x:0,y:0},max:{x:1,y:1}}}var a=new g;a._zoomTo(o,this._width,this._height,s);this._activateCamera(a,i);return this};V.prototype._activateCamera=function(t,e){if(e>0&&!this._animLoopRequestId){this._anim={start:{time:Date.now(),offsetX:this._camera.offsetX,offsetY:this._camera.offsetY,zoom:this._camera.zoom},end:{offsetX:t.offsetX,offsetY:t.offsetY,zoom:t.zoom},duration:e*1e3};this._startRasterMode();this._animLoopRequestId=window.requestAnimationFrame(this._animLoopFunction)}else{if(this._redlineHandler){this._redlineHandler.pan(t.offsetX-this._camera.offsetX,t.offsetY-this._camera.offsetY);this._redlineHandler.zoom(t.zoom/this._camera.zoom,t.offsetX,t.offsetY)}this._camera.zoom=t.zoom;this._camera.offsetX=t.offsetX;this._camera.offsetY=t.offsetY;this._updateViewBox();this._invalidateRasterImage();this.fireCameraChanged({viewBox:this._getViewBox()})}};V.prototype.beginGesture=function(t,e){this._gestureX=(t-this._camera.offsetX)/this._camera.zoom;this._gestureY=(e-this._camera.offsetY)/this._camera.zoom};V.prototype.endGesture=function(){this._gestureX=0;this._gestureY=0;this._endRasterMode()};function D(t,e,i){if(t.width!==e*devicePixelRatio||t.height!==i*devicePixelRatio){t.width=e*devicePixelRatio;t.height=i*devicePixelRatio;t.style.width=e+"px";t.style.height=i+"px"}}V.prototype.invalidate=function(){e.prototype.invalidate.call(this);if(this.raster){this._invalidateRasterImage()}};V.prototype._invalidateRasterImage=function(){if(this.raster.updateImageTimer){clearTimeout(this.raster.updateImageTimer);this.raster.updateImageTimer=null}if(this.raster.useRasterMode){this.raster.updateImageTimer=setTimeout(this._updateRasterImage.bind(this),100)}};V.prototype._updateRasterImage=function(){this.raster.updateImageTimer=null;if(this._svgElement==null||!this.raster.useRasterMode||!this.raster.bmpCanvas){return}var t=Math.round(Math.max(Math.max(this._width,this._height)*.5,512));var e=this._width+t;var i=this._height+t;var s=e/this._width;var o=i/this._height;var n=this._getViewBox();var a=[n[0]-n[2]*(s-1)*.5,n[1]-n[3]*(o-1)*.5,n[2]*s,n[3]*o];this._svgElement.setAttribute("width",e+"px");this._svgElement.setAttribute("height",i+"px");this._svgElement.setAttribute("viewBox",a.join(" "));var r=(new XMLSerializer).serializeToString(this._svgElement);var h="data:image/svg+xml; charset=utf8, "+encodeURIComponent(r);this._svgElement.setAttribute("width","100%");this._svgElement.setAttribute("height","100%");this._svgElement.setAttribute("viewBox",n.join(" "));this.raster.vectorImage.viewBox=a;this.raster.vectorImage.src=h};V.prototype._startRasterMode=function(t){if(this.raster.endRasterModeTimer){clearTimeout(this.raster.endRasterModeTimer);this.raster.endRasterModeTimer=null}if(this.raster.updateImageTimer){clearTimeout(this.raster.updateImageTimer);this.raster.updateImageTimer=null}if(this.raster.rasterMode||!this.raster.useRasterMode||this._svgElement==null){return}this.raster.rasterMode=true;this.raster.delayEnd=t;this._svgElement.style.display="none";this.raster.bmpCanvas.style.display="block";this._requestBmpDraw()};V.prototype._endRasterMode=function(){if(!this.raster.rasterMode){return}var t=function(){this.raster.bmpCanvas.style.display="none";this._svgElement.style.display="";this.raster.rasterMode=false;this._invalidateRasterImage()}.bind(this);if(this.raster.delayEnd){this.raster.endRasterModeTimer=setTimeout(function(){this.raster.endRasterModeTimer=null;t()}.bind(this),500)}else{t()}};V.prototype.pan=function(t,e){if(!this.getFreezeCamera()){this._startRasterMode();this._camera.offsetX+=t;this._camera.offsetY+=e;this._updateViewBox();if(this._redlineHandler){this._redlineHandler.pan(t,e)}this.fireCameraChanged({viewBox:this._getViewBox()})}};V.prototype.rotate=function(t,e){this.pan(t,e)};V.prototype.zoom=function(t){if(!this.getFreezeCamera()){this._startRasterMode(true);var e=this._camera.zoom;this._camera.zoom=Math.max(this._camera.zoom*t,g._MIN_ZOOM);this._camera.offsetX+=this._gestureX*(e-this._camera.zoom);this._camera.offsetY+=this._gestureY*(e-this._camera.zoom);if(this._redlineHandler){this._redlineHandler.zoom(this._camera.zoom/e)}this._updateViewBox();this.fireCameraChanged({viewBox:this._getViewBox()})}};V.prototype.hover=function(t,e){var i=this._getViewStateManagerSVG();if(!i){return}var s=this.getDisableHotspotHovering()?null:this.hitTest(t,e);var o=false;if(this._hotspotElement&&this._hotspotElement!==s){this.fireHotspotLeave({nodeRef:this._hotspotElement});if(!this.getShowAllHotspots()){this._hotspotElement.setHotspotColor(i._mask,null)}this._hotspotElement=null;o=true}if(this._dynamicContentElement&&this._dynamicContentElement!==s){this.fireHotspotLeave({nodeRef:this._dynamicContentElement});if(!this.getShowAllDynamicContents()){this._dynamicContentElement.setHotspotColor(i._mask,null)}this._dynamicContentElement=null;o=true}if(s&&s._vkGetNodeContentType()===f.Hotspot){this._hotspotElement=s;if(!this.getShowAllHotspots()){s.setHotspotColor(i._mask,this.getHotspotColorABGR())}this.fireHotspotEnter({nodeRef:s});o=true}if(s&&s._vkGetNodeContentType()===f.DynamicContent){this._dynamicContentElement=s;if(!this.getShowAllDynamicContents()){s.setHotspotColor(i._mask,this.getHotspotColorABGR())}this.fireHotspotEnter({nodeRef:s});o=true}if(o){this._invalidateRasterImage()}};V.prototype._getViewBox=function(){return this._camera._getViewBox()};V.prototype._requestBmpDraw=function(){if(this.raster.rasterMode){this.raster.bmpDrawRequestId=this.raster.bmpDrawRequestId||window.requestAnimationFrame(this._bmpDraw.bind(this))}};V.prototype._bmpDraw=function(){this.raster.bmpDrawRequestId=null;var t=this._getViewBox();var e=this.raster.rasterImage;var i=this.raster.bmpCanvas;D(i,this._width,this._height);var s=i.getContext("2d");s.resetTransform();s.clearRect(0,0,i.width,i.height);var o=e.viewBox;if(o){var n=this._camera._worldToScreen(o[0],o[1]);var a=this._camera._worldToScreen(t[0],t[1]);s.translate((n.x-a.x)*devicePixelRatio,(n.y-a.y)*devicePixelRatio);s.scale(o[2]*i.width/(t[2]*e.width),o[3]*i.height/(t[3]*e.height));s.imageSmoothingEnabled=true;s.imageSmoothingQuality="high";s.drawImage(e,0,0)}};V.prototype._updateViewBox=function(){if(this._svgElement==null){return false}this._requestBmpDraw();if(this._measurementSurface!=null){this._measurementSurface.update(this,this.getCamera())}this._svgElement.setAttribute("viewBox",this._getViewBox().join(" "));return true};V.prototype.getViewInfo=function(t){var e={};if(t==null){t={}}if(t.camera==null){t.camera=true}if(t.camera){e.camera={viewBox:this._getViewBox()}}if(t.visibility&&this._viewStateManager){var i=t.visibility.mode==null?l.Complete:t.visibility.mode;e.visibility={mode:i};if(i===l.Complete){var s=this._viewStateManager.getVisibilityComplete();e.visibility.visible=s.visible;e.visibility.hidden=s.hidden}else if(this._viewStateManager.getShouldTrackVisibilityChanges()){e.visibility.changes=this._viewStateManager.getVisibilityChanges()}else{E.warning(d().getText(m.VIT32.summary),m.VIT32.code,"sap.ui.vk.threejs.Viewport")}}var o=this._getViewStateManagerSVG();if(t.selection&&o){e.selection=o._getSelectionComplete()}return e};V.prototype.setViewInfo=function(t,e){var i=t.camera;if(i&&i.viewBox){var s=new g;s._setViewBox(i.viewBox,this._width,this._height);this._activateCamera(s,e)}var o=new Map;if(t.visibility||t.selection){var n=this._viewStateManager.getNodeHierarchy(),a=n.findNodesByName();a.forEach(function(t){var e=n.createNodeProxy(t);var i=e.getVeId();n.destroyNodeProxy(e);if(i){o.set(i,t)}})}if(t.visibility){switch(t.visibility.mode){case l.Complete:const e=t.visibility.visible.map(t=>o.get(t)).filter(t=>t!=null),i=t.visibility.hidden.map(t=>o.get(t)).filter(t=>t!=null);this._viewStateManager.setVisibilityState(e,true,false);this._viewStateManager.setVisibilityState(i,false,false);break;case l.Differences:this._viewStateManager.resetVisibility();t.visibility.changes.forEach(function(t){var e=o.get(t);if(e){this._viewStateManager.setVisibilityState(e,!this._viewStateManager.getVisibilityState(e),false)}},this);break;default:E.error(d().getText(m.VIT28.summary),m.VIT28.code,"sap.ui.vk.threejs.Viewport");break}}var r=this._getViewStateManagerSVG();var h=t.selection;if(h&&r){var c=r._getSelectionComplete();if(Array.isArray(h.selected)){var u=[];var f=[];h.selected.forEach(function(t){var e=o.get(t);if(e){u.push(e)}});c.selected.forEach(function(t){var e=o.get(t);if(e&&h.selected.indexOf(t)<0){f.push(e)}});r.setSelectionStates(u,f,false,false)}}return this};V.prototype.queueCommand=function(t){if(this instanceof V){t()}return this};V.prototype.getOutputSize=function(){var t=this.getDomRef().getBoundingClientRect();var e=t.width;var i=t.height;var s;s=Math.min(e,i);return{left:(e-s)*.5,top:(i-s)*.5,sideLength:s}};V.prototype.setShouldRenderFrame=function(){this.invalidate()};V.prototype._isPanoramicActivated=function(){return false};V.prototype.setShowAllHotspots=function(t){this.setProperty("showAllHotspots",t,true);var e=this._getViewStateManagerSVG();if(e){var i=e._mask;var s=e.getNodeHierarchy().getHotspotNodeRefs();var o=this._hotspotElement;var n=this.getShowAllHotspotsTintColor();s.forEach(function(e){if(t){e.setHotspotColor(i,n)}else if(e===o){e.setHotspotColor(i,this.getHotspotColorABGR())}else{e.setHotspotColor(i,null)}},this);if(s.length>0){this.invalidate()}}};V.prototype.setDisableHotspotHovering=function(t){this.setProperty("disableHotspotHovering",t,true);if(t){this.hover(0,0)}var e=this._getViewStateManagerSVG();if(e){var i=e.getNodeHierarchy().getHotspotNodeRefs();i.forEach(function(e){if(t){e.addClass("sapUiVizKitNonInteractiveHotspot")}else{e.removeClass("sapUiVizKitNonInteractiveHotspot")}})}};V.prototype.setHotspotColorABGR=function(t){this.setProperty("hotspotColorABGR",t,true);this.setProperty("hotspotColor",w(b(t)),true);this.invalidate();return this};V.prototype.setHotspotColor=function(t){this.setProperty("hotspotColor",t,true);this.setProperty("hotspotColorABGR",S(C(t)),true);this.invalidate();return this};V.prototype.showHotspots=function(t,e,i){if(t==null){return this}if(!Array.isArray(t)){t=[t]}var s=e?i||this.getHotspotColorABGR():null;var o=this._getViewStateManagerSVG()._mask;t.forEach(function(t){t.setCustomHotspotColor(o,s)});this.invalidate();return this};V.prototype.setShowAllDynamicContents=function(t){this.setProperty("showAllDynamicContents",t,true);const e=this._getViewStateManagerSVG();if(e){const i=e._mask;const s=e.getNodeHierarchy().getDynamicContentNodeRefs();const o=this._dynamicContentElement;const n=this.getShowAllHotspotsTintColor();s.forEach(function(e){if(t){e.setHotspotColor(i,n)}else if(e===o){e.setHotspotColor(i,this.getHotspotColorABGR())}else{e.setHotspotColor(i,null)}},this);if(s.length>0){this.invalidate()}}};V.prototype._getFillStyleId=function(t){if(t.highlightColor||t.tintColor){return null}var e;if(t.fillStyle&&t.fillStyle.veid!==undefined){e="f"+t.fillStyle.veid}else if(t.fill!==undefined&&t.fill[3]===0){e="fn"}else{return null}if(!this._styles.has(e)){var i=[];t._setFillStyleAttributes(function(t,e){i.push(t,e)});this._styles.set(e,i)}return e};V.prototype._getLineStyleId=function(t){if(t.highlightColor||t.tintColor){return null}var e;if(t.lineStyle&&t.lineStyle.veid!==undefined){e="l"+t.lineStyle.veid}else if(t.materialId){e="m"+t.materialId}else{return null}if(!this._styles.has(e)){var i=[];t._setLineStyleAttributes(function(t,e){i.push(t,e)});this._styles.set(e,i)}return e};V.prototype.getMeasurementSurface=function(){return this._measurementSurface};V.prototype._dumpSceneData=function(){var t=this._scene.getDefaultNodeHierarchy();var e=t.findNodesByName();var i=E.getLevel();E.setLevel(E.Level.INFO);E.info("**************************************");E.info("Nodes in the scene: "+e.length);var s=0;var o=0;var n=0;var a=0;var r=document.getElementsByTagName("svg")[0];var h=function(t){s+=t.children.length;var e=t;var i=1;while(e!=r){e=e.parentNode;i++}if(o<i){o=i}if(t.children.length===0){n++;if(t.tagName==="g"){a++}}for(var l=0;l<t.children.length;l++){h(t.children[l])}};h(r);E.info("DOM statistics:");E.info("    Nodes:      "+s);E.info("    Tree depth: "+o);E.info("    Leaf nodes: "+n);E.info("    Empty nodes:"+a);E.info("    Groups:     "+document.getElementsByTagName("g").length);E.info("    Lines:      "+document.getElementsByTagName("line").length);E.info("    Polylines:   "+document.getElementsByTagName("polyline").length);E.info("    Polygons:   "+document.getElementsByTagName("polygon").length);E.info("    Paths:      "+document.getElementsByTagName("path").length);E.info("    Ellipses:   "+document.getElementsByTagName("ellipse").length);E.info("    Rectangles: "+document.getElementsByTagName("rect").length);E.info("    Texts:      "+document.getElementsByTagName("text").length);E.info("    Images:     "+document.getElementsByTagName("image").length);E.info("**************************************");E.setLevel(i)};V.prototype.projectToScreen=function(t,e,i,s){var o=s._worldToScreen(t,e,0);o.z=0;return o};V.prototype.isECAD=function(){return this._scene?.isECADScene()??false};V.prototype._extractMetadata=function(t){if(t.length!=undefined){const e=new Map;t.forEach(function(t){if(t.category==="ecad"){e.set(t.tag,t.value)}});return e}return null};V.prototype._extractLayersZone=function(){const t=new Map;const e=this._scene.getSceneMetadata();const i=e.find(t=>t.category==="ecad"&&t.tag==="Layers");if(i){const s=i.value.split("|");s.forEach(function(i){const s=e.find(t=>t.category===i&&t.tag==="Zone");t.set(i,s?s.value:A.Unknown)},this)}return t};V.prototype._scanTree=function(t,e){const i=this._extractMetadata(e.userData.metadata||{});if(i){const s=i.get("layer");if(s){const i=t.get(s);switch(i){case A.Top:this._topElements.push(e);break;case A.Bottom:this._bottomElements.push(e);break;default:break}return}}e.children.forEach(this._scanTree.bind(this,t))};function P(t){const e=Math.sin(t);const i=Math.cos(t);return[i,-e,e,i,0,0]}V.prototype._setRootTransform=function(){const t=P(this._pcbRotateAngle);const e=[this._pcbVisibleSurface===A.Top?1:-1,0,0,1,0,0];const i=this._scene.getRootElement();i.setMatrix(R._multiplyMatrices(e,t))};V.prototype.findElement=function(t){while(t!=null){const e=this._extractMetadata(t.userData.metadata??{});if(e?.has("type")){return t}t=t.parent}return null};V.prototype.rotatePcbCW=function(){if(this.isECAD()){this._pcbRotateAngle+=this._pcbVisibleSurface===A.Top?-Math.PI/2:Math.PI/2;this._setRootTransform();this.zoomTo(c.Visible)}};V.prototype.rotatePcbCCW=function(){if(this.isECAD()){this._pcbRotateAngle+=this._pcbVisibleSurface===A.Top?Math.PI/2:-Math.PI/2;this._setRootTransform();this.zoomTo(c.Visible)}};V.prototype.flipPcb=function(t){if(this.isECAD()&&this._viewStateManager){this._pcbVisibleSurface=this._pcbVisibleSurface===A.Top?A.Bottom:A.Top;if(!t){this._setRootTransform();this.zoomTo(c.Visible)}this._viewStateManager.setVisibilityState(this._scene.getRootElement(),false,true,true);switch(this._pcbVisibleSurface){case A.Top:this._viewStateManager.setVisibilityState(this._topElements,true,true,true);break;case A.Bottom:this._viewStateManager.setVisibilityState(this._bottomElements,true,true,true);break;default:break}}};return V});
//# sourceMappingURL=Viewport.js.map