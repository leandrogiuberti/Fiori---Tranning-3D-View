/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["sap/base/Log","../Core","../ViewStateManagerBase","../cssColorToColor","../colorToCSSColor","../abgrToColor","../colorToABGR","../AnimationTrackType","../NodeContentType","./Scene","./Element","sap/ui/base/DataType","sap/ui/core/Element"],function(t,e,i,r,n,s,a,o,h,l,c,u,f){"use strict";var d;var p=i.extend("sap.ui.vk.svg.ViewStateManager",{metadata:{library:"sap.ui.vk"}});var y=p.getMetadata().getParent().getClass().prototype;p.prototype.init=function(){if(y.init){y.init.call(this)}this._mask=1|0;this._nodeHierarchy=null;this._selectedNodes=new Set;this._visibilityTracker=new d;this.setHighlightColor(3204448443);e.getEventBus().subscribe("sap.ui.vk","activateView",this._onActivateView,this)};p.prototype.exit=function(){e.getEventBus().unsubscribe("sap.ui.vk","activateView",this._onActivateView,this)};p.prototype._setContent=function(t){if(t===this._scene){return this}var e=null;if(t&&t instanceof l){e=t}this._setScene(e);if(e){var i=e.getInitialView();if(i){this._currentView=i;this._resetNodesStatusByCurrentView(this._currentView)}}return this};p.prototype._setScene=function(t){this._setNodeHierarchy(t?t.getDefaultNodeHierarchy():null);if(t){t.setViewStateManager(this)}this._scene=t;return this};p.prototype._setNodeHierarchy=function(t){var e=this._nodeHierarchy;if(this._nodeHierarchy){this._nodeHierarchy=null;this._selectedNodes.clear();this._visibilityTracker.clear()}if(t){this._nodeHierarchy=t;this._nodeHierarchy.attachNodeReplaced(this._handleNodeReplaced,this);this._nodeHierarchy.attachNodeUpdated(this._handleNodeUpdated,this);this._nodeHierarchy.attachNodeRemoving(this._handleNodeRemoving,this);this._initialState={visible:[],hidden:[]};var i=this;var r=t.findNodesByName();r.forEach(function(t){(t.isVisible(i._mask)?i._initialState.visible:i._initialState.hidden).push(t)});this.fireVisibilityChanged({visible:this._initialState.visible,hidden:this._initialState.hidden})}if(t!==e){this.fireNodeHierarchyReplaced({oldNodeHierarchy:e,newNodeHierarchy:t})}return this};p.prototype._handleNodeReplaced=function(t){var e=t.getParameter("ReplacedNodeRef");var i=t.getParameter("ReplacementNodeRef");if(this.getSelectionState(e)){this.setSelectionStates(i,e)}};p.prototype._handleNodeUpdated=function(t){var e=t.getParameter("nodeRef");if(this.getSelectionState(e)){this.setSelectionStates([],e);this.setSelectionStates(e,[])}};p.prototype._handleNodeRemoving=function(t){var e=t.getParameter("nodeRef");if(this.getSelectionState(e)){this.setSelectionStates([],e,true,true)}};p.prototype.getNodeHierarchy=function(){return this._nodeHierarchy};p.prototype.getVisibilityChanges=function(){return this.getShouldTrackVisibilityChanges()?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null};p.prototype.getCurrentView=function(){var t=f.getElementById(this.getViewManager());if(!t){return null}var e=t.getActiveView();return e};p.prototype.getVisibilityComplete=function(){var t=this.getNodeHierarchy(),e=t.findNodesByName(),i=[],r=[];e.forEach(function(e){var n=t.createNodeProxy(e);var s=n.getVeId();t.destroyNodeProxy(n);if(s){if(this.getVisibilityState(e)){i.push(s)}else{r.push(s)}}},this);return{visible:i,hidden:r}};p.prototype.resetVisibility=function(){this.setVisibilityState(this._initialState.visible,true,false);this.setVisibilityState(this._initialState.hidden,false,false);this._visibilityTracker.clear();return this};p.prototype.getVisibilityState=function(t){var e=this._mask;if(Array.isArray(t)){return t.map(function(t){return t?t.isVisible(e):false})}return t?t.isVisible(e):false};p.prototype.setVisibilityState=function(t,e,i,r){if(!Array.isArray(t)){t=[t]}var n=Array.isArray(e);var s=[];var a=t;if(i){a=[];t.forEach(function(t,i){var r=this._collectNodesRecursively(t);a=a.concat(r);var o=s.length;s.length=o+r.length;s.fill(n?e[i]:e,o)},this)}else if(!n){s.length=a.length;s.fill(e)}else{s=e}var o=[];var h=new Set;var l=this._mask;var c=a.filter(function(t,e){if(h.has(t)){return false}h.add(t);var i=t?t.isVisible(l)!=s[e]:false;if(i){o.push(s[e])}return i},this);if(c.length>0){var u={visible:[],hidden:[]};c.forEach(function(t,e){if(o[e]){t.setVisible(l,true);u.visible.push(t);if(r){var i=t.parent;while(i){i.setVisible(l,true);i=i.parent}}}else{t.setVisible(l,false);u.hidden.push(t)}},this);if(this.getShouldTrackVisibilityChanges()){c.forEach(this._visibilityTracker.trackNodeRef,this._visibilityTracker)}this.fireVisibilityChanged(u)}return this};p.prototype.enumerateSelection=function(t){this._selectedNodes.forEach(t);return this};p.prototype.getSelectionState=function(t){var e=this._selectedNodes;function i(t){return e.has(t)}return Array.isArray(t)?t.map(i):i(t)};p.prototype._getSelectionComplete=function(){var t=this.getNodeHierarchy(),e=[];function i(e){var i=t.createNodeProxy(e);var r=i.getVeId();t.destroyNodeProxy(i);return r}this._selectedNodes.forEach(function(t){var r=i(t);if(r){e.push(r)}});return{selected:e}};p.prototype._isAncestorSelected=function(t){t=t.parent;while(t){if(this._selectedNodes.has(t)){return true}t=t.parent}return false};p.prototype._updateHighlightColor=function(t,e){var i=e||this._selectedNodes.has(t);t.setSelected(this._mask,i,this._highlightColorABGR);if(t.nodeContentType!==h.Hotspot&&t.nodeContentType!==h.DynamicContent){var r=t.children;for(var n=0,s=r.length;n<s;n++){this._updateHighlightColor(r[n],i)}}};p.prototype.setSelectionState=function(t,e,i,r){if(!Array.isArray(t)){t=[t]}t=(i||this.getRecursiveSelection()?this._collectNodesRecursively(t):t).filter(function(t,e,i){return i.indexOf(t)===e});if(this.getRecursiveSelection()&&!e){t=this._nodeHierarchy._appendAncestors(t)}var n=t.filter(function(t){return this._selectedNodes.has(t)!==e},this);if(n.length>0){n.forEach(function(t){if(t){this._selectedNodes[e?"add":"delete"](t)}},this);n.forEach(function(t){if(t){this._updateHighlightColor(t,e||this._isAncestorSelected(t))}},this);if(!r){this.fireSelectionChanged({selected:e?n:[],unselected:e?[]:n})}}return this};p.prototype.setSelectionStates=function(t,e,i,r){if(!Array.isArray(t)){t=[t]}if(!Array.isArray(e)){e=[e]}t=i||this.getRecursiveSelection()?this._collectNodesRecursively(t):t;e=i||this.getRecursiveSelection()?this._collectNodesRecursively(e):e;if(this.getRecursiveSelection()){e=this._nodeHierarchy._appendAncestors(e,t)}var n=t.filter(function(t){return t&&this._selectedNodes.has(t)===false},this);var s=e.filter(function(t){return t&&this._selectedNodes.has(t)===true},this);if(n.length>0||s.length>0){n.forEach(function(t){this._selectedNodes.add(t);this._updateHighlightColor(t,true)},this);s.forEach(function(t){this._selectedNodes.delete(t)},this);s.forEach(function(t){this._updateHighlightColor(t,this._isAncestorSelected(t))},this);if(!r){this.fireSelectionChanged({selected:n,unselected:s})}}return this};p.prototype._collectNodesRecursively=function(t){var e=[],i=this;if(!Array.isArray(t)){t=[t]}t.forEach(function t(r){e.push(r);i._nodeHierarchy.enumerateChildren(r,t,false,true)});return e};p.prototype._getOpacity=function(t){return t.opacity!==undefined?t.opacity:null};p.prototype.getOpacity=function(t){if(Array.isArray(t)){return t.map(this._getOpacity,this)}else{return this._getOpacity(t)}};p.prototype.setTotalOpacity=function(t,e){this.setOpacity(t,e);return{opacity:e,totalOpacity:e}};p.prototype.setOpacity=function(t,e,i){if(!Array.isArray(t)){t=[t]}var r=Array.isArray(e);if(e===null){e=undefined}else if(r){e.forEach(function(t,i){if(t===null){e[i]=undefined}})}var n=[];var s=t;if(!r){n.length=s.length;n.fill(e)}else{n=e}var a=[];var o=new Set;var h=s.filter(function(t,e){if(o.has(t)){return false}o.add(t);var i=t?t.opacity!==n[e]:false;if(i){a.push(n[e])}return i},this);if(h.length>0){h.forEach(function(t,e){t.setOpacity(a[e])},this);this.fireOpacityChanged({changed:h,opacity:r?a:a[0]})}return this};p.prototype._getTintColorABGR=function(t){return t.tintColor!==undefined?t.tintColor:null};p.prototype._getTintColor=function(t){return t.tintColor!==undefined?n(s(t.tintColor)):null};p.prototype.getTintColor=function(t,e){var i=e?"_getTintColorABGR":"_getTintColor";if(Array.isArray(t)){return t.map(this[i],this)}else{return this[i](t)}};function g(t){switch(typeof t){case"number":return t>>>0;case"string":const e=u.getType("sap.ui.core.CSSColor");return e.isValid(t)?a(r(t)):undefined;default:return undefined}}p.prototype.setTintColor=function(t,e,i){if(!Array.isArray(t)){t=[t]}var r=Array.isArray(e);var n=[];var s=t;if(i){s=[];t.forEach(function(t,i){var a=this._collectNodesRecursively(t);s=s.concat(a);var o=n.length;n.length=o+a.length;n.fill(r?e[i]:e,o)},this)}else if(!r){n.length=s.length;n.fill(e)}else{n=e}var a=[];var o=new Set;var h=s.filter(function(t,e){if(o.has(t)){return false}o.add(t);var i=t?t.tintColor!==g(n[e]):false;if(i){a.push(n[e])}return i},this);if(h.length>0){var l=this._mask;var c=[];h.forEach(function(t,e){var i=g(a[e]);t.setTintColor(l,i);c.push(i)},this);var u={changed:h,tintColor:r?a:a[0],tintColorABGR:r?c:c[0]};this.fireTintColorChanged(u)}return this};p.prototype.setHighlightColor=function(t){t=g(t);if(t===undefined){return this}this._highlightColorABGR=t;if(this._selectedNodes.size>0){this._selectedNodes.forEach(function(t){this._updateHighlightColor(t,true)},this)}this.fireHighlightColorChanged({highlightColor:n(s(t)),highlightColorABGR:t});return this};p.prototype.getHighlightColor=function(t){return t?this._highlightColorABGR:n(s(this._highlightColorABGR))};p.prototype.getTransformationWorld=function(t){function e(t){return c._decompose(t._matrixWorld())}if(!Array.isArray(t)){return e(t)}var i=[];t.forEach(function(t){i.push(e(t))});return i};p.prototype.getTransformation=function(t){function e(t){var e=c._decompose(t.matrix);return{translation:e.position,quaternion:e.quaternion,scale:e.scale}}if(!Array.isArray(t)){return e(t)}var i=[];t.forEach(function(t){i.push(e(t))});return i};function v(t){if(t.length===3){return new Float32Array([1,0,0,1,t[0],t[1]])}else if(t.length===12){return new Float32Array([t[0],t[1],t[3],t[4],t[9],t[10]])}else if(t.length===16){return new Float32Array([t[0],t[1],t[4],t[5],t[12],t[13]])}else{throw new Error("Invalid matrix format")}}p.prototype.setTransformation=function(e,i){var r=Array.isArray(e);if(!Array.isArray(e)){e=[e]}var n={changed:[],transformation:[]};var s=function(t){return c._decompose(t.matrix)};if(!i){e.forEach(function(t){if(t.userData.matrix){t.setMatrix(t.userData.matrix);delete t.userData.matrix}n.changed.push(t);n.transformation.push(s(t))},this)}else{if(!Array.isArray(i)){i=[i]}e.forEach(function(e,r){if(!e.userData.matrix){e.userData.matrix=e.matrix.slice()}var a=i[r];if(a.transform){e.setMatrix(v(a.transform))}else{var o;if(a.quaternion){o=a.quaternion}else if(a.angleAxis){var h=a.angleAxis;var l=h[3]/2,u=Math.sin(l);o=[h[0]*u,h[1]*u,h[2]*u,Math.cos(l)]}else if(a.euler){t.warning("svg.ViewStateManager.setTransformation: Euler angles are not yet supported");o=[0,0,0,1]}var f=c._compose(a.translation,o,a.scale);e.setMatrix(f)}n.changed.push(e);n.transformation.push(s(e))},this)}if(!r){n.changed=n.changed[0];n.transformation=n.transformation[0]}this.fireTransformationChanged(n);return this};p.prototype._resetNodesStatusByCurrentView=function(t){var e=this.getNodeHierarchy();var i=t.getNodeInfos();if(!e||!i){return}var r=[];var n=[];i.forEach(function(t){if(t.target){if(t.transform){r.push(t.target);n.push({transform:t.transform})}else if(t[o.Translate]&&t[o.Rotate]&&t[o.Scale]){r.push(t.target);n.push({translation:t[o.Translate].slice(),quaternion:t[o.Rotate].slice(),scale:t[o.Scale].slice()})}}});if(t.userData&&t.userData.nodeStartDataByAnimation){t.userData.nodeStartDataByAnimation.forEach(function(t,e){if(t[o.Translate]&&t[o.Rotate]&&t[o.Scale]){r.push(e);n.push({translation:t[o.Translate].slice(),quaternion:t[o.Rotate].slice(),scale:t[o.Scale].slice()})}})}if(r.length){this.setTransformation(r,n)}var s=[];var a=[];i.forEach(function(t){if(!t.target.userData.skipIt){(t.visible?s:a).push(t.target)}});this.setVisibilityState(e.getChildren()[0].children,false,true);this.setVisibilityState(s,true,false);this.setVisibilityState(a,false,false)};p.prototype._onActivateView=function(t,e,i){var r=this.getViewManager();if(r&&i.source.getId()===r){this.activateView(i.view)}};p.prototype.activateView=function(t){this.fireViewStateApplying({view:t});this._resetNodesStatusByCurrentView(t);this.fireViewStateApplied({view:t});e.getEventBus().publish("sap.ui.vk","viewStateApplied",{source:this,view:t});return this};p.prototype.setJoints=function(t,e){return this};p.prototype._propagateOpacityToJointChildren=function(t,e){return this};p.prototype._setJointNodeMatrix=function(){return this};d=function(){this._visibilityChanges=new Set};d.prototype.getInfo=function(t){var e=[];this._visibilityChanges.forEach(function(i){var r=t.createNodeProxy(i);var n=r.getVeId();t.destroyNodeProxy(r);if(n){e.push(n)}else{e.push(t.getScene().nodeRefToPersistentId(i))}});return e};d.prototype.clear=function(){this._visibilityChanges.clear()};d.prototype.trackNodeRef=function(t){if(this._visibilityChanges.has(t)){this._visibilityChanges.delete(t)}else{this._visibilityChanges.add(t)}};return p});
//# sourceMappingURL=ViewStateManager.js.map