/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","./Element","./Ellipse","./Rectangle","./Line","./Polyline","./Path","./Text","./Image","./LinearGradient","./OrthographicCamera","../View","../NodeContentType","../NavigationMode","../TransformationMatrix","../getResourceBundle","../totara/TotaraUtils","../colorToCSSColor","./SvgImage"],function(e,t,i,a,r,s,n,o,h,d,l,u,p,c,m,f,_,v,g){"use strict";var y=function(e,t,i,a){this._rootNode=e;this._contentResource=t;this._resolve=i;this._reject=a;this._cameras=new Map;this._sceneIdTreeNodesMap=new Map;this._sceneIdRootNodeMap=new Map;this._materialMap=new Map;this._annotationsMap=new Map;this._annotationNodesMap=new Map;this._materialNodesMap=new Map;this._nodes=new Map;this._viewGroups=new Map;this._views=new Map;this._viewThumbnails=new Map;this._geometries=new Map;this._geometryMeshes=new Map;this._meshNodes=new Map;this._meshSubmeshes=new Map;this._images=new Map;this._imageTextures=new Map;this._fillStyles=new Map;this._lineStyles=new Map;this._textStyles=new Map;this._joints=new Map;this._yIndex=1;this._materialsByTextureImageId=new Map;if(t){var r=t.getNodeProxy();var s=r.getNodeHierarchy();this._vkScene=s.getScene();var n=t.getSource();if(n&&n.name){this._sceneIdTreeNodesMap.set(n.name,this._nodes);this._sceneIdRootNodeMap.set(n.name,e);this._currentSceneId=n.name}if(this._rootNode){this._rootNode.userData.skipIt=!t.getName()}}};y.prototype.setScene=function(t){this._yIndex=1;this._rootNode.matrix[3]=t.upAxis===2||t.upAxis===4?-1:1;const i=this._cameras.get(t.cameraId);const a=t.outputSettings;if(a&&i){const e=72;const i=1/25.4;const r=4/3;const s=i*e*r;const n=Math.min(a.width,a.height)*s;this._materialMap.forEach(function(e){if(e.lineStyle.widthCoordinateSpace===4){if(!t.showPaperSpace){e.lineWidth=e.lineStyle.width*1024/n;e.lineStyle.widthCoordinateSpace=0}}})}e.info("setScene",JSON.stringify(t),i);this._resolve?.({node:this._rootNode,camera:i,backgroundTopColor:t.backgroundTopColor,backgroundBottomColor:t.backgroundBottomColor,outputSettings:a,contentResource:this._contentResource,builder:this})};y.prototype.setRootNode=function(e,t,i,a){this._rootNode=e;e.sid=t;this._nodes.set(t,e);this._viewGroups=new Map;this._views=new Map;if(i){this._sceneIdTreeNodesMap.set(i,this._nodes);this._sceneIdRootNodeMap.set(i,e);this._currentSceneId=i}if(a){this._vkScene=a;if(this._sceneMetadata){this._vkScene.setSceneMetadata(this._sceneMetadata)}}return this};y.prototype.setNodePersistentId=function(e,t,i){this._resetCurrentScene(i);e.sid=t;this._nodes.set(t,e);return true};y.prototype.cleanup=function(){this._rootNode=null;this._currentSceneId=null;this._contentResource=null;this._resolve=null;this._reject=null;if(this._nodes){this._nodes.clear()}if(this._viewGroups){this._viewGroups.clear()}if(this._views){this._views.clear()}this._cameras.clear();this._materialMap.clear();this._annotationsMap.clear();this._annotationNodesMap.clear();this._materialNodesMap.clear();this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._materialsByTextureImageId.clear();this._viewThumbnails.clear();this._geometries.clear();this._geometryMeshes.clear();this._meshNodes.clear();this._meshSubmeshes.clear();this._images.clear();this._imageTextures.clear();this._joints.clear();this._fillStyles.clear();this._lineStyles.clear();this._textStyles.clear()};y.prototype.getNode=function(e,t){if(t){this._resetCurrentScene(t);if(this._nodes){return this._nodes.get(e)}}else{var i=this._sceneIdTreeNodesMap.values();var a=i.next();while(!a.done){var r=a.value.get(e);if(r){return r}a=i.next()}}return null};y.prototype._resetCurrentScene=function(e){if(e&&e!==this._currentSceneId){var t=this._sceneIdTreeNodesMap.get(e);if(t){this._nodes=t}else{this._nodes=new Map}var i=this._sceneIdRootNodeMap.get(e);if(i){this._rootNode=i}else{this._rootNode=null}this._currentSceneId=e}};y.prototype.createCamera=function(e,t){this._resetCurrentScene(t);var i=new l;i.setUpDirection(Array.isArray(e.up)?e.up:[0,1,0]);i.setZoomFactor(e.zoom);i.setPosition(e.origin);this._cameras.set(e.id,i);return i};y.prototype.getCamera=function(e){return this._cameras.get(e)};y.prototype.hasMesh=function(e){return this._meshSubmeshes.has(e)};y.prototype.hasImage=function(e){return this._images.has(e)};y.prototype.hasAnnotation=function(e){return this._annotationsMap.has(e)};function I(e){if(Array.isArray(e)){for(var t=0;t<e.length;t++){if(e[t].type===undefined||e[t].type==="mesh"||e[t].type==="line"){return e[t]}}}return null}y.prototype.setMeshNode=function(e,t){this._setMeshNode(this._nodes.get(e),t)};y.prototype.setModelViewVisibilitySet=function(){};y.prototype.setAnimationPlaybacks=function(){};y.prototype.createThumbnail=function(e){var t=this._viewThumbnails.get(e.imageId);if(t){t.thumbnailData="data:image/"+"jpeg"+";base64,"+window.btoa(String.fromCharCode.apply(null,e.data));if(this._fireThumbnailLoaded){this._fireThumbnailLoaded({modelView:t})}}};y.prototype.setSubmeshes=function(e){var t,i,a,r,s;for(var n=0,o=e.length;n<o;++n){t=e[n];i=t.submeshes;for(r=0,s=i.length;r<s;++r){a=i[r];this.insertSubmesh(a)}}};y.prototype.insertSubmesh=function(e){if(!e.lods){return false}var t=I(e.lods);if(!t){return false}e.boundingBox=t.boundingBox;var i=this._geometries.get(t.id);if(i){var a=this._meshNodes.get(e.meshId);if(a){for(var r=0;r<a.length;r++){this._addGeometryToNode(a[r],i,e)}}}else{_.pushElementIntoMapArray(this._geometryMeshes,t.id,e)}_.pushElementIntoMapArray(this._meshSubmeshes,e.meshId,e);return true};y.prototype.getViewGroup=function(e,t){this._resetCurrentScene(t);var i=this._viewGroups.get(e);var a=[];if(i&&i.views){for(var r=0;r<i.views.length;r++){var s=i.views[r].id;var n=this._views.get(s);if(n){a.push(n)}}}return a};y.prototype.insertViewGroup=function(e,t){this._resetCurrentScene(t);var i=this._viewGroups.get(e.id);if(!i){i=this._vkScene.createViewGroup({viewGroupId:e.id,name:e.name,description:e.description});this._viewGroups.set(e.id,i)}else{i.setViewGroupId(e.id);i.setName(e.name);i.setDescription(e.description)}i.type=e.type;i.metadata=e.metadata;i.veids=e.veids;i.views=e.views;i.sceneId=e.sceneId;return this};var w={turntable:c.Turntable,orbit:c.Orbit,pan:c.Pan,zoom:c.Zoom};y.prototype.insertView=function(e,t){this._resetCurrentScene(t);let i=this._views.get(e.viewId);if(i==null){i=this._vkScene.createView({viewId:e.viewId,name:e.name,description:e.description?'<pre class="sapThemeVizKitViewGalleryStepDescriptionPre">'+e.description+"</pre>":e.description,aspectRatio:e.safeAreaAspectRatio,autoPlayAnimation:e.autoPlayAnimation,navigationMode:w[e.navigationMode]||c.NoChange,dimension:2});this._views.set(e.viewId,i)}else{i.setName(e.name);i.setDescription(e.description?'<pre class="sapThemeVizKitViewGalleryStepDescriptionPre">'+e.description+"</pre>":e.description);i.setAspectRatio(e.safeAreaAspectRatio)}i.userData={viewInfo:e};if(e.thumbnailId){var a=this._images.get(e.thumbnailId);if(a){i.thumbnailData=a}else{this._viewThumbnails.set(e.thumbnailId,i)}}if(e.cameraId){i.setCamera(this._cameras.get(e.cameraId))}i.type=e.type;i.flyToTime=e.flyToTime;i.preDelay=e.preDelay;i.postDelay=e.postDelay;i.navigationMode=e.navigationMode;var r=this._getSavedColor(e.topColour,localStorage.getItem("color.backgroundTop"));if(r!=null){i.setTopColor(r)}var s=this._getSavedColor(e.bottomColour,localStorage.getItem("color.backgroundBottom"));if(s!=null){i.setBottomColor(s)}i.dimension=e.dimension;i.query=e.query;i.metadata=e.metadata;i.veids=e.veids;i.viewGroupId=e.viewGroupId;i.id=e.viewId;if(i.viewGroupId){var n=this._viewGroups.get(i.viewGroupId);if(n){n.addView(i)}}return this};y.prototype.getView=function(e,t){this._resetCurrentScene(t);return this._views.get(e)};y.prototype.setViewCamera=function(e,t,i){this._resetCurrentScene(i);var a=this._cameras.get(e);var r=this._views.get(t);if(a&&r){r.setCamera(a)}return this};y.prototype.getChildNodeIds=function(e,t,i){this._resetCurrentScene(t);var a=this._nodes.get(e);var r=[];if(!a){return r}if(a&&a.children){for(var s=0;s<a.children.length;s++){var n=a.children[s];if(n.userData.treeNode&&n.userData.treeNode.sid){r.push(n.userData.treeNode.sid)}else if(i&&n.userData.submeshInfo&&n.userData.submeshInfo.id){r.push(n.userData.submeshInfo.id)}}}return r};y.prototype.setViewNodeInfos=function(e,t,i){this._resetCurrentScene(i);var a=this._views.get(t);a.setNodeInfos(e);return this};y.prototype.finalizeViewGroups=function(e){this._resetCurrentScene(e);var t=this._viewGroups.entries();var i=t.next();while(!i.done){var a=i.value[1];var r=i.value[0];if(!a||!a.views||!a.views.length){i=t.next();continue}a.removeViews();for(var s=0;s<a.views.length;s++){var n=a.views[s].id;var o=this._views.get(n);if(o&&o.userData.viewInfo.thumbnailId&&!o.thumbnailData){var h=this._images.get(o.userData.viewInfo.thumbnailId);if(h){o.thumbnailData=h}}if(o){o.viewGroupId=r;a.addView(o)}}i=t.next()}return this};y.prototype.setVoxelThreshold=function(e){return this};y.prototype.getVoxelThreshold=function(){return 0};y.prototype.createNode=function(e,i){this._resetCurrentScene(i);var a=e.transform;const r=e.contentType=="SVG"?new g({sid:e.sid,name:e.name,matrix:[1,0,0,-1,0,0],sceneId:i,imageId:e.imageId,width:e.width,height:e.height}):new t({sid:e.sid,name:e.name,matrix:m.convertTo3x2(a)});this._nodes.set(e.sid,r);var s=r.userData;if(e.metadata){s.metadata=e.metadata}if(e.veids){s.veids=e.veids}if(e.usageIds){s.usageIds=e.usageIds}if(e.parametricId){s.parametricId=e.parametricId}else if(e.dynamicContentId){s.dynamicContentId=e.dynamicContentId}else if(e.meshId){this._setMeshNode(r,e.meshId)}s.treeNode=e;r.setVisible(1,e.visible??true);if(e.visualisable===false){s.skipIt=true}if(e.joints){e.joints.forEach(function(e){var t=this._nodes.get(e.parentSid);if(t){t.userData.jointNodes=t.userData.jointNodes||[];t.userData.jointNodes.push(r)}else{_.pushElementIntoMapArray(this._joints,e.parentSid,r)}},this)}var n=this._joints.get(e.sid);if(n){s.jointNodes=s.jointNodes?s.jointNodes.concat(n):n}if(e.viewBox){s.viewBox=e.viewBox}if(e.pageIndex!=null){r.setPageIndex(e.pageIndex)}var o=this._nodes.get(e.parentId);(o||this._rootNode).add(r);if(e.contentType==="HOTSPOT"){r._vkSetNodeContentType(p.Hotspot)}else if(e.contentType==="DYNAMIC_CONTENT"){r._vkSetNodeContentType(p.DynamicContent)}else if(e.contentType==="ANNOTATION"){r._vkSetNodeContentType(p.Annotation)}else if(e.contentType==="SVG"){r._vkSetNodeContentType(p.SvgImage)}return r};y.prototype.preferMeshes=function(){return false};y.prototype.createAnnotation=function(e,t){_.pushElementIntoMapArray(this._annotationNodesMap,e.annotationId,e.nodeId);var i=this.getAnnotation(e.annotationId);if(i){this.createImageNote(i,t)}};y.prototype.remove=function(e,t){this._resetCurrentScene(t);var i=this;e=[].concat(e);e.forEach(function(e){var a=i._nodes.get(e);if(a){i._nodes.delete(e);for(var r=0;r<a.children.length;r++){var s=a.children[r];if(s.userData&&s.userData.treeNode&&s.userData.treeNode.sid){i.remove(s.userData.treeNode.sid,t)}}}});return this};function M(e){return new Float32Array([Math.max(e[3]-e[0],Number.EPSILON),0,0,Math.max(e[4]-e[1],Number.EPSILON),(e[3]+e[0])*.5,(e[4]+e[1])*.5])}y.prototype._addGeometryToNode=function(e,t,i){var a=i.materialId;var r=this._getMaterial(a);var s=t.data;var o=s.indices;var h=s.points;var d=new Float32Array([1,0,0,1,0,0]);if(t.isPositionQuantized&&i.boundingBox&&i.boundingBox.length===6){d=M(i.boundingBox)}if(i.transform){}var l,u,p,c;var m=o.length;var f=[];if(t.isPolyline){for(l=0,u=-1;l<m;l+=2,u=c){p=o[l]*3;c=o[l+1]*3;if(p!==u){f.push({type:"move",points:[h[p],h[p+this._yIndex]]});f.push({type:"line",points:[h[c],h[c+this._yIndex]]})}else{f[f.length-1].points.push(h[c],h[c+this._yIndex])}}}else{r=Object.assign(Object.assign({},r),{lineColor:[0,0,0,0],lineWidth:0});for(l=0;l<m;l+=3){u=o[l]*3;p=o[l+1]*3;c=o[l+2]*3;f.push({type:"move",points:[h[u],h[u+this._yIndex]]});f.push({type:"line",points:[h[p],h[p+this._yIndex],h[c],h[c+this._yIndex]]});f.push({type:"close"})}}var v=new n({segments:f,isTriangleMesh:!t.isPolyline,matrix:d,material:r,materialID:a,fillStyle:t.isPolyline?null:{colour:r.color},subelement:true});e.add(v);_.pushElementIntoMapArray(this._materialNodesMap,a,v)};y.prototype.setGeometry=function(e){this._geometries.set(e.id,e);var t=this._geometryMeshes.get(e.id);if(t){for(var i=0;i<t.length;i++){var a=t[i];var r=this._meshNodes.get(a.meshId);if(r){for(var s=0;s<r.length;s++){this._addGeometryToNode(r[s],e,a)}}}}if(this._fireSceneUpdated){this._fireSceneUpdated()}return this};y.prototype._setMeshNode=function(e,t){_.pushElementIntoMapArray(this._meshNodes,t,e);var i=this._meshSubmeshes.get(t);if(i){for(var a=0;a<i.length;a++){var r=i[a];var s=I(r.lods);if(s){var n=this._geometries.get(s.id);if(n){this._addGeometryToNode(e,n,r)}}}}};var S=[0,0];var N=[0,0,0,1];var b=[1,1];function x(e){return t._compose(e.t||S,e.r||N,e.s||b)}y.prototype.setParametricContent=function(t,i,a){if(i==null){e.warning("Empty parametric content for node "+t);return}this._resetCurrentScene(a);var r=this._nodes.get(t);var s=i.shapes;if(s){for(var n=0;n<s.length;n++){this._createObject(s[n],r)}}else{this._createObject(i,r)}};y.prototype.setDynamicContent=function(e,t,i){this._resetCurrentScene(i);const a=this._nodes.get(e);if(a){a.userData.templateId=t.templateId;const e={type:"rectangle",width:1,height:1};const i=this._createObject(e,a);i.fill=i.stroke=[0,0,0,0]}};function T(e,t,i,a,r){return[e+i*Math.cos(r),t+a*Math.sin(r)]}y.prototype._createObject=function(t,h){t.matrix=x(t);t.subelement=true;if(t.materialID){t.material=this._getMaterial(t.materialID)}if(this._lineStyles&&t.stroke_id!==undefined){t.lineStyle=this._lineStyles.get(t.stroke_id)}if(this._fillStyles&&t.fill_id!==undefined){t.fillStyle=this._fillStyles.get(t.fill_id);if(t.fillStyle.gradient){var l=new d(t.fillStyle);t.fillStyle.fillURL="url(#"+l.uid+")";h.add(l)}}if(this._textStyles&&t.style_id!==undefined){t.style=this._textStyles.get(t.style_id);t.textStyles=this._textStyles}var u;switch(t.type){case"arc":case"ellipticalArc":var p=t.cx||0;var c=t.cy||0;var m=t.major??t.radius;var f=t.minor??t.radius;var v=t.start>t.end?t.start-Math.PI*2:t.start;var g=t.end;t.segments=[{type:"move",points:T(p,c,m,f,v)},{type:"arc",major:m,minor:f,short:Math.abs(g-v)<Math.PI,clockwise:g>v,points:T(p,c,m,f,g)}];u=new n(t);break;case"rectangle":u=new a(t);break;case"line":u=new r(t);break;case"polyline":u=new s(t);break;case"ellipse":case"circle":u=new i(t);break;case"text":if(this._rootNode.matrix[3]<0){t.matrix[2]*=-1;t.matrix[3]*=-1}u=new o(t);break;case"path":u=new n(t);break;default:e.warning("Unsupported parametric type",t.type);u=null;break}if(u){u.userData.po=t;if(t.materialID){_.pushElementIntoMapArray(this._materialNodesMap,t.materialID,u)}h.add(u)}return u};y.prototype.createImageNote=function(e,t){this._resetCurrentScene(t);if(e.type==="image"){var i=e.label.materialId;if(!i){return}var a=this._getMaterial(i);this._annotationsMap.set(e.id,e);var r=this._annotationNodesMap.get(e.id)||[];this._annotationNodesMap.delete(e.id);if(e.nodeId){r.push(e.nodeId)}for(var s=0;s<r.length;s++){var n=this._nodes.get(r[s]);if(n){var o=new h({materialID:i,material:a,subelement:true,matrix:[1,0,0,-1,0,0]});n.add(o);_.pushElementIntoMapArray(this._materialNodesMap,i,o)}}}};y.prototype.removeNode=function(e){this._nodes.delete(e.sid);e.children.forEach(this.removeNode,this)};y.prototype.createMaterial=function(e){var t=[];var i=e.id;var a=this._getMaterial(i);a.lineColor=e.lineColour;a.lineWidth=e.lineWidth||1;a.lineStyle={width:e.lineWidth||1,haloWidth:e.lineHaloWidth||0,endCapStyle:e.lineEndRound?1:0,dashPattern:e.lineDashPattern||[],dashPatternScale:e.lineDashPatternScale,widthCoordinateSpace:e.lineWidthCoordinateSpace};if(e.emissiveColour){a.color=e.emissiveColour}if(e.opacity!==undefined){a.opacity=e.opacity}if(e.textureEmissive&&e.textureEmissive.length&&e.textureEmissive[0].imageId){var r=e.textureEmissive[0].imageId;if(this._images.has(r)){a.texture=this._images.get(r)}else{var s={imageId:e.textureEmissive[0].imageId};t.push(s);_.pushElementIntoMapArray(this._imageTextures,r,{materialId:i});if(!a.userData){a.userData={}}a.userData.imageIdsToLoad=new Set;a.userData.imageIdsToLoad.add(s.imageId)}a.textureWidth=e.textureEmissive[0].width;a.textureHeight=e.textureEmissive[0].height;_.pushElementIntoMapArray(this._materialsByTextureImageId,r,{materialId:i})}var n=this._materialNodesMap.get(i);if(n){for(var o=0;o<n.length;o++){n[o].setMaterial(a,true)}}return t};y.prototype._getMaterial=function(e){return this._materialMap.get(e)||this._createTemporaryMaterial(e)};y.prototype._createTemporaryMaterial=function(e){var t={materialId:e,lineColor:[0,0,0,1],lineWidth:1};this._materialMap.set(e,t);return t};y.prototype.checkMaterialExists=function(e,t){if(!this._materialMap.get(e)){if(t){this._createTemporaryMaterial(e)}return false}return true};y.prototype.materialNeeded=function(e){return false};y.prototype.getAnnotation=function(e){return this._annotationsMap.get(e)};y.prototype.updateViewsForReplacedNodes=function(e){};y.prototype.insertFillStyle=function(e){this._fillStyles.set(e.veid,e)};y.prototype.insertLineStyle=function(e){this._lineStyles.set(e.veid,e)};y.prototype.insertTextStyle=function(e){this._textStyles.set(e.veid,e)};var C=function(e){var t="";try{var i=32768;var a=0;var r=e.length;var s;while(a<r){s=e.slice(a,Math.min(a+i,r));t+=String.fromCharCode.apply(null,s);a+=i}}catch(e){t=""}return t};y.prototype.createImage=function(t){if(t.binaryData.length<32){e.warning("SceneBuilder.createImage()","Can't create image from empty data");return this}var i=new DataView(t.binaryData.buffer);var a=true;if(i.getUint8(0,true)===parseInt("0xFF",16)&&i.getUint8(1,true)===parseInt("0xD8",16)){a=false}var r=C(t.binaryData);var s="data:image/"+(a?"png":"jpeg")+";base64,"+btoa(r);this._images.set(t.id,s);var n=this._imageTextures.get(t.id);if(n&&n.length){this._imageTextures.delete(t.id);n.forEach(function(e){var i=this._getMaterial(e.materialId);i.texture=s;if(i.userData&&i.userData.imageIdsToLoad&&i.userData.imageIdsToLoad.size){i.userData.imageIdsToLoad.delete(t.id)}var a=this._materialNodesMap.get(e.materialId);if(a){for(var r=0;r<a.length;r++){a[r].setMaterial(i,true)}}}.bind(this))}return this};y.prototype.setViewThumbnail=function(e,t,i,a){this._resetCurrentScene(i);var r=this._views.get(t);var s=this._images.get(e);if(r&&s){if(r.userData!==undefined){if(r.userData.viewInfo.thumbnailId===e){r.thumbnailData=s}}}return this};y.prototype._getSavedColor=function(e,t){if(e&&e.length>2){return v({red:Math.floor(e[0]*255),green:Math.floor(e[1]*255),blue:Math.floor(e[2]*255),alpha:e.length>3?e[3]:1})}else if(t){return t}return undefined};y.prototype.setSceneMetadata=function(e){if(this._vkScene){this._vkScene.setSceneMetadata(e)}else{this._sceneMetadata=e}};return y});
//# sourceMappingURL=SceneBuilder.js.map