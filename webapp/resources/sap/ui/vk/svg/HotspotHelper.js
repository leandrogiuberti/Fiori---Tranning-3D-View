/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["../NodeContentType","./Element","./Rectangle","./Path","sap/base/assert","sap/base/Log","sap/base/util/uid","../TransformationMatrix","../thirdparty/imagetracer","../uuidv4"],function(t,e,r,a,i,n,o,s,l,d){"use strict";var u=function(){};u.prototype.duplicateHotspot=function(t,r,a,i){t=Array.isArray(t)?t:[t];var n;if(a){n=e._multiplyMatrices(e._invertMatrix(t[0]._matrixWorld()),a)}else if(i){var o=i._camera._transformRect({x1:0,y1:0,x2:30,y2:30});n=[1,0,0,1,o.x2-o.x1,o.y2-o.y1]}var s=e._invertMatrix(r._matrixWorld());var l=[];t.forEach(function(t){var a=t.clone();a.userData.duplicatedFrom=t.sid;var i=e._multiplyMatrices(n,t._matrixWorld());var o=e._multiplyMatrices(s,i);a.matrix.set(o);r.add(a);l.push(a)});return l};u.prototype.updateHotspot=function(a){const i=e._invertMatrix(a._matrixWorld());function o(o){o.traverse(function(o){if(o.nodeContentType===t.Hotspot||o.parent===a){return}let s;if(o.type==="Image"){s=new r({x:o.x,y:o.y,width:o.width,height:o.height})}else if(o.type!=="Group"){s=(new o.constructor).copy(o,false)}else{n.warning(`Unsupported child node type "${o.type}" is tried to be embedded in hotspot node "${a.name}"`)}if(s!=null){s.matrix=e._multiplyMatrices(i,o._matrixWorld());s.userData.sourceJointNode=o;a.add(s)}})}for(let t=a.children.length-1;t>=0;--t){const e=a.children[t];if(e.userData.sourceJointNode!==undefined){a.remove(e)}}const s=a.userData.jointNodes;if(s!=null){for(const e of s){if(e.nodeContentType!==t.Hotspot&&e.parent!==a){o(e)}}}a._initAsHotspot()};u.prototype.mergeHotspots=function(r,a){var i=r.getDefaultNodeHierarchy();var n=a[0];var l=n.getPageIndex();var d=i.createNode(null,n.name,null,t.Hotspot,{sid:o()});if(l!=null){d.setPageIndex(l)}var u=[],h=[];var c=e._invertMatrix(d._matrixWorld());var p=function(t,e){return e._vkGetNodeContentType()===t};a.forEach(function(r){if(r.children.every(p.bind(null,t.Hotspot))){var a=r.children.length;while(a--){var i=r.children[0];var n=e._multiplyMatrices(c,i._matrixWorld());r.remove(i);d.add(i);i.matrix=n;u.push(i)}h.push(r)}else if(r.children.every(p.bind(null,t.Regular))){r.parent.remove(r);d.add(r);r.matrix=e._multiplyMatrices(c,r._matrixWorld());u.push(r)}});if(u){d.userData.jointNodes=Array.from(u)}if(n.hotspotColor!=null){d.setHotspotColor(n.vMask,n.hotspotColor)}if(n.customHotspotColor!=null){d.setCustomHotspotColor(n.vMask,n.customHotspotColor)}i.removeNode(h);var f=[],m=[],v=[],g=[],y=[];var x={name:d.name,contentType:t.Hotspot,joints:[],children:[]};if(l!=null){x.pageIndex=l}d.userData.jointNodes.forEach(function(e,r){var a=e.getParametricContent(v,g,y);m.push(a);const i={name:e.name,transform:s.convert3x2To4x3(e.matrix),parametric:r,contentType:t.Hotspot};if(l!=null){i.pageIndex=l}f.push(i);x.joints.push({child:r,type:"LINK",action:"bubble"});x.children.push(r)});f.push(x);a.forEach(function(t){f.push({suppressed:true,sid:t.sid})});var w=r.getViewStateManager().getCurrentView();return{nodeRef:d,request:{views:[{id:w?.getViewId(),name:w?.getName(),nodes:f}],parametrics:m,fillstyles:v,linestyles:g,textStyles:y}}};u.prototype.mergeElements=function(r,a){i(a.length&&"HotspotHelper.mergeElements: at least one node must be provided");var n=r.createNode(null,a[0].name,null,t.Regular,{sid:o()});var s=e._invertMatrix(n._matrixWorld());var l={name:n.name,contentType:"geometry",parametric:0};var d=[l],u=[],h=[],c=[],p=[];var f=new Set;a.forEach(function(t){t.traverse(function(t){if(t._isGeometryNode()){f.add(t)}})});a.forEach(function(t){d.push({suppressed:true,sid:t.sid})});f.forEach(function(t){var r=t._matrixWorld();t.parent.remove(t);n.add(t);t.setMatrix(e._multiplyMatrices(s,r));t.userData.skipIt=true;var a=t._getParametricShape(h,c,p);if(a.type!==undefined){u.push(a)}});a.forEach(function(t){if(!f.has(t)){t.parent.remove(t)}});var m={nodes:d,parametrics:[{shapes:u}]};if(h.length>0){m.fillStyles=h}if(c.length>0){m.lineStyles=c}if(p.length>0){m.textStyles=p}return{nodeRef:n,request:m}};u.prototype.createHotspotFromGeometry=function(r,i,n){return new Promise(function(o,s){r=Array.isArray(r)?r:[r];var d=[];r.forEach(function(t){t.traverseVisible(function(t){if(t._isGeometryNode()){d.push(t)}},-1>>>0)});if(d.length===1){switch(d[0].type){case"Rectangle":case"Ellipse":case"Line":var u=i.createNode(n,r[0].name,null,t.Hotspot);u.setMatrix(e._multiplyMatrices(e._invertMatrix(u.parent._matrixWorld()),d[0]._matrixWorld()));var h=d[0].clone();h.setMatrix([1,0,0,1,0,0]);u.add(h);o(u);return;default:break}}var c;var p=document.createElementNS("http://www.w3.org/2000/svg","svg");d.forEach(function(t){var e=t._getBBox(t._matrixWorld());if(!c){c=e}else{c.width=Math.max(c.x+c.width,e.x+e.width);c.height=Math.max(c.y+c.height,e.y+e.height);c.x=Math.min(c.x,e.x);c.y=Math.min(c.y,e.y);c.width-=c.x;c.height-=c.y}var r=t.domRef.cloneNode(true);if(r.getAttribute("fill")){r.setAttribute("fill","#000")}if(r.getAttribute("stroke")){r.setAttribute("stroke","#000")}r.setAttribute("transform","matrix("+t._matrixWorld().join(",")+")");p.appendChild(r)});var f=c.width*.05;var m=c.height*.05;c.x-=f;c.y-=m;c.width+=f*2;c.height+=m*2;p.setAttribute("width",Math.ceil(1e3*c.width/Math.max(c.width,c.height)));p.setAttribute("height",Math.ceil(1e3*c.height/Math.max(c.width,c.height)));p.setAttribute("viewBox",[c.x,c.y,c.width,c.height].join(" "));p.setAttribute("font-family",'"72","72full",Arial,Helvetica,sans-serif');var v=new Image;v.onload=function(){var d=document.createElement("canvas");var u=d.width=this.width;var h=d.height=this.height;var p=d.getContext("2d");var f=i.createNode(n,r[0].name,null,t.Hotspot);var m=f.parent._matrixWorld();var v=m[3]<0;if(v){f.setMatrix(e._multiplyMatrices(e._invertMatrix(m),[c.width/u,0,0,-c.height/h,c.x,c.y+c.height]));p.transform(1,0,0,-1,0,h)}else{f.setMatrix(e._multiplyMatrices(e._invertMatrix(m),[c.width/u,0,0,c.height/h,c.x,c.y]))}p.drawImage(this,0,0,u,h);var g=p.getImageData(0,0,u,h);function y(t,e){return t+e*u<<2}var x=p.createImageData(u,h);var w,_;var M,b;function C(t,e){return t>=0&&t<u&&e>=0&&e<h?M[y(t,e)+3]:0}for(var N=0;N<2;N++){M=g.data;b=x.data;for(_=1;_<h;_++){for(w=1;w<u;w++){if(C(w,_)>127||C(w-1,_)>127||C(w+1,_)>127||C(w,_-1)>127||C(w,_+1)>127){b[y(w,_)+3]=255}}}var H=g;g=x;x=H}var A=g.data;function T(t,e){var r=y(t,e);return A[r+3]<128&&A[r]!==1}var E=[0,0];while(E.length>0){_=E.pop();w=E.pop();A[y(w,_)]=1;if(w+1<u&&T(w+1,_)){E.push(w+1,_)}if(w>0&&T(w-1,_)){E.push(w-1,_)}if(_+1<h&&T(w,_+1)){E.push(w,_+1)}if(_>0&&T(w,_-1)){E.push(w,_-1)}}for(_=0;_<h;_++){for(w=0;w<u;w++){if(T(w,_)){A[y(w,_)+3]=255}}}var I=l.imagedataToSVG(g,{ltres:2,qtres:2,pathomit:8,rightangleenhance:false,colorsampling:0,numberofcolors:2,mincolorratio:0,colorquantcycles:1,blurradius:0,blurdelta:20,strokewidth:0,linefilter:true,roundcoords:0,pal:[{r:0,g:0,b:0,a:0},{r:0,g:0,b:0,a:255}],desc:false});var D=[];var S=(new DOMParser).parseFromString(I,"image/svg+xml");if(S&&S.firstChild&&S.firstChild.tagName==="svg"){for(var W=S.firstChild.firstChild;W!==null;W=W.nextSibling){if(W.tagName==="path"&&W.getAttribute("opacity")>.5){D=D.concat(a._extractSegmentsFromDomRef(W))}}}if(D.length>0){f.add(new a({segments:D}));o(f)}else{f.parent.remove(f);s()}};v.src="data:image/svg+xml;base64,"+btoa((new XMLSerializer).serializeToString(p))})};u.prototype.createRequest=function(e,r){if(!e||!r){return null}var a=[];var i=[];var n=[];var o=[];var l=[];var u=r&&r._currentView;function h(e,r){r.setNodePersistentId(e,d());var u={name:e.name,transform:s.convert3x2To4x3(e.matrix),veId:e.sid};const c=e.getPageIndex();if(c!=null){u.pageIndex=c}if(e.nodeContentType===t.Hotspot){u.contentType="HOTSPOT"}if(e.nodeContentType===t.DynamicContent){u.contentType="DYNAMICCONTENT"}if(e.userData.duplicatedFrom){u.duplicatedFrom=e.userData.duplicatedFrom;delete e.userData.duplicatedFrom}var p=e.getParametricContent(n,o,l);if(p){u.parametric=i.length;i.push(p)}var f=a.length;a.push(u);var m=e.children;if(m.length>0){var v=[];for(var g=0;g<m.length;g++){if(m[g].type==="Group"){v.push(h(m[g],r))}}if(v.length>0){u.children=v}}return f}var c=r.getScene();(Array.isArray(e)?e:[e]).forEach(function(t){h(t,c)});var p={views:[{id:u&&u.getViewId(),nodes:a}],parametrics:i};if(n.length>0){p.fillstyles=n}if(o.length>0){p.linestyles=o}if(l.length>0){p.textStyles=l}return p};return u});
//# sourceMappingURL=HotspotHelper.js.map