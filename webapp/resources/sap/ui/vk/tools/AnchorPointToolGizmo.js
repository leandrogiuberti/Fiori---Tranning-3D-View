/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../getResourceBundle","../thirdparty/three","../thirdparty/BufferGeometryUtils","./Gizmo","./CoordinateSystem","./AxisColours","./AnchorPointToolOperation","sap/base/assert"],function(t,e,i,o,r,a,s,n){"use strict";var h=o.extend("sap.ui.vk.tools.AnchorPointToolGizmo",{metadata:{library:"sap.ui.vk"},renderer:{apiVersion:2,render:function(t,e){t.openStart("div",e);t.class("sapUiVkTransformationToolEdit");t.openEnd();t.renderControl(e._editingForm);t.close("div")}}});h.prototype.init=function(){if(o.prototype.init){o.prototype.init.apply(this)}this._createEditingForm(null,84);this._gizmoIndex=-1;this._handleIndex=-1;this._viewport=null;this._tool=null;this._sceneGizmo=new e.Scene;const t=new e.DirectionalLight(16777215,.5*Math.PI);t.position.set(1,3,2);this._sceneGizmo.add(t);this._sceneGizmo.add(new e.AmbientLight(16777215,.5*Math.PI));this._touchAreas=new e.Group;this._gizmo=new e.Group;this._sceneGizmo.add(this._gizmo);this._matViewProj=new e.Matrix4;this._gizmoSize=96;this._moveDelta=new e.Vector3;this._rotationDelta=new e.Vector3;function r(t,o,r){var a=96,s=1,n=24,h=4,l=48;t.multiplyScalar(1/a);var d=new e.CylinderGeometry(s,s,a-n,4);var u=(new e.Matrix4).makeBasis(new e.Vector3(t.y,t.z,t.x),t,new e.Vector3(t.z,t.x,t.y));u.setPosition(t.clone().multiplyScalar((a-n)*.5));d.applyMatrix4(u);var _=new e.MeshLambertMaterial({color:o,transparent:true});var p=new e.Mesh(d,_);p.matrixAutoUpdate=false;p.userData.color=o;var c=new e.CylinderGeometry(0,h,n,12,1);u.setPosition(t.clone().multiplyScalar(a-n*.5));c.applyMatrix4(u);var m=new e.Mesh(c,_);m.matrixAutoUpdate=false;p.add(m);var g=new e.CylinderGeometry(l*.5,l*.5,l,12,1);g.applyMatrix4(u);var v=new e.CylinderGeometry(l*.5,l*.2,l,12,1);u.setPosition(t.clone().multiplyScalar(a*.5));v.applyMatrix4(u);var y=i.mergeGeometries([g,v]);r.add(new e.Mesh(y,_));return p}function s(t,i,o){var r=new Float32Array(9);r[t]=r[i+6]=1;r[t+3]=r[i+3]=.5;var a=new e.BufferGeometry;var s=new Float32Array(12);s[3+t]=s[6+i]=s[9+t]=s[9+i]=.333;a.setAttribute("position",new e.Float32BufferAttribute(s,3));a.setIndex([0,2,1,1,2,3]);var n=new e.MeshBasicMaterial({color:16776960,opacity:.5,transparent:true,visible:false,side:e.DoubleSide});var h=new e.Mesh(a,n);h.matrixAutoUpdate=false;h.userData.colors=r;var l=new e.BufferGeometry;var d=new Float32Array(9);d[t]=d[t+3]=d[i+3]=d[i+6]=.333;l.setAttribute("position",new e.Float32BufferAttribute(d,3));l.setAttribute("color",new e.Float32BufferAttribute(r,3));var u=new e.Line(l,new e.LineBasicMaterial({vertexColors:true,transparent:true,linewidth:window.devicePixelRatio}));u.matrixAutoUpdate=false;h.add(u);o.add(new e.Mesh(a,new e.MeshBasicMaterial({side:e.DoubleSide})));return h}function n(t,i,o,r){var a=new e.TorusGeometry(o,1/96,4,r,Math.PI/2);if(t===0){a.rotateY(Math.PI/-2)}else if(t===1){a.rotateX(Math.PI/2)}var s=new e.Mesh(a,new e.MeshBasicMaterial({color:i,transparent:true}));s.matrixAutoUpdate=false;s.userData.color=i;return s}function h(t,i,o){var r=new e.TorusGeometry(i,16/96,4,o,Math.PI/2);if(t===0){r.rotateY(Math.PI/-2)}else if(t===1){r.rotateX(Math.PI/2)}return new e.Mesh(r,new e.MeshBasicMaterial({opacity:.2,transparent:true}))}this._gizmo.add(r(new e.Vector3(1,0,0),a.x,this._touchAreas));this._gizmo.add(r(new e.Vector3(0,1,0),a.y,this._touchAreas));this._gizmo.add(r(new e.Vector3(0,0,1),a.z,this._touchAreas));this._gizmo.add(s(1,2,this._touchAreas));this._gizmo.add(s(2,0,this._touchAreas));this._gizmo.add(s(0,1,this._touchAreas));for(var l=0;l<3;l++){this._gizmo.add(n(l,a[["x","y","z"][l]],1,32));this._touchAreas.add(h(l,1,24))}var d=new e.MeshBasicMaterial({color:33023,opacity:.5,transparent:true,side:e.DoubleSide});this._arcMesh=new e.Mesh(new e.BufferGeometry,d);this._arcMesh.visible=false;this._gizmo.add(this._arcMesh);this._axisTitles=this._createAxisTitles();this._sceneGizmo.add(this._axisTitles);var u=new e.BufferGeometry;u.setAttribute("position",new e.Float32BufferAttribute(new Float32Array(6),3));this._line=new e.LineSegments(u,new e.LineBasicMaterial);this._line.frustumCulled=false;this._line.visible=false;this._gizmo.add(this._line)};h.prototype.hasDomElement=function(){return true};h.prototype._updateHandlesVisibility=function(){var t=this._tool.getAllowOperation();var e=t!==s.Rotate;var i=t!==s.Move;var o;for(o=0;o<3;o++){this._touchAreas.children[o].visible=e}for(o=3;o<6;o++){this._gizmo.children[o].visible=this._touchAreas.children[o].visible=e}for(o=6;o<9;o++){this._gizmo.children[o].visible=this._touchAreas.children[o].visible=i}};h.prototype._initAnchorPoint=function(t){t._anchorPoint=this._gizmo};h.prototype.show=function(t,e){this._viewport=t;this._tool=e;this._updateHandlesVisibility();this._initAnchorPoint(t)};h.prototype.hide=function(){this._viewport=null;this._tool=null};h.prototype.setPosition=function(t){this._gizmo.position.copy(t);this._gizmo.updateMatrixWorld()};h.prototype.setQuaternion=function(t){this._gizmo.quaternion.copy(t);this._gizmo.updateMatrixWorld()};h.prototype.getGizmoCount=function(){return 1};h.prototype.getTouchObject=function(t){this._touchAreas.position.copy(this._gizmo.position);this._touchAreas.quaternion.copy(this._gizmo.quaternion);this._touchAreas.scale.copy(this._gizmo.scale);this._touchAreas.updateMatrixWorld(true);return this._touchAreas};var l=[1,2,4,6,5,3,1,2,4];h.prototype.highlightHandle=function(t,e){var i;for(i=0;i<3;i++){var o=this._gizmo.children[i];var r=l[t]&1<<i;var a=r?16776960:o.userData.color;o.material.color.setHex(a);o.children[0].material.color.setHex(a);this._axisTitles.children[i].material.color.setHex(a)}for(i=3;i<6;i++){var n=this._gizmo.children[i];n.material.visible=i===t;var h=n.children[0].geometry.attributes.color;h.copyArray(i===t?[1,1,0,1,1,0,1,1,0]:n.userData.colors);h.needsUpdate=true;n.children[0].material.opacity=i===t||e&&t===-1?1:.35;n.children[0].visible=i===t||e}for(i=6;i<9;i++){var d=this._gizmo.children[i];d.visible=this._tool.getAllowOperation()!==s.Move&&(i===t||e);d.material.color.setHex(i===t?16776960:d.userData.color);d.material.opacity=i===t||e&&t===-1?1:.35}};h.prototype.selectHandle=function(e){this._handleIndex=e;if(e>=0&&e<3){this._units.setText(t().getText("TOOL_UNITS_MM"))}else if(e>=6&&e<9){this._units.setText(String.fromCharCode(176))}this._editingForm.rerender();this._viewport.setShouldRenderFrame()};h.prototype.beginGesture=function(){this._isMoved=false;this._isRotated=false;this._originPosition=(new e.Vector3).setFromMatrixPosition(this._gizmo.matrixWorld);this._originQuaternion=this._gizmo.quaternion.clone()};h.prototype.endGesture=function(){if(this._isMoved){this._tool.fireMoved({x:this._moveDelta.x,y:this._moveDelta.y,z:this._moveDelta.z})}if(this._isRotated){this._tool.fireRotated({x:this._rotationDelta.x,y:this._rotationDelta.y,z:this._rotationDelta.z})}this._line.visible=false;this._arcMesh.visible=false};h.prototype._setOffset=function(t,i){if(this._tool.fireEvent("moving",{x:t.x,y:t.y,z:t.z},true)){this._move(t);var o=(new e.Matrix4).copy(this._gizmo.matrixWorld).invert();var r=(new e.Vector3).setFromMatrixScale(this._gizmo.matrixWorld);var a=this._gizmo.position.clone().applyMatrix4(o);t.copy(this._originPosition).applyMatrix4(o).sub(a).multiply(r);var s=this._line.geometry.getAttribute("position");s.array.set(t.toArray());s.needsUpdate=true;this._line.geometry.computeBoundingBox();t.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z));t.multiplyScalar(1/Math.max(t.x,t.y,t.z));this._line.material.color.setRGB(t.x,t.y,t.z);this._line.visible=true}};h.prototype._move=function(t){if(this._tool.getAllowOperation()===s.Rotate){return this}this._isMoved=true;this._moveDelta.copy(t);this._gizmo.position.copy(this._originPosition).add(t);this._viewport.setShouldRenderFrame();return this};h.prototype.move=function(t,i,o){this.beginGesture();this._move(new e.Vector3(t,i,o||0))};h.prototype._setRotationAxisAngle=function(t,i,o){var r=(o-i)%(Math.PI*2);var a=[0,0,0];a[t]=r;a=(new e.Euler).fromArray(a);if(this._tool.fireEvent("rotating",{x:e.MathUtils.radToDeg(a.x),y:e.MathUtils.radToDeg(a.y),z:e.MathUtils.radToDeg(a.z)},true)){this._rotate(a);var s=[0,0,0];var n=new e.Vector3;var h=(t+1)%3,l=(t+2)%3;var d,u=Math.max(Math.ceil(Math.abs(r)*64/Math.PI),1);for(d=0;d<=u;d++){var _=i-r*(d/u);n.set(0,0,0).setComponent(h,Math.cos(_)).setComponent(l,Math.sin(_));s.push(n.x,n.y,n.z)}var p=[];for(d=0;d<u;d++){p.push(0,d+1,d+2)}var c=this._arcMesh.geometry;c.setIndex(p);c.setAttribute("position",new e.Float32BufferAttribute(s,3));this._arcMesh.visible=true}};h.prototype._rotate=function(t){if(this._tool.getAllowOperation()===s.Move){return this}this._tool._deactivateScreenAlignment();this._isRotated=true;this._rotationDelta.set(e.MathUtils.radToDeg(t.x),e.MathUtils.radToDeg(t.y),e.MathUtils.radToDeg(t.z));var i=(new e.Quaternion).setFromEuler(t);this._gizmo.quaternion.copy(this._originQuaternion).multiply(i);this._viewport.setShouldRenderFrame();return this};h.prototype.rotate=function(t,i,o){this.beginGesture();this._rotate(new e.Euler(e.MathUtils.degToRad(t||0),e.MathUtils.degToRad(i||0),e.MathUtils.degToRad(o||0)))};h.prototype._getValueLocaleOptions=function(){return this._handleIndex>=0&&this._handleIndex<3?{useGrouping:false}:{useGrouping:false,minimumFractionDigits:1,maximumFractionDigits:2}};h.prototype.getValue=function(){if(this._handleIndex>=0&&this._handleIndex<3){var t=(new e.Vector3).setFromMatrixColumn(this._gizmo.matrixWorld,this._handleIndex).normalize();return t.dot(this._gizmo.position)}if(this._handleIndex>=6&&this._handleIndex<9){return e.MathUtils.radToDeg(this._gizmo.rotation.reorder("YXZ")[["x","y","z"][this._handleIndex-6]])}return 0};h.prototype.setValue=function(t){if(this._handleIndex>=0&&this._handleIndex<3){var i=(new e.Vector3).setFromMatrixColumn(this._gizmo.matrixWorld,this._handleIndex).normalize().multiplyScalar(t-this.getValue());this.beginGesture();this._move(i);this.endGesture()}else if(this._handleIndex>=6&&this._handleIndex<9){var o=this._gizmo.rotation.clone();o[["x","y","z"][this._handleIndex-6]]=e.MathUtils.degToRad(t);var r=(new e.Quaternion).setFromEuler(o);var a=this._gizmo.quaternion.clone().invert().multiply(r);o.setFromQuaternion(a);this.beginGesture();this._rotate(o);this.endGesture()}};h.prototype.expandBoundingBox=function(t){if(this._viewport){this._expandBoundingBox(t,this._viewport.getCamera().getCameraRef(),true)}};h.prototype._updateGizmoTransformation=function(t,e){this._matViewProj.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse);var i=this._getGizmoScale(this._gizmo.position);this._gizmo.scale.setScalar(this._gizmoSize*i);this._gizmo.updateMatrixWorld(true);this._updateAxisTitles(this._axisTitles,this._gizmo,e,this._gizmoSize+18,i);this._line.scale.setScalar(1/(this._gizmoSize*i))};h.prototype._getEditingFormPosition=function(){var t=this._getGizmoScale(this._gizmo.position);var i=new e.Vector3;if(this._handleIndex>=0&&this._handleIndex<3){i.setFromMatrixColumn(this._gizmo.matrixWorld,this._handleIndex).normalize()}else if(this._handleIndex>=6&&this._handleIndex<9){var o=this._handleIndex%3;var r=this._extractBasis(this._gizmo.matrixWorld);i.copy(r[(o+1)%3]).add(r[(o+2)%3]).normalize()}return i.clone().multiplyScalar((this._gizmoSize+18)*t).add(this._gizmo.position).applyMatrix4(this._matViewProj)};h.prototype.render=function(){n(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");var t=this._viewport.getRenderer(),e=this._viewport.getCamera().getCameraRef();t.clearDepth();this._updateGizmoTransformation(0,e);t.render(this._sceneGizmo,e);this._updateEditingForm(this._handleIndex>=0&&this._handleIndex<3||this._handleIndex>=6&&this._handleIndex<9,this._handleIndex%3)};return h});
//# sourceMappingURL=AnchorPointToolGizmo.js.map