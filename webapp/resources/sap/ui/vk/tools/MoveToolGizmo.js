/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../getResourceBundle","../thirdparty/three","../thirdparty/BufferGeometryUtils","./Gizmo","./CoordinateSystem","./GizmoPlacementMode","./AxisColours","../AnimationTrackType","sap/base/assert","sap/base/Log"],function(t,e,i,r,o,a,n,s,l,h){"use strict";var d=r.extend("sap.ui.vk.tools.MoveToolGizmo",{metadata:{library:"sap.ui.vk"},renderer:{apiVersion:2,render:function(t,e){t.openStart("div",e);t.class("sapUiVkTransformationToolEdit");t.openEnd();t.renderControl(e._editingForm);t.close("div")}}});d.prototype.init=function(){r.prototype.init.apply(this);this._createEditingForm(t().getText("TOOL_UNITS_MM"),84);this._gizmoIndex=-1;this._handleIndex=-1;this._value=new e.Vector3;this._moveDelta=new e.Vector3;this._noHitOffset=new e.Vector3;this._viewport=null;this._tool=null;this._sceneGizmo=new e.Scene;const s=new e.DirectionalLight(16777215,.5*Math.PI);s.position.set(1,3,2);this._sceneGizmo.add(s);this._sceneGizmo.add(new e.AmbientLight(16777215,.5*Math.PI));this._gizmo=new e.Group;this._touchAreas=new e.Group;this._sceneGizmo.add(this._gizmo);this._coordinateSystem=o.World;this._placementMode=a.Default;this._nodes=[];this._matViewProj=new e.Matrix4;this._gizmoSize=96;function l(t,r,o){var a=96,n=1,s=24,l=4,h=48;t.multiplyScalar(1/a);var d=new e.MeshLambertMaterial({color:r,transparent:true});var c=new e.CylinderGeometry(n,n,a-s,4);var p=(new e.Matrix4).makeBasis(new e.Vector3(t.y,t.z,t.x),t,new e.Vector3(t.z,t.x,t.y));p.setPosition(t.clone().multiplyScalar((a-s)*.5));c.applyMatrix4(p);var u=new e.Mesh(c,d);u.matrixAutoUpdate=false;u.userData.color=r;var f=new e.CylinderGeometry(0,l,s,12,1);p.setPosition(t.clone().multiplyScalar(a-s*.5));f.applyMatrix4(p);var m=new e.Mesh(f,d);m.matrixAutoUpdate=false;u.add(m);var _=new e.CylinderGeometry(h*.5,h*.5,h,12,1);_.applyMatrix4(p);var v=new e.CylinderGeometry(h*.5,h*.2,h,12,1);p.setPosition(t.clone().multiplyScalar(a*.5));v.applyMatrix4(p);var y=i.mergeGeometries([_,v]);o.add(new e.Mesh(y,d));return u}function h(t,i,r){var o=new Float32Array(9);o[t]=o[i+6]=1;o[t+3]=o[i+3]=.5;var a=new e.BufferGeometry;var n=new Float32Array(12);n[3+t]=n[6+i]=n[9+t]=n[9+i]=.333;a.setAttribute("position",new e.Float32BufferAttribute(n,3));a.setIndex([0,2,1,1,2,3]);var s=new e.MeshBasicMaterial({color:16776960,opacity:.5,transparent:true,visible:false,side:e.DoubleSide});var l=new e.Mesh(a,s);l.matrixAutoUpdate=false;l.userData.colors=o;var h=new e.BufferGeometry;var d=new Float32Array(9);d[t]=d[t+3]=d[i+3]=d[i+6]=.333;h.setAttribute("position",new e.Float32BufferAttribute(d,3));h.setAttribute("color",new e.Float32BufferAttribute(o,3));var c=new e.Line(h,new e.LineBasicMaterial({vertexColors:true,transparent:true,linewidth:window.devicePixelRatio}));c.matrixAutoUpdate=false;l.add(c);r.add(new e.Mesh(a,new e.MeshBasicMaterial({side:e.DoubleSide})));return l}this._gizmo.add(l(new e.Vector3(1,0,0),n.x,this._touchAreas));this._gizmo.add(l(new e.Vector3(0,1,0),n.y,this._touchAreas));this._gizmo.add(l(new e.Vector3(0,0,1),n.z,this._touchAreas));this._gizmo.add(h(1,2,this._touchAreas));this._gizmo.add(h(2,0,this._touchAreas));this._gizmo.add(h(0,1,this._touchAreas));this._axisTitles=this._createAxisTitles();this._sceneGizmo.add(this._axisTitles);var d=new e.BufferGeometry;d.setAttribute("position",new e.Float32BufferAttribute(new Float32Array(6),3));this._line=new e.LineSegments(d,new e.LineBasicMaterial);this._line.frustumCulled=false;this._line.visible=false;this._gizmo.add(this._line)};d.prototype.hasDomElement=function(){return true};d.prototype.resetValues=function(){this._value.setScalar(0)};d.prototype.setCoordinateSystem=function(t){this._coordinateSystem=t;var e=t===o.Screen;var i=this._gizmo.children,r=this._touchAreas.children;i[2].visible=i[3].visible=i[4].visible=!e;r[2].visible=r[3].visible=r[4].visible=!e;this._axisTitles.children[2].visible=!e;this._gizmoIndex=this._handleIndex=-1};d.prototype.show=function(t,e){this._viewport=t;this._tool=e;this._nodes.length=0;this._updateSelection(t._viewStateManager);var i=this._getNodesProperties();this._tool.fireEvent("moving",{x:0,y:0,z:0,nodesProperties:i},true);this._attachVisibilityChanged()};d.prototype.hide=function(){this._detachVisibilityChanged();this._cleanTempData();this._disposeBoundsTree();this._viewport=null;this._tool=null;this._gizmoIndex=this._handleIndex=-1;this._updateEditingForm(false)};d.prototype._onVisibilityChanged=function(t){if(this._tool.getEnableSnapping()){this._computeBoundsTree()}};d.prototype.getGizmoCount=function(){if(this._coordinateSystem===o.Local||this._coordinateSystem===o.Parent){return this._nodes.length}else{return this._nodes.length>0?1:0}};d.prototype.getTouchObject=function(t){if(this._nodes.length===0){return null}this._updateGizmoObjectTransformation(this._touchAreas,t);return this._touchAreas};var c=[1,2,4,6,5,3];d.prototype.highlightHandle=function(t,e){var i;for(i=0;i<3;i++){var r=this._gizmo.children[i];var o=c[t]&1<<i;var a=o?16776960:r.userData.color;r.material.color.setHex(a);r.material.opacity=o||e?1:.35;r.children[0].material.color.setHex(a);r.children[0].material.opacity=o||e?1:.35;var n=this._axisTitles.children[i];n.material.color.setHex(a);n.material.opacity=o||e?1:.35}for(i=3;i<6;i++){var s=this._gizmo.children[i];s.material.visible=i===t;var l=s.children[0].geometry.attributes.color;l.copyArray(i===t?[1,1,0,1,1,0,1,1,0]:s.userData.colors);l.needsUpdate=true;s.children[0].material.opacity=i===t||e?1:.35}};d.prototype.selectHandle=function(t,e){this._gizmoIndex=e;this._handleIndex=t;if(this._tool.getAutoResetValues()){this.resetValues()}this._viewport.setShouldRenderFrame(true)};d.prototype.beginGesture=function(){this._beginValue=this._value.clone();this._moveDelta.setScalar(0);this._noHitOffset.setScalar(0);this._matOrigin=this._gizmo.matrixWorld.clone();this._nodes.forEach(function(t){var i=t.node;t.matOrigin=i.matrixWorld.clone();t.originLocal=i.position.clone();t.origin=(new e.Vector3).setFromMatrixPosition(i.matrixWorld);if(i.parent){t.matParentInv=(new e.Matrix4).copy(i.parent.matrixWorld).invert()}else{t.matParentInv=new e.Matrix4}})};d.prototype._printEventInfo=function(t,e,i,r,o){h.debug(t+" is fired:"+" x = "+e+"; y = "+i+"; z = "+r);o.forEach(function(t){h.debug("Node: "+t.node.name);if(t.offsetToRest){h.debug("offsetToRest: [ "+t.offsetToRest[0]+", "+t.offsetToRest[1]+", "+t.offsetToRest[2]+" ] ")}else{h.debug("offsetToRest: null")}if(t.offsetToPrevious){h.debug("offsetToPrevious: [ "+t.offsetToPrevious[0]+", "+t.offsetToPrevious[1]+", "+t.offsetToPrevious[2]+" ] ")}else{h.debug("offsetToPrevious: null")}if(t.absolute){h.debug("absolute: [ "+t.absolute[0]+", "+t.absolute[1]+", "+t.absolute[2]+" ] ")}else{h.debug("absolute: null")}if(t.world){h.debug("world: [ "+t.world[0]+", "+t.world[1]+", "+t.world[2]+" ] ")}else{h.debug("world: null")}if(t.restDifference){h.debug("restDifference: [ "+t.restDifference[0]+", "+t.restDifference[1]+", "+t.restDifference[2]+" ] ")}else{h.debug("restDifference: null")}if(t.restDifferenceInCoordinates){h.debug("restDifferenceInCoordinates: [ "+t.restDifferenceInCoordinates[0]+", "+t.restDifferenceInCoordinates[1]+", "+t.restDifferenceInCoordinates[2]+" ] ")}else{h.debug("restDifferenceInCoordinates: null")}})};d.prototype._getOffsetToRestInCoordinateSystem=function(t,i,r){if(r===o.World){return i.toArray()}else if(r===o.Custom){var a=(new e.Matrix4).extractRotation(this._gizmo.matrixWorld);var n=(new e.Matrix4).copy(a).invert();return i.clone().applyMatrix4(n).toArray()}else if(r===o.Local){var s=(new e.Matrix4).extractRotation(t.matrixWorld);var l=(new e.Matrix4).copy(s).invert();return i.clone().applyMatrix4(l).toArray()}else if(r===o.Screen){var h=this._viewport.getRenderer().getSize(new e.Vector2);var d=this._viewport.getCamera().getCameraRef();var c=(new e.Vector4).copy(this._gizmo.position).applyMatrix4(this._matViewProj);var p=(new e.Matrix3).setFromMatrix4(d.matrixWorld);var u=(new e.Matrix3).copy(p).invert();var f=i.clone().applyMatrix3(u);var m=2*c.w/(d.projectionMatrix.elements[0]*h.width);var _=2*c.w/(d.projectionMatrix.elements[5]*h.height);return[f.x/m,f.y/_,0]}return null};d.prototype._getNodesProperties=function(){var t=[];this._nodes.forEach(function(i){var r=i.node;var a={};a.node=r;var n=this._getEffectiveParent(r);var l=new e.Matrix4;if(n===r.parent){var h=this._viewport._viewStateManager.getRelativeTransformation(r);a.offsetToRestInParent=h.translation.slice();if(r.parent){l=(new e.Matrix4).extractRotation(r.parent.matrixWorld)}a.offsetToPreviousInParent=a.offsetToRestInParent.slice();var d;if(this._playback){d=this._viewport._viewStateManager._getEndPropertyInPreviousPlayback(r,s.Translate,this._playback);if(d){a.offsetToPreviousInParent[0]-=d[0];a.offsetToPreviousInParent[1]-=d[1];a.offsetToPreviousInParent[2]-=d[2]}}var c=this._viewport._viewStateManager.getRestTransformation(r);var p=[c.translation[0],c.translation[1],c.translation[2]];if(d){p[0]+=d[0];p[1]+=d[1];p[2]+=d[2]}var u=new e.Quaternion;var f=new e.Vector3;var m=new e.Vector3;r.matrix.decompose(m,u,f);var _=(new e.Matrix4).makeTranslation(-p[0],-p[1],-p[2]);var v=(new e.Matrix4).makeTranslation(-c.translation[0],-c.translation[1],-c.translation[2]);if(f.x===0||f.y===0||f.z===0){f.x=1;f.y=1;f.z=1}var y=(new e.Matrix4).makeScale(1/f.x,1/f.y,1/f.z);var x=(new e.Matrix4).makeRotationFromQuaternion(u.invert());var g=y.clone().multiply(x).multiply(_).multiply(r.matrix);g.decompose(m,u,f);a.offsetToPrevious=m.toArray();var w=y.multiply(x).multiply(v).multiply(r.matrix);w.decompose(m,u,f);a.offsetToRest=m.toArray()}else{if(r.userData.skipUpdateJointNode){this._viewport._viewStateManager._setJointNodeOffsets(r,s.Translate)}if(r.userData&&r.userData.offsetTranslation){a.offsetToRestInParent=r.userData.offsetTranslation.slice()}else{a.offsetToRestInParent=[0,0,0]}a.offsetToPreviousInParent=a.offsetToRestInParent.slice();if(r.userData.skipUpdateJointNode){r.userData.skipUpdateJointNode=false;this._viewport._viewStateManager._setJointNodeMatrix();r.userData.skipUpdateJointNode=true}var M=this._viewport._viewStateManager.getRestTransformationUsingJoint(r);var S=new e.Vector3;var z=new e.Vector3(M.scale[0],M.scale[1],M.scale[2]);var b=new e.Quaternion(M.quaternion[0],M.quaternion[1],M.quaternion[2],M.quaternion[3]);if(r.userData.offsetScale){z.x*=r.userData.offsetScale[0];z.y*=r.userData.offsetScale[1];z.z*=r.userData.offsetScale[2]}if(r.userData.offsetQuaternion){var P=new e.Quaternion(r.userData.offsetQuaternion[0],r.userData.offsetQuaternion[1],r.userData.offsetQuaternion[2],r.userData.offsetQuaternion[3]);b.multiply(P)}var T=(new e.Matrix4).makeRotationFromQuaternion(b);var I=(new e.Matrix4).makeTranslation(M.translation[0],M.translation[1],M.translation[2]);var D=n.matrixWorld.clone().multiply(I).multiply(T).scale(z);var V=(new e.Matrix4).copy(D).invert().multiply(r.matrixWorld);V.decompose(S,b,z);a.offsetToPrevious=S.toArray();a.offsetToRest=S.toArray()}var C=this._viewport._viewStateManager.getTransformation(r);a.absolute=[C.translation[0],C.translation[1],C.translation[2]];var A=this._viewport._viewStateManager.getTransformationWorld(r);a.world=A.translation;var R;if(this._nodeUserDataMap){R=this._nodeUserDataMap.get(r)}if(R&&R.initialTranslation){a.restDifference=[C.translation[0]-R.initialTranslation[0],C.translation[1]-R.initialTranslation[1],C.translation[2]-R.initialTranslation[2]];if(this._coordinateSystem===o.Parent){a.restDifferenceInCoordinates=a.restDifference.slice()}else{var G=new e.Vector3(a.restDifference[0],a.restDifference[1],a.restDifference[2]).applyMatrix4(l);a.restDifferenceInCoordinates=this._getOffsetToRestInCoordinateSystem(r,G,this._coordinateSystem)}}t.push(a)}.bind(this));return t};d.prototype.endGesture=function(){this._line.visible=false;var t=this._getNodesProperties();var i=this._moveDelta.clone();if(this._coordinateSystem===o.Custom){var r=(new e.Matrix4).extractRotation(this._gizmo.matrixWorld);var a=(new e.Matrix4).copy(r).invert();i.applyMatrix4(a)}delete this._beginValue;this._nodes.forEach(function(t){var e=t.node;delete e.userData.skipUpdateJointNode;this._viewport._viewStateManager._setJointNodeOffsets(e,s.Translate)},this);this._tool.fireMoved({x:i.x,y:i.y,z:i.z,nodesProperties:t});this._printEventInfo("Event 'moved'",i.x,i.y,i.z,t)};d.prototype._setOffset=function(t,i){if(this._coordinateSystem===o.Local||this._coordinateSystem===o.Parent){var r=this._nodes[i];var a=r.node;var n=this._getEffectiveParent(a);if(this._coordinateSystem===o.Parent&&n){a=n}var s=(new e.Matrix4).copy(a.matrixWorld).invert();var l=(new e.Vector3).setFromMatrixScale(a.matrixWorld);var h=r.origin.clone().applyMatrix4(s);t=r.origin.clone().add(t).applyMatrix4(s).sub(h).multiply(l)}else if(this._coordinateSystem===o.Screen){var d=this._viewport.getRenderer().getSize(new e.Vector2);var c=this._gizmo.position.clone().applyMatrix4(this._matViewProj);var p=this._gizmo.position.clone().add(t).applyMatrix4(this._matViewProj);t.set(Math.round((p.x-c.x)*.5*d.width),Math.round((p.y-c.y)*.5*d.height),0)}var u=this._getNodesProperties();var f=t.clone();if(this._coordinateSystem===o.Custom){var m=(new e.Matrix4).extractRotation(this._gizmo.matrixWorld);var _=(new e.Matrix4).copy(m).invert();f.applyMatrix4(_)}if(this._tool.fireEvent("moving",{x:f.x,y:f.y,z:f.z,nodesProperties:u},true)){this._printEventInfo("Event 'moving'",f.x,f.y,f.z,u);this._move(t);if(this._coordinateSystem===o.Screen){t.set((new e.Vector3).setFromMatrixColumn(this._matOrigin,0).normalize().dot(t),(new e.Vector3).setFromMatrixColumn(this._matOrigin,1).normalize().dot(t),0)}else if(this._coordinateSystem===o.Custom){var v=this._getAnchorPoint();if(v){var y=(new e.Matrix4).copy(v.matrixWorld).invert();var x=(new e.Vector3).setFromMatrixScale(v.matrixWorld);var g=v.position.clone().applyMatrix4(y);t.copy(v.position.clone().add(t).applyMatrix4(y).sub(g).multiply(x))}}var w=this._line.geometry.getAttribute("position");w.array.set(t.multiplyScalar(-1).toArray());w.needsUpdate=true;this._line.geometry.computeBoundingBox();t.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z));t.multiplyScalar(1/Math.max(t.x,t.y,t.z));this._line.material.color.setRGB(t.x,t.y,t.z);this._line.visible=true}};d.prototype._move=function(t,i=false){this._value.addVectors(this._beginValue,t);this._moveDelta.copy(t);this._nodes.forEach(function(t){var e=t.node;e.userData.skipUpdateJointNode=true});if(this._coordinateSystem===o.Local||this._coordinateSystem===o.Parent){this._nodes.forEach(e=>{var i=e.node;var r=this._getEffectiveParent(i);var a=null;if(this._coordinateSystem===o.Parent&&r){a=this._extractBasis(r.matrixWorld)}else{a=this._extractBasis(i.matrixWorld)}var n=e.origin.clone();n.add(a[0].multiplyScalar(t.x)).add(a[1].multiplyScalar(t.y)).add(a[2].multiplyScalar(t.z));i.matrixWorld.setPosition(n);i.matrix.multiplyMatrices(e.matParentInv,i.matrixWorld);i.position.setFromMatrixPosition(i.matrix);i.updateMatrixWorld(true)})}else{if(this._coordinateSystem===o.Screen){var r=this._viewport.getRenderer().getSize(new e.Vector2);var a=this._viewport.getCamera().getCameraRef();var n=(new e.Vector4).copy(this._gizmo.position).applyMatrix4(this._matViewProj);var s=t.x*2*n.w/(a.projectionMatrix.elements[0]*r.width);var l=t.y*2*n.w/(a.projectionMatrix.elements[5]*r.height);t.setFromMatrixColumn(a.matrixWorld,0).multiplyScalar(s);t.add((new e.Vector3).setFromMatrixColumn(a.matrixWorld,1).multiplyScalar(l))}this._gizmo.position.setFromMatrixPosition(this._matOrigin).add(t);if(this._coordinateSystem===o.Custom){var h=this._getAnchorPoint();if(h){h.position.copy(this._gizmo.position)}}this._nodes.forEach(function(e){if(!e.ignore){var i=e.node;i.matrixWorld.setPosition(e.origin.clone().add(t));i.matrix.multiplyMatrices(e.matParentInv,i.matrixWorld);i.position.setFromMatrixPosition(i.matrix);i.updateMatrixWorld(true)}})}if(!i&&this._tool.getEnableSnapping()){if(this._checkSceneSelectionIntersection()){const i=new e.Vector3;for(let e=0;e<6;e++){i.copy(t).add(this._noHitOffset).multiplyScalar(.5);this._move(i,true);(this._checkSceneSelectionIntersection()?t:this._noHitOffset).copy(i)}if(!this._noHitOffset.equals(i)){this._move(this._noHitOffset,true)}}else{this._noHitOffset.copy(t)}}this._viewport.setShouldRenderFrame()};d.prototype.move=function(t,i,r){this.beginGesture();if(this._coordinateSystem===o.Custom){var a=new e.Vector3(t,i,r);var n=(new e.Matrix4).extractRotation(this._gizmo.matrixWorld);a.applyMatrix4(n);t=a.x;i=a.y;r=a.z}this._move(new e.Vector3(t,i,r||0))};d.prototype.getValue=function(){return this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3?this._value.getComponent(this._handleIndex):0};d.prototype.setValue=function(t){if(this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3){this.beginGesture();this._move((new e.Vector3).setComponent(this._handleIndex,t-this._value.getComponent(this._handleIndex)));this.endGesture()}};d.prototype.expandBoundingBox=function(t){if(this._viewport){this._expandBoundingBox(t,this._viewport.getCamera().getCameraRef(),true)}};d.prototype._updateSelection=function(t){r.prototype._updateSelection.call(this,t);if(this._tool.getEnableSnapping()){this._computeBoundsTree()}};d.prototype.handleSelectionChanged=function(t){if(this._viewport){this._updateSelection(this._viewport._viewStateManager);var e=this._getNodesProperties();this._tool.fireEvent("moving",{x:0,y:0,z:0,nodesProperties:e},true);this._gizmoIndex=this._handleIndex=-1}};d.prototype._updateGizmoTransformation=function(t,e){var i=this._updateGizmoObjectTransformation(this._gizmo,t);this._updateAxisTitles(this._axisTitles,this._gizmo,e,this._gizmoSize+18,i);this._line.scale.setScalar(1/(this._gizmoSize*i))};d.prototype._getEditingFormPosition=function(){var t=this._updateGizmoObjectTransformation(this._gizmo,this._gizmoIndex);var i=(new e.Vector3).setFromMatrixColumn(this._gizmo.matrixWorld,this._handleIndex).normalize();return i.clone().multiplyScalar((this._gizmoSize+18)*t).add(this._gizmo.position).applyMatrix4(this._matViewProj)};d.prototype.render=function(){l(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");if(this._nodes.length>0){var t=this._viewport.getRenderer(),e=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse);t.clearDepth();for(var i=0,r=this.getGizmoCount();i<r;i++){this._updateGizmoTransformation(i,e);t.render(this._sceneGizmo,e)}}this._updateEditingForm(this._nodes.length>0&&this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3,this._handleIndex)};return d});
//# sourceMappingURL=MoveToolGizmo.js.map