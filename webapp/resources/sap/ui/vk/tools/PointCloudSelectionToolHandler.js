/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/EventProvider","../thirdparty/three"],function(t,i){"use strict";const e=t.extend("sap.ui.vk.tools.PointCloudSelectionToolHandler",{metadata:{library:"sap.ui.vk"},constructor:function(t){this._priority=10;this._tool=t;this._gizmo=t.getGizmo();this._rect=null;this._rayCaster=new i.Raycaster;this._handleIndex=-1;this._handleAxis=new i.Vector3;this._gizmoOrigin=new i.Vector3;this._gizmoScale=1;this._matrixOrigin=new i.Matrix4;this._rotationOrigin=new i.Matrix4;this._mouse=new i.Vector2;this._mouseOrigin=new i.Vector2}});e.prototype._updateMouse=function(t){const e=this.getViewport();const s=e.getRenderer().getSize(new i.Vector2);this._mouse.x=(t.x-this._rect.x)/s.width*2-1;this._mouse.y=(t.y-this._rect.y)/s.height*-2+1;this._rayCaster.setFromCamera(this._mouse,e.getCamera().getCameraRef())};e.prototype._updateHandles=function(t,i){this._handleIndex=-1;if(t.n===1||t.event&&t.event.type==="contextmenu"){for(let t=0,i=this._gizmo.getGizmoCount();t<i;t++){const i=this._gizmo.getTouchObject(t);const e=this._rayCaster.intersectObject(i,true);if(e.length>0){this._handleIndex=i.children.indexOf(e[0].object);if(this._handleIndex>=0){this._gizmoOrigin.setFromMatrixPosition(i.matrixWorld);this._matrixOrigin.copy(i.matrixWorld);this._gizmoScale=i.scale.x;this._rotationOrigin.extractRotation(i.matrixWorld);if(this._handleIndex<3){this._handleAxis.setFromMatrixColumn(i.matrixWorld,this._handleIndex).normalize()}else if(this._handleIndex<6){this._handleAxis.setFromMatrixColumn(i.matrixWorld,this._handleIndex-3).normalize()}else if(this._handleIndex<9){this._handleAxis.setFromMatrixColumn(i.matrixWorld,this._handleIndex-6).normalize()}else if(this._handleIndex<15){this._handleAxis.setFromMatrixColumn(i.matrixWorld,this._handleIndex-9>>1).normalize();if(this._handleIndex&1){this._handleAxis.multiplyScalar(-1)}}}}}}this._gizmo.highlightHandle(this._handleIndex,i||this._handleIndex===-1)};e.prototype.hover=function(t){if(this._inside(t)&&!this._gesture){this._updateMouse(t);this._updateHandles(t,true);t.handled|=this._handleIndex>=0}};e.prototype.click=function(t){if(this._inside(t)&&!this._gesture){this._updateMouse(t);this._updateHandles(t,true);const i=this.getViewport().hitTest(t.x-this._rect.x,t.y-this._rect.y);if(i){if(this._gizmo.getCurrentGroup()){this._gizmo._setGroupPosition(i.point,t.event.shiftKey)}else{this._gizmo.addGroup({position:i.point})}}t.handled=true}};const s=new i.Vector3;e.prototype._getAxisOffset=function(){const t=this._rayCaster.ray;const i=this._handleAxis.clone().cross(t.direction).cross(t.direction).normalize();s.copy(t.origin).sub(this._gizmoOrigin);return i.dot(s)/i.dot(this._handleAxis)};e.prototype._getPlaneOffset=function(){const t=this._rayCaster.ray;s.copy(this._gizmoOrigin).sub(t.origin);const i=this._handleAxis.dot(s)/this._handleAxis.dot(t.direction);return t.direction.clone().multiplyScalar(i).sub(s)};e.prototype._getMouseAngle=function(){const t=this._rayCaster.ray;const i=this._rotationPoint.clone().sub(t.origin);const e=this._rotationAxis.dot(i)/this._rotationAxis.dot(t.direction);const s=t.direction.clone().multiplyScalar(e).sub(i).normalize();return Math.atan2(s.dot(this._axis2),s.dot(this._axis1))};e.prototype.beginGesture=function(t){if(this._inside(t)&&!this._gesture){this._updateMouse(t);this._updateHandles(t,false);if(this._handleIndex>=0){t.handled=true;this._gesture=true;this._mouseOrigin.copy(t);this._gizmo.beginGesture();if(this._handleIndex<3||this._handleIndex>=9&&this._handleIndex<15){this._dragOrigin=this._getAxisOffset()}else if(this._handleIndex<6){this._dragOrigin=this._getPlaneOffset()}else if(this._handleIndex<9){this._axis1=(new i.Vector3).setFromMatrixColumn(this._matrixOrigin,(this._handleIndex+1)%3).normalize();this._axis2=(new i.Vector3).setFromMatrixColumn(this._matrixOrigin,(this._handleIndex+2)%3).normalize();this._rotationAxis=(new i.Vector3).crossVectors(this._axis1,this._axis2).normalize();this._rotationPoint=(new i.Vector3).setFromMatrixPosition(this._matrixOrigin);if(Math.abs(this._rayCaster.ray.direction.dot(this._rotationAxis))<Math.cos(Math.PI*85/180)){const t=this.getViewport().getCamera().getCameraRef().matrixWorld;this._axis1.setFromMatrixColumn(t,0).normalize();this._axis2.setFromMatrixColumn(t,1).normalize();this._rotationAxis.setFromMatrixColumn(t,2).normalize()}this._startAngle=this._getMouseAngle()}}}};e.prototype.move=function(t){if(this._gesture){t.handled=true;this._updateMouse(t);if(this._handleIndex<3){if(isFinite(this._dragOrigin)){this._gizmo._setOffset(this._handleAxis.clone().multiplyScalar(this._getAxisOffset()-this._dragOrigin))}}else if(this._handleIndex<6){if(isFinite(this._dragOrigin.x)&&isFinite(this._dragOrigin.y)&&isFinite(this._dragOrigin.z)){this._gizmo._setOffset(this._getPlaneOffset().sub(this._dragOrigin))}}else if(this._handleIndex<9){const t=this._getMouseAngle()-this._startAngle;if(isFinite(t)){this._gizmo._setRotationAxisAngle(this._handleIndex-6,t)}}else if(this._handleIndex<15){if(isFinite(this._dragOrigin)){this._gizmo._setSize(this._handleIndex-9,this._getAxisOffset()-this._dragOrigin,this._handleAxis,sap.ui.Device.os.macintosh?t.event.metaKey:t.event.ctrlKey,t.event.shiftKey)}}}};e.prototype.endGesture=function(t){if(this._gesture){this._gesture=false;t.handled=true;this._updateMouse(t);this._gizmo.endGesture();this._dragOrigin=undefined;this._updateHandles(t,true)}};e.prototype.getViewport=function(){return this._tool._viewport};e.prototype._getOffset=function(t){const i=t.getBoundingClientRect();return{x:i.left+window.scrollX,y:i.top+window.scrollY}};e.prototype._inside=function(t){const i=this._tool._viewport.getIdForLabel();const e=document.getElementById(i);if(e==null){return false}const s=this._getOffset(e);this._rect={x:s.x,y:s.y,w:e.offsetWidth,h:e.offsetHeight};return t.x>=this._rect.x&&t.x<=this._rect.x+this._rect.w&&t.y>=this._rect.y&&t.y<=this._rect.y+this._rect.h};return e});
//# sourceMappingURL=PointCloudSelectionToolHandler.js.map