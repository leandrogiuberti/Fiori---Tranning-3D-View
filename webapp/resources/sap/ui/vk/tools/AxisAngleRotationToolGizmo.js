/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","../thirdparty/three","./Gizmo","./AxisColours","../AnimationTrackType","sap/base/assert"],function(t,e,i,a,o,r){"use strict";var n=i.extend("sap.ui.vk.tools.AxisAngleRotationToolGizmo",{metadata:{library:"sap.ui.vk"},renderer:{apiVersion:2,render:function(t,e){t.openStart("div",e);t.class("sapUiVkTransformationToolEdit");t.openEnd();t.renderControl(e._editingForm);t.close("div")}}});var s=[16711808,a.y,a.z];var l=Math.PI*2,h=Math.PI/2,u=13;var d=e.MathUtils.degToRad,p=e.MathUtils.radToDeg;n.prototype.init=function(){i.prototype.init.apply(this);this._createEditingForm(String.fromCharCode(176),84);this._gizmoIndex=-1;this._handleIndex=-1;this._value=new e.Vector3;this._rotationDelta=new e.Vector3;this._noHitRotation=new e.Euler;this._viewport=null;this._tool=null;this._sceneGizmo=new e.Scene;const t=new e.DirectionalLight(16777215,.5*Math.PI);t.position.set(1,3,2);this._sceneGizmo.add(t);this._sceneGizmo.add(new e.AmbientLight(16777215,.5*Math.PI));this._gizmo=new e.Group;this._sceneGizmo.add(this._gizmo);this._touchAreas=new e.Group;this._nodes=[];this._matViewProj=new e.Matrix4;this._gizmoSize=96;function a(t,i,a){var o=new e.TorusGeometry(i,16/96,4,a,t===2?Math.PI:l);if(t===0){o.rotateY(h)}else if(t===1){o.rotateX(h)}else{o.rotateZ(-h)}return new e.Mesh(o,new e.MeshBasicMaterial({opacity:.2,transparent:true}))}var o;for(o=0;o<3;o++){this._touchAreas.add(a(o,1,24))}for(o=0;o<3;o++){var r=new e.Mesh(new e.IcosahedronGeometry(.25,0),new e.MeshBasicMaterial({opacity:.2,transparent:true}));r.position.setComponent(o,1.6);this._touchAreas.add(r)}};n.prototype._createGizmoObject=function(){var t=new e.Group;var i=t.userData;function a(t,i,a,o){var r=new e.TorusGeometry(a,1/96,4,o,t===2?Math.PI:l);if(t===0){r.rotateY(h)}else if(t===1){r.rotateX(h)}else{r.rotateZ(-h)}var n=new e.Mesh(r,new e.MeshBasicMaterial({color:i,transparent:true}));n.matrixAutoUpdate=false;n.userData.color=i;return n}function o(t,i){var a=96*3,o=2,r=12*3,n=2*3;t.multiplyScalar(1/a);var s=new e.MeshLambertMaterial({color:i});var l=new e.CylinderGeometry(o,o,a-r,4);var h=(new e.Matrix4).makeBasis(new e.Vector3(t.y,t.z,t.x),t,new e.Vector3(t.z,t.x,t.y));h.setPosition(t.clone().multiplyScalar((a-r)*.5));l.applyMatrix4(h);var u=new e.Mesh(l,s);u.matrixAutoUpdate=false;u.userData.color=i;var d=new e.CylinderGeometry(0,n,r,12,1);h.setPosition(t.clone().multiplyScalar(a-r*.5));d.applyMatrix4(h);var p=new e.Mesh(d,s);p.matrixAutoUpdate=false;u.add(p);return u}var r;for(r=0;r<3;r++){t.add(a(r,s[r],1,128))}i.axisArrow=o(new e.Vector3(3,0,0),s[0]);t.add(i.axisArrow);var n=new e.BufferGeometry;n.setAttribute("position",new e.Float32BufferAttribute(new Float32Array([0,0,0,3,0,0]),3));i.arrowProjection=new e.Line(n,new e.LineDashedMaterial({color:s[0],transparent:true,scale:10,dashSize:1,gapSize:1}));i.arrowProjection.computeLineDistances();t.add(i.arrowProjection);t.add(new e.AxesHelper(1.5));i.arcMeshes=[];for(r=0;r<3;r++){var d=new e.Mesh(new e.BufferGeometry,new e.MeshBasicMaterial({vertexColors:true,opacity:.5,transparent:true,side:e.DoubleSide,depthWrite:false}));d.visible=false;i.arcMeshes.push(d);t.add(d)}i.valueLabels=[];for(r=0;r<3;r++){var p=this._createTextMesh("",64,32,u,16777215,false);p.renderOrder=10;p.material.depthTest=false;p.visible=false;i.valueLabels.push(p);t.add(p)}var c=i.axisTitles=this._createAxisTitles();c.scale.setScalar(1/this._gizmoSize);var _=this._gizmoSize*1.6;c.children[0].position.x=_;c.children[1].position.y=_;c.children[2].position.z=_;t.add(c);return t};n.prototype.hasDomElement=function(){return true};n.prototype.resetValues=function(){this._value.setScalar(0)};n.prototype.show=function(t,e){this._viewport=t;this._tool=e;this.handleSelectionChanged();this._tool.fireEvent("rotating",{x:0,y:0,z:0,nodesProperties:this._getNodesProperties()},true);this._attachVisibilityChanged()};n.prototype.hide=function(){this._detachVisibilityChanged();this._cleanTempData();this._disposeBoundsTree();this._viewport=null;this._tool=null;this._gizmoIndex=this._handleIndex=-1;this._updateEditingForm(false)};n.prototype._onVisibilityChanged=function(t){if(this._tool.getEnableSnapping()){this._computeBoundsTree()}};n.prototype.getGizmoCount=function(){return this._nodes.length};n.prototype.getTouchObject=function(t){if(this._nodes.length===0){return null}var e=this._gizmo.children[t];c(this._touchAreas.children[2],e.children[2]);c(this._touchAreas.children[0],e.children[0]);this._updateGizmoObjectTransformation(this._touchAreas,t);return this._touchAreas};n.prototype.highlightHandle=function(t,e,i){for(var a=0,o=this._gizmo.children.length;a<o;a++){var r=this._gizmo.children[a];var n=r.userData;for(var s=0;s<3;s++){var l=r.children[s];var h=s===t&&a===e?16776960:l.userData.color;l.material.color.setHex(h);l.material.opacity=t===-1||s===t?1:.35;l.material.visible=i||s===t;var u=n.axisTitles.children[s];u.material.color.setHex(a===e&&s===t-3?16776960:l.userData.color);u.material.opacity=i?1:.35;n.arcMeshes[s].material.visible=i||s===t||s===2&&t===1}}};n.prototype._snapToAxis=function(t){var i=-this._value.y,a=-this._value.z;switch(t){case 0:i+=90;break;case 1:a+=90;break;default:break}this.beginGesture();this._rotate(new e.Euler(0,d(i),d(a)));this.endGesture()};n.prototype.selectHandle=function(t,e){this._gizmoIndex=e;this._handleIndex=t;if(t>=3&&t<6){this._snapToAxis(t-3)}this._updateEditValue();this._viewport.setShouldRenderFrame()};function c(t,e){t.quaternion.copy(e.quaternion);t.position.copy(e.position);t.updateMatrix();t.updateMatrixWorld(true)}function _(t){return p(Math.atan2(t[0],t[2]))}function m(t){return p(Math.atan2(t[1],Math.sqrt(t[0]*t[0]+t[2]*t[2])))}function v(t,e){t=d(t);e=d(e);var i=Math.sin(t),a=Math.cos(t);var o=Math.sin(e),r=Math.cos(e);return[i*r,o,a*r]}function f(t,i,a,o){if(t.userData.angle1===a&&t.userData.angle2===o){return}t.userData.angle1=a;t.userData.angle2=o;var r=(new e.Color).setHex(s[i]);var n=[0,0,0];var h=[r.r,r.g,r.b];var u=new e.Vector3;var d=(i+1)%3,p=(i+2)%3;var c=o-a;var _,m=Math.min(Math.max(Math.ceil(Math.abs(c)*64/Math.PI),1),1e4);var v=Math.min(l/Math.abs(c),1);var f=e.MathUtils.lerp;for(_=0;_<=m;_++){var g=1-_/m;var x=a+c*g;var y=f(v,1,g);u.set(0,0,0).setComponent(d,Math.cos(x)*y).setComponent(p,Math.sin(x)*y);n.push(u.x,u.y,u.z);var z=f(1,.5,g);h.push(r.r*z,r.g*z,r.b*z)}var w=[];for(_=0;_<m;_++){w.push(0,_+1,_+2)}var M=t.geometry;M.setIndex(w);M.setAttribute("position",new e.Float32BufferAttribute(n,3));M.setAttribute("color",new e.Float32BufferAttribute(h,3));t.visible=c!==0}n.prototype._updateGizmoObject=function(t,i,a,o){var r=this._gizmo.children[t];var n=new e.Euler(0,d(a-90),0,"YZX");var s=r.children[2];s.quaternion.setFromEuler(n);s.updateMatrix();n.z=d(o);var l=r.children[0];l.quaternion.setFromEuler(n);l.updateMatrix();l.position.setFromMatrixColumn(l.matrix,0).multiplyScalar(2);l.updateMatrix();var h=r.userData;var u=h.axisArrow;u.quaternion.copy(l.quaternion);u.updateMatrix();var p=h.arrowProjection;var _=Math.cos(n.z);p.quaternion.copy(s.quaternion);p.scale.setScalar(_);p.updateMatrix();p.material.scale=_*10;var m=h.arcMeshes;f(m[0],0,0,d(i));c(m[0],r.children[0]);f(m[1],1,0,d(a));c(m[1],r.children[1]);f(m[2],2,0,d(o));c(m[2],r.children[2]);var v=h.valueLabels;x(v[0],i);x(v[1],a);x(v[2],o)};n.prototype.beginGesture=function(){this._rotationDelta.setScalar(0);this._noHitRotation.set(0,0,0);this._nodes.forEach(function(t){t.beginAngle=t.angle;t.beginAzimuth=t.azimuth;t.beginElevation=t.elevation})};n.prototype._getNodesProperties=function(){return this.getValues()};n.prototype.endGesture=function(){this._nodes.forEach(function(t){delete t.beginAngle;delete t.beginAzimuth;delete t.beginElevation});var t=this._getNodesProperties();this._tool.fireRotated({x:this._rotationDelta.x,y:this._rotationDelta.y,z:this._rotationDelta.z,nodesProperties:t})};function g(t,e){var i=window.devicePixelRatio;var a=t.width;var o=t.height;var r=a*.5;var n=o*.5;var s=Math.min(u*.85*i,r-1);var l=t.getContext("2d");l.font="Bold "+u*i+"px Arial";var d=l.measureText(e);var p=Math.min(d.width*.5-s*.5,r-s-1);l.clearRect(0,0,a,o);l.beginPath();l.arc(r-p,n,s,h,h*3,false);l.lineTo(r+p,n-s);l.arc(r+p,n,s,-h,h,false);l.lineTo(r-p,n+s);l.closePath();l.globalAlpha=.75;l.fillStyle="#fff";l.fill();l.globalAlpha=1;l.lineWidth=i;l.strokeStyle="#000";l.stroke();l.fillStyle="#000";l.textAlign="center";if(sap.ui.Device.browser.chrome||sap.ui.Device.browser.firefox){l.textBaseline="top";l.fillText(e,r,n-d.actualBoundingBoxDescent*.5)}else{l.textBaseline="middle";l.fillText(e,r,n)}}function x(t,e){t.visible=e!==0;if(t.visible&&t.userData.value!==e){t.userData.value=e;var i=e.toLocaleString("fullwide",{useGrouping:false,minimumFractionDigits:1,maximumFractionDigits:1})+"°";var a=t.material.map;g(a.image,i);a.needsUpdate=true}}n.prototype._updateEditValue=function(){var t=this._nodes[this._gizmoIndex];if(t){this._value.set(t.angle,t.azimuth,t.elevation)}};n.prototype._calculateRotationQuaternion=function(t){var i=(new e.Vector3).fromArray(v(t.azimuth,t.elevation));var a=this._getEffectiveParent(t.node);if(a!==t.node.parent){i.transformDirection(a.matrixWorld);i.transformDirection(t.node.parent.matrixWorld.clone().invert())}return(new e.Quaternion).setFromAxisAngle(i,d(t.angle))};n.prototype._updateNodeRotation=function(t){const e=this._calculateRotationQuaternion(t);const i=t.node;i.quaternion.multiplyQuaternions(e,t.quaternion);i.updateMatrix();i.updateMatrixWorld(true);delete i.userData.skipUpdateJointNode;this._viewport._viewStateManager._setJointNodeOffsets(i,o.Rotate)};n.prototype._rotate=function(t,i){this._rotationDelta.set(p(t.x),p(t.y),p(t.z));this._nodes.forEach(function(t){t.angle=t.beginAngle+this._rotationDelta.x;t.azimuth=(t.beginAzimuth+this._rotationDelta.y)%360;t.elevation=e.MathUtils.clamp(t.beginElevation+this._rotationDelta.z,-90,90);if(t.azimuth>180){t.azimuth-=360}if(t.azimuth<-180){t.azimuth+=360}this._updateNodeRotation(t)},this);if(!i&&this._tool.getEnableSnapping()){if(this._checkSceneSelectionIntersection()){const i=new e.Euler;for(let e=0;e<6;e++){i.set((t.x+this._noHitRotation.x)*.5,(t.y+this._noHitRotation.y)*.5,(t.z+this._noHitRotation.z)*.5);this._rotate(i,true);(this._checkSceneSelectionIntersection()?t:this._noHitRotation).copy(i)}if(!this._noHitRotation.equals(i)){this._rotate(this._noHitRotation,true)}}else{this._noHitRotation.copy(t)}}this._updateEditValue();this._viewport.setShouldRenderFrame()};n.prototype._setRotationAxisAngle=function(t,i,a){var o=a-i;if(t!==0){o%=l}var r=new e.Euler;r[["x","y","z"][t]]=o;var n=this._getNodesProperties();if(this._tool.fireEvent("rotating",{x:p(r.x),y:p(r.y),z:p(r.z),nodesProperties:n},true)){this._rotate(r)}};n.prototype.rotate=function(t,i,a){this.beginGesture();this._rotate(new e.Euler(d(t||0),d(i||0),d(a||0)))};n.prototype._getValueLocaleOptions=function(){return{useGrouping:false,minimumFractionDigits:1,maximumFractionDigits:2}};n.prototype.getValue=function(){return this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3?this._value.getComponent(this._handleIndex):0};n.prototype.setValue=function(t){if(this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3){var i=new e.Euler;i[["x","y","z"][this._handleIndex]]=d(t-this._value.getComponent(this._handleIndex));this.beginGesture();this._rotate(i);this.endGesture()}};n.prototype.rotateBy=function(t){this.beginGesture();this._rotate(new e.Euler(d(t),0,0));this.endGesture()};n.prototype.setAxis=function(t){this.beginGesture();var e=0;var i=0;if(Array.isArray(t)){e=_(t);i=m(t)}else{if("azimuth"in t){e=t.azimuth}if("elevation"in t){i=t.elevation}}this._nodes.forEach(function(t){t.azimuth=e;t.elevation=i;this._updateNodeRotation(t)},this);this._updateEditValue();this._viewport.setShouldRenderFrame();this.endGesture()};n.prototype.getValues=function(){var t=[];this._nodes.forEach(function(e){t.push({node:e.node,angle:e.angle,azimuth:e.azimuth,elevation:e.elevation,axis:v(e.azimuth,e.elevation)})});return t};n.prototype._getNodeInfoByNode=function(t){var e=this._nodes;for(var i=0,a=e.length;i<a;i++){if(e[i].node===t){return e[i]}}return null};n.prototype.setValues=function(t){t.forEach(function(t){var e=this._getNodeInfoByNode(t.node);if(e){e.angle=t.angle;if(t.axis){e.azimuth=_(t.axis);e.elevation=m(t.axis)}else{e.azimuth=t.azimuth;e.elevation=t.elevation}var i=this._calculateRotationQuaternion(e);e.quaternion.multiplyQuaternions(i.invert(),e.node.quaternion);this._updateNodeRotation(e)}},this);this._updateEditValue();this._viewport.setShouldRenderFrame()};n.prototype.expandBoundingBox=function(t){if(this._viewport){this._expandBoundingBox(t,this._viewport.getCamera().getCameraRef(),true)}};n.prototype._updateSelection=function(t){i.prototype._updateSelection.call(this,t);if(this._tool.getEnableSnapping()){this._computeBoundsTree()}};n.prototype.handleSelectionChanged=function(t){this._nodes.length=0;this._gizmoIndex=this._handleIndex=-1;if(this._viewport){this._updateSelection(this._viewport._viewStateManager);this._tool.fireEvent("rotating",{x:0,y:0,z:0,nodesProperties:this._getNodesProperties()},true);this._nodes.forEach(function(t){t.quaternion=t.node.quaternion.clone();t.angle=0;t.azimuth=0;t.elevation=0});var e=this._nodes.length;var i=this._gizmo;while(i.children.length>e){i.remove(i.children[i.children.length-1])}while(i.children.length<e){i.add(this._createGizmoObject())}}};n.prototype._getObjectSize=function(t){var i=new e.Box3;this._nodes[t].node._expandBoundingBox(i,true,false);if(i.isEmpty()){return 0}var a=new e.Vector3;i.getSize(a);return a.length()};n.prototype._updateGizmoObjectTransformation=function(t,e){var i=this._nodes[e].node;var a=this._getEffectiveParent(i);t.position.setFromMatrixPosition(i.matrixWorld);if(a){t.quaternion.setFromRotationMatrix(a.matrixWorld)}else{t.quaternion.set(0,0,0,1)}var o=this._getGizmoScale(t.position);t.scale.setScalar(this._gizmoSize*o);t.updateMatrix();t.updateMatrixWorld(true);return o};n.prototype._getValuePosition=function(t,i,a,o){a=d(a);o=d(o);var r=new e.Euler(0,0,0,"YZX");if(i===0){r.set(0,a,o)}else if(i===1){r.set(0,a*.5,0)}else{r.set(0,a,o*.5)}r.y-=h;t.set(i===0?3.25:1.25,0,0).applyEuler(r)};var y=new e.Vector3;n.prototype._updateGizmoTransformation=function(t,e){var i=this._gizmo.children[t];var a=this._nodes[t];var o=this._updateGizmoObjectTransformation(i,t);i.userData.axisTitles.children.forEach(function(t){t.quaternion.copy(i.quaternion).invert().multiply(e.quaternion)});for(var r=0;r<3;r++){var n=i.userData.valueLabels[r];this._getValuePosition(n.position,r,a.azimuth,a.elevation);n.quaternion.copy(i.quaternion).invert().multiply(e.quaternion);y.copy(n.position).applyMatrix4(i.matrixWorld);n.scale.setScalar(this._getGizmoScale(y)/(o*this._gizmoSize))}};n.prototype._getEditingFormPosition=function(){var t=this._gizmo.children[this._gizmoIndex];var e=this._nodes[this._gizmoIndex];this._updateGizmoObjectTransformation(t,this._gizmoIndex);this._getValuePosition(y,this._handleIndex,e.azimuth,e.elevation);return y.applyMatrix4(t.matrixWorld).applyMatrix4(this._matViewProj)};n.prototype.render=function(){r(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");if(this._nodes.length>0){var t=this._viewport.getRenderer(),e=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse);t.clearDepth();for(var i=0,a=this.getGizmoCount();i<a;i++){var o=this._nodes[i];this._updateGizmoObject(i,o.angle,o.azimuth,o.elevation);this._updateGizmoTransformation(i,e)}t.render(this._sceneGizmo,e);this._updateEditValue()}this._updateEditingForm(this._nodes.length>0&&this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3,this._handleIndex,["δ","γ","α"][this._handleIndex])};n.prototype._getOffsetForRestTransformation=function(t){};return n});
//# sourceMappingURL=AxisAngleRotationToolGizmo.js.map