/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","./Gizmo","./PoiToolGizmoRenderer","./GizmoPlacementMode","../NodeContentType","sap/base/assert","../TransformationMatrix"],function(t,e,o,i,r,n,s){"use strict";var a=e.extend("sap.ui.vk.tools.PoiToolGizmo",{metadata:{library:"sap.ui.vk"}});a.prototype.init=function(){if(e.prototype.init){e.prototype.init.apply(this)}this._viewport=null;this._tool=null;this._placementMode=i.ObjectCenter;this._nodes=[];this._poiIndex=-1;this._moveDelta=new t.Vector3;this._ignoreNonPoiNode=false};a.prototype.hasDomElement=function(){return true};a.prototype.setIgnoreNonPoiNode=function(t){this._ignoreNonPoiNode=t};a.prototype.getIgnoreNonPoiNode=function(){return this._ignoreNonPoiNode};a.prototype.show=function(t,e){this._viewport=t;this._tool=e;this._nodes.length=0;this._updateSelection(t._viewStateManager);var o=this._getNodesProperties();this._tool.fireEvent("moving",{x:0,y:0,z:0,nodesProperties:o},true)};a.prototype.hide=function(){this._cleanTempData();this._viewport=null;this._tool=null;this._poiIndex=-1};a.prototype.getPOICount=function(){return this._nodes.length};a.prototype.getPOI=function(t){return t<this._nodes.length?this._nodes[t].node:null};a.prototype.selectPOI=function(t){this._poiIndex=t;this._viewport.setShouldRenderFrame()};a.prototype.beginGesture=function(){this._moveDelta.setScalar(0);this._nodes.forEach(function(e){var o=e.node;if(this._ignoreNonPoiNode&&o._vkGetNodeContentType()!==r.Symbol){return}e.origin=(new t.Vector3).setFromMatrixPosition(o.matrixWorld);e.matParentInv=new t.Matrix4;if(o.parent){e.matParentInv.copy(o.parent.matrixWorld).invert()}},this)};a.prototype._getNodesProperties=function(){var t=[];this._nodes.forEach(function(e){t.push({node:e.node})});return t};a.prototype.endGesture=function(){if(this._moveDelta.x||this._moveDelta.y||this._moveDelta.z){this._tool.fireMoved({x:this._moveDelta.x,y:this._moveDelta.y,z:this._moveDelta.z,nodesProperties:this._getNodesProperties()})}};a.prototype._setOffset=function(t){if(this._tool.fireEvent("moving",{x:t.x,y:t.y,z:t.z,nodesProperties:this._getNodesProperties()},true)){this._move(t)}};a.prototype._move=function(e){this._moveDelta.copy(e);var o=this._viewport._isPanoramicActivated();var i=(new t.Vector3).setFromMatrixPosition(this._viewport.getCamera().getCameraRef().matrixWorld);this._nodes.forEach(function(n){var s=n.node;if(this._ignoreNonPoiNode&&s._vkGetNodeContentType()!==r.Symbol){return}if(!n.origin){n.origin=(new t.Vector3).setFromMatrixPosition(s.matrixWorld)}var a=n.origin.clone();if(o){var p=a.distanceTo(i);a.add(e).sub(i).setLength(p).add(i)}else{a.add(e)}s.matrixWorld.setPosition(a);s.matrix.multiplyMatrices(n.matParentInv,s.matrixWorld);s.position.setFromMatrixPosition(s.matrix);s.matrixWorldNeedsUpdate=true;this._updatePoiNodeTransform(s)},this);this._viewport.setShouldRenderFrame()};a.prototype.move=function(e,o,i){this.beginGesture();this._move(new t.Vector3(e,o,i||0))};a.prototype.handleSelectionChanged=function(t){if(this._viewport){this._updateSelection(this._viewport._viewStateManager);var e=this._getNodesProperties();this._tool.fireEvent("moving",{x:0,y:0,z:0,nodesProperties:e},true);this._poiIndex=-1}};a.prototype._updatePoiButtons=function(){this._tool.updateButtons()};a.prototype.render=function(){n(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");this._updatePoiButtons()};a.prototype._updatePoiNodeTransform=function(e){if(e&&e.userData.treeNode){var o=null;var i=this._viewport.getScene().getSceneBuilder();if(i){var r=i.getReferenceNodeFromMarkerNodeId(e.userData.nodeId);o=r?(new t.Matrix4).copy(r.matrixWorld).invert():new t.Matrix4;var n=e.matrix.clone();n.premultiply(o);e.userData.treeNode.transform=s.convertTo4x3(n.elements)}}};return a});
//# sourceMappingURL=PoiToolGizmo.js.map