/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/events/KeyCodes","../thirdparty/three","../thirdparty/BufferGeometryUtils","../threejs/PolylineMesh","../threejs/PolylineGeometry","../threejs/PolylineMaterial","../threejs/PointCloudGroup","./Gizmo","./AxisColours","sap/base/assert"],function(t,e,o,i,r,n,s,a,u,p){"use strict";const l=a.extend("sap.ui.vk.tools.PointCloudSelectionToolGizmo",{metadata:{library:"sap.ui.vk"},renderer:{apiVersion:2,render:function(t,e){t.openStart("div",e);t.class("sapUiVkTransformationToolEdit");t.openEnd();t.close("div")}}});const c=96;const h=["x","y","z"];l.prototype.init=function(){a.prototype.init?.apply(this);this._currentGroupIndex=-1;this._viewport=null;this._tool=null;this._sceneGizmo=new e.Scene;const t=new e.DirectionalLight(16777215,.5*Math.PI);t.position.set(1,3,2);this._sceneGizmo.add(t);this._sceneGizmo.add(new e.AmbientLight(16777215,.5*Math.PI));const s=this._touchAreas=new e.Group;const p=this._gizmo=new e.Group;this._sceneGizmo.add(p);this._matViewProj=new e.Matrix4;this._groups=[];const l=new e.MeshBasicMaterial({opacity:.2,transparent:true,side:e.DoubleSide});function c(t){s.add(new e.Mesh(t,l))}function d(t,i){const r=96,n=1,s=0,a=48;t.multiplyScalar(1/r);const u=new e.CylinderGeometry(n,n,r-s,4);const l=(new e.Matrix4).makeBasis(new e.Vector3(t.y,t.z,t.x),t,new e.Vector3(t.z,t.x,t.y));l.setPosition(t.clone().multiplyScalar((r-s)*.5));u.applyMatrix4(l);const h=new e.MeshLambertMaterial({color:i,transparent:true});const d=new e.Mesh(u,h);d.matrixAutoUpdate=false;p.add(d);const _=new e.CylinderGeometry(a*.45,a*.45,a,12,1);_.applyMatrix4(l);const f=new e.CylinderGeometry(a*.45,a*.2,a,12,1);l.setPosition(t.clone().multiplyScalar(r*.5));f.applyMatrix4(l);const m=o.mergeGeometries([_,f]);c(m)}function _(t,o){const i=new Float32Array(9);i[t]=i[o+6]=1;i[t+3]=i[o+3]=.5;const r=new e.BufferGeometry;const n=new Float32Array(12);n[3+t]=n[6+o]=n[9+t]=n[9+o]=.333;r.setAttribute("position",new e.Float32BufferAttribute(n,3));r.setIndex([0,2,1,1,2,3]);const s=new e.MeshBasicMaterial({color:16776960,opacity:.5,transparent:true,visible:false,side:e.DoubleSide});const a=new e.Mesh(r,s);a.matrixAutoUpdate=false;a.userData.colors=i;const u=new e.BufferGeometry;const l=new Float32Array(9);l[t]=l[t+3]=l[o+3]=l[o+6]=.333;u.setAttribute("position",new e.Float32BufferAttribute(l,3));u.setAttribute("color",new e.Float32BufferAttribute(i,3));const h=new e.Line(u,new e.LineBasicMaterial({vertexColors:true,transparent:true,linewidth:window.devicePixelRatio}));h.matrixAutoUpdate=false;a.add(h);p.add(a);c(r)}function f(t,o,i){const r=new e.TorusGeometry(1,t,4,o,Math.PI/2);if(i===0){r.rotateY(Math.PI/-2)}else if(i===1){r.rotateX(Math.PI/2)}return r}function m(t,o,i){const r=f(1/96,i,t);const n=new e.Mesh(r,new e.MeshBasicMaterial({color:o,transparent:true}));n.matrixAutoUpdate=false;p.add(n)}d(new e.Vector3(1,0,0),u.x);d(new e.Vector3(0,1,0),u.y);d(new e.Vector3(0,0,1),u.z);_(1,2);_(2,0);_(0,1);for(let t=0;t<3;t++){m(t,u[h[t]],32);c(f(16/96,4,t))}for(let t=0;t<6;t++){const o=t>>1;const i=new e.ConeGeometry(.125,.25,16);i.translate(0,.125,0);if(o===0){i.rotateZ(Math.PI/(t&1?-2:2))}else if(o===2){i.rotateX(Math.PI/(t&1?2:-2))}else if(t===2){i.rotateX(Math.PI)}const r=new e.Mesh(i,new e.MeshLambertMaterial({color:u[h[o]],transparent:true}));p.add(r);const n=new e.CylinderGeometry(.25,.25,.5,12,1);if(o===0){n.rotateZ(Math.PI/2)}else if(o===2){n.rotateX(Math.PI/-2)}c(n)}p.children.forEach(function(t){t.userData.color=t.material.color.toJSON()});const y={color:16777215,linewidth:2,dashCapStyle:0,dashPattern:[5,5],segmentCapStyle:1,trimStyle:0,transparent:true};this._polylineMaterial1=new n(Object.assign({lineColor:13421568,dashOffset:5},y));this._polylineMaterial2=new n(Object.assign({lineColor:16776960,dashOffset:0},y));const g=.5;const w=new r;w.setVertices([new e.Vector3(-g,-g,-g),new e.Vector3(g,-g,-g),new e.Vector3(-g,g,-g),new e.Vector3(g,g,-g),new e.Vector3(-g,-g,g),new e.Vector3(g,-g,g),new e.Vector3(-g,g,g),new e.Vector3(g,g,g)],[0,1,2,3,4,5,6,7,0,2,1,3,4,6,5,7,0,4,1,5,2,6,3,7]);this._boxMesh=new e.Scene;this._boxMesh.add(new i(w,this._polylineMaterial1));this._boxMesh.add(new i(w.clone(),this._polylineMaterial2))};l.prototype.hasDomElement=function(){return true};l.prototype.show=function(t,e){this._viewport=t;this._tool=e;this._updatePointCloudGroups()};l.prototype.hide=function(){this._updatePointCloudGroups([]);this._viewport=null;this._tool=null};const d=new e.Vector2;const _=new e.Matrix4;const f=new e.Matrix4;l.prototype.addGroup=function(t){this._currentGroupIndex=this._groups.length;t??={};t.color=this._tool?.getSelectionColor()?.slice()||[0,1,0,1];let o=100;if(this._viewport){const i=this._viewport.getCamera().getCameraRef();if(t.position instanceof e.Vector3){o=(i.isPerspectiveCamera?-t.position.clone().applyMatrix4(i.matrixWorldInverse).z:1)/i.projectionMatrix.elements[5]}else{this._viewport.getRenderer().getSize(d);const r=this._viewport.hitTest(d.x>>1,d.y>>1);if(r){o=r.distance;t.position??=r.point}else{o=(i.near+i.far)*.5;t.position??=(new e.Vector3).setFromMatrixColumn(i.matrixWorld,2).multiplyScalar(-o).add(i.position)}o=(i.isPerspectiveCamera?o:1)/i.projectionMatrix.elements[5]}}t.size??=o*.5;const i=new s(t);this._groups.push(i);this._updatePointCloudGroups();this._tool?.fireGroupAdded({group:i});this._tool?.fireCurrentGroupChanged({group:i});return i};l.prototype.removeGroup=function(t){if(t==null){t=this._groups.pop()}else{const e=typeof t==="number"?t:this._groups.indexOf(t);if(e>=0){t=this._groups.splice(e,1)[0]}else{t=null}}if(t){this._currentGroupIndex=Math.min(this._currentGroupIndex,this._groups.length-1);this._updatePointCloudGroups();this._tool?.fireGroupRemoved({group:t});this._tool?.fireCurrentGroupChanged({group:this.getCurrentGroup()})}return t};l.prototype.clearGroups=function(t){this._groups.length=0;this._currentGroupIndex=-1;this._updatePointCloudGroups()};l.prototype.getGizmoCount=function(){return this.getCurrentGroup()!=null?1:0};l.prototype._updateGizmoObjectTransformation=function(t,e){const o=this._groups[e];t.position.copy(o._position);t.quaternion.copy(o._quaternion);const i=this._getGizmoScale(t.position);t.scale.setScalar(c*i);t.updateMatrixWorld(true);for(let e=0;e<3;e++){const i=o._size.getComponent(e)*.5/t.scale.x;t.children[9+e*2].position.setComponent(e,-i);t.children[9+e*2].updateMatrixWorld(true);t.children[10+e*2].position.setComponent(e,i);t.children[10+e*2].updateMatrixWorld(true)}return i};l.prototype._updateGizmoTransformation=function(t){const e=this._updateGizmoObjectTransformation(this._gizmo,t);this._gizmo.scale.setScalar(c*e);this._gizmo.updateMatrixWorld(true)};l.prototype.getTouchObject=function(t){this._updateGizmoObjectTransformation(this._touchAreas,this._currentGroupIndex);return this._touchAreas};l.prototype.highlightHandle=function(t,e){if(this._handleIndex===t&&this._hoverMode===e){return}this._handleIndex=t;this._hoverMode=e;const o=16776960;const i=.35;const r=[1,2,4,6,5,3,1,2,4];for(let n=0;n<3;n++){const s=this._gizmo.children[n];s.visible=t<9||e;s.material.color.setHex(r[t]&1<<n?o:s.userData.color);s.material.opacity=t<9?1:i}for(let o=3;o<6;o++){const r=this._gizmo.children[o];r.material.visible=o===t;const n=r.children[0].geometry.attributes.color;n.copyArray(o===t?[1,1,0,1,1,0,1,1,0]:r.userData.colors);n.needsUpdate=true;r.children[0].visible=o===t||e;r.children[0].material.opacity=o===t||e&&t===-1?1:i}for(let r=6;r<9;r++){const n=this._gizmo.children[r];n.visible=r===t||e;n.material.color.setHex(r===t?o:n.userData.color);n.material.opacity=r===t||e&&t===-1?1:i}for(let r=9;r<15;r++){const n=this._gizmo.children[r];n.visible=r===t||e;n.material.color.setHex(r===t?o:n.userData.color);n.material.opacity=r===t||e&&t===-1?1:i}this._viewport?.setShouldRenderFrame()};l.prototype.beginGesture=function(){const t=this.getCurrentGroup();if(t){this._originPosition=t._position.clone();this._originSize=t._size.clone();this._originQuaternion=t._quaternion.clone()}};l.prototype.endGesture=function(){};l.prototype._setGroupPosition=function(t,e){const o=this.getCurrentGroup();if(o){if(e){o._position.x=t.x;o._position.z=t.z}else{o._position.copy(t)}this._updatePointCloudGroups()}};l.prototype._setOffset=function(t){const e=this.getCurrentGroup();if(e){e?._position.copy(this._originPosition).add(t);this._updatePointCloudGroups()}};l.prototype._setSize=function(t,e,o,i,r){const n=this.getCurrentGroup();if(n){const s=t>>1;let a=this._originSize.getComponent(s)+e;this.highlightHandle(9+(a>=0?t:(t&~1)+1-(t&1)),false);a=Math.abs(a);n._size.copy(this._originSize);if(r){const t=a/this._originSize.getComponent(s);if(s!==1){n._size.x*=t;n._size.z*=t}else{n._size.y*=t}}else if(i){n._size.multiplyScalar(a/this._originSize.getComponent(s))}else{n._size.setComponent(s,a);n._position.copy(o).multiplyScalar(e*.5).add(this._originPosition)}this._updatePointCloudGroups()}};l.prototype._setRotationAxisAngle=function(t,o){const i=this.getCurrentGroup();if(i){const r=new e.Euler;r[h[t]]=o;i._quaternion.setFromEuler(r).premultiply(this._originQuaternion);this._updatePointCloudGroups()}};l.prototype._updatePointCloudGroups=function(t){const e=this._viewport?.getScene()?.getSceneRef()?.userData;if(e){t??=this._groups;e.pointCloudGroupMatrices=t.map(function(t){return t.getMatrix().invert().transpose()});e.pointCloudGroupColors=t.map(function(t){return t.getColor()});this._viewport?.setShouldRenderFrame()}};l.prototype.expandBoundingBox=function(t){if(this._viewport){this._expandBoundingBox(t,this._viewport.getCamera().getCameraRef(),true)}};l.prototype.getCurrentGroup=function(){return this._currentGroupIndex>=0&&this._currentGroupIndex<this._groups.length?this._groups[this._currentGroupIndex]:null};l.prototype._previousGroup=function(){if(this._currentGroupIndex>0){this._currentGroupIndex--}this._viewport?.setShouldRenderFrame();this._tool?.fireCurrentGroupChanged({group:this.getCurrentGroup()})};l.prototype._nextGroup=function(){if(this._currentGroupIndex<this._groups.length){this._currentGroupIndex++}this._viewport?.setShouldRenderFrame();this._tool?.fireCurrentGroupChanged({group:this.getCurrentGroup()})};l.prototype._isCurrentGroupAdditive=function(){const t=this.getCurrentGroup();if(t){return t._color.w>0?true:false}return undefined};l.prototype._changeCurrentGroupType=function(t){const e=this.getCurrentGroup();if(e){e._color.w=t?this._tool?.getSelectionColor()[3]||1:0;this._updatePointCloudGroups();this._tool?.fireCurrentGroupChanged({group:e})}};l.prototype.render=function(){p(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");const t=this._viewport.getRenderer();const o=this._viewport.getCamera().getCameraRef();t.clearDepth();t.getSize(d);this._polylineMaterial1.resolution.copy(d);this._polylineMaterial2.resolution.copy(d);_.multiplyMatrices(o.projectionMatrix,o.matrixWorldInverse);const i=o instanceof e.PerspectiveCamera?o.near:undefined;this._groups.forEach((e,r)=>{this._boxMesh.position.copy(e._position);this._boxMesh.quaternion.copy(e._quaternion);this._boxMesh.scale.copy(e._size);this._boxMesh.updateMatrixWorld(true);f.multiplyMatrices(_,this._boxMesh.matrixWorld);this._boxMesh.children.forEach(function(t){t.computeLineDistances(f,d,i)});this._polylineMaterial1.opacity=this._polylineMaterial2.opacity=r===this._currentGroupIndex?1:.15;t.render(this._boxMesh,o)});if(this.getCurrentGroup()){this._updateGizmoTransformation(this._currentGroupIndex);t.render(this._sceneGizmo,o)}};return l});
//# sourceMappingURL=PointCloudSelectionToolGizmo.js.map