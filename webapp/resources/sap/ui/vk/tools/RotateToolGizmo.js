/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","./Gizmo","./RotatableAxis","./CoordinateSystem","./AxisColours","../AnimationTrackType","../AnimationTrackValueType","./GizmoPlacementMode","sap/base/assert","sap/base/Log"],function(e,t,i,o,r,a,n,s,l,u){"use strict";var h=t.extend("sap.ui.vk.tools.RotateToolGizmo",{metadata:{library:"sap.ui.vk"},renderer:{apiVersion:2,render:function(e,t){e.openStart("div",t);e.class("sapUiVkTransformationToolEdit");e.openEnd();e.renderControl(t._editingForm);e.close("div")}}});h.prototype.init=function(){t.prototype.init.apply(this);this._createEditingForm(String.fromCharCode(176),84);this._gizmoIndex=-1;this._handleIndex=-1;this._value=new e.Vector3;this._rotationDelta=new e.Vector3;this._noHitRotation=new e.Euler;this._viewport=null;this._tool=null;this._sceneGizmo=new e.Scene;this._gizmo=new e.Group;this._touchAreas=new e.Group;this._sceneGizmo.add(this._gizmo);this._axis=i.All;this._coordinateSystem=o.World;this._nodes=[];this._matViewProj=new e.Matrix4;this._gizmoSize=96;function a(t,i,o,r){var a=new e.TorusGeometry(o,1/96,4,r);if(t===0){a.rotateY(Math.PI/2)}else if(t===1){a.rotateX(Math.PI/2)}var n=new e.Mesh(a,new e.MeshBasicMaterial({color:i,transparent:true}));n.matrixAutoUpdate=false;n.userData.color=i;return n}function n(t,i,o){var r=new e.TorusGeometry(i,16/96,4,o);if(t===0){r.rotateY(Math.PI/2)}else if(t===1){r.rotateX(Math.PI/2)}return new e.Mesh(r,new e.MeshBasicMaterial({opacity:.2,transparent:true}))}for(var s=0;s<3;s++){this._gizmo.add(a(s,r[["x","y","z"][s]],1,128));this._touchAreas.add(n(s,1,24))}this._gizmo.add(new e.AxesHelper(.75));var l=new e.MeshBasicMaterial({color:33023,opacity:.5,transparent:true,side:e.DoubleSide});this._arcMesh=new e.Mesh(new e.BufferGeometry,l);this._arcMesh.visible=false;this._gizmo.add(this._arcMesh);this._axisTitles=this._createAxisTitles();this._sceneGizmo.add(this._axisTitles)};h.prototype.hasDomElement=function(){return true};h.prototype.setAxis=function(e){this._axis=e;var t=[i.All,i.X,i.Y,i.Z];if(this._coordinateSystem!==o.Screen){for(var r=0;r<3;r++){if(e!==i.All&&t[r+1]!==e){this._gizmo.children[r].visible=this._touchAreas.children[r].visible=false}else{this._gizmo.children[r].visible=this._touchAreas.children[r].visible=true}}}};h.prototype.resetValues=function(){this._value.setScalar(0)};h.prototype.setCoordinateSystem=function(e){this._coordinateSystem=e;var t=e===o.Screen;if(t){this._gizmo.children[0].visible=this._gizmo.children[1].visible=false;this._touchAreas.children[0].visible=this._touchAreas.children[1].visible=false;this._gizmo.children[2].visible=this._touchAreas.children[2].visible=true}else{this._gizmo.children[0].visible=this._touchAreas.children[0].visible=this._axis===i.All||this._axis===i.X;this._gizmo.children[1].visible=this._touchAreas.children[1].visible=this._axis===i.All||this._axis===i.Y;this._gizmo.children[2].visible=this._touchAreas.children[2].visible=this._axis===i.All||this._axis===i.Z}this._axisTitles.visible=!t;this._gizmoIndex=this._handleIndex=-1};h.prototype.show=function(e,t){this._viewport=e;this._tool=t;this._nodes.length=0;this._updateSelection(e._viewStateManager);var i=this._getNodesProperties();this._tool.fireEvent("rotating",{x:0,y:0,z:0,nodesProperties:i},true);this._attachVisibilityChanged()};h.prototype._prepareForCreatingRotationKey=function(t,i,o){this._nodes.forEach(function(r){var n=r.node;var s=[0,0,0];t.setTime(i,o);var l=t.getAnimatedProperty(n,a.Rotate);if(l.offsetToPrevious){s=l.offsetToPrevious}if(!this._nodeUserDataMap){this._nodeUserDataMap=new Map}var u=this._nodeUserDataMap.get(n);if(!u){u={};this._nodeUserDataMap.set(n,u)}u.eulerInParentCoors=new e.Euler(s[0],s[1],s[2]);u.startEulerInParentCoors=new e.Euler(s[0],s[1],s[2])}.bind(this));var r=t.getCurrentPlayback();if(r){this._prepareForCreatingKey(r)}};h.prototype.hide=function(){this._detachVisibilityChanged();this._cleanTempData();this._disposeBoundsTree();this._viewport=null;this._tool=null;this._gizmoIndex=this._handleIndex=-1;this._updateEditingForm(false)};h.prototype._onVisibilityChanged=function(e){if(this._tool.getEnableSnapping()){this._computeBoundsTree()}};h.prototype.getGizmoCount=function(){if(this._coordinateSystem===o.Local||this._coordinateSystem===o.Parent){return this._nodes.length}else{return this._nodes.length>0?1:0}};h.prototype.getTouchObject=function(e){if(this._nodes.length===0){return null}this._updateGizmoObjectTransformation(this._touchAreas,e);return this._touchAreas};h.prototype.highlightHandle=function(e,t){for(var i=0;i<3;i++){var o=this._gizmo.children[i];var r=i===e?16776960:o.userData.color;o.material.color.setHex(r);o.material.opacity=e===-1||i===e?1:.35;o.material.visible=t||i===e;var a=this._axisTitles.children[i];a.material.color.setHex(r);a.material.opacity=e===-1||i===e?1:.35;a.material.visible=t||i===e}};h.prototype.selectHandle=function(e,t){this._gizmoIndex=t;this._handleIndex=e;if(this._tool.getAutoResetValues()){this.resetValues()}this._viewport.setShouldRenderFrame(true)};h.prototype.beginGesture=function(){this._beginValue=this._value.clone();this._rotationDelta.setScalar(0);this._noHitRotation.set(0,0,0);this._nodes.forEach((t,i)=>{this._updateGizmoObjectTransformation(this._gizmo,i);t.matGizmo=this._gizmo.matrixWorld.clone();t.node.parent.updateMatrixWorld(true);t.matOrigin=t.node.matrixWorld.clone();t.matLocalOrigin=t.node.matrix.clone();if(t.node.parent){t.matParentInv=(new e.Matrix4).copy(t.node.parent.matrixWorld).invert()}else{t.matParentInv=new e.Matrix4}t.quaternion=t.node.quaternion.clone()})};h.prototype._printEventInfo=function(e,t,i,o,r){u.debug(e+" is fired:"+" x = "+t+"; y = "+i+"; z = "+o);r.forEach(function(e){u.debug("Node: "+e.node.name);if(e.offsetToRest){u.debug("offsetToRest: [ "+e.offsetToRest[0]+", "+e.offsetToRest[1]+", "+e.offsetToRest[2]+", "+e.offsetToRest[3]+" ] ")}else{u.debug("offsetToRest: null")}if(e.offsetToRestInCoordinates){u.debug("offsetToRestInCoordinates: [ "+e.offsetToRestInCoordinates[0]+", "+e.offsetToRestInCoordinates[1]+", "+e.offsetToRestInCoordinates[2]+" ] ")}else{u.debug("offsetToRestInCoordinates: null")}if(e.offsetToPrevious){u.debug("offsetToPrevious: [ "+e.offsetToPrevious[0]+", "+e.offsetToPrevious[1]+", "+e.offsetToPrevious[2]+" ] ")}else{u.debug("offsetToPrevious: null")}if(e.absolute){u.debug("absolute: [ "+e.absolute[0]+", "+e.absolute[1]+", "+e.absolute[2]+", "+e.absolute[3]+" ] ")}else{u.debug("absolute: null")}if(e.world){u.debug("world: [ "+e.world[0]+", "+e.world[1]+", "+e.world[2]+", "+e.world[3]+" ] ")}else{u.debug("world: null")}if(e.restDifference){u.debug("restDifference: [ "+e.restDifference[0]+", "+e.restDifference[1]+", "+e.restDifference[2]+", "+e.restDifference[3]+" ] ")}else{u.debug("restDifference: null")}if(e.restDifferenceInCoordinates){u.debug("restDifference: [ "+e.restDifferenceInCoordinates[0]+", "+e.restDifferenceInCoordinates[1]+", "+e.restDifferenceInCoordinates[2]+", "+e.restDifferenceInCoordinates[3]+" ] ")}else{u.debug("restDifference: null")}})};h.prototype._getNodesProperties=function(){var t=[];this._nodes.forEach(function(i){var o=i.node;var r={};r.node=o;var n;if(this._nodeUserDataMap){n=this._nodeUserDataMap.get(o)}if(n&&n.eulerInParentCoors){var s=new e.Euler(n.eulerInParentCoors.x,n.eulerInParentCoors.y,n.eulerInParentCoors.z);var l=(new e.Quaternion).setFromEuler(s);if(this._playback){var u=this._viewport._viewStateManager._getEndPropertyInPreviousPlayback(o,a.Rotate,this._playback);if(u){var h=new e.Quaternion(u[0],u[1],u[2],u[3]);l.multiply(h)}}r.offsetToRest=[l.x,l.y,l.z,l.w];r.offsetToPrevious=[n.eulerInParentCoors.x,n.eulerInParentCoors.y,n.eulerInParentCoors.z]}else{r.offsetToRest=null;r.offsetToPrevious=null}var d=this._viewport._viewStateManager.getTransformation(o);r.absolute=[d.quaternion[0],d.quaternion[1],d.quaternion[2],d.quaternion[3]];var f=this._viewport._viewStateManager.getTransformationWorld(o);var _=new e.Quaternion(f.quaternion[0],f.quaternion[1],f.quaternion[2],f.quaternion[3]);var p=(new e.Euler).setFromQuaternion(_);r.world=[p.x,p.y,p.z];if(n&&n.quatInitialDiffInv){var c=new e.Quaternion(d.quaternion[0],d.quaternion[1],d.quaternion[2],d.quaternion[3]);c.multiply(n.quatInitialDiffInv);r.restDifference=[c.x,c.y,c.z,c.w]}else{r.restDifference=null}if(n.euler){r.restDifferenceInCoordinates=[n.euler.x,n.euler.y,n.euler.z]}else{r.restDifferenceInCoordinates=null}r.offsetToRestInCoordinates=null;t.push(r)},this);return t};h.prototype.endGesture=function(){this._arcMesh.visible=false;var e=this._getNodesProperties();delete this._beginValue;this._nodes.forEach(function(e){var t=e.node;var i;if(this._nodeUserDataMap){i=this._nodeUserDataMap.get(t)}if(i&&i.euler){i.startEuler.x=i.euler.x;i.startEuler.y=i.euler.y;i.startEuler.z=i.euler.z;i.startEulerInParentCoors.x=i.eulerInParentCoors.x;i.startEulerInParentCoors.y=i.eulerInParentCoors.y;i.startEulerInParentCoors.z=i.eulerInParentCoors.z}if(this._coordinateSystem!==o.Custom){delete t.userData.skipUpdateJointNode}this._viewport._viewStateManager._setJointNodeOffsets(t,a.Rotate)},this);this._tool.fireRotated({x:this._rotationDelta.x,y:this._rotationDelta.y,z:this._rotationDelta.z,nodesProperties:e});this._printEventInfo("Event 'rotated'",this._rotationDelta.x,this._rotationDelta.y,this._rotationDelta.z,e)};var d=function(e,t){if(Math.abs(e-t)<1e-6){return e}if(e>t){while(e>t){t+=2*Math.PI}if(t-e<=Math.PI){return t}else{return t-2*Math.PI}}else{while(e<t){t-=2*Math.PI}if(e-t<=Math.PI){return t}else{return t+2*Math.PI}}};h.prototype.rotateFromRestPosition=function(t,i,r){if(this._coordinateSystem!==o.Parent){return}this.beginGesture();this._nodes.forEach(function(e){var t=e.node;t.userData.skipUpdateJointNode=true});t=e.MathUtils.degToRad(t);i=e.MathUtils.degToRad(i);r=e.MathUtils.degToRad(r);for(var n=0,s=this._nodes.length;n<s;n++){var l=this._nodes[n];if(!l.ignore){var u=l.node;var h;if(this._nodeUserDataMap){h=this._nodeUserDataMap.get(u)}if(h&&h.euler&&h.eulerInParentCoors){this._rotationDelta.set(e.MathUtils.radToDeg(t-h.eulerInParentCoors.x),e.MathUtils.radToDeg(i-h.eulerInParentCoors.y),e.MathUtils.radToDeg(r-h.eulerInParentCoors.z));h.eulerInParentCoors.x=t;h.eulerInParentCoors.y=i;h.eulerInParentCoors.z=r;var d=new e.Euler(h.eulerInParentCoors.x,h.eulerInParentCoors.y,h.eulerInParentCoors.z);var f=(new e.Quaternion).setFromEuler(d);var _=this._viewport._viewStateManager.getRestTransformationUsingJoint(u);var p=new e.Quaternion(_.quaternion[0],_.quaternion[1],_.quaternion[2],_.quaternion[3]);if(this._playback){var c=this._viewport._viewStateManager._getEndPropertyInPreviousPlayback(u,a.Rotate,this._playback);if(c){var m=new e.Quaternion(c[0],c[1],c[2],c[3]);f.multiply(m)}}var v=this._getEffectiveParent(u);if(v!==u.parent){this._viewport._viewStateManager._setJointNodeOffsets(u,a.Rotate);u.userData.offsetQuaternion=[f.x,f.y,f.z,f.w];u.userData.skipUpdateJointNode=false;this._viewport._viewStateManager._setJointNodeMatrix();u.userData.skipUpdateJointNode=true}else{u.quaternion.copy(f.multiply(p))}u.updateMatrix();h.euler.x=h.eulerInParentCoors.x-h.startEulerInParentCoors.x+h.startEuler.x;h.euler.y=h.eulerInParentCoors.y-h.startEulerInParentCoors.y+h.startEuler.y;h.euler.z=h.eulerInParentCoors.z-h.startEulerInParentCoors.z+h.startEuler.z}}}this.endGesture()};h.prototype.rotateRestPosition=function(t,i,r){this.beginGesture();this._nodes.forEach(function(e){var t=e.node;t.userData.skipUpdateJointNode=true});t=e.MathUtils.degToRad(t);i=e.MathUtils.degToRad(i);r=e.MathUtils.degToRad(r);for(var a=0,n=this._nodes.length;a<n;a++){var s=this._nodes[a];if(!s.ignore){var l=s.node;var u;if(this._nodeUserDataMap){u=this._nodeUserDataMap.get(l)}if(u&&u.euler&&u.eulerInParentCoors){this._rotationDelta.set(e.MathUtils.radToDeg(t-u.euler.x),e.MathUtils.radToDeg(i-u.euler.y),e.MathUtils.radToDeg(r-u.euler.z));u.euler.x=t;u.euler.y=i;u.euler.z=r;var h=new e.Euler(u.euler.x,u.euler.y,u.euler.z);var f=(new e.Quaternion).setFromEuler(h);var _=new e.Matrix4;var p=new e.Matrix4;if(this._coordinateSystem===o.Local){_=l.parent.matrixWorld.clone().multiply(u.matRest);p=u.matRestInv.clone().multiply(s.matParentInv)}else if(this._gizmo&&this._coordinateSystem!==o.Parent){_=this._gizmo.matrixWorld.clone();p=p.copy(_).invert()}var c=(new e.Matrix4).makeRotationFromQuaternion(f);var m=c;if(this._coordinateSystem!==o.Parent){m=s.matParentInv.clone().multiply(_).multiply(c).multiply(p).multiply(l.parent.matrixWorld)}var v=(new e.Matrix4).makeRotationFromQuaternion(u.quatInitialDiff).multiply(m);var g=(new e.Euler).setFromRotationMatrix(v);if(Math.abs(g.x)<1e-6){g.x=0}if(Math.abs(g.y)<1e-6){g.y=0}if(Math.abs(g.z)<1e-6){g.z=0}u.eulerInParentCoors.x=d(u.eulerInParentCoors.x,g.x);u.eulerInParentCoors.y=d(u.eulerInParentCoors.y,g.y);u.eulerInParentCoors.z=d(u.eulerInParentCoors.z,g.z);l.matrix=u.matInitialDiff.clone().multiply(m.multiply(u.matRest));l.matrix.decompose(l.position,l.quaternion,l.scale);l.updateMatrix()}}}this.endGesture()};h.prototype._updateEulerForCreatingAnimationKey=function(t){for(var i=0,r=this._nodes.length;i<r;i++){var n=this._nodes[i];if(!n.ignore){var s=n.node;var l;if(this._nodeUserDataMap){l=this._nodeUserDataMap.get(s)}if(l&&l.euler){l.euler.x=l.startEuler.x+t[0];l.euler.y=l.startEuler.y+t[1];l.euler.z=l.startEuler.z+t[2];var u=false;if(Math.abs(l.euler.x)<1e-6&&(Math.abs(l.euler.y)<1e-6||Math.abs(l.euler.z)<1e-6)||Math.abs(l.euler.y)<1e-6&&Math.abs(l.euler.z)<1e-6){u=true}if(u&&this._coordinateSystem===o.Parent){l.eulerInParentCoors.x=l.startEulerInParentCoors.x+t[0];l.eulerInParentCoors.y=l.startEulerInParentCoors.y+t[1];l.eulerInParentCoors.z=l.startEulerInParentCoors.z+t[2];continue}var h=this._viewport._viewStateManager.getRelativeTransformation(s);var f;var _=this._getEffectiveParent(s);if(_!==s.parent&&this._coordinateSystem!==o.Custom){this._viewport._viewStateManager._setJointNodeOffsets(s,a.Rotate);f=new e.Quaternion(s.userData.offsetQuaternion[0],s.userData.offsetQuaternion[1],s.userData.offsetQuaternion[2],s.userData.offsetQuaternion[3]);s.userData.skipUpdateJointNode=false;this._viewport._viewStateManager._setJointNodeMatrix();s.userData.skipUpdateJointNode=true}else{f=new e.Quaternion(h.quaternion[0],h.quaternion[1],h.quaternion[2],h.quaternion[3])}var p=(new e.Matrix4).makeRotationFromQuaternion(f);if(this._playback){var c=this._viewport._viewStateManager._getEndPropertyInPreviousPlayback(s,a.Rotate,this._playback);if(c){var m=new e.Quaternion(c[0],c[1],c[2],c[3]);var v=(new e.Matrix4).makeRotationFromQuaternion(m);p.multiply((new e.Matrix4).copy(v).invert())}}var g=(new e.Euler).setFromRotationMatrix(p);if(Math.abs(g.x)<1e-5){g.x=0}if(Math.abs(g.y)<1e-5){g.y=0}if(Math.abs(g.z)<1e-5){g.z=0}l.eulerInParentCoors.x=d(l.eulerInParentCoors.x,g.x);l.eulerInParentCoors.y=d(l.eulerInParentCoors.y,g.y);l.eulerInParentCoors.z=d(l.eulerInParentCoors.z,g.z);if(u){continue}var y=new e.Matrix4;var x=new e.Matrix4;if(this._coordinateSystem===o.Local){y=s.parent.matrixWorld.clone().multiply(l.matRest);x=l.matRestInv.clone().multiply(n.matParentInv)}else if(this._gizmo&&this._coordinateSystem!==o.Parent){y=this._gizmo.matrixWorld.clone();x=x.copy(y).invert()}var M=new e.Quaternion(h.quaternion[0],h.quaternion[1],h.quaternion[2],h.quaternion[3]);M.multiply(l.quatInitialDiffInv);var z=(new e.Matrix4).makeRotationFromQuaternion(M);var I=z;if(this._coordinateSystem!==o.Parent){I=x.clone().multiply(s.parent.matrixWorld).multiply(z).multiply(n.matParentInv).multiply(y)}g=(new e.Euler).setFromRotationMatrix(I);if(Math.abs(g.x)<1e-6){g.x=0}if(Math.abs(g.y)<1e-6){g.y=0}if(Math.abs(g.z)<1e-6){g.z=0}l.euler.x=d(l.euler.x,g.x);l.euler.y=d(l.euler.y,g.y);l.euler.z=d(l.euler.z,g.z)}}}};h.prototype._rotate=function(t,i=false){this._rotationDelta.set(e.MathUtils.radToDeg(t.x),e.MathUtils.radToDeg(t.y),e.MathUtils.radToDeg(t.z));this._value.addVectors(this._beginValue,this._rotationDelta);this._nodes.forEach(function(e){var t=e.node;t.userData.skipUpdateJointNode=true});const r=new e.Quaternion;const a=t.toArray();for(let t=0;t<3;t++){const i=a[t];if(i){const n=a[3].charCodeAt(t)-88;if(n>=0&&n<3){this._nodes.forEach(t=>{if(t.ignore&&this._coordinateSystem!==o.Local){return}const a=(new e.Vector3).setFromMatrixColumn(t.matGizmo,n).normalize();const s=(new e.Matrix4).makeRotationAxis(a,i);const l=(new e.Vector3).setFromMatrixPosition(t.matGizmo);s.setPosition(l.sub(l.clone().applyMatrix4(s)));const u=t.node;if(this._coordinateSystem!==o.Parent){u.position.setFromMatrixPosition(t.matOrigin).applyMatrix4(s).applyMatrix4(t.matParentInv)}const h=(new e.Vector3).setFromMatrixScale(t.matOrigin);const d=a.clone().transformDirection((new e.Matrix4).copy(t.matOrigin).invert()).multiply(h).normalize();r.setFromAxisAngle(d,i);u.quaternion.copy(t.quaternion).multiply(r);u.updateMatrix();u.updateMatrixWorld()})}}}this._updateEulerForCreatingAnimationKey(a);if(!i&&this._tool.getEnableSnapping()){if(this._checkSceneSelectionIntersection()){const i=new e.Euler;for(let e=0;e<6;e++){i.set((t.x+this._noHitRotation.x)*.5,(t.y+this._noHitRotation.y)*.5,(t.z+this._noHitRotation.z)*.5);this._rotate(i,true);(this._checkSceneSelectionIntersection()?t:this._noHitRotation).copy(i)}if(!this._noHitRotation.equals(i)){this._rotate(this._noHitRotation,true)}}else{this._noHitRotation.copy(t)}}this._viewport.setShouldRenderFrame()};h.prototype._setRotationAxisAngle=function(t,i,r){var a=(r-i)%(Math.PI*2);var n=new e.Euler;n[["x","y","z"][t]]=a;var s=this._getNodesProperties();if(this._tool.fireEvent("rotating",{x:e.MathUtils.radToDeg(n.x),y:e.MathUtils.radToDeg(n.y),z:e.MathUtils.radToDeg(n.z),nodesProperties:s},true)){this._printEventInfo("Event 'rotating'",e.MathUtils.radToDeg(n.x),e.MathUtils.radToDeg(n.y),e.MathUtils.radToDeg(n.z),s);this._rotate(n);var l=[0,0,0];var u=new e.Vector3;var h=(t+1)%3,d=(t+2)%3;var f,_=Math.max(Math.ceil(Math.abs(a)*64/Math.PI),1);a*=this._coordinateSystem===o.Local?-1:1;for(f=0;f<=_;f++){var p=i+a*(f/_);u.set(0,0,0).setComponent(h,Math.cos(p)).setComponent(d,Math.sin(p));l.push(u.x,u.y,u.z)}var c=[];for(f=0;f<_;f++){c.push(0,f+1,f+2)}var m=this._arcMesh.geometry;m.setIndex(c);m.setAttribute("position",new e.Float32BufferAttribute(l,3));this._arcMesh.visible=true}};h.prototype.rotate=function(t,i,o){this.beginGesture();this._rotate(new e.Euler(e.MathUtils.degToRad(t||0),e.MathUtils.degToRad(i||0),e.MathUtils.degToRad(o||0)))};h.prototype._getValueLocaleOptions=function(){return{useGrouping:false,minimumFractionDigits:1,maximumFractionDigits:2}};h.prototype.getValue=function(){return this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3?this._value.getComponent(this._handleIndex):0};h.prototype.setValue=function(t){if(this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3){var i=new e.Euler;i[["x","y","z"][this._handleIndex]]=e.MathUtils.degToRad(t-this._value.getComponent(this._handleIndex));this.beginGesture();this._rotate(i);this.endGesture()}};h.prototype.expandBoundingBox=function(e){if(this._viewport){this._expandBoundingBox(e,this._viewport.getCamera().getCameraRef(),true)}};h.prototype._updateSelection=function(e){t.prototype._updateSelection.call(this,e);if(this._tool.getEnableSnapping()){this._computeBoundsTree()}};h.prototype.handleSelectionChanged=function(e){if(this._viewport){this._updateSelection(this._viewport._viewStateManager);var t=this._getNodesProperties();this._tool.fireEvent("rotating",{x:0,y:0,z:0,nodesProperties:t},true);this._gizmoIndex=this._handleIndex=-1}};h.prototype._getLevelingQuaternion=function(e,t){e.set(0,0,0,1);switch(this._coordinateSystem){case o.Local:e.setFromRotationMatrix(this._nodes[t].node.parent.matrixWorld);break;case o.Screen:e.copy(this._viewport.getCamera().getCameraRef().quaternion);break;case o.Custom:var i=this._getAnchorPoint();if(i){e.copy(i.quaternion)}break;default:break}};h.prototype._getObjectSize=function(t){var i=new e.Box3;if(this._nodes.length===1){this._nodes[0].node._expandBoundingBox(i,true,false)}else if(this._coordinateSystem===o.Local){this._nodes[0].node._expandBoundingBox(i,true,false)}if(i.isEmpty()){return 0}var r=new e.Vector3;i.getSize(r);return r.length()};h.prototype._updateGizmoTransformation=function(e,t){const i=this._updateGizmoObjectTransformation(this._gizmo,e);if(this._beginValue!=null&&this._placementMode===s.ObjectCenter){this._gizmo.position.setFromMatrixPosition(this._nodes[e].matGizmo);this._gizmo.matrix.setPosition(this._gizmo.position);this._gizmo.matrixWorld.setPosition(this._gizmo.position)}this._updateAxisTitles(this._axisTitles,this._gizmo,t,this._gizmoSize-12,i)};h.prototype._getEditingFormPosition=function(){var t=this._updateGizmoObjectTransformation(this._gizmo,this._gizmoIndex);var i=(new e.Vector3).setFromMatrixColumn(this._gizmo.matrixWorld,this._handleIndex).normalize();return i.clone().multiplyScalar((this._gizmoSize-12)*t).add(this._gizmo.position).applyMatrix4(this._matViewProj)};h.prototype.render=function(){l(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");if(this._nodes.length>0){var e=this._viewport.getRenderer(),t=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);e.clearDepth();for(var i=0,o=this.getGizmoCount();i<o;i++){this._updateGizmoTransformation(i,t);e.render(this._sceneGizmo,t)}}this._updateEditingForm(this._nodes.length>0&&this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3,this._handleIndex)};return h});
//# sourceMappingURL=RotateToolGizmo.js.map