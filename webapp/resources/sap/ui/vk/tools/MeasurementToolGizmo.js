/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","../measurements/Edge","../measurements/Face","../measurements/Vertex","../measurements/MeshAnalyzer","../measurements/MeshAnalyzer2D","../measurements/Settings","./MeasurementToolState","./Gizmo","../thirdparty/three","sap/ui/core/Element"],function(e,t,r,s,a,n,i,u,o,l,h){"use strict";var c=o.extend("sap.ui.vk.tools.MeasurementToolGizmo",{metadata:{library:"sap.ui.vk"},renderer:null});var _=c.getMetadata().getParent().getClass().prototype;c.prototype.hasDomElement=function(){return false};c.prototype.init=function(){if(_.init){_.init.call(this)}this._viewport=null;this._surface=null;this._tool=null;this._vsm=null;this._settings=null;this._state=u.Off;this._hoverPoint=null;this._currentFeature=null;this._currentFeatureIndex=0;this._firstFeature=null;this._secondFeature=null;this._vertexFeatures=[new s];this._edgeFeatures=[new t];this._faceFeatures=[new r];this._currentMeasurement=null;this._meshAnalyzerMap=new Map;this._is2D=false};c.prototype.setCurrentFeatureIndex=function(a){if(a<1&&this._firstFeature){e.error("setCurrentFeatureIndex: first feature not null with index="+a)}if(a<2&&this._secondFeature){e.error("setCurrentFeatureIndex: second feature not null with index="+a)}var n=a-this._currentFeatureIndex;if(n===1){this._currentFeatureIndex++;this._vertexFeatures.push(new s);this._edgeFeatures.push(new t);this._faceFeatures.push(new r)}else if(n===-1){this._currentFeatureIndex--;this._vertexFeatures.pop();this._edgeFeatures.pop();this._faceFeatures.pop()}else if(a===0){this._currentFeatureIndex=0;this._vertexFeatures.splice(1);this._edgeFeatures.splice(1);this._faceFeatures.splice(1)}else if(n!==0){e.error("setCurrentFeatureIndex: "+this._currentFeatureIndex+" => "+a)}};c.prototype._createMeshAnalyzer=function(e){let t=null;let r=0;let s=0;let n=0;let i,u,o;let h=function(e){if(e.geometry&&e.geometry.isBufferGeometry){const s=e.geometry.getAttribute("position");const a=e.geometry.getIndex();const h=e.userData.renderGroup;if(s&&a){if(t){for(let r=h?h.start:0,n=h?h.start+h.count:a.count;r<n;r+=3){i=(new l.Vector3).fromArray(s.array,a.array[r]*3);u=(new l.Vector3).fromArray(s.array,a.array[r+1]*3);o=(new l.Vector3).fromArray(s.array,a.array[r+2]*3);i.applyMatrix4(e.matrixWorld);u.applyMatrix4(e.matrixWorld);o.applyMatrix4(e.matrixWorld);t.addTriangle([i.x,i.y,i.z],[u.x,u.y,u.z],[o.x,o.y,o.z])}}else{r+=h?h.count:a.count}}else if(s){if(t){for(let r=h?h.start:0,a=h?h.start+h.count:s.count;r<a;++r){i=(new l.Vector3).fromArray(s.array,r*3);i.applyMatrix4(e.matrixWorld);t._addVertex([i.x,i.y,i.z])}}else{n+=h?h.count:s.count}}}e.children.forEach(h)};for(let i=0;i<2;++i){h(e);if(i===0){t=new a(r/3,s,n)}}t.finishMeshBuilding();return t};c.prototype._createMeshAnalyzer2D=function(e){return new n(e,this._viewport.getCamera()._getViewBox())};c.prototype._getMeshAnalyzer=function(e){var t=this._meshAnalyzerMap.get(e);if(t!=null){return t}var r=this._is2D?this._createMeshAnalyzer2D(e):this._createMeshAnalyzer(e);this._meshAnalyzerMap.set(e,r);return r};c.prototype.show=function(e,t){this._viewport=e;this._surface=e.getMeasurementSurface();this._tool=t;this._vsm=h.getElementById(e.getViewStateManager());this._is2D=e.getScene().getMetadata().getName()==="sap.ui.vk.svg.Scene";this._settings=i.load();this._state=u.SearchingFirstFeature;this.setCurrentFeatureIndex(0)};c.prototype.hide=function(){if(this._surface!=null){var e=this._surface;for(var t=0,r=this._faceFeatures.length;t<r;++t){e.removeFeature(this._faceFeatures[t])}for(var s=0,a=this._edgeFeatures.length;s<a;++s){e.removeFeature(this._edgeFeatures[s])}for(var n=0,i=this._vertexFeatures.length;n<i;++n){e.removeFeature(this._vertexFeatures[n])}if(this._currentMeasurement!=null){e.removeMeasurement(this._currentMeasurement);this._currentMeasurement=null}}var o=this._vsm;var l=this._hoverPoint&&this._hoverPoint.nodeRef;if(l!=null&&o!=null){o.setOutliningStates([],[l],false,true)}this._viewport=null;this._surface=null;this._tool=null;this._vsm=null;this._settings=null;this._state=u.Off;this._currentFeature=null;this._firstFeature=null;this._secondFeature=null;this.setCurrentFeatureIndex(0);this._hoverPoint=null};c.prototype._computeSphereRadius=function(e,t){var r=this._is2D?5:3;if(this._is2D){var s=t._camera._worldToScreen(e[0],e[1]);var a=t._camera._screenToWorld(s.x+r,s.y);r=Math.abs(e[0]-a.x)}else{var n=t.getDomRef().getBoundingClientRect();var i=n.width*.5;var u=n.height*.5;var o=t.getCamera().getCameraRef();var h=(new l.Vector3).fromArray(e);var c=h.clone();c.project(o);var _=r/i;var f=r/u;r=0;for(var p=0;p<4;++p){var d=p%2?-1:1;var m=new l.Vector3(c.x+d*(p<2?_:0),c.y+d*(p>=2?f:0),c.z);m.unproject(o);var v=m.distanceTo(h);if(v>r){r=v}}}return r};c.prototype._getPointRadius=function(e){const t=e.getScene().getSceneRef?.().userData?.pointScale;return t?t/1024:undefined};c.prototype._replaceCurrentFeature=function(e,t,r){var s=false;if(e!==this._currentFeature){this._surface.removeFeature(this._currentFeature);this._surface.addFeature(e);this._currentFeature=e;s=true}else if(r!==e.getContext()||t!==e.getFeatureId()){s=true}if(s){e.setContext(r);e.setFeatureId(t)}return s};return c});
//# sourceMappingURL=MeasurementToolGizmo.js.map