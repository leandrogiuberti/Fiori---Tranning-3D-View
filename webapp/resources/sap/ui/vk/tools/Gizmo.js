/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../library","sap/m/library","sap/m/Input","sap/m/Label","sap/m/HBox","sap/ui/core/library","sap/ui/core/Control","./CoordinateSystem","./AxisColours","./ToolNodeSet","../thirdparty/three","../thirdparty/three-mesh-bvh","./GizmoPlacementMode","../AnimationTrackType"],function(t,e,i,o,n,r,a,s,l,c,h,u,p,d){"use strict";var f=e.InputType;var _=a.extend("sap.ui.vk.tools.Gizmo",{metadata:{library:"sap.ui.vk"},renderer:null});_.prototype.hasDomElement=function(){return true};_.prototype._drawText=function(t,e,i,o){var n=window.devicePixelRatio;var r=t.width;var a=t.height;var s=r*.5;var l=a*.5;var c=t.getContext("2d");c.clearRect(0,0,r,a);c.font="Bold "+i*n+"px Arial";c.textAlign="center";c.textBaseline="middle";c.fillStyle="#000";c.globalAlpha=.5;c.filter="blur(3px)";c.fillText(e,s+1,l+1);c.fillStyle="#fff";c.globalAlpha=1;c.filter="blur(0px)";c.fillText(e,s,l);if(o){c.beginPath();c.arc(s,l,s-n,0,2*Math.PI,false);c.closePath();c.lineWidth=n*2;c.strokeStyle="#fff";c.stroke()}};_.prototype._createTextMesh=function(t,e,i,o,n,r){var a=window.devicePixelRatio;var s=document.createElement("canvas");s.width=e*a;s.height=i*a;this._drawText(s,t,o,r);var l=new h.Texture(s);l.needsUpdate=true;var c=new h.MeshBasicMaterial({map:l,color:n,transparent:true,alphaTest:.05,premultipliedAlpha:true,side:h.DoubleSide});var u=new h.Mesh(new h.PlaneGeometry(e,i),c);u.userData.color=n;return u};_.prototype._createAxisTitles=function(t,e,i,o){t=t||32;e=e||20;var n=new h.Group;n.add(this._createTextMesh("X",t,t,e,l.x,i));n.add(this._createTextMesh("Y",t,t,e,l.y,i));n.add(this._createTextMesh("Z",t,t,e,l.z,i));if(o){n.add(this._createTextMesh("-X",t,t,e,l.x,i));n.add(this._createTextMesh("-Y",t,t,e,l.y,i));n.add(this._createTextMesh("-Z",t,t,e,l.z,i))}return n};_.prototype._extractBasis=function(t){var e=[new h.Vector3,new h.Vector3,new h.Vector3];t.extractBasis(e[0],e[1],e[2]);e[0].normalize();e[1].normalize();e[2].normalize();return e};_.prototype._updateAxisTitles=function(t,e,i,o,n){var r=this._extractBasis(e.matrixWorld);t.children.forEach(function(t,e){var n=o.constructor===h.Vector3?o.getComponent(e%3):o;t.position.copy(r[e%3]).multiplyScalar(n*(e<3?1:-1));t.quaternion.copy(i.quaternion)});t.position.copy(e.position);t.scale.setScalar(n)};_.prototype._updateSelection=function(t){if(t==null){return false}var e=[];if(this._tool){if(this._tool.getNodeSet()===c.Highlight){t.enumerateSelection(function(t){e.push({node:t})})}else{t.enumerateOutlinedNodes(function(t){e.push({node:t})})}}if(this._nodes.length===e.length&&this._nodes.every(function(t,i){return e[i].node===t.node})){return false}this._cleanTempData();this._nodes=e;e.forEach(function(t){t.ignore=false;var i=t.node.parent;while(i&&!t.ignore){for(var o=0,n=e.length;o<n;o++){if(e[o].node===i){t.ignore=true;break}}i=i.parent}this._getOffsetForRestTransformation(t.node)},this);return true};function m(t,e,i,o,n){const r=i.attributes.position;let a=e.length/3;const s=o?.firstVertex??0;const l=o?o.lastVertex-s:r.count;const c=o?.start??0;const u=o?.count??i.index?.count??l;if(i.index!=null){a-=s;const e=i.index.array;const o=new h.Vector3,n=new h.Vector3,l=new h.Vector3;for(let i=c,s=c+u;i<s;i+=3){const s=e[i],c=e[i+1],h=e[i+2];o.set(r.getX(s),r.getY(s),r.getZ(s));n.set(r.getX(c),r.getY(c),r.getZ(c)).sub(o);l.set(r.getX(h),r.getY(h),r.getZ(h)).sub(o);if(n.cross(l).lengthSq()>1e-4){t.push(s+a);t.push(c+a);t.push(h+a)}}}else{for(let e=0;e<u;e++){t.push(e+a)}}const p=new h.Vector3;for(let t=s,i=s+l;t<i;t++){p.set(r.getX(t),r.getY(t),r.getZ(t));if(n!=null){p.applyMatrix4(n)}e.push(p.x);e.push(p.y);e.push(p.z)}}_.prototype._createBVHGeometry=function(t,e){const i=new h.BufferGeometry;i.setIndex(e);i.setAttribute("position",new h.Float32BufferAttribute(t,3));i.boundsTree=new u.MeshBVH(i);return i};_.prototype._computeBoundsTree=function(){if(this._nodes.length===0){this._disposeBoundsTree();return}const t=new Set(this._nodes.map(t=>t.node));const e=this._viewport?._getViewStateManagerThreeJS();e?.getJoints()?.forEach(e=>{if(t.has(e.parent)){t.add(e.node)}});this._selectedMeshes=[];const i=[];const o=[];const n=(r,a)=>{if(!(e?.getVisibilityState(r)??r.visible)||r._vkUpdate||r.userData.renderStage>0||r.userData.renderStage<0){return}a||=t.has(r);if(r.geometry instanceof h.BufferGeometry&&!r.geometry.userData.isPointCloud){const t=r.userData;if(a){if(!t.bvhGeometry){const e=[];const i=[];m(e,i,r.geometry,t.renderGroup,null);t.bvhGeometry=this._createBVHGeometry(i,e)}this._selectedMeshes.push(r)}else{m(i,o,r.geometry,t.renderGroup,r.matrixWorld)}}r.children.forEach(t=>n(t,a))};n(this._viewport._getNativeScene(),false);this._staticGeometry=this._createBVHGeometry(o,i)};_.prototype._disposeBoundsTree=function(){this._selectedMeshes=[];this._staticGeometry=null};_.prototype._checkSceneSelectionIntersection=function(){this._viewport?._getViewStateManagerThreeJS()?._setJointNodeMatrix();return this._selectedMeshes.some(t=>this._staticGeometry.boundsTree.intersectsGeometry(t.userData.bvhGeometry,t.matrixWorld))};_.prototype.setPlacementMode=function(t){this._placementMode=t};_.prototype._getAnchorPoint=function(){return this._viewport?this._viewport._anchorPoint:null};_.prototype._getGizmoScale=function(t){var e=this._viewport.getRenderer();var i=this._viewport.getCamera().getCameraRef();var o=new h.Vector4;o.copy(t).applyMatrix4(this._matViewProj);return o.w*2/(e.getSize(new h.Vector2).x*i.projectionMatrix.elements[0])};_.prototype._getEffectiveParent=function(t){if(this._viewport._viewStateManager){var e=this._viewport._viewStateManager.getJoints();if(e){for(var i=0;i<e.length;i++){var o=e[i];if(!o.node||!o.parent){continue}if(o.node===t){return o.parent}}}}return t.parent};_.prototype._cleanTempData=function(){this._nodes.forEach(function(t){delete t.node.userData.skipUpdateJointNode});this._nodeUserDataMap?.clear();this._sequence=null};_.prototype._prepareForCreatingKey=function(t){this._playback=t};_.prototype._getOffsetForRestTransformation=function(t){if(this._viewport._viewStateManager){if(!this._nodeUserDataMap){this._nodeUserDataMap=new Map}var e=this._nodeUserDataMap.get(t);if(!e){e={};this._nodeUserDataMap.set(t,e)}var i=this._viewport._viewStateManager.getTransformation(t);var o=this._viewport._viewStateManager.getRestTransformation(t);if(!o){return}var n=new h.Vector3(o.translation[0],o.translation[1],o.translation[2]);var r=new h.Vector3(o.scale[0],o.scale[1],o.scale[2]);e.quatRest=new h.Quaternion(o.quaternion[0],o.quaternion[1],o.quaternion[2],o.quaternion[3]);e.matRest=(new h.Matrix4).compose(n,e.quatRest,r);e.matRestInv=(new h.Matrix4).copy(e.matRest).invert();e.initialTranslation=i.translation.slice();e.initialScale=i.scale.slice();e.initialQuaternion=new h.Quaternion(i.quaternion[0],i.quaternion[1],i.quaternion[2],i.quaternion[3]);e.matInitial=t.matrix.clone();e.matInitialInv=(new h.Matrix4).copy(t.matrix).invert();e.quatInitialDiff=e.initialQuaternion.clone().multiply(e.quatRest.clone().invert());e.quatInitialDiffInv=e.quatInitialDiff.clone().invert();e.matInitialDiff=t.matrix.clone().multiply(e.matRestInv);var a=[0,0,0];var s=this._viewport._viewStateManager.getAnimationPlayer();if(s){var l=s.getAnimatedProperty(t,d.Rotate);if(l.offsetToPrevious){a=l.offsetToPrevious}}e.euler=new h.Euler(0,0,0);e.startEuler=new h.Euler(0,0,0);e.eulerInParentCoors=new h.Euler(a[0],a[1],a[2]);e.startEulerInParentCoors=new h.Euler(a[0],a[1],a[2])}};_.prototype._updateGizmoObjectTransformation=function(t,e){const i=this._getAnchorPoint();t.position.setScalar(0);switch(this._placementMode){default:case p.Default:if(this._nodes.length>0){if(this._coordinateSystem===s.Local||this._coordinateSystem===s.Parent){t.position.setFromMatrixPosition(this._nodes[e].node.matrixWorld)}else{const e=new h.Vector3;this._nodes.forEach(function(i){e.setFromMatrixPosition(i.node.matrixWorld);t.position.add(e)});t.position.multiplyScalar(1/this._nodes.length)}}break;case p.ObjectCenter:const o=new h.Box3;if(this._coordinateSystem===s.Local||this._coordinateSystem===s.Parent){this._nodes[e].node._expandBoundingBox(o,true,true,true)}else{this._nodes.forEach(function(t){t.node._expandBoundingBox(o,true,true,true)})}o.getCenter(t.position);break;case p.Custom:if(i){t.position.copy(i.position)}break}const o=this._getGizmoScale(t.position);t.scale.setScalar(this._gizmoSize*o);t.matrixAutoUpdate=true;t.quaternion.set(0,0,0,1);switch(this._coordinateSystem){case s.Local:case s.Parent:if(e>=0&&e<this._nodes.length){const i=this._nodes[e].node;const o=this._coordinateSystem===s.Parent?this._getEffectiveParent(i)?.matrixWorld:null;const n=this._extractBasis(o??i.matrixWorld);t.matrix.makeBasis(n[0],n[1],n[2]);t.quaternion.setFromRotationMatrix(t.matrix);t.matrix.scale(t.scale);t.matrix.setPosition(t.position);t.matrixAutoUpdate=false}break;case s.Screen:const o=this._viewport.getCamera().getCameraRef();t.quaternion.copy(o.quaternion);break;case s.Custom:if(i){t.quaternion.copy(i.quaternion)}break;default:break}t.updateMatrixWorld(true);return o};_.prototype._expandBoundingBox=function(t,e,i){var o=this.getGizmoCount();if(o>0){this._matViewProj.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse);for(var n=0;n<o;n++){this._updateGizmoTransformation(n,e);this._sceneGizmo._expandBoundingBox(t,i,false)}}};_.prototype._createEditingForm=function(t,e){this._label=new o({}).addStyleClass("sapUiVkTransformationToolEditLabel");this._units=new o({text:t}).addStyleClass("sapUiVkTransformationToolEditUnits");this._input=new i({width:e+"px",type:f.Number,maxLength:10,textAlign:r.TextAlign.Right,change:t=>{this.setValue(t.getParameter("value"))}});this._editingForm=new n({items:[this._label,this._input,this._units]}).addStyleClass("sapUiSizeCompact");this._editingForm.onkeydown=this._editingForm.ontap=this._editingForm.ontouchstart=function(t){t.setMarked()}};_.prototype._getValueLocaleOptions=function(){return{useGrouping:false}};_.prototype._updateEditingForm=function(t,e,i){var o=this.getDomRef();if(o){if(t&&this._tool&&this._tool.getShowEditingUI()){this._label.setText(i||["X","Y","Z"][e]);this._label.rerender();var n=this._label.getDomRef();if(n){n.style.color=new h.Color(l[["x","y","z"][e]]).getStyle()}this._input.setValue(this.getValue().toLocaleString("fullwide",this._getValueLocaleOptions()));var r=this._getEditingFormPosition();var a=this._gizmo.position.clone().applyMatrix4(this._matViewProj).sub(r);var s=this._viewport.getDomRef().getBoundingClientRect();var c=o.getBoundingClientRect();var u=a.x>-1e-4;var p=u?c.width:-c.width;var d=c.height*.5;var f=h.MathUtils.clamp(s.width*(r.x*.5+.5)+(u?-20:20),Math.max(p,0),s.width+Math.min(p,0));var _=h.MathUtils.clamp(s.height*(r.y*-.5+.5),d,s.height-d);o.style.left=Math.round(f)+"px";o.style.top=Math.round(_)+"px";o.style.transform="translate("+(u?"-100%":"0%")+", -50%)";o.style.display="block"}else{o.style.display="none"}}};_.prototype._attachVisibilityChanged=function(){this._viewport?._getViewStateManagerThreeJS()?.attachVisibilityChanged(this._onVisibilityChanged,this)};_.prototype._detachVisibilityChanged=function(){this._viewport?._getViewStateManagerThreeJS()?.detachVisibilityChanged(this._onVisibilityChanged,this)};return _});
//# sourceMappingURL=Gizmo.js.map