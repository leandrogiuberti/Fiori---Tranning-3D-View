/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Element","sap/ui/vk/dvl/GraphicsCore","sap/ui/vk/Scene","sap/ui/vk/NodeHierarchy","./ViewableLoadInfo","./SceneNode","./ArrayUtilities"],function(jQuery,e,t,i,a,s,r,n){"use strict";var o=e.extend("sap.ui.vtm.Scene",{metadata:{events:{downloadProgress:{parameters:{viewable:{type:"sap.ui.vtm.Viewable"},downloadedBytes:{type:"int"},totalBytes:{type:"int"}}},downloadStarted:{parameters:{viewableLoadInfos:{type:"sap.ui.vtm.ViewableLoadInfo[]"}}},downloadCompleted:{parameters:{viewableLoadInfos:{type:"sap.ui.vtm.ViewableLoadInfo[]"},downloadedViewables:{type:"sap.ui.vtm.Viewable[]"}}},loadStarted:{parameters:{viewableLoadInfos:{type:"sap.ui.vtm.ViewableLoadInfo[]"}}},loadProgress:{viewable:{type:"sap.ui.vtm.Viewable"},percentage:{type:"float"}},loadCompleted:{parameters:{succeeeded:{type:"boolean"},viewableLoadInfos:{type:"sap.ui.vtm.ViewableLoadInfo[]"},loadedViewables:{type:"sap.ui.vtm.Viewable[]"}}},hierarchyChanged:{}}},init:function(){this._viewablesBySource=new Map;this._viewableLoadInfosByViewable=new Map;this._rootContentResource=new sap.ui.vk.ContentResource({localMatrix:sap.ui.vtm.MatrixUtilities.toVkMatrix(sap.ui.vtm.MatrixUtilities.createIdentity())})},_getGraphicsCore:function(){var e=this;return new Promise(function(i,a){if(e._vkGraphicsCore){i(e._vkGraphicsCore)}else{t.create({},{antialias:true,alpha:true,premultipliedAlpha:false}).then(function(t){e._vkGraphicsCore=t;t.attachEvent("sceneLoadingProgress",function(t){var i=t.getParameter("sourceName"),a=t.getParameter("percentage")*100,s=e._viewablesBySource.get(i);e.fireLoadProgress({viewable:s,percentage:a})},e);i(t)})}})},destroy:function(){if(this._vkGraphicsCore!==null){this._vkGraphicsCore.destroy();this._vkGraphicsCore=null}e.prototype.destroy.apply(this)},_raiseHierarchyChanged:function(){sap.ui.vtm.measure(this,"fireHierarchyChanged",function(){this.fireHierarchyChanged()}.bind(this))},_getViewableLoadInfos:function(e){var t=[];e.forEach(function(e){var i=this._viewableLoadInfosByViewable.get(e);t.push(i)}.bind(this));return t},_raiseDownloadStarted:function(e){sap.ui.vtm.measure(this,"fireDownloadStarted",function(){var t=this._getViewableLoadInfos(e);this.fireDownloadStarted({viewableLoadInfos:t})}.bind(this))},_raiseDownloadCompleted:function(e){sap.ui.vtm.measure(this,"fireDownloadCompleted",function(){var t=this._getViewableLoadInfos(e);var i=t.filter(function(e){return e.getStatus()===sap.ui.vtm.ViewableLoadStatus.Downloaded}).map(function(e){return e.getViewable()});this.fireDownloadCompleted({viewableLoadInfos:t,downloadedViewables:i})}.bind(this))},_raiseLoadStarted:function(e){sap.ui.vtm.measure(this,"fireLoadStarted",function(){var t=this._getViewableLoadInfos(e);this.fireLoadStarted({viewableLoadInfos:t})}.bind(this))},_raiseLoadCompleted:function(e,t){sap.ui.vtm.measure(this,"fireLoadCompleted",function(){var i=this._getViewableLoadInfos(t);var a=i.filter(function(e){return e.getStatus()===sap.ui.vtm.ViewableLoadStatus.Loaded}).map(function(e){return e.getViewable()});this.fireLoadCompleted({succeeded:e,viewableLoadInfos:i,loadedViewables:a})}.bind(this))},getRootIds:function(){if(this._vkNodeHierarchy){var e=this._vkNodeHierarchy.getChildren();this.addCachedIds(e);return e}return[]},_getSceneNode:function(e){if(!this._vkNodeHierarchy){throw"Scene hierarchy is empty"}var t=new sap.ui.vtm.SceneNode({sceneNodeId:e,scene:this});return t},_getNodeHierarchy:function(){return this._vkNodeHierarchy},_traverseBranch:function(e,t,i,a){i.setSceneNodeId(e);if(t(i,a)===false){return}a.push(e);if(!i.getClosed()){var s=this.getChildIds(e);s.forEach(function(e){this._traverseBranch(e,t,i,a)}.bind(this))}a.pop()},traverseBranch:function(e,t){if(!e){throw"sceneNodeId not defined"}if(!t){throw"callback not defined"}sap.ui.vtm.measure(this,"traverseBranch ("+e+")",function(){var i=this._getSceneNode(e);var a=this.getAncestorIds(e);this._traverseBranch(e,t,i,a);i._destroy()}.bind(this));return this},traverseTree:function(e){if(!e){throw"callback not defined"}if(!this._vkNodeHierarchy){return this}sap.ui.vtm.measure(this,"traverseTree",function(){var t=this.getRootIds();var i=this._getSceneNode(null);t.forEach(function(t){this._traverseBranch(t,e,i,[])}.bind(this));i._destroy()}.bind(this));return this},traverseNodes:function(e,t){if(!e){throw"sceneNodeIds not defined"}if(!t){throw"callback not defined"}if(!Array.isArray(e)){e=[e]}sap.ui.vtm.measure(this,"traverseNodes ("+e.join(",")+")",function(){var i=this._getSceneNode(null);for(var a=0;a<e.length;a++){i.setSceneNodeId(e[a]);if(t(i,a)===false){break}}i._destroy()}.bind(this));return this},_handleLoadContentResourcesAsyncCompleted:function(e,t){t.forEach(function(t){var i=t.getSource();var a=sap.ui.vtm.ArrayUtilities.find(e,function(e){return e.source===i});var s=this._viewableLoadInfosByViewable.get(t);if(a){s.setStatus(sap.ui.vtm.ViewableLoadStatus.DownloadFailed);s.setErrorCode(a.status);s.setErrorText(a.statusText)}else{s.setStatus(sap.ui.vtm.ViewableLoadStatus.Downloaded)}}.bind(this));this._raiseDownloadCompleted(t);if(this.getDownloadedViewables().length!=0){this._raiseLoadStarted(t);setTimeout(function(){var e=function(){t.forEach(function(e){var t=this._viewableLoadInfosByViewable.get(e);var i=t.getStatus();if(i===sap.ui.vtm.ViewableLoadStatus.Loaded&&!e.getRootNodeIds()){var a=e._getContentResource().getNodeProxy();if(a){var s=a.getNodeId();this.addCachedIds(s);var r=this.getChildIds(s);e.setRootNodeIds(r)}}}.bind(this))}.bind(this);var i=function(e){var i=sap.ui.vtm.ArrayUtilities.find(t,function(t){return t.getSource()===e});if(i){var a=this._viewableLoadInfosByViewable.get(i);a.setStatus(sap.ui.vtm.ViewableLoadStatus.Loaded)}}.bind(this);var a=function(e){var i=sap.ui.vtm.ArrayUtilities.find(t,function(t){return t.getSource()===e});if(i){var a=this._viewableLoadInfosByViewable.get(i);a.setStatus(sap.ui.vtm.ViewableLoadStatus.LoadFailed)}}.bind(this);var s=function(e){var t=e.getParameter("source");var s=e.getParameter("sceneId");if(s){i(t)}else{a(t)}};this._vkGraphicsCore.attachSceneLoadingFinished(s);var r=t.filter(function(e){var t=this._viewableLoadInfosByViewable.get(e);switch(t.getStatus()){case sap.ui.vtm.ViewableLoadStatus.Downloading:case sap.ui.vtm.ViewableLoadStatus.DownloadFailed:return false;default:return true}}.bind(this));r.forEach(function(e){var t=e._getContentResource();if(this._rootContentResource.getContentResources().indexOf(t)<0){this._rootContentResource.addContentResource(t)}}.bind(this));if(!this._sceneCreated){var n=sap.ui.vtm.createMeasureId(this,"Building scene tree");jQuery.sap.measure.start(n,"",["sap.ui.vtm"]);this._vkGraphicsCore.buildSceneTreeAsync([this._rootContentResource]).then(function(i){jQuery.sap.measure.end(n);this._vkGraphicsCore.detachSceneLoadingFinished(s);this._vkScene=i.scene;this._vkNodeHierarchy=this._vkScene.getDefaultNodeHierarchy();var a=this.getRootIds();this.addCachedIds(a);e();this._sceneCreated=true;this.fireEvent("sceneCreated");this._raiseHierarchyChanged();this._raiseLoadCompleted(true,t)}.bind(this)).catch(function(e){jQuery.sap.measure.end(n);this._vkGraphicsCore.detachSceneLoadingFinished(s);this._raiseLoadCompleted(false,t)}.bind(this))}else{var o=sap.ui.vtm.createMeasureId(this,"Updating scene tree");jQuery.sap.measure.start(o,"",["sap.ui.vtm"]);this._vkGraphicsCore.updateSceneTreeAsync(this._vkScene,[this._rootContentResource]).then(function(i){jQuery.sap.measure.end(o);this._vkGraphicsCore.detachSceneLoadingFinished(s);e();this._raiseHierarchyChanged();this._raiseLoadCompleted(true,t)}.bind(this)).catch(function(e){jQuery.sap.measure.end(o);this._vkGraphicsCore.detachSceneLoadingFinished(s);if(e.contentResourcesWithEncryptedVds3){e.contentResourcesWithEncryptedVds3.forEach(function(e){var t=e.getSource();a(t)})}if(e.contentResourcesWithMissingPasswords){e.contentResourcesWithMissingPasswords.forEach(function(e){var t=e.getSource();a(t)})}this._raiseLoadCompleted(false,t)}.bind(this))}}.bind(this),50)}},_handleLoadContentResourcesAsyncProgress:function(e,t){var i=e.getParameter("source");var a=e.getParameter("loaded");var s=e.getParameter("total");var r=sap.ui.vtm.ArrayUtilities.find(t,function(e){return i===e.getSourceString()});sap.ui.vtm.measure(this,"fireDownloadProgress",function(){this.fireDownloadProgress({viewable:r,downloadedBytes:a,totalBytes:s})}.bind(this))},loadViewablesAsync:function(e){if(!e){throw"viewables not specified"}e=sap.ui.vtm.ArrayUtilities.wrap(e);if(!e.length){throw"viewables is empty"}e.forEach(function(e){var t=e.getSourceString();if(!this._viewablesBySource.has(t)){this._viewablesBySource.set(t,e)}var i=new sap.ui.vtm.ViewableLoadInfo({viewable:e,status:sap.ui.vtm.ViewableLoadStatus.Downloading});this._viewableLoadInfosByViewable.set(e,i)}.bind(this));this._raiseDownloadStarted(e);this._getGraphicsCore().then(function(){var t=e.map(function(e){return e.getSourceString()});var i=e.map(function(e){return e._getContentResource()});var a=sap.ui.vtm.createMeasureId(this,"Downloading "+t.join(", "));jQuery.sap.measure.start(a,"",["sap.ui.vtm"]);this._vkGraphicsCore.loadContentResourcesAsync(i,function(t){jQuery.sap.measure.end(a);t=t=t||[];this._handleLoadContentResourcesAsyncCompleted(t,e)}.bind(this),function(t){this._handleLoadContentResourcesAsyncProgress(t,e)}.bind(this))}.bind(this));return this},getDownloadedViewables:function(){var e=[];this._viewableLoadInfosByViewable.forEach(function(t,i){switch(t.getStatus()){case sap.ui.vtm.ViewableLoadStatus.Downloading:case sap.ui.vtm.ViewableLoadStatus.DownloadFailed:break;default:e.push(i);break}});return e},getLoadedViewables:function(){var e=[];this._viewableLoadInfosByViewable.forEach(function(t,i){if(t.getStatus()===sap.ui.vtm.ViewableLoadStatus.Loaded){e.push(i)}});return e},getViewableLoadInfos:function(){var e;this._viewableLoadInfosByViewable.forEach(function(t,i){e.push(t)});return e},getAncestorIds:function(e){if(this._vkNodeHierarchy){var t=this._vkNodeHierarchy.getAncestors(e);this.addCachedIds(t);return t}return[]},getParentId:function(e){var t=this.getAncestorIds(e);if(t&&t.length){return t[t.length-1]}return null},getChildIds:function(e){if(this._vkNodeHierarchy){var t=this._vkNodeHierarchy.getChildren(e,true);this.addCachedIds(t);return t}return[]},getDescendantIds:function(e){var t=[];sap.ui.vtm.measure(this,"getDescendantIds ("+e+")",function(){var i=function(e){var a=this.getChildIds(e);a.forEach(function(e){t.push(e);i(e)})}.bind(this);i(e)}.bind(this));this.addCachedIds(t);return t},getAllIds:function(){var e=this.getRootIds();var t=[];e.forEach(function(e){t.push(e);var i=this.getDescendantIds(e);t=t.concat(i)}.bind(this));this.setCachedIds(t);return t},getCachedIds:function(){if(!this._cachedIds||!this._cachedIds.length){this._cachedIds=this.getAllIds()}return this._cachedIds},setCachedIds:function(e){this._cachedIds=e;return this},addCachedIds:function(e){if(!this._cachedIds){this._cachedIds=[]}e=sap.ui.vtm.ArrayUtilities.wrap(e);e.forEach(function(e){if(this._cachedIds.indexOf(e)===-1){this._cachedIds.push(e)}}.bind(this));return this},removeCachedIds:function(e){if(this._cachedIds){e=sap.ui.vtm.ArrayUtilities.wrap(e);this._cachedIds=this._cachedIds.filter(function(t){return e.indexOf(t)===-1})}return this},createNode:function(e,t,i){var a=this._vkNodeHierarchy.createNode(e,i,t);this.addCachedIds(a);this._raiseHierarchyChanged();return a},cloneNode:function(e,t,i,a,s){var r=this._vkNodeHierarchy.createNodeCopy(e,t,a,i);s=s===undefined||s===null?true:s;this.addCachedIds(r);if(!s){var n=this.getChildIds(r);n.forEach(function(e){this.deleteNode(e)}.bind(this))}else{this.addCachedIds(this.getDescendantIds(r))}this._raiseHierarchyChanged();return r},deleteNode:function(e){this.removeCachedIds(e);this.removeCachedIds(this.getDescendantIds(e));this._vkNodeHierarchy.removeNode(e);this._raiseHierarchyChanged();return this},getVtm:function(){return this.getParent()}});return o});
//# sourceMappingURL=Scene.js.map