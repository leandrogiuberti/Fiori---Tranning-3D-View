/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Control","sap/ui/vk/dvl/Viewport","sap/m/OverflowToolbar","./ViewportHandler","sap/ui/vk/FlexibleControl","sap/ui/vk/FlexibleControlLayoutData"],function(jQuery,e,t,i,r,a,n){"use strict";var s=e.extend("sap.ui.vtm.Viewport",{metadata:{properties:{backgroundGradientTopColor:{type:"sap.ui.core.CSSColor",defaultValue:"black"},backgroundGradientBottomColor:{type:"sap.ui.core.CSSColor",defaultValue:"white"},overrideDisplayGroups:{type:"object[]",defaultValue:[]},contextDisplayGroups:{type:"object[]",defaultValue:[]}},aggregations:{_container:{type:"sap.m.VBox",multiple:false,visibility:"hidden"}},associations:{headerControls:{type:"sap.ui.core.Control",multiple:true}},events:{selectionChanged:{parameters:{selectedIds:{type:"string[]"},unselectedIds:{type:"string[]"},userInteraction:{type:"boolean"}}},nodeClicked:{sceneNode:{type:"sap.ui.vtm.SceneNode"}},visibilityChanged:{parameters:{visibleIds:{type:"string[]"},hiddenIds:{type:"string[]"},userInteraction:{type:"boolean"}}},viewChanged:{parameters:{cameraInfo:{type:"object"}}},refreshRequested:{},hover:{parameters:{x:{type:"float"},y:{type:"float"},nodeId:{type:"string"}}},beginGesture:{},endGesture:{}}},_getVkViewport:function(){return this.vkViewport},_getContainer:function(){return this.getAggregation("_container")},init:function(){this._programmaticSelectionChangeInProgress=false;this._programmaticVisibilityChangeInProgress=false},_initialize:function(e){this._setScene(e);var t=this._getVkViewport();var i=t._loco;if(t._viewportHandler){i.removeHandler(t._viewportHandler)}if(t._smart2DHandler){i.removeHandler(t._smart2DHandler)}var a=new r(this);i.addHandler(a)},renderer:function(e,t){e.write("<div");e.writeControlData(t);e.addStyle("height","inherit");e.addStyle("overflow","hidden");e.writeStyles();e.writeClasses();e.write(">");var i=t._getContainer();e.renderControl(i);e.write("</div>")},onBeforeRendering:function(){var e=this.getPanel().getVtm();if(e){var t=e.getScene();t.attachEvent("sceneCreated",function(){this._onSceneCreated(t)}.bind(this))}},getInitialized:function(){return this._initialized},refresh:function(){sap.ui.vtm.measure(this,"fireRefreshRequested",function(){this.fireRefreshRequested()}.bind(this));return this},_raiseHover:function(e,t,i){this.fireHover({x:e,y:t,nodeId:i})},_raiseBeginGesture:function(){this.fireBeginGesture()},_raiseEndGesture:function(){this.fireEndGesture()},setBackgroundGradientTopColor:function(e){this.setProperty("backgroundGradientTopColor",e);this._getVkViewport().setBackgroundColorTop(e);return this},setBackgroundGradientBottomColor:function(e){this.setProperty("backgroundGradientBottomColor",e);this._getVkViewport().setBackgroundColorBottom(e);return this},_getAncestor:function(e){var t=this.getParent();while(t&&t.getMetadata().getName()!==e){t=t.getParent()}return t},getPanel:function(){if(!this._panel){this._panel=this._getAncestor("sap.ui.vtm.Panel")}return this._panel},getScene:function(){return this._scene},_onSceneCreated:function(e){if(!this._initialized){this._initialized=true;this._initialize(e)}var t=e._vkScene;if(!this._vkScene&&t){var i=this._getVkViewport();this._vkScene=t;i.setScene(t);this._vkDefaultNodeHierarchy=t.getDefaultNodeHierarchy();if(this._vkDefaultNodeHierarchy&&this._vkGraphicsCore){this._vkViewStateManager=this._vkGraphicsCore.createViewStateManager(this._vkDefaultNodeHierarchy,true,true);if(this._vkViewStateManager){i.setViewStateManager(this._vkViewStateManager);this._vkViewStateManager.attachSelectionChanged(function(e){var t=e.getParameter("selected");var i=e.getParameter("unselected");sap.ui.vtm.measure(this,"fireSelectionChanged",function(){this.fireSelectionChanged({selectedIds:t,unselectedIds:i,userInteraction:!this._programmaticSelectionChangeInProgress})}.bind(this))}.bind(this));this._vkViewStateManager.attachVisibilityChanged(function(e){var t=e.getParameter("visible");var i=e.getParameter("hidden");sap.ui.vtm.measure(this,"fireVisibilityChanged",function(){this.fireVisibilityChanged({visibleIds:t,hiddenIds:i,userInteraction:!this._programmaticVisibilityChangeInProgress})}.bind(this))}.bind(this));var r=function(){sap.ui.vtm.measure(this,"fireViewChanged",function(){this.fireViewChanged({cameraInfo:this.getCameraInfo()})}.bind(this))}.bind(this);i.attachZoom(r);i.attachPan(r);i.attachRotate(r);i.attachNodeClicked(function(t){var i=t.getParameters().nodeId;sap.ui.vtm.measure(this,"fireNodeClicked",function(){var t=e._getSceneNode(i);try{this.fireNodeClicked({sceneNode:t})}finally{t.destroy()}}.bind(this))}.bind(this));i.attachFrameRenderingFinished(function(e){this.fireEvent("frameRenderingFinished",e)}.bind(this))}}}},getHeaderControls:function(){var e=this.getAssociation("headerControls");var t=[];if(e){e.forEach(function(e){var i=sap.ui.getCore().byId(e);if(i){t.push(i)}})}return t},_setScene:function(e){if(!e||this._scene){return this}var t=new sap.ui.vk.dvl.Viewport(this.getId()+"_sapUiVkViewport",{height:"100%"});this.vkViewport=t;this._scene=e;if(e){this._vkGraphicsCore=this._scene._vkGraphicsCore;if(this._vkGraphicsCore){t.setGraphicsCore(this._vkGraphicsCore);t.setBackgroundColorTop(this.getBackgroundGradientTopColor());t.setBackgroundColorBottom(this.getBackgroundGradientBottomColor())}}var i=this.getHeaderControls();i.forEach(function(e){if(e){e.setLayoutData(new sap.m.FlexItemData({growFactor:0,shrinkFactor:0}))}});t.setLayoutData(new sap.m.FlexItemData({growFactor:1,shrinkFactor:1,minHeight:"10px"}));var r=new sap.m.VBox({fitContainer:true,renderType:sap.ui.Device.browser.msie?sap.m.FlexRendertype.Div:sap.m.FlexRendertype.Bare,items:[i,t]});this.setAggregation("_container",r);return this},zoomToSelected:function(e){sap.ui.vtm.measure(this,"zoomToSelected",function(){if(e===null||e===undefined){e=.2}this._getVkViewport().zoomTo(sap.ui.vk.ZoomTo.Selected,null,e,0)}.bind(this));return this},zoomToVisible:function(e){sap.ui.vtm.measure(this,"zoomToVisible",function(){if(e===null||e===undefined){e=.2}this._getVkViewport().zoomTo(sap.ui.vk.ZoomTo.Visible,null,e,0)}.bind(this));return this},zoomToFit:function(e){var t=false;if(this._vkViewStateManager){this._vkViewStateManager.enumerateSelection(function(){t=true})}if(t){this.zoomToSelected(e)}else{this.zoomToVisible(e)}return this},zoomToAll:function(e){sap.ui.vtm.measure(this,"zoomToAll",function(){if(e===null||e===undefined){e=.2}this._getVkViewport().zoomTo(sap.ui.vk.ZoomTo.All,null,e,0)}.bind(this));return this},getVisibility:function(e){var t;sap.ui.vtm.measure(this,"getVisibility",function(){if(this._vkViewStateManager){t=this._vkViewStateManager.getVisibilityState(e)}}.bind(this));return t},setVisibility:function(e,t,i){if(jQuery.sap.debug()){var r={viewport:this.getId(),visibility:t,recursive:i,sceneNodeIds:e};jQuery.sap.log.warning("setVisibility "+JSON.stringify(r))}sap.ui.vtm.measure(this,"setVisibility",function(){if(Array.isArray(e)&&!e.length){return this}if(this._vkViewStateManager){try{this._programmaticVisibilityChangeInProgress=true;this._vkViewStateManager.setVisibilityState(e,t,i)}finally{this._programmaticVisibilityChangeInProgress=false}}}.bind(this));return this},getOpacity:function(e){var t;sap.ui.vtm.measure(this,"getOpacity",function(){if(this._vkViewStateManager){t=this._vkViewStateManager.getOpacity(e);this._scene.traverseNodes(e,function(i,r){if(Array.isArray(e)){if(t[r]==null){t[r]=i._vkNodeProxy.getOpacity()}}else if(t==null){t=i._vkNodeProxy.getOpacity()}})}}.bind(this));return t},setOpacity:function(e,t,i){if(jQuery.sap.debug()){var r={viewport:this.getId(),opacity:t,recursive:i,sceneNodeIds:e};jQuery.sap.log.warning("setOpacity "+JSON.stringify(r))}sap.ui.vtm.measure(this,"setOpacity",function(){if(Array.isArray(e)&&!e.length){return this}if(this._vkViewStateManager){this._vkViewStateManager.setOpacity(e,t,i)}}.bind(this));return this},getHighlightColor:function(e){var t;sap.ui.vtm.measure(this,"getHighlightColor",function(){if(this._vkViewStateManager){t=this._vkViewStateManager.getTintColor(e);this._scene.traverseNodes(e,function(i,r){if(Array.isArray(e)){if(t[r]==null){t[r]=i._vkNodeProxy.getTintColor()}}else if(t==null){t=i._vkNodeProxy.getTintColor()}})}}.bind(this));return t},setHighlightColor:function(e,t,i){if(jQuery.sap.debug()){var r={viewport:this.getId(),color:t,recursive:i,sceneNodeIds:e};jQuery.sap.log.warning("setHighlightColor "+JSON.stringify(r))}sap.ui.vtm.measure(this,"setHighlightColor",function(){if(Array.isArray(e)&&!e.length){return this}if(this._vkViewStateManager){this._vkViewStateManager.setTintColor(e,t,i)}}.bind(this));return this},getSelected:function(e){var t;sap.ui.vtm.measure(this,"getSelected",function(){if(this._vkViewStateManager){t=this._vkViewStateManager.getSelectionState(e)}}.bind(this));return t},setSelected:function(e,t,i){if(jQuery.sap.debug()){var r={viewport:this.getId(),selected:t,recursive:i,sceneNodeIds:e};jQuery.sap.log.warning("setSelected "+JSON.stringify(r))}sap.ui.vtm.measure(this,"setSelected",function(){if(Array.isArray(e)&&!e.length){return this}if(this._vkViewStateManager){try{this._programmaticSelectionChangeInProgress=true;this._vkViewStateManager.setSelectionState(e,t,i)}finally{this._programmaticSelectionChangeInProgress=false}}}.bind(this));return this},getSelectedIds:function(){var e=[];sap.ui.vtm.measure(this,"getSelectedIds",function(){if(this._vkViewStateManager){this._vkViewStateManager.enumerateSelection(function(t){e.push(t)})}}.bind(this));return e},setPredefinedView:function(e){var t;switch(e){case sap.ui.vtm.PredefinedView.Top:t=sap.ui.vk.ZoomTo.ViewTop;break;case sap.ui.vtm.PredefinedView.Bottom:t=sap.ui.vk.ZoomTo.ViewBottom;break;case sap.ui.vtm.PredefinedView.Front:t=sap.ui.vk.ZoomTo.ViewFront;break;case sap.ui.vtm.PredefinedView.Back:t=sap.ui.vk.ZoomTo.ViewBack;break;case sap.ui.vtm.PredefinedView.Left:t=sap.ui.vk.ZoomTo.ViewLeft;break;case sap.ui.vtm.PredefinedView.Right:t=sap.ui.vk.ZoomTo.ViewRight;break;default:throw"Unexpected view value: '"+e+"'."}this._getVkViewport().zoomTo(t,null,.2,0);return this},getCameraInfo:function(){var e=this._getVkViewport().getViewInfo({camera:{useTransitionCamera:true},animation:false});return e.camera},setCameraInfo:function(e,t){var i={camera:e,flyToDuration:t||0};this._getVkViewport().setViewInfo(i);return this},addOverrideDisplayGroup:function(e){var t=this.getOverrideDisplayGroups();t.push(e);this.setOverrideDisplayGroups(t);return this},addContextDisplayGroup:function(e){var t=this.getContextDisplayGroups();t.push(e);this.setContextDisplayGroups(t);return this}});return s});
//# sourceMappingURL=Viewport.js.map