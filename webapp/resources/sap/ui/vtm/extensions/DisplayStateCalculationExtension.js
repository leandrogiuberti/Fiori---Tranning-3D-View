/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Control","../Extension"],function(jQuery,t,i){"use strict";var e=i.extend("sap.ui.vtm.extensions.DisplayStateCalculationExtension",{metadata:{interfaces:["sap.ui.vtm.interfaces.IDisplayStateCalculationExtension"]},constructor:function(t,e){i.apply(this,arguments)},initialize:function(){this._handlingEvent=false;this._defaultVisibility=false;this._defaultOpacity=null;this._defaultHighlightColor=null;this.applyPanelHandler(function(t){var i=t.getViewport();i.attachRefreshRequested(function(i){if(!this.getEnabled()){return}this._updateDisplayStates(t)}.bind(this))}.bind(this))},_updateDisplayStates:function(t){var i=new sap.ui.vtm.Lookup,e=new sap.ui.vtm.Lookup,a=[],s=[];this._calculateDisplayStates(t,a,s,i,e);this._applyDisplayStates(t,a,s,i,e)},_applyContextUpdates:function(t,i){var e=t.getViewport();var a=e.getScene();var s=e.getContextDisplayGroups();s.reverse().forEach(function(t){var e=t.getDisplayStatesBySceneNodeId();if(e){var s=Object.getOwnPropertyNames(e);s.forEach(function(t){var s=e[t];var n=s.visibility;var l=s.opacity;var r=s.highlightColor;var o=s.recursive;var u=[t];if(o===true){Array.prototype.push.apply(u,a.getDescendantIds(t))}u.forEach(function(t){var e=i.get(t);if(n!==null&&n!==undefined){e.visibility=n}if(l!==null&&l!==undefined){e.opacity=l}if(r!==null&&r!==undefined){e.highlightColor=r===""?this._defaultHighlightColor:r}})})}})},_applyTreeItemUpdates:function(t,i){var e=t.getTree();var a=e.getAllItems();a.forEach(function(t){var e=t.visibility===true;if(e){var a=sap.ui.vtm.TreeItemUtilities.getSceneNodeIds(t);var s=t.opacity;var n=t.highlightColor;a.forEach(function(t){var a=i.get(t);a.visibility=e;a.opacity=s||this._defaultOpacity;a.highlightColor=n||this._defaultHighlightColor}.bind(this))}}.bind(this))},_applyOverrideUpdates:function(t,i){var e=t.getViewport();var a=e.getScene();var s=e.getOverrideDisplayGroups();s.reverse().forEach(function(t){var e=t.getDisplayStatesBySceneNodeId();if(e){var s=Object.getOwnPropertyNames(e);s.forEach(function(t){var s=e[t];var n=s.visibility;var l=s.opacity;var r=s.highlightColor;var o=s.recursive;var u=[t];if(o===true){Array.prototype.push.apply(u,a.getDescendantIds(t))}u.forEach(function(t){var e=i.get(t);if(n!==null&&n!==undefined){e.visibility=n}if(l!==null&&l!==undefined){e.opacity=l}if(r!==null&&r!==undefined){e.highlightColor=r===""?this._defaultHighlightColor:r}})})}})},_calculateDisplayStates:function(t,i,e,a,s){sap.ui.vtm.measure(this,"_calculateDisplayStates",function(){var n;var l=new Map;sap.ui.vtm.measure(this,"_calculateDisplayStates - Get all ids",function(){n=this._vtm.getScene().getCachedIds()}.bind(this));sap.ui.vtm.measure(this,"creating display states",function(){n.forEach(function(t){l.set(t,{visibility:this._defaultVisibility,opacity:this._defaultOpacity,highlightColor:this._defaultHighlightColor})}.bind(this))}.bind(this));sap.ui.vtm.measure(this,"_applyContextUpdates ("+t.getId()+")",function(){this._applyContextUpdates(t,l)}.bind(this));sap.ui.vtm.measure(this,"_applyTreeItemUpdates ("+t.getId()+")",function(){this._applyTreeItemUpdates(t,l)}.bind(this));sap.ui.vtm.measure(this,"_applyOverrideUpdates ("+t.getId()+")",function(){this._applyOverrideUpdates(t,l)}.bind(this));sap.ui.vtm.measure(this,"_calculateDisplayStates - Populating lookups",function(){l.forEach(function(t,n){if(t.visibility){e.push(n);a.addValue(t.opacity,n);s.addValue(t.highlightColor,n)}else{i.push(n)}})})}.bind(this))},_applyDisplayStates:function(t,i,e,a,s){sap.ui.vtm.measure(this,"_applyDisplayStates",function(){var n=t.getViewport();n.setVisibility(i,false,false);if(e.length){n.setVisibility(e,true,false);a.forEach(function(t,i){n.setOpacity(t,i,false)});s.forEach(function(t,i){n.setHighlightColor(t,i,false)})}})}});return e});
//# sourceMappingURL=DisplayStateCalculationExtension.js.map