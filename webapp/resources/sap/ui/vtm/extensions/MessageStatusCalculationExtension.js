/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Control","../Extension"],function(jQuery,e,t){"use strict";var s={Error:"Error",ErrorOnDescendant:"ErrorOnDescendant",Warning:"Warning",WarningOnDescendant:"WarningOnDescendant",Information:"Information",None:"None"};var a=t.extend("sap.ui.vtm.extensions.MessageStatusCalculationExtension",{metadata:{interfaces:["sap.ui.vtm.interfaces.IMessageStatusCalculationExtension"]},constructor:function(e,s){t.apply(this,arguments)},initialize:function(){this._rb=sap.ui.vtm.getResourceBundle();this.applyPanelHandler(function(e){var t=e.getTree();t.attachBeforeModelUpdated(function(t){this._handleBeforeModelUpdated(e)}.bind(this));this._handleBeforeModelUpdated(e)}.bind(this))},_getMessageStatusPriority:function(e){switch(e){case s.Error:return 1;case s.ErrorOnDescendant:return 2;case s.Warning:return 3;case s.WarningOnDescendant:return 4;case s.Information:return 5;case s.None:return 6;default:throw"Unknown message status: '"+e+"'"}},_makeCascadedMessageStatus:function(e){switch(e){case s.Error:case s.ErrorOnDescendant:return s.ErrorOnDescendant;case s.Warning:case s.WarningOnDescendant:return s.WarningOnDescendant;case s.Information:case s.None:return s.None;default:throw"Unknown message status: '"+e+"'"}},_messageStatusCompareFunction:function(e,t){return this._getMessageStatusPriority(e)-this._getMessageStatusPriority(t)},_calculateHighestPriorityMessageStatus:function(e){var t=e.messages;if(t){var s=sap.ui.vtm.TreeItemUtilities.getMessages(e);s.sort(sap.ui.core.Message.compareByType).reverse();return s[0].getLevel()}else{return sap.ui.core.MessageType.None}},_calculateHighestPriorityChildMessageStatus:function(e){var t=sap.ui.vtm.TreeItemUtilities.getIncludedChildren(e);if(t.length){var s=t.filter(function(e){return e.messageStatus});if(s.length){s.sort(function(e,t){return this._getMessageStatusPriority(e.messageStatus)-this._getMessageStatusPriority(t.messageStatus)}.bind(this));return s[0].messageStatus}}return sap.ui.core.MessageType.None},_calculateMessageStatus:function(e){var t=this._calculateHighestPriorityMessageStatus(e);var s=this._calculateHighestPriorityChildMessageStatus(e);if(this._messageStatusCompareFunction(t,s)>0){if(s===sap.ui.core.MessageType.None){if(e.messageStatus){delete e.messageStatus}}else{e.messageStatus=this._makeCascadedMessageStatus(s)}}else if(t===sap.ui.core.MessageType.None){if(e.messageStatus){delete e.messageStatus}}else{e.messageStatus=t}if(s===sap.ui.core.MessageType.None){if(e.childMessageStatus){delete e.childMessageStatus}else{e.childMessageStatus=s}}},_getIconSource:function(e){switch(e){case s.Error:return"sap-icon://error";case s.ErrorOnDescendant:return"sap-icon://message-error";case s.Warning:return"sap-icon://alert";case s.WarningOnDescendant:return"sap-icon://message-warning";case s.Information:return"sap-icon://message-information";case s.None:return null;default:throw"Unknown message type: '"+e+"'"}},_getStatusTooltip:function(e){switch(e){case s.Error:return this._rb.getText("MESSAGESTATUS_ERROR");case s.ErrorOnDescendant:return this._rb.getText("MESSAGESTATUS_ERRORONDESCENDANT");case s.Warning:return this._rb.getText("MESSAGESTATUS_WARNING");case s.WarningOnDescendant:return this._rb.getText("MESSAGESTATUS_WARNINGONDESCENDANT");case s.Information:return this._rb.getText("MESSAGESTATUS_INFORMATION");case s.None:return null;default:throw"Unknown message type: '"+e+"'"}},_getMessagesToShowTootip:function(e){if(e.messages){return this._rb.getText("MESSAGESTATUS_CLICKTOSHOWMESSAGES")}else{return this._rb.getText("MESSAGESTATUS_NOMESSAGESONTHISITEM")}},_getIconColor:function(e){switch(e){case s.Error:case s.ErrorOnDescendant:return sap.ui.core.IconColor.Negative;case s.Warning:case s.WarningOnDescendant:return sap.ui.core.IconColor.Critical;case s.Information:return sap.ui.core.IconColor.Neutral;case s.None:return null;default:throw"Unknown message type: '"+e+"'"}},_calculateMessageStatusForTree:function(e){var t=this._calculateMessageStatus.bind(this);var s=function(e,t){var a=sap.ui.vtm.TreeItemUtilities.getChildren(e);a.forEach(function(e){s(e,t)});if(t){t(e)}};e.getRootItems().forEach(function(e){s(e,t)});var a=false;sap.ui.vtm.TreeItemUtilities.traverseTree(e.getRootItems(),function(e){if(e.messageStatus){var t=this._getIconSource(e.messageStatus);if(e.messageStatusIconUrl!==t){e.messageStatusIconUrl=t;a=true}var s=this._getIconColor(e.messageStatus);if(e.messageStatusIconColor!==s){e.messageStatusIconColor=s;a=true}var n=this._getMessagesToShowTootip(e);var r=this._getStatusTooltip(e.messageStatus);var i=r?r+"\n"+n:n;if(e.messageStatusIconTooltip!=i){e.messageStatusIconTooltip=i;a=true}}else if(e.messageStatusIconUrl||e.messageStatusIconColor||e.messageStatusIconTooltip){delete e.messageStatusIconUrl;delete e.messageStatusIconColor;delete e.messageStatusIconTooltip;a=true}delete e.messageStatus;delete e.childMessageStatus}.bind(this));if(a){e._updateBindings()}},_handleBeforeModelUpdated:function(e){if(!this.getEnabled()){return}var t=e.getTree();this._calculateMessageStatusForTree(t)}});return a});
//# sourceMappingURL=MessageStatusCalculationExtension.js.map