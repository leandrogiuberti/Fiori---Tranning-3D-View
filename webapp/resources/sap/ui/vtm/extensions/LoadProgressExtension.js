/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../Extension"],function(jQuery,e){"use strict";var t=e.extend("sap.ui.vtm.extensions.LoadProgressExtension",{metadata:{interfaces:["sap.ui.vtm.interfaces.IDownloadProgressExtension","sap.ui.vtm.interfaces.ILoadProgressExtension"]},constructor:function(t,o){e.apply(this,arguments)},initialize:function(e){this._scene=e.getScene();this._rb=sap.ui.vtm.getResourceBundle();this._oDialog=new sap.ui.vtm.ProgressDialog({progressBarVisible:false});this._downloadInfoByViewable=new Map;this._loadInfoByViewable=new Map;this._boundDownloadStartedHandler=this._downloadStartedHandler.bind(this);this._boundDownloadProgressHandler=this._downloadProgressHandler.bind(this);this._boundDownloadCompletedHandler=this._downloadCompletedHandler.bind(this);this._boundLoadStartedHandler=this._loadStartedHandler.bind(this);this._boundLoadProgressHandler=this._loadProgressHandler.bind(this);this._boundLoadCompletedHandler=this._loadCompletedHandler.bind(this);this._scene.attachDownloadStarted(this._boundDownloadStartedHandler)},_setDownloadPercentComplete:function(e){if(this._oDialog.getPercentComplete()!==e){this._oDialog.setPercentComplete(e);this._oDialog.setProgressText(this._rb.getText("PROGRESS_DOWNLOADING_0",[e]));sap.ui.getCore().applyChanges()}},_downloadProgressHandler:function(e){if(!this.getEnabled()){return}var t=e.getParameter("viewable");var o=e.getParameter("downloadedBytes");var a=e.getParameter("totalBytes");this._downloadInfoByViewable.set(t,{downloadedBytes:o,totalBytes:a});var n=0,s=0;this._downloadInfoByViewable.forEach(function(e){n+=e.downloadedBytes;s+=e.totalBytes});var d=s==0?0:Math.floor(n/s*100);this._setDownloadPercentComplete(d)},_downloadStartedHandler:function(e){if(!this.getEnabled()){return}this._openDialog()},_setLoadPercentComplete:function(e){if(this._oDialog.getPercentComplete()!==e){this._oDialog.setPercentComplete(e);this._oDialog.setProgressText(this._rb.getText("PROGRESS_LOADING_0",[e]));sap.ui.getCore().applyChanges()}},_loadProgressHandler:function(e){if(!this.getEnabled()){return}var t=e.getParameter("viewable");var o=e.getParameter("percentage");this._loadInfoByViewable.set(t,{percentComplete:o});var a=0;var n=0;this._loadInfoByViewable.forEach(function(e){a+=e.percentComplete;n++});var s=n==0?0:Math.floor(a/n);this._setLoadPercentComplete(s)},_downloadCompletedHandler:function(e){this._downloadInfoByViewable.clear();var t=e.getParameter("viewableLoadInfos");var o=t.every(function(e){return e.getStatus()===sap.ui.vtm.ViewableLoadStatus.DownloadFailed});if(o){this._closeDialog()}},_loadStartedHandler:function(e){this._oDialog.setProgressText(this._rb.getText("PROGRESS_LOADING"));sap.ui.getCore().applyChanges()},_loadCompletedHandler:function(e){this._loadInfoByViewable.clear();this._closeDialog()},_openDialog:function(){if(!this._oDialog.isOpen()){this._scene.attachDownloadProgress(this._boundDownloadProgressHandler);this._scene.attachDownloadCompleted(this._boundDownloadCompletedHandler);this._scene.attachLoadStarted(this._boundLoadStartedHandler);this._scene.attachLoadProgress(this._boundLoadProgressHandler);this._scene.attachLoadCompleted(this._boundLoadCompletedHandler);this._oDialog.open();this._setDownloadPercentComplete(0)}},_closeDialog:function(){this._scene.detachDownloadProgress(this._boundDownloadProgressHandler);this._scene.detachDownloadCompleted(this._boundDownloadCompletedHandler);this._scene.detachLoadStarted(this._boundLoadStartedHandler);this._scene.detachLoadProgress(this._boundLoadProgressHandler);this._scene.detachLoadCompleted(this._boundLoadCompletedHandler);this._oDialog.close()}});return t});
//# sourceMappingURL=LoadProgressExtension.js.map