/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../../TableDelegate","../../table/ODataV4PropertyHelper","sap/ui/mdc/enums/TableP13nMode","sap/ui/mdc/enums/TableType","sap/ui/mdc/enums/TableSelectionMode","sap/ui/mdc/odata/v4/TypeMap","sap/ui/mdc/util/loadModules","sap/m/plugins/PluginBase","sap/ui/core/Lib","sap/ui/core/format/ListFormat","sap/ui/core/message/MessageType"],(e,t,n,o,r,i,a,s,l,g,u)=>{"use strict";const p=Object.assign({},e);p.getTypeMap=function(e){return i};p.getPropertyHelperClass=function(){return t};p.updateBindingInfo=function(t,n){const o=t.getRowBinding()?.getAggregation();e.updateBindingInfo.apply(this,arguments);if("expandTo"in(o??{})){n.parameters.$$aggregation={expandTo:o.expandTo}}if(!E(t)){const e=b(t);if(e.length>0){const o=t.getPropertyHelper();n.parameters.$select=e.map(e=>o.getProperty(e).path)}}};p.getGroupSorter=function(t){const n=t._getGroupedProperties()[0];if(!n||!t._isOfType(o.ResponsiveTable)){return undefined}if(!P(t).includes(n.name)){return undefined}return e.getGroupSorter.apply(this,arguments)};p.getSorters=function(t){let n=e.getSorters.apply(this,arguments);if(E(t)){const e=t.getPropertyHelper();const o=P(t).map(t=>e.getProperty(t).path);n=n.filter(e=>o.includes(e.sPath))}return n};p.updateBinding=function(e,t,n,o){if(E(e)){h(e,t)}else{const t=e.getModel("$sap.ui.mdc.Table");t.setProperty("/@custom/hasDataAggregation",false);t.setProperty("/@custom/hasGrandTotal",false)}if(!n||n.getPath()!==t.path){this.rebind(e,t);return}const r=n.getRootBinding();let i=r&&!r.isSuspended();try{if(i){r.suspend()}n.setAggregation(t.parameters?.$$aggregation);n.changeParameters((()=>{const e={...t.parameters};delete e.$$aggregation;return e})());n.filter(t.filters,"Application");n.sort(t.sorter);if(o&&o.forceRefresh){n.refresh()}}catch(o){this.rebind(e,t);if(r===n){i=false}}finally{if(i&&r.isSuspended()){r.resume()}}};p.fetchExpandAndCollapseConfiguration=function(e){if(!e._isOfType(o.TreeTable)){return Promise.resolve({})}return Promise.resolve({expandAll:function(e){c(e,Number.MAX_SAFE_INTEGER)},collapseAll:function(e){c(e,1)},expandAllFromNode:function(e,t){t.expand(Number.MAX_SAFE_INTEGER)},collapseAllFromNode:function(e,t){t.collapse(true)},isNodeExpanded:function(e,t){return t.getProperty("@$ui5.node.isExpanded")}})};function c(e,t){const n=e.getRowBinding();if(!n){return}const o=n.getAggregation()?.expandTo===t;if(o){n.refresh()}else{n.setAggregation({...n.getAggregation(),...{expandTo:t}})}}p.getInResultPropertyKeys=function(e){return[]};p.getSupportedFeatures=function(t){const r=e.getSupportedFeatures.apply(this,arguments);if(t._isOfType(o.Table)){const e=r.p13nModes;if(!e.includes(n.Group)){e.push(n.Group)}if(!e.includes(n.Aggregate)){e.push(n.Aggregate)}}return{...r}};p.validateState=function(t,n,o){const r=e.validateState.apply(this,arguments);let i;if(o==="Sort"){i=f(t,n)}else if(o==="Group"){i=d(t,n)}else if(o==="Column"){i=y(t,n)}return R(r,i)};function f(e,t){if(E(e)&&I(e,t.items,t.sorters)){return{validation:u.Information,message:l.getResourceBundleFor("sap.ui.mdc").getText("table.PERSONALIZATION_DIALOG_SORT_RESTRICTION")}}return null}function d(e,t){const n=l.getResourceBundleFor("sap.ui.mdc");if(t.aggregations){const o=Object.keys(t.aggregations);const r=[];const i=g.getInstance();o.forEach(t=>{const n=e.getPropertyHelper().getProperty(t);if(n&&n.groupable){r.push(t)}});if(r.length>0){return{validation:u.Information,message:n.getText("table.PERSONALIZATION_DIALOG_GROUP_RESTRICTION_TOTALS",[i.format(r)])}}}else if(e._isOfType(o.ResponsiveTable)){if(I(e,t.items,t.groupLevels)){return{validation:u.Information,message:n.getText("table.PERSONALIZATION_DIALOG_GROUP_RESTRICTION_VISIBLE")}}}return null}function y(e,t){const n=l.getResourceBundleFor("sap.ui.mdc");const r=t.aggregations&&Object.keys(t.aggregations);let i;if(e._isOfType(o.ResponsiveTable)){if(I(e,t.items,t.groupLevels)){return{validation:u.Information,message:n.getText("table.PERSONALIZATION_DIALOG_GROUP_RESTRICTION_VISIBLE")}}}if(I(e,t.items,r)){i=n.getText("table.PERSONALIZATION_DIALOG_TOTAL_RESTRICTION")}if(E(e)&&I(e,t.items,t.sorters)){const e=n.getText("table.PERSONALIZATION_DIALOG_SORT_RESTRICTION");i=i?i+"\n"+e:e}if(i){return{validation:u.Information,message:i}}return null}p.preInit=function(){return Promise.resolve()};p.initializeContent=async function(t){await e.initializeContent.apply(this,arguments);if(t._isOfType(o.Table)){await m(t)}};async function m(e){const[t]=await a("sap/ui/table/plugins/ODataV4Aggregation");e._oTable.addDependent(new t({enabled:"{= !!${$sap.ui.mdc.Table>/@custom/hasDataAggregation} }",groupHeaderFormatter:function(t){const n=e._getGroupedProperties().map(e=>e.name);const o=n[t.getProperty("@$ui5.node.level")-1];return e.getControlDelegate().formatGroupHeader(e,t,o)}}))}p.initializeSelection=function(t){if(t._isOfType(o.Table,true)){return T(t)}else{return e.initializeSelection.apply(this,arguments)}};function T(e){return a(["sap/ui/table/plugins/ODataV4MultiSelection","sap/ui/table/plugins/ODataV4SingleSelection"]).then(t=>{const[n,i]=t;function a(t){if(!e._isOfType(o.Table,true)){return}const a=e.getSelectionMode();let l;if(t&&e.getSelectedContexts().length>0){e.clearSelection();e.fireSelectionChange()}s.getPlugin(e._oTable,"sap.ui.table.plugins.ODataV4Selection")?.destroy();if(a===r.Multi){l=new n({limit:"{$sap.ui.mdc.Table#type>/selectionLimit}",enableNotification:true,hideHeaderSelector:"{= !${$sap.ui.mdc.Table#type>/showHeaderSelector} }",selectionChange:()=>e._onSelectionChange({selectAll:undefined})})}else if(a===r.Single||a===r.SingleMaster){l=new i({selectionChange:()=>e._onSelectionChange({selectAll:undefined})})}e._oTable.addDependent(l)}a();if(!e._oSelectionModeBinding){e._oSelectionModeBinding=e.getModel("$sap.ui.mdc.Table").bindProperty("/selectionMode");e._oSelectionModeBinding.attachChange(a)}})}p.setSelectedContexts=function(t,n){if(t._isOfType(o.Table,true)){const e=t.getSelectionMode();if(e===r.None||(e===r.Single||e===r.SingleMaster)&&n.length>1){throw Error("Unsupported operation: Cannot select the given number of contexts in the current selection mode")}t.clearSelection();for(const e of n){e.setSelected(true)}}else{e.setSelectedContexts.apply(this,arguments)}};p.getSelectedContexts=function(t){if(t._isOfType(o.Table,true)){return s.getPlugin(t._oTable,"sap.ui.table.plugins.ODataV4Selection")?.getSelectedContexts()??[]}return e.getSelectedContexts.apply(this,arguments)};function h(e,t){const n=x(e);const o=t.parameters.$search;if(n&&o){delete t.parameters.$search;n.search=o}t.parameters.$$aggregation=n;e.getModel("$sap.ui.mdc.Table").setProperty("/@custom/hasDataAggregation",!!n);const r=Object.keys(n?.aggregate||{}).some(e=>n.aggregate[e].grandTotal);e.getModel("$sap.ui.mdc.Table").setProperty("/@custom/hasGrandTotal",r);const i=s.getPlugin(e._oTable,"sap.ui.table.plugins.ODataV4Aggregation");i?.declareColumnsHavingTotals(S(e).map(e=>e.getInnerColumn()))}function P(e){return O(e,e.getColumns())}function b(e){return O(e,e.getControlDelegate().getInResultPropertyKeys(e))}function S(e){const t=Object.keys(e._getAggregatedProperties());const n=new Set;for(const o of e.getColumns()){const r=A(e,o).filter(e=>t.includes(e.key));const i=r.length>0;if(i){n.add(o);_(e,r).forEach(e=>{n.add(e)})}}return Array.from(n)}function O(e,t){const n=e.getPropertyHelper();const o=typeof t[0]==="object"?t.map(e=>e.getPropertyKey()):t;return Array.from(new Set(o.flatMap(e=>n.getProperty(e)?.getSimpleProperties().map(e=>e.key)||[])))}function A(e,t){const n=e.getPropertyHelper().getProperty(t.getPropertyKey());if(!n){return[]}else{return n.getSimpleProperties()}}function _(e,t){const n=[];t.forEach(e=>{if(e.unit){n.push(e.unit)}});return e.getColumns().filter(t=>A(e,t).some(e=>n.includes(e.key)))}function I(e,t,n){const o=[];if(t){t.forEach(t=>{e.getPropertyHelper().getProperty(t.name).getSimpleProperties().forEach(e=>{o.push(e.key)})})}const r=n?n.every(e=>o.find(t=>e.name?e.name===t:e===t)):true;return!r}function R(e,t){const n={Error:1,Warning:2,Information:3,None:4};if(!t||n[t.validation]-n[e.validation]>0){return e}else{return t}}function E(e){return e._isOfType(o.Table)&&(e._getGroupedProperties().length>0||e.isGroupingEnabled()||Object.keys(e._getAggregatedProperties()).length>0||e.isAggregationEnabled())}function x(e){const t=P(e);if(t.length===0){return undefined}const n={leafLevel:false,...e.getPayload()?.aggregationConfiguration};const o=e.getPropertyHelper();const r=e._getGroupedProperties().map(e=>e.name);const i=Object.keys(e._getAggregatedProperties());const a={group:{},groupLevels:[],aggregate:{},grandTotalAtBottomOnly:true,subtotalsAtBottomOnly:true};if(!n.leafLevel){C(a,e)}N(a,e);r.forEach(e=>{if(t.indexOf(e)<0){t.push(e)}});for(const n of t){const t=o.getProperty(n);if(t.extension.technicallyGroupable){v(a,e,t)}if(t.extension.technicallyAggregatable){G(a,e,t,{withTotals:i.includes(t.key)})}}r.forEach(e=>{const t=o.getProperty(e);if(t){a.groupLevels.push(t.path)}});if(!Object.keys(a.group).length&&!Object.keys(a.aggregate).length){return undefined}L(a);return a}function C(e,t){t.getPropertyHelper().getProperties().forEach(t=>{if(t.isKey){e.group[t.path]={}}})}function N(e,t){const n=t.getPropertyHelper();for(const o of b(t)){const t=n.getProperty(o);if(t.extension.technicallyGroupable){e.group[t.path]={}}else if(t.extension.technicallyAggregatable){e.aggregate[t.path]={}}}}function v(e,t,n){const o=t.getPropertyHelper();const r={};if(n.extension.additionalProperties.length===1){const r=o.getProperty(n.extension.additionalProperties[0]);if(r.text===n.key){v(e,t,r);return}}e.group[n.path]=r;const i=o.getProperty(n.text);if(i){r.additionally=[i.path]}const a=o.getProperty(n.unit);if(a){e.group[a.path]??={}}for(const t of n.extension.additionalProperties){const n=o.getProperty(t);e.group[n.path]??={}}}function G(e,t,n,o){const r=t.getPropertyHelper();const i={};e.aggregate[n.path]=i;if(o?.withTotals){i.grandTotal=true;i.subtotals=true}const a=r.getProperty(n.unit);if(a){i.unit=a.path}for(const t of n.extension.additionalProperties){const n=r.getProperty(t);e.group[n.path]??={}}}function L(e){M(e);$(e)}function M(e){for(const t in e.group){if(t in e.aggregate){if(e.aggregate[t].grandTotal||e.aggregate[t].subtotals){delete e.group[t]}else{delete e.aggregate[t]}}}}function $(e){const t=new Set;for(const n in e.group){e.group[n].additionally?.forEach(e=>t.add(e))}for(const n of t){if(n in e.group){delete e.group[n]}}}return p});
//# sourceMappingURL=TableDelegate.js.map