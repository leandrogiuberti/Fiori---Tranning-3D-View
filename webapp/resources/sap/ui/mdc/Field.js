/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/field/FieldBase","sap/ui/mdc/field/FieldBaseRenderer","sap/ui/mdc/enums/FieldDisplay","sap/ui/mdc/enums/BaseType","sap/ui/mdc/enums/OperatorName","sap/ui/mdc/condition/Condition","sap/base/Log","sap/base/util/deepEqual","sap/base/util/merge","sap/ui/model/BindingMode","sap/ui/model/Context","sap/ui/core/library","sap/ui/core/Element","sap/ui/core/LabelEnablement"],(t,e,i,n,a,s,o,l,r,p,d,g,h,u)=>{"use strict";const{ValueState:y}=g;const c=t.extend("sap.ui.mdc.Field",{metadata:{library:"sap.ui.mdc",designtime:"sap/ui/mdc/designtime/field/Field.designtime",properties:{value:{type:"any",defaultValue:null,bindable:"bindable"},additionalValue:{type:"any",defaultValue:null,bindable:"bindable"}},events:{change:{parameters:{value:{type:"string"},valid:{type:"boolean"},promise:{type:"Promise"}}}},defaultProperty:"value"},renderer:e});c.prototype.init=function(){this._vValue=null;this._vAdditionalValue=null;t.prototype.init.apply(this,arguments);this.setMaxConditions(1);this.setProperty("_operators",[a.EQ],true);this._oObserver.observe(this,{properties:["value","additionalValue","valueState"]})};c.prototype.exit=function(){t.prototype.exit.apply(this,arguments);if(this._iConditionUpdateTimer){clearTimeout(this._iConditionUpdateTimer);delete this._iConditionUpdateTimer;delete this._bPendingConditionUpdate}this._oBindingContext=undefined};c.prototype.bindProperty=function(e,i){let n;let a;let s=0;const o=typeof i.type==="string"?i.type:i.type?.getMetadata().getName();const r=typeof i.type==="string"?i.formatOptions:i.type?.getFormatOptions();const p=typeof i.type==="string"?i.constraints:i.type?.getConstraints();if(e==="value"&&!i.formatter){i.targetType="raw";n=this.getContentFactory().getDataType();if(i.type&&(!n||n.getMetadata().getName()!==o||!l(n.getFormatOptions(),r)||!l(n.getConstraints(),p)||n._bCreatedByOperator!==i.type._bCreatedByOperator)){if(typeof i.type==="string"){this.setDataType(o);this.setDataTypeFormatOptions(r);this.setDataTypeConstraints(p)}else{this.getContentFactory().setDataType(i.type)}this.getContentFactory().setDateOriginalType(undefined);this.getContentFactory().setUnitOriginalType(undefined);this.getContentFactory().setIsMeasure(false);if(i.parts&&i.type.isA("sap.ui.model.CompositeType")){a=[];for(s=0;s<i.parts.length;s++){a.push(i.parts[s].type)}this.getContentFactory().setCompositeTypes(a)}this.getContentFactory().updateConditionType();this.invalidate()}}else if(e==="additionalValue"&&!i.formatter){i.targetType="raw";n=this.getContentFactory().getAdditionalDataType();if(i.type&&(!n||n.getMetadata().getName()!==o||!l(n.getFormatOptions(),r)||!l(n.getConstraints(),p)||n._bCreatedByOperator!==i.type._bCreatedByOperator)){if(typeof i.type!=="string"){this.getContentFactory().setAdditionalDataType(i.type)}if(i.parts&&i.type.isA("sap.ui.model.CompositeType")){a=[];for(s=0;s<i.parts.length;s++){a.push(i.parts[s].type)}this.getContentFactory().setAdditionalCompositeTypes(a)}this.getContentFactory().updateConditionType();this.invalidate()}}t.prototype.bindProperty.apply(this,arguments)};c.prototype.handleModelContextChange=function(e){t.prototype.handleModelContextChange.apply(this,arguments);const i=this.getBinding("value");if(i){const t=i.isA("sap.ui.model.CompositeBinding")?i.getBindings()[0].getContext():i.getContext();if(d.hasChanged(this._oBindingContext,t)){this._oBindingContext=t;this.getContentFactory().updateConditionType();if(this.isInvalidInput()||this._getValueHelp()){if(this._oManagedObjectModel){this._oManagedObjectModel.checkUpdate(true,true)}this.resetInvalidInput()}}if(!this.getContentFactory().getDataType()){this.getContentFactory().setDataType(i.getType());this.invalidate()}}};c.prototype.initDataType=function(){t.prototype.initDataType.apply(this,arguments);const e=this.getBinding("value");if(e){this.getContentFactory().setDataType(e.getType())}};c.prototype.setProperty=function(e,i,n){if(e==="value"&&this.isInvalidInput()&&l(this.getValue(),this.validateProperty(e,i))){if(this._oManagedObjectModel){this._oManagedObjectModel.checkUpdate(true,true)}this.resetInvalidInput()}return t.prototype.setProperty.apply(this,arguments)};c.prototype.setMaxConditions=function(t){if(t!==1){throw new Error("Only one condition allowed for Field "+this)}return this.setProperty("maxConditions",t,true)};c.prototype.observeChanges=function(e){t.prototype.observeChanges.apply(this,arguments);if(e.name==="value"){const t=v.call(this,e.current,e.old);if(this._vAdditionalValue!==null&&D.call(this)&&!b.call(this,t,this._vValue,true)){this._vAdditionalValue=this.getAdditionalValue()}this._vValue=t;_.call(this,e.current);T.call(this)}if(e.name==="additionalValue"){this._vAdditionalValue=e.current;T.call(this)}if(e.name==="valueState"){if(this._bPendingConditionUpdate){this._bKeepValueState=true}}if(e.name==="conditions"){if(this.getCurrentContent().length<=1){M.call(this,e.current)}}};function f(){return this._vValue}function C(){return this._vAdditionalValue}function T(){if(!this.bDelegateInitialized){this.awaitControlDelegate().then(()=>{if(!this.isFieldDestroyed()){T.call(this)}});this._bPendingConditionUpdate=true;return}if(this.getDisplay()===i.Value){m.call(this,f.call(this),C.call(this))}else if(!this._iConditionUpdateTimer){this._iConditionUpdateTimer=setTimeout(()=>{m.call(this,f.call(this),C.call(this));this._iConditionUpdateTimer=undefined},0);this._bPendingConditionUpdate=true}}function m(t,e){const i=this.getConditions();if(I.call(this,t,e)){if(i.length>0){this.setConditions([])}}else{const n=i[0];const o=n&&n.values[0];const l=n&&n.values[1]?n.values[1]:null;if(!n||n.operator!==a.EQ||!b.call(this,o,t)||!F.call(this,e,l)){const i=this.getControlDelegate();const a=i.createCondition(this,this,[t,e],n);if(!s.compareConditions(n,a)){this.setConditions(a?[a]:[])}}}this._bPendingConditionUpdate=false;this._bKeepValueState=false}function v(t,e){const i=this.getContentFactory().getDataType()?this.getContentFactory().getDataType().getMetadata().getName():this.getDataType();if(t&&e&&(i==="sap.ui.model.odata.type.Unit"||i==="sap.ui.model.odata.type.Currency")&&!t[2]&&e[2]!==undefined){t=r([],t);t[2]=e[2];if(this._bPendingChange){const i=this.getConditions()[0];if(i){if(t[0]===e[0]&&t[0]!==i.values[0][0]){t[0]=i.values[0][0]}if(t[1]===e[1]&&t[1]!==i.values[0][1]){t[1]=i.values[0][1]}}}}return t}function b(t,e,i){let a=t===e;const s=this.getContentFactory().getDataType()?this.getContentFactory().getDataType().getMetadata().getName():this.getDataType();if(!a&&this.getTypeMap().getBaseType(s)===n.Unit&&Array.isArray(t)&&Array.isArray(e)){const n=t[0];const s=t[1];const o=t.length>=3?t[2]:null;const r=e[0];const p=e[1];const d=e.length>=3?e[2]:null;if(n===r&&s===p&&((this._bUnitSet||i)&&(!o||!d)||l(o,d))){a=true}if((o||d)&&!i){this._bUnitSet=true}}return a}function F(t,e,i){let n=t===e;if(!n&&(t===null||t===undefined||t==="")&&(e===null||e===undefined||e==="")){n=true}return n}function _(t){if(!this._oTypeInitialization){if(!this.bDelegateInitialized){this.awaitControlDelegate().then(()=>{if(!this.isFieldDestroyed()){_.call(this,t)}});return}const e=this.getBinding("value");const i=e?e.getType():this.getContentFactory().getDataType();if(i){this._oTypeInitialization=this.getTypeMap().initializeTypeFromValue(i,t);if(this._oTypeInitialization&&this.getContentFactory().getUnitOriginalType()){this.getTypeMap().initializeInternalType(this.getContentFactory().getDataType(),this._oTypeInitialization);this.getTypeMap().initializeInternalType(this.getContentFactory().getUnitType(),this._oTypeInitialization)}}}}c.prototype.fireChangeEvent=function(t,e,i,n){let a;if(t){if(e){a=this.getResultForChangePromise(t)}else{a=i}}if(this.getCurrentContent().length>1){if(t){M.call(this,this.getConditions())}else if(n){n=n.then(t=>{M.call(this,this.getConditions());return t})}}this.fireChange({value:a,valid:e,promise:n})};c.prototype.getResultForChangePromise=function(t){let e;if(t.length===0&&this.getContentFactory().getDataType()){e=this.getContentFactory().getDataType().parseValue("","string",[])}else if(t.length===1){e=t[0].values[0]}return e};function M(t){if(!this.bDelegateInitialized){this.awaitControlDelegate().then(()=>{if(!this.isFieldDestroyed()){M.call(this,t)}});return}let e=null;let i=null;const n=this.getValue();const a=this.getAdditionalValue();if(t.length===0&&I.call(this,n,a)){return}e=this.getResultForChangePromise(t);e=V.call(this,e,n);if(t.length===0||t[0].values.length===1){if(a){const t=this.getContentFactory().getAdditionalDataType();if(t){i=t.parseValue("","string")}}else{i=a}}else if(t.length===1&&t[0].values.length>1){i=t[0].values[1]}this._vValue=e;this._vAdditionalValue=i;if(!b.call(this,e,n,true)){this.setProperty("value",e,true)}if(!F.call(this,i,a,true)&&!D.call(this)){this.setProperty("additionalValue",i,true)}}function V(t,e){const i=this.getContentFactory().getDataType()?this.getContentFactory().getDataType().getMetadata().getName():this.getDataType();if(this.getTypeMap().getBaseType(i)===n.Unit&&Array.isArray(t)&&Array.isArray(e)&&!this.checkValueInitial(t)&&this.checkValueInitial(e)){for(let i=0;i<t.length;i++){if(t[i]===null&&e[i]!==undefined){t[i]=e[i]}}}return t}c.prototype.getSupportedOperators=function(){return this.getProperty("_operators",[])};function D(){const t=this.getBinding("additionalValue");if(t&&t.getBindingMode()===p.OneWay){return true}return false}c.prototype.checkCreateInternalContent=function(){if(!this.isFieldDestroyed()&&this.getContentFactory().getDataType()&&!this.isFieldPropertyInitial("editMode")&&!this.isFieldPropertyInitial("multipleLines")){t.prototype.checkCreateInternalContent.apply(this,arguments)}};c.prototype.getOverflowToolbarConfig=function(){const e=t.prototype.getOverflowToolbarConfig.apply(this,arguments);e.propsUnrelatedToSize.push("value");e.propsUnrelatedToSize.push("additionalValue");return e};c.prototype.isSearchField=function(){return false};function I(t,e){return this.checkValueInitial(t)&&!e}c.prototype.getAdditionalDataTypeConfiguration=function(){const t=this.getBinding("additionalValue");if(t){return t.getType()}else{const t=this.getBindingInfo("additionalValue");if(t?.type){if(typeof t.type==="string"){return{name:t.type,formatOptions:t.formatOptions,constraints:t.constraints}}else{return t.type}}}};c.prototype.getBindingEventParameter=function(e){const i=this.getBinding("value");if(!i){return null}const n=t.prototype.getBindingEventParameter.apply(this,arguments);if(n){n.property="value";n.type=i.getType()}return n};const A=Symbol("sap.ui.core.message.MessageMixin");c.prototype.refreshDataState=function(t,e){if(e.getChanges().messages&&this.getBinding(t)&&this.getBinding(t).isA("sap.ui.model.PropertyBinding")){const t=e.getMessages();const i=u.getReferencingLabels(this);const n=i[0];let a=false;t.forEach(t=>{if(i&&i.length>0){const e=h.getElementById(n);if(e.getMetadata().isInstanceOf("sap.ui.core.Label")&&e.getText){let i=t.getAdditionalText()||"";const n=e.getText();if(!i.split(",").includes(n)){if(t[A]){i=i?`${i}, ${n}`:n}else{i=n;t[A]=true}t.setAdditionalText(i);a=true}}else{o.warning("sap.ui.core.message.Message: Can't create labelText."+"Label with id "+n+" is no valid sap.ui.core.Label.",this)}}const e=this.getBinding("value");let s=this.getId();if(e.isA("sap.ui.model.CompositeBinding")&&this.getContentFactory().isMeasure()){const i=this.getCurrentContent();if(i.length>0){if(t.getMessageProcessor().isA("sap.ui.model.Model")){const n=e.getBindings();const a=t.getTargets();for(let t=0;t<a.length;t++){for(let e=0;e<n.length;e++){if(a[t]===n[e].getResolvedPath()){s=i[e].getId();break}}}}else if(t.getMessageProcessor().isA("sap.ui.core.message.ControlMessageProcessor")){for(let e=0;e<i.length;e++){const n=i[e].getId();const a=this.getValueStateForContent(n);if(a?.valueState===t.getType()&&a?.valueStateText===t.getMessage()){s=n;break}}}}}if(!t.getControlIds().includes(s)){t.addControlId(s);a=true}});const s=sap.ui.require("sap/ui/core/Messaging");if(s){const t=s.getMessageModel();t.checkUpdate(a,true)}const l=this.getCurrentContent();const r=[];if(t&&t.length>0){for(let e=0;e<t.length;e++){const i=t[e];if(y[i.getType()]){const t=i.getControlIds();for(let e=0;e<t.length;e++){const n=t[e];if(r.indexOf(n)<0&&l.find(t=>t.getId()===n)){this.setValueStateForContent(n,i.getType(),i.getMessage());r.push(n)}}if(e==0){this.setValueState(i.getType());this.setValueStateText(i.getMessage())}}}}else{this.setValueState(y.None);this.setValueStateText("");this.resetInvalidInput(false)}this._oManagedObjectModel?.checkUpdate(true,false,t=>{const e=t.getPath();return["/valueState","/valueStateText"].indexOf(e)>=0})}};c.prototype.isEmptyAllowed=function(){let e=t.prototype.isEmptyAllowed.call(this,arguments);if(e){const t=this.getContentFactory().retrieveDataType();try{const e=t.parseValue("","string");t.validateValue(e)}catch(t){e=false}}return e};return c});
//# sourceMappingURL=Field.js.map