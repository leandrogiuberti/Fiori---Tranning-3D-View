/*
 * SAPUI5

(c) Copyright 2009-2020 SAP SE. All rights reserved
 */
sap.ui.define(["./transaction/BaseController","./transaction/TransactionController","sap/ui/generic/app/util/ModelUtil","sap/base/Log"],function(e,t,r,i){"use strict";var o=e.extend("sap.ui.generic.app.ApplicationController",{constructor:function(t,r){e.apply(this,[t]);this._oGroupChanges={};this.sName="sap.ui.generic.app.ApplicationController";this.oPropertyChangedResolve;this.oPropertyChangedReject;this._initModel(t);this.registerView(r)}});o.prototype.propertyChanged=function(e,t,i){var o=this,a={batchGroupId:"Changes",changeSetId:"Changes",onlyIfPending:true,noShowResponse:true,noBlockUI:true,draftSave:true},n,s={};if(t&&t instanceof sap.ui.model.Context){var u=r.getEntitySetFromContext(t);var f=t.getModel().getMetaModel();var l=f.getODataEntitySet(u).entityType;s=f.getODataEntityType(l)}for(var c in s){if(c.startsWith("com.sap.vocabularies.Common.v1.SideEffects")){n=s[c];if(n.SourceProperties&&n.SourceProperties.length){for(var h=0;h<n.SourceProperties.length;h++){if(n.SourceProperties[h].PropertyPath===e){o.registerGroupChange(o._getSideEffectsQualifier(c))}}}}}if(!o._oDraftMergeTimer.nTimeoutID){o.oResultPromise=new Promise(function(e,t){o.oPropertyChangedResolve=e;o.oPropertyChangedReject=t;o._oDraftMergeTimer.nTimeoutID=setTimeout(function(){o._oDraftMergeTimer.nTimeoutID=null;if(o._oModel.hasPendingChanges()){o.triggerSubmitChanges(a).then(function(t){e()},function(e){t(e)})}else{e()}},(i||0)*1e3)})}return o.oResultPromise};o.prototype.registerGroupChange=function(e){this._oGroupChanges[e]=true};o.prototype.registerView=function(e){var t=this;if(e){this._fnAttachValidateFieldGroup=function(r){var i,o,a,n,s=[];var u=this.getBindingContext();if(!u){return false}if(!t.getTransactionController().getDraftController().getDraftContext().hasDraft(u)){this.detachValidateFieldGroup(t._fnAttachValidateFieldGroup);return false}if(r.mParameters.fieldGroupIds){a=r.mParameters.fieldGroupIds.length}for(n=0;n<a;n++){i=r.mParameters.fieldGroupIds[n];o=e.data(i);if(o){s.push({uuid:i,objid:o})}}t._onValidateFieldGroup(s,e)};e.attachValidateFieldGroup(this._fnAttachValidateFieldGroup)}};o.prototype._initModel=function(e){if(e.getDefaultBindingMode()!==sap.ui.model.BindingMode.TwoWay){i.error("ApplicationController: The model's DefaultBindingMode wasn't but is now set to 'TwoWay'.");e.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay)}if(e.getRefreshAfterChange()!==false){i.error("ApplicationController: The model's setting 'RefreshAfterChange' wasn't but is now set to 'false'.");e.setRefreshAfterChange(false)}e.setDeferredGroups(["Changes"]);e.setChangeGroups({"*":{groupId:"Changes",changeSetId:"Changes",single:false}})};o.prototype._onValidateFieldGroup=function(e,t){var r,i=e.length,o,a={bGlobal:false,aRequests:[],bHasTargets:true},n=[],s=this;for(r=0;r<i;r++){n.push(this._executeFieldGroup(e[r],a,t).then(function(){return true},function(){return false}))}var u=function(e){if(e.find(function(e){return e})){i=a.aRequests.length;for(r=0;r<i;r++){o=a.aRequests[r];o(a.bGlobal)}if(a.bGlobal){s._oModel.refresh(true,false,"Changes")}var t=s.triggerSubmitChanges({batchGroupId:"Changes",noShowSuccessToast:true,forceSubmit:true,noBlockUI:true,urlParameters:{},draftSave:s._oModel.hasPendingChanges(true)});s.fireEvent("beforeSideEffectExecution",{promise:t});return t}};return Promise.all(n).then(u)};o.prototype._executeFieldGroup=function(e,t,r){var i,o,a,n={batchGroupId:"Changes",changeSetId:"SideEffects",noShowSuccessToast:true,forceSubmit:true,noBlockUI:true,urlParameters:{}},s=this;i=this._getSideEffectsQualifier(e.objid.name);n.urlParameters.SideEffectsQualifier=i;o=e.objid.contextObject;a=this._getSideEffect(e.objid);return this._hasClientErrors(e.uuid,r).then(function(){if(!s._oGroupChanges[i]){return Promise.reject()}s._oGroupChanges[i]=false;if(o&&o.isTransient&&o.isTransient()){return s.synchronizeDraftAsync().then(function(){s._executeSideEffects(a,o,n,t)})}else{s._executeSideEffects(a,o,n,t)}})};o.prototype._getSideEffectsQualifier=function(e){var t=e.replace("com.sap.vocabularies.Common.v1.SideEffects","");if(t.indexOf("#")===0){t=t.replace("#","")}return t};o.prototype._executeSideEffectsForActions=function(e,t,r){var i;var o="_it/";var a={bGlobal:false,aRequests:[],bHasTargets:true};var n={batchGroupId:"Changes",changeSetId:"SideEffects",noShowSuccessToast:true,forceSubmit:true,noBlockUI:true,urlParameters:{}};var s=0;if(r===false){n.batchGroupId="NonDraftChanges"}if(e.TargetEntities&&e.TargetEntities.length){for(s=0;s<e.TargetEntities.length;s++){if(e.TargetEntities[s].NavigationPropertyPath.indexOf(o)===0){e.TargetEntities[s].NavigationPropertyPath=e.TargetEntities[s].NavigationPropertyPath.substr(4)}}}var u=function(e,t){var r=e[t];if(r&&r.startsWith(o)){e[t]=r.substr(4)}};(e.TargetProperties||[]).forEach(function(e){["PropertyPath","String"].forEach(u.bind(null,e))});for(s=0;s<t.length;s++){this._executeSideEffects(e,t[s],n,a);if(a.aRequests[0]){i=a.aRequests[0];i(a.bGlobal);a.aRequests=[]}}if(a.bGlobal){this._oModel.refresh(true,false,n.batchGroupId)}};o.prototype._executeSideEffects=function(e,t,r,i){var o=this,a,n,s;var u=o.getTransactionController().getDraftController();var f=u.getDraftContext().hasDraft(t);if(e.TriggerAction&&e.TriggerAction.String&&f){n=e.TriggerAction.String}this._setSelect(e,r,i,t);s=i.bHasTargets;a=function(e,i){var a=!(i&&i.callPreparationOnly);var l=o._oModel.getETag(t.getPath());if(l){r.headers={"If-Match":"*"}}if(n&&a){o._callAction(n,t,r)}else if(i&&i.callPreparationOnDraftRoot&&f){delete r.urlParameters.SideEffectsQualifier;u.prepareDraft(i.draftRootContext,r)}if(!e&&s&&a){var c=Object.assign({},r);c.context=t;o._read("",c,true)}};i.aRequests.push(a)};o.prototype._hasClientErrors=function(e,t){var r,i=[];r=t.getControlsByFieldGroupId(e);r.forEach(function(e){var t=e.getParent();var r={handleSuccess:false};i.push(t&&t.checkValuesValidity&&t.checkValuesValidity(r))});return Promise.all(i)};o.prototype._findChildEntityTypeByNavigationProperty=function(e,t){var r=this._oModel.getMetaModel();var i=t.split("/");var o=e;for(var a of i){var n=r.getODataAssociationEnd(o,a);if(!n){return null}o=r.getODataEntityType(n.type)}return o};o.prototype._setSelect=function(e,t,o,a){var n=this;var s=new Set;var u=new Set;var f=r.getEntitySetFromContext(a);var l=this._oModel.getMetaModel();var c=l.getODataEntitySet(f).entityType;var h=l.getODataEntityType(c);if(!o.bGlobal){if((!e.TargetEntities||e.TargetEntities.length===0)&&(!e.TargetProperties||e.TargetProperties.length===0)){o.bHasTargets=false;return}if(e.TargetEntities?.length>0){e.TargetEntities.forEach(function(e){const t=e.NavigationPropertyPath;if(t===""){s.add("*")}else{const e=n._findChildEntityTypeByNavigationProperty(h,t);if(e){s.add(t);u.add(t)}else{i.error("ApplicationController: Invalid TargetEntities entry '"+t+"' on the side effect")}}})}if(e.TargetProperties?.length>0){e.TargetProperties.forEach(function(e){var t=e.PropertyPath||e.String;if(t.includes("/")){var r=t.lastIndexOf("/");var o=t.substring(0,r);var a=t.substring(r+1);var f=n._findChildEntityTypeByNavigationProperty(h,o);if(f&&l.getODataProperty(f,a)){u.add(o);s.add(t)}else{i.error("ApplicationController: Invalid TargetProperties entry '"+t+"' on the side effect")}}else{var c=!!l.getODataProperty(h,t);if(c){s.add(t)}else{i.error("ApplicationController: Invalid TargetProperties entry '"+t+"' on the side effect")}}})}}if(s.size>0){t.readParameters={$select:Array.from(s).join(",")};if(u.size>0){t.readParameters["$expand"]=Array.from(u).join(",")}}};o.prototype._getSideEffect=function(e){var t,r,i,o;t=this._oModel.getMetaModel();i="getOData"+e.originType.substring(0,1).toUpperCase()+e.originType.substring(1);if(e.originNamespace){o=e.originNamespace+"."+e.originName}else{o=e.originName}if(t[i]){r=t[i](o);if(r){return r[e.name]}}throw"Unknown SideEffect originType: "+e.originType};o.prototype.getTransactionController=function(){if(!this._oTransaction){this._oTransaction=new t(this._oModel,this._oQueue,{noBatchGroups:true},this._oDraftMergeTimer)}return this._oTransaction};o.prototype.invokeActions=function(e,t,r){var i,o,a=t.length,n,s=[],u,f=false;var l=this._oModel.hasPendingChanges();r=r||{};if(this._oDraftMergeTimer.nTimeoutID){f=true;if(a&&this._oModel.getETag(t[0].getPath())){r.headers={"If-Match":"*"}}}n=this._getChangeSetFunc(t,r.operationGrouping);if(a===0){s.push(this._invokeAction(e,null,null,r))}else{for(o=0;o<a;o++){s.push(this._invokeAction(e,t[o],(f?"Action":"")+n(o),r))}}var c=this._oModel.getMetaModel().getODataFunctionImport(e.split("/")[1]);for(var h in c){if(h.startsWith("com.sap.vocabularies.Common.v1.SideEffects")){u=c[h];break}}if(u){this._executeSideEffectsForActions(u,t,r.triggerChanges)}if(r.triggerChanges!==false){s.push(this.triggerSubmitChanges({batchGroupId:"Changes",successMsg:"Call of action succeeded",failedMsg:"Call of action failed",forceSubmit:true,context:i,draftSave:l}))}var g=this;return this._newPromiseAll(s).then(function(e){var i=false;if(e&&r.triggerChanges!==false&&e.length>t.length){var o=e.pop();if(f&&l){var a=o.response[0];if(a.response.statusCode>=400&&a.response.statusCode<599){g.oPropertyChangedReject(a)}else{g.oPropertyChangedResolve(a)}}}i=g._checkAtLeastOneSuccess(t,e);if(i){return e}else{return Promise.reject(e)}})};o.prototype.executeSideEffects=function(e,t,i,o,a){var n,s,u,f,l,c;var h=false;var g=!t&&!i;var p={bGlobal:false,aRequests:[],bHasTargets:true};var d={batchGroupId:"Changes",changeSetId:"SideEffects",noShowSuccessToast:true,forceSubmit:true,noBlockUI:true,urlParameters:{}};var v=r.getEntitySetFromContext(e);var C=e.getModel().getMetaModel();var S=C.getODataEntitySet(v).entityType;var y=C.getODataEntityType(S);var m=0;o=!(o===false);i=i||[];t=t||[];var b=function(t){if(c){d.urlParameters.SideEffectsQualifier=c}else{delete d.urlParameters.SideEffectsQualifier}this._executeSideEffects(t,e,d,p);if(p.aRequests[0]){l=p.aRequests[0];l(p.bGlobal,a);p.aRequests=[]}}.bind(this);for(var P in y){if(P.startsWith("com.sap.vocabularies.Common.v1.SideEffects")){n=y[P];f=false;c=this._getSideEffectsQualifier(P);if(g){if(!n.SourceProperties&&!n.SourceEntities){b(n);f=true;h=true;break}}else{if(n.SourceEntities&&n.SourceEntities.length){for(m=0;m<n.SourceEntities.length;m++){s=n.SourceEntities[m].NavigationPropertyPath;if(i.indexOf(s)!==-1){f=true}}}if(!f&&n.SourceProperties&&n.SourceProperties.length){for(m=0;m<n.SourceProperties.length;m++){u=n.SourceProperties[m].PropertyPath;if(t.indexOf(u)!==-1){f=true}}}if(f){b(n);h=true}}}}if(g&&!f){b({});h=true}if(o&&!p.bHasTargets){this._oModel.refresh(true,false,"Changes");h=true}var _=null;if(h){_=this.triggerSubmitChanges({batchGroupId:"Changes",noShowSuccessToast:true,forceSubmit:true,noBlockUI:true,urlParameters:{},draftSave:this._oModel.hasPendingChanges(true)})}else{_=Promise.resolve()}this.fireEvent("beforeSideEffectExecution",{promise:_});return _};o.prototype._checkAtLeastOneSuccess=function(e,t){var r,i=false;if(e.length<=t.length){for(r=0;r<e.length;r++){t[r].actionContext=e[r];if(!t[r].error){i=true}}if(e.length===0){for(r=0;r<t.length;r++){if(!t[r].error){i=true}}}}return i};o.prototype._newPromiseAll=function(e){var t=[];var r=Promise.resolve(null);e.forEach(function(e){r=r.then(function(){return e}).then(function(e){t.push({response:e})},function(e){t.push({error:e})})});return r.then(function(){return Promise.resolve(t)})};o.prototype._getChangeSetFunc=function(e,t){var r=e.length;var i=function(){return"Changes"};if(r===1){return i}if(t==="com.sap.vocabularies.UI.v1.OperationGroupingType/ChangeSet"){return i}return function(e){return"Changes"+e}};o.prototype.getNewActionContext=function(e,t,r){var i=this;e=e.startsWith("/")?e.split("/")[1]:e;r=Object.assign({batchGroupId:"Changes",changeSetId:"SingleAction",successMsg:"Call of action succeeded",failedMsg:"Call of action failed",forceSubmit:true,context:t,functionImport:this._oMeta.getODataFunctionImport(e)},r);var o=this._createFunctionContext(t,r);o.result=o.result.then(function(e){return i._normalizeResponse(e,true)},function(e){if(!e.aborted){var t=i._normalizeError(e);throw t}});return o};o.prototype.submitActionContext=function(e,t,r){var i;var o=this._oModel.getMetaModel().getODataFunctionImport(r);for(var a in o){if(a.startsWith("com.sap.vocabularies.Common.v1.SideEffects")){i=o[a];break}}if(i){this._executeSideEffectsForActions(i,[e])}this.triggerSubmitChanges({batchGroupId:"Changes",successMsg:"Call of action succeeded",failedMsg:"Call of action failed",forceSubmit:true,context:t})};o.prototype._invokeAction=function(e,t,r,i){var o=this;var a=Object.assign({},i.headers);var n=Object.assign({},i.urlParameters);var s={batchGroupId:"Changes",changeSetId:r,successMsg:"Call of action succeeded",failedMsg:"Call of action failed",urlParameters:n,forceSubmit:true,context:t,headers:a,expand:i.expand};if(i.triggerChanges===false){s.batchGroupId="NonDraftChanges"}return this._callAction(e,t,s).then(function(e){return o._normalizeResponse(e,true)},function(e){var t=o._normalizeError(e);throw t})};o.prototype.synchronizeDraftAsync=function(){if(!this._oModel.hasPendingChanges()){return Promise.resolve({})}var e={batchGroupId:"Changes",changeSetId:"Changes",onlyIfPending:true,noShowResponse:true,noBlockUI:true,draftSave:true};return this.triggerSubmitChanges(e)};o.prototype.destroy=function(){e.prototype.destroy.apply(this,[]);if(this._oTransaction){this._oTransaction.destroy()}this._oModel=null;this._oTransaction=null;this._oGroupChanges=null};return o},true);
//# sourceMappingURL=ApplicationController.js.map