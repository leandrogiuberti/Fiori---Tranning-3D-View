/*
 * SAPUI5

(c) Copyright 2009-2020 SAP SE. All rights reserved
 */
sap.ui.define(["./BaseController","./DraftController","sap/ui/generic/app/util/ModelUtil","sap/base/util/extend","sap/base/Log"],function(t,e,r,n,a){"use strict";var i=t.extend("sap.ui.generic.app.transaction.TransactionController",{metadata:{publicMethods:["destroy","setBatchStrategy","getDraftController","invokeAction","editEntity","deleteEntity","deleteEntities","propertyChanged","hasClientValidationErrors","resetChanges","getDefaultValues","getDefaultValuesFunction","updateMultipleEntities"]},constructor:function(e,r,n,a){t.apply(this,[e,r,a]);this.sName="sap.ui.generic.app.transaction.TransactionController";this._oDraft=null;n=n||{};if(!n.noBatchGroups){e.setDeferredGroups(["Changes"]);e.setChangeGroups({"*":{groupId:"Changes",changeSetId:"Changes",single:false}})}return this.getInterface()}});i.prototype.setBatchStrategy=function(t){var e,r=this._oModel.getChangeGroups();for(e in r){r[e].single=t}this._oModel.setChangeGroups(r)};i.prototype.getDraftController=function(){if(!this._oDraft){this._oDraft=new e(this._oModel,this._oQueue,this._oDraftMergeTimer)}return this._oDraft};i.prototype.editEntity=function(t,e,n){var a=this;return new Promise(function(i){var o,s;o=a.getDraftController().getDraftContext();s=r.getEntitySetFromContext(t);if(o.isDraftEnabled(s)&&a._oDraftUtil.isActiveEntity(t.getObject())){return i(a.getDraftController().createEditDraftEntity(t,e,n))}return i({context:t})})};i.prototype.deleteEntity=function(t,e,r){var n,a,i=this,o,s,l;if(typeof t=="string"){o=t}else if(typeof t=="object"&&t instanceof sap.ui.model.Context){s=t;o=s.getPath()}e=e||{};Object.assign(e,{batchGroupId:"Changes",changeSetId:"Changes",successMsg:"Changes were discarded",failedMsg:"Discarding of changes failed",forceSubmit:true,context:s});var u=r?"lenient":"strict";e.headers={Prefer:"handling="+u};if(i._oModel.getObject(o)&&i._oDraftUtil.isActiveEntity(i._oModel.getObject(o))!==undefined&&!i._oDraftUtil.isActiveEntity(i._oModel.getObject(o))){if(!s){s=new sap.ui.model.Context(this._oModel,o)}l=i.getDraftController();n=l.discardDraft(s,e)}else{n=this._remove(o,e)}n.then(function(t){return i._normalizeResponse(t,true)},function(t){var e=i._normalizeError(t);throw e});a=this.triggerSubmitChanges(e);return this._returnPromiseAll([n,a])};i.prototype.deleteEntities=function(t,e){var r,n=[],a=this,i,o,s;e=e||{};var l=e.bIsStrict?"strict":"lenient";e.headers=e.headers||{};e.headers.Prefer="handling="+l;Object.assign(e,{batchGroupId:"Changes",changeSetId:"Changes",successMsg:"Changes were discarded",failedMsg:"Discarding of changes failed",forceSubmit:true});var u=function(t){return a._normalizeResponse(t,true)};var h=function(t){var e=a._normalizeError(t);throw e};for(var c=0;c<t.length;c++){o=null;if(typeof t[c]=="string"){i=t[c]}else if(typeof t[c]=="object"&&t[c]instanceof sap.ui.model.Context){o=t[c];i=o.getPath()}if(a._oModel.getObject(i)&&a._oDraftUtil.isActiveEntity(a._oModel.getObject(i))!==undefined&&!a._oDraftUtil.isActiveEntity(a._oModel.getObject(i))){e.changeSetId="Changes";if(!o){o=new sap.ui.model.Context(this._oModel,i)}s=a.getDraftController();r=s.discardDraft(o,e).then(u,h)}else{e.changeSetId="ActiveChanges";r=this._remove(i,e).then(u,h)}n.push(r)}r=this.triggerSubmitChanges(e);n.push(r);return this._atLeastOnePromiseResolved(n,true)};i.prototype.invokeAction=function(t,e,r){var n=this,a,i;a=this.hasClientMessages();if(a){return a}r={batchGroupId:"Changes",changeSetId:"Changes",successMsg:"Call of action succeeded",failedMsg:"Call of action failed",urlParameters:r.urlParameters,forceSubmit:true,context:e};a=this._callAction(t,e,r).then(function(t){return n._normalizeResponse(t,true)},function(t){var e=n._normalizeError(t);throw e});this._oModel.refresh(true,false,"Changes");i=this.triggerSubmitChanges(r);return this._returnPromiseAll([a,i])};i.prototype.resetChanges=function(t){this._oModel.resetChanges(t)};i.prototype.getDefaultValues=function(t,e,i,o){var s,l,u=t[0],h=this;if(!(u instanceof sap.ui.model.Context)){throw new Error("No context")}var c=r.getEntitySetFromContext(u);if(!c){throw new Error("No EntitySet found in the current context")}var f=u.getModel();var g=f.getMetaModel();var d=g.getODataEntityType(g.getODataEntitySet(c).entityType);if(i){var p=i.split("/");if(p.length>1){try{var v=this.getImmediateParentContextDetails(d,u,i);d=v.entityType;u=v.context;i=v.relativeChildNavigationProperty}catch(t){a.error("Unable to fetch the default values: "+t.message);return e}}s=d.navigationProperty.find(function(t){return t.name===i});var y=g.getODataEntityType(g.getODataAssociationEnd(d,i).type);l=y.property}else if(o){s=g.getODataFunctionImport(o);l=s.parameter}else{s=g.getODataEntitySet(c);l=d.property}var m=this.getDefaultValuesFunction(s);if(m){var C=g.getODataFunctionImport(m);if(t.length>1&&C.parameter){a.error("Parameterized DefaultValuesFunction not to be called with multiple selections");return e}var D={successMsg:"Call of action succeeded",failedMsg:"Call of action failed",urlParameters:null,forceSubmit:true,context:u,headers:{},batchGroupId:"DefaultValues",keepDraftMergeTimer:true};var _=this._oModel.getETag(u.getPath());if(_){D.headers={"If-Match":"*"}}o=C.name;var E="/"+o;return this._callAction(E,u,D).then(function(t){if(t.httpResponse.statusCode==="200"){var r=t.responseData[o]||t.responseData;var a={};l.forEach(function(t){if(r.hasOwnProperty(t.name)){a[t.name]=r[t.name]}});return n({},e,a)}return e}).then(function(t){return h.triggerSubmitChanges(D).then(function(){return t})})}return e};i.prototype.getImmediateParentContextDetails=function(t,e,r){var n=r.split("/");var a=e.getModel();var i=a.getMetaModel();var o=e;var s=t;var l;var u;var h;if(n.length<2){throw new Error("This method supports only the nested navigation property!")}for(var c=0;c<n.length;c++){var f=n[c];if(c===n.length-1){h=f;continue}var g=i.getODataAssociationEnd(s,f);if(g&&g.multiplicity.endsWith("1")){l=a.createBindingContext(f,o)}else{throw new Error("The entity type '"+s.name+"' and the navigation property '"+f+"' don't have 1..1 relationship")}if(!l){var d=o.getPath()+"/"+f;throw new Error("The context with the path '"+d+"' is not available")}u=i.getODataEntityType(g.type);o=l;s=u}return{context:l,entityType:u,relativeChildNavigationProperty:h}};i.prototype.getDefaultValuesFunction=function(t){var e=t["com.sap.vocabularies.Common.v1.DefaultValuesFunction"];return e&&e.String};i.prototype.updateMultipleEntities=function(t){var e=[];var r=this;var n=function(t){return r._normalizeResponse(t,true)};var a={batchGroupId:"Changes",changeSetId:"Changes",successMsg:"Changes saved",failedMsg:"Saving of changes failed",forceSubmit:true};var i=function(t){var e=r._normalizeError(t);throw e};for(var o=0;o<t.length;o++){var s=this._updateEntity(t[o].sContextPath,t[o].oUpdateData,o).then(n,i);e.push(s)}return this._atLeastOnePromiseResolved(e).finally(function(){r.triggerSubmitChanges(a)})};i.prototype.destroy=function(){t.prototype.destroy.apply(this,[]);if(this._oDraft){this._oDraft.destroy()}this._oDraft=null};return i},true);
//# sourceMappingURL=TransactionController.js.map