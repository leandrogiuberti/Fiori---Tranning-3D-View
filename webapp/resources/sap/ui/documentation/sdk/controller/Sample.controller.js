/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Element","sap/ui/core/EventBus","sap/ui/core/Theming","sap/ui/documentation/sdk/controller/SampleBaseController","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/core/Component","sap/ui/core/ComponentContainer","sap/ui/documentation/sdk/controller/util/ControlsInfo","sap/ui/documentation/sdk/util/ToggleFullScreenHandler","sap/m/BusyDialog","sap/m/Text","sap/ui/core/HTML","sap/m/library","sap/base/Log","sap/ui/core/Fragment","sap/ui/documentation/sdk/util/Resources","./config/sampleForwardingConfig","sap/base/strings/capitalize","sap/base/i18n/Localization"],function(e,t,i,n,a,s,o,r,l,d,h,u,p,m,f,c,g,_,S,I){"use strict";var T=m.URLHelper;var y=["sap-ui-rtl","sap-ui-language"];var R={LEGACY_THEME_VERSION_THRESHOLD:68,LEGACY_DEFAULT_THEME:"sap_belize",SETTINGS_TIMEOUT:3e3,BUSY_DIALOG_TIMEOUT:1e3,EXTERNAL_SAMPLE_RENDERING_DELAY:100};return n.extend("sap.ui.documentation.sdk.controller.Sample",{onInit:function(){n.prototype.onInit.call(this);this.oRouter=this.getRouter();this._attachPaternMatched();this.oModel=new a({showNavButton:true,showNewTab:false,rtaLoaded:false,rtaStarted:false,density:this.getOwnerComponent().getContentDensityClass(),rtl:I.getRTL(),theme:i.getTheme(),showWarning:false});this._sId=null;this._sEntityId=null;this.getView().setModel(this.oModel);this.bus=t.getInstance();this.setDefaultSampleTheme();this.getOwnerComponent()._sSampleIframeOrigin=g.getConfig()!=="."?g.getResourceOrigin():window.origin},_attachPaternMatched:function(){this.oRouter.getRoute("sample").attachPatternMatched(this._onSampleMatched,this)},_onSampleMatched:function(e){this._sId=e.getParameter("arguments").sampleId;this._sEntityId=e.getParameter("arguments").entityId;this.byId("page").setBusy(true);if(_[this._sId]){return this.oRouter.navTo("sample",{entityId:_[this._sId].entityId,sampleId:_[this._sId].sampleId},true)}this.getModel("appView").setProperty("/bHasMaster",false);l.loadData().then(this._loadSample.bind(this))},_loadSample:function(e){var t=window.location.search,i=t.includes("dk-sample-standalone"),n=this._getPage(),a=this.oModel.getData(),s=e.samples[this._sId],o;if(!s){setTimeout(function(){n.setBusy(false)},0);this.onRouteNotFound();return}this.entityId=this._sEntityId?this._sEntityId:s.entityId;this._sLib=s.library;a.sEntityId=this.entityId;if(i){this._handleRedirect(s)}if(s.previousSampleId||s.nextSampleId){a.previousSampleId=s.previousSampleId;a.nextSampleId=s.nextSampleId}if(s.contexts){o=s.contexts[this.entityId];if(o){a.previousSampleId=o.previousSampleId;a.nextSampleId=o.nextSampleId}else{this.onRouteNotFound();return}}a.title="Sample: "+s.name;a.showNewTab=true;a.id=s.id;a.name=s.name;a.details=s.details;a.description=s.description;a.showSettings=!s.external;a.external=s.external;a.externalAppRef=s.externalAppRef;a.externalSourceRef=s.externalSourceRef;a.externalResourceRef=s.externalResourceRef;var r=this._getChangedSamplesLocalStorage();if(r&&JSON.parse(r).indexOf(s.id)>-1){a.showWarning=true}else{a.showWarning=false}this._createIframe().then(function(e){this.getOwnerComponent()._oCurrentOpenedSample=this._oHtmlControl;if(e){a.stretch=e.stretch;a.includeInDownload=e.additionalDownloadFiles;a.customIndexHTML=e.customIndexHTML;if(e.files){var t=sap.ui.require.toUrl(s.id.replace(/\./g,"/"));a.files=[];for(var i=0;i<e.files.length;i++){var o=e.files[i];a.files.push({name:o});this._updateFileContent(t,o)}}a.iframe=e.iframe||null;n.setProperty("enableScrolling",!!e.stretch,true)}this.getAPIReferenceCheckPromise(s.entityId).then(function(e){this.getView().byId("apiRefButton").setVisible(e)}.bind(this));this.oModel.setData(a);this.appendPageTitle(this.getModel().getProperty("/name"))}.bind(this)).catch(function(e){n.removeAllContent();n.addContent(new u({text:"Error while loading the sample: "+e}))}).finally(function(){setTimeout(function(){n.setBusy(false)},0)})},_handleRedirect:function(e){if(this._isExternalSample(e)){T.redirect(e.externalAppRef,false);return}this._initIframeURL();this._applySearchParamValueToIframeURL("sap-ui-theme",this._sDefaultSampleTheme);this.sIFrameUrl+="&dk-sample-standalone";T.redirect(this.sIFrameUrl,false)},_isExternalSample:function(e){return e&&e.external},_getIframeContentWindow:function(){var e=this._oHtmlControl&&this._oHtmlControl.getDomRef();return e?e.contentWindow:null},_postMessageToIframe:function(e){var t=this._getIframeContentWindow();if(t){t.postMessage(e,this.getOwnerComponent()._sSampleIframeOrigin)}},_initIframeURL:function(){var e=this.oModel&&this.oModel.getData();if(e&&this._isExternalSample(e)&&e.externalAppRef){this.sIFrameUrl=e.externalAppRef;return}var t=g.getConfig(),i=g.getResourcesVersion(),n="";y.forEach(function(e,t){if(new URL(document.location.href).searchParams.get(e)){n+=(n===""?"?":"&")+e+"="+new URL(document.location.href).searchParams.get(e)}});n=(n===""?"?":n+"&")+"sap-ui-xx-sample-id="+this._sId+"&sap-ui-xx-sample-lib="+(this._sLib||"")+"&sap-ui-xx-sample-origin="+t+i+"&sap-ui-xx-dk-origin="+window.location.origin;this.sIFrameUrl=g.getResourceOrigin()+"/resources/sap/ui/documentation/sdk/index.html"+n},getSettingsDialog:function(){return new Promise(function(e,t){if(!this._oSettingsDialog){c.load({id:"sample",name:"sap.ui.documentation.sdk.view.appSettingsDialog",controller:this}).then(function(t){this._oSettingsDialog=t;this._oSettingsDialog.setModel(this._oMessageBundle,"i18n");e(this._oSettingsDialog)}.bind(this))}else{e(this._oSettingsDialog)}}.bind(this))},_getChangedSamplesLocalStorage:function(){return localStorage.getItem("dk_changed_samples")},_setChangedSamplesLocalStorage:function(e){localStorage.setItem("dk_changed_samples",e)},handleSettings:function(){if(!this._oMessageBundle){this._oMessageBundle=new s({bundleName:"sap.ui.documentation.messagebundle"})}this.getSettingsDialog().then(function(e){this.loadSampleSettings(this.applySampleSettings.bind(this));return e}.bind(this)).then(function(e){e.open()}).catch(function(e){f.error(e)})},applySampleSettings:function(t){if(t.data.type==="SETTINGS"){var i=e.getElementById("sample--ThemeSelect");i.setSelectedKey(t.data.data.theme);e.getElementById("sample--RTLSwitch").setState(t.data.data.RTL);e.getElementById("sample--DensityModeSwitch").setSelectedKey(this._presetDensity(t.data.data.density,true))}},loadSampleSettings:function(e){return new Promise(function(t,i){this._postMessageToIframe({type:"SETTINGS",reason:"get"});var n=function(i){e(i);window.removeEventListener("message",n);t()};window.addEventListener("message",n);setTimeout(function(){window.removeEventListener("message",n);i("The sample iframe is not loading settings")},R.SETTINGS_TIMEOUT)}.bind(this))},handleCloseAppSettings:function(){this._oSettingsDialog.close()},handleSaveAppSettings:function(){var t=e.getElementById("sample--DensityModeSwitch").getSelectedKey(),i=e.getElementById("sample--ThemeSelect").getSelectedKey(),n=e.getElementById("sample--RTLSwitch").getState();this._oSettingsDialog.close();if(!this._oBusyDialog){this._oBusyDialog=new h;this._handleBusyDialog()}else{this._handleBusyDialog()}this._applyAppConfiguration(i,t,n);this._saveLocalSettings(i,t,n)},_saveLocalSettings:function(e,t,i){t=this._presetDensity(t);this.oModel.setData({theme:e,rtl:i,density:t},true)},_presetDensity:function(e,t){return t?e.slice(9).toLowerCase():"sapUiSize"+S(e)},_applyAppConfiguration:function(e,t,i){var n=this.oModel.getData();if(this._isExternalSample(n)){return}if(this.getModel().getProperty("/iframe")){this._setStandAloneIndexIframeSetting(e,t,i)}else{this._postMessageToIframe({type:"SETTINGS",reason:"set",data:{density:this._presetDensity(t),RTL:i,theme:e}})}},_setStandAloneIndexIframeSetting:function(e,t,i){this._applySearchParamValueToIframeURL("sap-ui-theme",e);this._applySearchParamValueToIframeURL("sap-ui-density",t);this._applySearchParamValueToIframeURL("sap-ui-rtl",i);var n=this._oHtmlControl&&this._oHtmlControl.getDomRef();if(n){n.src=this.sIFrameUrl}},_handleBusyDialog:function(){this._oBusyDialog.open();setTimeout(function(){this._oBusyDialog.close()}.bind(this),R.BUSY_DIALOG_TIMEOUT)},_updateFileContent:function(e,t,i){this.fetchSourceFile(e+"/"+t,undefined,i).then(function(e){var i=this.oModel.getProperty("/files");i.some(function(i){if(i.name===t){i.raw=e;return true}});this.oModel.setProperty("/files",i)}.bind(this))},onAPIRefPress:function(){this.oRouter.navTo("apiId",{id:this.entityId})},onNewTab:function(){var e=this.oModel.getData();if(this._isExternalSample(e)&&e.externalAppRef){T.redirect(e.externalAppRef,true);return}if(this.oModel.getProperty("/iframe")){T.redirect(this.sIFrameUrl,true);return}this._openNewTabWithSettings()},_openNewTabWithSettings:function(){this.loadSampleSettings(function(e){this._applySearchParamValueToIframeURL("sap-ui-theme",e.data.data.theme);this._applySearchParamValueToIframeURL("sap-ui-rtl",e.data.data.RTL);this._applySearchParamValueToIframeURL("sap-ui-density",e.data.data.density)}.bind(this)).then(function(){T.redirect(this.sIFrameUrl,true)}.bind(this)).catch(function(e){f.error("Failed to load sample settings for new tab",e)})},onPreviousSample:function(e){this.oRouter.navTo("sample",{entityId:this.entityId,sampleId:this.oModel.getProperty("/previousSampleId")})},onNextSample:function(e){this.oRouter.navTo("sample",{entityId:this.entityId,sampleId:this.oModel.getProperty("/nextSampleId")})},onInfoSample:function(e){var t=e.getSource();if(!this._oPopover){c.load({name:"sap.ui.documentation.sdk.view.samplesInfo",controller:this}).then(function(e){this.getView().addDependent(e);this._oPopover=e;this._oPopover.openBy(t)}.bind(this))}else{this._oPopover.openBy(t)}},onWarningSample:function(e){var t=e.getSource();if(!this._oWarningPopover){c.load({name:"sap.ui.documentation.sdk.view.samplesWarning",controller:this}).then(function(e){this.getView().addDependent(e);this._oWarningPopover=e;this._oWarningPopover.openBy(t)}.bind(this))}else{this._oWarningPopover.openBy(t)}},_createIframe:function(){return new Promise(function(e,t){this.fResolve=e;this.fReject=t;this._initIframeURL();if(this._oHtmlControl){this._oHtmlControl.destroy()}this._oHtmlControl=this._createHTMLControl().addEventDelegate({onBeforeRendering:this._onBeforeIframeRendering.bind(this)}).addEventDelegate({onAfterRendering:this._onAfterIframeRendering.bind(this)});this._getPage().removeAllContent();this._getPage().addContent(this._oHtmlControl)}.bind(this))},_onBeforeIframeRendering:function(){window.removeEventListener("message",this.onMessage.bind(this))},_onAfterIframeRendering:function(){var e=this.oModel.getData();if(this._isExternalSample(e)){setTimeout(function(){this.fResolve({})}.bind(this),R.EXTERNAL_SAMPLE_RENDERING_DELAY)}else{window.addEventListener("message",this.onMessage.bind(this))}},_createHTMLControl:function(){return new p({id:"sampleFrame",content:'<iframe src="'+this.sIFrameUrl+'" id="sampleFrame" frameBorder="0"></iframe>'})},_getPage:function(){return this.byId("page")},onMessage:function(e){var t=this.oModel.getData();if(this._isExternalSample(t)){return}if(e.origin!==this.getOwnerComponent()._sSampleIframeOrigin){return}if(e.source!==this._oHtmlControl.getDomRef().contentWindow){return}if(e.data.type==="INIT"){this.fnMessageInit(e)}else if(e.data.type==="ERR"){this.fnMessageError(e)}else if(e.data.type==="LOAD"){this.fnMessageLoad(e)}else if(e.data.type==="RTA"){this._loadRTA.call(this)}else if(e.data.type==="RTA_START"){this._onRTAStarted.call(this)}else if(e.data.type==="RTA_STOP"){this._onRTAStopped.call(this)}},fnMessageInit:function(e){var t=this.oModel.getData();if(e.data.config?.sample?.iframe){this.sIFrameUrl=sap.ui.require.toUrl(this._sId.replace(/\./g,"/"))+"/"+e.data.config.sample.iframe;this._setStandAloneIndexIframeSetting(t.theme,t.density,t.rtl)}if(!this._isExternalSample(t)){this._postMessageToIframe({type:"SETTINGS",reason:"set",data:{density:t.density,RTL:t.rtl,theme:t.theme}})}this.fResolve(e.data.config?.sample||{})},fnMessageLoad:function(){f.info("Sample Iframe for sample "+this._sId+" is loaded")},fnMessageError:function(e){this.fReject(e.data.data.msg)},setDefaultSampleTheme:function(){var e=g.getResourcesVersion();this._sDefaultSampleTheme=e&&parseInt(e.slice(3,5))<R.LEGACY_THEME_VERSION_THRESHOLD?R.LEGACY_DEFAULT_THEME:i.getTheme()},onNavBack:function(e){this.oRouter.navTo("entity",{id:this.entityId})},onNavToCode:function(){var e=this.oModel.getData();if(this._isExternalSample(e)&&e.externalSourceRef){T.redirect(e.externalSourceRef,true);return}this.oRouter.navTo("code",{entityId:this.entityId,sampleId:this._sId},false)},onToggleFullScreen:function(e){d.updateMode(e,this.getView(),this)},onDownload:function(){var e=this.oModel.getData();if(this._isExternalSample(e)&&e.externalResourceRef){T.redirect(e.externalResourceRef,true);return}if(n.prototype.onDownload){n.prototype.onDownload.call(this)}},_oRTA:null,_applySearchParamValueToIframeURL:function(e,t){var i=window.URL,n;try{n=new i(this.sIFrameUrl,document.location)}catch(e){f.warning("window.URL is not supported. The search param value won't be applied.");return}this.sIFrameUrl=this.sIFrameUrl.replace(n.search,"");n.searchParams.set(e,t);this.sIFrameUrl=this.sIFrameUrl+decodeURI(n.search)},_loadRTA:function(){var e=this.oModel.getData();e.rtaLoaded=true;this.oModel.setData(e,true);this.oRouter.attachRouteMatched(function(){if(this._oRTA){this._oRTA.destroy();this._oRTA=null}},this)},_onRTAStarted:function(){this.oModel.setProperty("/rtaStarted",true)},_onRTAStopped:function(){this.oModel.setProperty("/rtaStarted",false)},onToggleAdaptationMode:function(e){var t=this._getIframeContentWindow();if(!t){return false}this._postMessageToIframe({type:"RTA",data:{msg:"Start the RTA"}})},onRouteNotFound:function(){var e=this.getModel("i18n").getProperty("NOT_FOUND_SAMPLE_TITLE");this.oRouter.myNavToWithoutHash("sap.ui.documentation.sdk.view.SampleNotFound","XML",false);setTimeout(this.appendPageTitle.bind(this,e))}})});
//# sourceMappingURL=Sample.controller.js.map