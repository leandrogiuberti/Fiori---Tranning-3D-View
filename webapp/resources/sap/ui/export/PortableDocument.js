/*!
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["./ExportDialog","./ExportBase","./ExportUtils","./library","./util/PDFCapabilities","sap/base/i18n/Localization","sap/base/Log","sap/m/BusyDialog","sap/ui/base/Object","sap/ui/model/odata/v4/ODataModel","sap/ui/util/openWindow"],function(e,t,o,i,r,n,s,a,c,l,u){"use strict";const p=i.FileType;const d=i.EdmType;const h=i.Status;const m="application/pdf";const f=t.extend("sap.ui.export.PortableDocument",{constructor:function(e,o,i){t.call(this,e,o);if(!c.isA(this._mCapabilities,"sap.ui.export.util.PDFCapabilities")){this._mCapabilities=new r(this._mCapabilities)}if(i?.FileShare&&i?.ParentFileShareItem){this._mCloudFileInfo=i}["paperSize","orientation","font","fontSize","doEnableAccessibility","fitToPage","signature","signatureReason","pdfArchive","showPageNumber"].forEach(t=>{if(typeof e[t]!=="undefined"){this._mSettings[t]=e[t]}})}});f.prototype.processDataSource=function(e){let t=null;const o=typeof e;if(!e){return null}if(o!="object"){s.error("Spreadsheet#processDataSource: Unable to apply data source of type "+o);return null}if(e.dataUrl&&e.serviceUrl){t=e}if(e.isA&&e.isA(["sap.ui.model.ListBinding","sap.ui.model.TreeBinding"])){t=this.createDataSourceFromBinding(e)}return t};f.prototype.createDataSourceFromBinding=function(e){let t=null;if(e.isA(["sap.ui.model.ClientListBinding","sap.ui.model.ClientTreeBinding"])){s.error("Unable to create dataSource configuration due to not supported Binding: "+e.getMetadata().getName())}if(typeof e.getDownloadUrl==="function"){const i=e.getModel(),r=o.interceptUrl(e.getDownloadUrl("pdf")),n=o.interceptUrl(i.sServiceUrl),s=i.isA("sap.ui.model.odata.v4.ODataModel");const a=new URL(r,document.baseURI);a.hash="";this._oModel=i;a.search=a.search.split("&").filter(e=>e.indexOf("$format")==-1).join("&");t={type:"odata",version:s?4:2,dataUrl:a.toString(),commonServiceUrl:this._resolveCommonServiceUrl(n),serviceUrl:f.harmonizeUrl(n),headers:s?i.getHttpHeaders(true):i.getHeaders(),count:o.getCountFromBinding(e),useBatch:s||i.bUseBatch}}return t};f.prototype._resolveCommonServiceUrl=function(e){e=f.harmonizeUrl(e);const t=/^[\./]/.test(e);let o=this._mCapabilities.DocumentDescriptionReference;if(typeof o!=="string"||!o){return e.split("/").slice(0,-5).join("/")+"/default/iwbep/common/0001/"}o=o.endsWith("/")?o:o.split("/").slice(0,-1).join("/")+"/";let i=new URL(e,document.baseURI);i=new URL(o,i.href);return t?i.pathname:i.href};f.prototype._createDocumentDescription=function(e){const t=e.workbook;const o=e.dataSource.version;const i={Title:t.context.title,Format:{PaperSize:e.paperSize,Orientation:e.orientation},PDFStandard:{DoEnableAccessibility:e.doEnableAccessibility},TableColumns:[]};if(this._mCapabilities.ArchiveFormat){i.PDFStandard.UsePDFAConformance=e.pdfArchive}if(this._mCapabilities.CoverPage){const e=t.context.metainfo;i.CoverPage=[];if(e instanceof Array){e.forEach(e=>{if(o===2){e.items.forEach(t=>{const o={Title:e.name,Name:t.key,Value:t.value};i.CoverPage.push(o)})}else{const t={Title:e.name,Content:[]};e.items.forEach(e=>{t.Content.push({Name:e.key,Value:e.value})});i.CoverPage.push(t)}})}}if(this._mCapabilities.FitToPage){i.Format.FitToPage={IsEnabled:e.fitToPage,MinimumFontSize:1}}if(this._mCapabilities.FontSize){i.Format.FontSize=Number(e.fontSize)}if(this._mCapabilities.HeaderFooter&&e.showPageNumber){i.Footer={Center:{Type:"PAGENUM"}}}if(this._mCapabilities.Signature){i.Signature={DoSign:e.signature,Reason:e.signatureReason}}if(this._mCapabilities.TextDirectionLayout){i.Format.TextDirectionLayout=n.getRTL()?"RTL":"LTR"}if(this._mCapabilities.Treeview&&t.hierarchyLevel&&t.drillState){if(o===2){i.Hierarchy={DistanceFromRootElement:t.hierarchyLevel,DrillStateElement:t.drillState}}else{i.Format.TableFormat="TREE"}}if(this._mCapabilities.UploadToFileShare&&this._mCloudFileInfo){i.FileName=this._mCloudFileInfo.FileShareItemName;i.FileShare={Repository:this._mCloudFileInfo.FileShare,Folder:this._mCloudFileInfo.ParentFileShareItem};e.dataSource.headers["SAP-Upload-To-File-Share"]=true}t.columns.filter((e,t,o)=>{const i=Array.isArray(e.property)?e.property[0]:e.property;if(!i){return false}return o.findIndex(e=>{const t=Array.isArray(e.property)?e.property[0]:e.property;return i===t})===t}).forEach(e=>{const t={Name:Array.isArray(e.property)?e.property[0]:e.property,Header:e.label};if(this._mCapabilities.IANATimezoneFormat&&e.type===d.DateTime){t.Format={DisplayFormat:o==2?"IANATSSHOR":"IANA-Timestamp-Short"};if(e.timezoneProperty){t.Format.IANATimezoneProperty=e.timezoneProperty}else if(e.timezone){t.Format.IANATimezone=e.timezone}}i.TableColumns.push(t)});return i};f.prototype._getEntitySetName=function(e){let t;const o=e?.version||2;if(this._mCapabilities&&typeof this._mCapabilities.DocumentDescriptionCollection==="string"){t=this._mCapabilities.DocumentDescriptionCollection}return t||(o==4?"MyDocumentDescriptions":"SAP__MyDocumentDescriptions")};f.prototype._getModel=function(e){const t=e.version||2;return t===4?new l({serviceUrl:e.commonServiceUrl}):this._oModel};f.prototype._showWarning=function(t){let o=Promise.resolve();const i={rows:t.dataSource.count,rowLimit:this._mCapabilities.ResultSizeMaximum,fileType:p.PDF};if(isNaN(i.rows)||i.rows>i.rowLimit){o=e.showWarningDialog(i)}return o};f.showErrorMessage=async t=>{const i=await o.getResourceBundle();if(!t){return}if(typeof t.text==="function"){t.text().then(t=>{e.showErrorMessage(t)}).catch(()=>{e.showErrorMessage(i.getText("PDF_GENERIC_ERROR"))})}else if(t.message){e.showErrorMessage(t.message)}};f.prototype._applyResultSize=function(e){const t=parseInt(this._mCapabilities.ResultSizeMaximum);if(!isNaN(t)&&t>0){const o=new URL(e);o.search+="&$top="+t;e=o.toString()}return e};f.prototype.setDefaultExportSettings=function(e){let t=e?.workbook?.context;if(!(t instanceof Object)){t=e.workbook.context={}}if(typeof t.title==="string"&&t.title){return Promise.resolve()}return o.getResourceBundle().then(e=>{t.title=e.getText("XLSX_DEFAULT_TITLE")})};f.prototype.postDocumentDescription=function(e,t){const o=this._getModel(t);const i="/"+this._getEntitySetName(t);if(!o?.isA(["sap.ui.model.odata.v4.ODataModel","sap.ui.model.odata.v2.ODataModel"])){throw new Error("Unsupported Model")}if(o.isA("sap.ui.model.odata.v4.ODataModel")){const t=o.bindList(i);const r=t.create(e);return r.created().then(()=>r.getObject()["Id"])}else{return new Promise((t,r)=>{o.create(i,e,{groupId:"documentDescription",success:e=>{t(e["Id"])},error:r})})}};f.prototype.createBuildPromise=async function(e){const t=await o.getResourceBundle();const i=this._createDocumentDescription(e);let r=new a("PDFExportBusyDialog",{title:t.getText("PROGRESS_TITLE"),text:t.getText("PDF_GENERATION_IN_PROGRESS"),showCancelButton:true,close:e=>{if(e.getParameter("cancelPressed")){this.cancel()}r.destroy();r=null}});r.open();try{await this._showWarning(e);this._request=new AbortController;const t=await this.postDocumentDescription(i,e.dataSource);const r=await this.sendRequest(e.dataSource,t);o.saveAsFile(r,e.fileName);o.announceExportStatus(h.FINISHED,{assertive:true})}catch(e){f.showErrorMessage(e)}r?.destroy()};f.prototype.sendRequest=async function(e,t){if(this._request?.signal.aborted){throw null}e.dataUrl=this._applyResultSize(e.dataUrl);const o=e.useBatch?f.createBatchRequest(e,t,this._request):f.createGetRequest(e,t,this._request);try{let t=await fetch(o);if(e.useBatch){t=await f.getBatchResponse(t)}if(t.status===301&&t.headers.has("Location")){u(t.headers.get("Location"),"_blank");return undefined}if(t.ok){return t.blob()}else{throw t.text()}}catch(e){if(e.name==="AbortError"){throw null}else{throw e}}};f.harmonizeUrl=function(e){return e.endsWith("/")?e:e+"/"};f.createGetRequest=function(e,t,o){const i=new Headers(e.headers);i.set("Accept",m);i.set("SAP-Document-Description-Id",t);return new Request(e.dataUrl,{signal:o.signal,headers:i})};f.createBatchRequest=function(e,t,o){const i=e.dataUrl.split(e.serviceUrl)[1];const r="batch_"+f._createGuid();const n=new Headers(e.headers);n.set("Accept",m);n.set("SAP-Document-Description-Id",t);const s=f.createRequestBody(i,r,n);n.set("Accept","multipart/mixed");n.set("Content-Type","multipart/mixed;boundary="+r);n.delete("SAP-Document-Description-Id");n.delete("SAP-Upload-To-File-Share");return new Request(e.serviceUrl+"$batch",{body:s,cache:"no-store",headers:n,method:"POST",signal:o.signal})};f.createRequestBody=function(e,t,o){const i=[];i.push("--"+t);i.push("Content-Type: application/http");i.push("Content-Transfer-Encoding: binary");i.push("");i.push(`GET ${e} HTTP/1.1`);for(const[e,t]of o.entries()){i.push(e+":"+t)}i.push("");i.push("");i.push("--"+t+"--");i.push("");return i.join("\r\n")};f.getBatchResponse=async function(e){if(!e.ok){return e}const t=await e.arrayBuffer();const o=new Uint8Array(t);const{status:i,statusText:r,headers:n,pdfContent:s}=f.parseResponseBody(o);return new Response(s,{status:i,statusText:r,headers:n})};f.getStartIndex=function(e){return e.findIndex((t,o)=>{const i="%PDF-";return t===i.charCodeAt(0)&&e[o+1]===i.charCodeAt(1)&&e[o+2]===i.charCodeAt(2)&&e[o+3]===i.charCodeAt(3)&&e[o+4]===i.charCodeAt(4)})};f.getEndIndex=function(e){return e.findLastIndex((t,o)=>{const i="%%EOF";return t===i.charCodeAt(4)&&e[o-1]===i.charCodeAt(3)&&e[o-2]===i.charCodeAt(2)&&e[o-3]===i.charCodeAt(1)&&e[o-4]===i.charCodeAt(0)})};f.parseResponseBody=function(e){let t;const o=f.getStartIndex(e);const i=f.getEndIndex(e);if(o!==-1&&i!==-1){t=e.subarray(o,i+1)}const r=(new TextDecoder).decode(e.subarray(0,o));const n=r.split("\r\n");n.splice(0,n.findIndex(e=>/^HTTP\/1\.[0|1] ([1-9][0-9]{2})/.test(e)));const[,s,a]=n[0].match(/^HTTP\/1\.[0|1] ([1-9][0-9]{2}) ?([\w ]*)$/);const c=/^([\w\-]+): ?(.+)$/;const l=n.filter(e=>c.test(e)).reduce((e,t)=>{const[,o,i]=t.match(c);e.set(o,i);return e},new Headers);return{status:s,statusText:a,headers:l,pdfContent:t}};f._createGuid=function(){if(globalThis.crypto?.randomUUID){return globalThis.crypto.randomUUID()}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=Math.random()*16|0,o=e==="x"?t:t&3|8;return o.toString(16)})};f.prototype.getMimeType=function(){return m};f.prototype.cancel=function(){this._request?.abort()};f.prototype.destroy=function(){t.prototype.destroy.apply(this,arguments);this._request=null;this._oModel=null};return f});
//# sourceMappingURL=PortableDocument.js.map