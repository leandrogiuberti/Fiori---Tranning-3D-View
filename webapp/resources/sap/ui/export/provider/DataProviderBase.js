/*!
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
(function(t){"use strict";if(typeof globalThis.sap?.ui?.define==="function"){globalThis.sap.ui.define([],t,true)}else{globalThis.DataProviderBase=t()}})(function(){"use strict";const t=function(e){this.mSettings=e;this.bCanceled=false;this.iAvailableRows=0;this.mRequest=null;this.iCount=Math.min(e.dataSource.count||t.MAX_ROWS,t.MAX_ROWS);this.iTotalRows=e.dataSource.downloadLimit??t.MAX_ROWS;this.iBatchSize=Math.min(e.dataSource.sizeLimit||t.MAX_ROWS,this.iTotalRows);this.fnConvertData=t.getDataConverter(e);this._prepareDataUrl()};t.MAX_ROWS=1048575;t.HTTP_ERROR_MSG="HTTP connection error";t.HTTP_WRONG_RESPONSE_MSG="Unexpected server response:\n";t._createGuid=function(){if(globalThis.crypto?.randomUUID){return globalThis.crypto.randomUUID()}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=Math.random()*16|0,n=t==="x"?e:e&3|8;return n.toString(16)})};t.getColumnsToConvert=function(t){return t.reduce(function(t,e){const n=e.property instanceof Array?e.property:[e.property];if(e.unitProperty){n.push(e.unitProperty)}n.forEach(function(e){const n=e.split("/");if(n.length>1){t.push({property:e,keys:n})}});return t},[])};t.getDataConverter=function(e){let n=e.workbook.columns;if(e.workbook.hierarchyLevel){n=n.concat([{property:e.workbook.hierarchyLevel}])}const s=this.getColumnsToConvert(n);return function(e){return t._convertData(e,s)}};t._convertData=function(e,n){n.forEach(function(n){e.forEach(function(e){e[n.property]=t._getValue(e,n)})});return e};t._getValue=function(t,e){const n=e.keys.reduce(function(t,e){return t&&t[e]},t);return n};t.prototype.requestData=function(t){const e=this.mSettings.dataSource;this.fnProcessCallback=t;this.mRequest={serviceUrl:this._cleanUrl(e.serviceUrl),dataUrl:this._getUrl(0,this.iBatchSize),useBatch:e.useBatch,headers:e.headers};this.sendRequest(this.mRequest).then(this.fnOnDataReceived.bind(this)).catch(this.fnOnError.bind(this));return{cancel:function(){this.bCanceled=true;if(this._oPendingRequest instanceof AbortController){this._oPendingRequest.abort()}}.bind(this)}};t.prototype.fnOnDataReceived=async function(e){this._oPendingRequest=null;if(this.bCanceled){return}const{data:n,nextUrl:s}=await t.getHarmonizedBodyFrom(e);const r=this.mRequest?.dataUrl.includes("$skiptoken");const i=n.length;this.iAvailableRows+=i;const o=this.iTotalRows-this.iAvailableRows;const a={};a.finished=this._isFinished(i,s,o,r);a.progress=this.iTotalRows;a.total=this.iTotalRows<this.iCount?this.iTotalRows:this.iCount;a.fetched=this.iAvailableRows;if(!a.finished){this.mRequest.dataUrl=this._getUrl(this.iAvailableRows,Math.min(this.iBatchSize,o),s);this.sendRequest(this.mRequest).then(this.fnOnDataReceived.bind(this)).catch(this.fnOnError.bind(this))}if(i<this.iBatchSize&&s){this.iBatchSize=i}a.rows=this.fnConvertData(n);this.fnProcessCallback(a)};t.prototype._isFinished=function(t,e,n,s){if(t===0||n<=0){return true}if(t===this.iBatchSize){return false}if(e){return false}if(t<this.iBatchSize&&s){return false}return true};t.prototype.fnOnError=function(t){this.fnProcessCallback({error:t})};t.prototype._cleanUrl=function(t){if(!t){return""}const e=new URL(t);e.hash=e.search="";e.pathname+=e.pathname.endsWith("/")?"":"/";return e.toString()};t.prototype._prepareDataUrl=function(){const t=this.mSettings.dataSource;const e=/\$skip\=[0-9]+/,n=/\$top\=[0-9]+/;if(!t.dataUrl){throw"Unable to load data - no URL provided."}const s=new URL(t.dataUrl);s.search=s.search||"";if(!e.test(s.search)){s.search+=(s.search.length?"&$skip=":"$skip=")+0}if(!n.test(s.search)){s.search+="&$top="+0}this.mSettings.dataSource.dataUrl=s.toString()};t.prototype._getUrl=function(t,e,n){const s=new URL(this.mSettings.dataSource.dataUrl);if(n){const t=new URL(n,s.origin);s.search=t.search}else{s.search=(s.search||"").replace(/\$skip\=[0-9]+/g,"$skip="+t).replace(/\$top\=[0-9]+/g,"$top="+e)}return s.toString()};t.prototype.sendRequest=async function(e){if(typeof e!=="object"||e===null||typeof e.dataUrl!=="string"){throw new Error("Unable to send request - Mandatory parameters missing.")}const n=e.useBatch&&e.serviceUrl;const s=new AbortController;const r=n?t.createBatchRequest(e,s):t.createGetRequest(e,s);let i;try{this._oPendingRequest=s;i=await fetch(r)}catch(t){this._oPendingRequest=null;if(t.name==="AbortError"){throw null}else{throw t}}i=n?await t.getBatchResponse(i):i;if(!i.ok){const e=await i.text();throw new Error(t.HTTP_WRONG_RESPONSE_MSG+e)}return i};t.createGetRequest=function(t,e){const n=new Headers(t.headers);n.set("Accept","application/json");return new Request(t.dataUrl,{cache:"no-store",headers:n,signal:e.signal})};t.createBatchRequest=function(e,n){const s=e.dataUrl.split(e.serviceUrl)[1];const r="batch_"+t._createGuid();const i=new Headers(e.headers);const o=t.createRequestBody(s,r,i);i.set("Accept","multipart/mixed");i.set("Content-Type","multipart/mixed;boundary="+r);return new Request(e.serviceUrl+"$batch",{body:o,cache:"no-store",headers:i,method:"POST",signal:n.signal})};t.createRequestBody=function(t,e,n){const s=[];s.push("--"+e);s.push("Content-Type: application/http");s.push("Content-Transfer-Encoding: binary");s.push("");s.push(`GET ${t} HTTP/1.1`);s.push("Accept:application/json");for(const[t,e]of n.entries()){if(t!="accept"){s.push(t+":"+e)}}s.push("");s.push("");s.push("--"+e+"--");s.push("");return s.join("\r\n")};t.getBatchResponse=async function(e){const n=await e.text();if(!e.ok){throw new Error(t.HTTP_WRONG_RESPONSE_MSG+n)}const s=n.split("\r\n");s.splice(0,s.findIndex(t=>/^HTTP\/1\.[0|1] ([1-9][0-9]{2})/.test(t)));const[,r,i]=s[0].match(/^HTTP\/1\.[0|1] ([1-9][0-9]{2}) ?([\w ]*)$/);const o=s.find(t=>t.startsWith("{")&&t.endsWith("}"));const a=/^([\w\-]+): ?([\d\w\./]+)/;const c=s.filter(t=>a.test(t)).reduce((t,e)=>{const[,n,s]=e.match(a);t.set(n,s);return t},new Headers);return new Response(o,{status:r,statusText:i,headers:c})};t.getHarmonizedBodyFrom=async function(t){const e={data:[]};if(!t){return e}const n=await t.json();if(!n){return e}const s=n.value||n.d?.results||n.d||n;e.nextUrl=n["@odata.nextLink"]??n.d?.__next;if(Array.isArray(s)){e.data=s}return e};return t});
//# sourceMappingURL=DataProviderBase.js.map