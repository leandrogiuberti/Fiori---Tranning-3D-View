/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/ui/base/SyncPromise","sap/ui/core/Lib","sap/ui/core/Rendering","sap/ui/thirdparty/jquery"],function(e,t,r,n,s,jQuery){"use strict";var a=/\/\$batch($|\?)/,i=/(?:^|\r\n)Content-Id\s*:\s*(\S+)/i,o=/ \$([^ ?\/]+)/,u=/\.json$/i,c=/\.xml$/i,f=/^(.*)?:\s*(.*)$/,l="application/json;charset=UTF-8;IEEE754Compatible=true",d={},p="\r\nContent-Type: application/http\r\n"+"Content-Transfer-Encoding: binary\r\n",h=/^Content-Type:\s*multipart\/mixed;\s*boundary=/i,y=new URLSearchParams(window.location.search),g=y.get("autoRespondAfter"),m=y.get("realOData"),E=/^(\S+) (\S+)$/,x=/^(GET|DELETE|MERGE|PATCH|POST) (\S+) HTTP\/1\.1$/,v={},T=/^(OData-Version|DataServiceVersion)$/,b=m==="true"||m==="direct",R=null,q=/[ "[\]{}]/g,w=/%(20|22|5B|5D|7B|7D)/gi,O=/^\w+ /,S=/(^|\/)resources\/(~[-a-zA-Z0-9_.]*~\/)?/,A;if(b){document.title+=" (real OData)"}function C(e){return sap.ui.require.toUrl(e).replace(S,"$1test-resources/")+"/"}function D(e){if(c.test(e)){return"application/xml"}if(u.test(e)){return l}return"application/x-octet-stream"}function k(e,t,r){var n=QUnit.objectType(e),s=QUnit.objectType(t),a;if(n==="string"&&s==="regexp"){if(!t.test(e)){throw new Error(r+": actual value "+e+" does not match expected regular expression "+t)}return}if(n!==s){throw new Error(r+": actual type "+n+" does not match expected type "+s)}if(n==="array"){if(e.length<t.length){throw new Error(r+": array length: "+e.length+" < "+t.length)}}if(n==="array"||n==="object"){for(a in t){k(e[a],t[a],r==="/"?r+a:r+"/"+a)}}else if(e!==t){throw new Error(r+": actual value "+e+" does not match expected value "+t)}}function M(e,t,r,n){try{k(e,t,"/");QUnit.assert.pushResult({result:n,actual:e,expected:t,message:r})}catch(s){QUnit.assert.pushResult({result:!n,actual:e,expected:t,message:(r||"")+" failed because of "+s.message})}}A={awaitRendering:function(){return new Promise(function(e){function t(){if(s.isPending()){setTimeout(t,1)}else{e()}}t()})},checkGetAndRequest:function(e,t,n,s,a,i){var o,u=s.replace("fetch","get"),c=e.mock(Promise),f=new Error("rejected"),l=Promise.reject(f),d=s.replace("fetch","request"),p={},h=r.resolve(l);o=e.mock(t).expects(s).exactly(4);o=o.withExactArgs.apply(o,a);o.returns(r.resolve(p));n.strictEqual(t[u].apply(t,a),p);o.returns(h);c.expects("resolve").withExactArgs(sinon.match.same(h)).returns(l);n.strictEqual(t[d].apply(t,a),l);c.restore();if(i){n.throws(function(){t[u].apply(t,a)},new Error("Result pending"))}else{n.strictEqual(t[u].apply(t,a),undefined,"pending")}return h.catch(function(){if(i){n.throws(function(){t[u].apply(t,a)},f)}else{n.strictEqual(t[u].apply(t,a),undefined,"rejected")}})},deepContains:function(e,t,r){M(e,t,r,true)},encodeReadableUrl:function(e){return e.replaceAll(q,e=>`%${e.charCodeAt(0).toString(16).padStart(2,"0").toUpperCase()}`)},makeUrlReadable:function(e){return e.replaceAll(w,(e,t)=>String.fromCharCode(Number.parseInt(t,16)))},notDeepContains:function(e,t,r){M(e,t,r,false)},requestAllSources:function(e,t,r){r=C(r||"sap/ui/core/qunit/odata/v4/data");const n=new Map;function s(e){if(Array.isArray(e)){e.forEach(s)}else if(e.source){let t=n.get(e.source);if(!t){t=fetch(r+e.source).then(e=>e.text());n.set(e.source,t)}t.then(t=>{e.message=t;e.headers??={};e.headers["Content-Type"]||=D(e.source);delete e.source},()=>{})}}Object.values(e).forEach(s);t?.forEach(e=>{s(e.response)});return Promise.all(Array.from(n.values())).then(()=>{})},useFakeServer:function(r,n,s,u,c,y){var m,E;function v(e,t){var r=j(e,t.requestBody),n=H(t);if(R){R(t.requestBody,t.method+" "+t.url)}t.respond(200,jQuery.extend({},n,{"Content-Type":"multipart/mixed;boundary="+r.boundary}),k(r,n))}function b(e){var t={buildResponse:e.buildResponse,code:e.code||200,headers:e.headers||{},ifMatch:e.ifMatch};if(e.source){t.message=$(n+e.source);t.headers["Content-Type"]||=D(e.source)}else if(typeof e.message==="object"){t.headers["Content-Type"]=l;t.message=JSON.stringify(e.message)}else{t.message=e.message}return t}function q(){var e,t,r={};for(t in s){e=s[t];let n="GET ";const a=O.exec(t);if(a){n=a[0];t=t.slice(n.length)}t=n+A.encodeReadableUrl(t);if(Array.isArray(e)){r[t]=e.map(b)}else{r[t]=[b(e)]}}return r}function w(t,r,n){e.error(r.method+" "+A.makeUrlReadable(r.url),n,"sap.ui.test.TestUtils");return{code:t,headers:{"Content-Type":l},message:JSON.stringify({error:{code:"TestUtils",message:n instanceof Error?n.message:n}})}}function S(e){return e.slice(0,e.indexOf("\r\n"))}function k(e,t){var r=[""];e.parts.every(function(e){r.push(e.boundary?"\r\nContent-Type: multipart/mixed;boundary="+e.boundary+"\r\n\r\n"+k(e,t):M(e,t));return!e.code||e.code<400||t.DataServiceVersion==="2.0"});r.push("--\r\n");return r.join("--"+e.boundary)}function M(e,t){var r=jQuery.extend({},t,e.headers);return p+(e.contentId?"Content-ID: "+e.contentId+"\r\n":"")+"\r\nHTTP/1.1 "+e.code+" \r\n"+Object.keys(r).map(function(e){return e+": "+r[e]}).join("\r\n")+"\r\n\r\n"+(e.message||"")+"\r\n"}function U(t,r){var n,s,a=t+" "+r;if(E[a]){return{responses:E[a]}}if(!m){return undefined}n=[];s=m.filter(function(e){var t=a.match(e.regExp);if(t){n.push(t)}return t});if(s.length>1){e.warning("Multiple matches found for "+a,undefined,"sap.ui.test.TestUtils");return undefined}return s.length?{responses:s[0].response,match:n[0]}:undefined}function H(e){var t,r={};for(t in e.requestHeaders){if(T.test(t)){r[t]=e.requestHeaders[t]}}return r}function P(r,n,s,a){var i,u=U(r.method,r.url),c,f=u&&u.responses;f=(f||[]).filter(function(e){if(typeof e.ifMatch==="function"){return e.ifMatch(r)}return!e.ifMatch||e.ifMatch.test(r.requestBody)});if(f.length){c=f[0];if(typeof c.buildResponse==="function"){c=t({},c);try{const e=o.exec(r.requestLine);let t;if(e){t=a[e[1]]}c.buildResponse(u.match,c,r,t)}catch(e){c=w(500,r,e)}}if(u.responses.length>1){i=u.responses.indexOf(c)}}else if(!y&&!s){switch(r.method){case"HEAD":c={code:200};break;case"DELETE":case"MERGE":case"PATCH":c={code:204};break;case"POST":c={code:200,headers:{"Content-Type":l},message:r.requestBody};break}}if(c){const t=r.method+" "+A.makeUrlReadable(r.url);e.info(t+(i!==undefined?", alternative (ifMatch) #"+i:""),'{"If-Match":'+JSON.stringify(r.requestHeaders["If-Match"])+"}","sap.ui.test.TestUtils");if(c.message){e.debug(t,c.message,"sap.ui.test.TestUtils")}}else if(s){return undefined}else{c=w(404,r,"No mock data found")}c.headers=jQuery.extend({},H(r),c.headers);if(n&&c.code<300){c.contentId=n;if(a){a[n]=c.message}}return c}function j(e,t,r={}){t=t.replace(/^\s+/,"");const n=S(t);return{boundary:S(t).slice(2),parts:t.split(n).slice(1,-1).map(function(t){var n,s,a,o,u,c;t=t.slice(2);s=S(t);if(h.test(s)){o=j(e,t.slice(s.length+4),r);n=o.parts.filter(function(e){return e.code>=300});return n.length?n[0]:o}c=t.indexOf("\r\n\r\n")+4;u=F(e,t.slice(c));a=i.exec(t.slice(0,c));return P(u,a&&a[1],false,r)})}}function F(e,t){var r=t.indexOf("\r\n\r\n"),n,s,a={requestHeaders:{}};a.requestBody=t.slice(r+4,t.length-2);t=t.slice(0,r);n=t.split("\r\n");a.requestLine=n.shift();s=x.exec(a.requestLine);if(s){a.method=s[1];a.url=e+s[2];n.forEach(function(e){const t=f.exec(e);if(t){a.requestHeaders[t[1]]=t[2]}})}return a}function L(e){var t=e.url;if(a.test(t)){if(!B(e,true)){v(t.slice(0,t.indexOf("/$batch")+1),e)}}else{B(e)}}function $(e){var t=d[e];if(!t){jQuery.ajax({async:false,url:e,dataType:"text",success:function(e){t=e}});if(!t){throw new Error(e+": resource not found")}d[e]=t}return t}function B(e,t){var r=P(e,undefined,t);if(!r){return false}if(R){R(e.requestBody,e.method+" "+e.url)}e.respond(r.code,r.headers,r.message);return true}function G(){var e,t;E=q();if(u){m=u.map(function(e){return{regExp:e.regExp,response:Array.isArray(e.response)?e.response.map(b):[b(e.response)]}})}t=sinon.fakeServer.create();if(r.getFakes){r.getFakes().push(t)}else{r.add(t)}t.autoRespond=true;if(g){t.autoRespondAfter=parseInt(g)}t.respondWith("GET",/./,B);t.respondWith("DELETE",/./,B);t.respondWith("HEAD",/./,B);t.respondWith("PATCH",/./,B);t.respondWith("MERGE",/./,B);t.respondWith("POST",/./,L);e=t.restore;t.restore=function(){sinon.FakeXMLHttpRequest.filters=[];e.apply(this,arguments)};sinon.xhr.supportsCORS=jQuery.support.cors;sinon.FakeXMLHttpRequest.useFilters=true;sinon.FakeXMLHttpRequest.addFilter(function(e,t){var r=U(e,t)||(c?t.startsWith(c)||a.test(t):e==="DELETE"||e==="HEAD"||e==="MERGE"||e==="PATCH"||e==="POST");return!r});return t}n=C(n);return G()},withNormalizedMessages:function(e){var t;if(sinon.createSandbox){t=sinon.createSandbox()}else{t=sinon.sandbox.create()}try{const r=n.prototype._loadResourceBundle;t.stub(n.prototype,"_loadResourceBundle").callsFake(function(){var e=r.apply(this,[arguments[0],true]);return{getText:function(t,r){var n=t,s=e.getText(t),a;for(a=0;a<10;a+=1){if(s.indexOf("{"+a+"}")>=0){n+=" "+(a>=r.length?"{"+a+"}":r[a])}}return n}}});e.apply(this)}finally{t.verifyAndRestore()}},isRealOData:function(){if(m==="proxy"){throw new Error("realOData=proxy is no longer supported")}return b},getRealOData:function(){return m?"&realOData="+m:""},onRequest:function(e){R=e},proxy:function(t){e.warning("#proxy is no longer supported",null,"sap.ui.test.TestUtils");return t},retrieveData:function(e){var t=v[e];delete v[e];return t},setData:function(e,t){v[e]=t},setupODataV4Server:function(e,t,r,n,s){if(this.isRealOData()){return}if(!n){n="/"}else if(n.slice(-1)!=="/"){n+="/"}A.useFakeServer(e,r||"sap/ui/core/qunit/odata/v4/data",A.normalizeFixture(t,n),s,n!=="/"?n:undefined)},normalizeFixture:function(e,t){var r={};Object.keys(e).forEach(function(n){var s=E.exec(n),a,i;if(s){a=s[1]||"GET";i=s[2]}else{a="GET";i=n}if(!i.startsWith("/")){i=t+i}r[a+" "+i]=e[n]});return r},spyFetch:function(e){var t=e.spy(XMLHttpRequest.prototype,"open");t.calledWithUrl=function(e){return t.getCall(e).args[1]};return t}};return A},true);
//# sourceMappingURL=TestUtils.js.map