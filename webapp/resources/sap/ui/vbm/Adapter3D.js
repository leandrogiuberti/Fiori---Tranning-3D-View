/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/core/Element","sap/ui/base/ManagedObjectObserver","sap/ui/unified/Menu","sap/ui/unified/MenuItem","sap/m/ResponsivePopover","sap/ui/vbm/Viewport","./adapter3d/ObjectFactory","./adapter3d/VBIJSONParser","./adapter3d/SceneBuilder","./adapter3d/Utilities","./adapter3d/DragDropHandler","./adapter3d/RectangleTracker","./adapter3d/ColladaBounds","sap/m/HBox","sap/m/VBox","sap/m/Link","sap/m/Button","sap/m/Text","sap/m/Image","./adapter3d/thirdparty/three","sap/base/Log","jquery.sap.global","./library"],function(e,t,i,o,n,r,a,s,l,c,p,h,u,d,f,v,_,m,y,g,w,jQuery,x){"use strict";var b=g.Vector2;var C=g.Vector3;var B=c.toBoolean;var A="sap.ui.vbm.Adapter3D";var I;var k=e.extend("sap.ui.vbm.Adapter3D",{metadata:{library:"sap.ui.vbm",associations:{viewport:{type:"sap.ui.vbm.Viewport"}},events:{submit:{parameters:{data:{type:"string"}}}}}});var S=k.getMetadata().getParent().getClass().prototype;k.prototype.init=function(){if(S.init){S.init.call(this)}this._viewport=null;this._context={resources:new Map,config:new Map,dataTypes:[],data:{},windows:[],scenes:[],actions:[],voQueues:{toAdd:new Map,toUpdate:new Map,toRemove:new Map,clear:function(){this.toAdd.clear();this.toUpdate.clear();this.toRemove.clear()}},sceneQueues:{toAdd:[],toUpdate:[],toRemove:[],clear:function(){this.toAdd.length=0;this.toUpdate.length=0;this.toRemove.length=0}},windowQueues:{toAdd:[],toUpdate:[],toRemove:[],clear:function(){this.toAdd.length=0;this.toUpdate.length=0;this.toRemove.length=0}},setupView:undefined};this._update=Promise.resolve();this._parser=null;this._sceneBuilder=null;this._hoverInstance=null;this._hoverTimeOutId=null;this._clickTimerId=null;this._mouseDown=false;this._lastXY={x:0,y:0};this._viewportObserver=new t(this._observeChanges.bind(this));this._detail={popover:undefined,anchor:undefined,pending:undefined};this._raycaster=new g.Raycaster;this._dragDropHandler=null;this._rectangleTracker=null;this._colladaBounds=null};k.prototype.exit=function(){if(this._clickTimerId){clearTimeout(this._clickTimerId);this._clickTimerId=null}if(this._hoverTimeOutId){clearTimeout(this._hoverTimeOutId);this._hoverTimeOutId=null}this._disconnectViewport();this._viewportObserver.disconnect();this._viewportObserver=null;if(this._dragDropHandler){this._dragDropHandler.destroy();this._dragDropHandler=null}if(this._rectangleTracker){this._rectangleTracker=null}if(this._colladaBounds){this._colladaBounds.destroy();this._colladaBounds=null}if(this._sceneBuilder){this._sceneBuilder.destroy();this._sceneBuilder=null}if(this._parser){this._parser.destroy();this._parser=null}this._detail=null;this._context=null;this._raycaster=null;this._hoverInstance=null;if(S.exit){S.exit.call(this)}};k.prototype.setViewport=function(e){this.setAssociation("viewport",e,true);this._configureViewport()};k.prototype._configureViewport=function(){var e=sap.ui.getCore().byId(this.getViewport())||null;if(e!==this._viewport){this._disconnectViewport();this._viewport=e;this._connectViewport();var t=this._viewport.getOrbitControl();t.setConfig(this._context.config);t.setUtilities(c)}};k.prototype._connectViewport=function(){if(this._viewport){this._viewportObserver.observe(this._viewport,{destroy:true});this._viewport.addEventDelegate(I,this);this._dragDropHandler=new p(this);this._colladaBounds=new u(this);this._rectangleTracker=new h(this)}};k.prototype._disconnectViewport=function(){if(this._viewport){this._dragDropHandler.destroy();this._dragDropHandler=null;this._colladaBounds=null;this._rectangleTracker=null;this._viewport.removeEventDelegate(I);I.onBeforeRendering.call(this);this._viewportObserver.unobserve(this._viewport,{destroy:true});this._viewport=null}};k.prototype._observeChanges=function(e){if(e.type==="destroy"&&e.object===this._viewport){this._disconnectViewport()}};k.prototype.load=function(e){var t=this;t._configureViewport();if(!t._viewport){return Promise.reject()}var i=null;if(!t._parser){t._parser=new s(t._context)}if(!t._sceneBuilder){t._sceneBuilder=new l(t._context,t._viewport)}if(typeof e==="string"){try{i=JSON.parse(e)}catch(e){w.error("attempt to load invalid JSON string","",A);return Promise.resolve()}}else if(typeof e==="object"){i=e}if(!(i&&i.SAPVB)){w.error("attempt to load null","",A);return Promise.resolve()}t._viewport.setBusy(true);t._update=t._update.then(function(){t._parser.loadVBIJSON(i);return t._sceneBuilder.synchronize()}).then(function(){t._processAutomation(i);t._processDetailWindow();t._context.voQueues.toRemove.forEach(function(e){e.forEach(function(e){if(t._hoverInstance===e){t._hoverInstance=null}},t)},t);if(t._colladaBounds){t._colladaBounds.initialize()}if(t._dragDropHandler){t._dragDropHandler.update()}t._viewport._resetBBox();t._viewport._updateCamera();t._context.voQueues.clear();t._context.sceneQueues.clear();t._context.windowQueues.clear();t._viewport.setBusy(false)});return t._update};k.prototype._processDetailWindow=function(e){var t=x.findInArray(this._context.windowQueues.toAdd,function(e){return e.type==="callout"});var i=t&&x.findInArray(this._context.scenes,function(e){return e.id===t.refScene});if(t&&i){this._closeDetailWindow();var o=this._createDetailWindow(t);this._fillDetailWindow(o,i);this._openDetailWindow(o,t)}};k.prototype._closeDetailWindow=function(){if(this._detail.popover){this._detail.popover.close();this._detail.popover.destroy();this._detail.popover=undefined}if(this._detail.anchor){this._detail.anchor.style.visibility="hidden"}};k.prototype._createDetailWindow=function(e){var t;if(e.caption!==""){var i=new sap.m.Text({width:"100%",textAlign:sap.ui.core.TextAlign.Center,text:e.caption,tooltip:e.caption});t=new sap.m.Bar({contentLeft:[i]})}var o=new sap.m.ResponsivePopover({placement:sap.m.PlacementType.Auto,showCloseButton:true,verticalScrolling:true,contentWidth:e.width+"px"});o.addStyleClass("sapUiVbmDetailWindow");if(t){o.setCustomHeader(t)}return o};k.prototype._getAnchor=function(e,t){if(!this._detail.anchor){var i=document.createElement("div");i.setAttribute("role",sap.ui.core.AccessibleRole.Note);i.classList.add("sapUiVbmDetailWindowAnchor");this._viewport.getDomRef().appendChild(i);this._detail.anchor=i}this._detail.anchor.style.left=e+"px";this._detail.anchor.style.top=t+"px";return this._detail.anchor};k.prototype._openDetailWindow=function(e,t){var i=t.pos.split(";");var o=new C(parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2]));if(!this._viewport.getDomRef()){if(this._detail.pending){this._detail.pending.popover.destroy()}this._detail.pending={world:o,popover:e}}else{var n=this._viewport.getDomRef().getBoundingClientRect();var r=this._viewport.worldToScreen(c.vbToThreeJs(o));r.x=c.clamp(r.x,5,n.width-5);r.y=c.clamp(r.y,5,n.height-5);e.openBy(this._getAnchor(r.x,r.y));e.attachAfterClose(function(){this._closeDetailWindow()}.bind(this));this._detail.popover=e}};k.prototype._openDetailPending=function(){if(this._detail.pending&&this._viewport.getDomRef()){var e=this._viewport.worldToScreen(c.vbToThreeJs(this._detail.pending.world));this._detail.pending.popover.openBy(this._getAnchor(e.x,e.y));this._detail.popover=this._detail.pending.popover;this._detail.pending=undefined}};k.prototype._fillDetailWindow=function(e,t){var i=function(e){var t;switch(e){case"1":t=sap.m.FlexJustifyContent.Start;break;case"2":t=sap.m.FlexJustifyContent.Center;break;case"4":t=sap.m.FlexJustifyContent.End;break;default:t=sap.m.FlexJustifyContent.Inherit;break}return t};var o=function(e){var t;switch(e.type){case"{00100000-2013-1000-1100-50059A6A47FA}":t=new m({text:e.vo.text,tooltip:e.vo.tooltip});t.addStyleClass("sapUiVbmDetailWindowBase sapUiVbmDetailWindowCaption");if(e.vo.level==="3"){t.addStyleClass("sapUiVbmDetailWindowCaption3")}break;case"{00100000-2013-1000-3700-AD84DDBBB31B}":t=new m({text:e.vo.text,tooltip:e.vo.tooltip});t.addStyleClass("sapUiVbmDetailwindowBase");break;case"{00100000-2013-1000-2400-D305F7942B98}":t=new v({text:e.vo.text,tooltip:e.vo.tooltip,href:e.vo.autoexecute?e.vo.reference:""});t.addStyleClass("sapUiVbmDetailWindowBase");break;case"{00100000-2013-1000-1200-855B919BB0E9}":t=new _({text:e.vo.text,tooltip:e.vo.tooltip});break;case"{00100000-2013-1000-2200-6B060A330B2C}":if(e.vo.image&&e.vo.image!==""){t=new y({src:c.makeDataUri(this._context.resources.get(e.vo.image)),tooltip:e.vo.tooltip})}break;default:w.error("attempt to create unknown element of detail window",e.type,A)}return t};var n=t.voGroups.map(function(e){return e.vos.map(function(t){return{type:e.type,vo:t}})}).reduce(function(e,t){return e.concat(t)}).sort(function(e,t){return parseInt(e.vo.top,10)-parseInt(t.vo.top,10)}).reduce(function(e,t){var i=t.vo.top?t.vo.top:"0";e[i]=e[i]||[];e[i].push(t);return e},{});var r=new f;for(var a in n){if(n.hasOwnProperty(a)){var s=new d({width:Math.max.apply(null,n[a].map(function(e){return parseInt(e.vo.right,10)}))+"px"});var l=0;n[a].sort(function(e,t){return parseInt(e.vo.left,10)-parseInt(t.vo.left,10)}).map(function(e){var t=[];if(parseInt(e.vo.left,10)-l>1){t.push(new d({width:parseInt(e.vo.left,10)-l+"px"}))}var n=new d({width:parseInt(e.vo.right,10)-parseInt(e.vo.left,10)+"px",justifyContent:i(e.vo.align)});l=parseInt(e.vo.right,10);n.addItem(o.bind(this)(e));t.push(n);return t},this).reduce(function(e,t){return e.concat(t)}).forEach(s.addItem,s);r.addItem(s)}}e.addContent(r)};k.prototype._processAutomation=function(e){var t=this;var n=function(e,r,a,s,l){var c=new o({text:r.text,enabled:r.disabled==="X"?false:true,startsSection:l,select:t._menuItemSelectionHandler.bind(t,r.id,a.instance,s,a.object)});if(r.MenuItem){var p=new i;l=false;[].concat(r.MenuItem).forEach(function(e){if(e.hasOwnProperty("Separator")){l=true}else{n(p,e,a,s,l);l=false}});c.setSubmenu(p)}e.addItem(c)};if(e&&e.SAPVB&&e.SAPVB.Automation&&e.SAPVB.Automation.Call&&e.SAPVB.Automation.Call){if(e.SAPVB.Automation.Call.handler&&e.SAPVB.Automation.Call.handler==="CONTEXTMENUHANDLER"){var r=[].concat(e.SAPVB.Automation.Call.Param).filter(function(e){return e.name==="x"});var a=[].concat(e.SAPVB.Automation.Call.Param).filter(function(e){return e.name==="y"});var s;if(r.length>0&&a.length>0){s=r[0]["#"]+" "+a[0]["#"]}if(e.SAPVB&&e.SAPVB.Menus&&e.SAPVB.Menus.Set){var l=[].concat(e.SAPVB.Menus.Set).filter(function(t){return t.Menu.id===e.SAPVB.Automation.Call.refID});if(l.length>0){var c=new i;var p=false;[].concat(l[0].Menu.MenuItem).forEach(function(t){if(t.hasOwnProperty("Separator")){p=true}else{n(c,t,e.SAPVB.Automation.Call,l[0].Menu.action,p);p=false}});var h=sap.ui.core.Popup.Dock;c.open(false,this._viewport,h.BeginTop,h.BeginTop,this._viewport,s,"fit fit")}}}}};k.prototype._menuItemSelectionHandler=function(e,t,i,o){var n={version:"2.0","xmlns:VB":"VB",Action:{id:e,instance:t,name:i,object:o}};this.fireSubmit({data:JSON.stringify(n)})};k.prototype._genericEventHandler=function(e,t){var i=c.parseKeyboardShortcut(this._context.config.has("HOME_VIEW")?this._context.config.get("HOME_VIEW"):"72");if(c.matchKeyboardShortcut(t,i)){this._viewport.applyCameraHome(false);return}var o=t.instance;var n=o?o.voGroup.id:t.voGroupId;var r=x.findInArray(this._context.actions,function(t){return t.refVO===n&&t.refEvent===e});if(r){var a=[];var s={version:"2.0","xmlns:VB":"VB",Action:{id:r.id,name:r.name,object:r.refVO,instance:o&&o.id?o.voGroup.datasource+"."+o.id:"",Params:{Param:a}}};if(r.name==="KEY_PRESS"){if(["Shift","Control","Alt","Meta"].indexOf(t.key)!==-1||[16,17,18,91].indexOf(t.code)!==-1){return}else{a.push({name:"code","#":t.keyCode},{name:"shift","#":t.shiftKey},{name:"ctrl","#":t.ctrlKey},{name:"alt","#":t.altKey},{name:"meta","#":t.metaKey})}}else if(t&&t.cursor){a.push({name:"x","#":t.cursor.x},{name:"y","#":t.cursor.y})}if(r.AddActionProperty){var l=[];[].concat(r.AddActionProperty).forEach(function(e){switch(e.name){case"pos":if(t.hitPoint){var i=c.threeJsToVb(t.hitPoint);l.push({name:e.name,"#":i.x.toFixed(5)+";"+i.y.toFixed(5)+";"+i.z.toFixed(5)})}break;case"zoom":var o=this._viewport._getCameraState();var n=this._sceneBuilder._getZoomFactor(o.position,o.target);l.push({name:e.name,"#":n.toFixed(5)});break;default:break}},this);if(l.length>0){s.Action.AddActionProperties={AddActionProperty:l}}}if(o&&e==="Click"&&t.selectionChanges){var p=o.voGroup.datasource,h;var u=c.getAttributeAlias(this._context,p,o.voGroup.keyAttributeName);s.Data={Merge:{N:[{name:o.voGroup.datasource,E:t.selectionChanges.selected.map(function(e){h={};h[u]=e.id||"";h["VB:s"]="true";return h}).concat(t.selectionChanges.deselected.map(function(e){h={};h[u]=e.id||"";h["VB:s"]="false";return h}))}]}}}this.fireSubmit({data:JSON.stringify(s)})}};k.prototype._propagateClick=function(e){this._genericEventHandler("Click",e)};k.prototype._propagateDoubleClick=function(e){this._genericEventHandler("DoubleClick",e)};k.prototype._propagateContextMenu=function(e){this._genericEventHandler("ContextMenu",e)};k.prototype._propagateKeyPress=function(e){this._genericEventHandler("KeyPress",e)};k.prototype._propogateHoverChange=function(e){this._genericEventHandler("HoverChange",e)};k.prototype._handleClick=function(e){var t=e.instance;w.trace("click","x: "+e.cursor.x+", y: "+e.cursor.y+", instance: "+(t?t.id:"")+", tooltip: "+(t?t.tooltip:""),A);this._extendEventWithSelection(e);if(e.selectionChanges){this._sceneBuilder.updateSelection(e.selectionChanges.selected,e.selectionChanges.deselected)}this._propagateClick(e)};k.prototype._handleDoubleClick=function(e){var t=e.instance;w.trace("double click","x: "+e.cursor.x+", y: "+e.cursor.y+", instance: "+(t?t.id:"")+", tooltip: "+(t?t.tooltip:""),A);this._propagateDoubleClick(e)};k.prototype._handleContextMenu=function(e){var t=e.instance;if(!t){e.voGroupId="Scene"}w.trace("context menu","x: "+e.cursor.x+", y: "+e.cursor.y+", instance: "+(t?t.id:"")+", tooltip: "+(t?t.tooltip:""),A);this._propagateContextMenu(e)};k.prototype._handleHover=function(e){var t;var i=e.instance||null;w.trace("hover","x: "+e.cursor.x+", y: "+e.cursor.y+", instance: "+(i?i.id:"")+", tooltip: "+(i?i.tooltip:""),A);if(i){t=i.tooltip;if(!t){t=i.text}}var o=this._viewport.getDomRef();if(o){if(t){o.setAttribute("title",t)}else{o.removeAttribute("title")}}if(i!==this._hoverInstance){clearTimeout(this._hoverTimeOutId);this._hoverTimeOutId=setTimeout(function(){this._propogateHoverChange(e);this._hoverTimeOutId=undefined}.bind(this),500);this._hoverInstance=i;if(this._sceneBuilder){this._sceneBuilder.updateHotInstance(this._hoverInstance)}}};k.prototype._handleKeyPress=function(e){w.trace("keypress",e.key,A);this._propagateKeyPress(e)};k.prototype._getXY=function(e){var t=this._viewport.getDomRef().getBoundingClientRect();return{x:(e.pageX||e.originalEvent.pageX)-window.pageXOffset-t.left,y:(e.pageY||e.originalEvent.pageY)-window.pageYOffset-t.top}};k.prototype._hitTest=function(e){var t=this._viewport.getScene();var i=this._viewport.getCamera();var o=e.cursor||this._getXY(e);var n=this._viewport.getDomRef().getBoundingClientRect();var r=new b(o.x/n.width*2-1,-o.y/n.height*2+1);this._raycaster.layers.set(0);this._raycaster.setFromCamera(r,i);var a=this._raycaster.intersectObjects(t.children,true);if(a&&a.length>0){var s=a[0],l=s.object,c=null;if(l){if(l._instanceHitTest instanceof Function){c=l._instanceHitTest(s)}else{c=s.object._sapInstance}return{info:s,point:s.point,instance:c}}}else if(this._context.scene){a=this._viewport._intersectMapPlane(this._raycaster);if(a&&a.length>0){return{instance:null,info:a[0],point:a[0].point}}}return undefined};k.prototype._extendEventWithCursor=function(e){e.cursor=e.cursor||this._getXY(e)};k.prototype._extendEventWithInstance=function(e){this._extendEventWithCursor(e);var t=this._hitTest(e);if(t){e.instance=t.instance;e.hitPoint=t.point}else{e.instance=null}};var D=3;I={onkeydown:function(e){if(!e.originalEvent.repeat){this._handleKeyPress(e)}},oncontextmenu:function(e){this._extendEventWithInstance(e);if(this._skipClick){this._skipClick=false;this._handleHover(e)}else{this._handleContextMenu(e)}},onmousedown:function(e){if(this._hoverTimeOutId){clearTimeout(this._hoverTimeOutId);this._hoverTimeOutId=null}this._mouseDown=true;this._extendEventWithCursor(e);w.trace("mousedown","x: "+e.cursor.x+", y: "+e.cursor.y,A);this._lastXY.x=e.cursor.x;this._lastXY.y=e.cursor.y},onmouseup:function(e){this._mouseDown=false},onhover:function(e){if(this._mouseDown){this._extendEventWithCursor(e);w.trace("hover","x: "+e.cursor.x+", y: "+e.cursor.y,A);if(Math.abs(this._lastXY.x-e.cursor.x)>D||Math.abs(this._lastXY.y-e.cursor.y)>D){this._skipClick=true}}else{this._extendEventWithInstance(e);this._handleHover(e)}},onmouseout:function(e){this._extendEventWithInstance(e);delete e.instance;this._handleHover(e)},onBeforeRendering:function(e){if(this._onhoverProxy){this._viewport.$().off("wheel",this._onhoverProxy);this._viewport.$().off("mousemove",this._onhoverProxy)}if(this._onpointerdownProxy){this._viewport.$().off("pointerdown",this._onpointerdownProxy)}if(this._onpointerupProxy){this._viewport.$().off("pointerup",this._onpointerupProxy)}},onAfterRendering:function(e){if(!this._onhoverProxy){this._onhoverProxy=I.onhover.bind(this)}this._viewport.$().on("wheel",this._onhoverProxy);this._viewport.$().on("mousemove",this._onhoverProxy);if(this._detail.anchor){this._viewport.getDomRef().appendChild(this._detail.anchor)}this._openDetailPending()}};I["ontap"]=function(e){w.trace("onclick","",A);this._extendEventWithInstance(e);if(this._skipClick){this._skipClick=false;this._handleHover(e)}else if(this._clickTimerId){clearTimeout(this._clickTimerId);this._clickTimerId=null;this._handleDoubleClick(e)}else{this._clickTimerId=setTimeout(function(){this._clickTimerId=null;this._handleClick(e)}.bind(this),200)}};var P=sap.ui.Device.os.macintosh?"metaKey":"ctrlKey";k.prototype._extendEventWithSelection=function(e){var t=e.instance;if(t){if(e.originalEvent.type==="click"){if(!(e[P]&&e.shiftKey)){var i;var o;if(e[P]){i="toggle";o=false}else if(e.shiftKey){i="select";o=false}else{i="select";o=true}e.selectionChanges=this._changeSelection(t,i,o)}}else{e.selectionChanges=this._changeSelection(t,"toggle",false)}}};k.prototype._changeSelection=function(e,t,i){var o=[];var n=[];var r=e.voGroup;var a=B(e["VB:s"]);var s;if(t==="select"){if(r.maxSel!=="0"){if(a){if(i){s=r.selected.indexOf(e);n=r.selected.splice(s+1).concat(r.selected.splice(0,s))}}else{if(i||r.maxSel==="1"){n=r.selected.splice(0)}r.selected.push(e);o=[e]}}}else if(t==="toggle"){if(a){if(r.minSel==="0"||r.selected.length>1){s=r.selected.indexOf(e);n=r.selected.splice(s,1)}}else if(r.maxSel!=="0"){if(r.maxSel==="1"){n=r.selected.splice(0)}r.selected.push(e);o=[e]}}o.forEach(function(e){e["VB:s"]="true"});n.forEach(function(e){e["VB:s"]="false"});return{selected:o,deselected:n}};k.prototype.enableRectangularSelection=function(){this._rectangleTracker=new h(this);this._rectangleTracker._createEvent()};k.prototype.disableRectangularSelection=function(){this._rectangleTracker._destroy()};return k});
//# sourceMappingURL=Adapter3D.js.map