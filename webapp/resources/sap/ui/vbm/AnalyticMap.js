/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["./GeoMap","./VoBase","sap/ui/core/theming/Parameters","jquery.sap.global","sap/base/Log","./library","./AnalyticMapRenderer"],function(e,t,i,jQuery,o,r,n){"use strict";var a=e.extend("sap.ui.vbm.AnalyticMap",{metadata:{library:"sap.ui.vbm",properties:{},aggregations:{regions:{type:"sap.ui.vbm.Region",multiple:true,singularName:"region"}},events:{regionClick:{parameters:{code:{type:"string"}}},regionContextMenu:{parameters:{code:{type:"string"}}},regionSelect:{},regionDeselect:{}}},renderer:n});a.DefaultABAPGeoJSONURL="/sap/bc/vbi/geojson/L0.json";a.DefaultGeoJSONURL="media/analyticmap/L0.json";a.DefaultRegionSelectColor="RHLSA(0;1;1;1)";a.DefaultHotDeltaColor="RHLSA(0;1;1;1.0)";var s="0.6";let l=i.get({name:["_sap_ui_vbm_shared_ChoroplethRegionBG","_sap_ui_vbm_shared_ChoroplethRegionBorder","_sap_ui_vbm_shared_ChartDataPointBorderHoverSelectedColor","_sap_ui_vbm_shared_ChartDataPointNotSelectedBackgroundOpacity"]});a.DefaultRegionColor=l?l["_sap_ui_vbm_shared_ChoroplethRegionBG"]:"rgb(213,218,221)";a.DefaultRegionColorBorder=l?l["_sap_ui_vbm_shared_ChoroplethRegionBorder"]:"rgb(255,255,255)";a.AltBorderColor=l?l["_sap_ui_vbm_shared_ChartDataPointBorderHoverSelectedColor"]:"#676767";s=l?l["_sap_ui_vbm_shared_ChartDataPointNotSelectedBackgroundOpacity"]:"0.6";a.DefaultRegionNonSelectColor="RHLSA(0;1;1;"+s+")";a.prototype.exit=function(){e.prototype.exit.apply(this,arguments);this.detachEvent("submit",a.prototype.onAnalyticsSubmit,this)};a.prototype.onAfterRendering=function(){sap.ui.vbm.VBI.prototype.onAfterRendering.apply(this,arguments)};a.prototype.destroyRegions=function(){this.mbRegionsDirty=true;this.destroyAggregation("regions")};a.prototype.addRegion=function(e){this.mbRegionsDirty=true;this.addAggregation("regions",e)};a.prototype.removeRegion=function(e){this.mbRegionsDirty=true;this.removeAggregation("regions",e)};a.prototype.insertRegion=function(e,t){this.mbRegionsDirty=true;this.insertAggregation("regions",e,t)};a.prototype.removeAllRegions=function(){this.mbRegionsDirty=true;this.removeAllAggregation("regions")};a.prototype.destroyLegend=function(){this.mbLegendDirty=true;this.destroyAggregation("legend")};a.prototype.setLegend=function(e){this.mbLegendDirty=true;this.setAggregation("legend",e)};a.prototype.onAnalyticsSubmit=function(e){var t=JSON.parse(e.mParameters.data);var i,o,r;switch(t.Action.name){case"RGN_CONTEXTMENU":i=t.Action.instance.split(".")[1];r={code:i};if(o=this.findRegionInAggregation(i)){o.fireContextMenu(r)}this.fireRegionContextMenu(r);break;case"RGN_CLICK":i=t.Action.instance.split(".")[1];r={code:i};if(o=this.findRegionInAggregation(i)){o.fireClick(r)}this.fireRegionClick(r);if(t.Data&&t.Data.Merge){this.setSelectionPropFireSelect(t.Data.Merge)}break;default:break}};a.prototype.init=function(){this.mProperties.scaleVisible=false;e.prototype.init.apply(this,arguments);this.mbRegionsDirty=false;this.mbLegendDirty=false;this.mbThemingDirty=true;this.attachEvent("submit",a.prototype.onAnalyticsSubmit,this);this.createRegions()};a.prototype.createRegions=function(){var e=this.mColC=a.DefaultRegionColor;var t=this.mColCB=a.DefaultRegionColorBorder;function i(e,t,i,o,r,n,s,l){var p={};p.K=e;p.P=[];p.T=n;p.C=o;p.CB=r;p.HDC=a.DefaultHotDeltaColor;p.ACB=p.CB;p.G=s;p.S="false";p.XA=l;var g,u,h;for(var f=0,c=t.length;f<c;++f){u=t[f];h=[];for(var d=0,m=u.length;d<m;++d){g="";for(var y=0,C=u[d].length;y<C;++y){if(y){g+=";"}g+=u[d][y]}h.push(g)}p.P.push(h)}return p}var r=null,n=[],s="";n[0]=a.GeoJSONURL;var l=window.URI(a.DefaultABAPGeoJSONURL);l.addQuery("sap-language",sap.ui.getCore().getConfiguration().getLanguage());n[1]=l.toString();n[2]=sap.ui.require.toUrl("sap/ui/vbm/"+a.DefaultGeoJSONURL);for(var p=0;p<3;++p){s=n[p];if(!r&&s){var g=new XMLHttpRequest;g.open("GET",s,false);g.send();if(g.status===200&&!!g.responseText){r=JSON.parse(g.responseText)}else{console.error("An error occurred:",g.status,g.statusText)}}}if(!r){o.error("The GeoJSON file is invalid or could not be parsed.\r\nPlease contact your Administrator.",s,"sap.ui.vbm.AnalyticMap");return}var u=[];this.mRegionApplicationTable=u;this.mRegionBox=[];this.mNames=[];this.mRegionProps=[];var h,f,c,d;var m=r.features,y="",C;var R;var b;var v;for(var B=0,A=m.length;B<A;++B){C=[];b=[];v=[];R=[];var L=m[B];if(L.id2==="AQ"){continue}if(!L.id2){L.id2=L.id}if(L.properties&&L.properties.name){y=L.properties.name}else if(L.properties&&L.properties.NAME){y=L.properties.NAME}else{y=""}this.mNames[L.id2]=y;this.mRegionProps[L.id2]=L.properties;var _=L.geometry.coordinates;var D,S,M,T,P;var N,I;switch(L.geometry.type){case"Polygon":c=Number.MAX_VALUE;d=-Number.MAX_VALUE;h=Number.MAX_VALUE;f=-Number.MAX_VALUE;P=_.length;for(N=0;N<P;++N){D=_[N];C=[];for(I=0;I<D.length;++I){T=D[I];if(!N){if((S=T[0])<h){h=S}if(S>f){f=S}if((M=T[1])<c){c=M}if(M>d){d=M}}C.push(T[0],T[1],"0")}v.push(C)}b.push(v);R.push([h,f,c,d]);break;case"MultiPolygon":for(var G=0,V=_.length;G<V;++G){c=Number.MAX_VALUE;d=-Number.MAX_VALUE;h=Number.MAX_VALUE;f=-Number.MAX_VALUE;v=[];P=_[G].length;for(N=0;N<P;++N){D=_[G][N];C=[];for(I=0;I<D.length;++I){T=D[I];if(!N){if((S=T[0])<h){h=S}if(S>f){f=S}if((M=T[1])<c){c=M}if(M>d){d=M}}C.push(T[0],T[1],"0")}v.push(C)}R.push([h,f,c,d]);b.push(v)}break;default:continue}u.push(i(L.id2,b,L.geometry.type,e,t,y,L.id2,R));this.mRegionBox[L.id2]=window.VBI.MathLib.GetSurroundingBox(R)}};a.prototype.getRegionsTemplateObject=function(){return{id:"Region",type:"{00100000-2012-0004-B001-F311DE491C77}","entity.bind":"Regions.Entity",datasource:"Regions","posarraymulti.bind":"Regions.PosList","color.bind":"Regions.Color",selectColor:a.DefaultRegionSelectColor,nonSelectColor:a.DefaultRegionNonSelectColor,"colorBorder.bind":"Regions.BorderColor","tooltip.bind":"Regions.ToolTip","hotDeltaColor.bind":"Regions.HotDeltaColor","altBorderDeltaColor.bind":"Regions.AltBorderColor","select.bind":"Regions.VB:s","labelText.bind":"Regions.LT","labelPos.bind":"Regions.LP","labelBgColor.bind":"Regions.LBC","labelBorderColor.bind":"Regions.LBBC","labelArrow.bind":"Regions.AR","labelType.bind":"Regions.LabelType"}};a.prototype.getRegionsTypeObject=function(){var e=[{name:"Key",alias:"K",type:"string"},{name:"PosList",alias:"P",type:"vectorarraymulti"},{name:"ToolTip",alias:"T",type:"string"},{name:"Color",alias:"C",type:"color"},{name:"BorderColor",alias:"CB",type:"color"},{name:"HotDeltaColor",alias:"HDC",type:"string"},{name:"AltBorderColor",alias:"ACB",type:"color"},{name:"Entity",alias:"G",type:"string"},{name:"VB:s",alias:"S",type:"boolean"},{name:"LT",alias:"LT",type:"string"},{name:"LP",alias:"LP",type:"string"},{name:"LBC",alias:"LBC",type:"color"},{name:"LBBC",alias:"LBBC",type:"color"},{name:"AR",alias:"AR",type:"boolean"},{name:"LabelType",alias:"LabelType",type:"string"}];return{name:"Regions",minSel:"0",maxSel:"-1",key:"Key",A:e}};a.prototype.getRegionsDataObjects=function(){var e=[];var i=[];var o=[];var r=[];jQuery.extend(true,e,this.mRegionApplicationTable);if(!e.length){return null}var n=this.getRegionMap();for(var s=0,l=e.length,p,g,u;s<l;++s){g=e[s];if(p=n[g.K]){g.HDC="RHLSA(0;1.0;1.0;0.4)";g.ACB=a.AltBorderColor;if(u=p.getColor()){g.C=this.getPlugin()?window.VBI.Utilities.String2VBColor(u):u}if(u=p.getTooltip()){g.T=u}g.LT=p.getLabelText();g.S=p.getSelect();g.LP="0";g.LBC=p.getLabelBgColor();g.LBBC=p.getLabelBorderColor();g.AR=p.getLabelArrow();var h=p.getLabelType();var f=t.prototype.getLabelProps(h);if(f&&g.LT){if(f.LBC){g.LBC=f.LBC}if(f.LBBC){g.LBBC=f.LBBC}if(f.LIC){g.LIC=f.LIC}if(f.LICC){g.LICC=f.LICC}if(f.LICTC){g.LICTC=f.LICTC}}if(!g.LBC){g.LBC="rgba(255,255,255,1.0)"}if(g.LBBC==""){g.LBBC=g.LBC}i.push(g)}else{o.push(g)}}r=o.concat(i);return{name:"Regions",type:"N",E:r}};a.prototype.addRegionsActions=function(e){e.push({id:"AMap1",name:"RGN_CLICK",refScene:"MainScene",refVO:"Region",refEvent:"Click"});e.push({id:"AMap2",name:"RGN_CONTEXTMENU",refScene:"MainScene",refVO:"Region",refEvent:"ContextMenu"});return e};a.prototype.findSelected=function(e,t){var i=this.getRegions();if(!i){return null}var o=[];if(jQuery.type(t)=="object"){if(t.S==(e?"true":"false")){for(var r=0;r<i.length;++r){if(i[r].sId==t.K){o.push(i[r])}}}}else if(jQuery.type(t)=="array"){for(var n=0;n<t.length;++n){if(t[n].S==(e?"true":"false")){for(var a=0;a<i.length;++a){if(i[a].mProperties.code===t[n].K){o.push(i[a])}}}}}return o};a.prototype.setSelectionPropFireSelect=function(t){var i={};i.N=[];var o=t.N;for(var r=0;r<o.length;++r){var n=o[r];var a=n.E;var s,l;var p=false;if(n.name=="Regions"){s=[];l=[];var g=this.getRegionMap();for(var u=0;u<a.length;++u){var h=a[u];var f=h.S=="true"?true:false;var c=g[h.K];if(c){var d=c.getSelect();if(f!=d){c.setProperty("select",f,true);if(f&&this.mEventRegistry["regionSelect"]){s.push(c)}else if(!f&&this.mEventRegistry["regionDeselect"]){l.push(c)}}}else{p=true}}if(l.length){this.fireRegionDeselect({deselected:l})}if(s.length){this.fireRegionSelect({selected:s})}if(p){this.invalidate();this.mbForceDataUpdate=true}}else{i.N.push(n)}}if(i.N.length){e.prototype.setSelectionPropFireSelect.call(this,i)}};a.prototype.getSelectedItems=function(e){var t=[];if(!e){return null}for(var i=0;i<e.length;++i){if(e[i].name==="Regions"){var o=this.findSelected(true,e[i].E);if(o&&o.length){t=t.concat(o)}}else{var r=this.getAggregatorContainer(e[i].name);var n=r.findSelected(true,e[i].E);if(n&&n.length){t=t.concat(n)}}}return t};a.prototype.findRegionInAggregation=function(e){var t=this.getRegions();if(t){for(var i=0,o=t.length;i<o;++i){if(t[i].mProperties.code===e){return t[i]}}}return null};a.prototype.updateVOData=function(t,i,o,r,n){if(this.mbThemingDirty){this.applyTheming(this.mRegionApplicationTable)}t.push(this.getRegionsTemplateObject());r.push(this.getRegionsTypeObject());o.push({name:"Regions",type:"N"});i.push(this.getRegionsDataObjects());e.prototype.updateVOData.apply(this,arguments);this.addRegionsActions(n)};a.prototype.resetDirtyStates=function(){e.prototype.resetDirtyStates.apply(this,arguments);this.mbRegionsDirty=false};a.prototype.minimizeApp=function(t){e.prototype.minimizeApp.apply(this,arguments);var i,o;if(!this.getMapConfiguration()){(i=t)&&(i=i.SAPVB)&&(i=i.Scenes)&&((o=i.Set)||(o=i.Merge))&&(i=o.SceneGeo)&&i.refMapLayerStack&&(i.refMapLayerStack="")}return t};a.prototype.invalidate=function(t){if(t instanceof sap.ui.vbm.Region){this.mbRegionsDirty=true}e.prototype.invalidate.apply(this,arguments)};a.prototype.getRegionMap=function(){var e={};var t=this.getRegions();for(var i=0,o=t?t.length:0,r;i<o;++i){r=t[i];e[r.getCode()]=r}return e};a.prototype.zoomToRegions=function(e,t){if(t==undefined){t=.9999}var i=[];for(var o=0,r=e.length;o<r;++o){var n=this.mRegionBox[e[o]];if(n!=undefined){i.push(n)}}if(!i.length){return}var a=null;if(a=this.mVBIContext.GetMainScene()){a.ZoomToAreas(i,t)}};a.prototype.getRegionsInfo=function(e){var t=[];for(var i=0,r=e.length,n;i<r;++i){n=e[i];t[n]={};t[n].BBox=this.mRegionBox[n];t[n].Name=this.mNames[n];t[n].Properties=this.mRegionProps[n];t[n].Midpoint=[0,0];var a=this.mVBIContext.GetMainScene();if(a){var s=[];for(var l=0;l<this.mRegionApplicationTable.length;++l){if(this.mRegionApplicationTable[l].K===n){s=this.mRegionApplicationTable[l].XA;break}}if(s.length!=0){var p,g,u,h,f,c;if(s.length==1){p=s[0]}else{g=0;for(var d=0;d<s.length;++d){u=window.VBI.MathLib.DegToRad([s[d][0],s[d][2]]);h=window.VBI.MathLib.DegToRad([s[d][1],s[d][3]]);if(Math.abs(h[0]-u[0])>Math.PI)u[0]+=2*Math.PI;f=a.GetPointFromGeo(u,false);c=a.GetPointFromGeo(h,false);var m=Math.abs(c[0]-f[0])*Math.abs(c[1]-f[1])*.5;if(m>g){g=m;p=s[d]}}}if(p){u=window.VBI.MathLib.DegToRad([p[0],p[2]]);h=window.VBI.MathLib.DegToRad([p[1],p[3]]);if(Math.abs(h[0]-u[0])>Math.PI)u[0]+=2*Math.PI;f=a.GetPointFromGeo(u,false);c=a.GetPointFromGeo(h,false);var y=[(f[0]+c[0])*.5,(f[1]+c[1])*.5];t[n].Midpoint=window.VBI.MathLib.RadToDeg(a.GetGeoFromPoint(y))}else{o.error("Unable to calculate country mid point, box is empty",n,"sap.ui.vbm.AnalyticMap")}}else{o.error("Unable to calculate country mid point, region not found",n,"sap.ui.vbm.AnalyticMap")}}else{o.error("Unable to calculate country mid point, scene is empty",n,"sap.ui.vbm.AnalyticMap")}}return t};a.prototype.onThemeChanged=function(e){this.mbThemingDirty=true;this.invalidate()};a.prototype.applyTheming=function(e){if(i){var t=a.DefaultRegionColor;var o=a.DefaultRegionColorBorder;let n=i.get({name:["_sap_ui_vbm_shared_ChoroplethRegionBG","_sap_ui_vbm_shared_ChoroplethRegionBorder"]});t=a.DefaultRegionColor=n?n["_sap_ui_vbm_shared_ChoroplethRegionBG"]:a.DefaultRegionColor;o=a.DefaultRegionColorBorder=n?n["_sap_ui_vbm_shared_ChoroplethRegionBorder"]:a.DefaultRegionColorBorder;if(this.getPlugin()){t=window.VBI.Utilities.String2VBColor(t);o=window.VBI.Utilities.String2VBColor(o)}if(t!=this.mColC||o!=this.mColCB){for(var r=0;r<e.length;++r){if(e[r].C===this.mColC){e[r].C=t}if(e[r].CB===this.mColCB){e[r].CB=o}}this.mColC=t;this.mColCB=o}this.mbThemingDirty=false}};a.prototype.isRegionSubscribed=function(e,t){if(t){var i=this.findRegionInAggregation(t);return i&&i.hasListeners(e)}return false};return a});
//# sourceMappingURL=AnalyticMap.js.map