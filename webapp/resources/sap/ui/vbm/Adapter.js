/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/core/Element","jquery.sap.global","sap/base/Log","./library","./vector/VBITransformer","./vector/MapRenderer"],function(e,jQuery,t,a){"use strict";var i="sap.ui.vbm.Adapter";var n=e.extend("sap.ui.vbm.Adapter",{metadata:{library:"sap.ui.vbm",associations:{map:{type:"sap.ui.vbm.GeoMap"}},events:{submit:{parameters:{data:{type:"string"}}}}}});n.prototype.init=function(){this._eventHandlers=[];this._actions=[];this._mapConfiguration={};this._clusterVOs=new Map;this._dataTypes={};this._data={};this._idKeyMap={};this._propsAnomalies=new Map;this._propsAnomalies.set("pos","position");this._propsAnomalies.set("posarray","position");this._propsAnomalies.set("dragdata","dragData");this._routeProperties=["color","colorBorder","directionIndicator","dotcolor","dotwidth","dragdata","end","hotDeltaColor","labelBgColor","labelPos","labelText","lineDash","linewidth","posarray","selectColor","start","tooltip"];this._areaProperties=["key","color","colorBorder","posarray","selectColor","dragdata","VB:s","VB:c","hotScale","hotDeltaColor","borderDash","selectColor","fxdir","fxsize","entity","labelBgColor","labelBorderColor","labelPos","labelText","labelArrow","label","labelAlignment","tooltip"];this._spotProperties=["alignment","contentOffset","dragdata","fxdir","fxsize","hotDeltaColor","icon","image","labelBgColor","labelPos","labelText","pos","selectColor","tooltip","semanticType"]};n.prototype.exit=function(){this._actions.forEach(function(e){e.detach()});this._detachHandlers()};n.prototype.setMap=function(e){var t=this._map()||null;var a=sap.ui.getCore().byId(e instanceof sap.ui.vbm.GeoMap?e.getId():e);if(t!=a&&t!=null){this._detachHandlers();this.init()}this.setAssociation("map",e,true);if(a!=null){var i=new sap.ui.model.json.JSONModel;i.setSizeLimit(1e5);a.setModel(i)}};n.prototype._map=function(){return sap.ui.getCore().byId(this.getMap())};n.prototype._attachHandler=function(e,t,a){if(e in this.mEventRegistry&&this.mEventRegistry[e].length>0){return this}else{if(!a._eventHandlers.some(function(e){return e===t})){a._eventHandlers.push(t)}this.attachEvent(e,t,a);return this}};n.prototype._detachHandlers=function(){var e=this;var t=function(t){if(this.hasListeners(t)){var a=this.mEventRegistry[t];for(var i=0,n=a.length;i<n;i++){var r=e._eventHandlers.indexOf(a[i].fFunction);if(r!==-1){this.detachEvent(t,a[i].fFunction,a[i].oListener)}}}};var a=this._map();if(a!=null){var i=a.mEventRegistry;for(var n in i){if(i.hasOwnProperty(n)){t.call(a,n)}}var r=function(e){var a=e.mEventRegistry;for(var i in a){if(a.hasOwnProperty(i)){t.call(e,i)}}};a.getVos().forEach(r)}return this};n.prototype._verifyMapType=function(e){var t="DEFAULT";if(e?.SAPVB?.Scenes?.Set){if(e?.SAPVB?.Scenes?.Set?.SceneGeo?.refMapLayerStack){t=e.SAPVB.Scenes.Set.SceneGeo.refMapLayerStack}if(e?.SAPVB?.MapProviders?.Set?.MapProvider){let a=e.SAPVB.MapProviders.Set.MapProvider;if(Array.isArray(a)){for(const e in a){if(a.hasOwnProperty(e)){let i=a[e];if(i.name==t&&i.type=="V"){return true}else if(i.name==t&&i.type==""){return false}}}}else if(a.name==t&&a.type=="V"){return true}else if(a.name==t&&a.type==""){return false}}}else if(e?.SAPVB?.Scenes?.Merge){var a=e?.SAPVB?.Scenes?.Merge?.SceneGeo?.refMapLayerStack;if(a){const e=this._mapConfiguration.MapProvider.find(e=>e.name===a);return e.type==="V"?true:false}}};n.prototype.load=function(e,a=false){var n=null;if(typeof e==="string"){try{n=JSON.parse(e)}catch(e){t.debug("attempt to load invalid JSON string","",i);return this}}else if(typeof e==="object"){n=e}if(!n){t.debug("nothing to load","",i);return this}if(!n.SAPVB){t.debug("invalid object supplied for load","",i);return this}if(typeof a==="boolean"&&a){VBI.VBITransformer.clearTransformedJSON()}if(this._verifyMapType(n)){VBI.VBITransformer.parseVBI(n)}if(VBI.VBITransformer.getVectorFlag()==true){VBI.VBITransformer.parseVBI(n)}if(n.SAPVB.Config){this._processConfiguration(n.SAPVB.Config)}if(n.SAPVB.Resources){this._processResources(n.SAPVB.Resources)}if(n.SAPVB.DataTypes){this._processDataTypes(n.SAPVB.DataTypes)}if(n.SAPVB.Clustering){this._processClusters(n.SAPVB.Clustering)}if(VBI.VBITransformer.getVectorFlag()==true){VBI.MapRenderer.setAdapter(this)}return(n.SAPVB.MapProviders?this._processMapProviders(n.SAPVB.MapProviders):Promise.resolve()).then(function(){if(n.SAPVB.MapLayerStacks&&VBI.VBITransformer.getVectorFlag()==false){this._processMapLayerStacks(n.SAPVB.MapLayerStacks)}if(n.SAPVB.Scenes){this._processScenes(n.SAPVB.Scenes)}if(n.SAPVB.Data){this._processData(n.SAPVB.Data)}if(n.SAPVB.Actions){this._processActions(n.SAPVB.Actions)}if(n.SAPVB.Automation&&n.SAPVB.Automation.Call&&VBI.VBITransformer.getVectorFlag()==false){this._processAutomation(n.SAPVB.Automation,n.SAPVB.Menus)}if(n.SAPVB.Windows&&VBI.VBITransformer.getVectorFlag()==false){this._processDetailWindows(n)}}.bind(this))};n.prototype._processConfiguration=function(e){return this};n.prototype._processResources=function(e){if(e.Set){var t=this._map();t.destroyResources();[].concat(e.Set.Resource).forEach(function(e){t.addResource(new sap.ui.vbm.Resource({name:e.name,value:e.value}))},this)}return this};n.prototype._processDataTypes=function(e){if(e.Set){if(e.Set.name&&e.Set.type&&e.Set.type==="N"){[].concat(e.Set.N).foreach(function(e){this._dataTypes.forEach(function(t){if(t.name==e.name){t=e}})})}else{this._dataTypes=[].concat(e.Set.N)}}return this};n.prototype._processData=function(e){var t=function(e,t){var i=a.findInArray(this._dataTypes,function(e){return e.name==t});if(i==null||!i.A){return undefined}else{var n=a.findInArray(i.A,function(t){return t.alias==e});if(n!=null){return n.name}else{return undefined}}};var i=function(e){if(e.name&&e.E){this._data[e.name]=[].concat(e.E).map(function(a){var i={};for(var n in a){if(n!=="xmlns:VB"&&n!=="n.name"&&a.hasOwnProperty(n)){if(n==="VB:c"){i["changeable"]=a[n]}else if(n==="VB:s"){i["select"]=a[n]}else{var r=t.call(this,n,e.name);if(r!=null&&r!==""){i[r]=a[n]}else{i[n]=a[n]}}}}return i},this)}};var n=function(e){var i={};for(var n in e){if(n!=="xmlns:VB"&&n!=="n.name"&&e.hasOwnProperty(n)){if(n==="VB:c"){i["changeable"]=e[n]}else if(n==="VB:s"){i["select"]=e[n]}else{var r=t.call(this,n,e["n.name"]);if(r!=null&&r!==""){i[r]=e[n]}else{i[n]=e[n]}}}}if(!this._data[e["n.name"]]){this._data[e["n.name"]]=[]}if(this._data[e["n.name"]].some(function(t){return t.Key==e.K})){var s=a.findIndexInArray(this._data[e["n.name"]],function(t){return t.Key===e.K});if(s!==-1){this._data[e["n.name"]][s]=i}}else{this._data[e["n.name"]].push(i)}};if(e.Remove){[].concat(e.Remove).filter(function(e){return e.N&&e.N.E}).forEach(function(e){[].concat(e.N.E).forEach(function(t){var i=a.findIndexInArray(this._data[e.name],function(e){return e.Key===t.K});if(i!==-1){this._data[e.name].splice(i,1)}},this)},this)}if(e.Set&&typeof e.Set==="object"&&!jQuery.isEmptyObject(e.Set)){if(!Array.isArray(e.Set)&&!e.Set.name&&!e.Set.type){this._data={};if(e.Set.N!==null){[].concat(e.Set.N).forEach(i,this)}}else{[].concat(e.Set).filter(function(e){return e.name&&e.type}).map(function(e){return[].concat(e.N)}).reduce(function(e,t){return e.concat(t)}).map(function(e){var t=e.hasOwnProperty("E")&&e.E?[].concat(e.E):[];return t.map(function(t){t["n.name"]=e.name;return t})}).reduce(function(e,t){return e.concat(t)}).forEach(n,this)}}this._map().getModel().setData(this._data,false);return this};n.prototype._processMapProviders=function(e){if(e.Set&&e.Set.MapProvider){var n=[].concat(e.Set.MapProvider).map(function(e){return{name:e.name,tileX:e.tileX,tileY:e.tileY,minLOD:e.minLOD,maxLOD:e.maxLOD,copyright:e.copyright,MapBase:e.MapBase,copyrightImage:e.copyrightImage,copyrightLink:e.copyrightLink,description:e.description,projection:e.projection,resolution:e.resolution,retries:e.retries,type:e.type,Header:e.Header?[].concat(e.Header).map(function(e){return{name:e.name,value:e.value}}):e.Header,Source:e.Source?[].concat(e.Source).map(function(e){return{id:e.id,url:e.url}}):e.Source}});var r=function(e){return e&&e.url&&e.url.indexOf("google")!==-1};var s=n.map(function(e){return[].concat(e.Source)}).reduce(function(e,t){return e.concat(t)}).filter(r);if(s.length>0){var o=[];var c=s.reduce(function(e,t){var i=t.url.split("key=")[1];e[i]=e[i]||[];if(a.findIndexInArray(o,function(e){return e===i})===-1){o.push(i)}e[i].push(t);return e},{});var f=function(e){return new Promise(function(t,a){var i=new XMLHttpRequest;i.open("POST","https://www.googleapis.com/tile/v1/createSession?key="+e,true);i.setRequestHeader("Content-Type","application/json");i.onreadystatechange=function(){if(i.readyState==4){if(i.status==200){t(JSON.parse(i.responseText))}else{a(new Error(i.statusText))}}};var n={mapType:"terrain",language:"en-NZ",region:"nz",layerTypes:["layerRoadmap"],overlay:false,scale:"scaleFactor1x"};i.send(JSON.stringify(n))}).then(function(t){if(t&&t.session){c[e].forEach(function(e){e.url=e.url+"&session="+t.session})}},function(e){t.debug(e,"",i)})};return Promise.all(o.map(f)).then(function(){this._mapConfiguration.MapProvider=n;this._updateMapconfiguration()}.bind(this))}else{this._mapConfiguration.MapProvider=n;this._updateMapconfiguration();return Promise.resolve()}}return this};n.prototype._processMapLayerStacks=function(e){if(e.Set&&e.Set.MapLayerStack){this._mapConfiguration.MapLayerStacks=[];[].concat(e.Set.MapLayerStack).forEach(function(e){var t={name:e.name},a="true";if(e.MapLayer){t.MapLayer=[];[].concat(e.MapLayer).forEach(function(e){var i={name:e.name,refMapProvider:e.refMapProvider,opacity:e.opacity,colBkgnd:e.colBkgnd,singleBMP:e.singleBMP||"false"};a=i.singleBMP!=="true"?"false":a;t.MapLayer.push(i)});t.singleBMP=e.singleBMP||a}this._mapConfiguration.MapLayerStacks.push(t)},this);this._updateMapconfiguration()}return this};n.prototype._updateMapconfiguration=function(){if(this._mapConfiguration.MapProvider&&this._mapConfiguration.MapLayerStacks){this._map().setMapConfiguration(this._mapConfiguration)}return this};n.prototype._ui5Id=function(e){return this._map().getId()+"-"+e};n.prototype._processScenes=function(e){if(e.Set&&e.Set.SceneGeo){var n=this._map();if(e.Set.SceneGeo.initialStartPosition){n.setCenterPosition(e.Set.SceneGeo.initialStartPosition)}if(e.Set.SceneGeo.initialZoom){n.setZoomlevel(Math.floor(e.Set.SceneGeo.initialZoom))}if(e.Set.SceneGeo.refMapLayerStack){n.setRefMapLayerStack(e.Set.SceneGeo.refMapLayerStack)}var r=e.Set.SceneGeo.VO;n.destroyVos();if(!r){return this}r.forEach(function(e){if(this._clusterVOs.has(e.id)){return}var r,s,o=[],c={};function f(t,a){for(var i in e){var n=i.indexOf(".bind");var r=n!==-1?i.substring(0,n):i;if(t.indexOf(r)!==-1){r=a.get(r)||r;var s=e[i];if(n!==-1){s=e[i].substring(e[i].indexOf(".")+1);o.push(s)}c[r]=n!==-1?"{"+s+"}":s}}}function u(){if(e.DragSource&&s.getMetadata().hasAggregation("dragSource")){[].concat(e.DragSource.DragItem).forEach(function(e){s.addDragSource(new sap.ui.vbm.DragSource({type:e.type}))})}if(e.DropTarget&&s.getMetadata().hasAggregation("dropTarget")){[].concat(e.DropTarget.DropItem).forEach(function(e){s.addDropTarget(new sap.ui.vbm.DropTarget({type:e.type}))})}}switch(e.type){case"{00100000-2012-0004-B001-64592B8DB964}":f(this._spotProperties,this._propsAnomalies);r=new sap.ui.vbm.Spot(c);s=new sap.ui.vbm.Spots(this._ui5Id(e.id));u();break;case"{00100000-2012-0004-B001-C46BD7336A1A}":f(this._routeProperties,this._propsAnomalies);r=new sap.ui.vbm.Route(c);s=new sap.ui.vbm.Routes(this._ui5Id(e.id));u();break;case"{00100000-2012-0004-B001-F311DE491C77}":f(this._areaProperties,this._propsAnomalies);r=new sap.ui.vbm.Area(c);s=new sap.ui.vbm.Areas(this._ui5Id(e.id));u();break;case"{00100000-2014-0004-BDA8-87B904609063}":case"{00100000-2014-0004-B001-9F1B43BE944A}":case"{00100000-2013-0004-B001-7EB3CCC039C4}":case"{00100000-2013-0004-B001-686F01B57873}":case"{00100000-2012-0004-B001-BFED458C3076}":case"{00100000-2012-0004-B001-383477EA1DEB}":case"{388951f5-a66b-4423-a5ad-e0ee13c2246f}":default:t.debug("unsupported VO type",e.type,i);return}var p=a.findIndexInArray(this._dataTypes,function(t){return t.name===e.datasource});if(p!==-1){var h=this._dataTypes[p];r.bindProperty("key",{path:h.key});o.push(h.key);var l=[];h.A.forEach(function(e){if(o.indexOf(e.name)===-1){l.push(e.name);var t=new sap.ui.core.CustomData({key:e.name,value:"{"+e.name+"}"});r.addCustomData(t)}});if(l.length){s.setCustomProperties(l)}s.bindAggregation("items",{path:"/"+e.datasource+"",template:r})}else{s.addItem(r)}n.addVo(s)}.bind(this))}else if(e.Merge&&e.Merge.SceneGeo&&e.Merge.SceneGeo.refMapLayerStack&&VBI.VBITransformer.getVectorFlag()==false){this._map().setRefMapLayerStack(e.Merge.SceneGeo.refMapLayerStack)}return this};function r(e,t){Object.assign(this,e);this._adapter=t;if(!this.refVO){this.refVO="General"}}r.prototype.attach=function(){var e=false;this._listener=this._adapter;this._handler=this._adapter._handler;if(this.refVO==="Map"||this.refVO==="General"){this._target=this._adapter._map()}else{var n=this._adapter._ui5Id(this.refVO);this._target=a.findInArray(this._adapter._map().getVos(),function(e){return e.getId()===n});if(!this._target){this._target=this._adapter._clusterVOs.get(this.refVO);e=!!this._target}}if(!this._target){t.warning("unable to attach action",this.id,i);return false}switch(this.refEvent){case"Click":this._event="click";if(e){this._listener=this;this._handler=function(e){this._adapter._handler(e,this)}}break;case"ContextMenu":this._event="contextMenu";if(e){this._listener=this;this._handler=function(e){this._adapter._handler(e,this)}}break;case"DoubleClick":this._event="click";this._handler=this._adapter._clickHandler;if(e){this._listener=this;this._handler=function(e){this._adapter._clickHandler(e,this)}}break;case"Drop":this._event="drop";break;case"CreateComplete":this._event="createComplete";break;case"Select":this._event="select";break;case"KeyPress":if(this._target!==this._adapter._map()){return false}this._event="keyDown";this._target.setKeyEventDelay(250);this._target.setAllowKeyEventRepeat(false);this._handler=this._adapter._getKeyboardHandler(this.name);break;default:if(this.refEvent&&this.name){t.info("No UI5 event found to attach action to. Falling through to default vbi event handling.",this.name,i);this._event=this.name}else{t.error("Action invalid. No refEvent or name supplied.",this,i);return false}}this._target.attachEvent(this._event,this._handler,this._listener);this._target.invalidate();return true};r.prototype.detach=function(){if(this._target&&this._event&&this._handler&&this._listener){this._target.detachEvent(this._event,this._handler,this._listener);this._target.invalidate();this._target=this._event=this._handler=this._listener=undefined}};n.prototype._removeAction=function(e){var t=this._actions[e];t.detach();this._actions.splice(e,1);if(t.refEvent==="DoubleClick"){var i=a.findInArray(this._actions,function(e){return e.refVO===t.refVO&&e.refEvent==="Click"});if(i){i.attach()}}};n.prototype._addAction=function(e){var n=new r(e,this);if(e.refEvent==="Click"){if(this._actions.some(function(t){return t.refVO===e.refVO&&t.refEvent==="DoubleClick"},this)){this._actions.push(n);return}}else if(e.refEvent==="DoubleClick"){var s=a.findInArray(this._actions,function(t){return t.refVO===e.refVO&&t.refEvent==="Click"},this);if(s){s.detach()}}if(n.attach()){this._actions.push(n)}else{t.info("unable to attach action",e.id,i)}};n.prototype._processActions=function(e){var n,r;if(e.Remove){if(e.Remove.Action){n=[].concat(e.Remove.Action)}else{n=[].concat(e.Remove)}n.forEach(function(e){r=a.findIndexInArray(this._actions,function(t){return t.id===e.id});if(r!==-1){this._removeAction(r)}else{t.info("remove of nonexistent action",e.id,i)}},this)}if(e.Set){if(e.Set.Action){n=[].concat(e.Set.Action)}else{n=[].concat(e.Set)}n.forEach(function(e){r=a.findIndexInArray(this._actions,function(t){return t.id===e.id});if(r!==-1){this._removeAction(r)}this._addAction(e)},this)}return this};n.prototype._getKeyboardHandler=function(e){return function(t){var a=t.mParameters;if(a.key=="Shift"||a.code==16||a.key=="Control"||a.code==17||a.key=="Alt"||a.code==18||a.key=="Meta"||a.code==91){return}var i={version:"2.0","xmlns:VB":"VB",Action:{name:e,Params:{Param:[{name:"code","#":a.code},{name:"shift","#":a.shift},{name:"ctrl","#":a.ctrl},{name:"alt","#":a.alt},{name:"meta","#":a.meta}]}}};this.fireSubmit({data:JSON.stringify(i)})}};n.prototype.idKeyMapGenerator=function(){this._map().getVos().map(function(e){return e.getItems()}).reduce(function(e,t){return e.concat(t)}).forEach(function(e){this._idKeyMap[e.getUniqueId()]=e.getKey()},this);return this};n.prototype._processAutomation=function(e,t){var a={};if(e.Call.handler==="CONTEXTMENUHANDLER"){var i=this;var n=this._map();if(e.Call.instance&&e.Call.instance.split(".").length==2){var r=this._map().getVos().map(function(e){return e.getItems()}).reduce(function(e,t){return e.concat(t)}).filter(function(t){return t.getKey()===e.Call.instance.split(".")[1]});if(r.length>0){n=r[0];e.Call.instance=n.getUniqueId();e.Call.object=i._ui5Id(e.Call.object)}}if(t.Set.Menu){[].concat(t.Set.Menu).forEach(function(e){i._attachHandler.call(n,e.action,function(e){var t;if(e.oSource===i._map()){t=e.getParameters();if(t.Action.object.startsWith(this._map().getId())){t.Action.object=t.Action.object.substr(this._map().getId().length+1)}if(t.id&&t.hasOwnProperty("id")){delete t.id}}else{t=e.getParameters().data;if(t.Action.object.startsWith(this._map().getId())){t.Action.object=t.Action.object.substr(this._map().getId().length+1)}t.Action.instance=t.Action.object+"."+e.oSource.getKey()}if(t.Data&&t.Data.Merge&&t.Data.Merge.N){[].concat(t.Data.Merge.N).forEach(function(e){if(e.name&&e.name.startsWith(this._map().getId())){e.name=e.name.substr(this._map().getId().length+1)}},this);var a=t.Data.Merge.N.map(function(e){return e.E}).reduce(function(e,t){return e.concat(t)}).map(function(e){return e.K});if(jQuery.isEmptyObject(this._idKeyMap)){this.idKeyMapGenerator()}if(a.some(function(e){return!this._idKeyMap.hasOwnProperty(e)},this)){this.idKeyMapGenerator()}var n=function(e){e.K=this._idKeyMap[e.K]};[].concat(t.Data.Merge.N).map(function(e){return e.E}).reduce(function(e,t){return e.concat(t)}).forEach(n,this)}this.fireSubmit({data:JSON.stringify(t)})},i)})}}a["Automation"]=e;a["Menus"]=t;var s={};s["SAPVB"]=a;this._map().load(s);return this};n.prototype._processClusters=function(e){this._clusterVOs.clear();if(e.Set){var a=this._map();a.destroyClusters();[].concat(e.Set.Cluster).forEach(function(e){var n=null;switch(e.type){case"distance":n=new sap.ui.vbm.ClusterDistance(e.id);if(e.distance){n.setDistance(parseFloat(e.distance))}break;case"grid":n=new sap.ui.vbm.ClusterGrid(e.id);if(e.limit){n.setLimit(parseInt(e.limit,10))}if(e.limitOnSum){n.setLimitTotal(parseInt(e.limitOnSum,10))}if(e.order){n.setOrderIndex(parseInt(e.order,10))}if(e.areabordersize){n.setCellSpacing(-parseInt(e.areabordersize,10))}if(e.distanceX&&e.distanceY){n.setGridSize(e.distanceX+";"+e.distanceY)}if(e.offsetX&&e.offsetY){n.setOffset(e.offsetX+";"+e.offsetY)}break;case"tree":n=new sap.ui.vbm.ClusterTree(e.id,{});break;default:t.debug("unsupported clustering type",e.type,i);break}if(n){if(e.rule){n.setRule(e.rule)}n.setTextSettings({textcolor:e.textcolor,textfont:e.textfont,textfontsize:e.textfontsize,textoffset:e.textoffset,textoffsetY:e.textoffsetY});n.setVizTemplate(new sap.ui.vbm.Cluster);a.addCluster(n)}this._clusterVOs.set(e.VO,n)},this)}return this};n.prototype._processDetailWindows=function(e){var t=this._map();var i=this;if(!e.SAPVB.Windows.Set&&!e.SAPVB.Windows.Remove){return this}if(e.SAPVB.Windows.Set&&e.SAPVB.Windows.Set.name){var n=function(e,t){return function(a){return a[e]===t}};var r=[].concat(e.SAPVB.Windows.Set).map(function(e){var i=t.getModel().getData();var r=e;for(var s in e.Window){if(e.Window.hasOwnProperty(s)){if(s.endsWith(".bind")){if(s.startsWith("pos")){var o=e.Window[s].split(".");if(o[0]in i){var c=a.findIndexInArray(i[o[0]],n("Key",o[1]));if(c!==-1){var f=i[o[0]][c];if(o[2]in f){delete r.Window[s];r.Window[s.split(".")[0]]=f[o[2]]}}}}}}}return r},this);e.SAPVB.Windows.Set=r;if(e.SAPVB.Scenes&&e.SAPVB.Scenes.Set&&e.SAPVB.Scenes.Set.name&&e.SAPVB.Scenes.Set.Scene&&e.SAPVB.Scenes.Set.Scene.VO){var s=[].concat(e.SAPVB.Scenes.Set.Scene.VO).map(function(r){var s=r;var o=function(e,t,i){return function(r){if(r.name&&r.type){var s=r[r.type];if(s.name===r.name){var o=a.findInArray([].concat(this._dataTypes),n("name",s.name));var c=a.findInArray([].concat(a.findInArray([].concat(o.N),n("name",i[2])).A),n("name",i[4])).alias;var f=[].concat(s.E)[i[1]];var u=[].concat(a.findInArray([].concat(f.N),n("name",i[2])).E)[i[3]];e[t.split(".")[0]]=u[c];delete e[t]}}}};for(var c in r){if(r.hasOwnProperty(c)){if(c.endsWith(".bind")){var f=r[c].split(".");if(e.SAPVB.Data&&e.SAPVB.Data.Set){[].concat(e.SAPVB.Data.Set).forEach(o(s,c,f),this)}}}}if(e.SAPVB.Actions&&e.SAPVB.Actions.Set){[].concat(e.SAPVB.Actions.Set).filter(function(e){return e.Action.refVO===s.id}).forEach(function(e){i._attachHandler.call(t,e.Action.name,i._handler,i)})}return s},this);e.SAPVB.Scenes.Set.Scene.VO=s}}t.load(e);return this};n.prototype._handler=function(e,t){if(e.oSource instanceof sap.ui.vbm.ClusterBase){var i=e.getParameters().instance.getKey();var n=e.getParameters().event;var r=this._map().mVBIContext.GetMainScene();if(i&&n&&r){var s=r.GetEventVPCoords(n);var o=r.GetPosFromVPPoint([s[0],s[1],0]);var c=this._map().getInfoForCluster(i,sap.ui.vbm.ClusterInfoType.NodeInfo);e.getParameters().data={version:"2.0","xmlns:VB":"VB",id:e.oSource.getId(),Action:{id:t.id,name:t.name,object:t.refVO,instance:i,Params:{Param:[{name:"x","#":s[0].toString()},{name:"y","#":s[1].toString()}]},AddActionProperties:{AddActionProperty:[{name:"pos","#":o[0].toString()+";"+o[1].toString()+";0.0"},{name:"vos","#":c.cnt}]}}};this.fireSubmit({data:JSON.stringify(e.getParameters().data)})}}else{var f=e.getParameters();var u=f.data?f.data:f;if(u.Action&&!u.Action.object){this.fireSubmit({data:JSON.stringify(u)});return}if(u.Action.object.startsWith(this._map().getId())){u.Action.object=u.Action.object.substr(this._map().getId().length+1)}if(u.Action&&u.Action.object){var p="Route",h="Link";var l=[u.Action.object];if(u.Action.object===p){l.push(h);u.Action.object=h}var d=a.findInArray(this._actions,function(e){return l.indexOf(e.refVO)!=-1&&u.Action.name.toLowerCase()===e.refEvent.toLowerCase()});if(d){u.Action.id=d.id;u.Action.name=d.name;if(u.Action.instance){u.Action.instance=u.Action.object+"."+f.instance.getKey()}var m=[];if(u.Action.Params){u.Action.Params.Param.forEach(function(e){if(e.name==="strSource"){m.push(e)}});if(m.length){if(jQuery.isEmptyObject(this._idKeyMap)){this.idKeyMapGenerator()}else if(m.some(function(e){return!this._idKeyMap.hasOwnProperty(e["#"].split(".")[1])},this)){this.idKeyMapGenerator()}m.forEach(function(e){var t=e["#"].split(".");e["#"]=t[0]+"."+this._idKeyMap[t[1]]},this)}}if(u.Data&&u.Data.Merge&&u.Data.Merge.N){[].concat(u.Data.Merge.N).forEach(function(e){if(e.name&&e.name.startsWith(this._map().getId())){e.name=e.name.substr(this._map().getId().length+1)}},this);var v=u.Data.Merge.N.map(function(e){return e.E}).reduce(function(e,t){return e.concat(t)}).map(function(e){return e.K});if(jQuery.isEmptyObject(this._idKeyMap)){this.idKeyMapGenerator()}if(v.some(function(e){return!this._idKeyMap.hasOwnProperty(e)},this)){this.idKeyMapGenerator()}var y=function(e){e.K=this._idKeyMap[e.K]};[].concat(u.Data.Merge.N).map(function(e){return e.E}).reduce(function(e,t){return e.concat(t)}).forEach(y,this)}[].concat(d.AddActionProperty||[]).forEach(function(e){var t=u.Action.AddActionProperties.AddActionProperty||[];var i=a.findInArray([].concat(t),function(t){return t.name===e.name});if(!i){switch(e.name){case"zoom":t.push({name:e.name,"#":this._map().getZoomlevel()});break;case"centerpoint":t.push({name:e.name,"#":this._map().getCenterPosition()});break;case"pitch":t.push({name:e.name,"#":"0.0"});break;case"yaw":t.push({name:e.name,"#":"0.0"});break;default:break}}},this);this.fireSubmit({data:JSON.stringify(u)})}}}this.timeout=undefined};n.prototype._clickHandler=function(e,t){if(this.timeout){clearTimeout(this.timeout);if(!t){e.getParameters().data.Action.name="doubleclick"}this._handler(e,t)}else{var i=t?a.findInArray(this._actions,function(e){return e.refVO===t.refVO&&e.refEvent==="Click"}):undefined;this.oEvent=jQuery.extend(true,{},e);this.timeout=setTimeout(this._handler.bind(this,this.oEvent,i),500)}};return n});
//# sourceMappingURL=Adapter.js.map