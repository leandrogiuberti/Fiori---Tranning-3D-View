/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/base/Object","./Utilities","./PolygonHandler","./ModelHandler","./thirdparty/three","./thirdparty/DecalGeometry","./thirdparty/html2canvas","sap/base/Log","./../library"],function(e,t,r,i,a,s,n,o,l){"use strict";var c="sap.ui.vbm.adapter3d.SceneBuilder";var d=a.Matrix4;var u=a.Vector3;var p=a.Math.degToRad;var h=t.toArray;var f=t.toBoolean;var _=t.toVector3;var y=t.createMaterial;var g=t.propertyChanged;var m=t.propertyRemoved;var x=t.propertyAdded;var v=t.updateProperty;var b=t.refCountableDispose;var w;var D;var H=e.extend("sap.ui.vbm.adapter3d.SceneBuilder",{constructor:function(t,a){e.call(this);this._context=t;this._viewport=a;this._root=a.getRoot();this._scene=a.getScene();this._hotInstance=null;this._decalHelper=null;this._targets=new Map;this._instanceDecals=new Map;this._textures=new Map;this._box4=null;this._box6=null;this._cylinder=null;this._cylinderCaps=null;this._polygonHandler=new r(this._root);this._modelHandler=new i(this._context.resources,this._textures,this._scene,this._root);this._textureLoader=null}});H.prototype.destroy=function(){this._root=null;this._scene=null;this._viewport=null;this._context=null;this._hotInstance=null;if(this._box4){this._box4.dispose()}if(this._box6){this._box6.dispose()}if(this._cylinder){this._cylinder.dispose()}if(this._cylinderCaps){this._cylinderCaps.dispose()}if(this._decalHelper){this._decalHelper.material.dispose();this._decalHelper.geometry.dispose();this._scene.remove(this._decalHelper);this._decalHelper=null}this._polygonHandler.destroy();this._polygonHandler=null;this._modelHandler.destroy();this._modelHandler=null;this._textures.forEach(function(e){e.dispose()});this._targets.clear();this._targets=null;this._instanceDecals.clear();this._instanceDecals=null;e.prototype.destroy.call(this)};H.prototype.synchronize=function(){var e=this;function t(t){var r=e._textures.get(t);if(!r){e._textures.set(t,null)}}return new Promise(function(r,i){var a=l.findInArray(e._context.windows,function(e){return e.type==="default"});var s=a&&l.findInArray(e._context.scenes,function(e){return e.id===a.refScene});if(!s){r();return}e._context.scene=s;if(e._context.setupView){var n=e._context.setupView;e._setupView(n.position,n.zoom,n.pitch,n.yaw,n.home,n.flyTo);e._context.setupView=undefined}var o=[];var c=[],d=[];var u=e._context.voQueues.toAdd.get(s)||[];var p=e._context.voQueues.toUpdate.get(s)||[];var h=e._context.voQueues.toRemove.get(s)||[];[].concat(u,p).forEach(function(r){if(r.isModel){e._modelHandler.addModel(r)}if(r.texture&&g(r,"texture")){t(r.texture)}if(r.textureCap&&g(r,"textureCap")){t(r.textureCap)}if(r.isDecal&&r.text&&g(r,["text","size"])){o.push(r)}});e._loadTextures().then(function(){return e._modelHandler.loadModels()}).then(function(){return e._renderTexts(o)}).then(function(){h.forEach(e._removeInstance.bind(e));p.forEach(e._updateInstance.bind(e,d));u.forEach(e._addInstance.bind(e,c));e._polygonHandler.update();e._modelHandler.update();e._scene.updateMatrixWorld(true);d.forEach(e._updateInstance.bind(e,null));c.forEach(e._addInstance.bind(e,null));e._cleanupCache();r()}).catch(function(e){i(e)})})};H.prototype._findMesh=function(e){var t=null;e.traverse(function(e){if(!t&&e.isMesh){t=e}});return t};H.prototype._getGeometrySize=function(){return 2};H.prototype._getZoomFactor=function(e,t){var r=new u;r.subVectors(t,e);return this._getGeometrySize()*2/r.length()};H.prototype._setupView=function(e,t,r,i,a,s){e=_(e||"0;0;0");t=parseFloat(t||"1");if(t===0){t=1}else if(t<0){t=.1}var n=this._getGeometrySize()*2/t;r=parseFloat(r||"0");i=parseFloat(i||"0");r=r%180===0?r+1:r;var o=new d;o.makeRotationX(p(r+180));var l=new d;l.makeRotationZ(p(-(i+180)));var c=new d;c.multiplyMatrices(l,o);var h=new u(0,0,-5);var f=new u(0,0,0);var y=new u;y.subVectors(f,h).normalize();y.multiplyScalar(n);y.applyMatrix4(c);y.add(e);f.add(e);var g={zoom:1,target:new u(-f.x,-f.z,f.y),position:new u(-y.x,-y.z,y.y)};if(a){this._viewport._setCameraHome(g);this._viewport._applyCamera(g,s)}else{this._viewport._applyCamera(g,s)}};H.prototype._getDecalTextKey=function(e){return e.size+";"+e.text};H.prototype._renderTexts=function(e){var t=[];e.forEach(function(e){if(!this._textures.has(this._getDecalTextKey(e))){t.push(this._renderText(e))}},this);return Promise.all(t)};H.prototype._renderText=function(e){var r=this;return new Promise(function(i,s){var l=_(e.size);if(l.length()<1e-6){o.error("Unable render text to html: decal size is invalid","",c);i()}else{var d=512;var u=l.x/l.y;var p=Math.ceil(u>=1?d:d*u);var h=Math.ceil(u<=1?d:d/u);var f=document.createElement("iframe");f.style.visibility="hidden";f.sandbox="allow-same-origin";f.width=p;f.height=h;document.body.appendChild(f);var y=f.contentDocument||f.contentWindow.document;y.open();y.close();y.body.innerHTML=e.text;var g=document.createElement("canvas");g.width=f.width*window.devicePixelRatio;g.height=f.height*window.devicePixelRatio;g.style.width=f.width+"px";g.style.height=f.height+"px";var m=g.getContext("2d");m.scale(window.devicePixelRatio,window.devicePixelRatio);n(y.body,{canvas:g,width:p,height:h,backgroundColor:null,logging:false}).then(function(s){if(s.width>0&&s.height>0){var n=new a.Texture(s);n.needsUpdate=true;t.addRef(n);r._textures.set(r._getDecalTextKey(e),n)}else{o.error("Failed render text to html","",c)}document.body.removeChild(f);i()})}})};H.prototype._loadTextures=function(){var e=[];this._textures.forEach(function(t,r){if(!t){e.push(this._loadTexture(r))}},this);return Promise.all(e)};H.prototype._loadTexture=function(e){var r=this;var i=this._context.resources.get(e);if(!i){this._textures.delete(e);o.error("Failed to get texture from context",e,c);return Promise.resolve()}return new Promise(function(a,s){r._getTextureLoader().load(t.makeDataUri(i),function(t){t.flipY=false;r._textures.set(e,t);a()},null,function(t){r._textures.delete(e);o.error("Failed to load texture from Data URI: "+e,"status: "+t.status+", status text: "+t.statusText,c);a()})})};H.prototype._cleanupCache=function(){this._textures.forEach(function(e){if(b(e)){e.dispose();this._textures.delete(e)}},this);if(this._box4&&b(this._box4)){this._box4.dispose();this._box4=null}if(this._box6&&b(this._box6)){this._box6.dispose();this._box6=null}if(this._cylinder&&b(this._cylinder)){this._cylinder.dispose();this._cylinder=null}if(this._cylinderCaps&&b(this._cylinderCaps)){this._cylinderCaps.dispose();this._cylinderCaps=null}};H.prototype._addInstance=function(e,t){if(!t.isDecal){this._updateInstanceKeys(t)}if(t.isPolygon){this._polygonHandler.addInstance(t)}else if(t.isModel){this._modelHandler.addInstance(t)}else if(t.isBox){this._assignBoxProperties(t)}else if(t.isCylinder){this._assignCylinderProperties(t)}else if(t.isDecal){if(e){e.push(t)}else{this._assignDecalProperties(t)}}else{o.error("Unable to add instance: instance type is unknown","",c)}};H.prototype._updateInstance=function(e,t){if(!t.isDecal){this._updateInstanceKeys(t)}if(t.isPolygon){this._polygonHandler.updateInstance(t)}else if(t.isModel){this._modelHandler.updateInstance(t)}else if(t.isBox){this._assignBoxProperties(t,t===this._hotInstance)}else if(t.isCylinder){this._assignCylinderProperties(t,t===this._hotInstance)}else if(t.isDecal){if(e){e.push(t)}else{this._assignDecalProperties(t)}}else{o.error("Unable to update instance: instance type is unknown","",c)}};H.prototype._removeInstance=function(e){if(!e.isDecal){this._removeInstanceKeys(e)}if(e.isPolygon){this._polygonHandler.removeInstance(e)}else if(e.isModel){this._modelHandler.removeInstance(e)}else if(e.isBox||e.isCylinder||e.isDecal){if(e.object3D){this._deleteObject3D(e.object3D);e.object3D=null;e._last={};if(e.isDecal&&e.target){var t=this._targets.get(e.target);if(t){this._instanceDecals.get(t).delete(e)}else{o.error("Unable to remove decal from (instance <-> decals) map","",c)}}}else{o.error("Unable to remove instance: object3D is missing","",c)}}else{o.error("Unable to remove instance: instance type is unknown","",c)}if(this._hotInstance===e){this._hotInstance=null}};H.prototype.updateSelection=function(e,t){e.concat(t).forEach(function(e){if(e.isPolygon){this._polygonHandler.updateInstance(e)}else if(e.isModel){this._modelHandler.updateInstance(e)}else if(e.isBox){this._assignBoxProperties(e,e===this._hotInstance)}else if(e.isCylinder){this._assignCylinderProperties(e,e===this._hotInstance)}},this);this._polygonHandler.update();this._modelHandler.update()};H.prototype._updateHotStatus=function(e,t){if(e.isBox){this._assignBoxProperties(e,t)}else if(e.isCylinder){this._assignCylinderProperties(e,t)}};H.prototype.updateHotInstance=function(e){this._polygonHandler.updateHotInstance(e);this._modelHandler.updateHotInstance(e);this._polygonHandler.update();this._modelHandler.update();if(this._hotInstance){this._updateHotStatus(this._hotInstance,false)}if(e){this._updateHotStatus(e,true)}this._hotInstance=e};H.prototype._assignBoxProperties=function(e,r){var i=e.object3D||null;if(!i||g(e,"texture6")){var s=this._getBoxGeometry(f(e.texture6));t.addRef(s);if(i){t.subRef(i.geometry);i.geometry=s}else{i=new a.Mesh(s,y(false));i.matrixAutoUpdate=false;i.layers.set(0);i._sapInstance=e;this._root.add(i);e.object3D=i}}v(e,"texture6");this._assignProperties(e,r)};H.prototype._assignCylinderProperties=function(e,r){var i,s=false,n=f(e.isOpen),l=e.object3D||null;if(!l||g(e,"isOpen")){var d=this._getCylinderGeometry(n);t.addRef(d);if(l){t.subRef(l.geometry);l.geometry=d;if(n){i=l.material[1];if(i.map){t.subRef(i.map);i.dispose()}l.material=l.material[0];l.material.side=a.DoubleSide;l.material.needsUpdate=true}else{i=l.material.clone();i.map=null;l.material=[l.material,i,i];l.material.forEach(function(e){e.needsUpdate=true;e.side=a.FrontSide});s=true}}else{if(n){l=new a.Mesh(d,y(true))}else{i=y(false);l=new a.Mesh(d,[y(false),i,i])}l.matrixAutoUpdate=false;l.layers.set(0);l._sapInstance=e;this._root.add(l);e.object3D=l}}if(g(e,"textureCap")||s){i=Array.isArray(l.material)?l.material[1]:null;if(i){if(i.map){t.subRef(i.map);i.map=null;i.needsUpdate=true}if(e.textureCap){i.map=this._textures.get(e.textureCap);if(i.map){i.needsUpdate=true;t.addRef(i.map)}else{o.error("Unable to apply cap texture on cylinder, texture not found",e.textureCap,c)}}}}v(e,["isOpen","textureCap"]);this._assignProperties(e,r)};H.prototype._assignProperties=function(e,r){var i,s,n=e.object3D;if(g(e,"texture")){s=Array.isArray(n.material)?n.material[0]:n.material;if(s.map){t.subRef(s.map);s.map=null;s.needsUpdate=true}if(e.texture){s.map=this._textures.get(e.texture);if(s.map){s.needsUpdate=true;t.addRef(s.map)}else{o.error("Unable to apply texture, texture not found",e.texture,c)}}}if(g(e,["color","selectColor","VB:s"])||r!==undefined){i=t.getColor(e,e.color,r);t.toArray(n.material).forEach(function(e){e.color.copy(i.rgb);e.opacity=i.opacity;e.transparent=e.opacity<1;e.needsUpdate=true})}var l=n.children.length===0?null:n.children[0];if(m(e,"colorBorder")){l.material.dispose();l.geometry.dispose();n.remove(l)}else if(e.colorBorder){if(x(e,"colorBorder")){var u=e.isBox?new a.EdgesGeometry(n.geometry):new a.EdgesGeometry(n.geometry,60);l=new a.LineSegments(u,t.createLineMaterial());l.matrixAutoUpdate=false;l.layers.set(1);n.add(l)}if(g(e,["colorBorder","selectColor,","VB:s"])||r!==undefined){s=l.material;i=t.getColor(e,e.colorBorder,r);s.color.copy(i.rgb);s.opacity=i.opacity;s.transparent=s.opacity<1;s.needsUpdate=true}}if(g(e,["pos","rot","scale","normalize"])){var p=new d,h=new d;if(f(e.normalize)){n.position.set(0,0,0);n.rotation.set(0,0,0);n.scale.set(1,1,1);n.updateMatrix();t.normalizeObject3D(n,p)}t.getInstanceMatrix(e,h);h.multiply(p);h.decompose(n.position,n.quaternion,n.scale);n.updateMatrix()}v(e,["texture","color","selectColor","VB:s","colorBorder","normalize","pos","rot","scale"])};H.prototype._assignDecalProperties=function(e){var r=false,i;if(g(e,["position","direction","size","rotation","target"])){r=true}if(!e.target&&g(e,["planeOrigin","planeNormal"])){r=true}if(r){if(e.object3D){i=e.object3D.material.clone();this._deleteObject3D(e.object3D);e.object3D=null}var a=this._getDecalTarget(e);if(!a){o.error("Unable to create decal","target is missing",c);return}var s=this._createDecal(e,a,i);this._disposeDecalTarget(e,a);if(!s){return}}if(g(e,["texture","text"])){i=e.object3D.material;if(i.map){t.subRef(i.map);i.map=null}i.map=this._textures.get(e.text?this._getDecalTextKey(e):e.texture);if(i.map){i.map.flipY=true;i.needsUpdate=true;t.addRef(i.map)}else{o.error("Unable to apply texture, texture not found",e.texture,c)}}if(g(e,"target")){var n=this._targets.get(e._last.target);if(n){this._instanceDecals.get(n).delete(e)}n=this._targets.get(e.target);if(n){if(!this._instanceDecals.has(n)){this._instanceDecals.set(n,new Set)}this._instanceDecals.get(n).add(e)}}v(e,["position","direction","size","rotation","target","texture","text","planeOrigin","planeNormal"])};H.prototype._createDecal=function(e,r,i){this._root.updateMatrixWorld(true);var s=_(e.position);var n=_(e.direction).normalize();if(n.length()<1e-6){o.error("Unable create decal: direction is invalid","",c);return false}var l=p(t.toFloat(e.rotation));var d=_(e.size);if(d.length()<1e-6){o.error("Unable create decal: size is invalid","",c);return false}s.applyMatrix4(r.matrixWorld);n.transformDirection(r.matrixWorld);var u=new a.Raycaster(s,n);var h=u.intersectObject(r);if(!h.length){o.error("Unable create decal: cannot project decal to plane","",c);return false}if(!this._decalHelper){this._decalHelper=new a.Mesh(new a.BoxBufferGeometry(1,1,5));this._decalHelper.visible=false;this._decalHelper.layers.set(1);this._decalHelper.up.set(0,1,0);this._scene.add(this._decalHelper)}var f=h[0];var y=f.point;var g=n.clone().negate();var m=(new a.Box3).setFromObject(r);var x=m.max.clone().sub(m.min).length();g.multiplyScalar(x);g.add(y);this._decalHelper.position.copy(y);this._decalHelper.lookAt(g);this._decalHelper.rotation.z+=l;i=i||new a.MeshPhongMaterial({specular:4473924,shininess:0,opacity:.99,transparent:true,depthTest:true,depthWrite:false,polygonOffset:true,polygonOffsetUnits:.1,polygonOffsetFactor:-1});var v=new a.DecalGeometry(r,y,this._decalHelper.rotation,d);e.object3D=new a.Mesh(v,i);e.object3D.renderOrder=100;e.object3D.matrixAutoUpdate=false;e.object3D.layers.set(1);this._scene.add(e.object3D);return true};H.prototype._createPlane=function(e,t){var r=_(e.planeOrigin);var i=_(e.planeNormal).normalize();if(i.length()<1e-6){o.error("Unable to create plane for decal: normal is invalid","",c);return null}var s=new u(i.x===0?10:-i.x,i.y===0?-10:i.y,i.z===0?10:-i.z);var n=r.clone(r).add(s);n.sub(i.clone().multiplyScalar(i.dot(n.clone().sub(r))));var l=1e4;s=n.clone().sub(r).normalize();var d=i.clone().cross(s).normalize();s.multiplyScalar(l);d.multiplyScalar(l);var p=r.clone().add(s);var h=r.clone().sub(s);var f=r.clone().add(d);var y=r.clone().sub(d);var g=new a.BufferGeometry;g.setAttribute("position",new a.Float32BufferAttribute([p.x,p.y,p.z,f.x,f.y,f.z,h.x,h.y,h.z,h.x,h.y,h.z,y.x,y.y,y.z,p.x,p.y,p.z],3));g.setAttribute("normal",new a.Float32BufferAttribute([i.x,i.y,i.z,i.x,i.y,i.z,i.x,i.y,i.z,i.x,i.y,i.z,i.x,i.y,i.z,i.x,i.y,i.z],3));var m=new a.Mesh(g);t.add(m);return m};H.prototype._getDecalTarget=function(e){if(e.target){var t=this._targets.get(e.target);if(t){if(t.isBox||t.isCylinder){return t.object3D}else if(t.isPolygon){return this._polygonHandler.getTarget(t)}else if(t.isModel){return this._modelHandler.getTarget(t)}else{o.error("Unable to get decal's target","target instance type is unknown",c);return null}}}else if(e.planeOrigin&&e.planeNormal){return this._createPlane(e,this._root)}else{o.error("Unable to get/create decal's target","missing parameters",c);return null}};H.prototype._disposeDecalTarget=function(e,t){if(e.target){var r=this._targets.get(e.target);if(r){if(r.isPolygon||r.isModel){this._deleteObject3D(t)}}else{o.error("Unable to dispose decal's target","target not found",c)}}else{this._deleteObject3D(t)}};H.prototype._updateInstanceKeys=function(e){var t=this._getInstanceKeys(e);if(t){if(t.key!==e._last.key){this._targets.delete(e._last.key);this._targets.delete(e._last.group);this._targets.set(t.key,e);this._targets.set(t.group,e);e._last.key=t.key;e._last.group=t.group}}};H.prototype._removeInstanceKeys=function(e){var t=this._getInstanceKeys(e);if(t){this._targets.delete(t.key);this._targets.delete(t.group)}};H.prototype._getInstanceKeys=function(e){if(e.dataInstance){var t=e.voGroup.keyAttributeName;if(t){var r=e.dataInstance[t];if(r){return{key:r,group:e.voGroup.id+"."+r}}}}return null};H.prototype._deleteObject3D=function(e){e.traverse(function(e){if(e.geometry){if(t.refCountable(e.geometry)){t.subRef(e.geometry)}else{e.geometry.dispose()}}h(e.material).forEach(function(e){if(e.map){t.subRef(e.map)}e.dispose()})});e.parent.remove(e)};H.prototype._getBoxGeometry=function(e){if(e){return this._box6||(this._box6=w(e))}else{return this._box4||(this._box4=w(e))}};H.prototype._getCylinderGeometry=function(e){if(e){return this._cylinder||(this._cylinder=D(e))}else{return this._cylinderCaps||(this._cylinderCaps=D(e))}};H.prototype._getTextureLoader=function(){return this._textureLoader||(this._textureLoader=new a.TextureLoader)};w=function(e){var t=new a.BufferGeometry;t.setAttribute("position",new a.Float32BufferAttribute([.1,.1,-.1,-.1,-.1,-.1,-.1,.1,-.1,.1,.1,-.1,.1,-.1,-.1,-.1,-.1,-.1,.1,.1,.1,-.1,.1,.1,-.1,-.1,.1,.1,.1,.1,-.1,-.1,.1,.1,-.1,.1,.1,.1,-.1,.1,-.1,.1,.1,-.1,-.1,.1,.1,-.1,.1,.1,.1,.1,-.1,.1,.1,-.1,-.1,-.1,-.1,.1,-.1,-.1,-.1,.1,-.1,-.1,.1,-.1,.1,-.1,-.1,.1,-.1,-.1,-.1,-.1,.1,.1,-.1,.1,-.1,-.1,-.1,-.1,-.1,-.1,.1,-.1,.1,.1,.1,.1,.1,-.1,.1,-.1,-.1,.1,.1,.1,.1,.1,.1,.1,-.1,-.1,.1,-.1],3));t.setAttribute("normal",new a.Float32BufferAttribute([0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0],3));t.setAttribute("color",new a.Float32BufferAttribute([.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5],3));if(e){t.setAttribute("uv",new a.Float32BufferAttribute([2/3,.5,1,1,2/3,1,2/3,.5,1,.5,1,1,2/3,0,1,0,1,.5,2/3,0,1,.5,2/3,.5,2/3,.5,1/3,1,1/3,.5,2/3,.5,2/3,1,1/3,1,2/3,0,1/3,.5,1/3,0,2/3,0,2/3,.5,1/3,.5,1/3,.5,0,1,0,.5,1/3,.5,1/3,1,0,1,0,.5,1/3,0,1/3,.5,0,.5,0,0,1/3,0],2))}else{t.setAttribute("uv",new a.Float32BufferAttribute([.5,.5,1,1,.5,1,.5,.5,1,.5,1,1,1,.5,1,1,.5,1,1,.5,.5,1,.5,.5,.5,.5,0,1,0,.5,.5,.5,.5,1,0,1,.5,.5,1,0,1,.5,.5,.5,.5,0,1,0,.5,.5,0,1,0,.5,.5,.5,.5,1,0,1,0,.5,.5,0,.5,.5,0,.5,0,0,.5,0],2))}return t};D=function(e){var t=.1;return new a.CylinderGeometry(t,t,2*t,24,1,e)};return H});
//# sourceMappingURL=SceneBuilder.js.map