/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/base/util/isEmptyObject","sap/base/util/merge","sap/base/util/restricted/_omit","sap/ui/dt/AggregationOverlay","sap/ui/dt/ElementOverlay","sap/ui/dt/OverlayRegistry","sap/ui/dt/Util","sap/ui/fl/apply/api/ExtensionPointRegistryAPI","sap/ui/fl/Utils","sap/ui/core/mvc/View","sap/ui/base/DesignTime"],function(e,t,n,i,a,r,s,o,g,l,d,u,m){"use strict";function v(e,t){var n=l.getExtensionPointInfoByViewId({viewId:e});return a(n,t)}function c(e){return a(e,["bIsView"])}return function(p,f){var h={};h.mExtensionPointMetadata={palette:{icons:{svg:"sap/ui/core/designtime/Icon.icon.svg"}}};h._aConsideredExtensionPoints=[];h._attachNotConsideredExtensionPoints=function(e,t){var n=d.getViewForControl(e.getElement()).getId();var i=v(n,this._aConsideredExtensionPoints);Object.keys(i).forEach(function(e,a){var r=i[e];var s=this._getExtensionPointData(r);s.id=n;t.elements.splice(a,0,s);this._aConsideredExtensionPoints.push(s.name)}.bind(this))};h._getOutline=function(e,t){var n;if(!t&&g.isInteger(e)){t=e;e=undefined}var i=[];if(!e){i=p._oDesignTime.getRootElements().map(function(e){return o.getOverlay(e)})}else{var a=o.getOverlay(e);if(!a){throw g.createError("services.Outline#get",`Cannot find element with id= ${e}. A valid or empty value for the initial element id should be provided.`,"sap.ui.rta")}i.push(a)}n=i.map(function(e){return this._getChildrenNodes(e,t)},this);this._aConsideredExtensionPoints=[];return n};h._getExtensionPoints=function(e){var t=e.id;var n=e.technicalName;return l.getExtensionPointInfoByParentId({parentId:t}).filter(function(e){return e.aggregationName===n})};h._getExtensionPointData=function(e){return{id:e.targetControl.getId(),name:e.name,technicalName:"sap.ui.extensionpoint",type:"extensionPoint",icon:this.mExtensionPointMetadata.palette.icons.svg,extensionPointInfo:{defaultContent:e.defaultContent.map(function(e){return e.getId()}),createdControls:e.createdControls||[]}}};h._enrichExtensionPointData=function(e,t){var n=m.isDesignModeEnabled();if(!n){return undefined}if(e.type==="aggregation"){var i=this._getExtensionPoints(e).sort(function(e,t){return t.index-e.index});i.forEach(function(t){var n=this._getExtensionPointData(t);e.elements.splice(t.index,0,n);this._aConsideredExtensionPoints.push(n.name)}.bind(this))}else if(e.bIsView){return this._attachNotConsideredExtensionPoints(t,e)}return undefined};function y(e,t,n){var i=e.getAggregationName&&e.getAggregationName();if(i){var a=e.getParent().getId();if(n[i]){return{templateFor:a,...n[i]}}return(t&&t.elements||[]).map(function(e){if(e.type==="aggregationBindingTemplate"||e.parentAggregationName===i){return{templateFor:a,...e}}return e.technicalName===i&&e}).filter(Boolean)[0]}var r=e.getParentElementOverlay().getAggregationBindingTemplateOverlays&&e.getParentElementOverlay().getAggregationBindingTemplateOverlays().reduce(function(e,t){return e.concat(t.getChildren())},[])||[];if(r.includes(e)){return undefined}if(!t){return undefined}var s=e.getParentElementOverlay();if(s.getId()===t.templateFor){return t}var o=e.getParent().getChildren().indexOf(e);return t.elements[o]}h._getChildrenNodes=function(e,t,a,r){var s=g.isInteger(t);var o={};if(e.getShouldBeDestroyed()){return{}}var l=this._getNodeProperties(e,a,r)||{};var d=e.getChildren();var u=e.getAggregationBindingTemplateOverlays&&e.getAggregationBindingTemplateOverlays()||[];if(u.length>0){d=u.reduce(function(e,t){var n=t.getChildren()[0];o[n.getId()]=t.getAggregationName();return[n].concat(e)},d)}if((!s||s&&t>0)&&d.length>0&&!n(l)){t=s?t-1:t;var m={};l.elements=d.map(function(e){var n=y(e,r,m);var a=this._getChildrenNodes(e,t,e.getParent(),n);if(a.type==="aggregationBindingTemplate"){var s=o[e.getId()];m[s]=i({},a)}return a},this).filter(function(e){return!n(e)});this._enrichExtensionPointData(l,e)}return c(l)};function E(e,t,n){var i=e.getParentElementOverlay();return i&&n&&i.getAggregationOverlay(n,"AggregationBindingTemplateOverlays")===t}function _(e,t,n){var i={editable:e.getEditable(),bIsView:e.getElement()instanceof u};if(t.isA("sap.ui.core.Component")){i.component=true}if(typeof e.isVisible()==="boolean"){i.visible=e.isVisible()}var a=e.getParent()&&e.getParentAggregationOverlay();var r=a&&a.getAggregationName()||"";if(E(e,a,r)){i.type="aggregationBindingTemplate";i.icon="sap-icon://attachment-text-file";i.parentAggregationName=r}else{i.type="element"}var s=n.getName(t);if(s&&s.singular){i.name=s&&s.singular}return i}function O(e,t,n){var i=e.getAggregationName();var a={technicalName:e.getAggregationName(),editable:false,type:"aggregation",bIsView:e.getElement()instanceof u};if(t.getAggregation(i)){var r=t.getDesignTimeMetadata().getAggregationDescription(i,n);if(r.singular){a.name=r.singular}}if(t.getAggregationBindingTemplateOverlays().length){a.icon="sap-icon://card"}return a}function b(e,t,n){var i={id:e.getId(),technicalName:e.getMetadata().getName(),editable:false,type:null};if(n){i.templateReference=n.id}var a=P(t);if(a){i.icon=a}var r=t.getLabel(e);if(r&&r!==i.id){i.instanceName=r}return i}function P(e){var t=e.getData();return t.palette&&t.palette.icons&&t.palette.icons.svg||undefined}h._getNodeProperties=function(e,t,n){var i=e.getElement();var a=e.getDesignTimeMetadata();var r=b(i,a,n);if(e instanceof s){return{...r,..._(e,i,a)}}return{...r,...O(e,t,i)}};h._removeDuplicate=function(e,n){return e.filter(function(e){return!t(n,e,Infinity)})};h._updatesHandler=function(t){var n=t.getParameters();if(this.sStatus==="initial"){this.aUpdates=[]}var s=i({},n);var g=s.id?o.getOverlay(s.id).getElement().getId():undefined;var l=s.targetId?o.getOverlay(s.targetId).getElement().getId():undefined;switch(t.getId()){case"elementOverlayCreated":if(n.elementOverlay.isRoot()){var d=n.elementOverlay.getElement().getId();[s.element]=h._getOutline(d);s.type="new";break}return;case"elementOverlayAdded":[s.element]=h._getOutline(g);s.targetId=l;s.type="new";break;case"elementOverlayMoved":[s.element]=h._getOutline(g,0);s.targetId=l;s.type="move";break;case"elementOverlayDestroyed":var u=s.elementOverlay.getParentAggregationOverlay();if(u instanceof r&&!u._bIsBeingDestroyed||s.elementOverlay.isRoot()){s.element={};s.element.id=s.elementOverlay.getElement()?s.elementOverlay.getElement().getId():s.elementOverlay.getAssociation("element");s.type="destroy";break}return;case"elementOverlayEditableChanged":s.element={id:g,editable:s.editable};s.type="editableChange";break;case"elementPropertyChanged":[s.element]=h._getOutline(g,0);s.type="elementPropertyChange";break;default:e.error("Event type is not 'expected' by handler")}s=a(s,["elementOverlay","editable","target","id","elementId"]);this.aUpdates=h._removeDuplicate(this.aUpdates,s);this.aUpdates.push(s);if(this.sStatus==="initial"){setTimeout(function(){if(Array.isArray(this.aUpdates)&&this.aUpdates.length>0){this.sStatus="initial";f("update",this.aUpdates)}}.bind(h),200)}this.sStatus="processing"};h.destroy=function(){p._oDesignTime?.detachEvent("elementOverlayCreated",this._updatesHandler,this);p._oDesignTime?.detachEvent("elementOverlayAdded",this._updatesHandler,this);p._oDesignTime?.detachEvent("elementOverlayMoved",this._updatesHandler,this);p._oDesignTime?.detachEvent("elementOverlayDestroyed",this._updatesHandler,this);p._oDesignTime?.detachEvent("elementPropertyChanged",this._updatesHandler,this);p._oDesignTime?.detachEvent("elementOverlayEditableChanged",this._updatesHandler,this);delete this.aUpdates;delete this.sStatus};h.aUpdates=[];h.sStatus="initial";p._oDesignTime.attachEvent("elementOverlayCreated",h._updatesHandler,h);p._oDesignTime.attachEvent("elementOverlayAdded",h._updatesHandler,h);p._oDesignTime.attachEvent("elementOverlayMoved",h._updatesHandler,h);p._oDesignTime.attachEvent("elementOverlayDestroyed",h._updatesHandler,h);p._oDesignTime.attachEvent("elementPropertyChanged",h._updatesHandler,h);p._oDesignTime.attachEvent("elementOverlayEditableChanged",h._updatesHandler,h);return{events:["update"],exports:{get:h._getOutline.bind(h)},destroy:h.destroy.bind(h)}}});
//# sourceMappingURL=Outline.js.map