/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/m/MessageBox","sap/ui/base/ManagedObject","sap/ui/core/Element","sap/ui/core/Lib","sap/ui/dt/ElementOverlay","sap/ui/dt/OverlayRegistry","sap/ui/dt/OverlayUtil","sap/ui/dt/Util","sap/ui/fl/variants/VariantManagement","sap/ui/fl/variants/VariantManager","sap/ui/fl/write/api/ContextSharingAPI","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/rta/plugin/rename/RenameDialog","sap/ui/rta/plugin/Plugin","sap/ui/rta/Utils"],function(t,e,n,a,i,r,o,s,c,g,l,m,u,d,h,p,f){"use strict";r.prototype._variantManagement=undefined;r.prototype.getVariantManagement=function(){return this._variantManagement};r.prototype.setVariantManagement=function(t){this._variantManagement=t};r.prototype.hasVariantManagement=function(){return!!this._variantManagement};function V(t){const e=t.getElement().getManageDialog();if(e&&!e.bIsDestroyed){e.destroy()}}const A=p.extend("sap.ui.rta.plugin.ControlVariant",{metadata:{library:"sap.ui.rta",properties:{oldValue:"string"},associations:{},events:{}}});function y(t){const e=t.getElement();const n=t.getDesignTimeMetadata();const a=t.getVariantManagement();return this.getCommandFactory().getCommandFor(e,"save",{},n,a)}function _(t,e,n,a){const i=t.getElement();const r=t.getDesignTimeMetadata();return this.getCommandFactory().getCommandFor(i,"switch",{targetVariantReference:e,sourceVariantReference:n,discardVariantContent:a},r)}A.prototype.init=function(...t){p.prototype.init.apply(this,t);this._oDialog=new h};A.prototype.registerElementOverlay=function(...t){const[e]=t;const i=e.getElement();let r;p.prototype.registerElementOverlay.apply(this,t);if(i instanceof g){const t=i.getFor();const s=d.getAppComponentForControl(i);const c=i.getId();r=s.getLocalId(c)||c;e.setVariantManagement(r);if(!t||Array.isArray(t)&&t.length===0){return}const g=!Array.isArray(t)?[t]:t;g.forEach(function(t){const e=t instanceof n?t:a.getElementById(t);const i=o.getOverlay(e);if(!i){const e=(t,n)=>{const a=t.getParameter("elementOverlay");if(a.getElement().getId()===n){this._propagateVariantManagement(a,r);this.getDesignTime().detachEvent("elementOverlayCreated",e)}};this.getDesignTime().attachEvent("elementOverlayCreated",t,e,this)}else{this._propagateVariantManagement(i,r)}}.bind(this));V(e)}else if(!e.getVariantManagement()){r=this._getVariantManagementFromParent(e);if(r){e.setVariantManagement(r)}}};A.prototype._isPersonalizationMode=function(){return this.getCommandFactory().getFlexSettings().layer===u.USER};A.prototype._propagateVariantManagement=function(t,e){t.setVariantManagement(e);let n=s.getAllChildOverlays(t);n.forEach(function(t){n=n.concat(this._propagateVariantManagement(t,e))}.bind(this));return n};A.prototype._getVariantManagementFromParent=function(t){const e=t.getVariantManagement();if(!e&&t.getParentElementOverlay()){return this._getVariantManagementFromParent(t.getParentElementOverlay())}return e};A.prototype.deregisterElementOverlay=function(...t){const e=t[0];if(this._isVariantManagementControl(e)){V(e)}this.removeFromPluginsList(e);p.prototype.deregisterElementOverlay.apply(this,t)};A.prototype._isEditable=function(t){if(this._isPersonalizationMode()){return false}return this._isVariantManagementControl(t)&&this.hasStableId(t)};A.prototype._isVariantManagementControl=function(t){const e=t.getElement();const n=e.getAssociation("for");return!!(n&&e instanceof g)};A.prototype.isVariantSwitchAvailable=function(t){return this._isVariantManagementControl(t)};A.prototype.isVariantSwitchEnabled=function(t){const e=t[0];if(this._isVariantManagementControl(e)){const t=e.getElement();const n=e.getVariantManagement?e.getVariantManagement():undefined;if(!n){return false}const a=t.getVariants().reduce(function(t,e){if(e.getVisible()){return t.concat(e)}return t},[]);const i=a.length>1;return i}return false};A.prototype.isRenameAvailable=function(t){return this._isVariantManagementControl(t)};A.prototype.isRenameEnabled=function(t){return this._isVariantManagementControl(t[0])};A.prototype.isVariantSaveAvailable=function(t){return this._isVariantManagementControl(t)};A.prototype.isVariantSaveEnabled=function(t){const e=t[0];const n=e.getElement();return n.getModified()};A.prototype.isVariantSaveAsAvailable=function(t){return this._isVariantManagementControl(t)};A.prototype.isVariantSaveAsEnabled=function(t){return this._isVariantManagementControl(t[0])};A.prototype.isVariantConfigureAvailable=function(t){return this._isVariantManagementControl(t)};A.prototype.isVariantConfigureEnabled=function(t){return this._isVariantManagementControl(t[0])};A.prototype.switchVariant=function(t,n,a){const r=t.getElement();const o=i.getResourceBundleFor("sap.ui.rta");function s(i){if(i===e.Action.CANCEL){return}if(i===o.getText("BTN_MODIFIED_VARIANT_SAVE")){let e;this.getCommandFactory().getCommandFor(r,"composite").then(function(n){e=n;return y.call(this,t)}.bind(this)).then(function(i){e.addCommand(i);return _.call(this,t,n,a)}.bind(this)).then(function(t){e.addCommand(t);this.fireElementModified({command:e})}.bind(this))}if(i===o.getText("BTN_MODIFIED_VARIANT_DISCARD")){_.call(this,t,n,a,true).then(function(t){this.fireElementModified({command:t})}.bind(this))}}if(r.getModified()){e.warning(o.getText("MSG_CHANGE_MODIFIED_VARIANT"),{onClose:s.bind(this),actions:[o.getText("BTN_MODIFIED_VARIANT_SAVE"),o.getText("BTN_MODIFIED_VARIANT_DISCARD"),e.Action.CANCEL],emphasizedAction:o.getText("BTN_MODIFIED_VARIANT_SAVE"),styleClass:f.getRtaStyleClassName(),id:"controlVariantWarningDialog"})}else{_.call(this,t,n,a).then(function(t){this.fireElementModified({command:t})}.bind(this)).catch(function(t){throw c.createError("ControlVariant#switchVariant",t,"sap.ui.rta")})}};A.prototype.renameVariant=async function(t){const[e]=t;const n=e.getVariantManagement();const a=e.getDesignTimeMetadata();const i=e.getElement();const r=a.getData().variantRenameDomRef;const o=await this._oDialog.openDialogAndHandleRename({overlay:e,domRef:r,action:this.getAction(e)});if(!o){return}const s=await this._createSetTitleCommand({text:o,element:i,designTimeMetadata:a,variantManagementReference:n});this.fireElementModified({command:s})};A.prototype.createSaveCommand=function(t){const e=t[0];return y.call(this,e).then(function(t){this.fireElementModified({command:t})}.bind(this))};A.prototype.createSaveAsCommand=function(t){const e=t[0];const n=e.getElement();const a=e.getDesignTimeMetadata();const i=e.getVariantManagement();return this.getCommandFactory().getCommandFor(n,"saveAs",{sourceVariantReference:n.getCurrentVariantKey()},a,i).then(function(t){this.fireElementModified({command:t})}.bind(this))};A.prototype._createSetTitleCommand=function(e){return this.getCommandFactory().getCommandFor(e.element,"setTitle",{newText:e.text},e.designTimeMetadata,e.variantManagementReference).catch(function(e){t.error("Error during rename: ",e)})};A.prototype.configureVariants=function(t){const e=t[0];const n=e.getElement();const a=e.getVariantManagement();const i=e.getDesignTimeMetadata();const r=this.getCommandFactory().getFlexSettings();const o=r;o.variantManagementControl=n;return l.manageVariants(n,a,r.layer,f.getRtaStyleClassName(),m.createComponent(o)).then(function(t){if(t.changes.length>0){return this.getCommandFactory().getCommandFor(n,"configure",{control:n,changes:t.changes,deletedVariants:t.variantsToBeDeleted},i,a)}return undefined}.bind(this)).then(function(t){if(t){this.fireElementModified({command:t})}}.bind(this)).catch(function(t){throw c.createError("ControlVariant#configureVariants",t,"sap.ui.rta")})};A.prototype.getMenuItems=function(t){const e=t[0];const n=e.getElement();const a=[];if(this.isRenameAvailable(e)){a.push({id:"CTX_VARIANT_SET_TITLE",text:i.getResourceBundleFor("sap.ui.rta").getText("CTX_RENAME"),handler:this.renameVariant.bind(this),enabled:this.isRenameEnabled.bind(this),rank:this.getRank("CTX_VARIANT_SET_TITLE"),icon:"sap-icon://edit"})}if(this.isVariantSaveAvailable(e)){a.push({id:"CTX_VARIANT_SAVE",text:i.getResourceBundleFor("sap.ui.rta").getText("CTX_VARIANT_SAVE"),handler:this.createSaveCommand.bind(this),enabled:this.isVariantSaveEnabled.bind(this),rank:this.getRank("CTX_VARIANT_SAVE"),icon:"sap-icon://save"})}if(this.isVariantSaveAsAvailable(e)){a.push({id:"CTX_VARIANT_SAVEAS",text:i.getResourceBundleFor("sap.ui.rta").getText("CTX_VARIANT_SAVEAS"),handler:this.createSaveAsCommand.bind(this),enabled:this.isVariantSaveAsEnabled.bind(this),rank:this.getRank("CTX_VARIANT_SAVEAS"),icon:"sap-icon://duplicate"})}if(this.isVariantConfigureAvailable(e)){a.push({id:"CTX_VARIANT_MANAGE",text:i.getResourceBundleFor("sap.ui.rta").getText("CTX_VARIANT_MANAGE"),handler:this.configureVariants.bind(this),enabled:this.isVariantConfigureEnabled.bind(this),startSection:true,rank:this.getRank("CTX_VARIANT_MANAGE"),icon:"sap-icon://action-settings"})}if(this.isVariantSwitchAvailable(e)){const t=n.getVariantByKey(n.getCurrentVariantKey());const e=n.getVariants().reduce(function(e,n){if(n.getVisible()){const a=t.getKey()===n.getKey();const i={id:n.getKey(),text:n.getTitle(),icon:a?"sap-icon://accept":"blank",enabled:!a};return e.concat(i)}return e},[]);a.push({id:"CTX_VARIANT_SWITCH_SUBMENU",text:i.getResourceBundleFor("sap.ui.rta").getText("CTX_VARIANT_SWITCH"),handler:function(e,n){const a=n.eventItem.getParameters().item.getProperty("key");const i=e[0];const r=t.getKey();return this.switchVariant(i,a,r)}.bind(this),enabled:this.isVariantSwitchEnabled.bind(this),submenu:e,rank:this.getRank("CTX_VARIANT_SWITCH_SUBMENU"),icon:"sap-icon://switch-views"})}return a};A.prototype.getActionName=function(){return"controlVariant"};A.prototype.destroy=function(...t){p.prototype.destroy.apply(this,t);this._oDialog.destroy();delete this._oDialog};return A});
//# sourceMappingURL=ControlVariant.js.map