/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/base/DesignTime","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/dt/Util","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/Utils","sap/ui/rta/plugin/annotations/AnnotationChangeDialog","sap/ui/rta/plugin/annotations/AnnotationTypes","sap/ui/rta/plugin/Plugin"],function(t,e,n,i,o,a,s,r,l){"use strict";async function c(t,e,n,i){const o=await this.getCommandFactory().getCommandFor(t,"composite");for(const a of n){if(a.content.text&&!a.content.textType){a.content.textType="XFLD"}const n=await this.getCommandFactory().getCommandFor(t,"annotation",{changeType:e.changeType,serviceUrl:a.serviceUrl,content:{...a.content,objectTemplateInfo:e.objectTemplateInfo},changesToDelete:i});o.addCommand(n)}if(o.getCommands().length>0){this.fireElementModified({command:o})}}function p(e,n){const i=n.title;const o=e.getElement();if(i){if(typeof i==="function"){return i(o)}const t=e.getDesignTimeMetadata()?.getLibraryText(o,i);if(t){return t}}t.error("Annotation action title is not properly defined in the designtime metadata");return undefined}function u(e){const n=e.type===r.StringType?"sap-icon://edit":"sap-icon://request";const i=e.icon;if(!i){return n}if(typeof i!=="string"){t.error("Icon setting for annotation action should be a string");return n}return i}function g(e){if(e.singleRename&&!e.controlBasedRenameChangeType){t.error("When using singleRename, controlBasedRenameChangeType must also be defined");return false}return true}const d=l.extend("sap.ui.rta.plugin.annotations.AnnotationPlugin",{metadata:{library:"sap.ui.rta",associations:{},events:{}}});const f="CTX_ANNOTATION";const h="CTX_ANNOTATION_CHANGE_SINGLE_LABEL";d.prototype.init=function(...t){l.prototype.init.apply(this,t);this._oDialog=new s};d.prototype._isEditable=function(t){if(e.isDesignModeEnabled()){return false}const n=this.getAction(t);if(n){return Object.values(n).some(t=>t.changeType)}return false};d.prototype.isEnabled=function(t){if(t.length!==1){return false}const e=t[0];const n=this.getResponsibleElementOverlay(e);const i=this.getAction(n);if(i){return Object.values(i).some(t=>{if(typeof t.isEnabled!=="undefined"){if(typeof t.isEnabled==="function"){return t.isEnabled(n.getElement())}return t.isEnabled}return true})}return false};d.prototype.handler=async function(t,e){const s=t[0];const r=s.getElement();try{const t=await this._oDialog.openDialogAndHandleChanges({title:p(s,e),type:e.type,control:r,delegate:e.delegate,annotation:e.annotation,description:e.description,singleRename:e.singleRename,controlBasedRenameChangeType:e.controlBasedRenameChangeType});if(t.length){const i=[];if(e.singleRename){const t=await o._getUIChanges({selector:r});const s=a.getAppComponentForControl(r);i.push(...t.filter(t=>t.getChangeType()===e.controlBasedRenameChangeType&&n.getControlIdBySelector(t.getSelector(),s)===r.getId()))}return c.call(this,r,e,t,i)}return undefined}catch(t){throw i.propagateError(t,"AnnotationPlugin#handler","Error occurred during handler execution","sap.ui.rta.plugin.annotations.AnnotationPlugin")}};d.prototype.getMenuItems=async function(t){const e=t[0];const n=this.getResponsibleElementOverlay(e);const i=this.getAction(n);const o=[];if(i){if(this._isEditableByPlugin(n)===undefined){await this.evaluateEditable([n],{onRegistration:false})}Object.entries(i).forEach(function([e,i],a){const s=i.type===r.StringType&&i.singleRename?h:f;const l=this.getRank(s);if(this.isAvailable([n])&&g(i)){const r=p(n,i);if(!r){return}o.push({id:`${s}_${e}`,rank:l+a,text:r,icon:u(i),enabled:typeof i.isEnabled==="function"&&i.isEnabled(t[0].getElement())||i.isEnabled!==false&&this.isEnabled(t),handler:this.handler.bind(this,t,i),additionalInfo:this._getAdditionalInfo(n,i)})}},this)}return o};d.prototype.getActionName=function(){return"annotation"};d.prototype.destroy=function(...t){l.prototype.destroy.apply(this,t);this._oDialog.destroy();delete this._oDialog};return d});
//# sourceMappingURL=AnnotationPlugin.js.map