/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/isEmptyObject","sap/m/MessageBox","sap/ui/core/Lib","sap/ui/dt/OverlayRegistry","sap/ui/dt/Util","sap/ui/fl/write/api/ContextSharingAPI","sap/ui/rta/plugin/rename/RenameDialog","sap/ui/rta/plugin/Plugin","sap/ui/rta/Utils"],function(t,e,n,a,i,r,o,s,c,l){"use strict";var d=c.extend("sap.ui.rta.plugin.CompVariant",{metadata:{library:"sap.ui.rta",properties:{oldValue:{type:"string"}}}});function g(t){return t.getMetadata().getName()==="sap.ui.comp.smartvariants.SmartVariantManagement"}function u(t,e,n,a){var i=t.getDesignTimeMetadata();var o=a||t.getElement();return Promise.resolve().then(function(){if(e.length===1){return this.getCommandFactory().getCommandFor(o,e[0],n,i)}var t;return this.getCommandFactory().getCommandFor(o,"composite").then(function(a){t=a;var r=[];e.forEach(function(t){r.push(this.getCommandFactory().getCommandFor(o,t,n[t],i))}.bind(this));return Promise.all(r).then(function(e){e.forEach(t.addCommand.bind(t));return t})}.bind(this))}.bind(this)).then(function(t){this.fireElementModified({command:t})}.bind(this)).catch(function(t){throw r.createError(e[0],t,"sap.ui.rta.plugin.CompVariant")})}function p(t){return t.getElement().getAllVariants()}d.prototype.init=function(...t){c.prototype.init.apply(this,t);this._oDialog=new s};async function m(t){const[e]=t;const n=e.getElement().getPresentVariantId();const a=e.getDesignTimeMetadata().getData().variantRenameDomRef;const i=await this._oDialog.openDialogAndHandleRename({overlay:e,domRef:a,action:this.getAction(e)});if(!i){return}const r={newVariantProperties:{[n]:{name:i}}};u.call(this,e,["compVariantUpdate"],r)}d.prototype.isRenameAvailable=function(t){const e=t.getElement();if(g(e)){const n=p(t);const a=n.find(function(t){return t.getVariantId()===e.getPresentVariantId()});const i=this.getCommandFactory().getFlexSettings().layer;return a.isRenameEnabled(i)}return false};d.prototype.isRenameEnabled=function(t){return this.isRenameAvailable(t[0])};function h(n){var a=n[0].getElement();var i=this.getCommandFactory().getFlexSettings();i.variantManagementControl=a;const r=a.getCurrentVariantId();var s={layer:this.getCommandFactory().getFlexSettings().layer,contextSharingComponentContainer:o.createComponent(i),rtaStyleClass:l.getRtaStyleClassName()};a.openManageViewsDialogForKeyUser(s,function(i){if(!e(i)){u.call(this,n[0],["compVariantUpdate"],{newVariantProperties:t(i,["default"]),newDefaultVariantId:i.default,oldDefaultVariantId:a.getDefaultVariantId(),oldSelectedVariantId:r})}}.bind(this))}function A(t,e,i){if(i===n.Action.CANCEL){return}var r=a.getResourceBundleFor("sap.ui.rta");var o=t.getElement();var s;if(i===r.getText("BTN_MODIFIED_VARIANT_SAVE")){C(o).then(function(n){s={compVariantSwitch:{targetVariantId:e,sourceVariantId:o.getPresentVariantId()},compVariantUpdate:n};u.call(this,t,["compVariantUpdate","compVariantSwitch"],s)}.bind(this))}if(i===r.getText("BTN_MODIFIED_VARIANT_DISCARD")){u.call(this,t,["compVariantSwitch"],{targetVariantId:e,sourceVariantId:o.getPresentVariantId(),discardVariantContent:true})}}function V(t){return p(t[0]).length>1}function f(t,e){var i=t[0];var r=i.getElement();if(r.getModified()){var o=a.getResourceBundleFor("sap.ui.rta");var s=e.eventItem.getParameters().item.getProperty("key");n.warning(o.getText("MSG_CHANGE_MODIFIED_VARIANT"),{onClose:A.bind(this,i,s),actions:[o.getText("BTN_MODIFIED_VARIANT_SAVE"),o.getText("BTN_MODIFIED_VARIANT_DISCARD"),n.Action.CANCEL],emphasizedAction:o.getText("BTN_MODIFIED_VARIANT_SAVE"),styleClass:l.getRtaStyleClassName(),id:"compVariantWarningDialog"})}else{u.call(this,i,["compVariantSwitch"],{targetVariantId:e.eventItem.getParameters().item.getProperty("key"),sourceVariantId:r.getPresentVariantId()})}}function C(t){return t.getPresentVariantContent().then(function(e){var n={onlySave:true,newVariantProperties:{}};n.newVariantProperties[t.getPresentVariantId()]={content:e};return n})}function _(t){var e=t[0].getElement();C(e).then(function(e){u.call(this,t[0],["compVariantUpdate"],e)}.bind(this))}function I(t){return t[0].getElement().currentVariantGetModified()}function T(t,e){var n=t[0].getElement();var a=this.getCommandFactory().getFlexSettings();a.variantManagementControl=n;var i=o.createComponent(a);return new Promise(function(a){n.openSaveAsDialogForKeyUser(l.getRtaStyleClassName(),function(i){if(i){u.call(this,t[0],["compVariantSaveAs"],{newVariantProperties:{default:i.default,executeOnSelection:i.executeOnSelection,content:i.content,type:i.type,text:i.text,contexts:i.contexts},previousDirtyFlag:n.getModified(),previousVariantId:n.getPresentVariantId(),previousDefault:n.getDefaultVariantId(),activateAfterUndo:!!e})}a(i)}.bind(this),i)}.bind(this))}function E(t,e,n){var r=a.getResourceBundleFor("sap.ui.rta");if(n===r.getText("BTN_CREATE_NEW_VIEW")){T.call(this,[i.getOverlay(t)],true).then(function(n){if(!n){t.activateVariant(e)}})}else{t.activateVariant(e)}}function v(t,e){var i=a.getResourceBundleFor("sap.ui.rta");var r=e[0];var o=r.getElement();t=t.action||t;var s=o.getVariantManagement();var c=s.getModified();return t.handler(o,{styleClass:l.getRtaStyleClassName()}).then(function(t){if(t&&t.length){var e=t[0].changeSpecificData.content.persistencyKey;var a=s.getAllVariants();var o=a.find(function(t){return t.getVariantId()===s.getPresentVariantId()});if(o.isEditEnabled(this.getCommandFactory().getFlexSettings().layer)){u.call(this,r,["compVariantContent"],{variantId:t[0].changeSpecificData.content.key,newContent:t[0].changeSpecificData.content.content,persistencyKey:e,isModifiedBefore:c},s)}else{n.warning(i.getText("MSG_CHANGE_READONLY_VARIANT"),{onClose:E.bind(this,s,o.getVariantId()),actions:[i.getText("BTN_CREATE_NEW_VIEW"),n.Action.CANCEL],emphasizedAction:i.getText("BTN_CREATE_NEW_VIEW"),styleClass:l.getRtaStyleClassName()})}}}.bind(this))}d.prototype._isEditable=function(t){return this.hasStableId(t)&&!!this.getAction(t)};d.prototype.getMenuItems=function(t){var e=t[0];var n=e.getElement();const i=this.getAction(e);var r=[];if(this.isAvailable([e])){if(i){if(i.changeType==="variantContent"){r.push({id:"CTX_COMP_VARIANT_CONTENT",additionalInfo:this._getAdditionalInfo(e,i),text:this.getActionText(e,i),handler:v.bind(this,i),enabled:true,rank:this.getRank("CTX_COMP_VARIANT_CONTENT"),icon:"sap-icon://key-user-settings"})}else{var o=this.getCommandFactory().getFlexSettings().layer;var s=a.getResourceBundleFor("sap.ui.rta");var c=p(e);var l=c.find(function(t){return t.getVariantId()===n.getPresentVariantId()});if(l.isRenameEnabled(o)){r.push({id:"CTX_COMP_VARIANT_RENAME",text:s.getText("CTX_RENAME"),handler:m.bind(this),enabled:true,rank:this.getRank("CTX_COMP_VARIANT_RENAME"),icon:"sap-icon://edit"})}if(l.isEditEnabled(o)){r.push({id:"CTX_COMP_VARIANT_SAVE",text:s.getText("CTX_VARIANT_SAVE"),handler:_.bind(this),enabled:I,rank:this.getRank("CTX_COMP_VARIANT_SAVE"),icon:"sap-icon://save"})}r.push({id:"CTX_COMP_VARIANT_SAVE_AS",text:s.getText("CTX_VARIANT_SAVEAS"),handler:T.bind(this),enabled:true,rank:this.getRank("CTX_COMP_VARIANT_SAVE_AS"),icon:"sap-icon://duplicate"});r.push({id:"CTX_COMP_VARIANT_MANAGE",text:s.getText("CTX_VARIANT_MANAGE"),handler:h.bind(this),enabled:true,rank:this.getRank("CTX_COMP_VARIANT_MANAGE"),icon:"sap-icon://action-settings"});var d=c.map(function(t){var e=n.getPresentVariantId()===t.getVariantId();var a={id:t.getVariantId(),text:t.getText("variantName"),icon:e?"sap-icon://accept":"blank",enabled:!e};return a});r.push({id:"CTX_COMP_VARIANT_SWITCH",text:s.getText("CTX_VARIANT_SWITCH"),handler:f.bind(this),enabled:V,submenu:d,rank:this.getRank("CTX_COMP_VARIANT_SWITCH"),icon:"sap-icon://switch-views"})}}}return r};d.prototype.getActionName=function(){return"compVariant"};d.prototype.destroy=function(...t){c.prototype.destroy.apply(this,t);this._oDialog.destroy();delete this._oDialog};return d});
//# sourceMappingURL=CompVariant.js.map