/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/dt/ElementUtil","sap/ui/dt/OverlayRegistry","sap/ui/dt/Util","sap/ui/fl/Utils","sap/ui/rta/Utils"],function(e,t,n,a,r,o){"use strict";const i={};function s(e,t){let n;e.reveal.elements.some(function(e){if(e.element.getId()===t.getId()){n=e;return false}return undefined});return n}async function g(t){const n=await c(t.selectedElement,t.actions,t.parents,t.plugin);t.compositeCommand.addCommand(n);const a=await d(t.selectedElement,t.parents,t.siblingElement,t.index,t.targetAggregation,t.plugin);if(a){t.compositeCommand.addCommand(a)}else{e.warning(`No move action configured for ${t.parents.parent.getMetadata().getName()}, aggregation: ${t.selectedElement.aggregation}`,"sap.ui.rta")}return t.compositeCommand}function c(e,a,r,o){const i=t.getElementInstance(e.elementId);const g=n.getOverlay(i);const c=s(a,i);const d=g?o.getVariantManagementReference(g):undefined;if(c.action.changeOnRelevantContainer){return o.getCommandFactory().getCommandFor(i,"reveal",{revealedElementId:i.getId(),directParent:r.parent},c.designTimeMetadata,d)}return o.getCommandFactory().getCommandFor(i,"reveal",{},c.designTimeMetadata,d)}function d(e,a,r,i,s,g){const c=t.getElementInstance(e.elementId);const d=n.getOverlay(c);const m=d.getParentElementOverlay().getElement()||a.parent;const l=o.getIndex(a.parent,r,s);const p=o.getIndex(m,c,e.sourceAggregation)-1;const u=i!==undefined?i:t.adjustIndexForMove(m,a.parent,p,l);if(u!==p||a.parent!==c.getParent()||e.sourceAggregation!==s){const t=n.getOverlay(c)?n.getOverlay(c).getParentAggregationOverlay():a.relevantContainerOverlay;const r=t.getDesignTimeMetadata();const o=g.getVariantManagementReference(d);return g.getCommandFactory().getCommandFor(a.relevantContainer,"move",{movedElements:[{element:c,sourceIndex:p,targetIndex:u}],source:{parent:m,aggregation:e.sourceAggregation},target:{parent:a.parent,aggregation:s}},r,o)}return Promise.resolve()}function m(e,t){const n=e.getManifestEntry("/sap.ui5/dependencies/libs");return Object.keys(t).some(function(e){return!n[e]||n[e].lazy})}function l(e,t,n,a){if(t){const o=r.getAppComponentForControl(e.relevantContainer);if(m(o,t)){const r=o.getManifest();const i=r["sap.app"].id;return a.getCommandFactory().getCommandFor(e.publicParent,"addLibrary",{reference:i,parameters:{libraries:t},appComponent:o},n)}}return Promise.resolve()}async function p(e){const t=e.actions.addViaDelegate.action;const n=e.parents.parentOverlay.getAggregationOverlay(e.actions.aggregation);const a=n.getDesignTimeMetadata();const r=await l(e.parents,t.delegateInfo.requiredLibraries,a,e.plugin);if(r){e.compositeCommand.addCommand(r)}const o=await C(e,a);if(o){e.compositeCommand.addCommand(o)}return e.compositeCommand}function u(e){let t="";if(e){const n=e.getEntry?e.getEntry("sap.app"):e["sap.app"];if(n?.dataSources?.mainService?.uri){t=n.dataSources.mainService.uri}}return t}function f(e,t,n){return`${e.getId()}_${t}_${n}`.replace("/","_")}function C(e,t){const n=e.parents;const a=e.actions.addViaDelegate.action;const i=a.changeOnRelevantContainer?n.relevantContainer:n.parent;const s=a.changeOnRelevantContainer?n.relevantContainerOverlay:n.parentOverlay;const g=o.getIndex(n.parent,e.siblingElement,e.actions.aggregation,t.getData().getIndex);return e.plugin.getCommandFactory().getCommandFor(n.parent,"addDelegateProperty",{newControlId:f(i,e.selectedElement.entityType,e.selectedElement.bindingPath),index:e.index!==undefined?e.index:g,bindingString:e.selectedElement.bindingPath,entityType:e.selectedElement.entityType,parentId:n.parent.getId(),propertyName:e.selectedElement.name,oDataServiceVersion:e.selectedElement.oDataServiceVersion,oDataServiceUri:u(r.getAppComponentForControl(n.parent).getManifest()),modelType:a.delegateInfo.modelType,relevantContainerId:n.relevantContainer.getId()},t,e.plugin.getVariantManagementReference(s))}i.createCommands=async function(t,n,r,o,i,s,c){i.sort(function(e,t){if(e.label>t.label){return-1}if(e.label<t.label){return 1}return 0});if(i.length>0){try{const a=await c.getCommandFactory().getCommandFor(t.parent,"composite");for(const d of i){const i={compositeCommand:a,selectedElement:d,parents:t,siblingElement:n,actions:r,index:o,targetAggregation:s,plugin:c};switch(d.type){case"invisible":await g(i);break;case"delegate":await p(i);break;default:e.error(`Can't create command for untreated element.type ${d.type}`)}}c.fireElementModified({command:a})}catch(e){throw a.propagateError(e,"AdditionalElementsPlugin#_createCommands","Error occurred during _createCommands execution","sap.ui.rta.plugin")}}};return i});
//# sourceMappingURL=CommandBuilder.js.map