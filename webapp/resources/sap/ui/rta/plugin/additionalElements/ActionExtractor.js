/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/merge","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Lib","sap/ui/dt/ElementUtil","sap/ui/dt/OverlayRegistry","sap/ui/fl/apply/api/DelegateMediatorAPI","sap/ui/rta/plugin/additionalElements/AdditionalElementsUtils","sap/ui/rta/Utils"],function(e,t,n,a,r,i,o,l,s){"use strict";const c={};async function g(e,t,n){const a=await n.hasChangeHandler(e.changeType,e.element);if(a){return{aggregationName:e.aggregation,addPropertyActionData:{designTimeMetadata:t,action:e,delegateInfo:{payload:e.delegateInfo.payload||{},delegate:e.delegateInfo.instance,modelType:e.delegateInfo.modelType,requiredLibraries:e.delegateInfo.requiredLibraries,delegateType:e.delegateInfo.delegateType}}}}return undefined}function u(e,t,n){const a=e.getElement();if(!a){return[]}const o=r.getAggregation(a,t,n).filter(function(t){const a=i.getOverlay(t);if(!n.hasStableId(a)){return false}const r=e.getRelevantContainer(true);const o=i.getOverlay(r);let l=e;let s=false;do{s=!l.getElementVisibility();if(s){break}if(l===o){break}else{l=l.getParentElementOverlay()}}while(l);if(s){return true}return a.getElementVisibility()===false},this);return o.map(function(e){return{element:e,sourceAggregation:t}})}function d(e,t){return t.sParentAggregationName}function f(e,t,n,a){let r=n.changeType&&a.hasStableId(e);if(r&&e!==t.relevantContainerOverlay){r=a.hasStableId(t.relevantContainerOverlay)}return r}async function m(e,t,n,a,r){const i=e.reduce(function(e,t){let n=[];a.forEach(function(e){n=n.concat(u.call(this,t,e,r))}.bind(this),[]);return t?e.concat(n):e}.bind(this),[]);let o={elements:[],controlTypeNames:[]};for(const e of i){o=await h(o,e,r,n)}if(o.elements.length>0){t[n]={reveal:o}}return t}function y(e,t,n){return e.filter(e=>{const a=e.changeOnRelevantContainer?t.relevantContainer:t.parent;const r=i.getOverlay(a);return f(r,t,e,n)})}async function p(e){const n=Object.keys(e||{});try{for(const e of n){await a.load({name:e})}return true}catch(e){t.error("Required library not available: ",e);return false}}function v(e,t){const a=e.reduce(async function(e,a){const r=await e;const i=a.changeOnRelevantContainer?t.relevantContainer:t.parent;const l=await o.getReadDelegateForControl({control:i,modifier:n});const s=await o.getWriteDelegateForControl({control:i,modifier:n});const c=await p(s?.requiredLibraries);if(l?.instance&&s?.controlType&&c){a.element=i;a.delegateInfo=l;a.delegateInfo.requiredLibraries=s.requiredLibraries;r.push(a)}return r},Promise.resolve([]));return a}async function h(e,t,n,a){const o=i.getOverlay(t.element);if(o){const i=o.getDesignTimeMetadata();const c=i&&i.getAction("reveal",t.element);if(c&&c.changeType){let g=t.element;if(c.changeOnRelevantContainer){g=o.getRelevantContainer()}if(r.isElementValid(t.element)){const r=l.getParents(true,o,n);const u=await n.hasChangeHandler(c.changeType,g);if(u){let l=c.changeOnRelevantContainer?n.hasStableId(r.relevantContainerOverlay)&&n.hasStableId(r.parentOverlay):true;c.getAggregationName||=d;if(l&&t.sourceAggregation!==a){const e=r.parentOverlay.getAggregationOverlay(a);l=await s.checkTargetZone(e,o,n)}if(l){e.elements.push({element:t.element,designTimeMetadata:i,action:c,sourceAggregation:t.sourceAggregation,targetAggregation:a});const n=i.getName(t.element);if(n){e.controlTypeNames.push(n)}}}}}}return e}c.getActions=async function(t,n,a,r,i){const o=t?"asSibling":"asChild";if(!r&&n._mAddActions){return n._mAddActions[o]}const[l,s]=await Promise.all([this._getRevealActions(t,n,a,i),this._getAddViaDelegateActions(t,n,a)]);const c=e(l,s);n._mAddActions||={asSibling:{},asChild:{}};n._mAddActions[o]=c;return c};c.getActionsOrUndef=function(e,t){const n=e?"asSibling":"asChild";return t._mAddActions&&t._mAddActions[n]};let A={};let b=true;c.clearCache=function(){A={};b=true};c._getRevealActions=async function(e,t,n,a){if(b){b=false;a.attachEventOnce("synced",function(){A={};b=true},this)}const o=l.getParents(e,t,n);let s=[o.parentOverlay];if(o.relevantContainer!==o.parent){s=r.findAllSiblingsInContainer(o.parent,o.relevantContainer).map(function(e){return i.getOverlay(e)}).filter(function(e){return e})}let c=[];if(o.parentOverlay){const t=A[o.parentOverlay.getId()];if(t&&e){return t}c=o.parentOverlay.getChildren().filter(function(e){return!e.getDesignTimeMetadata().isIgnored(o.parent)}).map(function(e){return e.getAggregationName()});const a=await c.reduce(function(e,t){return e.then(function(e){return m(s,e,t,c,n)})},Promise.resolve({}));if(e){A[o.parentOverlay.getId()]=a}return a}return{}};c._getAddViaDelegateActions=async function(e,t,n){const a=l.getParents(e,t,n);const r=a.parentOverlay&&a.parentOverlay.getDesignTimeMetadata();let i=r?await r.getActionDataFromAggregations("add",a.parent,undefined,"delegate"):[];i=await y(i,a,n);i=await v(i,a);return i.reduce(async function(e,t){const i=await e;const o=await g.call(this,t,r,n);if(o){o.addPropertyActionData.relevantContainer=a.relevantContainer;i[o.aggregationName]||={};i[o.aggregationName].addViaDelegate=o.addPropertyActionData}return i}.bind(this),Promise.resolve({}))};return c});
//# sourceMappingURL=ActionExtractor.js.map