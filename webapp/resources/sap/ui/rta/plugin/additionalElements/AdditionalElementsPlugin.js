/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/each","sap/base/Log","sap/ui/core/EventBus","sap/ui/core/IconPool","sap/ui/core/Lib","sap/ui/dt/OverlayRegistry","sap/ui/dt/OverlayUtil","sap/ui/fl/write/api/FieldExtensibility","sap/ui/rta/plugin/additionalElements/ActionExtractor","sap/ui/rta/plugin/additionalElements/AddElementsDialog","sap/ui/rta/plugin/additionalElements/AdditionalElementsAnalyzer","sap/ui/rta/plugin/additionalElements/AdditionalElementsUtils","sap/ui/rta/plugin/additionalElements/CommandBuilder","sap/ui/rta/plugin/Plugin","sap/ui/rta/Utils"],function(e,t,i,n,s,a,l,o,r,c,u,g,d,h,E){"use strict";const f=true;const m=false;function b(e,t){const i=t.responsibleElementOverlay.getParentAggregationOverlay().getAggregationName();return Object.keys(e).some(function(e){return e===i})}async function p(e){const t=e.getModel();if(t&&t.sServiceUrl){const e=await o.isServiceOutdated(t.sServiceUrl);if(e){o.setServiceValid(t.sServiceUrl);i.getInstance().publish("sap.ui.core.UnrecoverableClientStateCorruption","RequestReload",{})}}}async function _(e){await o.onControlSelected(e);const t=await o.isExtensibilityEnabled(e);if(t){await p(e);const t=await o.getExtensionData(e);if(t){t.UITexts=await o.getTexts()||{}}return t}return undefined}function y(e){const t=this.getExtensibilityInfo(e);if(!t){this.getDialog().setCustomFieldButtonVisible(false);return}const i=t.UITexts?.options;if(!i){const e=s.getResourceBundleFor("sap.ui.rta");t.UITexts.options=[{actionKey:undefined,text:e.getText("BTN_ADDITIONAL_ELEMENTS_CREATE_CUSTOM_FIELDS"),tooltip:t.UITexts.tooltip}]}this.getDialog().setExtensibilityOptions(t);this.getDialog().detachEvent("triggerExtensibilityAction",this._onTriggerExtensibilityAction,this);this.getDialog().attachEvent("triggerExtensibilityAction",e,this._onTriggerExtensibilityAction,this);this.getDialog().addExtensibilityInfo(t)}const A=h.extend("sap.ui.rta.plugin.additionalElements.AdditionalElementsPlugin",{constructor:function(...e){this._getMenuItemsPromise=Promise.resolve();const[t]=e;t.dialog=new c;h.apply(this,e)},metadata:{library:"sap.ui.rta",properties:{commandFactory:"object"},aggregations:{dialog:{type:"sap.ui.rta.plugin.additionalElements.AddElementsDialog",multiple:false}},associations:{},events:{}},_getRelevantOverlays(e){const t=l.findAllOverlaysInContainer(e,true);e.setRelevantOverlays(t);return t},getContextMenuText(e,t,i,n){let a;function l(){a=s.getResourceBundleFor("sap.ui.rta");return a.getText("CTX_ADD_ELEMENTS",[a.getText("MULTIPLE_CONTROL_NAME")])}if(i==="$$OnlyChildCustomField$$"){return l()}if(n){a=s.getResourceBundleFor("sap.ui.rta");return a.getText("CTX_ADD_ELEMENTS_WITH_SUBMENU")}const o=g.getParents(e,t,this);const c=r.getActionsOrUndef(e,t);i||=Object.keys(c)[0];const u=c[i];if(!u){return l()}u.aggregation=i;return g.getText("CTX_ADD_ELEMENTS",u,o.parent,f)},isAvailable(e,t){return e.every(function(e){return this._isEditableByPlugin(e,t)},this)},isEnabled(e,t,i){if(e.length>1){return false}if(this.getExtensibilityInfo(t)){return true}const n=this.getResponsibleElementOverlay(e[0]);let s;let a=false;if(t){s=n.getParentElementOverlay();if(s){a=true}}else{const e=r.getActionsOrUndef(t,n);const s=e[i];if(s&&(s.reveal&&s.reveal.elements.length>0||s.addViaDelegate)){a=true}}const l=this.getCachedElements(t);const o=!!(l&&l.length>0);a&&=o;return a},async registerElementOverlay(...e){const[t]=e;const i=t.getElement().getModel();if(i){const e=i.getMetaModel();if(e&&e.loaded){await e.loaded();this.evaluateEditable([t],{onRegistration:true})}}h.prototype.registerElementOverlay.apply(this,e)},_checkIfCreateFunctionIsAvailable(e){return!e||e&&e.content&&e.content.createFunction},async showAvailableElements(e,i,n,l,o,c){const u=n[0];const h=g.getParents(e,u,this);const E=e&&u.getElement();const f=await r.getActions(e,u,this,undefined,this.getDesignTime());let m=[];const b=f[i];if(i!=="$$OnlyChildCustomField$$"){try{m=await this.getAllElements(e,[h.responsibleElementOverlay],o,c)}catch(e){if(e instanceof Error){throw e}else{t.info("Service not up to date, skipping add dialog","sap.ui.rta");return}}}y.call(this,e);const p=m.filter(function(e){return e.aggregation===i})[0];const _=p?p.elements:[];this.getDialog().setElements(_);if(c){const e=s.getResourceBundleFor("sap.ui.rta");const t=e.getText("HEADER_ADDITIONAL_ELEMENTS_WITH_AGGREGATION",[c]);this.getDialog().setTitle(t)}else if(i||o){this._setDialogTitle(b||{},h.parent,o)}try{await this.getDialog().open();const e=this.getDialog().getSelectedElements();await d.createCommands(h,E,b,l,e,i,this);const t=a.getOverlay(E)||u;t.focus()}catch(e){if(e instanceof Error){throw e}}},_setDialogTitle(e,t,i){const n=g.getText("HEADER_ADDITIONAL_ELEMENTS",e,t,m,i);this.getDialog().setTitle(n)},_onTriggerExtensibilityAction(e,t){const i=E.getRtaStyleClassName();const n=e.getParameters().actionKey;return o.onTriggerCreateExtensionData(this.getExtensibilityInfo(t),i,n)},async _isEditable(e,i){try{const[e,t]=await Promise.all([this._isEditableCheck(i.sourceElementOverlay,true),this._isEditableCheck(i.sourceElementOverlay,false)]);return{asSibling:e,asChild:t}}catch(e){t.error(e)}},async _isEditableCheck(e,t){const i=g.getParents(t,e,this);if(!i.relevantContainerOverlay){return false}const n=await r.getActions(t,e,this,true,this.getDesignTime());await this._getMenuItemsPromise;this.clearCachedElements();return E.doIfAllControlsAreAvailable([e,i.parentOverlay],function(){let s=false;if(t){s=b(n,i)}else{s=Object.keys(n).some(function(e){if(n[e].addViaDelegate){s=this.checkAggregationsOnSelf(i.parentOverlay,"add",undefined,"delegate")}if(!s&&n[e].reveal){return true}return s}.bind(this))}s&&=this.hasStableId(e)&&this.hasStableId(i.parentOverlay);return s}.bind(this))},async getAllElements(t,i){const n=i[0];const s=g.getParents(t,n,this);let a;const l=[];let o=false;const c=this.getCachedElements(t);if(c){return c}this.clearExtensibilityInfo(t);const d=await r.getActions(t,n,this,undefined,this.getDesignTime());e(d,function(e){a=d[e];a.aggregation=e;if(a.addViaDelegate){o=true}l.push({aggregation:e,elementPromises:[a.reveal?u.enhanceInvisibleElements(s.parent,a):Promise.resolve([]),a.addViaDelegate?u.getUnrepresentedDelegateProperties(s.parent,a.addViaDelegate):Promise.resolve([])]})});const h=o&&await _(s.parent);this.setExtensibilityInfo(t,h);const E=await this._combineAnalyzerResults(l);this.setCachedElements(E,t);return E},getMenuItems(e){const t=[];let i;this.clearCachedElements();this._getMenuItemsPromise=Promise.all([this.getAllElements(false,e),this.getAllElements(true,e)]).then(function(n){const s=n[0].length>0;const a=n[0].length>1;const l=n[1].length>0;const o=this.isAvailable(e,false);const r=this.isAvailable(e,true);if(r&&(!o||!s)){i=this._buildMenuItem("CTX_ADD_ELEMENTS_AS_SIBLING",true,e,n,false)}else if(o&&(!r||!l)&&!a){i=this._buildMenuItem("CTX_ADD_ELEMENTS_AS_CHILD",false,e,n,false)}else if(o&&(!r||!l)&&a){i=this._buildMenuItem("CTX_ADD_ELEMENTS_AS_CHILD",false,e,n,true)}else if(o&&r&&s&&l){i=this._buildMenuItem("CTX_ADD_ELEMENTS_CHILD_AND_SIBLING",false,e,n,true)}if(i){t.push(this.enhanceItemWithResponsibleElement(i,e,["addViaDelegate","reveal","custom"]))}return t}.bind(this));return this._getMenuItemsPromise},_buildMenuItem(e,t,i,n,s){let a;let l;let o;const r=i[0];if(t){const e=g.getParents(t,r,this);o=e.responsibleElementOverlay.getParentAggregationOverlay().getAggregationName()}else{const e=n[0].length===0&&n[1].length===0;o=e?"$$OnlyChildCustomField$$":n[0]&&n[0][0]&&n[0][0].aggregation}if(s){a=this._buildSubmenuItems(false,i,n[0]);if(e==="CTX_ADD_ELEMENTS_CHILD_AND_SIBLING"){a=a.concat(this._buildSubmenuItems(true,i,n[1]))}}else{l=function(e,t){return this.showAvailableElements(e,o,t)}.bind(this,t)}const c={id:e,text:this.getContextMenuText.bind(this,t,r,o,s),enabled:s||function(e,t){return this.isEnabled(t,e,o)}.bind(this,t),rank:this.getRank(e),icon:"sap-icon://add",handler:l};if(s){c.submenu=a}return c},_buildSubmenuItems(e,t,i){const s=[];const a=e?"CTX_ADD_ELEMENTS_AS_SIBLING":"CTX_ADD_ELEMENTS_AS_CHILD";let l=0;n.registerFont({collectionName:"BusinessSuiteInAppSymbols",fontFamily:"BusinessSuiteInAppSymbols",fontURI:sap.ui.require.toUrl("sap/ushell/themes/base/fonts/"),lazy:true});function o(e,t,i){i=e?i.getParentElementOverlay():i;const n=i.getDesignTimeMetadata();const s=n.getAggregationDisplayName(t,i.getElement());return s?s.plural:t}i.forEach(function(i){const n=i.aggregation;const r=this.getResponsibleElementOverlay(t[0]);const c=o(e,n,r);const u={id:`${a}_${l}`,text:c,enabled:function(t){return this.isEnabled(t,e,n)}.bind(this),handler:function(e,t){return this.showAvailableElements(e,n,t,undefined,undefined,c)}.bind(this,e),icon:e?"sap-icon://BusinessSuiteInAppSymbols/icon-add-outside":"sap-icon://add"};s.push(this.enhanceItemWithResponsibleElement(u,t,["addViaDelegate","reveal","custom"]));l++}.bind(this));return s},async _combineAnalyzerResults(e){const t=[];e.forEach(function(e){t.push(Promise.all(e.elementPromises).then(function(t){const i=t[0];const n=t[1];const s=i.concat(n);return{aggregation:e.aggregation,elements:s}}))});const i=await Promise.all(t);return i.filter(function(e){const t=e&&e.elements;return t.length>0})},clearCachedElements(){this._oCachedElements=undefined},setCachedElements(e,t){this._oCachedElements||={};this._oCachedElements[t?"asSibling":"asChild"]=e},getCachedElements(e){if(this._oCachedElements){return this._oCachedElements[e?"asSibling":"asChild"]}return undefined},clearExtensibilityInfo(e){if(this._oExtensibilityInfo){this._oExtensibilityInfo[e?"asSibling":"asChild"]=undefined}},setExtensibilityInfo(e,t){this._oExtensibilityInfo||={};this._oExtensibilityInfo[e?"asSibling":"asChild"]=t},getExtensibilityInfo(e){if(this._oExtensibilityInfo){return this._oExtensibilityInfo[e?"asSibling":"asChild"]}return undefined},exit(...e){this.getDialog().destroy();if(h.prototype.exit){h.prototype.exit.apply(this,e)}}});return A});
//# sourceMappingURL=AdditionalElementsPlugin.js.map