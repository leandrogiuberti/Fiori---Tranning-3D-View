/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_curry","sap/m/InstanceManager","sap/ui/base/ManagedObject","sap/ui/core/Component","sap/ui/dt/util/ZIndexManager","sap/ui/dt/Overlay","sap/ui/dt/OverlayRegistry","sap/ui/fl/Utils"],function(t,e,o,n,i,s,a,p){"use strict";const r={add:"_activateFocusHandle",remove:"_deactivateFocusHandle"};function u(t){let e;let o;if(t.isA("sap.ui.core.Component")){e=t}else{e=l(t)}if(e){o=p.getAppComponentForControl(e)}return o}function l(t){let e;let o;let i;if(t){e=n.getOwnerComponentFor(t);if(!e&&typeof t.getParent==="function"&&t.getParent()?.isA("sap.ui.core.Element")){i=t.getParent()}else if(e){i=e}if(i){o=l(i)}}return o||e}const c=o.extend("sap.ui.rta.util.PopupManager",{metadata:{properties:{rta:"any"},associations:{autoCloseAreas:{type:"sap.ui.core.Control",multiple:true,singularName:"autoCloseArea"}},events:{open:{parameters:{oControl:{type:"sap.ui.core.Control"}}},close:{parameters:{oControl:{type:"sap.ui.core.Control"}}}},library:"sap.ui.rta"}});c.prototype.init=function(){this._oModalState=new Map;this._aPopupFilters=[this._isSupportedPopup.bind(this),this._isPopupAdaptable.bind(this)];this._aPopupFilters.forEach(function(t){i.addPopupFilter(t)})};c.prototype._overrideInstanceFunctions=function(){this._applyPopupAttributes({method:this._createPopupOverlays,setModal:true,bringToTop:true});this._overrideAddPopupInstance();this._overrideRemovePopupInstance()};c.prototype.getCategorizedOpenPopups=function(){const t=e.getOpenDialogs();const o=this._getValidatedPopups(t);const n=e.getOpenPopovers();const i=this._getValidatedPopups(n);const s={aDialogs:o.relevant,aPopovers:i.relevant,aAllSupportedPopups:o.allSupported.concat(i.allSupported)};return s};c.prototype._getValidatedPopups=function(t){const e=[];t=t.filter(function(t){if(this._isPopupAdaptable(t)){e.push(t);return true}else if(t.isA("sap.m.Dialog")){e.push(t)}return undefined}.bind(this));return{relevant:t,allSupported:e}};c.prototype._isComponentInsidePopup=function(t){return Array.isArray(t.getContent())?t.getContent().some(function(t){if(t.isA("sap.ui.core.ComponentContainer")){return this.oRtaRootAppComponent===u(n.getComponentById(t.getComponent()))}return undefined}.bind(this)):false};c.prototype._isSupportedPopup=function(t){return t.isA("sap.m.Dialog")||t.isA("sap.m.Popover")};c.prototype.setRta=function(t){if(t&&t._oDesignTime){this.setProperty("rta",t);const e=t.getRootControlInstance();this.oRtaRootAppComponent=u(e);const o=this._onModeChange.bind(this);t.attachModeChanged(o);this._overrideInstanceFunctions()}};c.prototype._adjustRootOverlayVisibility=function(t,e){this.getRta()._oDesignTime.getRootElements().forEach(function(o){if(o.getId()!==e.getId()){a.getOverlay(o).setVisible(t)}})};c.prototype._onModeChange=function(e){const o=e.getParameters().mode;const n=function(t,e){if(t==="navigation"){e.oPopup[this._getFocusEventName("add")]()}else{e.oPopup[this._getFocusEventName("remove")]();if(this.getRta().getShowToolbars()){this.getRta().getToolbar().bringToFront()}}};if(o==="navigation"){this._applyPatchesToOpenPopups(t(n)(o))}else{this._removePatchesToOpenPopups(t(n)(o))}};c.prototype._applyPatchesToOpenPopups=function(t){this._applyPopupAttributes({method:t,focus:true,setModal:false})};c.prototype._removePatchesToOpenPopups=function(t){this._applyPopupAttributes({method:t,setModal:true})};c.prototype._getFocusEventName=function(t){return r[t]};c.prototype._overrideAddPopupInstance=function(){this._fnOriginalAddDialogInstance=e.addDialogInstance;e.addDialogInstance=this._overrideAddFunctions(this._fnOriginalAddDialogInstance);this._fnOriginalAddPopoverInstance=e.addPopoverInstance;e.addPopoverInstance=this._overrideAddFunctions(this._fnOriginalAddPopoverInstance)};c.prototype._overrideAddFunctions=function(t){return function(...o){const[n]=o;const i=t.apply(e,o);if(this._isSupportedPopup(n)){if(this._isPopupAdaptable(n)&&this.getRta()._oDesignTime){n.attachEventOnce("afterOpen",this._createPopupOverlays,this);n.attachEventOnce("afterOpen",this.fireOpen,this);this._setModal(true,n)}else if(!n.isA("sap.m.Popover")){this._setModal(true,n)}}return i}.bind(this)};c.prototype._setModal=function(t,e){const o=this._oModalState.get(e.oPopup);if(typeof o!=="boolean"&&t&&this.getRta().getMode()!=="navigation"){this._oModalState.set(e.oPopup,e.oPopup.getModal());if(this._isPopupAdaptable(e)){this._adjustRootOverlayVisibility(false,e)}e.oPopup.setModal(true)}else if(typeof o==="boolean"&&t===false){e.oPopup.setModal(o);if(this._isPopupAdaptable(e)){this._adjustRootOverlayVisibility(true,e)}this._oModalState.delete(e.oPopup)}};c.prototype._applyPopupAttributes=function(t){const e=this.getCategorizedOpenPopups();["aDialogs","aPopovers"].forEach(function(o){if(e[o].length>0){if(t.focus){if(e[o][0].oPopup.oContent){e[o][0].oPopup.oContent.focus()}}e[o].forEach(function(e){t.method.call(this,e)}.bind(this))}}.bind(this));e.aAllSupportedPopups.forEach(this._setModal.bind(this,t.setModal))};c.prototype._applyPopupPatch=function(t){const e=s.getOverlayContainer();const{oPopup:o}=t;const n=[o.oContent.getDomRef(),e].concat(this.getAutoCloseAreas());if(this.getRta().getShowToolbars()){const t=this.getRta().getToolbar();const e=!!t.getVisible();if(!e){this.getRta().attachEventOnce("start",function(){n.push(t.getDomRef())})}else{n.push(t.getDomRef())}}o.setExtraContent(n);this.fnOriginalPopupOnAfterRendering||=o.onAfterRendering;o.onAfterRendering=function(...t){const e=this.fnOriginalPopupOnAfterRendering.apply(o,t);o[this._getFocusEventName("remove")]();return e}.bind(this);if(this.getRta().getMode()==="adaptation"){o[this._getFocusEventName("remove")]()}};c.prototype._overrideRemovePopupInstance=function(){this._fnOriginalRemoveDialogInstance=e.removeDialogInstance;e.removeDialogInstance=this._overrideRemoveFunctions(this._fnOriginalRemoveDialogInstance);this._fnOriginalRemovePopoverInstance=e.removePopoverInstance;e.removePopoverInstance=this._overrideRemoveFunctions(this._fnOriginalRemovePopoverInstance)};c.prototype._overrideRemoveFunctions=function(t){return function(...o){const[n]=o;const i=t.apply(e,o);if(this._isSupportedPopup(n)){if(this._isPopupAdaptable(n)&&this.getRta()._oDesignTime){this.getRta()._oDesignTime.removeRootElement(n)}this._oModalState?.delete(n.oPopup);this.fireClose(n)}return i}.bind(this)};c.prototype._createPopupOverlays=function(t){if(!t){return}const e=t.isA("sap.ui.base.Event")?t.getSource():t;if(this.getRta()._oDesignTime.getRootElements().indexOf(e.getId())===-1&&!this._isComponentInsidePopup(e)){this.getRta()._oDesignTime.addRootElement(e)}e.detachAfterOpen(this._createPopupOverlays,this);this._applyPopupPatch(e)};c.prototype._restoreInstanceFunctions=function(){if(this._fnOriginalAddDialogInstance){e.addDialogInstance=this._fnOriginalAddDialogInstance}if(this._fnOriginalRemoveDialogInstance){e.removeDialogInstance=this._fnOriginalRemoveDialogInstance}if(this._fnOriginalAddPopoverInstance){e.addPopoverInstance=this._fnOriginalAddPopoverInstance}if(this._fnOriginalRemovePopoverInstance){e.removePopoverInstance=this._fnOriginalRemovePopoverInstance}this._applyPatchesToOpenPopups(this._removePopupPatch)};c.prototype._removePopupPatch=function(t){const{oPopup:e}=t;e[this._getFocusEventName("add")]();if(this.fnOriginalPopupOnAfterRendering){e.onAfterRendering=this.fnOriginalPopupOnAfterRendering}};function d(t){if(!t||t.isA("sap.ui.core.Component")){return true}if(!t.isPopupAdaptationAllowed||t.isPopupAdaptationAllowed()){return d(t.getParent())}return false}c.prototype._isPopupAdaptable=function(t){if(t.isPopupAdaptationAllowed){return t.isPopupAdaptationAllowed()}if(!t.getMetadata().getEvents().afterOpen){return false}const e=u(t);if(e&&this.oRtaRootAppComponent===e||this._isComponentInsidePopup(t)){return d(t.getParent())}return false};c.prototype.exit=function(){this._restoreInstanceFunctions();delete this._oModalState;this._aPopupFilters.forEach(function(t){i.removePopupFilter(t)})};return c});
//# sourceMappingURL=PopupManager.js.map