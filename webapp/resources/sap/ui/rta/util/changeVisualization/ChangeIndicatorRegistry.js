/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/values","sap/base/util/restricted/_omit","sap/base/Log","sap/ui/base/ManagedObject","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/dt/ElementUtil","sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/fl/Utils","sap/ui/fl/changeHandler/common/ChangeCategories","sap/ui/rta/util/changeVisualization/ChangeStates"],function(e,t,n,i,o,r,s,a,c,g){"use strict";const d=i.extend("sap.ui.rta.util.changeVisualization.ChangeIndicatorRegistry",{metadata:{properties:{changeCategories:{type:"object",defaultValue:[]},rootControlId:{type:"string"}}},constructor:function(...e){i.prototype.constructor.apply(this,e);this._oRegisteredChanges={};this._oChangeIndicators={}}});d.prototype.exit=function(){this.reset()};d.prototype.getAllRegisteredChanges=function(){return e(this._oRegisteredChanges||{}).map(function(e){return{...e}})};d.prototype.getRegisteredChangeIds=function(){return Object.keys(this._oRegisteredChanges||{})};d.prototype.getRegisteredChange=function(e){return this._oRegisteredChanges[e]&&{...this._oRegisteredChanges[e]}};d.prototype.getSelectorsWithRegisteredChanges=function(){const n={};let i;function o(e,o,r,s){if(n[e]===undefined){n[e]=[]}n[e].push({id:r.change.getId(),dependent:s,affectedElementId:o||i,displayElementsKey:r.visualizationInfo.displayElementIds.toString(),descriptionPayload:r.visualizationInfo.descriptionPayload||{},...t(r,["visualizationInfo"])});i=o||i}e(this._oRegisteredChanges).forEach(function(e){e.visualizationInfo.displayElementIds.forEach(function(t,n){o(t,e.visualizationInfo.affectedElementIds[n],e,false)})});return n};d.prototype.getRelevantChangesWithSelector=function(){const e=this.getSelectorsWithRegisteredChanges();let t=[];Object.keys(e).forEach(function(n){const i=e[n].filter(function(e){return!e.dependent});t=t.concat(i)});return t};d.prototype.getChangeIndicator=function(e){return this._oChangeIndicators[e]};d.prototype.getChangeIndicators=function(){return e(this._oChangeIndicators||{})};d.prototype.registerChange=function(e,t,n){const i=a.getAppComponentForControl(r.getElementInstance(this.getRootControlId()));return l(e,i).then(function(i){const o=this.getChangeCategories();let r;if(t==="settings"&&Object.keys(o).includes(i.descriptionPayload.category)){r=i.descriptionPayload.category}else{r=Object.keys(o).find(function(e){return o[e].includes(t)});r||=c.OTHER}let s;let a=[];if(n){a=n.getData().draftFilenames}if(e.getState()==="NEW"){s=g.getDraftAndDirtyStates()}else if(a&&a.includes(e.getId())){s=[g.DRAFT]}else{s=[g.ALL]}this._oRegisteredChanges[e.getId()]={change:e,commandName:t,changeCategory:r,changeStates:s,visualizationInfo:i}}.bind(this))};function l(e,t){function n(e){if(!e){return undefined}return e.map(function(e){const n=typeof e.getId==="function"?e:o.bySelector(e,t);return n&&n.getId()}).filter(Boolean)}return u(t,e).then(function(t){const i=t||{};const o=e.getSelector&&e.getSelector()&&[e.getSelector()];const r=i.affectedControls||o||[];const s=e.getOriginalSelector&&e.getOriginalSelector();const a=s?o:r;return{affectedElementIds:n(r),dependentElementIds:n(i.dependentControls)||[],displayElementIds:n(i.displayControls||n(a)),updateRequired:i.updateRequired,descriptionPayload:i.descriptionPayload||{}}})}function u(e,t){let i=t.getOriginalSelector&&t.getOriginalSelector();i||=t.getSelector&&t.getSelector();const r=o.bySelector(i,e);if(r){return s.getChangeHandler({changeType:t.getChangeType(),element:r,modifier:o,layer:t.getLayer()}).then(function(n){if(n&&typeof n.getChangeVisualizationInfo==="function"&&t.isSuccessfullyApplied&&t.isSuccessfullyApplied()){return n.getChangeVisualizationInfo(t,e)}return undefined}).catch(function(e){n.error(e);return undefined})}return Promise.resolve()}d.prototype.registerChangeIndicator=function(e,t){this._oChangeIndicators[e]=t};d.prototype.waitForIndicatorRendering=function(){const e=this.getChangeIndicators().filter(e=>e.getVisible());return Promise.all(e.map(e=>e.waitForRendering()))};d.prototype.reset=function(){Object.keys(this._oRegisteredChanges).forEach(function(e){this.removeRegisteredChange(e)}.bind(this));e(this._oChangeIndicators).forEach(function(e){e.destroy()});this._oChangeIndicators={}};d.prototype.removeRegisteredChange=function(e){delete this._oRegisteredChanges[e]};d.prototype.removeOutdatedRegisteredChanges=function(){this.getAllRegisteredChanges().forEach(function(e){if(e.visualizationInfo&&e.visualizationInfo.updateRequired){this.removeRegisteredChange(e.change.getId())}}.bind(this))};d.prototype.removeRegisteredChangesWithoutVizInfo=function(){this.getAllRegisteredChanges().forEach(function(e){if(e.visualizationInfo&&e.visualizationInfo.displayElementIds.length===0){this.removeRegisteredChange(e.change.getId())}}.bind(this))};return d});
//# sourceMappingURL=ChangeIndicatorRegistry.js.map