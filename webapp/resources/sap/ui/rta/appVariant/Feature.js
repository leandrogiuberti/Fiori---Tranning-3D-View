/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/merge","sap/ui/core/BusyIndicator","sap/ui/core/EventBus","sap/ui/fl/apply/api/FlexRuntimeInfoAPI","sap/ui/fl/write/_internal/appVariant/AppVariantFactory","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/Utils","sap/ui/rta/appVariant/AppVariantUtils","sap/ui/rta/util/showMessageBox"],function(e,n,t,r,i,s,a,o,u){"use strict";let c;let l;let p;let f;let h;const d=function(){return a.getAppDescriptor(p)};const g=function(){window.onbeforeunload=h};const A=function(e){const n=e?"MSG_DO_NOT_CLOSE_BROWSER_CURRENTLY_ADAPTING":"MSG_DO_NOT_CLOSE_BROWSER";h=window.onbeforeunload;window.onbeforeunload=o.handleBeforeUnloadEvent;return o.showMessage(n)};const v=function(e,n){return l.triggerCatalogPublishing(e,n,true)};const w=function(e){return l.triggerCatalogPublishing(e,null,false)};const P=function(e,t){if(c){o.closeOverviewDialog();return this.onGetOverview(true,t)}else if(!c&&e){n.hide();return this.onGetOverview(true,t)}return Promise.resolve()};const S=function(e,n,t){return e?o.navigateToFLPHomepage():P.call(this,!n,t)};const b=function(e,n){if(e&&e.response&&e.response.IAMId){if(!Array.isArray(e.response.CatalogIds)||e.response.CatalogIds.length===0){const e=o.getText("MSG_BASE_APP_CATALOGS_NOT_FOUND",n);const t=o.getText("HEADER_SAVE_APP_VARIANT_FAILED");u(e,{title:t},"error");return Promise.reject()}return l.notifyKeyUserWhenPublishingIsReady(e.response.IAMId,n,true)}return Promise.resolve()};const _=function(e,n){if(e&&e.response&&e.response.IAMId&&e.response.inProgress){return l.notifyKeyUserWhenPublishingIsReady(e.response.IAMId,n,false)}return Promise.resolve()};t.getInstance().subscribe("sap.ui.rta.appVariant.manageApps.controller.ManageApps","navigate",function(){if(c){c.destroy();c=null}});return{onGetOverview(e,n){const t=d();return new Promise(function(r){const i=function(){o.closeOverviewDialog()};const s="sap/ui/rta/appVariant/AppVariantOverviewDialog";const a={idRunningApp:t["sap.app"].id,isOverviewForKeyUser:e,layer:n};sap.ui.require([s],function(e){c||=new e(a);c.attachCancel(i);c.oPopup.attachOpened(function(){r(c)});c.open()})})},isOverviewExtended(){const e=new URLSearchParams(window.location.search);const n=e.get("sap-ui-xx-app-variant-overview-extended");if(!n){return false}return n.toLowerCase()==="true"},isManifestSupported(){const e=d();return o.getManifirstSupport(e["sap.app"].id)},isSaveAsAvailable(e,n,t){p=e;f=t;const r=d();if(r["sap.app"]&&r["sap.app"].id){return s.isSaveAsAvailable(n).then(function(e){if(e){if(r["sap.app"].crossNavigation&&r["sap.app"].crossNavigation.inbounds){return o.getParsedHash(r["sap.app"].crossNavigation.inbounds)}return o.getParsedHash()}return undefined}).then(function(e){return!!e})}return Promise.resolve(false)},getAppVariantManifest(e){p=e;const n=d();if(n["sap.app"]&&n["sap.app"].id){return i.load({id:n["sap.app"].id})}return Promise.resolve(false)},_determineSelector(e,n){return e?p:{appId:n["sap.app"].id,appVersion:n["sap.app"].applicationVersion.version}},onSaveAs(t,i,s,u){let c;let p;let h=d();let w=true;if(u&&u["sap.app"].id===h["sap.app"].id){i=true;h=e({},u);u=null}else if(u){w=false;h=e({},u);u=null}const P=this._determineSelector(w,h);return new Promise(function(u){const d=function(){return l.processSaveAsDialog(h,t)};const w=function(e){n.show();return l.createAllInlineChanges(e,P)};const _=function(e){const n=e.slice();return o.addChangesToPersistence(n,P)};const I=async function(){const e=o.getNewAppVariantId();const n=await o.getParsedHash();return l.createAppVariant(e,n,P).catch(function(n){let t=n.messageKey;t||="MSG_SAVE_APP_VARIANT_FAILED";return o.catchErrorDialog(n,t,e)})};const m=function(n){p=null;p=e({},n.response);return l.clearRTACommandStack(i)};const E=function(){const e=a.getUshellContainer();if(e&&i){e.setDirtyFlag(false)}};var O=function(){E();c=r.isAtoEnabled();const e=o.buildSuccessInfo(p.id,t,c);return l.showSuccessMessage(e)};const D=function(){const e=o.buildFinalSuccessInfoS4HANACloud();return l.showSuccessMessage(e)};const V=function(){n.show();if(c){let e;return A().then(function(){return v(p.id,p.reference)}).then(function(r){e={...r};n.hide();return S.call(this,t,null,s)}.bind(this)).then(function(){return b(e,p.id)}).then(function(){g();return D()}).then(function(){return t?u():S.call(this,t,c,s)}.bind(this))}n.hide();return S.call(this,t,c,s)};sap.ui.require(["sap/ui/rta/appVariant/AppVariantManager"],function(e){l||=new e({commandSerializer:f,layer:s});return d().then(w).then(_).then(I).then(m).then(O).then(V.bind(this)).then(u).catch(function(e){if(!e){return false}if(c){g()}return S.call(this,null,c,s).then(u)}.bind(this))}.bind(this))}.bind(this))},onDeleteFromOverviewDialog(e,t,i){let s;return new Promise(function(a){sap.ui.require(["sap/ui/rta/appVariant/AppVariantManager"],function(u){l||=new u({rootControl:p,commandSerializer:f,layer:i});const c=function(){return l.deleteAppVariant(e).catch(function(n){if(n==="cancel"){return Promise.reject("cancel")}let t=n.messageKey;t||="MSG_DELETE_APP_VARIANT_FAILED";return o.catchErrorDialog(n,t,e)})};const h=function(){o.closeOverviewDialog();const n=o.buildDeleteSuccessMessage(e,s);return l.showSuccessMessage(n)};const d=function(){s=r.isAtoEnabled();if(s){let n;return A(t).then(function(){return w(e)}).then(function(e){n={...e};return P.call(this,!t,i)}.bind(this)).then(function(){return _(n,e)})}n.show();return Promise.resolve()};const v=function(){if(s){g()}n.hide();return t?a():P.call(this,!s,s,i).then(a)};if(t){o.closeOverviewDialog();o.navigateToFLPHomepage()}return d.call(this).then(c).then(h).then(v.bind(this)).catch(function(e){if(e==="cancel"){return false}if(s){g()}return P.call(this,null,s,i).then(a)}.bind(this))}.bind(this))}.bind(this))}}});
//# sourceMappingURL=Feature.js.map