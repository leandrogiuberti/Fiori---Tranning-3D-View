/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Lib","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/Utils","sap/ui/rta/command/CompositeCommand","sap/ui/rta/command/FlexCommand","sap/ui/rta/command/ManifestCommand","sap/ui/rta/command/Settings","sap/ui/rta/util/showMessageBox"],function(e,t,n,o,s,i,a,r,c,d){"use strict";function u(e,n,o,s){const a=s.getSelector&&s.getSelector();const r=new c({selector:a,changeType:s.getChangeType(),element:t.bySelector(a,e)});r._oPreparedChange=s;const d=s.getSupportInformation().compositeCommand;if(d){if(!n[d]){n[d]=new i;o.pushExecutedCommand(n[d])}n[d].addCommand(r)}else{o.pushExecutedCommand(r)}}function m(e,t){const n=this.getAllExecutedCommands();e.forEach(e=>{n.some(n=>{const o=n.getPreparedChange?.();if(Array.isArray(o)){return o.some(o=>{if(o.getId()===e.getId()){n.setRelevantForSave(t);return true}return false})}else if(o){if(o.getId()===e.getId()){n.setRelevantForSave(t);return true}return false}return false})})}const h=e.extend("sap.ui.rta.command.Stack",{metadata:{library:"sap.ui.rta",properties:{saved:{type:"boolean",defaultValue:false},lastCommandExecuted:{type:"object",defaultValue:Promise.resolve()},lastCommandUnExecuted:{type:"object",defaultValue:Promise.resolve()}},aggregations:{commands:{type:"sap.ui.rta.command.BaseCommand",multiple:true}},events:{modified:{}}}});h.initializeWithChanges=async function(e,t){const n=new h;n._aPersistedChanges=t;if(t?.length>0){const i=s.getAppComponentForControl(e);const a={selector:i,invalidateCache:false};const r=await o._getUIChanges(a);const c={};const d={};r.forEach(e=>{d[e.getId()]=e});t.reduce((e,t)=>{const n=d[t];if(n){e.push(n)}return e},[]).forEach(u.bind(null,i,c,n))}return n};h.prototype.init=function(){this._aCommandExecutionHandler=[];this._toBeExecuted=-1};h.prototype._getCommandToBeExecuted=function(){return this.getCommands()[this._toBeExecuted]};h.prototype.pushExecutedCommand=function(e){this.push(e,true);this.fireModified()};h.prototype.push=function(e,t){if(this._bUndoneCommands){this._bUndoneCommands=false;while(this._toBeExecuted>-1){this.pop()}}this.insertCommand(e,0);if(!t){this._toBeExecuted++}};h.prototype.top=function(){return this.getCommands()[0]};h.prototype.pop=function(){if(this._toBeExecuted>-1){this._toBeExecuted--}return this.removeCommand(0)};h.prototype.removeCommand=function(e,t){const n=this.removeAggregation("commands",e,t);return n};h.prototype.removeAllCommands=function(e){const t=this.removeAllAggregation("commands",e);this._toBeExecuted=-1;this.fireModified();return t};h.prototype.isEmpty=function(){return this.getCommands().length===0};async function p(e){let t;const n=this.getSubCommands(e);const s=[];let i=n.map(e=>{if(e.getRuntimeOnly()){return undefined}if(e instanceof r){s.push(e.createAndStoreChange());return undefined}if(e instanceof a){t=e.getAppComponent();if(t){return e.getPreparedChange()}}return undefined}).filter(Boolean);await Promise.all(s);if(this._aPersistedChanges){i=i.filter(e=>this._aPersistedChanges.indexOf(e.getId())===-1)}if(t){o.add({flexObjects:i,selector:t})}}function f(e){let t;const n=[];const s=this.getSubCommands(e);s.forEach(e=>{if(!(e instanceof a||e instanceof r)||e.getRuntimeOnly()){return}const o=e.getPreparedChange();t=e.getAppComponent();if(t){n.push(o)}});if(t){o.remove({flexObjects:n,selector:t})}}h.prototype.execute=function(){this.setLastCommandExecuted(this.getLastCommandExecuted().catch(()=>{}).then(async()=>{const e=this._getCommandToBeExecuted();if(e){try{await p.call(this,e);await e.execute();this._toBeExecuted--;const t=e.getDiscardedChanges?.();if(t){m.call(this,t,false)}this.fireModified()}catch(t){const o=t||new Error("Executing of the change failed.");o.index=this._toBeExecuted;o.command=this.removeCommand(this._toBeExecuted);this._toBeExecuted--;f.call(this,o.command);const s=n.getResourceBundleFor("sap.ui.rta");const i=e.isA("sap.ui.rta.command.AddXMLAtExtensionPoint")?o.message:s.getText("MSG_GENERIC_ERROR_MESSAGE",[o.message]);d(i,{title:s.getText("HEADER_ERROR")},"error");throw o}}return undefined}));return this.getLastCommandExecuted()};h.prototype._unExecute=function(){this.setLastCommandUnExecuted(this.getLastCommandUnExecuted().catch(()=>{}).then(async()=>{if(this.canUndo()){this._bUndoneCommands=true;this._toBeExecuted++;const e=this._getCommandToBeExecuted();const t=e.getDiscardedChanges?.();if(e){await e.undo();f.call(this,e);if(t){m.call(this,t,true)}this.fireModified()}}}));return this.getLastCommandUnExecuted()};h.prototype.canUndo=function(){return this._toBeExecuted+1<this.getCommands().length};h.prototype.canSave=function(){return this.canUndo()&&this.getAllExecutedCommands().some(e=>e.getRelevantForSave())};h.prototype.undo=function(){return this._unExecute()};h.prototype.canRedo=function(){return!!this._getCommandToBeExecuted()};h.prototype.redo=function(){return this.execute()};h.prototype.pushAndExecute=function(e){this.push(e);return this.execute()};h.prototype.getAllExecutedCommands=function(){let e=[];const t=this.getCommands();for(let n=t.length-1;n>this._toBeExecuted;n--){const o=this.getSubCommands(t[n]);e=e.concat(o)}return e};h.prototype.getSubCommands=function(e){let t=[];if(e.getCommands){e.getCommands().forEach(e=>{const n=this.getSubCommands(e);t=t.concat(n)})}else{t.push(e)}return t};h.prototype.compositeLastTwoCommands=function(){const e=this.pop();const t=this.pop();const n=new i;n.addCommand(t);n.addCommand(e);this.push(n)};return h});
//# sourceMappingURL=Stack.js.map