/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/editor/fields/ObjectField","sap/ui/model/json/JSONModel","sap/m/CheckBox","sap/base/util/deepEqual","sap/base/util/deepClone","sap/ui/integration/util/Utils","sap/m/table/columnmenu/Menu","sap/ui/core/Lib"],function(e,t,r,a,i,o,n,l){"use strict";let s;var u=e.extend("sap.ui.integration.editor.fields.ObjectListField",{metadata:{library:"sap.ui.integration"},renderer:e.getMetadata().getRenderer()});u.loadDependencies=function(){return l.load("sap.ui.table").then(()=>new Promise((e,t)=>{sap.ui.require(["sap/ui/table/Table"],t=>{s=t;e()},t)}))};u.prototype.initVisualization=function(e){var t=this;t._positionCount=1;t._newObjectTemplate={_dt:{_selected:true,_uuid:""}};var r=e.visualization;if(!r){if(e.value&&!e.properties&&(!e.values||e.values&&!e.values.metadata)){t.parseValueProperties()}if(e.values||e.properties){r=t.createTableVisualization(e)}else{r=t.createTextAreaVisualization(e)}e.withLabel=true}this._visualization=r;this.attachAfterInit(this._afterInit)};u.prototype._afterInit=function(){var e=this;var r=e.getAggregation("_field");if(r instanceof s){r.addStyleClass("sapUiIntegrationEditorItemObjectListFieldTable");e._oMenu=new n;var a=r.getColumns();for(var l=0;l<a.length;l++){if(a[l].getFilterProperty()||a[l].getSortProperty()){a[l].setHeaderMenu(e._oMenu.getId())}}var u=e.getConfiguration();if(!u.values){var d=[];if(Array.isArray(u.value)){d=i(u.value,500);d.forEach(function(t){t._dt=t._dt||{};t._dt._selected=true;t._dt._uuid=t._dt._uuid||o.generateUuidV4();t._dt._position=e._positionCount;e._positionCount++})}e.setModel(new t({value:d,_allSelected:true}));e.bindObject({path:"/value"})}}};u.prototype.parseValueProperties=function(){var e=this;var t=e.getConfiguration();if(Array.isArray(t.value)&&t.value.length>0&&!t.properties){var r={};t.value.forEach(function(e){for(var t in e){if(!r[t]&&t!=="_dt"){var a=typeof e[t];var i=a==="string"?{}:{type:a};r[t]=i}}});if(!a(r,{})){t.properties=r;t._propertiesParsedFromValue=true}}};u.prototype.buildSelectionColumnLabels=function(){var e=this;var t=e.getConfiguration();var a=e.getResourceBundle();return new r(e.getParameterId()+"_control_table_column_selection_label_all_checkbox",{selected:"{/_allSelected}",visible:typeof t.values!=="undefined",tooltip:{path:"/_allSelected",formatter:function(e){if(!e){return a.getText("EDITOR_FIELD_OBJECT_LIST_TABLE_COLUMN_SELECTION_TOOLTIP_ADDALL")}else{return a.getText("EDITOR_FIELD_OBJECT_LIST_TABLE_COLUMN_SELECTION_TOOLTIP_REMOVEALL")}}},select:e.onSelectionColumnClick.bind(e)})};u.prototype.onSelectionColumnClick=function(e){var t=this;var r=e.getParameter("selected");var a=t.getAggregation("_field");var o=a.getBinding("rows").getContexts();o.forEach(function(e){var t=e.getObject();t._dt=t._dt||{};t._dt._selected=r});var n=a.getModel();var l=a.getBinding("rows").getPath();var s=n.getProperty(l);var u;s.forEach(function(e){if(e._dt&&e._dt._selected){var t=i(e,500);u=u||[];u.push(t)}});n.checkUpdate(true);t.setValue(u)};u.prototype.updateSelectionColumn=function(){var e=this;var t=e.getAggregation("_field");var r=t.getBinding("rows").getContexts();var a=true;if(r.length===0){a=false}else{for(var i=0;i<r.length;i++){var o=r[i].getObject();if(!o._dt||o._dt._selected!==true){a=false;break}}}t.getModel().setProperty("/_allSelected",a)};u.prototype.onAdd=function(e){var t=this;var r=t.getAggregation("_field");var a=t._oObjectDetailsPopover.getModel().getProperty("/value");a._dt._position=t._positionCount;var i=r.getBinding("rows").getPath();var o=r.getModel();var n=o.getProperty(i);n.push(a);o.setProperty("/_hasTableAllSelected",false);o.setProperty("/_hasTableSelected",false);o.setProperty("/_hasNotEditableItemSelected",false);o.checkUpdate();t.refreshValue();t._oObjectDetailsPopover.close();t._positionCount++;t.updateTable()};u.prototype.refreshValue=function(){var e=this;var t=e.getAggregation("_field");var r=t.getModel();var a=t.getBinding("rows").getPath();var o=r.getProperty(a);var n=[];o.forEach(function(e){if(e._dt._selected){var t=i(e);n.push(t)}});e.setValue(n)};u.prototype.onSelectionChange=function(e){var t=this;var r=e.getParameter("selected");var a=this._getCurrentProperty("value");var i=t.getAggregation("_field");var o=i.getModel();if(r||a.length>1){t.refreshValue();t.updateSelectionColumn()}else{o.setProperty("/_allSelected",false);t.setValue(undefined)}};u.prototype.mergeValueWithRequestResult=function(e){var t=this;var r=t.getConfiguration();var n=t.getAggregation("_field");var l=n.getModel();var s=n.getBinding("rows").getPath();if(Array.isArray(r.value)&&r.value.length>0){var u=i(r.value,500);if(Array.isArray(e)&&e.length>0){t._positionCount=r.value.length+1;var d=[];u.forEach(function(e){var t;if(!e._dt){t=o.generateUuidV4()}else{t=e._dt._uuid||o.generateUuidV4();delete e._dt._uuid;delete e._dt._position}d.push(t)});var _=[];for(var p=0;p<e.length;p++){var g=e[p];var c=false;for(var f=0;f<u.length;f++){if(a(g,u[f])){c=true;break}}if(!c){g._dt._uuid=o.generateUuidV4();g._dt._position=t._positionCount;t._positionCount++;_.push(g)}}for(var v=0;v<u.length;v++){var h=u[v];h._dt=h._dt||{};h._dt._selected=true;h._dt._uuid=d[v];h._dt._position=v+1}if(_.length>0){l.setProperty("/_allSelected",false);u=u.concat(_)}else{l.setProperty("/_allSelected",true)}}else{u.forEach(function(e){e._dt=e._dt||{};e._dt._selected=true;e._dt._uuid=e._dt._uuid||o.generateUuidV4();e._dt._position=t._positionCount;t._positionCount++});l.setProperty("/_allSelected",true)}l.setProperty(s,u)}else{if(Array.isArray(e)&&e.length>0){e.forEach(function(e){e._dt._uuid=o.generateUuidV4();e._dt._position=t._positionCount;t._positionCount++})}else{l.setProperty(s,[])}l.setProperty("/_allSelected",false)}l.checkUpdate();t.updateTable()};u.prototype.onChangeOfTextArea=function(e){var t=this;var r=t.getResourceBundle();var a=e.getSource();var i=a.getValue();if(!i||i===""){t.saveValue(undefined,a)}else{try{var o=JSON.parse(i);if(!(o instanceof Array)){a.setValueState("Error");a.setValueStateText(r.getText("EDITOR_VAL_NOT_AN_ARRAY_OF_JSONOBJECTS"));return}t.saveValue(o,a)}catch(e){a.setValueState("Error");a.setValueStateText(r.getText("EDITOR_VAL_NOT_A_JSONOBJECT"))}}};u.prototype.saveValue=function(e,t,r){var a=this;var i;if(!r){a.setValue(e)}else{i=t.getModel();i.setProperty("/value",e)}t.setValueState("None");t.setValueStateText("")};u.prototype.cleanDT=function(e){if(e){e.forEach(function(e){if(e&&e._dt&&e._dt._selected){delete e._dt._selected}if(e&&e._dt&&a(e._dt,{})){delete e._dt}})}};return u});
//# sourceMappingURL=ObjectListField.js.map