/*!
* OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
*/
sap.ui.define(["sap/ui/integration/Extension","sap/ui/integration/util/OAuth3LOHelper","sap/ui/integration/util/Utils","sap/m/IllustratedMessageType","sap/ui/core/Lib","sap/ui/integration/library","sap/ui/core/library","sap/m/library","sap/base/Log"],function(t,e,n,o,i,s,r,a,u){"use strict";const l=r.aria.HasPopup;const p=s.CardBlockingMessageType;const g=a.ButtonType;const c=t.extend("sap.ui.integration.extensions.OAuth3LO");c.prototype.overrideBlockingMessage=function(t){if(!t){return null}if(!e.needsConsent(t)){return null}if(e.hasConsentError(t)){return this._createConsentErrorMessage(t)}return this._createConsentMessage(t)};c.prototype.fetch=async function(n,o,i){const s=await t.prototype.fetch.apply(this,arguments);if(e.needsConsent(s)){this._aPollingRequest=[n,o,i]}return s};c.prototype.exit=function(){t.prototype.exit.apply(this,arguments);if(this._sConsentId){e.unregisterCard(this._sConsentId,this.getCard())}if(this._oPolling){this._oPolling.stop();this._oPolling=null}};c.prototype._createConsentMessage=function(t){const n=this.getCard();const s=e.readHeader(t);this._sConsentId=s.consent.id;e.registerCard(this._sConsentId,n);const r=new URL(s.consent.url,window.location.href);return{type:p.Information,illustrationType:o.UnableToLoad,imageSrc:s.imageSrc,title:s.title||i.getResourceBundleFor("sap.ui.integration").getText("CARD_OAUTH3LO_FALLBACK_TITLE"),description:s.description||i.getResourceBundleFor("sap.ui.integration").getText("CARD_OAUTH3LO_FALLBACK_DESCRIPTION",[r.origin]),additionalContent:[{text:s.buttonText||i.getResourceBundleFor("sap.ui.integration").getText("CARD_OAUTH3LO_FALLBACK_BUTTON_TEXT"),buttonType:g.Accept,ariaHasPopup:l.Dialog,press:()=>{this._triggerConsent(s)}}]}};c.prototype._createConsentErrorMessage=function(t){const n=e.readHeader(t);u.error(n.message,this);return{type:p.Error,illustrationType:o.UnableToLoad,title:i.getResourceBundleFor("sap.ui.integration").getText("CARD_ERROR_CONFIGURATION_TITLE"),description:i.getResourceBundleFor("sap.ui.integration").getText("CARD_ERROR_CONFIGURATION_DESCRIPTION")}};c.prototype._triggerConsent=function(t){const n=t.consent.url;if(!n){u.error("Consent url for OAuth3LO is empty.",this);return}e.openConsentWindow(n,t.popupWindow);window.addEventListener("focus",()=>{this._startPolling(t)},{once:true})};c.prototype._startPolling=function(o){const i=o.polling;if(this._oPolling){this._oPolling.stop()}this._oPolling=n.polling(async()=>{u.info("Polling for 3LO consent.",this);const n=await t.prototype.fetch.apply(this,this._aPollingRequest);if(e.hasConsentError(n)){this.getCard().showBlockingMessage(this._createConsentErrorMessage(n));return true}if(e.needsConsent(n)){return false}if(n.ok){e.handleConsent(o.consent.id)}return true},i.frequency,i.maximum)};return c});
//# sourceMappingURL=OAuth3LO.js.map