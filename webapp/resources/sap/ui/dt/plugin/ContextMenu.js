/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/assert","sap/m/Button","sap/m/Menu","sap/m/MenuItem","sap/ui/base/DesignTime","sap/ui/core/Lib","sap/ui/dt/util/_createPromise","sap/ui/dt/Plugin","sap/ui/dt/OverlayRegistry","sap/ui/dt/Util","sap/ui/events/KeyCodes","sap/ui/Device"],function(e,t,n,o,i,s,a,r,u,l,c,d){"use strict";const p=r.extend("sap.ui.dt.plugin.ContextMenu",{metadata:{library:"sap.ui.dt",properties:{contextElement:{type:"object"},openOnClick:{type:"boolean",defaultValue:true}},events:{openedContextMenu:{},closedContextMenu:{}}}});const h="sapUiDtContextMenu";const f=s.getResourceBundleFor("sap.ui.dt");p.prototype.init=function(){this.oContextMenuControl=new n;this.oContextMenuControl.attachItemSelected(this._onItemSelected,this);this.oContextMenuControl.attachClosed(this._contextMenuClosed,this);this.oContextMenuControl.addStyleClass(h);this._aMenuItems=[];this._aGroupedItems=[];this._bHasPropagatedMenuItems=false;this._aSubMenus=[]};p.prototype.exit=function(){delete this._aMenuItems;if(this.oContextMenuControl){this.oContextMenuControl.destroy()}};p.prototype.addMenuItem=function(e,t,n){const o={menuItem:e,fromPlugin:!!t,bPersistOneTime:n};this._aMenuItems.push(o)};p.prototype.registerElementOverlay=function(e){e.attachBrowserEvent("click",this._openContextMenu,this);e.attachBrowserEvent("touchstart",this._openContextMenu,this);e.attachBrowserEvent("contextmenu",this._openContextMenu,this);e.attachBrowserEvent("keydown",this._onKeyDown,this);e.attachBrowserEvent("keyup",this._onKeyUp,this)};p.prototype.deregisterElementOverlay=function(e){e.detachBrowserEvent("click",this._openContextMenu,this);e.detachBrowserEvent("touchstart",this._openContextMenu,this);e.detachBrowserEvent("contextmenu",this._openContextMenu,this);e.detachBrowserEvent("keydown",this._onKeyDown,this);e.detachBrowserEvent("keyup",this._onKeyUp,this)};function m(e){const n=new t({id:`${this.sId}-${e.id}-additionalInfo-button`,icon:"sap-icon://message-information",visible:!e.submenu,type:"Transparent",ariaLabelledBy:this.getId()});n.setTooltip(e.additionalInfo);return n}function g(e,t){return e.map(e=>{const n=e.getPropagatedActionInfo(t);if(n){const t=u.getOverlay(n.propagatingControl);let o=e.getMenuItems([t]);if(!(o instanceof Promise)){o=Promise.resolve(o)}return new Promise((e,t)=>{o.then(t=>{const o=t.map(e=>{e.propagatingControl=n.propagatingControl;e.propagatingControlName=n.propagatingControlName;if(i.isDesignModeEnabled()||!e.propagatingControlName){e.propagatingControlName=n.propagatingControl.getMetadata().getName().split(".").pop()}return e});e(o)}).catch(t)})}return null}).filter(Boolean)}p.prototype.open=function(e,t,n){let i;const s=f.getText("CTX_EXTENDED_ACTIONS_HEADER");const r=f.getText("CTX_EXTENDED_ACTIONS_HEADER_DESCRIPTION");const c=e.getElement();const d=e.getDesignTimeMetadata();this.sSelectedControlName=d.getName(c)?.singular||c.getMetadata().getName().split(".").pop();this.bHasExtendedActionsTitleSet=false;function p(t,n,a,l,c){const d=function(){return false};if(a){if(!c){if(!this.bHasExtendedActionsTitleSet){this.bHasExtendedActionsTitleSet=true;const e=new o({key:"CTX_EXTENDED_MENU_TITLE",id:"CTX_EXTENDED_MENU_TITLE",text:s,enabled:false});e.addStyleClass("sapUiDtContextMenuExtendedActionsTitle");e.setTooltip(r);e.isFocusable=d;t.addItem(e)}const e=`CTX_PROPAGATED_CONTROL_NAME_${a.replace(/[\.\s]/g,"_").toUpperCase()}`;const n=new o({key:e,id:e,text:a,enabled:false});n.addStyleClass("sapUiDtContextMenuPropagatedControlTitle");n.isFocusable=d;t.addItem(n)}n.forEach(function(e){const n=u.getOverlay(e.propagatingControl);const i=[n];const s=typeof e.text==="function"?e.text(n):e.text;const a=typeof e.enabled==="function"?e.enabled(i):e.enabled;const r=new o({key:e.id,icon:e.icon,text:s,enabled:a});if(!c){r.addStyleClass("sapUiDtContextMenuPropagatedItem")}t.addItem(r);if(e.additionalInfo){const t=m.call(this,e);r.addEndContent(t)}}.bind(this))}else{const s=i;if(!l){const e=new o({key:"CTX_CONTROL_NAME",id:"CTX_CONTROL_NAME",text:this.sSelectedControlName,enabled:false});e.addStyleClass("sapUiDtContextMenuControlTitle");e.isFocusable=d;t.addItem(e)}n.forEach(function(n,i){const a=typeof n.text==="function"?n.text(e):n.text;const r=typeof n.enabled==="function"?n.enabled(s):n.enabled;const u=new o({key:n.id,icon:n.icon,text:a,enabled:r});t.addItem(u);if(n.additionalInfo){const e=m.call(this,n);u.addEndContent(e)}if(n.submenu){const e=true;p.call(this,t.getItems()[i+1],n.submenu,undefined,e)}}.bind(this))}}const h=e.getElement();if(this._fnCancelMenuPromise){if(this.getContextElement()===h){return}this._fnCancelMenuPromise();delete this._fnCancelMenuPromise}this.setContextElement(h);this.getDesignTime().getSelectionManager().attachChange(this._onSelectionChanged,this);i=this.getSelectedOverlays().filter(function(t){return t!==e});i.unshift(e);this._aMenuItems=this._aMenuItems.filter(function(e){if(e.bPersistOneTime){e.bPersistOneTime=false;return true}return!e.fromPlugin});this.oContextMenuControl.destroyItems();let C=Promise.resolve();if(!t){const e=a(function(e,t){l.waitForSynced(this.getDesignTime())().then(e).catch(t)}.bind(this));this._fnCancelMenuPromise=e.cancel;C=e.promise.then(function(){this._bHasPropagatedMenuItems=false;this._aSubMenus=[];const e=[];const t=this.getDesignTime().getPlugins();t.forEach(function(t){let n=t.getMenuItems(i);if(!(n instanceof Promise)){n=Promise.resolve(n)}e.push(n)});let n=[];if(i.length===1){n=g(t,i[0])}const o=a(function(t,o){e.push(...n);Promise.all(e).then(t).catch(o)});this._fnCancelMenuPromise=o.cancel;return o.promise}.bind(this)).then(function(e){if(e.length>0){return e.reduce(function(e,t){return e.concat(t)})}return e}).then(function(e){e.forEach(function(e){if(e.submenu!==undefined){this._addSubMenu(e)}else if(e.propagatingControlName!==undefined){this._addMenuItemToGroup(e);this.addMenuItem(e,true)}else{this.addMenuItem(e,true)}}.bind(this));delete this._fnCancelMenuPromise}.bind(this))}C.then(function(){const t=this._aMenuItems.map(function(e){return e.menuItem});if(t.length>0){const o=false;const i=this._sortMenuItems(t.filter(e=>!e.propagatingControl));p.call(this,this.oContextMenuControl,i,undefined,o);this._aGroupedItems.forEach(function(e){const t=e.sGroupName===this.sSelectedControlName;p.call(this,this.oContextMenuControl,e.aGroupedItems,e.sGroupName,o,t)}.bind(this));const s=n.type==="keyup"?e:undefined;e.focus();this.oContextMenuControl.openAsContextMenu(n,s)}this.fireOpenedContextMenu()}.bind(this)).catch(function(e){throw l.createError("ContextMenu#open",`An error occurred during calling getMenuItems: ${e}`)})};p.prototype._sortMenuItems=function(e){return e.sort(function(e,t){if(!e.rank&&!t.rank){return 0}if(!e.rank&&t.rank){return-1}if(e.rank&&!t.rank){return 1}return e.rank-t.rank})};p.prototype._onItemSelected=function(t){this._ensureSelection(this._oCurrentOverlay);function n(t,n){let o;if(t.propagatingControl){o=[u.getOverlay(t.propagatingControl)]}else{o=t.responsible||this.getSelectedOverlays()||[]}e(o.length>0,"sap.ui.rta - Opening context menu, with empty selection - check event order");const i={};i.eventItem=n;i.contextElement=this.getContextElement();t.handler(o,i)}const o=t.getParameter("item").getKey();this._aMenuItems.some(function(e){const i=e.menuItem;if(o===e.menuItem.id){n.apply(this,[i,t]);return true}else if(i.submenu){i.submenu.some(function(e){if(o===e.id){n.apply(this,[e,t]);return true}}.bind(this))}},this)};p.prototype._onKeyUp=function(e){const t=u.getOverlay(e.currentTarget.id);if(e.keyCode===c.ENTER&&t.getIgnoreEnterKeyUpOnce()){t.setIgnoreEnterKeyUpOnce(false);e.stopPropagation();e.preventDefault();return}if((e.keyCode===c.SPACE||e.keyCode===c.ENTER)&&e.shiftKey===false&&e.altKey===false&&e.ctrlKey===false){if(!this._checkForPluginLock()){this._openContextMenu(e);e.stopPropagation();e.preventDefault()}}if(e.keyCode===c.F10&&e.shiftKey===true&&e.altKey===false&&e.ctrlKey===false){if(!this._checkForPluginLock()){this._openContextMenu(e);e.stopPropagation();e.preventDefault()}}};p.prototype._onKeyDown=function(e){const t=u.getOverlay(e.currentTarget.id);if(e.keyCode===c.SPACE&&e.shiftKey===false&&e.altKey===false&&e.ctrlKey===false){if(t&&t.isSelectable()&&!this._checkForPluginLock()){t.setSelected(true);e.stopPropagation();e.preventDefault()}}};p.prototype._openContextMenu=function(e){if(e.type==="click"&&i.isDesignModeEnabled()){return}const t=u.getOverlay(e.currentTarget.id);if(t&&t.isSelectable()&&t.getSelected()){this._oCurrentOverlay=t;this.open(t,undefined,e)}};p.prototype._contextMenuClosed=function(){this._aGroupedItems=[];this.fireClosedContextMenu()};p.prototype._onSelectionChanged=function(){this.getDesignTime().getSelectionManager().detachChange(this._onSelectionChanged,this)};p.prototype._ensureSelection=function(e){if(e&&!e.isSelected()){e.setSelected(true)}};p.prototype._checkForPluginLock=function(){if(d.os.ios){return false}return!!this.getDesignTime().getBusyPlugins().length};p.prototype._addMenuItemToGroup=function(e){const t=e.propagatingControlName;const n=this._aGroupedItems.some(function(n){if(n.sGroupName===t){n.aGroupedItems.push(e);return true}});if(!n){if(t!==this.sSelectedControlName){this._aGroupedItems.push({sGroupName:e.propagatingControlName,aGroupedItems:[e]});this._bHasPropagatedMenuItems=true}else{this._aGroupedItems.unshift({sGroupName:e.propagatingControlName,aGroupedItems:[e]})}}};p.prototype._addSubMenu=function(e){e.submenu.forEach(function(t){t.handler||=e.handler});this._aSubMenus.push({sSubMenuId:e.id,aSubMenuItems:e.submenu});this.addMenuItem(e,true)};return p});
//# sourceMappingURL=ContextMenu.js.map