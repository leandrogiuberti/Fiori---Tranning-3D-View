/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Component","sap/ui/core/Lib","sap/ui/fl/apply/_internal/changes/descriptor/ApplyStrategyFactory","sap/ui/fl/apply/_internal/changes/descriptor/InlineApplier","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerRegistration","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/variants/VariantModel","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/model/odata/ODataUtils","sap/ui/performance/Measurement"],function(e,n,t,o,a,i,r,s,c,l,p,d,g,u,f,m){"use strict";var h={};h._componentInstantiationPromises=new WeakMap;var y={};function C(n){if(g.getUshellContainer()){return Promise.resolve()}var o=window.sessionStorage.getItem(`sap.ui.rta.restart.${d.CUSTOMER}`);if(o){var a=l.getFlexReferenceForControl(n);if(o!==a&&o!=="true"){e.error(`an application component was started which does not match the component for which the restart was triggered:\n\t\t\t\t\tTriggering component: ${o}\n\t\t\t\t\tStarted component: ${a}`);return Promise.resolve()}return new Promise(function(e,o){Promise.all([t.load({name:"sap.ui.rta"}),n.rootControlLoaded()]).then(function(){sap.ui.require(["sap/ui/rta/api/startKeyUserAdaptation"],function(t){t({rootControl:n});e()})}).catch(function(e){o(e)})})}return Promise.resolve()}function M(e){const n=l.getFlexReferenceForControl(e);const t=r.getStorageResponse(n);if(t.messagebundle&&!e.getModel("i18nFlexVendor")&&t.changes?.changes?.some(e=>e.layer===d.VENDOR)){e.setModel(new u(t.messagebundle),"i18nFlexVendor")}}async function v(e){const n=l.getFlexReferenceForControl(e);var t;var o=i.applyAllChangesForControl.bind(i,e,n);o._bIsFlexApplyChangesFunction=true;e.addPropagationListener(o);t=h._createVariantModel(e);await t.initialize();m.end("flexProcessing");e.setModel(t,s.getVariantModelName());await C(e)}function w(e,n){if(g.isApplicationComponent(e)){var t=e.getId();var o=r.initialize({componentId:t,asyncHints:n.asyncHints}).then(v.bind(this,e)).then(M.bind(this,e)).then(function(){if(y[t]){y[t].forEach(function(n){var t=e.getModel(s.getVariantModelName());n.setModel(t,s.getVariantModelName())});delete y[t]}});h._componentInstantiationPromises.set(e,o);return o}else if(g.isEmbeddedComponent(e)){var a=g.getAppComponentForControl(e);if(h._componentInstantiationPromises.has(a)){return h._componentInstantiationPromises.get(a).then(function(){var n=a.getModel(s.getVariantModelName());e.setModel(n,s.getVariantModelName())})}y[a.getId()]=y[a.getId()]||[];y[a.getId()].push(e);return Promise.resolve()}return Promise.resolve()}function A(e,n){if(!g.isApplication(n)||!e.id){return Promise.resolve()}r.initialize({componentData:e.componentData||e.settings&&e.settings.componentData,asyncHints:e.asyncHints,manifest:n,componentId:e.id});return a.applyChanges(n,o.getRuntimeStrategy())}h._createVariantModel=function(e){return new p({},{appComponent:e})};h.instanceCreatedHook=function(...e){return w(...e)};h.componentLoadedHook=function(...e){return A(...e)};async function P(t){const o=t.owner&&n.get(t.owner.id);if(!t.factoryConfig){e.error("Could not fetch Annotation changes. This can be caused by creating a component in an unsupported way");return[]}const a=t.owner?.id||t.factoryConfig.id||t.factoryConfig.settings?.id;const i=o?.getComponentData()||t.factoryConfig.componentData||t.factoryConfig.settings?.componentData;const s=l.getFlexReference({manifest:o?.getManifest()||t.manifest,componentData:i});try{await r.initialize({componentData:i,asyncHints:t.owner?.config.asyncHints||t.factoryConfig.asyncHints,componentId:a,reference:s,skipLoadBundle:true});const n=f.removeOriginSegmentParameters(t.model.getServiceUrl());const o=r.getAnnotationChanges(s).filter(e=>e.getServiceUrl()===n);const l=[];for(const n of o){try{const e=await c.getAnnotationChangeHandler({changeType:n.getChangeType()});l.push(await e.applyChange(n));n._appliedOnModel=true}catch(t){e.error(`Annotation change with id ${n.getId()} could not be applied to the model`,t)}}return l}catch(n){e.error("Annotation changes could not be applied.",n);return[]}}h.modelCreatedHook=function(e){e.model.setAnnotationChangePromise(P(e))};return h});
//# sourceMappingURL=ComponentLifecycleHooks.js.map