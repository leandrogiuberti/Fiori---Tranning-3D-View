/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/Deferred","sap/base/util/each","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/Component","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/DataSelector","sap/ui/fl/apply/_internal/flexState/InitialPrepareFunctions","sap/ui/fl/initial/_internal/Loader","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/LayerUtils","sap/ui/fl/apply/_internal/init"],function(e,t,n,r,a,c,i,s,o,f,l,u,p,d,m,g){"use strict";const b="sap.ui.fl.apply._internal.flexObjects.AppDescriptorChange";const x="sap.ui.fl.apply._internal.flexObjects.AnnotationChange";const h={};const O={};const j={};const y={appDescriptorChanges:{pathInResponse:[]},annotationChanges:{pathInResponse:[]},changes:{initialPreparationFunctionName:"uiChanges",pathInResponse:["changes"]},variants:{initialPreparationFunctionName:"variants",pathInResponse:["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"]},comp:{pathInResponse:["comp.changes","comp.defaultVariants","comp.standardVariants","comp.variants"]}};const R={flexObjects:{},smartVariantManagementControls:{}};function F(e,t){var n={comp(){return Object.values(t).reduce(function(e,t){return e.concat(t)},[])},variants(){return t.map(function(e){var n=e.variantReference===e.variantManagementReference||t.some(function(t){return t.variantManagementReference===e.variantManagementReference&&t.fileName===e.variantReference});if(!n){return{...e,variantReference:e.variantManagementReference}}return e})}}[e];if(n){return n()}return Array.isArray(t)?t:[]}function v(e){var t=i.getComponentById(e.componentId);e.componentData||=t&&t.getComponentData()||{};e.manifest||=e.rawManifest||t&&t.getManifestObject()||{};e.reference||=p.getFlexReference(e)}function I(e){var t=[];n(e.changes,function(e,n){F(e,n).forEach(function(e){t.push(s.createFromFileContent(e,null,true))})});return t}function C(e,t){var n=y[e].initialPreparationFunctionName;var r=l[n];if(r){return r(t)}return undefined}var D=new f({id:"flexObjects",parameterKey:"reference",executeFunction(e,t){if(!O[t.reference]){return[]}var n=O[t.reference].runtimePersistence;return n.flexObjects.concat(n.runtimeOnlyData.flexObjects||[],R.flexObjects[t.reference][O[t.reference].componentId]||[])}});const S=new f({id:"appDescriptorChanges",parentDataSelector:D,executeFunction(e){return e.filter(e=>e.isA(b))},checkInvalidation(e,t){const n=["addFlexObject","removeFlexObject"].includes(t.type);return n&&t.updatedObject?.isA(b)}});const P=new f({id:"annotationChanges",parentDataSelector:D,executeFunction(e){return e.filter(e=>e.isA(x))},checkInvalidation(e,t){const n=["addFlexObject","removeFlexObject"].includes(t.type);return n&&t.updatedObject?.isA(x)}});function w(e,t){const n=e.storageResponse;var a={flexObjects:I(n),runtimeOnlyData:{flexObjects:[]}};if(!e.componentId){return a}Object.keys(y).forEach(function(c){var i=C(c,{storageResponse:n,externalData:t,flexObjects:a.flexObjects,componentId:e.componentId});if(i){a=r(a,i)}});return a}function k(e,t,r){const a=r.flexObjects.slice();const i=a.length;const f=[];let l;n(t.changes,function(e,t){F(e,t).forEach(function(e){f.push(e)})});O[e].runtimePersistence={...r,flexObjects:f.map(function(e){let t;const n=a.find(function(n,r){t=r;return n.getId()===e.fileName});if(n){a.splice(t,1);if(n.getState()!==o.LifecycleState.PERSISTED){n.setResponse(e);l=true}return n}if(e.fileType==="ctrl_variant_change"&&e.fileName.endsWith("flVariant_contextFiltering_setVisible")){return s.createFromFileContent(e,null,true)}const r="Error updating runtime persistence: storage returned unknown flex objects";c.error(r);throw new Error(r)})};if(i!==O[e].runtimePersistence.flexObjects.length){l=true}return l}function E(e,t){var n=e.reference;var r=false;if(!O[n].componentData&&e.componentId){var c=i.getComponentById(e.componentId);O[n].componentData=c?c.getComponentData():e.componentData;r=true}if(!O[n].storageResponse){O[n].storageResponse=L(n,t);delete O[n].runtimePersistence;r=true}if(!a.get(["flexObjects",n,e.componentId],R)){a.set(["flexObjects",n,e.componentId],[],R)}if(!O[n].runtimePersistence){O[n].runtimePersistence=w(O[n],R.flexObjects[n][e.componentId]||[]);r=true}if(r){D.checkUpdate({reference:n})}}function L(e,t){const c=r({},t);c.changes={...m.getEmptyFlexDataResponse(),...c.changes};const i=c.changes;const s=d.getByReference(e);if(g.isLayerFilteringRequired(e)){n(y,function(e,t){t.pathInResponse.forEach(function(e){const t=a.get(e,i).filter(function(e){return!e.layer||!g.isOverLayer(e.layer,s.maxLayer)});a.set(e,t,i)})})}O[e].maxLayer=s.maxLayer;return c}function _(e){O[e.reference]=r({},{componentId:e.componentId,componentData:e.componentData,skipLoadBundle:e.skipLoadBundle})}function M(e){var t=O[e.reference].componentId;return t!==e.componentId}function z(e,t){if(O[e]?.maxLayer!==d.getByReference(e).maxLayer){h.rebuildFilteredResponse(e,t)}}function U(e){O[e]={emptyState:true,reInitialize:true,componentId:""};const n=new t;j[e]=n;n.resolve();const r=u.initializeEmptyCache(e);E({reference:e},r)}h.getRuntimeOnlyData=function(e){if(!O[e]){U(e)}return O[e].runtimePersistence.runtimeOnlyData};h.initialize=async function(e){const n=r({},e);v(n);const a=n.reference;const c=j[a];const i=new t;j[a]=i;if(c){await c.promise}const s=await u.getFlexData(n);if(!O[n.reference]?.storageResponse||s.cacheInvalidated||M(n)){_(n)}else{z(n.reference,s.data)}E(n,s.data);i.resolve()};h.waitForInitialization=function(e){const t=j[e]?.promise;if(!t){c.error("FlexState.waitForInitialization was called before FlexState.initialize");return Promise.resolve()}return t};h.isInitialized=function(e){var t=e.reference?e.reference:p.getFlexReferenceForControl(e.control);return!!O[t]};h.lazyLoadFlVariant=async function(e){if(!O[e.reference]){U(e.reference)}const t=await u.loadFlVariant(e);const n=O[e.reference];n.storageResponse=L(e.reference,t.completeData);n.runtimePersistence.flexObjects=[...n.runtimePersistence.flexObjects,...I(L(e.reference,{changes:t.newData}))];D.checkUpdate({reference:e.reference})};h.reinitialize=async function(e){v(e);const n=e.reference;const r=O[n].runtimePersistence;const a=j[n].promise;const c=new t;j[n]=c;await a;e.reInitialize=true;const i=await u.getFlexData(e);_(e);O[n].storageResponse=L(n,i.data);const s=k(n,O[n].storageResponse,r);if(s){D.checkUpdate({reference:n})}c.resolve()};h.update=function(e,t){const n=[];m.updateStorageResponse(O[e].storageResponse,t);u.updateCachedResponse(e,t);t.forEach(t=>{if(t.type!=="ui2"){const r=O[e].runtimePersistence.flexObjects.findIndex(e=>e.getId()===t.flexObject.fileName);const a=O[e].runtimePersistence.flexObjects[r];switch(t.type){case"add":if(r<0){throw new Error("Flex response includes unknown flex object")}break;case"delete":if(r>=0){O[e].runtimePersistence.flexObjects.splice(r,1);n.push({type:"removeFlexObject",updatedObject:a})}break;case"update":if(a&&a.getState()!==o.LifecycleState.PERSISTED){a.setResponse(t.flexObject);n.push({type:"updateFlexObject",updatedObject:a})}break;default:}}});if(n.length){D.checkUpdate({reference:e},n)}};h.clearState=function(e){u.clearCache(e);if(e){delete O[e];delete j[e];D.clearCachedResult({reference:e})}else{Object.keys(O).forEach(e=>delete O[e]);Object.keys(j).forEach(e=>delete j[e]);D.clearCachedResult()}};h.addRuntimeSteadyObject=function(e,t,n){n.setState(o.LifecycleState.PERSISTED);R.flexObjects[e]||={};R.flexObjects[e][t]||=[];R.flexObjects[e][t].push(n);D.checkUpdate({reference:e},[{type:"addFlexObject",updatedObject:n}])};h.clearRuntimeSteadyObjects=function(e,t){if(R.flexObjects[e]){delete R.flexObjects[e][t];D.clearCachedResult({reference:e})}};h.rebuildFilteredResponse=function(e,t){if(O[e]){O[e].storageResponse=L(e,t);O[e].runtimePersistence=w(O[e],R.flexObjects[e][O[e].componentId]||[]);D.checkUpdate({reference:e})}};h.addDirtyFlexObjects=function(e,t){if(!O[e]){U(e)}const n=d.getByReference(e).adaptationLayer;const r=t.filter(e=>!n||!g.isOverLayer(e.getLayer(),n)).filter(t=>!O[e].runtimePersistence.flexObjects.some(e=>e.getId()===t.getId()));if(r.length>0){O[e].runtimePersistence.flexObjects=O[e].runtimePersistence.flexObjects.concat(r);D.checkUpdate({reference:e},r.map(function(e){return{type:"addFlexObject",updatedObject:e}}))}return r};h.removeDirtyFlexObjects=function(e,t){const n=[];if(t.length>0){const r=O[e].runtimePersistence.flexObjects;t.forEach(function(e){const t=r.indexOf(e);if(t>=0){n.push(e);r.splice(t,1)}});if(n.length>0){D.checkUpdate({reference:e},t.map(function(e){return{type:"removeFlexObject",updatedObject:e}}))}}return n};h.getComponentIdForReference=function(e){return O[e]?.componentId};h.getFlexObjectsDataSelector=function(){return D};h.getAppDescriptorChanges=function(e){return S.get({reference:e})};h.getAnnotationChanges=function(e){return P.get({reference:e})};h.getUI2Personalization=function(e){return r({},O[e].storageResponse.changes.ui2personalization)};h.callPrepareFunction=function(e,t){return y[e].prepareFunction(t)};h.getStorageResponse=async function(e){if(j[e]){await j[e].promise;return u.getCachedFlexData(e)}return undefined};h.getComponentData=function(e){return O[e]&&O[e].componentData};h.addSVMControl=function(e,t){R.smartVariantManagementControls[e]||=[];R.smartVariantManagementControls[e].push(t)};h.getSVMControls=function(e){return R.smartVariantManagementControls[e]||[]};return h});
//# sourceMappingURL=FlexState.js.map