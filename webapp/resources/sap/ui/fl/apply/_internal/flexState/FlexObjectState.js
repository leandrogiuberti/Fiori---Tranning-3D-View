/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/merge","sap/base/util/restricted/_omit","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/changes/UIChangesState","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/DataSelector","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/Utils"],function(e,n,t,c,a,s,o,i,r,l,p,g,d){"use strict";const f={};const u=new l({id:"allDirtyFlexObjects",parentDataSelector:p.getFlexObjectsDataSelector(),executeFunction(e){return e.filter(e=>e.getState()!==s.LifecycleState.PERSISTED)}});function h(e,n){const t=f.getCompleteDependencyMap(n).mDependencies;return t[e.getId()]&&{...t[e.getId()]}}function D(e,n,c,a,s){const o=[];const i=f.getLiveDependencyMap(s);const r={...e};e.controlsDependencies.forEach(e=>{if(!t.bySelector(e,c)){const n=t.getControlIdBySelector(e,c);o.push(e);i.mControlsWithDependencies[n]||=[];if(!i.mControlsWithDependencies[n].includes(a.getId())){i.mControlsWithDependencies[n].push(a.getId())}}});r.dependencies=n;r.controlsDependencies=o;if(n.length||o.length){i.mDependencies[a.getId()]=r}return r}function y(e,n){const c=e.getDependentControlSelectorList();c.push(e.getSelector());return!c.some(e=>!t.bySelector(e,n))}function C(e,n,t,c,a){let s=y(e,c);if(!s){return[]}a.push(e);const o=e.getId();const i=n[o]&&n[o].dependencies||[];for(let e=0,r=i.length;e<r;e++){const r=d.getChangeFromChangesMap(t,i[e]);s=C(r,n,t,c,a);if(s.length===0){a=[];break}delete n[o]}return a}f.getAllApplicableUIChanges=function(e){const n=i.getVariantIndependentUIChanges(e);return n.concat(r.getInitialUIChanges({reference:e}))};f.getCompleteDependencyMap=function(n){const t=i.getVMIndependentCompleteDependencyMap(n);const c=r.getDependencyMap(n);const a=e({},t);e(a.mDependencies,c.mDependencies);e(a.mDependentChangesOnMe,c.mDependentChangesOnMe);a.aChanges=a.aChanges.concat(c.aChanges);["mChanges","mControlsWithDependencies"].forEach(e=>{Object.entries(c[e]).forEach(([n,t])=>{if(Object.keys(a[e]).includes(n)){a[e][n]=a[e][n].concat(t)}else{a[e][n]=t}})});return a};f.getLiveDependencyMap=function(e){return p.getRuntimeOnlyData(e).liveDependencyMap||o.createEmptyDependencyMap()};f.getOpenDependentChangesForControl=function(e,n){const c=g.getFlexReferenceForControl(n);return o.getOpenDependentChangesForControl(f.getLiveDependencyMap(c),t.getControlIdBySelector(e,n),n)};f.copyDependenciesFromCompleteDependencyMap=function(e,n){const c=g.getFlexReferenceForControl(n);let s=h(e,c);if(s){const o=f.getLiveDependencyMap(c);const i=[];s.dependencies.forEach(function(c){if(a.checkIfDependencyIsStillValid(n,t,o,c)){o.mDependentChangesOnMe[c]||=[];o.mDependentChangesOnMe[c].push(e.getId());i.push(c)}});s=D(s,i,n,e,c)}};f.waitForFlexObjectsToBeApplied=async function(e){const n=d.getAppComponentForSelector(e[0].selector);if(!n){return}const t=g.getFlexReferenceForControl(n);await Promise.all(e.map(e=>{const a=e.selector.id&&c.getElementById(e.selector.id)||e.selector;e.changeTypes||=[];const s=f.getLiveDependencyMap(t);let o=[];const i={...s.mDependencies};const{mChanges:r}=s;const l=r[a.getId()]||[];const p=l.filter(n=>!n.isCurrentProcessFinished()&&(e.changeTypes.length===0||e.changeTypes.includes(n.getChangeType())));const g=[];p.forEach(e=>{const t=C(e,i,s.mChanges,n,[]);t.forEach(e=>{if(g.indexOf(e)===-1){g.push(e)}})});g.forEach(e=>{o=o.concat(e.addChangeProcessingPromises())});return Promise.all(o)}))};f.getDirtyFlexObjects=function(e){function n(e){return!(e.getState()===s.LifecycleState.DELETED&&e._sPreviousState===s.LifecycleState.NEW)||e.getState()===s.LifecycleState.DELETED&&e.getFileType()==="variant"}return u.get({reference:e}).filter(e=>n(e))};return f});
//# sourceMappingURL=FlexObjectState.js.map