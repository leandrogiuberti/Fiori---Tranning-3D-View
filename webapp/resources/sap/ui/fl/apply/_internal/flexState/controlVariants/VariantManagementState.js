/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_pick","sap/base/util/ObjectPath","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/DataSelector","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/changeHandler/condenser/Classification","sap/ui/fl/LayerUtils"],function(e,t,n,a,r,c,i,s,f,o){"use strict";const u={ctrl_variant_change:{getCondenserInfo(e){return{classification:f.LastOneWins,uniqueKey:e.getVariantId()+e.getChangeType()}}},ctrl_variant_management_change:{getCondenserInfo(e,t){return{classification:f.LastOneWins,uniqueKey:t.modifier.getControlIdBySelector(e.getSelector(),t.appComponent)}}}};var l={};const g={};const v={};function d(e,t,r){var c=s.getComponentData(e);var i=n.get(["technicalParameters",a.VARIANT_TECHNICAL_PARAMETER],c)||[];var f=r.filter(e=>e.visible).map(e=>e.key);if(i.length===1){i=i[0].split(",")}var o=f.find(e=>i.includes(e));if(o){return o}return t.slice().reverse().map(e=>e.getContent().defaultVariant).find(e=>f.includes(e))}function p(e,t,n){var a=(g[t]||{})[n];return{defaultVariant:n,currentVariant:a,variants:[],variantManagementChanges:e.filter(function(e){return e.getSelector().id===n})}}function h(e,t){return e.find(e=>e.getId()===t)}function m(e,t){const n=[];let a=t;let r;do{r=h(e,a.getVariantReference());if(r){n.push(r);a=r}}while(r);return n.map(e=>e.getId())}function V(e,t){const n=m(e.variants,t);return{instance:t,variantChanges:e.variantChanges.filter(function(e){return e.getVariantId()===t.getId()}),controlChanges:e.changes.filter(function(e){var a=e.isA("sap.ui.fl.apply._internal.flexObjects.UIChange");if(!a){return false}var r=e.getVariantReference()===t.getId();var c=n.indexOf(e.getVariantReference())>-1;var i=o.compareAgainstCurrentLayer(e.getLayer(),t.getLayer())===-1;return r||c&&i}),key:t.getId(),title:t.getName(),layer:t.getLayer(),favorite:t.getFavorite(),executeOnSelect:t.getExecuteOnSelection(),visible:t.getVisible(),author:t.getAuthor(),contexts:t.getContexts(),isStandardVariant:t.getStandardVariant()}}function C(e,t){switch(t.getChangeType()){case"setTitle":e.title=t.getText("title");break;case"setFavorite":e.favorite=t.getContent().favorite;break;case"setExecuteOnSelect":e.executeOnSelect=t.getContent().executeOnSelect;break;case"setVisible":e.visible=t.getContent().visible;break;case"setContexts":e.contexts=t.getContent().contexts;break;default:throw Error("Unknown ctrl_variant_change type")}}function R(e,t){var n=t.getContent().defaultVariant;e.variants.forEach(t=>{if(t.key===n&&t.visible){e.defaultVariant=n}})}function y(e){const t={variants:[],variantManagementChanges:[],changes:[],variantChanges:[]};e.forEach(e=>{switch(e.getFileType()){case"ctrl_variant":t.variants.push(e);break;case"ctrl_variant_management_change":t.variantManagementChanges.push(e);break;case"change":t.changes.push(e);break;case"ctrl_variant_change":t.variantChanges.push(e);break;default:break}});return t}function b(e,t){const a=y(e);const r=t.reference;const c={};a.variants.forEach(e=>{var t=e.getVariantManagementReference();c[t]||=p(a.variantManagementChanges,r,t);c[t].variants.push(V(a,e))});a.variantChanges.forEach(e=>{const t=O(c,e);if(t){C(t,e,r,c)}});a.variantManagementChanges.forEach(e=>{const t=c[e.getSelector().id];if(t){R(t,e)}});Object.keys(c).forEach(e=>{const t=c[e];if(!t.currentVariant||!t.variants.some(e=>e.key===t.currentVariant)){const c=d(r,a.variantManagementChanges,t.variants)||e;t.currentVariant=c;n.set([r,e],c,g)}t.variants.sort((e,t)=>{if(e.isStandardVariant){return-1}if(t.isStandardVariant){return 1}return e.title.toLowerCase()<t.title.toLowerCase()?-1:1});var i=t.variants.find(e=>e.key===t.currentVariant).controlChanges;t.modified=i.some(e=>!e.isPersisted()&&!e.getSavedToVariant());t.variants.some(e=>{if(!e.favorite&&e.key===t.defaultVariant){e.favorite=true;return true}return false})});return c}function O(e,t){var n;Object.values(e).some(function(e){return e.variants.some(function(e){if(t.getVariantId()===e.key){n=e;return true}return false})});return n}var j=new i({id:"variantManagementMap",parentDataSelector:s.getFlexObjectsDataSelector(),executeFunction:b,checkInvalidation(e,t){if(t.type==="switchVariant"){return true}const n=["addFlexObject","updateFlexObject","removeFlexObject"];const a=n.includes(t.type);const r=["ctrl_variant","ctrl_variant_change","ctrl_variant_management_change"];const c=r.includes(t.updatedObject?.getFileType?.());const i=t.updatedObject?.getVariantReference?.();return a&&(c||i)}});var x=new i({id:"variantManagements",parameterKey:"variantManagementReference",parentDataSelector:j,executeFunction(e,t){return e[t.variantManagementReference]}});var S=new i({id:"variants",parameterKey:"variantReference",parentDataSelector:x,executeFunction(e,t){return e.variants.find(e=>e.instance.getId()===t.variantReference)}});const F=new i({id:"vmDependentDependencyMap",parentDataSelector:j,executeFunction(e,t){let n=[];Object.entries(e).forEach(([e,a])=>{n=n.concat(l.getControlChangesForVariant({vmReference:e,vReference:a.currentVariant,reference:t.reference}))});const a=c.createEmptyDependencyMap();const r=s.getComponentIdForReference(t.reference);n.forEach(e=>{c.addChangeAndUpdateDependencies(e,r,a)});return a},checkInvalidation(e,t){if(t.type==="switchVariant"){return true}const n=["addFlexObject","removeFlexObject"].includes(t.type);const a=t.updatedObject.getFileType()==="change";const r=Object.values(g[e.reference]||{});return a&&n&&r.includes(t.updatedObject.getVariantReference())}});var _=new i({id:"variantDependentFlexObjects",parentDataSelector:s.getFlexObjectsDataSelector(),executeFunction(e){return e.filter(function(e){const t=e.getVariantReference?.();const n=["ctrl_variant","ctrl_variant_change","ctrl_variant_management_change"].indexOf(e.getFileType())>-1;return n||t})}});l.getDependencyMap=function(e){return F.get({reference:e})};l.getVariantDependentFlexObjects=function(e){return _.get({reference:e})};l.getChangeInformationProvider=function(e){return u[e.getFileType()]};l.resetCurrentVariantReference=function(e){delete g[e];j.checkUpdate({reference:e})};l.getVariantManagementMap=function(){return j};l.addRuntimeSteadyObject=function(e,t,n){s.addRuntimeSteadyObject(e,t,n)};l.clearRuntimeSteadyObjects=function(e,t){s.clearRuntimeSteadyObjects(e,t)};l.addRuntimeOnlyFlexObjects=function(e,t){t.forEach(t=>s.getRuntimeOnlyData(e).flexObjects.push(t));s.getFlexObjectsDataSelector().clearCachedResult({reference:e})};l.loadVariant=async function(e){await s.lazyLoadFlVariant({variantReference:e.variantReference,reference:e.reference})};l.getControlChangesForVariant=function(e){const t=l.getVariant(e);if(t){return t.controlChanges.filter(function(t){const n=t.getState()!==r.LifecycleState.PERSISTED;const a=t.getVariantReference()!==e.vReference;return(e.includeDirtyChanges!==false||!n)&&(e.includeReferencedChanges!==false||!a)})}return[]};l.getVariantChangesForVariant=function(e){var t=l.getVariant(e);return t?.variantChanges||[]};l.getVariant=function(e){var t=e.vReference||x.get({variantManagementReference:e.vmReference,reference:e.reference}).defaultVariant;return S.get({variantManagementReference:e.vmReference,variantReference:t,reference:e.reference})};l.updateVariant=function(e){j.checkUpdate({reference:e.reference},[{type:"updateFlexObject",updatedObject:e.variant}])};l.getCurrentVariantReference=function(e){var t=x.get({variantManagementReference:e.vmReference,reference:e.reference});return t?.currentVariant};l.getDefaultVariantReference=function(e){const t=x.get({variantManagementReference:e.vmReference,reference:e.reference});return t?.defaultVariant};l.getAllCurrentVariants=function(e){const t=j.get({reference:e});return Object.entries(t).map(t=>{const n=l.getVariant({vmReference:t[0],vReference:t[1].currentVariant,reference:e}).instance;return n})};l.getVariantManagementReferences=function(e){var t=j.get({reference:e});return Object.keys(t)};l.getVariantManagementReferenceForVariant=function(e,t){const n=j.get({reference:e});return Object.entries(n).find(([,e])=>e.variants.some(e=>e.key===t))?.[0]};l.getAllVariants=function(e){var t=j.get({reference:e});return Object.keys(t).reduce(function(e,n){return e.concat(t[n].variants)},[])};l.getVariantManagementChanges=function(e){const t=j.get({reference:e.reference});const n=Object.values(t).map(e=>e.variantManagementChanges).flat();if(!e.vReference){return n}return n.filter(t=>e.vReference===t.getContent().defaultVariant)};l.getInitialUIChanges=function(e){const t=j.get({reference:e.reference});e.includeDirtyChanges=!!e.includeDirtyChanges;return Object.keys(t).reduce(function(n,a){if(e.vmReference&&e.vmReference===a||!e.vmReference){const r={...e,vmReference:a,vReference:t[a].currentVariant};return n.concat(l.getControlChangesForVariant(r))}return n},[])};l.getAllCurrentFlexObjects=function(e){const t=j.get({reference:e.reference});return Object.keys(t).reduce(function(n,a){if(e.vmReference&&e.vmReference===a||!e.vmReference){const r={...e,vmReference:a,vReference:t[a].currentVariant};const c=l.getVariant(r);return n.concat(c.variantChanges).concat(c.controlChanges).concat(t[a].variantManagementChanges).concat(t[a].variants.map(e=>e.instance))}return n},[])};l.filterHiddenFlexObjects=function(e,t){const n=j.get({reference:t});const a=[];Object.values(n).forEach(e=>{e.variants.forEach(e=>{if(e.visible===false){a.push(e.key)}})});return e.filter(e=>{const t={ctrl_variant:()=>e.getVariantId(),ctrl_variant_change:()=>e.getVariantId(),change:()=>e.getVariantReference()}[e.getFileType()]?.();return!a.includes(t)})};l.setCurrentVariant=function(e){n.set([e.reference,e.vmReference],e.newVReference,g);j.checkUpdate({reference:e.reference},[{type:"switchVariant"}])};l.setVariantSwitchPromise=function(e,t,n){v[e]||={};v[e][t]=n};l.waitForVariantSwitch=function(e,t){return v[e]?.[t]||Promise.resolve()};l.waitForAllVariantSwitches=function(e){return Promise.all(Object.values(v[e]||{}))};l.getVariantsForVariantManagement=function(e){const t=x.get({variantManagementReference:e.vmReference,reference:e.reference});return t?.variants||[]};return l});
//# sourceMappingURL=VariantManagementState.js.map