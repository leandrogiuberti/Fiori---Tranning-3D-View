/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/DataSelector","sap/ui/fl/apply/_internal/flexState/compVariants/applyChangesOnVariant","sap/ui/fl/apply/_internal/flexObjects/CompVariant","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States"],function(e,t,n,a,r,c,i){"use strict";const s={};const p="sap.ui.fl.apply._internal.flexObjects.UpdatableChange";const l=["addFavorite","defaultVariant","removeFavorite","standardVariant","updateVariant"];const o=e=>e?.isA(p)&&e.getFileType()==="change"&&e.getChangeType()==="defaultVariant";const y=new n({id:"compSetDefault",parameterKey:"persistencyKey",parentDataSelector:t.getFlexObjectsDataSelector(),executeFunction(e,t){return e.filter(e=>(e.getState()!==i.LifecycleState.DELETED||t.includeDeleted)&&o(e)&&e.getSelector().persistencyKey===t.persistencyKey)},checkInvalidation(e,t){const n=t.updatedObject;const a=n?.getSelector?.().persistencyKey===e.persistencyKey;const r=["addFlexObject","removeFlexObject"].includes(t.type);return a&&r&&o(t.updatedObject)}});const d=new n({id:"compEntitiesData",parentDataSelector:t.getFlexObjectsDataSelector(),executeFunction(e){return e.filter(e=>e.getFileType()==="variant"||e.getFileType()==="change"&&l.includes(e.getChangeType()))},checkInvalidation(e,t){const n=t.updatedObject;const a=["addFlexObject","updateFlexObject","removeFlexObject"];const r=a.includes(t.type);const c=n.getFileType()==="change"&&l.includes(n.getChangeType());const i=t.updatedObject?.getFileType?.()==="variant";return r&&(i||c)}});const u=new n({id:"compVariantData",parameterKey:"persistencyKey",parentDataSelector:d,executeFunction(e,t){const n=e.filter(e=>e.getFileType()==="variant"&&e.getPersistencyKey()===t.persistencyKey&&(e.getState()!==i.LifecycleState.DELETED||t.includeDeleted));return s.applyChangesOnVariants(t.reference,t.persistencyKey,n)},checkInvalidation(e,t){const n=t.updatedObject;const a=["addFlexObject","updateFlexObject","removeFlexObject"];const r=a.includes(t.type);const c=n.getFileType()==="change"&&l.includes(n.getChangeType());const i=t.updatedObject?.getFileType?.()==="variant";return r&&(i||c)}});const g=new n({id:"compEntitiesByPersistencyKey",parameterKey:"persistencyKey",parentDataSelector:d,executeFunction(e,t){return e.filter(e=>(e.getPersistencyKey?.()||e.getSelector?.().persistencyKey)===t.persistencyKey)},checkInvalidation(e,t){const n=t.updatedObject;return(n?.getPersistencyKey?.()||n.getSelector?.().persistencyKey)===e.persistencyKey}});const f=new n({id:"getChangesByVariantIds",parentDataSelector:g,executeFunction(e){const t={};const n=e.filter(e=>e.getFileType()==="variant").map(e=>e.getVariantId());e.filter(e=>e.getFileType()==="change"&&e.getChangeType()!=="defaultVariant").forEach(function(e){const a=S(e.getSelector().variantId||e.getContent().key);if(n.includes(a)){t[a]||=[];t[a].push(e)}else if(e.getChangeType()==="standardVariant"){t[r.STANDARD_VARIANT_ID]||=[];t[r.STANDARD_VARIANT_ID].push(e)}});return t}});function m(e){const t=e.variantInput||{};const n={fileName:t.fileName,fileType:"variant",variantId:t.id||r.STANDARD_VARIANT_ID,persisted:t.persisted,reference:e.reference,favorite:t.favorite,executeOnSelection:t.executeOnSelection,adaptationId:t.adaptationId,content:t.content||{},texts:{variantName:{value:t.name||""}},selector:{persistencyKey:e.persistencyKey}};return c.createCompVariant(n)}function S(e){return e?.replace("#","_HASHTAG_")}s.applyChangesOnVariants=function(e,t,n){const r=f.get({reference:e,persistencyKey:t});n.forEach(t=>{const n=r[t.getVariantId()]||[];if(n.length>0){a(t,n);d.checkUpdate({reference:e},[{type:"updateFlexObject",updatedObject:t}])}});return n};s.getCompEntitiesDataSelector=function(){return d};s.getSetDefaultDataSelector=function(){return y};s.getDefaultVariantId=e=>{const t=e.variants;const n=t.map(e=>e.getVariantId());n.push(r.STANDARD_VARIANT_ID);e.persistencyKey=String(e.persistencyKey);const a=[...y.get(e)].reverse();const c=a.map(e=>e.getContent().defaultVariantName).map(e=>S(e));return c.find(e=>n.includes(e))||""};s.assembleVariantList=function(e){let n=u.get(e).findLast(e=>e.getStandardVariant());if(!n){n=m({reference:e.reference,persistencyKey:e.persistencyKey,variantInput:e.standardVariant,standardVariant:true});t.addRuntimeSteadyObject(e.reference,e.componentId,n)}return u.get(e).filter(e=>e.getVisible())};s.getVariant=function(e){return u.get(e).find(t=>t.getVariantId()===e.id)};s.getVariantChanges=function(e){const t=e.getFlexObjectMetadata().reference;const n=e.getVariantId();const a=e.getPersistencyKey();return f.get({reference:t,persistencyKey:a})?.[n]||[]};s.addExternalVariants=function(n){try{n.variants?.map(e=>{e.reference=n.reference;e.fileName=S(e.id);e.selector={persistencyKey:n.persistencyKey};e.texts={variantName:{value:e.name}};return e}).map(e=>c.createFromFileContent(e,r,true)).forEach(e=>t.addRuntimeSteadyObject(n.reference,n.componentId,e))}catch(t){e.error(`External comp variant could not be added: ${t.message}`)}};s.getDefaultChanges=e=>{e.persistencyKey=String(e.persistencyKey);return y.get(e)};s.getCompEntities=e=>d.get(e);s.getCompEntitiesByPersistencyKey=e=>g.get(e);return s});
//# sourceMappingURL=CompVariantManagementState.js.map