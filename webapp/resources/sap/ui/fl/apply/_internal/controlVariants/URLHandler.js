/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/deepEqual","sap/base/util/isEmptyObject","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/base/ManagedObjectObserver","sap/ui/core/Component","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/thirdparty/hasher"],function(e,a,t,r,n,o,i,s,l,c){"use strict";var m={};var p={};function d(e,a){var t=[];return e.reduce(function(e,r){var n=a.getVariantManagementReference(r).variantManagementReference;if(n){if(t.includes(n)){e.updateRequired=true;return e}t.push(n)}if(n&&a.oData[n].currentVariant!==r){e.updateRequired=true;if(a.oData[n].currentVariant!==a.oData[n].defaultVariant){e.parameters.push(a.oData[n].currentVariant)}}else{e.parameters.push(r)}return e},{updateRequired:false,parameters:[]})}function u(e,a){const t=e.getUShellService("URLParsing")?.parseShellHash(a||c.getHash());var n=r.get(["params",s.VARIANT_TECHNICAL_PARAMETER],t);if(Array.isArray(n)&&n.length===1){n=n[0].split(",")}if(n){var o=d(n,e);if(o.updateRequired){p.update({updateURL:!e._bDesignTimeMode,parameters:o.parameters,updateHashEntry:true,model:e})}}}function f(e,a){try{const t=e.getUShellService("URLParsing");if(t){u(e,a)}}catch(e){n.error(e.message)}const t=e.getUShellService("ShellNavigationInternal");return t?.NavigationFilterStatus.Continue}function A(e){const a=e.getUShellService("ShellNavigationInternal");if(!m[e.sFlexReference]){m[e.sFlexReference]=f.bind(null,e);if(a){a.registerNavigationFilter(m[e.sFlexReference])}}}function R(e){const a=e.getUShellService("ShellNavigationInternal");if(a){a.unregisterNavigationFilter(m[e.sFlexReference]);delete m[e.sFlexReference]}}function h(a){const t=a.model;const r=t.getUShellService("URLParsing");const o=t.getUShellService("Navigation");const i=r?.parseShellHash(c.getHash());if(i?.params){const l={...i.params};const m=t.oAppComponent?.getComponentData?.()?.technicalParameters;if(!m){n.warning("Component instance not provided, so technical parameters in component data and browser history remain unchanged")}if(a.parameters.length===0){delete i.params[s.VARIANT_TECHNICAL_PARAMETER];if(m){delete m[s.VARIANT_TECHNICAL_PARAMETER]}}else{i.params[s.VARIANT_TECHNICAL_PARAMETER]=[a.parameters.toString()];if(m){m[s.VARIANT_TECHNICAL_PARAMETER]=[a.parameters.toString()]}}if(a.silent){c.changed.active=false;c.replaceHash(r.constructShellHash(i));c.changed.active=true}else if(!e(l,i.params)){o.navigate({target:{semanticObject:i.semanticObject,action:i.action,context:i.contextRaw},params:i.params,appSpecificRoute:i.appSpecificRoute,writeHistory:false})}}}function v(e){var r={index:-1};var n=e.model;var o=n.getUShellService("URLParsing");var i=o?.parseShellHash(c.getHash()).params;if(i){r.parameters=[];if(n._bDesignTimeMode){i[s.VARIANT_TECHNICAL_PARAMETER]=p.getStoredHashParams(e)}if(Array.isArray(i[s.VARIANT_TECHNICAL_PARAMETER])){if(i[s.VARIANT_TECHNICAL_PARAMETER].length>1){i[s.VARIANT_TECHNICAL_PARAMETER]=i[s.VARIANT_TECHNICAL_PARAMETER].map(decodeURIComponent)}else if(i[s.VARIANT_TECHNICAL_PARAMETER].length===1){const e=i[s.VARIANT_TECHNICAL_PARAMETER][0];const a=e&&decodeURIComponent(e);i[s.VARIANT_TECHNICAL_PARAMETER]=a?a.split(","):[]}i[s.VARIANT_TECHNICAL_PARAMETER].some(function(t,o){if(!a(n.getVariant(t,e.vmReference))){r.index=o;return true}return false})}}return t(r,i&&i[s.VARIANT_TECHNICAL_PARAMETER]&&{parameters:i[s.VARIANT_TECHNICAL_PARAMETER]})}function g(e){var a=e.getUShellService("URLParsing");var t=a?.parseShellHash(c.getHash());return t?.params&&t.params[s.VARIANT_TECHNICAL_PARAMETER]}p.variantTechnicalParameterName="sap-ui-fl-control-variant-id";p.initialize=function(e){var a=e.model;p.attachHandlers(e);a._oHashData={hashParams:[],controlPropertyObservers:[],variantControlIds:[]};u(a)};p.updateVariantInURL=function(e){var a=p.removeURLParameterForVariantManagement(e);if(!a.parameters){return}var t=a.parameters||[];var r=a.index;var n=e.newVReference===e.model.oData[e.vmReference].defaultVariant;if(!n){if(r===-1){t=t.concat([e.newVReference])}else{t=t.slice(0,r).concat([e.newVReference],t.slice(r))}}if(!n||r>-1){p.update({parameters:t,updateURL:!e.model._bDesignTimeMode,updateHashEntry:true,model:e.model})}};p.removeURLParameterForVariantManagement=function(e){var a=v(e);if(a.index>-1){a.parameters.splice(a.index,1)}return a};p.attachHandlers=function(e){async function a(){await l.waitForAllVariantSwitches(e.model.sFlexReference);e.model._oHashData.controlPropertyObservers.forEach(function(e){e.destroy()});R(e.model);e.model.destroy();e.model.oComponentDestroyObserver.unobserve(e.model.oAppComponent,{destroy:true});e.model.oComponentDestroyObserver.destroy()}A(e.model);if(!e.model.oComponentDestroyObserver&&e.model.oAppComponent instanceof i){e.model.oComponentDestroyObserver=new o(a.bind(null));e.model.oComponentDestroyObserver.observe(e.model.oAppComponent,{destroy:true})}};p.registerControl=function(e){if(e.updateURL){e.model._oHashData.variantControlIds.push(e.vmReference)}};p.update=function(e){if(!Array.isArray(e.parameters)){n.info("Variant URL parameters could not be updated since invalid parameters were received");return}if(e.updateURL){h(e)}if(e.updateHashEntry){e.model._oHashData.hashParams=e.parameters}};p.getStoredHashParams=function(e){return Array.prototype.slice.call(e.model._oHashData.hashParams)};p.handleModelContextChange=function(e){var a="modelContextChange";function t(a,t){var r=a.getSource().getVariantManagementReference();var n=t.model._oHashData.variantControlIds;var o=n.indexOf(r);if(o>-1){n.slice(o).forEach(function(a){if(v({vmReference:a,model:e.model}).index===-1){t.model.switchToDefaultForVariantManagement(a)}})}}var r=new o(function(r){if(r.current===true&&r.old===false){r.object.attachEvent(a,{model:e.model},t)}else if(r.current===false&&r.old===true){r.object.detachEvent(a,t)}});r.observe(e.vmControl,{properties:["resetOnContextChange"]});e.model._oHashData.controlPropertyObservers.push(r);if(e.vmControl.getResetOnContextChange()!==false){e.vmControl.attachEvent(a,{model:e.model},t)}};p.clearAllVariantURLParameters=function(e){if(g(e.model)){p.update({updateURL:true,parameters:[],updateHashEntry:false,model:e.model})}};return p});
//# sourceMappingURL=URLHandler.js.map