/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_difference","sap/base/util/restricted/_isEqual","sap/base/util/restricted/_omit","sap/base/util/isEmptyObject","sap/base/util/merge","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/BusyIndicator","sap/ui/core/Lib","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/controlVariants/Switcher","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexObjectState","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/initial/_internal/Settings","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/model/BindingMode","sap/m/library"],function(e,t,a,n,r,i,s,o,c,l,f,u,h,p,d,g,v,m,V,R,y,C,b,x){"use strict";var S={};const{SharingMode:D}=x;function M(e,t,a){const n=p.waitForVariantSwitch(t,a).catch(function(){}).then(e);p.setVariantSwitchPromise(t,a,n);return n}function F(e,t){S[e]=t}function U(e,t){return h.switchVariant(e).then(function(){if(this.oData[e.vmReference].updateVariantInURL){c.updateVariantInURL({vmReference:e.vmReference,newVReference:e.newVReference,model:this})}this.callVariantSwitchListeners(e.vmReference,e.newVReference,undefined,t)}.bind(this))}function I(e){var t=m.getInstanceOrUndef();if(t&&!t.getIsVariantPersonalizationEnabled()){e.remove=false;e.rename=false;e.change=false}}function E(e){var t=m.getInstanceOrUndef();var a=t&&(t.getIsKeyUser()||!t.getUserId()||t.getIsPublicFlVariantEnabled()&&t.getUserId().toUpperCase()===e.instance.getSupportInformation().user.toUpperCase());e.remove=a;e.rename=a;e.change=a}function O(e,t,a){var n=a?R.getCurrentLayer():V.USER;if(e.layer===n&&e.key!==t){return true}return false}function L(){var e=y.getUshellContainer();if(e){var t=[y.getUShellService("UserInfo"),y.getUShellService("URLParsing"),y.getUShellService("Navigation"),y.getUShellService("ShellNavigationInternal")];return Promise.all(t).then(function(e){F("UserInfo",e[0]);F("URLParsing",e[1]);F("Navigation",e[2]);F("ShellNavigationInternal",e[3])}).catch(function(e){throw new Error(`Error getting service from Unified Shell: ${e}`)})}return undefined}function _(e,t){return r({},e.find(function(e){return e.key===t}))}function P(e){const t=p.getInitialUIChanges({vmReference:e.vmReference,reference:e.reference});const a=t.reduce((t,a)=>{const n=a.getSelector();const r=i.bySelector(n,e.appComponent);if(r&&y.indexOfObject(t,{selector:r})===-1){t.push({selector:r})}return t},[]);return a.length?d.waitForFlexObjectsToBeApplied(a):Promise.resolve()}var T=C.extend("sap.ui.fl.variants.VariantModel",{constructor:function(e,t){this.pSequentialImportCompleted=Promise.resolve();C.apply(this,[e]);this.sharing={PRIVATE:D.Private,PUBLIC:D.Public};this.sFlexReference=v.getFlexReferenceForControl(t.appComponent);this.oAppComponent=t.appComponent;this._oResourceBundle=o.getResourceBundleFor("sap.ui.fl");this.fnUpdateListener=this.updateData.bind(this);this.oDataSelector=p.getVariantManagementMap();this.oDataSelector.addUpdateListener(this.fnUpdateListener);this.updateData();const a=d.getLiveDependencyMap(this.sFlexReference);p.getInitialUIChanges({reference:this.sFlexReference},this.oAppComponent.getId(),this.sFlexReference).forEach(e=>{u.addChangeAndUpdateDependencies(e,this.oAppComponent.getId(),a)});this.setDefaultBindingMode(b.OneWay)}});T.prototype.updateData=function(){const e=this.oDataSelector.get({reference:this.sFlexReference});const t={...this.getData()};Object.entries(e).forEach(function(e){const a=e[0];const n={...e[1]};t[a]||={};t[a].variants=n.variants.map(function(e){const n=(t[a].variants||[]).find(function(t){return t.key===e.key});return{...n||{},...e}});t[a].currentVariant=n.currentVariant;t[a].defaultVariant=n.defaultVariant;t[a].modified=n.modified});this.setData(t);this.refresh(true)};T.prototype.invalidateMap=function(){this.oDataSelector.checkUpdate({reference:this.sFlexReference})};T.prototype.initialize=function(){return Promise.all([m.getInstance(),L()]).then(function(){c.initialize({model:this})}.bind(this))};T.prototype.updateCurrentVariant=function(e){var t={vmReference:e.variantManagementReference,currentVReference:this.getCurrentVariantReference(e.variantManagementReference),newVReference:e.newVariantReference,appComponent:e.appComponent||this.oAppComponent,modifier:i,reference:this.sFlexReference};if(e.internallyCalled){return U.call(this,t,e.scenario)}return M(U.bind(this,t,e.scenario),this.sFlexReference,e.variantManagementReference)};T.prototype.getCurrentVariantReference=function(e){return this.oData[e].currentVariant};T.prototype.getVariantManagementReference=function(e){var t="";var a=-1;Object.keys(this.oData).some(function(n){return this.oData[n].variants.some(function(r,i){if(r.key===e){t=n;a=i;return true}return false})}.bind(this));return{variantManagementReference:t,variantIndex:a}};T.prototype.getVariant=function(e,t){var a=t||this.getVariantManagementReference(e).variantManagementReference;return _(this.oData[a].variants,e)};T.prototype.getVariantTitle=function(e,t){return _(this.oData[t].variants,e).title};T.prototype.callVariantSwitchListeners=function(e,t,a,n){const r=g.getVariantManagementControlByVMReference(e,this.oAppComponent);const i=_(this.oData[e].variants,t);if(n){i.createScenario=n}if(a){a(i)}else{r._executeAllVariantAppliedListeners(i)}};function k(e,t){var a={id:t.newVariantReference,variantName:t.title,contexts:t.contexts,layer:t.layer,adaptationId:t.adaptationId,reference:e.getFlexObjectMetadata().reference,generator:t.generator,variantManagementReference:t.variantManagementReference,executeOnSelection:t.executeOnSelection};if(t.layer===V.VENDOR){a.user="SAP"}if(t.currentVariantComparison===1){if(t.sourceVariantSource.instance.getLayer()===t.layer){a.variantReference=t.sourceVariantSource.instance.getVariantReference()}else{a.variantReference=e.getVariantReference()}}else if(t.currentVariantComparison===0){a.variantReference=e.getVariantReference()}else if(t.currentVariantComparison===-1){a.variantReference=t.sourceVariantReference}return f.createFlVariant(a)}T.prototype._duplicateVariant=function(e){var t=e.sourceVariantReference;var a=e.variantManagementReference;var n=this.getVariant(t);var i=p.getControlChangesForVariant({vmReference:a,vReference:t,reference:this.sFlexReference}).map(function(e){return e.convertToFileContent()});e.currentVariantComparison=R.compareAgainstCurrentLayer(n.instance.getLayer(),e.layer);if(e.currentVariantComparison===1){e.sourceVariantSource=this.getVariant(n.instance.getVariantReference())}var s={instance:k(n.instance,e),controlChanges:i,variantChanges:{}};i=s.controlChanges.slice();var o={};s.controlChanges=i.reduce(function(t,a){if(R.compareAgainstCurrentLayer(a.layer,e.layer)>=0){o=r({},a);o.layer=e.layer;o.variantReference=s.instance.getId();o.support||={};o.support.sourceChangeFileName=a.fileName;o.packageName="$TMP";o.fileName=y.createDefaultFileName(o.changeType);t.push(f.createFromFileContent(o))}return t},[]);return s};T.prototype._collectModelChanges=function(e,t,a){const n=this.getData()[e];const r=n.variants;const i=[];const s=m.getInstanceOrUndef();const o=[];const c=e=>r.find(t=>t.key===e);const l=(e,a,n)=>{const r=["setTitle","setExecuteOnSelect","setVisible"].includes(a);const o=r&&s?.getIsPublicFlVariantEnabled()&&e.layer===V.PUBLIC?V.PUBLIC:t;i.push({variantReference:e.key,changeType:a,layer:o,...n})};a.getParameter("renamed")?.forEach(({key:e,name:t})=>{const a=c(e);l(a,"setTitle",{title:t,originalTitle:a.title})});a.getParameter("fav")?.forEach(({key:e,visible:t})=>{const a=c(e);l(a,"setFavorite",{favorite:t,originalFavorite:a.favorite})});a.getParameter("exe")?.forEach(({key:e,exe:t})=>{const a=c(e);l(a,"setExecuteOnSelect",{executeOnSelect:t,originalExecuteOnSelect:a.executeOnSelect})});a.getParameter("deleted")?.forEach(e=>{const t=c(e);l(t,"setVisible",{visible:false});o.push(e)});a.getParameter("contexts")?.forEach(({key:e,contexts:t})=>{const a=c(e);l(a,"setContexts",{contexts:t,originalContexts:a.contexts})});const f=a.getParameter("def");if(f){i.push({variantManagementReference:e,changeType:"setDefault",defaultVariant:f,originalDefaultVariant:n.defaultVariant,layer:t})}return{changes:i,variantsToBeDeleted:o}};T.prototype.setVariantProperties=function(e,t){var a=this.getData();var n=this.getVariant(t.variantReference,e).instance;var r={};switch(t.changeType){case"setTitle":n.setName(t.title,true);break;case"setFavorite":r.favorite=t.favorite;n.setFavorite(t.favorite);break;case"setExecuteOnSelect":r.executeOnSelect=t.executeOnSelect;n.setExecuteOnSelection(t.executeOnSelect);break;case"setVisible":r.visible=t.visible;r.createdByReset=false;n.setVisible(t.visible);break;case"setContexts":r.contexts=t.contexts;n.setContexts(t.contexts);break;case"setDefault":r.defaultVariant=t.defaultVariant;var i=c.getStoredHashParams({model:this});if(i&&this.oData[e].updateVariantInURL){if(a[e].defaultVariant!==a[e].currentVariant&&i.indexOf(a[e].currentVariant)===-1){c.update({parameters:i.concat(a[e].currentVariant),updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this})}else if(a[e].defaultVariant===a[e].currentVariant&&i.indexOf(a[e].currentVariant)>-1){i.splice(i.indexOf(a[e].currentVariant),1);c.update({parameters:i,updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this})}}break;default:break}return r};T.prototype._ensureStandardVariantExists=function(e){var t=this.getData();var a=t[e]||{};if(!t[e]||n(a)){var r=f.createFlVariant({id:e,variantManagementReference:e,variantName:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),user:l.DEFAULT_AUTHOR,layer:V.BASE,reference:this.sFlexReference});p.addRuntimeSteadyObject(this.sFlexReference,this.oAppComponent.getId(),r);this._aCreatedStandardVariantsFor||=[];this._aCreatedStandardVariantsFor.push(e)}};T.prototype.setModelPropertiesForControl=function(e,t,a){this.oData[e].showFavorites=true;var n=this._bDesignTimeMode;if(n!==t){this._bDesignTimeMode=t;if(t){c.clearAllVariantURLParameters({model:this})}else if(n&&this.oData[e].updateVariantInURL){c.update({parameters:c.getStoredHashParams({model:this}),updateURL:true,updateHashEntry:false,model:this})}}if(!(typeof this.fnManageClick==="function"&&typeof this.fnManageClickRta==="function")){this._initializeManageVariantsEvents()}a.detachManage(this.fnManageClick,this);if(t&&this.oData[e]._isEditable){this.oData[e].variantsEditable=false;this.oData[e].variants.forEach(function(a){a.rename=true;a.change=true;a.sharing=this.sharing.PUBLIC;a.remove=O(a,e,t)}.bind(this))}else if(this.oData[e]._isEditable){a.attachManage({variantManagementReference:e},this.fnManageClick,this);this.oData[e].variantsEditable=true;this.oData[e].variants.forEach(function(a){a.remove=O(a,e,t);switch(a.layer){case V.USER:a.rename=true;a.change=true;a.sharing=this.sharing.PRIVATE;I(a);break;case V.PUBLIC:a.sharing=this.sharing.PUBLIC;E(a);break;default:a.rename=false;a.change=false;a.sharing=this.sharing.PUBLIC}}.bind(this))}else{this.oData[e].variantsEditable=false;this.oData[e].variants.forEach(function(e){e.remove=false;e.rename=false;e.change=false})}};T.prototype._initializeManageVariantsEvents=function(){this.fnManageClickRta=function(e,t){const a=this._collectModelChanges(t.variantManagementReference,t.layer,e);t.resolve(a)};this.fnManageClick=function(e,t){sap.ui.require(["sap/ui/fl/variants/VariantManager"],function(a){a.handleManageEvent(e,t,this)}.bind(this))}};T.prototype._handleSaveEvent=function(e){if(!this._bDesignTimeMode){var t=e.getSource();var a=e.getParameters();sap.ui.require(["sap/ui/fl/variants/VariantManager"],function(e){e.handleSaveEvent(t,a,this)}.bind(this))}};function A(e,t){sap.ui.require(["sap/ui/fl/variants/VariantManager"],function(a){a.handleSelectVariant(e,t)})}T.prototype.getLocalId=function(e,t){return i.getSelector(e,t).id};T.prototype.switchToDefaultForVariantManagement=function(e){if(this.oData[e].currentVariant!==this.oData[e].defaultVariant){s.show(200);this.updateCurrentVariant({variantManagementReference:e,newVariantReference:this.oData[e].defaultVariant}).then(function(){s.hide()})}};T.prototype.switchToDefaultForVariant=function(e){Object.keys(this.oData).forEach(function(t){if(!e||this.oData[t].currentVariant===e){this.switchToDefaultForVariantManagement(t)}}.bind(this))};function w(e,t){this.oData[t].variants.forEach(function(a){const n=a.title&&a.title.match(/{(\w+)>(\w.+)}/);if(n){const[,r,i]=n;const s=e.getModel(r);if(s){const e=s.getResourceBundle().getText(i);const t={reference:this.sFlexReference,changeType:"setTitle",layer:a.layer,fileType:"ctrl_variant_change",variantId:a.key};const n=f.createVariantChange(t);n.setText("title",e,"XFLD");a.instance.setName(e,true);p.addRuntimeSteadyObject(this.sFlexReference,this.oAppComponent.getId(),n)}else{e.attachEventOnce("modelContextChange",w.bind(this,e,t))}}}.bind(this))}T.prototype.registerToModel=function(e){const t=e.getVariantManagementReference();this._ensureStandardVariantExists(t);this.oData[t]._isEditable=e.getEditable();e.setShowExecuteOnSelection(false);w.call(this,e,t);e.attachEvent("select",{vmReference:t,model:this},A);e.attachSave(this._handleSaveEvent,this);this.setModelPropertiesForControl(t,false,e);const a=e.getUpdateVariantInURL();this.oData[t].updateVariantInURL=a;if(a){c.registerControl({vmReference:t,updateURL:true,model:this});c.handleModelContextChange({model:this,vmControl:e})}const n={appComponent:this.oAppComponent,reference:this.sFlexReference,vmReference:t};p.setVariantSwitchPromise(this.sFlexReference,t,P(n))};T.prototype.getCurrentControlVariantIds=function(){return Object.keys(this.oData||{}).reduce(function(e,t){return e.concat([this.oData[t].currentVariant])}.bind(this),[])};T.prototype.getVariantManagementControlIds=function(){var e;return Object.keys(this.oData||{}).reduce(function(t,a){if(this.oAppComponent.byId(a)){e=this.oAppComponent.createId(a)}else{e=a}t.push(e);return t}.bind(this),[])};T.prototype.destroy=function(){const e=this.oDataSelector.get({reference:this.sFlexReference});const t=Object.entries(e).map(([e,t])=>{const a=p.getVariant({vmReference:e,vReference:t.currentVariant,reference:this.sFlexReference});return a.controlChanges}).flat();const a=d.getLiveDependencyMap(this.sFlexReference);const n=[];t.forEach(e=>{if(!e.isPersisted()){n.push(e)}else{u.removeChangeFromMap(a,e.getId());u.removeChangeFromDependencies(a,e.getId())}});sap.ui.require(["sap/ui/fl/write/_internal/flexState/FlexObjectManager"],e=>{e.deleteFlexObjects({reference:this.sFlexReference,flexObjects:n})});this.oDataSelector.removeUpdateListener(this.fnUpdateListener);const r=[];(this._aCreatedStandardVariantsFor||[]).forEach(t=>{if(e[t]?.variants.length>1||e[t]?.variants[0].controlChanges.length){r.push(e[t].variants[0].instance)}});if(r.length){p.addRuntimeOnlyFlexObjects(this.sFlexReference,r)}p.clearRuntimeSteadyObjects(this.sFlexReference,this.oAppComponent.getId());p.resetCurrentVariantReference(this.sFlexReference);C.prototype.destroy.apply(this)};T.prototype.getUShellService=function(e){return y.getUshellContainer()&&S[e]};return T});
//# sourceMappingURL=VariantModel.js.map