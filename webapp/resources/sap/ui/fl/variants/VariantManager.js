/*
 * ! OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_difference","sap/base/util/merge","sap/base/util/ObjectPath","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexObjectState","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/fl/apply/api/FlexRuntimeInfoAPI","sap/ui/fl/write/_internal/controlVariants/ControlVariantWriteUtils","sap/ui/fl/write/_internal/flexState/changes/UIChangeManager","sap/ui/fl/write/_internal/flexState/FlexObjectManager","sap/ui/fl/write/api/ContextBasedAdaptationsAPI","sap/ui/fl/Layer","sap/ui/fl/Utils"],function(e,n,a,t,r,i,c,o,l,s,f,p,g,u,d,v,m,C,R){"use strict";var h={};function V(e){const n=R.getAppComponentForControl(e);return n.getModel(p.getVariantModelName())}function y(e,n){const a=e.map(e=>e.getId());return f.getDirtyFlexObjects(n).filter(function(e){return a.includes(e.getId())&&!e.getSavedToVariant()})}async function x(e){var n=y(e.changes,e.reference);n=n.reverse();if(e.revert){await c.revertMultipleChanges(n,{appComponent:e.appComponent,modifier:t,reference:e.reference})}v.deleteFlexObjects({reference:e.reference,flexObjects:n})}function F(e,n,a){const t=s.waitForVariantSwitch(n,a).catch(function(){}).then(e);s.setVariantSwitchPromise(n,a,t);return t}async function w(e,n,a,t){if(!t._bDesignTimeMode){const r=await v.saveFlexObjects({flexObjects:e,selector:a});if(r){const e=r.response.find(e=>e.fileType==="ctrl_variant");const a=t.oData[n].variants.find(n=>n.key===e.fileName);const i=a.instance.getSupportInformation();i.user=e.support.user;a.instance.setSupportInformation(i)}t.invalidateMap()}}function b(e,n,a){var t={layer:e,control:n,reference:a};var r=m.hasAdaptationsModel(t);return r&&m.getDisplayedAdaptationId(t)}h.handleSelectVariant=function(e,n){return F(async function(e,n){var t=n.model;var r=n.vmReference;var i=false;var c=a.get([r,"modified"],t.oData);var o=e.key;var l=e.key;if(a.get([r,"currentVariant"],t.oData)&&t.oData[r].currentVariant!==o){l=t.oData[r].currentVariant;i=true;await t.updateCurrentVariant({variantManagementReference:r,newVariantReference:o,appComponent:t.oAppComponent,internallyCalled:true})}if(c){var f=s.getControlChangesForVariant({reference:t.sFlexReference,vmReference:r,vReference:l});await x({changes:f,reference:t.sFlexReference,vmReference:r,vReference:l,appComponent:t.oAppComponent,revert:!i})}if(!i){t.callVariantSwitchListeners(r,t.oData[r].currentVariant)}}.bind(null,e.getParameters(),n),n.model,n.vmReference)};h.handleManageEvent=async function(n,a,t){const r=a.variantManagementReference;if(!t.getData()){return}const{changes:i,variantsToBeDeleted:c}=t._collectModelChanges(r,C.USER,n);if(!i.length&&!c.length){return}if(i.some(e=>e.visible===false&&e.variantReference===t.getCurrentVariantReference(r))){const e=n.getParameter("def")||s.getDefaultVariantReference({reference:t.sFlexReference,vmReference:r});await t.updateCurrentVariant({variantManagementReference:r,newVariantReference:e})}i.forEach(function(e){e.appComponent=t.oAppComponent});const o=h.addVariantChanges(r,i);const f=c.map(e=>{const n=s.getVariant({reference:t.sFlexReference,vmReference:r,vReference:e});if(n.layer===C.USER){return u.deleteVariant(t.sFlexReference,r,e)}return[]}).flat();const p=[...e(o,f),...f.filter(e=>e.getState()!==l.LifecycleState.NEW)];const g=Object.values(C).reverse();for(const e of g){const n=p.filter(n=>n.getLayer()===e);if(n.length>0){await v.saveFlexObjects({flexObjects:n,selector:t.oAppComponent})}}};h.handleSaveEvent=async function(e,a,r){var i=R.getAppComponentForControl(e);r||=V(e);var c=r.getLocalId(e.getId(),i);var l;await F(async function(e,a,i){var c=r.getCurrentVariantReference(e);var f=s.getControlChangesForVariant({reference:r.sFlexReference,vmReference:e,vReference:c});if(i.overwrite){l=y(f,r.sFlexReference);if(r.getVariant(c,e).layer===C.PUBLIC){l.forEach(e=>e.setLayer(C.PUBLIC))}const n=await v.saveFlexObjects({flexObjects:l,selector:a});r.invalidateMap();return n}var p=i.layer||(i.public?C.PUBLIC:C.USER);var g=i.layer||C.USER;var u=i.newVariantReference||R.createDefaultFileName("flVariant");var d={variantManagementReference:e,appComponent:a,layer:p,title:i.name,contexts:i.contexts,sourceVariantReference:c,newVariantReference:u,generator:i.generator,additionalVariantChanges:[],adaptationId:b(g,a,r.sFlexReference),executeOnSelection:i.execute};var m={content:{},reference:r.sFlexReference,generator:d.generator,layer:g,adaptationId:d.adaptationId};if(i.def){var V=n({changeType:"setDefault",content:{defaultVariant:u},fileType:"ctrl_variant_management_change",selector:t.getSelector(e,d.appComponent)},m);d.additionalVariantChanges.push(o.createVariantManagementChange(V))}const F=await h.copyVariant(d);l=F;await x({changes:f,reference:r.sFlexReference,vmReference:e,vReference:c,appComponent:a});return w(l,e,a,r)}.bind(r,c,i,a),r,c);return l};h.addAndApplyChangesOnVariant=function(e,n){const a=V(n);const c=d.addDirtyChanges(a.sFlexReference,e,a.oAppComponent);return c.reduce(async function(e,n){await e;const c=r.getElementById(t.getControlIdBySelector(n.getSelector(),a.oAppComponent));const o=await i.applyChangeOnControl(n,c,{modifier:t,appComponent:a.oAppComponent,view:R.getViewForControl(c)});if(!o.success){var l=o.error||new Error("The change could not be applied.");v.deleteFlexObjects({reference:a.sFlexReference,flexObjects:[n]});throw l}},Promise.resolve())};h.eraseDirtyChangesOnVariant=async function(e,n,a){const t=g.getFlexReference({element:a});var r=s.getControlChangesForVariant({reference:t,vmReference:e,vReference:n});var i=y(r,t);await x({changes:r,reference:t,vmReference:e,vReference:n,appComponent:R.getAppComponentForControl(a),revert:true});return i};h.copyVariant=async function(e){const n=V(e.appComponent);var a=n._duplicateVariant(e);a.generator=e.generator;n.oData[e.variantManagementReference].variants.push({key:a.instance.getId(),rename:true,change:true,remove:true,sharing:e.layer===C.USER?n.sharing.PRIVATE:n.sharing.PUBLIC});var t=[];if(e.layer===C.PUBLIC){a.instance.setFavorite(false);var r={variantId:e.newVariantReference,changeType:"setFavorite",fileType:"ctrl_variant_change",generator:e.generator,layer:C.USER,reference:n.sFlexReference,content:{favorite:true}};t.push(o.createVariantChange(r))}t=v.addDirtyFlexObjects(n.sFlexReference,t.concat([a.instance].concat(a.controlChanges).concat(e.additionalVariantChanges)));await n.updateCurrentVariant({variantManagementReference:e.variantManagementReference,newVariantReference:a.instance.getId(),appComponent:e.appComponent,internallyCalled:true,scenario:"saveAs"});return t};h.removeVariant=async function(e){const n=V(e.appComponent);var a=f.getDirtyFlexObjects(n.sFlexReference).filter(function(n){return n.getVariantReference&&n.getVariantReference()===e.variant.getId()||n.getId()===e.variant.getId()});await n.updateCurrentVariant({variantManagementReference:e.variantManagementReference,newVariantReference:e.sourceVariantReference,appComponent:e.component});v.deleteFlexObjects({reference:n.sFlexReference,flexObjects:a})};h.addVariantChange=function(e,n){const a=V(n.appComponent);var t=h.createVariantChange(e,n);v.addDirtyFlexObjects(a.sFlexReference,[t]);return t};h.addVariantChanges=function(e,n){const a=V(n[0].appComponent);var t=n.map(function(n){return h.createVariantChange(e,n)});v.addDirtyFlexObjects(a.sFlexReference,t);return t};h.deleteVariantChange=function(e,n,a){const t=V(n.appComponent);t.setVariantProperties(e,n);v.deleteFlexObjects({reference:t.sFlexReference,flexObjects:[a]})};h.createVariantChange=function(e,n){const a=V(n.appComponent);var r=a.setVariantProperties(e,n);var i={changeType:n.changeType,layer:n.layer,generator:n.generator,reference:a.sFlexReference};if(n.adaptationId!==undefined){i.adaptationId=n.adaptationId}else{i.adaptationId=b(n.layer,n.appComponent,a.sFlexReference)}let c;if(n.changeType==="setDefault"){i.fileType="ctrl_variant_management_change";i.selector=t.getSelector(e,n.appComponent);c=o.createVariantManagementChange(i)}else{i.fileType="ctrl_variant_change";i.variantId=n.variantReference;c=o.createVariantChange(i)}c.setContent(r);if(n.changeType==="setTitle"){c.setText("title",n.title,"XFLD")}return c};h.manageVariants=function(e,n,a,t,r){const i=V(e);return new Promise(function(c){e.attachEventOnce("manage",{resolve:c,variantManagementReference:n,layer:a},i.fnManageClickRta,i);e.openManagementDialog(true,t,r)})};h.getDirtyChangesFromVariantChanges=function(e,n){return y(e,n)};h.updateVariantManagementMap=function(e){s.getVariantManagementMap().checkUpdate({reference:e})};h.getControlChangesForVariant=function(e,n,a){return s.getVariant({reference:e,vmReference:n,vReference:a}).controlChanges};return h});
//# sourceMappingURL=VariantManager.js.map