/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_pick","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/flexObjects/CompVariant","sap/ui/fl/apply/_internal/flexObjects/CompVariantRevertData","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/RevertData","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexObjects/UpdatableChange","sap/ui/fl/apply/_internal/flexState/compVariants/applyChangesOnVariant","sap/ui/fl/apply/_internal/flexState/compVariants/CompVariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/initial/_internal/Settings","sap/ui/fl/initial/api/Version","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/_internal/Versions"],function(e,t,n,a,r,i,o,s,c,p,l,f,u,d,g,y,v){"use strict";function S(e,t){const n=C("/draftFilenames",t);if(n){return e.getState()===c.LifecycleState.NEW||n.includes(e.getId())}return true}function C(e,t){const n={reference:t.reference,layer:t.layer};if(v.hasVersionsModel(n)){return v.getVersionsModel(n).getProperty(e)}return undefined}function m(e,t){const n=e.getFlexObjectMetadata?e.getFlexObjectMetadata().changeType:e.getChangeType();if(!["defaultVariant","updateVariant"].includes(n)){return false}const a=e.getLayer()===t.layer;const r=e.getFlexObjectMetadata().packageName;const i=!r||r==="$TMP";return a&&i&&S(e,t)}function x(e,t){if(t.isVariant&&t.isVariant()){return e.variants}const n=t.getChangeType();switch(n){case"defaultVariant":return e.defaultVariants;case"standardVariant":return e.standardVariants;default:return e.changes}}function V(e,t){for(let n=0;n<e.length;n++){if(e[n].fileName===t.fileName){e.splice(n,1,t);break}}}async function h(e,t,n,a){const r=await y.update({flexObject:e.convertToFileContent(),layer:e.getLayer(),transport:e.getRequest(),parentVersion:n});if(r?.response){e.setResponse(r.response);if(n){v.onAllChangesSaved({reference:r.response.reference,layer:r.response.layer,draftFilenames:r.response.fileName})}}else{e.setState(c.LifecycleState.PERSISTED)}const i=x(t.changes.comp,e);const o=e.convertToFileContent();u.getFlexObjectsDataSelector().checkUpdate({reference:a});V(i,o);return o}async function D(e,t,n,a){var r=e.convertToFileContent();await y.remove({flexObject:r,layer:e.getLayer(),transport:e.getRequest(),parentVersion:n});await v.updateModelFromBackend({reference:r.reference,layer:r.layer});u.update(a,[{type:"delete",flexObject:r}]);u.getFlexObjectsDataSelector().checkUpdate({reference:a});return r}function O(e){var t={};if(typeof e.texts==="object"){Object.keys(e.texts).forEach(function(n){t[n]={value:e.texts[n],type:"XFLD"}})}return t}function T(e){return e&&[c.LifecycleState.NEW,c.LifecycleState.UPDATED,c.LifecycleState.DELETED].includes(e.getState())}function U(e){if(e.layer){return e.layer}if(e.isUserDependent){return n.USER}var t=new URLSearchParams(window.location.search).get("sap-ui-layer")||"";t=t.toUpperCase();if(t){return t}if(!e.fileType==="variant"){return n.CUSTOMER}var a=d.getInstanceOrUndef()?.getIsPublicLayerAvailable?.();return a?n.PUBLIC:n.CUSTOMER}function b(e){if(e instanceof r){e.removeAllRevertData()}}function E(e,t){e.storeExecuteOnSelection(t.executeOnSelection);e.storeFavorite(t.favorite);e.storeContexts(t.contexts);e.storeName(t.name);e.storeContent(t.content||e.getContent());return e}function F(e,t){e.setExecuteOnSelection(t.executeOnSelection);e.setFavorite(t.favorite);e.setContexts(t.contexts);e.setName(t.name);e.setContent(t.content||e.getContent());return e}function I(e){if(e&&e.getRevertData().length){let t;e.getRevertData().reverse().some(e=>{t=e.getContent();return t.previousAction===L.updateActionType.SAVE});E(e,{name:t.previousName,content:t.previousContent,favorite:t.previousFavorite,executeOnSelection:t.previousExecuteOnSelection,contexts:t.previousContexts});e.setState(t.previousState)}}function R(e){if(e.layer===n.VENDOR){e.support={user:"SAP"}}else if(d.getInstanceOrUndef()?.getUserId()){e.support={user:d.getInstanceOrUndef().getUserId()}}}var L={};L.checkSVMControlsForDirty=function(e){return u.getSVMControls(e).some(e=>{if(e?.oModel){return e?.getModified?.()}return false})};L.setDefault=function(e){const t={defaultVariantName:e.defaultVariantId};e.layer||=new URLSearchParams(window.location.search).get("sap-ui-layer")||n.USER;let r=f.getDefaultChanges(e).slice(-1)[0];if(!r||!m(r,e)){const n="defaultVariant";const i={fileName:a.createDefaultFileName(n),fileType:"change",changeType:n,layer:e.layer,content:t,namespace:a.createNamespace(e,"changes"),reference:e.reference,selector:{persistencyKey:e.persistencyKey},support:e.support||{}};i.adaptationId=e.changeSpecificData?.adaptationId;i.support.generator||=`CompVariantState.${n}`;r=o.createFromFileContent(i,p);r.addRevertInfo(new s({type:L.operationType.NewChange}));u.addDirtyFlexObjects(e.reference,[r])}else{r.addRevertInfo(new s({type:L.operationType.ContentUpdate,content:{previousState:r.getState(),previousContent:r.getContent()}}));r.setContent(t);f.getSetDefaultDataSelector().checkUpdate({reference:e.reference})}return r};L.revertSetDefaultVariantId=function(e){const t=f.getDefaultChanges(e);const n=t?.slice(-1)[0];const a=n.popLatestRevertInfo();if(a.getType()===L.operationType.ContentUpdate){n.setContent(a.getContent().previousContent);n.setState(a.getContent().previousState)}else{n.setState(c.LifecycleState.DELETED);t.pop()}};L.addVariant=function(t){if(!t){return undefined}const a=t.changeSpecificData;a.layer=U(a);a.changeType=a.type;a.texts=O(a);R(a);const r={...a,...e(t,"changeSpecificData")};const i=o.createCompVariant(r);u.addDirtyFlexObjects(t.reference,[i]);if(a.layer!==n.USER&&a.layer!==n.PUBLIC){t.id=t.control.getCurrentVariantId();I(f.getVariant(t))}return i};L.updateVariant=function(e){function a(t,n){const a=t.getLayer()===n;const r=t.getFlexObjectMetadata().packageName;const i=!r||r==="$TMP";const o=f.getVariantChanges(t).some(e=>e.getLayer()===n);return t.getPersisted()&&a&&i&&!o&&S(t,e)}function r(t){return f.getVariantChanges(t).reverse().find(t=>t.getChangeType()==="updateVariant"&&m(t,e))}function s(e,t,n,a){const r={type:n,change:a,content:{previousState:t.getState(),previousContent:t.getContent(),previousFavorite:t.getFavorite(),previousVisible:t.getVisible(),previousExecuteOnSelection:t.getExecuteOnSelection(),previousContexts:t.getContexts(),previousName:t.getName(),previousAction:e.action}};t.addRevertData(new i(r))}function c(e,t){s(e,t,L.operationType.ContentUpdate);if(e.executeOnSelection!==undefined){t.storeExecuteOnSelection(e.executeOnSelection)}if(e.layer===n.PUBLIC){t.storeFavorite(false)}else if(e.favorite!==undefined){t.storeFavorite(e.favorite)}if(e.visible!==undefined){t.storeVisible(e.visible)}if(e.contexts){t.storeContexts(e.contexts)}if(e.name){t.storeName(e.name)}if(e.transportId){t.setRequest(e.transportId)}t.storeContent(e.content||t.getContent())}function p(e,n,a){const r=a.getRevertData()||[];const i={...a.getContent()};const o={previousContent:{...i},previousState:a.getState(),change:t(e,["favorite","visible","executeOnSelection","contexts","content","name"])};r.push(o);a.setRevertData(r);if(e.executeOnSelection!==undefined){i.executeOnSelection=e.executeOnSelection}if(e.favorite!==undefined){i.favorite=e.favorite}if(e.visible!==undefined){i.visible=e.visible}if(e.contexts){i.contexts=e.contexts}if(e.content){i.variantContent=e.content}if(e.adaptationId){a.setAdaptationId(e.adaptationId)}if(e.name){a.setText("variantName",e.name)}a.setContent(i);if(e.transportId){a.setRequest(e.transportId)}s(e,n,L.operationType.UpdateVariantViaChangeUpdate,a);l(n,[a]);f.getCompEntitiesDataSelector().checkUpdate({reference:e.reference})}function d(e,t){const n={};["favorite","visible","executeOnSelection","contexts"].forEach(t=>{if(e[t]!==undefined){n[t]=e[t]}});if(e.content!==undefined){n.variantContent=e.content}const a=o.createUIChange({changeType:"updateVariant",layer:e.layer,fileType:"change",reference:e.reference,packageName:e.packageName,content:n,selector:{persistencyKey:e.persistencyKey,variantId:t.getVariantId()}});const r=e.adaptationId||e?.changeSpecificData?.adaptationId;if(r){a.setAdaptationId(r)}if(e.name){a.setText("variantName",e.name,"XFLD",true)}if(e.transportId){a.setRequest(e.transportId)}u.addDirtyFlexObjects(e.reference,[a]);s(e,t,L.operationType.NewChange,a);l(t,[a]);f.getCompEntitiesDataSelector().checkUpdate({reference:e.reference})}const g=f.getVariant(e);const y=U(e);e.layer||=y;if(e.forceCreate){d(e,g)}else if(a(g,y)){c(e,g)}else{const t=r(g);if(t){p(e,g,t)}else{d(e,g)}}f.getCompEntitiesDataSelector().checkUpdate({reference:e.reference});return g};L.discardVariantContent=function(e){const t=f.getVariant(e);const n=t.getRevertData();if(n.length!==0){const t=n.slice().reverse().some(function(t){e.layer=t.getChange()?.getLayer();if(t.getContent().previousAction===L.updateActionType.SAVE){e.content=t.getContent().previousContent;e.action=L.updateActionType.DISCARD;return true}});if(!t){e.content=n[0].getContent().previousContent;e.action=L.updateActionType.DISCARD}L.updateVariant(e)}return t};L.updateActionType={UPDATE:"update",SAVE:"save",DISCARD:"discard",UPDATE_METADATA:"update_metadata"};L.operationType={StateUpdate:"StateUpdate",ContentUpdate:"ContentUpdate",NewChange:"NewChange",UpdateVariantViaChange:"UpdateVariantViaChange",UpdateVariantViaChangeUpdate:"UpdateVariantViaChangeUpdate"};L.removeVariant=function(e){const t=f.getVariant(e);const n=t.getState();if(!e.revert){const e=new i({type:L.operationType.StateUpdate,content:{previousState:n}});t.addRevertData(e)}t.markForDeletion();u.getFlexObjectsDataSelector().checkUpdate({reference:e.reference});return t};L.revert=function(e){const n=f.getVariant(Object.assign({includeDeleted:true},e));const a=n.getRevertData().pop();n.removeRevertData(a);const r=a.getContent();let i;let o;switch(a.getType()){case L.operationType.ContentUpdate:E(n,{name:r.previousName,content:r.previousContent,favorite:r.previousFavorite,executeOnSelection:r.previousExecuteOnSelection,contexts:r.previousContexts,...t(e,["reference","persistencyKey","id"])});break;case L.operationType.NewChange:i=a.getChange();u.removeDirtyFlexObjects(i.getFlexObjectMetadata().reference,[i]);F(n,{name:r.previousName,content:r.previousContent,favorite:r.previousFavorite,executeOnSelection:r.previousExecuteOnSelection,contexts:r.previousContexts,...t(e,["reference","persistencyKey","id"])});break;case L.operationType.UpdateVariantViaChangeUpdate:i=a.getChange();F(n,{...{name:r.previousName,content:r.previousContent,favorite:r.previousFavorite,executeOnSelection:r.previousExecuteOnSelection,contexts:r.previousContexts},...t(e,["reference","persistencyKey","id"])});o=i.getRevertData().pop();i.setContent(o.previousContent);i.setState(o.previousState);break;case L.operationType.StateUpdate:default:break}n.setState(r.previousState);f.getCompEntitiesDataSelector().checkUpdate({reference:e.reference});return n};L.overrideStandardVariant=function(e){const t=f.assembleVariantList(e);const n=t.find(e=>e.getStandardVariant());n.setExecuteOnSelection(!!e.executeOnSelection);f.applyChangesOnVariants(e.reference,e.persistencyKey,[n])};L.persist=async function(e){async function t(t,a,r){if(t.getLayer()===n.PUBLIC){t.setFavorite(false)}const i=await y.write({flexObjects:[t.convertToFileContent()],layer:t.getLayer(),transport:t.getRequest(),isLegacyVariant:t.isVariant&&t.isVariant(),parentVersion:r});if(i?.response?.[0]){t.setResponse(i.response[0]);if(r){v.onAllChangesSaved({reference:i.response[0].reference,layer:i.response[0].layer,draftFilenames:[i.response[0].fileName]})}}else{t.setState(c.LifecycleState.PERSISTED)}const o=t.convertToFileContent();x(a.changes.comp,t).push(o);u.getFlexObjectsDataSelector().checkUpdate({reference:e.reference});return o}function a(n,a,r){switch(n.getState()){case c.LifecycleState.NEW:b(n);return t(n,a,r);case c.LifecycleState.UPDATED:b(n);return h(n,a,r,e.reference);case c.LifecycleState.DELETED:if(n._sPreviousState!==c.LifecycleState.NEW){b(n);return D(n,a,r,e.reference)}return Promise.resolve();default:return undefined}}const r=f.getCompEntitiesByPersistencyKey(e);const i=await u.getStorageResponse(e.reference);const o=r.filter(T);const s=o.map(async(e,t)=>{if(t===0){const t=C("/persistedVersion",{layer:e.getLayer(),reference:e.getFlexObjectMetadata().reference});await a(e,i,t);const n=o.map((e,n)=>{if(n!==0){const n=t?g.Number.Draft:undefined;return a(e,i,n)}return undefined});return Promise.all(n)}return undefined});return Promise.all(s)};L.filterHiddenFlexObjects=function(e,t){const n=f.getCompEntities({reference:t}).filter(e=>e.getFileType()==="variant").map(e=>e.getId());return e.filter(e=>{if(e.getFileType()==="change"){if(e.getChangeType()==="updateVariant"){return n.includes(e.getSelector().variantId)}if(e.getChangeType()==="defaultVariant"){return!e.getContent().defaultVariantName||n.includes(e.getContent().defaultVariantName)}}return true})};return L});
//# sourceMappingURL=CompVariantManager.js.map