/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/changes/UIChangesState","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexObjectState","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/initial/_internal/Settings","sap/ui/fl/initial/api/Version","sap/ui/fl/write/_internal/condenser/Condenser","sap/ui/fl/apply/_internal/flexState/compVariants/CompVariantManagementState","sap/ui/fl/write/_internal/flexState/compVariants/CompVariantManager","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/_internal/Versions","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(e,t,n,r,a,c,i,s,l,o,f,p,g,y,u,d,x,F,S,h,O){"use strict";const b={};function C(e,t){if(t.isValidForDependencyMap()){c.removeChangeFromMap(l.getLiveDependencyMap(e),t.getId());c.removeChangeFromDependencies(l.getLiveDependencyMap(e),t.getId())}}function j(e){return typeof e.isA==="function"&&e.isA("sap.ui.fl.apply._internal.flexObjects.FlexObject")?e:r.createFromFileContent(e)}async function m(e,r,a){const c=Object.values(S).filter(e=>e!==r);const i=b.removeDirtyFlexObjects({reference:a,layers:c,component:e});if(i.length){await n.revertMultipleChanges([...i].reverse(),{appComponent:e,modifier:t,reference:a})}}function L(e,t){return e.map(e=>e[t]()).filter((e,t,n)=>n.indexOf(e)===t).length===1}function D(e,t,n){if(!e||!L(t,"getLayer")){return false}const r=new URLSearchParams(window.location.search);if(r.has("sap-ui-xx-condense-changes")){return r.get("sap-ui-xx-condense-changes")==="true"}return n||[S.CUSTOMER,S.PUBLIC,S.USER].includes(t[0].getLayer())}function E(e,t,n,r,a){const c=t.map(e=>V(e,n)).filter(Boolean);e.filter(e=>!t.some(t=>e.getId()===t.getId())).forEach(e=>{if(r){o.removeDirtyFlexObjects(a,[e]);C(a,e);c.push({type:"delete",flexObject:e.convertToFileContent()})}else{b.deleteFlexObjects({reference:a,flexObjects:[e]})}});if(c.length){o.getFlexObjectsDataSelector().checkUpdate({reference:a});o.update(a,c)}}function v(e,t,n,r,c){if(!e.length&&!n){return[]}const i=o.getFlexObjectsDataSelector().get({reference:c}).filter(e=>{if(r===S.CUSTOMER&&t){return e.getState()===a.LifecycleState.PERSISTED&&t.includes(e.getId())}return e.getState()===a.LifecycleState.PERSISTED&&h.compareAgainstCurrentLayer(e.getLayer(),r)===0});return i.concat(e)}async function T(e,t,n,r){let c;if(n){[c]=e.filter(e=>e.getState()===a.LifecycleState.NEW)}const i={response:[]};const s=[];for(const r of e){const e={layer:r.getLayer(),transport:r.getRequest(),parentVersion:n};let l;if(r.getState()===a.LifecycleState.NEW){if(e.parentVersion!==undefined){e.parentVersion=r===c?e.parentVersion:g.Number.Draft}e.flexObjects=[r.convertToFileContent()];l=await x.write(e)}else if(r.getState()===a.LifecycleState.DELETED){e.flexObject=r.convertToFileContent();l=await x.remove(e)}const o=V(r,t);if(o){s.push(o)}if(l?.response){i.response.push(...l.response)}}if(s.length){o.update(r,s)}o.getFlexObjectsDataSelector().checkUpdate({reference:r});return i}function V(e,t){if(!t){let t;switch(e.getState()){case a.LifecycleState.NEW:t={type:"add",flexObject:e.convertToFileContent()};break;case a.LifecycleState.DELETED:t={type:"delete",flexObject:e.convertToFileContent()};break;case a.LifecycleState.UPDATED:t={type:"update",flexObject:e.convertToFileContent()};break;default:}e.setState(a.LifecycleState.PERSISTED);return t}return undefined}async function I(e){const t=v(e.dirtyFlexObjects,e.draftFilenames,e.condenseAnyLayer,e.layer,e.reference);const n=p.getInstanceOrUndef()?.getIsCondensingEnabled()&&D(e.appComponent,t,e.condenseAnyLayer);const r=n?t:e.dirtyFlexObjects;const c=r.slice(0);if(L(e.dirtyFlexObjects,"getRequest")&&(p.getInstanceOrUndef()?.getHasPersoConnector()?L(e.dirtyFlexObjects,"getLayer"):true)){const t=D(e.appComponent,c,e.condenseAnyLayer)?await y.condense(e.appComponent,c):c;let i;const s=c[0].getRequest();if(n){i=await x.condense({allChanges:r,condensedChanges:t,layer:e.layer,transport:s,isLegacyVariant:false,parentVersion:e.parentVersion})}else{const n=r.filter(e=>e.getState()===a.LifecycleState.DELETED);const c=t.filter(e=>e.getState()!==a.LifecycleState.DELETED);if(n.length){await T(n,e.skipUpdateCache,e.parentVersion,e.reference)}if(c.length){i=await x.write({layer:e.layer,flexObjects:c.map(e=>e.convertToFileContent()),transport:s,isLegacyVariant:false,parentVersion:e.parentVersion})}}E(r,t,e.skipUpdateCache,n,e.reference);return i||{response:[]}}return T(e.dirtyFlexObjects,e.skipUpdateCache,e.parentVersion,e.reference)}b.filterHiddenFlexObjects=function(e,t){const n=s.filterHiddenFlexObjects(e,t);return d.filterHiddenFlexObjects(n,t)};b.getFlexObjects=async function(e){e.reference=f.getFlexReferenceForControl(e.selector);if(e.invalidateCache){const t=O.getAppComponentForSelector(e.selector);e.componentId=t.getId();await o.reinitialize(e)}let t=i.getVariantIndependentUIChanges(e.reference).concat(u.getCompEntities(e));if(!e.includeCtrlVariants){t=t.concat(s.getInitialUIChanges({reference:e.reference,includeDirtyChanges:true}))}else if(!e.onlyCurrentVariants){t=t.concat(s.getVariantDependentFlexObjects(e.reference))}else{t=t.concat(s.getAllCurrentFlexObjects({reference:e.reference}))}if(e.includeManifestChanges){t=t.concat(o.getAppDescriptorChanges(e.reference))}if(e.includeAnnotationChanges){t=t.concat(o.getAnnotationChanges(e.reference))}if(e.currentLayer){t=t.filter(t=>t.getLayer()===e.currentLayer)}return t};b.hasDirtyFlexObjects=function(e){const t=f.getFlexReferenceForSelector(e.selector);return l.getDirtyFlexObjects(t).length>0};b.addDirtyFlexObjects=function(e,t){return o.addDirtyFlexObjects(e,t.map(j))};b.removeDirtyFlexObjects=function(e){const n=[].concat(e.layers||[]);const r=l.getDirtyFlexObjects(e.reference);const a=r.filter(r=>{let a=true;if(n.length&&!n.includes(r.getLayer())){return false}if(e.generator&&r.getSupportInformation().generator!==e.generator){return false}if(e.control){const n=t.getControlIdBySelector(r.getSelector(),e.component);a=e.control.getId()===n}if(e.changeTypes){a&&=e.changeTypes.includes(r.getChangeType())}return a});return o.removeDirtyFlexObjects(e.reference,a)};b.saveFlexObjects=async function(e){const t=O.getAppComponentForSelector(e.selector);const n=f.getFlexReferenceForControl(e.selector);const r=e.layer===S.CUSTOMER;const a=r&&F.getVersionsModel({reference:n,layer:e.layer});const c=a&&a.getProperty("/versioningEnabled");if(e.removeOtherLayerChanges&&e.layer){await m(t,e.layer,n)}const i=e.flexObjects||l.getDirtyFlexObjects(n);if(!i.length){return{response:[]}}const s=await I({reference:n,layer:e.layer||i[0].getLayer(),dirtyFlexObjects:i,skipUpdateCache:e.skipUpdateCache,condenseAnyLayer:e.condenseAnyLayer,appComponent:t,parentVersion:c?a.getProperty("/persistedVersion"):undefined,draftFilenames:c?a.getProperty("/draftFilenames"):undefined});if(r&&c){F.updateAfterSave({reference:n,layer:e.layer,backendResponse:s})}return s};b.deleteFlexObjects=function(e){const t=l.getDirtyFlexObjects(e.reference);const n=[];const r=[];e.flexObjects.forEach(c=>{if(t.indexOf(c)>-1&&c.getState()===a.LifecycleState.NEW){r.push(c)}else{c.markForDeletion();n.push(c)}C(e.reference,c)});o.removeDirtyFlexObjects(e.reference,r);const c=b.addDirtyFlexObjects(e.reference,n);if(!r.length&&!c.length){const t=o.getFlexObjectsDataSelector();t.checkUpdate({reference:e.reference})}};b.restoreDeletedFlexObjects=function(e){const t=e.flexObjects.filter(e=>e.getState()===a.LifecycleState.DELETED||e.getState()===a.LifecycleState.NEW);t.forEach(e=>{e.restorePreviousState()});const n=t.filter(e=>e.getState()!==a.LifecycleState.PERSISTED);b.addDirtyFlexObjects(e.reference,n)};b.resetFlexObjects=async function(e){const r=f.getFlexReferenceForControl(e.appComponent);const a=await b.getFlexObjects({selector:e.appComponent,currentLayer:e.layer,includeCtrlVariants:true});const c={reference:r,layer:e.layer,changes:a};if(e.generator){c.generator=e.generator}if(e.selectorIds){c.selectorIds=e.selectorIds}if(e.changeTypes){c.changeTypes=e.changeTypes}const i=await x.reset(c);if(e.selectorIds||e.changeTypes||e.generator){const c=[];if(i?.response?.length>0){i.response.forEach(e=>{c.push(e.fileName)})}const s=a.filter(e=>c.indexOf(e.getId())!==-1);o.update(r,s.map(e=>({flexObject:e.convertToFileContent(),type:"delete"})));if(s.length){await n.revertMultipleChanges([...s].reverse(),{appComponent:e.appComponent,modifier:t,reference:r})}}};return b});
//# sourceMappingURL=FlexObjectManager.js.map