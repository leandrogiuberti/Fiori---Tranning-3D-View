/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/initial/api/Version","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/api/FeaturesAPI","sap/ui/model/json/JSONModel","sap/ui/model/BindingMode"],function(e,r,n,t,i,s){"use strict";var a={};var o=9;var l=o+1;function d(e){var n=p(e);n.setDefaultBindingMode(s.OneWay);n.setSizeLimit(o);n.setDirtyChanges=function(e){n.setProperty("/dirtyChanges",e);n.updateDraftVersion();n.updateBindings(true)};n.updateDraftVersion=function(){var e=n.getProperty("/versions");var t=n.getProperty("/versioningEnabled");var i=n.getProperty("/dirtyChanges");var s=n.getProperty("/backendDraft");var a=t&&(i||s);n.setProperty("/draftAvailable",a);if(i){n.setProperty("/displayedVersion",r.Number.Draft)}if(!u(e)&&a){e.splice(0,0,{version:r.Number.Draft,type:r.Type.Draft,filenames:[],isPublished:false})}if(u(e)&&!a){e.shift();n.setProperty("/displayedVersion",n.getProperty("/persistedVersion"))}var o=n.getProperty("/displayedVersion")!==n.getProperty("/activeVersion");n.setProperty("/activateEnabled",o)};return n}function f(e,n){if(n!==r.Number.Original&&n!==r.Number.Draft){return e.some(function(e){return e.version===n&&e.isPublished===false})}return false}function p(n){var t;var s=r.Number.Original;var a=n.versions;var o=n.versionsModel;var l=u(a);var d=[];if(a.length>0){t=a[0].version}else{t=r.Number.Original}a.forEach(function(e){if(e.version===r.Number.Draft){e.type=r.Type.Draft;e.isPublished=false;d=e.filenames}else if(s===r.Number.Original){e.type=r.Type.Active;s=e.version}else{e.type=r.Type.Inactive}});if(o){o.setProperty("/publishVersionEnabled",f(a,t));o.setProperty("/versioningEnabled",n.versioningEnabled);o.setProperty("/versions",a);o.setProperty("/backendDraft",l);o.setProperty("/dirtyChanges",false);o.setProperty("/draftAvailable",l);o.setProperty("/activateEnabled",l);o.setProperty("/activeVersion",s);o.setProperty("/persistedVersion",t);o.setProperty("/displayedVersion",t);o.setProperty("/draftFilenames",d);o.updateBindings(true)}else{var p=e.getByReference(n.reference);return new i({publishVersionEnabled:f(a,p.version||t),versioningEnabled:n.versioningEnabled,versions:a,backendDraft:l,dirtyChanges:false,draftAvailable:l,activateEnabled:l,activeVersion:s,persistedVersion:p.version||t,displayedVersion:p.version||t,draftFilenames:d})}return o}function u(e){return e.some(function(e){return e.version===r.Number.Draft})}function v(e,r){e.setProperty("/backendDraft",false);e.setProperty("/dirtyChanges",false);e.setProperty("/draftAvailable",false);e.setProperty("/activateEnabled",false);e.setProperty("/displayedVersion",r);e.setProperty("/persistedVersion",r);e.updateBindings(true)}var c={};c.initialize=async function(e){var r=e.reference;var i=e.layer;e.limit=l;const s=await t.isVersioningEnabled(i);if(a&&a[r]&&a[r][i]){return a[r][i]}var o=s?n.versions.load(e):Promise.resolve([]);return o.then(function(r){e.versioningEnabled=s;e.versions=r;return d(e)}).then(function(e){a[r]||={};a[r][i]||={};a[r][i]=e;return a[r][i]})};c.getVersionsModel=function(e){var r=e.reference;var n=e.layer;if(!c.hasVersionsModel(e)){throw Error(`Versions Model for reference '${r}' and layer '${n}' were not initialized.`)}return a[r][n]};c.hasVersionsModel=function(e){var r=e.reference;var n=e.layer;return!!(a[r]&&a[r][n])};c.clearInstances=function(){a={}};c.updateAfterSave=async function(e){const r={reference:e.reference,layer:e.layer};if(e.backendResponse?.response?.length>0){const n=e.backendResponse.response.map(e=>e.fileName);r.draftFilenames=n;c.onAllChangesSaved(r)}else{await c.updateModelFromBackend(r)}};c.updateModelFromBackend=function(e){if(c.hasVersionsModel(e)&&c.getVersionsModel(e).getProperty("/versioningEnabled")){e.limit=l;return n.versions.load(e).then(function(r){var n=c.getVersionsModel(e);e.versioningEnabled=n.getProperty("/versioningEnabled");e.versions=r;e.versionsModel=n;return p(e)})}return undefined};c.onAllChangesSaved=function(n){const t=c.getVersionsModel(n);const i=t.getProperty("/versioningEnabled");const s=t.getProperty("/dirtyChanges");const a=t.getProperty("/draftFilenames");t.setProperty("/draftFilenames",a.concat(n.draftFilenames));t.setProperty("/dirtyChanges",true);t.setProperty("/backendDraft",i&&s||!!n.contextBasedAdaptation);t.updateDraftVersion();t.setProperty("/persistedVersion",r.Number.Draft);t.updateBindings(true);const o=e.getByReference(n.reference);o.version=r.Number.Draft;e.setByReference(o,n.reference)};c.activate=function(e){var t=c.getVersionsModel(e);var i=t.getProperty("/versions");var s=u(i);var a=t.getProperty("/activeVersion");if(e.displayedVersion===a){return Promise.reject("Version is already active")}e.version=e.displayedVersion;return n.versions.activate(e).then(function(e){i.forEach(function(e){e.type=r.Type.Inactive});e.type=r.Type.Active;e.isPublished=false;if(s){i.shift()}i.splice(0,0,e);t.setProperty("/activeVersion",e.version);t.setProperty("/publishVersionEnabled",true);t.setProperty("/draftFilenames",[]);v(t,e.version)})};c.discardDraft=function(e){var r=c.getVersionsModel(e);var t=r.getProperty("/backendDraft");var i=t?n.versions.discardDraft(e):Promise.resolve();return i.then(function(){var n=r.getProperty("/versions");n.shift();let i=r.getProperty("/activeVersion");if(e.discardDraftAndKeepActiveVersion){i=r.getProperty("/displayedVersion")}v(r,i);return{backendChangesDiscarded:t}})};c.publish=function(e){var r=c.getVersionsModel({reference:e.reference,layer:e.layer});return n.versions.publish(e).then(function(n){if(n!=="Error"&&n!=="Cancel"){r.setProperty("/publishVersionEnabled",false);var t=r.getProperty("/versions");var i=false;t.forEach(function(r){if(r.isPublished){return}if(r.version===e.version){i=true}if(i&&!r.isPublished){r.isPublished=true}})}return n})};return c});
//# sourceMappingURL=Versions.js.map