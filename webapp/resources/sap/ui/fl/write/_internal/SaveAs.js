/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/merge","sap/base/Log","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/apply/_internal/flexState/FlexObjectState","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/apply/api/FlexRuntimeInfoAPI","sap/ui/fl/initial/_internal/Settings","sap/ui/fl/write/_internal/appVariant/AppVariantFactory","sap/ui/fl/write/_internal/appVariant/AppVariantInlineChangeFactory","sap/ui/fl/write/_internal/flexState/FlexObjectManager","sap/ui/fl/Layer","sap/ui/fl/Utils"],function(e,t,r,n,a,i,c,s,o,u,l,p,f){"use strict";function g(e){return s.getInstance().then(function(t){if(!e.package&&(e.layer===p.VENDOR||e.layer===p.CUSTOMER_BASE&&!t.getIsAtoEnabled())){return Promise.reject("Package must be provided or is valid")}if(e.isForSmartBusiness&&(e.package!=="$TMP"&&e.package!=="")&&!e.transport&&!t.getIsAtoEnabled()){return Promise.reject("Transport must be provided")}if(e.isForSmartBusiness&&e.transport||e.package==="$TMP"){return Promise.resolve({packageName:e.package,transport:e.transport})}return Promise.resolve({packageName:"",transport:""})})}function h(e,t){var r=t.transport?e.setTransportRequest(t.transport):Promise.resolve();return r.then(function(){if(t.packageName){return e.setPackage(t.packageName)}return Promise.resolve()})}function d(e){var t=[];e.forEach(function(e){var r={changeType:e.getChangeType(),content:e.getContent()};if(e.getTexts()){r.texts=e.getTexts()}t.push(u.createNew(r))});return Promise.all(t)}function m(e,t){var r={reference:t.getId()};var n=f.createNamespace(r,"changes");var a=e.getFlexObjectMetadata();a.namespace=n;a.reference=t.getId();e.setFlexObjectMetadata(a)}function A(e,t){var r=[];e.forEach(function(e){e.replaceHostingIdForTextKey(t.getId(),t.getReference(),e.getContent(),e.getTexts());r.push(t.addDescriptorInlineChange(e))});return Promise.all(r)}function v(e){const t=i.getFlexReferenceForSelector(e);return a.getDirtyFlexObjects(t).filter(function(e){return n.getChangeTypes().includes(e.getChangeType())})}function y(e){const t=i.getFlexReferenceForSelector(e);return a.getDirtyFlexObjects(t).slice()}function _(e){const t=i.getFlexReferenceForSelector(e);var r=[];v(e).forEach(function(e){if(n.getChangeTypes().includes(e.getChangeType())){r.push(e)}});l.deleteFlexObjects({reference:t,flexObjects:r})}function P(e,t){if(!e){throw new Error(`App variant with ID: ${t.id}does not exist`)}t.package=e.getPackage();t.layer=e.getDefinition().layer;return g(t).then(function(t){return h(e,t)}).then(function(){return e})}var F={saveAs(e){var a;var i;return o.prepareCreate(e).then(function(r){a=t({},r);return g(e)}).then(function(e){return h(a,e)}).then(function(){var t=[];y(e.selector).forEach(function(e){if(n.getChangeTypes().includes(e.getChangeType())){t.push(e)}else{m(e,a)}});return d(t)}).then(function(e){return A(e,a)}).then(function(){return a.submit().catch(function(e){e.messageKey="MSG_SAVE_APP_VARIANT_FAILED";throw e})}).then(function(r){i=t({},r);_(e.selector);var n=y(e.selector);if(n.length){return l.saveFlexObjects({selector:e.selector,skipUpdateCache:true}).then(function(){const t=c.getFlexReference({element:e.selector});l.removeDirtyFlexObjects({reference:t})}).catch(function(t){return this.deleteAppVariant({id:e.id}).then(function(){t.messageKey="MSG_COPY_UNSAVED_CHANGES_FAILED";throw t})}.bind(this))}return Promise.resolve()}.bind(this)).then(function(){return i}).catch(function(t){if(v(e.selector).length){_(e.selector)}r.error("the app variant could not be created.",t.message||t);throw t})},updateAppVariant(a){var i;var c;return o.prepareUpdate(e(a,"selector")).catch(function(e){e.messageKey="MSG_LOAD_APP_VARIANT_FAILED";throw e}).then(function(e){if(!e){throw new Error(`App variant with ID: ${a.id}does not exist`)}i=t({},e);a.package=i.getPackage();a.layer=i.getDefinition().layer;return g(a)}).then(function(e){return h(i,e)}).then(function(){var e=[];v(a.selector).forEach(function(t){if(n.getChangeTypes().includes(t.getChangeType())){e.push(t)}});return d(e)}).then(function(e){return A(e,i)}).then(function(){return i.submit().catch(function(e){if(a.isForSmartBusiness){_(a.selector);throw e}e.messageKey="MSG_UPDATE_APP_VARIANT_FAILED";throw e})}).then(function(e){c=t({},e);_(a.selector);return c}).catch(function(e){if(v(a.selector).length){_(a.selector)}r.error("the app variant could not be updated.",e.message||e);throw e})},deleteAppVariant(t){return o.prepareDelete(e(t,"selector")).catch(function(e){e.messageKey="MSG_LOAD_APP_VARIANT_FAILED";throw e}).then(function(e){return t.isForSmartBusiness?Promise.resolve(e):P(e,t)}).then(function(e){return e.submit().catch(function(e){if(e==="cancel"){return Promise.reject("cancel")}e.messageKey="MSG_DELETE_APP_VARIANT_FAILED";throw e})}).catch(function(e){if(e==="cancel"){return Promise.reject("cancel")}r.error("the app variant could not be deleted.",e.message||e);throw e})}};return F});
//# sourceMappingURL=SaveAs.js.map