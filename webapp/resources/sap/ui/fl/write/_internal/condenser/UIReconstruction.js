/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_isEqual","sap/base/util/each","sap/base/util/ObjectPath","sap/ui/fl/changeHandler/condenser/Classification","sap/ui/fl/write/_internal/condenser/classifications/Create","sap/ui/fl/write/_internal/condenser/classifications/Destroy","sap/ui/fl/write/_internal/condenser/classifications/Move","sap/ui/fl/write/_internal/condenser/Utils"],function(e,n,t,s,i,c,o,a){"use strict";const r={};const f={create:i,destroy:c,move:o};function l(e,t){n(e,(e,s)=>{n(s,(n,i)=>{t(s,e,i,n)})})}function u(e,n,t){e.splice(t,0,e.splice(n,1)[0])}function d(e,n){const t={};l(e,(e,s,i,c)=>{const o=i[a.TARGET_UI];const r=i[a.INITIAL_UI];n.forEach(e=>{const n=o.indexOf(e.affectedControl)>-1||r.indexOf(e.affectedControl)>-1;if(c===e.targetAggregation&&n){t[s]||={};const n=t[s];n[c]||=[];const i=n[c];i.push(e)}})});return t}function h(e){return!e.some(e=>e.classification!==s.Create)}function g(e){return!e.some(e=>a.isUnknown(e))}function I(e){return e.classification==="destroy"?-1:e.getTargetIndex(e.change)}function E(e){e.sort((e,n)=>{const t=I(e);const s=I(n);return t-s})}function T(e){return!e.some(e=>!a.isUnknown(e))}function p(n,t){let s;if(n.length<t.length){s=t.slice(n.length);if(!T(s)){return false}t=t.slice(0,n.length)}else if(n.length>t.length){s=n.slice(t.length,n.length);if(!T(s)){return false}n=n.slice(0,t.length)}return e(n,t)}function _(e,n,t,s,i){const c={};i.forEach(e=>{const s=e.targetContainer;c[s]||={};const i=c[s];i[n]||=a.initializeArrayWithPlaceholders(0,t.length-1);f[e.classification].simulate(i[n],e,t)});const o=c[e][n];if(p(s,o)){i.forEach(e=>{if(e.sameIndex){e.change.condenserState="delete"}});return true}return false}function A(e,n){function t(e,n){if(I(n)!==e){const t=n.change.getState();n.setTargetIndex(n.change,e);n.change.setState(t);if(n.change.isPersisted()){n.change.condenserState="update"}}}function i(n,i,c){c[a.TARGET_UI].forEach((n,i)=>{if(!a.isUnknown(n)){const c=e[n];const o=c[a.INDEX_RELEVANT];l(o,(e,n,c,o)=>{if(o!==s.Destroy){c.forEach(t.bind(this,i))}})}})}l(n,i)}function U(e,n){l(n,(n,t,s,i)=>{const c=s[a.INITIAL_UI];const o=s[a.TARGET_UI];if(p(c,o)){o.forEach(n=>{const t=e[n];if(t!==undefined){l(t[a.INDEX_RELEVANT],(e,n,t)=>{t.forEach(e=>{e.change.condenserState="delete"})});delete t[a.INDEX_RELEVANT]}});delete n[i]}})}function x(e,n){l(n,(n,s,i,c)=>{const o=i[a.INITIAL_UI];const r=i[a.TARGET_UI];o.forEach((n,s)=>{const i=e[n];if(!i||!t.get([a.INDEX_RELEVANT,c],i)){const e=a.PLACEHOLDER+s;const t=r.indexOf(n);if(t>=0){r[t]=e}}})})}r.swapChanges=function(e,n){const t=e.map(e=>n.indexOf(e)).sort();e.forEach(e=>{n[t.shift()]=e})};r.sortIndexRelatedChanges=function(e,n){const t=[];const s=d(e,n);l(s,(n,s,i,c)=>{const o=e[s][c][a.TARGET_UI];const r=e[s][c][a.INITIAL_UI];let f=true;if(g(o)||h(i)){E(i);f=_(s,c,r,o,i)}else if(!_(s,c,r,o,i)){f=false;let e=i.length;while(e!==0&&!f){let n=0;let t=1;while(t<i.length&&!f){u(i,n,t);f=_(s,c,r,o,i);n++;t++}e--}}if(!f){throw Error(`no correct sorting found for the container: ${s}`)}i=i.filter(e=>e.change.condenserState!=="delete");t.push(i.map(e=>{if(e.revertIndex>-1){e.setIndexInRevertData(e.change,e.revertIndex);e.sourceIndex=e.revertIndex}return e.change}))});return t};r.addChange=async function(e,n){await f[n.classification].addToReconstructionMap(e,n)};r.compareAndUpdate=function(e,n){U(e,n);x(e,n);A(e,n)};return r});
//# sourceMappingURL=UIReconstruction.js.map