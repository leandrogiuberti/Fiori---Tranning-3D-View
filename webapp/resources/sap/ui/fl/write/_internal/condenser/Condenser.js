/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_isEqual","sap/base/util/each","sap/base/util/isPlainObject","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexObjects/FlexObject","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexObjects/UIChange","sap/ui/fl/changeHandler/condenser/Classification","sap/ui/fl/write/_internal/condenser/classifications/LastOneWins","sap/ui/fl/write/_internal/condenser/classifications/Reverse","sap/ui/fl/write/_internal/condenser/classifications/Update","sap/ui/fl/write/_internal/condenser/UIReconstruction","sap/ui/fl/write/_internal/condenser/Utils","sap/ui/fl/Utils","sap/ui/performance/Measurement"],function(e,t,n,a,s,o,r,i,c,f,l,d,u,p,g,C,h,E,y){"use strict";const _={};const S="unclassified";const I={lastOneWins:u,reverse:p,update:g};const O=["affectedControl","sourceContainer","targetContainer","updateControl"];function N(e,t){const n=e[d.Move];return t.classification===d.Create&&n&&n[n.length-1].targetContainer===t.targetContainer}function D(e,t){return t.classification===d.Move&&e[d.Destroy]}function T(e,t){return t.classification===d.Create&&e[d.Destroy]}async function v(e,t,n,a){if(!D(e,n)&&!T(e,n)){const t=n.classification;if(!e[t]){n.change=a;a.condenserState="select";e[t]=[n]}else{a.condenserState="delete"}e[t][0].updateChange=a}else{a.condenserState="delete"}if(N(e,n)||T(e,n)){if(e[d.Move]){e[d.Move].forEach(e=>{e.change.condenserState="delete"});delete e[d.Move]}if(e[d.Destroy]){e[d.Destroy].forEach(e=>{e.change.condenserState="delete"});delete e[d.Destroy]}}await C.addChange(t,n)}function m(e,t,n){e[t.classification]||={};const a=e[t.classification];I[t.classification].addToChangesMap(a,t,n)}async function A(e,t,n,a,s){e[a.type]||={};const o=e[a.type];if(a.type===h.NOT_INDEX_RELEVANT){m(o,a,s)}else{n.push(s);o[a.targetAggregation]||={};await v(o[a.targetAggregation],t,a,s)}}function R(e,t,n){e[t]||=[];e[t].push(n);n.condenserState="select"}async function w(e,t){let n;let a=false;const s={modifier:o,appComponent:e};try{if(t instanceof l){const c=o.getControlIdBySelector(t.getSelector(),e);const f=r.getElementById(c);if(f){s.view=E.getViewForControl(f);const e=i.getControlIfTemplateAffected(t,f,s);a=e.bTemplateAffected;n=await i.getChangeHandler({flexObject:t,control:e.control,controlType:e.controlType,modifier:s.modifier})}}else{n=await i.getChangeHandler({flexObject:t})}if(typeof n.getCondenserInfo==="function"){const e=await n.getCondenserInfo(t,s);if(e&&a){x(e,t)}return e}}catch(e){return undefined}return undefined}function x(e,t){const n=t.getOriginalSelector();const a=t.getSelector();O.forEach(t=>{if(e[t]&&e[t]===a){e[t]=n}})}function b(e,t,n,s){const o=n.getIdForCondensing(t,s);e[o]||={};if(t&&t.updateControl){const n=t.updateControl;const s=[h.NOT_INDEX_RELEVANT,d.Update,t.uniqueKey];const r=a.get(s,e[n]);if(r){a.set(s,r,e[o]);delete e[n][h.NOT_INDEX_RELEVANT][d.Update][t.uniqueKey]}}return e[o]}async function L(e,t,n,a,s){for(const o of s){await U(e,t,n,a,o)}}async function U(e,t,n,a,s){const o=await w(e,s);j(o,e);const r=b(t,o,s,e);if(o!==undefined){M(o);await A(r,n,a,o,s);if(o.update){V(r,o,s)}}else{R(r,S,s);t[S]=true}}function M(e){if(I[e.classification]){e.type=h.NOT_INDEX_RELEVANT}else{e.type=h.INDEX_RELEVANT}}function j(e,t){O.forEach(n=>{if(e&&e[n]){e[n]=o.getControlIdBySelector(e[n],t)}})}function V(e,t,n){const s=[h.NOT_INDEX_RELEVANT,d.Update,t.uniqueKey];const o=a.get(s,e);if(o){o.change.condenserState="delete";if(n.condenserState==="delete"){return}if(n.isPersisted()){n.condenserState="update"}t.update(n,o.updateContent);n.setState(f.LifecycleState.UPDATED);delete e[h.NOT_INDEX_RELEVANT][d.Update][t.uniqueKey]}}function X(e,a){t(e,(t,s)=>{if(I[t]&&I[t].getChangesFromMap){I[t].getChangesFromMap(e,t).forEach(e=>{a.push(e)})}else if(n(s)){return X(s,a)}else if(Array.isArray(s)){s.forEach(e=>{if(e instanceof c){a.push(e)}else{a.push(e.change)}})}});return a}function q(e){return X(e,[])}function F(e,t){Object.values(e).forEach(e=>{if(n(e)){F(e,t)}else if(Array.isArray(e)){e.forEach(e=>{if(!(e instanceof c)){t.push(e)}})}});return t}function P(e,t){t.sort((t,n)=>e.indexOf(t)-e.indexOf(n))}function B(e,t){t.sort((t,n)=>e.indexOf(t.change)-e.indexOf(n.change))}function K(e,t){const n=e.map(e=>e.getId());t.forEach(t=>{if(n.indexOf(t.getId())===-1){e.push(t)}})}function W(e){for(const t in e){for(const n of["lastOneWins","update"]){const s=a.get([t,h.NOT_INDEX_RELEVANT,n],e);if(s){for(const e of Object.values(s)){if(e.oldestChange?.getRevertData){e.change.setRevertData(e.oldestChange.getRevertData())}}}}}}function H(t,n,a){t.forEach(t=>{const s=t.updateChange;if(s&&!e(s.getContent(),t.change.getContent())&&s.getState()!==f.LifecycleState.NEW){const e=t.change;if(s.getId()!==e.getId()){const t=e.getContent();s.setContent(t);s.setRevertData(e.getRevertData());e.condenserState="delete";n=n.map(t=>{if(t.getId()===e.getId()){return s}return t});const o=t=>{if(t.getId()===e.getId()){return s}return t};a.forEach((e,t)=>{a[t]=e.map(o)})}else{s.setState(f.LifecycleState.UPDATED)}s.condenserState="update"}});return n}_.condense=async function(e,t){y.start("Condenser_overall","Condenser overall - CondenserClass",["sap.ui.fl","Condenser"]);const n={};const a={};const o=[];const r=[];const i=[];t.slice(0).reverse().forEach(e=>{if(e.getState()===f.LifecycleState.DELETED){e.condenserState="delete"}else if(e.canBeCondensed()){i.push(e)}else{r.push(e)}});y.start("Condenser_defineMaps","defining of maps - CondenserClass",["sap.ui.fl","Condenser"]);await L(e,n,a,o,i);y.end("Condenser_defineMaps");W(n);const c=n[S];if(!c){C.compareAndUpdate(n,a)}let l=q(n);if(c){o.forEach(e=>{if(e.condenserState!=="update"){e.condenserState="select"}});K(l,o)}l=l.concat(r);P(t,l);if(!c){y.start("Condenser_handleIndexRelatedChanges","handle index related changes - CondenserClass",["sap.ui.fl","Condenser"]);let e=true;let r=F(n,[]);B(t,r);let i;try{y.start("Condenser_sort","sort index related changes - CondenserClass",["sap.ui.fl","Condenser"]);i=C.sortIndexRelatedChanges(a,r)}catch(t){s.error(`Error during Condensing: ${t.message}`,"No Condensing performed for index-relevant changes.");e=false}y.end("Condenser_sort");if(e){l=l.filter(e=>e.condenserState!=="delete");r=r.filter(e=>e.change.condenserState!=="delete");l=H(r,l,i);P(t,l);i.forEach(e=>{C.swapChanges(e,l)})}else{o.forEach(e=>{e.condenserState="select"});K(l,o);P(t,l)}y.end("Condenser_handleIndexRelatedChanges")}y.end("Condenser_overall");return l};return _});
//# sourceMappingURL=Condenser.js.map