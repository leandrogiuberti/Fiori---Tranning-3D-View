/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/flexObjects/UIChange","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/api/FlexRuntimeInfoAPI","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/initial/_internal/Loader","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/initial/_internal/Settings","sap/ui/fl/write/_internal/condenser/Condenser","sap/ui/fl/write/_internal/flexState/changes/UIChangeManager","sap/ui/fl/write/_internal/flexState/FlexObjectManager","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/ui/fl/write/_internal/init"],function(e,t,n,r,s,a,i,o,l,c,f,u,g,p,d,h,y,C,x,b){"use strict";var F={};function m(e){return e._getMap&&r.getChangeTypes().includes(e._getMap().changeType)||e.getChangeType&&r.getChangeTypes().includes(e.getChangeType())}function w(e){return F._getUIChanges({...e,includeCtrlVariants:true}).then(function(e){return e.length>0})}F.hasDirtyChanges=function(e){return d.hasDirtyFlexObjects(e)};F.hasHigherLayerChanges=async function(e){e.upToLayer||=x.getCurrentLayer();const t=await d.getFlexObjects(e);const n=t.filter(t=>x.isOverLayer(t.getLayer(),e.upToLayer));if(n.length===0){return false}return d.filterHiddenFlexObjects(n,e.reference).length>0};F.save=async function(t){const n=f.getFlexReferenceForSelector(t.selector);let r=l.getByReference(n);r.saveChangeKeepSession=true;l.setByReference(r,n);await d.saveFlexObjects(t);r.version=t.version;l.setByReference(r,n);const s=await d.getFlexObjects({...e(t,["skipUpdateCache","layer","version"]),invalidateCache:true,currentLayer:t.layer,includeCtrlVariants:true});if(s?.length>0){await F.updateResetAndPublishInfo(t)}r=l.getByReference(n);delete r.saveChangeKeepSession;l.setByReference(r,n);return s};F.updateResetAndPublishInfo=async function(e){const n=f.getFlexReferenceForSelector(e.selector);const[r,s]=await Promise.all([w(e),y.isPublishAvailable()]);const a={isResetEnabled:r,isPublishEnabled:false,allContextsProvided:true};const i=e.layer!==C.USER&&e.layer!==C.PUBLIC;if(i){try{const t=await h.getFlexInfo({...e,reference:n});a.allContextsProvided=t.allContextsProvided!==false;a.isResetEnabled=t.isResetEnabled;a.isPublishEnabled=s&&t.isPublishEnabled}catch(e){t.error(`Sending request to flex/info route failed: ${e.message}`)}}const o=l.getByReference(n);const u={...o,...a};l.setByReference(u,n);c.setAllContextsProvided(n,u.allContextsProvided)};F.getResetAndPublishInfoFromSession=function(e){var t=f.getFlexReferenceForControl(e)||"true";return JSON.parse(window.sessionStorage.getItem(`sap.ui.fl.info.${t}`))};F.reset=function(t){var n=b.getAppComponentForSelector(t.selector);return d.resetFlexObjects({...e(t,"selector"),appComponent:n})};F.add=function(e){const t=b.getAppComponentForSelector(e.selector);const n=f.getFlexReferenceForSelector(e.selector);function r(e){if(m(e)){return e.store()}if(e instanceof a){return p.addDirtyChanges(n,[e],t)?.[0]}return d.addDirtyFlexObjects(n,[e])?.[0]}if(e.change&&e.flexObjects){throw new Error("Using 'flexObjects' and 'change' properties together not supported. Please use the 'flexObjects' property.")}if(e.change){return r(e.change)}const s=e.flexObjects.some(function(e){return m(e)});if(s){return e.flexObjects.map(r)}const i=[];const o=[];e.flexObjects.forEach(e=>{if(e instanceof a){i.push(e)}else{o.push(e)}});const l=d.addDirtyFlexObjects(n,o);const c=p.addDirtyChanges(n,i,t);return e.flexObjects.map(e=>l.find(t=>t===e)||c.find(t=>t===e))};F.remove=function(e){if(e.change&&e.flexObjects){return Promise.reject(new Error("Using 'flexObjects' and 'change' properties together not supported. Please use the 'flexObjects' property."))}if(!e.selector){return Promise.reject(new Error(`An invalid selector was passed so change could not be removed with id: ${e.change.getId()}`))}const t=b.getAppComponentForSelector(e.selector);if(!t){return Promise.reject(new Error(`Invalid application component for selector, change could not be removed with id: ${e.change.getId()}`))}const r=e.change?[e.change]:e.flexObjects;const a=f.getFlexReferenceForSelector(e.selector);r.forEach(function(e){if(e.isValidForDependencyMap()){const r=n.bySelector(e.getSelector(),t);if(r){s.destroyAppliedCustomData(r,e,n)}}});d.deleteFlexObjects({reference:a,flexObjects:r});return Promise.resolve()};F.getChangesWarning=function(e){return this._getUIChanges(e).then(function(e){const t=e.some(function(e){return e.isChangeFromOtherSystem()});const n=u.getInstanceOrUndef();const r=n&&n.getIsProductiveSystem()&&n.getSystem()&&n.getClient();const s=e.length===0;let a={showWarning:false};if(t){a={showWarning:true,warningType:"mixedChangesWarning"}}if(r&&s){a={showWarning:true,warningType:"noChangesAndPSystemWarning"}}return a})};F._condense=function(e){return Promise.resolve().then(function(){if(!e.selector){throw Error("An invalid selector was passed")}var t=b.getAppComponentForSelector(e.selector);if(!t){throw Error("Invalid application component for selector")}if(!e.changes||e.changes&&!Array.isArray(e.changes)){throw Error("Invalid array of changes")}return g.condense(t,e.changes)})};F._getUIChanges=function(e){if(e.layer){e.currentLayer=e.layer}e.invalidateCache=false;return d.getFlexObjects(e)};F._getAnnotationChanges=function(e){const t=f.getFlexReferenceForControl(e.control);return i.getAnnotationChanges(t)};F._getFlexObjectsForUser=async function(e){const t=o.getUserId();const n=await F._getUIChanges(e);return n.filter(e=>e.getSupportInformation().user===t)};F.setAdaptationLayer=function(e,t){const n=f.getFlexReferenceForControl(t);const r=l.getByReference(n);r.adaptationLayer=e;l.setByReference(r,n)};return F});
//# sourceMappingURL=PersistenceWriteAPI.js.map