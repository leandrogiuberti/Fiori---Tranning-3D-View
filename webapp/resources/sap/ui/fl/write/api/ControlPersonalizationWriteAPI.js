/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexState/FlexObjectState","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/fl/apply/api/FlexRuntimeInfoAPI","sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerStorage","sap/ui/fl/initial/_internal/Settings","sap/ui/fl/write/_internal/flexState/changes/UIChangeManager","sap/ui/fl/write/_internal/flexState/FlexObjectManager","sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/write/_internal/init"],function(e,t,n,r,o,a,c,l,i,s,p,f,u,g,d,h){"use strict";var m={};function C(e,r){if(!e.changeSpecificData){return Promise.reject(new Error("No changeSpecificData available"))}if(!e.changeSpecificData.changeType){return Promise.reject(new Error("No valid changeType"))}if(!(e.selectorControl instanceof n)){return Promise.reject(new Error("No valid selectorControl"))}var o=e.selectorControl.getMetadata().getName();return s.getChangeHandler(e.changeSpecificData.changeType,o,e.selectorControl,t,r)}function y(e,n,r){var a=o.getRelevantVariantManagementControlId(n,[],r);return t.getSelector(a,e).id}function v(t){e.error(t);return Promise.reject(t)}var S={async add(t){if(!t.changes.length){return Promise.resolve([])}const n=t.changes[0].selectorElement||t.changes[0].selectorControl;const r=h.getAppComponentForControl(n);const o=i.getFlexReference({element:n});const a=r.getModel(l.getVariantModelName());const c=d.USER;const s=[];const p={};function v(){const n=[];const l=[];return t.changes.reduce(function(o,i){return o.then(function(){i.selectorControl=i.selectorElement;return C(i,c)}).then(function(){if(!i.transient&&!t.ignoreVariantManagement){if(!i.changeSpecificData.variantReference){let e;const n=i.selectorControl.getId();e=p[n]||y(r,i.selectorControl,t.useStaticArea);if(!e&&!t.useStaticArea){e=y(r,i.selectorControl,true)}if(e){p[n]=e;const t=a.oData[e].currentVariant;i.changeSpecificData.variantReference=t}}}else{delete i.changeSpecificData.variantReference}i.changeSpecificData={...i.changeSpecificData,developerMode:false,layer:c};return g.create({changeSpecificData:i.changeSpecificData,selector:i.selectorControl})}).then(function(e){if(!i.transient){l.push(e)}n.push({changeInstance:e,selectorControl:i.selectorControl})}).catch(function(t){e.error("A Change was not created successfully. Reason: ",t.message)})},Promise.resolve()).then(function(){f.addDirtyChanges(o,l,r);return n}).catch(function(t){e.error("Changes were not added successfully. Reason: ",t.message)})}function S(t){return t.reduce(function(t,n){return t.then(function(){n.changeInstance.setQueuedForApply();return g.apply({change:n.changeInstance,element:n.selectorControl})}).then(function(e){if(e.success){s.push(n.changeInstance)}else{throw e.error||new Error("ChangesWriteAPI.apply failed with unspecified error")}}).catch(function(t){u.deleteFlexObjects({reference:o,flexObjects:[n.changeInstance]});e.error("A Change was not applied successfully. Reason: ",t.message)})},Promise.resolve())}const I=await v();await S(I);(m[o]||[]).forEach(function(e){e(s)});return s},reset(e){if(!e.selectors||e.selectors.length===0){return v("At least one control ID has to be provided as a parameter")}var t=e.selectors[0].appComponent||h.getAppComponentForControl(e.selectors[0]);if(!t){return v("App Component could not be determined")}var n=e.selectors.map(function(e){var n=e.id||e.getId();var r=t.getLocalId(n);return r||n});return u.resetFlexObjects({layer:d.USER,appComponent:t,selectorIds:n,changeTypes:e.changeTypes})},async restore(e){if(!e||!e.selector){return Promise.reject("No selector was provided")}var n=h.getAppComponentForControl(e.selector);if(!n){return Promise.reject("App Component could not be determined")}const o=i.getFlexReference({element:e.selector});if(c.isInitialized({control:n})){const a=u.removeDirtyFlexObjects({reference:o,layers:d.USER,component:n,control:e.selector,generator:e.generator,changeTypes:e.changeTypes});if(a.length!==0){await r.revertMultipleChanges([...a].reverse(),{appComponent:n,modifier:t,reference:o})}}return undefined},hasDirtyFlexObjects(e){if(!e||!e.selector){throw Error("No selector was provided")}var n=h.getAppComponentForControl(e.selector);if(!n){throw Error("App Component could not be determined")}const r=i.getFlexReference({element:e.selector});var o=a.getDirtyFlexObjects(r);return o.some(function(r){if(r.getLayer()!==d.USER){return false}if(e.generator&&r.getSupportInformation().generator!==e.generator){return false}if(e.changeTypes&&e.changeTypes.indexOf(r.getChangeType())===-1){return false}var o=r.getSelector();return e.selector.getId()===t.getControlIdBySelector(o,n)})},save(e){var t=e.selector.appComponent||h.getAppComponentForControl(e.selector);if(!t){return v("App Component could not be determined")}if(c.isInitialized({control:t})){return u.saveFlexObjects({flexObjects:e.changes,selector:t})}return Promise.resolve()},buildSelectorFromElementIdAndType(e){var t=h.getAppComponentForControl(e.element);if(!t||!e.elementId||!e.elementType){throw new Error("Not enough information given to build selector.")}return{elementId:e.elementId,elementType:e.elementType,appComponent:t,id:e.elementId,controlType:e.elementType}},async isCondensingEnabled(){const e=await p.getInstance();return e.getIsCondensingEnabled()},attachChangeCreation(e,t){var n=i.getFlexReference({element:e});m[n]=(m[n]||[]).concat(t)},detachChangeCreation(e,t){var n=i.getFlexReference({element:e});if(Array.isArray(m[n])){m[n]=m[n].filter(function(e){return e!==t})}},detachAllChangeCreationListeners(e){if(e){var t=i.getFlexReference({element:e});delete m[t]}else{m={}}}};return S});
//# sourceMappingURL=ControlPersonalizationWriteAPI.js.map