/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/core/Element","sap/ui/core/Lib","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexObjectState","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/descriptorRelated/api/DescriptorChangeFactory","sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerStorage","sap/ui/fl/write/_internal/appVariant/AppVariantInlineChangeFactory","sap/ui/fl/write/_internal/controlVariants/ControlVariantWriteUtils","sap/ui/fl/write/_internal/flexState/FlexObjectManager","sap/ui/fl/write/api/ContextBasedAdaptationsAPI","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/write/_internal/init"],function(e,t,n,a,r,i,o,c,p,l,s,g,f,h,u,d,C,m,y,S,D,v,F,w,x){"use strict";var T={};function I(e){let n;if(e.changeSpecificData.layer){n=e.changeSpecificData.layer;delete e.changeSpecificData.layer}const a={changeType:e.changeSpecificData.changeType,content:e.changeSpecificData.content};if(e.changeSpecificData.texts){a.texts=e.changeSpecificData.texts}if(e.changeSpecificData.support){a.support={compositeCommand:e.changeSpecificData.support.compositeCommand||""}}if(e.changeSpecificData.adaptationId){a.adaptationId=e.changeSpecificData.adaptationId}return m.createDescriptorInlineChange(a).then(t=>(new d).createNew(e.changeSpecificData.reference,t,n,undefined,e.generator)).catch(e=>{t.error("the change could not be created.",e.message);throw e})}async function A(e){const t=await C.getAnnotationChangeHandler({changeType:e.changeSpecificData.changeType});const a=s.createAnnotationChange(e.changeSpecificData);t.completeChangeContent(a,e.changeSpecificData,{modifier:n,appComponent:e.appComponent});return a}function _(e){const a=s.createUIChange(e.changeSpecificData);return C.getChangeHandler(a.getChangeType(),e.controlType,e.selector,n,a.getLayer()).then(r=>{const i={...e.changeSpecificData};if(i.content){Object.keys(i.content).forEach(e=>{if(!i[e]){i[e]=i.content[e]}else{t.warning(`The property '${e}' is defined both in the change specific data and its content.`)}})}return r.completeChangeContent(a,i,{modifier:n,appComponent:e.appComponent,view:x.getViewForControl(e.selector)})}).then(()=>{a.setState(g.LifecycleState.NEW);return a})}T.create=function(e){const{changeSpecificData:t,selector:r}=e;if(t.changeType==="codeExt"){return s.createControllerExtensionChange(t)}e.appComponent=x.getAppComponentForSelector(r.view||r);if(r?.appId||u.getFlexReferenceForControl(e.appComponent)){t.reference=r?.appId||u.getFlexReferenceForControl(e.appComponent)}const i={layer:t.layer,control:e.appComponent,reference:t.reference};if(D.hasAdaptationsModel(i)){t.adaptationId=D.getDisplayedAdaptationId(i)}if(o.getChangeTypes().includes(t.changeType)){return I(e)}if(e.changeSpecificData.changeType==="deactivateChanges"){return s.createFlexObject(e.changeSpecificData)}if(e.annotationChange){return A(e)}if(r instanceof a){return Promise.resolve(s.createUIChange(t))}if(r.name&&r.view){t.selector={name:r.name,viewSelector:n.getSelector(r.view.getId(),e.appComponent)};return _(e)}const c=r.id||r.getId();t.selector||={};Object.assign(t.selector,n.getSelector(c,e.appComponent));e.controlType=r.controlType||x.getControlType(r);return _(e)};T.apply=function(t){if(!(t.element instanceof r)){return Promise.reject("Please provide an Element")}t.appComponent=x.getAppComponentForSelector(t.element);t.modifier||=n;return c.applyChangeOnControl(t.change,t.element,e(t,["element","change"])).then(function(e){var a=h.getOpenDependentChangesForControl(n.getControlIdBySelector(t.change.getSelector(),t.appComponent),t.appComponent);if(a.length>0){return T.revert({change:t.change,element:t.element}).then(function(){var e=i.getResourceBundleFor("sap.ui.fl");var n=a.map(function(e){return e.getId()}).join(", ");throw Error(e.getText("MSG_DEPENDENT_CHANGE_ERROR",[t.change.getId(),n]))})}return e})};T.revert=function(e){var t=x.getAppComponentForSelector(e.element||{});var a=[];var r={modifier:n,appComponent:t};if(!Array.isArray(e.change)){return p.revertChangeOnControl(e.change,e.element,r)}var i=e.change.slice(0).reverse();return i.reduce(function(t,n){return t.then(function(){return p.revertChangeOnControl(n,e.element,r).then(function(e){a.unshift(e)})})},Promise.resolve()).then(function(){return a})};T.getChangeHandler=function(e){var t=e.controlType||e.modifier?.getControlType(e.element);return l.getChangeHandler({changeType:e.changeType,control:e.element,controlType:t,modifier:e.modifier,layer:e.layer,appDescriptorChange:e.appDescriptorChange,annotationChange:e.annotationChange})};T.deleteVariantsAndRelatedObjects=function(e){if(!e.variantManagementControl?.isA("sap.ui.fl.variants.VariantManagement")){throw new Error("Please provide a valid Variant Management control")}const a=e.variantManagementControl;const r=x.getAppComponentForControl(a);const i=n.getSelector(a,r).id;const o=u.getFlexReferenceForControl(r);let c=e.variants.filter(n=>{const a=f.getVariant({vmReference:i,reference:o,vReference:n});if(!a){t.warning(`Variant with ID '${n}' does not exist in the Variant Management control.`);return false}return a.layer===e.layer});if(!e.forceDelete){const t=F.getDraftFilenames({control:a,layer:e.layer});const n=h.getDirtyFlexObjects(o).map(e=>e.getId());c=c.filter(e=>t.includes(e)||n.includes(e))}return c.map(e=>y.deleteVariant(o,i,e)).flat()};T.restoreDeletedFlexObjects=function(e){S.restoreDeletedFlexObjects(e)};return T});
//# sourceMappingURL=ChangesWriteAPI.js.map