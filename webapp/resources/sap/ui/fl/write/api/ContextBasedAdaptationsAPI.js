/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Lib","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/apply/_internal/flexState/compVariants/applyChangesOnVariant","sap/ui/fl/apply/_internal/flexState/compVariants/CompVariantManagementState","sap/ui/fl/write/_internal/flexState/compVariants/CompVariantManager","sap/ui/fl/write/_internal/flexState/FlexObjectManager","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/_internal/Versions","sap/ui/fl/write/api/Adaptations","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/fl/write/_internal/init"],function(e,t,n,r,a,i,o,s,l,d,c,p,u,f,y,v,g){"use strict";var h={};var A;var I=[f.VENDOR,f.PARTNER,f.CUSTOMER_BASE,f.CUSTOMER];var x={};function m(e){var t=r.getFlexReferenceForControl(e);if(!t){throw Error("The application ID could not be determined")}return t}function C(e,t,n){if(n){return c.updateModelFromBackend({reference:t.appId,layer:t.layer}).then(function(){return e})}c.onAllChangesSaved({reference:t.appId,layer:t.layer,contextBasedAdaptation:true});return Promise.resolve(e)}x.initialize=function(t){A||=e.getResourceBundleFor("sap.ui.fl");if(!t.layer){return Promise.reject("No layer was provided")}if(!t.control){return Promise.reject("No control was provided")}var n=m(t.control);t.reference=n;var r=t.layer;if(h&&h[n]&&h[n][r]){return Promise.resolve(h[n][r])}var i;return u.isContextBasedAdaptationAvailable(r).then(function(e){i=e;return i?x.load(t):Promise.resolve({adaptations:[]})}).then(function(e){var n=a.getByReference(t.reference);var r=e.adaptations[0];if(n.adaptationId){r=e.adaptations.find(function(e){return e.id===n.adaptationId})||r}return x.createModel(e.adaptations,r,i)}).then(function(e){h[n]||={};h[n][r]||={};h[n][r]=e;return h[n][r]})};x.createModel=function(e,t,n){if(!Array.isArray(e)){throw Error("Adaptations model can only be initialized with an array of adaptations")}if(n&&!t){throw Error("Invalid call, must pass displayed adaptation")}if(!n&&e.length){throw Error("Invalid call, must not pass adaptations if feature is disabled")}const r=new g({allAdaptations:[],adaptations:[],count:0,displayedAdaptation:{},contextBasedAdaptationsEnabled:n});r.updateAdaptations=function(e){const t=e.filter(function(e,t){e.rank=t+1;return e.type!==p.Type.Default});r.setProperty("/adaptations",t);r.setProperty("/allAdaptations",e);r.setProperty("/count",t.length);let n=r.getProperty("/displayedAdaptation");const a=e.find(function(e){return!!n&&e.id===n.id});if(a){n={...a};r.setProperty("/displayedAdaptation",n)}r.updateBindings(true)};r.insertAdaptation=function(e){const t=r.getProperty("/allAdaptations");t.splice(e.priority,0,e);delete e.priority;r.updateAdaptations(t)};r.deleteAdaptation=function(){const e=r.getProperty("/displayedAdaptation").rank-1;const t=r.getProperty("/adaptations");const n=r.getProperty("/count");let a;if(n>1){a=t[e+(e===n-1?-1:1)].id}t.splice(e,1);const i=r.getProperty("/allAdaptations").pop();t.push(i);r.updateAdaptations(t);return a};r.switchDisplayedAdaptation=function(e){const t=r.getIndexByAdaptationId(e);const n=t?r.getProperty("/allAdaptations")[t]:r.getProperty("/allAdaptations")[0];r.setProperty("/displayedAdaptation",n);r.updateBindings(true)};r.updateAdaptationContent=function(e){const t=r.getProperty("/allAdaptations");const n=t.find(function(t){return e.adaptationId===t.id});n.title=e.title;n.contexts=e.contexts;const a=n.rank-1;if(a!==e.priority){const n=t.splice(a,1);t.splice(e.priority,0,n[0])}r.updateAdaptations(t)};r.getIndexByAdaptationId=function(e){const t=r.getProperty("/allAdaptations");const n=t.findIndex(function(t){return t.id===e});return n>-1?n:undefined};if(e.length>0){r.updateAdaptations(e);r.setProperty("/displayedAdaptation",t)}return r};x.getAdaptationsModel=function(e){if(!e.layer){throw Error("No layer was provided")}if(!e.control){throw Error("No control was provided")}e.reference=m(e.control);var t=e.reference;var n=e.layer;if(!x.hasAdaptationsModel(e)){throw Error(`Adaptations model for reference '${t}' and layer '${n}' were not initialized.`)}return h[t][n]};x.getDisplayedAdaptationId=function(e){var t=this.getAdaptationsModel(e).getProperty("/displayedAdaptation/id");return t!==p.Type.Default?t:undefined};x.hasAdaptationsModel=function(e){var t=e.reference;var n=e.layer;return h[t]&&h[t][n]};x.adaptationExists=function(e){var t=e.reference;var n=e.layer;return this.hasAdaptationsModel({reference:t,layer:n})&&h[t][n].getProperty("/count")>0};x.clearInstances=function(){h={}};x.refreshAdaptationModel=function(e){this.clearInstances();return this.initialize(e).then(function(e){return e.getProperty("/displayedAdaptation/id")})};function V(e,t){return e.get(t)||t}function P(e,t){return d.contextBasedAdaptation.create({layer:e.layer,flexObject:t,appId:e.appId,parentVersion:S(e)}).then(function(n){var r=this.getAdaptationsModel(e);r.insertAdaptation(t);return C(n,e)}.bind(this))}function w(e,t){return d.write({layer:e.layer,flexObjects:t,transport:"",isLegacyVariant:false,parentVersion:S(e)})}function j(e,t,n){if(n.isA("sap.ui.fl.apply._internal.flexObjects.CompVariant")){var r=t.filter(function(e){return e.getChangeType()==="updateVariant"&&e.getSelector().variantId===n.getId()});var a=n.clone();i(a,r);a.destroy();return a.mProperties}return e.find(function(e){return e.key===n.getId()})}function b(e,t){var n={};var r=[];e.forEach(function(e){var a=t[e.getId()];if(a.visible){var i=true;var o=Object.keys(a.contexts);o.forEach(function(t){var r=Array.from(a.contexts[t]);r.forEach(function(t){i=false;if(n[t]){n[t].variants.push(e)}else{n[t]={contextBasedAdaptationId:v.createDefaultFileName(),variants:[e]}}})});if(i){r.push(e)}}});return{uniqueContexts:n,unrestrictedViews:r}}function O(e,t,n,r){if(e.isA("sap.ui.fl.apply._internal.flexObjects.CompVariant")){var a=e.getPersistencyKey();e=s.updateVariant({reference:t.appId,persistencyKey:a,id:e.getId(),layer:t.layer,visible:false,adaptationId:n,forceCreate:true});return o.getVariantChanges(e).reverse()[0].convertToFileContent()}var i=v.getAppComponentForControl(t.control);var l=r.createVariantChange(e.getVariantManagementReference(),{changeType:"setVisible",visible:false,variantReference:e.getId(),layer:t.layer,appComponent:i,adaptationId:n});return l.convertToFileContent()}function E(e,t,n){return e.filter(e=>n===e.isA("sap.ui.fl.apply._internal.flexObjects.Variant")&&e.getLayer()===t)}function F(e){var t=e.getFileType();if(t==="change"){if(e.getSelector().variantId){return e.getSelector().variantId}if(e.getVariantReference()){return e.getVariantReference()}}else if(t==="ctrl_variant_change"){return e.getVariantId()}return undefined}function M(e){return e.getFileType()==="ctrl_variant_change"&&e.getChangeType()==="setContexts"}function B(e,t){return t.filter(function(t){var n=F(t);if(M(t)){return false}return!n||e.indexOf(n)<0})}function T(e,t){var n=[];var r=[];var a=new Map;e.forEach(function(e){if(e.isA("sap.ui.fl.apply._internal.flexObjects.Variant")){n.push(e)}else{r.push(e)}});var i=N(n,a,t);var o=_(r,a,t);return i.concat(o).map(function(e){return e.convertToFileContent()})}function N(e,n,r){var a=[];e.forEach(function(e){var i=t.createFromFileContent(e.cloneFileContentWithNewId());i.setAdaptationId(r);i.setContexts();n.set(e.getId(),i.getId());a.push(i)});return a}function _(e,n,r){const a=[];e.forEach(function(e){const i=t.createFromFileContent(e.cloneFileContentWithNewId());const o=i.getContent();if(e.getFileType()==="change"){if(e.getSelector().variantId){const e=i.getSelector();e.variantId=V(n,i.getSelector().variantId);i.setSelector(e)}else if(e.getContent().defaultVariantName){o.defaultVariantName=V(n,i.getContent().defaultVariantName);i.setContent(o)}if(e.getVariantReference()){i.setVariantReference(V(n,i.getVariantReference()))}if(e.getChangeType()==="updateVariant"){delete i.getContent().contexts;if(!Object.keys(i.getContent()).length){return}}}else if(e.getFileType()==="ctrl_variant_change"){i.setVariantId(V(n,i.getVariantId()))}else if(e.getFileType()==="ctrl_variant_management_change"&&e.getContent().defaultVariant){o.defaultVariant=V(n,i.getContent().defaultVariant);i.setContent(o)}i.setAdaptationId(r);a.push(i)});return a}function S(e){return c.getVersionsModel({layer:e.layer,reference:e.appId}).getProperty("/persistedVersion")}function R(e,t,n,r,a){var i={contextBasedAdaptations:[],flexObjects:[]};var o={};e.forEach(function(e){o[e.getId()]=j(t,n,e)});var s=b(e,o);var l=s.uniqueContexts;var d=s.unrestrictedViews;Object.entries(l).forEach(function(t){var o=t[0];var s=t[1];s.variants=s.variants.concat(d);var l=s.contextBasedAdaptationId;var c={id:l,title:A.getText("CBA_MIGRATED_ADAPTATION_TITLE",[o]),contexts:{role:[o]},priority:0};i.contextBasedAdaptations.push(c);var p=s.variants.filter(function(e){return e.getLayer()===f.CUSTOMER});var u=new Map;var y=N(p,u,l);y.forEach(function(e){i.flexObjects.push(e.convertToFileContent())});var v=s.variants.map(function(e){return e.getId()});var g=e.map(function(e){return e.getId()}).filter(function(e){return v.indexOf(e)<0});var h=B(g,n);var I=_(h,u,l);I.forEach(function(e){i.flexObjects.push(e.convertToFileContent())});e.forEach(function(e){if(e.getLayer()!==f.CUSTOMER&&v.indexOf(e.getId())<0){i.flexObjects.push(O(e,r,l,a))}})});e.forEach(function(e){var t=o[e.getId()];var n=d.indexOf(e)<0;if(t.visible===true&&n){i.flexObjects.push(O(e,r,undefined,a))}});return i}function D(){return new Promise(function(e){sap.ui.require(["sap/ui/fl/variants/VariantManager"],function(t){e(t)})})}x.migrate=async function(e){e.appId=m(e.control);var t=S(e);e.parentVersion=t;var a=[];var i=n.getAllVariants(r.getFlexReferenceForControl(e.control));var o={contextBasedAdaptation:[],flexObjects:[]};const s=await D();return l.getFlexObjects({selector:e.control,includeManifestChanges:true,includeAnnotationChanges:true,includeCtrlVariants:true,includeDirtyChanges:true}).then(function(e){I.forEach(function(t){a.push(E(e,t,true))});a.push(E(e,f.CUSTOMER,false));return Promise.all(a)}).then(function(t){var n=t.pop();var r=t.flat();o=R(r,i,n,e,s);var a=Promise.resolve();o.contextBasedAdaptations.forEach(function(t){a=a.then(P.bind(this,e,t))}.bind(this));return a}.bind(this)).then(function(){if(o.flexObjects.length>0){return w(e,o.flexObjects)}return Promise.resolve()}).then(function(){return this.refreshAdaptationModel({control:e.control,layer:e.layer})}.bind(this))};x.canMigrate=function(e){var t=x.getAdaptationsModel(e);if(t.getProperty("/count")!==0){return Promise.resolve(false)}return l.getFlexObjects({selector:e.control,invalidateCache:false,includeCtrlVariants:true,includeDirtyChanges:true}).then(function(t){var a=[];I.forEach(function(e){a.push(E(t,e,true))});a=a.flat();var i=n.getAllVariants(r.getFlexReferenceForControl(e.control));return a.some(function(e){var n=j(i,t,e);return n.visible===true&&Object.keys(n.contexts).some(function(e){return n.contexts[e].length!==0})})})};x.create=function(e){if(!e.layer){return Promise.reject("No layer was provided")}if(!e.control){return Promise.reject("No control was provided")}if(!e.contextBasedAdaptation){return Promise.reject("No contextBasedAdaptation was provided")}e.contextBasedAdaptation.id=v.createDefaultFileName();e.appId=m(e.control);return P.call(this,e,e.contextBasedAdaptation).then(function(){return l.getFlexObjects({selector:e.control,includeManifestChanges:true,includeAnnotationChanges:true,invalidateCache:false,includeCtrlVariants:true,includeDirtyChanges:true,currentLayer:f.CUSTOMER})}).then(function(t){var n=y.filterChangeOrChangeDefinitionsByCurrentLayer(t,f.CUSTOMER);var r=T(n,e.contextBasedAdaptation.id);return w(e,r)})};x.update=function(e){if(!e.layer){return Promise.reject("No layer was provided")}if(!e.control){return Promise.reject("No control was provided")}if(!e.contextBasedAdaptation){return Promise.reject("No contextBasedAdaptation was provided")}if(!e.adaptationId){return Promise.reject("No adaptationId was provided")}e.appId=m(e.control);return d.contextBasedAdaptation.update({layer:e.layer,flexObject:e.contextBasedAdaptation,appId:e.appId,adaptationId:e.adaptationId,parentVersion:S(e)}).then(function(t){return C(t,e)})};x.reorder=function(e){if(!e.layer){return Promise.reject("No layer was provided")}if(!e.control){return Promise.reject("No control was provided")}if(!e.parameters||!e.parameters.priorities){return Promise.reject("No valid priority list was provided")}e.appId=m(e.control);return d.contextBasedAdaptation.reorder({layer:e.layer,flexObjects:e.parameters,appId:e.appId,parentVersion:S(e)}).then(function(t){return C(t,e)})};x.load=function(e){if(!e.layer){return Promise.reject("No layer was provided")}if(!e.control){return Promise.reject("No control was provided")}e.appId=m(e.control);return d.contextBasedAdaptation.load({layer:e.layer,appId:e.appId,version:S(e)}).then(function(e){e||={adaptations:[]};return e})};x.remove=function(e){if(!e.layer){return Promise.reject("No layer was provided")}if(!e.control){return Promise.reject("No control was provided")}if(!e.adaptationId){return Promise.reject("No adaptationId was provided")}e.appId=m(e.control);return d.contextBasedAdaptation.remove({layer:e.layer,appId:e.appId,adaptationId:e.adaptationId,parentVersion:S(e)}).then(function(t){return C(t,e,true)})};return x});
//# sourceMappingURL=ContextBasedAdaptationsAPI.js.map