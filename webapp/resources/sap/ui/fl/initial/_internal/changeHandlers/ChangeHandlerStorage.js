/*!
* OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
*/
sap.ui.define(["sap/base/util/each","sap/base/Log","sap/ui/fl/Layer","sap/ui/fl/requireAsync"],function(e,n,r,t){"use strict";const a={};let o={};let l={};let i={};let s={};const c="defaultForAll";const u={VENDOR:true,CUSTOMER_BASE:true,CUSTOMER:true,PUBLIC:false,USER:false};const f={VENDOR:true,CUSTOMER_BASE:true,CUSTOMER:false,PUBLIC:false,USER:false};function h(e){if(!e.changeHandler){n.error("sap.ui.fl.registry.ChangeRegistryStorage: changeHandler required");return false}return true}async function g(e){if(typeof e.changeHandler==="string"){const n=await t(e.changeHandler.replace(/\./g,"/"));e.changeHandler=n}return e.changeHandler}function d(e,n){let r={};if(!n||!n.changeHandler){r.changeHandler=n}else{r=n}if(r.changeHandler==="default"){r.changeHandler=i.defaultChangeHandlers[e]}else if(Object.keys(i.developerChangeHandlers||{}).includes(e)){throw Error(`You can't use a custom change handler for the following Developer Mode change type: ${e}. Please use 'default' instead.`)}return r}function y(n){l={};e(n,function(e,n){const r={controlType:"defaultActiveForAll",changeHandler:n,layers:{...f},changeType:e};l[e]=r})}function p(n,r,t){t=d(r,t);const a={...u};if(t.layers){e(t.layers,function(e,n){if(a[e]===undefined){throw Error(`The Layer '${e}' is not supported. Please only use supported layers`)}a[e]=n})}const o={controlType:n,changeHandler:t.changeHandler,layers:a,changeType:r};return h(o)?o:undefined}function C(e,n,r){const t=p(e,n,r);if(t){o[e]||={};o[e][n]=t}}function H(r,a){let o=Promise.resolve(a);const l="ChangeHandlerStorage.registerChangeHandlersForControl.skip_next_then";if(typeof a==="string"){o=new Promise(e=>{setTimeout(()=>{t(`${a}.flexibility`).then(e).catch(function(t){n.error(`Flexibility change handler registration failed.\nControlType: ${r}\n${t.message}`);e(l)})},0)})}return o.then(function(n){if(n!==l){e(n,function(e,n){C(r,e,n)})}}).catch(function(e){n.error(e.message)})}function E(e,n,t){const a=o[e]&&o[e][n]||l[n];if(!a){throw Error("No Change handler registered for the Control and Change type")}t=t===r.PUBLIC?r.USER:t;if(!a.layers[t]){throw Error(`Change type ${n} not enabled for layer ${t}`)}return a}function T(e,r,a,o){const l=o.getChangeHandlerModulePath(a);if(typeof l!=="string"){return Promise.resolve(undefined)}return t(l).then(function(n){const t=n[e];if(t){return p(r,e,t)}}).catch(function(e){n.error(`Flexibility registration for control ${o.getId(a)} failed to load module ${l}\n${e.message}`)})}a.getChangeHandler=function(e,n,r,t,a){return T(e,n,r,t).then(function(r){const t=r||E(n,e,a);return g(t)}).then(function(e){if(typeof e.completeChangeContent!=="function"||typeof e.applyChange!=="function"||typeof e.revertChange!=="function"){throw new Error("The ChangeHandler is either not available or does not have all required functions")}return e})};a.registerPredefinedChangeHandlers=function(e,n){i.defaultChangeHandlers=e;i.developerChangeHandlers=n;y(n)};a.registerChangeHandlersForLibrary=function(n){const r=[];e(n,function(e,n){r.push(H(e,n))});return Promise.all(r)};a.clearAll=function(){o={};l={};i={};s={}};a.registerChangeHandlersForControl=function(e,n){return H(e,n)};a.registerAnnotationChangeHandler=function(e){const n=e.isDefaultChangeHandler?c:e.changeType;s[n]={changeHandler:e.changeHandler}};a.getAnnotationChangeHandler=function(e){const n=s[e.changeType]||s[c];if(!n){throw Error("No Annotation Change handler registered for the Change type and Model type")}return g(n)};return a});
//# sourceMappingURL=ChangeHandlerStorage.js.map