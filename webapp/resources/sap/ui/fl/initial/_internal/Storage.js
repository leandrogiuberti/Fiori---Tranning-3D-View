/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_merge","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/initial/_internal/storageResultDisassemble","sap/ui/fl/initial/_internal/StorageFeaturesMerger","sap/ui/fl/initial/_internal/StorageResultMerger","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/Layer"],function(e,n,t,r,a,o,s){"use strict";function i(e,t){const r=t.map(function(t){const r={...e,url:t.url,path:t.path};const a=n.getByReference(e.reference);if(!t.layers||t.layers[0]!=="ALL"&&t.layers.indexOf(s.CUSTOMER)===-1){delete r.version}else{if(a.initialAllContexts){r.allContexts=true}if(!r.version&&a.version){r.version=a.version}}const i=!!Object.keys(window.sessionStorage).filter(e=>e.startsWith("sap.ui.rta.restart.")).length;if(!i&&!a.saveChangeKeepSession){n.removeByReference(e.reference)}if(r.version){delete r.cacheKey}return t.loadConnectorModule.loadFlexData(r).then(function(e){return e||o.getEmptyFlexDataResponse()}).catch(o.logAndResolveDefault.bind(undefined,o.getEmptyFlexDataResponse(),t,"loadFlexData"))});return Promise.all(r)}function l(e){var n=[];e.forEach(function(e){if(Array.isArray(e)){n=n.concat(e)}else{n.push(e)}});return n}function u(e){return e.map(function(e){return t(e)})}function c(e){return Promise.resolve(e).then(l).then(u).then(l).then(a.merge)}function f(e){return o.getStaticFileConnector().then(i.bind(this,e))}function d(e){var n=e.map(function(e){if(!e?.loadConnectorModule?.loadFeatures){return Promise.resolve(o.logAndResolveDefault({features:{},layers:e.layers},e,"loadFeatures"))}return e.loadConnectorModule.loadFeatures({url:e.url}).then(function(n){return{features:n,layers:e.layers}}).catch(o.logAndResolveDefault.bind(null,{features:{},layers:e.layers},e,"loadFeatures"))});return Promise.all(n)}async function h(n,t){const r=await Promise.all(t.map(function(e){if(!e?.loadConnectorModule?.loadVariantsAuthors){return Promise.resolve(o.logAndResolveDefault({},e,"loadVariantsAuthors"))}const t={reference:n,url:e.url};return e.loadConnectorModule.loadVariantsAuthors(t).then(e=>e||{}).catch(o.logAndResolveDefault.bind(undefined,{},e,"loadVariantsAuthors"))}));return e({},...r)}var p={};p.loadFeatures=function(){return o.getLoadConnectors().then(d).then(r.mergeResults)};p.completeFlexData=function(e){if(!e||!e.reference){return Promise.reject("No reference was provided")}return Promise.all([f(e),e.partialFlexData]).then(c)};p.loadFlexData=function(e){if(!e||!e.reference){return Promise.reject("No reference was provided")}return o.getLoadConnectors(e.skipLoadBundle).then(i.bind(this,e)).then(c)};p.loadVariantsAuthors=function(e){if(!e){return Promise.reject("No reference was provided")}return o.getLoadConnectors().then(h.bind(this,e))};p.loadFlVariant=async function(e){const n=await o.getLoadConnectors();const t=[];for(const r of n){if(r?.loadConnectorModule?.loadFlVariant){const n={...e,url:r.url,layers:r.layers};try{t.push(await r.loadConnectorModule.loadFlVariant(n))}catch(e){t.push({})}}}const r=["variants","variantChanges","variantDependentControlChanges"];return t.reduce((e,n)=>{r.forEach(t=>{if(n[t]){e[t]=[...e[t]||[],...n[t]]}});return e},{})};return p});
//# sourceMappingURL=Storage.js.map