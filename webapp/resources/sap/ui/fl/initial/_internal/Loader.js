/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/Deferred","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/base/ManagedObject","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/initial/_internal/Settings","sap/ui/fl/initial/_internal/Storage","sap/ui/fl/initial/_internal/StorageUtils"],function(e,t,a,n,i,r,s,o,c,l){"use strict";const d={};const f={};const p={};function u(e){if(typeof e==="string"){e={id:e}}e.idIsLocal=true;return e}function m(e,t){if(s.getOvpEntry(e)){[t.changes,t.variantChanges,t.variantDependentControlChanges,t.variantManagementChanges].flat().filter(e=>e.selector&&!e.selector.idIsLocal).forEach(function(e){e.selector=u(e.selector);if(e.dependentSelector){Object.keys(e.dependentSelector).forEach(t=>{const a=e.dependentSelector[t];if(Array.isArray(a)){e.dependentSelector[t]=a.map(u)}else{e.dependentSelector[t]=u(a)}})}})}return t}function g(e){l.getAllFlexObjectNamespaces().forEach(function(t){const n=a.get(t,e);if(n){a.set(t,n.filter(e=>{let t;try{t=new i(e.fileName)}catch(e){return false}t.destroy();return true}),e)}});return e}function h(e){if(e?.startupParameters&&Array.isArray(e.startupParameters.hcpApplicationId)){return e.startupParameters.hcpApplicationId[0]}}function v(e){const t="deactivateChanges";const n=e.changes.map(e=>{if(e.changeType===t){return[e.fileName,...e.content.changeIds]}}).flat().filter(Boolean);if(n.length){l.getAllFlexObjectNamespaces().forEach(function(t){const i=a.get(t,e);if(i.length){a.set(t,i.filter(e=>!n.includes(e.fileName)),e)}})}return e}p.getFlexData=async function(a){let n=r.getByReference(a.reference);const i=t({},a,{version:n.version,adaptationId:n.displayedAdaptationId,allContextsProvided:n.allContextsProvided});const l=i.reference;const p=f[l];const u=new e;f[l]=u;if(p){await p.promise}const y=a.reInitialize||!d[a.reference]||d[l].parameters.emptyState||d[l].parameters.version!==i.version||d[l].parameters.allContextsProvided!==i.allContextsProvided||d[l].parameters.adaptationId!==i.adaptationId;const I=d[l]&&!d[l].parameters.emptyState&&d[l].parameters.bundleNotLoaded&&!i.skipLoadBundle;if(!y&&!I){u.resolve();return{data:d[l].data,cacheInvalidated:false}}let C;let x;const b=s.getBaseComponentNameFromManifest(i.manifest);if(y){const e=i.reInitialize?undefined:s.getCacheKeyFromAsyncHints(l,i.asyncHints);C=await c.loadFlexData({preview:s.getPreviewSectionFromAsyncHints(i.asyncHints),reference:l,componentName:b,cacheKey:e,siteId:h(i.componentData),appDescriptor:i.manifest.getRawJson?i.manifest.getRawJson():i.manifest,version:i.version,adaptationId:i.adaptationId,skipLoadBundle:i.skipLoadBundle});const t=await o.getInstance();x=t.getIsVariantAuthorNameAvailable()?await c.loadVariantsAuthors(l):{}}else{C=await c.completeFlexData({reference:l,componentName:b,partialFlexData:d[l].data.changes});x=d[l].data.authors}const F=Object.assign({},C);v(F);g(F);m(i.manifest,F);const w={changes:F,cacheKey:F.cacheKey,authors:x};d[l]={data:w,parameters:{bundleNotLoaded:!!i.skipLoadBundle,version:i.version,allContextsProvided:i.allContextsProvided,adaptationId:i.adaptationId}};if(w.changes.info!==undefined){n={...n,...w.changes.info}}r.setByReference(n,l);u.resolve();return{data:w,cacheInvalidated:true}};p.initializeEmptyCache=function(e){const t={changes:l.getEmptyFlexDataResponse()};d[e]={data:t,parameters:{bundleNotLoaded:true,emptyState:true}};return t};p.clearCache=function(e){if(e){delete d[e];delete f[e]}else{Object.keys(d).forEach(e=>{delete d[e];delete f[e]})}};p.loadFlVariant=async function(e){const t=await c.loadFlVariant({variantReference:e.variantReference,reference:e.reference});Object.entries(t).forEach(([t,a])=>{d[e.reference].data.changes[t].push(...a)});return{newData:t,completeData:d[e.reference].data}};p.updateCachedResponse=function(e,t){l.updateStorageResponse(d[e].data,t)};p.getCachedFlexData=function(e){return d[e]?.data||{}};p.waitForInitialization=function(e){const t=f[e]?.promise;if(!t){n.error("Loader.waitForInitialization was called before FlexState.initialize");return Promise.resolve()}return t};p.setAllContextsProvided=function(e,t){if(d[e]&&d[e].parameters.allContextsProvided===undefined){d[e].parameters.allContextsProvided=t}};return p});
//# sourceMappingURL=Loader.js.map