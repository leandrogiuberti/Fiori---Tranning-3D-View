/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/util/extend","sap/base/util/ObjectPath","sap/ui/VersionInfo","sap/ui/core/Lib","sap/ui/core/Supportability","sap/ui/support/supportRules/RuleSet","sap/ui/support/supportRules/CommunicationBus","sap/ui/support/supportRules/WCBChannels","sap/ui/support/supportRules/RuleSerializer","sap/ui/support/supportRules/Constants","sap/ui/support/supportRules/util/EvalUtils","sap/ui/support/supportRules/util/Utils","sap/ui/thirdparty/jquery"],function(e,i,r,t,u,s,n,a,l,o,p,c,f,jQuery){"use strict";var h=function(){var e;return function(i){if(!e){e=document.createElement("a")}e.href=i;return e.href.replace(/\/$/,"")}}();var R="sprt";var b=sap.ui.require.toUrl("sap/ui/support");var L=b.replace("/sap/ui/support","");var _=h(L);var m={};m._mRuleLibs={};m._mRequireRuleLibs={};m.getRuleLibs=function(){return this._mRuleLibs};m.addRuleLib=function(e,i){this._mRuleLibs[e]=i};m.getRuleLib=function(e){return this._mRuleLibs[e]};m._fetchSupportRuleSets=function(e,i){var r=i||u.all(),s=this._fetchLibraryNamesWithSupportRules(r);return t.load({library:"sap.ui.core"}).then(function(e){n.versionInfo=e;return s}).then(function(e){return Promise.all(this._fetchLibraryFiles(e,this._fetchRuleLib))}.bind(this)).then(function(){this._bRulesCreated=true;a.publish(l.UPDATE_SUPPORT_RULES,{sRuleSet:o.serialize(this._mRuleLibs),oVersionInfo:n.versionInfo});if(e&&typeof e==="function"){e()}}.bind(this))};m.loadAdditionalRuleSets=function(e){var i=this,r=i._fetchLibraryFiles(e,i._fetchRuleLib);Promise.all(r).then(function(){i._bRulesCreated=true;a.publish(l.UPDATE_SUPPORT_RULES,{sRuleSet:o.serialize(i._mRuleLibs)})})};m._fetchLibraryNamesWithSupportRules=function(e){return new Promise(function(i){f.canLoadInternalRulesAsync().then(function(r){var t={publicRules:[],internalRules:[],allRules:[]};e=e||{};var u=[];Object.keys(e).forEach(function(e){var i=new Promise(function(i){var r=_+"/"+e.replace(/\./g,"/")+"/.supportrc";jQuery.ajax({type:"GET",dataType:"json",url:r,success:function(r){i({lib:e,rcData:r})},error:function(){i({lib:e,rcData:null})}})});u.push(i)});Promise.all(u).then(function(e){e.forEach(function(e){if(e.rcData){var u=false;if(e.rcData.publicRules){t.publicRules.push(e.lib);u=true}if(r&&e.rcData.internalRules){t.internalRules.push(e.lib);u=true}if(u&&t.allRules.indexOf(e.lib)<0){t.allRules.push(e.lib)}}i(t)})})})})};m._fetchLibraryFiles=function(e,i){var r=[],t=sap.ui.require.toUrl("sap/ui/support"),u=t.replace("sap/ui/support",""),n=f.canLoadInternalRules(),o=n&&e.internalRules.length>0,p=0,c=e.publicRules.length;var h=s.getSupportSettings();var R=h&&h.indexOf("silent")>-1;if(o){c+=e.internalRules.length}function b(){p+=1;var e=Math.ceil(p/c*100);a.publish(l.CURRENT_LOADING_PROGRESS,{value:e})}if(e.publicRules.length>0){e.publicRules.forEach(function(e){var s=this._registerLibraryPath(e,t,u).customizableLibName;if(this._mRequireRuleLibs[s]){return}var n=this._requireRuleLib(s,i);if(!R){n.then(function(){b()})}this._mRequireRuleLibs[s]=n;r.push(n)}.bind(this))}if(n&&e.internalRules.length>0){e.internalRules.forEach(function(e){var s=this._registerLibraryPath(e,t,u).internalLibName;if(this._mRequireRuleLibs[s]){return}var n=this._requireRuleLib(s,i);if(!R){n.then(function(){b()})}this._mRequireRuleLibs[s]=n;r.push(n)}.bind(this))}return r};m._registerLibraryPath=function(e,i,r){var t=e.replace(/\./g,"/");var u=t;var s=this._getLoadFromSupportOrigin();var n={};if(s){u+="/"+R;n[u]=r+t}var a=u+"/internal";var l=r.replace("resources/","")+"test-resources/"+t+"/internal";n[a]=l;sap.ui.loader.config({paths:n});return{internalLibName:a.replace(/\//g,"."),customizableLibName:u.replace(/\//g,".")}};m._requireRuleLib=function(e,i){var r=this;return new Promise(function(t){try{sap.ui.require([e.replace(/\./g,"/")+"/library.support"],function(u){i.call(r,e,u);t()},t)}catch(e){t()}})};m._fetchRuleLib=function(t,u){try{var s=t.replace("."+R,"").replace(".internal",""),a=this._mRuleLibs[s];if(u==null){u=r.get(t).library.support;if(u){e.error(`The ruleset for library '${t}' could only be retrieved via globals.`+`This is deprecated and won't be supported in future releases`)}}if(!u){throw"The library.support file was not fetched successfully or doesn't export a value."}if(a){a.ruleset.mergeRuleSet(u.ruleset);return}if(u.ruleset instanceof n){a=i({},u)}else{a=this._createRuleLib(u)}this.addRuleLib(s,a)}catch(i){e.error("["+p.SUPPORT_ASSISTANT_NAME+"] Failed to load RuleSet for "+t+" library",i)}};m._getLoadFromSupportOrigin=function(){var e=new URL(sap.ui.require.toUrl("sap/ui/core"),document.baseURI);var i=new URL(sap.ui.require.toUrl("sap/ui/support"),document.baseURI);return e.origin!==i.origin};m.fetchNonLoadedRuleSets=function(e){t.load().then(function(e){var i={};e.libraries.forEach(function(e){i[e.name]=e});return this._fetchLibraryNamesWithSupportRules(i)}.bind(this)).then(function(i){var r=[];i.allRules.forEach(function(i){if(e.indexOf(i)<0){r.push(i)}});a.publish(l.POST_AVAILABLE_LIBRARIES,{libNames:r})})};m._onLibraryChanged=function(e){if(e.getParameter("stereotype")==="library"&&this._bRulesCreated){this._oMainPromise=this._fetchSupportRuleSets()}};m.updateRuleSets=function(e){this._oMainPromise=this._fetchSupportRuleSets(e)};m._createRuleLib=function(e){var i={name:e.name,niceName:e.niceName};var r=new n(i);r.mergeRuleSet(e.ruleset);return{lib:i,ruleset:r}};m.getAllRules=function(){var e={};Object.keys(this._mRuleLibs).map(function(r){e=i(e,this._mRuleLibs[r].ruleset.getRules())},this);return e};m.getAllRuleDescriptors=function(){var e=this.getAllRules();return Object.keys(e).map(function(i){return{libName:e[i].libName,ruleId:i}})};if(c.isEvalAllowed()){m.addRuleLib(p.TEMP_RULESETS_NAME,{lib:{name:p.TEMP_RULESETS_NAME},ruleset:new n({name:p.TEMP_RULESETS_NAME})})}return m},true);
//# sourceMappingURL=RuleSetLoader.js.map