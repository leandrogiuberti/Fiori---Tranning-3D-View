/*!
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/model/Context","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/VariantItem","sap/m/VariantManagement","sap/ui/core/Control","sap/ui/core/Lib","sap/ui/core/library","sap/base/Log","./SmartVariantManagementModel","sap/ui/model/BindingMode"],function(e,t,o,a,n,r,i,s,l,p,d){"use strict";const{TitleLevel:u}=s;const c={defaultVariantKey:"defaultVariant",editable:"variantsEditable",headerLevel:"headerLevel",selectionKey:"currentVariant",showExecuteOnSelection:"showExecuteOnSelection",showSetAsDefault:"supportDefault",showShare:"supportPublic",standardItemText:"standardItemText",titleStyle:"titleStyle",useFavorites:"showFavorites",variantCreationByUserAllowed:"creationAllowed"};const h={creationAllowed:"creationAllowed",supportDefault:"supportDefault",headerLevel:"level",titleStyle:"titleStyle",variantsEditable:"showFooter",showExecuteOnSelection:"supportApplyAutomatically",supportPublic:"supportPublic",showFavorites:"supportFavorites",modified:"modified",defaultVariant:"defaultKey",currentVariant:"selectedKey"};const y=["selectedKey"];const f=r.extend("sap.ui.comp.smartvariants.SmartVariantManagementMediator",{metadata:{interfaces:["sap.ui.core.IShrinkable","sap.m.IOverflowToolbarContent","sap.m.IToolbarInteractiveControl"],library:"sap.ui.comp",designtime:"sap/ui/comp/designtime/smartvariants/SmartVariantManagementMediator.designtime",properties:{defaultVariantKey:{type:"string",group:"Misc",defaultValue:null},displayTextForExecuteOnSelectionForStandardVariant:{type:"string",group:"Misc",defaultValue:""},editable:{type:"boolean",group:"Misc",defaultValue:true},enabled:{type:"boolean",group:"Misc",defaultValue:true},executeOnSelectionForStandardDefault:{type:"boolean",group:"Misc",defaultValue:false},headerLevel:{type:"sap.ui.core.TitleLevel",group:"Appearance",defaultValue:u.Auto},inErrorState:{type:"boolean",group:"Misc",defaultValue:false},maxWidth:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},modelName:{type:"string",group:"Misc",defaultValue:""},selectionKey:{type:"string",group:"Misc",defaultValue:null},showCreateTile:{type:"boolean",group:"Misc",defaultValue:false},showExecuteOnSelection:{type:"boolean",group:"Misc",defaultValue:false},showSetAsDefault:{type:"boolean",group:"Misc",defaultValue:true},showShare:{type:"boolean",group:"Misc",defaultValue:false},standardItemText:{type:"string",group:"Misc",defaultValue:null},titleStyle:{type:"sap.ui.core.TitleLevel",group:"Appearance",defaultValue:u.Auto},useFavorites:{type:"boolean",group:"Misc",defaultValue:false},variantCreationByUserAllowed:{type:"boolean",group:"Misc",defaultValue:true}},events:{cancel:{},manage:{parameters:{renamed:{type:"object[]"},deleted:{type:"string[]"},exe:{type:"object[]"},fav:{type:"object[]"},def:{type:"string"},contexts:{type:"object[]"}}},save:{parameters:{name:{type:"string"},overwrite:{type:"boolean"},key:{type:"string"},execute:{type:"boolean"},public:{type:"boolean"},def:{type:"boolean"},contexts:{type:"object[]"},global:{type:"boolean"}}},select:{parameters:{key:{type:"string"}}}},associations:{for:{type:"sap.ui.core.Control",multiple:true}},defaultAggregation:"variantItems",aggregations:{variantItems:{type:"sap.m.VariantItem",multiple:true},_embeddedVM:{type:"sap.m.VariantManagement",multiple:false,visibility:"hidden"}}},renderer:{apiVersion:2,render(e,t){e.openStart("div",t);e.style("max-width",t.getMaxWidth());e.openEnd();e.renderControl(t._oVM);e.close("div")}}});f.prototype.init=function(){r.prototype.init.apply(this);this.oModel=new p;this.setModel(this.oModel,"$sVM");this.setModelName(p.getDefaultModelName());this.oResourceBundle=i.getResourceBundleFor("sap.ui.comp");this.STANDARDVARIANTKEY="*standard*";this._createEmbeddedVM();this.attachModelContextChange(this._setBindingContext,this);this._setBindingContext()};f.prototype._createEmbeddedVM=function(){this._oVM=new n(`${this.getId()}-vm`);this.setAggregation("_embeddedVM",this._oVM,true);this._oVM.attachManage(this._onManage,this);this._oVM.attachSave(this._onSave,this);this._oVM.attachSelect(this._onSelect,this)};f.prototype._destroyEmbeddedVM=function(){if(this._oVM){this._oVM.detachManage(this._onManage,this);this._oVM.detachSave(this._onSave,this);this._oVM.detachSelect(this._onSelect,this);this._oVM.destroy();this._oVM=undefined}};f.prototype._setBindingContext=function(){const t=this.getModelName();if(!this.oContext&&t===p.getDefaultModelName()){const o=this.getModel(t);if(o){this.oContext=new e(o,p.getDefaultContextPath());this.setBindingContext(this.oContext,t);this._oVM.setModel(o,t);this._createItemsModel(t);const a=Object.entries(h).map(([e,t])=>({nameInModel:e,nameInVariantMangement:t}));this._bindPropertiesToVM(t,a,this._oVM);this.setPopoverTitle(this.oResourceBundle.getText("VARIANT_MANAGEMENT_VARIANTS"))}}};f.prototype._bindPropertiesToVM=function(e,t,o=this._oVM){if(!e||!t?.length){return}t.forEach(t=>{const a={};if(y.includes(t.nameInVariantMangement)){a.mode=d.TwoWay}o.bindProperty(t.nameInVariantMangement,{path:`${this.oContext}/${t.nameInModel}`,model:e,...a})})};f.prototype._createItemsModel=function(e){this._oItemsTemplate=new a({key:`{${e}>key}`,title:`{${e}>title}`,sharing:`{${e}>sharing}`,remove:`{${e}>remove}`,favorite:`{${e}>favorite}`,executeOnSelect:`{${e}>executeOnSelect}`,rename:`{${e}>rename}`,visible:`{${e}>visible}`,changeable:`{${e}>changeable}`,author:`{${e}>author}`,contexts:`{${e}>contexts}`});this._oVM.bindAggregation("items",{path:`${this.oContext}/variants`,model:e,template:this._oItemsTemplate,filters:new t({path:"visible",operator:o.EQ,value1:true})})};f.prototype.resolveTitleBindings=function(e){const t=[];this.oModel.prepareVariantsForTitleBindings(this.oContext?.sPath,e).forEach(o=>{const a=this.getModel(o.sResourceModel);if(a){const e=a.getResourceBundle().getText(o.sResourceKey);this.oModel.reorderVariants(o.key,e,-1)}else if(t.indexOf(o.sResourceModel)<0){t.push(o.sResourceModel);this.attachEventOnce("modelContextChange",this.resolveTitleBindings.bind(this,e))}})};f.prototype._onManage=function(e){const t=e.getParameters();this.fireManage(t)};f.prototype._onSave=function(e){const t=e.getParameters();if(t.hasOwnProperty("execute")){t.exe=t.execute}if(t.hasOwnProperty("public")){t.global=t.public}this.fireSave(t)};f.prototype._onSelect=function(e){this.fireSelect(e.getParameters())};f.prototype._checkUpdate=function(){this.oModel.checkUpdate(true)};f.prototype._getIdxSorted=function(e){return this.oModel.getIdxSorted(e)};f.prototype._reapplyExecuteOnSelectForStandardVariantItem=function(e){const t=this.getStandardVariantKey();const o=this.oModel.getVariants();const a=this.oModel.findVariantIndex(t,-1);if(a>-1){o[a]["executeOnSelect"]=e;o[a]["originalExecuteOnSelect"]=e;this.oModel.setVariants(o)}};f.prototype._removeViewItem=function(e){this.oModel.removeVariant(e)};f.prototype._reorderList=function(e,t){this.oModel.reorderVariants(e,t)};f.prototype._updateView=function(e,t,o){this.oModel.updateView(e,t,o)};f.prototype._setPropertyAlsoInModel=function(e,t){const o=c[e];this._setPropertyInModel(o,t);return this.setProperty(e,t)};f.prototype._setPropertyInModel=function(e,t){this.oModel._setProperty(e,t,this.oContext?.path)};f.prototype.getCurrentVariantKey=function(){return this.getSelectionKey()};f.prototype.setCurrentVariantKey=function(e){return this.setSelectionKey(e)};f.prototype.setDefaultVariantKey=function(e){return this._setPropertyAlsoInModel("defaultVariantKey",e)};f.prototype.setEditable=function(e){return this._setPropertyAlsoInModel("editable",e)};f.prototype.setHeaderLevel=function(e){return this._setPropertyAlsoInModel("headerLevel",e)};f.prototype.getModified=function(){return this.oModel.getModified(this.oContext?.sPath)};f.prototype.setModified=function(e){this.oModel.setModified(e,this.oContext?.sPath)};f.prototype.getSelectionKey=function(){return this.oModel.getCurrentVariant(this.oContext?.sPath)};f.prototype.setSelectionKey=function(e){return this._setPropertyAlsoInModel("selectionKey",e)};f.prototype.setShowExecuteOnSelection=function(e){return this._setPropertyAlsoInModel("showExecuteOnSelection",e)};f.prototype.setShowSetAsDefault=function(e){return this._setPropertyAlsoInModel("showSetAsDefault",e)};f.prototype.setShowShare=function(e){return this._setPropertyAlsoInModel("showShare",e)};f.prototype.setStandardItemText=function(e){return this._setPropertyAlsoInModel("standardItemText",e)};f.prototype.setTitleStyle=function(e){return this._setPropertyAlsoInModel("titleStyle",e)};f.prototype.setUseFavorites=function(e){return this._setPropertyAlsoInModel("useFavorites",e)};f.prototype.setVariantCreationByUserAllowed=function(e){return this._setPropertyAlsoInModel("variantCreationByUserAllowed",e)};f.prototype.getVariantItems=function(){return this.getVariants()};f.prototype.getItemByKey=function(e){const t=this.getVariantItems();for(let o=0;o<t.length;o++){if(e==t[o].getKey()){return t[o]}}return null};f.prototype._getEmbeddedVM=function(){return this._oVM};f.prototype._assignUser=function(e,t){const o=this._oVM.getItemByKey(e);if(!o){return}o.setAuthor(t)};f.prototype.currentVariantGetModified=function(){return this.getModified()};f.prototype.currentVariantSetModified=function(e){this.setModified(e)};f.prototype.setDisplayTextForExecuteOnSelectionForStandardVariant=function(e){this.setProperty("displayTextForExecuteOnSelectionForStandardVariant",e);this._oVM.setDisplayTextForExecuteOnSelectionForStandardVariant(e);return this};f.prototype.setEnabled=function(e){this.setProperty("enabled",e);const t=this._oVM.oVariantLayout.getContent();if(!e){t[0].removeStyleClass("sapMVarMngmtClickable");t[0].addStyleClass("sapMVarMngmtDisabled");t[1].addStyleClass("sapMVarMngmtDisabled");t[2].removeStyleClass("sapMVarMngmtClickable");t[2].addStyleClass("sapMVarMngmtDisabled");this._oVM.bPopoverOpen=true}else{t[0].removeStyleClass("sapMVarMngmtDisabled");t[0].addStyleClass("sapMVarMngmtClickable");t[1].removeStyleClass("sapMVarMngmtDisabled");t[2].removeStyleClass("sapMVarMngmtDisabled");t[2].addStyleClass("sapMVarMngmtClickable");this._oVM.bPopoverOpen=false}return this};f.prototype.getFocusDomRef=function(){if(this._oVM){return this._oVM.oVariantPopoverTrigger.getFocusDomRef()}return null};f.prototype.getInErrorState=function(){return this._oVM.getInErrorState()};f.prototype.setInErrorState=function(e){const t=this._oVM.getTitle();if(e&&t&&!t.getText()){t.setText(this._determineStandardVariantName())}this.setProperty("inErrorState",e);this._oVM.setInErrorState(e);return this};f.prototype._determineStandardVariantName=function(){let e=this.oResourceBundle.getText("VARIANT_MANAGEMENT_STANDARD");if(this.oModel.getDefaultVariant()===this.STANDARDVARIANTKEY&&this.getStandardItemText()){e=this.getStandardItemText()}return e};f.prototype.setPopoverTitle=function(e){this._oVM.setPopoverTitle(e);return this};f.prototype.getShowAsText=function(){return this._oVM.getShowAsText()};f.prototype.setShowAsText=function(e){this._oVM.setShowAsText(e);return this};f.prototype.setShowCreateTile=function(e){this.setProperty("showCreateTile",e);this._oVM._setShowCreateTile(e);return this};f.prototype.getShowCreateTile=function(){return this._oVM._getShowCreateTile()};f.prototype.getStandardVariantKey=function(){return this._oVM.getStandardVariantKey()};f.prototype.setStandardVariantKey=function(e){this._oVM.setStandardVariantKey(e)};f.prototype._setStandardVariantKey=function(e){this._oVM.setStandardVariantKey(e)};f.prototype.getVariants=function(){return this._oVM?this._oVM.getItems():[]};f.prototype.getVariantByKey=function(e){return this._oVM?this._oVM._getItemByKey(e):null};f.prototype._createSaveAsDialog=function(){this._oVM._createSaveAsDialog()};f.prototype._handleVariantSaveAs=function(e){this._oVM._handleVariantSaveAs(e)};f.prototype.openManagementDialog=function(e,t,o){this._oVM.openManagementDialog(e,t,o)};f.prototype._destroyManageDialog=function(){if(this._oVM){this._oVM.destroyManageDialog()}};f.prototype.registerApplyAutomaticallyOnStandardVariant=function(e){this._fRegisteredApplyAutomaticallyOnStandardVariant=e;return this};f.prototype.getApplyAutomaticallyOnVariant=function(e){let t=false;if(e){t=e.executeOnSelect;if(this._fRegisteredApplyAutomaticallyOnStandardVariant&&this.getDisplayTextForExecuteOnSelectionForStandardVariant()&&e.key===this.getStandardVariantKey()){try{t=this._fRegisteredApplyAutomaticallyOnStandardVariant(e)}catch(e){l.error("callback for determination of apply automatically on standard variant failed")}}}return t};f.prototype.getOverflowToolbarConfig=function(){return{canOverflow:false,invalidationEvents:["save","manage","select"]}};f.prototype._getToolbarInteractive=function(){return true};f.prototype.exit=function(...e){this._destroyEmbeddedVM();if(this._oItemsTemplate){this._oItemsTemplate.destroy();this._oItemsTemplate=undefined}if(this.oModel){this.oModel.destroy();this.oModel=undefined}this._fRegisteredApplyAutomaticallyOnStandardVariant=null;this.oContext=undefined;this.oResourceBundle=undefined;r.prototype.exit.apply(this,e)};return f});
//# sourceMappingURL=SmartVariantManagementMediator.js.map