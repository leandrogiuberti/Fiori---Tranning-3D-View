/*!
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/model/BindingMode","sap/ui/core/Lib","sap/ui/core/library","sap/base/Log"],function(t,e,n,r,i){"use strict";const{TitleLevel:a}=r;const o="/data";const s="$sVM";const l=["creationAllowed","currentVariant","defaultVariant","headerLevel","modified","showExecuteOnSelection","showFavorites","standardItemText","supportDefault","supportPublic","titleStyle","variants","variantsEditable"];const p=t.extend("sap.ui.comp.smartvariants.SmartVariantManagementModel",{constructor:function(){t.apply(this,arguments);this.setSizeLimit(1e3);this.setDefaultBindingMode(e.OneWay);this._aContexts=[];if(!this.getProperty(o)){this.createContext(o)}this._sDefaultVariantId=null}});p.prototype.createContext=function(t,e){if(!t){return}if(this._aContexts.includes(t)){return}if(!t.startsWith("/")){i.warning("SmartVariantManagementModel: you've called 'createContext' with a context path that's not starting with a '/'.");return}this._aContexts.push(t);this.setProperty(t,e||{creationAllowed:true,currentVariant:"",defaultVariant:"",headerLevel:a.Auto,modified:false,showExecuteOnSelection:false,showFavorites:false,standardItemText:null,supportDefault:true,supportPublic:false,titleStyle:a.Auto,variants:[],variantsEditable:true})};l.forEach(function(t){const e=t=>t[0].toUpperCase()+t.slice(1);const n=e(t);const r=`get${n}`,i=`set${n}`;p.prototype[r]=function(e){return this._getProperty(t,e)};p.prototype[i]=function(e,n){return this._setProperty(t,e,n)}});p.prototype._getProperty=function(t,e){return this.getProperty(`${e||o}/${t}`)};p.prototype._setProperty=function(t,e,n){return this.setProperty(`${n||o}/${t}`,e)};p.prototype.getContexts=function(){return this._aContexts};p.prototype._getDefaultVariantId=function(){return this._sDefaultVariantId||""};p.prototype._setDefaultVariantId=function(t,e){if(u&&e){u.setDefaultVariantId({control:e,defaultVariantId:t})}this._sDefaultVariantId=t};p.prototype.prepareVariantsForTitleBindings=function(t,e){if(!e){const n=this.getVariants(t);e=n.map(t=>{const e=t.title&&t.title.match(/{(\w+)>(\w.+)}/);if(!e){return undefined}return{key:t.key,sResourceModel:e[1],sResourceKey:e[2]}}).filter(t=>t!==undefined)}return e};p.prototype.updateVariant=function(t){var e,n,r,i,a;if(t){n=this.getVariants();r=this.findVariantIndex(t.getVariantId());if(r>-1){e=n[r];e["executeOnSelect"]=t.getExecuteOnSelection();e["originalExecuteOnSelect"]=t.getExecuteOnSelection();e["favorite"]=t.getFavorite();e["originalFavorite"]=t.getFavorite();if(t.getContexts){e["contexts"]=t.getContexts();e["originalContexts"]=t.getContexts()}a=t.getText("variantName");if(e["title"]!==a){i=this.getIdxSorted(a);if(r!==i){n.splice(r,1);n.splice(i,0,e)}e["title"]=a;e["originalTitle"]=a}this.setVariants(n);this.checkUpdate(true)}}};p.prototype.reorderVariants=function(t,e,n=0){const r=this.getVariants();var i;var a=this.findVariantIndex(t,n);if(a>0){i=r[a];r.splice(a,1);a=this.getIdxSorted(e);if(a>0){i.title=e;r.splice(a,0,i);this.setVariants(r)}}else if(a===0){r[a]["title"]=e;this.setVariants(r)}};p.prototype.getIdxSorted=function(t){const e=this.getVariants();const n=t.toUpperCase();const r=e.findIndex((t,e)=>{if(e>0){if(t.title.toUpperCase()>n){return true}}return false});return r>-1?r:e.length};p.prototype.removeVariant=function(t){const e=this.getVariants();var n=this.findVariantIndex(t);if(n>-1){e.splice(n,1);this.setVariants(e)}};p.prototype.updateView=function(t,e,n){const r=this.getVariants();var i=this.findVariantIndex(t,-1);if(i>-1){r[i][e]=n;this.setVariants(r)}};p.prototype.findVariantIndex=function(t,e=0){return this.getVariants().findIndex((n,r)=>{if(r>e){if(n.key===t){return true}}return false})};let d,u,f;p.prototype.retrieveDataFromFlex=function(){if(!u){throw new Error("SmartVariantManagementModel.retrieveDataFromFlex: FlexWriteAPI is not available. Please call 'loadFlex' before this method.")}return[u.isVariantSharingEnabled(),u.isVariantPersonalizationEnabled(),u.isVariantAdaptationEnabled()]};p.prototype.loadFlex=function(){const t=()=>new Promise(t=>{sap.ui.require(["sap/ui/fl/apply/api/SmartVariantManagementApplyAPI","sap/ui/fl/write/api/SmartVariantManagementWriteAPI","sap/ui/fl/apply/api/FlexRuntimeInfoAPI"],function(e,n,r){d=e;u=n;f=r;t()})});if(!this._oFlLibrary){if(!this._oPersistencyPromise){this._oPersistencyPromise=new Promise((t,e)=>{this._fResolvePersistencyPromise=t;this._fRejectPersistencyPromise=e})}this._oFlLibrary=new Promise((e,r)=>{n.load({name:"sap.ui.fl"}).then(()=>{t().then(e)}).catch(t=>{if(this._fRejectPersistencyPromise){this._fRejectPersistencyPromise()}r(t)})})}return this._oFlLibrary};p.prototype._unloadFlex=function(){d=undefined;u=undefined;f=undefined;this._oFlLibrary=undefined};p.prototype.isFlexLoaded=function(){return d!==undefined&&u!==undefined&&f!==undefined};p.prototype.isFlexSupported=function(t){if(this.isFlexLoaded()){return Promise.resolve(this._isFlexSupported(t))}else{return this.loadFlex().then(()=>this._isFlexSupported(t))}};p.prototype._isFlexSupported=function(t){if(!f){throw new Error("SmartVariantManagementModel._isFlexSupported: FlexRuntimeInfoAPI is not available. Please call 'loadFlex' before this method.")}return f.isFlexSupported({element:t})};p.prototype.loadVariants=function(t,e,n){if(!d){throw new Error("SmartVariantManagementModel.loadVariant: FlexApplyAPI is not available. Please call 'loadFlex' before this method.")}return d.loadVariants(t).then(t=>{this._fResolvePersistencyPromise();e(t)}).catch(t=>{this._fRejectPersistencyPromise(t);n(t)})};p.prototype.flUpdateVariant=function(t,e,n){let r;if(e.hasOwnProperty("content")||e.hasOwnProperty("name")){r=this._handleLayerUpdate(t,e,n)}if(e.hasOwnProperty("favorite")||e.hasOwnProperty("executeOnSelection")){r=this._handleUserDependentUpdate(t,e,n)}return r};p.prototype._handleLayerUpdate=function(t,e,n){const r={control:n,id:t.getVariantId(),layer:t.getLayer()};if(e.hasOwnProperty("content")){r.content=e.content}if(e.hasOwnProperty("name")){r.name=e.name}if(e.hasOwnProperty("packageName")){r.packageName=e.packageName}if(e.hasOwnProperty("transportId")){r.transportId=e.transportId}return this._handleUpdate(r)};p.prototype._handleUserDependentUpdate=function(t,e,n){const r={control:n,id:t.getVariantId(),isUserDependent:true};if(e.hasOwnProperty("favorite")){r.favorite=e.favorite}if(e.hasOwnProperty("executeOnSelection")){r.executeOnSelection=e.executeOnSelection}return this._handleUpdate(r)};p.prototype._handleUpdate=function(t){return this._flWriteUpdateVariant(t)};p.prototype._flWriteUpdateVariant=function(t){return u?.updateVariant(t)??null};p.prototype._flWriteRemoveVariant=function(t){return u?.removeVariant(t)??null};p.prototype._flWriteAddVariant=function(t){return u?.addVariant(t)??null};p.prototype.flWriteOverrideStandardVariant=function(t,e){if(u){u.overrideStandardVariant({control:e,executeOnSelection:t})}};p.prototype.save=function(t){if(!u){throw new Error("SmartVariantManagementModel.save: FlexWriteAPI is not set. Please call 'loadFlex' before calling this method.")}return u.save({control:t})};p.prototype._createMetadataPromise=function(){this._oMetadataPromise=new Promise(t=>{this._fResolveMetadataPromise=t})};p.prototype._resolveMetadataPromise=function(){if(this._fResolveMetadataPromise){this._fResolveMetadataPromise()}};p.prototype.getPersistencyPromise=function(){return this._oPersistencyPromise};p.getDefaultContextPath=()=>o;p.getDefaultModelName=()=>s;p.prototype.destroy=function(){this._oPersistencyPromise=null;this._sDefaultVariantId=null;this._fResolveMetadataPromise=null;this._oMetadataPromise=null;this._aContexts=undefined;t.prototype.destroy.apply(this,arguments)};return p});
//# sourceMappingURL=SmartVariantManagementModel.js.map