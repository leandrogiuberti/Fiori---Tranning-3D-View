/*
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/core/Lib","sap/ui/model/CompositeType","sap/ui/comp/util/FormatUtil","sap/ui/model/ParseException","sap/ui/model/ValidateException","sap/base/util/isPlainObject","sap/base/util/Deferred","sap/base/assert"],function(e,t,i,r,n,s,o,a){"use strict";var l=t.extend("sap.ui.comp.smartfield.type.TextArrangement",{constructor:function(e,i,r,n){this.getPrimaryType().call(this,e,i);t.call(this,e,i);this.init(e,i,r);a(r.keyField!==undefined,"Missing value for the keyField. - "+this.getName());if(n?.isA?.("sap.ui.comp.smartfield.SmartField")){this.oSmartField=n}},metadata:{abstract:true}});l.prototype.init=function(e,t,i){this.sName="TextArrangement";this.bParseWithValues=true;this.async=true;var r={textArrangement:"idOnly"};var n={onBeforeValidateValue:function(){}};this.oSettings=Object.assign(n,i);this.oFormatOptions=Object.assign(r,e);this.fnParser=this.getValidator({textArrangement:this.oFormatOptions.textArrangement,prefix:"parse"});this.fnValidator=this.getValidator({textArrangement:this.oFormatOptions.textArrangement,prefix:"validate"});this.bValueListNoValidation=i.valueListNoValidation;this.bClientSideMandatoryCheck=this.oSettings.clientSideMandatoryCheck!==undefined?this.oSettings.clientSideMandatoryCheck:true;this.bIsInvalid=false;this._sSelectedValue=null};l.prototype.getSettings=function(){return this.oSettings};l.prototype.parseValue=function(e,t,i){var r,n=e===""&&!this._isValueSelected(e),s=this.oFormatOptions.textArrangement;if(n&&(this.bClientSideMandatoryCheck||!this.bClientSideMandatoryCheck&&this.oConstraints.nullable)){e=null}if(typeof e==="string"){e=e.replace(/\u0020+$/,"")}if(s==="idOnly"){r=this.parseIDOnly(e,t)}else{r=this.fnParser(e,t,i,this.oFormatOptions,this.oSettings)}if(r[0]&&r[0].toUpperCase&&this.oFormatOptions.displayFormat==="UpperCase"){r[0]=r[0].toUpperCase()}return r};l.prototype.parseIDOnly=function(e,t){e=this.getPrimaryType().prototype.parseValue.call(this,e,t);return[e,undefined]};l.prototype.setSelectedValue=function(e){this._sSelectedValue=e};l.prototype._isValueSelected=function(e){return this._sSelectedValue===e};l.prototype.parseIDAndDescription=function(e,t,i,r){var n;if(!this._isValueSelected(e)){if(r&&r.textArrangement==="idAndDescription"){n=/^([\S\s]+?)\s\([\S\s]+\)$/.exec(e)}else{n=/^[\S\s]+\s\(([\S\s]+?)\)$/.exec(e)}}this.setSelectedValue(null);if(Array.isArray(n)&&n[1]){e=n[1]}return this.parseIDOnly(e,t)};l.prototype._parseKey=function(e,t){const i=this.getPrimaryType(),r=new i(this.oFormatOptions,this.oConstraints);return r.parseValue.call(this,e,t)};l.prototype.parseDescriptionOnly=function(e,t,i,r,s){var a,l,d,p=this.oConstraints&&this.oConstraints.maxLength?this.oConstraints.maxLength:0;if(e&&this._isValueSelected(e)){return Promise.resolve([e])}function h(i,r){var o,a=s.keyField,l=s.descriptionField,d=i.reject;var p=u(e,{key:l,value:a,data:r});var h=p.length;if(h===1){if(this._bRevokedValue){this._bRevokedValue=false;return false}o=this.getPrimaryType().prototype.parseValue.call(this,p[0],t);i.resolve([o,undefined]);return true}if(h===0){p=u(e,{key:a,value:l,data:r});h=p.length}if(!this.bValueListNoValidation){this.oSmartField?._addAdditionalInfo("descriptionCount",h);if(h===0){i.reject(new n(this.getResourceBundleText("SMARTFIELD_NOT_UNIQUE")));return false}if(h>1){i.reject(new n(this.getResourceBundleText("SMARTFIELD_DUPLICATE_VALUES")));return false}}if(!this._validateDeprecationCode(s,e,p,d,r)){return false}o=this.getPrimaryType().prototype.parseValue.call(this,e,t);i.resolve([o,undefined]);return true}function c(e,t){e.reject(new n(this.getResourceBundleText("SMARTFIELD_INVALID_ENTRY")))}a=new o;if(e===null){a.resolve([e,undefined]);return a.promise}if(e&&e.toUpperCase&&this.oFormatOptions.displayFormat==="UpperCase"){e=e.toUpperCase()}if(this.oConstraints.descriptionMaxLength){p=parseInt(this.oConstraints.descriptionMaxLength)}if(e&&p&&e.length>p){a.reject(new n(this.getCoreResourceBundleText("EnterTextMaxLength",[p])));return a.promise}d={filterFields:this.getFilterFields(),noRebind:true,success:function(e){if(e.length!==1){a.resolve([null]);return false}return h.call(this,a,e)}.bind(this),error:c.bind(this,a)};l=this.onBeforeValidateValue(e,d);if(l){a.promise.then(l)}return a.promise.then(function(i){if(l&&i&&i[0]){e=i[0]}if(this.oConstraints.keyMaxLength){this.oConstraints.maxLength=parseInt(this.oConstraints.keyMaxLength);p=this.oConstraints.maxLength}e=this._parseKey(e,t);if(e&&p&&e.length>p){return new Promise((e,t)=>{t(new n(this.getResourceBundleText("ENTER_A_VALID_VALUE")))})}return a.promise.then(function(t){var i,r;if(t[0]!==null){return t}else{i=new o;r={filterFields:["keyField"],success:h.bind(this,i),error:c.bind(this,i)};this.onBeforeValidateValue(e,r);return i.promise}}.bind(this))}.bind(this))};l.prototype.validateValue=function(e,t){this.validateIDOnly(e);var i=e[0];if(i===null){return}if(this.oFormatOptions.textArrangement==="descriptionOnly"){this.validateDescriptionOnly(e,this.oSettings);return}if(this.oFormatOptions.textArrangement==="idOnly"&&this.bValueListNoValidation){return}var r=new Promise(function(r,s){function o(t){var n=Object.assign({},this.oSettings,{data:t,reject:s});if(i===""&&Array.isArray(t)&&t.length===0&&this.oConstraints.nullable===false&&!this.bClientSideMandatoryCheck){r(e);return true}var o=this.fnValidator(e,n);if(o){r(e)}return o}function a(e){s(new n(this.getResourceBundleText("SMARTFIELD_INVALID_ENTRY")))}var l={filterFields:this.getFilterFields(),success:o.bind(this),error:a.bind(this),bCheckValuesValidity:t};this.onBeforeValidateValue(i,l)}.bind(this));if(this.bValueListNoValidation){return}else{return r}};l.prototype.validateIDOnly=function(e,t){var i=e[0],r,s;this.getPrimaryType().prototype.validateValue.call(this,i);if(this.getSettings().valueList&&t){r=t.data;s=t.reject;this.oSmartField?._addAdditionalInfo("descriptionCount",r.length);if(r.length===0){s(new n(this.getResourceBundleText("SMARTFIELD_NOT_FOUND")));return false}if(r.length>1){s(new n(this.getResourceBundleText("SMARTFIELD_DUPLICATE_VALUES")));return false}if(!this._validateDeprecationCode(t,e,[],s,t.data)){return false}}return true};l.prototype.validateIDAndDescription=function(e,t){var i={key:t.keyField,value:t.descriptionField,data:t.data};if(this.oFormatOptions&&this.oFormatOptions.displayFormat){i.displayFormat=this.oFormatOptions.displayFormat}var r=u(e[0],i,this.oConstraints);this.oSmartField?._addAdditionalInfo("descriptionCount",r.length);var s=t.reject;if(!this.bValueListNoValidation){if(r.length===0){s(new n(this.getResourceBundleText("SMARTFIELD_NOT_FOUND")));return false}if(r.length>1){s(new n(this.getResourceBundleText("SMARTFIELD_DUPLICATE_VALUES")));return false}}if(!this._validateDeprecationCode(t,e,r,s,t.data)){return false}return true};l.prototype._validateDeprecationCode=function(e,t,i,r,s){const o=this._getDeprecationCodeField(),a=e.reject||r;if(!o||!this.oSmartField){return true}const l=s[0]?.[o];if(l==="W"){setTimeout(()=>{this.oSmartField.setValueState("Warning");this.oSmartField.setValueStateText(this.getResourceBundleText("DEPRECATED_VALUE"))})}if(l==="E"){if(!this.bValueListNoValidation){this._decorateRevokedValue(t[0],i[0]);a(new n(this.getResourceBundleText("REVOKED_VALUE")));return false}else if(this.bValueListNoValidation){setTimeout(()=>{this.oSmartField.setValueState("Error");this.oSmartField.setValueStateText(this.getResourceBundleText("REVOKED_VALUE"))})}}return true};l.prototype._getDeprecationCodeField=function(){if(!this._sDeprecationCodeField){this._sDeprecationCodeField=this.oSmartField?._oFactory?.getValueHelpProvider()?.oPrimaryValueListAnnotation?.deprecationCodeField}return this._sDeprecationCodeField};l.prototype._decorateRevokedValue=function(e,t){const i=this.oSmartField?._getInnerControlPropertyBinding("edit")?.sInternalType,r=this.formatValue([e,t],i);this.oSmartField?.getFirstInnerControl()?.setValue(r);this._bRevokedValue=true};l.prototype.validateDescriptionOnly=function(e,t){};l.prototype.formatValue=function(e,t){var r;if(!Array.isArray(e)){return e}if(this.bValueListNoValidation&&e[1]===undefined){e.splice(1,1)}r=this.getPrimaryType().prototype.formatValue.call(this,e[0],t);if(r===null&&!(this._isKeyPropertyMissingInModel(e)&&this.oFormatOptions.textArrangement==="descriptionOnly")){return r}if(this.oConstraints.isDigitSequence&&r===""){if(e[0]!==""){r=e[0]}else{return[]}}if(r&&this.oFormatOptions.displayFormat==="UpperCase"){r=r.toUpperCase()}var n=e[1];if(n===""&&this.oFormatOptions.textArrangement!=="idOnly"&&this.oSettings.delegate){this.oSettings.delegate._sTextArrangementLastReadValue=null}if(!n&&this.oFormatOptions.textArrangement==="descriptionOnly"){return r}if(s(n)||this.bIsInvalid){n=""}return i.getFormattedExpressionFromDisplayBehaviour(this.oFormatOptions.textArrangement,r,n)};l.prototype._isKeyPropertyMissingInModel=function(e){return e[0]===undefined&&e[1]!==undefined?true:false};l.prototype.setDescriptionIsInvalid=function(e){this.bIsInvalid=e};l.prototype.getDescriptionIsInvalid=function(){return this.bIsInvalid};l.prototype.destroy=function(){this.oFormatOptions=null;this.oSettings=null;this.fnParser=null;this.fnValidator=null};l.prototype.getName=function(){return"sap.ui.comp.smartfield.type.TextArrangement"};l.prototype.onBeforeValidateValue=function(e,t){return this.oSettings.onBeforeValidateValue(e,t)};l.prototype.getResourceBundleText=function(t,i){return e.getResourceBundleFor("sap.ui.comp").getText(t,i)};l.prototype.getCoreResourceBundleText=function(t,i){return e.getResourceBundleFor("sap.ui.core").getText(t,i)};l.prototype.getPrimaryType=function(){};l.prototype.getValidator=function(e){switch(e.textArrangement){case"idAndDescription":case"descriptionAndId":return this[e.prefix+"IDAndDescription"];case"descriptionOnly":return this[e.prefix+"DescriptionOnly"];default:return this[e.prefix+"IDOnly"]}};l.prototype.getFilterFields=function(e){if(this.oFormatOptions&&this.oFormatOptions.textArrangement==="descriptionOnly"){return["descriptionField"]}return["keyField"]};function u(e,t,i){var r=[];if(t.displayFormat==="UpperCase"){e=e.toLowerCase()}t.data.forEach(function(n){let s=n[t.key];if(s&&t.displayFormat==="UpperCase"){s=s.toLowerCase()}const o=i?.isDigitSequence&&i?.maxLength&&e.lastIndexOf(s)!==-1;if(o||s===e){r.push(n[t.value])}});return r}return l});
//# sourceMappingURL=TextArrangement.js.map