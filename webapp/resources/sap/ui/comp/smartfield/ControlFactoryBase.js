/*
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/Lib","sap/ui/core/library","sap/ui/comp/library","sap/ui/model/BindingMode","sap/ui/comp/util/FormatUtil","sap/ui/comp/providers/ValueHelpProvider","sap/ui/comp/providers/ValueListProvider","sap/ui/comp/smartfield/BindingUtil","sap/ui/comp/odata/MetadataAnalyser","sap/m/HBox","sap/base/Log","sap/base/strings/capitalize","sap/ui/comp/smartfilterbar/SmartFilterBar","sap/ui/comp/smartfield/ValueListDelegate"],function(t,e,a,i,o,n,r,s,l,u,d,p,h,g,f){"use strict";var c=i.smartfield.ControlContextType;var y=a.ValueState;var m=t.extend("sap.ui.comp.smartfield.ControlFactoryBase",{constructor:function(a,i){t.apply(this,arguments);this.sName="ControlFactoryBase";this._oModel=a;this._oParent=i;this._oBinding=new l;this._aProviders=[];this._oRb=e.getResourceBundleFor("sap.ui.comp")}});m.prototype.bind=function(){return Promise.resolve()};m.prototype.createControl=function(t){var e,a;e=this._getCreator(t);if(e){a=this[e](t);this._addAriaLabelledBy(a);this._addAriaDescribedBy(a);if(a&&a.onCreate){this[a.onCreate](a.control,a.params)}}return a};m.prototype.updateControl=function(t){var e,a=t.mode,i=this._oParent,o=i.data("configdata");if(o&&o.configdata){e=i.getFirstInnerControl();if(o.configdata.onText&&a==="display"){o.configdata.onText(e)}else if(o.configdata.onInput&&a==="edit"){o.configdata.onInput(e)}}};m.prototype._addAriaLabelledBy=function(t){var e=this._getTargetControlForAccAttributes(t),a=this._oParent.getAriaLabelledBy();if(e&&e.addAriaLabelledBy&&a.length>0){e.removeAllAriaLabelledBy();a.forEach(function(t){e.addAriaLabelledBy(t)})}};m.prototype._addAriaDescribedBy=function(t){var e=this._getTargetControlForAccAttributes(t),a=this._oParent.getAriaDescribedBy();if(e&&e.addAriaDescribedBy&&a.length>0){e.removeAllAriaDescribedBy();a.forEach(function(t){e.addAriaDescribedBy(t)})}};m.prototype._getTargetControlForAccAttributes=function(t){var e,a=this._oParent.getControlContext();if(a===c.None||a===c.Form||a===c.SmartFormGrid){if(t){e=t.control;if(e instanceof d){if(e.getItems().length>0){e=e.getItems()[0]}}}}return e};m.prototype.addValidations=function(t,e){var a,i,o=this;a=function(t,a){var i,n,r=a.getParameter("targetControl")||a.getSource();if(r){if(r.setValueState){r.setValueState(t)}n=a.getParameter("exception");if(n){i=n.message}if(!i){i=a.getParameter("message")}if(r.setValueStateText){r.setValueStateText(i)}}if(e){o._oParent[e](t===y.Error)}};i=function(t){a(y.Error,t)};t.attachFormatError(i);t.attachParseError(i);t.attachValidationError(i);t.attachValidationSuccess(function(t){o._oParent.onValidation(t);a(y.None,t)})};m.prototype._isInnerUoM=function(){var t=this.getCustomDataConfiguration();return t&&t.isUOM&&t.isInnerControl};m.prototype._getDisplayBehaviourConfiguration=function(t){var e=null,a,o=this._isInnerUoM(),n=this._oParent._getComputedTextInEditModeSource()==="ValueListNoValidation";var r=this._oParent.getConfiguration();if(r&&!this._getCriticalityQualifierConfiguration()){e=r.getDisplayBehaviour()}if(!e&&this._oMetaData&&this._oMetaData.entityType){e=this._oHelper.oAnnotation.getTextArrangement(this._oMetaData.property.property,this._oMetaData.entityType,n)}if(!e){if(!t&&this._oSelector){a=this._oSelector.checkComboBox({mode:"edit"});t=a&&a.combobox?"defaultDropDownDisplayBehaviour":"defaultInputFieldDisplayBehaviour"}e=this._oParent.data(t)}if(!e&&!o){e=i.DEFAULT_DISPLAY_BEHAVIOUR}return e};m.prototype._getCriticalityQualifierConfiguration=function(){var t=null,e=this._oParent.getConfiguration();if(e){t=e.getCriticalityQualifier&&e.getCriticalityQualifier()}return t};m.prototype._getPreventInitialDataFetchInVHDialog=function(t){var e=this._oParent.getConfiguration();if(e&&!e.isPropertyInitial("preventInitialDataFetchInValueHelpDialog")){return e.getPreventInitialDataFetchInValueHelpDialog()}if(u.isValueList(t)&&t["com.sap.vocabularies.Common.v1.ValueList"]&&t["com.sap.vocabularies.Common.v1.ValueList"].FetchValues){return t["com.sap.vocabularies.Common.v1.ValueList"].FetchValues.Int!=="1"}return false};m.prototype._formatDisplayBehaviour=function(t,e,a){var i=this._getDisplayBehaviourConfiguration(t);if(t==="defaultCheckBoxDisplayBehaviour"){return this._getFormattedExpressionFromDisplayBehaviour(i,e)}if(t==="defaultComboBoxReadOnlyDisplayBehaviour"&&!i){i="descriptionAndId"}return n.getFormattedExpressionFromDisplayBehaviour(i||"idOnly",e,a)};m.prototype._getFormattedExpressionFromDisplayBehaviour=function(t,e){var a="";switch(t){case"OnOff":a=e?"SMARTFIELD_CB_ON":"SMARTFIELD_CB_OFF";break;case"TrueFalse":a=e?"SMARTFIELD_CB_TRUE":"SMARTFIELD_CB_FALSE";break;default:a=e?"SMARTFIELD_CB_YES":"SMARTFIELD_CB_NO";break}return this._oRb.getText(a)};m.prototype.getDropdownItemKeyType=function(){};m.prototype.getValueStateBindingInfoForRecommendationStateAnnotation=function(){};m.prototype.createValueHelp=function(t){var e,a=this.getCustomDataConfiguration(),i=this._isInnerUoM()?a&&a.smartFieldRootControl:this._oParent,o=t.edmProperty,n=t.valueHelp;if(n.annotation&&(o["sap:value-list"]||o["com.sap.vocabularies.Common.v1.ValueList"])){var l=n.displayBehaviour||this._getDisplayBehaviourConfiguration(),u=this._oParent.data("dateFormatSettings"),d=this._getPreventInitialDataFetchInVHDialog(o);if(typeof u==="string"){try{u=JSON.parse(u)}catch(t){}}var p,h,c,y,m,_,v;if(typeof n.annotation==="string"){h=n.annotation}else if(n&&typeof n.annotation==="object"){if(a){c=a.annotations;if(c&&c.valuelist&&typeof c.valuelist==="string"){h=c.valuelist}}y=c&&(c.valueListData&&c.valueListData.annotation||c.valuelist);p=n.analyser.getValueListAnnotationForFunctionImport({"":y||n.annotation},o.name).primaryValueListAnnotation}var P=t.control,A=t.model,b=t.onValueListChange;if(!n.noDialog){if(P.setFilterSuggests){P.setFilterSuggests(false)}if(i){if(i.isContextTable&&i.isContextTable()){v=i.data("configdata")&&i.data("configdata").configdata;if(v){m=v.defaultFilterBarExpanded;_=v.defaultShowAllFilters}}else{m=i.data("defaultFilterBarExpanded");_=i.data("defaultShowAllFilters")}}var B=new r({context:"SmartField",fnAsyncWritePromise:this._oParent._isAsync&&this._oParent._isAsync()?this._oParent.checkValuesValidity.bind(this._oParent):null,selectedODataRowHandler:this._selectedODataRowHandler.bind(this),fieldName:o.name,control:P,model:A,dateFormatSettings:u,displayBehaviour:l,loadAnnotation:true,fullyQualifiedFieldName:h,metadataAnalyser:n.analyser,annotation:p,title:n.dialogtitle,preventInitialDataFetchInValueHelpDialog:d,supportMultiSelect:!!n.supportMultiSelect,supportRanges:!!n.supportRanges,takeOverInputValue:true,type:n.type,maxLength:o.maxLength,filterBarClass:g,enabledMultiSelectionPlugin:n?.enabledMultiSelectionPlugin!==undefined?n.enabledMultiSelectionPlugin:true,defaultFilterBarExpanded:m,defaultShowAllFilters:_});if(b){B.attachValueListChanged(b)}this._aProviders.push(B);if(P.setShowValueHelp){P.setShowValueHelp(true)}}var D=true,C=true,S=true;if(this._oParent._getHistoryEnabled){D=this._oParent._getHistoryEnabled();C=this._oParent.isPropertyInitial("historyEnabled")}if(this._oParent.getShowValueHelp&&!this._oParent.getShowValueHelp()){S=false}if(!n.noTypeAhead||!P.isA("sap.m.Input")){e={control:P,model:A,dateFormatSettings:u,displayBehaviour:l,fieldViewMetadata:o,loadAnnotation:true,fullyQualifiedFieldName:h,metadataAnalyser:n.analyser,annotation:p,aggregation:n.aggregation,typeAheadEnabled:!n.noTypeAhead,dropdownItemKeyType:this.getDropdownItemKeyType(P),maxLength:o.maxLength,fieldHistoryEnabled:D,fieldHistoryEnabledInitial:C,bShowAllSuggestionsButton:S};var F=new s(this.getValueListProviderConfiguration(e));if(!n.noTypeAhead){if(P.setShowSuggestion){P.setShowSuggestion(true)}}if(b){F.attachValueListChanged(b)}this.oValueListDelegate=new f(F);this._aProviders.push(F)}}};m.prototype.getValueListProviderConfiguration=function(t){return{context:"SmartField",fnAsyncWritePromise:this._oParent._isAsync&&this._oParent._isAsync()?this._oParent.checkValuesValidity.bind(this._oParent):null,selectedODataRowHandler:this._selectedODataRowHandler.bind(this),control:t.control,model:t.model,dateFormatSettings:t.dateFormatSettings,displayBehaviour:t.displayBehaviour,fieldViewMetadata:t.fieldViewMetadata,loadAnnotation:true,fullyQualifiedFieldName:t.fullyQualifiedFieldName,metadataAnalyser:t.metadataAnalyser,annotation:t.annotation,aggregation:t.aggregation,typeAheadEnabled:t.typeAheadEnabled,dropdownItemKeyType:t.dropdownItemKeyType,maxLength:t.maxLength,fieldHistoryEnabled:t.fieldHistoryEnabled,fieldHistoryEnabledInitial:t.fieldHistoryEnabledInitial,bShowAllSuggestionsButton:t.bShowAllSuggestionsButton}};m.prototype._selectedODataRowHandler=function(t,e,a){if(this.oTextArrangementDelegate){this.oTextArrangementDelegate.setDataForNextDescriptionRequest(t,e);this.oTextArrangementDelegate.setAbsolutePathToVLProperty(a)}};m.prototype.getAttribute=function(t){var e=this._oParent.getBindingInfo(t);if(e){return this._oBinding.toBindingPath(e)}return this._oParent["get"+t.substring(0,1).toUpperCase()+t.substring(1)]()};m.prototype.getCustomDataConfiguration=function(){var t=this._oParent&&this._oParent.data&&this._oParent.data("configdata");return t&&t.configdata?t.configdata:null};m.prototype.createAttributes=function(t,e,a,i){var o=this,n,r={};for(var s in a){if(a.hasOwnProperty(s)){var l=this._oParent.getBindingInfo(s);if(l){r[s]=this._oBinding.toBinding(l)}else if(s==="valueState"&&this._oParent.isPropertyInitial("valueState")){l=this.getValueStateBindingInfoForRecommendationStateAnnotation();if(l){r[s]=l}else{r[s]=this._oParent["get"+h(s)]()}}else{r[s]=this._oParent["get"+h(s)]()}if(s==="placeholder"&&e&&e.property&&!r.placeholder){r.placeholder=this._oHelper.oAnnotation.getPlaceholder(e.property)}}}if(t){if(e&&e.property&&e.property.type==="Edm.String"&&(this._oHelper.oAnnotation.isStaticOptional(e.property)||this._oParent&&this._oParent._fieldControlValue===3||this._oParent&&!this._oParent.getClientSideMandatoryCheck())){n={parseKeepsEmptyString:true}}if(e&&e.property&&u.getIsTimezoneProperty(e.property)){r[t]={model:this._oMetaData.model,path:this._oMetaData.path,parts:[{value:null},{path:this._oMetaData.path}],type:e?this._oTypes.getType(e,{showDate:false,showTime:false}):null,mode:this._oParent.getBindingMode("value")}}else{r[t]={model:this._oMetaData.model,path:this._oMetaData.path,type:e?this._oTypes.getType(e,n):null,mode:this._oParent.getBindingMode("value")}}}if(i){r[i.event]=function(t){try{var e=t.getParameters();var a={value:e[i.parameter],newValue:e[i.parameter]};o._oParent.fireChange(a)}catch(t){p.warning(t)}}}return r};m.prototype.mapBindings=function(t,e,a){var i,o;for(i in e){o=this._oParent.getBindingInfo(i);if(o){t[e[i]]=this._oBinding.toBinding(o)}else{t[e[i]]=a&&a[e[i]]||this._oParent["get"+i.substring(0,1).toUpperCase()+i.substring(1)]()}}};m.prototype.getFormatSettings=function(t){var e=null,a,i,o;if(t){e=this._oParent.data(t);if(!e){a=this._oParent.getCustomData();if(a){o=a.length;while(o--){i=a[o];if(i.getKey()===t){e=i.getValue();break}}}}if(e&&typeof e==="string"){try{e=JSON.parse(e)}catch(t){return null}}}return e};m.prototype.getValueListProvider=function(){return this._aProviders.find(function(t){return t.isA("sap.ui.comp.providers.ValueListProvider")})};m.prototype.getValueHelpProvider=function(){return this._aProviders.find(function(t){return t.isA("sap.ui.comp.providers.ValueHelpProvider")})};m.prototype.destroyValueHelp=function(){this._aProviders.forEach(function(t){t.destroy()});this._aProviders=[]};m.prototype.destroy=function(){this.destroyValueHelp();if(this._oBinding){this._oBinding.destroy()}this._oBinding=null;this._oParent=null;this._oModel=null;this._oRb=null};return m},true);
//# sourceMappingURL=ControlFactoryBase.js.map