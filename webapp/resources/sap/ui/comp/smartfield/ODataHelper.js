/*
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/comp/library","sap/ui/comp/odata/MetadataAnalyser","sap/ui/comp/odata/AnalyticalAnalyser","sap/ui/comp/smartfield/AnnotationHelper","sap/base/Log","sap/ui/model/odata/_ODataMetaModelUtils","sap/ui/model/odata/ODataUtils","sap/base/assert"],function(t,e,i,n,a,r,o,p){"use strict";var s=t.TextArrangementType;var l=function(t,e,i,a){if(t){this.oMeta=t.getMetaModel()}if(i){this.oMeta=i}this._oModel=t;this._oUtil=e;this.oAnnotation=new n;this.bIsAnalytical=a};l.prototype.getAnalyzer=function(t){if(!this._oAnalyzer){if(this.bIsAnalytical){this._oAnalyzer=new i(this._oModel||t)}else{this._oAnalyzer=new e(this._oModel||t)}}return this._oAnalyzer};l.prototype.checkNavigationProperty=function(t,e){var i,n,a,r;if(e&&t){i=this._oUtil.getNavigationProperties(e);a=i.paths.length;while(a--){n=i.paths.shift();n=this._oUtil.correctPath(n);if(n===""||n===t.entitySet.name){continue}r=this.getNavigationProperty(t.entityType,n);if(r.entitySet){t.entitySet=r.entitySet;t.entityType=r.entityType}}}};l.prototype.getNavigationProperty=function(t,e){var i=this._getNamedProperty(e,"navigationProperty",t),n,a,r={};if(i){n=this.oMeta.getODataAssociationSetEnd(t,i.name);if(n===null){return}a=this.getAssociation(t,i.name);if(a){r.toRoleAssociationEndMultiplicity=this.getToRoleAssociationEndMultiplicity(a.end,i.toRole)}r.entitySet=this.oMeta.getODataEntitySet(n.entitySet);if(r.entitySet){r.entityType=this.oMeta.getODataEntityType(r.entitySet.entityType)}}return r};l.prototype.startWithNavigationProperty=function(t,e){var i=t.split("/"),n;if(i&&i.length>1){n=this._getNamedProperty(i.shift(),"navigationProperty",e.entityType)}if(n){return n.name}return null};l.prototype.getProperty=function(t){var e=[],i,n,a,r,o,p={entityType:t.entityType,entitySet:t.entitySet};if(t){n=t.path.split("/");i=n.length;if(p&&i>1){while(p&&p.entityType){r=n[0];p=this.getNavigationProperty(p.entityType,r);if(p&&p.entityType){t.entityType=p.entityType;t.entitySet=p.entitySet;t.toRoleAssociationEndMultiplicity=p.toRoleAssociationEndMultiplicity;e.push(n.shift());i--}}}t.navigationPath=e.join("/");if(i>1){a=this.oMeta.getODataProperty(t.entityType,n[0]);if(a){t.property=this._getComplex(a,n,i)}return}if(t.navigationPath){o=t.path.replace(t.navigationPath+"/","")}else{o=t.path}a=this.oMeta.getODataProperty(t.entityType,o);t.property={property:a,typePath:t.path,valueListAnnotation:null,valueListKeyProperty:null,valueListEntitySet:null,valueListEntityType:null}}};l.prototype._getComplex=function(t,e,i){var n=t,a,r=[];while(i--){if(n){if(i===0){a=n.name;n=this._getNamedProperty(e[0],"property",n);return{typePath:a+"/"+e[0],property:n,complex:true,parents:r}}n=this.oMeta.getODataComplexType(n.type);if(n){r.push(n)}}e.shift()}};l.prototype._getNamedProperty=function(t,e,i){var n;if(i[e]){for(var a=0;a<i[e].length;a++){if(i[e][a].name===t){n=i[e][a];break}}}return n};l.prototype.getTextProperty2=function(t){var e,i;e=this.oAnnotation.getText(t.property.property);if(e){i=this._preprocAnnotation(e,t);this.getProperty(i);this._postprocAnnotation(i,t)}return i};l.prototype.getUnitOfMeasure2=function(t){var e,i;e=this.oAnnotation.getUnit(t.property.property);if(e){i=this._preprocAnnotation(e,t);this.getProperty(i);this._postprocAnnotation(i,t)}return i};l.prototype._preprocAnnotation=function(t,e){var i,n;n=this.traverseNavigationProperties(t,e.entityType);if(!n.navigationPath){n.entitySet=e.entitySet}if(e.navigationPath){n.path=e.path.replace(e.navigationPath+"/","")}else{n.path=e.path}if(n.navigationPath){i=t.replace(n.navigationPath+"/","")}else{i=t}n.path=n.path.replace(e.property.property.name,i);if(n.navigationPath){n.navigationPathHelp=n.navigationPath}return n};l.prototype._postprocAnnotation=function(t,e){var i;if(t.navigationPathHelp){t.navigationPath=t.navigationPathHelp}if(t.navigationPath){i=t.navigationPath}else{i=""}if(e.navigationPath){if(i){i=e.navigationPath+"/"+i}else{i=e.navigationPath}}t.navigationPath=i;if(t.navigationPath){t.path=t.navigationPath+"/"+t.path}};l.prototype.traverseNavigationProperties=function(t,e){var i={},n={},a,r,o;a=t.split("/");o=a.length;i.entityType=e;n.entityType=e;while(o--){r=a.shift();if(r===""){continue}n=this.getNavigationProperty(i.entityType,r);if(!n.entitySet){break}i.entityType=n.entityType;i.entitySet=n.entitySet;if(i.navigationPath){i.navigationPath=i.navigationPath+"/"+r}else{i.navigationPath=r}}return i};l.prototype.getValueListAnnotationPath=function(t){var e,i,n=this.getEdmProperty(t),a=n?n.name:"";if(t&&t.property&&t.property.complex){i=t.property.parents.length-1;e=t.property.parents[i].namespace;e=e+"."+t.property.typePath}else if(t&&t.entitySet&&n){e=t.entitySet.entityType+"/"+a}return e};l.prototype.getUOMValueListAnnotationPath=function(t){var e;if(t.annotations.uom){e=this.getValueListAnnotationPath(t.annotations.uom)}if(e){t.annotations.valuelistuom=e}};l.prototype.getUOMTextAnnotation=function(t){if(t&&t.annotations&&t.annotations.uom){t.annotations.textuom=this.getTextProperty2(t.annotations.uom)}};l.prototype.geValueListEntitySet=function(t){if(t&&t.annotations&&t.annotations.valuelist){if(t.annotations.valuelist.primaryValueListAnnotation&&t.annotations.valuelist.primaryValueListAnnotation.valueListEntitySetName){t.annotations.valuelistentityset=this.oMeta.getODataEntitySet(t.annotations.valuelist.primaryValueListAnnotation.valueListEntitySetName)}}};l.prototype.getEdmProperty=function(t){var e=t.property;return e&&e.property||null};l.prototype.getValueListData=function(t){var i=this.getEdmProperty(t),n=t.annotations;if(e.isValueList(i)){n.valuelist=this.getValueListAnnotationPath(t);var a=e.getValueListMode(i);if(a){n.valuelistType=a}else{n.valuelistType=this.getAnalyzer().getValueListSemantics(i["com.sap.vocabularies.Common.v1.ValueList"])}}};l.prototype.findProperty=function(t,e){return r.findObject(t,e)};l.prototype.getAssociation=function(t,e){var i;if(t){i=this.findProperty(t.navigationProperty,e)}if(i&&this.oMeta.oModel){return r.getObject(this.oMeta.oModel,"association",i.relationship)}return null};l.prototype.getToRoleAssociationEnd=function(t,e){if(Array.isArray(t)){for(var i=0;i<t.length;i++){var n=t[i];if(n.role===e){return n}}}return null};l.prototype.getToRoleAssociationEndMultiplicity=function(t,e){var i=this.getToRoleAssociationEnd(t,e);return i?i.multiplicity:""};l.prototype.checkNavigationPropertyRequiredMetadata=function(t){var e=t.propertyName,i=t.textAnnotation,n=i?i.Path:"",r=t.entityType,o=r.namespace+"."+r.name,l="sap.ui.comp.smartfield.ODataHelper",y="com.sap.vocabularies.Common.v1.Text";if(!i){a.info('Missing "'+y+'" annotation for "'+e+'" EDM property of "'+o+'" entity type.',l);return false}if(n===undefined){p(false,'Missing "Path" attribute of "'+y+'" annotation for "'+e+'" EDM property of "'+o+'" entity type. - '+l);return false}if(n===""){p(false,'Missing URL path name of "'+y+'" annotation for "'+e+'" EDM property of "'+o+'" entity type. - '+l);return false}var f="com.sap.vocabularies.UI.v1.TextArrangement",u=i[f];if(!u){a.info('Missing "'+f+'" annotation for "'+e+'" EDM property of "'+o+'" entity type.',l);return false}var c=u.EnumMember;if(c===undefined){p(false,'Missing "EnumMember" attribute of "'+f+'" annotation for "'+e+'" EDM property of "'+o+'" entity type. - '+l);return false}if(!(c.split("/")[1]in s)){p(false,'Invalid "'+c+'" Text annotation enumeration member for "'+e+'" EDM property of "'+o+'" entity type. - '+l);return false}if(u.EnumMember===s.TextSeparate){return false}if(n.indexOf("/")===-1){p(false,'Invalid navigation property URL path name specified in the "'+y+'" annotation of the "'+e+'" EDM property of the "'+o+'" entity type. - '+l);return false}var h=n.split("/")[0],g=this.findProperty(r.navigationProperty,h);if(!g){p(false,'The navigation property URL path name "'+h+'" (specified in the Text annotation of the "'+e+'" EDM property) was not found in the "'+o+'" entity type of the service metadata document. - '+l);return false}var d=this.getAssociation(r,h);if(!d){p(false,'Missing "'+g.relationship+'" association for "'+g.name+'" EDM navigation property of the "'+o+'" entity type. - '+l);return false}var v=d.referentialConstraint;if(!v){p(false,'Missing referential constraint for "'+g.relationship+'" association in the service metadata document. - '+l);return false}if(!Array.isArray(d.end)||!(d.end.length>0)){p(false,'Missing association end for "'+g.relationship+'" association in the service metadata document. - '+l);return false}var m=this.getToRoleAssociationEndMultiplicity(d.end,g.toRole);if(m!=="1"){p(false,'Expected multiplicity of 1 for "'+g.toRole+'" association end of the "'+g.relationship+'" association in the service metadata document. - '+l);return false}if(v.principal.propertyRef.length!==1||v.dependent.propertyRef.length!==1){p(false,'Expected the single "'+e+'" foreign key EDM property as '+'referential constraint in the "'+g.relationship+'" association. - '+l);return false}var P=t.entityTypeOfNavigationProperty||this.getNavigationProperty(r,h).entityType;if(P.key.propertyRef.length!==1){p(false,'Expected a single key property in the lookup "'+P.namespace+"."+P.name+'" entity type. - '+l);return false}var A=v.principal.propertyRef[0].name;if(A!==P.key.propertyRef[0].name){p(false,'Expected a property named "'+A+'" to be the single key property in the lookup "'+P.namespace+"."+P.name+'" entity type. - '+l);return false}return true};l.prototype.checkNavigationPropertyRequiredMetadataNoAsserts=function(t){var e=t.textAnnotation,i=e?e.Path:"",n=t.entityType;if(!e){return false}if(i===undefined){return false}if(i===""){return false}var a="com.sap.vocabularies.UI.v1.TextArrangement",r=e[a];if(!r){return false}var o=r.EnumMember;if(o===undefined){return false}if(!(o.split("/")[1]in s)){return false}if(r.EnumMember===s.TextSeparate){return false}if(i.indexOf("/")===-1){return false}var p=i.split("/")[0],l=this.findProperty(n.navigationProperty,p);if(!l){return false}var y=this.getAssociation(n,p);if(!y){return false}var f=y.referentialConstraint;if(!f){return false}if(!Array.isArray(y.end)||!(y.end.length>0)){return false}var u=this.getToRoleAssociationEndMultiplicity(y.end,l.toRole);if(u!=="1"){return false}if(f.principal.propertyRef.length!==1||f.dependent.propertyRef.length!==1){return false}var c=t.entityTypeOfNavigationProperty||this.getNavigationProperty(n,p).entityType;if(c.key.propertyRef.length!==1){return false}var h=f.principal.propertyRef[0].name;if(h!==c.key.propertyRef[0].name){return false}return true};l.prototype.checkValueListRequiredMetadataForTextArrangmentNoAsserts=function(t){var e=t.valueListAnnotation;if(!e){return false}if(!Array.isArray(e.fields)){return false}var i=e.descriptionField,n=this.findProperty(e.fields,i);if(!n){return false}if(n["sap:filterable"]==="false"){return false}return true};l.prototype.checkValueListRequiredMetadataForTextArrangment=function(t){var e=t.valueListAnnotation,i="sap.ui.comp.smartfield.ODataHelper";if(!e){var n=t.entityType,a=n.namespace+"."+n.name;p(false,'Missing "ValueList" annotation for "'+t.propertyName+'" EDM property of "'+a+'" entity type. - '+i);return false}if(!Array.isArray(e.fields)){p(false,'Missing fields for "'+e.valueListEntityName+'" entity. - '+i);return false}var r=e.descriptionField,o=this.findProperty(e.fields,r);if(r!==undefined){if(!o){p(false,'The "'+r+'" description field was not found '+"in the service metadata document. - "+i);return false}if(o["sap:filterable"]==="false"){p(false,'Expected the "'+o.fullName+'" field to be filterable. - '+i);return false}}return true};l.prototype.checkValueListRequiredMetadataForValidation=function(t){var e=t.valueListAnnotation;if(!e){return false}if(!Array.isArray(e.fields)){return false}return true};l.prototype.getEdmDisplayPath=function(t){var e=t.annotations.text;if(e){return e.path}return t.path};l.prototype.getTextAnnotationPropertyPath=function(t){return t?t.path:""};l.prototype.getAbsolutePropertyPathToValueListEntity=function(t){var e=t.property,i=e&&e["com.sap.vocabularies.Common.v1.Text"],n=t.bindingContextPath;if(typeof n==="string"&&n!==""&&i){return n+"/"+i.Path}var a=t.entitySet,r=t.entityID,p;if(r==null||r===""){return""}if(i&&a){if(t.property.type=="Edm.Guid"){p=t.entityID.toLowerCase()}else{p=t.entityID}p=o.formatValue(p,t.property.type,true);return"/"+a.name+"("+encodeURIComponent(p)+")"+"/"+i.Path}return""};l.prototype.getODataValueListKeyProperty=function(t){for(var e=0;e<t.fields.length;e++){var i=t.fields[e];if(i.name===t.keyField){return i}}};l.prototype.getUOMPath=function(t){if(t&&t.annotations&&t.annotations.uom){return t.annotations.uom.path}return null};l.prototype.getUOMTypePath=function(t){if(t.property.complex){return t.property.typePath.replace(t.property.property.name,t.annotations.uom.property.name)}return t.annotations.uom.property.name};l.prototype.getDropdownChangeHandler=function(t,e){return function(i){var n="",r=false;try{if(e){if(t.getFirstInnerControl&&t.getFirstInnerControl().setEnteredValue){t.getFirstInnerControl().setEnteredValue()}n=i.getSource().getSelectedKey();r=n!==null;if(!r){n=i.getSource().getValue()}}else{var o=i.getParameter("selectedItem");if(!o&&i.getSource().getSelectedItem){o=i.getSource().getSelectedItem()}if(o){n=o.getKey();r=n!==null}}t.fireChange({value:n,newValue:n,selectionChange:r})}catch(t){a.warning(t)}}};l.prototype.applyCriticality=function(t,e){var i=this.getEdmProperty(t),n=t.annotations?.lineitem,a=t.annotations?.datapoint,r=t.annotations?.fieldgroup,o=t.annotations?.connectedfields,p,s,l;if(!i){return}p=i["com.sap.vocabularies.UI.v1.DataFieldDefault"];if(p&&p.RecordType==="com.sap.vocabularies.UI.v1.DataField"&&p["Criticality"]){i.criticalityInfo=this.getAnalyzer()._extractCriticalityInfo(p["Criticality"],p);i.criticalityInfo.criticalityFrom="DataFieldDefault";return}if(n&&n.criticality&&n.criticality[i.name]){i.criticalityInfo=n.criticality[i.name];i.criticalityInfo.criticalityFrom="LineItem";return}if(a){if(a.primaryAnnotation&&!e){s=a.primaryAnnotation}else if(a.additionalAnnotations){s=a.additionalAnnotations[e]}if(s&&s?.Value?.Path===i.name&&s.Criticality){i.criticalityInfo=this.getAnalyzer()._extractCriticalityInfo(s.Criticality,s);i.criticalityInfo.criticalityFrom="DataPoint";return}}l={FieldGroup:r,ConnectedFields:o};for(const t in l){const n=l[t];if(n){for(let a=0;a<n.length;a++){const r=n[a];if(!r.groupName&&!e||r.groupName===e){if(r.criticality&&r.criticality[i.name]){i.criticalityInfo=r.criticality[i.name];i.criticalityInfo.criticalityFrom=t;return}}}}}};l.prototype.destroy=function(){if(this._oAnalyzer){this._oAnalyzer.destroy()}if(this.oAnnotation){this.oAnnotation.destroy()}this._oUtil=null;this.oMeta=null;this.oAnalyzer=null;this.oAnnotation=null};l.prototype.getAutoExpandProperties=function(t){var e=[],i=[];for(var n in t){switch(n){case"com.sap.vocabularies.Common.v1.Text":case"Org.OData.Measures.V1.Unit":case"Org.OData.Measures.V1.ISOCurrency":case"com.sap.vocabularies.Common.v1.FieldControl":if(t[n].Path){i=t[n].Path.split("/")}break}if(i.length>1&&e.indexOf(i[0])<0){e.push(i[0])}}return e.join(",")};l.prototype.loadValueListAnnotation=function(t,e){var i=this.getAnalyzer().getValueListAnnotationLazy(t,e);i.catch(function(){a.error("The value list annotation could not be loaded.",undefined,"sap.ui.comp.smartfield.ODataHelper.loadValueListAnnotation")});return i};l.prototype._setControlDocumentationRef=function(t,e){if(e?.String&&t){sap.ui.require(["sap/ui/core/fieldhelp/FieldHelpUtil"],function(i){i.setDocumentationRef(t,e.String)})}};return l},true);
//# sourceMappingURL=ODataHelper.js.map