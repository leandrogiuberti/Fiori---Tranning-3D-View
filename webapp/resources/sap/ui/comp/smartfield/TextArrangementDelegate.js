/*!
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/comp/library","sap/ui/core/library","sap/ui/core/Core","sap/ui/base/Object","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/base/assert","sap/base/util/deepEqual"],function(t,e,i,r,a,o,n,s){"use strict";var l=t.smartfield.TextInEditModeSource;var d=r.extend("sap.ui.comp.smartfield.TextArrangementDelegate",{constructor:function(t){r.apply(this,arguments);this.oFactory=t;this.oSmartField=t._oParent;this.bValidMetadata=false;this.sBindingContextPath="";this.sAbsolutePathToVLProperty="";this._mOneTimeDescriptionCache=new Map;this._sTextArrangementLastReadValue=null;this._mTextArrangementLastReadAdditionalFilters=null}});d.getPaths=function(t,e){var i=e.property&&e.property.valueListAnnotation;switch(t){case l.NavigationProperty:var r=e.annotations.text;if(!r){return{}}return{keyField:r.entityType.key.propertyRef[0].name,descriptionField:r.property.typePath,entitySetName:r.entitySet.name};case l.ValueList:if(!i){return{}}return{keyField:i.keyField,descriptionField:i.descriptionField,entitySetName:e.property.valueListEntitySet&&e.property.valueListEntitySet.name};case l.ValueListNoValidation:if(!i){return{}}return{valueListNoValidation:true,keyField:i.keyField,descriptionField:i.descriptionField,entitySetName:e.property.valueListEntitySet.name}}};d.prototype.getBindingInfo=function(t){var e,i,r=t&&t.type,a=t&&t.keyType,o=t.valueListNoValidation,n={},s=this.oSmartField,u=this.oFactory,p=u._oMetaData;if(!r||!r.isA("sap.ui.comp.smartfield.type.TextArrangement")&&!r.isA("sap.ui.comp.smartfield.type.TextArrangementString")){var c=s.getBindingInfo("value");r=c&&c.type||{};var y=d.getPaths(u._bTextInDisplayModeValueList?l.ValueList:s._getComputedTextInEditModeSource(),p);if(u.isEmptyStringSignificant()){n.isStringNullable=true}i=u._oTypes.getType(p.property,Object.assign(n,r.oFormatOptions),r.oConstraints,{composite:true,keyField:y.keyField,descriptionField:y.descriptionField,valueListNoValidation:o,valueList:s._getComputedTextInEditModeSource()===l.ValueList,delegate:this});if(Array.isArray(i)){r=i[0];a=i[1]}else{r=i}}var h=this.oSmartField.getBinding("value").getValue(),f=s._getComputedTextInEditModeSource(),g=d.getPaths(this.oFactory._bTextInDisplayModeValueList?l.ValueList:f,p);var F=this.getTextAnnotationPropertyPath({entitySet:{name:g.entitySetName},entityID:h});if(F===""||F.indexOf("undefined")!==-1){F="__$$SmartFieldNotExistingBindingPath"}e={model:p.model,type:r,parts:[{path:p.path},{path:F}]};if(a){e.parts[0].type=a}return e};d.prototype.getTextAnnotationPropertyPath=function(t){t=t||{};var e=t.textInEditModeSource||this.oSmartField._getComputedTextInEditModeSource(),i=this.oFactory,r=i._oMetaData,a=r.annotations&&r.annotations.text,o=t.textAnnotation||a;if(i._bTextInDisplayModeValueList){e=l.ValueList}switch(e){case l.NavigationProperty:return i._oHelper.getTextAnnotationPropertyPath(o);case l.ValueList:case l.ValueListNoValidation:var n=t.edmValueListKeyProperty||r.property.valueListKeyProperty,s=t.bindingContextPath||this.sBindingContextPath;if(o&&s!=="/undefined"&&this.oSmartField._isValueInitial()){var d=i._oHelper.getTextAnnotationPropertyPath(o);if(d&&d!==this.oFactory.getMetaData().path){return d}}return i._oHelper.getAbsolutePropertyPathToValueListEntity({property:n,bindingContextPath:s,entitySet:t.entitySet,entityID:t.entityID});case l.None:return"";default:return""}};d.prototype.checkRequiredMetadata=function(t,e){var i=this.oFactory,r=i._oMetaData,a=r.property,o=a.property,n=a.valueListKeyProperty,s=this.oSmartField.getTextInEditModeSource(),d=s===l.ValueList||s===l.ValueListWarning,u=o&&o["com.sap.vocabularies.Common.v1.Text"]||n&&n["com.sap.vocabularies.Common.v1.Text"];if(!u&&!d){return false}switch(t){case l.None:return false;case l.NavigationProperty:var p=r.annotations.text,c;if(p){c=p.entityType}var y={propertyName:r.property&&r.property.property&&r.property.property.name,entityType:r.entityType,entityTypeOfNavigationProperty:c,textAnnotation:r.property&&r.property.property&&r.property.property["com.sap.vocabularies.Common.v1.Text"]};if(e){return i._oHelper.checkNavigationPropertyRequiredMetadataNoAsserts(y)}else{return i._oHelper.checkNavigationPropertyRequiredMetadata(y)}case l.ValueList:case l.ValueListNoValidation:var h={propertyName:r.property&&r.property.property&&r.property.property.name,entityType:r.entityType,valueListAnnotation:r.property&&r.property.valueListAnnotation};if(e){return i._oHelper.checkValueListRequiredMetadataForTextArrangmentNoAsserts(h)}else{return i._oHelper.checkValueListRequiredMetadataForTextArrangment(h)}default:return false}};d.prototype.onBeforeValidateValue=function(t,e){var i=this.oSmartField;if(!i.getBindingContext()){return}var r=this.onFetchIDAndDescriptionCollectionSuccess.bind(this,{value:t,mode:i.getMode(),noRebind:e.noRebind,success:e.success,filterFields:e.filterFields,userInteractionValue:true});var a=this.onFetchIDAndDescriptionCollectionError.bind(this,{error:e.error});var o={value:t,success:r,error:a,filterFields:e.filterFields,updateBusyIndicator:true,bCheckValuesValidity:e.bCheckValuesValidity};return this.fetchIDAndDescriptionCollection(o)};d.prototype.fetchIDAndDescriptionCollectionIfRequired=function(t){var e,i,r,a=this.oSmartField,o=t.mode,n=t.forceTextArrangementFetch,d=a._getInnerControlPropertyBinding(o),u=a.getBinding("value"),p=d&&d.getType(),c=p&&p.isA("sap.ui.comp.smartfield.type.TextArrangement")||false,y=a._getComputedTextInEditModeSource(),h=this.oFactory,f=y===l.ValueList,g=a._isValueInitial();if(h){e=h.getMetaData();i=h._getLocalTextAnnotation()}if(i&&(e&&i.path===e.path||this.sBindingContextPath==="/undefined"||!g)){i=null}if(i&&g&&!a._isValueInValidation()){return}if(f||!i&&y===l.ValueListNoValidation&&this.oFactory._getDisplayBehaviourConfiguration()!=="idOnly"||this.oFactory._bTextInDisplayModeValueList){var F,m,v,P,V=false,D=a.getModel(),A=this.getAdditionalFiltersData(a,a.getControlFactory().getMetaData(),{}),L=this._mTextArrangementLastReadAdditionalFilters&&!s(this._mTextArrangementLastReadAdditionalFilters,A);if(D&&d){if(c){F=d.getBindings();m=D.getProperty(F[0].getResolvedPath());if(p.oFormatOptions.textArrangement==="descriptionOnly"){v=D.getProperty(F[1].getResolvedPath());if(v&&[v,m].includes(this._sTextArrangementLastReadValue)){V=true}}else{V=this._sTextArrangementLastReadValue===m}}else{m=D.getProperty(u.getResolvedPath());V=this._sTextArrangementLastReadValue===m}P=m===undefined||m===null}if(!P&&(L||!V||!c||n)){r=["keyField"];var T={value:m,mode:o,initialRendering:true,filterFields:r};return this.fetchIDAndDescriptionCollection({value:m,filterFields:r,updateBusyIndicator:false,success:this.onFetchIDAndDescriptionCollectionSuccess.bind(this,T)})}}};d.prototype.fetchIDAndDescriptionCollection=function(t){var e=t.value,i=this.oSmartField;if(t.bCheckValuesValidity){t.filterFields=["keyField"]}var r=i._oControl&&i._oControl.edit;if(r&&t.updateBusyIndicator){r.setBusyIndicatorDelay(300);r.setBusy(true)}i._setValueInValidation(e);return this.readODataModel(t).then(function(){i._bValueNotInitial=true}).finally(function(){if(r&&t.updateBusyIndicator){r.setBusyIndicatorDelay(0);r.setBusy(false)}i._setValueInValidation(undefined)})};d.prototype.readODataModel=function(t){var e=this.oSmartField,i,r,a,o,n,s=e._getComputedTextInEditModeSource(),u=e.getControlFactory().getMetaData(),p=d.getPaths(this.oFactory._bTextInDisplayModeValueList?l.ValueList:s,u),c="/"+p.entitySetName,y=u&&u.annotations&&u.annotations.valueListData||null,h=p.keyField,f=p.descriptionField,g=this.oFactory&&this.oFactory.getValueListProvider(),F=y&&y.valueListEntitySetName===p.entitySetName,m=F&&y&&y.outParams?Object.values(y.outParams):[],v=F&&y&&y.fields?y.fields:[],P={success:t.success,error:t.error},V=e.getSuppressEmptyStringRequest(),D=this.oFactory.isEmptyStringSignificant(),A=this.oFactory._isFixedList();if(!f&&(this.oSmartField.getMode()==="display"||!e._isValueListValidationMode())){return Promise.resolve()}this._sTextArrangementLastReadValue=t.value;try{i=this.getAbsolutePathToVLProperty();if(i){r=this.getSelectedEntity(i);if(r){this.clearAbsolutePathToVLProperty();t.success(r);return Promise.resolve()}}}catch(t){return Promise.reject(t)}n=this.getDataForNextDescriptionRequest(t.value);if(n&&n.hasOwnProperty(f)&&g&&g._shouldHaveHistory&&!g._shouldHaveHistory()){t.success(n);return Promise.resolve()}o=this.getAdditionalFiltersData(e,u,n);var L={keyFieldPath:h,aFilterFields:["keyField"]};if(f){L.descriptionFieldPath=f;L.aFilterFields=t.filterFields}for(a in o){t.filterFields.push(a)}L.additionalFilters=o;var T=this.getFilters(t.value,L);if(T.length===0){return Promise.resolve()}var x=this.getUrlParameters({keyField:h,descriptionField:f,outParams:m,allFields:v});P.filters=T;P.urlParameters=x;this._mTextArrangementLastReadAdditionalFilters=o;if(D&&!A&&V===true&&t.value===""){t.success=null;this.onFetchIDAndDescriptionCollectionSuccess(t,{results:[]});return Promise.resolve()}return e._getTextArrangementRead().read(e.getModel(),c,P).then(t.success).catch(t.error)};d.prototype.getSelectedEntity=function(t){return t!==""&&this.oSmartField.getBindingContext().getProperty(t)};d.prototype.clearAbsolutePathToVLProperty=function(){this.sAbsolutePathToVLProperty=""};d.prototype.setAbsolutePathToVLProperty=function(t){this.sAbsolutePathToVLProperty=t};d.prototype.getAbsolutePathToVLProperty=function(){return this.sAbsolutePathToVLProperty};d.prototype.getAdditionalFiltersData=function(t,e,i){var r,a,o,n,s,l={};if(typeof i==="undefined"){i={}}if(e&&e.annotations&&e.annotations.valueListData){a=e.annotations.valueListData.inParams;r=e.annotations.valueListData.constParams}if(r){for(o in r){l[o]=r[o]}}if(a){for(n in a){s=a[n];if(s!==e.annotations.valueListData.keyField){l[s]=i[s]!==undefined?i[s]:t.getBindingContext().getProperty(n)}}}return l};d.prototype._setBindingPath=function(t,e,i,r,a){var o=t.getModel(),s;n(Array.isArray(e)," - "+this.getMetadata().getName());if(o){this.invalidateDescription(i,r,false);if(Array.isArray(e)&&e.length===1){s=o.getKey(e[0])}if(a&&e.length!==1){this.sBindingContextPath="/"+s;this.bindPropertyForValueList(i,r,true)}else if(typeof s==="string"){this.sBindingContextPath="/"+s;this.bindPropertyForValueList(i,r,false,a)}else if(e.length!==1&&i==="text"){this.sBindingContextPath=undefined;this.bindPropertyForValueList(i,r,false)}else if(e.length!==1){this.invalidateDescription(i,r,true)}}};d.prototype.invalidateDescription=function(t,e,i){var r,a=e&&e.getBinding(t),o,n=a&&a.getType();if(!n){o=e&&e.getBindingInfo(t);n=o&&o.type}if(n&&n.isA("sap.ui.comp.smartfield.type.TextArrangement")){r=n.getDescriptionIsInvalid();if(r!==i){n.setDescriptionIsInvalid(i);if(a){a.refresh(true)}}}};d.prototype.onFetchIDAndDescriptionCollectionSuccess=function(t,e,i){var r,a=true,o,n,s,d,u,p,c,y=this.oSmartField;if(!y){return}n=t.mode||y.getMode();r=e&&Array.isArray(e.results)&&e.results.length===1?e.results[0]:null;o=y.getControlFactory()&&y.getControlFactory().getValueListProvider()||null;s=y._oControl.edit;d=y._oControl.display;u=e&&e.results===undefined?[e]:e.results;c=y._getComputedTextInEditModeSource();if(r&&o&&t.userInteractionValue){o._calculateAndSetODataModelOutputData(r);if(n==="edit"&&!t.initialRendering&&c!==l.NavigationProperty){o._oHistoryValuesProvider&&o._oHistoryValuesProvider.setFieldData([r])}}if(!t.initialRendering){y.oValidation.handleValueListWarning(u)}if(typeof t.success==="function"){a=t.success(u)}if(!a&&c!==l.ValueListNoValidation){return}if(t.noRebind){return}if(d){this._setBindingPath(y,u,"text",d)}if(s&&y.isTextInEditModeSourceNotNone("edit")){p=c===l.ValueListNoValidation;this._setBindingPath(y,u,"value",s,p)}};d.prototype.onFetchIDAndDescriptionCollectionError=function(t,e){if(typeof t.error==="function"){t.error(e)}};d.prototype.bindPropertyForValueList=function(t,e,i,r){var a=this.oSmartField,o={},n,s,d,u,p=a._getComputedTextInEditModeSource();if(p===l.ValueList||p===l.ValueListNoValidation||this.oFactory._bTextInDisplayModeValueList){s=e&&e.getBindingInfo(t);if(this.oFactory&&s){d=s.type;if(s.parts&&s.parts[0]){u=s.parts[0].type}if((!d||!d.isA("sap.ui.comp.smartfield.type.TextArrangement"))&&this.oFactory._getTextArrangementType){n=this.oFactory._getTextArrangementType();if(n){d=n}}if(d){o={type:d}}if(u){o.keyType=u}o.skipValidation=i;o.bValueListNoValidation=r;e.bindProperty(t,this.getBindingInfo(o))}}};d.prototype.getUrlParameters=function(t){var e=[t.keyField];if(t.descriptionField){e.push(t.descriptionField)}t.outParams.forEach(function(t){if(e.indexOf(t)===-1){e.push(t)}});if(this.oSmartField._getComputedTextInEditModeSource()!==l.NavigationProperty){e=t.allFields.map(function(t){return t.name})}return{$select:e.join(","),$top:2}};d.prototype.getFilters=function(t,e){this.destroyFilters();var i=e.aFilterFields,r;if(Array.isArray(i)&&i.length===1&&Object.keys(e.additionalFilters).length===0){switch(i[0]){case"keyField":this.oIDFilter=u(t,e);return[this.oIDFilter];case"descriptionField":this.oDescriptionFilter=p(t,e);return[this.oDescriptionFilter]}}this.oIDFilter=u(t,e);r=this._getAdditionalFilters(e);this.oFilters=new a({and:true,filters:[new a({and:false,filters:[this.oIDFilter]})]});if(r.aFilters.length>0){this.oFilters.aFilters.push(r)}return[this.oFilters]};d.prototype.setDataForNextDescriptionRequest=function(t,e){this._mOneTimeDescriptionCache.set(t,e)};d.prototype.getDataForNextDescriptionRequest=function(t){var e=this._mOneTimeDescriptionCache.get(t);this._mOneTimeDescriptionCache.delete(t);return e};function u(t,e){return new a({value1:t,path:e.keyFieldPath,operator:o.EQ})}function p(t,e){return new a({value1:t,path:e.descriptionFieldPath,operator:o.EQ})}d.prototype._getAdditionalFilters=function(t){var e=[],i=this.oSmartField.getControlFactory().getMetaData(),r=i.annotations&&i.annotations.valueListData,o=r&&r.fields;Object.keys(t.additionalFilters).forEach(function(i){var a=t.additionalFilters[i],n=o.find(function(t){return t.name===i}),s=r.aInitialValueIsSignificantFields.indexOf(i)!==-1,l=this._generateFiltersForField(a,i,n,s);if(l){e.push(l)}}.bind(this));return new a({and:true,filters:e})};d.prototype._generateFiltersForField=function(t,e,i,r){if(t===null||t===undefined||t===""){if(r){return this._generateFiltersForEmptyField(e,i&&i.nullable==="false")}}else{return new a({value1:t,path:e,operator:o.EQ})}};d.prototype._generateFiltersForEmptyField=function(t,e){if(e){return new a({value1:"",path:t,operator:o.EQ})}return new a([new a({value1:"",path:t,operator:o.EQ}),new a({value1:null,path:t,operator:o.EQ})],false)};d.prototype.destroyFilters=function(){if(this.oIDFilter){this.oIDFilter.destroy();this.oIDFilter=null}if(this.oDescriptionFilter){this.oDescriptionFilter.destroy();this.oDescriptionFilter=null}if(this.oFilters){this.oFilters.destroy();this.oFilters=null}};d.prototype.destroy=function(){this.oSmartField=null;this.bValidMetadata=false;this.sBindingContextPath="";this.sAbsolutePathToVLProperty="";this._mOneTimeDescriptionCache=null;this._mTextArrangementLastReadAdditionalFilters=null;this.destroyFilters()};return d});
//# sourceMappingURL=TextArrangementDelegate.js.map