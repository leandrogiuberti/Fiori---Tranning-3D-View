/*!
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/core/Element","sap/ui/core/Lib","sap/ui/thirdparty/jquery","sap/ui/comp/library","sap/ui/base/ManagedObject","./SemanticObjectController","sap/ui/model/json/JSONModel","sap/ui/model/BindingMode","sap/ui/core/Control","./Factory","./NavigationPopover","./Util","sap/m/VBox","./LinkData","sap/m/MessageBox","sap/ui/comp/personalization/Controller","sap/ui/comp/personalization/Util","./NavigationContainer","./ContactDetailsController","./Log","sap/ui/core/InvisibleText","sap/ui/core/CustomData","sap/base/Log","sap/base/util/isPlainObject","sap/ui/core/Component","sap/base/util/merge","sap/base/strings/whitespaceReplacer"],function(t,e,jQuery,i,n,a,o,r,s,l,c,p,u,g,v,d,f,m,b,h,y,P,A,C,N,_,O){"use strict";var S=n.extend("sap.ui.comp.navpopover.NavigationPopoverHandler",{metadata:{library:"sap.ui.comp",properties:{semanticObject:{type:"string",defaultValue:null},additionalSemanticObjects:{type:"string[]",defaultValue:[]},semanticObjectController:{type:"any",defaultValue:null},fieldName:{type:"string",defaultValue:null},semanticObjectLabel:{type:"string",defaultValue:null},mapFieldToSemanticObject:{type:"boolean",defaultValue:true},contactAnnotationPath:{type:"string",defaultValue:undefined},enableAvailableActionsPersonalization:{type:"boolean",defaultValue:true},beforeNavigationCallback:{type:"function"},navigationTargetsObtainedCallback:{type:"function"}},aggregations:{_popover:{type:"sap.ui.comp.navpopover.NavigationPopover",multiple:false,visibility:"hidden"}},associations:{control:{type:"sap.ui.core.Control",multiple:false}},events:{beforePopoverOpens:{parameters:{semanticObject:{type:"string"},semanticAttributes:{type:"object"},semanticAttributesOfSemanticObjects:{type:"object"},setSemanticAttributes:{type:"function"},setAppStateKey:{type:"function"},originalId:{type:"string"},open:{type:"function"}}},navigationTargetsObtained:{parameters:{mainNavigation:{type:"sap.ui.comp.navpopover.LinkData"},actions:{type:"sap.ui.comp.navpopover.LinkData[]"},ownNavigation:{type:"sap.ui.comp.navpopover.LinkData"},popoverForms:{type:"sap.ui.layout.form.SimpleForm[]"},semanticObject:{type:"string"},semanticAttributes:{type:"object"},originalId:{type:"string"},show:{type:"function"}}},innerNavigate:{parameters:{text:{type:"string"},href:{type:"string"},semanticObject:{type:"string"},semanticAttributes:{type:"object"},originalId:{type:"string"}}}}}});S.prototype.init=function(){this._oPopover=null;this._oContactDetailsController=new b;var t=new o({semanticObject:undefined,semanticAttributes:undefined,appStateKey:undefined,mainNavigationId:undefined,navigationTarget:{mainNavigation:undefined,enableAvailableActionsPersonalization:undefined,extraContent:undefined},availableActions:[]});t.setDefaultBindingMode(r.TwoWay);t.setSizeLimit(1e3);this.setModel(t,"$sapuicompNavigationPopoverHandler");this._oRTANavigationHandling={enabled:false,initialValue:undefined};this._oLog=A.getLevel()>=A.Level.INFO?new h:undefined};S.prototype.applySettings=function(t){n.prototype.applySettings.apply(this,arguments);this._setSemanticAttributes(this._calculateSemanticAttributes(null))};S.prototype.openPopover=function(t){var e=this;return this._getPopover().then(function(i){var n=i.getDirectLink();if(n){e._fireInnerNavigate({text:n.getText(),href:n.getHref(),internalHref:n.data("internalHref")});e._destroyPopover();return}i.show(t)})};S.prototype.getSemanticObjectValue=function(){var t=this._getSemanticAttributes();if(t){return t[this.getSemanticObject()][this.getSemanticObject()]}return undefined};S.prototype.getNavigationPopoverStableId=function(){var e=t.getElementById(this.getControl());if(!e){A.error("NavigationPopoverHandler: Stable ID could not be determined because the control is undefined");return undefined}var i=this._getComponent(e);if(!i){A.error("NavigationPopoverHandler: Stable ID could not be determined because the app component is not defined for control '"+e.getId()+"'");return undefined}var n=this.getModel("$sapuicompNavigationPopoverHandler").getProperty("/semanticObject");if(!n){A.error("NavigationPopoverHandler: Stable ID could not be determined because no default semantic object is defined");return undefined}var a=[n].concat(this.getAdditionalSemanticObjects());p.sortArrayAlphabetical(a);var o=a.join("--");return i.createId("sapuicompnavpopoverNavigationPopover---"+o)};S.prototype.updateBindingContext=function(){var t=this.getBindingContext("$sapuicompNavigationPopoverHandler");s.prototype.updateBindingContext.apply(this,arguments);var e=this.getBindingContext("$sapuicompNavigationPopoverHandler");if(e&&e!==t){this._setSemanticAttributes(this._calculateSemanticAttributes(null));this._destroyPopover()}};S.prototype.setSemanticObject=function(t){this._destroyPopover();this.setProperty("semanticObject",t);this.getModel("$sapuicompNavigationPopoverHandler").setProperty("/semanticObject",t);this._setSemanticAttributes(this._calculateSemanticAttributes(null));return this};S.prototype._setSemanticAttributes=function(t){this.getModel("$sapuicompNavigationPopoverHandler").setProperty("/semanticAttributes",t)};S.prototype._getSemanticAttributes=function(){return this.getModel("$sapuicompNavigationPopoverHandler").getProperty("/semanticAttributes")};S.prototype.setEnableAvailableActionsPersonalization=function(t){this.setProperty("enableAvailableActionsPersonalization",t);this.getModel("$sapuicompNavigationPopoverHandler").setProperty("/navigationTarget/enableAvailableActionsPersonalization",t);return this};S.prototype.setFieldName=function(t){this.setProperty("fieldName",t);this._setSemanticAttributes(this._calculateSemanticAttributes(null));return this};S.prototype.setControl=function(t){this.setAssociation("control",t);this.setModel(t.getModel());this._destroyPopover();this._updateSemanticObjectController();this._setSemanticAttributes(this._calculateSemanticAttributes(null));return this};S.prototype.setMapFieldToSemanticObject=function(t){this.setProperty("mapFieldToSemanticObject",t);this._setSemanticAttributes(this._calculateSemanticAttributes(null));return this};S.prototype.setSemanticObjectController=function(t){this._updateSemanticObjectController(t);this._setSemanticAttributes(this._calculateSemanticAttributes(null));return this};S.prototype.exit=function(){this._oContactDetailsController.destroy();this._destroyPopover();if(this.getSemanticObjectController()){this.getSemanticObjectController().unregisterControl(this)}if(this.getModel("$sapuicompNavigationPopoverHandler")){this.getModel("$sapuicompNavigationPopoverHandler").destroy()}this._oRTANavigationHandling=undefined};S.prototype._initModel=function(){var i=this;var n;var a=this.getSemanticObject();var o=this.getAdditionalSemanticObjects();var r=p.getContactAnnotationPath(this,this.getSemanticObjectController());var s=t.getElementById(this.getControl());if(!s){A.error("sap.ui.comp.navpopover.NavigationPopoverHandler: No control provided, popover cannot be attached.")}var l=s&&s.getBindingContext()?s.getBindingContext().getPath():null;if(!l){A.warning("sap.ui.comp.navpopover.NavigationPopoverHandler: Binding Context is null. Please be aware that without binding context no semantic attributes can be calculated. Without semantic attributes no URL parameters can be created.")}var c=this.getModel();var u=this._getComponent(s);var v=s&&s.getId();var d,f,m;if(this._oLog){this._oLog.reset()}return e.load({name:"sap.ui.fl"}).then(function(){return p.retrieveSemanticObjectMapping(i.getFieldName(),c,l)}).then(function(t){i._setSemanticAttributes(i._calculateSemanticAttributes(t,i._oLog));n=i._getSemanticAttributes();return i._fireBeforePopoverOpens(n,a,v,i._oLog)}).then(function(t){n=t.semanticAttributes;i._setSemanticAttributes(n);f=i.getSemanticObjectValue();d=s&&s._getTextOfDom&&s._getTextOfDom()||i.getSemanticObjectValue();i.getModel("$sapuicompNavigationPopoverHandler").setProperty("/appStateKey",t.appStateKey);return p.retrieveNavigationTargets(a,o,t.appStateKey,u,n,d,i.getFieldName(),c,l,i._oLog)}).then(function(t){m=t;i._oContactDetailsController.setModel(c);return i._oContactDetailsController.getBindingPath4ContactAnnotation(l,r,f)}).then(function(t){var e=i._oContactDetailsController.getContactDetailsContainers(t);return i._fireNavigationTargetsObtained(d,a,n,v,e,m,i._oLog)}).then(function(t){var e=t.availableActions;var n=[];if(e){e.forEach(function(t){if(t.getText()){t.setText(O(t.getText()))}if(t.getHref()){t.setInternalHref(t.getHref());n.push(i._convertToExternal(t.getHref()).then(function(e){t.setHref(e)}))}})}var a=t.mainNavigation;if(a){if(a.getDescription()){a.setDescription(O(a.getDescription()))}if(a.getText()){a.setText(O(a.getText()))}if(a.getHref()){a.setInternalHref(a.getHref());n.push(i._convertToExternal(a.getHref()).then(function(t){a.setHref(t)}))}}if(t.mainNavigationId){t.mainNavigationId=O(t.mainNavigationId)}return Promise.all(n).then(function(){var n=i.getModel("$sapuicompNavigationPopoverHandler");n.setProperty("/mainNavigationId",t.mainNavigationId);n.setProperty("/navigationTarget/mainNavigation",a);n.setProperty("/navigationTarget/extraContent",t.extraContent);n.setProperty("/availableActions",i._updateVisibilityOfAvailableActions(g.convert2Json(e)));n.setProperty("/navigationTarget/enableAvailableActionsPersonalization",i._getEnableAvailableActionsPersonalization(n.getProperty("/availableActions")));if(A.getLevel()>=A.Level.TRACE){A.info("sap.ui.comp.NavigationPopoverHandler: calculation of semantic attributes\n---------------------------------------------\nBelow you can see detailed information regarding semantic attributes which have been calculated for one or more semantic objects defined in a SmartLink control. Semantic attributes are used to create the URL parameters. Additionally you can see all links containing the URL parameters.\n"+i._getLogFormattedText())}})})};S.prototype._initPopover=function(){var e=this;return this._initModel().then(function(){var i=e.getModel("$sapuicompNavigationPopoverHandler");var n=e._createPopover();n.setModel(i,"$sapuicompNavigationPopoverHandler");var a=t.getElementById(e.getControl());if(a){a.addDependent(n)}return n})};S.prototype._initNavigationContainer=function(){var e=this;return this._initModel().then(function(){var i=e.getModel("$sapuicompNavigationPopoverHandler");var n=e._createNavigationContainer();n.setModel(i,"$sapuicompNavigationPopoverHandler");var a=t.getElementById(e.getControl());if(a){a.addDependent(n)}return n})};S.prototype._getPopover=function(){if(!this._oPopover){return this._initPopover()}else{return Promise.resolve(this._oPopover)}};S.prototype._getNavigationContainer=function(){return this._initNavigationContainer().then(function(t){return t})};S.prototype._destroyPopover=function(){if(this._oPopover){this._oPopover.destroy();this._oPopover=null}};S.prototype._createPopover=function(){if(this._oPopover){return this._oPopover}var t=this._createNavigationContainer();this._oPopover=new c({customData:new P({key:"useExternalContent"}),content:[t],title:"{$sapuicompNavigationPopoverHandler>/mainNavigationId}",source:this.getControl(),beforeClose:function(){this.removeAllContent().forEach(function(t){t.destroy()})},afterClose:this._destroyPopover.bind(this),ariaLabelledBy:t.getExtraContent()||t._oHeaderArea.getItems()[0].getContent().getId()});this.setAggregation("_popover",this._oPopover);return this._oPopover};S.prototype._createNavigationContainer=function(){var e=this.getNavigationPopoverStableId();if(!e){A.error("NavigationPopoverHandler: Due to undefined stable ID the button of action personalization is set to disabled")}var i=t.getElementById(e);if(i){if(i.getParent()&&i.getParent().getParent()&&i.getParent().getParent().isA("sap.ui.comp.navpopover.NavigationPopover")){i.getParent().getParent().close();if(!i.isDestroyed()){i.destroy()}}else{A.error("Duplicate ID '"+e+"'. The instance of NavigationContainer should be destroyed first in order to avoid duplicate creation of NavigationContainer with stable ID.");throw"Duplicate ID"}}var n=this.getModel("$sapuicompNavigationPopoverHandler");return new m(e,{mainNavigationId:"{$sapuicompNavigationPopoverHandler>/mainNavigationId}",mainNavigation:n.getProperty("/navigationTarget/mainNavigation"),availableActions:{path:"$sapuicompNavigationPopoverHandler>/availableActions",templateShareable:false,template:new g({key:"{$sapuicompNavigationPopoverHandler>key}",href:"{$sapuicompNavigationPopoverHandler>href}",internalHref:"{$sapuicompNavigationPopoverHandler>internalHref}",text:"{$sapuicompNavigationPopoverHandler>text}",target:"{$sapuicompNavigationPopoverHandler>target}",description:"{$sapuicompNavigationPopoverHandler>description}",visible:"{$sapuicompNavigationPopoverHandler>visible}"})},extraContent:n.getProperty("/navigationTarget/extraContent")?n.getProperty("/navigationTarget/extraContent").getId():undefined,component:this._getComponent(t.getElementById(this.getControl())),enableAvailableActionsPersonalization:"{$sapuicompNavigationPopoverHandler>/navigationTarget/enableAvailableActionsPersonalization}",beforePopoverOpen:function(){if(this._oPopover){this._oPopover.setModal(true)}}.bind(this),afterPopoverClose:function(){if(this._oPopover){this._oPopover.setModal(false)}}.bind(this),navigate:this._onNavigate.bind(this),control:this.getControl()})};S.prototype._convertToExternal=function(t){return l.getServiceAsync("Navigation").then(function(e){if(!e){return Promise.resolve(t)}return e.getHref({target:{shellHash:t}},this._getComponent())}.bind(this))};S.prototype._fireBeforePopoverOpens=function(t,e,i,n){var a=this;return new Promise(function(o){var r={semanticAttributes:t,appStateKey:undefined};if(!a.hasListeners("beforePopoverOpens")){o(r);return}var s=function(t){var e=Object.keys(t).filter(function(e){return!jQuery.isEmptyObject(t[e])});return!!e.length};a.fireBeforePopoverOpens({originalId:i,semanticObject:e,semanticAttributes:!jQuery.isEmptyObject(t[e])?t[e]:null,semanticAttributesOfSemanticObjects:s(t)?t:null,setSemanticAttributes:function(t,i){i=i||e;r.semanticAttributes=r.semanticAttributes||{};if(n){n.updateSemanticObjectAttributes(i,r.semanticAttributes[i],t)}r.semanticAttributes[i]=t},setAppStateKey:function(t){r.appStateKey=t},open:function(){return o(r)}})})};S.prototype._fireNavigationTargetsObtained=async function(t,e,i,n,a,o,r){var s=this;const l=(t,e)=>{e??=t;const i=e.mainNavigationId;if(i!==undefined&&i!==null){t.mainNavigationId=i}const n=e.mainNavigation;if(n!==undefined){t.mainNavigation=n;if(r&&n){r.addIntent({text:n.getText(),intent:n.getHref()})}}const a=e.actions;if(a){a.forEach(function(t){if(t.getKey()===undefined){A.error("'key' attribute of 'availableAction' '"+t.getText()+"' is undefined. Links without 'key' can not be persisted.");A.warning("The 'visible' attribute of 'availableAction' '"+t.getText()+"' is set to 'true'");t.setVisible(true)}if(r&&t){r.addIntent({text:t.getText(),intent:t.getHref()})}});t.availableActions=a}const o=e.extraContent;if(o){t.extraContent=o}return t};const c={mainNavigationId:t,extraContent:a.length?new u({items:a}):undefined};const p={mainNavigation:o.mainNavigation,actions:o.availableActions,ownNavigation:o.ownNavigation,popoverForms:a,semanticObject:e,semanticAttributes:i?i[e]:i,originalId:n};const v=this.getNavigationTargetsObtainedCallback();if(v){if(s.hasListeners("navigationTargetsObtained")){s.fireNavigationTargetsObtained({...p,show:function(){A.warning(`sap.ui.comp.navpopover.NavigationPopoverHandler: "navigationTargetsObtained" event handling will be ignored as "navigationTargetsObtainedCallback" property is set.`)}})}const t={...p,...c};const e=await v(t);return l(t,e)}return new Promise(function(t){const e={...o,...c};if(!s.hasListeners("navigationTargetsObtained")){t(e);return}s.fireNavigationTargetsObtained({...p,show:function(i,n,a,o){if(arguments.length>0&&!(typeof i==="string"||n instanceof g||Array.isArray(a))&&o===undefined){o=a;a=n;n=i;i=undefined}return t(l(e,{mainNavigationId:i,mainNavigation:n,actions:a,extraContent:o}))}})})};S.prototype._onNavigate=function(t){var e=t.getParameters();this._fireInnerNavigate({text:e.text,href:e.href,internalHref:e.internalHref})};S.prototype._fireInnerNavigate=function(e){var i=t.getElementById(this.getControl());var n=this.getSemanticObject();var a=this._getSemanticAttributes();if(this.getAdditionalSemanticObjects().length>0){var o=this.getAdditionalSemanticObjects().find(function(t){return e.href.includes(t)});if(o){n=o}}var r={text:e.text,href:e.href,originalId:i?i.getId():undefined,semanticObject:n,semanticAttributes:a?a[n]:a};if(this.getBeforeNavigationCallback()){this.getBeforeNavigationCallback()(_({},r)).then(function(t){if(t===true){r.internalHref=e.internalHref;this.fireInnerNavigate(r);if(!this.getSemanticObjectController()){p.navigate(e.internalHref)}}}.bind(this))}else{r.internalHref=e.internalHref;this.fireInnerNavigate(r);if(!this.getSemanticObjectController()){p.navigate(e.internalHref)}}};S.prototype._getComponent=function(t){if(!t){return null}var e=t.getParent();while(e){if(e instanceof N){if(e&&e.getAppComponent){e=e.getAppComponent()}return e}e=e.getParent()}return N.getComponentById(N.getOwnerIdFor(t))};S.prototype.getAppComponent=function(){return this._getComponent(t.getElementById(this.getControl()))};S.prototype._getBindingContextObject=function(){var e=t.getElementById(this.getControl());var i=this.getBindingContext()||e&&e.getBindingContext();return i?i.getObject(i.getPath()):null};S.prototype._getLogFormattedText=function(){return this._oLog?this._oLog.getFormattedText():"No logging data available"};S.prototype._calculateSemanticAttributes=function(t,e){var i=this._getBindingContextObject();var n=this.getFieldName();var a=this;var o=["",this.getSemanticObject()].concat(this.getAdditionalSemanticObjects());var r={};o.forEach(function(o){r[o]={};var s=a._getMappingRules(o,t,i);for(var l in i){var c=null,p=null;if(e&&o){c={transformations:[]};e.addSemanticObjectAttribute(o,l,c)}if(i[l]===undefined||i[l]===null){if(c){c.transformations.push({value:i[l],description:"ℹ Undefined and null values have been removed in NavigationPopoverHandler."})}continue}if(C(i[l])){if(c){c.transformations.push({value:i[l],description:"ℹ Plain objects has been removed in NavigationPopoverHandler."})}continue}var u=s[l];if(c&&l!==u){p=t?{value:undefined,description:"ℹ The attribute "+l+" has been renamed to "+u+" in NavigationPopoverHandler.",reason:"🔴 A com.sap.vocabularies.Common.v1.SemanticObjectMapping annotation is defined for semantic object "+o+" with source attribute "+l+" and target attribute "+u+". You can modify the annotation if the mapping result is not what you expected."}:{value:undefined,description:"ℹ The attribute "+l+" has been renamed to "+u+" in NavigationPopoverHandler.",reason:"🔴 The property mapFieldToSemanticObject is set to true. Attribute "+l+" is mapped to "+u+". (semantic object is "+a.getSemanticObject()+", field name is "+a.getFieldName()+"). If this is not what you expected, you can set the property to false or define a com.sap.vocabularies.Common.v1.SemanticObjectMapping annotation."}}var g=i[l];if(r[o][u]){if(i[n]){if(u===s[a.getFieldName()]){g=i[n]}else{A.error("The attribute "+l+" can not be renamed to the attribute "+u+" due to a clash situation. This can lead to wrong navigation later on.")}}}r[o][u]=g;if(c){c.transformations.push({value:i[l],description:"ℹ The attribute "+l+" with the value "+i[l]+" is taken from the binding context in NavigationPopoverHandler."});if(p){c.transformations.push(p);e.addSemanticObjectAttribute(o,u,{transformations:[{value:g,description:"ℹ The attribute "+u+" with the value "+g+" has been added due to a mapping rule regarding the attribute "+l+" in NavigationPopoverHandler."}]})}}}});return r};S.prototype._getMappingRules=function(t,e,i){var n=this.getMapFieldToSemanticObject();if(this.getSemanticObjectController()&&this.getSemanticObjectController().getMapFieldToSemanticObject()!==undefined){n=this.getSemanticObjectController().getMapFieldToSemanticObject()}var a;var o={};if(e){for(a in e[t]){if(typeof e[t][a]==="string"){o[a]=e[t][a]}}}else if(n){if(this.getSemanticObjectController()){var r=this.getSemanticObjectController().getFieldSemanticObjectMap();for(a in r){o[a]=r[a]}}if(this.getFieldName()&&this.getSemanticObject()){o[this.getFieldName()]=this.getSemanticObject()}}for(a in i){if(!o.hasOwnProperty(a)){o[a]=a}}return o};S.prototype._updateSemanticObjectController=function(e){var i=this.getProperty("semanticObjectController");var n=t.getElementById(this.getControl());e=e||this.getSemanticObjectController()||this._getSemanticObjectControllerOfControl(n);if(e&&n&&e.isControlRegistered(n)){e.unregisterControl(this)}if(e!==i&&i){i.unregisterControl(this)}this.setProperty("semanticObjectController",e);if(e&&!e.isControlRegistered(n)){e.registerControl(this)}};S.prototype._getSemanticObjectControllerOfControl=function(t){if(!t){return undefined}var e;var i=t.getParent();while(i){if(i.getSemanticObjectController){e=i.getSemanticObjectController();if(e){this.setSemanticObjectController(e);break}}i=i.getParent()}return e};S.prototype._updateVisibilityOfAvailableActions=function(t){var e=this._oRTANavigationHandling.initialValue===undefined?this._getEnableAvailableActionsPersonalization(t):this._oRTANavigationHandling.initialValue;if(!e){return t}var i=p.getStorableAvailableActions(t);var n=i.some(function(t){return!!t.isSuperiorAction});i.forEach(function(e){if(t.length>10){e.visible=false}if(n){e.visible=false}if(e.isSuperiorAction){e.visible=true}});if(t.every(function(t){return!t.visible})){if(t[0]){t[0].visible=true}if(t[1]){t[1].visible=true}if(t[2]){t[2].visible=true}}return t};S.prototype._getEnableAvailableActionsPersonalization=function(t){var e=p.getStorableAvailableActions(t);if(e.length===0){return false}var i=this.getEnableAvailableActionsPersonalization();if(this.getSemanticObjectController()&&this.getSemanticObjectController().getEnableAvailableActionsPersonalization()&&this.getSemanticObjectController().getEnableAvailableActionsPersonalization()[this.getFieldName()]!==undefined){i=this.getSemanticObjectController().getEnableAvailableActionsPersonalization()[this.getFieldName()]}return i};return S});
//# sourceMappingURL=NavigationPopoverHandler.js.map