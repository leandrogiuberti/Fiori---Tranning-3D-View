/*!
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/base/i18n/Localization","sap/ui/base/Object","./Constants","./Utils","./HistoryGlobalDataService"],function(t,e,i,a,n){"use strict";var r="en";var s;var o=e.extend("sap.ui.comp.historyvalues.HistoryAppDataService",{constructor:function(){e.apply(this,arguments);this._initialize()}});o.prototype._initialize=function(){this._initializeAppContainerId=this._initializeAppContainerId.bind(this);this._initializeAppData=this._initializeAppData.bind(this);this._sContainerId="";this._oPersonalizer=null;this._sAppId="";this._oData={};this._oDataReadyPromise=this._getHistoryGlobalDataService().then(t=>t.getApps()).then(this._initializeAppContainerId).then(this._initializeAppData)};o.prototype._getHistoryGlobalDataService=function(){return n.getInstance()};o.prototype._initializeAppContainerId=function(t){return a.getAppInfo().then(e=>{this._sAppId=i.getHistoryPrefix()+e.id;this._sContainerId=t[this._sAppId];if(!this._sContainerId){this._createAndSaveContainerId(t)}return this._sContainerId})};o.prototype._initializeAppData=function(){return this._getPersonalizer().then(t=>t.getPersData()).then(function(t){this._oData=t||this._getDefaultData();return this._oData}.bind(this))};o.prototype._getPersonalizer=function(){if(this._oPersonalizer){return Promise.resolve(this._oPersonalizer)}const t=sap.ui.require("sap/ushell/Container");return t.getServiceAsync("PersonalizationV2").then(async t=>{const e={keyCategory:t.constants.keyCategory.FIXED_KEY,writeFrequency:t.constants.writeFrequency.LOW,clientStorageAllowed:false,validity:Infinity},a={container:this._sContainerId,item:i.getHistoryPrefix()+"appData"};this._oPersonalizer=await t.getPersonalizer(a,e);return this._oPersonalizer})};o.prototype._createAndSaveContainerId=function(t){this._sContainerId=this._createContainerId();t[this._sAppId]=this._sContainerId;this._getHistoryGlobalDataService().then(e=>e.setApps(t))};o.prototype._createContainerId=function(){var t="xxxxxxxx.xxxx.4xxx.yxxx.xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=Math.random()*16|0;if(t==="y"){e=e&3|8}return e.toString(16)});return i.getShortHistoryPrefix()+t};o.prototype._getDefaultData=function(){return{}};o.prototype._isDataReady=function(){return this._oDataReadyPromise};o.prototype._getHistoryEnabled=function(){return this._getHistoryGlobalDataService().then(t=>t.getHistoryEnabled())};o.prototype.getFieldData=function(t){return this._isDataReady().then(this._getHistoryEnabled.bind(this)).then(function(e){if(!e){return[]}var a=[],n=this._getLanguage();if(this._isDefaultLanguage(n)){a=this._oData[t]||[]}else{var r=i.getHistoryPrefix()+n;if(!this._oData[r]){a=[]}else{a=this._oData[r][t]||[]}}return a.slice()}.bind(this))};o.prototype.setFieldData=function(t,e){return this._isDataReady().then(this._getHistoryEnabled.bind(this)).then(function(a){if(!a){return false}var n=this._getLanguage();if(this._isDefaultLanguage(n)){this._oData[t]=e}else{var r=i.getHistoryPrefix()+n;if(!this._oData[r]){this._oData[r]={}}this._oData[r][t]=e}return this._getPersonalizer().then(t=>t.setPersData(this._oData))}.bind(this))};o.prototype._getLanguage=function(){var e=t.getLanguage()||r;var i=e.match(/[a-z]+/i);if(i[0]){e=i[0].toLowerCase()}return e};o.prototype._isDefaultLanguage=function(t){return t===r};o.prototype.destroy=function(){e.prototype.destroy.apply(this,arguments);this._sContainerId="";this._oPersonalizer=null;this._sAppId="";this._oData={};this._oDataReadyPromise=null};return{getInstance:function(){if(!s){s=new o}return Promise.all([s._isDataReady(),a.getAppInfo()]).then(t=>{const[,e]=t;const a=i.getHistoryPrefix()+e.id;if(s._sAppId!==a){s.destroy();s=new o}return s._isDataReady().then(()=>s)})}}});
//# sourceMappingURL=HistoryAppDataService.js.map