/*!
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/m/library","sap/m/List","sap/m/Popover","sap/m/StandardListItem","sap/m/MultiInput","sap/m/MultiComboBox","sap/m/Select","sap/m/Token","sap/m/Tokenizer","sap/ui/comp/smartfield/SmartField","sap/ui/comp/odata/MetadataAnalyser","sap/ui/core/Messaging","sap/ui/model/ParseException","sap/ui/model/ValidateException","sap/ui/model/BindingMode","sap/ui/comp/odata/ODataType","sap/ui/comp/providers/ValueHelpProvider","sap/ui/comp/util/FormatUtil","sap/ui/core/format/DateFormat","sap/ui/comp/smartfilterbar/FilterProvider","sap/base/Log","sap/base/util/deepEqual","sap/ui/comp/library","sap/ui/core/library","sap/ui/core/ResizeHandler","sap/m/Link","sap/m/Text","sap/m/FlexBox","sap/m/HBox","sap/base/util/isEmptyObject","sap/base/security/sanitizeHTML","sap/ui/thirdparty/jquery","sap/ui/core/date/UI5Date","sap/ui/core/Lib","sap/ui/core/InvisibleText"],function(t,e,i,o,a,n,s,r,l,h,u,p,d,g,_,f,c,y,m,T,v,x,M,b,k,I,B,C,S,E,D,P,R,F,H){"use strict";var V=M.valuehelpdialog.ValueHelpRangeOperation;var L=M.smartfilterbar.DisplayBehaviour;var N=M.smartfield.TextInEditModeSource;var O=b.ValueState;var w=t.PlacementType;var A="-mInput";var z="-mInputTokenizer";var W="-mInputHBox";var K="-mMoreLink";var q=F.getResourceBundleFor("sap.ui.comp");var U={SELECT:"SELECT",DESELECT:"DESELECT"};var G=h.extend("sap.ui.comp.smartmultiinput.SmartMultiInput",{metadata:{library:"sap.ui.comp",properties:{supportRanges:{type:"boolean",defaultValue:false},supportMultiSelect:{type:"boolean",defaultValue:true},enableODataSelect:{type:"boolean",defaultValue:false},requestAtLeastFields:{type:"string",defaultValue:""},textSeparator:{type:"string",defaultValue:null},singleTokenMode:{type:"boolean",defaultValue:false},enableValueHelpSelectAll:{type:"boolean",defaultValue:undefined}},aggregations:{initialTokens:{type:"sap.m.Token",multiple:true}},events:{beforeCreate:{allowPreventDefault:true,parameters:{oData:{type:"object"},mParameters:{type:"object"}}},beforeRemove:{allowPreventDefault:true,parameters:{mParameters:{type:"object"}}},tokenUpdate:{parameters:{type:{type:"string"},addedTokens:{type:"sap.m.Token[]"},removedTokens:{type:"sap.m.Token[]"}}},selectionChange:{parameters:{changedItem:{type:"sap.ui.core.Item"},selected:{type:"boolean"}}},selectionFinish:{parameters:{selectedItems:{type:"sap.ui.core.Item[]"}}}}},renderer:function(t,e){h.getMetadata().getRenderer().render(t,e);if(e._oEmptyDash){var i=e.getTokens().length>0?false:true;e._oEmptyDash.setVisible(i);if(i&&e._oMoreLink){e._oMoreLink.setVisible(false)}}}});G.prototype.getTokens=function(){if(this._isReadMode()&&this._oTokenizer){return this._oTokenizer.getTokens()}else if(this._oMultiComboBox&&this._oMultiComboBox.getAggregation("tokenizer")){return this._oMultiComboBox.getAggregation("tokenizer").getTokens()}else if(this._oMultiInput){return this._oMultiInput.getTokens()}return[]};G.prototype.getValue=function(){return this.getTokens()};G.prototype._createMultiInput=function(){var t=this._createAttributes(),e;if(this._oMultiComboBox){this._oMultiComboBox.destroy();this._oMultiComboBox=null}if(this.getSingleTokenMode()&&!this.getBindingContext()){t["maxTokens"]=1}this._oMultiInput=new a(this.getId()+A,t);this._oMultiInput.attachChange(function(t){this._validateValueOnChange(t.getParameter("value"))},this);if(this.getBindingContext()){this._bindMultiInput()}else{e=this.getAggregation("initialTokens")||[];e.forEach(function(t){this._oMultiInput.addToken(t)}.bind(this))}this._oMultiInput.attachTokenUpdate(function(t){this._validateValueOnChange(this._oMultiInput.getValue());var e=t.getParameters();delete e.id;if(this.getBinding("value").getBindingMode()!=="TwoWay"||!this.getBindingContext()){if(t.getParameter("removedTokens")){t.getParameter("removedTokens").forEach(function(t){t.destroy()})}}this.fireTokenUpdate(e)},this);var i={control:this._oMultiInput,onCreate:"_onMultiInputCreate",params:{type:{type:this._getType(),property:this._oFactory._oMetaData.property}}};this._initMultiInputValueHelp(i);return i};G.prototype._createMultiComboBox=function(){var t=this._createAttributes();if(this.getSingleTokenMode()&&!this.getBindingContext()){t["width"]="100%";delete t["placeholder"]}this._oMultiComboBoxRequestStack={};this._oMultiComboBox=this.getSingleTokenMode()&&!this.getBindingContext()?new s(this.getId()+"mComboBox",t):new n(this.getId()+"mComboBox",t);if(this.getBindingContext()){this._bindMultiComboBox()}else{this._oMultiInput=this._oMultiComboBox._oTokenizer}if(!this.getSingleTokenMode()){this._oMultiComboBox.attachSelectionChange(function(t){var e=t.getParameters();delete e.id;this.fireSelectionChange(e)},this);this._oMultiComboBox.attachSelectionFinish(function(t){(()=>{var t=Object.keys(this._oMultiComboBoxRequestStack);var e=(this._oMultiInput.getTokens()||[]).map(t=>t.getKey());if(t.length>0){t.forEach(t=>{var i=this._oMultiComboBoxRequestStack[t],o=e.indexOf(t),a=i[i.length-1],n=this._getModel();if(o===-1){if(a.action===U.SELECT){n.createEntry(...i[0].params)}}else if(a.action===U.DESELECT){n.remove(...i[0].params)}})}this._oMultiComboBoxRequestStack={}})();var e=t.getParameters();delete e.id;this.fireSelectionFinish(e)},this)}else if(this.getSingleTokenMode()&&!this.getBindingContext()){this._oMultiComboBox.attachChange(function(t){var e=t.getParameters();delete e.id;this.fireSelectionChange(e)},this)}var e={control:this._oMultiComboBox,onCreate:"_onCreate",params:{type:{type:this._getType(),property:this._oFactory._oMetaData.property},valuehelp:{annotation:this._getValueListAnnotation(),aggregation:"items",noDialog:true,noTypeAhead:true}}};return e};G.prototype._createAttributes=function(){var t={width:true,textAlign:true,placeholder:true,tooltip:true,name:true,valueState:true,valueStateText:true};var e=this._oFactory.createAttributes(null,this._oFactory._oMetaData.property,t,{event:"change",parameter:"value"});return e};function j(t){var e=t.getParameter("tokens"),i,o,n=0,s=[],r=null,l;this._onCancel();if(this.oControl instanceof a){this.oControl.setValue("");var h=this.oControl.getTokens();var u=[];var p=[];var d=[];h.forEach(function(t){var i=e.some(function(e){return t.getKey()===e.getKey()});if(!i){p.push(t)}else{var o=e.filter(function(e){return t.getKey()===e.getKey()})[0];if(!this.oControl.getBindingContext()&&this.bSupportRanges&&o.getKey().startsWith("range_")){d.push(o)}else{t.setText(o.getText());d.push(t)}}}.bind(this));e.forEach(function(t){var e=h.some(function(e){return e.getKey()===t.getKey()});if(!e){u.push(t);d.push(t)}});this.oControl.setTokens(d);var g=this.oControl.getParent();if(g&&g.getBindingContext()&&g.getBinding("value").getBindingMode()==="TwoWay"){var _=g._getModel(),f=g._getEntitySetName(),c=_._resolveGroup(f),y=_.getDeferredGroups().indexOf(c.groupId)>=0;if(!y&&(p.length||u.length)&&d.length){g.setBusyIndicatorDelay(g.getBusyIndicatorDelay());g.setBusy(true)}}this.oControl.fireTokenUpdate({type:"tokensChanged",removedTokens:p,addedTokens:u});n=e.length;while(n--){r=e[n].data("row");if(r){s.push(r)}}}else{if(e[0]){if(this.bIsSingleIntervalRange){i=e[0].data("range");if(i){if(this._sType==="datetime"){l=m.getDateTimeInstance(Object.assign({},this._oDateFormatSettings,{UTC:false}));if(typeof i.value1==="string"){i.value1=R.getInstance(i.value1)}if(i.operation==="BT"){if(typeof i.value2==="string"){i.value2=R.getInstance(i.value2)}o=l.format(i.value1)+"-"+l.format(i.value2)}else{o=l.format(i.value1)}}else if(i.operation==="BT"){o=i.value1+"-"+i.value2}else{o=i.value1}}}else{o=e[0].getKey()}r=e[0].data("row");if(r){s.push(r)}}this.oControl.setValue(o);this.oControl.fireChange({value:o,validated:true})}this._calculateAndSetFilterOutputData(s)}function Q(t){var e,i,o,a={};if(t&&this.mOutParams){for(e in this.mOutParams){if(e){i=this.mOutParams[e];if(i!==this.sKey){o=t[i];a[e]=o}}}if(a&&!E(a)){this.fireEvent("valueListChanged",{changes:a})}}}function J(t,e){var i=document.createElement("span");i.style.whiteSpace="nowrap";i.style.maxWidth="fit-content";i.innerHTML=t;i.className="sapMText";e.appendChild(i);var o=e.childNodes;var a=o[o.length-1].offsetWidth;e.removeChild(e.childNodes[o.length-1]);return a}G.prototype._initMultiInputValueHelp=function(t){var e=this._getFilterType(this._oFactory._oMetaData.property.property),i={},o=this._getDateFormatSettings(),a,n=this.getEnableValueHelpSelectAll();this._oFactory._getValueHelpDialogTitle(i);if(this._getValueListAnnotation()){t.params.valuehelp={annotation:this._getValueListAnnotation(),aggregation:"suggestionRows",noDialog:false,noTypeAhead:false,supportMultiSelect:this.getSingleTokenMode()?false:this.getSupportMultiSelect(),supportRanges:this.getBindingContext()?false:this.getSupportRanges(),type:e,displayBehaviour:this._getDisplayBehaviour(),enabledMultiSelectionPlugin:n===undefined?undefined:!n}}else if(this.getSupportRanges()&&!this.getBindingContext()){a=new c({fieldName:this._getPropertyName(),preventInitialDataFetchInValueHelpDialog:true,model:this.getModel(),control:this._oMultiInput,title:i.dialogtitle,supportMultiSelect:this.getSingleTokenMode()?false:this.getSupportMultiSelect(),supportRanges:true,type:e,dateFormatSettings:o,isUnrestrictedFilter:this._isTimeType(e),displayBehaviour:this._getDisplayBehaviour(),enabledMultiSelectionPlugin:n===undefined?undefined:!n});a._onOK=j;a._calculateAndSetODataModelOutputData=Q;this._oMultiInput.addValidator(this._validateToken.bind(this))}else{this._oMultiInput.setShowValueHelp(false);this._oMultiInput.addValidator(this._validateToken.bind(this))}};G.prototype._bindMultiInput=function(){var t=this.getBinding("value").getBindingMode();switch(t){case _.OneTime:this._bindMultiInputOneTime();break;case _.OneWay:this._bindMultiInputOneWay();break;case _.TwoWay:default:this._bindMultiInputTwoWay()}};G.prototype._bindMultiInputOneTime=function(){var t=this;this._readNavigationPropertySet().then(function(e){e.results.forEach(function(e){var i=e[t._getPropertyName()];var o=t._getDescriptionFieldName();var a=o?e[o]:"";t._oMultiInput.addToken(t._createToken(i,a))})})};G.prototype._bindMultiInputOneWay=function(){this._bindMultiInputTokens(this._oMultiInput)};G.prototype._bindMultiInputTwoWay=function(){this._bindMultiInputTokens(this._oMultiInput);this._oMultiInput.attachTokenUpdate(function(t){t.getParameter("addedTokens").forEach(this._addToken.bind(this));t.getParameter("removedTokens").forEach(this._removeToken.bind(this))},this)};G.prototype._bindMultiInputTokens=function(t){var e=this._getNavigationPath(),i=this._getSelectExpandParameter();if(!E(i)){t.bindAggregation("tokens",{path:e,parameters:{...i,usePreliminaryContext:true},factory:this._tokensFactory.bind(this),events:{aggregatedDataStateChange:this._processDataState.bind(this)}})}else{t.bindAggregation("tokens",{path:e,factory:this._tokensFactory.bind(this),events:{aggregatedDataStateChange:this._processDataState.bind(this)}})}};G.prototype._processDataState=function(t){var e=t.getParameter("dataState"),i=this.getBinding("value");if(!e||!e.getChanges().messages){return}if(i&&i.bIsBeingDestroyed){return}var o=e.getMessages();if(o.length){var a=false;var n=o[0];o.forEach(function(t){if(t.getControlIds().indexOf(this.getId())==-1){t.addControlId(this.getId());a=true}}.bind(this));this.setValueState(n.getType());this.setValueStateText(n.getMessage());if(a){p.getMessageModel().checkUpdate(false,true)}}else{this.setValueState(O.None);this.setValueStateText("")}};G.prototype._getSelectExpandParameter=function(){var t={};if(this.getEnableODataSelect()){t.select=this._addODataSelectParameters()}if(this._oFactory._oMetaData.annotations.text&&this._oFactory._oMetaData.annotations.text.navigationPathHelp){t.expand=this._oFactory._oMetaData.annotations.text.navigationPathHelp}return t};G.prototype._addODataSelectParameters=function(t){var e=this._getPropertyName();if(this._getDescriptionFieldName()){e=e+","+this._getDescriptionFieldName()}if(this.getRequestAtLeastFields()){e=e+","+this.getRequestAtLeastFields()}return e};G.prototype._calculateFieldGroupMetaData=function(){var t,e,i,o;if(this._oFactory._oMeta){e=this._oFactory._oMeta.entitySet;i=this.getModel().getMetaModel().getODataEntitySet(e);o=this.getModel().getMetaModel().getODataEntityType(i.entityType);t={entitySet:i,entityType:o,path:this._getNavigationPath()}}return t};G.prototype._bindMultiComboBox=function(){var t=this.getBinding("value").getBindingMode();switch(t){case _.OneTime:this._bindMultiComboBoxOneTime();break;case _.OneWay:this._bindMultiComboBoxOneWay();break;case _.TwoWay:default:this._bindMultiComboBoxTwoWay()}};G.prototype._bindMultiComboBoxOneTime=function(){var t=this;this._readNavigationPropertySet().then(function(e){var i=e.results.map(function(e){return e[t._getPropertyName()]});t._oMultiComboBox.setSelectedKeys(i)})};G.prototype._bindMultiComboBoxOneWay=function(){this._createAndAttachHelperMultiInput()};G.prototype._bindMultiComboBoxTwoWay=function(){this._createAndAttachHelperMultiInput();this._oMultiComboBox.attachSelectionChange(function(t){var e=t.getParameter("selected"),i=t.getParameter("changedItem"),o={},a,n,s;this.setValueState(O.None);this.setValueStateText("");if(e){o[this._getPropertyName()]=i.getKey();s=i.getBindingContext("list")||i.getBindingContext();a=s.getProperty();this._getEntityType().key.propertyRef.forEach(function(t){if(a&&a[t.name]){o[t.name]=a[t.name]}})}else{n=this._oMultiInput.getTokens().filter(function(t){return t.getKey()===i.getKey()})[0]}if(e){this._createEntity(o,i.getKey())}else{this._removeEntity(n?.getBindingContext(),i.getKey())}},this)};G.prototype._readNavigationPropertySet=function(){var t=this;return new Promise(function(e,i){var o=t.getBindingContext(),a=t._getModel(),n=t._getNavigationPath();a.read(n,{context:o,success:function(t){e(t)},error:function(e){t.setValueState(O.Error);t.setValueStateText(e.responseText);i(e)}})})};G.prototype._createAndAttachHelperMultiInput=function(){this._oMultiInput=new a({maxTokens:this.getSingleTokenMode()?1:undefined});this._oMultiInput.setBindingContext(this.getBindingContext());this._oMultiInput.setModel(this._getModel());this._bindMultiInputTokens(this._oMultiInput);var t=this._oMultiInput.getBinding("tokens");this._updateSelectedKeys.call(this);t.attachChange(this._updateSelectedKeys,this)};G.prototype._updateSelectedKeys=function(){var t=this?._oMultiInput?.getTokens().map(function(t){return t.getKey()})||[];if(this._oMultiComboBox){var e=this.getBinding("value").getBindingMode();if(e==_.TwoWay){if(this._oFactory){var i=this._oFactory.getValueListProvider();if(i&&i.bInitialised){i._calculateFilterInputData();if(i._mLastFilterInputData&&!x(i._mLastFilterInputData,i.mFilterInputData)){i._filterDropdownRowsByInParameters()}}}}this._oMultiComboBox.setSelectedKeys(t)}};G.prototype._getReadTokenList=function(){if(!this.oReadTokenList){this.oReadTokenList=new e;this.addDependent(this.oReadTokenList)}return this.oReadTokenList};G.prototype._getReadTokenListPopover=function(){if(!this.oReadTokenListPopover){this.oReadTokenListPopover=new i({showArrow:true,placement:w.Auto,showHeader:false,contentMinWidth:"auto",content:[this.oReadTokenList]});this.addDependent(this.oReadTokenListPopover)}return this.oReadTokenListPopover};G.prototype._handleNMoreIndicatorPress=function(){var t=this.getTokens();if(!t){return}var e=this._getReadTokenList();var i=this._getReadTokenListPopover();e.removeAllItems();for(var a=0,n=t.length;a<n;a++){var s=t[a],r=new o({title:s.getText()});e.addItem(r)}if(this._oMoreLink.getDomRef()){i.openBy(this._oMoreLink.getDomRef())}};G.prototype._onResize=function(){if(this._isReadMode()&&this._oTokenizer){this._deregisterResizeHandler();this._oTokenizer.setMaxWidth(this.$().width()+"px");this._oTokenizer.setRenderMode("Narrow");this._oTokenizer.scrollToEnd();if(this.getMode()==="display"&&this.getTokens().length>0){this._onDisplayResize()}this._registerResizeHandler()}};G.prototype._onDisplayResize=function(){if(this.getDomRef()&&this.getDomRef().offsetWidth>0){var t=this.getDomRef().clientWidth,e=this._iHiddenLabelsCount?J("999 "+q.getText("POPOVER_DEFINE_MORE_LINKS"),this.getDomRef()):0,i=!this._iHBoxWidth||this._iHBoxWidth+e>t,o=this._iHiddenLabelsCount>0&&this._iHBoxWidth+e+this._iFirstHiddenTokenLength<t;if(i||o){this._oHBox.removeAllItems();this.getTokens().forEach(function(t){this._oHBox.addItem(this._generateDisplayText(t.getText()))}.bind(this))}}};G.prototype.onBeforeRendering=function(){if(h.prototype.onBeforeRendering){h.prototype.onBeforeRendering.apply(this,arguments)}this._deregisterResizeHandler()};G.prototype.onAfterRendering=function(){if(h.prototype.onAfterRendering){h.prototype.onAfterRendering.apply(this,arguments)}if(this._oTokenizer&&this._oTokenizer.getBinding("tokens")){this._oTokenizer.getBinding("tokens").attachChange(this._onTokenizerBindingChange.bind(this))}if(this.getMode()==="display"&&this.bControlNotRendered){this._oHBox.removeAllItems();this._oMoreLink.setVisible(false);this.getTokens().forEach(function(t){var e=this._generateDisplayText(t.getText());this._oHBox.addItem(e)},this)}if(this._oMultiComboBox&&this._oMultiInput&&this._oMultiInput.getBindingContext()&&this.getBindingContext()){var t=this.getBindingContext().getPath();var e=this._oMultiInput.getBindingContext().getPath();if(e!==t){this._oMultiInput.setBindingContext(this.getBindingContext())}}this._registerResizeHandler()};G.prototype._onTokenizerBindingChange=function(){if(this.getMode()==="display"&&this._oTokenizer.getTokens()?.length===0&&this._oMoreLink.getVisible()===true){this._oMoreLink.setVisible(false);this._oEmptyDash.setVisible(true)}};G.prototype._registerResizeHandler=function(){if(!this._iResizeHandlerId){this._iResizeHandlerId=k.register(this,this._onResize.bind(this))}};G.prototype._deregisterResizeHandler=function(){if(this._iResizeHandlerId){k.deregister(this._iResizeHandlerId);this._iResizeHandlerId=null}};G.prototype._hasHTML=function(t){var e=/<[a-z][\s\S]*>/i;return e.test(t)};G.prototype._createTokenizer=function(){this._oTokenizer=new l(this.getId()+z,{editable:false,visible:false,width:"100%"});this._oHBox=new S(this.getId()+W);this._oMoreLink=new I(this.getId()+K,{press:this._handleNMoreIndicatorPress.bind(this),ariaLabelledBy:this.getId()+"-label"});this._oEmptyDash=new B({text:"–",visible:true});var t=this._getNavigationPath(),e=this._getSelectExpandParameter();if(this.getBindingContext()){this._bindMultiInputTokens(this._oTokenizer);this._oHBox.bindAggregation("items",{path:t,parameters:e,factory:this._textFactory.bind(this)})}else{this.attachInnerControlsCreated(this._mirrorTokensToDisplayTokenizer,this)}var i=new C({height:"100%",items:[this._oEmptyDash,this._oHBox,this._oMoreLink,this._oTokenizer]});return{control:i,onCreate:"_onCreate"}};G.prototype._textFactory=function(t,e){var i=e.getProperty(this._getPropertyName())||"";var o=i instanceof Date?this._formatValue(i):i.toString(),a=this._getDescriptionFieldName(),n=a?e.getProperty(a):"",s=this._getFormattedText(o,n),r;if(this.getDomRef()&&this.getDomRef().offsetWidth){this.bControlNotRendered=false;r=this._generateDisplayText(s)}else{this.bControlNotRendered=true;r=new B({text:s})}if(this._oEmptyDash){this._oEmptyDash.setVisible(false)}return r};G.prototype._generateDisplayText=function(t){var e=this.getDomRef(),i=e.offsetWidth,o=J("999 "+q.getText("POPOVER_DEFINE_MORE_LINKS"),e),a=new B,n,s,r;t=this._hasHTML(t)?D(t):t;if(!t){return a}if(this._oHBox.getItems().length===0){this._iHBoxWidth=0;this._iHiddenLabelsCount=0;this._iFirstHiddenTokenLength=0}this._oHBox.getItems().filter(function(t){return!t.getVisible()}).forEach(function(t){this._oHBox.removeItem(t)}.bind(this));a.setTooltip(t);t=this._iHBoxWidth===0?t:" "+this.getTextSeparator()+" "+t;a.setText(t);var l=J(t,e);this._iHBoxWidth+=l;if(this._iHiddenLabelsCount===0&&this._iHBoxWidth<=i){this._oMoreLink.setVisible(false)}else{while(this._iHBoxWidth&&this._iHBoxWidth>i-o){this._iHiddenLabelsCount+=1;if(this._oHBox.getItems()[0]){this._iFirstHiddenTokenLength=J(this._oHBox.getItems()[0].getText(),e);this._iHBoxWidth-=this._iFirstHiddenTokenLength;this._oHBox.removeItem(0)}else{this._iHBoxWidth-=l;a.setVisible(false)}}if(this._oHBox.getItems().length===0&&this._iHiddenLabelsCount===1&&!a.getVisible()){this._iHiddenLabelsCount=0;this._iHBoxWidth+=l;a.setVisible(true);this._oMoreLink.setVisible(false)}else{if(this._oHBox.getItems().length>0){n=this._oHBox.getItems()[0];n.setText(n.getTooltip());if(this._oHBox.getItems().length-1>0){s=this._oHBox.getItems()[this._oHBox.getItems().length-1];r=" "+this.getTextSeparator()+" "+s.getTooltip();s.setText(r)}a.setText(a.getText()+" "+this.getTextSeparator()+" ")}else{a.setText(a.getTooltip()+" "+this.getTextSeparator()+" ")}this._oMoreLink.setVisible(true);this._oMoreLink.setText(this._iHiddenLabelsCount+" "+this._getDisplaySubText())}}return a};G.prototype._getDisplaySubText=function(){return this.getValue().length===this._iHiddenLabelsCount?q.getText("SMARTMULTIINPUT_ITEMS"):q.getText("POPOVER_DEFINE_MORE_LINKS")};G.prototype._mirrorTokensToDisplayTokenizer=function(){if(this.getMode()==="display"){var t=this._oMultiInput&&this._oMultiInput.getTokens();this._oTokenizer.removeAllTokens();this._oHBox.removeAllItems();this._oMoreLink.setVisible(false);if(!t){t=this.getAggregation("initialTokens")||[]}t.forEach(function(t){var e=new r({text:t.getText(),key:t.getKey()});this._oTokenizer.addToken(e);var i=this._generateDisplayText(t.getText());this._oHBox.addItem(i)},this)}};G.prototype.getTextSeparator=function(){var t=this.getProperty("textSeparator");if(t){return t}return q.getText("SMARTMULTIINPUT_SEPARATOR")};G.prototype._tokensFactory=function(t,e){var i;this.setBusy(false);if(this._oFactory){var o=e.getProperty(this._getPropertyName());if(o===null||o===undefined){i=new r;Promise.resolve().then(function(){i.destroy()});return i}var a=o instanceof Date?this._formatValue(o):o.toString();var n=this._getDescriptionFieldName();var s=n?e.getProperty(n):"";i=this._createToken(a,s,e)}else{i=new r}return i};G.prototype._createToken=function(t,e,i){var o=this._getFormattedText(t,e);var a;a=new r;a.setKey(t);a.setText(o);return a};G.prototype._addToken=function(t){var e={},i,o,a,n=t.data("row"),s=t.data("range");e[this._getPropertyName()]=t.getKey();if(n){this._getEntityType().key.propertyRef.forEach(function(t){var i=n[t.name];if(i||i===0){e[t.name]=i}});if(this._oFactory._aProviders&&this._oFactory._aProviders[0].mOutParams){var r=this._oFactory._aProviders[0].mOutParams;for(o in r){if(o&&o!==this._getPropertyName()){a=r[o];e[o]=n[a]}}}}if(s){e["range"]=s}this.setValueState(O.None);this.setValueStateText("");i=this._createEntity(e);t.setBindingContext(i)};G.prototype._createEntity=function(t,e){var i=this._getModel(),o=this._getEntitySetName(),a=i._resolveGroup(o),n=this._getNavigationPath(),s=this.fireBeforeCreate({oData:t,mParameters:a});a.refreshAfterChange=true;a.context=this.getBindingContext();var r=a.context;var l=r&&r.isTransient&&r.isTransient();if(l){a={}}a.properties=t;if(s){if(e){if(!this._oMultiComboBoxRequestStack[e]){this._oMultiComboBoxRequestStack[e]=[]}this._oMultiComboBoxRequestStack[e].push({action:U.SELECT,params:[n,a]})}else{return i.createEntry(n,a)}}};G.prototype._removeToken=function(t){this._removeEntity(t.getBindingContext());t.destroy()};G.prototype._removeEntity=function(t,e){var i=this._getModel(),o=this._getEntitySetName(),a=i._resolveGroup(o),n=this.fireBeforeRemove({mParameters:a});var s=i.getDeferredGroups().indexOf(a.groupId)>=0;if(t&&s&&this._entityHasPendingCreateChange(i,t)){i.deleteCreatedEntry(t);n=false}a.refreshAfterChange=true;a.context=t;if(n){var r="";if(e){if(!this._oMultiComboBoxRequestStack[e]){this._oMultiComboBoxRequestStack[e]=[]}this._oMultiComboBoxRequestStack[e].push({action:U.DESELECT,params:[r,a]})}else{i.remove(r,a)}}};G.prototype._entityHasPendingCreateChange=function(t,e){var i=t.getPendingChanges();var o=t.getKey(e);return!!i[o]&&x(i[o],e.getObject())};G.prototype._getEntityKeyProperties=function(t){var e=this._getModel(),i=e.oMetadata._getEntityTypeByPath(t.getPath()),o={};i.key.propertyRef.forEach(function(e){var i=e.name;o[i]=t.getProperty(i)});return o};G.prototype.checkClientError=function(){if(this.getMode()==="display"){return false}return!this._validateMultiInput()};G.prototype.getRangeData=function(){var t=this.getTokens(),e=[];t.forEach(function(t){var i;if(t.data("range")){i=t.data("range")}else{i=this._getDefaultTokenRangeData(t)}e.push(i)},this);return e};G.prototype.setRangeData=function(t){if(!this.getBindingContext()){var e=Array.isArray(t)?t:[t];if(!this._oMultiInput){var i=this.getEditable(),o=this.getEnabled(),a=this.getContextEditable();this.setEditable(true);this.setEnabled(true);this.setContextEditable(true);this._updateInnerControlsIfRequired();this.setEditable(i);this.setEnabled(o);this.setContextEditable(a);this._updateInnerControlsIfRequired()}this._oMultiInput.removeAllTokens();e.forEach(function(t){var e=this._getTokenTextFromRangeData(t);var i=new r({text:e,key:e});i.data("range",t);this._oMultiInput.addToken(i)},this);this._mirrorTokensToDisplayTokenizer()}else{v.warning("setRangeData can only be used without property binding")}};G.prototype._getTokenTextFromRangeData=function(t){var e="";switch(t.operation){case V.EQ:e="="+t.value1;break;case V.GT:e=">"+t.value1;break;case V.GE:e=">="+t.value1;break;case V.LT:e="<"+t.value1;break;case V.LE:e="<="+t.value1;break;case V.Contains:e="*"+t.value1+"*";break;case V.StartsWith:e=t.value1+"*";break;case V.EndsWith:e="*"+t.value1;break;case V.BT:e=t.value1+"...";if(t.value2){e+=t.value2}break;default:e=""}if(t.exclude&&e!==""){e="!("+e+")"}return e};G.prototype._getComputedTextInEditModeSource=function(){var t=this.getTextInEditModeSource();if(this.isPropertyInitial("textInEditModeSource")&&this.getMode()==="edit"){t=N.None}return t};G.prototype.getFilter=function(){var t=[this._getPropertyName()],e={},i=this.getRangeData(),o;e[this._getPropertyName()]={ranges:i,items:[]};o=T.generateFilters(t,e);return o&&o.length===1&&o[0]};G.prototype._getDefaultTokenRangeData=function(t){var e={exclude:false,operation:V.EQ,value1:this._parseValue(t.getKey()),value2:"",keyField:this._getPropertyName()};return e};G.prototype._validateToken=function(t){var e=t.text;var i=this._validateValue(e);if(i){var o=new r({key:e,text:e});if(this.getSupportRanges()){var a=this._getDefaultTokenRangeData(o);o.data("range",a);o.setText("="+e)}return o}return undefined};G.prototype._validateMultiInput=function(){if(this._oMultiInput.getValueState()!==O.None){return false}if(this.getRequired()&&this.getTokens().length===0){this.setValueStateText(F.getResourceBundleFor("sap.ui.comp").getText("VALUEHELPVALDLG_FIELDMESSAGE"));this.setValueState(O.Error);return false}else{this.setValueState(O.None);this.setValueStateText("");return true}};G.prototype._validateValueOnChange=function(t){if(t===""){this.setValueState(O.None);this.setValueStateText("");this._validateMultiInput()}else{this._validateValue(t)}};G.prototype._parseValue=function(t){return this._getType().parseValue(t,"string")};G.prototype._formatValue=function(t){return this._getType().formatValue(t,"string")};G.prototype._validateValue=function(t){try{var e=this._parseValue(t);this._getType().validateValue(e);this.setValueState(O.None);this.setValueStateText("");return true}catch(e){this.setValueState(O.Error);this.setValueStateText(e.message);var i={element:this._oMultiInput,property:"value",type:this._getType(),newValue:t,oldValue:null,exception:e,message:e.message};if(e instanceof d){this.fireParseError(i)}else if(e instanceof g){this.fireValidationError(i)}return false}};G.prototype._getModel=function(){if(this._oFactory){return this._oFactory._oModel}return null};G.prototype._getDateFormatSettings=function(){var t=this.data("dateFormatSettings");if(typeof t==="string"){try{t=JSON.parse(t)}catch(t){}}return t};G.prototype._getNavigationPath=function(){return this._oFactory._oMetaData.navigationPath};G.prototype._getDescriptionFieldName=function(){var t=this._oFactory._oMetaData.annotations.text;if(t){if(t.navigationPathHelp){return t.navigationPathHelp+"/"+t.property.property.name}return t.property.property.name}};G.prototype._getType=function(){if(!this._oType){var t;if(this._isEdmTimeType()){t=this._getDateFormatSettings()}this._oType=this._oFactory._oTypes.getType(this._oFactory._oMetaData.property,t)}return this._oType};G.prototype._isEdmTimeType=function(){var t=["Edm.DateTime","Edm.DateTimeOffset","Edm.Time"];return t.indexOf(this._oFactory._oMetaData.property.property.type)>-1};G.prototype._isTimeType=function(t){var e=["date","datetime","time"];return e.indexOf(t)>-1};G.prototype._getPropertyName=function(){return this._oFactory._oMetaData.property.property.name};G.prototype._getEntitySetName=function(){return this._oFactory._oMetaData.entitySet.name};G.prototype._getEntityType=function(){return this._oFactory._oMetaData.entityType};G.prototype._getValueListAnnotation=function(){return this._oFactory._oMetaData.annotations.valuelist};G.prototype._getDisplayBehaviour=function(){var t=this._oFactory._getDisplayBehaviourConfiguration("defaultInputFieldDisplayBehaviour");if(!t||t===L.auto){t=L.descriptionAndId}return t};G.prototype._getFormattedText=function(t,e){var i=this._getDisplayBehaviour();var o=y.getFormattedExpressionFromDisplayBehaviour(i,t,e);return this._hasHTML(o)?D(o):o};G.prototype._getFilterType=function(t){if(f.isNumeric(t.type)){return"numeric"}else if(t.type==="Edm.DateTime"&&t["sap:display-format"]==="Date"){return"date"}else if(t.type==="Edm.String"){return"string"}else if(t.type==="Edm.Boolean"){return"boolean"}else if(t.type==="Edm.Time"){return"time"}else if(t.type==="Edm.DateTimeOffset"){return"datetime"}return undefined};G.prototype.setEntitySet=function(){h.prototype.setEntitySet.apply(this,arguments);this.updateBindingContext(false,this._getModel());return this};G.prototype.bindProperty=function(t,e){h.prototype.bindProperty.apply(this,arguments);if(t==="value"){this.updateBindingContext(false,this._getModel())}return this};G.prototype._checkComboBox=function(){var t=this._oFactory._oSelector.checkComboBox();return t&&t.combobox};G.prototype._isReadMode=function(){return!this.getEditable()||!this.getEnabled()||!this.getContextEditable()};function $(){this._onCreate.apply(this,arguments);if(this._aProviders.length>0){this._aProviders[0]._onOK=j;this._aProviders.forEach(function(t){t._calculateAndSetODataModelOutputData=Q})}}G.prototype._init=function(){var t=this;this._oRb=F.getResourceBundleFor("sap.ui.comp");if(this.getSingleTokenMode()&&!this._oInvisibleText){this._oInvisibleText=new H;this._oInvisibleText.toStatic();this.addAssociation("ariaLabelledBy",this._oInvisibleText.getId());this._oInvisibleText.setText(this._oRb.getText("SMARTMULTIINPUT_SINGLETOKENMODE"));this.addDependent(this._oInvisibleText)}h.prototype._init.apply(this,arguments);if(this._oFactory){this._oFactory._createMultiInput=this._createMultiInput.bind(this);this._oFactory._createMultiComboBox=this._createMultiComboBox.bind(this);this._oFactory._createTokenizer=this._createTokenizer.bind(this);this._oFactory._onMultiInputCreate=$;this._oFactory._oSelector.getCreator=function(e){var i=e!==undefined&&e.mode!==undefined?e.mode==="display":t._isReadMode();if(i){return"_createTokenizer"}else if(t._checkComboBox()){return"_createMultiComboBox"}else{return"_createMultiInput"}}}};G.prototype._getEditableForNotExpandedNavigation=function(){return true};G.prototype.exit=function(){h.prototype.exit.apply(this,arguments);this._deregisterResizeHandler();if(this._oMultiInput){this._oMultiInput.destroy()}if(this._oMultiComboBox){this._oMultiComboBox.destroy()}if(this._oTokenizer){this._oTokenizer.destroy()}if(this._oHBox){this._oHBox.destroy()}this._oMultiInput=null;this._oMultiComboBox=null;this._oTokenizer=null;this._oHBox=null};return G});
//# sourceMappingURL=SmartMultiInput.js.map