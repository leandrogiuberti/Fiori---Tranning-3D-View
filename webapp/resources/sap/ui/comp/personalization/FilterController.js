/*!
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["./BaseController","sap/m/library","sap/ui/comp/library","./Util","sap/ui/comp/filterbar/VariantConverterTo","sap/ui/comp/filterbar/VariantConverterFrom","sap/base/util/merge","sap/ui/comp/smartfilterbar/FilterProvider","sap/ui/core/Lib","sap/m/p13n/FilterPanel","sap/ui/comp/util/FormatUtil","sap/ui/core/library","sap/ui/comp/odata/MetadataAnalyser","sap/ui/comp/smartfilterbar/SFBMultiInput","sap/ui/comp/providers/TokenParser","sap/ui/comp/p13n/P13nConditionPanel","sap/m/Token","sap/m/MultiInput","sap/ui/comp/valuehelpdialog/ValueHelpDialog","sap/ui/comp/smartfilterbar/AdditionalConfigurationHelper"],function(e,t,i,a,r,l,o,n,s,u,p,f,d,h,c,m,y,g,F,_){"use strict";var T=f.ValueState;var C=i.smartfilterbar.FilterType;var v=e.extend("sap.ui.comp.personalization.FilterController",{constructor:function(i,a){e.apply(this,arguments);this.setType(t.P13nPanelType.filter);this.setItemType(t.P13nPanelType.filter+"Items");this._aDropdownFields=[];this.aFilterItems=[];this._aSFBMultiInputs=[];this._aFilterPanelFields=[];this._aConditionTypeControls=[];this._aCustomFields=[];this._aCustomColumnKeysWithSlash=[];this.aSFBControlConfig=[];this._aRangeKeyFields=[];this._oResourceBundle=s.getResourceBundleFor("sap.ui.comp");this._bShowCurrentDateButton=false},metadata:{events:{afterFilterModelDataChange:{}}}});v.prototype.setTable=function(t){e.prototype.setTable.apply(this,arguments)};v.prototype.getColumn2Json=function(e,t,r){if(this.getTableType()!==i.personalization.TableType.AnalyticalTable&&this.getTableType()!==i.personalization.TableType.Table&&this.getTableType()!==i.personalization.TableType.TreeTable){return null}if(!a.isFilterable(e)){return null}if(!e.getFiltered||e.getFiltered&&!e.getFiltered()){return null}return{columnKey:t,exclude:false,operation:e.getFilterOperator(),value1:e.getFilterValue(),value2:""}};v.prototype.getColumn2JsonTransient=function(e,t,r,l){if(!a.isFilterable(e)){return null}var o;if(this.getTableType()===i.personalization.TableType.AnalyticalTable||this.getTableType()===i.personalization.TableType.Table||this.getTableType()===i.personalization.TableType.TreeTable){if(a.getColumnType(e)==="boolean"){o=a._getCustomProperty(e,"values")}return{columnKey:t,text:r,tooltip:l!==r?l:undefined,maxLength:a._getCustomProperty(e,"maxLength"),precision:a._getCustomProperty(e,"precision"),scale:a._getCustomProperty(e,"scale"),type:a.getColumnType(e),typeInstance:a._getCustomProperty(e,"typeInstance"),values:o,nullable:a._getCustomProperty(e,"nullable")}}if(this.getTableType()===i.personalization.TableType.ResponsiveTable){if(a.getColumnType(e)==="boolean"){o=a._getCustomProperty(e,"values")}return{columnKey:t,text:r,tooltip:l!==r?l:undefined,maxLength:a._getCustomProperty(e,"maxLength"),precision:a._getCustomProperty(e,"precision"),scale:a._getCustomProperty(e,"scale"),type:a.getColumnType(e),typeInstance:a._getCustomProperty(e,"typeInstance"),values:o,nullable:a._getCustomProperty(e,"nullable")}}if(this.getTableType()===i.personalization.TableType.ChartWrapper){return{columnKey:t,text:r,tooltip:l!==r?l:undefined,maxLength:a._getCustomProperty(e,"maxLength"),precision:a._getCustomProperty(e,"precision"),scale:a._getCustomProperty(e,"scale"),type:a.getColumnType(e),typeInstance:a._getCustomProperty(e,"typeInstance"),values:o,nullable:a._getCustomProperty(e,"nullable")}}};v.prototype.handleIgnore=function(e,t){e.sort.sortItems.splice(t,1)};v.prototype.syncJson2Table=function(e){var t=this.getColumnMap();var a=o({},t);this.fireBeforePotentialTableChange();if(this.getTableType()===i.personalization.TableType.AnalyticalTable||this.getTableType()===i.personalization.TableType.Table||this.getTableType()===i.personalization.TableType.TreeTable){e.filter.filterItems.forEach(function(e){var i=t[e.columnKey];if(i){if(!i.getFiltered()){i.setFiltered(true)}delete a[e.columnKey]}});for(var r in a){var l=a[r];if(l&&l.getFiltered()){l.setFiltered(false)}}}this.fireAfterPotentialTableChange()};v.prototype.getDataSuiteFormat2Json=function(e){var t=this.createControlDataStructure();if(!e.SelectOptions||!e.SelectOptions.length){return t}t.filter.filterItems=e.SelectOptions.map(function(e){var t=this.oFilterProvider?._getFieldMetadata(e.PropertyName);if(!t){t=this.getTable()?.getParent()?._oTableProvider.getTableViewMetadata()?.filter(function(t){return t.name===e.PropertyName})[0]}var i=l.convertOption(e.Ranges[0].Option,e.Ranges[0].Low,t);return{columnKey:e.PropertyName,exclude:e.Ranges[0].Sign==="E",operation:i.op,value1:i.v,value2:e.Ranges[0].High}}.bind(this));return t};v.prototype.getDataSuiteFormatSnapshot=function(e){var t=this.getUnionData(this.getControlDataInitial(),this.getControlData());if(!t.filter||!t.filter.filterItems||!t.filter.filterItems.length){return}var i=this.getColumnMap(),l=a.getColumnKeysOfType("date",i),o=a.getColumnKeysOfType("datetime",i),n=a.getColumnKeysOfType("time",i);t.filter.filterItems.forEach(function(t){var a,s,u=true,p=t.columnKey,f=r.addRangeEntry(e,p);if(this._getSmartTable()){u=this._getSmartTable()._oTableProvider.getIsUTCDateHandlingEnabled()}if(this._getSmartChart()){u=this._getSmartChart()._oChartProvider.getIsUTCDateHandlingEnabled()}if(l.includes(p)){a="date"}else if(o.includes(p)){a="datetime"}else if(n.includes(p)){a="time"}if(l.concat(o,n).includes(p)){s=!!i[p]?.data("p13nData")?.typeInstance?.isA("sap.ui.comp.odata.type.FiscalDate");r.addP13nRanges(f,[t],a,u,s);return}r.addRanges(f,[t])},this)};v.prototype._getFilterPropertyFromColumn=function(e){var t,i,a,r=this._getColumnByKey(e);if(!r){a=this.getColumnMap();r=a&&a[e]}if(r){if(r.getFilterProperty){i=r.getFilterProperty()}t=r.data("p13nData");if(t&&!i){i=t["filterProperty"]}}return i};v.prototype._createFilterFieldControl=function(e){if(e.conditionType){e.control=e.conditionType.initializeFilterItem()}else if(!e.control&&e.fCreateControl){e.fCreateControl(e);delete e.fCreateControl}};v.prototype._getControlDataReduceFilterItems=function(){var e=this.getControlDataReduce();return e&&e.filter&&e.filter.filterItems};v.prototype._updateControlDataReduce=function(e){var t=this.getControlDataReduce();if(!e||!(t&&t.filter&&t.filter.filterItems)){return}e.reverse();t.filter.filterItems=e;this.setControlDataReduce2Model(t);this.fireAfterPotentialModelChange({json:t})};v.prototype._getColumnByKey=function(e){var t,i,a,r,l,o=this.getTable();if(o){t=o.getColumns();a=t.length;for(r=0;r<a;r++){i=t[r];l=i.data("p13nData");if(l&&l.columnKey===e){return i}}}return null};v.prototype._getIsCustomColumn=function(e){var t=this._getColumnByKey(e),i=t&&t.data("p13nData");return!i?false:!i.typeInstance};v.prototype._getFilterQueryPanelParameter=function(){return new URLSearchParams(window.location.search).get("sap-ui-xx-filterQueryPanel")==="true"};v.prototype.getPanel=function(e){if(!a.hasFilterableColumns(this.getColumnMap())){return null}if(e&&e.column){var t=a.getColumnKey(e.column);if(t){var i=this.getTransientData();i.filter.filterItems.forEach(function(e){e["isDefault"]=e.columnKey===t})}}var r=this.getTable(),l=this._getSmartFilterBar();if(l&&l._oFilterProvider){this._aDropdownFields=l._oFilterProvider._aFilterBarDropdownFieldMetadata;this._bShowCurrentDateButton=l._oFilterProvider._oShowCurrentDateButton}else if(r&&r.oParent&&r.oParent._oTableProvider&&r.oParent._oTableProvider._aTableViewMetadata){this._aDropdownFields=r.oParent._oTableProvider._aTableViewMetadata.filter(function(e){return e.hasFixedValues})}return new Promise(function(e){sap.ui.require(["sap/ui/comp/p13n/P13nFilterPanel","sap/ui/comp/p13n/P13nItem","sap/ui/comp/p13n/P13nAnyFilterItem","sap/ui/comp/providers/ValueListProvider"],function(t,i,a,r){var l,o=true,s,p=[],f,d;if(o){var h,c,m;if(!this.oSmartTable){this.oSmartTable=this._getSmartTable()}if(!this.oSmartChart){this.oSmartChart=this._getSmartChart()}if(!this.oSmartFilterBar){this.oSmartFilterBar=this._getSmartFilterBar();this.aSFBControlConfig=this.oSmartFilterBar?.getControlConfiguration();d=this.oSmartFilterBar?.getUseDateRangeType()&&this.oSmartTable?.isPropertyInitial("useDateRangeType")}if(this.oSmartTable){m=this.oSmartTable;p=this.oSmartTable.getFilterControlConfiguration();f=this.oSmartTable.getUseDateRangeType()}else if(this.oSmartChart){m=this.oSmartChart}if(m){h=m.getModel();c=m.getEntitySet();l=m.getId()}if(!c&&!m&&this.getTable()&&this.getTable().isA("sap.ui.table.AnalyticalTable")){h=this.getTable().getModel();c=this.getTable().getBinding("rows")&&this.getTable().getBinding("rows").getPath().slice(1).split("(")[0]}try{this.oFilterPanel=new u({enableReorder:false,change:this._mdcFilterPanelChangeHandler.bind(this),itemFactory:this._itemFactoryHandler.bind(this)});this._detachFieldsFromMDCFilterPanel();if(this.oSmartFilterBar){s=this.oSmartFilterBar.getAdditionalConfiguration()}if(this.oSmartTable&&p.length>0){s=new _(p)}if(s){s.getControlConfiguration().forEach(function(e){if(e.customControl!==null){e.customControl=null}if(e.conditionType?.defaultOperation){e.conditionType.defaultOperation=undefined}})}if(!this.oFilterProviderPromise){this.oFilterProviderPromise=n._createFilterProvider({entitySet:c,model:h,defaultDropDownDisplayBehaviour:this.oSmartTable&&this.oSmartTable.data("defaultDropDownDisplayBehaviour"),defaultTokenDisplayBehaviour:this.oSmartTable&&this.oSmartTable.data("defaultTokenDisplayBehaviour"),defaultSingleFieldDisplayBehaviour:this.oSmartTable&&this.oSmartTable.data("defaultSingleFieldDisplayBehaviour"),dateFormatSettings:this.oSmartTable&&this.oSmartTable._getDateFormatSettings(),useContainsAsDefaultFilter:this.oSmartTable&&this.oSmartTable.data("useContainsAsDefaultFilter"),defaultFilterBarExpanded:this.oSmartTable&&this.oSmartTable.data("defaultFilterBarExpanded"),defaultShowAllFilters:this.oSmartTable&&this.oSmartTable.data("defaultShowAllFilters"),annotationSuppressed:true,useDateRangeType:!!(f||d),showSelectAll:this.oSmartTable?.data("showSelectAll")||this.oSmartFilterBar?.data("showSelectAll"),context:"mdcFilterPanel",smartTable:this.oSmartTable,smartContainerId:l,additionalConfiguration:s,tableViewMetadata:this.oSmartTable&&this.oSmartTable._aTableViewMetadata,showCurrentDateButton:this._bShowCurrentDateButton})}this.oFilterProviderPromise.then(function(e){this._aActiveFilterPanelFieldNames=[];if(!e._aCustomFieldMetadata){e._aCustomFieldMetadata=[]}this.oFilterProvider=e;this.oFilterPanel.setModel(e.oModel,e.sFilterModelName);if(!this._aSplitIntervalFields){this._aSplitIntervalFields=this._getSplitIntervalFieldNames()}this.oFilterPanel.setP13nData(this._prepareP13nData());this._updateFilterData()}.bind(this))}catch(e){this.oFilterPanel=this._createBasicFilterPanel()}return e(this.oFilterPanel)}}.bind(this))}.bind(this))};v.prototype._removeFilter=function(e){var t=this._getControlDataReduceFilterItems().filter(function(t){return t.columnKey!==e});this._updateControlDataReduce(t);this._getControlByName(e).setTokens([])};v.prototype._createBasicFilterPanel=function(){var e=new u({enableReorder:false,change:this._mdcFilterPanelChangeHandler.bind(this),itemFactory:this._createBasicFilterField.bind(this)});this.oFilterPanel=e;e.setP13nData(this._prepareP13nData());this._detachFieldsFromMDCFilterPanel();this._updateBasicFilters();return e};v.prototype._updateBasicFilters=function(e){var t,i,a=e||this._getControlDataReduceFilterItems();this._aCustomFields.forEach(function(e){e.setTokens([])});if(Array.isArray(a)){a.reverse().forEach(function(e){t=this._getControlByName(e.columnKey);if(t){i=new y({text:this._getFormattedRangeTokenText(e.operation,e.value1,e.value2,e.exclude,e.columnKey)}).data("range",{exclude:e.exclude,operation:e.operation,keyField:e.columnKey,value1:e.value1,value2:e.value2});t.addToken(i)}}.bind(this))}};v.prototype._getFormattedRangeTokenText=function(e,t,i,a,r){var l=this._getKeyFieldByKey(r),o=t,n=i,s=true;if(l){if(!l.typeInstance&&m._createKeyFieldTypeInstance){m._createKeyFieldTypeInstance(l)}if(l.typeInstance){o=l.typeInstance.formatValue(t,"string",s);n=l.typeInstance.formatValue(i,"string",s)}}return p.getFormattedRangeText(e,o,n,a)};v.prototype._getKeyFieldByKey=function(e){var t;if(this._aRangeKeyFields){this._aRangeKeyFields.some(function(i){if(typeof i!=="string"){if(i.key===e){t=i;return true}}return false})}return t};v.prototype._createBasicFilterField=function(e){var t,i=this._getSmartTable(),a=i&&i.getId(),r,l=e.name,o=this._getControlByName(l);if(!o){r="FilterPanel-"+a+"-"+l;o=new g(r,{editable:true,enabled:true,showValueHelp:true,valueHelpOnly:true});o.attachTokenUpdate(function(e){var t,i,a=this._getControlDataReduceFilterItems(),r=e.getParameter("removedTokens"),l=r.length;if(e.getParameter("type")==="removed"){a=a.filter(function(e){for(t=0;t<l;t++){i=r[t].data("range");if(i&&i.keyField===e.columnKey&&i.value1===e.value1&&i.value2===e.value2){l-=1;return false}}return true});this._updateControlDataReduce(a)}}.bind(this));t=new c;t.addKeyField({key:l,label:e.label});t.associateInput(o);t.setDefaultOperation("EQ");o._sControlName=l;o.attachValueHelpRequest(this._vhRequest.bind(this,e,o));this._aCustomFields.push(o)}return o};v.prototype._getSplitIntervalFieldNames=function(){var e,t,i=[],a=this.oFilterProvider;if(a&&a.aAllFields){for(e=0;e<a.aAllFields.length;e++){t=a.aAllFields[e];if(t.filterRestriction===C.Interval&&t.type!=="Edm.DateTime"){i.push(t.name)}}}return i};v.prototype._vhRequest=function(e,t){var i,r=this._getColumnByKey(e.name),l=t&&t.getId()+"-valueHelpDialog",o=new F(l,{key:e.name,supportRangesOnly:true,supportRanges:true,title:e.label,cancel:function(){o.close()}});o.attachOk(this._onOk.bind(this,t,o));o.attachAfterClose(function(){this.destroy()});o.setProperty("_enhancedExcludeOperations",true);i={label:e.label,key:e.name,type:a._getCustomProperty(r,"type")||"string",maxLength:a._getCustomProperty(r,"maxLength"),scale:a._getCustomProperty(r,"scale"),precision:a._getCustomProperty(r,"precision"),nullable:a._getCustomProperty(r,"nullable")};m._createKeyFieldTypeInstance(i);this._aRangeKeyFields.push(i);o.setRangeKeyFields([i]);o.setTokens(t.getTokens());o.open()};v.prototype._onOk=function(e,t,i){var a=i.getParameter("tokens"),r=[];if(!a){t.close();return}e.setTokens(a);var l=this._getControlDataReduceFilterItems();a.forEach(function(e){r.push(e.data("range"))});l=l.filter(function(t){return t.columnKey!==e._sControlName});l.push(this._createConditionForRanges(r));l=l.flat();this._updateControlDataReduce(l);t.close()};v.prototype._getFieldMetadata=function(e,t){var i=null;if(Array.isArray(e)){e.some(function(e){if(e&&e.fields){e.fields.some(function(e){if(e&&e.name===t){i=e}return i!==null})}return i!==null})}return i};v.prototype._itemFactoryHandler=function(e){var t,i,r,l,o,n=e.name,s=this.oFilterProvider,u=this._getControlByName(n),p=this._getFilterPropertyFromColumn(n),f=this._getColumnByKey(n),d;if(u&&u.isA("sap.m.DatePicker")&&u.getValue()&&!this._checkIfFilterHasValue(n)){u.setValue("")}if(p&&p.includes("/")){d=s._oMetadataAnalyser.extractNavigationPropertyField(p,s.sEntitySet);d=s._createFieldMetadata(d)}else{d=s._getFieldMetadata(p)}if(d&&p&&n!==p){d=Object.assign({},d)}this._aActiveFilterPanelFieldNames.push(n);if(!u){if(!d){if(!this._aViewMetadata){this._aViewMetadata=s._oMetadataAnalyser._getAllFilterableFieldsByEntityForAllEndpoints(s.sEntitySet,true,false,null)}d=this._getFieldMetadata(this._aViewMetadata,n);if(d){d=s._createFieldMetadata(d)}}try{d=this._updateFieldMetadata(d,e,p)}catch(e){}if(this.aSFBControlConfig&&d){for(t=0;t<this.aSFBControlConfig.length;t++){i=this.aSFBControlConfig[t];if(i.getKey()===d.fieldName){r=i.getDisplayBehaviour();if(r&&!i.isPropertyInitial("displayBehaviour")){o=Object.assign({},d);o.displayBehaviour=r}l=i.getControlType();if(l&&!i.isPropertyInitial("controlType")){if(!o){o=Object.assign({},d)}o.controlType=l}break}}}if(o){if(o.conditionType){u=this._createSemanticControl(o)}else{o.fCreateControl(o);u=o.control}}else if(d){if(d.conditionType){u=this._createSemanticControl(d)}else{d.fCreateControl(d);u=d.control}}if(!u){u=new h({editable:true,enabled:true,showValueHelp:true,valueHelpOnly:true});d={fieldName:n,type:a._getCustomProperty(f,"edmType")||a._getCustomProperty(f,"type"),filterType:a._getCustomProperty(f,"type"),maxLength:a._getCustomProperty(f,"maxLength"),scale:a._getCustomProperty(f,"scale"),precision:a._getCustomProperty(f,"precision"),nullable:a._getCustomProperty(f,"nullable"),isDigitSequence:a._getCustomProperty(f,"isDigitSequence"),label:e.label};s._associateValueHelpDialog(u,d,true,true);s._aCustomFieldMetadata.push(d);u.bindProperty("value",{path:s.sFilterModelName+">/"+d.fieldName+"/value",type:s._getType(d)});s._handleMultiInput(u,d,s._getType(d))}u.setModel(this.getTable().getModel());u._sControlName=e.name;this._aFilterPanelFields.push(u);if(u.isA("sap.m.Select")||u.isA("sap.m.TimePicker")){u.setWidth("100%")}if(u.isA("sap.m.MultiInput")){u.attachTokenUpdate(this._fieldChangeHandler.bind(this))}else{u.attachChange(this._fieldChangeHandler.bind(this))}}if(u.getValueState&&u.getValueState()===T.Error){u.setValueState(T.None)}return u};v.prototype._createSemanticControl=function(e){const t=e.conditionType.initializeFilterItem("mdcFilterPanel");this._aConditionTypeControls.push(t);if(t&&t.getValue()){setTimeout(function(){t.setValue(null)},0,t)}return t};v.prototype._fieldChangeHandler=function(e){var t,i,a,r=[],l,o=this.oFilterProvider,n,s=e.getSource(),u=s._sControlName,p={exclude:false,columnKey:u,operation:"EQ",value1:null,value2:null};setTimeout(function(){Promise.all(o._getCurrentValidationPromises()).then(function(){n=o.getFilterData();for(t in n){if(n.hasOwnProperty(t)){i=n[t];if(i){a=o._getFieldMetadata(t);if(a&&a.fieldNameOData&&t!==a.fieldNameOData){t=a.fieldNameOData}p.columnKey=t;if(p.columnKey&&p.columnKey.includes("___")){p.columnKey=p.columnKey.replaceAll("___","/")}l=Object.assign({},p);if(Array.isArray(i.ranges)&&i.ranges.length>0){r.push(this._createConditionForRanges(i.ranges,i.conditionTypeInfo))}if(Array.isArray(i.items)&&i.items.length>0){r.push(this._createConditionForItems(i.items,p))}if(i.hasOwnProperty("low")&&i.low){r.push(this._createConditionForIntervals(i,t,p))}if(i.value){if(s&&s.getValueState()!==T.Error){l=Object.assign({},p);l.value1=i.value;r.push(l)}}if(typeof i!=="object"||i instanceof Date){l=Object.assign({},p);l.value1=i;r.push(l)}}}}r=r.flat();this._updateControlDataReduce(r);if(s._oFieldViewMetadata&&this.oFilterProvider._oMetadataAnalyser.getMultiUnitBehaviorEnabled()){if(s._oFieldViewMetadata.isMeasureField){this._setWarningState(s)}if(d.isUnitOfMeasure(s._oFieldViewMetadata)||d.isCurrencyCode(s._oFieldViewMetadata)){this._clearWarningState(s)}}}.bind(this))}.bind(this))};v.prototype._setWarningState=function(e){var t=e._oFieldViewMetadata,i=this.oFilterProvider&&this.oFilterProvider._getFieldMetadata(t.unit),a=i&&i.label,r=this._oResourceBundle.getText("UNIT_WARNING_TEXT",[a]),l=this._checkIfFilterHasValue(t.name),o=this._checkIfFilterHasValue(i.name);if(t.filterRestriction==="single"){return}if(!o&&l){setTimeout(function(){e.setValueState(T.Warning);e.setValueStateText(r)})}if(!l){e.setValueState(T.None)}};v.prototype._clearWarningState=function(e){var t=e._oFieldViewMetadata,i=t&&t.name,a=t&&t.label,r=this._oResourceBundle.getText("UNIT_WARNING_TEXT",[a]),l,o=this._checkIfFilterHasValue(t.name),n;if(t.filterRestriction==="single"){return}this.oFilterProvider.aAllFields.forEach(function(e){if(e.isCurrencyField&&e["Org.OData.Measures.V1.ISOCurrency"].Path===i||e.isMeasureField&&e["Org.OData.Measures.V1.Unit"]&&e["Org.OData.Measures.V1.Unit"].Path===i){l=this._getControlByName(e.name);if(l){n=this._checkIfFilterHasValue(e.name);if(o&&l.getValueState()===T.Warning){l.setValueState(T.None)}if(!o&&n&&l.getValueState()===T.None){l.setValueState(T.Warning);l.setValueStateText(r)}}}}.bind(this))};v.prototype._checkIfFilterHasValue=function(e,t){var i=t||this.oFilterProvider.getFilterData(),a=i[e]||i._CUSTOM&&i._CUSTOM[e];if(a===null||typeof a==="undefined"){return false}if(typeof a==="string"&&a){return true}if(typeof a==="number"){return true}if(typeof a==="object"&&Object.prototype.toString.call(a)==="[object Date]"){return true}if(typeof a==="object"&&(a.hasOwnProperty("low")||a.hasOwnProperty("high"))){return!!a.low||!!a.high}if(typeof a==="object"&&(a.hasOwnProperty("value")||a.hasOwnProperty("items")||a.hasOwnProperty("ranges"))){return!!a.value||a.items&&!!a.items.length||a.ranges&&!!a.ranges.length}return false};v.prototype._updateFieldMetadata=function(e,t,i){var a,r,l=t.name,o=this.oFilterProvider,n=false,s=this._getIsCustomColumn(l),u=this._getColumnByKey(l);if(e){if(t&&!s&&e.fieldName&&e.fieldName.includes("/")){n=true}if(s){a=u&&(u.getHeader&&u.getHeader()||u.getLabel&&u.getLabel());if(a&&a.getText()){e.label=a.getText()}}}if(i&&i.includes("/")){e=o._oMetadataAnalyser.extractNavigationPropertyField(i,o.sEntitySet);e=o._createFieldMetadata(e)}if(!e){l=this._getFilterPropertyFromColumn(l);r=o.aAllFields&&o.aAllFields.find(function(e){return e.name===l});r=o._createFieldMetadata(r);e=Object.assign({},r)}if(s||n){e=this._prepareFieldMetadataForCustomColumn(e,t)}return e};v.prototype._prepareFieldMetadataForCustomColumn=function(e,t){var i=t.name,r,l,o,n,s,u=t.name,p=this._getColumnByKey(u),f=this.oFilterProvider;if(u.includes("/")){this._aCustomColumnKeysWithSlash.push(u);u=u.replaceAll("/","___")}e.customColumnKey=i;e.fieldName=u;e.name=u;n=!!e.ui5Type&&e.ui5Type.oConstraints;e.label=p&&(p.getHeader?p.getHeader().getText():p.getLabel().getText());o=a._getCustomProperty(p,"maxLength");l=a._getCustomProperty(p,"scale");r=a._getCustomProperty(p,"precision");if(n&&(o||l||r)){s=e.ui5Type;e=Object.assign({},e,{ui5Type:Object.assign({},e.ui5Type,{oConstraints:Object.assign({},e.ui5Type.oConstraints)})});for(var d in s){if(!s.hasOwnProperty(d)){e.ui5Type[d]=s[d]}}}if(o){e.maxLength=o;if(n){e.ui5Type.oConstraints.maxLength=o}}if(l){e.scale=l;if(n){e.ui5Type.oConstraints.scale=l}}if(r){e.precision=r;if(n){e.ui5Type.oConstraints.precision=r}}f._aCustomFieldMetadata.push(e);this._updateFilterData();return e};v.prototype._prepareP13nData=function(){var e=[],t,i,a,r=this._getControlDataReduceFilterItems();this.getTransientData().filter.filterItems.forEach(function(a){t=r&&r.some(function(e){return e.columnKey===a.columnKey});if(a.isDefault){t=true;i=this.oFilterProvider?._oMetadataAnalyser?.getDescriptionFieldName(a.columnKey,this.oFilterProvider.sEntitySet)}e.push({name:a.columnKey,label:a.text,active:t})}.bind(this));if(i){a=e.find(e=>e.name===i);if(a){a.active=true}}return e};v.prototype._mdcFilterPanelChangeHandler=function(e){if(e.getParameter("reason")===this.oFilterPanel.CHANGE_REASON_REMOVE){this._handleFieldRemove(e)}};v.prototype._handleFieldRemove=function(e){try{var t=this.oFilterProvider,i=e.getParameter("item").name,a,r,l=this._getControlByName(i),o=t.getFilterData(),n=this._getControlDataReduceFilterItems();if(i&&i.includes("/")){r=t._oMetadataAnalyser.extractNavigationPropertyField(i,t.sEntitySet);r=t._createFieldMetadata(r)}else{r=t._getFieldMetadata(i)}if(n&&n.length>0){n=n.filter(function(e){return e.columnKey!==i})}this._updateControlDataReduce(n);if(!r){a=this._getFilterPropertyFromColumn(i);r=t.aAllFields.find(function(e){return e.name===a});r=t._createFieldMetadata(r);r.name=i;r.fieldName=i;r.control=l}if(r&&!r.control&&l){r.control=l}t._createInitialModelForField(o,r);if(l&&l.getValue&&l.getValue()){l.setValue(null)}}catch(t){this._removeFilter(e.getParameter("item").name)}};v.prototype._detachFieldsFromMDCFilterPanel=function(){var e,t=this.oFilterPanel.exit;this.oFilterPanel.exit=function(){t.apply(this,arguments);this._aFilterPanelFields.forEach(function(t){if(t){e=t.getParent();if(e){e.removeContent(t)}}});this._aCustomFields.forEach(function(t){if(t){e=t.getParent();if(e){e.removeContent(t)}}});if(this._aActiveFilterPanelFieldNames){this._aActiveFilterPanelFieldNames=null}}.bind(this)};v.prototype._createConditionForRanges=function(e,t){var i,a,r=[],l;for(i=0;i<e.length;i++){a=Object.assign({},e[i]);if(!a.columnKey){a.columnKey=a.keyField}try{l=this.oFilterProvider._getFieldMetadata(a.columnKey);if(l&&l.fieldNameOData){a.columnKey=l.fieldNameOData}if(a.columnKey&&a.columnKey.includes("___")){a.columnKey=a.columnKey.replaceAll("___","/")}}catch(e){}if(t){a.conditionTypeInfo=t}delete a.keyField;delete a.tokenText;r.push(a)}return r};v.prototype._createConditionForItems=function(e,t){var i,a,r=[],l;for(i=0;i<e.length;i++){a=e[i];l=Object.assign({},t);l.value1=a.key;l.token=a.text;r.push(l)}return r};v.prototype._createConditionForIntervals=function(e,t,i){var a,r=this.oFilterProvider,l=[],o;a=Object.assign({},i);a.operation="BT";if(e.low&&e.high){a.value1=e.low;a.value2=e.high}else if(e.low){if(r._aFilterBarDateTimeFieldNames.indexOf(t)>-1){o=r._getFieldMetadata(t);l=[e.low];if(typeof e.low==="string"){l=p.parseDateTimeOffsetInterval(e.low);l[0]=o.ui5Type.parseValue(l[0],"string")}if(l.length===2){l[1]=o.ui5Type.parseValue(l[1],"string")}if(l.length===1){a.operation="EQ"}}else{l=p.parseFilterNumericIntervalData(e.low)}if(l){a.value1=l[0];a.value2=l[1]}}return a};v.prototype._updateFilterData=function(e){var t,i,a,r,l,o,n,s=this.oFilterProvider,u=e?e:this._getControlDataReduceFilterItems();s.clear();if(this._aConditionTypeControls.length>0){this._aConditionTypeControls.forEach(e=>{if(e.getValue()){e.setValue(null)}})}o=Object.assign({},s.getFilterData());Object.values(o).forEach(e=>{if(e?.conditionTypeInfo){e.conditionTypeInfo.data.operation="DATE"}});n=Object.keys(o);if(u&&u.length>0){for(t=0;t<u.length;t++){l=Object.assign({},u[t]);r=l.keyField?l.keyField:l.columnKey;if(this._aCustomColumnKeysWithSlash.includes(r)){r=r.replaceAll("/","___")}if(r.indexOf("/")>-1&&n.indexOf(r.replaceAll("/","."))>-1){r=n[n.indexOf(r.replaceAll("/","."))]}a=o[r];if(!l.keyField){l.keyField=l.columnKey;delete l.columnKey}if(l.token){i={key:l.value1,text:l.token};if(!a.items){a.items=[]}a.items.push(i)}else if(l?.conditionTypeInfo){if(!l.conditionTypeInfo.data.operation){l.conditionTypeInfo.data.operation=l.conditionTypeInfo.data.operator}a.conditionTypeInfo=l.conditionTypeInfo;if(!a.ranges){a.ranges=[]}a.ranges.push(l)}else if(a?.conditionTypeInfo){a.conditionTypeInfo.data.value1=l.value1;a.conditionTypeInfo.data.value2=l.value2;const e=this.oFilterProvider._getFieldMetadata(a.conditionTypeInfo.data.key);if(e?.type==="Edm.DateTimeOffset"){if(l.value2){a.conditionTypeInfo.data.operation="DATETIMERANGE"}else{a.conditionTypeInfo.data.operation="DATETIME"}}else if(l.value2){a.conditionTypeInfo.data.operation="DATERANGE"}if(l.operation==="LE"||l.operation==="LT"){a.conditionTypeInfo.data.operation="TO"}if(l.operation==="GE"||l.operation==="GT"){a.conditionTypeInfo.data.operation="FROM"}if(e?.filterRestriction==="interval"){const e=this._getControlByName(l.keyField)?.toDates({operator:a.conditionTypeInfo.data.operation,values:[l.value1]});l.value1=a.conditionTypeInfo.data.value1=e[0]?.oDate;l.value2=a.conditionTypeInfo.data.value2=e[1]?.oDate;l.operation="BT"}if(!a.ranges){a.ranges=[]}a.ranges.push(l)}else if(a&&a.hasOwnProperty("low")){if(s._aFilterBarDateTimeFieldNames&&s._aFilterBarDateTimeFieldNames.indexOf(r)>-1){if(l.value1 instanceof Date){l.value1=l.value1.toISOString()}if(l.value2 instanceof Date){l.value2=l.value2.toISOString()}}if(this._aSplitIntervalFields&&this._aSplitIntervalFields.indexOf(l.keyField)>-1){i={low:l.value1+"-"+l.value2,high:null}}else{i={low:l.value1,high:l.value2}}o[r]=i}else if(a===null||typeof a!=="object"){o[r]=l.value1}else{if(this._getControlByName(l.keyField)?.isA("sap.m.MultiComboBox")){o[r].items?.push({key:l.value1})}else{if(!(a&&a.ranges)){a.ranges=[]}o[r].ranges.push(l)}}}s.setFilterData(o)}};v.prototype._getControlByName=function(e){var t,i,a,r=this._aFilterPanelFields.length?this._aFilterPanelFields:this._aCustomFields;for(t=0;t<r.length;t++){a=r[t];if(a._sControlName===e){i=a;break}}return i};v.prototype.getChangeType=function(e,t){if(!t||!t.filter||!t.filter.filterItems){return i.personalization.ChangeType.Unchanged}if(t&&t.filter&&t.filter.filterItems){t.filter.filterItems.forEach(function(e){delete e.key;delete e.source})}if(e&&e.filter&&e.filter.filterItems){e.filter.filterItems.forEach(function(e){delete e.key;delete e.source})}var a=JSON.stringify(e.filter.filterItems)!==JSON.stringify(t.filter.filterItems);return a?i.personalization.ChangeType.ModelChanged:i.personalization.ChangeType.Unchanged};v.prototype.getChangeData=function(e,t){if(!e||!e.filter||!e.filter.filterItems){return this.createControlDataStructure()}if(t&&t.filter&&t.filter.filterItems){t.filter.filterItems.forEach(function(e){delete e.key;delete e.source})}if(e&&e.filter&&e.filter.filterItems){e.filter.filterItems.forEach(function(e){delete e.key;delete e.source})}if(!t||!t.filter||!t.filter.filterItems){return{filter:a.copy(e.filter)}}if(JSON.stringify(e.filter.filterItems)!==JSON.stringify(t.filter.filterItems)){return{filter:a.copy(e.filter)}}return null};v.prototype.getUnionData=function(e,t){if(!t||!t.filter||!t.filter.filterItems){return{filter:a.copy(e.filter)}}return{filter:a.copy(t.filter)}};v.prototype._getSmartFilterBar=function(){var e,t=this.getTable();if(t){e=t.oParent&&t.oParent._oSmartFilter}if(!e&&t&&this.getTableType()===i.personalization.TableType.ChartWrapper){e=t.getChartObject()&&t.getChartObject().oParent&&t.getChartObject().oParent._oSmartFilter}return e?e:null};v.prototype._getSmartTable=function(){var e=this.getTable()&&this.getTable().getParent();return e&&e.isA("sap.ui.comp.smarttable.SmartTable")?e:null};v.prototype._getSmartChart=function(){var e=this.getTable();if(e&&this.getTableType()===i.personalization.TableType.ChartWrapper){return e&&e.getChartObject()&&e.getChartObject().getParent()}return null};v.prototype.exit=function(){e.prototype.exit.apply(this,arguments);this._aDropdownFields=null;this.aFilterItems=null;this._aSFBMultiInputs=null;this.oSmartChart=null;this.oSmartTable=null;this.oSmartFilterBar=null;this.aSFBControlConfig=null;this._aSplitIntervalFields=null;if(this.oFilterProviderPromise){this.oFilterProviderPromise=null}if(this.oFilterProvider&&this.oFilterProvider.destroy){this.oFilterProvider.destroy();this.oFilterProvider=null}if(this._aFilterPanelFields&&this._aFilterPanelFields.length>0){this._aFilterPanelFields.forEach(function(e){e.destroy()})}if(this._aCustomFields&&this._aCustomFields.length>0){this._aCustomFields.forEach(function(e){e.destroy()})}this._aFilterPanelFields=null;this._aConditionTypeControls=null;this._aCustomFields=null;this._aActiveFilterPanelFieldNames=null;this._aViewMetadata=null;this._aCustomColumnKeysWithSlash=null};return v});
//# sourceMappingURL=FilterController.js.map