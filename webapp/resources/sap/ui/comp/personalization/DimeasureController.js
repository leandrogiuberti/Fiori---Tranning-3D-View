/*!
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["./BaseController","sap/m/library","sap/ui/comp/library","./Util","sap/ui/comp/odata/ChartMetadata","sap/m/MessageStrip","sap/ui/core/Lib"],function(e,t,i,r,a,n,o){"use strict";var s=e.extend("sap.ui.comp.personalization.DimeasureController",{constructor:function(i,r){e.apply(this,arguments);this.setType(t.P13nPanelType.dimeasure);this.setItemType(t.P13nPanelType.dimeasure+"Items");this.CHARTLAYOUT_AXIS1="axis1";this.CHARTLAYOUT_AXIS2="axis2";this.CHARTLAYOUT_AXIS3="axis3";this.CHARTLAYOUT_CATEGORY="category";this.CHARTLAYOUT_CATEGORY2="category2";this.CHARTLAYOUT_SERIES="series"},metadata:{events:{afterDimeasureModelDataChange:{}}}});s.prototype.setTable=function(t){e.prototype.setTable.apply(this,arguments);if(this.getTableType()!==i.personalization.TableType.ChartWrapper){throw"The provided object is incorrect. 'oTable' has to be an instance of sap.ui.comp.personalization.ChartWrapper. "}var r=t.getChartObject();r.detachDrilledDown(this._onDrilledDown,this);r.attachDrilledDown(this._onDrilledDown,this);r.detachDrilledUp(this._onDrilledUp,this);r.attachDrilledUp(this._onDrilledUp,this);this._monkeyPatchTable(r)};s.prototype._monkeyPatchTable=function(e){var t=this;var i=e.setChartType.bind(e);var r=function(e){i(e);t._onSetChartType(e)};if(e.setChartType.toString()===r.toString()){return}e.setChartType=r};s.prototype._onSetChartType=function(e){var t=this.getControlData();if(!e||e===t.dimeasure.chartTypeKey){return}this.fireBeforePotentialTableChange();t.dimeasure.chartTypeKey=e;this.updateControlDataBaseFromJson(t);this.fireAfterPotentialTableChange();this.fireAfterDimeasureModelDataChange()};s.prototype._onDrilledDown=function(e){this.fireBeforePotentialTableChange();this._addVisibleDimensions(e.getParameter("dimensions")||[]);this.fireAfterPotentialTableChange();this.fireAfterDimeasureModelDataChange()};s.prototype._addVisibleDimensions=function(e){if(!e.length){return}var t=this.getControlData();if(t&&t.dimeasure&&t.dimeasure.dimeasureItems){t.dimeasure.dimeasureItems.sort(function(e,t){return e.index-t.index})}var a=t.dimeasure.dimeasureItems.filter(function(t){return t.visible&&t.aggregationRole===i.personalization.AggregationRole.Dimension&&e.indexOf(t.columnKey)<0}).reduce(function(e,t){return t.columnKey},"");e.forEach(function(e){var i=r.getIndexByKey("columnKey",a,t.dimeasure.dimeasureItems)+1;var n=r.getIndexByKey("columnKey",e,t.dimeasure.dimeasureItems);a=e;if(n<0||i<0||n>t.dimeasure.dimeasureItems.length-1||i>t.dimeasure.dimeasureItems.length-1){return}var o=t.dimeasure.dimeasureItems.splice(n,1);o[0].visible=true;t.dimeasure.dimeasureItems.splice(i,0,o[0]);var s=-1;t.dimeasure.dimeasureItems.forEach(function(e){if(e.index!==undefined){e.index=++s}});this.updateControlDataBaseFromJson(t)},this)};s.prototype._onDrilledUp=function(e){this.fireBeforePotentialTableChange();var t=this.getControlData();var i=e.getParameter("dimensions")||[];i.forEach(function(e){var i=r.getArrayElementByKey("columnKey",e,t.dimeasure.dimeasureItems);if(!i){throw"No entry found in 'controlDataBase' for columnKey '"+e+"'"}i.visible=false;this.updateControlDataBaseFromJson(t)},this);this.fireAfterPotentialTableChange();this.fireAfterDimeasureModelDataChange()};s.prototype.getColumn2Json=function(e,t,i){if(!r.isAggregatable(e)){return null}return{columnKey:t,index:i,visible:e.getVisible(),role:e.getRole(),aggregationRole:e.getAggregationRole()}};s.prototype.getAdditionalData2Json=function(e,t){var i=t.getChartObject();e.dimeasure.chartTypeKey=i.getChartType()};s.prototype.getColumn2JsonTransient=function(e,t,i,a){if(!r.isAggregatable(e)){return null}return{columnKey:t,text:i,tooltip:a!==i?a:undefined,aggregationRole:e.getAggregationRole()}};s.prototype.handleIgnore=function(e,t){e.dimeasure.dimeasureItems[t].visible=false};s.prototype.syncJson2Table=function(e){var t=this.getTable().getChartObject();var a=function(e,t,i,a){var n=r.copy(e);n.sort(s._sortByIndex);var o=[];n.forEach(function(e){if(e.visible===true){o.push(e.columnKey);var t=a(e.columnKey);if(t){t.setRole(e.role)}}});if(JSON.stringify(o)!==JSON.stringify(t)){i(o,true,true)}};this.fireBeforePotentialTableChange();var n=e.dimeasure.dimeasureItems.filter(function(e){return e.aggregationRole===i.personalization.AggregationRole.Dimension});var o=e.dimeasure.dimeasureItems.filter(function(e){return e.aggregationRole===i.personalization.AggregationRole.Measure});var u=t.getVisibleDimensions();a(n,u,t.setVisibleDimensions.bind(t),t.getDimensionByName.bind(t));var l=t.getVisibleMeasures();a(o,l,t.setVisibleMeasures.bind(t),t.getMeasureByName.bind(t));t.setChartType(e.dimeasure.chartTypeKey);this.fireAfterPotentialTableChange()};s.prototype.getDataSuiteFormat2Json=function(e){var t=this.createControlDataStructure();var n=function(e,i,a){var n=r.getIndexByKey("columnKey",e,t.dimeasure.dimeasureItems);if(n<0){n=t.dimeasure.dimeasureItems.length;t.dimeasure.dimeasureItems.splice(n,0,{columnKey:e})}t.dimeasure.dimeasureItems[n][i]=a};this.getControlDataInitial().dimeasure.dimeasureItems.filter(function(e){return e.visible===true}).forEach(function(e){n(e.columnKey,"visible",false)});if(e.Visualizations&&e.Visualizations.length){var o=e.Visualizations.filter(function(e){return e.Type==="Chart"});if(o.length){var s=0;if(o[0].Content.Dimensions.length){s=o[0].Content.Dimensions.length;o[0].Content.Dimensions.forEach(function(e,t){var s=r.getArrayElementByKey("Dimension",e,o[0].Content.DimensionAttributes);n(e,"visible",true);n(e,"index",t);if(s&&s.Role){n(e,"role",a.getDimensionRole(s.Role))}n(e,"aggregationRole",i.personalization.AggregationRole.Dimension)},this)}if(o[0].Content.Measures.length){o[0].Content.Measures.forEach(function(e,t){var u=r.getArrayElementByKey("Measure",e,o[0].Content.MeasureAttributes);n(e,"visible",true);n(e,"index",s+t);if(u&&u.Role){n(e,"role",a.getMeasureRole(u.Role))}n(e,"aggregationRole",i.personalization.AggregationRole.Measure)},this)}}t.dimeasure.chartTypeKey=a.getChartType(o[0].Content.ChartType)}return t};s.prototype.getDataSuiteFormatSnapshot=function(e){var t=this.getUnionData(this.getControlDataInitial(),this.getControlData());if(!t.dimeasure||!t.dimeasure.dimeasureItems||!t.dimeasure.dimeasureItems.length){return}var r=t.dimeasure.dimeasureItems.filter(function(e){return e.aggregationRole===i.personalization.AggregationRole.Dimension}).filter(function(e){return e.visible===true});var n=t.dimeasure.dimeasureItems.filter(function(e){return e.aggregationRole===i.personalization.AggregationRole.Measure}).filter(function(e){return e.visible===true});if(r.length||n.length){if(!e.Visualizations){e.Visualizations=[]}e.Visualizations.push({Type:"Chart",Content:{ChartType:a.getAnnotationChartType(t.dimeasure.chartTypeKey),Dimensions:r.sort(function(e,t){return e.index-t.index}).map(function(e){return e.columnKey}),DimensionAttributes:r.sort(function(e,t){return e.index-t.index}).map(function(e){return{Dimension:e.columnKey,Role:a.getAnnotationDimensionRole(e.role)}}),Measures:n.sort(function(e,t){return e.index-t.index}).map(function(e){return e.columnKey}),MeasureAttributes:n.sort(function(e,t){return e.index-t.index}).map(function(e){return{Measure:e.columnKey,Role:a.getAnnotationMeasureRole(e.role)}})}})}};s.prototype.getChartTypeLayoutConfig=function(){if(this._aChartTypeLayout){return this._aChartTypeLayout}var e=[this.CHARTLAYOUT_AXIS1,this.CHARTLAYOUT_CATEGORY,this.CHARTLAYOUT_SERIES];var t=[this.CHARTLAYOUT_AXIS1,this.CHARTLAYOUT_AXIS2,this.CHARTLAYOUT_CATEGORY,this.CHARTLAYOUT_SERIES];var i=[this.CHARTLAYOUT_AXIS1,this.CHARTLAYOUT_CATEGORY,this.CHARTLAYOUT_CATEGORY2];var r=[this.CHARTLAYOUT_AXIS1,this.CHARTLAYOUT_AXIS2,this.CHARTLAYOUT_AXIS3,this.CHARTLAYOUT_CATEGORY,this.CHARTLAYOUT_SERIES];this._aChartTypeLayout=[{key:"column",allowedLayoutOptions:e},{key:"bar",allowedLayoutOptions:e},{key:"line",allowedLayoutOptions:e},{key:"combination",allowedLayoutOptions:e},{key:"pie",allowedLayoutOptions:e},{key:"donut",allowedLayoutOptions:e},{key:"dual_column",allowedLayoutOptions:t},{key:"dual_bar",allowedLayoutOptions:t},{key:"dual_line",allowedLayoutOptions:t},{key:"stacked_bar",allowedLayoutOptions:e},{key:"scatter",allowedLayoutOptions:t},{key:"bubble",allowedLayoutOptions:r},{key:"heatmap",allowedLayoutOptions:i},{key:"bullet",allowedLayoutOptions:e},{key:"vertical_bullet",allowedLayoutOptions:e},{key:"dual_stacked_bar",allowedLayoutOptions:t},{key:"100_stacked_bar",allowedLayoutOptions:e},{key:"stacked_column",allowedLayoutOptions:e},{key:"dual_stacked_column",allowedLayoutOptions:t},{key:"100_stacked_column",allowedLayoutOptions:e},{key:"dual_combination",allowedLayoutOptions:t},{key:"dual_horizontal_combination",allowedLayoutOptions:t},{key:"dual_horizontal_combination",allowedLayoutOptions:t},{key:"dual_stacked_combination",allowedLayoutOptions:t},{key:"dual_horizontal_stacked_combination",allowedLayoutOptions:t},{key:"stacked_combination",allowedLayoutOptions:e},{key:"100_dual_stacked_bar",allowedLayoutOptions:e},{key:"100_dual_stacked_column",allowedLayoutOptions:e},{key:"horizontal_stacked_combination",allowedLayoutOptions:e},{key:"waterfall",allowedLayoutOptions:i},{key:"horizontal_waterfall",allowedLayoutOptions:i}];return this._aChartTypeLayout};s.prototype._getTimeseriesSpecificPanelLayout=function(e){if(e.includes("timeseries")){var t=[this.CHARTLAYOUT_AXIS1,this.CHARTLAYOUT_CATEGORY,this.CHARTLAYOUT_SERIES];this._aChartTypeLayoutTimeseries=[{key:"timeseries_scatter",allowedLayoutOptions:t}];var i=this._aChartTypeLayoutTimeseries.find(function(t){return t.key===e});if(i){return i}else{var r=e.replace("timeseries_","");return this.getChartTypeLayoutConfig().find(function(e){return e.key===r})}}return undefined};s.prototype.isChartTypeValid=function(){if(!this.oPanel){return{valid:true,errorMessage:""}}const e=this.oPanel._validateChartType();const t=this.oPanel.getErrorConfig()?.chartType;const i=this.oPanel.getErrorMessage(t,e.error);return{valid:e.valid,errorMessage:i}};s.prototype.retrieveAdaptationUI=function(e){function t(e,t){if(!e.hasOwnProperty("index")||!t.hasOwnProperty("index")){return 0}if(e.index<t.index){return-1}if(e.index>t.index){return 1}return 0}var i;var a=new Promise(function(e,t){i=e});sap.ui.require(["sap/ui/mdc/p13n/panels/ChartItemPanel"],function(e){var a,s=this.getControlDataReduce().dimeasure.chartTypeKey;var u=[{kind:"Dimension"},{kind:"Measure"}];const l=this.getTable().getChartObject(),d=l?.getParent(),y={chartType:s,invalidChartType:d?._bInvalidChartType,errorMessage:d?._sErrorMsg};if(s.includes("timeseries")){a=this._getTimeseriesSpecificPanelLayout(s)}if(!a){a=this.getChartTypeLayoutConfig().find(function(e){return e.key===s})}if(!a){var m=[this.CHARTLAYOUT_AXIS1,this.CHARTLAYOUT_AXIS2,this.CHARTLAYOUT_AXIS3,this.CHARTLAYOUT_CATEGORY,this.CHARTLAYOUT_CATEGORY2,this.CHARTLAYOUT_SERIES];a={key:s,allowedLayoutOptions:m}}a.templateConfig=u;var f=new e({panelConfig:a,errorConfig:y,changeItems:function(e){if(!e.getParameter("items")){return}var t=e.getParameter("items");var i=this.getControlDataReduce();i.dimeasure.dimeasureItems.forEach(function(e){var i=r.getArrayElementByKey("columnKey",e.columnKey,t);if(!i){return}e.index=i.index;e.visible=i.visible;e.role=i.role});this.setControlDataReduce2Model(i);this.fireAfterPotentialModelChange({json:i})}.bind(this)});var h=this.getAdaptationData().sort(t);f.setP13nData(h);this.oPanel=f;if(s==="heatmap"||s==="timeseries_heatmap"){var p=o.getResourceBundleFor("sap.ui.mdc");f.setMessageStrip(new n({text:p.getText("chart.PERSONALIZATION_DIALOG_MEASURE_WARNING"),type:"Warning"}))}i(f)}.bind(this));return a};s.prototype._transformAdaptationData=function(t,i){var r=e.prototype._transformAdaptationData.apply(this,arguments);r.visible=t.visible;r.role=t.role;r.kind=t.aggregationRole;r.index=t.index;return r};s.prototype._isDimMeasureItemEqual=function(e,t){if(!e&&!t){return true}if(e&&!t){if(e.index===-1&&e.visible===false){return true}return false}if(t&&!e){if(t.index===-1&&t.visible===false){return true}return false}for(var i in e){if(t[i]===undefined||e[i]!==t[i]){return false}}return true};s.prototype._isSemanticEqual=function(e,t){if(e.dimeasure.chartTypeKey!==t.dimeasure.chartTypeKey){return false}var i=function(e,t){if(e.visible===true&&(t.visible===false||t.visible===undefined)){return-1}else if((e.visible===false||e.visible===undefined)&&t.visible===true){return 1}else if(e.visible===true&&t.visible===true){if(e.index<t.index){return-1}else if(e.index>t.index){return 1}else{return 0}}else if((e.visible===false||e.visible===undefined)&&(t.visible===false||t.visible===undefined)){if(e.columnKey<t.columnKey){return-1}else if(e.columnKey>t.columnKey){return 1}else{return 0}}};var a=r.copy(e.dimeasure.dimeasureItems).sort(i);var n=r.copy(t.dimeasure.dimeasureItems).sort(i);var o=true;a.some(function(e,t){if(!this._isDimMeasureItemEqual(e,n[t])){o=false;return true}},this);return o};s.prototype.getChangeType=function(e,t){if(!t||!t.dimeasure||!t.dimeasure.dimeasureItems){return i.personalization.ChangeType.Unchanged}return this._isSemanticEqual(e,t)?i.personalization.ChangeType.Unchanged:i.personalization.ChangeType.ModelChanged};s.prototype.getChangeData=function(e,t){if(!e||!e.dimeasure||!e.dimeasure.dimeasureItems){return this.createControlDataStructure()}if(!t||!t.dimeasure||!t.dimeasure.dimeasureItems){return{chartTypeKey:e.dimeasure.chartTypeKey,dimeasure:r.copy(e.dimeasure)}}if(!this._isSemanticEqual(e,t)){return{chartTypeKey:e.dimeasure.chartTypeKey,dimeasure:r.copy(e.dimeasure)}}return null};s.prototype.getUnionData=function(e,t){if(!t||!t.dimeasure||!t.dimeasure.dimeasureItems){return r.copy(e)}var i=r.copy(t);Object.keys(e.dimeasure).forEach(function(t){if(Array.isArray(e.dimeasure[t])){e.dimeasure[t].forEach(function(e){var a=r.getArrayElementByKey("columnKey",e.columnKey,i.dimeasure[t]);if(!a){i.dimeasure[t].push(e);return}if(a.visible===undefined&&e.visible!==undefined){a.visible=e.visible}if(a.role===undefined&&e.role!==undefined){a.role=e.role}if(a.index===undefined&&e.index!==undefined){a.index=e.index}if(a.aggregationRole===undefined&&e.aggregationRole!==undefined){a.aggregationRole=e.aggregationRole}});return}if(i.dimeasure[t]===undefined&&e.dimeasure[t]!==undefined){i.dimeasure[t]=e.dimeasure[t]}},this);return i};s._sortByIndex=function(e,t){if(e.index!==undefined&&t.index===undefined){return-1}if(t.index!==undefined&&e.index===undefined){return 1}if(e.index<t.index){return-1}if(e.index>t.index){return 1}return 0};s.prototype.isChartConsistent=function(e){var t=this.getTable();if(!t){return Promise.resolve(true)}var i=t.getChartObject();if(!i){return Promise.resolve(true)}return o.load("sap.chart",{async:true}).then(function(){try{var t=sap.ui.require("sap/chart/library");var r=t.api.getChartTypeLayout(e.dimeasure.chartTypeKey,i.getDimensions(),i.getMeasures());return r.errors.length===0}catch(e){return false}})};s.prototype.exit=function(){e.prototype.exit.apply(this,arguments);var t=this.getTable();if(t){var i=t.getChartObject();if(i){i.detachDrilledDown(this._onDrilledDown,this);i.detachDrilledUp(this._onDrilledUp,this)}}};return s});
//# sourceMappingURL=DimeasureController.js.map