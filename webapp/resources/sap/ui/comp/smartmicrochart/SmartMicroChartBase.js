/*!
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/core/Element","sap/ui/thirdparty/jquery","sap/ui/comp/library","sap/m/library","sap/ui/comp/providers/ChartProvider","sap/ui/core/format/NumberFormat","sap/ui/core/format/DateFormat","sap/ui/model/BindingMode","sap/ui/model/type/Date","sap/base/Log","sap/ui/core/Control","./SmartMicroChartRenderer","sap/suite/ui/microchart/library"],function(t,jQuery,e,a,i,r,n,o,s,l,h,u,p){"use strict";var c=a.ValueColor;var y=p.MicroChartColorType;var m=a.Size;var d=h.extend("sap.ui.comp.smartmicrochart.SmartMicroChartBase",{metadata:{abstract:true,library:"sap.ui.comp",properties:{entitySet:{type:"string",group:"Misc",defaultValue:null},chartType:{type:"string",group:"Misc"},chartBindingPath:{type:"string",group:"Misc",defaultValue:null},showLabel:{type:"boolean",group:"Appearance",defaultValue:true},width:{type:"sap.ui.core.CSSSize",group:"Misc"},height:{type:"sap.ui.core.CSSSize",group:"Misc"},size:{type:"sap.m.Size",group:"Misc",defaultValue:"Auto"},isResponsive:{type:"boolean",group:"Appearance",defaultValue:false}},defaultAggregation:"_chart",aggregations:{_chart:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},associations:{chartTitle:{type:"sap.m.Label",group:"Misc",multiple:false},chartDescription:{type:"sap.m.Label",group:"Misc",multiple:false},unitOfMeasure:{type:"sap.m.Label",group:"Misc",multiple:false},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{initialize:{}}},renderer:u});d._MINIMIZE="com.sap.vocabularies.UI.v1.ImprovementDirectionType/Minimize";d._MAXIMIZE="com.sap.vocabularies.UI.v1.ImprovementDirectionType/Maximize";d._TARGET="com.sap.vocabularies.UI.v1.ImprovementDirectionType/Target";d._DELTABULLET="com.sap.vocabularies.UI.v1.VisualizationType/DeltaBulletChart";d._BULLET="com.sap.vocabularies.UI.v1.VisualizationType/BulletChart";d._CALENDAR_TERMS_PATTERNS={"com.sap.vocabularies.Common.v1.IsCalendarYear":"yyyy","com.sap.vocabularies.Common.v1.IsCalendarQuarter":"Q","com.sap.vocabularies.Common.v1.IsCalendarMonth":"MM","com.sap.vocabularies.Common.v1.IsCalendarWeek":"ww","com.sap.vocabularies.Common.v1.IsCalendarDate":"yyyyMMdd","com.sap.vocabularies.Common.v1.IsCalendarYearMonth":"yyyyMM"};d._ASSOCIATIONS=["chartTitle","chartDescription","unitOfMeasure","freeText"];d._ASSOCIATIONS_ANNOTATIONS_MAP={chartDescription:"Description",chartTitle:"Title",unitOfMeasure:{propertyAnnotationPath:"Value",propertyAnnotationProperties:["ISOCurrency","Unit"]},freeText:{propertyAnnotationPath:"Value",propertyAnnotationProperties:["Label"]}};d._isBulletVizualizationType=function(t){return t===d._BULLET||t===d._DELTABULLET};d.prototype._initializeMetadata=function(){if(!this._bIsInitialized){var t=this.getModel();if(t&&(t.getMetadata().getName()==="sap.ui.model.odata.v2.ODataModel"||t.getMetadata().getName()==="sap.ui.model.odata.ODataModel")){if(!this._bMetaModelLoadAttached){t.getMetaModel().loaded().then(this._onMetadataInitialized.bind(this));this._bMetaModelLoadAttached=true}}else if(t){this._onMetadataInitialized.call(this)}}};d.prototype._onMetadataInitialized=function(){this._bMetaModelLoadAttached=false;if(this._bIsInitialized){return}this._createChartProvider.call(this);this._oChartViewMetadata=this._oChartProvider.getChartViewMetadata();this._oDataPointMetadata=this._oChartProvider.getChartDataPointMetadata();this._bIsInitialized=true;this.fireInitialize();if(this.getEnableAutoBinding&&this.getEnableAutoBinding()){if(this.getChartBindingPath()){this.bindElement(this.getChartBindingPath())}else{l.error("The property chartBindingPath needs to be set in order for property enableAutoBinding to be applied.")}}if(this._checkChartMetadata.call(this)){this._aDataPointAnnotations=this._getDataPointAnnotations.call(this);this._oDataPointAnnotations=this._aDataPointAnnotations[0];if(this._aDataPointAnnotations.every(this._checkDataPointAnnotation.bind(this))){this._createAndBindInnerChart()}}else{l.error("Created annotations not valid. Please review the annotations and metadata.")}};d.prototype._getDataPointAnnotations=function(){var t=[],e;if(this._oChartViewMetadata&&this._oChartViewMetadata.measureFields){for(var a=0;a<this._oChartViewMetadata.measureFields.length;a++){e=this._getDataPointAnnotation.call(this,this._oChartViewMetadata.measureFields[a]);t.push(e)}}else{e=this._getDataPointAnnotation.call(this);t.push(e)}return t};d.prototype._cleanup=function(){if(this._oDateType){this._oDateType.destroy();this._oDateType=null}};d.prototype._createChartProvider=function(){var t,e;e=this.getEntitySet();t=this.getModel();if(t&&e){this._oChartProvider=new i({entitySet:e,model:t,chartQualifier:this.data("chartQualifier")})}else{l.error("Property entitySet is not set or no model has been attached to the control.")}};d.prototype._checkChartMetadata=function(){if(jQuery.isEmptyObject(this._oChartViewMetadata)){if(jQuery.isEmptyObject(this._oDataPointMetadata)){l.error("DataPoint annotation must be provided if chart annotation is missing.");return false}return true}else{if(!this._oChartViewMetadata.fields||this._oChartViewMetadata.fields.length===0){l.error("No fields exist in the metadata.");return false}if(this._hasMember(this,"_oChartViewMetadata.annotation.ChartType")){return this._checkChartType.call(this)}else if(this.getChartType()==="Comparison"||this.getChartType()==="Delta"){return true}else{l.error("The Chart annotation is invalid.");return false}}};d.prototype._checkChartType=function(){var t=this._getSupportedChartTypes();for(var e=0;e<t.length;e++){if(this._oChartViewMetadata.annotation.ChartType.EnumMember==="com.sap.vocabularies.UI.v1.ChartType/"+t[e]){return true}}l.error('The ChartType property in the Chart annotation is not part of the list of valid types: "'+t.toString()+'".');return false};d.prototype._getDataPointQualifier=function(t){var e;if(!this._oChartViewMetadata&&this._oDataPointMetadata){return this.data("chartQualifier")}if(!this._hasMember(this,"_oChartViewMetadata.annotation.MeasureAttributes.length")||!this._oChartViewMetadata.annotation.MeasureAttributes.length){return""}if(t&&this._oChartViewMetadata.measureAttributes&&this._oChartViewMetadata.measureAttributes[t]){return(this._oChartViewMetadata.measureAttributes[t].dataPoint.match(/\#([^\#]*)$/)||[])[1]||""}e=this._oChartViewMetadata.annotation.MeasureAttributes[0];if(this._hasMember(e,"DataPoint.AnnotationPath")){return(e.DataPoint.AnnotationPath.match(/\#([^\#]*)$/)||[])[1]||""}};d.prototype._getDataPointAnnotation=function(t){var e=this._getDataPointQualifier.call(this,t),a;if(e){a=this._oDataPointMetadata.additionalAnnotations[e]}else{a=this._oDataPointMetadata.primaryAnnotation}return a};d.prototype._checkDataPointAnnotation=function(t){var e=null;if(jQuery.isEmptyObject(t)){l.error("The DataPoint annotation is empty. Please check it!");return false}if(this._hasMember(t,"Visualization.EnumMember")){e=t.Visualization.EnumMember;if(!d._isBulletVizualizationType(e)){l.error("The only support visualization types for micro charts are BulletChart and DeltaBulletChart.");return false}}if(jQuery.isEmptyObject(this._oChartViewMetadata)&&e===null){l.error("If only DataPoint annotation is provided the VisualizationType is expected to be set.");return false}if(this._hasMember(t,"Value.Path")){if(jQuery.isEmptyObject(t.Criticality)){this._checkCriticalityMetadata(t.CriticalityCalculation)}return true}else{l.error("The Value property does not exist in the DataPoint annotation. This property is essential for creating the smart chart.");return false}};d.prototype._checkCriticalityMetadata=function(t){if(jQuery.isEmptyObject(t)){l.warning("The CriticalityCalculation property in DataPoint annotation is not provided.");return false}if(this._hasMember(t,"ImprovementDirection.EnumMember")){var e=t.ImprovementDirection.EnumMember;switch(e){case d._MINIMIZE:return this._checkCriticalityMetadataForMinimize(t);case d._MAXIMIZE:return this._checkCriticalityMetadataForMaximize(t);case d._TARGET:return this._checkCriticalityMetadataForTarget(t);default:l.warning("The improvement direction in DataPoint annotation must be either Minimize, Maximize or Target.")}}else{l.warning("The ImprovementDirection property in DataPoint annotation is not provided.")}return false};d.prototype._checkCriticalityMetadataForMinimize=function(t){if(!this._hasMember(t,"ToleranceRangeHighValue.Path")){l.warning("The ToleranceRangeHighValue property in DataPoint annotation is missing for Minimize improvement direction.");return false}if(!this._hasMember(t,"DeviationRangeHighValue.Path")){l.warning("The DeviationRangeHighValue property in DataPoint annotation is missing for Minimize improvement direction.");return false}return true};d.prototype._checkCriticalityMetadataForMaximize=function(t){if(!this._hasMember(t,"ToleranceRangeLowValue.Path")){l.warning("The ToleranceRangeLowValue property in DataPoint annotation is missing for Minimize improvement direction.");return false}if(!this._hasMember(t,"DeviationRangeLowValue.Path")){l.warning("The DeviationRangeLowValue property in DataPoint annotation is missing for Minimize improvement direction.");return false}return true};d.prototype._checkCriticalityMetadataForTarget=function(t){if(!this._hasMember(t,"ToleranceRangeLowValue.Path")){l.warning("The DeviationRangeLowValue property in DataPoint annotation is missing for Target improvement direction.");return false}if(!this._hasMember(t,"ToleranceRangeHighValue.Path")){l.warning("The ToleranceRangeHighValue property in DataPoint annotation is missing for Target improvement direction.");return false}if(!this._hasMember(t,"DeviationRangeLowValue.Path")){l.warning("The ToleranceRangeLowValue property in DataPoint annotation is missing for Target improvement direction.");return false}if(!this._hasMember(t,"DeviationRangeHighValue.Path")){l.warning("The DeviationRangeHighValue property in DataPoint annotation is missing for Target improvement direction.");return false}return true};d.prototype._mapCriticalityTypeWithColor=function(t){var e;if(!t){return y.Neutral}else{e=t.toString()}e=(e.match(/(?:CriticalityType\/)?([^\/]*)$/)||[])[1]||"";if(y.hasOwnProperty(e)){switch(e){case"Negative":case"Error":case"1":return y.Error;case"Critical":case"Warning":case"2":return y.Critical;case"Good":case"Positive":case"3":return y.Good;case"Sequence1":return y.Sequence1;case"Sequence2":return y.Sequence2;case"Sequence3":return y.Sequence3;case"Sequence4":return y.Sequence4;case"Sequence5":return y.Sequence5;case"Sequence6":return y.Sequence6;case"Sequence7":return y.Sequence7;case"Sequence8":return y.Sequence8;case"Sequence9":return y.Sequence9;case"Sequence10":return y.Sequence10;case"Sequence11":return y.Sequence11;case"Sequence12":return y.Sequence12;default:return y.Neutral}}else{e=(e.match(/(?:CriticalityType\/)?([^\/]*)$/)||[])[1]||"";switch(e){case"Negative":case"1":return c.Error;case"Critical":case"2":return c.Critical;case"Positive":case"3":return c.Good;default:return c.Neutral}}};d.prototype._getThresholdValues=function(t){var e={},a=this.getBindingContext();for(var i in t){if(t.hasOwnProperty(i)&&i!=="ImprovementDirection"){e[i]=t[i].Path&&a&&a.getProperty(t[i].Path)||t[i].Decimal||0}}return e};d.prototype._getValueColorForMinimize=function(t,e,a){if(t<=e){return this._mapCriticalityTypeWithColor("Positive")}else if(t>e&&t<=a){return this._mapCriticalityTypeWithColor("Critical")}else if(t>a){return this._mapCriticalityTypeWithColor("Negative")}};d.prototype._getValueColorForMaximize=function(t,e,a){if(t>=e){return this._mapCriticalityTypeWithColor("Positive")}else if(t<e&&t>=a){return this._mapCriticalityTypeWithColor("Critical")}else if(t<a){return this._mapCriticalityTypeWithColor("Negative")}};d.prototype._getValueColorForTarget=function(t,e,a,i,r){if(t>=e&&t<=i){return this._mapCriticalityTypeWithColor("Positive")}else if(t>=a&&t<e||t>i&&t<=r){return this._mapCriticalityTypeWithColor("Critical")}else if(t<a||t>r){return this._mapCriticalityTypeWithColor("Negative")}};d.prototype._getValueColor=function(t,e){var a=this._oDataPointAnnotations.CriticalityCalculation,i,r;t=parseFloat(t)||0;if(typeof e==="string"){r=this._mapCriticalityTypeWithColor(e)}else if(a&&typeof t!=="undefined"&&t!==null){i=this._getThresholdValues.call(this,a);r=this._criticalityCalculation(t,a.ImprovementDirection.EnumMember,i)}return r||this._mapCriticalityTypeWithColor()};d.prototype._getTopLabelColor=function(t,e,a){var i=this._aDataPointAnnotations[a].CriticalityCalculation,r=parseFloat(t)||0,n={},o;for(var s in i){if(i.hasOwnProperty(s)&&s!=="ImprovementDirection"){n[s]=e[i[s].Path]}}if(i&&typeof r!=="undefined"&&r!==null){o=this._criticalityCalculation(r,i.ImprovementDirection.EnumMember,n)}return o};d.prototype._criticalityCalculation=function(t,e,a){var i;switch(e){case d._MINIMIZE:i=this._getValueColorForMinimize(t,a.ToleranceRangeHighValue,a.DeviationRangeHighValue);break;case d._MAXIMIZE:i=this._getValueColorForMaximize(t,a.ToleranceRangeLowValue,a.DeviationRangeLowValue);break;case d._TARGET:i=this._getValueColorForTarget(t,a.ToleranceRangeLowValue,a.DeviationRangeLowValue,a.ToleranceRangeHighValue,a.DeviationRangeHighValue);break;default:l.warning("The improvement direction in DataPoint annotation must be either Minimize, Maximize or Target.")}return i};d.prototype._getAnnotation=function(t){var e=d._ASSOCIATIONS_ANNOTATIONS_MAP[t];if(!e){l.warning('No annotation connected to association "'+t+'".');return{}}if(!jQuery.isEmptyObject(this._oChartViewMetadata)&&typeof e==="string"){return this._oChartViewMetadata.annotation[e]}if(!jQuery.isEmptyObject(this._oDataPointAnnotations)&&this._hasMember(e,"propertyAnnotationPath")&&this._hasMember(e,"propertyAnnotationProperties")){var a;if(this._hasMember(this._oDataPointAnnotations,e.propertyAnnotationPath+".Path")){a=this._getPropertyAnnotation.call(this,this._oDataPointAnnotations[e.propertyAnnotationPath].Path)}if(a){return this._getValueFromPropertyAnnotation(a,e.propertyAnnotationProperties)}}return{}};d.prototype._getValueFromPropertyAnnotation=function(t,e){for(var a in t){for(var i=0;i<e.length;i++){if(a.indexOf(e[i])>-1){return t[a]}}}return{}};d.prototype._updateAssociation=function(e,a){var i,r;if(this.getMetadata().hasAssociation(e)){i=t.getElementById(this.getAssociation(e));if(i&&i.getMetadata().hasProperty("text")){r=this._getAnnotation.call(this,e);this._setAssociationText(i,r,a)}}};d.prototype._updateAssociations=function(t){var e=t&&t.getContexts(0,1)[0],a=e&&e.getObject();var i=d._ASSOCIATIONS.length;for(var r=0;r<i;r++){this._updateAssociation.call(this,d._ASSOCIATIONS[r],a)}};d.prototype.updateChartLabels=function(t){var e={value:Infinity},a={value:-Infinity},i={value:Infinity},r={value:-Infinity},n,o,s,l,h;h=t.getContexts();h.forEach(function(t){for(var h=0;h<this._oChartViewMetadata.dimensionFields.length;h++){s=this._oChartViewMetadata.dimensionFields[h];n=t.getProperty(s);l=this._oChartViewMetadata.measureFields[h];o=t.getProperty(l);e=n<e.value?{context:t,value:n,index:h}:e;a=n>a.value?{context:t,value:n,index:h}:a;i=o<i.value?{context:t,value:o,index:h}:i;r=o>r.value?{context:t,value:o,index:h}:r}},this);if(i.context&&e.context&&r.context&&a.context){this._updateTopLabel.call(this,this._getLabelsMap()["leftTop"],i.context.getObject(),i.index);this._updateBottomLabel.call(this,this._getLabelsMap()["leftBottom"],e.context.getObject(),e.index);this._updateTopLabel.call(this,this._getLabelsMap()["rightTop"],r.context.getObject(),r.index);this._updateBottomLabel.call(this,this._getLabelsMap()["rightBottom"],a.context.getObject(),a.index)}};d.prototype._updateTopLabel=function(t,e,a){var i=e[this._aDataPointAnnotations[a].Value.Path],r=this._getTopLabelColor.call(this,i,e,a),n=this._getLabelNumberFormatter.call(this,this._aDataPointAnnotations[a].Value.Path),o;o=n.format(i);this._updateLabel(t,{text:o,color:r})};d.prototype._updateBottomLabel=function(t,e,a){var i,r,n,o;i=this._oChartViewMetadata.dimensionFields[a];if(i){n=e[i];r=this._getPropertyAnnotation.call(this,this._oChartViewMetadata.dimensionFields[a]);if(r.hasOwnProperty("sap:text")||r.hasOwnProperty("com.sap.vocabularies.Common.v1.Text")){var s=r["sap:text"]||r["com.sap.vocabularies.Common.v1.Text"].Path;o=e[s]}else{o=this._formatBottomLabel.call(this,n,r)}if(o){this._updateLabel(t,{text:o})}}};d.prototype._formatBottomLabel=function(t,e){var a=this._getSemanticsPattern.call(this,e);if(a){return this._formatSemanticsValue.call(this,t,a)}a=this._getCalendarPattern.call(this,e);if(a){return this._formatSemanticsValue.call(this,t,a)}return this._formatDateAndNumberValue.call(this,t)};d.prototype._formatSemanticsValue=function(t,e){if(e){if(!this._oDateType){this._oDateType=new s({style:"short",source:{pattern:e}})}return this._oDateType.formatValue(t,"string")}return null};d.prototype._formatDateAndNumberValue=function(t){if(t instanceof Date){return this._getLabelDateFormatter.call(this).format(t)}else if(!isNaN(t)){return this._getLabelNumberFormatter.call(this,this._oChartViewMetadata.dimensionFields[0]).format(t)}else{return null}};d.prototype._getSemanticsPattern=function(t){if(t.hasOwnProperty("sap:semantics")){switch(t["sap:semantics"]){case"yearmonthday":return"yyyyMMdd";case"yearmonth":return"yyyyMM";case"year":return"yyyy";default:return null}}return null};d.prototype._getCalendarPattern=function(t){for(var e in d._CALENDAR_TERMS_PATTERNS){if(t.hasOwnProperty(e)){return d._CALENDAR_TERMS_PATTERNS[e]}}return null};d.prototype._getLabelNumberFormatter=function(t){var e=this._getPropertyAnnotation.call(this,t).precision||null;var a=this._getPropertyAnnotation.call(this,t).scale||null;return r.getFloatInstance({style:"short",precision:e,decimals:a})};d.prototype._getLabelDateFormatter=function(){return n.getInstance({style:"short"})};d.prototype._setAssociationText=function(t,e,a){if(!e){return}if(e.Path&&a){t.setProperty("text",a[e.Path],false)}else if(e.Path){t.bindProperty("text",{path:e.Path,mode:o.OneWay});t.invalidate()}else if(e.String){if(e.String.indexOf("{")===0){var i=e.String.split(">");t.bindProperty("text",{path:i[1].substr(0,i[1].length-1),model:i[0].substr(1),mode:o.OneWay});t.invalidate()}else{t.setProperty("text",e.String,false)}}};d.prototype._getPropertyAnnotation=function(t){var e,a,i,r;e=this.getModel().getMetaModel();a=this._oChartProvider._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(this.getEntitySet());i=e.getODataEntityType(a);r=e.getODataProperty(i,t);return r};d.prototype._hasMember=function(t,e){var a=".",i=e.split(a),r=i.shift();return!!t&&(i.length>0?this._hasMember(t[r],i.join(a)):t.hasOwnProperty(r))};d.prototype.getAccessibilityInfo=function(){var t={};var e=this.getAggregation("_chart");if(e&&e.getAccessibilityInfo){t=e.getAccessibilityInfo()}return t};d.prototype._formatDimension=function(t){if(typeof t==="string"){var e=this._getPropertyAnnotation.call(this,this._oChartViewMetadata.dimensionFields[0]),a=this._getSemanticsPattern.call(this,e);if(a){t=n.getInstance({pattern:a}).parse(t)}}if(t instanceof Date){return parseFloat(t.getTime())}else if(!isNaN(t)){return parseFloat(t)}else{this.getAggregation("_chart").enableXIndexing(true);return 0}};d.prototype.exit=function(){this._cleanup.call(this)};d.prototype.setEntitySet=function(t){if(this.getProperty("entitySet")!==t){this.setProperty("entitySet",t,true);this._initializeMetadata.call(this)}return this};d.prototype.addAriaLabelledBy=function(t){this.addAssociation("ariaLabelledBy",t,true);this.getAggregation("_chart").addAriaLabelledBy(t);return this};d.prototype.removeAriaLabelledBy=function(t){this.removeAssociation("ariaLabelledBy",t,true);this.getAggregation("_chart").removeAriaLabelledBy(t);return this};d.prototype.removeAllAriaLabelledBy=function(){this.removeAllAssociation("ariaLabelledBy",true);this.getAggregation("_chart").removeAllAriaLabelledBy();return this};d.prototype.setChartType=function(){return this};d.prototype.propagateProperties=function(){if(h.prototype.propagateProperties){h.prototype.propagateProperties.apply(this,arguments)}this._initializeMetadata.call(this)};d.prototype._getBindingPath=function(){if(this.getChartBindingPath()){return this.getChartBindingPath()}else if(this.getEntitySet()){return"/"+this.getEntitySet()}else{return""}};d.prototype._getSupportedChartTypes=function(){return this._CHART_TYPE};d.prototype.setSize=function(t){if(this.getSize()!==t){this.setProperty("size",t)}return this};d.prototype.setAssociation=function(t,e,a){if(h.prototype.setAssociation){h.prototype.setAssociation.apply(this,arguments)}this._updateAssociation.call(this,t);return this};d.prototype._isResponsive=function(){return this.getSize()===m.Responsive};return d});
//# sourceMappingURL=SmartMicroChartBase.js.map