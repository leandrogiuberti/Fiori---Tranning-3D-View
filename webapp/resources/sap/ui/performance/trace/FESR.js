/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/config","sap/ui/Device","sap/ui/performance/trace/Passport","sap/ui/performance/trace/Interaction","sap/ui/performance/XHRInterceptor","sap/ui/performance/BeaconRequest","sap/ui/util/isCrossOriginURL","sap/base/util/Version"],function(e,t,n,r,i,a,o,s){"use strict";const u=e.get({name:"sapUiFesrEnv",type:e.Type.String,external:true});var p=false,c,f,m,d=n.getRootId(),g=t.os.name+"_"+t.os.version,l=`${t.browser.reportingName}_${t.browser.version}${u?":"+u:""}`,S=N(),v="",R="",P,T=0,h="undetermined",A="undetermined_startup_0",I,y,E=new WeakMap;function N(){var e=0;if(t.system.combi){e=1}else if(t.system.desktop){e=2}else if(t.system.tablet){e=4}else if(t.system.phone){e=3}return e}function b(e){var t=new Date(e);return t.toISOString().replace(/[^\d]/g,"")}function F(){if(!o(arguments[1])){if(!P){P=n.getTransactionId()}var e=n.header(n.traceFlags(),d,n.getTransactionId(),h,A);this.setRequestHeader("SAP-PASSPORT",e);E.set(this,e)}}function _(){if(!o(arguments[1])){if(I&&y){this.setRequestHeader("SAP-Perf-FESRec",I);this.setRequestHeader("SAP-Perf-FESRec-opt",y);I=null;y=null;P=n.getTransactionId()}}}function w(e,t){return[q(d,32),q(P,32),O(e.navigation,4),O(e.roundtrip,4),O(t.timeToInteractive,4),O(e.completeRoundtrips,2),q(A,40,true),O(e.networkTime,4),O(e.requestTime,4),q(g,10),"SAP_UI5"].join(",")}function H(e,t){return[q(t.appNameShort,20,true),q(t.stepName,20,true),"",q(l,20),O(e.bytesSent,4),O(e.bytesReceived,4),"","",O(e.processing,4),e.requestCompression?"X":"","","","","",O(e.busyDuration,4),O(t.interactionType||0,4),q(S,1),"",q(b(e.start),20),q(t.appNameLong,70,true)].join(",")}function q(e,t,n){if(!e){e=e===0?"0":""}else if(typeof e==="number"){var r=e;e=Math.round(e).toString();if(e.length>t||r<0){e="-1"}}else{e=n?e.substr(-t,t):e.substr(0,t)}return e}function O(e,t){if(typeof e!=="number"){e=""}else{var n=Math.pow(256,t)/2-1;e=Math.round(e);e=e>=0&&e<=n?e.toString():"-1"}return e}function C(e){var t=new s(e);return"@"+t.getMajor()+"."+t.getMinor()+"."+t.getPatch()}function D(e,t){I=w(e,t);y=H(e,t)}function L(e){T++;h=e?e.component+v:undefined;A=e?e.trigger+"_"+e.event+"_"+T:undefined;return A}function M(e){if(e){e.rootId=n.getRootId();var t=e.semanticStepName?e.semanticStepName:e.trigger+"_"+e.event;var r=U.onBeforeCreated({stepName:t,appNameLong:e.stepComponent||e.component,appNameShort:e.stepComponent||e.component,timeToInteractive:e.duration,interactionType:B(t)},e);if(f||e.requests.length>0){D(e,r);if(f){P=null}}if(f&&I&&y){f.append("SAP-Perf-FESRec",I+"SAP-Perf-FESRec-opt"+y);$()}if(R!=e.appVersion){R=e.appVersion;v=R?C(R):""}}h="undefined";A="undefined"}function $(){if(!m){m=setTimeout(function(){f.send();clearTimeout(m);m=undefined},6e4)}}function B(e){var t=2;if(e.indexOf("startup")!==-1){t=1}return t}var U={};U.getBeaconURL=function(){return c};U.setActive=async function(e,o){if(e&&!p){f=o?a.isSupported()&&new a({url:o}):null;c=o;p=true;n.setActive(true);await r.setActive(true);i.register("PASSPORT_HEADER","open",F);if(!f){i.register("FESR","open",_)}r.setFESR(U);await t.os.getPlatformInfo().then(e=>{g=`${e.name}_${e.version}`})}else if(!e&&p){p=false;await r.setActive(false);i.unregister("FESR","open");if(i.isRegistered("PASSPORT_HEADER","open")){i.register("PASSPORT_HEADER","open",function(){this.setRequestHeader("SAP-PASSPORT",n.header(n.traceFlags(),d,n.getTransactionId()))})}if(f){f.send();clearTimeout(m);m=null;f=null;c=null}r.setFESR(null)}};U.getActive=function(){return p};U.onBeforeCreated=function(e,t){return{stepName:e.stepName,appNameLong:e.appNameLong,appNameShort:e.appNameShort,timeToInteractive:e.timeToInteractive,interactionType:e.interactionType}};U.onInteractionStarted=L;U.onInteractionFinished=M;U.passportHeader=E;return U});
//# sourceMappingURL=FESR.js.map