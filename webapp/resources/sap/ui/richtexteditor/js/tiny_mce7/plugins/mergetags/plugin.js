/*!
 * Tiny Merge Tags plugin
 *
 * Copyright (c) 2023 Ephox Corporation DBA Tiny Technologies, Inc.
 * Licensed under the Tiny commercial license. See https://www.tiny.cloud/legal/
 *
 * Version: 7.7.2-153
 */

!function(){"use strict";const e=e=>t=>(e=>{const t=typeof e;return null===e?"null":"object"===t&&Array.isArray(e)?"array":"object"===t&&(n=r=e,(o=String).prototype.isPrototypeOf(n)||(null===(a=r.constructor)||void 0===a?void 0:a.name)===o.name)?"string":t;var n,r,o,a})(t)===e,t=e("string"),n=e("object"),r=e("array"),o=e=>!(e=>null==e)(e);class a{constructor(e,t){this.tag=e,this.value=t}static some(e){return new a(!0,e)}static none(){return a.singletonNone}fold(e,t){return this.tag?t(this.value):e()}isSome(){return this.tag}isNone(){return!this.tag}map(e){return this.tag?a.some(e(this.value)):a.none()}bind(e){return this.tag?e(this.value):a.none()}exists(e){return this.tag&&e(this.value)}forall(e){return!this.tag||e(this.value)}filter(e){return!this.tag||e(this.value)?this:a.none()}getOr(e){return this.tag?this.value:e}or(e){return this.tag?this:e}getOrThunk(e){return this.tag?this.value:e()}orThunk(e){return this.tag?this:e()}getOrDie(e){if(this.tag)return this.value;throw new Error(null!=e?e:"Called getOrDie on None")}static from(e){return o(e)?a.some(e):a.none()}getOrNull(){return this.tag?this.value:null}getOrUndefined(){return this.value}each(e){this.tag&&e(this.value)}toArray(){return this.tag?[this.value]:[]}toString(){return this.tag?`some(${this.value})`:"none()"}}a.singletonNone=new a(!1);const s=e=>parseInt(e,10),i=(e,t)=>{const n=e-t;return 0===n?0:n>0?1:-1},l=(e,t,n)=>({major:e,minor:t,patch:n}),u=e=>{const t=/([0-9]+)\.([0-9]+)\.([0-9]+)(?:(\-.+)?)/.exec(e);return t?l(s(t[1]),s(t[2]),s(t[3])):l(0,0,0)},c=Array.prototype.slice,g=Array.prototype.push,h=(e,t)=>{const n=e.length,r=new Array(n);for(let o=0;o<n;o++){const n=e[o];r[o]=t(n,o)}return r},m=(e,t)=>{for(let n=0,r=e.length;n<r;n++)t(e[n],n)},d=e=>{const t=[];for(let n=0,o=e.length;n<o;++n){if(!r(e[n]))throw new Error("Arr.flatten item "+n+" was not an array, input: "+e);g.apply(t,e[n])}return t},f=(e,t)=>d(h(e,t)),p=(e,t)=>{for(let n=0,r=e.length;n<r;++n)if(!0!==t(e[n],n))return!1;return!0},v=Object.hasOwnProperty,y=(e,t)=>v.call(e,t),b=e=>y(e,"value")&&t(e.value)&&e.value.length>0,x=e=>y(e,"title")&&t(e.title)&&e.title.length>0&&y(e,"menu")&&r(e.menu)&&e.menu.length>0&&p(e.menu,w),w=e=>n(e)&&(b(e)||x(e)),N=e=>{var t;if(r(t=e)&&t.length>0&&p(t,w)){const t=(e=>{const t=(e,n)=>{if(0===e.length)return n;const[r,...o]=e;if(b(r))return r.value.length>255?t(o,n):t(o,[...n,r]);{const e=t(r.menu,[]);return t(o,e.length>0?[...n,{...r,menu:e}]:n)}};return t(e,[])})(e);return t.length>0?{valid:!0,value:t}:{valid:!1,message:"Merge tag list should not contain values with more than 255 characters"}}return{valid:!1,message:"Must be a non-empty array of objects matching the configuration schema: https://www.tiny.cloud/docs/tinymce/6/mergetags/"}},C=e=>t=>t.options.get(e),_=C("mergetags_prefix"),T=C("mergetags_suffix"),O=C("mergetags_list"),j="data-mce-mergetag",A="data-mce-mergetag-affix",E="mce-mergetag-affix",M=(e,t,n)=>{const r=tinymce.html.Node.create("span",{class:"mce-mergetag",contenteditable:"false","data-mce-cef-wrappable":"true",[j]:"1"}),o=tinymce.html.Node.create("span",{class:E,[A]:""}),a=tinymce.html.Node.create("#text");a.value=t,o.append(a);const s=tinymce.html.Node.create("span",{class:E,[A]:""}),i=tinymce.html.Node.create("#text");i.value=n,s.append(i);const l=tinymce.html.Node.create("#text");return l.value=e,r.append(o),r.append(l),r.append(s),r},S=(e,t,n)=>tinymce.html.Serializer().serialize(M(e,t,n)),k=(e,t)=>{const n=[];for(let r=e.indexOf(t);-1!==r;r=e.indexOf(t,r+t.length))n.push(r);return n},I=(e,t,n)=>((e,t,n,r=255)=>{let o=[],s=[];if(t===n){const n=k(e,t);if(n.length<2)return a.none();m(n,((e,t)=>(t%2==0?o:s).push(e)))}else{if(o=k(e,t),0===o.length)return a.none();if(s=k(e,n),0===s.length)return a.none()}const i=h(o,(e=>[e,-1])),l=t.length;for(let e=s.length-1;e>=0;e--){const t=s[e];for(let e=o.length-1;e>=0;e--){const n=o[e]+l;if(t>n){t<=n+r&&(i[e][1]=t);break}}}const u=(e=>{const t=[];for(let n=0,r=e.length;n<r;n++){const r=e[n];-1!==r[1]&&t.push(r)}return t})(i),c=h(u,(([e,t])=>[e,t+n.length]));return g=c,c.length>0?a.some(g):a.none();var g})(e,t,n).map((r=>h(((e,t)=>{const n=d(e);let r=!1;0===n[0]?r=!0:n.unshift(0),n[n.length-1]!==t&&n.push(t);const o=[];for(let e=0;e<n.length-1;e++)n[e]!==n[e+1]&&o.push({isTag:r,indexes:[n[e],n[e+1]]}),r=!r;return o})(r,e.length),(({isTag:r,indexes:[o,a]})=>r?{isTag:r,content:e.substring(o+t.length,a-n.length)}:{isTag:r,content:e.substring(o,a)})))),P=e=>m(e,(e=>e.unwrap())),L=e=>{if(null==e)throw new Error("Node cannot be null or undefined");return{dom:e}},z=L;"undefined"!=typeof window?window:Function("return this;")();const F=e=>t=>(e=>e.dom.nodeType)(t)===e,R=F(1),$=F(9),B=F(11),D=e=>z(e.dom.getRootNode()),q=e=>(e=>B(e)&&o(e.dom.host))(e)?e:z((e=>$(e)?e:z(e.dom.ownerDocument))(e).dom.body),H=e=>e.dom.blur(),U=e=>{const t=D(z(e.getElement())),n=q(t);var r;(r=n,((e=(()=>z(document))())=>a.from(e.dom.activeElement).map(z))(D(r)).filter((e=>r.dom.contains(e.dom)))).filter((e=>R(e)&&"input"===e.dom.nodeName.toLowerCase())).each(H)},V=e=>t(e.title)&&e.title.length>0?e.title:e.value;function G(e,t){const n=_(e),r=T(e),o=t=>h(t,(t=>(t=>x(t)?{type:"nestedmenuitem",text:t.title,getSubmenuItems:()=>o(t.menu)}:{type:"menuitem",text:V(t),value:t.value,onAction:()=>{return o=t.value,U(e),void e.insertContent(S(o,n,r));var o}})(t)));return o(t)}const K=(e,t)=>{if(0===t.length)return e;{const n=t.toLowerCase(),r=f(e,(e=>{const t=((e,t,n)=>{const r=e.toLowerCase().indexOf(n),o=t.toLowerCase().indexOf(n),a=r>-1,s=o>-1;return a&&s?Math.min(r,o):a?r:s?o:-1})(e.text,e.value,n);return t>=0?[{item:e,index:t}]:[]})),o=(e=>{const t=c.call(e,0);return t.sort(((e,t)=>e.index-t.index)),t})(r);return h(o,(({item:e})=>e))}},W=e=>{const t=(e,n)=>((e,n,r)=>(m(e,((e,n)=>{var o,a;o=r,r=x(a=e)?t(a.menu,o):[...o,a]})),r))(e,0,n);return t(e,[])};tinymce.PluginManager.requireLangPack("mergetags","ar,bg_BG,ca,cs,da,de,el,es,eu,fa,fi,fr_FR,he_IL,hi,hr,hu_HU,id,it,ja,kk,ko_KR,ms,nb_NO,nl,pl,pt_BR,pt_PT,ro,ru,sk,sl_SI,sv_SE,th_TH,tr,uk,vi,zh_CN,zh_TW"),tinymce.PluginManager.add("mergetags",(e=>{((e,t)=>!!e&&-1===((e,t)=>{const n=i(e.major,t.major);if(0!==n)return n;const r=i(e.minor,t.minor);if(0!==r)return r;const o=i(e.patch,t.patch);return 0!==o?o:0})((e=>u((e=>[e.majorVersion,e.minorVersion].join(".").split(".").slice(0,3).join("."))(e)))(e),u(t)))(tinymce,"6.4.0")?console.error("The mergetags plugin requires at least version 6.4.0 of TinyMCE."):((e=>{const t=e.options.register;t("mergetags_list",{processor:N}),t("mergetags_prefix",{processor:"string",default:"{{"}),t("mergetags_suffix",{processor:"string",default:"}}"})})(e),(e=>{const t=_(e),n=T(e);e.addCommand("mceMergeTag",((r,o)=>{((e,t,n)=>{const r=e.selection.getContent({format:"text"});r.length>0&&r.length<=255?e.insertContent(S(r,t,n)):r.length>255&&(e.insertContent(`${t}${r}${n}`),console.error("Merge tag content should not contain more than 255 characters"))})(e,t,n),e.execCommand("mceAutocompleterClose")}))})(e),(e=>{e.on("PreInit",(()=>{const{serializer:n,parser:r}=e,o=_(e),s=T(e);r.addNodeFilter("#text",((e,n)=>r=>{const o=e.length+n.length,s=f(r,(r=>a.from(r.value).filter((e=>e.length>o&&!(e=>{let n=e;for(;n=n.parent;){const e=n.attr("contenteditable");if(t(e))return"false"===e}return!1})(r))).map((t=>({node:r,fragments:I(t,e,n)}))).toArray()));m(s,(({node:t,fragments:r})=>{const o=tinymce.html.Node.create("span");r.each((r=>{m(r,(({isTag:t,content:r})=>{if(t)o.append(M(r,e,n));else{const e=tinymce.html.Node.create("#text");e.value=r,o.append(e)}})),t.replace(o),o.unwrap()}))}))})(o,s)),n.addAttributeFilter([j,A].join(","),P)}))})(e),a.from(O(e)).fold((()=>{console.warn("No entries added to the mergetags_list option yet. The toolbar button and menu item for the mergetags plugin will be hidden.")}),(t=>{((e,t)=>{const n=_(e),r=T(e),o=W(t),a=h(o,(e=>({text:V(e),...e})));e.ui.registry.addAutocompleter("mergetags",{trigger:n,minChars:0,columns:1,fetch:e=>Promise.resolve(K(a,e)),onAction:(t,o,a)=>{e.selection.setRng(o),e.insertContent(S(a,n,r)),t.hide()}})})(e,t),((e,t)=>{const n=G(e,t),r=((e,t)=>G(e,W(t)))(e,t);e.ui.registry.addMenuButton("mergetags",{tooltip:"Insert merge tag",icon:"addtag",onSetup:t=>{const n=()=>{t.setEnabled(e.selection.isEditable())};return e.on("NodeChange",n),n(),()=>{e.off("NodeChange",n)}},search:{placeholder:"Filter merge tags"},fetch:(e,t)=>{t.pattern.length>0?e((e=>{const t=K(r,e);return t.length>0?t:[{type:"menuitem",value:"stub",text:"No matches",enabled:!1}]})(t.pattern)):e(n)}})})(e,t),((e,t)=>{const n=G(e,t);var r;e.ui.registry.addNestedMenuItem("mergetags",{text:"Merge tag",icon:"addtag",onSetup:t=>{const n=()=>{t.setEnabled(e.selection.isEditable())};return e.on("NodeChange",n),n(),()=>{e.off("NodeChange",n)}},getSubmenuItems:(r=n,()=>r)})})(e,t)})))}))}();