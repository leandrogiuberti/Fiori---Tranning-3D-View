{"version":3,"file":"InitController.js","names":["Environment","___sap_px_pxapi","Constants","_interopRequireDefault","__Constants","Util","__Util","EmbeddedPxConfig","__EmbeddedPxConfig","PxApiWrapper","__PxApiWrapper","PushStateMigrator","__PushStateMigrator","InitController","pluginInfo","_classCallCheck","this","_pxApiWrapper","_createClass","key","get","value","init","parameters","surveyInvitationDialogCallback","_temp2","_result","_exit","Log","error","ERROR","INIT_PARAMS_INCONSISTENT","undefined","COMPONENT","INIT_CONTROLLER","_this","migrate","PUSH_STATE_MIGRATION_FAILED","Promise","resolve","isPhone","info","INFO","PHONE_NOT_SUPPORTED","_temp","hasOldParameters","initWithOldParameters","then","_await$_this$initWith","hasNewParameters","hasUrlParameters","overwriteWithUrlParameters","initWithNewParameters","_await$_this$initWith2","e","reject","Device","system","phone","configUrl","unitId","environment","debug","DEBUG","INIT_PARAMS_MANDATORY_FOUND_NEW","INIT_PARAMS_MANDATORY_NOT_SET_NEW","configJson","INIT_PARAMS_MANDATORY_FOUND_JSON","INIT_PARAMS_MANDATORY_NOT_SET_JSON","qualtricsInternalUri","tenantId","INIT_PARAMS_MANDATORY_FOUND_OLD","INIT_PARAMS_MANDATORY_NOT_SET_OLD","isUnitIdUrlParamSet","isEnvironmentUrlParamSet","INIT_PARAMS_URL_MODIFIED","getUnitIdUrlParamValue","env","getEnvironmentUrlParamValue","_temp4","_result3","_exit2","_this2","_temp3","tenantInfo","tenantRole","configIdentifier","initialize","_await$_this2$_pxApiW","_await$_this2$_pxApiW2","_this3","version","prod","startupConfig","productName","platformType","scopeSet","convertScopeSet","runtimeConfig","useApi","themingConfig","writeToGlobals","pushConfig","scopeSetString","scopeSetMap","featurePush","SCOPE_SETS","APP_PUSH","dynamicPush","TIMED_PUSH","scopeSetArray","split","appendManualScopeSet","map","scopeItem","trim","MANUAL","indexOf","push"],"sources":["./InitController.ts"],"sourcesContent":["import { Environment } from '@sap-px/pxapi';\nimport { ConfigIdentifier, JSONValue, SurveyInvitationDialogCallback, TenantInfo } from '@sap-px/pxapi/dist/api/common/Types';\nimport Log from 'sap/base/Log';\nimport Device from 'sap/ui/Device';\nimport Constants from '../common/Constants';\nimport { PluginInfo, PxConfigType, RawStartParameters } from '../common/Types';\nimport Util from '../common/Util';\nimport EmbeddedPxConfig from '../embeddedCfg/EmbeddedPxConfig';\nimport PxApiWrapper from '../pxapi/PxApiWrapper';\nimport PushStateMigrator from '../storage/PushStateMigrator';\n\nexport default class InitController {\n\tprivate _pxApiWrapper: PxApiWrapper;\n\n\tconstructor(pluginInfo: PluginInfo) {\n\t\tthis._pxApiWrapper = new PxApiWrapper(pluginInfo);\n\t}\n\n\tpublic get pxApiWrapper() {\n\t\treturn this._pxApiWrapper;\n\t}\n\n\tpublic async init(parameters: RawStartParameters, surveyInvitationDialogCallback: SurveyInvitationDialogCallback): Promise<boolean> {\n\t\tif (!PushStateMigrator.migrate()) {\n\t\t\tLog.error(Constants.ERROR.PUSH_STATE_MIGRATION_FAILED, undefined, Constants.COMPONENT.INIT_CONTROLLER);\n\t\t\treturn false;\n\t\t}\n\t\tif (this.isPhone()) {\n\t\t\tLog.info(Constants.INFO.PHONE_NOT_SUPPORTED, undefined, Constants.COMPONENT.INIT_CONTROLLER);\n\t\t\treturn false;\n\t\t}\n\t\tif (this.hasOldParameters(parameters)) {\n\t\t\treturn await this.initWithOldParameters(parameters, surveyInvitationDialogCallback);\n\t\t} else if (this.hasNewParameters(parameters)) {\n\t\t\tif (this.hasUrlParameters()) {\n\t\t\t\tthis.overwriteWithUrlParameters(parameters);\n\t\t\t}\n\t\t\treturn await this.initWithNewParameters(parameters, surveyInvitationDialogCallback);\n\t\t}\n\t\tLog.error(Constants.ERROR.INIT_PARAMS_INCONSISTENT, undefined, Constants.COMPONENT.INIT_CONTROLLER);\n\t\treturn false;\n\t}\n\n\tprivate isPhone(): boolean {\n\t\treturn Device.system.phone;\n\t}\n\n\tprivate hasNewParameters(parameters: RawStartParameters): boolean {\n\t\tif (parameters.configUrl && parameters.unitId && parameters.environment) {\n\t\t\tLog.debug(Constants.DEBUG.INIT_PARAMS_MANDATORY_FOUND_NEW, undefined, Constants.COMPONENT.INIT_CONTROLLER);\n\t\t\treturn true;\n\t\t}\n\t\tLog.debug(Constants.DEBUG.INIT_PARAMS_MANDATORY_NOT_SET_NEW, undefined, Constants.COMPONENT.INIT_CONTROLLER);\n\t\tif (parameters.configJson) {\n\t\t\tLog.debug(Constants.DEBUG.INIT_PARAMS_MANDATORY_FOUND_JSON, undefined, Constants.COMPONENT.INIT_CONTROLLER);\n\t\t\treturn true;\n\t\t}\n\t\tLog.debug(Constants.DEBUG.INIT_PARAMS_MANDATORY_NOT_SET_JSON, undefined, Constants.COMPONENT.INIT_CONTROLLER);\n\t\treturn false;\n\t}\n\n\tprivate hasOldParameters(parameters: RawStartParameters): boolean {\n\t\tif (parameters.qualtricsInternalUri && parameters.tenantId) {\n\t\t\tLog.debug(Constants.DEBUG.INIT_PARAMS_MANDATORY_FOUND_OLD, undefined, Constants.COMPONENT.INIT_CONTROLLER);\n\t\t\treturn true;\n\t\t}\n\t\tLog.debug(Constants.DEBUG.INIT_PARAMS_MANDATORY_NOT_SET_OLD, undefined, Constants.COMPONENT.INIT_CONTROLLER);\n\t\treturn false;\n\t}\n\n\tprivate hasUrlParameters(): boolean {\n\t\tif (Util.isUnitIdUrlParamSet() && Util.isEnvironmentUrlParamSet()) {\n\t\t\tLog.debug(Constants.DEBUG.INIT_PARAMS_URL_MODIFIED, undefined, Constants.COMPONENT.INIT_CONTROLLER);\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tprivate overwriteWithUrlParameters(parameters: RawStartParameters) {\n\t\tconst unitId = Util.getUnitIdUrlParamValue();\n\t\tif (unitId) {\n\t\t\tparameters.unitId = unitId;\n\t\t}\n\t\tconst env = Util.getEnvironmentUrlParamValue();\n\t\tif (env) {\n\t\t\tparameters.environment = env;\n\t\t}\n\t}\n\n\t// FLP Settings\n\tprivate async initWithNewParameters(\n\t\tparameters: RawStartParameters,\n\t\tsurveyInvitationDialogCallback: SurveyInvitationDialogCallback\n\t): Promise<boolean> {\n\t\t//Load PX-API\n\t\tif (parameters.configUrl && !parameters.configJson) {\n\t\t\tconst tenantInfo = {\n\t\t\t\ttenantId: parameters.tenantId,\n\t\t\t\ttenantRole: parameters.tenantRole\n\t\t\t} as TenantInfo;\n\t\t\tconst configIdentifier = {\n\t\t\t\tconfigUrl: parameters.configUrl,\n\t\t\t\tunitId: parameters.unitId,\n\t\t\t\tenvironment: parameters.environment\n\t\t\t} as ConfigIdentifier;\n\t\t\treturn await this._pxApiWrapper.initialize(tenantInfo, configIdentifier, undefined, surveyInvitationDialogCallback);\n\t\t} else if (!parameters.configUrl && parameters.configJson) {\n\t\t\tconst tenantInfo = {\n\t\t\t\ttenantId: parameters.tenantId,\n\t\t\t\ttenantRole: parameters.tenantRole\n\t\t\t} as TenantInfo;\n\t\t\tconst configJson = parameters.configJson as PxConfigType;\n\t\t\treturn await this._pxApiWrapper.initialize(tenantInfo, undefined, configJson as JSONValue, surveyInvitationDialogCallback);\n\t\t}\n\t\tLog.error(Constants.ERROR.INIT_PARAMS_INCONSISTENT, undefined, Constants.COMPONENT.INIT_CONTROLLER);\n\t\treturn false;\n\t}\n\n\tprivate async initWithOldParameters(\n\t\tparameters: RawStartParameters,\n\t\tsurveyInvitationDialogCallback: SurveyInvitationDialogCallback\n\t): Promise<boolean> {\n\t\t//Load embedded config\n\t\tconst configJson = {\n\t\t\tversion: '0.4.0',\n\t\t\tunitId: '83cec47d-199c-4fc9-8848-330c6e3ec6bb',\n\t\t\tenvironment: Environment.prod,\n\t\t\tstartupConfig: {\n\t\t\t\tqualtricsInternalUri: parameters.qualtricsInternalUri,\n\t\t\t\tproductName: parameters.productName,\n\t\t\t\tplatformType: parameters.platformType,\n\t\t\t\tscopeSet: this.convertScopeSet(parameters.scopeSet)\n\t\t\t},\n\t\t\truntimeConfig: {\n\t\t\t\tuseApi: true\n\t\t\t},\n\t\t\tthemingConfig: {\n\t\t\t\twriteToGlobals: true\n\t\t\t},\n\t\t\tpushConfig: EmbeddedPxConfig.pushConfig()\n\t\t} as PxConfigType;\n\n\t\tconst tenantInfo = {\n\t\t\ttenantId: parameters.tenantId,\n\t\t\ttenantRole: parameters.tenantRole\n\t\t} as TenantInfo;\n\t\t//Load and init PX-API\n\t\treturn await this._pxApiWrapper.initialize(tenantInfo, undefined, configJson as JSONValue, surveyInvitationDialogCallback);\n\t}\n\n\tprivate convertScopeSet(scopeSetString: string | undefined): string[] {\n\t\tconst scopeSetMap = { featurePush: Constants.SCOPE_SETS.APP_PUSH, dynamicPush: Constants.SCOPE_SETS.TIMED_PUSH };\n\t\tif (scopeSetString) {\n\t\t\tlet scopeSetArray = scopeSetString.split(',');\n\t\t\tscopeSetArray = this.appendManualScopeSet(scopeSetArray);\n\t\t\tconst scopeSet = scopeSetArray.map((scopeItem) => {\n\t\t\t\treturn scopeSetMap[scopeItem.trim() as keyof typeof scopeSetMap] || scopeItem.trim();\n\t\t\t});\n\t\t\treturn scopeSet;\n\t\t}\n\t\treturn [Constants.SCOPE_SETS.MANUAL];\n\t}\n\n\tprivate appendManualScopeSet(scopeSetArray: string[]): string[] {\n\t\tif (scopeSetArray.indexOf(Constants.SCOPE_SETS.MANUAL) > -1) {\n\t\t\treturn scopeSetArray;\n\t\t}\n\t\tscopeSetArray.push(Constants.SCOPE_SETS.MANUAL);\n\t\treturn scopeSetArray;\n\t}\n}\n"],"mappings":"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","ignoreList":[]}