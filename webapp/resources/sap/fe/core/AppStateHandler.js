/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/fe/base/ClassSupport","sap/fe/core/helpers/ToES6Promise","sap/fe/navigation/library","sap/ui/base/Object","./controllerextensions/BusyLocker","./helpers/ModelHelper"],function(t,e,n,a,o,i,r,s){"use strict";var p,c,u;var l=n.defineUI5Class;function f(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,S(t,e)}function S(t,e){return S=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},S(t,e)}const h=o.NavType;const A="skipMerge";const g="REPLACE_COMPLETE_APPSTATE";let d=(p=l("sap.fe.core.AppStateHandler"),p(c=(u=function(n){function o(e){var a;a=n.call(this)||this;a._mCurrentAppState={};a.oAppComponent=e;a.sId=`${e.getId()}/AppStateHandler`;a.simultaneousCreateRequest={};a.bNoRouteChange=false;t.info("APPSTATE : Appstate handler initialized");return a}f(o,n);var i=o.prototype;i.getId=function t(){return this.sId};i._getInnerAppStateForView=function t(e,n){if(n===g||!e){return e}return{[n]:e[n]||{}}};i._addAppStateInHash=function e(n,a){const o=this.oAppComponent,i=o.getNavigationService(),r=o.getRouterProxy(),p=r.getHash(),c=s.isStickySessionSupported(o.getMetaModel()),u=i.replaceInnerAppStateKey(r.getHash(),n);if(u&&this.simultaneousCreateRequest[a]===0&&u!==p){r.navToHash(u,undefined,undefined,undefined,!c);this.bNoRouteChange=true}t.info("APPSTATE: navToHash")};i._createAppStateKey=async function e(n,a){const o=this.oAppComponent,i=o.getNavigationService();if(this.simultaneousCreateRequest[a]){this.simultaneousCreateRequest[a]++}else{this.simultaneousCreateRequest[a]=1}const r=await i.storeInnerAppStateAsync(n,true,true);this.simultaneousCreateRequest[a]--;t.info("APPSTATE: Appstate stored");return r};i._getAppStateInfo=async function n(a,o){const i=this.oAppComponent;const{replaceHash:r=true,viewId:s=g}=o??{};let p=null;let c={appState:this._mCurrentAppState};const u=this._getInnerAppStateForView(this._mCurrentAppState,s);if(a&&!e(u,a)){this._mCurrentAppState={...this._mCurrentAppState,...a};c={appState:this._mCurrentAppState};try{p=await this._createAppStateKey(c,s);if(r===true){this._addAppStateInHash(p,s)}}catch(e){t.error(e)}}else{const t=i.getRouterProxy(),e=t.getHash();p=t.findAppStateInHash(e)}return{appStateData:c,appStateKey:p}};i.createAppState=async function t(e){const n=this.oAppComponent;if(!n.getEnvironmentCapabilities().getCapabilities().AppState||r.isLocked(this)){return}const{skipMerge:a=false,viewId:o=g}=e??{},i=n.getRootControl().getController();if(!i.viewState){throw new Error(`viewState controller extension not available for controller: ${i.getMetadata().getName()}`)}await i.routingIsComplete();let s=await i.viewState.retrieveViewState();s=this._getInnerAppStateForView(s,o);if(a){s={...s,...{skipMerge:a}}}return this._getAppStateInfo(s,e)};i._createNavigationParameters=function t(e,n){return Object.assign({},e,{selectionVariantDefaults:e.oDefaultedSelectionVariant,selectionVariant:e.oSelectionVariant,requiresStandardVariant:!e.bNavSelVarHasDefaultsOnly,navigationType:n})};o.setRTAVersionWasActivated=function t(e,n){this.versionActivationStatus[e]=n};o.getRTAVersionWasActivated=function t(e){return this.versionActivationStatus[e]};i._checkIfLastSeenRecord=function t(e){const n=e&&e.getBindingContext("internal");if(n&&n.getProperty("fclColumnClosed")===true){const t=n.getProperty("technicalKeysOfLastSeenRecord");const a=e?.getBindingContext();const o=a&&a.getPath()||"";const i=a?.getModel().getMetaModel();const r=i?.getMetaPath(o);const s=i?.getObject(`${r}/$Type/$Key`);if(s){for(const e of s){const o=a.getObject()[e];if(o!==t[e]){n.setProperty("fclColumnClosed",false);return true}}}}return false};i._getAppStateData=function t(e,n,a){let o="",i=0;const r=a===h.hybrid?e.iAppState:e;if(r?.appState){for(i;i<Object.keys(r.appState).length;i++){if(Object.keys(r.appState)[i]===n){o=Object.keys(r.appState)[i];break}}}if(r?.appState){return{[Object.keys(r.appState)[i]]:r.appState[o]||{}}}};i.applyAppState=async function e(n,i){if(o.getRTAVersionWasActivated(this.oAppComponent.getId())){o.setRTAVersionWasActivated(this.oAppComponent.getId(),false);return Promise.resolve()}if(!this.oAppComponent.getEnvironmentCapabilities().getCapabilities().AppState||r.isLocked(this,n)){return Promise.resolve()}const s=this._checkIfLastSeenRecord(i);if(s===true){return Promise.resolve()}r.lock(this,n);r.lock(this);r.lock(this.oAppComponent.getRootControl());const p=this.oAppComponent.getNavigationService();return a(p.parseNavigation()).catch(function(e){if(!e){e=[]}t.warning("APPSTATE: Parse Navigation failed",e[0]);return[{},e[1],e[2]]}).then(async e=>{t.info("APPSTATE: Parse Navigation done");const a=e[0]||{},o=e[2]||h.initial,i=this.oAppComponent.getRootControl().getController();const r=this._getAppStateData(a,n,o);const s=a?.appState?.[A];this._mCurrentAppState=o===h.iAppState||o===h.hybrid?{...this._mCurrentAppState,...r}:{};let p=true;if(!i.viewState){throw new Error(`viewState extension required for controller ${i.getMetadata().getName()}`)}if(i.viewState._isStateEmptyForIAppStateNavType(a,o)){if(!i.viewState._getInitialStateApplied()){i.viewState._setInitialStateApplied()}p=false}const c=await i.viewState.applyViewState(this._mCurrentAppState,this._createNavigationParameters(a,o),s);if(!p){return{}}else{return c}}).catch(function(e){t.error("appState could not be applied",e);throw e}).finally(()=>{r.unlock(this,n);r.unlock(this);r.unlock(this.oAppComponent.getRootControl())})};i.checkIfRouteChangedByIApp=function t(){return this.bNoRouteChange};i.resetRouteChangedByIApp=function t(){if(this.bNoRouteChange){this.bNoRouteChange=false}};o.resetVersionActivationStatus=function t(){for(const t in this.versionActivationStatus){if(Object.prototype.hasOwnProperty.call(this.versionActivationStatus,t)){this.versionActivationStatus[t]=false}}};return o}(i),u.versionActivationStatus={},u))||c);return d},true);
//# sourceMappingURL=AppStateHandler.js.map