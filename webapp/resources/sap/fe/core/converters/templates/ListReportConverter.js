/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/base/BindingToolkit","sap/fe/core/converters/controls/Common/Action","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/helpers/ActionUtilities","sap/fe/core/helpers/StableIdHelper","../../helpers/TypeGuards","../ManifestSettings","../controls/Common/DataVisualization","../controls/Common/KPI","../helpers/ID"],function(t,e,n,i,a,o,r,s,l,c,u){"use strict";var f={};var d=u.getTableID;var p=u.getIconTabBarID;var y=u.getFilterVariantManagementID;var h=u.getFilterBarID;var m=u.getDynamicListReportID;var g=u.getCustomTabID;var v=u.getChartID;var C=c.getKPIDefinitions;var b=l.isSelectionPresentationCompliant;var T=l.isPresentationCompliant;var P=l.getSelectionVariant;var w=l.getSelectionPresentationVariant;var I=l.getDefaultLineItem;var S=l.getDefaultChart;var V=l.getDataVisualizationConfiguration;var E=s.VisualizationType;var M=s.VariantManagementType;var z=s.TemplateType;var D=r.isAnnotationOfType;var A=o.generate;var F=i.insertCustomElements;var L=n.showDraftEditStatus;var x=n.getSelectionFields;var k=n.getManifestFilterFields;var B=n.getFilterBarHideBasicSearch;var H=e.getActionsFromManifest;var R=t.getExpressionFromAnnotation;var O=t.compileExpression;var W=function(t){t["Multi"]="Multi";t["Combined"]="Combined";t["Custom"]="Custom";t["Default"]="Default";return t}(W||{});var $=function(t){t["SingleTable"]="SingleTable";t["SingleChart"]="SingleChart";t["Combined"]="Combined";t["Custom"]="Custom";return t}($||{});const U=function(t,e){return t.type===e};const j=function(t,e){return t.viewType===e};function N(t){const e=[];t.forEach(function(t){if(!j(t,$.Custom)){const n=j(t,$.Combined)?t.secondaryVisualization.visualizations:t.presentation.visualizations;n.forEach(function(t){if(t.type===E.Table){e.push(t)}})}});return e}function Q(t){const e=[];t.forEach(function(t){if(!j(t,$.Custom)){const n=j(t,$.Combined)?t.primaryVisualization.visualizations:t.presentation.visualizations;n.forEach(function(t){if(t.type===E.Chart){e.push(t)}})}});return e}const K=function(t){const e={};for(const n in t){if(t[n]?.settings?.defaultValues?.length){e[n]=t[n]?.settings?.defaultValues}}return e};function q(t,e,n){const i=e.getManifestWrapper().getDefaultTemplateAnnotationPath();const a=w(t,i,e);const o="ALP flavor needs both chart and table to load the application";if(a){if(i){const t=a.PresentationVariant;if(!t){throw new Error("Presentation Variant is not configured in the SPV mentioned in the manifest")}if(!T(t,n)){if(n){throw new Error(o)}return undefined}}if(b(a,n)===true){return a}else if(n){throw new Error(o)}}const r=t.annotations?.UI?.PresentationVariant;if(r){if(T(r,n)){return r}else if(n){throw new Error(o)}}if(!n){return I(t)}return undefined}const G=function(t,e,n){const i=X(t[0],true);const a=X(t[1]?t[1]:t[0],false);if(i&&a){const t={primaryVisualization:i,secondaryVisualization:a,tableControlId:a.visualizations[0]?.type===E.Table?a.visualizations[0].annotation?.id:"",chartControlId:i.visualizations[0]?.type===E.Chart?i.visualizations[0].id:"",defaultPath:e,viewType:$.Combined,visible:U(n,W.Multi)?n.visible:undefined};return t}};const J=function(t,e,n){const i=tt(e,E.Table)?.annotation.id;const a={presentation:e,title:et(t,n),selectionVariantPath:nt(n),visible:U(n,W.Multi)?n.visible:undefined};if(i){return{...a,...{tableControlId:i,viewType:$.SingleTable}}}return{...a,...{chartControlId:tt(e,E.Chart)?.id,viewType:$.SingleChart}}};const X=function(t,e){const n=Object.assign({},t);const i=t.visualizations.find(t=>!!e&&t.type===E.Chart||!e&&t.type===E.Table);if(i){n.visualizations=[i]}else{const t=e?{visualization:"Primary",type:"chart"}:{visualization:"Secondary",type:"table"};throw new Error(`${t.visualization} visualization needs valid ${t.type}`)}return n};const Y=function(t,e,n){const i=t.getEntityTypeAnnotation(e.annotationPath);const a=i.annotation;t=i.converterContext;const o=a;if(o||t.getTemplateType()===z.AnalyticalListPage){return V(o?t.getRelativeAnnotationPath(o.fullyQualifiedName,t.getEntityType()):"",t,{isCondensedTableLayoutCompliant:true,shouldCreateTemplateChartVisualization:true})}else{throw new Error(`Annotation Path for the ${n?"primary":"secondary"} visualization mentioned in the manifest is not found`)}};const Z=function(t,e){for(const n of t.visualizations){switch(n.type){case E.Table:const t=n.control.filters||{};t.hiddenFilters=t.hiddenFilters||{paths:[]};if(!e.keepPreviousPersonalization){n.annotation.id=d(e.key??"","LineItem");n.annotation.apiId=A([n.annotation.id,"Table"])}break;case E.Chart:n.id=v(e.key||"","Chart");n.multiViews=true;break;default:break}}};const _=function(t){return{title:t.label,fragment:t.template,type:t.type,customTabId:g(t.key??""),visible:t.visible,viewType:$.Custom}};const tt=function(t,e){return t.visualizations.find(t=>t.type===e)};const et=function(t,e){if(U(e,W.Multi)){const n=t.getEntityTypeAnnotation(e.annotationPath).annotation;return O(R(n.Text))}return""};const nt=function(t){if(U(t,W.Multi)){return t.annotation&&D(t.annotation,"com.sap.vocabularies.UI.v1.SelectionPresentationVariantType")?`@${t.annotation.SelectionVariant?.fullyQualifiedName.split("@")[1]}`:t.annotationPath}return undefined};const it=function(t){if(!U(t,W.Custom)){return!U(t,W.Combined)&&t.annotation?t.converterContext.getRelativeAnnotationPath(t.annotation.fullyQualifiedName,t.converterContext.getEntityType()):""}return""};const at=function(t){if(!U(t,W.Custom)){const e=t.converterContext;const n=U(t,W.Multi)?{associatedSelectionVariant:t.selectionVariant,isMacroOrMultipleView:true}:{};const i=V(it(t),e,{...{isCondensedTableLayoutCompliant:true},...n});if(!U(t,W.Combined)&&i.visualizations.length===2&&e.getTemplateType()===z.AnalyticalListPage){const e=G([i],"both",t);if(e){return e}}else if(U(t,W.Combined)){const{primary:n,secondary:i}=t;if(n?.length&&i?.length){const a=G([Y(e,n[0],true),Y(e,i[0],false)],t.defaultPath,t);if(a){return a}}else if(e.getTemplateType()===z.AnalyticalListPage){throw new Error("SecondaryItems in the Views is not present")}}else if(U(t,W.Multi)){Z(i,t)}const a=J(e,i,t);a.presentation.inMultiView=!!n.isMacroOrMultipleView;return a}else{return _(t)}};const ot=function(t,e){let n=[];const i=t.getManifestWrapper();if(e){e.paths.forEach(a=>{if(i.isCombinedViewConfiguration(a)){if(e.paths.length>1){throw new Error("ALP flavor cannot have multiple views")}else{n.push({converterContext:t,primary:a.primary,secondary:a.secondary,defaultPath:a.defaultPath,type:W.Combined})}}else if(i.isCustomViewConfiguration(a)){n.push({key:a.key,label:a.label,template:a.template,type:W.Custom,visible:a.visible})}else{const e=t.getConverterContextFor(a.contextPath||a.entitySet&&`/${a.entitySet}`||t.getContextPath()),i=e.getEntityType();if(i&&e){let t;const o=e.getEntityTypeAnnotation(a.annotationPath);const r=o.annotation;if(r){t=r.term==="com.sap.vocabularies.UI.v1.SelectionVariant"?q(i,e,false):r;n.push({selectionVariant:r.term==="com.sap.vocabularies.UI.v1.SelectionVariant"?r:undefined,converterContext:e,annotation:t,annotationPath:a.annotationPath,keepPreviousPersonalization:a.keepPreviousPersonalization,key:a.key,visible:a.visible,type:W.Multi})}}else{}}})}else{const e=t.getEntityType();if(t.getTemplateType()===z.AnalyticalListPage){n=st(t,n)}else{n.push({annotation:q(e,t,false),converterContext:t,type:W.Default})}}return n.map(t=>at(t))};const rt=function(t,e){const n=t.getManifestWrapper();const i=n.getViewConfiguration();if(e.length>1&&!lt(t)){return{showTabCounts:i?i.showCounts??n.hasMultipleEntitySets():undefined,id:p()}}return undefined};function st(t,e){const n=t.getEntityType();const i=q(n,t,true);let a,o;if(i){e.push({annotation:i,converterContext:t,type:W.Default})}else{a=S(n);o=I(n);if(a&&o){const n=[{annotationPath:"@"+a.term}];const i=[{annotationPath:"@"+o.term}];e.push({converterContext:t,primary:n,secondary:i,defaultPath:"both",type:W.Combined})}else{throw new Error("ALP flavor needs both chart and table to load the application")}}return e}function lt(t){return t.getManifestWrapper().hasMultipleVisualizations()||t.getTemplateType()===z.AnalyticalListPage}const ct=function(t){const e=t.getManifestWrapper();const n=F([],H(e.getHeaderActions(),t).actions);return a.ensurePrimaryActionNeverOverflows(n)};f.getHeaderActions=ct;const ut=function(t,e){t.forEach(t=>{if(!j(t,$.Custom)&&!j(t,$.Combined)){t.presentation.visualizations.forEach(t=>{if(t.type===E.Chart&&t.filterId!==e){t.filterId=e}})}})};const ft=function(t,e){const n=t.getEntityType();const i=t.getContextPath();if(!i){throw new Error("An EntitySet is required to be able to display a ListReport, please adjust your `entitySet` property to point to one.")}const a=t.getManifestWrapper();const o=a.getViewConfiguration();const r=a.hasMultipleEntitySets();const s=ot(t,o);const l=N(s);const c=Q(s);const u=l.some(t=>t.control.type==="ResponsiveTable");let f="";let d="";const p=m();const g=h(i);const v=y(g);const b=a.getFilterConfiguration();const T=b?.initialLayout!==undefined?b?.initialLayout.toLowerCase():"compact";const w=b?.layout!==undefined?b?.layout.toLowerCase():"compact";const I=b.useSemanticDateRange!==undefined?b.useSemanticDateRange:true;const S=b.showClearButton!==undefined?b.showClearButton:false;const V=dt(s);if(V){d=V.chartId;f=V.tableId}const E=a.useHiddenFilterBar();const z=(a.isFilterBarHidden()||E)&&d==="";const D=x(t,l);const A=D.selectionFields;const F=D.sPropertyInfo;const H=B(l,c,t);const R=rt(t,s);const O=R?undefined:P(n,t);const W=I?K(k(n,t)):{};const $=ct(t);if(r){ut(s,g)}const U=l.map(t=>t.annotation.apiId).concat(c.map(t=>t.apiId));const j=[...z&&!E?[]:[g],...a.getVariantManagement()!==M.Control?U:[],...R?[R.id]:[]];const q=R&&a.getStickyMultiTabHeaderConfiguration()?R.id:undefined;const G=e?.HiddenDraft?.enabled||l.every(t=>t.control.type==="TreeTable"||t.enableAnalytics||t.annotation.collection!==i);return{mainEntitySet:i,mainEntityType:`${i}/`,multiViewsControl:R,stickySubheaderProvider:q,singleTableId:f,singleChartId:d,dynamicListReportId:p,headerActions:$,easyFilterEnabled:!z&&e?.MagicFiltering,showPinnableToggle:u,filterBar:{propertyInfo:F,selectionFields:A,hideBasicSearch:H,showClearButton:S,disableDraftEditStateFilter:G,showDraftEditStatus:L(t)},views:s,filterBarId:z&&!E?"":g,filterConditions:{selectionVariant:O,defaultSemanticDates:W},variantManagement:{id:v,targetControlIds:j.join(",")},hasMultiVisualizations:lt(t),templateType:a.getTemplateType(),useSemanticDateRange:I,filterInitialLayout:T,filterLayout:w,kpiDefinitions:C(t),hideFilterBar:z,useHiddenFilterBar:E,collapsedHeaderFragment:a.getCollapsedHeaderFragment(),expandedHeaderFragment:a.getExpandedHeaderFragment()}};f.convertPage=ft;function dt(t){const e=t.find(t=>(j(t,$.Combined)||j(t,$.SingleTable))&&!!t.tableControlId)?.tableControlId??"",n=t.find(t=>(j(t,$.Combined)||j(t,$.SingleChart))&&!!t.chartControlId)?.chartControlId??"";if(e||n){return{chartId:n,tableId:e}}return undefined}return f},false);
//# sourceMappingURL=ListReportConverter.js.map