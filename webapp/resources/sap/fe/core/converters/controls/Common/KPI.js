/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/helpers/IssueManager","sap/fe/core/converters/helpers/SelectionVariantHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/PropertyHelper","sap/ui/core/message/MessageType","../../helpers/Aggregation","../../helpers/ID","./Criticality"],function(e,t,a,i,n,r,o,l,c){"use strict";var s={};var u=c.getMessageTypeFromCriticalityType;var d=l.getKPIID;var p=o.AggregationHelper;var f=n.getAssociatedTextPropertyPath;var g=i.enhanceDataModelPath;var y=a.isPathAnnotationExpression;var C=a.isAnnotationOfType;var h=a.isAnnotationOfTerm;var T=t.getFilterDefinitionsFromSelectionVariant;var m=e.IssueType;var v=e.IssueSeverity;var I=e.IssueCategory;const D={"UI.TrendType/StrongUp":"Up","UI.TrendType/Up":"Up","UI.TrendType/StrongDown":"Down","UI.TrendType/Down":"Down","UI.TrendType/Sideways":"None"};const S={"UI.ChartType/ColumnStacked":"StackedColumn","UI.ChartType/BarStacked":"StackedBar","UI.ChartType/Donut":"Donut","UI.ChartType/Line":"Line","UI.ChartType/Bubble":"bubble","UI.ChartType/Column":"column","UI.ChartType/Bar":"bar","UI.ChartType/VerticalBullet":"vertical_bullet","UI.ChartType/Combination":"combination","UI.ChartType/Scatter":"scatter"};function b(e,t,a){if(e.Measures===undefined){return undefined}const i=e.Dimensions?e.Dimensions.map(t=>{const i=e.DimensionAttributes?.find(e=>e.Dimension?.value===t.value);const n={name:t.value,label:t.$target?.annotations.Common?.Label?.toString()||t.value,role:i?.Role?.replace("UI.ChartDimensionRoleType/","")};const r=g(a.getDataModelObjectPath(),t.value).targetObject;if(r?.annotations.Common?.Text){n.text=f(r);n.textArrangement=r.annotations.Common.Text.annotations?.UI?.TextArrangement?.toString().replace("UI.TextArrangementType/","")??"TextFirst"}return n}):[];const n=e.Measures.map(t=>{const a=e.MeasureAttributes?.find(e=>e.Measure?.value===t.value);return{name:t.value,label:t.$target?.annotations.Common?.Label?.toString()||t.value,role:a?.Role?.replace("UI.ChartMeasureRoleType/","")}});const r={chartType:S[e.ChartType]||"Line",dimensions:i,measures:n,sortOrder:t?.SortOrder?.map(e=>({name:e.Property?.value||"",descending:!!e.Descending})),maxItems:t?.MaxItems?.valueOf()};const o=e.Title?.valueOf();if(o!==undefined){r.title=o}return r}function V(e,t){const a=e.Value.$target;if(a.annotations.Measures?.ISOCurrency){const e=a.annotations.Measures?.ISOCurrency;if(y(e)){t.datapoint.unit={value:e.$target.name,isCurrency:true,isPath:true}}else{t.datapoint.unit={value:e.toString(),isCurrency:true,isPath:false}}}else if(a.annotations.Measures?.Unit){const e=a.annotations.Measures?.Unit;if(y(e)){t.datapoint.unit={value:e.$target.name,isCurrency:false,isPath:true}}else{t.datapoint.unit={value:e.toString(),isCurrency:false,isPath:false}}}}function P(e,t,a){if(e.Criticality){if(y(e.Criticality)){const i=e.Criticality.$target;if(i&&t.isPropertyAggregatable(i)){a.datapoint.criticalityPath=e.Criticality.path}else{a.datapoint.criticalityValue=r.None}}else{a.datapoint.criticalityValue=u(e.Criticality)}}else if(e.CriticalityCalculation){a.datapoint.criticalityCalculationMode=e.CriticalityCalculation.ImprovementDirection;a.datapoint.criticalityCalculationThresholds=[];switch(a.datapoint.criticalityCalculationMode){case"UI.ImprovementDirectionType/Target":a.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.DeviationRangeLowValue);a.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.ToleranceRangeLowValue);a.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.AcceptanceRangeLowValue);a.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.AcceptanceRangeHighValue);a.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.ToleranceRangeHighValue);a.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.DeviationRangeHighValue);break;case"UI.ImprovementDirectionType/Minimize":a.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.AcceptanceRangeHighValue);a.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.ToleranceRangeHighValue);a.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.DeviationRangeHighValue);break;case"UI.ImprovementDirectionType/Maximize":default:a.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.DeviationRangeLowValue);a.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.ToleranceRangeLowValue);a.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.AcceptanceRangeLowValue)}}else{a.datapoint.criticalityValue=r.None}}function U(e,t,a){if(e.Trend){if(y(e.Trend)){const i=e.Trend.$target;if(i&&t.isPropertyAggregatable(i)){a.datapoint.trendPath=e.Trend.path}else{a.datapoint.trendValue="None"}}else{a.datapoint.trendValue=D[e.Trend]||"None"}}else if(e.TrendCalculation){a.datapoint.trendCalculationIsRelative=e.TrendCalculation.IsRelativeDifference?true:false;if(e.TrendCalculation.ReferenceValue.$target){const i=e.TrendCalculation.ReferenceValue.$target;if(t.isPropertyAggregatable(i)){a.datapoint.trendCalculationReferencePath=e.TrendCalculation.ReferenceValue.path}else{a.datapoint.trendValue="None"}}else{a.datapoint.trendCalculationReferenceValue=e.TrendCalculation.ReferenceValue}if(a.datapoint.trendCalculationReferencePath!==undefined||a.datapoint.trendCalculationReferenceValue!==undefined){a.datapoint.trendCalculationTresholds=[e.TrendCalculation.StrongDownDifference.valueOf(),e.TrendCalculation.DownDifference.valueOf(),e.TrendCalculation.UpDifference.valueOf(),e.TrendCalculation.StrongUpDifference.valueOf()]}}else{a.datapoint.trendValue="None"}}function A(e,t,a){if(e.TargetValue){if(e.TargetValue.$target){const i=e.TargetValue.$target;if(t.isPropertyAggregatable(i)){a.datapoint.targetPath=e.TargetValue.path}}else{a.datapoint.targetValue=e.TargetValue}}}function O(e){const t=e.annotations["Common"]||{};let a;Object.keys(t).forEach(e=>{const i=t[e];if(h(i,"com.sap.vocabularies.Common.v1.SemanticObject")){if(!i.qualifier||!a){a=i}}});if(a){const e={semanticObject:a.toString(),unavailableActions:[]};const i=Object.keys(t).find(e=>{const i=t[e];return h(i,"com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions")&&i.qualifier===a?.qualifier});if(i){e.unavailableActions=t[i]}return e}else{return undefined}}function R(e){return!!e.template}function M(e,t,a){let i="";if(t.contextPath){i=t.contextPath}else if(t.entitySet){i=`/${t.entitySet}`}const n=e.getConverterContextFor(i);const r=new p(n.getEntityType(),n);if(!r.isAnalyticsSupported()){e.getDiagnostics().addIssue(I.Annotation,v.Medium,m.KPI_ISSUES.NO_ANALYTICS+i);return undefined}let o;let l;let c;let s;let u;const f=n.getAnnotationsByTerm("UI","com.sap.vocabularies.UI.v1.KPI");const g=f.find(e=>e.qualifier===t.qualifier);if(g){l=g.DataPoint;o=g.SelectionVariant;c=g.Detail?.DefaultPresentationVariant;s=c?.Visualizations?.find(e=>C(e.$target,"com.sap.vocabularies.UI.v1.ChartDefinitionType"))?.$target;if(g.Detail?.SemanticObject){u={semanticObject:g.Detail.SemanticObject.toString(),action:g.Detail.Action?.toString(),unavailableActions:[]}}}else{const a=n.getAnnotationsByTerm("UI","com.sap.vocabularies.UI.v1.SelectionPresentationVariant");const i=a.find(e=>e.qualifier===t.qualifier);if(i){o=i.SelectionVariant;c=i.PresentationVariant;l=c?.Visualizations?.find(e=>C(e.$target,"com.sap.vocabularies.UI.v1.DataPointType"))?.$target;s=c?.Visualizations?.find(e=>C(e.$target,"com.sap.vocabularies.UI.v1.ChartDefinitionType"))?.$target}else{e.getDiagnostics().addIssue(I.Annotation,v.Medium,m.KPI_ISSUES.KPI_NOT_FOUND+t.qualifier);return undefined}}if(!c||!l||!s){e.getDiagnostics().addIssue(I.Annotation,v.Medium,m.KPI_ISSUES.KPI_DETAIL_NOT_FOUND+t.qualifier);return undefined}const y=l.Value.$target;if(!r.isPropertyAggregatable(y)){e.getDiagnostics().addIssue(I.Annotation,v.Medium,m.KPI_ISSUES.MAIN_PROPERTY_NOT_AGGREGATABLE+t.qualifier);return undefined}const h=b(s,c,e);if(!h){return undefined}const D={type:"Analytical",id:"kpiTag-"+d(a),contextPath:i,datapoint:{propertyPath:l.Value.path,annotationPath:n.getEntitySetBasedAnnotationPath(l.fullyQualifiedName),title:l.Title?.toString(),description:l.Description?.toString()},selectionVariantFilterDefinitions:o?T(o):undefined,chart:h};if(l.ValueFormat?.NumberOfFractionalDigits!==undefined){D.datapoint.numberOfFractionalDigits=l.ValueFormat.NumberOfFractionalDigits.valueOf()}if(!u){if(t.detailNavigation){u={outboundNavigation:t.detailNavigation}}else{u=O(y)}}if(u){D.navigation=u}V(l,D);P(l,r,D);U(l,r,D);A(l,r,D);return D}function N(e,t,a){if(R(t)){return{type:"Custom",key:e,template:t.template}}else{return M(a,t,e)}}function $(e){const t=e.getManifestWrapper().getKPIConfiguration(),a=[];Object.keys(t).forEach(i=>{const n=N(i,t[i],e);if(n){a.push(n)}});return a}s.getKPIDefinitions=$;return s},false);
//# sourceMappingURL=KPI.js.map