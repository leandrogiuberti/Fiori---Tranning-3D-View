/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/base/BindingToolkit","sap/fe/core/converters/helpers/Aggregation","sap/fe/core/converters/helpers/IssueManager","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/FilterTemplating"],function(t,e,a,n,o,i){"use strict";var r={};var s=i.isPropertyFilterable;var l=i.getIsRequired;var u=o.checkFilterExpressionRestrictions;var c=n.isEntitySet;var g=a.IssueType;var f=a.IssueSeverity;var p=a.IssueCategory;var P=e.AggregationHelper;var y=t.not;var v=t.compileExpression;const m=function(t,e,a){let n,o,i;let r;const s=a.getCustomAggregateDefinitions();let l=a.getTransAggregations();let u=[];if(e?.$target?.Measures){u=s.filter(function(t){return t.qualifier===e?.$target?.Measures?.[0]?.value});r=u.length>0?u[0].qualifier:e?.$target?.Measures?.[0]?.value}if(!u[0]&&e?.$target?.DynamicMeasures){r=t.getConverterContextFor(t.getAbsoluteAnnotationPath(e.$target.DynamicMeasures?.[0]?.value)).getDataModelObjectPath().targetObject?.Name.toString();l=a.getAggregatedProperty()}else{l=a.getAggregatedProperties()[0]}const c=e?.$target?.Dimensions[0]?.value;if(s.some(function(t){return t.qualifier===r})){n=r;i=true}else if(l&&l[0]){l.some(function(t){if(t.Name===r){n=t?.AggregatableProperty.value}})}if(!i){const t=a.getAggregatableProperties();if(t&&t.length){for(const e of t){if(e?.Property?.value===n){i=true}}}}const g=a.getGroupableProperties();if(g&&g.length){for(const t of g){if(t?.value===c){o=true}}}return i&&o};function h(t,e,a,n){let o;const i=n[a];if(i?.visualFilter?.valueList){const n=i?.visualFilter?.valueList;const r=n.split("#");const h=r.length>1?`ValueList#${r[1]}`:r[0];const A=t.resolvePath(a);const L=A?.annotations?.Common?.[h];const C=A?.annotations?.Common?.ValueListWithFixedValues?.valueOf()||false;if(L){const t=L?.CollectionPath.toString();const n=e.getConverterContextFor(`/${t||e.getEntitySet()?.name}`);const i=L?.Parameters;let r;const h=[];let A=[];const I=n.getParameterEntityType();A=I?I.keys.map(function(t){return t.name}):[];if(e.getContextPath()===n.getContextPath()){d(h,A,true)}if(i){for(const t of i){const e=t.LocalDataProperty?.value;const o=t.ValueListProperty;if((t?.$Type==="com.sap.vocabularies.Common.v1.ValueListParameterInOut"||t?.$Type==="com.sap.vocabularies.Common.v1.ValueListParameterOut")&&a===e){r=t}if((t?.$Type==="com.sap.vocabularies.Common.v1.ValueListParameterInOut"||t?.$Type==="com.sap.vocabularies.Common.v1.ValueListParameterIn")&&a!==e){const t=s(n,o);if(!t){h.push({localDataProperty:e,valueListProperty:o})}}}}if(h&&h.length){h.forEach(function(t){const o=v(u(e.getConverterContextFor(e.getAbsoluteAnnotationPath(t?.localDataProperty)).getDataModelObjectPath(),["SingleValue"]));const i=v(u(n.getConverterContextFor(n.getAbsoluteAnnotationPath(t?.valueListProperty)).getDataModelObjectPath(),["SingleValue"]));if(i==="true"&&o==="false"){throw new Error(`FilterRestrictions of ${a} in MainEntitySet and ValueListEntitySet are different`)}})}const E=L?.PresentationVariantQualifier;const S=L?.SelectionVariantQualifier;const D=n?.getEntityType().annotations.UI?.[`PresentationVariant#${E}`];const V=new P(n.getEntityType(),n);if(!V.isAnalyticsSupported()){return undefined}if(D){const i=D?.Visualizations;const s=`/${L?.CollectionPath}`||`/${n?.getEntitySet()?.name}`;o={};o.contextPath=s;o.isValueListWithFixedValues=C;let P;for(const t of i){if(t.$target?.term==="com.sap.vocabularies.UI.v1.Chart"){P=t;break}}if(P){const s=m(n,P,V);if(!s){return}const L=P?.$target?.Dimensions[0]?.$target?.annotations?.UI?.Hidden?.valueOf();const C=P?.$target?.Dimensions[0]?.$target?.annotations?.UI?.HiddenFilter?.valueOf();if(L===true||C===true){return}else if(i&&i.length){o.chartAnnotation=P.$target?n?.getAbsoluteAnnotationPath(`${P.$target.fullyQualifiedName}/$AnnotationPath/`):undefined;const i=n.getEntitySet()?.name;let s;const m=n?.getRelativeAnnotationPath(`${D.fullyQualifiedName}/`,n.getEntityType());if(I){s=n.getContextPath()+"/"+m}else{s="/"+i+"/"+m}o.presentationAnnotation=D?s:undefined;o.outParameter=r?.LocalDataProperty?.value;o.inParameters=h;o.valuelistProperty=r?.ValueListProperty;const L=u(e.getConverterContextFor(e.getAbsoluteAnnotationPath(a)).getDataModelObjectPath(),["SingleRange","MultiRange"]);if(v(L)==="true"){e.getDiagnostics().addIssue(p.Annotation,f.High,g.MALFORMED_VISUALFILTERS.VALUELIST);return undefined}const C=u(e.getConverterContextFor(e.getAbsoluteAnnotationPath(a)).getDataModelObjectPath(),["SingleValue"]);o.multipleSelectionAllowed=v(y(C));o.required=l(e,a);let E;if(S){E=n?.getEntityTypeAnnotation(`@UI.SelectionVariant#${S}`)?.annotation;let t;const e=n?.getRelativeAnnotationPath(`${E?.fullyQualifiedName}/`,n.getEntityType());if(I){t=n.getContextPath()+"/"+e}else{t="/"+i+"/"+e}o.selectionVariantAnnotation=E?t:undefined}let V=[];if(I){const a=t.split("/")[0];const n=t.split("/")[1];const o=e.getConverterContextFor(`/${a}`);const i=o?.getDataModelObjectPath().startingEntitySet?.annotations?.Capabilities?.NavigationRestrictions?.RestrictedProperties;const r=i?.find(t=>{if(t.NavigationProperty?.type==="NavigationPropertyPath"){return t.NavigationProperty.value===n}});V=r?.FilterRestrictions?.RequiredProperties??[]}else{const t=n?.getEntitySet();if(c(t)){V=t.annotations.Capabilities?.FilterRestrictions?.RequiredProperties??[]}}let $=[];if(V?.length){V.forEach(function(t){$.push(t.value)})}$=$.concat(A);o.requiredProperties=$;if(e.getContextPath()===n.getContextPath()){d(h,V,false)}if(o.requiredProperties?.length){if(!o.inParameters||!o.inParameters.length){if(!o.selectionVariantAnnotation){o.showOverlayInitially=true}else{let t=E?.SelectOptions?.reduce((t,e)=>{if(e.PropertyName?.value){t.push(e.PropertyName.value)}return t},[])??[];const e=E?.Parameters?.map(t=>t.PropertyName?.value)||[];t=t.concat(e);$=$.sort((t,e)=>t.localeCompare(e));t=t.sort((t,e)=>t.localeCompare(e));o.showOverlayInitially=$.some(function(e){return!t.includes(e)})}}else{o.showOverlayInitially=false}}else{o.showOverlayInitially=false}const T=P?.$target?.Dimensions[0]?.$target?.type;o.renderLineChart=T==="Edm.DateTimeOffset"||T==="Edm.Date"||T==="Edm.TimeOfDay"||P.$target?.ChartType!=="UI.ChartType/Line"}}else{e.getDiagnostics().addIssue(p.Annotation,f.High,g.MALFORMED_VISUALFILTERS.CHART);return}}else{e.getDiagnostics().addIssue(p.Annotation,f.High,g.MALFORMED_VISUALFILTERS.PRESENTATIONVARIANT)}}else{e.getDiagnostics().addIssue(p.Annotation,f.High,g.MALFORMED_VISUALFILTERS.VALUELIST)}}else{e.getDiagnostics().addIssue(p.Manifest,f.High,g.MALFORMED_VISUALFILTERS.VALUELIST)}return o}r.getVisualFilters=h;function d(t,e,a){e.forEach(function(e){const n=a?e:e.value;t.push({localDataProperty:n,valueListProperty:n})})}r._addInParameters=d;return r},false);
//# sourceMappingURL=VisualFilters.js.map