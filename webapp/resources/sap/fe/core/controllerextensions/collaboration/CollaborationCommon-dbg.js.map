{"version":3,"names":["UserStatus","_exports","UserEditingState","Activity","formatInitials","fullName","academicTitles","forEach","academicTitle","replace","initials","parts","trimStart","split","length","shift","charAt","pop","substring","toUpperCase","getUserColor","UserID","activeUsers","invitedUsers","user","find","u","id","color","i","findIndex","getAppComponent","oControl","isA","oOwner","Component","getOwnerComponentFor","getMe","appComponent","shellServiceHelper","getShellServices","name","hasUShell","getUserInitials","getUser","getId","getFullName","window","adt","userID","userName","getText","initialName","me","status","CurrentlyEditing","textId","oResourceModel","Library","getResourceBundleFor","_len","arguments","args","Array","_key","CollaborationUtils","addSelf","context","model","getModel","metaModel","getMetaModel","entitySet","getMetaPath","getPath","shareActionName","getObject","shareAction","bindContext","setParameter","invoke","undefined","shareObject","bindingContext","users","groupId","getActivityKeyFromPath","path","lastIndexOf","CollaborationFieldGroupPrefix"],"sourceRoot":".","sources":["CollaborationCommon.ts"],"sourcesContent":["import type AppComponent from \"sap/fe/core/AppComponent\";\nimport Component from \"sap/ui/core/Component\";\n\nimport type Control from \"sap/ui/core/Control\";\nimport Library from \"sap/ui/core/Lib\";\nimport type Context from \"sap/ui/model/odata/v4/Context\";\n\n// ADT Preview provides the user name and id for collaboration draft\ndeclare global {\n\tinterface Window {\n\t\tadt: {\n\t\t\tuserName: string;\n\t\t\tuserID: string;\n\t\t};\n\t}\n}\n\nexport enum UserStatus {\n\tNotYetInvited = 0,\n\tNoChangesMade = 1,\n\tChangesMade = 2,\n\tCurrentlyEditing = 3\n}\n\nexport enum UserEditingState {\n\tNoChanges = \"N\",\n\tInProgress = \"P\"\n}\n\nexport type User = {\n\tid: string;\n\tinitials?: string;\n\tname: string;\n\tcolor?: string;\n\ttransient?: boolean;\n\tstatus?: UserStatus;\n\tme?: boolean;\n\tinitialName?: string;\n};\n\n// backend representation of a user according to collaboration draft spec\nexport type BackendUser = {\n\tUserID: string;\n\tUserAccessRole: string;\n\tUserEditingState?: UserEditingState;\n\tUserDescription?: string;\n};\n\nexport type UserActivity = User & {\n\tkey?: string;\n};\n\nexport enum Activity {\n\tJoin = \"JOIN\",\n\tJoinEcho = \"JOINECHO\",\n\tLeave = \"LEAVE\",\n\tChange = \"CHANGE\",\n\tCreate = \"CREATE\",\n\tDelete = \"DELETE\",\n\tAction = \"ACTION\",\n\tLock = \"LOCK\",\n\tLockEcho = \"LOCKECHO\",\n\tActivate = \"ACTIVATE\",\n\tDiscard = \"DISCARD\",\n\tUnlock = \"UNLOCK\"\n}\n\nexport type Message = {\n\tuserDescription: string;\n\tuserID: string;\n\tuserAction: string;\n\tclientAction: string;\n\tclientTriggeredActionName?: string;\n\tclientRefreshListBinding?: string;\n\tclientRequestedProperties?: string;\n\tclientContent: string;\n};\n\nfunction formatInitials(fullName: string): string {\n\t// remove titles - those are the ones from S/4 to be checked if there are others\n\tconst academicTitles = [\"Dr.\", \"Prof.\", \"Prof. Dr.\", \"B.A.\", \"MBA\", \"Ph.D.\"];\n\tacademicTitles.forEach(function (academicTitle) {\n\t\tfullName = fullName.replace(academicTitle, \"\");\n\t});\n\n\tlet initials: string;\n\tconst parts = fullName.trimStart().split(\" \");\n\n\tif (parts.length > 1) {\n\t\tinitials = (parts?.shift()?.charAt(0) || \"\") + parts.pop()?.charAt(0);\n\t} else {\n\t\tinitials = fullName.substring(0, 2);\n\t}\n\n\treturn initials.toUpperCase();\n}\n\nfunction getUserColor(UserID: string, activeUsers: User[], invitedUsers: User[]): string | undefined {\n\t// search if user is known\n\tconst user = activeUsers.find((u) => u.id === UserID);\n\tif (user) {\n\t\treturn user.color;\n\t} else {\n\t\t// search for next free color\n\t\tfor (let i = 1; i <= 10; i++) {\n\t\t\tif (\n\t\t\t\tactiveUsers.findIndex((u) => u.color === `Accent${i}`) === -1 &&\n\t\t\t\tinvitedUsers.findIndex((u) => u.color === `Accent${i}`) === -1\n\t\t\t) {\n\t\t\t\treturn `Accent${i}`;\n\t\t\t}\n\t\t}\n\t\t// this seems to be a popular object :) for now just return 10 for all.\n\t\t// for invited we should start from 1 again so the colors are different\n\t\treturn \"Accent10\";\n\t}\n}\n\n// copied from CommonUtils. Due to a cycle dependency I can't use CommonUtils here.\n// That's to be fixed. the discard popover thingy shouldn't be in the common utils at all\nfunction getAppComponent(oControl: Control | Component): AppComponent {\n\tif (oControl.isA<AppComponent>(\"sap.fe.core.AppComponent\")) {\n\t\treturn oControl;\n\t}\n\tconst oOwner = Component.getOwnerComponentFor(oControl);\n\tif (!oOwner) {\n\t\treturn oControl as AppComponent;\n\t} else {\n\t\treturn getAppComponent(oOwner);\n\t}\n}\n\nfunction getMe(appComponent: AppComponent): User {\n\tconst shellServiceHelper = appComponent.getShellServices();\n\tlet initials, id, name;\n\tif (shellServiceHelper?.hasUShell()) {\n\t\tinitials = shellServiceHelper.getUserInitials();\n\t\tid = shellServiceHelper.getUser().getId();\n\t\tname = shellServiceHelper.getUser().getFullName();\n\t} else if (window.adt) {\n\t\t// check if we are in ADT preview, if so use the user provided by ADT\n\t\tid = window.adt.userID;\n\t\tname = window.adt.userName;\n\t\tinitials = formatInitials(name);\n\t} else {\n\t\tthrow \"No Shell... No User\";\n\t}\n\n\treturn {\n\t\tinitials: initials,\n\t\tid: id,\n\t\tname: getText(\"C_COLLABORATIONDRAFT_ME\", name),\n\t\tinitialName: name,\n\t\tcolor: \"Accent6\", //  same color as FLP...\n\t\tme: true,\n\t\tstatus: UserStatus.CurrentlyEditing\n\t};\n}\n\nexport function getText(textId: string, ...args: string[]): string {\n\tconst oResourceModel = Library.getResourceBundleFor(\"sap.fe.core\")!;\n\treturn oResourceModel.getText(textId, args);\n}\n\nexport const CollaborationUtils = {\n\tformatInitials: formatInitials,\n\tgetUserColor: getUserColor,\n\tgetMe: getMe,\n\tgetAppComponent: getAppComponent,\n\tgetText: getText\n};\n\nexport async function addSelf(context: Context): Promise<Context> {\n\tconst model = context.getModel();\n\tconst metaModel = model.getMetaModel();\n\tconst entitySet = metaModel.getMetaPath(context.getPath());\n\tconst shareActionName = metaModel.getObject(`${entitySet}@com.sap.vocabularies.Common.v1.DraftRoot/ShareAction`);\n\tconst shareAction = model.bindContext(`${shareActionName}(...)`, context);\n\tshareAction.setParameter(\"Users\", []);\n\tshareAction.setParameter(\"ShareAll\", true);\n\tshareAction.setParameter(\"IsDeltaUpdate\", true);\n\tshareAction.setParameter(\"If-Match\", \"*\");\n\treturn shareAction.invoke(undefined, true);\n}\n\nexport async function shareObject(bindingContext: Context, users: BackendUser[] = [], groupId = \"$auto.Workers\"): Promise<Context> {\n\tconst model = bindingContext.getModel();\n\tconst metaModel = model.getMetaModel();\n\tconst entitySet = metaModel.getMetaPath(bindingContext.getPath());\n\tconst shareActionName = metaModel.getObject(`${entitySet}@com.sap.vocabularies.Common.v1.DraftRoot/ShareAction`);\n\tconst shareAction = model.bindContext(`${shareActionName}(...)`, bindingContext);\n\tshareAction.setParameter(\"Users\", users);\n\tshareAction.setParameter(\"ShareAll\", true);\n\treturn shareAction.invoke(groupId, true);\n}\n\nexport function getActivityKeyFromPath(path: string): string {\n\treturn path.substring(path.lastIndexOf(\"(\") + 1, path.lastIndexOf(\")\"));\n}\n\nexport const CollaborationFieldGroupPrefix = \"_CollaborationDraft_\";\n"],"mappings":"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","ignoreList":[],"file":"CollaborationCommon-dbg.js"}