{"version":3,"file":"ActivityBase.js","names":["COLLABORATION","CONNECTION","CURRENTDRAFTID","WEBSOCKETSTATUS","isCollaborationConnected","internalModel","getProperty","WEBSOCKET_STATUS","CONNECTED","_exports","initializeCollaboration","user","draftUUID","receiveCallback","view","sendUserInfo","arguments","length","undefined","endCollaboration","activeUsers","setProperty","activities","additionalParameters","draft","URLSearchParams","window","location","search","get","id","initialName","webSocket","createWebSocket","ChannelType","CollaborationDraft","getModel","CONNECTING","attachMessage","event","message","getParameter","attachOpen","showConnectionLostDialog","resourceModel","getResourceModel","lostOfConnectionText","getText","MessageBox","warning","actions","Action","OK","emphasizedAction","attachError","includes","ERROR","attachClose","evt","CLOSED","broadcastCollaborationMessage","action","content","triggeredActionName","refreshListBinding","requestedProperties","send","clientAction","clientContent","clientTriggeredActionName","clientRefreshListBinding","clientRequestedProperties","Activity","Activate","Discard","CLOSING","close"],"sources":["./ActivityBase.ts"],"sourcesContent":["import type { FEView } from \"sap/fe/core/BaseController\";\nimport type { Message, User } from \"sap/fe/core/controllerextensions/collaboration/CollaborationCommon\";\nimport { Activity } from \"sap/fe/core/controllerextensions/collaboration/CollaborationCommon\";\nimport { getResourceModel } from \"sap/fe/core/helpers/ResourceModelHelper\";\nimport type { WebSocketParameter } from \"sap/fe/core/helpers/WebSocket\";\nimport { ChannelType, WEBSOCKET_STATUS, createWebSocket } from \"sap/fe/core/helpers/WebSocket\";\nimport MessageBox from \"sap/m/MessageBox\";\nimport type Event from \"sap/ui/base/Event\";\nimport type SapPcpWebSocket from \"sap/ui/core/ws/SapPcpWebSocket\";\nimport type { WebSocket$CloseEvent, WebSocket$MessageEvent } from \"sap/ui/core/ws/WebSocket\";\nimport type JSONModel from \"sap/ui/model/json/JSONModel\";\n\nconst COLLABORATION = \"/collaboration\";\nconst CONNECTION = \"/collaboration/connection\";\nconst CURRENTDRAFTID = \"/collaboration/DraftID\";\nconst WEBSOCKETSTATUS = \"/collaboration/websocket_status\";\n\nexport function isCollaborationConnected(internalModel: JSONModel): boolean {\n\treturn internalModel.getProperty(WEBSOCKETSTATUS) === WEBSOCKET_STATUS.CONNECTED;\n}\n\n/**\n * Initializes the collaboration websocket.\n * @param user\n * @param draftUUID\n * @param internalModel\n * @param receiveCallback\n * @param view\n * @param sendUserInfo\n * @returns True if a new websocket was created\n */\nexport function initializeCollaboration(\n\tuser: User,\n\tdraftUUID: string,\n\tinternalModel: JSONModel,\n\treceiveCallback: (_: Message) => void,\n\tview: FEView,\n\tsendUserInfo = false\n): boolean {\n\tif (internalModel.getProperty(CONNECTION)) {\n\t\t// A connection is already established\n\t\tif (internalModel.getProperty(CURRENTDRAFTID) === draftUUID) {\n\t\t\t// Connection corresponds to the same draft -> nothing to do\n\t\t\treturn false;\n\t\t} else {\n\t\t\t// There was a connection to another draft -> we close it before creating a new one\n\t\t\t// This can happen e.g. when switching between items in FCL\n\t\t\tendCollaboration(internalModel);\n\t\t}\n\t}\n\n\tconst activeUsers: User[] = [user];\n\tinternalModel.setProperty(COLLABORATION, { activeUsers: activeUsers, activities: {} });\n\n\tconst additionalParameters: WebSocketParameter = {\n\t\tdraft: draftUUID\n\t};\n\tif (sendUserInfo || new URLSearchParams(window.location.search).get(\"useFLPUser\") === \"true\") {\n\t\t// used for internal testing\n\t\tadditionalParameters[\"userID\"] = user.id;\n\t\tadditionalParameters[\"userName\"] = user.initialName ?? \"\";\n\t}\n\n\tconst webSocket = createWebSocket(ChannelType.CollaborationDraft, view.getModel(), additionalParameters);\n\n\tinternalModel.setProperty(WEBSOCKETSTATUS, WEBSOCKET_STATUS.CONNECTING);\n\tinternalModel.setProperty(CONNECTION, webSocket);\n\tinternalModel.setProperty(CURRENTDRAFTID, draftUUID);\n\n\twebSocket.attachMessage(function (event: WebSocket$MessageEvent & Event<{ pcpFields?: Message }>): void {\n\t\tconst message = event.getParameter(\"pcpFields\");\n\t\tif (message) {\n\t\t\treceiveCallback(message);\n\t\t}\n\t});\n\n\twebSocket.attachOpen(function () {\n\t\tinternalModel.setProperty(WEBSOCKETSTATUS, WEBSOCKET_STATUS.CONNECTED);\n\t});\n\n\tfunction showConnectionLostDialog(): void {\n\t\tconst resourceModel = getResourceModel(view);\n\t\tconst lostOfConnectionText = resourceModel.getText(\"C_COLLABORATIONDRAFT_CONNECTION_LOST\");\n\n\t\tMessageBox.warning(lostOfConnectionText, {\n\t\t\tactions: [MessageBox.Action.OK],\n\t\t\temphasizedAction: MessageBox.Action.OK\n\t\t});\n\t}\n\n\twebSocket.attachError(function () {\n\t\tif ([WEBSOCKET_STATUS.CONNECTING, WEBSOCKET_STATUS.CONNECTED].includes(internalModel.getProperty(WEBSOCKETSTATUS))) {\n\t\t\tshowConnectionLostDialog();\n\t\t}\n\t\tinternalModel.setProperty(WEBSOCKETSTATUS, WEBSOCKET_STATUS.ERROR);\n\t});\n\n\twebSocket.attachClose(function (evt: WebSocket$CloseEvent) {\n\t\tinternalModel.setProperty(WEBSOCKETSTATUS, WEBSOCKET_STATUS.CLOSED);\n\t\t// RFC 6455 defines the status codes when closing an established connection :  https://datatracker.ietf.org/doc/html/rfc6455#section-7.4\n\t\t// status code 1000 means normal closure\n\t\tif ((evt.getParameter(\"code\") as number | undefined) !== 1000) {\n\t\t\tshowConnectionLostDialog();\n\t\t}\n\t});\n\n\treturn true;\n}\n\nexport function broadcastCollaborationMessage(\n\taction: Activity,\n\tcontent: string | undefined,\n\tinternalModel: JSONModel,\n\ttriggeredActionName?: string,\n\trefreshListBinding?: boolean,\n\trequestedProperties?: string\n): void {\n\tif (isCollaborationConnected(internalModel)) {\n\t\tconst webSocket = internalModel.getProperty(CONNECTION) as SapPcpWebSocket;\n\n\t\twebSocket.send(\"\", {\n\t\t\tclientAction: action,\n\t\t\tclientContent: content,\n\t\t\tclientTriggeredActionName: triggeredActionName,\n\t\t\tclientRefreshListBinding: refreshListBinding,\n\t\t\tclientRequestedProperties: requestedProperties\n\t\t});\n\n\t\tif (action === Activity.Activate || action === Activity.Discard) {\n\t\t\tendCollaboration(internalModel);\n\t\t}\n\t}\n}\n\nexport function endCollaboration(internalModel: JSONModel): void {\n\tconst webSocket = internalModel.getProperty(CONNECTION) as SapPcpWebSocket | undefined;\n\tinternalModel.setProperty(COLLABORATION, {});\n\tinternalModel.setProperty(WEBSOCKETSTATUS, WEBSOCKET_STATUS.CLOSING);\n\twebSocket?.close();\n}\n"],"mappings":";;;;yUAYA,MAAMA,EAAgB,iBACtB,MAAMC,EAAa,4BACnB,MAAMC,EAAiB,yBACvB,MAAMC,EAAkB,kCAEjB,SAASC,EAAyBC,GACxC,OAAOA,EAAcC,YAAYH,KAAqBI,EAAiBC,SACxE,CAEAC,EAAAL,2BAUO,SAASM,EACfC,EACAC,EACAP,EACAQ,EACAC,GAEU,IADVC,EAAYC,UAAAC,OAAA,GAAAD,UAAA,KAAAE,UAAAF,UAAA,GAAG,MAEf,GAAIX,EAAcC,YAAYL,GAAa,CAE1C,GAAII,EAAcC,YAAYJ,KAAoBU,EAAW,CAE5D,OAAO,KACR,KAAO,CAGNO,EAAiBd,EAClB,CACD,CAEA,MAAMe,EAAsB,CAACT,GAC7BN,EAAcgB,YAAYrB,EAAe,CAAEoB,YAAaA,EAAaE,WAAY,CAAC,IAElF,MAAMC,EAA2C,CAChDC,MAAOZ,GAER,GAAIG,GAAgB,IAAIU,gBAAgBC,OAAOC,SAASC,QAAQC,IAAI,gBAAkB,OAAQ,CAE7FN,EAAqB,UAAYZ,EAAKmB,GACtCP,EAAqB,YAAcZ,EAAKoB,aAAe,EACxD,CAEA,MAAMC,EAAYC,EAAgBC,EAAYC,mBAAoBrB,EAAKsB,WAAYb,GAEnFlB,EAAcgB,YAAYlB,EAAiBI,EAAiB8B,YAC5DhC,EAAcgB,YAAYpB,EAAY+B,GACtC3B,EAAcgB,YAAYnB,EAAgBU,GAE1CoB,EAAUM,cAAc,SAAUC,GACjC,MAAMC,EAAUD,EAAME,aAAa,aACnC,GAAID,EAAS,CACZ3B,EAAgB2B,EACjB,CACD,GAEAR,EAAUU,WAAW,WACpBrC,EAAcgB,YAAYlB,EAAiBI,EAAiBC,UAC7D,GAEA,SAASmC,IACR,MAAMC,EAAgBC,EAAiB/B,GACvC,MAAMgC,EAAuBF,EAAcG,QAAQ,wCAEnDC,EAAWC,QAAQH,EAAsB,CACxCI,QAAS,CAACF,EAAWG,OAAOC,IAC5BC,iBAAkBL,EAAWG,OAAOC,IAEtC,CAEApB,EAAUsB,YAAY,WACrB,GAAI,CAAC/C,EAAiB8B,WAAY9B,EAAiBC,WAAW+C,SAASlD,EAAcC,YAAYH,IAAmB,CACnHwC,GACD,CACAtC,EAAcgB,YAAYlB,EAAiBI,EAAiBiD,MAC7D,GAEAxB,EAAUyB,YAAY,SAAUC,GAC/BrD,EAAcgB,YAAYlB,EAAiBI,EAAiBoD,QAG5D,GAAKD,EAAIjB,aAAa,UAAmC,IAAM,CAC9DE,GACD,CACD,GAEA,OAAO,IACR,CAAClC,EAAAC,0BAEM,SAASkD,EACfC,EACAC,EACAzD,EACA0D,EACAC,EACAC,GAEA,GAAI7D,EAAyBC,GAAgB,CAC5C,MAAM2B,EAAY3B,EAAcC,YAAYL,GAE5C+B,EAAUkC,KAAK,GAAI,CAClBC,aAAcN,EACdO,cAAeN,EACfO,0BAA2BN,EAC3BO,yBAA0BN,EAC1BO,0BAA2BN,IAG5B,GAAIJ,IAAWW,EAASC,UAAYZ,IAAWW,EAASE,QAAS,CAChEvD,EAAiBd,EAClB,CACD,CACD,CAACI,EAAAmD,gCAEM,SAASzC,EAAiBd,GAChC,MAAM2B,EAAY3B,EAAcC,YAAYL,GAC5CI,EAAcgB,YAAYrB,EAAe,CAAC,GAC1CK,EAAcgB,YAAYlB,EAAiBI,EAAiBoE,SAC5D3C,GAAW4C,OACZ,CAACnE,EAAAU,mBAAA,OAAAV,CAAA","ignoreList":[]}