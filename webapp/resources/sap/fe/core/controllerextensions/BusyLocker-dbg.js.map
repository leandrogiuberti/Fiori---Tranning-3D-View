{"version":3,"names":["_iTimeoutInSeconds","_mLockCounters","_oReferenceDummy","getId","setBusy","bBusy","Log","info","getLockCountId","oReference","sPath","isLocked","getLockCountEntry","warning","sId","id","path","reference","count","deleteLockCountEntry","mLockCountEntry","applyLockState","isA","setProperty","undefined","clearTimeout","timeout","setTimeout","error","changeLockCount","iDelta","BusyLocker","lock","oModelOrControl","_updateLock","unlock"],"sourceRoot":".","sources":["BusyLocker.ts"],"sourcesContent":["import Log from \"sap/base/Log\";\nimport type BaseObject from \"sap/ui/base/Object\";\nimport type Control from \"sap/ui/core/Control\";\nimport type Model from \"sap/ui/model/Model\";\nimport type JSONModel from \"sap/ui/model/json/JSONModel\";\nexport type BaseObjectWithId = BaseObject & { getId(): string; setBusy?(busy: boolean): void };\nconst _iTimeoutInSeconds = 30,\n\t_mLockCounters: Record<string, LockCountEntry> = {},\n\t_oReferenceDummy = {\n\t\tgetId: function (): string {\n\t\t\treturn \"BusyLocker.ReferenceDummy\";\n\t\t},\n\t\tsetBusy: function (bBusy: boolean): void {\n\t\t\tLog.info(`setBusy(${bBusy}) triggered on dummy reference`);\n\t\t}\n\t};\nfunction getLockCountId(oReference: BaseObjectWithId | Model, sPath?: string): string {\n\treturn oReference.getId() + (sPath || \"/busy\");\n}\nfunction isLocked(oReference: BaseObjectWithId | Model, sPath?: string): boolean {\n\treturn getLockCountId(oReference, sPath) in _mLockCounters;\n}\nfunction getLockCountEntry(oReference: BaseObjectWithId | Model, sPath?: string): LockCountEntry {\n\tif (!oReference || !oReference.getId) {\n\t\tLog.warning(\"No reference for BusyLocker, using dummy reference\");\n\t\toReference = _oReferenceDummy as unknown as BaseObjectWithId;\n\t}\n\n\tsPath = sPath || \"/busy\";\n\tconst sId = getLockCountId(oReference, sPath);\n\n\tif (!(sId in _mLockCounters)) {\n\t\t_mLockCounters[sId] = {\n\t\t\tid: sId,\n\t\t\tpath: sPath,\n\t\t\treference: oReference,\n\t\t\tcount: 0\n\t\t};\n\t}\n\treturn _mLockCounters[sId];\n}\n/**\n * @param mLockCountEntry\n */\nfunction deleteLockCountEntry(mLockCountEntry: LockCountEntry): void {\n\tdelete _mLockCounters[mLockCountEntry.id];\n}\n\ntype LockCountEntry = {\n\tid: string;\n\tcount: number;\n\tpath: string;\n\ttimeout?: number;\n\treference: BaseObjectWithId | Model;\n};\nfunction applyLockState(mLockCountEntry: LockCountEntry): boolean {\n\tconst reference = mLockCountEntry.reference;\n\tconst bBusy = mLockCountEntry.count !== 0;\n\n\tif (reference.isA && reference.isA<JSONModel>(\"sap.ui.model.Model\")) {\n\t\treference.setProperty(mLockCountEntry.path, bBusy, undefined, true);\n\t} else if ((reference as Control).setBusy) {\n\t\t(reference as Control).setBusy(bBusy);\n\t}\n\n\tclearTimeout(mLockCountEntry.timeout);\n\tif (bBusy) {\n\t\tmLockCountEntry.timeout = setTimeout(function () {\n\t\t\tLog.error(\n\t\t\t\t`busy lock for ${mLockCountEntry.id} with value ${mLockCountEntry.count} timed out after ${_iTimeoutInSeconds} seconds!`\n\t\t\t);\n\t\t}, _iTimeoutInSeconds * 1000) as unknown as number;\n\t} else {\n\t\tdeleteLockCountEntry(mLockCountEntry);\n\t}\n\n\treturn bBusy;\n}\n\nfunction changeLockCount(mLockCountEntry: LockCountEntry, iDelta: number): void {\n\tif (iDelta === 0) {\n\t\tmLockCountEntry.count = 0;\n\t\tLog.info(`busy lock count '${mLockCountEntry.id}' was reset to 0`);\n\t} else {\n\t\tmLockCountEntry.count += iDelta;\n\t\tLog.info(`busy lock count '${mLockCountEntry.id}' is ${mLockCountEntry.count}`);\n\t}\n}\n\nconst BusyLocker = {\n\tlock: function (oModelOrControl: BaseObjectWithId | Model, sPath?: string): boolean {\n\t\treturn this._updateLock(oModelOrControl, sPath, 1);\n\t},\n\n\tunlock: function (oModelOrControl: BaseObjectWithId | Model, sPath?: string): boolean {\n\t\treturn this._updateLock(oModelOrControl, sPath, -1);\n\t},\n\n\tisLocked: function (oModelOrControl: BaseObjectWithId | Model, sPath?: string): boolean {\n\t\treturn isLocked(oModelOrControl, sPath);\n\t},\n\n\t_updateLock: function (oReference: BaseObjectWithId | Model, sPath: string | undefined, iDelta: number): boolean {\n\t\tconst mLockCountEntry = getLockCountEntry(oReference, sPath);\n\t\tchangeLockCount(mLockCountEntry, iDelta);\n\t\treturn applyLockState(mLockCountEntry);\n\t}\n};\n\nexport default BusyLocker;\n"],"mappings":"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","ignoreList":[],"file":"BusyLocker-dbg.js"}