{"version":3,"file":"KPIManagement.js","names":["MessageTypeFromCriticality","MessageType","Error","Warning","Success","Information","ValueColorFromMessageType","None","messageTypeFromTargetCalculation","kpiValue","aThresholds","criticalityProperty","undefined","messageTypeFromMinimizeCalculation","messageTypeFromMaximizeCalculation","deviationIndicatorFromTrendType","trendValue","deviationIndicator","deviationIndicatorFromCalculation","referenceValue","isRelative","compValue","createFilterFromDefinition","filterDefinition","ranges","length","Filter","propertyPath","operator","rangeLow","rangeHigh","aRangeFilters","map","range","filters","and","getFilterStringFromDefinition","currentLocale","Locale","Localization","getLanguage","resBundle","Library","getResourceBundleFor","dateFormat","DateFormat","getDateInstance","style","formatRange","valueLow","propertyType","indexOf","format","Date","valueHigh","getText","join","formatChartTitle","kpiDef","formatList","items","label","res","I","chart","title","measures","dimensions","updateChartLabelSettings","chartDefinition","oChartProperties","chartType","categoryAxis","visible","valueAxis","formatString","plotArea","dataLabel","type","valueAxis2","legendGroup","layout","position","alignment","sizeLegend","filterMap","aObjects","aRoles","filter","dimension","includes","role","getScatterBubbleChartFeeds","axis1Measures","axis2Measures","axis3Measures","otherMeasures","seriesDimensions","shapeDimension","find","xMeasure","shift","yMeasure","uid","values","sizeMeasure","push","getChartFeeds","async","getNavigationParameters","navInfo","oShellService","semanticObject","action","getLinks","then","aLinks","getPrimaryIntent","oLink","oInfo","parseShellHash","intent","unavailableActions","outboundNavigation","Promise","resolve","outbound","KPIManagementControllerExtension","_dec","defineUI5Class","_dec2","methodOverride","_dec3","_class","_class2","_ControllerExtension","call","this","_inheritsLoose","_proto","prototype","initCardManifest","kpiDefinition","oKPIModel","oCardManifest","id","technology","data","json","header","datapoint","subTitle","description","unitOfMeasurement","mainIndicator","number","unit","state","trend","content","minHeight","chartProperties","path","targetPath","targetValue","sideIndicators","selectionVariantFilterDefinitions","aDescriptions","forEach","desc","details","text","value","name","measure","feeds","setProperty","manifest","initNavigationInfo","navigation","oNavInfo","parameters","onInit","aKPIDefinitions","getView","getController","_getPageModel","getProperty","oView","oAppComponent","getAppComponent","JSONModel","setModel","getShellServices","catch","err","Log","error","loadKPITagData","getModel","onExit","destroy","updateDatapointValueAndCurrency","kpiContext","rawUnit","isPath","isPercentage","isCurrency","rawValue","Number","parseFloat","NumberFormat","getFloatInstance","minFractionDigits","maxFractionDigits","numberOfFractionalDigits","showScale","kpiValueUnscaled","groupingEnabled","kpiValueNoScale","kpiValueScale","decimals","maxIntegerDigits","kpiUnit","getUnitInstance","showNumber","updateDatapointCriticality","criticalityValue","criticalityPath","criticalityCalculationThresholds","criticalityCalculationMode","updateDatapointTrend","trendPath","trendCalculationReferenceValue","trendCalculationReferencePath","trendReferenceValue","trendCalculationIsRelative","trendCalculationTresholds","updateTargetValue","targetRawValue","deviationRawValue","targetScale","deviationValue","oMainModel","loadFull","oListBinding","bindList","contextPath","$$groupId","oAggregate","setAggregation","aggregate","aFilters","requestContexts","aContexts","loadKPICardData","oGroup","additionally","group","sortOrder","sort","sortInfo","Sorter","descending","allContexts","maxItems","chartData","oContext","oData","textArrangement","valueFormatters","formatWithBrackets","getPopover","oKPITag","_this","oPopover","reject","load","sap","ui","require","_len","arguments","params","Array","_key","CardClass","Host","oHost","attachAction","oEvent","sType","getParameter","oParams","base","_intentBasedNavigation","navigate","navigateOutbound","oCard","width","height","setHost","Popover","showHeader","placement","addDependent","onKPIPressed","kpiID","oDef","oModel","popover","setModal","setManifest","setPreviewMode","openBy","promises","all","attachEventOnce","getFocusDomRef","focus","refresh","ControllerExtension","_applyDecoratedDescriptor","Object","getOwnPropertyDescriptor"],"sources":["./KPIManagement.ts"],"sourcesContent":["import Log from \"sap/base/Log\";\nimport Localization from \"sap/base/i18n/Localization\";\nimport { defineUI5Class, methodOverride } from \"sap/fe/base/ClassSupport\";\nimport type BaseController from \"sap/fe/core/BaseController\";\nimport type PageController from \"sap/fe/core/PageController\";\nimport type {\n\tAnalyticalKPIDefinition,\n\tKPIChartDefinition,\n\tKPIDefinition,\n\tNavigationInfo\n} from \"sap/fe/core/converters/controls/Common/KPI\";\nimport type { FilterDefinition, RangeDefinition } from \"sap/fe/core/converters/helpers/SelectionVariantHelper\";\nimport valueFormatters from \"sap/fe/core/formatters/ValueFormatter\";\nimport type { IShellServices } from \"sap/fe/core/services/ShellServicesFactory\";\nimport type GenericTag from \"sap/m/GenericTag\";\nimport Popover from \"sap/m/Popover\";\nimport type Control from \"sap/ui/core/Control\";\nimport Library from \"sap/ui/core/Lib\";\nimport Locale from \"sap/ui/core/Locale\";\nimport DateFormat from \"sap/ui/core/format/DateFormat\";\nimport NumberFormat from \"sap/ui/core/format/NumberFormat\";\nimport MessageType from \"sap/ui/core/message/MessageType\";\nimport ControllerExtension from \"sap/ui/core/mvc/ControllerExtension\";\nimport type HostType from \"sap/ui/integration/Host\";\nimport type { Host$ActionEvent } from \"sap/ui/integration/Host\";\nimport type { default as Card, CardManifest, default as CardType, ChartCardContent } from \"sap/ui/integration/widgets/Card\";\nimport Filter from \"sap/ui/model/Filter\";\nimport type FilterOperator from \"sap/ui/model/FilterOperator\";\nimport Sorter from \"sap/ui/model/Sorter\";\nimport JSONModel from \"sap/ui/model/json/JSONModel\";\nimport type Context from \"sap/ui/model/odata/v4/Context\";\nimport type ODataModel from \"sap/ui/model/odata/v4/ODataModel\";\n\nconst MessageTypeFromCriticality: Record<string, MessageType> = {\n\t\"1\": MessageType.Error,\n\t\"2\": MessageType.Warning,\n\t\"3\": MessageType.Success,\n\t\"5\": MessageType.Information\n};\n\nconst ValueColorFromMessageType: Record<MessageType, string> = {\n\tError: \"Error\",\n\tWarning: \"Critical\",\n\tSuccess: \"Good\",\n\tInformation: \"None\",\n\tNone: \"None\"\n};\n\n/**\n * Function to get a message state from a calculated criticality of type 'Target'.\n * @param kpiValue The value of the KPI to be tested against.\n * @param aThresholds Thresholds to be used [DeviationRangeLowValue,ToleranceRangeLowValue,AcceptanceRangeLowValue,AcceptanceRangeHighValue,ToleranceRangeHighValue,DeviationRangeHighValue].\n * @returns The corresponding MessageType\n */\nfunction messageTypeFromTargetCalculation(kpiValue: number, aThresholds: (number | undefined | null)[]): MessageType {\n\tlet criticalityProperty: MessageType;\n\n\tif (aThresholds[0] !== undefined && aThresholds[0] !== null && kpiValue < aThresholds[0]) {\n\t\tcriticalityProperty = MessageType.Error;\n\t} else if (aThresholds[1] !== undefined && aThresholds[1] !== null && kpiValue < aThresholds[1]) {\n\t\tcriticalityProperty = MessageType.Warning;\n\t} else if (aThresholds[2] !== undefined && aThresholds[2] !== null && kpiValue < aThresholds[2]) {\n\t\tcriticalityProperty = MessageType.None;\n\t} else if (aThresholds[5] !== undefined && aThresholds[5] !== null && kpiValue > aThresholds[5]) {\n\t\tcriticalityProperty = MessageType.Error;\n\t} else if (aThresholds[4] !== undefined && aThresholds[4] !== null && kpiValue > aThresholds[4]) {\n\t\tcriticalityProperty = MessageType.Warning;\n\t} else if (aThresholds[3] !== undefined && aThresholds[3] !== null && kpiValue > aThresholds[3]) {\n\t\tcriticalityProperty = MessageType.None;\n\t} else {\n\t\tcriticalityProperty = MessageType.Success;\n\t}\n\n\treturn criticalityProperty;\n}\n\n/**\n * Function to get a message state from a calculated criticality of type 'Minimize'.\n * @param kpiValue The value of the KPI to be tested against.\n * @param aThresholds Thresholds to be used [AcceptanceRangeHighValue,ToleranceRangeHighValue,DeviationRangeHighValue].\n * @returns The corresponding MessageType\n */\nfunction messageTypeFromMinimizeCalculation(kpiValue: number, aThresholds: (number | undefined | null)[]): MessageType {\n\tlet criticalityProperty: MessageType;\n\n\tif (aThresholds[2] !== undefined && aThresholds[2] !== null && kpiValue > aThresholds[2]) {\n\t\tcriticalityProperty = MessageType.Error;\n\t} else if (aThresholds[1] !== undefined && aThresholds[1] !== null && kpiValue > aThresholds[1]) {\n\t\tcriticalityProperty = MessageType.Warning;\n\t} else if (aThresholds[0] !== undefined && aThresholds[0] !== null && kpiValue > aThresholds[0]) {\n\t\tcriticalityProperty = MessageType.None;\n\t} else {\n\t\tcriticalityProperty = MessageType.Success;\n\t}\n\n\treturn criticalityProperty;\n}\n\n/**\n * Function to get a message state from a calculated criticality of type 'Maximize'.\n * @param kpiValue The value of the KPI to be tested against.\n * @param aThresholds Thresholds to be used [DeviationRangeLowValue,ToleranceRangeLowValue,AcceptanceRangeLowValue].\n * @returns The corresponding MessageType\n */\nfunction messageTypeFromMaximizeCalculation(kpiValue: number, aThresholds: (number | undefined | null)[]): MessageType {\n\tlet criticalityProperty: MessageType;\n\n\tif (aThresholds[0] !== undefined && aThresholds[0] !== null && kpiValue < aThresholds[0]) {\n\t\tcriticalityProperty = MessageType.Error;\n\t} else if (aThresholds[1] !== undefined && aThresholds[1] !== null && kpiValue < aThresholds[1]) {\n\t\tcriticalityProperty = MessageType.Warning;\n\t} else if (aThresholds[2] !== undefined && aThresholds[2] !== null && kpiValue < aThresholds[2]) {\n\t\tcriticalityProperty = MessageType.None;\n\t} else {\n\t\tcriticalityProperty = MessageType.Success;\n\t}\n\n\treturn criticalityProperty;\n}\n\n/**\n * Function to calculate a DeviationIndicator value from a trend value.\n * @param trendValue The criticality values.\n * @returns The corresponding DeviationIndicator value\n */\nfunction deviationIndicatorFromTrendType(trendValue: number | string): string {\n\tlet deviationIndicator: string;\n\n\tswitch (trendValue) {\n\t\tcase 1: // StrongUp\n\t\tcase \"1\":\n\t\tcase 2: // Up\n\t\tcase \"2\":\n\t\t\tdeviationIndicator = \"Up\";\n\t\t\tbreak;\n\n\t\tcase 4: // Down\n\t\tcase \"4\":\n\t\tcase 5: // StrongDown\n\t\tcase \"5\":\n\t\t\tdeviationIndicator = \"Down\";\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tdeviationIndicator = \"None\";\n\t}\n\n\treturn deviationIndicator;\n}\n\n/**\n * Function to calculate a DeviationIndicator from a TrendCalculation.\n * @param kpiValue The value of the KPI\n * @param referenceValue The reference value to compare with\n * @param isRelative True is the comparison is relative\n * @param aThresholds Array of thresholds [StrongDownDifference, DownDifference, UpDifference, StrongUpDifference]\n * @returns The corresponding DeviationIndicator value\n */\nfunction deviationIndicatorFromCalculation(\n\tkpiValue: number,\n\treferenceValue: number,\n\tisRelative: boolean,\n\taThresholds: (number | undefined | null)[] | undefined\n): string {\n\tlet deviationIndicator: string;\n\n\tif (!aThresholds || (isRelative && !referenceValue)) {\n\t\treturn \"None\";\n\t}\n\n\tconst compValue = isRelative ? (kpiValue - referenceValue) / referenceValue : kpiValue - referenceValue;\n\n\tif (aThresholds[0] !== undefined && aThresholds[0] !== null && compValue <= aThresholds[0]) {\n\t\t// StrongDown --> Down\n\t\tdeviationIndicator = \"Down\";\n\t} else if (aThresholds[1] !== undefined && aThresholds[1] !== null && compValue <= aThresholds[1]) {\n\t\t// Down --> Down\n\t\tdeviationIndicator = \"Down\";\n\t} else if (aThresholds[3] !== undefined && aThresholds[3] !== null && compValue >= aThresholds[3]) {\n\t\t// StrongUp --> Up\n\t\tdeviationIndicator = \"Up\";\n\t} else if (aThresholds[2] !== undefined && aThresholds[2] !== null && compValue >= aThresholds[2]) {\n\t\t// Up --> Up\n\t\tdeviationIndicator = \"Up\";\n\t} else {\n\t\t// Sideways --> None\n\t\tdeviationIndicator = \"None\";\n\t}\n\n\treturn deviationIndicator;\n}\n\n/**\n * Creates a sap.ui.model.Filter from a filter definition.\n * @param filterDefinition The filter definition\n * @returns Returns a sap.ui.model.Filter from the definition, or undefined if the definition is empty (no ranges)\n */\nfunction createFilterFromDefinition(filterDefinition: FilterDefinition): Filter | undefined {\n\tif (filterDefinition.ranges.length === 0) {\n\t\treturn undefined;\n\t} else if (filterDefinition.ranges.length === 1) {\n\t\treturn new Filter(\n\t\t\tfilterDefinition.propertyPath,\n\t\t\tfilterDefinition.ranges[0].operator as FilterOperator,\n\t\t\tfilterDefinition.ranges[0].rangeLow,\n\t\t\tfilterDefinition.ranges[0].rangeHigh\n\t\t);\n\t} else {\n\t\tconst aRangeFilters = filterDefinition.ranges.map((range) => {\n\t\t\treturn new Filter(filterDefinition.propertyPath, range.operator as FilterOperator, range.rangeLow, range.rangeHigh);\n\t\t});\n\t\treturn new Filter({\n\t\t\tfilters: aRangeFilters,\n\t\t\tand: false\n\t\t});\n\t}\n}\n\nfunction getFilterStringFromDefinition(filterDefinition: FilterDefinition): string {\n\tconst currentLocale = new Locale(Localization.getLanguage());\n\tconst resBundle = Library.getResourceBundleFor(\"sap.fe.core\")!;\n\tconst dateFormat = DateFormat.getDateInstance({ style: \"medium\" }, currentLocale);\n\n\tfunction formatRange(range: RangeDefinition): string {\n\t\tconst valueLow =\n\t\t\tfilterDefinition.propertyType.indexOf(\"Edm.Date\") === 0\n\t\t\t\t? dateFormat.format(new Date(range.rangeLow))\n\t\t\t\t: (range.rangeLow as string);\n\t\tconst valueHigh =\n\t\t\tfilterDefinition.propertyType.indexOf(\"Edm.Date\") === 0 && range.rangeHigh !== undefined\n\t\t\t\t? dateFormat.format(new Date(range.rangeHigh))\n\t\t\t\t: range.rangeHigh;\n\n\t\tswitch (range.operator) {\n\t\t\tcase \"BT\":\n\t\t\t\treturn `[${valueLow} - ${valueHigh}]`;\n\n\t\t\tcase \"Contains\":\n\t\t\t\treturn `*${valueLow}*`;\n\n\t\t\tcase \"GE\":\n\t\t\t\treturn `\\u2265${valueLow}`;\n\n\t\t\tcase \"GT\":\n\t\t\t\treturn `>${valueLow}`;\n\n\t\t\tcase \"LE\":\n\t\t\t\treturn `\\u2264${valueLow}`;\n\n\t\t\tcase \"LT\":\n\t\t\t\treturn `<${valueLow}`;\n\n\t\t\tcase \"NB\":\n\t\t\t\treturn resBundle.getText(\"C_KPICARD_FILTERSTRING_NOT\", [`[${valueLow} - ${valueHigh}]`]);\n\n\t\t\tcase \"NE\":\n\t\t\t\treturn `\\u2260${valueLow}`;\n\n\t\t\tcase \"NotContains\":\n\t\t\t\treturn resBundle.getText(\"C_KPICARD_FILTERSTRING_NOT\", [`*${valueLow}*`]);\n\n\t\t\tcase \"EQ\":\n\t\t\tdefault:\n\t\t\t\treturn valueLow;\n\t\t}\n\t}\n\tif (filterDefinition.ranges.length === 0) {\n\t\treturn \"\";\n\t} else if (filterDefinition.ranges.length === 1) {\n\t\treturn formatRange(filterDefinition.ranges[0]);\n\t} else {\n\t\treturn `(${filterDefinition.ranges.map(formatRange).join(\",\")})`;\n\t}\n}\n\nfunction formatChartTitle(kpiDef: AnalyticalKPIDefinition): string {\n\tconst resBundle = Library.getResourceBundleFor(\"sap.fe.core\")!;\n\n\tfunction formatList(items: { name: string; label: string }[]): string {\n\t\tif (items.length === 0) {\n\t\t\treturn \"\";\n\t\t} else if (items.length === 1) {\n\t\t\treturn items[0].label;\n\t\t} else {\n\t\t\tlet res = items[0].label;\n\t\t\tfor (let I = 1; I < items.length - 1; I++) {\n\t\t\t\tres += `, ${items[I].label}`;\n\t\t\t}\n\n\t\t\treturn resBundle.getText(\"C_KPICARD_ITEMSLIST\", [res, items[items.length - 1].label]);\n\t\t}\n\t}\n\n\t// If the chart has a title, use it. Otherwise, create a title from the dimensions and measures\n\treturn (\n\t\tkpiDef.chart.title ??\n\t\tresBundle.getText(\"C_KPICARD_CHARTTITLE\", [formatList(kpiDef.chart.measures), formatList(kpiDef.chart.dimensions)])\n\t);\n}\n\nfunction updateChartLabelSettings(\n\tchartDefinition: KPIChartDefinition,\n\toChartProperties: {\n\t\tcategoryAxis: { title: { visible: boolean } };\n\t\tsizeLegend: { visible: boolean };\n\t\tlegendGroup: { layout: { position: string; alignment: string } };\n\t\tvalueAxis: {\n\t\t\ttitle: { visible: boolean };\n\t\t\tlabel: {\n\t\t\t\tformatString: string;\n\t\t\t};\n\t\t};\n\t\tvalueAxis2: {\n\t\t\ttitle: { visible: boolean };\n\t\t\tlabel: {\n\t\t\t\tformatString: string;\n\t\t\t};\n\t\t};\n\t\tplotArea: {\n\t\t\tdataLabel: {};\n\t\t};\n\t}\n): void {\n\tswitch (chartDefinition.chartType) {\n\t\tcase \"Donut\":\n\t\t\t// Show data labels, do not show axis titles\n\t\t\toChartProperties.categoryAxis = {\n\t\t\t\ttitle: {\n\t\t\t\t\tvisible: false\n\t\t\t\t}\n\t\t\t};\n\t\t\toChartProperties.valueAxis = {\n\t\t\t\ttitle: {\n\t\t\t\t\tvisible: false\n\t\t\t\t},\n\t\t\t\tlabel: {\n\t\t\t\t\tformatString: \"ShortFloat\"\n\t\t\t\t}\n\t\t\t};\n\t\t\toChartProperties.plotArea.dataLabel = {\n\t\t\t\tvisible: true,\n\t\t\t\ttype: \"value\",\n\t\t\t\tformatString: \"ShortFloat_MFD2\"\n\t\t\t};\n\t\t\tbreak;\n\n\t\tcase \"bubble\":\n\t\t\t// Show axis title, bubble size legend, do not show data labels\n\t\t\toChartProperties.valueAxis = {\n\t\t\t\ttitle: {\n\t\t\t\t\tvisible: true\n\t\t\t\t},\n\t\t\t\tlabel: {\n\t\t\t\t\tformatString: \"ShortFloat\"\n\t\t\t\t}\n\t\t\t};\n\t\t\toChartProperties.valueAxis2 = {\n\t\t\t\ttitle: {\n\t\t\t\t\tvisible: true\n\t\t\t\t},\n\t\t\t\tlabel: {\n\t\t\t\t\tformatString: \"ShortFloat\"\n\t\t\t\t}\n\t\t\t};\n\t\t\toChartProperties.legendGroup = {\n\t\t\t\tlayout: {\n\t\t\t\t\tposition: \"bottom\",\n\t\t\t\t\talignment: \"topLeft\"\n\t\t\t\t}\n\t\t\t};\n\t\t\toChartProperties.sizeLegend = {\n\t\t\t\tvisible: true\n\t\t\t};\n\t\t\toChartProperties.plotArea.dataLabel = { visible: false };\n\t\t\tbreak;\n\n\t\tcase \"scatter\":\n\t\t\t// Do not show data labels and axis titles\n\t\t\toChartProperties.valueAxis = {\n\t\t\t\ttitle: {\n\t\t\t\t\tvisible: false\n\t\t\t\t},\n\t\t\t\tlabel: {\n\t\t\t\t\tformatString: \"ShortFloat\"\n\t\t\t\t}\n\t\t\t};\n\t\t\toChartProperties.valueAxis2 = {\n\t\t\t\ttitle: {\n\t\t\t\t\tvisible: false\n\t\t\t\t},\n\t\t\t\tlabel: {\n\t\t\t\t\tformatString: \"ShortFloat\"\n\t\t\t\t}\n\t\t\t};\n\t\t\toChartProperties.plotArea.dataLabel = { visible: false };\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\t// Do not show data labels and axis titles\n\t\t\toChartProperties.categoryAxis = {\n\t\t\t\ttitle: {\n\t\t\t\t\tvisible: false\n\t\t\t\t}\n\t\t\t};\n\t\t\toChartProperties.valueAxis = {\n\t\t\t\ttitle: {\n\t\t\t\t\tvisible: false\n\t\t\t\t},\n\t\t\t\tlabel: {\n\t\t\t\t\tformatString: \"ShortFloat\"\n\t\t\t\t}\n\t\t\t};\n\t\t\toChartProperties.plotArea.dataLabel = { visible: false };\n\t}\n}\nfunction filterMap(aObjects: { name: string; label: string; role?: string }[], aRoles?: (string | undefined)[]): string[] {\n\tif (aRoles && aRoles.length) {\n\t\treturn aObjects\n\t\t\t.filter((dimension) => {\n\t\t\t\treturn aRoles.includes(dimension.role);\n\t\t\t})\n\t\t\t.map((dimension) => {\n\t\t\t\treturn dimension.label;\n\t\t\t});\n\t} else {\n\t\treturn aObjects.map((dimension) => {\n\t\t\treturn dimension.label;\n\t\t});\n\t}\n}\n\nfunction getScatterBubbleChartFeeds(chartDefinition: KPIChartDefinition): { uid: string; type: string; values: string[] }[] {\n\tconst axis1Measures = filterMap(chartDefinition.measures, [\"Axis1\"]);\n\tconst axis2Measures = filterMap(chartDefinition.measures, [\"Axis2\"]);\n\tconst axis3Measures = filterMap(chartDefinition.measures, [\"Axis3\"]);\n\tconst otherMeasures = filterMap(chartDefinition.measures, [undefined]);\n\tconst seriesDimensions = filterMap(chartDefinition.dimensions, [\"Series\"]);\n\n\t// Get the first dimension with role \"Category\" for the shape\n\tconst shapeDimension = chartDefinition.dimensions.find((dimension) => {\n\t\treturn dimension.role === \"Category\";\n\t});\n\n\t// Measure for the x-Axis : first measure for Axis1, or for Axis2 if not found, or for Axis3 if not found\n\tconst xMeasure = axis1Measures.shift() || axis2Measures.shift() || axis3Measures.shift() || otherMeasures.shift() || \"\";\n\t// Measure for the y-Axis : first measure for Axis2, or second measure for Axis1 if not found, or first measure for Axis3 if not found\n\tconst yMeasure = axis2Measures.shift() || axis1Measures.shift() || axis3Measures.shift() || otherMeasures.shift() || \"\";\n\tconst res = [\n\t\t{\n\t\t\tuid: \"valueAxis\",\n\t\t\ttype: \"Measure\",\n\t\t\tvalues: [xMeasure]\n\t\t},\n\t\t{\n\t\t\tuid: \"valueAxis2\",\n\t\t\ttype: \"Measure\",\n\t\t\tvalues: [yMeasure]\n\t\t}\n\t];\n\n\tif (chartDefinition.chartType === \"bubble\") {\n\t\t// Measure for the size of the bubble: first measure for Axis3, or remaining measure for Axis1/Axis2 if not found\n\t\tconst sizeMeasure = axis3Measures.shift() || axis1Measures.shift() || axis2Measures.shift() || otherMeasures.shift() || \"\";\n\t\tres.push({\n\t\t\tuid: \"bubbleWidth\",\n\t\t\ttype: \"Measure\",\n\t\t\tvalues: [sizeMeasure]\n\t\t});\n\t}\n\n\t// Color (optional)\n\tif (seriesDimensions.length) {\n\t\tres.push({\n\t\t\tuid: \"color\",\n\t\t\ttype: \"Dimension\",\n\t\t\tvalues: seriesDimensions\n\t\t});\n\t}\n\t// Shape (optional)\n\tif (shapeDimension) {\n\t\tres.push({\n\t\t\tuid: \"shape\",\n\t\t\ttype: \"Dimension\",\n\t\t\tvalues: [shapeDimension.label]\n\t\t});\n\t}\n\treturn res;\n}\n\nfunction getChartFeeds(chartDefinition: KPIChartDefinition): { uid: string; type: string; values: string[] }[] {\n\tlet res: { uid: string; type: string; values: string[] }[];\n\n\tswitch (chartDefinition.chartType) {\n\t\tcase \"Donut\":\n\t\t\tres = [\n\t\t\t\t{\n\t\t\t\t\tuid: \"size\",\n\t\t\t\t\ttype: \"Measure\",\n\t\t\t\t\tvalues: filterMap(chartDefinition.measures)\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tuid: \"color\",\n\t\t\t\t\ttype: \"Dimension\",\n\t\t\t\t\tvalues: filterMap(chartDefinition.dimensions)\n\t\t\t\t}\n\t\t\t];\n\t\t\tbreak;\n\n\t\tcase \"bubble\":\n\t\tcase \"scatter\":\n\t\t\tres = getScatterBubbleChartFeeds(chartDefinition);\n\t\t\tbreak;\n\n\t\tcase \"vertical_bullet\":\n\t\t\tres = [\n\t\t\t\t{\n\t\t\t\t\tuid: \"actualValues\",\n\t\t\t\t\ttype: \"Measure\",\n\t\t\t\t\tvalues: filterMap(chartDefinition.measures, [undefined, \"Axis1\"])\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tuid: \"targetValues\",\n\t\t\t\t\ttype: \"Measure\",\n\t\t\t\t\tvalues: filterMap(chartDefinition.measures, [\"Axis2\"])\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tuid: \"categoryAxis\",\n\t\t\t\t\ttype: \"Dimension\",\n\t\t\t\t\tvalues: filterMap(chartDefinition.dimensions, [undefined, \"Category\"])\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tuid: \"color\",\n\t\t\t\t\ttype: \"Dimension\",\n\t\t\t\t\tvalues: filterMap(chartDefinition.dimensions, [\"Series\"])\n\t\t\t\t}\n\t\t\t];\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tres = [\n\t\t\t\t{\n\t\t\t\t\tuid: \"valueAxis\",\n\t\t\t\t\ttype: \"Measure\",\n\t\t\t\t\tvalues: filterMap(chartDefinition.measures)\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tuid: \"categoryAxis\",\n\t\t\t\t\ttype: \"Dimension\",\n\t\t\t\t\tvalues: filterMap(chartDefinition.dimensions, [undefined, \"Category\"])\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tuid: \"color\",\n\t\t\t\t\ttype: \"Dimension\",\n\t\t\t\t\tvalues: filterMap(chartDefinition.dimensions, [\"Series\"])\n\t\t\t\t}\n\t\t\t];\n\t}\n\n\treturn res;\n}\n\nasync function getNavigationParameters(\n\tnavInfo: NavigationInfo,\n\toShellService: IShellServices\n): Promise<{ semanticObject?: string; action?: string; outbound?: string } | undefined> {\n\tif (navInfo.semanticObject) {\n\t\tif (navInfo.action) {\n\t\t\t// Action is already specified: check if it's available in the shell\n\t\t\treturn oShellService.getLinks([{ semanticObject: navInfo.semanticObject, action: navInfo.action }]).then((aLinks) => {\n\t\t\t\treturn aLinks.length && aLinks[0].length ? { semanticObject: navInfo.semanticObject, action: navInfo.action } : undefined;\n\t\t\t});\n\t\t} else {\n\t\t\t// We get the primary intent from the shell\n\t\t\treturn oShellService.getPrimaryIntent(navInfo.semanticObject).then((oLink) => {\n\t\t\t\tif (!oLink) {\n\t\t\t\t\t// No primary intent...\n\t\t\t\t\treturn undefined;\n\t\t\t\t}\n\n\t\t\t\t// Check that the primary intent is not part of the unavailable actions\n\t\t\t\tconst oInfo = oShellService.parseShellHash(oLink.intent);\n\t\t\t\treturn navInfo.unavailableActions && navInfo.unavailableActions.includes(oInfo.action)\n\t\t\t\t\t? undefined\n\t\t\t\t\t: { semanticObject: oInfo.semanticObject, action: oInfo.action };\n\t\t\t});\n\t\t}\n\t} else {\n\t\t// Outbound navigation specified in the manifest\n\t\treturn navInfo.outboundNavigation ? Promise.resolve({ outbound: navInfo.outboundNavigation }) : Promise.resolve(undefined);\n\t}\n}\n\n/**\n * A controller extension for managing the KPIs in an analytical list page.\n * @hideconstructor\n * @since 1.93.0\n */\n@defineUI5Class(\"sap.fe.core.controllerextensions.KPIManagement\")\nclass KPIManagementControllerExtension extends ControllerExtension {\n\tprivate base!: PageController;\n\n\tprotected aKPIDefinitions?: KPIDefinition[];\n\n\tprotected oCard!: Card;\n\n\tprotected oPopover!: Popover;\n\n\tconstructor() {\n\t\tsuper();\n\t}\n\n\t/**\n\t * Creates the card manifest for a KPI definition and stores it in a JSON model.\n\t * @param kpiDefinition The KPI definition\n\t * @param oKPIModel The JSON model in which the manifest will be stored\n\t */\n\tprotected initCardManifest(kpiDefinition: AnalyticalKPIDefinition, oKPIModel: JSONModel): void {\n\t\tconst oCardManifest: CardManifest<Partial<ChartCardContent>> = {\n\t\t\t\"sap.app\": {\n\t\t\t\tid: \"sap.fe.KPICard\",\n\t\t\t\ttype: \"card\"\n\t\t\t},\n\t\t\t\"sap.ui\": {\n\t\t\t\ttechnology: \"UI5\"\n\t\t\t},\n\t\t\t\"sap.card\": {\n\t\t\t\ttype: \"Analytical\",\n\t\t\t\tdata: {\n\t\t\t\t\tjson: {}\n\t\t\t\t},\n\t\t\t\theader: {\n\t\t\t\t\ttype: \"Numeric\",\n\t\t\t\t\ttitle: kpiDefinition.datapoint.title,\n\t\t\t\t\tsubTitle: kpiDefinition.datapoint.description,\n\t\t\t\t\tunitOfMeasurement: \"{mainUnit}\",\n\t\t\t\t\tmainIndicator: {\n\t\t\t\t\t\tnumber: \"{mainValueNoScale}\",\n\t\t\t\t\t\tunit: \"{mainValueScale}\",\n\t\t\t\t\t\tstate: \"{mainState}\",\n\t\t\t\t\t\ttrend: \"{trend}\"\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tcontent: {\n\t\t\t\t\tminHeight: \"25rem\",\n\t\t\t\t\tchartProperties: {\n\t\t\t\t\t\tplotArea: {},\n\t\t\t\t\t\ttitle: {\n\t\t\t\t\t\t\tvisible: true,\n\t\t\t\t\t\t\talignment: \"left\"\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tpath: \"/chartData\"\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\t// Add side indicators in the card header if a target is defined for the KPI\n\t\tif (kpiDefinition.datapoint.targetPath || kpiDefinition.datapoint.targetValue !== undefined) {\n\t\t\tconst resBundle = Library.getResourceBundleFor(\"sap.fe.core\")!;\n\t\t\toCardManifest[\"sap.card\"].header.sideIndicators = [\n\t\t\t\t{\n\t\t\t\t\ttitle: resBundle.getText(\"C_KPICARD_INDICATOR_TARGET\"),\n\t\t\t\t\tnumber: \"{targetNumber}\",\n\t\t\t\t\tunit: \"{targetUnit}\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttitle: resBundle.getText(\"C_KPICARD_INDICATOR_DEVIATION\"),\n\t\t\t\t\tnumber: \"{deviationNumber}\",\n\t\t\t\t\tunit: \"%\"\n\t\t\t\t}\n\t\t\t];\n\t\t}\n\n\t\t// Details of the card: filter descriptions\n\t\tif (kpiDefinition.selectionVariantFilterDefinitions?.length) {\n\t\t\tconst aDescriptions: string[] = [];\n\t\t\tkpiDefinition.selectionVariantFilterDefinitions.forEach((filterDefinition) => {\n\t\t\t\tconst desc = getFilterStringFromDefinition(filterDefinition);\n\t\t\t\tif (desc) {\n\t\t\t\t\taDescriptions.push(desc);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (aDescriptions.length) {\n\t\t\t\toCardManifest[\"sap.card\"].header.details = aDescriptions.join(\", \");\n\t\t\t}\n\t\t}\n\n\t\t// Chart settings: type, title, dimensions and measures in the manifest\n\t\toCardManifest[\"sap.card\"].content.chartType = kpiDefinition.chart.chartType;\n\t\tupdateChartLabelSettings(kpiDefinition.chart, oCardManifest[\"sap.card\"].content.chartProperties);\n\t\toCardManifest[\"sap.card\"].content.chartProperties.title.text = formatChartTitle(kpiDefinition);\n\t\toCardManifest[\"sap.card\"].content.dimensions = kpiDefinition.chart.dimensions.map((dimension) => {\n\t\t\treturn { label: dimension.label, value: `{${dimension.name}}` };\n\t\t});\n\t\toCardManifest[\"sap.card\"].content.measures = kpiDefinition.chart.measures.map((measure) => {\n\t\t\treturn { label: measure.label, value: `{${measure.name}}` };\n\t\t});\n\t\toCardManifest[\"sap.card\"].content.feeds = getChartFeeds(kpiDefinition.chart);\n\n\t\toKPIModel.setProperty(`/${kpiDefinition.id}`, {\n\t\t\tmanifest: oCardManifest\n\t\t});\n\t}\n\n\tprotected async initNavigationInfo(\n\t\tkpiDefinition: AnalyticalKPIDefinition,\n\t\toKPIModel: JSONModel,\n\t\toShellService: IShellServices\n\t): Promise<void> {\n\t\t// Add navigation\n\t\tif (kpiDefinition.navigation) {\n\t\t\treturn getNavigationParameters(kpiDefinition.navigation, oShellService).then((oNavInfo) => {\n\t\t\t\tif (oNavInfo) {\n\t\t\t\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/header/actions`, [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: \"Navigation\",\n\t\t\t\t\t\t\tparameters: oNavInfo\n\t\t\t\t\t\t}\n\t\t\t\t\t]);\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t});\n\t\t} else {\n\t\t\treturn Promise.resolve();\n\t\t}\n\t}\n\n\t@methodOverride()\n\tpublic onInit(): void {\n\t\tthis.aKPIDefinitions = (this.getView().getController() as PageController)._getPageModel()?.getProperty(\"/kpiDefinitions\");\n\n\t\tif (this.aKPIDefinitions && this.aKPIDefinitions.length) {\n\t\t\tconst oView = this.getView();\n\t\t\tconst oAppComponent = (oView.getController() as BaseController).getAppComponent();\n\n\t\t\t// Create a JSON model to store KPI data\n\t\t\tconst oKPIModel = new JSONModel();\n\t\t\toView.setModel(oKPIModel, \"kpiModel\");\n\n\t\t\tthis.aKPIDefinitions.forEach((kpiDefinition) => {\n\t\t\t\t// We only need to worry about analytical KPI definition\n\t\t\t\tif (kpiDefinition.type === \"Analytical\") {\n\t\t\t\t\t// Create the manifest for the KPI card and store it in the KPI model\n\t\t\t\t\tthis.initCardManifest(kpiDefinition, oKPIModel);\n\n\t\t\t\t\t// Set the navigation information in the manifest\n\t\t\t\t\tthis.initNavigationInfo(kpiDefinition, oKPIModel, oAppComponent.getShellServices()).catch(function (err: string) {\n\t\t\t\t\t\tLog.error(err);\n\t\t\t\t\t});\n\n\t\t\t\t\t// Load tag data for the KPI\n\t\t\t\t\tthis.loadKPITagData(kpiDefinition, oAppComponent.getModel(), oKPIModel).catch(function (err: string) {\n\t\t\t\t\t\tLog.error(err);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\t@methodOverride()\n\tpublic onExit(): void {\n\t\tconst oKPIModel = this.getView().getModel(\"kpiModel\") as JSONModel;\n\n\t\tif (oKPIModel) {\n\t\t\toKPIModel.destroy();\n\t\t}\n\t}\n\n\tprivate updateDatapointValueAndCurrency(kpiDefinition: AnalyticalKPIDefinition, kpiContext: Context, oKPIModel: JSONModel): void {\n\t\tconst currentLocale = new Locale(Localization.getLanguage());\n\t\tconst rawUnit = kpiDefinition.datapoint.unit?.isPath\n\t\t\t? kpiContext.getProperty(kpiDefinition.datapoint.unit.value)\n\t\t\t: kpiDefinition.datapoint.unit?.value;\n\n\t\tconst isPercentage = kpiDefinition.datapoint.unit?.isCurrency === false && rawUnit === \"%\";\n\n\t\t// /////////////////////\n\t\t// Main KPI value\n\t\tconst rawValue = Number.parseFloat(kpiContext.getProperty(kpiDefinition.datapoint.propertyPath));\n\n\t\t// Value formatted with a scale\n\t\tconst kpiValue = NumberFormat.getFloatInstance(\n\t\t\t{\n\t\t\t\tstyle: isPercentage ? undefined : \"short\",\n\t\t\t\tminFractionDigits: 0,\n\t\t\t\tmaxFractionDigits: kpiDefinition.datapoint.numberOfFractionalDigits ?? 1,\n\t\t\t\tshowScale: !isPercentage\n\t\t\t},\n\t\t\tcurrentLocale\n\t\t).format(rawValue);\n\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/mainValue`, kpiValue);\n\n\t\t// Value without a scale\n\t\tconst kpiValueUnscaled = NumberFormat.getFloatInstance(\n\t\t\t{\n\t\t\t\tmaxFractionDigits: kpiDefinition.datapoint.numberOfFractionalDigits ?? 2,\n\t\t\t\tshowScale: false,\n\t\t\t\tgroupingEnabled: true\n\t\t\t},\n\t\t\tcurrentLocale\n\t\t).format(rawValue);\n\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/mainValueUnscaled`, kpiValueUnscaled);\n\n\t\t// Value formatted with the scale omitted\n\t\tconst kpiValueNoScale = NumberFormat.getFloatInstance(\n\t\t\t{\n\t\t\t\tstyle: isPercentage ? undefined : \"short\",\n\t\t\t\tminFractionDigits: 0,\n\t\t\t\tmaxFractionDigits: kpiDefinition.datapoint.numberOfFractionalDigits ?? 1,\n\t\t\t\tshowScale: false\n\t\t\t},\n\t\t\tcurrentLocale\n\t\t).format(rawValue);\n\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/mainValueNoScale`, kpiValueNoScale);\n\n\t\t// Scale of the value\n\t\tconst kpiValueScale = NumberFormat.getFloatInstance(\n\t\t\t{\n\t\t\t\tstyle: isPercentage ? undefined : \"short\",\n\t\t\t\tdecimals: 0,\n\t\t\t\tmaxIntegerDigits: 0,\n\t\t\t\tshowScale: true\n\t\t\t},\n\t\t\tcurrentLocale\n\t\t).format(rawValue);\n\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/mainValueScale`, kpiValueScale);\n\n\t\t// /////////////////////\n\t\t// Unit or currency\n\t\tif (kpiDefinition.datapoint.unit && rawUnit) {\n\t\t\tif (kpiDefinition.datapoint.unit.isCurrency) {\n\t\t\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/mainUnit`, rawUnit);\n\t\t\t} else {\n\t\t\t\t// In case of unit of measure, we have to format it properly\n\t\t\t\tconst kpiUnit = NumberFormat.getUnitInstance({ showNumber: false }, currentLocale).format(rawValue, rawUnit);\n\t\t\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/mainUnit`, kpiUnit);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate updateDatapointCriticality(kpiDefinition: AnalyticalKPIDefinition, kpiContext: Context, oKPIModel: JSONModel): void {\n\t\tconst rawValue = Number.parseFloat(kpiContext.getProperty(kpiDefinition.datapoint.propertyPath));\n\n\t\tlet criticalityValue = MessageType.None;\n\t\tif (kpiDefinition.datapoint.criticalityValue != null) {\n\t\t\t// Criticality is a fixed value\n\t\t\tcriticalityValue = kpiDefinition.datapoint.criticalityValue;\n\t\t} else if (kpiDefinition.datapoint.criticalityPath) {\n\t\t\t// Criticality comes from another property (via a path)\n\t\t\tcriticalityValue =\n\t\t\t\tMessageTypeFromCriticality[kpiContext.getProperty(kpiDefinition.datapoint.criticalityPath)] || MessageType.None;\n\t\t} else if (kpiDefinition.datapoint.criticalityCalculationThresholds && kpiDefinition.datapoint.criticalityCalculationMode != null) {\n\t\t\t// Criticality calculation\n\t\t\tswitch (kpiDefinition.datapoint.criticalityCalculationMode) {\n\t\t\t\tcase \"UI.ImprovementDirectionType/Target\":\n\t\t\t\t\tcriticalityValue = messageTypeFromTargetCalculation(rawValue, kpiDefinition.datapoint.criticalityCalculationThresholds);\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"UI.ImprovementDirectionType/Minimize\":\n\t\t\t\t\tcriticalityValue = messageTypeFromMinimizeCalculation(\n\t\t\t\t\t\trawValue,\n\t\t\t\t\t\tkpiDefinition.datapoint.criticalityCalculationThresholds\n\t\t\t\t\t);\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"UI.ImprovementDirectionType/Maximize\":\n\t\t\t\tdefault:\n\t\t\t\t\tcriticalityValue = messageTypeFromMaximizeCalculation(\n\t\t\t\t\t\trawValue,\n\t\t\t\t\t\tkpiDefinition.datapoint.criticalityCalculationThresholds\n\t\t\t\t\t);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/mainCriticality`, criticalityValue);\n\t\toKPIModel.setProperty(\n\t\t\t`/${kpiDefinition.id}/manifest/sap.card/data/json/mainState`,\n\t\t\tValueColorFromMessageType[criticalityValue] || \"None\"\n\t\t);\n\t}\n\n\tprivate updateDatapointTrend(kpiDefinition: AnalyticalKPIDefinition, kpiContext: Context, oKPIModel: JSONModel): void {\n\t\tconst rawValue = Number.parseFloat(kpiContext.getProperty(kpiDefinition.datapoint.propertyPath));\n\n\t\tlet trendValue = \"None\";\n\n\t\tif (kpiDefinition.datapoint.trendValue) {\n\t\t\t// Trend is a fixed value\n\t\t\ttrendValue = kpiDefinition.datapoint.trendValue;\n\t\t} else if (kpiDefinition.datapoint.trendPath) {\n\t\t\t// Trend comes from another property via a path\n\t\t\ttrendValue = deviationIndicatorFromTrendType(kpiContext.getProperty(kpiDefinition.datapoint.trendPath));\n\t\t} else if (\n\t\t\tkpiDefinition.datapoint.trendCalculationReferenceValue !== undefined ||\n\t\t\tkpiDefinition.datapoint.trendCalculationReferencePath\n\t\t) {\n\t\t\t// Calculated trend\n\t\t\tlet trendReferenceValue: number;\n\t\t\tif (kpiDefinition.datapoint.trendCalculationReferenceValue !== undefined) {\n\t\t\t\ttrendReferenceValue = kpiDefinition.datapoint.trendCalculationReferenceValue;\n\t\t\t} else {\n\t\t\t\ttrendReferenceValue = Number.parseFloat(\n\t\t\t\t\tkpiContext.getProperty(kpiDefinition.datapoint.trendCalculationReferencePath || \"\")\n\t\t\t\t);\n\t\t\t}\n\t\t\ttrendValue = deviationIndicatorFromCalculation(\n\t\t\t\trawValue,\n\t\t\t\ttrendReferenceValue,\n\t\t\t\t!!kpiDefinition.datapoint.trendCalculationIsRelative,\n\t\t\t\tkpiDefinition.datapoint.trendCalculationTresholds\n\t\t\t);\n\t\t}\n\n\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/trend`, trendValue);\n\t}\n\n\tprivate updateTargetValue(kpiDefinition: AnalyticalKPIDefinition, kpiContext: Context, oKPIModel: JSONModel): void {\n\t\tif (kpiDefinition.datapoint.targetValue === undefined && kpiDefinition.datapoint.targetPath === undefined) {\n\t\t\treturn; // No target set for the KPI\n\t\t}\n\t\tconst rawValue = Number.parseFloat(kpiContext.getProperty(kpiDefinition.datapoint.propertyPath));\n\t\tconst currentLocale = new Locale(Localization.getLanguage());\n\n\t\tlet targetRawValue: number;\n\t\tif (kpiDefinition.datapoint.targetValue !== undefined) {\n\t\t\ttargetRawValue = kpiDefinition.datapoint.targetValue;\n\t\t} else {\n\t\t\ttargetRawValue = Number.parseFloat(kpiContext.getProperty(kpiDefinition.datapoint.targetPath || \"\"));\n\t\t}\n\t\tconst deviationRawValue = targetRawValue !== 0 ? ((rawValue - targetRawValue) / targetRawValue) * 100 : undefined;\n\n\t\t// Formatting\n\t\tconst targetValue = NumberFormat.getFloatInstance(\n\t\t\t{\n\t\t\t\tstyle: \"short\",\n\t\t\t\tminFractionDigits: 0,\n\t\t\t\tmaxFractionDigits: kpiDefinition.datapoint.numberOfFractionalDigits ?? 1, // Use the same precision as the main value\n\t\t\t\tshowScale: false\n\t\t\t},\n\t\t\tcurrentLocale\n\t\t).format(targetRawValue);\n\t\tconst targetScale = NumberFormat.getFloatInstance(\n\t\t\t{\n\t\t\t\tstyle: \"short\",\n\t\t\t\tdecimals: 0,\n\t\t\t\tmaxIntegerDigits: 0,\n\t\t\t\tshowScale: true\n\t\t\t},\n\t\t\tcurrentLocale\n\t\t).format(targetRawValue);\n\n\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/targetNumber`, targetValue);\n\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/targetUnit`, targetScale);\n\n\t\tif (deviationRawValue !== undefined) {\n\t\t\tconst deviationValue = NumberFormat.getFloatInstance(\n\t\t\t\t{\n\t\t\t\t\tminFractionDigits: 0,\n\t\t\t\t\tmaxFractionDigits: 1,\n\t\t\t\t\tshowScale: false\n\t\t\t\t},\n\t\t\t\tcurrentLocale\n\t\t\t).format(deviationRawValue);\n\t\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/deviationNumber`, deviationValue);\n\t\t} else {\n\t\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/deviationNumber`, \"N/A\");\n\t\t}\n\t}\n\n\t/**\n\t * Loads tag data for a KPI, and stores it in the JSON KPI model.\n\t * @param kpiDefinition The definition of the KPI.\n\t * @param oMainModel The model used to load the data.\n\t * @param oKPIModel The JSON model where the data will be stored\n\t * @param loadFull If not true, loads only data for the KPI tag\n\t * @returns The promise that is resolved when data is loaded.\n\t */\n\tprotected async loadKPITagData(\n\t\tkpiDefinition: AnalyticalKPIDefinition,\n\t\toMainModel: ODataModel,\n\t\toKPIModel: JSONModel,\n\t\tloadFull?: boolean\n\t): Promise<void | Context[]> {\n\t\t// If loadFull=false, then we're just loading data for the tag and we use the \"$auto.LongRunners\" groupID\n\t\t// If loadFull=true, we're loading data for the whole KPI (tag + card) and we use the \"$auto.Workers\" groupID\n\t\tconst oListBinding = loadFull\n\t\t\t? oMainModel.bindList(kpiDefinition.contextPath, undefined, undefined, undefined, { $$groupId: \"$auto.Workers\" })\n\t\t\t: oMainModel.bindList(kpiDefinition.contextPath, undefined, undefined, undefined, { $$groupId: \"$auto.LongRunners\" });\n\t\tconst oAggregate: Record<string, { unit?: string }> = {};\n\n\t\t// Main value + currency/unit\n\t\tif (kpiDefinition.datapoint.unit?.isPath) {\n\t\t\toAggregate[kpiDefinition.datapoint.propertyPath] = { unit: kpiDefinition.datapoint.unit.value };\n\t\t} else {\n\t\t\toAggregate[kpiDefinition.datapoint.propertyPath] = {};\n\t\t}\n\n\t\t// Property for criticality\n\t\tif (kpiDefinition.datapoint.criticalityPath) {\n\t\t\toAggregate[kpiDefinition.datapoint.criticalityPath] = {};\n\t\t}\n\n\t\t// Properties for trend and trend calculation\n\t\tif (loadFull) {\n\t\t\tif (kpiDefinition.datapoint.trendPath) {\n\t\t\t\toAggregate[kpiDefinition.datapoint.trendPath] = {};\n\t\t\t}\n\t\t\tif (kpiDefinition.datapoint.trendCalculationReferencePath) {\n\t\t\t\toAggregate[kpiDefinition.datapoint.trendCalculationReferencePath] = {};\n\t\t\t}\n\t\t\tif (kpiDefinition.datapoint.targetPath) {\n\t\t\t\toAggregate[kpiDefinition.datapoint.targetPath] = {};\n\t\t\t}\n\t\t}\n\n\t\toListBinding.setAggregation({ aggregate: oAggregate });\n\n\t\t// Manage SelectionVariant filters\n\t\tif (kpiDefinition.selectionVariantFilterDefinitions?.length) {\n\t\t\tconst aFilters = kpiDefinition.selectionVariantFilterDefinitions.map(createFilterFromDefinition).filter((filter) => {\n\t\t\t\treturn filter !== undefined;\n\t\t\t}) as Filter[];\n\t\t\toListBinding.filter(aFilters);\n\t\t}\n\n\t\treturn oListBinding.requestContexts(0, 1).then((aContexts: Context[]): void => {\n\t\t\tif (aContexts.length) {\n\t\t\t\tconst rawUnit = kpiDefinition.datapoint.unit?.isPath\n\t\t\t\t\t? aContexts[0].getProperty(kpiDefinition.datapoint.unit.value)\n\t\t\t\t\t: kpiDefinition.datapoint.unit?.value;\n\n\t\t\t\tif (kpiDefinition.datapoint.unit && !rawUnit) {\n\t\t\t\t\t// A unit/currency is defined, but its value is undefined --> multi-unit situation\n\t\t\t\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/mainValue`, \"*\");\n\t\t\t\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/mainValueUnscaled`, \"*\");\n\t\t\t\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/mainValueNoScale`, \"*\");\n\t\t\t\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/mainValueScale`, \"\");\n\t\t\t\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/mainUnit`, undefined);\n\t\t\t\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/mainCriticality`, MessageType.None);\n\t\t\t\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/mainState`, \"None\");\n\t\t\t\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/trend`, \"None\");\n\t\t\t\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/targetNumber`, undefined);\n\t\t\t\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/targetUnit`, undefined);\n\t\t\t\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/deviationNumber`, undefined);\n\t\t\t\t} else {\n\t\t\t\t\tthis.updateDatapointValueAndCurrency(kpiDefinition, aContexts[0], oKPIModel);\n\t\t\t\t\tthis.updateDatapointCriticality(kpiDefinition, aContexts[0], oKPIModel);\n\n\t\t\t\t\tif (loadFull) {\n\t\t\t\t\t\tthis.updateDatapointTrend(kpiDefinition, aContexts[0], oKPIModel);\n\t\t\t\t\t\tthis.updateTargetValue(kpiDefinition, aContexts[0], oKPIModel);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn;\n\t\t});\n\t}\n\n\t/**\n\t * Loads card data for a KPI, and stores it in the JSON KPI model.\n\t * @param kpiDefinition The definition of the KPI.\n\t * @param oMainModel The model used to load the data.\n\t * @param oKPIModel The JSON model where the data will be stored\n\t * @returns The promise that is resolved when data is loaded.\n\t */\n\tprotected async loadKPICardData(\n\t\tkpiDefinition: AnalyticalKPIDefinition,\n\t\toMainModel: ODataModel,\n\t\toKPIModel: JSONModel\n\t): Promise<void | Context[]> {\n\t\tconst oListBinding = oMainModel.bindList(kpiDefinition.contextPath, undefined, undefined, undefined, {\n\t\t\t$$groupId: \"$auto.Workers\"\n\t\t});\n\t\tconst oGroup: Record<string, { additionally?: string[] }> = {};\n\t\tconst oAggregate: Record<string, Object> = {};\n\n\t\tkpiDefinition.chart.dimensions.forEach((dimension) => {\n\t\t\toGroup[dimension.name] = {};\n\t\t\tif (dimension.text) {\n\t\t\t\t// Also load the text property if there's one (as an additional property)\n\t\t\t\toGroup[dimension.name].additionally = [dimension.text];\n\t\t\t}\n\t\t});\n\t\tkpiDefinition.chart.measures.forEach((measure) => {\n\t\t\toAggregate[measure.name] = {};\n\t\t});\n\t\toListBinding.setAggregation({\n\t\t\tgroup: oGroup,\n\t\t\taggregate: oAggregate\n\t\t});\n\n\t\t// Manage SelectionVariant filters\n\t\tif (kpiDefinition.selectionVariantFilterDefinitions?.length) {\n\t\t\tconst aFilters = kpiDefinition.selectionVariantFilterDefinitions.map(createFilterFromDefinition).filter((filter) => {\n\t\t\t\treturn filter !== undefined;\n\t\t\t}) as Filter[];\n\t\t\toListBinding.filter(aFilters);\n\t\t}\n\n\t\t// Sorting\n\t\tif (kpiDefinition.chart.sortOrder) {\n\t\t\toListBinding.sort(\n\t\t\t\tkpiDefinition.chart.sortOrder.map((sortInfo) => {\n\t\t\t\t\treturn new Sorter(sortInfo.name, sortInfo.descending);\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\n\t\tconst allContexts = await oListBinding.requestContexts(0, kpiDefinition.chart.maxItems);\n\t\tconst chartData = allContexts.map((oContext) => {\n\t\t\tconst oData: Record<string, unknown> = {};\n\t\t\tkpiDefinition.chart.dimensions.forEach((dimension) => {\n\t\t\t\t// We have to format the dimension value here, as the card doesn't support calculated bindings yet\n\t\t\t\tswitch (dimension.textArrangement) {\n\t\t\t\t\tcase \"TextOnly\":\n\t\t\t\t\t\toData[dimension.name] = oContext.getProperty(dimension.text!);\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase \"TextLast\":\n\t\t\t\t\t\toData[dimension.name] = valueFormatters.formatWithBrackets(\n\t\t\t\t\t\t\toContext.getProperty(dimension.name),\n\t\t\t\t\t\t\toContext.getProperty(dimension.text!)\n\t\t\t\t\t\t);\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase undefined:\n\t\t\t\t\t\t// No text arrangement\n\t\t\t\t\t\toData[dimension.name] = oContext.getProperty(dimension.name);\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tdefault:\n\t\t\t\t\t\t//Default should be TextFirst if there is a Text annotation and neither TextOnly nor TextLast are set\n\t\t\t\t\t\toData[dimension.name] = valueFormatters.formatWithBrackets(\n\t\t\t\t\t\t\toContext.getProperty(dimension.text!),\n\t\t\t\t\t\t\toContext.getProperty(dimension.name)\n\t\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t});\n\t\t\tkpiDefinition.chart.measures.forEach((measure) => {\n\t\t\t\toData[measure.name] = oContext.getProperty(measure.name);\n\t\t\t});\n\n\t\t\treturn oData;\n\t\t});\n\n\t\toKPIModel.setProperty(`/${kpiDefinition.id}/manifest/sap.card/data/json/chartData`, chartData);\n\t}\n\n\t/**\n\t * Gets the popover to display the KPI card\n\t * The popover and the contained card for the KPIs are created if necessary.\n\t * The popover is shared between all KPIs, so it's created only once.\n\t * @param oKPITag The tag that triggered the popover opening.\n\t * @returns The shared popover as a promise.\n\t */\n\tprotected async getPopover(oKPITag: GenericTag): Promise<Popover> {\n\t\tif (!this.oPopover) {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tLibrary.load({ name: \"sap/ui/integration\" })\n\t\t\t\t\t.then((): void => {\n\t\t\t\t\t\tsap.ui.require([\"sap/ui/integration/widgets/Card\", \"sap/ui/integration/Host\"], (...params: unknown[]) => {\n\t\t\t\t\t\t\tconst CardClass = params[0] as typeof CardType;\n\t\t\t\t\t\t\tconst Host = params[1] as typeof HostType;\n\t\t\t\t\t\t\tconst oHost = new Host();\n\n\t\t\t\t\t\t\toHost.attachAction((oEvent: Host$ActionEvent) => {\n\t\t\t\t\t\t\t\tconst sType = oEvent.getParameter(\"type\");\n\t\t\t\t\t\t\t\tconst oParams = oEvent.getParameter(\"parameters\") as {\n\t\t\t\t\t\t\t\t\tsemanticObject?: string;\n\t\t\t\t\t\t\t\t\taction: string;\n\t\t\t\t\t\t\t\t\toutbound: string;\n\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\tif (sType === \"Navigation\") {\n\t\t\t\t\t\t\t\t\tif (oParams.semanticObject) {\n\t\t\t\t\t\t\t\t\t\tthis.base._intentBasedNavigation.navigate(oParams.semanticObject, oParams.action);\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tthis.base._intentBasedNavigation.navigateOutbound(oParams.outbound);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tthis.oCard = new CardClass({\n\t\t\t\t\t\t\t\twidth: \"25rem\",\n\t\t\t\t\t\t\t\theight: \"auto\"\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tthis.oCard.setHost(oHost as unknown as Control);\n\n\t\t\t\t\t\t\tthis.oPopover = new Popover(\"kpi-Popover\", {\n\t\t\t\t\t\t\t\tshowHeader: false,\n\t\t\t\t\t\t\t\tplacement: \"Auto\",\n\t\t\t\t\t\t\t\tcontent: [this.oCard]\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\toKPITag.addDependent(this.oPopover); // The first clicked tag gets the popover as dependent\n\n\t\t\t\t\t\t\tresolve(this.oPopover);\n\t\t\t\t\t\t});\n\t\t\t\t\t\treturn;\n\t\t\t\t\t})\n\t\t\t\t\t.catch(function () {\n\t\t\t\t\t\treject();\n\t\t\t\t\t});\n\t\t\t});\n\t\t} else {\n\t\t\treturn Promise.resolve(this.oPopover);\n\t\t}\n\t}\n\n\tpublic async onKPIPressed(oKPITag: GenericTag, kpiID: string): Promise<void> {\n\t\tconst oKPIModel = oKPITag.getModel(\"kpiModel\") as JSONModel;\n\n\t\tif (this.aKPIDefinitions && this.aKPIDefinitions.length) {\n\t\t\tconst kpiDefinition = this.aKPIDefinitions.find(function (oDef) {\n\t\t\t\treturn (oDef as AnalyticalKPIDefinition).id === kpiID;\n\t\t\t}) as AnalyticalKPIDefinition | undefined;\n\n\t\t\tif (kpiDefinition) {\n\t\t\t\ttry {\n\t\t\t\t\tconst oModel = oKPITag.getModel() as ODataModel;\n\n\t\t\t\t\tconst popover = await this.getPopover(oKPITag);\n\t\t\t\t\t// Set the popover as modal while the card is loading (so that card rendering doesn't interfere with the popover and close it)\n\t\t\t\t\tpopover.setModal(true);\n\n\t\t\t\t\tthis.oCard.setManifest(oKPIModel.getProperty(`/${kpiID}/manifest`));\n\t\t\t\t\tthis.oCard.setPreviewMode(\"Abstract\"); // Display placeholders in the card until data is loaded\n\t\t\t\t\tpopover.openBy(oKPITag, false); // Open the popover immediately\n\n\t\t\t\t\tconst promises = [\n\t\t\t\t\t\tthis.loadKPITagData(kpiDefinition, oModel, oKPIModel, true),\n\t\t\t\t\t\tthis.loadKPICardData(kpiDefinition, oModel, oKPIModel)\n\t\t\t\t\t];\n\n\t\t\t\t\tawait Promise.all(promises);\n\t\t\t\t\tthis.oCard.attachEventOnce(\"stateChanged\", () => {\n\t\t\t\t\t\t// Once the card has been rendered, set the focus properly and set the popover as non-modal\n\t\t\t\t\t\t(this.oCard.getFocusDomRef() as HTMLElement)?.focus();\n\t\t\t\t\t\tpopover.setModal(false);\n\t\t\t\t\t});\n\t\t\t\t\tthis.oCard.setManifest(oKPIModel.getProperty(`/${kpiID}/manifest`));\n\t\t\t\t\tthis.oCard.refresh();\n\t\t\t\t\tthis.oCard.setPreviewMode(\"Off\"); // Display real data in the card\n\t\t\t\t} catch (err) {\n\t\t\t\t\tLog.error(err as string);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport default KPIManagementControllerExtension;\n"],"mappings":"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","ignoreList":[]}