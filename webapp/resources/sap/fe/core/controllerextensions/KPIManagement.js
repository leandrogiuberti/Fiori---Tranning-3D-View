/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/i18n/Localization","sap/fe/base/ClassSupport","sap/fe/core/formatters/ValueFormatter","sap/m/Popover","sap/ui/core/Lib","sap/ui/core/Locale","sap/ui/core/format/DateFormat","sap/ui/core/format/NumberFormat","sap/ui/core/message/MessageType","sap/ui/core/mvc/ControllerExtension","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/model/json/JSONModel"],function(e,t,a,n,i,r,o,s,l,c,d,u,p,f){"use strict";var m,g,h,y,P;var b=a.methodOverride;var v=a.defineUI5Class;function D(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,C(e,t)}function C(e,t){return C=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},C(e,t)}function I(e,t,a,n,i){var r={};return Object.keys(n).forEach(function(e){r[e]=n[e]}),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=a.slice().reverse().reduce(function(a,n){return n(e,t,a)||a},r),i&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(i):void 0,r.initializer=void 0),void 0===r.initializer?(Object.defineProperty(e,t,r),null):r}const N={1:c.Error,2:c.Warning,3:c.Success,5:c.Information};const x={Error:"Error",Warning:"Critical",Success:"Good",Information:"None",None:"None"};function $(e,t){let a;if(t[0]!==undefined&&t[0]!==null&&e<t[0]){a=c.Error}else if(t[1]!==undefined&&t[1]!==null&&e<t[1]){a=c.Warning}else if(t[2]!==undefined&&t[2]!==null&&e<t[2]){a=c.None}else if(t[5]!==undefined&&t[5]!==null&&e>t[5]){a=c.Error}else if(t[4]!==undefined&&t[4]!==null&&e>t[4]){a=c.Warning}else if(t[3]!==undefined&&t[3]!==null&&e>t[3]){a=c.None}else{a=c.Success}return a}function T(e,t){let a;if(t[2]!==undefined&&t[2]!==null&&e>t[2]){a=c.Error}else if(t[1]!==undefined&&t[1]!==null&&e>t[1]){a=c.Warning}else if(t[0]!==undefined&&t[0]!==null&&e>t[0]){a=c.None}else{a=c.Success}return a}function w(e,t){let a;if(t[0]!==undefined&&t[0]!==null&&e<t[0]){a=c.Error}else if(t[1]!==undefined&&t[1]!==null&&e<t[1]){a=c.Warning}else if(t[2]!==undefined&&t[2]!==null&&e<t[2]){a=c.None}else{a=c.Success}return a}function F(e){let t;switch(e){case 1:case"1":case 2:case"2":t="Up";break;case 4:case"4":case 5:case"5":t="Down";break;default:t="None"}return t}function A(e,t,a,n){let i;if(!n||a&&!t){return"None"}const r=a?(e-t)/t:e-t;if(n[0]!==undefined&&n[0]!==null&&r<=n[0]){i="Down"}else if(n[1]!==undefined&&n[1]!==null&&r<=n[1]){i="Down"}else if(n[3]!==undefined&&n[3]!==null&&r>=n[3]){i="Up"}else if(n[2]!==undefined&&n[2]!==null&&r>=n[2]){i="Up"}else{i="None"}return i}function S(e){if(e.ranges.length===0){return undefined}else if(e.ranges.length===1){return new u(e.propertyPath,e.ranges[0].operator,e.ranges[0].rangeLow,e.ranges[0].rangeHigh)}else{const t=e.ranges.map(t=>new u(e.propertyPath,t.operator,t.rangeLow,t.rangeHigh));return new u({filters:t,and:false})}}function j(e){const a=new o(t.getLanguage());const n=r.getResourceBundleFor("sap.fe.core");const i=s.getDateInstance({style:"medium"},a);function l(t){const a=e.propertyType.indexOf("Edm.Date")===0?i.format(new Date(t.rangeLow)):t.rangeLow;const r=e.propertyType.indexOf("Edm.Date")===0&&t.rangeHigh!==undefined?i.format(new Date(t.rangeHigh)):t.rangeHigh;switch(t.operator){case"BT":return`[${a} - ${r}]`;case"Contains":return`*${a}*`;case"GE":return`≥${a}`;case"GT":return`>${a}`;case"LE":return`≤${a}`;case"LT":return`<${a}`;case"NB":return n.getText("C_KPICARD_FILTERSTRING_NOT",[`[${a} - ${r}]`]);case"NE":return`≠${a}`;case"NotContains":return n.getText("C_KPICARD_FILTERSTRING_NOT",[`*${a}*`]);case"EQ":default:return a}}if(e.ranges.length===0){return""}else if(e.ranges.length===1){return l(e.ranges[0])}else{return`(${e.ranges.map(l).join(",")})`}}function O(e){const t=r.getResourceBundleFor("sap.fe.core");function a(e){if(e.length===0){return""}else if(e.length===1){return e[0].label}else{let a=e[0].label;for(let t=1;t<e.length-1;t++){a+=`, ${e[t].label}`}return t.getText("C_KPICARD_ITEMSLIST",[a,e[e.length-1].label])}}return e.chart.title??t.getText("C_KPICARD_CHARTTITLE",[a(e.chart.measures),a(e.chart.dimensions)])}function V(e,t){switch(e.chartType){case"Donut":t.categoryAxis={title:{visible:false}};t.valueAxis={title:{visible:false},label:{formatString:"ShortFloat"}};t.plotArea.dataLabel={visible:true,type:"value",formatString:"ShortFloat_MFD2"};break;case"bubble":t.valueAxis={title:{visible:true},label:{formatString:"ShortFloat"}};t.valueAxis2={title:{visible:true},label:{formatString:"ShortFloat"}};t.legendGroup={layout:{position:"bottom",alignment:"topLeft"}};t.sizeLegend={visible:true};t.plotArea.dataLabel={visible:false};break;case"scatter":t.valueAxis={title:{visible:false},label:{formatString:"ShortFloat"}};t.valueAxis2={title:{visible:false},label:{formatString:"ShortFloat"}};t.plotArea.dataLabel={visible:false};break;default:t.categoryAxis={title:{visible:false}};t.valueAxis={title:{visible:false},label:{formatString:"ShortFloat"}};t.plotArea.dataLabel={visible:false}}}function M(e,t){if(t&&t.length){return e.filter(e=>t.includes(e.role)).map(e=>e.label)}else{return e.map(e=>e.label)}}function E(e){const t=M(e.measures,["Axis1"]);const a=M(e.measures,["Axis2"]);const n=M(e.measures,["Axis3"]);const i=M(e.measures,[undefined]);const r=M(e.dimensions,["Series"]);const o=e.dimensions.find(e=>e.role==="Category");const s=t.shift()||a.shift()||n.shift()||i.shift()||"";const l=a.shift()||t.shift()||n.shift()||i.shift()||"";const c=[{uid:"valueAxis",type:"Measure",values:[s]},{uid:"valueAxis2",type:"Measure",values:[l]}];if(e.chartType==="bubble"){const e=n.shift()||t.shift()||a.shift()||i.shift()||"";c.push({uid:"bubbleWidth",type:"Measure",values:[e]})}if(r.length){c.push({uid:"color",type:"Dimension",values:r})}if(o){c.push({uid:"shape",type:"Dimension",values:[o.label]})}return c}function L(e){let t;switch(e.chartType){case"Donut":t=[{uid:"size",type:"Measure",values:M(e.measures)},{uid:"color",type:"Dimension",values:M(e.dimensions)}];break;case"bubble":case"scatter":t=E(e);break;case"vertical_bullet":t=[{uid:"actualValues",type:"Measure",values:M(e.measures,[undefined,"Axis1"])},{uid:"targetValues",type:"Measure",values:M(e.measures,["Axis2"])},{uid:"categoryAxis",type:"Dimension",values:M(e.dimensions,[undefined,"Category"])},{uid:"color",type:"Dimension",values:M(e.dimensions,["Series"])}];break;default:t=[{uid:"valueAxis",type:"Measure",values:M(e.measures)},{uid:"categoryAxis",type:"Dimension",values:M(e.dimensions,[undefined,"Category"])},{uid:"color",type:"Dimension",values:M(e.dimensions,["Series"])}]}return t}async function R(e,t){if(e.semanticObject){if(e.action){return t.getLinks([{semanticObject:e.semanticObject,action:e.action}]).then(t=>t.length&&t[0].length?{semanticObject:e.semanticObject,action:e.action}:undefined)}else{return t.getPrimaryIntent(e.semanticObject).then(a=>{if(!a){return undefined}const n=t.parseShellHash(a.intent);return e.unavailableActions&&e.unavailableActions.includes(n.action)?undefined:{semanticObject:n.semanticObject,action:n.action}})}}else{return e.outboundNavigation?Promise.resolve({outbound:e.outboundNavigation}):Promise.resolve(undefined)}}let k=(m=v("sap.fe.core.controllerextensions.KPIManagement"),g=b(),h=b(),m(y=(P=function(a){function s(){return a.call(this)||this}D(s,a);var d=s.prototype;d.initCardManifest=function e(t,a){const n={"sap.app":{id:"sap.fe.KPICard",type:"card"},"sap.ui":{technology:"UI5"},"sap.card":{type:"Analytical",data:{json:{}},header:{type:"Numeric",title:t.datapoint.title,subTitle:t.datapoint.description,unitOfMeasurement:"{mainUnit}",mainIndicator:{number:"{mainValueNoScale}",unit:"{mainValueScale}",state:"{mainState}",trend:"{trend}"}},content:{minHeight:"25rem",chartProperties:{plotArea:{},title:{visible:true,alignment:"left"}},data:{path:"/chartData"}}}};if(t.datapoint.targetPath||t.datapoint.targetValue!==undefined){const e=r.getResourceBundleFor("sap.fe.core");n["sap.card"].header.sideIndicators=[{title:e.getText("C_KPICARD_INDICATOR_TARGET"),number:"{targetNumber}",unit:"{targetUnit}"},{title:e.getText("C_KPICARD_INDICATOR_DEVIATION"),number:"{deviationNumber}",unit:"%"}]}if(t.selectionVariantFilterDefinitions?.length){const e=[];t.selectionVariantFilterDefinitions.forEach(t=>{const a=j(t);if(a){e.push(a)}});if(e.length){n["sap.card"].header.details=e.join(", ")}}n["sap.card"].content.chartType=t.chart.chartType;V(t.chart,n["sap.card"].content.chartProperties);n["sap.card"].content.chartProperties.title.text=O(t);n["sap.card"].content.dimensions=t.chart.dimensions.map(e=>({label:e.label,value:`{${e.name}}`}));n["sap.card"].content.measures=t.chart.measures.map(e=>({label:e.label,value:`{${e.name}}`}));n["sap.card"].content.feeds=L(t.chart);a.setProperty(`/${t.id}`,{manifest:n})};d.initNavigationInfo=async function e(t,a,n){if(t.navigation){return R(t.navigation,n).then(e=>{if(e){a.setProperty(`/${t.id}/manifest/sap.card/header/actions`,[{type:"Navigation",parameters:e}])}return})}else{return Promise.resolve()}};d.onInit=function t(){this.aKPIDefinitions=this.getView().getController()._getPageModel()?.getProperty("/kpiDefinitions");if(this.aKPIDefinitions&&this.aKPIDefinitions.length){const t=this.getView();const a=t.getController().getAppComponent();const n=new f;t.setModel(n,"kpiModel");this.aKPIDefinitions.forEach(t=>{if(t.type==="Analytical"){this.initCardManifest(t,n);this.initNavigationInfo(t,n,a.getShellServices()).catch(function(t){e.error(t)});this.loadKPITagData(t,a.getModel(),n).catch(function(t){e.error(t)})}})}};d.onExit=function e(){const t=this.getView().getModel("kpiModel");if(t){t.destroy()}};d.updateDatapointValueAndCurrency=function e(a,n,i){const r=new o(t.getLanguage());const s=a.datapoint.unit?.isPath?n.getProperty(a.datapoint.unit.value):a.datapoint.unit?.value;const c=a.datapoint.unit?.isCurrency===false&&s==="%";const d=Number.parseFloat(n.getProperty(a.datapoint.propertyPath));const u=l.getFloatInstance({style:c?undefined:"short",minFractionDigits:0,maxFractionDigits:a.datapoint.numberOfFractionalDigits??1,showScale:!c},r).format(d);i.setProperty(`/${a.id}/manifest/sap.card/data/json/mainValue`,u);const p=l.getFloatInstance({maxFractionDigits:a.datapoint.numberOfFractionalDigits??2,showScale:false,groupingEnabled:true},r).format(d);i.setProperty(`/${a.id}/manifest/sap.card/data/json/mainValueUnscaled`,p);const f=l.getFloatInstance({style:c?undefined:"short",minFractionDigits:0,maxFractionDigits:a.datapoint.numberOfFractionalDigits??1,showScale:false},r).format(d);i.setProperty(`/${a.id}/manifest/sap.card/data/json/mainValueNoScale`,f);const m=l.getFloatInstance({style:c?undefined:"short",decimals:0,maxIntegerDigits:0,showScale:true},r).format(d);i.setProperty(`/${a.id}/manifest/sap.card/data/json/mainValueScale`,m);if(a.datapoint.unit&&s){if(a.datapoint.unit.isCurrency){i.setProperty(`/${a.id}/manifest/sap.card/data/json/mainUnit`,s)}else{const e=l.getUnitInstance({showNumber:false},r).format(d,s);i.setProperty(`/${a.id}/manifest/sap.card/data/json/mainUnit`,e)}}};d.updateDatapointCriticality=function e(t,a,n){const i=Number.parseFloat(a.getProperty(t.datapoint.propertyPath));let r=c.None;if(t.datapoint.criticalityValue!=null){r=t.datapoint.criticalityValue}else if(t.datapoint.criticalityPath){r=N[a.getProperty(t.datapoint.criticalityPath)]||c.None}else if(t.datapoint.criticalityCalculationThresholds&&t.datapoint.criticalityCalculationMode!=null){switch(t.datapoint.criticalityCalculationMode){case"UI.ImprovementDirectionType/Target":r=$(i,t.datapoint.criticalityCalculationThresholds);break;case"UI.ImprovementDirectionType/Minimize":r=T(i,t.datapoint.criticalityCalculationThresholds);break;case"UI.ImprovementDirectionType/Maximize":default:r=w(i,t.datapoint.criticalityCalculationThresholds);break}}n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainCriticality`,r);n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainState`,x[r]||"None")};d.updateDatapointTrend=function e(t,a,n){const i=Number.parseFloat(a.getProperty(t.datapoint.propertyPath));let r="None";if(t.datapoint.trendValue){r=t.datapoint.trendValue}else if(t.datapoint.trendPath){r=F(a.getProperty(t.datapoint.trendPath))}else if(t.datapoint.trendCalculationReferenceValue!==undefined||t.datapoint.trendCalculationReferencePath){let e;if(t.datapoint.trendCalculationReferenceValue!==undefined){e=t.datapoint.trendCalculationReferenceValue}else{e=Number.parseFloat(a.getProperty(t.datapoint.trendCalculationReferencePath||""))}r=A(i,e,!!t.datapoint.trendCalculationIsRelative,t.datapoint.trendCalculationTresholds)}n.setProperty(`/${t.id}/manifest/sap.card/data/json/trend`,r)};d.updateTargetValue=function e(a,n,i){if(a.datapoint.targetValue===undefined&&a.datapoint.targetPath===undefined){return}const r=Number.parseFloat(n.getProperty(a.datapoint.propertyPath));const s=new o(t.getLanguage());let c;if(a.datapoint.targetValue!==undefined){c=a.datapoint.targetValue}else{c=Number.parseFloat(n.getProperty(a.datapoint.targetPath||""))}const d=c!==0?(r-c)/c*100:undefined;const u=l.getFloatInstance({style:"short",minFractionDigits:0,maxFractionDigits:a.datapoint.numberOfFractionalDigits??1,showScale:false},s).format(c);const p=l.getFloatInstance({style:"short",decimals:0,maxIntegerDigits:0,showScale:true},s).format(c);i.setProperty(`/${a.id}/manifest/sap.card/data/json/targetNumber`,u);i.setProperty(`/${a.id}/manifest/sap.card/data/json/targetUnit`,p);if(d!==undefined){const e=l.getFloatInstance({minFractionDigits:0,maxFractionDigits:1,showScale:false},s).format(d);i.setProperty(`/${a.id}/manifest/sap.card/data/json/deviationNumber`,e)}else{i.setProperty(`/${a.id}/manifest/sap.card/data/json/deviationNumber`,"N/A")}};d.loadKPITagData=async function e(t,a,n,i){const r=i?a.bindList(t.contextPath,undefined,undefined,undefined,{$$groupId:"$auto.Workers"}):a.bindList(t.contextPath,undefined,undefined,undefined,{$$groupId:"$auto.LongRunners"});const o={};if(t.datapoint.unit?.isPath){o[t.datapoint.propertyPath]={unit:t.datapoint.unit.value}}else{o[t.datapoint.propertyPath]={}}if(t.datapoint.criticalityPath){o[t.datapoint.criticalityPath]={}}if(i){if(t.datapoint.trendPath){o[t.datapoint.trendPath]={}}if(t.datapoint.trendCalculationReferencePath){o[t.datapoint.trendCalculationReferencePath]={}}if(t.datapoint.targetPath){o[t.datapoint.targetPath]={}}}r.setAggregation({aggregate:o});if(t.selectionVariantFilterDefinitions?.length){const e=t.selectionVariantFilterDefinitions.map(S).filter(e=>e!==undefined);r.filter(e)}return r.requestContexts(0,1).then(e=>{if(e.length){const a=t.datapoint.unit?.isPath?e[0].getProperty(t.datapoint.unit.value):t.datapoint.unit?.value;if(t.datapoint.unit&&!a){n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainValue`,"*");n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainValueUnscaled`,"*");n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainValueNoScale`,"*");n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainValueScale`,"");n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainUnit`,undefined);n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainCriticality`,c.None);n.setProperty(`/${t.id}/manifest/sap.card/data/json/mainState`,"None");n.setProperty(`/${t.id}/manifest/sap.card/data/json/trend`,"None");n.setProperty(`/${t.id}/manifest/sap.card/data/json/targetNumber`,undefined);n.setProperty(`/${t.id}/manifest/sap.card/data/json/targetUnit`,undefined);n.setProperty(`/${t.id}/manifest/sap.card/data/json/deviationNumber`,undefined)}else{this.updateDatapointValueAndCurrency(t,e[0],n);this.updateDatapointCriticality(t,e[0],n);if(i){this.updateDatapointTrend(t,e[0],n);this.updateTargetValue(t,e[0],n)}}}return})};d.loadKPICardData=async function e(t,a,i){const r=a.bindList(t.contextPath,undefined,undefined,undefined,{$$groupId:"$auto.Workers"});const o={};const s={};t.chart.dimensions.forEach(e=>{o[e.name]={};if(e.text){o[e.name].additionally=[e.text]}});t.chart.measures.forEach(e=>{s[e.name]={}});r.setAggregation({group:o,aggregate:s});if(t.selectionVariantFilterDefinitions?.length){const e=t.selectionVariantFilterDefinitions.map(S).filter(e=>e!==undefined);r.filter(e)}if(t.chart.sortOrder){r.sort(t.chart.sortOrder.map(e=>new p(e.name,e.descending)))}const l=await r.requestContexts(0,t.chart.maxItems);const c=l.map(e=>{const a={};t.chart.dimensions.forEach(t=>{switch(t.textArrangement){case"TextOnly":a[t.name]=e.getProperty(t.text);break;case"TextLast":a[t.name]=n.formatWithBrackets(e.getProperty(t.name),e.getProperty(t.text));break;case undefined:a[t.name]=e.getProperty(t.name);break;default:a[t.name]=n.formatWithBrackets(e.getProperty(t.text),e.getProperty(t.name))}});t.chart.measures.forEach(t=>{a[t.name]=e.getProperty(t.name)});return a});i.setProperty(`/${t.id}/manifest/sap.card/data/json/chartData`,c)};d.getPopover=async function e(t){var a=this;if(!this.oPopover){return new Promise((e,n)=>{r.load({name:"sap/ui/integration"}).then(()=>{sap.ui.require(["sap/ui/integration/widgets/Card","sap/ui/integration/Host"],function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++){r[o]=arguments[o]}const s=r[0];const l=r[1];const c=new l;c.attachAction(e=>{const t=e.getParameter("type");const n=e.getParameter("parameters");if(t==="Navigation"){if(n.semanticObject){a.base._intentBasedNavigation.navigate(n.semanticObject,n.action)}else{a.base._intentBasedNavigation.navigateOutbound(n.outbound)}}});a.oCard=new s({width:"25rem",height:"auto"});a.oCard.setHost(c);a.oPopover=new i("kpi-Popover",{showHeader:false,placement:"Auto",content:[a.oCard]});t.addDependent(a.oPopover);e(a.oPopover)});return}).catch(function(){n()})})}else{return Promise.resolve(this.oPopover)}};d.onKPIPressed=async function t(a,n){const i=a.getModel("kpiModel");if(this.aKPIDefinitions&&this.aKPIDefinitions.length){const t=this.aKPIDefinitions.find(function(e){return e.id===n});if(t){try{const e=a.getModel();const r=await this.getPopover(a);r.setModal(true);this.oCard.setManifest(i.getProperty(`/${n}/manifest`));this.oCard.setPreviewMode("Abstract");r.openBy(a,false);const o=[this.loadKPITagData(t,e,i,true),this.loadKPICardData(t,e,i)];await Promise.all(o);this.oCard.attachEventOnce("stateChanged",()=>{this.oCard.getFocusDomRef()?.focus();r.setModal(false)});this.oCard.setManifest(i.getProperty(`/${n}/manifest`));this.oCard.refresh();this.oCard.setPreviewMode("Off")}catch(t){e.error(t)}}}};return s}(d),I(P.prototype,"onInit",[g],Object.getOwnPropertyDescriptor(P.prototype,"onInit"),P.prototype),I(P.prototype,"onExit",[h],Object.getOwnPropertyDescriptor(P.prototype,"onExit"),P.prototype),P))||y);return k},false);
//# sourceMappingURL=KPIManagement.js.map