/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/ClassSupport","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BaseControllerExtension","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/Feedback","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controllerextensions/editFlow/TransactionHelper","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/controllerextensions/editFlow/editFlowConstants","sap/fe/core/controllerextensions/editFlow/sticky","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/EditState","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/SemanticKeyHelper","sap/fe/core/library","sap/m/Button","sap/m/Dialog","sap/m/MessageToast","sap/m/Text","sap/ui/core/Element","sap/ui/core/Lib","sap/ui/core/Messaging","sap/ui/core/message/Message","sap/ui/core/message/MessageType","sap/ui/core/mvc/OverrideExecution","sap/ui/model/Filter","sap/ui/model/Sorter","../ActionRuntime","../controls/Recommendations/ConfirmRecommendationDialog","../converters/ManifestSettings","../helpers/TypeGuards","./editFlow/draftDataLossPopup","./routing/NavigationReason"],function(e,t,n,i,o,s,a,r,c,l,d,g,f,h,u,p,y,m,C,w,D,M,b,P,v,E,A,x,S,I,R,_,k,T,O){"use strict";var F,B,H,V,N,j,L,$,G,U,q,K,W,z,J,Q,X,Y,Z,ee,te,ne,ie,oe,se,ae,re,ce,le,de,ge,fe,he,ue,pe,ye,me,Ce,we,De,Me,be,Pe,ve,Ee,Ae,xe,Se;var Ie=k.isFulfilled;var Re=_.CreationMode;var _e=R.RecommendationDialogDecision;var ke=R.ConfirmRecommendationDialog;var Te=u.getResourceModel;var Oe=g.getInvolvedDataModelObjects;var Fe=g.convertTypes;var Be=a.Activity;var He=s.triggerConfiguredSurvey;var Ve=s.TriggerType;var Ne=s.StandardActions;var je=t.publicExtension;var Le=t.methodOverride;var $e=t.finalExtension;var Ge=t.extensible;var Ue=t.defineUI5Class;function qe(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,Ke(e,t)}function Ke(e,t){return Ke=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Ke(e,t)}function We(e,t,n,i,o){var s={};return Object.keys(i).forEach(function(e){s[e]=i[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=n.slice().reverse().reduce(function(n,i){return i(e,t,n)||n},s),o&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(o):void 0,s.initializer=void 0),void 0===s.initializer?(Object.defineProperty(e,t,s),null):s}const ze=y.ProgrammingModel,Je=y.Constants,Qe=y.DraftStatus,Xe=y.EditMode,Ye=y.StartupMode;let Ze=(F=Ue("sap.fe.core.controllerextensions.EditFlow"),B=Le(),H=je(),V=$e(),N=je(),j=$e(),L=je(),$=$e(),G=je(),U=Ge(A.After),q=je(),K=Ge("AfterAsync"),W=je(),z=Ge("AfterAsync"),J=je(),Q=Ge(A.After),X=je(),Y=Ge(A.After),Z=je(),ee=Ge("AfterAsync"),te=je(),ne=Ge(A.After),ie=je(),oe=Ge(A.After),se=je(),ae=Ge(A.After),re=je(),ce=Ge(A.After),le=je(),de=Ge(A.After),ge=je(),fe=$e(),he=je(),ue=$e(),pe=je(),ye=$e(),me=je(),Ce=$e(),we=je(),De=$e(),Me=je(),be=Ge(A.After),Pe=je(),ve=Ge(A.Instead),Ee=je(),Ae=$e(),F(xe=(Se=function(t){function i(){var n;for(var i=arguments.length,o=new Array(i),s=0;s<i;s++){o[s]=arguments[s]}n=t.call(this,...o)||this;n.syncTasks=Promise.resolve();n.handleSideEffects=async(t,i,o)=>{try{const e=await i;await e.created();n.requestSideEffectsForNavigationProperty(t,o??n.getView().getBindingContext())}catch(t){e.error("Error while creating the document",t)}};n.createCustomValidationMessages=(e,t)=>{const i=t.getCreationRow().data("customValidationFunction");const o=t.getBindingContext("internal")?.getProperty("creationRowCustomValidity");const s=[];let a;let r;const c=P.getMessageModel().getData().filter(e=>e.getCode()===i);P.removeMessages(c);e.forEach(e=>{if(e.messageTarget){a=M.getElementById(o[e.messageTarget].fieldId);r=`${a.getBindingContext()?.getPath()}/${a.getBindingPath("value")}`;if(!P.getMessageModel().getData().filter(e=>e.getTargets().some(e=>e===r)).length){P.addMessages(new v({message:e.messageText,processor:n.getView().getModel(),type:E.Error,code:i,technical:false,persistent:false,target:r}))}const t=P.getMessageModel().getData().filter(e=>e.getTargets().some(e=>e===r));t[0].addControlId(o[e.messageTarget].fieldId)}else{s.push({code:i,text:e.messageText,persistent:true,type:E.Error})}});if(s.length){n.getMessageHandler().showMessageDialog({customMessages:s})}};n.resolveCreationMode=(e,t,i)=>{if(e!==Re.NewPage){return e}else{const e=t.getModel().getMetaModel();const o=n.getProgrammingModel(t);if(!t.isRelative()){const n=Oe(e.getMetaContext(t.getPath()));const i=n.targetEntitySet,s=(o===ze.Draft?i?.annotations.Common?.DraftRoot:i?.annotations.Session?.StickySessionSupported)?.NewAction?.toString();if(s&&n.targetEntityType.actions[s].parameters.length>1){return Re.Deferred}}const s=n.getTransactionHelper().getCreationParameters(t,i,n.getAppComponent());if(s.length){return Re.Deferred}return Re.Async}};return n}qe(i,t);var s=i.prototype;s.onInit=function e(){this._hiddenDraft=this.getAppComponent().getEnvironmentCapabilities().getCapabilities().HiddenDraft};s.getInterface=function e(){return t.prototype.getInterface.call(this)};s.getAppComponent=function e(){return this.base.getAppComponent()};s.editDocument=async function t(n){const i=this.getTransactionHelper();const o=this._getRootViewController();const s=n.getModel();const a=this.getView().getViewData();const r=this.getProgrammingModel(n);const c="editGroup";const l=this.getMessageHandler().registerToHoldMessages();try{const e=await this.getRootContext(n);await this.base.editFlow.onBeforeEdit({context:e});let t=this._isFclEnabled()?o.getRightmostContext():n;if(t===undefined||r===ze.Draft&&this.getProgrammingModel(t)!==ze.Draft){t=n}const d={};const g=i.editDocument(e,this.base.getView(),this.getAppComponent(),this.getMessageHandler(),c,d);this.syncTask(g);const f={rootSiblingPathPromise:g};this._setStickySessionInternalProperties(r,s);let u;const p=t!==e||a?.viewLevel>1;if(p){u=this._computeSiblingInformation(e,t,r,true,f,c)}n.getModel().submitBatch(c);let y=await u;const m=await g;let C=m;if(p&&C){if(y===undefined){y=await this._computeSiblingInformation(e,t,r,true,f,"$auto")}C=this._getNavigationTargetForEdit(n,m,y)}else{this._updatePathsInHistory([])}let w=false;if(m){if(r!==ze.Sticky&&h.isCollaborationDraftSupported(s.getMetaModel())&&d.existingDraftReused!==true){this.base.collaborativeDraft.setInitialShare(true)}this.base.recommendations.resetRejectedRecommendations(C);await this.base.editFlow.onAfterEdit({context:C});await this._handleNewContext(C,{editable:true,recreateContext:false,forceFocus:true});if(r===ze.Sticky){let e;if(this._isFclEnabled()){e=m?.getModel().getKeepAliveContext(m.getPath())}else{e=m}await this.handleStickyOn(e)}else if(this._hiddenDraft){await this.handleHiddenDraftEdit(m)}w=true;this.setEditMode(Xe.Editable,false);this.setDocumentModified(false)}this.getMessageHandler().showMessageDialog({unHoldKey:l,overrideUIDecision:w});return C}catch(t){this.getMessageHandler().showMessageDialog({unHoldKey:l});e.error("Error while editing the document",t);return Promise.reject(t)}};s.requestSideEffectsOnDelete=function e(t,n){let i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(n&&this.requestSideEffectsForNavigationProperty(t,n,i)){const e=h.getMessagesPath(t.getModel().getMetaModel(),n.getPath());if(e&&this.getTransactionHelper().isListBindingHierarchical(t)){this.getAppComponent().getSideEffectsService().requestSideEffects([e],n)}}};s.requestSideEffectsForNavigationProperty=function e(t,i){let o=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(i){const e=h.getRelativeMetaPathForListBinding(i,t);if((o||!n.hasTransientContext(t))&&e){this.getAppComponent().getSideEffectsService().requestSideEffectsForNavigationProperty(e,i);return true}}return false};s.deleteMultipleDocuments=async function t(n,i){i.beforeDeleteCallBack=this.base.editFlow.onBeforeDelete;i.requestSideEffects=i.requestSideEffects!==false;let s;let a=false;const r=this.getGlobalUIModel();const c=this.getView().byId(i.controlId)??M.getElementById(i.controlId);let l=[];if(c?.isA("sap.ui.mdc.Table")){s=c.getParent();a=s.tableDefinition?.control?.creationMode===Re.InlineCreationRows;l=n.filter(e=>e.isInactive())}if(!c){throw new Error("parameter controlId missing or incorrect")}else{i.parentControl=c}const d=c.getBinding("items")||c.getRowBinding();i.bFindActiveContexts=true;o.lock(r);try{const e=await this.deleteDocumentTransaction(n,i);if(!e){return}if(this.getProgrammingModel(i?.selectedContexts?.[0]??n[0])===ze.Sticky){this.setDocumentModified(true)}let t;if(c.isA("sap.ui.mdc.Table")){c.clearSelection()}const o=this.getView().getBindingContext();if(d.isRoot()){t=this.getTransactionHelper().refreshListBinding(d,this.getAppComponent())}else if(i.requestSideEffects){this.requestSideEffectsOnDelete(d,o,a)}if(!this.getAppComponent()._isFclEnabled()){f.setEditStateDirty()}const r=this.base.recommendations.isRecommendationEnabled();if(r){this.base.recommendations.ignoreRecommendationForContexts(n)}n?.forEach(e=>this.base.recommendations.resetRejectedRecommendations(e));await this.base.editFlow.onAfterDelete({contexts:n});if(s){if(a&&l.length>0){s.removeEmptyRowsMessages(l);await s.setUpEmptyRows(s.getContent(),false)}}this._sendActivity(Be.Delete,n);return await t}catch(t){if(d.isRoot()){await this.getTransactionHelper().refreshListBinding(d,this.getAppComponent())}else if(i.requestSideEffects){const e=this.getView().getBindingContext();this.requestSideEffectsOnDelete(d,e,a)}e.error("Error while deleting the document(s)",t)}finally{o.unlock(r)}};s.updateDocument=async function t(n,i){const o=this.getView().getBindingContext();const s=this.getProgrammingModel(n)===ze.Draft;this.getMessageHandler().removeTransitionMessages();const a=this.getMessageHandler().registerToHoldMessages();return this.syncTask(async()=>{if(o){this.setDocumentModified(true);if(!this._isFclEnabled()){f.setEditStateDirty()}if(s){this.setDraftStatus(Qe.Saving)}}try{await i;const e=this.getView().getBindingContext();if(!s||!e||e!==o){return}const t=e.getModel().getMetaModel();const n=t.getMetaContext(e.getPath()).getObject("@sapui.name");const a=p.getSemanticKeys(t,n);if(a?.length&&e.getProperty("IsActiveEntity")===false&&e.getProperty("HasActiveEntity")===true){const t=this._getSemanticMapping();const n=t?.semanticPath,i=p.getSemanticPath(e,true);if(n&&n!==i){await this._handleNewContext(e,{editable:true,recreateContext:false})}}this.setDraftStatus(Qe.Saved)}catch(t){e.error("Error while updating the document",t);if(s&&o){this.setDraftStatus(Qe.Clear)}}finally{await this.getMessageHandler().showMessages({unHoldKey:a})}})};s.getParentContextFromSelection=function e(t){if(t&&t.length>1){throw new Error(`Cannot create a new document in a TreeTable with ${t.length} parents`)}return t?.length===1?t[0]:undefined};s.createDocument=async function e(t,n){let i;let o;const s=this.getView().getModel();let a;if(s&&h.isCollaborationDraftSupported(s.getMetaModel())){a="DraftAdministrativeData/DraftAdministrativeUser,IsActiveEntity,HasActiveEntity"}if(typeof t==="object"&&t.isA&&t.isA("sap.fe.core.IRowBindingInterface")){i=t.getRowBinding({$select:a,$$groupId:"$auto.Workers"});t=i}if(n.creationMode!==Re.External){if(typeof t==="string"){const e=this.getView().getModel()?.bindList(t,undefined,undefined,undefined,{$select:a,$$groupId:"$auto.Workers"});if(!e){return}else{i=e}delete n.createAtEnd}else if(typeof t==="object"&&t.isA&&t.isA("sap.ui.model.odata.v4.ODataListBinding")){i=t}else{throw new Error("Binding object or path expected")}if(this.getTransactionHelper().isListBindingHierarchical(i)){o=this.getParentContextFromSelection(n.selectedContexts)}}const r=this.resolveCreationMode(n.creationMode,i,n.data);this.getAppComponent().getRouterProxy().removeIAppStateKey();if((n.singleDraftForCreate!==undefined?n.singleDraftForCreate:this.getAppComponent().getManifest()["sap.fe"]?.app?.singleDraftForCreate)&&i===i.getRootBinding()&&i.getHeaderContext()!==null){const e=i.getModel()?.bindList(i.getPath(),i.getContext(),new S("DraftAdministrativeData/LastChangeDateTime",true),new x({filters:[new x({path:"IsActiveEntity",operator:"EQ",value1:false}),new x({path:"HasActiveEntity",operator:"EQ",value1:false})],and:true}));const s=await(e?.requestContexts(0,1));if(s.length>0){return this._handleNewContext(s[0],{editable:true,recreateContext:false}).then(()=>e?.destroy())}e?.destroy();return this._handleCreationMode(r,t,n,i,o)}return this._handleCreationMode(r,t,n,i,o)};s._handleCreationMode=async function e(t,n,i,o,s){await this.syncTask();this._updatePathsInHistory([]);switch(t){case Re.External:return this.createExternalDocument(n,i.outbound);case Re.Deferred:return this.createDeferredDocument(o,s,i.data);case Re.CreationRow:return i.creationRow?this.createCreateRowDocument({creationRow:i.creationRow,skipSideEffects:i.skipSideEffects,createAtEnd:i.createAtEnd}):undefined;case Re.Inline:return this.createDialogInlineDocument({creationMode:Re.Inline,tableId:i.tableId,createAtEnd:i.createAtEnd,skipSideEffects:i.skipSideEffects,parentContext:s,data:i.data},o);case Re.CreationDialog:if(o.isRelative()){return this.createDialogInlineDocument({creationMode:Re.CreationDialog,tableId:i.tableId,createAtEnd:i.createAtEnd,skipSideEffects:i.skipSideEffects,parentContext:s,data:i.data,creationDialogFields:i.creationDialogFields},o)}else{return this.createDialogAndSaveDocument({tableId:i.tableId,createAtEnd:i.createAtEnd,skipSideEffects:i.skipSideEffects,parentContext:s,data:i.data,creationDialogFields:i.creationDialogFields},o)}case Re.Sync:case Re.Async:return this.createSyncAsyncDocument({creationMode:t,data:i.data,bFromDeferred:i.bFromDeferred,skipSideEffects:i.skipSideEffects,createAction:i.createAction,parentContext:s},o);default:throw new Error(`Unhandled creationMode ${t}`)}};s.postDocumentCreation=async function e(t,n){const i=this.getProgrammingModel(n);const o=n.getModel();const s=await t;const a=s[0];this._setStickySessionInternalProperties(i,o);await this.base.editFlow.onAfterCreate({context:a});this.setEditMode(Xe.Editable);if(!n.isRelative()){if(i===ze.Sticky){const e=o.getMetaModel().getMetaContext(n.getPath());const t=Oe(e).startingEntitySet;const i=t?.annotations.Session?.StickySessionSupported?.NewAction;this.getInternalModel().setProperty("/lastInvokedAction",i)}else if(this.getTransactionHelper().isListBindingHierarchical(n)||this.getTransactionHelper().isListBindingAnalytical(n)){this.forceDraftSaveOrDiscard(true)}}if(a){if(this._hiddenDraft&&i===ze.Draft){await this.handleHiddenDraftEdit(a)}this.setDocumentModifiedOnCreate(n);if(!this._isFclEnabled()){f.setEditStateDirty()}this._sendActivity(Be.Create,a);if(h.isCollaborationDraftSupported(o.getMetaModel())&&this.isDraftRoot(a)&&!this.base.collaborativeDraft.isConnected()){this.base.collaborativeDraft.setInitialShare(true)}}};s.createCreateRowDocument=async function t(n){let i;const s=this.getAppComponent();const a=n.creationRow;const r=n.creationRow.getParent();let c=Promise.resolve();if(!r){return}const l=r.getModel()?.getMetaModel();const d=r.getRowBinding();if(this.getTransactionHelper().isListBindingHierarchical(d)){throw new Error(`Unhandled creationMode "CreationRow" with a TreeTable`)}const g=a.getBindingContext();const f=this.getCreationRowValidationFunction(r);if(a.data("disableAddRowButtonForEmptyData")==="true"){r.getBindingContext("internal")?.setProperty("creationRowFieldValidity",{})}const h=await this.syncTask(f);if(h.length>0){this.createCustomValidationMessages(h,r);e.error("Custom Validation failed");return}const u=Oe(l.getMetaContext(g.getPath())).targetEntityType;const p=g.getObject();await this._checkForValidationErrors();d.attachEventOnce("change",async()=>{await i;r.scrollToIndex(n.createAtEnd?r.getRowBinding().getLength():0)});this.handleCreateEvents(d);try{i=this.getTransactionHelper().createDocument(d,{data:Object.assign({},...Object.keys(p).filter(e=>u.navigationProperties.findIndex(t=>t.name===e)===-1).map(e=>({[e]:p[e]}))),keepTransientContextOnFailed:false,busyMode:"Local",busyId:r?.getParent()?.getTableDefinition()?.annotation.id,parentControl:this.getView(),beforeCreateCallBack:this.base.editFlow.onBeforeCreate,skipParameterDialog:s.getStartupMode()===Ye.AutoCreate,createAtEnd:n.createAtEnd,creationMode:Re.CreationRow},s,this._getResourceModel(),this.getMessageHandler(),false);if(!n.skipSideEffects){this.handleSideEffects(d,i)}await i;const t=g.getBinding();const o=t.create();a.setBindingContext(o);o.created()?.catch(()=>{e.trace("transient fast creation context deleted")});c=g.delete("$direct");return await this.postDocumentCreation(Promise.all([i,c]),d)}catch(t){if(o.isLocked(this.base.getView().getModel("ui"))){o.unlock(this.base.getView().getModel("ui"))}e.error("CreationRow navigation error: ",t)}};s.createDialogInlineDocument=async function e(t,n){let i;if(t.tableId){i=this.getView().byId(t.tableId)}if(i?.isA("sap.ui.mdc.Table")){i.getRowBinding().attachEventOnce("createCompleted",async()=>{const e=await o;const t=e.getIndex();const s=n.getAggregation();const a=s?.createInPlace??false;if(t!==undefined&&t>=0){setTimeout(function(){if(!i?.getBusy()){i?.focusRow(t,true)}},0)}else if(a){w.show(this._getResourceModel().getText("C_NEW_ELEMENT_NOT_DISPLAYED"))}if(this.getTransactionHelper().isListBindingHierarchical(n)&&!a){const t=e.getParent();const n=t?.getIndex();if(n!==undefined&&n>=0){i?.scrollToIndex(n)}}})}else{i=undefined}this.handleCreateEvents(n);const o=this.getTransactionHelper().createDocument(n,{keepTransientContextOnFailed:false,busyMode:"Local",busyId:i?.getParent()?.getTableDefinition()?.annotation.id,parentControl:this.getView(),beforeCreateCallBack:this.base.editFlow.onBeforeCreate,skipParameterDialog:this.getAppComponent().getStartupMode()===Ye.AutoCreate,createAtEnd:t.createAtEnd,creationMode:t.creationMode,parentContext:t.parentContext,data:t.data,creationDialogFields:t.creationDialogFields},this.getAppComponent(),this._getResourceModel(),this.getMessageHandler(),false);if(!t.skipSideEffects){this.handleSideEffects(n,o)}return this.postDocumentCreation(Promise.all([o,this.syncTask(o)]),n)};s.createDialogAndSaveDocument=async function t(n,i){let o;if(n.tableId){o=this.getView().byId(n.tableId);if(o?.isA("sap.ui.mdc.Table")!==true){o=undefined}}let s;const a=async t=>{try{await this.base.editFlow.onAfterCreate({context:t})}catch(t){e.error("Error after creation: "+t)}await this.base.editFlow.onBeforeSave({context:t});s=await this.getTransactionHelper().saveDocument(t,this.getAppComponent(),this._getResourceModel(),false,[],this.getMessageHandler(),true,true);try{await this.base.editFlow.onAfterSave({context:s})}catch(t){e.error("Error after save: "+t)}if(this.getTransactionHelper().isListBindingHierarchical(i)){const e=o?.getParent();if(e){const t=n.parentContext?.getIndex();e.refresh();if(t!==undefined&&t>=0){o?.scrollToIndex(t)}}}else{const e=s.getIndex();if(e!==undefined&&e>=0){o?.scrollToIndex(e)}}};const r=this.getTransactionHelper().createDocument(i,{keepTransientContextOnFailed:false,busyMode:"Local",busyId:o?.getParent()?.getTableDefinition()?.annotation.id,parentControl:this.getView(),beforeCreateCallBack:this.base.editFlow.onBeforeCreate,afterCreateCallBack:a,skipParameterDialog:this.getAppComponent().getStartupMode()===Ye.AutoCreate,createAtEnd:n.createAtEnd,creationMode:Re.CreationDialog,parentContext:n.parentContext,data:n.data,creationDialogFields:n.creationDialogFields},this.getAppComponent(),this._getResourceModel(),this.getMessageHandler(),false);await Promise.all([r,this.syncTask(r)]);if(s&&n.skipSideEffects!==true){this.requestSideEffectsForNavigationProperty(i,s)}};s.createDeferredDocument=async function e(t,n,i){const s=this.getGlobalUIModel();o.lock(s);await this.getInternalRouting().navigateForwardToContext(t,{createOnNavigateParameters:{mode:"Deferred",parentContext:n,listBinding:t,data:i},editable:true,forceFocus:true});o.unlock(s)};s.createSyncAsyncDocument=async function e(t,n){let i;const s=this.getGlobalUIModel();const a=this.getInternalRouting();o.lock(s);const r=this.getTransactionHelper().createDocument(n,{...t,...{parentControl:this.getView(),beforeCreateCallBack:this.base.editFlow.onBeforeCreate,skipParameterDialog:this.getAppComponent().getStartupMode()===Ye.AutoCreate}},this.getAppComponent(),this._getResourceModel(),this.getMessageHandler(),false).then(e=>{if(this._isFclEnabled()&&e&&e.getBinding()!==n){n.refresh()}return e});if((this._isFclEnabled()||t.bFromDeferred!==true)&&!t.skipSideEffects){this.handleSideEffects(n,r,t.bFromDeferred?n.getContext():undefined)}if(t.creationMode===Re.Async){i=a.navigateForwardToContext(n,{createOnNavigateParameters:{mode:"Async",createContextPromise:r},editable:true,forceFocus:true})}else{i=r.then(async e=>{if(!e){const e=b.getResourceBundleFor("sap.fe.core");return a.navigateToMessagePage(e.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"),{title:e.getText("C_COMMON_SAPFE_ERROR"),description:e.getText("C_EDITFLOW_SAPFE_CREATION_FAILED_DESCRIPTION")})}else{const i={editable:true,forceFocus:true,transient:this.getProgrammingModel(n)==ze.Sticky||t.createAction?true:undefined};return t.bFromDeferred?a.navigateToContext(e,i):a.navigateForwardToContext(e,i)}})}try{await this.postDocumentCreation(Promise.all([r,i]),n)}catch(e){if([Je.CancelActionDialog,Je.ActionExecutionFailed,Je.CreationFailed,Je.OnBeforeCreateFailed].includes(e instanceof Error?e.message:e)){this.getInternalRouting().navigateBackFromTransientState()}throw e}finally{o.unlock(s)}};s.createExternalDocument=async function e(t,n){if(n){if(typeof t!=="string"&&this.getTransactionHelper().isListBindingHierarchical(t)){throw new Error(`Unhandled creationMode "External" with a TreeTable`)}await this.syncTask();const e=this.getView().getController();const i=h.getAbsoluteMetaPathForListBinding(this.base.getView(),t);e._intentBasedNavigation.onChevronPressNavigateOutBound(e,n,undefined,i)}};s.validateDocument=async function e(t,n){return this.getTransactionHelper().validateDocument(t,n,this.getView())};s.getCreationRowValidationFunction=function e(t){const n=t?.getCreationRow();if(n&&t){return async()=>{const e=n.getBindingContext().getObject();delete e["@$ui5.context.isTransient"];return this.validateDocument(t.getBindingContext(),{data:e,customValidationFunction:t.getCreationRow().data("customValidationFunction")})}}return async()=>Promise.resolve([])};s.createMultipleDocuments=async function t(n,i,s,a,r){let c=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;let l=arguments.length>6?arguments[6]:undefined;let d=arguments.length>7?arguments[7]:undefined;const g=this.getTransactionHelper();const f=this.getGlobalUIModel();const h=n;l=l!==false;if(!c){o.lock(f)}try{await this.syncTask();const e=h.getModel().getMetaModel();let t;if(h.getContext()){t=e.getMetaPath(`${h.getContext().getPath()}/${h.getPath()}`)}else{t=e.getMetaPath(h.getPath())}this.handleCreateEvents(h);const o=i.map(async n=>{const i={data:{},parentControl:this.getView()};i.keepTransientContextOnFailed=false;i.creationMode=Re.CreationRow;i.createAtEnd=s;i.inactive=c;i.beforeCreateCallBack=r;for(const o in n){const s=e.getObject(`${t}/${o}`);if(s&&s.$kind!=="NavigationProperty"&&!o.includes("/")&&n[o]){i.data[o]=n[o]}}return g.createDocument(h,i,this.getAppComponent(),this._getResourceModel(),this.getMessageHandler(),a,d)});const f=await Promise.all(o);if(!c){this.setDocumentModifiedOnCreate(h)}const u=f.filter(e=>!e.isInactive());await Promise.all(u.map(async e=>e.created()));if(l){this.requestSideEffectsForNavigationProperty(n,this.base.getView().getBindingContext())}if(this.base.collaborativeDraft.isConnected()&&u.length>0){this._sendActivity(Be.Create,u)}return f}catch(t){e.error("Error while creating multiple documents.");throw t}finally{if(!c){o.unlock(f)}}};s.onBeforeCreate=async function e(t){return Promise.resolve()};s.onBeforeEdit=async function e(t){return Promise.resolve()};s.onBeforeSave=async function e(t){return Promise.resolve()};s.onBeforeDiscard=async function e(t){return Promise.resolve()};s.onBeforeDelete=async function e(t){return Promise.resolve()};s.onBeforeExecuteAction=async function e(t){return Promise.resolve()};s.onAfterSave=async function e(t){return Promise.resolve()};s.onAfterCreate=async function e(t){return Promise.resolve()};s.onAfterEdit=async function e(t){return Promise.resolve()};s.onAfterDiscard=async function e(t){return Promise.resolve()};s.onAfterDelete=async function e(t){return Promise.resolve()};s.saveDocument=async function t(n,i){if(!this.getGlobalUIModel().getProperty("/isEditable")&&this.base.inlineEditFlow?.isInlineEditPossible()&&this.getGlobalUIModel().getProperty("/isInlineEditActive")){this.base.inlineEditFlow.inlineEditSave();return}i=i||{};const o=i.bExecuteSideEffectsOnError||undefined;const s=this.getTransactionHelper();const a=i.bindings;const r=this.getMessageHandler().registerToHoldMessages();try{await this.syncTask();this.getMessageHandler().removeTransitionMessages();if(i.mergePatchDraft!==true){await this._submitOpenChanges(n)}await this._checkForValidationErrors();const e=await this.checkRecommendationOption();const t=await this.getRootContext(n);await this.base.editFlow.onBeforeSave({context:t});const c=this.getProgrammingModel(n);const l=this._getRootViewController();let d;if((c===ze.Sticky||n.getProperty("HasActiveEntity"))&&l.isFclEnabled()||this._hiddenDraft&&n.getProperty("HasActiveEntity")){d=await this._computeSiblingInformation(t,this._hiddenDraft?n:l.getRightmostContext(),c,true)}await this.base._sideEffects.handlePageChangeContext(n);if(n.getModel().hasPendingChanges("$auto")&&i.mergePatchDraft){n.getModel().submitBatch("$auto")}const g=await s.saveDocument(t,this.getAppComponent(),this._getResourceModel(),o,a,this.getMessageHandler(),this.getCreationMode(),undefined,i?.isStandardSave);this._removeStickySessionInternalProperties(c);if(this._hiddenDraft){this.handleSessionOff()}this._sendActivity(Be.Activate,g);this.base.collaborativeDraft.disconnect();this._triggerConfiguredSurvey(Ne.save,Ve.standardAction);this.setDocumentModified(false);this.setEditMode(Xe.Display,false);this.getMessageHandler().showMessageDialog({unHoldKey:r});this.base.recommendations.resetRejectedRecommendations(g);await this.base.editFlow.onAfterSave({context:g});this.base.recommendations.storeDataForTelemetry(e);if(g!==n){let e=g;d=d??this._createSiblingInfo(n,g);if(c===ze.Draft){const e=p.getSemanticPath(n,true);const t=p.getSemanticPath(g,true);if(e&&t&&e!==t){d.pathMapping.push({oldPath:e,newPath:t})}}this._updatePathsInHistory(d.pathMapping);if(l.isFclEnabled()||this._hiddenDraft?.stayOnCurrentPageAfterSave){if(d.targetContext.getPath()!==g.getPath()){e=d.targetContext}}if(i.skipBindingToView!==true){await this._handleNewContext(e,{editable:false,recreateContext:false,forceFocus:true})}}}catch(t){await this.getMessageHandler().showMessageDialog({unHoldKey:r});if(!(t&&t.canceled)){e.error("Error while saving the document",t)}throw t}};s.toggleDraftActive=async function e(t){const n=t.getObject();let i;const o=t&&this.getProgrammingModel(t)===ze.Draft;if(!o||!(!n.IsActiveEntity&&n.HasActiveEntity||n.IsActiveEntity&&n.HasDraftEntity)){return}if(!n.IsActiveEntity&&n.HasActiveEntity){i=false}else{i=true}try{const e=this._getRootViewController();const n=e.isFclEnabled()?e.getRightmostContext():t;let o=await this._computeSiblingInformation(t,n,ze.Draft,false);if(!o&&t!==n){o=await this._computeSiblingInformation(t,t,ze.Draft,false)}if(o){if(e.isFclEnabled()){const e=this._getSemanticMapping();if(e?.technicalPath===t.getPath()){const t=o.pathMapping[o.pathMapping.length-1].newPath;o.pathMapping.push({oldPath:e.semanticPath,newPath:t})}}this._updatePathsInHistory(o.pathMapping);await this._handleNewContext(o.targetContext,{editable:i,recreateContext:true,forceFocus:true})}else{throw new Error("Error in EditFlow.toggleDraftActive - Cannot find sibling")}}catch(e){throw new Error(`Error in EditFlow.toggleDraftActive:${e}`)}};s.cancelDocument=async function t(n,i){const o=this.getTransactionHelper();let s;let a=false;i.skipDiscardPopover=this._hiddenDraft?.enabled?true:i.skipDiscardPopover;const r={skipDiscardPopover:i.skipDiscardPopover===true,cancelButton:i.control||i.cancelButton,beforeCancelCallBack:this.base.editFlow.onBeforeDiscard};try{await this.syncTask();let e;const t=this.getProgrammingModel(n);if(this._hiddenDraft&&t==="Draft"){const t=h.getDraftRootPath(n);e=n.getPath()===t?n:await this.getRootContext(n)}else{e=await this.getRootContext(n)}if((t===ze.Sticky||n.getProperty("HasActiveEntity"))&&this._isFclEnabled()||this._hiddenDraft){const i=this._getRootViewController();s=await this._computeSiblingInformation(e,this._hiddenDraft?n:i.getRightmostContext(),t,true)}const c=await o.cancelDocument(e,r,this.getAppComponent(),this._getResourceModel(),this.getMessageHandler(),this._hiddenDraft?this.getCreationMode()&&!e.getProperty("HasActiveEntity"):this.getCreationMode(),this.isDocumentModified()||t===ze.Sticky);this._getRootViewController().getInstancedViews().forEach(e=>{const t=e.getBindingContext();if(t?.isKeepAlive()===true){t.setKeepAlive(false)}});this._removeStickySessionInternalProperties(t);if(this._hiddenDraft){this.handleSessionOff()}this.setEditMode(Xe.Display,false);this.setDocumentModified(false);this.setDraftStatus(Qe.Clear);this.base.recommendations.resetRejectedRecommendations(n);await this.base.editFlow.onAfterDiscard({context:c.activeContext});f.setEditStateDirty();if(!c.activeContext){this._sendActivity(Be.Discard,n);this.base.collaborativeDraft.disconnect();if(!i.skipBackNavigation){await this.getInternalRouting().navigateBackFromContext(e);a=true}}else{const e=c.activeContext;this._sendActivity(Be.Discard,e);this.base.collaborativeDraft.disconnect();let o=e;s=s??this._createSiblingInfo(n,e);this._updatePathsInHistory(s.pathMapping);if((this._isFclEnabled()||this._hiddenDraft?.stayOnCurrentPageAfterCancel)&&s.targetContext.getPath()!==e.getPath()){o=s.targetContext}if(t===ze.Draft){if(!i.skipBindingToView){await this._handleNewContext(o,{editable:false,recreateContext:true,forceFocus:true,siblingPath:p.getSemanticPath(c.activeContext,true,c.activeContextData)})}else{return e}}else{await this._handleNewContext(o,{editable:false,recreateContext:true,forceFocus:true})}}if(t===ze.Draft&&!this._hiddenDraft){this.showDocumentDiscardMessage(a)}}catch(t){if(typeof t==="string"&&t===y.Constants.CancelDiscardDraft){return}e.error("Error while discarding the document",t)}};s.getRootContext=async function e(t,i){const o=this.getView().getViewData();const s=this.getProgrammingModel(t);if(o?.viewLevel>1){if(s===ze.Draft||s===ze.Sticky){return await n.createRootContext(s,this.getView(),this.getAppComponent(),i)}}return t};s.isRootContextNew=async function e(t){const n=await this.getRootContext(t,{$select:"HasActiveEntity,IsActiveEntity"});const i=await n.requestProperty(["HasActiveEntity","IsActiveEntity"]);return!i[0]&&!i[1]};s.showDocumentDiscardMessage=function e(t){const n=this._getResourceModel();const i=n.getText("C_TRANSACTION_HELPER_DISCARD_DRAFT_TOAST");if(t==true){const e=this.getAppComponent();e.getRoutingService().attachAfterRouteMatched({},this.showMessageWhenNoContext,this)}else{w.show(i)}};s.showMessageWhenNoContext=function e(){const t=this._getResourceModel();const n=t.getText("C_TRANSACTION_HELPER_DISCARD_DRAFT_TOAST");const i=this.getAppComponent();w.show(n,{closeOnBrowserNavigation:false});i.getRoutingService().detachAfterRouteMatched(this.showMessageWhenNoContext,this)};s.isDraftRoot=function e(t){const n=t.getModel().getMetaModel();const i=n.getMetaContext(t.getPath());return h.isDraftRoot(Oe(i).targetEntitySet)};s.deleteDocument=async function t(n,i){const o=this.getAppComponent();const s={...i,bFindActiveContexts:false,beforeDeleteCallBack:this.base.editFlow.onBeforeDelete},a=this.getMessageHandler().registerToHoldMessages();try{if(this._isFclEnabled()&&this.isDraftRoot(n)&&n.getIndex()===undefined&&n.getProperty("IsActiveEntity")===true&&n.getProperty("HasDraftEntity")===true){s.beforeDeleteCallBack=async t=>{await this.base.editFlow.onBeforeDelete(t);try{const e=n.getModel();const t=e.bindContext(`${n.getPath()}/SiblingEntity`).getBoundContext();const i=await t.requestCanonicalPath();const o=e.getKeepAliveContext(i);o.replaceWith(n)}catch(t){e.error("Error while replacing the draft instance in the LR ODLB",t)}}}const t=await this.deleteDocumentTransaction(n,s);if(!t){return}if(this.getProgrammingModel(n)===ze.Sticky){this.setDocumentModified(true)}if(!this._isFclEnabled()){f.setEditStateDirty()}else{const e=n.getBinding();if(e.isA("sap.ui.model.odata.v4.ODataListBinding")){if(e.isRoot()){await this.getTransactionHelper().refreshListBinding(e,o)}else if(s.requestSideEffects!==false){this.requestSideEffectsOnDelete(e,e.getContext())}}}this._sendActivity(Be.Delete,n);await(o?.getShellServices().setBackNavigation());const i=this.base.recommendations.isRecommendationEnabled();if(i){this.base.recommendations.ignoreRecommendationForContexts([n])}this.base.recommendations.resetRejectedRecommendations(n);await this.base.editFlow.onAfterDelete({contexts:[n]});if(!this._isFclEnabled()){if(o?.getStartupMode()===Ye.Deeplink){o.getRouterProxy().exitFromApp()}else{this.getInternalRouting().navigateBackFromContext(n)}}}catch(t){e.error("Error while deleting the document",t)}finally{this.getMessageHandler().showMessages({unHoldKey:a})}};s.applyDocument=async function e(t){const n=this.getGlobalUIModel();const i=this.getMessageHandler().registerToHoldMessages();try{await this.syncTask();if(t.getModel().hasPendingChanges("$auto")){o.lock(n);await this._submitOpenChanges(t)}const e=await this.showConfirmRecommendationsDialog(false);if(e===_e.Continue){return}await this._checkForValidationErrors();await this.getMessageHandler().showMessageDialog({unHoldKey:i});await this.getInternalRouting().navigateBackFromContext(t,{callExtension:true})}finally{if(o.isLocked(n)){o.unlock(n)}}};s.invokeAction=async function t(n,i,o){const s=this.getTransactionHelper();let a;let r;let c;const l=this.base.getView();if(i?.isA&&i?.isA("sap.ui.model.odata.v4.Context")||Array.isArray(i)||o!==undefined){const e=i;i=o||{};if(e){i.contexts=e}else{i.model=this.base.getView().getModel()}}const d={...i,view:this.base.getView()}||{view:this.base.getView()};d.isNavigable=d.requiresNavigation||d.isNavigable;const g=Fe(this.getView().getModel()?.getMetaModel());if(n.includes(""+g.entityContainer.name)){d.isBound=false}else{d.isBound=true}if(!d.entitySetName&&d.contexts&&d.model){d.entitySetName=d.model.getMetaModel().getMetaContext((Array.isArray(d.contexts)?d.contexts[0]:d.contexts).getPath()).getObject("@sapui.name")}let h;if(d.controlId){h=this.getView().byId(d.controlId);if(h){d.internalModelContext=h.getBindingContext("internal")}}else{d.internalModelContext=l.getBindingContext("internal")}d.ignoreETag=d.internalModelContext?.getProperty("/sessionOn");if(n&&n.includes("(")){a=n.split("(");n=a[0];r=a[a.length-1].replaceAll(")","")}if(d.bStaticAction&&h){if(h.isA("sap.ui.mdc.Table")){const e=h.getParent();d.contexts=e.getRowBinding().getHeaderContext()}if(r&&h.getBindingContext()&&h.isA&&h.isA("sap.ui.mdc.Table")){d.contexts=this._getActionOverloadContextFromMetadataPath(h.getBindingContext(),h.getRowBinding(),r)}if(d.enableAutoScroll){c=this.createActionPromise(n,h.getId())}}try{await this.syncTask();if(!Array.isArray(d.contexts)&&d.contexts?.getBinding().isA("sap.ui.model.odata.v4.ODataContextBinding")){await this.base._sideEffects.handlePageChangeContext(d.contexts)}await this.base.editFlow.onBeforeExecuteAction({contexts:d.contexts});const t=await s.callAction(n,d,this.getAppComponent(),this.getMessageHandler());const o=t.filter(Ie);if(t.length!==o.length){throw t}let a;if(d.contexts&&Array.isArray(d.contexts)&&d.isBound===true){a=await this._refreshListIfRequired(this.getActionResponseDataAndKeys(n,o),d.contexts[0])}if(this.base.collaborativeDraft.isConnected()){this._sendActivity(Be.Action,d.contexts,n,a,Object.keys(o[0].value.boundContext.getObject()))}this._triggerConfiguredSurvey(n,Ve.action);if(c){c.fResolver(o)}if(d.contexts){if(this.base.getView().getViewData().converterType!=="ListReport"){f.setEditStateDirty()}this.getInternalModel().setProperty("/lastInvokedAction",n)}if(d.isNavigable){if(o.length===1){const t=this._getBoundContext(l,d)?o[0].value.boundContext:o[0].value.returnedContext??o[0].value.boundContext;const n=l.getModel().getMetaModel();const i=n.getMetaPath(t.getPath());const s=(e,t)=>e.filter(e=>{if(t){return t.includes(e)}return true});const a=Array.isArray(d.contexts)?s(d.contexts,d.applicableContexts)[0]:d.contexts;const r=a&&n.getMetaPath(a.getPath());if(i!=undefined&&i===r){if(a?.getPath()!==t.getPath()){this.getInternalRouting().navigateForwardToContext(t,{checkNoHashChange:true});if(this.getProgrammingModel(t)===ze.Draft&&(t.getProperty("IsActiveEntity")===false||this._isFclEnabled())){t.getBinding().destroy()}}else{e.info("Navigation to the same context is not allowed")}}}}this.base.editFlow.onAfterActionExecution(n);if(!Array.isArray(i?.contexts)&&o.length===1){return o[0].value.returnedContext??o[0].value.boundContext}return o.map(e=>({...e,...{value:e.value.returnedContext??e.value.boundContext}}))}catch(e){if(c){c.fRejector()}if(e===Je.CancelActionDialog){throw new Error("Dialog cancelled")}throw e}};s.onAfterActionExecution=async function e(t){};s.customMassEditSave=async function e(t){return Promise.resolve(false)};s.securedExecution=async function e(t,n){const i=n?.busy?.set??true,s=n?.busy?.check??true,a=n?.updatesDocument??false,r=this.getGlobalUIModel(),c=this.getView().getBindingContext(),l=c&&this.getProgrammingModel(c)===ze.Draft,d=this.getMessageHandler().registerToHoldMessages();if(s&&o.isLocked(r)){return Promise.reject("Application already busy therefore execution rejected")}if(i){o.lock(r)}if(a&&l){this.setDraftStatus(Qe.Saving)}this.getMessageHandler().removeTransitionMessages();return this.syncTask(t).then(()=>{if(a){this.setDocumentModified(true);if(!this._isFclEnabled()){f.setEditStateDirty()}if(l){this.setDraftStatus(Qe.Saved)}}return}).catch(e=>{if(a&&l){this.setDraftStatus(Qe.Clear)}throw e}).finally(()=>{if(i){o.unlock(r)}this.getMessageHandler().showMessageDialog({unHoldKey:d})})};s.handlePatchSent=function e(t){const n=this.getView()?.getBindingContext("internal");const i=this.getView()?.getBindingContext("ui");const o=this.base.collaborativeDraft.isConnected()||n.getProperty("/sessionOn");if(o){t.getSource().getModel().setIgnoreETag(true)}if(i?.getProperty("isEditable")===false){this.base.inlineEditFlow.handleInlineEditPatchSent(t)}else if(!n?.getProperty("skipPatchHandlers")){const e=t.getSource();const n=new Promise((n,i)=>{t.getSource().attachEventOnce("patchCompleted",s=>{if(o){t.getSource().getModel().setIgnoreETag(false)}if(t.getSource().isA("sap.ui.model.odata.v4.ODataListBinding")){I.setActionEnablementAfterPatch(this.getView(),e,this.getView()?.getBindingContext("internal"))}const a=s.getParameter("success");if(a){n()}else{i()}})});this.updateDocument(e,n)}};s.handleCreateSent=function e(t){const n=t.getParameter("context");this.getMessageHandler().removeTransitionMessages(false,false,n.getPath())};s.syncTask=async function t(n){if(n){if(typeof n==="function"){this.syncTasks=this.syncTasks.then(n).catch(function(t){e.debug(t)})}else{this.syncTasks=this.syncTasks.then(async()=>n).catch(function(t){e.debug(t)})}}return this.syncTasks};s.computeModelsForEditMode=async function t(n){const i=this.getProgrammingModel(n);if(i===ze.Draft){try{this.setDraftStatus(Qe.Clear);const e=this.getGlobalUIModel();e.setProperty("/isEditablePending",true,undefined,true);const t=this.getView().getModel();const i=h.isCollaborationDraftSupported(t.getMetaModel());let o=false;const s=await n.requestObject("IsActiveEntity");if(i){o=!await this.base.collaborativeDraft.activateCollaboration(n,s)}else{e.setProperty("/hasCollaborationAuthorization",undefined)}this.fetchCollaborativeDraftUsersPromise=undefined;if(s===false&&!o){this.setEditMode(Xe.Editable);const e=await n.requestObject("HasActiveEntity");this.setEditMode(undefined,!e)}else{this.setEditMode(Xe.Display,false)}e.setProperty("/isEditablePending",false,undefined,true)}catch(t){e.error("Error while determining the editMode for draft",t)}}else if(i===ze.Sticky){const e=this.getInternalModel().getProperty("/lastInvokedAction");if(e&&this.isNewActionForSticky(e,n)){this.setEditMode(Xe.Editable,true);if(!this.getAppComponent()._isFclEnabled()){f.setEditStateDirty()}this.handleStickyOn(n);this._setStickySessionInternalProperties(this.getProgrammingModel(n),n.getModel());this.getInternalModel().setProperty("/lastInvokedAction",undefined)}}};s.deleteDocumentTransaction=async function e(t,n){if(n.selectedContexts){n.numberOfSelectedContexts=n.selectedContexts.length}const i=this._getResourceModel();const o=this.getTransactionHelper();if(n.controlId){const e=M.getElementById(n.controlId);if(e&&!e.isA("sap.ui.mdc.MultiValueField")){n.internalModelContext=e.getBindingContext("internal")}}await this.syncTask();return o.deleteDocument(t,n,this.getAppComponent(),i,this.getMessageHandler())};s._getResourceModel=function e(){return Te(this.getView())};s.getTransactionHelper=function e(){return r};s.getMessageHandler=function e(){if(this.base.messageHandler){return this.base.messageHandler}else{throw new Error("Edit Flow works only with a given message handler")}};s.getInternalModel=function e(){return this.getView().getModel("internal")};s.getGlobalUIModel=function e(){return this.getView().getModel("ui")};s.getPageInternalModel=function e(){return this.getView().getModel("pageInternal")};s.setCreationMode=function e(t){const n=this.getView().getBindingContext("pageInternal");this.getPageInternalModel().setProperty(l.CreateMode,t,n,true)};s.getCreationMode=function e(){const t=this.getView().getBindingContext("pageInternal");return!!t.getProperty(l.CreateMode)};s.isDocumentModified=function e(){return!!this.getGlobalUIModel().getProperty(l.DocumentModified)};s.setDocumentModified=function e(t){this.getGlobalUIModel().setProperty(l.DocumentModified,t)};s.setDocumentModifiedOnCreate=function e(t){if(t.isRelative()){this.setDocumentModified(true)}};s.handleCreateEvents=function e(t){this.setDraftStatus(Qe.Clear);const n=this.getProgrammingModel(t);const i=[];t.attachEvent("createSent",e=>{if(n===ze.Draft){this.setDraftStatus(Qe.Saving)}const t=e.getParameter("context");let o=i.find(e=>e.context===t)?.messageHandlingKey;if(!o){o=this.getMessageHandler().registerToHoldMessages();i.push({context:t,messageHandlingKey:o})}});t.attachEvent("createCompleted",e=>{const t=e.getParameter("success"),o=e.getParameter("context");if(n===ze.Draft){this.setDraftStatus(t?Qe.Saved:Qe.Clear)}const s=i.find(e=>e.context===o)?.messageHandlingKey;if(s){this.getMessageHandler().showMessageDialog({unHoldKey:s})}})};s.setDraftStatus=function e(t){this.getView().getModel("ui").setProperty("/draftStatus",t,undefined,true)};s.getProgrammingModel=function e(t){return this.getTransactionHelper().getProgrammingModel(t)};s.setEditMode=function e(t,n){const i=this.getGlobalUIModel();if(t){i.setProperty("/isEditable",t==="Editable",undefined,true);if(t!=="Editable"){this.forceDraftSaveOrDiscard(false)}}if(n!==undefined){this.setCreationMode(n)}};s.forceDraftSaveOrDiscard=function e(t){this.getGlobalUIModel().setProperty("/forceDraftSaveOrDiscard",t,undefined,true)};s.shallForceDraftSaveOrDiscard=function e(){return this.getGlobalUIModel().getProperty("/forceDraftSaveOrDiscard")===true};s.isNewActionForSticky=function t(n,i){try{const e=i.getModel().getMetaModel();const t=e.getMetaContext(i.getPath());const o=Oe(t).startingEntitySet;const s=o.annotations.Session?.StickySessionSupported;if(s?.NewAction===n){return true}if(s?.AdditionalNewActions&&s?.AdditionalNewActions.includes(n)){return true}return false}catch(t){e.info(t);return false}};s.handleStickyOn=async function t(n){const i=this.getAppComponent();try{if(i===undefined){throw new Error("undefined AppComponent for function handleStickyOn")}if(!i.getRouterProxy().hasNavigationGuard()){await this.registerCallbacks(n,i)}}catch(t){e.info(t);return false}return true};s.registerCallbacks=async function e(t,n,i){const o=n.getRouterProxy().getHash();const s=this.getInternalModel();setTimeout(function(){n.getRouterProxy().setNavigationGuard(t.getPath().substring(1),i)},0);await n.getShellServices().setBackNavigation(this.onBackNavigationInSession.bind(this,t));const a=this.base.getView().getModel("sap.fe.i18n");n.registerCallbacks(this.getDirtyStateProvider(n,s,o),this.getRouteMatchedFunction(t,n),!this._hiddenDraft?this.getSessionTimeoutFunction(t,a):undefined)};s.handleHiddenDraftEdit=async function t(n){const i=this.getAppComponent();try{if(i===undefined){throw new Error("undefined AppComponent for function handleHiddenDraftEdit")}let e;if(!this._isFclEnabled()){e=n}else{e=n?.getModel().getKeepAliveContext(n.getPath())}if(this.getCreationMode()){const t=h.getDraftRootPath(e);e=e.getPath()===t?e:await this.getRootContext(e)}if(!i.getRouterProxy().hasNavigationGuard()){const t=p.getSemanticPath(e,true)?.substring(1);await this.registerCallbacks(e,i,t)}}catch(t){e.info(t);return false}return true};s.handleSessionOff=function t(){const n=this.getAppComponent();try{if(n===undefined){throw new Error("undefined AppComponent for function handleStickyOff")}if(n.getRouterProxy){n.getRouterProxy().discardNavigationGuard()}if(n.unregisterCallbacks){n.unregisterCallbacks()}this.setEditMode(Xe.Display,false);if(n.getShellServices){n.getShellServices().setBackNavigation()}}catch(t){e.info(t);return false}return true};s._setStickySessionInternalProperties=function e(t,n){if(t===ze.Sticky){const e=this.getInternalModel();e.setProperty("/sessionOn",true);e.setProperty("/stickySessionToken",n.getHttpHeaders(true)["SAP-ContextId"])}};s.getDirtyStateProvider=function t(n,i,o){return t=>{try{if(t===undefined){throw new Error("Invalid input parameters for DirtyStateProvider function")}const e=t.innerAppRoute;const s=n.getRouterProxy();let a="";let r;const c=i.getProperty("/sessionOn");if(!c&&!this._hiddenDraft){return undefined}if(!s.isNavigationFinalized()){r=false;a=e}else if(o===e){r=true}else if(s.checkHashWithGuard(e)||s.isGuardCrossAllowedByUser()){a=e;r=false}else if(this._hiddenDraft&&!this.isDocumentModified()){r=false;a=e}else{r=true}if(r){setTimeout(function(){n.getShellServices().setDirtyFlag(false)},0)}else{o=a}return r}catch(t){e.info(t);return undefined}}};s.getSessionTimeoutFunction=function t(n,i){return()=>{try{if(n===undefined){throw new Error("Context missing for SessionTimeout function")}this.getMessageHandler().removeTransitionMessages();const e=new C({title:"{sap.fe.i18n>C_EDITFLOW_OBJECT_PAGE_SESSION_EXPIRED_DIALOG_TITLE}",state:"Warning",content:new D({text:"{sap.fe.i18n>C_EDITFLOW_OBJECT_PAGE_SESSION_EXPIRED_DIALOG_MESSAGE}"}),beginButton:new m({text:"{sap.fe.i18n>C_COMMON_DIALOG_OK}",type:"Emphasized",press:()=>{this.handleSessionOff();this.getInternalRouting().navigateBackFromContext(n)}}),afterClose:function(){e.destroy()}});e.addStyleClass("sapUiContentPadding");e.setModel(i,"sap.fe.i18n");this.getView().addDependent(e);e.open()}catch(t){e.info(t);return undefined}return true}};s.getRouteMatchedFunction=function e(t,n){const i=this.getProgrammingModel(t);const o=t.getModel();const s=t.getPath();return async()=>{const e=n.getRouterProxy().getHash();if(!e||!n.getRouterProxy().checkHashWithGuard(e)){if(this._hiddenDraft&&i===ze.Draft){return this.handleHiddenDraftDiscard(t,o,s)}else{await this.discardStickySession(t);t.getModel().clearSessionContext()}}}};s.handleHiddenDraftDiscard=async function e(t,n,i){let o;if(t?.getBinding()){o=t}else{o=n.bindContext(i,undefined,{}).getBoundContext()}await o.requestProperty(["HasActiveEntity","IsActiveEntity"]);return this.discardHiddenDraftSession(o)};s.discardContext=function e(t,n){if(t?.hasPendingChanges()){t.getBinding().resetChanges()}if(!n){t.refresh()}};s.discardStickySession=async function e(t){const n=this.getCreationMode();this.handleSessionOff();const i=await d.discardDocument(t);if(i!==undefined&&i!==null){this.discardContext(i,n)}};s.discardHiddenDraftSession=async function e(t){await T.discardDraft(this.getView().getController(),undefined,t,true);this.handleSessionOff()};s.getInternalRouting=function e(){if(this.base._routing){return this.base._routing}else{throw new Error("Edit Flow works only with a given routing listener")}};s._getRootViewController=function e(){return this.getAppComponent().getRootViewController()};s._getSemanticMapping=function e(){return this.getAppComponent().getRoutingService().getLastSemanticMapping()};s.createActionPromise=function e(t,n){let i,o;this.actionPromise=new Promise((e,t)=>{i=e;o=t}).then(e=>Object.assign({controlId:n},this.getActionResponseDataAndKeys(t,e)));return{fResolver:i,fRejector:o}};s.getActionResponseDataAndKeys=function e(t,n){if(n.length>=1){const e=this.base.getView();const i=e.getModel().getMetaModel().getData()??{};const o=i[t];const s=o?.[0].$ReturnType?o?.[0].$ReturnType.$Type:null;const a=s&&i[s]?i[s].$Key:[];return{oData:n[0].value.boundContext.getObject(),keys:a}}return undefined};s.getCurrentActionPromise=async function e(){return this.actionPromise};s.deleteCurrentActionPromise=function e(){this.actionPromise=undefined};s.showConfirmRecommendationsDialog=async function e(t){if(!this.confirmRecommendationsDialog){this.confirmRecommendationsDialog=new ke({view:this.getView(),programmingModel:this.getProgrammingModel(this.getView().getBindingContext())})}return this.confirmRecommendationsDialog?.open(t)};s._scrollAndFocusOnInactiveRow=function e(t){const n=t.getRowBinding();const i=n.getCount()||0;if(t.data("tableType")!=="ResponsiveTable"){if(i>0){t.scrollToIndex(i-1)}t.focusRow(i,true)}else{const e=n.getAllCurrentContexts();if(!e?.length){t.focusRow(i,true);return}let o=i,s=0;for(const t of e){if(t.isInactive()&&s<o){o=s}s++}if(o>0){t.scrollToIndex(o)}t.focusRow(o,true)}};s.createEmptyRowsAndFocus=async function e(t){const n=t.getParent();if(n?.tableDefinition?.control?.inlineCreationRowsHiddenInEditMode&&!t.getBindingContext("pageInternal")?.getProperty("createMode")){if(n.tableDefaultsPromise){const e=await n.tableDefaultsPromise;await n.setUpEmptyRows(t,true,e??{})}else{await n.setUpEmptyRows(t,true)}}this._scrollAndFocusOnInactiveRow(t)};s._sendActivity=function e(t,n,i,o,s){const a=Array.isArray(n)?n.map(e=>e.getPath()):n?.getPath();this.base.collaborativeDraft.send({action:t,content:a,triggeredActionName:i,refreshListBinding:o,actionRequestedProperties:s})};s._triggerConfiguredSurvey=function e(t,n){He(this.base.getView(),t,n)};s._submitOpenChanges=async function e(t){const n=t.getModel(),i=this.getGlobalUIModel();try{await n.submitBatch("$auto");await n.oRequestor.waitForRunningChangeRequests("$auto");if(n.hasPendingChanges("$auto")){throw new Error("submit of open changes failed")}}finally{if(o.isLocked(i)){o.unlock(i)}}};s._removeStickySessionInternalProperties=function e(t){if(t===ze.Sticky){const e=this.getInternalModel();e.setProperty("/sessionOn",false);e.setProperty("/stickySessionToken",undefined);this.handleSessionOff()}};s.onBackNavigationInSession=function e(t){const n=this.base.getView();const i=this.getAppComponent().getRouterProxy();if(i.checkIfBackIsOutOfGuard()){d.processDataLossConfirmation(async()=>{await this.discardStickySession(t);this._removeStickySessionInternalProperties(ze.Sticky);history.back()},n,ze.Sticky);return}history.back()};s._handleNewContext=async function e(t,n){if(!this._isFclEnabled()){f.setEditStateDirty()}await this.getInternalRouting().navigateToContext(t,{checkNoHashChange:true,editable:n.editable,persistOPScroll:true,recreateContext:n.recreateContext,reason:O.EditFlowAction,showPlaceholder:false,forceFocus:n.forceFocus??false,keepCurrentLayout:true,semanticPath:n.siblingPath})};s._getBoundContext=function e(t,n){const i=t.getViewData().viewLevel;const o=i>1||i===1&&n.controlId;return!n.isNavigable||!!o};s._checkForValidationErrors=async function t(){return this.syncTask().then(()=>{const t=this._isFclEnabled()?this._getRootViewController()._getAllVisibleViews().map(e=>e.getId()):[this.getView().getId()];const n=P.getMessageModel().getData();let i;if(!n.length){e.info("No validation errors found");return}for(const e of n){if(e.validation){i=M.getElementById(e.getControlId());while(i){if(t.includes(i.getId())){throw"validation errors exist"}i=i.getParent()}}}return})};s._refreshListIfRequired=async function e(t,n){if(!n||!t||!t.oData||!t.keys){return false}const i=n.getBinding();if(i&&i.isA("sap.ui.model.odata.v4.ODataListBinding")){const e=t.oData;const o=t.keys;const s=n.getObject();let a=true;if(Object.keys(e).length){a=o.every(function(t){return s[t]===e[t]});if(!a){await this.getTransactionHelper().refreshListBinding(i,this.getAppComponent());return true}}}return false};s._getActionOverloadContextFromMetadataPath=function e(t,n,i){const o=t.getModel();const s=o.getMetaModel();let a=n.getPath().split("/");let r=t;a.pop();if(a.length===0){a=[""]}if(a[0]!==""){a.unshift("")}const c=a.map(e=>{if(e!==""){r=o.bindContext(e,r).getBoundContext()}else{r=t}return r}).reverse();const l=c.find(e=>s.getMetaContext(e.getPath()).getObject("$Type")===i);return l||n.getHeaderContext()};s._createSiblingInfo=function e(t,n){return{targetContext:n,pathMapping:[{oldPath:t.getPath(),newPath:n.getPath()}]}};s._updatePathsInHistory=function e(t){const n=this.getAppComponent();n.getRouterProxy().setPathMapping(t);const i=this._getSemanticMapping();if(t.length&&i?.technicalPath===t[t.length-1].oldPath){i.technicalPath=t[t.length-1].newPath}};s._getNavigationTargetForEdit=function e(t,n,i){let o;i=i??this._createSiblingInfo(t,n);this._updatePathsInHistory(i.pathMapping);if(i.targetContext.getPath()!=n.getPath()){o=t.getPath()===i.targetContext.getPath()?t:i.targetContext}return o};s._computeSiblingInformation=async function t(n,i,o,s,a,r){i=i??n;if(!i.getPath().startsWith(n.getPath())){e.error("Cannot compute rightmost sibling context");throw new Error("Cannot compute rightmost sibling context")}let l=i;if(o===ze.Draft&&this.getProgrammingModel(i)!==ze.Draft){l=n}if(s&&l.getPath()===n.getPath()){return Promise.resolve(undefined)}const d=n.getModel();if(o===ze.Draft){return c.computeSiblingInformation(n,l,a,r)}else{return{targetContext:d.bindContext(i.getPath()).getBoundContext(),pathMapping:[]}}};s._isFclEnabled=function e(){return this.getAppComponent()._isFclEnabled()};s.checkRecommendationOption=async function e(){const t=await this.showConfirmRecommendationsDialog(true);if(t===_e.Continue){return Promise.reject(_e.Continue)}return t};s.createNextDocument=async function e(){const t=this.getView()?.getBindingContext()?.getPath();const n=t?.substring(0,t.lastIndexOf("("));return this.createDocument(n,{creationMode:Re.NewPage})};return i}(i),We(Se.prototype,"onInit",[B],Object.getOwnPropertyDescriptor(Se.prototype,"onInit"),Se.prototype),We(Se.prototype,"editDocument",[H,V],Object.getOwnPropertyDescriptor(Se.prototype,"editDocument"),Se.prototype),We(Se.prototype,"updateDocument",[N,j],Object.getOwnPropertyDescriptor(Se.prototype,"updateDocument"),Se.prototype),We(Se.prototype,"createDocument",[L,$],Object.getOwnPropertyDescriptor(Se.prototype,"createDocument"),Se.prototype),We(Se.prototype,"onBeforeCreate",[G,U],Object.getOwnPropertyDescriptor(Se.prototype,"onBeforeCreate"),Se.prototype),We(Se.prototype,"onBeforeEdit",[q,K],Object.getOwnPropertyDescriptor(Se.prototype,"onBeforeEdit"),Se.prototype),We(Se.prototype,"onBeforeSave",[W,z],Object.getOwnPropertyDescriptor(Se.prototype,"onBeforeSave"),Se.prototype),We(Se.prototype,"onBeforeDiscard",[J,Q],Object.getOwnPropertyDescriptor(Se.prototype,"onBeforeDiscard"),Se.prototype),We(Se.prototype,"onBeforeDelete",[X,Y],Object.getOwnPropertyDescriptor(Se.prototype,"onBeforeDelete"),Se.prototype),We(Se.prototype,"onBeforeExecuteAction",[Z,ee],Object.getOwnPropertyDescriptor(Se.prototype,"onBeforeExecuteAction"),Se.prototype),We(Se.prototype,"onAfterSave",[te,ne],Object.getOwnPropertyDescriptor(Se.prototype,"onAfterSave"),Se.prototype),We(Se.prototype,"onAfterCreate",[ie,oe],Object.getOwnPropertyDescriptor(Se.prototype,"onAfterCreate"),Se.prototype),We(Se.prototype,"onAfterEdit",[se,ae],Object.getOwnPropertyDescriptor(Se.prototype,"onAfterEdit"),Se.prototype),We(Se.prototype,"onAfterDiscard",[re,ce],Object.getOwnPropertyDescriptor(Se.prototype,"onAfterDiscard"),Se.prototype),We(Se.prototype,"onAfterDelete",[le,de],Object.getOwnPropertyDescriptor(Se.prototype,"onAfterDelete"),Se.prototype),We(Se.prototype,"saveDocument",[ge,fe],Object.getOwnPropertyDescriptor(Se.prototype,"saveDocument"),Se.prototype),We(Se.prototype,"cancelDocument",[he,ue],Object.getOwnPropertyDescriptor(Se.prototype,"cancelDocument"),Se.prototype),We(Se.prototype,"deleteDocument",[pe,ye],Object.getOwnPropertyDescriptor(Se.prototype,"deleteDocument"),Se.prototype),We(Se.prototype,"applyDocument",[me,Ce],Object.getOwnPropertyDescriptor(Se.prototype,"applyDocument"),Se.prototype),We(Se.prototype,"invokeAction",[we,De],Object.getOwnPropertyDescriptor(Se.prototype,"invokeAction"),Se.prototype),We(Se.prototype,"onAfterActionExecution",[Me,be],Object.getOwnPropertyDescriptor(Se.prototype,"onAfterActionExecution"),Se.prototype),We(Se.prototype,"customMassEditSave",[Pe,ve],Object.getOwnPropertyDescriptor(Se.prototype,"customMassEditSave"),Se.prototype),We(Se.prototype,"securedExecution",[Ee,Ae],Object.getOwnPropertyDescriptor(Se.prototype,"securedExecution"),Se.prototype),Se))||xe);return Ze},false);
//# sourceMappingURL=EditFlow.js.map