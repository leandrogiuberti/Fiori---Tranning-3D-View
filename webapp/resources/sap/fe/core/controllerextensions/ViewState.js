/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/base/ClassSupport","sap/fe/navigation/library","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution"],function(t,e,i,r,n,a){"use strict";var o,s,p,l,c,d,u,f,y,S,g,h,v,w,b,A,C,I,O,m,P,_,V,j,R,B,D,K,E,M,T,H,F,N,x,k,L,U,z,$,q,G,Q,W,J,X,Y,Z,tt,et,it,rt,nt;function at(t){return new Promise((e,i)=>{sap.ui.require([t],i=>{if(!(i&&i.__esModule)){i=i===null||!(typeof i==="object"&&t.endsWith("/library"))?{default:i}:i;Object.defineProperty(i,"__esModule",{value:true})}e(i)},t=>{i(t)})})}var ot=i.publicExtension;var st=i.privateExtension;var pt=i.finalExtension;var lt=i.extensible;var ct=i.defineUI5Class;function dt(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,ut(t,e)}function ut(t,e){return ut=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},ut(t,e)}function ft(t,e,i,r,n){var a={};return Object.keys(r).forEach(function(t){a[t]=r[t]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=i.slice().reverse().reduce(function(i,r){return r(t,e,i)||i},a),n&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(n):void 0,a.initializer=void 0),void 0===a.initializer?(Object.defineProperty(t,e,a),null):a}const yt=r.NavType;const St="#additionalStates";const gt=async function(){return(await at("sap/ui/mdc/p13n/StateUtil")).default};const ht={"sap.ui.fl.variants.VariantManagement":{retrieve:function(t){return{variantId:t.getCurrentVariantKey()}},apply:async function(e,i){try{if(i&&i.variantId!==undefined&&i.variantId!==e.getCurrentVariantKey()){const r=this._checkIfVariantIdIsAvailable(e,i.variantId);let n;if(r){n=i.variantId}else{n=e.getStandardVariantKey();this.controlsVariantIdUnavailable.push(...e.getFor())}try{const t=(await at("sap/ui/fl/apply/api/ControlVariantApplyAPI")).default;await t.activateVariant({element:e,variantReference:n});await this._setInitialStatesForDeltaCompute(e)}catch(i){t.error(i);this.invalidateInitialStateForApply.push(...e.getFor());await this._setInitialStatesForDeltaCompute(e)}}else{this._setInitialStatesForDeltaCompute(e)}}catch(e){t.error(e)}}},"sap.fe.templates.ListReport.controls.MultipleModeControl":{retrieve:function(t){return{selectedKey:t.content.getSelectedKey()}},apply:function(t,e){if(e?.selectedKey){const i=t.content;const r=i.getItems().find(t=>t.getKey()===e.selectedKey);if(r){i.setSelectedKey(e.selectedKey);if(t.getModel("_pageModel")?.getProperty("/hideFilterBar")===true){t.refreshSelectedInnerControlContent()}}}}},"sap.ui.mdc.Table":{refreshBinding:function(e){const i=e.getRowBinding();if(i){const t=i.getRootBinding();const e=i.getAggregation();if(t===i&&e?.hierarchyQualifier===undefined){i.refresh()}else{const t=i.getHeaderContext();const e=i.getGroupId();if(t){t.requestSideEffects([{$NavigationPropertyPath:""}],e)}}}else{t.info(`Table: ${e.getId()} was not refreshed. No binding found!`)}}},"sap.m.SegmentedButton":{retrieve:function(t){return{selectedKey:t.getSelectedKey()}},apply:function(t,e){if(e?.selectedKey&&e.selectedKey!==t.getSelectedKey()){t.setSelectedKey(e.selectedKey);if(t.getParent()?.isA("sap.ui.mdc.ActionToolbar")){t.fireEvent("selectionChange")}}}},"sap.m.Select":{retrieve:function(t){return{selectedKey:t.getSelectedKey()}},apply:function(t,e){if(e?.selectedKey&&e.selectedKey!==t.getSelectedKey()){t.setSelectedKey(e.selectedKey);if(t.getParent()?.isA("sap.ui.mdc.ActionToolbar")){t.fireEvent("change")}}}},"sap.f.DynamicPage":{retrieve:function(t){return{headerExpanded:t.getHeaderExpanded()}},apply:function(t,e){if(e){t.setHeaderExpanded(e.headerExpanded)}}},"sap.ui.core.mvc.View":{retrieve:function(t){const e=t.getController();if(e&&e.viewState){return e.viewState.retrieveViewState()}return{}},apply:async function(t,e,i,r){const n=t.getController();if(n&&n.viewState&&i){return n.viewState.applyViewState(e,i,r)}},refreshBinding:async function(t){const e=t.getController();if(e&&e.viewState){return e.viewState.refreshViewBindings()}}},"sap.ui.core.ComponentContainer":{retrieve:async function(t){const e=t.getComponentInstance();if(e){return this.retrieveControlState(e.getRootControl())}return{}},apply:async function(t,e,i){const r=t.getComponentInstance();if(r){return this.applyControlState(r.getRootControl(),e,i)}}}};let vt=(o=ct("sap.fe.core.controllerextensions.ViewState"),s=ot(),p=pt(),l=ot(),c=lt(a.After),d=st(),u=pt(),f=st(),y=pt(),S=ot(),g=lt(a.After),h=ot(),v=lt(a.After),w=ot(),b=lt(a.After),A=st(),C=pt(),I=ot(),O=lt(a.After),m=st(),P=pt(),_=ot(),V=lt(a.After),j=ot(),R=pt(),B=st(),D=pt(),K=ot(),E=pt(),M=ot(),T=lt(a.After),H=st(),F=pt(),N=ot(),x=lt(a.Instead),k=ot(),L=lt(a.After),U=ot(),z=pt(),$=st(),q=ot(),G=lt(a.After),Q=ot(),W=lt(a.After),J=ot(),X=lt(a.After),Y=ot(),Z=lt(a.After),tt=st(),et=pt(),it=ot(),o(rt=(nt=function(i){function r(){var e;e=i.call(this)||this;e._retrieveCalls=[];e.initialControlStatesMapper={};e.controlsVariantIdUnavailable=[];e.invalidateInitialStateForApply=[];e.viewStateControls=[];e.stateContributors=[];e._setInitialStatesForDeltaCompute=async i=>{try{const t=e.viewStateControls;const r=[];const n=[];let a=[];const o=i?.getFor()??[];e.updateInitialState(o);await Promise.all(t.filter(function(t){return t&&(!i||o.includes(t.getId()))&&(t.isA("sap.ui.mdc.Table")||t.isA("sap.ui.mdc.FilterBar")||t.isA("sap.ui.mdc.Chart"))}).map(async t=>{if(i){e._addEventListenersToVariantManagement(i,o)}const a=(await gt()).retrieveExternalState(t);r.push(a);n.push(e.getStateKey(t))}));a=await Promise.all(r);a.forEach((t,i)=>{e.initialControlStatesMapper[n[i]]=t})}catch(e){t.error(e)}};e._retrieveCalls=[];e._pInitialStateApplied=new Promise(t=>{e._pInitialStateAppliedResolve=t});return e}dt(r,i);var n=r.prototype;n.refreshViewBindings=async function t(){const e=await this.collectResults(this.base.viewState.adaptBindingRefreshControls);let i=Promise.resolve();e.filter(t=>t&&t.isA&&t.isA("sap.ui.base.ManagedObject")).forEach(t=>{i=i.then(this.refreshControlBinding.bind(this,t))});return i};n.adaptBindingRefreshControls=function t(e){};n.refreshControlBinding=async function e(i){const r=this.getControlRefreshBindingHandler(i);let n=Promise.resolve();if(typeof r.refreshBinding!=="function"){t.info(`refreshBinding handler for control: ${i.getMetadata().getName()} is not provided`)}else{n=n.then(r.refreshBinding.bind(this,i))}return n};n.getControlRefreshBindingHandler=function t(e){const i={};if(e){for(const t in ht){if(e.isA(t)){i["refreshBinding"]=ht[t].refreshBinding||{};break}}}this.base.viewState.adaptBindingRefreshHandler(e,i);return i};n.adaptBindingRefreshHandler=function t(e,i){};n.onSuspend=function t(){};n.onRestore=function t(){};n.destroy=function t(){delete this._pInitialStateAppliedResolve;i.prototype.destroy.call(this)};n.collectResults=async function t(e){const i=[];for(var r=arguments.length,n=new Array(r>1?r-1:0),a=1;a<r;a++){n[a-1]=arguments[a]}n.push(i);e.apply(this,n);return Promise.all(i)};n.adaptControlStateHandler=function t(e,i){};n.getControlStateHandler=function t(e){const i=[],r=[];if(e){if(e.isA("sap.fe.core.controllerextensions.viewState.IViewStateContributor")&&e.retrieveState&&e.applyState){i.push({retrieve:async t=>e.retrieveState.bind(e)(),apply:async(t,i,r,n)=>{const a=!this.invalidateInitialStateForApply.includes(e.getId())&&!this.controlsVariantIdUnavailable.includes(e.getId())&&r?.navigationType!==yt.hybrid&&n!==true;if(!i){if(e.applyLegacyState){await e.applyLegacyState.bind(e)(this.getControlState.bind(this),r,a,n)}}else{await e.applyState.bind(e)(i,r,a,n)}}})}else{for(const t in ht){if(e.isA(t)){i.push(Object.assign({},ht[t]));break}}}}this.base.viewState.adaptControlStateHandler(e,r);return i.concat(r)};n.adaptStateControls=function t(e){e.push(...this.stateContributors)};n.getStateKey=function t(e){return this.getView().getLocalId(e.getId())||e.getId()};n._retrieveViewState=async function i(){let r={};try{await this._pInitialStateApplied;const t=await this.collectResults(this.base.viewState.adaptStateControls);const i=await Promise.all(t.filter(function(t){return t&&t.isA&&t.isA("sap.ui.base.ManagedObject")}).map(async t=>this.retrieveControlState(t).then(e=>({key:this.getStateKey(t),value:e}))));r=i.reduce(function(t,i){const r={};r[i.key]=i.value;return e(t,r)},{});const n=this._currentViewState;if(n&&Object.keys(n).length>0){this._addMissingState(r,n)}const a=await Promise.resolve(this._retrieveAdditionalStates());if(a&&Object.keys(a).length){r[St]=a}}catch(e){const i=this.getView().getId();t.error(`ViewState : ${i} : failed to retrieve state!`)}return r};n.retrieveViewState=async function t(){const e=this._retrieveViewState();this._retrieveCalls.push(e);await e;const i=await Promise.allSettled(this._retrieveCalls);const r=i[i.length-1];const n=r.status==="fulfilled"?r.value:undefined;this._currentViewState=n;return n};n._addMissingState=function t(e,i){for(const t in i){if(!(t in e)){e[t]=i[t]}}};n.retrieveAdditionalStates=function t(e){};n._retrieveAdditionalStates=function t(){const e={};this.base.viewState.retrieveAdditionalStates(e);return e};n.retrieveControlState=async function t(i){const r=this.getControlStateHandler(i);return Promise.all(r.map(async t=>{if(typeof t.retrieve!=="function"){throw new Error(`controlStateHandler.retrieve is not a function for control: ${i.getMetadata().getName()}`)}return t.retrieve.call(this,i)})).then(t=>t.reduce(function(t,i){return e(t,i)},{}))};n.applyInitialStateOnly=function t(){return true};n.getControlState=function t(e){const i=this._currentViewState;let r={};if(i){const t=this.getStateKey(e);r=i[t]}return r};n.adaptApplyStateNavParams=function t(e){};n.applyViewState=async function e(i,r,n){this.base.viewState.adaptApplyStateNavParams(r);if(this.base.viewState.applyInitialStateOnly()&&this._getInitialStateApplied()&&this._currentViewState){return}try{if(this._isStateEmptyForIAppStateNavType(i,r.navigationType)&&!this.__isRootViewController()){return}await this.collectResults(this.base.viewState.onBeforeStateApplied,[],r.navigationType);const t=await this.collectResults(this.base.viewState.adaptStateControls);this.viewStateControls=t;let e=Promise.resolve();let a=false;this._currentViewState=i;this.configOfStateApply=this.configOfStateApply??{};this.configOfStateApply.skipMerge=n;this.configOfStateApply.navTypeParameters=r;this.configOfStateApply.state=i;const o=t.reduce((t,e)=>{if(!e){return t}const i=e.isA("sap.ui.fl.variants.VariantManagement");if(!a){a=i}t=i?[e,...t]:[...t,e];return t},[]);if(!a){this._setInitialStatesForDeltaCompute()}o.filter(function(t){return t.isA("sap.ui.base.ManagedObject")}).forEach(t=>{const a=this.getStateKey(t);e=e.then(this.applyControlState.bind(this,t,i?i[a]:undefined,r,n??false))});await e;if(r.navigationType===yt.iAppState||r.navigationType===yt.hybrid){await this.collectResults(this.base.viewState.applyAdditionalStates,i?i[St]:undefined)}else{await this.collectResults(this.base.viewState.applyNavigationParameters,r);const t=[];this._getPromisesForAdaptControls(o,r,t);await Promise.all(t)}}finally{try{if(!this._isStateEmptyForIAppStateNavType(i,r.navigationType)){await this.collectResults(this.base.viewState.onAfterStateApplied)}this._setInitialStateApplied()}catch(e){t.error(e)}}};n._getPromisesForAdaptControls=function t(e,i,r){e.filter(function(t){return t.isA("sap.ui.base.ManagedObject")}).forEach(t=>{if(t.isA("sap.fe.core.controllerextensions.viewState.IViewStateContributor")&&t.applyNavigationParameters)r.push(t.applyNavigationParameters(i))});return r};n._checkIfVariantIdIsAvailable=function t(e,i){const r=e.getVariants();let n=false;r.forEach(function(t){if(t.getKey()===i){n=true}});return n};n._setInitialStateApplied=function t(){if(this._pInitialStateAppliedResolve){const t=this._pInitialStateAppliedResolve;delete this._pInitialStateAppliedResolve;t()}};n._getInitialStateApplied=function t(){return!this._pInitialStateAppliedResolve};n._isStateEmptyForIAppStateNavType=function t(e,i){return(!e||Object.keys(e).length===0)&&i==yt.iAppState};n.__isRootViewController=function t(){const e=this.base.getView().getController();return e.isA("sap.fe.core.rootView.NavContainer")||e.isA("sap.fe.core.rootView.Fcl")};n.onBeforeStateApplied=function t(e,i){};n.onAfterStateApplied=function t(e){};n.applyAdditionalStates=function t(e,i){};n.applyNavigationParameters=function t(e,i){};n.applyControlState=async function t(e,i,r,n){const a=this.getControlStateHandler(e);let o=Promise.resolve();a.forEach(t=>{if(typeof t.apply!=="function"){throw new Error(`controlStateHandler.apply is not a function for control: ${e.getMetadata().getName()}`)}o=o.then(t.apply.bind(this,e,i,r,n))});return o};n.updateAppStateDebounced=function t(){if(this.updateAppStateTimer){clearTimeout(this.updateAppStateTimer)}this.updateAppStateTimer=setTimeout(()=>{this.base.getExtensionAPI().updateAppState()},200)};n.registerStateContributor=function t(e){if(this.stateContributors.includes(e)){return}this.stateContributors.push(e);if(this._currentViewState){const t=this.getStateKey(e);const i=this._currentViewState[t];const r=this.configOfStateApply?.navTypeParameters?.navigationType;const n=this.configOfStateApply?.skipMerge;if(i&&i===this.configOfStateApply?.state?.[t]){const t=!this.invalidateInitialStateForApply.includes(e.getId())&&!this.controlsVariantIdUnavailable.includes(e.getId())&&r!==yt.hybrid&&n!==true;e.applyState(i,undefined,t)}else{this.updateAppStateDebounced()}}};n.deregisterStateContributor=function t(e){const i=this.stateContributors.findIndex(t=>t==e);if(i!==-1){this.stateContributors.splice(i,1)}};n.getInterface=function t(){return this};n._getControlState=function t(e,i){const r=this.initialControlStatesMapper;if(Object.keys(r).length>0&&r[e]){if(Object.keys(r[e]).length===0){r[e]={...i}}return{fullState:i,initialState:r[e]}}return i};n._addEventListenersToVariantManagement=function t(e,i){const r={variantManagedControls:i};const n=()=>{this._updateInitialStatesOnVariantChange(i)};e.attachSave(r,n,{});e.attachSelect(r,n,{})};n._updateInitialStatesOnVariantChange=function t(e){const i=this.initialControlStatesMapper;Object.keys(i).forEach(t=>{for(const r of e){if(r.includes(t)){i[t]={}}}});this.updateInitialState(e)};n.updateInitialState=async function t(e){const i=this.stateContributors;await Promise.all(i.map(async t=>{const i=t?.getId();if(e.includes(i)&&t?.isA("sap.fe.core.controllerextensions.viewState.IViewStateContributor")&&t.setInitialState){await t.setInitialState()}}))};n._isInitialStatesApplicable=function t(e,i,r,n){return!!e&&!this.invalidateInitialStateForApply.includes(i.getId())&&!this.controlsVariantIdUnavailable.includes(i.getId())&&(n??true)&&r!==true};return r}(n),ft(nt.prototype,"refreshViewBindings",[s,p],Object.getOwnPropertyDescriptor(nt.prototype,"refreshViewBindings"),nt.prototype),ft(nt.prototype,"adaptBindingRefreshControls",[l,c],Object.getOwnPropertyDescriptor(nt.prototype,"adaptBindingRefreshControls"),nt.prototype),ft(nt.prototype,"refreshControlBinding",[d,u],Object.getOwnPropertyDescriptor(nt.prototype,"refreshControlBinding"),nt.prototype),ft(nt.prototype,"getControlRefreshBindingHandler",[f,y],Object.getOwnPropertyDescriptor(nt.prototype,"getControlRefreshBindingHandler"),nt.prototype),ft(nt.prototype,"adaptBindingRefreshHandler",[S,g],Object.getOwnPropertyDescriptor(nt.prototype,"adaptBindingRefreshHandler"),nt.prototype),ft(nt.prototype,"onSuspend",[h,v],Object.getOwnPropertyDescriptor(nt.prototype,"onSuspend"),nt.prototype),ft(nt.prototype,"onRestore",[w,b],Object.getOwnPropertyDescriptor(nt.prototype,"onRestore"),nt.prototype),ft(nt.prototype,"collectResults",[A,C],Object.getOwnPropertyDescriptor(nt.prototype,"collectResults"),nt.prototype),ft(nt.prototype,"adaptControlStateHandler",[I,O],Object.getOwnPropertyDescriptor(nt.prototype,"adaptControlStateHandler"),nt.prototype),ft(nt.prototype,"getControlStateHandler",[m,P],Object.getOwnPropertyDescriptor(nt.prototype,"getControlStateHandler"),nt.prototype),ft(nt.prototype,"adaptStateControls",[_,V],Object.getOwnPropertyDescriptor(nt.prototype,"adaptStateControls"),nt.prototype),ft(nt.prototype,"getStateKey",[j,R],Object.getOwnPropertyDescriptor(nt.prototype,"getStateKey"),nt.prototype),ft(nt.prototype,"_retrieveViewState",[B,D],Object.getOwnPropertyDescriptor(nt.prototype,"_retrieveViewState"),nt.prototype),ft(nt.prototype,"retrieveViewState",[K,E],Object.getOwnPropertyDescriptor(nt.prototype,"retrieveViewState"),nt.prototype),ft(nt.prototype,"retrieveAdditionalStates",[M,T],Object.getOwnPropertyDescriptor(nt.prototype,"retrieveAdditionalStates"),nt.prototype),ft(nt.prototype,"retrieveControlState",[H,F],Object.getOwnPropertyDescriptor(nt.prototype,"retrieveControlState"),nt.prototype),ft(nt.prototype,"applyInitialStateOnly",[N,x],Object.getOwnPropertyDescriptor(nt.prototype,"applyInitialStateOnly"),nt.prototype),ft(nt.prototype,"adaptApplyStateNavParams",[k,L],Object.getOwnPropertyDescriptor(nt.prototype,"adaptApplyStateNavParams"),nt.prototype),ft(nt.prototype,"applyViewState",[U,z],Object.getOwnPropertyDescriptor(nt.prototype,"applyViewState"),nt.prototype),ft(nt.prototype,"_checkIfVariantIdIsAvailable",[$],Object.getOwnPropertyDescriptor(nt.prototype,"_checkIfVariantIdIsAvailable"),nt.prototype),ft(nt.prototype,"onBeforeStateApplied",[q,G],Object.getOwnPropertyDescriptor(nt.prototype,"onBeforeStateApplied"),nt.prototype),ft(nt.prototype,"onAfterStateApplied",[Q,W],Object.getOwnPropertyDescriptor(nt.prototype,"onAfterStateApplied"),nt.prototype),ft(nt.prototype,"applyAdditionalStates",[J,X],Object.getOwnPropertyDescriptor(nt.prototype,"applyAdditionalStates"),nt.prototype),ft(nt.prototype,"applyNavigationParameters",[Y,Z],Object.getOwnPropertyDescriptor(nt.prototype,"applyNavigationParameters"),nt.prototype),ft(nt.prototype,"applyControlState",[tt,et],Object.getOwnPropertyDescriptor(nt.prototype,"applyControlState"),nt.prototype),ft(nt.prototype,"updateAppStateDebounced",[it],Object.getOwnPropertyDescriptor(nt.prototype,"updateAppStateDebounced"),nt.prototype),nt))||rt);return vt},false);
//# sourceMappingURL=ViewState.js.map