{"version":3,"names":["ProgrammingModel","FELibrary","getConvertedAction","context","operation","operationName","getActionName","metaModel","getModel","getMetaModel","actionPath","getMetaPath","getPath","boundAction","createBindingContext","convertTypes","resolvePath","target","model","sEntitySetPath","getObject","editDocumentInStickySession","appComponent","messageHandler","convertedAction","result","Operation","contexts","label","getResourceModel","getText","skipMessages","oDataProperties","disableSideEffects","ignoreETag","isEmptyObject","groupId","replaceWithRVC","getBinding","isA","deferredSubmit","bindingParameters","$$inheritExpandSelect","execute","status","Error","reason","newContext","value","returnedContext","sideEffects","getSideEffectsService","getODataActionSideEffects","triggerActions","length","requestSideEffectsForODataAction","activateDocument","mParameters","isStandardSave","metaPath","resourceModel","messagesPath","requestSideEffects","error","Log","undefined","discardDocument","discardActionAnnotation","discardAction","bindContext","invoke","then","processDataLossConfirmation","fnProcess","view","programmingModel","uiEditable","CommonUtils","getIsEditable","resourceBundle","Library","getResourceBundleFor","warningMsg","confirmButtonTxt","cancelButtonTxt","Sticky","MessageBox","warning","actions","emphasizedAction","onClose","actionText","info","sticky"],"sourceRoot":".","sources":["sticky.ts"],"sourcesContent":["import type { Action as EdmAction } from \"@sap-ux/vocabularies-types\";\nimport { CommonAnnotationTerms } from \"@sap-ux/vocabularies-types/vocabularies/Common\";\nimport Log from \"sap/base/Log\";\nimport isEmptyObject from \"sap/base/util/isEmptyObject\";\nimport type AppComponent from \"sap/fe/core/AppComponent\";\nimport type { FEView } from \"sap/fe/core/BaseController\";\nimport CommonUtils from \"sap/fe/core/CommonUtils\";\nimport type ResourceModel from \"sap/fe/core/ResourceModel\";\nimport { getResourceModel } from \"sap/fe/core/helpers/ResourceModelHelper\";\nimport FELibrary from \"sap/fe/core/library\";\nimport MessageBox from \"sap/m/MessageBox\";\nimport Library from \"sap/ui/core/Lib\";\nimport type Context from \"sap/ui/model/odata/v4/Context\";\nimport { convertTypes } from \"../../converters/MetaModelConverter\";\nimport type MessageHandler from \"../MessageHandler\";\nimport Operation from \"./operations/Operation\";\n\nconst ProgrammingModel = FELibrary.ProgrammingModel;\n\n/**\n * Gets the converted action for a given context and operation.\n * @param context  The context that should be bound to the operation\n * @param operation The operation name\n * @returns The converted action\n */\nfunction getConvertedAction(context: Context, operation: string): EdmAction | undefined {\n\tconst operationName = getActionName(context, operation);\n\tconst metaModel = context.getModel().getMetaModel(),\n\t\tactionPath = `${metaModel.getMetaPath(context.getPath())}/${operationName}`,\n\t\tboundAction = metaModel.createBindingContext(actionPath)!;\n\treturn convertTypes(metaModel).resolvePath<EdmAction | undefined>(boundAction.getPath()).target;\n}\n\n/**\n * Determines the action name for a draft operation.\n * @param context The context that should be bound to the operation\n * @param operation The operation name\n * @returns The name of the draft operation\n */\nfunction getActionName(context: Context, operation: string): string {\n\tconst model = context.getModel(),\n\t\tmetaModel = model.getMetaModel(),\n\t\tsEntitySetPath = metaModel.getMetaPath(context.getPath());\n\n\treturn metaModel.getObject(`${sEntitySetPath}@com.sap.vocabularies.Session.v1.StickySessionSupported/${operation}`);\n}\n\n/**\n * Opens a sticky session to edit a document.\n * @param context Context of the document to be edited\n * @param appComponent The AppComponent\n * @param messageHandler The message handler controller extension\n * @returns A Promise resolved when the sticky session is in edit mode\n */\nasync function editDocumentInStickySession(\n\tcontext: Context,\n\tappComponent: AppComponent,\n\tmessageHandler: MessageHandler\n): Promise<Context | undefined> {\n\tconst operation = \"EditAction\";\n\tconst convertedAction = getConvertedAction(context, operation);\n\tif (convertedAction) {\n\t\tconst result = await new Operation(appComponent, context.getModel(), convertedAction, {\n\t\t\tmessageHandler: messageHandler,\n\t\t\tcontexts: [context],\n\t\t\tlabel: getResourceModel(appComponent).getText(\"C_COMMON_OBJECT_PAGE_EDIT\"),\n\t\t\tskipMessages: true,\n\t\t\toDataProperties: {\n\t\t\t\tdisableSideEffects: true,\n\t\t\t\tignoreETag: isEmptyObject(context.getObject()), // If the context has not been loaded yet, we can ignore the ETag (as no previous ETag is available)\n\t\t\t\tgroupId: \"direct\",\n\t\t\t\treplaceWithRVC: context.getBinding().isA(\"sap.ui.model.odata.v4.ODataListBinding\"),\n\t\t\t\tdeferredSubmit: false\n\t\t\t},\n\t\t\tbindingParameters: { $$inheritExpandSelect: true }\n\t\t}).execute();\n\t\tif (result[0].status === \"rejected\") {\n\t\t\tthrow new Error(result[0].reason);\n\t\t} else {\n\t\t\tconst newContext = result[0].value.returnedContext;\n\t\t\tif (newContext) {\n\t\t\t\tconst sideEffects = appComponent\n\t\t\t\t\t.getSideEffectsService()\n\t\t\t\t\t.getODataActionSideEffects(getActionName(context, operation), newContext);\n\t\t\t\tif (sideEffects?.triggerActions && sideEffects.triggerActions.length) {\n\t\t\t\t\tawait appComponent.getSideEffectsService().requestSideEffectsForODataAction(sideEffects, newContext);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn newContext;\n\t\t}\n\t} else {\n\t\tthrow new Error(`Edit Action for Sticky Session not found for ${operation}`);\n\t}\n}\n/**\n * Activates a document and closes the sticky session.\n * @param context Context of the document to be activated\n * @param appComponent Context of the document to be activated\n * @param messageHandler The message handler controller extension\n * @param mParameters The parameters\n * @param [mParameters.resourceModel] Resource Model\n * @returns A promise resolve when the sticky session is activated\n */\nasync function activateDocument(\n\tcontext: Context,\n\tappComponent: AppComponent,\n\tmessageHandler: MessageHandler,\n\tmParameters: { resourceModel?: ResourceModel },\n\tisStandardSave?: boolean | undefined\n): Promise<Context> {\n\tconst operation = \"SaveAction\";\n\tconst model = context.getModel(),\n\t\tmetaModel = model.getMetaModel(),\n\t\tmetaPath = metaModel.getMetaPath(context.getPath());\n\n\tconst convertedAction = getConvertedAction(context, operation);\n\tconst label = isStandardSave\n\t\t? mParameters?.resourceModel?.getText(\"T_OP_OBJECT_PAGE_SAVE\")\n\t\t: mParameters?.resourceModel?.getText(\"C_OP_OBJECT_PAGE_SAVE\");\n\tif (convertedAction) {\n\t\tconst result = await new Operation(appComponent, context.getModel(), convertedAction, {\n\t\t\tmessageHandler: messageHandler,\n\t\t\tcontexts: [context],\n\t\t\tlabel: label,\n\t\t\tskipMessages: true,\n\t\t\toDataProperties: {\n\t\t\t\tdisableSideEffects: true,\n\t\t\t\tignoreETag: isEmptyObject(context.getObject()), // If the context has not been loaded yet, we can ignore the ETag (as no previous ETag is available)\n\t\t\t\tgroupId: \"direct\",\n\t\t\t\treplaceWithRVC: context.getBinding().isA(\"sap.ui.model.odata.v4.ODataListBinding\"),\n\t\t\t\tdeferredSubmit: false\n\t\t\t},\n\t\t\tbindingParameters: { $$inheritExpandSelect: true }\n\t\t}).execute();\n\n\t\tif (result[0].status === \"rejected\") {\n\t\t\tconst messagesPath = metaModel.getObject(`${metaPath}/@${CommonAnnotationTerms.Messages}/$Path`) as string | undefined;\n\n\t\t\tif (messagesPath) {\n\t\t\t\ttry {\n\t\t\t\t\tawait appComponent.getSideEffectsService().requestSideEffects([messagesPath], context);\n\t\t\t\t} catch (error: unknown) {\n\t\t\t\t\tLog.error(\"Error while requesting side effects\", error as string);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new Error(result[0].reason);\n\t\t} else if (result[0].value.returnedContext === undefined) {\n\t\t\tthrow new Error(`Save Action for Sticky Session doesn't return a context for ${metaPath}`);\n\t\t}\n\t\treturn result[0].value.returnedContext;\n\t} else {\n\t\tthrow new Error(`Save Action for Sticky Session not found for ${metaPath}`);\n\t}\n}\n/**\n * Discards a document and closes sticky session.\n * @param context Context of the document to be discarded\n * @returns A promise resolved when the document is dicarded\n */\nasync function discardDocument(context: Context): Promise<Context> {\n\tconst model = context.getModel(),\n\t\tmetaModel = model.getMetaModel(),\n\t\tmetaPath = metaModel.getMetaPath(context.getPath()),\n\t\tdiscardActionAnnotation = metaModel.getObject(`${metaPath}@com.sap.vocabularies.Session.v1.StickySessionSupported/DiscardAction`);\n\n\tif (!discardActionAnnotation) {\n\t\tthrow new Error(`Discard Action for Sticky Session not found for ${metaPath}`);\n\t}\n\n\tconst discardAction = model.bindContext(`/${discardActionAnnotation}(...)`);\n\treturn discardAction.invoke(\"$single\").then(function () {\n\t\treturn context;\n\t});\n}\n\n/**\n * Process the Data loss confirmation.\n * @param fnProcess Function to execute after confirmation\n * @param view Current view\n * @param programmingModel Programming Model of the current page\n * @returns `void` i think\n */\nfunction processDataLossConfirmation(fnProcess: Function, view: FEView, programmingModel: string): void {\n\tconst uiEditable = CommonUtils.getIsEditable(view),\n\t\tresourceBundle = Library.getResourceBundleFor(\"sap.fe.templates\")!,\n\t\twarningMsg = resourceBundle.getText(\"T_COMMON_UTILS_NAVIGATION_AWAY_MSG\"),\n\t\tconfirmButtonTxt = resourceBundle.getText(\"T_COMMON_UTILS_NAVIGATION_AWAY_CONFIRM_BUTTON\"),\n\t\tcancelButtonTxt = resourceBundle.getText(\"T_COMMON_UTILS_NAVIGATION_AWAY_CANCEL_BUTTON\");\n\n\tif (programmingModel === ProgrammingModel.Sticky && uiEditable) {\n\t\treturn MessageBox.warning(warningMsg, {\n\t\t\tactions: [confirmButtonTxt, cancelButtonTxt],\n\t\t\temphasizedAction: confirmButtonTxt,\n\t\t\tonClose: function (actionText: string) {\n\t\t\t\tif (actionText === confirmButtonTxt) {\n\t\t\t\t\tLog.info(\"Navigation confirmed.\");\n\t\t\t\t\tfnProcess();\n\t\t\t\t} else {\n\t\t\t\t\tLog.info(\"Navigation rejected.\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\treturn fnProcess();\n}\n\n/**\n * Static functions for the sticky session programming model\n * @namespace\n * @since 1.54.0\n */\nconst sticky = {\n\teditDocumentInStickySession: editDocumentInStickySession,\n\tactivateDocument: activateDocument,\n\tdiscardDocument: discardDocument,\n\tprocessDataLossConfirmation: processDataLossConfirmation\n};\n\nexport default sticky;\n"],"mappings":";;;;;;;;;EAiBA,MAAMA,gBAAgB,GAAGC,SAAS,CAACD,gBAAgB;;EAEnD;AACA;AACA;AACA;AACA;AACA;EACA,SAASE,kBAAkBA,CAACC,OAAgB,EAAEC,SAAiB,EAAyB;IACvF,MAAMC,aAAa,GAAGC,aAAa,CAACH,OAAO,EAAEC,SAAS,CAAC;IACvD,MAAMG,SAAS,GAAGJ,OAAO,CAACK,QAAQ,CAAC,CAAC,CAACC,YAAY,CAAC,CAAC;MAClDC,UAAU,GAAG,GAAGH,SAAS,CAACI,WAAW,CAACR,OAAO,CAACS,OAAO,CAAC,CAAC,CAAC,IAAIP,aAAa,EAAE;MAC3EQ,WAAW,GAAGN,SAAS,CAACO,oBAAoB,CAACJ,UAAU,CAAE;IAC1D,OAAOK,YAAY,CAACR,SAAS,CAAC,CAACS,WAAW,CAAwBH,WAAW,CAACD,OAAO,CAAC,CAAC,CAAC,CAACK,MAAM;EAChG;;EAEA;AACA;AACA;AACA;AACA;AACA;EACA,SAASX,aAAaA,CAACH,OAAgB,EAAEC,SAAiB,EAAU;IACnE,MAAMc,KAAK,GAAGf,OAAO,CAACK,QAAQ,CAAC,CAAC;MAC/BD,SAAS,GAAGW,KAAK,CAACT,YAAY,CAAC,CAAC;MAChCU,cAAc,GAAGZ,SAAS,CAACI,WAAW,CAACR,OAAO,CAACS,OAAO,CAAC,CAAC,CAAC;IAE1D,OAAOL,SAAS,CAACa,SAAS,CAAC,GAAGD,cAAc,2DAA2Df,SAAS,EAAE,CAAC;EACpH;;EAEA;AACA;AACA;AACA;AACA;AACA;AACA;EACA,eAAeiB,2BAA2BA,CACzClB,OAAgB,EAChBmB,YAA0B,EAC1BC,cAA8B,EACC;IAC/B,MAAMnB,SAAS,GAAG,YAAY;IAC9B,MAAMoB,eAAe,GAAGtB,kBAAkB,CAACC,OAAO,EAAEC,SAAS,CAAC;IAC9D,IAAIoB,eAAe,EAAE;MACpB,MAAMC,MAAM,GAAG,MAAM,IAAIC,SAAS,CAACJ,YAAY,EAAEnB,OAAO,CAACK,QAAQ,CAAC,CAAC,EAAEgB,eAAe,EAAE;QACrFD,cAAc,EAAEA,cAAc;QAC9BI,QAAQ,EAAE,CAACxB,OAAO,CAAC;QACnByB,KAAK,EAAEC,gBAAgB,CAACP,YAAY,CAAC,CAACQ,OAAO,CAAC,2BAA2B,CAAC;QAC1EC,YAAY,EAAE,IAAI;QAClBC,eAAe,EAAE;UAChBC,kBAAkB,EAAE,IAAI;UACxBC,UAAU,EAAEC,aAAa,CAAChC,OAAO,CAACiB,SAAS,CAAC,CAAC,CAAC;UAAE;UAChDgB,OAAO,EAAE,QAAQ;UACjBC,cAAc,EAAElC,OAAO,CAACmC,UAAU,CAAC,CAAC,CAACC,GAAG,CAAC,wCAAwC,CAAC;UAClFC,cAAc,EAAE;QACjB,CAAC;QACDC,iBAAiB,EAAE;UAAEC,qBAAqB,EAAE;QAAK;MAClD,CAAC,CAAC,CAACC,OAAO,CAAC,CAAC;MACZ,IAAIlB,MAAM,CAAC,CAAC,CAAC,CAACmB,MAAM,KAAK,UAAU,EAAE;QACpC,MAAM,IAAIC,KAAK,CAACpB,MAAM,CAAC,CAAC,CAAC,CAACqB,MAAM,CAAC;MAClC,CAAC,MAAM;QACN,MAAMC,UAAU,GAAGtB,MAAM,CAAC,CAAC,CAAC,CAACuB,KAAK,CAACC,eAAe;QAClD,IAAIF,UAAU,EAAE;UACf,MAAMG,WAAW,GAAG5B,YAAY,CAC9B6B,qBAAqB,CAAC,CAAC,CACvBC,yBAAyB,CAAC9C,aAAa,CAACH,OAAO,EAAEC,SAAS,CAAC,EAAE2C,UAAU,CAAC;UAC1E,IAAIG,WAAW,EAAEG,cAAc,IAAIH,WAAW,CAACG,cAAc,CAACC,MAAM,EAAE;YACrE,MAAMhC,YAAY,CAAC6B,qBAAqB,CAAC,CAAC,CAACI,gCAAgC,CAACL,WAAW,EAAEH,UAAU,CAAC;UACrG;QACD;QACA,OAAOA,UAAU;MAClB;IACD,CAAC,MAAM;MACN,MAAM,IAAIF,KAAK,CAAC,gDAAgDzC,SAAS,EAAE,CAAC;IAC7E;EACD;EACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACA,eAAeoD,gBAAgBA,CAC9BrD,OAAgB,EAChBmB,YAA0B,EAC1BC,cAA8B,EAC9BkC,WAA8C,EAC9CC,cAAoC,EACjB;IACnB,MAAMtD,SAAS,GAAG,YAAY;IAC9B,MAAMc,KAAK,GAAGf,OAAO,CAACK,QAAQ,CAAC,CAAC;MAC/BD,SAAS,GAAGW,KAAK,CAACT,YAAY,CAAC,CAAC;MAChCkD,QAAQ,GAAGpD,SAAS,CAACI,WAAW,CAACR,OAAO,CAACS,OAAO,CAAC,CAAC,CAAC;IAEpD,MAAMY,eAAe,GAAGtB,kBAAkB,CAACC,OAAO,EAAEC,SAAS,CAAC;IAC9D,MAAMwB,KAAK,GAAG8B,cAAc,GACzBD,WAAW,EAAEG,aAAa,EAAE9B,OAAO,CAAC,uBAAuB,CAAC,GAC5D2B,WAAW,EAAEG,aAAa,EAAE9B,OAAO,CAAC,uBAAuB,CAAC;IAC/D,IAAIN,eAAe,EAAE;MACpB,MAAMC,MAAM,GAAG,MAAM,IAAIC,SAAS,CAACJ,YAAY,EAAEnB,OAAO,CAACK,QAAQ,CAAC,CAAC,EAAEgB,eAAe,EAAE;QACrFD,cAAc,EAAEA,cAAc;QAC9BI,QAAQ,EAAE,CAACxB,OAAO,CAAC;QACnByB,KAAK,EAAEA,KAAK;QACZG,YAAY,EAAE,IAAI;QAClBC,eAAe,EAAE;UAChBC,kBAAkB,EAAE,IAAI;UACxBC,UAAU,EAAEC,aAAa,CAAChC,OAAO,CAACiB,SAAS,CAAC,CAAC,CAAC;UAAE;UAChDgB,OAAO,EAAE,QAAQ;UACjBC,cAAc,EAAElC,OAAO,CAACmC,UAAU,CAAC,CAAC,CAACC,GAAG,CAAC,wCAAwC,CAAC;UAClFC,cAAc,EAAE;QACjB,CAAC;QACDC,iBAAiB,EAAE;UAAEC,qBAAqB,EAAE;QAAK;MAClD,CAAC,CAAC,CAACC,OAAO,CAAC,CAAC;MAEZ,IAAIlB,MAAM,CAAC,CAAC,CAAC,CAACmB,MAAM,KAAK,UAAU,EAAE;QACpC,MAAMiB,YAAY,GAAGtD,SAAS,CAACa,SAAS,CAAC,GAAGuC,QAAQ,sDAA2C,CAAuB;QAEtH,IAAIE,YAAY,EAAE;UACjB,IAAI;YACH,MAAMvC,YAAY,CAAC6B,qBAAqB,CAAC,CAAC,CAACW,kBAAkB,CAAC,CAACD,YAAY,CAAC,EAAE1D,OAAO,CAAC;UACvF,CAAC,CAAC,OAAO4D,KAAc,EAAE;YACxBC,GAAG,CAACD,KAAK,CAAC,qCAAqC,EAAEA,KAAe,CAAC;UAClE;QACD;QACA,MAAM,IAAIlB,KAAK,CAACpB,MAAM,CAAC,CAAC,CAAC,CAACqB,MAAM,CAAC;MAClC,CAAC,MAAM,IAAIrB,MAAM,CAAC,CAAC,CAAC,CAACuB,KAAK,CAACC,eAAe,KAAKgB,SAAS,EAAE;QACzD,MAAM,IAAIpB,KAAK,CAAC,+DAA+Dc,QAAQ,EAAE,CAAC;MAC3F;MACA,OAAOlC,MAAM,CAAC,CAAC,CAAC,CAACuB,KAAK,CAACC,eAAe;IACvC,CAAC,MAAM;MACN,MAAM,IAAIJ,KAAK,CAAC,gDAAgDc,QAAQ,EAAE,CAAC;IAC5E;EACD;EACA;AACA;AACA;AACA;AACA;EACA,eAAeO,eAAeA,CAAC/D,OAAgB,EAAoB;IAClE,MAAMe,KAAK,GAAGf,OAAO,CAACK,QAAQ,CAAC,CAAC;MAC/BD,SAAS,GAAGW,KAAK,CAACT,YAAY,CAAC,CAAC;MAChCkD,QAAQ,GAAGpD,SAAS,CAACI,WAAW,CAACR,OAAO,CAACS,OAAO,CAAC,CAAC,CAAC;MACnDuD,uBAAuB,GAAG5D,SAAS,CAACa,SAAS,CAAC,GAAGuC,QAAQ,uEAAuE,CAAC;IAElI,IAAI,CAACQ,uBAAuB,EAAE;MAC7B,MAAM,IAAItB,KAAK,CAAC,mDAAmDc,QAAQ,EAAE,CAAC;IAC/E;IAEA,MAAMS,aAAa,GAAGlD,KAAK,CAACmD,WAAW,CAAC,IAAIF,uBAAuB,OAAO,CAAC;IAC3E,OAAOC,aAAa,CAACE,MAAM,CAAC,SAAS,CAAC,CAACC,IAAI,CAAC,YAAY;MACvD,OAAOpE,OAAO;IACf,CAAC,CAAC;EACH;;EAEA;AACA;AACA;AACA;AACA;AACA;AACA;EACA,SAASqE,2BAA2BA,CAACC,SAAmB,EAAEC,IAAY,EAAEC,gBAAwB,EAAQ;IACvG,MAAMC,UAAU,GAAGC,WAAW,CAACC,aAAa,CAACJ,IAAI,CAAC;MACjDK,cAAc,GAAGC,OAAO,CAACC,oBAAoB,CAAC,kBAAkB,CAAE;MAClEC,UAAU,GAAGH,cAAc,CAACjD,OAAO,CAAC,oCAAoC,CAAC;MACzEqD,gBAAgB,GAAGJ,cAAc,CAACjD,OAAO,CAAC,+CAA+C,CAAC;MAC1FsD,eAAe,GAAGL,cAAc,CAACjD,OAAO,CAAC,8CAA8C,CAAC;IAEzF,IAAI6C,gBAAgB,KAAK3E,gBAAgB,CAACqF,MAAM,IAAIT,UAAU,EAAE;MAC/D,OAAOU,UAAU,CAACC,OAAO,CAACL,UAAU,EAAE;QACrCM,OAAO,EAAE,CAACL,gBAAgB,EAAEC,eAAe,CAAC;QAC5CK,gBAAgB,EAAEN,gBAAgB;QAClCO,OAAO,EAAE,SAAAA,CAAUC,UAAkB,EAAE;UACtC,IAAIA,UAAU,KAAKR,gBAAgB,EAAE;YACpCnB,GAAG,CAAC4B,IAAI,CAAC,uBAAuB,CAAC;YACjCnB,SAAS,CAAC,CAAC;UACZ,CAAC,MAAM;YACNT,GAAG,CAAC4B,IAAI,CAAC,sBAAsB,CAAC;UACjC;QACD;MACD,CAAC,CAAC;IACH;IACA,OAAOnB,SAAS,CAAC,CAAC;EACnB;;EAEA;AACA;AACA;AACA;AACA;EACA,MAAMoB,MAAM,GAAG;IACdxE,2BAA2B,EAAEA,2BAA2B;IACxDmC,gBAAgB,EAAEA,gBAAgB;IAClCU,eAAe,EAAEA,eAAe;IAChCM,2BAA2B,EAAEA;EAC9B,CAAC;EAAC,OAEaqB,MAAM;AAAA","ignoreList":[],"file":"sticky-dbg.js"}