/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/base/BindingToolkit","sap/fe/core/controls/Any","sap/fe/core/helpers/TypeGuards","sap/fe/core/library","sap/fe/core/templating/ActionHelper","sap/m/MessageBox","../../../converters/MetaModelConverter","../../../helpers/ResourceModelHelper","./ODataOperation","./OperationMessage","./OperationParameters","./actionHelper"],function(e,t,a,s,i,n,o,r,c,l,p,m){"use strict";var h={};var g=o.getInvolvedDataModelObjects;var u=o.convertTypes;var d=i.getIsActionCriticalExpression;var f=a.isRejected;var P=e.isConstant;var C=e.compileExpression;var D=e.compileConstant;const v=s.InvocationGrouping;let x=function(){function e(e,t,a,s){this.executionPromise=new Promise((e,t)=>{this.executionResolve=e;this.executionReject=t});this.parametersValues={};this.numberOfODataExecutions=0;this.externalParametersValues=false;this.appComponent=e;this.model=t;this.convertedAction=a;this.parameters=s;this.contexts=s.contexts??[];this.setMessageCollectedPromise();this.entitySetName=s.entitySetName??(this.convertedAction.isBound&&this.contexts[0]!==undefined?this.model.getMetaModel().getMetaContext(this.contexts[0].getPath()).getObject("@sapui.name"):undefined);this.operationMessage=new l({messageHandler:this.parameters.messageHandler,action:this.convertedAction,contexts:this.contexts,label:this.parameters.label,invocationGrouping:this.parameters.invocationGrouping,disableNotification:this.parameters.skipMessages,entitySetName:this.entitySetName,events:{onMessageCollected:()=>{this.manageDialogOnMessages();this.messageCollectedResolve()},onMessagePageNavigationCallback:()=>{this.operationParameters.closeParameterDialog()}}});this.operationParameters=new p(this.appComponent,this.model,this.convertedAction,this.parameters.skipParameterDialog,{contexts:this.contexts,defaultValuesExtensionFunction:this.parameters.defaultValuesExtensionFunction,isCreateAction:this.parameters.isCreateAction,label:this.parameters.label,parameterValues:this.parameters.parameterValues,entitySetName:this.entitySetName,view:this.parameters.view,messageHandler:this.parameters.messageHandler,events:{onParameterDialogOpened:this.operationMessage.onParameterDialogOpened.bind(this.operationMessage),onParameterDialogClosed:this.operationMessage.onParameterDialogClosed.bind(this.operationMessage)}})}h=e;var a=e.prototype;a.clear=function e(){this.operationParameters.closeParameterDialog();this.odataOperation?.clear()};a.setDefaultParametersValues=function e(t){this.parametersValues=t;this.externalParametersValues=true};a.execute=async function e(){this.internalExecution();return this.executionPromise};a.internalExecution=async function e(){let t=[];try{this.numberOfODataExecutions++;if(!this.externalParametersValues){this.parametersValues=await this.operationParameters.getOperationParameters()}if(this.numberOfODataExecutions===1){await this.confirmAction()}this.odataOperation=new c(this.convertedAction,{appComponent:this.appComponent,contexts:this.contexts,model:this.model,label:this.parameters.label,invocationGrouping:this.parameters.invocationGrouping,disableStrictHandling:this.parameters.oDataProperties?.disableStrictHandling,disableSideEffects:this.parameters.oDataProperties?.disableSideEffects,ghostContextBindingProtection:this.parameters.oDataProperties?.ghostContextBindingProtection,events:{onStrictValidation:this.parameters.oDataEvents?.onStrictValidation,onStrictCancel:this.parameters.oDataEvents?.onStrictCancel,onStrictResponse:e=>{this.parameters.messageHandler.addWarningMessagesToMessageHandler(e);this.operationMessage.onStrictHandling()},onODataResponse:this.parameters.oDataEvents?.onODataResponse,onODataSubmit:this.parameters.oDataEvents?.onODataSubmit,onRequestSideEffects:this.parameters.oDataEvents?.onRequestSideEffects},parametersValues:this.parametersValues},{enhance$select:this.parameters.oDataProperties?.enhance$select,groupId:this.parameters.oDataProperties?.groupId,replaceWithRVC:this.parameters.oDataProperties?.replaceWithRVC,ignoreETag:this.parameters.oDataProperties?.ignoreETag,bindingParameters:this.parameters.bindingParameters,deferredSubmit:this.parameters.oDataProperties?.deferredSubmit});t=await this.odataOperation.execute();this.operationMessage.reactToOperations(t);if(this.operationParameters.isParameterDialog()){if(!t.some(f)){this.closeDialog()}else{await this.messageCollectedPromise}}if(this.operationParameters.isParameterDialogOpened()){this.setMessageCollectedPromise();this.internalExecution()}else{this.executionResolve(t)}}catch(e){this.executionReject(e)}};a.manageDialogOnMessages=function e(){const t=this.operationMessage.isErrorIntoParameterDialog();if(m.isStaticAction(this.convertedAction)||this.contexts.length===0){return this.resetDialog()}else if(this.parameters.invocationGrouping===v.ChangeSet){if(t||this.odataOperation?.isStrictCanceled()===true){return this.resetDialog()}else{return this.closeDialog()}}else if(this.parameters.contexts&&this.parameters.contexts.length>1||!t){return this.closeDialog()}return this.resetDialog()};a.setMessageCollectedPromise=function e(){this.messageCollectedPromise=new Promise(e=>{this.messageCollectedResolve=e})};a.closeDialog=function e(){this.operationParameters.closeParameterDialog()};a.resetDialog=function e(){this.operationParameters.resetParameterDialogState()};a.getOperationResults=async function e(){return this.executionPromise};a.isActionCritical=async function e(){const a=this.parameters.contexts?.[0];let s=true;const i=d(this.convertedAction,u(this.model.getMetaModel()));if(P(i)){s=D(i,false,undefined,true)}else if(a){const e=new t({anyBoolean:C(i)});e.setModel(a.getModel());e.setBindingContext(a);const s=e.getBinding("anyBoolean");if(s){if(s.isA("sap.ui.model.CompositeBinding")){await Promise.all(s.getBindings().map(e=>e.requestValue?.()))}else{await(s.requestValue?.())}}}return s};a.confirmAction=async function e(){if(!this.operationParameters.isParameterDialog()){const e=await this.isActionCritical();if(e){const e=m.getActionName(this.convertedAction);await new Promise((t,a)=>{const i=e.includes(".")?e.split(".")[e.split(".").length-1]:e;const o=i&&this.entitySetName?`${this.entitySetName}|${i}`:"";n.confirm(r.getResourceModel(this.parameters.view??this.appComponent).getText("C_OPERATIONS_ACTION_CONFIRM_MESSAGE",undefined,o),{title:this.getConfirmTitle(o),onClose:e=>{if(e===n.Action.OK){t(true)}else{a(new Error(s.Constants.CancelActionDialog))}}})})}}};a.getConfirmTitle=function e(t){if(!this.parameters.view){return undefined}const a="C_OPERATIONS_ACTION_CONFIRM_TITLE";const s=r.getResourceModel(this.parameters.view??this.appComponent);const i=s.checkIfResourceKeyExists(`${a}|${t}`);if(i){return s.getText(a,undefined,t)}};e.getOperationFromName=function e(t,a,s){const i=a.getMetaModel();const n=u(i);if(s){const e=g(i.getMetaContext(s.getPath())).targetEntityType.name;const a=t.replace(/\(.*\)$/g,"").replace(`${n.namespace}.`,"").split(".").pop();return n.actions.find(t=>t.name===a&&t.isBound&&t.sourceEntityType&&e===t.sourceEntityType.name)}const o=t.replace(`${n.entityContainer.fullyQualifiedName}/`,"").replace(`${n.namespace}.`,"").replace("()","");return n.actionImports.find(e=>e.name===o)};return e}();h=x;return h},false);
//# sourceMappingURL=Operation.js.map