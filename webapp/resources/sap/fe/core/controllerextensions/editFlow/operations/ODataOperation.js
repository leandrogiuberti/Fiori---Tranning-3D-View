/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/fe/core/library","sap/m/InstanceManager","sap/ui/model/odata/v4/SubmitMode","../../../helpers/ModelHelper","../../../helpers/TypeGuards","./ODataStrictHandling","./actionHelper"],function(t,e,i,s,n,r,a,o,p){"use strict";var h={};var c=a.isAction;const u=i.InvocationGrouping;let d=function(){function i(t,e){let i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};this.operationContextBindings=[];this.firstIterationOperations=[];this.apiGroupIdsToSubmit=new Set;this.bindingParameters={};this.operationParameters=[];this.neverSubmitted=true;this.failedContexts=[];this.operationPromises=[];this.apiGroupId="apiMode";this.operation=t;this.parameters=e;this.operationProperties=i;const s=c(this.operation)?this.operation:this.operation.action;this.actionName=p.getActionName(s);this.sideEffects=this.parameters.appComponent.getSideEffectsService().getODataActionSideEffects(this.actionName,this.parameters.contexts.length?this.parameters.contexts[0]:undefined);if(!s.isFunction&&this.parameters.disableStrictHandling!==true){this.oDataStrictHandling=new o({appComponent:this.parameters.appComponent,contexts:this.parameters.contexts,label:this.parameters.label??this.actionName,invocationGrouping:this.parameters.invocationGrouping,events:{onResponse:this.parameters.events?.onStrictResponse,onValidation:this.onStrictValidation.bind(this),onCancel:this.parameters.events?.onStrictCancel}})}this.defineOperationParameters();this.setBindingParameters();this.isContinueOnErrorCompliant=this.parameters.invocationGrouping!==u.ChangeSet&&this.parameters.contexts.length>1&&(!this.operationProperties.groupId||this.isAPIMode(this.operationProperties.groupId))&&this.operationProperties.deferredSubmit!==true}h=i;var a=i.prototype;a.setBindingParameters=function t(){this.bindingParameters=e(this.operationProperties.bindingParameters??{});if(c(this.operation)&&!this.operation.isFunction&&this.parameters.contexts.length&&this.operationProperties.enhance$select===true){const t=this.bindingParameters.$select?.split(",")??[];const e=this.operation.returnEntityType;const i=this.parameters.model.getMetaModel();const s=r.getMessagesPath(i,this.parameters.contexts[0].getPath());const n=!this.operation.returnCollection&&!!e&&this.operation.sourceEntityType===e;if(n){if(s&&!!e?.entityProperties.find(t=>t.name===s)&&!t.includes(s)){this.bindingParameters.$select=this.bindingParameters.$select?`${this.bindingParameters.$select},${s}`:s;this.bindingParameters.$$inheritExpandSelect=true}}}};a.defineOperationParameters=function t(){if(!c(this.operation)){this.operationParameters=this.operation.action.parameters}else{this.operationParameters=p.getActionParameters(this.operation)}};a.clear=function t(){for(const t of this.operationContextBindings){t.destroy()}this.apiGroupIdsToSubmit.clear();this.operationContextBindings=[];this.failedContexts=[];this.operationPromises=[]};a.execute=async function e(){let i;try{if(this.parameters.contexts.length){i=await(this.parameters.invocationGrouping===u.ChangeSet||this.isContinueOnErrorCompliant?this.executeOperation():this.executeSequentially())}else{i=await Promise.allSettled([this.executeImport()])}}catch(e){t.error("Error while executing operation "+this.actionName,e);throw e}finally{this.parameters.events?.onODataResponse?.()}return i};a.executeImport=async function t(){const e=this.parameters.model.bindContext(`/${this.actionName}(...)`);this.operationContextBindings.push(e);this.setParametersValue(e);const i=this.operationProperties.groupId??"actionImport";const s=[this.invoke(e,i)];this.defaultSubmit(i);await Promise.allSettled(this.firstIterationOperations);await this.afterODataOperationExecution();const n=await Promise.all(s);return n[0]};a.executeOperation=async function t(){let e=this.operationProperties.groupId;if(this.isContinueOnErrorCompliant){e=e??this.apiGroupId;this.parameters.model.setContinueOnError(e)}this.operationPromises=this.parameters.contexts.map(async t=>this.executeBoundOperation(t,e));await Promise.allSettled(this.firstIterationOperations);await this.afterODataOperationExecution();return Promise.allSettled(this.operationPromises)};a.afterODataOperationExecution=async function t(){await(this.oDataStrictHandling?.manageStrictHandlingFails());await(this.parameters.events?.onAfterODataOperationExecution?.())};a.executeSequentially=async function t(){await this.parameters.contexts.reduce(async(t,e,i)=>{await t;this.operationPromises.push(this.executeBoundOperation(e,this.operationProperties.groupId??`${this.apiGroupId}${i+1}`));await Promise.allSettled(this.firstIterationOperations)},Promise.resolve());await this.afterODataOperationExecution();return Promise.allSettled(this.operationPromises)};a.executeBoundOperation=async function t(e,i){const s=this.parameters.model.bindContext(`${this.actionName}(...)`,e,this.bindingParameters);this.operationContextBindings.push(s);const n=[];this.setParametersValue(s);const r=i??s.getUpdateGroupId();const a=this.invoke(s,r);n.push(a);this.defaultSubmit(r);Promise.allSettled(n);return a};a.enhanceSideEffects=function t(e,i){if(i&&this.parameters.ghostContextBindingProtection===true){const t=this.parameters.appComponent;const n=e.requestSideEffects.bind(e);e.requestSideEffects=async function(){if(t.getRootViewController().getInstancedViews().some(t=>t.getBindingContext()===i)||s.getOpenDialogs().some(t=>t.getBindingContext()===i)){return n(...arguments)}return Promise.resolve()}}};a.invoke=async function t(e,i){let s;let n;let r;const a=new Promise(function(t,e){n=t;r=e});this.firstIterationOperations.push(a);if(i&&this.isAPIMode(i)){this.apiGroupIdsToSubmit.add(i)}try{const t=e.getContext()??e.getBoundContext();const r=e.invoke(i,this.operationProperties.ignoreETag,this.oDataStrictHandling?.handleOdataStrictHandling.bind(this.oDataStrictHandling,e,n,()=>{if(this.isContinueOnErrorCompliant){this.parameters.model.setContinueOnError(i)}this.requestSideEffects(t,i,[]);this.parameters.model.submitBatch(i)}),this.operationProperties.replaceWithRVC);this.requestSideEffects(t,i,[r]);await Promise.race([r,a]);s=await r;this.enhanceSideEffects(e,s);n()}catch(t){r(t);const i=e.getContext();if(i){this.failedContexts.push(i)}throw t}finally{await(this.parameters.events?.onAfterODataInvoke?.(e,i))}return{returnedContext:s,boundContext:e.getBoundContext()}};a.onStrictValidation=function t(){this.parameters.events?.onStrictValidation?.();this.retriggerFailedContexts()};a.retriggerFailedContexts=async function t(){if(this.parameters.invocationGrouping!==u.ChangeSet){const t="apiRetrigger";if(this.isContinueOnErrorCompliant){this.parameters.model.setContinueOnError(t)}let e=0;for(const i of this.failedContexts){const s=`${t}${this.isContinueOnErrorCompliant?"":e+1}`;e++;this.operationPromises.push(this.executeBoundOperation(i,s))}await Promise.allSettled(this.operationPromises)}};a.submit=function t(){if(!this.neverSubmitted||this.apiGroupIdsToSubmit.size===0){return}for(const t of Array.from(this.apiGroupIdsToSubmit.values())){this.submitOnModel(t)}this.parameters.events?.onODataSubmit?.()};a.isStrictCanceled=function t(){return this.oDataStrictHandling?.isCanceled()??false};a.submitOnModel=function t(e){this.parameters.model.submitBatch(e);this.apiGroupIdsToSubmit.delete(e)};a.isAPIMode=function t(e){if(!e){return false}if(e.startsWith("$auto")||e.startsWith("$direct")||e.startsWith("$single")){return false}const i=this.parameters.appComponent.getManifestEntry("sap.ui5")?.models[""]?.settings?.groupProperties?.[e]?.submit;if(i===undefined||[n.Auto,n.Direct].includes(i)){return true}return true};a.defaultSubmit=function t(e){const i=this.neverSubmitted;const s=this.isAPIMode(e);if(!s){this.neverSubmitted=false}else if(this.operationProperties.deferredSubmit!==true&&e){this.neverSubmitted=false;this.submitOnModel(e)}if(i&&!this.neverSubmitted){this.parameters.events?.onODataSubmit?.()}};a.setParametersValue=function t(e){if(this.operationParameters.length){const t=this.parameters.parametersValues??{};for(const i of this.operationParameters){const s=i.name;if(!t[s]){switch(i.type){case"Edm.String":t[s]="";break;case"Edm.Boolean":t[s]=false;break;case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":t[s]=0;break;default:break}}e.setParameter(s,t[s])}}};a.requestSideEffects=async function e(i,s,n){const r=this.parameters.appComponent.getSideEffectsService();let a=n??[];if(this.sideEffects&&!this.parameters.disableSideEffects===true){a=a.concat((this.sideEffects.triggerActions??[]).map(async t=>{if(this.isContinueOnErrorCompliant){this.submitOnModel(s)}return r.executeAction(t,i,{submitBatch:false,groupId:s})}),this.sideEffects.pathExpressions?r.requestSideEffects(this.sideEffects.pathExpressions,i,s):[]);try{await Promise.all(a);if(this.sideEffects.pathExpressions){this.parameters.events?.onRequestSideEffects?.(this.sideEffects,this.operation,a)}}catch(e){t.info("Error while requesting side effects for the operation "+this.actionName,e)}}};return i}();h=d;return h},false);
//# sourceMappingURL=ODataOperation.js.map