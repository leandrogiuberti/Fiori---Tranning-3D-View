/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/isEmptyObject","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/editFlow/draftDataLossPopup","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/TypeGuards","sap/m/Button","sap/m/Dialog","sap/m/MessageBox","sap/m/Text","sap/ui/core/Lib","../../helpers/ModelHelper","./operations/Operation"],function(e,t,n,o,r,a,i,s,c,d,u,f,g,l,h){"use strict";var p=s.isPathAnnotationExpression;var E=i.getResourceModel;var P=a.getInvolvedDataModelObjects;var A=a.convertTypes;const m={EDIT:"EditAction",ACTIVATION:"ActivationAction",DISCARD:"DiscardAction",PREPARE:"PreparationAction"};function w(e,t){const n=e.getModel(),o=n.getMetaModel(),r=o.getMetaPath(e.getPath());return o.getObject(`${r}@com.sap.vocabularies.Common.v1.DraftRoot/${t}`)}function C(e,t,n){const o=w(e,t);return e.getModel().bindContext(`${o}(...)`,e,n)}function D(e,t){const n=w(e,t);const o=e.getModel().getMetaModel(),r=`${o.getMetaPath(e.getPath())}/${n}`,a=o.createBindingContext(r);return A(o).resolvePath(a.getPath()).target}function M(e,t){const n=e.getModel(),o=n.getMetaModel(),r=o.getMetaPath(e.getPath());return o.getObject(`${r}@com.sap.vocabularies.Common.v1.DraftRoot/${t}/$ReturnType`)}function v(e){return!!w(e,m.PREPARE)}async function x(e,o,r,a,i,s){const c=D(e,m.EDIT);if(c){const d=new h(n.getAppComponent(r),e.getModel(),c,{messageHandler:i,contexts:[e],label:E(r).getText("C_COMMON_OBJECT_PAGE_EDIT"),bindingParameters:{$$inheritExpandSelect:true,$$updateGroupId:"$auto"},skipMessages:true,oDataProperties:{disableSideEffects:true,ignoreETag:t(e.getObject()),groupId:a,replaceWithRVC:e.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding"),deferredSubmit:s!==true}});d.setDefaultParametersValues({PreserveChanges:o});const u=await d.execute();if(u[0].status==="rejected"){const e=new Error(u[0].reason.message);e.status=u[0].reason.status;throw e}else{return u[0].value.returnedContext}}else{throw new Error("The edit action not found")}}async function b(t,n,o){if(l.getMessagesPath(t.getModel().getMetaModel(),t.getPath())&&F.hasPrepareAction(t)){try{if(!o&&!t.isKeepAlive()){await t.getBinding().requestObject("")}const e=F.executeDraftPreparationAction(t,t.getUpdateGroupId(),true,o);if(!M(t,m.PREPARE)){O(t,n.getSideEffectsService())}return await e}catch(t){e.error("Error while requesting messages",t)}}return undefined}async function y(t,n,o,r,a,i,s){const c=F.hasPrepareAction(t);const d=c;let u;if(!t.getProperty("IsActiveEntity")){const f=D(t,m.ACTIVATION);const g=s?i?.getText("T_OP_OBJECT_PAGE_SAVE"):i?.getText("C_OP_OBJECT_PAGE_SAVE");if(f){try{u=new h(n,t.getModel(),f,{messageHandler:o,contexts:[t],label:g,bindingParameters:{$$inheritExpandSelect:true},skipMessages:true,oDataProperties:{disableSideEffects:true,groupId:r,ignoreETag:d,replaceWithRVC:t.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")}});const e=await u.execute();if(e[0].status==="rejected"){throw new Error(e[0].reason)}else if(e[0].value.returnedContext===undefined){throw new Error("No context returned by the action")}return e[0].value.returnedContext}catch(o){if(c){const o=await a;o?.destroy();u?.clear();const r=w(t,m.PREPARE),i=n.getSideEffectsService(),s=i.getODataActionSideEffects(r,t),c=s&&s.pathExpressions;if(c&&c.length>0){try{await i.requestSideEffects(c,t)}catch(t){e.error("Error while requesting side effects",t)}}else{try{await O(t,i,true)}catch(t){e.error("Error while requesting messages",t)}}}throw o}}else{throw new Error("The activation action not found")}}else{throw new Error("The activation action cannot be executed on an active document")}}function T(e){return M(e,m.PREPARE)?S(e):undefined}function S(e){const t=e.getModel().getMetaModel().getMetaContext(e.getPath());const n=P(t);const o=n.targetEntityType.annotations.Common?.Messages;return p(o)?o.path:undefined}async function _(t,n,o,r){if(!t.getProperty("IsActiveEntity")){const a=o?T(t):undefined;const i=C(t,m.PREPARE,a?{$select:a}:undefined);i.setParameter("SideEffectsQualifier","");const s=n||i.getGroupId();return i.invoke(s,r).then(function(){return i}).catch(function(t){e.error("Error while executing the operation",t);return i})}else{throw new Error("The preparation action cannot be executed on an active document")}}async function O(e,t){let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;const o=l.getMessagesPath(e.getModel().getMetaModel(),e.getPath());if(o){await t.requestSideEffects([o],e);if(n){const t=await e.requestObject();if(t[o].length>0){r.removeUnboundTransitionMessages();r.removeBoundTransitionMessages()}}}return}async function $(e,n,o,r){if(!e.getProperty("IsActiveEntity")){const a=D(e,m.DISCARD);if(a){const i=await new h(o,e.getModel(),a,{messageHandler:n,label:E(o)?.getText("C_TRANSACTION_HELPER_DRAFT_DISCARD_BUTTON")||"",contexts:[e],skipMessages:true,oDataProperties:{disableSideEffects:true,disableStrictHandling:!r,ignoreETag:t(e.getObject()),groupId:"direct",replaceWithRVC:undefined,deferredSubmit:false}}).execute();if(i[0].status==="rejected"){throw new Error(i[0].reason)}}else{throw new Error("The discard action not found")}}else{throw new Error("The discard action cannot be executed on an active document")}}async function R(t,n,o,r,a){let i=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;if(!n.getPath().startsWith(t.getPath())){e.error("Cannot compute rightmost sibling context");throw new Error("Cannot compute rightmost sibling context")}if(n.getProperty("IsActiveEntity")===false&&n.getProperty("HasActiveEntity")===false){return undefined}const s=t.getModel();try{const e=n.getPath().replace(t.getPath(),"");const c=e?e.substring(1).split("/"):[];c.unshift(t.getPath().substring(1));const d=[];const u=[];let f="";const g=[...c];if(o?.rootSiblingPathPromise){g.shift();f="/"+t?.getPath()?.substring(1)}const l=g.map(async e=>{f+=`/${e}`;d.unshift(f);if(f.endsWith(")")){const e=s.bindContext(`${f}/SiblingEntity`,undefined,r?{$$groupId:r}:undefined).getBoundContext();return e.requestCanonicalPath()}else{return Promise.resolve(undefined)}});const h=await Promise.all(l);if(h.some(e=>e&&e.endsWith("/SiblingEntity"))){return undefined}if(o?.rootSiblingPathPromise){const e=(await o.rootSiblingPathPromise)?.getPath();h.unshift(e);d.push(t.getPath())}let p="";h.forEach((e,t)=>{if(t!==0){if(c[t].endsWith(")")){const n=c[t].replace(/\(.*$/,"");const o=e.replace(/.*\(/,"(");p+=`/${n}${o}`}else{p+=`/${c[t]}`}}else{p=e}u.unshift(p)});let E;const P=S(n);if(i){E={$$groupId:"$auto.Workers"}}else{E=a??{};if(P){if(E.$select){E.$select+=`,${P}`}else{E.$select=P}}E.$$groupId="$auto.Heroes"}return{targetContext:i?s.getKeepAliveContext(p,!!P,E):s.bindContext(p,undefined,E).getBoundContext(),pathMapping:d.map((e,t)=>({oldPath:e,newPath:u[t]}))}}catch(e){return undefined}}async function I(e,t,o,a,i,s){const c=o||{},d=typeof c.bPreserveChanges==="undefined"||typeof c.bPreserveChanges==="boolean"&&c.bPreserveChanges;async function f(t){const n=e.getModel();const s=n.bindContext(`${e.getPath()}/DraftAdministrativeData`).getBoundContext();const c=E(o.oView);const d=await s.requestObject();if(d){r.removeUnboundTransitionMessages();let t=d.InProcessByUserDescription||d.InProcessByUser;const n=o.oView.getViewData().entitySet;if(t){const e=c.getText("C_DRAFT_OBJECT_PAGE_DRAFT_LOCKED_BY_USER",t,n);u.error(e);throw new Error(e)}else{t=d.CreatedByUserDescription||d.CreatedByUser;const r=c.getText("C_DRAFT_OBJECT_PAGE_DRAFT_UNSAVED_CHANGES",t,n);await F.showEditConfirmationMessageBox(r,e);return F.executeDraftEditAction(e,false,o.oView,a,i,true)}}else if(t?.message){u.error(t.message)}throw new Error(`Draft creation aborted for document: ${e.getPath()}`)}if(!e){throw new Error("Binding context to active document is required")}let g;try{g=await F.executeDraftEditAction(e,d,o.oView,a,i)}catch(o){if(o.status===409||o.status===423){r.removeBoundTransitionMessages();r.removeUnboundTransitionMessages();const a=l.isCollaborationDraftSupported(e.getModel().getMetaModel())?{$select:"DraftAdministrativeData/DraftAdministrativeUser"}:undefined;const i=await F.computeSiblingInformation(e,e,undefined,undefined,a,t._isFclEnabled());if(i?.targetContext){await n.waitForContextRequested(i.targetContext);if(s){s.existingDraftReused=true}return i.targetContext}else{g=await f(o)}}else if(!(o&&o.canceled)){throw new Error(o)}}if(g){const e=F.getActionName(g,m.EDIT);const n=t.getSideEffectsService().getODataActionSideEffects(e,g);if(n?.triggerActions?.length){await t.getSideEffectsService().requestSideEffectsForODataAction(n,g);return g}else{return g}}else{return undefined}}async function B(e,t,n,o,r){const a=o||{};if(!e){throw new Error("Binding context to draft document is required")}const i=a.fnBeforeActivateDocument?await a.fnBeforeActivateDocument(e):true;if(!i){throw new Error(`Activation of the document was aborted by extension for document: ${e.getPath()}`)}let s;if(!F.hasPrepareAction(e)){s=await y(e,t,n,undefined,undefined,o.resourceModel)}else{const a="$auto";const i=e.getModel().hasPendingChanges("$auto")?true:false;const c=F.executeDraftPreparationAction(e,a,undefined,i);e.getModel().submitBatch(a);const d=F.executeDraftActivationAction(e,t,n,a,c,o.resourceModel,r);const u=await Promise.all([c,d]);s=u[1]}return a.fnAfterActivateDocument?a.fnAfterActivateDocument(e,s):s}async function N(e,t){const n=g.getResourceBundleFor("sap.fe.core");return new Promise(function(o,r){const a=new d({title:n.getText("C_MESSAGE_HANDLING_SAPFE_ERROR_MESSAGES_PAGE_TITLE_WARNING"),state:"Warning",content:new f({text:e}),beginButton:new c({text:n.getText("C_COMMON_OBJECT_PAGE_EDIT"),type:"Emphasized",press:function(){a.close();o(true)}}),endButton:new c({text:n.getText("C_COMMON_OBJECT_PAGE_CANCEL"),press:function(){a.close();r(`Draft creation aborted for document: ${t.getPath()}`)}}),afterClose:function(){a.destroy()}});a.addStyleClass("sapUiContentPadding");a.open()})}async function G(e,t,n,o){if(e.isTransient()){return e.delete()}const r=w(e,m.DISCARD);const a=e.getObject().IsActiveEntity;if(a||!a&&!r){if(e.hasPendingChanges()&&!e.isInactive()){await e.getBinding().resetChanges();return e.delete()}else{return!n._isFclEnabled()&&!e.getProperty("IsActiveEntity")&&l.isDraftRoot(P(e.getModel().getMetaModel().getMetaContext(e.getPath()))?.targetEntitySet)&&e.getProperty("HasActiveEntity")?e.getModel().delete(e):e.delete()}}else{await $(e,t,n,o)}}const F={createDraftFromActiveDocument:I,activateDocument:B,deleteDraft:G,executeDraftEditAction:x,executeDraftValidation:b,executeDraftPreparationAction:_,executeDraftActivationAction:y,hasPrepareAction:v,computeSiblingInformation:R,processDataLossOrDraftDiscardConfirmation:o.processDataLossOrDraftDiscardConfirmation,silentlyKeepDraftOnForwardNavigation:o.silentlyKeepDraftOnForwardNavigation,createOperation:C,executeDraftDiscardAction:$,NavigationType:o.NavigationType,getActionName:w,showEditConfirmationMessageBox:N};return F},false);
//# sourceMappingURL=draft.js.map