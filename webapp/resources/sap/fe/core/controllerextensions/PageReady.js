/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/ClassSupport","sap/fe/core/controllerextensions/pageReady/DataQueryWatcher","sap/fe/core/services/TemplatedViewServiceFactory","sap/ui/base/EventProvider","sap/ui/core/Component","sap/ui/core/Rendering","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","../CommonUtils"],function(e,t,i,o,n,r,a,s,c,h){"use strict";var p,d,g,u,l,y,f,b,v,P,m,R,E,C,_,O,w,D,T,x,A,B,W;var j=o.TemplatedViewServiceFactory;var F=t.publicExtension;var I=t.privateExtension;var k=t.methodOverride;var S=t.finalExtension;var q=t.extensible;var U=t.defineUI5Class;function M(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,z(e,t)}function z(e,t){return z=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},z(e,t)}function V(e,t,i,o,n){var r={};return Object.keys(o).forEach(function(e){r[e]=o[e]}),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=i.slice().reverse().reduce(function(i,o){return o(e,t,i)||i},r),n&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(n):void 0,r.initializer=void 0),void 0===r.initializer?(Object.defineProperty(e,t,r),null):r}let H=(p=U("sap.fe.core.controllerextensions.PageReady"),d=k(),g=k(),u=F(),l=S(),y=k("_routing"),f=k("_routing"),b=k("_routing"),v=F(),P=S(),m=F(),R=S(),E=F(),C=S(),_=F(),O=S(),w=F(),D=S(),T=I(),x=q(c.Instead),A=F(),p(B=(W=function(t){function o(){var e;e=t.call(this)||this;e.pageReadyTimeoutDefault=7e3;return e}M(o,t);var s=o.prototype;s.onInit=function e(){this._nbWaits=0;this._oEventProvider=this._oEventProvider?this._oEventProvider:new n;this.view=this.getView();this.appComponent=h.getAppComponent(this.view);this.pageComponent=r.getOwnerComponentFor(this.view);const t=this.appComponent.getManifest();this.pageReadyTimeout=t["sap.ui5"]?.pageReadyTimeout??this.pageReadyTimeoutDefault;if(this.pageComponent?.attachContainerDefined){this.pageComponent.attachContainerDefined(e=>this.registerContainer(e.getParameter("container")))}else{this.registerContainer(this.view)}const o=this.appComponent.getRootControl().getController();const a=o?.getPlaceholder?.();if(a?.isPlaceholderDebugEnabled()){this.attachEvent("pageReady",null,()=>{a.getPlaceholderDebugStats().iPageReadyEventTimestamp=Date.now()},this);this.attachEvent("heroesBatchReceived",null,()=>{a.getPlaceholderDebugStats().iHeroesBatchReceivedEventTimestamp=Date.now()},this)}this.queryWatcher=new i(this._oEventProvider,this.checkPageReadyDebounced.bind(this))};s.onExit=function e(){delete this._oAppComponent;if(this._oContainer&&this._fnContainerDelegate){this._oContainer.removeEventDelegate(this._fnContainerDelegate)}};s.waitFor=function e(t){this._nbWaits++;t.finally(()=>{setTimeout(()=>{this._nbWaits--},0)}).catch(null)};s.onRouteMatched=function e(){this._bIsPageReady=false};s.onRouteMatchedFinished=async function e(){await this.onAfterBindingPromise;this.checkPageReadyDebounced()};s.registerAggregatedControls=function e(t){if(t){const e=t.getBinding();this.queryWatcher.registerBinding(e)}const i=[];const o=this.getView().findAggregatedObjects(true);o.forEach(e=>{const t=e.getObjectBinding();if(t){this.queryWatcher.registerBinding(t)}else{const t=Object.keys(e?.mBindingInfos??{});t.forEach(t=>{const i=e?.mBindingInfos?.[t].binding;if(i&&i.isA("sap.ui.model.odata.v4.ODataListBinding")){this.queryWatcher.registerBinding(i)}})}if(e.isA("sap.fe.macros.table.TableAPI")||e.isA("sap.fe.macros.Chart")){const t=e.getContent?.()??e.getChartControl();if(t.getBindingContext()!==null){this.bTablesChartsLoaded=false;i.push(this.queryWatcher.registerTableOrChart(t))}}else if(e.isA("sap.fe.macros.controls.FilterBar")){this.queryWatcher.registerFilterBar(e)}});return i};s.onAfterBinding=function t(i,o){if(this.pageReadyTimeoutTimer){clearTimeout(this.pageReadyTimeoutTimer)}if(!o?.deferredCreation||!this.isContextExpected()||i){this.pageReadyTimeoutTimer=setTimeout(()=>{e.error(`The PageReady Event was not fired within the ${this.pageReadyTimeout} ms timeout . It has been forced. Please contact your application developer for further analysis`);this._oEventProvider.fireEvent("pageReady")},this.pageReadyTimeout)}else{const e=this.appComponent.getRootControl().getController();const t=e?.getPlaceholder?.();t?.disableAnimation()}if(this.isContextExpected()&&!i){this.bHasContext=false;return}else{this.bHasContext=true}if(this._bAfterBindingAlreadyApplied){return}this._bAfterBindingAlreadyApplied=true;this.attachEventOnce("pageReady",null,()=>{clearTimeout(this.pageReadyTimeoutTimer);this.pageReadyTimeoutTimer=undefined;this._bAfterBindingAlreadyApplied=false;this.queryWatcher.reset()});this.onAfterBindingPromise=new Promise(async e=>{const t=this.registerAggregatedControls(i);if(t.length>0){await Promise.all(t);this.bTablesChartsLoaded=true;this.checkPageReadyDebounced();e()}else{this.checkPageReadyDebounced();e()}})};s.isPageReady=function e(){return this._bIsPageReady};s.waitPageReady=async function e(){return new Promise(e=>{if(this.isPageReady()){e()}else{if(!this._oEventProvider){this._oEventProvider=new n}this.attachEventOnce("pageReady",null,()=>{e()},this)}})};s.attachEventOnce=function e(t,i,o,n){return this._oEventProvider.attachEventOnce(t,i,o,n)};s.attachEvent=function e(t,i,o,n){return this._oEventProvider.attachEvent(t,i,o,n)};s.detachEvent=function e(t,i){return this._oEventProvider.detachEvent(t,i)};s.registerContainer=function e(t){this._oContainer=t;this._fnContainerDelegate={onBeforeShow:()=>{this.bShown=false;this._bIsPageReady=false},onBeforeHide:()=>{this.bShown=false;this._bIsPageReady=false},onAfterShow:()=>{this.bShown=true;this.onAfterBindingPromise?.then(()=>this.checkPageReadyDebounced(true))}};this._oContainer?.addEventDelegate(this._fnContainerDelegate,this)};s.isContextExpected=function e(){return false};s.checkPageReadyDebounced=function e(){let t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(this.pageReadyTimer){clearTimeout(this.pageReadyTimer)}const i=this.getView().getModel();let o;if(i&&i.getOptimisticBatchEnabler()===null||this.isContextExpected()){o=200}else{o=20}this.pageReadyTimer=setTimeout(()=>{this._checkPageReady(t)},o)};s._checkPageReady=function e(){let t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;const i=()=>{if(!a.isPending()){a.detachUIUpdated(i);this._bWaitingForRefresh=false;this.checkPageReadyDebounced()}};const o=()=>{if(a.isPending()){setTimeout(o,500)}else if(this._bWaitingForRefresh){this._bWaitingForRefresh=false;a.detachUIUpdated(i);this.checkPageReadyDebounced()}};if(this.bShown&&this.queryWatcher.isDataReceived()!==false&&this.bTablesChartsLoaded!==false&&(!this.isContextExpected()||this.bHasContext)){if(this.queryWatcher.isDataReceived()===true&&!t&&!this._bWaitingForRefresh&&a.isPending()){this.queryWatcher.resetDataReceived();this._bWaitingForRefresh=true;a.attachUIUpdated(i);setTimeout(o,500)}else if(!this._bWaitingForRefresh&&a.isPending()||this._nbWaits!==0||j.getNumberOfViewsInCreationState()>0||this.queryWatcher.isSearchPending()){this._bWaitingForRefresh=true;a.attachUIUpdated(i);setTimeout(o,500)}else if(!this._bWaitingForRefresh){this._bIsPageReady=true;this._oEventProvider.fireEvent("pageReady")}}};s.forcePageReady=function e(){this._oEventProvider.fireEvent("pageReady")};return o}(s),V(W.prototype,"onInit",[d],Object.getOwnPropertyDescriptor(W.prototype,"onInit"),W.prototype),V(W.prototype,"onExit",[g],Object.getOwnPropertyDescriptor(W.prototype,"onExit"),W.prototype),V(W.prototype,"waitFor",[u,l],Object.getOwnPropertyDescriptor(W.prototype,"waitFor"),W.prototype),V(W.prototype,"onRouteMatched",[y],Object.getOwnPropertyDescriptor(W.prototype,"onRouteMatched"),W.prototype),V(W.prototype,"onRouteMatchedFinished",[f],Object.getOwnPropertyDescriptor(W.prototype,"onRouteMatchedFinished"),W.prototype),V(W.prototype,"onAfterBinding",[b],Object.getOwnPropertyDescriptor(W.prototype,"onAfterBinding"),W.prototype),V(W.prototype,"isPageReady",[v,P],Object.getOwnPropertyDescriptor(W.prototype,"isPageReady"),W.prototype),V(W.prototype,"waitPageReady",[m,R],Object.getOwnPropertyDescriptor(W.prototype,"waitPageReady"),W.prototype),V(W.prototype,"attachEventOnce",[E,C],Object.getOwnPropertyDescriptor(W.prototype,"attachEventOnce"),W.prototype),V(W.prototype,"attachEvent",[_,O],Object.getOwnPropertyDescriptor(W.prototype,"attachEvent"),W.prototype),V(W.prototype,"detachEvent",[w,D],Object.getOwnPropertyDescriptor(W.prototype,"detachEvent"),W.prototype),V(W.prototype,"isContextExpected",[T,x],Object.getOwnPropertyDescriptor(W.prototype,"isContextExpected"),W.prototype),V(W.prototype,"checkPageReadyDebounced",[A],Object.getOwnPropertyDescriptor(W.prototype,"checkPageReadyDebounced"),W.prototype),W))||B);return H},false);
//# sourceMappingURL=PageReady.js.map