/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/ClassSupport","sap/fe/core/helpers/RecommendationHelper","sap/fe/core/helpers/StandardRecommendationHelper","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","../CommonUtils","./editFlow/TransactionHelper","../controls/Recommendations/ConfirmRecommendationDialog","./recommendations/Telemetry"],function(e,t,n,o,i,r,s,c,a,d){"use strict";var l,m,p,h,f,u,g,y,R,x,b,C,P,A,O,w,v,D;var F={};var E=a.RecommendationDialogDecision;var I=o.standardRecommendationHelper;var j=n.recommendationHelper;var B=t.publicExtension;var V=t.methodOverride;var M=t.finalExtension;var T=t.extensible;var S=t.defineUI5Class;function _(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,k(e,t)}function k(e,t){return k=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},k(e,t)}function H(e,t,n,o,i){var r={};return Object.keys(o).forEach(function(e){r[e]=o[e]}),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=n.slice().reverse().reduce(function(n,o){return o(e,t,n)||n},r),i&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(i):void 0,r.initializer=void 0),void 0===r.initializer?(Object.defineProperty(e,t,r),null):r}let z=(l=S("sap.fe.core.controllerextensions.Recommendations"),m=V(),p=V("_routing"),h=B(),f=B(),u=T(r.Instead),g=B(),y=M(),R=B(),x=T(r.Instead),b=B(),C=B(),P=B(),A=T("AfterAsync"),O=B(),w=T(r.Instead),l(v=(D=function(t){function n(){var e;e=t.call(this)||this;e.dataToBeAccepted=[];return e}F=n;_(n,t);var o=n.prototype;o.onInit=function e(){this.telemetry=new d;this.allRecommendedFields=[];this.internalModel=this.base.getView().getModel("internal");this.previousContext=undefined};o.onAfterBinding=async function e(t){if(t){const e=t.getPath().split("/")[1];const n=this.previousContext?.getPath().split("/")[1];this.rootContext=undefined;let o=this.internalModel.getProperty("/isRecommendationEnabled");this.previousContext=t;const i=this.getView().getViewData()?.viewLevel;const r=i&&i>1?await this._getRootContext(t):t;if(r){if(o===undefined){o=this.base.recommendations.isEnabled(r);this.internalModel.setProperty("/isRecommendationEnabled",o)}const t=this.base.getAppComponent()._isFclEnabled();const i=t?this.base.getAppComponent().getRootViewController().getHelper().getCurrentUIState().isFullScreen:true;if(e!==n){this.tryResetRecommendations(r);this.telemetry.resetData()}if(t&&!i){return}}}};o._getRootContext=async function e(t){const n=c.getProgrammingModel(t);return s.createRootContext(n,this.base.getView(),this.base.getAppComponent())};o.clearRecommendations=function e(){const t=this.getView().getBindingContext();if(t){j.clearRecommendations(this.base.getView(),t)}};o.isEnabled=function e(t){return false};o.isRecommendationEnabled=function e(){return!!this.internalModel?.getProperty("/isRecommendationEnabled")};o.fetchRecommendations=async function e(t,n){return Promise.resolve([])};o.fetchAndApplyRecommendations=async function t(n,o){let i=false;const r=this.base.getAppComponent().getSideEffectsService();const s=r.getRecommendationsMapping();const c=n.filter(e=>I.checkIfRecommendationRoleExistsForContext(e,s));if(this.isRecommendationEnabled()){const t=o?I.getContextsWithNoRecommendations(c,this.internalModel):c;const n=t.map(e=>e.context);if(n&&n.length>0){try{const e=await this._getRootContext(n[0]);const t=performance.now();const o=await this.base.recommendations.fetchRecommendations(n,e);const r=performance.now();this.telemetry.updateResponseTimeInfo(r-t);if(o?.length){this.updateAllRecommendedFields(o);this.telemetry.updateDataFromRecommendationResponse(o)}else{this.telemetry.increaseCount("numberOfTimesEmptyRecommendations")}i=this.applyRecommendation(o,n)}catch(t){e.error("There was an error fetching the recommendations",t)}}this.storeRecommendationContexts(c)}return i};o.fetchAndApplyRecommendationsOnFieldChange=async function e(t,n){const o=this.base.getAppComponent();const i=o.getSideEffectsService().checkIfFieldIsRecommendationRelevant(t);if(i){const e=this.fetchTargets(true);const t=this.fetchFilteredRecommendationContexts(e);const o=t.filter(function(e){if(e.context.getPath()?.includes((n?.context).getPath())){return e}});I.clearIgnoredContexts(this.internalModel,(n?.context).getPath());return this.fetchAndApplyRecommendations(o)}else{return false}};o.onBeforeAcceptRecommendations=async function e(t){return Promise.resolve()};o.acceptRecommendations=async function e(t){const n=[];if(t.recommendationData){for(const e of t.recommendationData){if(e.context&&e.propertyPath){n.push(e.context.setProperty(e.propertyPath,e.value,"$auto.abc"))}}await Promise.all(n)}return true};o.applyRecommendation=function e(t,n){I.storeRecommendations(t,this.getView().getModel("internal"),n);return true};o.storeRecommendationContexts=function e(t){const n=[];let o=this.internalModel.getProperty("/recommendationContexts")||[];t.forEach(e=>{n.push(e.context.getPath())});o=o?.filter(e=>{const o=e?.context;if(o){const i=o.getPath();const r=n.indexOf(i);if(r<0){return true}else if(e.contextIdentifier){t[r].contextIdentifier=e.contextIdentifier}}return false});this.internalModel.setProperty("/recommendationContexts",[...o,...t])};o.fetchFilteredRecommendationContexts=function e(t){const n=[];const o=[];for(const e of t){const t=e.substring(0,e.lastIndexOf(")")+1);const i=this.getView().getModel("internal").getProperty("/recommendationContexts");i.forEach(e=>{const i=e.context;if(i.getPath()==t&&!n.includes(t)){n.push(t);o.push(e)}})}return o};o.fetchFilteredRecommendationData=function e(t){const n={};const o=this.getView().getModel("internal")?.getProperty("/recommendationsData");Object.keys(o).forEach(e=>{if(t.includes(e)){n[e]=Object.assign(o[e],{})}});return n};o.fetchTargets=function e(t){const n=this.getView().getModel("internal")?.getProperty("/recommendationsData");if(n.version===null){return[]}const o=this.base.getAppComponent()._isFclEnabled();const i=o?this.base.getAppComponent().getRootViewController().getHelper().getCurrentUIState().isFullScreen:true;const r=(e,t)=>{const n=e=>{const n=t.split(e);const o=n[1];let i=o.split("/");if(i.length<=3){return true}else{i=i.slice(2);return!i.some(e=>e.includes("("))}};if(o&&!i){const o=this.base.getAppComponent().getRootViewController().getRightmostContext();if(t.includes(o?.getPath())){return n(o?.getPath())}else{return n(e)}}else{return n(e)}};const s=this.fetchDataToBeFiltered(n,t);return s.filter(e=>e.includes(this.getView().getBindingContext()?.getPath())&&r(this.getView().getBindingContext()?.getPath(),e))||[]};o.fetchDataToBeFiltered=function e(t,n){let o=[];if(n){const e=this.getView().getModel("internal")?.getProperty("/recommendationContexts");e.forEach(e=>{o.push(e.context.getPath())})}else{o=Object.keys(t).filter(e=>e!=="version"&&e!=="keys")}return o};o.adjustAcceptAllParams=function e(t,n,o){o.recommendationData=[];for(const e in t){if(t[e].value||t[e].text){const i=e.substring(0,e.lastIndexOf(")")+1);const r=e.substring(e.lastIndexOf(")")+2);const s=n.filter(function(e){if((e?.context).getPath()===i){return true}});if(s?.length>0&&I.isRecommendationFieldNull(s[0].context,e,r)){o.recommendationData.push({context:s[0].context,contextIdentifier:s[0].contextIdentifier,propertyPath:r,value:t[e].value,text:t[e].text})}}}};o.fetchAcceptAllParams=async function e(){const t=this.fetchTargets();const n=this.fetchFilteredRecommendationData(t);const o=this.fetchFilteredRecommendationContexts(t);const i={};this.adjustAcceptAllParams(n,o,i);await this.getView().getController().recommendations.onBeforeAcceptRecommendations(i);I.addContextIdentifierText(i,this.getView()?.getBindingContext()?.getPath());this.dataToBeAccepted=i.recommendationData||[];return i};o.checkIfRecommendationsExist=function e(){const t=this.internalModel.getProperty("/recommendationsData")||{};return Object.keys(t).length!==0};o.ignoreRecommendationForContexts=function e(t){if(!t||!t.length){const e=this.getView();const n=e.getBindingContext();t=[n]}I.ignoreRecommendationForContexts(t,this.internalModel)};o.tryResetRecommendations=function e(t){I.setCurrentRootContext(t);this.internalModel.setProperty("/recommendationContexts",[]);I.resetRecommendations(this.internalModel)};o.storeDataForTelemetry=async function e(t){const n=await this._getRootContext(this.getView().getBindingContext());if(n&&this.base.recommendations.isEnabled(n)){if(t===E.Accept){this.telemetry.updateData("numberOfFieldsAcceptedThroughAcceptButton",this.dataToBeAccepted.length)}else if(t===E.Reject){this.telemetry.updateData("numberOfFieldsIgnoredThroughIgnoreButton",this.dataToBeAccepted.length)}this.telemetry.storeData(this.getView())}};o.increaseTelemetryDataCount=function e(t){this.telemetry.increaseCount(t)};o.updateTelemetryDataBasedOnUserSelection=function e(t,n){this.telemetry.updateTelemetryDataBasedOnUserSelection(this.getView(),t,n)};o.updateAllRecommendedFields=function e(t){const n=this.getView().getBindingContext().getPath();const o=t.filter(e=>e["AIRecommendedFieldPath"]?.includes(n));if(!this.allRecommendedFields){this.allRecommendedFields=[]}o.forEach(e=>{const t=e["AIRecommendedFieldPath"];if(t){if(!this.allRecommendedFields.includes(t)){this.allRecommendedFields.push(t);this.telemetry.increaseCount("numberOfRecommendedFields")}}})};o.resetRejectedRecommendations=function e(t){const n=t.getModel()?.getLocalAnnotationModel();const o=n?.getProperty("/rejectedRecommendations");Object.keys(o||{}).forEach(e=>{if(e.startsWith(t.getPath())){delete o[e]}});n?.setProperty("/rejectedRecommendations",o)};return n}(i),H(D.prototype,"onInit",[m],Object.getOwnPropertyDescriptor(D.prototype,"onInit"),D.prototype),H(D.prototype,"onAfterBinding",[p],Object.getOwnPropertyDescriptor(D.prototype,"onAfterBinding"),D.prototype),H(D.prototype,"clearRecommendations",[h],Object.getOwnPropertyDescriptor(D.prototype,"clearRecommendations"),D.prototype),H(D.prototype,"isEnabled",[f,u],Object.getOwnPropertyDescriptor(D.prototype,"isEnabled"),D.prototype),H(D.prototype,"isRecommendationEnabled",[g,y],Object.getOwnPropertyDescriptor(D.prototype,"isRecommendationEnabled"),D.prototype),H(D.prototype,"fetchRecommendations",[R,x],Object.getOwnPropertyDescriptor(D.prototype,"fetchRecommendations"),D.prototype),H(D.prototype,"fetchAndApplyRecommendations",[b],Object.getOwnPropertyDescriptor(D.prototype,"fetchAndApplyRecommendations"),D.prototype),H(D.prototype,"fetchAndApplyRecommendationsOnFieldChange",[C],Object.getOwnPropertyDescriptor(D.prototype,"fetchAndApplyRecommendationsOnFieldChange"),D.prototype),H(D.prototype,"onBeforeAcceptRecommendations",[P,A],Object.getOwnPropertyDescriptor(D.prototype,"onBeforeAcceptRecommendations"),D.prototype),H(D.prototype,"acceptRecommendations",[O,w],Object.getOwnPropertyDescriptor(D.prototype,"acceptRecommendations"),D.prototype),D))||v);F=z;return F},false);
//# sourceMappingURL=Recommendations.js.map