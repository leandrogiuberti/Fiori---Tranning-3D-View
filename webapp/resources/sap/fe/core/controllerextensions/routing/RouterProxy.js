/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/ClassSupport","sap/fe/core/helpers/Synchronization","sap/ui/base/Object","sap/ui/core/Element","sap/ui/core/Lib"],function(t,e,s,i,n,o){"use strict";var a,r;var h=e.defineUI5Class;function c(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,u(t,e)}function u(t,e){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},u(t,e)}const l={EQUAL:0,COMPATIBLE:1,ANCESTOR:2,DIFFERENT:3};const f={LAYOUTPARAM:"layout",IAPPSTATEPARAM:"sap-iapp-state"};function d(t,e){return{_guardHash:t.replace(/\?[^?]*$/,""),hashTracker:e?e.replace(/\?[^?]*$/,""):undefined,check:function(t){return t.indexOf(this._guardHash)===0||(this.hashTracker?t.indexOf(this.hashTracker)===0:false)}}}function p(t){return t.replace(new RegExp(`[&?]*${f.IAPPSTATEPARAM}=[^&]*`),"")}let g=(a=h("sap.fe.core.RouterProxy"),a(r=function(e){function i(){var t;for(var s=arguments.length,i=new Array(s),n=0;n<s;n++){i[n]=arguments[n]}t=e.call(this,...i)||this;t.bIsRebuildHistoryRunning=false;t.bIsComputingTitleHierachy=false;t.bIsGuardCrossAllowed=false;t.sIAppStateKey=null;t._bActivateRouteMatchSynchro=false;t._bApplyRestore=false;t._pathMappings=[];t.restoreHistoryTriggered=false;t.appStateUpdating=false;return t}c(i,e);var a=i.prototype;a.init=function e(s,i){s.getService("shellServices").then(()=>this.asyncInit(s,i)).catch(function(e){t.error("Cannot retrieve the shell services",e)});this._fnHashGuard=this.hashGuard.bind(this);window.addEventListener("popstate",this._fnHashGuard);this._bDisableOnHashChange=false;this._bIgnoreRestore=false;this._bForceFocus=true};a.asyncInit=function t(e,s){this._oShellServices=e.getShellServices();this.initRaw(e.getRouter());this.routingHints=e.getRoutingService().getRoutingHints();this.waitForRouteMatchBeforeNavigation();history.replaceState(Object.assign({feLevel:0},history.state),"",window.location);this.fclEnabled=s;this._fnBlockingNavFilter=this._blockingNavigationFilter.bind(this);this._oShellServices.registerNavigationFilter(this._fnBlockingNavFilter)};a.destroy=function t(){if(this._oShellServices){this._oShellServices.unregisterNavigationFilter(this._fnBlockingNavFilter)}window.removeEventListener("popstate",this._fnHashGuard)};a.setAppStateInHash=function t(e,s){let i;if(e.includes(f.IAPPSTATEPARAM)){i=e.replace(new RegExp(`${f.IAPPSTATEPARAM}=[^&]*`),`${f.IAPPSTATEPARAM}=${s}`)}else{if(!e.includes("?")){i=`${e}?`}else{i=`${e}&`}i+=`${f.IAPPSTATEPARAM}=${s}`}return i};a.findAppStateInHash=function t(e){const s=e.match(new RegExp(`\\?.*${f.IAPPSTATEPARAM}=([^&]*)`));return s&&s.length>1?s[1]:null};a.getDecodedWindowHash=function t(){return decodeURI(window.location.hash)};a.initRaw=function t(e){this._oRouter=e;this._oManagedHistory=[];this._oNavigationGuard=null;const s=this.getHash();this._oManagedHistory.push(this._extractStateFromHash(s));this.appName=this.getAppNameFromHash(this.getDecodedWindowHash());this.sIAppStateKey=this.findAppStateInHash(s)};a.getFullHash=function t(){const e=this._oShellServices.splitHash(this.getDecodedWindowHash());if("appSpecificRoute"in e){return e.appSpecificRoute?.replace(/^&\//,"")??""}return""};a.getHash=function t(){return this._oRouter.getHashChanger().getHash()??""};a.getAppNameFromHash=function t(e){const s=this._oShellServices?.splitHash(e);return s?.shellPart??""};a.isFocusForced=function t(){return this._bForceFocus};a.setFocusForced=function t(e){this._bForceFocus=e};a.removeIAppStateKey=function t(){this.sIAppStateKey=null};a.setAppStateUpdating=function t(e){this.appStateUpdating=e};a.isAppStateUpdating=function t(){return this.appStateUpdating};a.removeRestoreHistoryFlagFromHash=function t(e){return e.replace("restoreHistory=true&","").replace(/[?&]restoreHistory=true/,"")};a.navToHash=async function t(e,s,i,n,o){e=e.startsWith("/")?e.substring(1):e;if(o!==false){await this._oShellServices.setBackNavigation()}e=this.removeRestoreHistoryFlagFromHash(e);if(this._oRouteMatchSynchronization){return this._oRouteMatchSynchronization.waitFor().then(async()=>{this._oRouteMatchSynchronization=undefined;return this._internalNavToHash(e,s,i,n)})}else{if(this._bActivateRouteMatchSynchro){this.waitForRouteMatchBeforeNavigation()}return this._internalNavToHash(e,s,i,n)}};a._internalNavToHash=async function t(e,s,n,a){if(this.fclEnabled&&this.sIAppStateKey&&!this.findAppStateInHash(e)){e=this.setAppStateInHash(e,this.sIAppStateKey)}if(!this.checkHashWithGuard(e)){if(!this.oResourceBundle){this.oResourceBundle=o.getResourceBundleFor("sap.fe.core")}if(!confirm(this.oResourceBundle.getText("C_ROUTER_PROXY_SAPFE_EXIT_NOTSAVED_MESSAGE"))){return Promise.resolve(false)}this.bIsGuardCrossAllowed=true}const r=this._extractStateFromHash(e);if(!this._bForceFocus){const t=i.extractEntitySetsFromHash(this.getHash());this._bForceFocus=a||t.length<r.keys.length&&t.every(function(t,e){return t===r.keys[e]})}const h=this._pushNewState(r,false,s,n);this.storeFocusInfoForCurrentHash();return this._rebuildBrowserHistory(h,false)};a.restoreHistory=async function t(){if(this._bApplyRestore){this._bApplyRestore=false;let t=this.getHash();t=this.removeRestoreHistoryFlagFromHash(t);const e=this._extractStateFromHash(t);const s=this._pushNewState(e,true,false,true);this.restoreHistoryTriggered=true;return this._rebuildBrowserHistory(s,true)}else{return Promise.resolve()}};a.checkRestoreHistoryWasTriggered=function t(){return this.restoreHistoryTriggered};a.resetRestoreHistoryFlag=function t(){this.restoreHistoryTriggered=false};a.navBack=async function t(){const e=this.getHash();let s;for(let t=this._oManagedHistory.length-1;t>0;t--){if(this._oManagedHistory[t].hash===e){s=this._oManagedHistory[t-1].hash;break}}if(s){return this.navToHash(s)}else{window.history.back();return Promise.resolve()}};a.navTo=async function t(e,s){const i=this._oRouter.getURL(e,s);return this.navToHash(i,false,s?.noPreservationCache,false,!s?.bIsStickyMode)};a.exitFromApp=function t(){return this._oShellServices.backToPreviousApp()};a.isCurrentStateImpactedBy=function t(e){if(e[0]==="/"){e=e.substring(1)}const s=d(e);return s.check(this.getHash())};a.isNavigationFinalized=function t(){return!this.bIsRebuildHistoryRunning};a.setNavigationGuard=function t(e,s){this._oNavigationGuard=d(e,s);this.bIsGuardCrossAllowed=false};a.discardNavigationGuard=function t(){this._oNavigationGuard=null};a.hasNavigationGuard=function t(){return this._oNavigationGuard!==null};a.checkHashWithGuard=function t(e){return this._oNavigationGuard===null||this._oNavigationGuard.check(e)};a.isGuardCrossAllowedByUser=function t(){return this.bIsGuardCrossAllowed};a.activateRouteMatchSynchronization=function t(){this._bActivateRouteMatchSynchro=true};a.resolveRouteMatch=function t(){if(this._oRouteMatchSynchronization){this._oRouteMatchSynchronization.resolve()}};a.waitForRouteMatchBeforeNavigation=function t(){this._oRouteMatchSynchronization=new s;this._bActivateRouteMatchSynchro=false};i.extractEntitySetsFromHash=function t(e){if(e===undefined){e=""}const s=e.split("?")[0];const i=s.split("/");const n=[];i.forEach(t=>{if(t.length){n.push(t.split("(")[0])}});return n};a._extractStateFromHash=function t(e){if(e===undefined){e=""}const s={keys:i.extractEntitySetsFromHash(e),hash:e,screenMode:0};const n=e.match(new RegExp(`\\?.*${f.LAYOUTPARAM}=([^&]*)`));s.sLayout=n&&n.length>1?n[1]:undefined;if(s.sLayout==="MidColumnFullScreen"){s.screenMode=1}else if(s.sLayout==="EndColumnFullScreen"){s.screenMode=2}else{s.screenMode=0}return s};a._pushNewState=function t(e,s,i,n){const o=this.removeRestoreHistoryFlagFromHash(this.getHash());let a=this._oManagedHistory.length-1;let r=s?1:0;if(!s){while(a>=0&&this._oManagedHistory[a].hash!==o){this._oManagedHistory.pop();a--}if(this._oManagedHistory.length===0){this._oManagedHistory.push(this._extractStateFromHash(o));history.replaceState(Object.assign({feLevel:0},history.state),"")}}if(i&&!n){this._oManagedHistory[this._oManagedHistory.length-1].preserved=true}let h;while(this._oManagedHistory.length>0){const t=this._oManagedHistory[this._oManagedHistory.length-1];if((n||!t.preserved)&&this._compareCacheStates(t,e)!==l.ANCESTOR){h=this._oManagedHistory.pop();r++}else if(t.preserved&&p(t.hash)===p(e.hash)){h=this._oManagedHistory.pop();r++;e.preserved=true;break}else{break}}this.sIAppStateKey=this.findAppStateInHash(e.hash);if(!this.fclEnabled&&h){const t=this.findAppStateInHash(h.hash);const s=this._compareCacheStates(h,e);if(!this.sIAppStateKey&&t&&(s===l.EQUAL||s===l.COMPATIBLE)){e.hash=this.setAppStateInHash(e.hash,t)}}const c=h&&e.hash===h.hash;if(this._oManagedHistory.length===0||this._oManagedHistory[this._oManagedHistory.length-1].hash!==e.hash){this._oManagedHistory.push(e);if(h&&p(h.hash)===p(e.hash)){e.focusControlId=h.focusControlId;e.secondaryFocusControlId=h.secondaryFocusControlId;e.focusInfo=h.focusInfo;e.secondaryFocusInfo=h.secondaryFocusInfo}}if(r===0){return{type:"append"}}else if(r===1){return c?{type:"none"}:{type:"replace"}}else{return c?{type:"back",steps:r-1}:{type:"back-replace",steps:r-1}}};a._blockingNavigationFilter=function t(){return this._bDisableOnHashChange?"Custom":"Continue"};a._disableEventOnHashChange=function t(){this._bDisableOnHashChange=true;this._oRouter.stop()};a._enableEventOnHashChange=function t(e){this._bDisableOnHashChange=false;this._oRouter.initialize(e)};a._rebuildBrowserHistory=async function t(e,s){const i=this;return new Promise(t=>{this.bIsRebuildHistoryRunning=true;const n=this._oManagedHistory[this._oManagedHistory.length-1],o=this._oManagedHistory.length-1;function a(){if(!s){i._enableEventOnHashChange(true)}i._oRouter.getHashChanger().replaceHash(n.hash);history.replaceState(Object.assign({feLevel:o},history.state),"");if(s){setTimeout(function(){i._enableEventOnHashChange(true)},0)}i.bIsRebuildHistoryRunning=false;t(true)}function r(){window.removeEventListener("popstate",r);setTimeout(function(){a()},0)}function h(){window.removeEventListener("popstate",h);i.bIsRebuildHistoryRunning=false;t(true)}i._bIgnoreRestore=true;switch(e.type){case"replace":const s=history.state?.focusInfo;i._oRouter.getHashChanger().replaceHash(n.hash);history.replaceState(Object.assign({feLevel:o,focusInfo:s},history.state),"");i.bIsRebuildHistoryRunning=false;t(true);break;case"append":i._oRouter.getHashChanger().setHash(n.hash);history.replaceState(Object.assign({feLevel:o},history.state),"");i.bIsRebuildHistoryRunning=false;t(true);break;case"back":window.addEventListener("popstate",h);history.go(-e.steps);break;case"back-replace":this._disableEventOnHashChange();window.addEventListener("popstate",r);history.go(-e.steps);break;default:this.bIsRebuildHistoryRunning=false;t(false)}})};a.getLastHistoryEntry=function t(){return this._oManagedHistory[this._oManagedHistory.length-1]};a.setPathMapping=function t(e){this._pathMappings=e.filter(t=>t.oldPath!==t.newPath)};a.hashGuard=function t(){let e=this.getDecodedWindowHash();const s=this.getAppNameFromHash(e);if(s!=this.appName){return}if(e.includes("restoreHistory=true")){this._bApplyRestore=true}else if(!this.bIsRebuildHistoryRunning&&this._oRouter.isInitialized()){const t=this._pathMappings.find(t=>e.includes(t.oldPath));if(t){e=e.replace(t.oldPath,t.newPath);history.replaceState(Object.assign({},history.state),"",encodeURI(e))}const s=e.split("&/");const i=s[1]?s[1]:"";if(this.checkHashWithGuard(i)){const t=this._extractStateFromHash(i);this._pushNewState(t,false,false,this.isAppStateUpdating()?false:true)}}};a._compareCacheStates=function t(e,s){if(e.keys.length>s.keys.length){return l.DIFFERENT}let i=true;let n;for(n=0;i&&n<e.keys.length;n++){if(e.keys[n]!==s.keys[n]){i=false}}if(!i){if(e.keys.length===1&&s.keys.length===1&&this.routingHints?.[e.keys[0]]){if(this.routingHints[e.keys[0]].parentOf&&this.routingHints[e.keys[0]].parentOf.includes(s.keys[0])){return l.ANCESTOR}}return l.DIFFERENT}if(e.keys.length<s.keys.length||e.screenMode<s.screenMode){return l.ANCESTOR}if(e.screenMode>s.screenMode){return l.DIFFERENT}return e.sLayout===s.sLayout?l.EQUAL:l.COMPATIBLE};i.splitAppSpecificRoute=function t(e){const s=e?.split("&/")??[];if(!s[0]){s.shift()}return s};a.checkIfBackIsOutOfGuard=function t(){const e=this.getFullHash();const s=i.splitAppSpecificRoute(e);if(s.length>1){return false}const n=s[0]??"";let o;if(this._oNavigationGuard){for(let t=this._oManagedHistory.length-1;t>0;t--){if(this._oManagedHistory[t].hash===n){o=this._oManagedHistory[t-1].hash;break}}return!o||!this.checkHashWithGuard(o)}return false};a.checkIfBackExitsApp=function t(){const e=this.getFullHash();const s=i.splitAppSpecificRoute(e);if(s.length>1){return false}const n=s[0]??"";return this._oManagedHistory.length>0&&this._oManagedHistory[0].hash===n};a.checkIfBackHasSameContext=function t(){if(this._oManagedHistory.length<2){return false}const e=this._oManagedHistory[this._oManagedHistory.length-1];const s=this._oManagedHistory[this._oManagedHistory.length-2];return e.hash.split("?")[0]===s.hash.split("?")[0]};a.restoreFocusForCurrentHash=function t(){const e=p(this.getHash());const s=this._oManagedHistory.find(t=>p(t.hash)===e);let i=false;if(s?.focusControlId){let t=n.getElementById(s.focusControlId);let e=s.focusInfo;let o=false;if((!t||!t.getFocusDomRef())&&s.secondaryFocusControlId){t=n.getElementById(s.secondaryFocusControlId);e=s.secondaryFocusInfo;o=true}if(t?.getParent()?.isA("sap.ui.mdc.Table")&&t.getBusy()&&!o){return false}t?.focus(e);i=t!==undefined}return i};a.storeFocusInfoForCurrentHash=function t(){const e=p(this.getHash());const s=this._oManagedHistory.find(t=>p(t.hash)===e);if(s){const t=n.getActiveElement();s.focusControlId=t?.getId();if(t){let e=t.getParent();while(e&&!e.isA("sap.ui.table.Table")&&!e.isA("sap.m.Table")){e=e.getParent()}s.secondaryFocusControlId=e?.getId();s.secondaryFocusInfo={preventScroll:true}}s.focusInfo=t?.getFocusInfo()}};a.findLayoutForHash=function t(e){if(!this.fclEnabled){return undefined}const s=e.split("?")[0];let i;for(let t=this._oManagedHistory.length-1;t>=0&&i===undefined;t--){if(this._oManagedHistory[t].hash.split("?")[0]===s){i=this._oManagedHistory[t]}}return i?.sLayout};return i}(i))||r);return g},false);
//# sourceMappingURL=RouterProxy.js.map