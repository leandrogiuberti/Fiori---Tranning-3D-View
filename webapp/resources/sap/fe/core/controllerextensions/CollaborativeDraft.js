/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/ClassSupport","sap/ui/core/Element","../CommonUtils","../templating/UIFormatters","./BaseControllerExtension","./collaboration/CollaborationCommon"],function(t,e,i,o,r,n,a){"use strict";var s,c;var l={};var f=a.shareObject;var u=a.addSelf;var d=a.CollaborationUtils;var h=a.CollaborationFieldGroupPrefix;var g=a.Activity;var p=r.FieldEditMode;var v=e.defineUI5Class;function b(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,C(t,e)}function C(t,e){return C=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},C(t,e)}let P=(s=v("sap.fe.core.controllerextensions.CollaborativeDraft"),s(c=function(e){function r(){return e.apply(this,arguments)||this}l=r;b(r,e);var n=r.prototype;n.getCollaborativeDraftService=function t(){this.collaborativeDraftService=this.collaborativeDraftService??this.base.getAppComponent().getCollaborativeDraftService();return this.collaborativeDraftService};n.handleContentFocusIn=function t(e,o){if(e.isA("sap.m.Tokenizer")){e=e.getParent()?.getParent()}let r=false;if(o){r=!e.getDomRef()?.contains(o.relatedTarget)}if(e.isA("sap.ui.mdc.MultiValueField")||r){const t=this.getLastFocusId();if(t&&t!==e.getId()&&this.getLastFocusFieldGroups()===e.getFieldGroupIds().join(",")){const e=i.getElementById(t);this?.sendFocusOutMessage(e)}this.setLastFocusInformation(e);this.sendFocusInMessage(e)}};n.handleContentFocusOut=function t(e){let o=e.getSource();if(o.isA("sap.m.Tokenizer")){o=o.getParent()?.getParent()}if(!o.isA("sap.ui.mdc.MultiValueField")){while(o&&!o?.isA("sap.fe.macros.Field")){o=o?.getParent()}if(!o)return}const r=e.getParameter("fieldGroupIds");if(r.some(t=>t.startsWith(h))){const t=e.getSource();let r=i.getActiveElement();while(r&&r!==t){r=r.getParent()}if(r!==t){this.sendFocusOutMessage(o);if(this.getLastFocusId()===o.getId()){this.setLastFocusInformation(undefined)}}}};n.getLastFocusId=function t(){return this.lastFocusId};n.getLastFocusFieldGroups=function t(){return this.lastFocusFieldGroups};n.setLastFocusInformation=function t(e){this.lastFocusId=e?.getId();this.lastFocusFieldGroups=e?.getFieldGroupIds().join(",")};n.sendFocusInMessage=function t(e){const i=this.getCollaborationPath(e);if(i){this.send({action:g.Lock,content:i})}};n.sendFocusOutMessage=function t(e){if(!e){return}const i=this.getCollaborationPath(e);if(i){this.send({action:g.Unlock,content:i})}};n.getCollaborationPath=function t(e){const i=e?.getBindingContext();if(!i){return}if(e.isA("sap.fe.macros.Field")){if(!e.getMainPropertyRelativePath()){return undefined}const t=e.content;if(![p.Editable,p.EditableDisplay,p.EditableReadOnly].includes(t?.getProperty("editMode"))){return undefined}return`${i.getPath()}/${e.getMainPropertyRelativePath()}`}else if(e.isA("sap.ui.mdc.MultiValueField")){const t=e.getBindingInfo("items").template.getBindingPath("key");return`${i.getPath()}/${e.getBindingInfo("items").path}/${t}`}};n.send=function t(e){this.getCollaborativeDraftService().send(this.getView(),e)};n.isConnected=function t(){return this.getCollaborativeDraftService().isConnected(this.getView())};n.connect=async function t(e){return this.getCollaborativeDraftService().connect(e,this.getView())};n.disconnect=function t(){const e=this.getView().getModel("ui");this.cleanDraftRoot();e.setProperty("/hasCollaborationAuthorization",undefined);if(this.isConnected()){this.getCollaborativeDraftService().disconnect(this.getView())}};n.isCollaborationEnabled=function t(){return this.getCollaborativeDraftService().isCollaborationEnabled(this.getView())};n.retainAsyncMessages=function t(e){return this.getCollaborativeDraftService().retainAsyncMessages(this.getView(),e)};n.releaseAsyncMessages=function t(e){return this.getCollaborativeDraftService().releaseAsyncMessages(this.getView(),e)};n.updateLocksForContextPath=function t(e,i){return this.getCollaborativeDraftService().updateLocksForContextPath(this.getView(),e,i)};n.getCurrentDraftRootPath=function t(){const e=this.getView().getModel("internal");return e?.getProperty("/collaborativeDraftRootPath")};n.getDraftUserListPromise=function t(){const e=this.getView().getModel("internal");return e?.getProperty("/collaborativeDraftUserListPromise")};n.isInitialShare=function t(){const e=this.getView().getModel("internal");return e?.getProperty("/collaborativeDraftShareInitial")===true};n.setInitialShare=function t(e){const i=this.getView().getModel("internal");i?.setProperty("/collaborativeDraftShareInitial",e)};n.setDraftRoot=function e(i,o){const r=this.getView().getModel("internal");let n;if(i.getObject("DraftAdministrativeData/DraftAdministrativeUser")===undefined){n=new Promise(e=>{const o=i.getModel().bindList("DraftAdministrativeData/DraftAdministrativeUser",i);o.requestContexts().then(t=>e(t.map(t=>t.getObject()))).catch(e=>{t.error("Error while loading the DraftAdministrativeUser "+e)})})}else{n=i.requestSideEffects(["DraftAdministrativeData/DraftAdministrativeUser"],o).then(async()=>i.requestObject("DraftAdministrativeData/DraftAdministrativeUser"))}r?.setProperty("/collaborativeDraftUserListPromise",n);r?.setProperty("/collaborativeDraftRootPath",i.getPath())};n.cleanDraftRoot=function t(){const e=this.getView().getModel("internal");e?.setProperty("/collaborativeDraftUserListPromise",undefined);e?.setProperty("/collaborativeDraftRootPath",undefined)};n.activateCollaboration=async function e(i,r){try{const e=this.getView().getModel("ui");if(r){e.setProperty("/hasCollaborationAuthorization",undefined);this.disconnect();return false}const n=o.findOrCreateRootContext(i,"Draft",this.getView(),this.base.getAppComponent(),{$$groupId:i.getGroupId(),$select:"DraftAdministrativeData/DraftAdministrativeUser"}).rootContext;if(!n){t.error("Couldn't find draft root context for enabling collaboration");return false}const a=this.getCurrentDraftRootPath();if(a!==n.getPath()){t.error(`Unexpected path for checking collaboration authorizations: ${n.getPath()} (expecting ${a})`)}const s=await this.getDraftUserListPromise();if(e.getProperty("/hasCollaborationAuthorization")!==undefined){return e.getProperty("/hasCollaborationAuthorization")}const c=d.getMe(this.base.getAppComponent());const l=s?.some(t=>t.UserID===c.id)??false;e.setProperty("/hasCollaborationAuthorization",l);e.setProperty("/showCollaborationStrip",!l);if(l){this.connect(n).catch(e=>{t.error("Error when connecting to the collaboration draft "+e)})}else if(this.isConnected()){this.getCollaborativeDraftService().disconnect(this.getView())}return l}catch(e){t.error("Error while activating the collaborative draft "+e);return false}};n.executeShareAction=async function e(i){try{const e=o.findOrCreateRootContext(i,"Draft",this.getView(),this.base.getAppComponent(),{$$groupId:i.getGroupId(),$select:"DraftAdministrativeData/DraftAdministrativeUser"}).rootContext;if(!e){t.error("Couldn't find draft root context for enabling collaboration");return}const r=this.getCurrentDraftRootPath();if(r!==undefined&&r!==e.getPath()){this.disconnect()}if(r===e.getPath()){return}const n=this.isInitialShare()?f(e,undefined,e.getGroupId()):u(e);this.setInitialShare(false);this.setDraftRoot(e,e.getGroupId());await n}catch(e){t.error("Error while adding current user in the collaborative draft "+e)}};n.sendLockChange=function t(e,i,o){this.send({action:o?g.Lock:g.Unlock,content:`${e.getPath()}/${i}`})};n.sendPropertyValuesChange=function t(e,i){if(!Array.isArray(i)){i=[i]}this.send({action:g.Change,content:i.map(t=>`${e.getPath()}/${t}`)})};n.sendContextsCreated=function t(e){this.send({action:g.Create,content:e.map(t=>t.getPath())})};n.sendContextsDeleted=function t(e){this.send({action:g.Delete,content:e.map(t=>t.getPath())})};return r}(n))||c);l=P;return l},false);
//# sourceMappingURL=CollaborativeDraft.js.map