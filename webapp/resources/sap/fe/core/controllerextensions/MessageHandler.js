/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/base/util/uid","sap/fe/base/ClassSupport","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/ui/core/Lib","sap/ui/core/Messaging","sap/ui/core/message/MessageType","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","../helpers/ResourceModelHelper"],function(e,t,s,o,n,i,r,a,g,l,c,p){"use strict";var u,d,h,f,M,y,m,T,w,b,v,S,E,I,P;var D=p.getResourceModel;var C=o.publicExtension;var O=o.privateExtension;var A=o.methodOverride;var U=o.finalExtension;var B=o.extensible;var _=o.defineUI5Class;function x(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,H(e,t)}function H(e,t){return H=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},H(e,t)}function N(e,t,s,o,n){var i={};return Object.keys(o).forEach(function(e){i[e]=o[e]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=s.slice().reverse().reduce(function(s,o){return o(e,t,s)||s},i),n&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(n):void 0,i.initializer=void 0),void 0===i.initializer?(Object.defineProperty(e,t,i),null):i}let R=(u=_("sap.fe.core.controllerextensions.MessageHandler"),d=A(),h=O(),f=B(c.Instead),M=O(),y=B(c.Instead),m=C(),T=B("AfterAsync"),w=C(),b=U(),v=C(),S=C(),E=U(),u(I=(P=function(o){function l(){var e;e=o.call(this)||this;e.strictWarningMessages=[];e.holdKeys=[];e.holdMsgsToShow=false;return e}x(l,o);var c=l.prototype;c.onInit=function e(){const t=this.base.getAppComponent().getModel("internal");t.setProperty("/messageUIDecision",undefined);t.setProperty("/messageUIElementIsAvailable",Promise.resolve())};c.addWarningMessagesToMessageHandler=function e(t){this.strictWarningMessages=this.strictWarningMessages.concat(t)};c.isStrictWarningMessage=function e(s){return this.strictWarningMessages.find(e=>e.getCode()===s.getCode()&&e.getMessage()===s.getMessage()&&e.getType()===s.getType()&&e.getDescriptionUrl()===s.getDescriptionUrl()&&t(e.getTargets(),s.getTargets())&&e.getPersistent()===s.getPersistent())!==undefined};c.clearStrictWarningMessages=function e(){this.strictWarningMessages=[]};c.filterErrorMessages=function e(t){return t.filter(e=>e.getType()===g.Error)};c.getShowBoundMessagesInMessageDialog=function e(){return true};c.filterContextBoundMessages=function e(t,s){return t};c.beforeShowMessageButton=async function e(t){return Promise.resolve()};c.registerToHoldMessages=function e(t){const o=t??s();if(!this.holdKeys.includes(o)){this.holdKeys.push(o)}return o};c.resetHoldKeys=function e(){this.holdKeys=[]};c.showMessageDialog=async function e(t){const s=this.base.getAppComponent().getModel("internal");await s.getProperty("/messageUIElementIsAvailable");const o=a.getMessageModel().getData();const n=o.filter(e=>this.isStrictWarningMessage(e));a.removeMessages(n);const i=t&&t.customMessages?t.customMessages:undefined,r=this.base.getView().getBindingContext("internal");const g=this.base.getView().getViewData().converterType;if(t&&t.isOperationDialogOpen&&r){r.setProperty("isOperationDialogOpen",true)}const l=this.getShowBoundMessagesInMessageDialog();const c=t&&t.context?t.context:this.getView().getBindingContext();if(r){r.setProperty("isOperationDialogOpen",false)}return new Promise(function(e,s){setTimeout(function(){this.processAndShowMessages(t??{},c,l,i??[],e,s,g)}.bind(this),0)}.bind(this))};c.processAndShowMessages=function e(t,s,o,n,r,a,g){const{concurrentEditFlag:l,control:c,sActionName:p,onBeforeShowMessage:u,unHoldKey:d,isOperationDialogOpen:h=false,overrideUIDecision:f,showBoundStateMessages:M}=t;this.holdMsgsToShow=true;const y=i.getUIDecisions(n,s,o,l,c,p,u,g,M,t,D(this.getView()),this);this.updateUIDecisions(y,f);this.removeHoldKey(d??c?.getId());const m=this.base.getAppComponent().getModel("internal")?.getProperty("/messageUIElementIsAvailable");this.base.getAppComponent().getModel("internal")?.setProperty("/messageUIElementIsAvailable",m.then(async function(){return this.showMessagesWithCondtions(h,r,a)}.bind(this)))};c.showMessagesWithCondtions=async function t(){let s=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;let o=arguments.length>1?arguments[1]:undefined;let n=arguments.length>2?arguments[2]:undefined;const r=s||this.checkToShowUIElement();const a=this.base.getAppComponent().getModel("internal");if(r&&a.getProperty("/messageUIDecision")){try{const e=await i.showMessagesInUI(a.getProperty("/messageUIDecision"));o?.(e)}catch(t){e.error(`FE : V4 : MessageHandler : Error on trying to show UI element: ${t}`);n?.(t);a.setProperty("/messageUIElementIsAvailable",Promise.resolve())}a.setProperty("/messageUIDecision",undefined);this.clearStrictWarningMessages();this.holdMsgsToShow=false}else{e.info("FE : V4 : MessageHandler : Holding messages until a registered process ");o?.()}};c.removeTransitionMessages=function e(t,s,o){if(!t){i.removeBoundTransitionMessages(o)}if(!s){i.removeUnboundTransitionMessages()}};c._checkNavigationToErrorPage=function e(t){const s=i.getMessages();const o=this.getShowBoundMessagesInMessageDialog();const r=o?i.getMessages(true,true):[];const a=t&&t.customMessages?t.customMessages:[];const g=n.isStickyEditMode(this.base.getView());let l;if(t?.isDataReceivedError===true){l={title:t.title,description:t.description,navigateBackToOrigin:true,errorType:"PageNotFound"}}else if(!g&&!r.length&&!a.length&&(s.length===1||t?.isInitialLoad503Error===true)){const e=s[0];const t=e.getTechnicalDetails();if(t?.httpStatus===503){l=this._getHTTP503MessageParameters(e,t)}}return l};c._getHTTP503MessageParameters=function e(t,s){let o;const n=s.retryAfter!==undefined?this._getSecondsBeforeRetryAfter(s.retryAfter):undefined;if(n===undefined||n>120){const e=i.getRetryAfterMessage(t);o={description:e?`${e} ${t.getMessage()}`:t.getMessage(),navigateBackToOrigin:true,errorType:"UnableToLoad"}}return o};c._getSecondsBeforeRetryAfter=function e(t){const s=new Date,o=s.getTime(),n=t.getTime(),i=(n-o)/1e3;return i};c.updateUIDecisions=function e(t){let s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;const o=this.base.getAppComponent().getModel("internal");const n=o.getProperty("/messageUIDecision");let i=[];let r;if(n&&s===false){if(n.messagesToShow.length===1&&t.messagesToShow.length===1&&n.messagesToShow[0].getCode()==="C_COMMON_SUCCESS_MESSAGE"&&t.messagesToShow[0].getCode()==="C_COMMON_SUCCESS_MESSAGE"){i=n.messagesToShow}else{i=Array.from(new Set([...n.messagesToShow,...t.messagesToShow]))}const e=[n.uiElementToUse,t.uiElementToUse];let s=i.length>0?"Dialog":"None";if(i.length===1){if(e.includes("Toast")){s="Toast"}else if(e.includes("Box")){s="Box"}}r={messagesToShow:i,uiElementToUse:s,contextNeedsEtagRefresh:n.contextNeedsEtagRefresh||t.contextNeedsEtagRefresh,containsBoundTransition:n.containsBoundTransition||t.containsBoundTransition}}else{r=t}o.setProperty("/messageUIDecision",r)};c.removeHoldKey=function e(t){if(t&&this.holdKeys.includes(t)){this.holdKeys.splice(this.holdKeys.indexOf(t),1)}};c.checkToShowUIElement=function e(){return this.holdMsgsToShow&&(this.holdKeys.length>0?false:true)};c.holdMessagesForControl=function e(t){const s=t.getId();this.registerToHoldMessages(s)};c.releaseHoldByControl=async function e(t){const s=t?.getId();this.removeHoldKey(s);const o=this.base.getAppComponent().getModel("internal")?.getProperty("/messageUIElementIsAvailable");this.base.getAppComponent().getModel("internal")?.setProperty("/messageUIElementIsAvailable",o?.then(async function(){return this.showMessagesWithCondtions()}.bind(this)));await(this.base.getAppComponent().getModel("internal")?.getProperty("/messageUIElementIsAvailable"))};c.showMessages=async function e(t){const s=this._checkNavigationToErrorPage(t);if(s){if(t?.messagePageNavigationCallback){t.messagePageNavigationCallback()}s.handleShellBack=!t?.shellBack;this.removeTransitionMessages();const e=r.getResourceBundleFor("sap.fe.core");return new Promise((o,n)=>{setTimeout(()=>{this.resetHoldKeys();this.base._routing.navigateToMessagePage(t?.isDataReceivedError===true?e.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"):e.getText("C_MESSAGE_HANDLING_SAPFE_503_TITLE"),s).then(o).catch(n)},0)})}else{return this.showMessageDialog(t)}};return l}(l),N(P.prototype,"onInit",[d],Object.getOwnPropertyDescriptor(P.prototype,"onInit"),P.prototype),N(P.prototype,"getShowBoundMessagesInMessageDialog",[h,f],Object.getOwnPropertyDescriptor(P.prototype,"getShowBoundMessagesInMessageDialog"),P.prototype),N(P.prototype,"filterContextBoundMessages",[M,y],Object.getOwnPropertyDescriptor(P.prototype,"filterContextBoundMessages"),P.prototype),N(P.prototype,"beforeShowMessageButton",[m,T],Object.getOwnPropertyDescriptor(P.prototype,"beforeShowMessageButton"),P.prototype),N(P.prototype,"showMessageDialog",[w,b],Object.getOwnPropertyDescriptor(P.prototype,"showMessageDialog"),P.prototype),N(P.prototype,"removeTransitionMessages",[v],Object.getOwnPropertyDescriptor(P.prototype,"removeTransitionMessages"),P.prototype),N(P.prototype,"showMessages",[S,E],Object.getOwnPropertyDescriptor(P.prototype,"showMessages"),P.prototype),P))||I);return R},false);
//# sourceMappingURL=MessageHandler.js.map