/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/ClassSupport","sap/fe/base/HookSupport","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BaseControllerExtension","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/controls/inlineEditFlow/InlineEditExitDialog","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/TypeGuards","sap/m/MessageToast","sap/ui/core/Lib","sap/ui/core/Messaging","../controls/inlineEditFlow/DraftExistsDialog"],function(e,t,i,n,o,r,s,a,l,d,c,h,p){"use strict";var f,u,g,E,y,I,v,b,w,P;var C={};var m=l.isProperty;var B=i.hookable;var D=t.methodOverride;var F=t.defineUI5Class;function A(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,T(e,t)}function T(e,t){return T=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},T(e,t)}function O(e,t,i,n,o){var r={};return Object.keys(n).forEach(function(e){r[e]=n[e]}),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=i.slice().reverse().reduce(function(i,n){return n(e,t,i)||i},r),o&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(o):void 0,r.initializer=void 0),void 0===r.initializer?(Object.defineProperty(e,t,r),null):r}let S=(f=F("sap.fe.core.controllerextensions.InlineEditFlow"),u=B("Before"),g=D("routing"),E=D("_routing"),y=D("editFlow"),I=D("editFlow"),v=D("editFlow"),b=D("editFlow"),f(w=(P=function(t){function i(){var e;for(var i=arguments.length,n=new Array(i),o=0;o<i;o++){n[o]=arguments[o]}e=t.call(this,...n)||this;e.inlineEditControls=[];e.preventFieldGroupChangeHandler=false;return e}C=i;A(i,t);var o=i.prototype;o.isInlineEditPossible=function e(){return this.base.getAppComponent().getInlineEditService().doesPageHaveInlineEdit(this.base.getRoutingTargetName())};o.inlineEditSave=async function t(){const i=this.base.getView().getModel();const o=h.getMessageModel().getData();const s=o.some(e=>!r.isNonTechnicalMessage(e));if(s){this.base.setShowFooter(true);return}if(!i.hasPendingChanges(n.INLINEEDIT_UPDATEGROUPID)){this.inlineEditEnd();return}try{h.removeAllMessages();await i.submitBatch(n.INLINEEDIT_UPDATEGROUPID)}catch(t){e.warning("Error while saving inline edit changes")}};o.inlineEditDiscard=function e(){this.base.getView().getModel().resetChanges(n.INLINEEDIT_UPDATEGROUPID);this.inlineEditEnd(true)};o.inlineEditEnd=function e(t){h.removeAllMessages();this.base.setShowFooter(false);for(const e of this.inlineEditControls){e.inlineEditEnd(t)}this.inlineEditControls=[];this.base.getView().getModel("ui").setProperty("/isInlineEditActive",false)};o.startInlineEdit=function e(t,i,n){if(n?.getBindingContext()?.getProperty("HasDraftEntity")){new p(this.base.getView()).open();n?.resetIndicatorPopup();return}const o=this.base.getAppComponent().getInlineEditService();const r=o.getInlineConnectedProperties(this.base.getRoutingTargetName(),t);this.inlineEditStart([],r?.length?r:[t],i);this.base.getView().getModel("ui").setProperty("/isInlineEditActive",true)};o.focusHandling=function e(t){for(const e of this.inlineEditControls){if(e!==t){e.closeInlineEditPopupEditMode()}else if(e===t){e.focus()}}};o.inlineEditStart=async function e(t,i,n){if(this.abortTimerBeforeSave){this.abortTimerBeforeSave();this.abortTimerBeforeSave=undefined;await this.inlineEditSave()}const o=this.inlineEditControls.map(e=>e.getId());for(const e of t){if(!o.includes(e.getId())){this.inlineEditControls.push(e)}}this.inlineEditBindingContextPath=n;return};o.isPropertyConsideredForInlineEdit=function e(t){return this.base.getAppComponent().getInlineEditService().isPropertyConsideredForInlineEdit(this.base.getRoutingTargetName(),t)};o.handleInlineEditPatchSent=async function e(t){if(this.inlineEditControls.length===0){return}this.patchPromise=new Promise((e,i)=>{t.getSource().attachEventOnce("patchCompleted",t=>{const n=t.getParameter("success");if(n){e(t)}else{i(t)}})});try{await this.patchPromise;this.patchPromise=undefined;const e=c.getResourceBundleFor("sap.fe.core");if(e){d.show(e.getText("C_INLINE_EDIT_SAVED"))}this.inlineEditEnd()}catch(e){this.patchPromise=undefined;this.handleInlineEditSaveFailed()}};o.handleInlineEditSaveFailed=function e(){const t=this.base.getView().getModel().getMetaModel();const i=h.getMessageModel().getData();if(i.length){this.base.setShowFooter(true);this.propagateInlineFieldGroupIdToMessageButton()}if(!this.inlineEditBindingContextPath){return}for(const e of i){for(const i of e.getTargets()){const e=t.createBindingContext(t.getMetaPath(i));const n=e?a.getInvolvedDataModelObjects(e):null;if(m(n?.targetObject)){const e=n?.targetObject?.fullyQualifiedName??"";if(this.isPropertyConsideredForInlineEdit(e)){this.startInlineEdit(e,this.inlineEditBindingContextPath)}}}}};o.delayedCallToSave=async function e(){if(this.abortTimerBeforeSave||this.patchPromise||this.preventFieldGroupChangeHandler){return}const t=new Promise((e,t)=>{this.abortTimerBeforeSave=t;setTimeout(()=>e(),500)});try{await t;this.abortTimerBeforeSave=undefined;this.inlineEditSave()}catch(e){}};o.reactivateFieldGroupChangeHandler=function e(){setTimeout(()=>{this.preventFieldGroupChangeHandler=false},500)};o.hasInlineEditChanges=function e(){if(this.base.getView().getModel().hasPendingChanges(n.INLINEEDIT_UPDATEGROUPID)){return true}return this.inlineEditControls.some(e=>{if(e.isA("sap.fe.macros.Field")){return e.hasPendingUserInput()}return false})};o.onBeforeNavigation=async function e(){try{await this.onBeforeAnyEditFlowAction();return false}catch(e){return true}};o.openInlineEditExitDialogAndWaitForResult=async function e(){return new Promise(e=>{new s(this.base.getView(),e).open()})};o.onBeforeAnyEditFlowAction=async function e(){if(this.inlineEditControls.length>0){this.preventFieldGroupChangeHandler=true;if(this.abortTimerBeforeSave){this.abortTimerBeforeSave();this.abortTimerBeforeSave=undefined}if(!this.hasInlineEditChanges()){this.inlineEditEnd();return}try{if(this.patchPromise){await this.patchPromise}else{const e=await this.openInlineEditExitDialogAndWaitForResult();if(e==="Save"){await this.inlineEditSave();if(this.base.getView().getModel().hasPendingChanges(n.INLINEEDIT_UPDATEGROUPID)){this.focusHandling(this.inlineEditControls[0]);this.reactivateFieldGroupChangeHandler();throw new Error("unsave change prevent execution")}}else if(e==="Cancel"){this.focusHandling(this.inlineEditControls[0]);this.reactivateFieldGroupChangeHandler();throw new Error("cancel was chosen")}else{this.inlineEditDiscard()}this.reactivateFieldGroupChangeHandler();return}}catch(e){this.focusHandling(this.inlineEditControls[0]);this.reactivateFieldGroupChangeHandler();return Promise.reject()}}return};o.onBeforeBinding=function e(){if(this.inlineEditControls.length>0){this.inlineEditEnd()}if(this.base.getView().getModel().hasPendingChanges(n.INLINEEDIT_UPDATEGROUPID)){this.base.getView().getModel().resetChanges(n.INLINEEDIT_UPDATEGROUPID)}};o.onBeforeEdit=async function e(){return this.onBeforeAnyEditFlowAction()};o.onBeforeCreate=async function e(){return this.onBeforeAnyEditFlowAction()};o.onBeforeDelete=async function e(){return this.onBeforeAnyEditFlowAction()};o.onBeforeExecuteAction=async function e(){return this.onBeforeAnyEditFlowAction()};o.propagateInlineFieldGroupIdToMessageButton=function e(){const t=this.base.getFooter()?.findAggregatedObjects(true,e=>e.isA("sap.ui.core.Control"))??[];for(const e of t){const t=new Set(e.getFieldGroupIds());t.add("InlineEdit");e.setFieldGroupIds(Array.from(t))}};return i}(o),O(P.prototype,"inlineEditStart",[u],Object.getOwnPropertyDescriptor(P.prototype,"inlineEditStart"),P.prototype),O(P.prototype,"onBeforeNavigation",[g],Object.getOwnPropertyDescriptor(P.prototype,"onBeforeNavigation"),P.prototype),O(P.prototype,"onBeforeBinding",[E],Object.getOwnPropertyDescriptor(P.prototype,"onBeforeBinding"),P.prototype),O(P.prototype,"onBeforeEdit",[y],Object.getOwnPropertyDescriptor(P.prototype,"onBeforeEdit"),P.prototype),O(P.prototype,"onBeforeCreate",[I],Object.getOwnPropertyDescriptor(P.prototype,"onBeforeCreate"),P.prototype),O(P.prototype,"onBeforeDelete",[v],Object.getOwnPropertyDescriptor(P.prototype,"onBeforeDelete"),P.prototype),O(P.prototype,"onBeforeExecuteAction",[b],Object.getOwnPropertyDescriptor(P.prototype,"onBeforeExecuteAction"),P.prototype),P))||w);C=S;return C},false);
//# sourceMappingURL=InlineEditFlow.js.map