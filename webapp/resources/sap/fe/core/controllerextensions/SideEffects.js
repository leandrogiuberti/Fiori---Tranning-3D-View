/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/ClassSupport","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ResourceModelHelper","sap/m/Button","sap/m/Dialog","sap/m/MessageToast","sap/m/Text","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","../CommonUtils","sap/ui/core/Component"],function(e,t,i,r,o,s,n,c,f,d,a,p){"use strict";var l,u,g,h,E,y,F,S,m,_,v,C,x,P,O,b,w,G,D,M,j,R,I,A,T,q,B,$,N,V,k,z,W,Q,U,L,H,J,K,X,Y,Z,ee,te,ie,re,oe,se,ne,ce,fe,de;var ae=r.getResourceModel;var pe=i.getInvolvedDataModelObjectsForTargetPath;var le=t.publicExtension;var ue=t.privateExtension;var ge=t.methodOverride;var he=t.finalExtension;var Ee=t.extensible;var ye=t.defineUI5Class;function Fe(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,Se(e,t)}function Se(e,t){return Se=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Se(e,t)}function me(e,t,i,r,o){var s={};return Object.keys(r).forEach(function(e){s[e]=r[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=i.slice().reverse().reduce(function(i,r){return r(e,t,i)||i},s),o&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(o):void 0,s.initializer=void 0),void 0===s.initializer?(Object.defineProperty(e,t,s),null):s}const _e="$$ImmediateRequest";let ve=(l=ye("sap.fe.core.controllerextensions.SideEffects"),u=ge(),g=le(),h=he(),E=le(),y=he(),F=le(),S=he(),m=le(),_=he(),v=le(),C=he(),x=le(),P=he(),O=le(),b=he(),w=le(),G=he(),D=le(),M=he(),j=le(),R=he(),I=le(),A=he(),T=le(),q=he(),B=le(),$=he(),N=le(),V=he(),k=le(),z=Ee(d.Instead),W=le(),Q=Ee(d.Instead),U=le(),L=he(),H=ue(),J=he(),K=le(),X=he(),Y=le(),Z=he(),ee=ue(),te=he(),ie=ue(),re=he(),oe=le(),se=he(),ne=le(),ce=he(),l(fe=(de=function(t){function i(){var e;e=t.call(this)||this;e.requestExecutions=[];return e}Fe(i,t);var r=i.prototype;r.onInit=function e(){this._view=this.base.getView();this._pageComponent=p.getOwnerComponentFor(this._view);this._sideEffectsService=a.getAppComponent(this._view).getSideEffectsService();this._registeredFieldGroupMap={};this._fieldGroupInvalidity={};this._registeredFailedSideEffects={}};r.addControlSideEffects=function e(t,i){this._sideEffectsService.addControlSideEffects(t,i)};r.removeControlSideEffects=function e(t){const i=t.isA?.("sap.ui.base.ManagedObject")&&t.getId();if(i){this._sideEffectsService.removeControlSideEffects(i)}};r.getContextForSideEffects=function e(t,i){let r=t,o=this._sideEffectsService.getEntityTypeFromContext(t);if(i!==o){r=t.getBinding().getContext();if(r){o=this._sideEffectsService.getEntityTypeFromContext(r);if(i!==o){r=r.getBinding().getContext();if(r){o=this._sideEffectsService.getEntityTypeFromContext(r);if(i!==o){return undefined}}}}}return r||undefined};r.waitForSideEffectExecutions=async function e(){await Promise.allSettled(this.requestExecutions)};r.getFieldSideEffectsMap=function e(t){let i={};if(this._pageComponent){const e=this._pageComponent.getEntitySet?.();const r=this._pageComponent.getContextPath?.()||e&&`/${e}`;if(r){const e=t.getFieldGroupIds(),o=pe(r,this._view.getModel().getMetaModel());i=this.getSideEffectsMapForFieldGroups(e,t.getBindingContext());if(o){const e=o.targetEntityType.fullyQualifiedName,r=this.getTargetProperty(t),s=this.getContextForSideEffects(t.getBindingContext(),e);if(r&&s){const t=this._sideEffectsService.getControlEntitySideEffects(e);Object.keys(t).forEach(o=>{const n=t[o];if(n.sourceProperties.includes(r)){const t=`${o}::${e}`;i[t]={name:t,immediate:true,sideEffects:n,context:s}}})}}}}return i};r.getSideEffectsMapForFieldGroups=function e(t,i){const r={};t.forEach(e=>{const{name:t,immediate:o,sideEffects:s,sideEffectEntityType:n}=this._getSideEffectsPropertyForFieldGroup(e);const c=i?this.getContextForSideEffects(i,n):undefined;if(s&&(!i||i&&c)){r[t]={name:t,immediate:o,sideEffects:s};if(i){r[t].context=c}}});return r};r.clearFieldGroupsValidity=function e(){this._fieldGroupInvalidity={}};r.isFieldGroupValid=function e(t,i){const r=this._getFieldGroupIndex(t,i);return Object.keys(this._fieldGroupInvalidity[r]??{}).length===0};r.getTargetProperty=function e(t){const i=t.data("sourcePath");const r=this._view.getModel().getMetaModel();const o=this._view.getBindingContext()?.getPath();const s=o?`${r.getMetaPath(o)}/`:"";return i?.replace(s,"")};r.prepareDeferredSideEffectsForField=function e(t,i,r){const o=t.getSource();this._saveFieldPropertiesStatus(o,i);if(!i){return}const s=this.getFieldSideEffectsMap(o);Object.keys(s).filter(e=>s[e].immediate!==true).forEach(e=>{const t=s[e];this.registerFieldGroupSideEffects(t,r)})};r.handleFieldChange=async function e(t,i,r){let o=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;const s=t.getSource();if(!o){this.prepareDeferredSideEffectsForField(t,i,r)}else{this._saveFieldPropertiesStatus(s,i);if(!i){return}}return this._manageSideEffectsFromField(s)};r.handleFieldGroupChange=async function t(i){const r=i.getSource(),o=i.getParameter("fieldGroupIds")??[],s=o.some(e=>e.startsWith("fe_sideEffectHandling_"));let n=[];if(s){const e=this.handleCustomFieldFieldGroupChange(i);if(e){n.push(e.then(()=>{}))}}const c=o.reduce((e,t)=>e.concat(this.getRegisteredSideEffectsForFieldGroup(t)),[]);n=n.concat(c.map(async e=>this._requestFieldGroupSideEffects(e)));return Promise.all(n).catch(t=>{const i=r.getBindingContext()?.getPath();e.debug(`Error while processing FieldGroup SideEffects on context ${i}`,t)})};r.handleCustomFieldFieldGroupChange=function e(t){const i=t.getSource();const r=Object.values(this.getFieldSideEffectsMap(i));r.filter(e=>e.immediate!==true).forEach(e=>{this.registerFieldGroupSideEffects(e,Promise.resolve())});const o=r.filter(e=>e.immediate===true).map(e=>e.sideEffects);const s=i.getBindingContext();if(o.length&&s){return this.requestMultipleSideEffects(o,s)}return null};r.handlePageChangeContext=async function t(i){const r=this.getRegisteredSideEffectsForContext(i);return Promise.all(r.map(async e=>this._requestFieldGroupSideEffects(e)).concat(this.waitForSideEffectExecutions())).catch(t=>{e.debug(`Error while processing on page context ${i.getPath()}`,t)})};r.requestSideEffects=async function e(t,i,r,o){let s=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;const n=this.triggerCallbacks.bind(this);const{targets:c,triggerAction:f}=o?o(t):{targets:[...t.targetEntities??[],...t.targetProperties??[]],triggerAction:!this._sideEffectsService.isControlSideEffects(t)?t.triggerAction:undefined};if(f&&!s){this.requestExecutions.push(this._sideEffectsService.executeAction(f,i,{groupId:r}))}if(c.length){const e=this._sideEffectsService.requestSideEffects(c,i,r).then(async function e(){return n(t.targetEntities?.map(e=>e.$NavigationPropertyPath)||[])}).catch(e=>{this.registerFailedSideEffects([t],i);throw e});this.requestExecutions.push(e);return e}};r.requestSideEffectsForEvent=async function e(t,i){if(this.isDataPathRelevant(i,t)){await this.base.editFlow.syncTask();const e=this._findRelevantContext(i,this.getView().getBindingContext());if(e){return this._sideEffectsService.requestSideEffectsForEvent(t,e)}}};r.isDataPathRelevant=function e(t,i){const r=this.getView().getBindingContext();if(this._contextIsRelevant(t,r)){return true}return!!this._findRelevantContext(t,r)};r._contextIsRelevant=function t(i,r){if(r?.getPath()===i||r?.getCanonicalPath()===i){return true}const o=r.getModel();const s=o.getMetaModel();const n=o.getDependentBindings(r);const c=r.getObject()?.IsActiveEntity;for(const t of n){const o=t.getPath()??"";if(o.startsWith("@$ui5")||!!c&&o.includes("DraftAdministrativeData/")){continue}try{const e=s.fetchUpdateData(o,r).getResult();if(e?.entityPath===i||"/"+e?.editUrl===i){return true}}catch(t){e.debug(`Error while checking ${o} on page context `,t)}}return false};r._findRelevantContext=function e(t,i){if(this._contextIsRelevant(t,i)){return i}const r=i.getModel().getDependentBindings(i);for(const e of r){if(e.isA("sap.ui.model.odata.v4.ODataContextBinding")){if(this._contextIsRelevant(t,e.getBoundContext())){return e.getBoundContext()}}else if(e.isA("sap.ui.model.odata.v4.ODataListBinding")){const i=e.getAllCurrentContexts();for(const e of i){if(this._contextIsRelevant(t,e)){return e}}}}};r.getDataRefreshText=function e(){const t=ae(this.getView());return t.getText("C_SERVER_EVENTS_NEW_DATA_ITEM")};r.notifyDataRefresh=function e(){n.show(this.base.getView().getController()._sideEffects.getDataRefreshText())};r.confirmDataRefresh=async function e(){if(!this.isConfirmationDialogOpen){return new Promise((e,t)=>{const i=this.getDataRefreshText();const r=ae(this.getView());const n=new s({title:r.getText("WARNING"),state:"Warning",content:new c({text:i}),beginButton:new o({text:r.getText("C_COMMON_SAPFE_REFRESH"),press:()=>{n.close();e()}}),endButton:new o({text:r.getText("C_COMMON_DIALOG_CANCEL"),press:()=>{n.close();t()}}),afterClose:()=>{n.destroy();this.isConfirmationDialogOpen=false}});n.addStyleClass("sapUiContentPadding");this.isConfirmationDialogOpen=true;n.open()})}return Promise.reject()};r.requestMultipleSideEffects=async function e(t,i,r){let o=new Set;let s=new Set;const n=t.reduce((e,t)=>{const i=t.triggerAction;if(i){e.push(i)}return e},[]);const c=this.triggerCallbacks.bind(this);for(const e of n){this._sideEffectsService.executeAction(e,i,{groupId:r})}for(const e of t){o=(e.targetProperties??[]).reduce((e,t)=>e.add(t),o);s=(e.targetEntities??[]).reduce((e,t)=>e.add(t.$NavigationPropertyPath),s)}return this._sideEffectsService.requestSideEffects([...Array.from(o),...Array.from(s).map(e=>({$NavigationPropertyPath:e}))],i,r).then(async function e(){return c(Array.from(s))}).catch(e=>{this.registerFailedSideEffects(t,i);throw e})};r.getRegisteredFailedRequests=function e(){return this._registeredFailedSideEffects};r.registerFailedSideEffects=function e(t,i){const r=i.getPath();this._registeredFailedSideEffects[r]=this._registeredFailedSideEffects[r]??[];for(const e of t){const t=this._registeredFailedSideEffects[r].every(t=>e.fullyQualifiedName!==t.fullyQualifiedName);if(t){this._registeredFailedSideEffects[r].push(e)}}};r.unregisterFailedSideEffectsForAContext=function e(t){delete this._registeredFailedSideEffects[t]};r.unregisterFailedSideEffects=function e(t,i){const r=i.getPath();if(this._registeredFailedSideEffects[r]?.length){this._registeredFailedSideEffects[r]=this._registeredFailedSideEffects[r].filter(e=>e.fullyQualifiedName!==t)}};r.registerFieldGroupSideEffects=function e(t,i){const r=this._getFieldGroupIndex(t.name,t.context);if(!this._registeredFieldGroupMap[r]){this._registeredFieldGroupMap[r]={promise:i??Promise.resolve(),sideEffectProperty:t}}};r.unregisterFieldGroupSideEffects=function e(t){const{context:i,name:r}=t;const o=this._getFieldGroupIndex(r,i);delete this._registeredFieldGroupMap[o]};r.getRegisteredSideEffectsForFieldGroup=function e(t){const i=[];for(const e of Object.keys(this._registeredFieldGroupMap)){if(e.startsWith(`${t}_`)){i.push(this._registeredFieldGroupMap[e])}}return i};r.getRegisteredSideEffectsForContext=function e(t){const i=[];for(const e of Object.keys(this._registeredFieldGroupMap)){if(this._registeredFieldGroupMap)if(e.includes(`_${t.getPath()}`)){i.push(this._registeredFieldGroupMap[e])}}return i};r._getFieldGroupIndex=function e(t,i){return`${t}_${i.getPath()}`};r._getSideEffectsPropertyForFieldGroup=function e(t){const i=t.includes(_e),r=t.replace(_e,""),o=r.split("#"),s=o[0],n=`${s}@com.sap.vocabularies.Common.v1.SideEffects${o.length===2?`#${o[1]}`:""}`,c=this._sideEffectsService.getODataEntitySideEffects(s)?.[n];return{name:r,immediate:i,sideEffects:c,sideEffectEntityType:s}};r._manageSideEffectsFromField=async function t(i){const r=this.getFieldSideEffectsMap(i);try{const e={};const t=(t,i)=>{const r=t.getPath();if(e[r]){e[r].sideEffects.push(i)}else{e[r]={context:t,sideEffects:[i]}}};for(const e of Object.values(r).filter(e=>e.immediate===true)){this.unregisterFailedSideEffects(e.sideEffects.fullyQualifiedName,e.context);t(e.context,e.sideEffects)}for(const e of[i.getBindingContext(),this._view.getBindingContext()].filter(e=>!!e)){const i=e.getPath();const r=this._registeredFailedSideEffects[i]??[];this.unregisterFailedSideEffectsForAContext(i);for(const i of r){t(e,i)}}await Promise.all(Object.values(e).map(async e=>e.sideEffects.length===1?this.requestSideEffects(e.sideEffects[0],e.context):this.requestMultipleSideEffects(e.sideEffects,e.context)))}catch(t){e.debug(`Error while managing Field SideEffects`,t)}};r.triggerCallbacks=async function e(t){await Promise.all(t.map(e=>{const t=this._sideEffectsService.getRegisteredCallback(e);if(t){return t()}return Promise.resolve()}))};r._requestFieldGroupSideEffects=async function t(i){this.unregisterFieldGroupSideEffects(i.sideEffectProperty);try{await i.promise}catch(t){e.debug(`Error while processing FieldGroup SideEffects`,t);return}try{const{sideEffects:e,context:t,name:r}=i.sideEffectProperty;if(this.isFieldGroupValid(r,t)){await this.requestSideEffects(e,t)}}catch(t){e.debug(`Error while executing FieldGroup SideEffects`,t)}};r._saveFieldPropertiesStatus=function e(t,i){const r=this.getFieldSideEffectsMap(t);Object.keys(r).forEach(e=>{const{name:o,immediate:s,context:n}=r[e];if(!s){const e=this._getFieldGroupIndex(o,n);if(i){delete this._fieldGroupInvalidity[e]?.[t.getId()]}else{this._fieldGroupInvalidity[e]={...this._fieldGroupInvalidity[e],...{[t.getId()]:true}}}}})};return i}(f),me(de.prototype,"onInit",[u],Object.getOwnPropertyDescriptor(de.prototype,"onInit"),de.prototype),me(de.prototype,"addControlSideEffects",[g,h],Object.getOwnPropertyDescriptor(de.prototype,"addControlSideEffects"),de.prototype),me(de.prototype,"removeControlSideEffects",[E,y],Object.getOwnPropertyDescriptor(de.prototype,"removeControlSideEffects"),de.prototype),me(de.prototype,"getContextForSideEffects",[F,S],Object.getOwnPropertyDescriptor(de.prototype,"getContextForSideEffects"),de.prototype),me(de.prototype,"waitForSideEffectExecutions",[m,_],Object.getOwnPropertyDescriptor(de.prototype,"waitForSideEffectExecutions"),de.prototype),me(de.prototype,"getFieldSideEffectsMap",[v,C],Object.getOwnPropertyDescriptor(de.prototype,"getFieldSideEffectsMap"),de.prototype),me(de.prototype,"getSideEffectsMapForFieldGroups",[x,P],Object.getOwnPropertyDescriptor(de.prototype,"getSideEffectsMapForFieldGroups"),de.prototype),me(de.prototype,"clearFieldGroupsValidity",[O,b],Object.getOwnPropertyDescriptor(de.prototype,"clearFieldGroupsValidity"),de.prototype),me(de.prototype,"isFieldGroupValid",[w,G],Object.getOwnPropertyDescriptor(de.prototype,"isFieldGroupValid"),de.prototype),me(de.prototype,"getTargetProperty",[D,M],Object.getOwnPropertyDescriptor(de.prototype,"getTargetProperty"),de.prototype),me(de.prototype,"prepareDeferredSideEffectsForField",[j,R],Object.getOwnPropertyDescriptor(de.prototype,"prepareDeferredSideEffectsForField"),de.prototype),me(de.prototype,"handleFieldChange",[I,A],Object.getOwnPropertyDescriptor(de.prototype,"handleFieldChange"),de.prototype),me(de.prototype,"handleFieldGroupChange",[T,q],Object.getOwnPropertyDescriptor(de.prototype,"handleFieldGroupChange"),de.prototype),me(de.prototype,"handlePageChangeContext",[B,$],Object.getOwnPropertyDescriptor(de.prototype,"handlePageChangeContext"),de.prototype),me(de.prototype,"requestSideEffects",[N,V],Object.getOwnPropertyDescriptor(de.prototype,"requestSideEffects"),de.prototype),me(de.prototype,"requestSideEffectsForEvent",[k,z],Object.getOwnPropertyDescriptor(de.prototype,"requestSideEffectsForEvent"),de.prototype),me(de.prototype,"getDataRefreshText",[W,Q],Object.getOwnPropertyDescriptor(de.prototype,"getDataRefreshText"),de.prototype),me(de.prototype,"getRegisteredFailedRequests",[U,L],Object.getOwnPropertyDescriptor(de.prototype,"getRegisteredFailedRequests"),de.prototype),me(de.prototype,"registerFailedSideEffects",[H,J],Object.getOwnPropertyDescriptor(de.prototype,"registerFailedSideEffects"),de.prototype),me(de.prototype,"unregisterFailedSideEffectsForAContext",[K,X],Object.getOwnPropertyDescriptor(de.prototype,"unregisterFailedSideEffectsForAContext"),de.prototype),me(de.prototype,"unregisterFailedSideEffects",[Y,Z],Object.getOwnPropertyDescriptor(de.prototype,"unregisterFailedSideEffects"),de.prototype),me(de.prototype,"registerFieldGroupSideEffects",[ee,te],Object.getOwnPropertyDescriptor(de.prototype,"registerFieldGroupSideEffects"),de.prototype),me(de.prototype,"unregisterFieldGroupSideEffects",[ie,re],Object.getOwnPropertyDescriptor(de.prototype,"unregisterFieldGroupSideEffects"),de.prototype),me(de.prototype,"getRegisteredSideEffectsForFieldGroup",[oe,se],Object.getOwnPropertyDescriptor(de.prototype,"getRegisteredSideEffectsForFieldGroup"),de.prototype),me(de.prototype,"getRegisteredSideEffectsForContext",[ne,ce],Object.getOwnPropertyDescriptor(de.prototype,"getRegisteredSideEffectsForContext"),de.prototype),de))||fe);return ve},false);
//# sourceMappingURL=SideEffects.js.map