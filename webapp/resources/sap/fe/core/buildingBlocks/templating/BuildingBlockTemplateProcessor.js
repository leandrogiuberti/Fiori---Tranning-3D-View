/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/base/util/uid","sap/fe/base/BindingToolkit","sap/fe/base/jsx-runtime/jsx","sap/fe/core/buildingBlocks/templating/AttributeModel","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/helpers/TypeGuards","sap/ui/base/BindingInfo","sap/ui/core/util/XMLPreprocessor","sap/ui/model/json/JSONModel","../TraceInfo"],function(e,t,n,i,o,s,r,a,l,c,u,d){"use strict";var f={};var p=a.isFunctionArray;var m=a.isContext;var g=r.Placement;var h=i.isUndefinedExpression;var b=i.isBindingToolkitExpression;var y=i.compileExpression;const x="sap.fe.core.buildingBlocks.templating.BuildingBlockTemplateProcessor";const C="http://schemas.sap.com/sapui5/extension/sap.ui.core.template/1";const $=new DOMParser;function w(e,t,n,i){const o=t[i];const s=o?.getObject();if(n.required===true&&(!o||s===null)){throw new Error(`${e}: Required metadataContext '${i}' is missing`)}else if(s){if(s.hasOwnProperty("$kind")&&s.$kind!==undefined&&n.expectedTypes!==undefined){if(!n.expectedTypes.includes(s.$kind)){throw new Error(`${e}: '${i}' must be '$kind' '${n.expectedTypes}' but is '${s.$kind}': ${o.getPath()}`)}}else if(s.hasOwnProperty("$Type")&&s.$Type!==undefined&&n.expectedAnnotationTypes){if(!n.expectedAnnotationTypes.includes(s.$Type)){throw new Error(`${e}: '${i}' must be '$Type' '${n.expectedAnnotationTypes}' but is '${s.$Type}': ${o.getPath()}`)}}}}function A(t,n,i,o){const s=n.metadataContexts&&Object.keys(n.metadataContexts)||[],r=n.properties&&Object.keys(n.properties)||[],a={};const l=o.getAttributeNames();for(const e of l){a[e]=true}s.forEach(function(e){const o=n.metadataContexts[e];w(t,i,o,e);delete a[e]});r.forEach(function(e){const i=n.properties[e];if(!o.hasAttribute(e)){if(i.required&&!i.hasOwnProperty("defaultValue")){throw new Error(`${t}: `+`Required property '${e}' is missing`)}}else{delete a[e]}});Object.keys(a).forEach(function(n){if(!n.includes(":")&&!n.startsWith("xmlns")){e.warning(`Unchecked parameter: ${t}: ${n}`,undefined,x)}})}f.validateMacroSignature=A;const P="sap.ui.core.Element";const k="sap.ui.model.Context";f.SAP_UI_MODEL_CONTEXT=k;function N(e){const t={class:{type:"string",isPublic:true}};const n={dependents:{type:P,slot:"dependents",isPublic:true},customData:{type:P,slot:"customData",isPublic:true},layoutData:{type:P,slot:"layoutData",isPublic:true},...e.aggregations};const i={};for(const n of Object.keys(e.properties)){const o=e.properties[n].type;if(o!==k){t[n]=e.properties[n]}if([k,"object","array"].includes(o)){i[n]=e.properties[n]}}return{...e,properties:t,metadataContexts:i,aggregations:n}}function E(e,t){let n;if(t&&t.startsWith("/")){n=t}else{let i=e.currentContextPath.getPath();if(!i.endsWith("/")){i+="/"}n=i+t}return{model:"metaModel",path:n}}function O(e,t,n){let i;if(n.startsWith("/uid--")&&!e.models.converterContext.getProperty(n)){const t=U(n);e.models.converterContext.setProperty(n,t);i={model:"converterContext",path:n}}else if(t==="metaPath"&&e.currentContextPath||t==="contextPath"){i=E(e,n)}else if(n&&n.startsWith("/")){i={model:"metaModel",path:n}}else{i={model:"metaModel",path:e.bindingContexts.entitySet?e.bindingContexts.entitySet.getPath(n):n}}return i}function T(e,t,n,i,o,s){let r;if(!o&&t.hasAttribute(n)){let o=t.getAttribute(n);r=l.parse(o);if(r&&n==="metaPath"&&r.model&&r.path){const e=`${r.model}>${r.path}`;const t=i.getContext(e);if(t?.getModel()?.isA("sap.ui.model.json.JSONModel")){o=t.getObject();r=undefined}}if(!r){r=O(e,n,o)}}else if(e.bindingContexts.hasOwnProperty(n)){r={model:n,path:""}}else if(s){try{if(i.getContext(`${n}>`)){r={model:n,path:""}}}catch(e){return undefined}}return r}async function v(n,i,o,s){const r=n.properties;const a=Object.keys(r);const l={};for(const n of a){if(r[n].type==="object"){l[n]=r[n].defaultValue&&t(r[n].defaultValue)}else{l[n]=r[n].defaultValue}if(i.hasAttribute(n)&&o&&r[n].isPublic!==true){e.error(`Property ${n} was ignored as it is not intended for public usage`)}else if(i.hasAttribute(n)){await s.visitAttribute(i,i.attributes.getNamedItem(n));let e=i.getAttribute(n);if(e!==undefined&&e!==null){if(typeof e==="string"&&!e.startsWith("{")){switch(r[n].type){case"boolean":e=e==="true";break;case"number":e=Number(e);break}}e=e===null?undefined:e;l[n]=e}}}return l}function j(e,t,n,i,o,s,r){t.currentContextPath=t.bindingContexts.contextPath;const a={};const l=e.metadataContexts;const c=Object.keys(l);const u=c.indexOf("contextPath");if(u!==-1){const e=c.splice(u,1);c.splice(0,0,e[0])}for(const u of c){const c=r[u];if(c!==undefined&&typeof c==="object"&&Object.keys(c).length>0){delete e.metadataContexts[u];continue}const d=i&&l[u].isPublic===false&&n.hasAttribute(u);const f=T(t,n,u,o,d,e.isOpen??false);if(f){f.name=u;W(s,o,f);if((u==="entitySet"||u==="contextPath")&&!t.bindingContexts.hasOwnProperty(u)){t.bindingContexts[u]=s[u]}if(u==="contextPath"){t.currentContextPath=s[u]}if(s[u]!==undefined){r[u]=s[u]}else if(typeof r[u]==="string"){delete e.metadataContexts[u]}}else{a[u]=true}}return a}async function S(t,i,o){const s={};if(i&&i.children.length>0){const r=i.firstElementChild;if(r?.namespaceURI===C){const e=r.parentNode;if(e){await t.visitNode(r)}}const a=i.children;for(let t=0;t<a.length;t++){const i=a[t];let r=i.getAttribute("key")||i.getAttribute("id")||o?.skipKey&&o.multiple===false&&n();if(r){r=`InlineXML_${r}`;i.setAttribute("key",r);let e={key:r,position:{placement:i.getAttribute("placement")||g.After,anchor:i.getAttribute("anchor")||undefined},type:"Slot"};if(o?.processAggregations){e=o.processAggregations(i,e)}s[e.key]=e}else if(i.tagName!=="slot"){e.error(`The aggregation ${i.nodeName} is missing a Key attribute. It is not displayed`)}}}return s}function B(e){const t=e.children;const n=[];const i={};for(const t of e.getAttributeNames()){i[t]=e.getAttribute(t)}if(t.length>0){const e=Object.keys(t).map(e=>t[e].localName);const o=e.length!==new Set(e).size;for(const e of t){if(o){n.push(B(e))}else{i[e.localName]=B(e)}}if(o){return n}}return i}async function M(e,t,n,i,o){const s={};if(e.firstElementChild!==null){let r=e.firstElementChild;while(r!==null){if(r.namespaceURI===C){const e=r.parentNode;if(e){const n=Array.from(e.children).indexOf(r);await t.visitNode(r);r=e.children[n]?e.children[n]:null}else{r=r.nextElementSibling}}else{const e=r.localName;let i=e;if(i[0].toUpperCase()===i[0]){i=n.defaultAggregation||""}const s=n.aggregations[i];if(s!==undefined&&!s.slot){const e=await S(t,r,s);o[i]=e;for(const t in e){n.aggregations[t]=e[t]}}r=r.nextElementSibling}}r=e.firstElementChild;while(r!==null){const a=r.nextElementSibling;const l=r.localName;let c=l;if(c[0].toUpperCase()===c[0]){c=n.defaultAggregation||""}if(Object.keys(n.aggregations).includes(c)&&(!i||n.aggregations[c].isPublic===true)){const i=n.aggregations[c];if(!i.slot&&r!==null&&r.children.length>0){await t.visitNode(r);let n=r.firstElementChild;while(n){const t=n.nextElementSibling;if(!i.hasVirtualNode){const t=document.createElementNS(e.namespaceURI,n.getAttribute("key"));t.appendChild(n);s[n.getAttribute("key")]=t}else{s[n.getAttribute("key")]=n}n.removeAttribute("key");n=t}}else if(i.slot){await t.visitNode(r);if(c!==l){if(!s[c]){const t=document.createElementNS(e.namespaceURI,c);s[c]=t}s[c].appendChild(r.cloneNode(true))}else{s[c]=r.cloneNode(true)}}}else if(Object.keys(n.properties).includes(c)){await t.visitNode(r);if(n.properties[c].type==="object"){const e=B(r);o[c]=e}else if(n.properties[c].type==="array"){if(r!==null&&r.children.length>0){const e=r.children;const t=[];for(let n=0;n<e.length;n++){const i=e[n];const o={};const s=i.getAttributeNames();for(const e of s){o[e]=i.getAttribute(e)}t.push(o)}o[c]=t}}}r=a}}return s}function I(e,t,n){let i=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;if(Object.keys(e).length>0){Object.keys(e).forEach(function(o){const s=e[o];if(n!==null&&n!==undefined&&s){const e=s.firstElementChild;if(!["dependents","customData","layoutData"].includes(o)){const i=t[o]!==undefined&&t[o].slot||o;const s=n.querySelector(`slot[name='${i}']`);if(s!==null){const t=L(n,o,e);s.replaceWith(...t.children)}}else if(i&&e!==null){const i=t[o]!==undefined&&t[o].slot||o;const s=n.querySelector(`slot[name='${i}']`);const r=L(n,o,e);if(s!==null){s.replaceWith(...r.children)}else{n.appendChild(r)}}}})}}function L(e,t,n){const i=document.createElementNS(e.namespaceURI,t.replace(/:/gi,"_"));while(n){const e=n.nextElementSibling;i.appendChild(n);n=e}return i}async function D(t,n,i){let r=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;const a=N(t.metadata);const l=a.fragment??`${a.namespace??a.publicNamespace}.${a.xmlTag??a.name}`;const c={};const f=i.getSettings();f.models.converterContext??=new u;if(!f[l]){f[l]={}}const p=await v(a,n,r,i);const g=Object.keys(p);const h=j(a,f,n,r,i,c,p);try{const u=await M(n,i,a,r,p);let g={};if(f.models.viewData){g=f.models.viewData.getProperty("/controlConfiguration")}let h=p;Object.keys(p).forEach(e=>{let n=p[e];const i=t?.metadata?.properties[e];if(i?.validate){n=i.validate(n)||n}if(n?.isA?.(k)&&!n.getModel().isA("sap.ui.model.odata.v4.ODataMetaModel")){p[e]=n.getObject()}});p.isPublic=r;const b=new t({...p,...u},g,f);h=b.getProperties();Object.keys(a.metadataContexts).forEach(function(e){if(h.hasOwnProperty(e)){const t=h[e];if(m(t)){c[e]=t}else if(typeof t==="object"){const n=R(t);f.models.converterContext.setProperty(n,t);const i=f.models.converterContext.createBindingContext(n);U(n);c[e]=i}}});const y=new s(n,h,t);c["this"]=y.createBindingContext("/");let x;const C=n?.getAttribute("core:require")||undefined;if(d.isTraceInfoActive()){const e=d.traceMacroCalls(l,a,c,n,i);if(e?.macroInfo){x=f["_macroInfo"];f["_macroInfo"]=e.macroInfo}}A(l,a,c,n);const $=i.with(c,a.isOpen!==undefined?!a.isOpen:true);const w=n.parentNode;let P;let N;if(w){P=Array.from(w.children).indexOf(n);if(a.fragment){N=$.insertFragment(l,n)}else{const i=Object.keys(X);const s=await o.renderAsXML(async()=>b.getTemplate(n));if(t.isRuntime){for(const e in X){if(!i.includes(e)){const t=U(e);f.models.converterContext.setProperty(e,t)}}}let r="";if(s){let t=false;let i=G(s,true);for(const e of i){const n=document.createNodeIterator(e,NodeFilter.SHOW_TEXT);let i=n.nextNode();if(e.localName==="parsererror"){t=true}while(i){if(i.textContent&&i.textContent.trim().length>0){r=i.textContent}i=n.nextNode()}}if(t){e.error(`Error while processing building block ${a.xmlTag||a.name}`,r);i=await H(async()=>{const e=await o.renderAsXML(async()=>b.getTemplate(n));return G(e??"",true)})}else if(r.length>0){e.error(`Error while processing building block ${a.xmlTag||a.name}`);const t=F([`Error while processing building block ${a.xmlTag||a.name}`,`Trailing text was found in the XML: ${r}`],i.map(e=>e.outerHTML).join("\n"));i=G(t,true)}n.replaceWith(...i);const l=i.map(async e=>{I(u,a.aggregations,e,false);return $.visitNode(e)});N=Promise.all(l)}else{n.remove();N=Promise.resolve()}}await N;const i=w.children[P];I(u,a.aggregations,i,true);if(i!==undefined){const e=i.querySelectorAll("slot");e.forEach(function(e){e.remove()});if(C){let e=i.getAttributeNS("sap.ui.core","require");if(e){e=e.substring(0,e.length-1)+","+C.substring(1)}else{e=C}i.setAttributeNS("sap.ui.core","core:require",e)}if(p.class&&!t.isRuntime){i.classList.add(p.class)}}}if(x){f["_macroInfo"]=x}else{delete f["_macroInfo"]}}catch(t){const i={initialProperties:{},resolvedProperties:{},missingContexts:h};for(const e of g){const t=p[e];if(m(t)){i.initialProperties[e]={path:t.getPath(),value:t.getObject()}}else{i.initialProperties[e]=t}}for(const e in p){const t=p[e];if(!g.includes(e)){if(m(t)){i.resolvedProperties[e]={path:t.getPath(),value:t.getObject()}}else{i.resolvedProperties[e]=t}}}e.error(t);const o=F([`Error while processing building block ${a.name}`],n.outerHTML,i,t.stack);const s=G(o,true);n.replaceWith(...s)}}function W(e,t,n){const i=n.name||n.model||undefined;if(e[i]){return}try{let o=n.path;if(n.model!==null){o=`${n.model}>${o}`}const s=t.getSettings();if(n.model==="converterContext"&&n.path.length>0){e[i]=s.models[n.model].getContext(n.path)}else if(!s.bindingContexts[n.model]&&s.models[n.model]){e[i]=s.models[n.model].getContext(n.path)}else{e[i]=t.getContext(o)}}catch(e){}}function V(e){if(e.metadata.namespace!==undefined){c.plugIn(async(t,n)=>D(e,t,n),e.metadata.namespace,e.metadata.xmlTag||e.metadata.name)}if(e.metadata.publicNamespace!==undefined){c.plugIn(async(t,n)=>D(e,t,n,true),e.metadata.publicNamespace,e.metadata.xmlTag||e.metadata.name)}}f.registerBuildingBlock=V;function q(e){if(e.metadata.namespace!==undefined){c.plugIn(null,e.metadata.namespace,e.metadata.xmlTag||e.metadata.name)}if(e.metadata.publicNamespace!==undefined){c.plugIn(null,e.metadata.publicNamespace,e.metadata.xmlTag||e.metadata.name)}}f.unregisterBuildingBlock=q;function F(e,t,n,i){const o=e.map(e=>z`<m:Label text="${J(e)}"/>`);let s="";if(i){const e=btoa(`<pre>${i}</pre>`);s=z`<m:FormattedText htmlText="{= BBF.base64Decode('${e}') }" />`}let r="";if(n){let e="";try{e=btoa(JSON.stringify(n,null,4))}catch(t){e=btoa(JSON.stringify({error:"Could not stringify additionalData due to circular structure."},null,4))}r=z`<m:VBox>
			<m:Label text="Trace Info"/>
			<code:CodeEditor type="json"  value="${`{= BBF.base64Decode('${e}') }`}" height="300px" />
		</m:VBox>`}return z`<controls:FormElementWrapper xmlns:controls="sap.fe.core.controls">
					<m:VBox xmlns:m="sap.m" xmlns:code="sap.ui.codeeditor" core:require="{BBF:'sap/fe/core/buildingBlocks/templating/BuildingBlockFormatter'}">
					${o}
					${s}
						<grid:CSSGrid gridTemplateRows="fr" gridTemplateColumns="repeat(2,1fr)" gridGap="1rem" xmlns:grid="sap.ui.layout.cssgrid" >
							<m:VBox>
								<m:Label text="How the building block was called"/>
								<code:CodeEditor type="xml" value="${`{= BBF.base64Decode('${btoa(t.replaceAll("&gt;",">"))}') }`}" height="300px" />
							</m:VBox>
							${r}
						</grid:CSSGrid>
					</m:VBox>
				</controls:FormElementWrapper>`}const X={};function R(e){const t=`/uid--${n()}`;X[t]=e;return t}f.storeObjectValue=R;function U(e){const t=X[e];delete X[e];return t}let _=false;const H=async function(e){_=true;let t;try{t=e()}finally{_=false}return t};function G(e){let t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(t){e=`<template\n\t\t\t\t\t\txmlns:template="http://schemas.sap.com/sapui5/extension/sap.ui.core.template/1"\n\t\t\t\t\t\txmlns:m="sap.m"\n\t\t\t\t\t\txmlns:macros="sap.fe.macros"\n\t\t\t\t\t\txmlns:core="sap.ui.core"\n\t\t\t\t\t\txmlns:mdc="sap.ui.mdc"\n\t\t\t\t\t\txmlns:customData="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1">${e}</template>`}const n=$.parseFromString(e,"text/xml");let i=n.firstElementChild;while(i?.localName==="template"){i=i.firstElementChild}const o=i?.parentElement?i?.parentElement.children:[i];return Array.from(o)}f.parseXMLString=G;function J(e){return e?.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}f.escapeXMLAttributeValue=J;function K(e){const t=G(e,true);if(t?.length>0&&t[0]?.localName==="parsererror"){const n=t[0].innerText||t[0].innerHTML;return F([n.split("\n")[0]],e)}else{return e}}const z=function(e){let t="";let n;for(var i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++){o[s-1]=arguments[s]}for(n=0;n<o.length;n++){t+=e[n];const i=o[n];if(Array.isArray(i)&&i.length>0&&typeof i[0]==="string"){t+=i.flat(5).join("\n").trim()}else if(p(i)){t+=i.map(e=>e()).join("\n")}else if(b(i)){const e=y(i);t+=J(e)}else if(typeof i==="undefined"){t+="{this>undefinedValue}"}else if(typeof i==="function"){t+=i()}else if(typeof i==="object"&&i!==null){if(m(i)){t+=i.getPath()}else{const e=R(i);t+=`${e}`}}else if(i&&typeof i==="string"&&!i.startsWith("<")&&!i.startsWith("&lt;")){t+=J(i)}else{t+=i}}t+=e[n];t=t.trim();if(_){return K(t)}return t};f.xml=z;const Q=function(e,t){if(e){return t}else{return""}};f.addConditionallyToXML=Q;const Y=function(e,t){if(t!==undefined&&!h(t)){return()=>z`${e}="${t}"`}else{return()=>""}};f.addAttributeToXML=Y;return f},false);
//# sourceMappingURL=BuildingBlockTemplateProcessor.js.map