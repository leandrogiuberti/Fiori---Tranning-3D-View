/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/converters/MetaModelConverter","sap/m/MessageBox","sap/ui/core/Lib","sap/ui/core/Messaging","sap/ui/core/util/PasteHelper","../converters/ManifestSettings","../templating/UIFormatters"],function(e,t,n,o,r,s,a,i){"use strict";var l=i.FieldEditMode;var g=a.CreationMode;const u=function(e,t,n,o){let r=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;let s=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;const a=n.getProperty(e),i={parseKeepsEmptyString:true},l=o.getUI5Type(`${t}/${e}`,i);let g,u;if(r===true){g=!a;u=n.getProperty(`${e}@Org.OData.Core.V1.Computed`)}else{g=!a||n.getProperty(`${e}@Org.OData.Core.V1.Computed`)}return{property:e,ignore:s||g,computed:u,type:l}};const c=function(e){const t=[...e];const r=o.getResourceBundleFor("sap.fe.core"),s=r.getText("C_PASTE_HELPER_SAPFE_PASTE_ERROR_CORRECTION_MESSAGE"),a=r.getText("C_PASTE_HELPER_SAPFE_PASTE_ERROR_CORRECTION_NOTE");let i;if(t.length>1){i=r.getText("C_PASTE_HELPER_SAPFE_PASTE_ERROR_MESSAGE_PLURAL",[t.length])}else{i=r.getText("C_PASTE_HELPER_SAPFE_PASTE_ERROR_MESSAGE_SINGULAR")}t.unshift("");t.unshift(a);t.unshift(s);n.error(i,{title:r.getText("C_COMMON_SAPFE_ERROR_MESSAGES_PAGE_TITLE_ERROR"),details:t.join("<br>")})};const f={displayErrorMessages:c,formatCustomMessage:function(e,t){let n="";const r=e.length;const s=o.getResourceBundleFor("sap.fe.core"),a=s.getText("T_MESSAGE_GROUP_DESCRIPTION_TABLE_ROW");if(r>0){n+=`${a} ${t}: `;e.forEach((e,t)=>{if(e.messageText){n+=e.messageText+(t+1!==r?" ":"")}})}return n},getColumnInfo:function(e,n){let o=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;const r=e.getRowBinding().getModel(),s=r.getMetaModel(),a=r.resolve(e.getRowBinding().getPath(),e.getRowBinding().getContext()),i=s.getMetaContext(a),l=t.getInvolvedDataModelObjects(i).targetEntityType.entityProperties,g=[],u=e.getParent().getTableDefinition();function c(e,t,n){if(e.text&&t){g.push(e.text)}if(e.exportSettings!==null){if(o&&n.includes("/")){return{property:e.path,ignore:true}}else{let t=false;if(e.path){t=g.includes(e.path)}return f.getInfoForEntityProperty(e.path,a,i,s,u.control.enablePastingOfComputedProperties,t)}}}const p=e.getParent().getEnhancedFetchedPropertyInfos();const d=Object.assign({},...p.map(e=>({[e.key]:e})));const h=[];(n??e.getColumns()).forEach(e=>{const t=d[e.getPropertyKey()];if(t.propertyInfos){t.propertyInfos.forEach(e=>{const t=d[e],n=this.hasValueHelpProperty(l,t),o=c(t,n,e);if(o){h.push(o)}});if(t.exportDataPointTargetValue){h.push({property:"targetValueFromDataPoint",ignore:true})}}else if(t.exportSettings!==null){if(t.path){h.push(f.getInfoForEntityProperty(t.path,a,i,s,u.control.enablePastingOfComputedProperties))}else{h.push({property:"unused",type:null,ignore:true})}}});return h},getInfoForEntityProperty:u,hasValueHelpProperty:function(e,t){const n=e.find(e=>e.name===t.path);if(n){return!!n.annotations?.Common?.ValueList}return false},parsePastedData:async function(e,t,n){let o=arguments.length>3&&arguments[3]!==undefined?arguments[3]:true;const r=this.getColumnInfo(t,n,o);const a=t.getParent().getTableDefinition();const i=e.length?e[0].length:0;let l=-1;for(let e=0;e<r.length&&l<0;e++){if(!r[e].ignore&&!r[e].computed){l=e}}if(a.control.enablePastingOfComputedProperties){const t=r.filter(function(e){return e.computed});t.forEach(function(t){const n=r.indexOf(t);const o=e.every(e=>e[n]==="");if(o){t.ignore=true}})}const g=await(l<0||l>i-1?{parsedData:[],errors:null}:s.parse(e,r));if(g.errors){const e=g.errors.map(function(e){return e.message});this.displayErrorMessages(e);return[]}else{return g.parsedData}},_updateContexts:async function(t,n,o){let r=0;const s=[];for(const a of o){const o=n[r++];if(o){for(const n in a){if(t.getParent().getPropertyEditMode(n,o)===l.Editable){s.push(o.setProperty(n,a[n]))}else{e.warning(`Property ${n} is not editable for row ${o.getIndex()}`)}}}}await Promise.allSettled(s)},getPasteInformationForReponsiveTable:function(e,t,n,o){let r=0;const s=o.getRowBinding().getCurrentContexts().findIndex(e=>e.isTransient());const a=t.rows;let i=0;const l=t.columns.length>1?t.columns:o.getColumns().slice(o.getColumns().indexOf(t.columns[0]));if(t.columns.length===1&&t.rows.length===1){if(n<=s&&n+e.length>s){r=e.length-(s-n)-1;i=e.length}else{r=0;i=e.length}}else{const n=a.filter(e=>e.isTransient())?.pop();const o=n?a.indexOf(n):-1;i=Math.min(e.length,t.rows.length);if(o>-1){i=o===t.rows.length-1?e.length:i;r=o===t.rows.length-1?e.length-o-1:0}}return{rows:a,columns:l,updatedRowCount:i,numberOfNewCreationRows:r}},getPasteInformationForGridTable:function(e,t,n,o){let r=0;const s=t.rows;let a=0;const i=o.getRowBinding().getLength();let l=t.columns.length>1?t.columns:o.getColumns().slice(o.getColumns().indexOf(t.columns[0]));if(t.columns.length===1&&t.rows.length===1){r=n+e.length>i?n+e.length-i:0;l=o.getColumns().slice(o.getColumns().indexOf(t.columns[0]));a=e.length}else{r=n+s.length>=i?n+e.length-i:0;a=r===0?Math.min(e.length,t.rows.length):e.length}return{rows:s,columns:l,updatedRowCount:a,numberOfNewCreationRows:r}},getPasteInformation:function(t,n,o,r){let s=null;switch(r.data("tableType")){case"GridTable":s=this.getPasteInformationForGridTable(t,n,o,r);break;case"ResponsiveTable":s=this.getPasteInformationForReponsiveTable(t,n,o,r);break;default:e.warning(`Paste operation is not supported for table type ${r.data("tableType")}`)}if(s&&s?.numberOfNewCreationRows>0&&r.getParent().getCreationMode().getName()!==g.InlineCreationRows){s.updatedRowCount-=s.numberOfNewCreationRows;s.numberOfNewCreationRows=0}return s},pasteRangeData:async function(e,t,n){const o=t.rows[0].getIndex();const r=this.getPasteInformation(e,t,o,n);if(!r)return;const s=await this.parsePastedData(e,n,r.columns,false);if(s.length>0){if(r.numberOfNewCreationRows>0){await n.getParent().createEmptyRows(n.getRowBinding(),n,false,r.numberOfNewCreationRows,true)}r.rows=await n.getRowBinding().requestContexts(o,r.updatedRowCount);await this._updateContexts(n,r.rows,s);const e=r.rows.find(e=>e.isTransient())?.getIndex();if(e){n.focusRow(e)}return{updatedRowCount:r.updatedRowCount,updatedColCount:Object.keys(s[0]).length,numberOfNewCreationRows:r.numberOfNewCreationRows<0?0:r.numberOfNewCreationRows,posFirstInlineCreationRow:e}}},pasteData:async function(t,n,o){const s=o.editFlow;const a=n.getParent().getTableDefinition();let i=[];return this.parsePastedData(t,n).then(async e=>{i=e||[];return Promise.all(i.map(async e=>s.validateDocument(n.getBindingContext(),{data:e,customValidationFunction:a?.control?.customValidationFunction})))}).then(e=>{const t=e.reduce(function(e,t,n){if(t.length>0){e.push({messages:t,row:n+1})}return e},[]);if(t.length>0){const e=t.map(e=>this.formatCustomMessage(e.messages,e.row));this.displayErrorMessages(e);return[]}return i}).then(async e=>{const t=n.getRowBinding().getCurrentContexts().filter(e=>e.isTransient());const i=t.pop();const l=!!r.getMessageModel().getData().find(e=>i&&e.getTargets()[0].includes(i.getPath()));const g=e.length>0?await s.createMultipleDocuments(n.getRowBinding(),e,a?.control?.createAtEnd,true,o.editFlow.onBeforeCreate):undefined;if(i&&!l){i?.delete();await n.getParent().createEmptyRows(n.getRowBinding(),n,false,1)}return g}).catch(t=>{e.error("Error while pasting data",t);return undefined})}};return f},false);
//# sourceMappingURL=PasteHelper.js.map