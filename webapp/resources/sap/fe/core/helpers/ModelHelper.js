/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/BindingToolkit","sap/fe/base/jsx-runtime/jsx","sap/fe/core/controls/Any","sap/fe/core/controls/DataWatcher","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/MetaPath","sap/fe/core/helpers/PromiseKeeper","sap/fe/core/helpers/TypeGuards","sap/ui/core/Element","sap/ui/model/BindingMode","sap/ui/model/json/JSONModel","sap/ui/model/odata/type/Raw"],function(t,e,n,o,i,a,r,s,c,d,g,l,u){"use strict";var f=c.isPathAnnotationExpression;var h=c.isNavigationProperty;var p=c.isEntitySet;var y=a.getInvolvedDataModelObjects;var m=a.convertTypes;var P=e.compileExpression;const M={disableCollaborationDraft:false,isStickySessionSupported:function(t){const e=t.getObject("/");for(const n in e){if(e[n].$kind==="EntitySet"&&t.getObject(`/${n}@com.sap.vocabularies.Session.v1.StickySessionSupported`)){return true}}return false},isDraftSupported:function(t,e){const n=t.getMetaContext(e);const o=y(n);return this.isObjectPathDraftSupported(o)},isObjectPathDraftSupported:function(t){const e=t.targetEntitySet;const n=M.isDraftRoot(e);const o=M.isDraftNode(e);const i=h(t.targetObject)&&t.targetObject?.containsTarget&&(t.startingEntitySet?.annotations?.Common?.DraftRoot||t.startingEntitySet?.annotations?.Common?.DraftNode)?true:false;const a=t.targetEntityType.keys?.some(t=>t.name==="IsActiveEntity");return n||o||!e&&i&&a},isMetaPathDraftSupported:function(t){const e=t.getClosestEntitySet();const n=M.isDraftRoot(e);const o=M.isDraftNode(e);return n||o},isCollaborationDraftSupportedFromConverterContext(t){return t.getConvertedTypes().entitySets.some(t=>t.annotations?.Common?.DraftRoot?.ShareAction!==undefined)},isCollaborationDraftSupported:function(t,e){if(!M.disableCollaborationDraft){const n=e?.context?.getModel()||t;if(n.__$feIsCollaborationDraftEnabled!==undefined){return n.__$feIsCollaborationDraftEnabled}const o=n.getObject("/");for(const t in o){if(o[t].$kind==="EntitySet"&&n.getObject(`/${t}@com.sap.vocabularies.Common.v1.DraftRoot/ShareAction`)){n.__$feIsCollaborationDraftEnabled=true;return true}}n.__$feIsCollaborationDraftEnabled=false}return false},getDraftRootPath:function(t){const e=t.getModel().getMetaModel();const n=function(t,o){let i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;const r=i?t:new RegExp(/.*(?=\/)/).exec(t)?.[0];if(r&&r!=="/"){const t=e.getMetaPath(r);const i=a.getInvolvedDataModelObjects(e.getContext(t));if(i.targetEntitySet?.annotations.Common?.DraftRoot){return r}return n(r,o,false)}return undefined};return n(t.getPath(),t.getModel())},getStickyRootPath:function(t){const e=t.getModel().getMetaModel();const n=function(t,o){let i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;const r=i?t:new RegExp(/.*(?=\/)/).exec(t)?.[0];if(r&&r!=="/"){const t=e.getMetaPath(r);const i=a.getInvolvedDataModelObjects(e.getContext(t));if(i.startingEntitySet===i.targetEntitySet&&i.targetEntitySet?.annotations?.Session?.StickySessionSupported){return r}return n(r,o,false)}return undefined};return n(t.getPath(),t.getModel())},getTargetEntitySet:function(t){const e=t.getPath();if(t.getObject("$kind")==="EntitySet"||t.getObject("$kind")==="Action"||t.getObject("0/$kind")==="Action"){return e}const n=M.getEntitySetPath(e);return`/${t.getObject(n)}`},getEntitySetPath:function(t,e){let n="";if(!e){n=`/${t.split("/").filter(M.filterOutNavPropBinding).join("/$NavigationPropertyBinding/")}`}else{const o=t.split("/").filter(M.filterOutNavPropBinding);if(o.length>1){const t={growingPath:"/",pendingNavPropBinding:""};const i=o.reduce((t,n,o)=>{const i=!!o&&"/$NavigationPropertyBinding/"||"";let{growingPath:a,pendingNavPropBinding:r}=t;const s=a+i;const c=e.getObject(s);const d=r?`${r}/${n}`:n;if(c&&Object.keys(c).length>0&&c.hasOwnProperty(d)){a=s+d.replace("/","%2F");r=""}else{r+=r?`/${n}`:n}return{growingPath:a,pendingNavPropBinding:r}},t);n=i.growingPath}else{n=`/${o[0]}`}}return n},getActionParameterItemsModelPath:function(t){return t&&t.$Name?`{path: 'mvfview>/${t.$Name}'}`:undefined},filterOutNavPropBinding:function(t){return t!==""&&t!=="$NavigationPropertyBinding"},enhanceInternalJSONModel:function(t){const e=t.bindContext;t.bindContext=function(t,n,o,i){const a=e.apply(this,[t,n,o,i]);const r=a.getBoundContext;a.getBoundContext=function(){const t=r.apply(this);if(t){t.setProperty=function(t,e){if(this.getObject()===undefined){this.getModel().setProperty(this.getPath(),{})}const n=t.split("/");let o=this.getPath().replace(/\/$/,"");for(let t=0;t<n.length-1;t++){o=`${o}/${n[t]}`;if(this.getModel().getProperty(o)===undefined){this.getModel().setProperty(o,{})}}this.getModel().setProperty(t,e,this)}}return t};return a}},enhanceUiJSONModel:function(t,e){const n=t.setProperty;t.setProperty=function(o,i,a,r){if(o==="/isEditable"){t.setProperty("/editMode",i?e.EditMode.Editable:e.EditMode.Display,a,r)}return n.apply(this,[o,i,a,r])}},enhanceViewJSONModel:function(t){const e=t._getObject;t._getObject=function(t,n){if(t===undefined||t===""){t="/"}return e.apply(this,[t,n])}},isFilteringCaseSensitive:function(t,e){const n=e??t?.getObject("/@Org.OData.Capabilities.V1.FilterFunctions");if(!n){return true}return n.indexOf("tolower")===-1},getMetaPathForContext:function(t){const e=t.getModel(),n=e.getMetaModel(),o=t.getPath();return n&&o&&n.getMetaPath(o)},getRootEntitySetPath:function(t){let e="";const n=t?t.split("/"):[];if(n.length>1){e=n[1]}return e},getAbsoluteMetaPathForListBinding:function(t,e){const n=t.getModel().getMetaModel();let o;if(typeof e==="string"){if(e.startsWith("/")){o=n.getMetaPath(e)}else{const i=t.getBindingContext();const a=i.getPath();o=n.getMetaPath(`${a}/${e}`)}}else{const i=e;const a=i.getRootBinding();if(i===a){o=n.getMetaPath(i.getPath())}else{const r=a.getPath();const s=i.getPath();if(e.getContext()===t.getBindingContext()){o=n.getMetaPath(`${r}/${s}`)}else{o=`${n.getMetaPath(e.getContext().getPath())}/${s}`}}}return o},getRelativeMetaPathForListBinding(t,e){const n=e.getContext();const o=t.getPath();if(!n){return}if(n.getPath()===o){return e.getPath()}if(n.getPath().startsWith(o)){const t=e.getModel().getMetaModel();const i=t.getMetaPath(o);return`${t.getMetaPath(n.getPath())}/${e.getPath()}`.replace(`${i}/`,"")}return},isDraftRoot:function(t){return this.getDraftRoot(t)!==undefined},isDraftNode:function(t){return this.getDraftNode(t)!==undefined},isSticky:function(t){return this.getStickySession(t)!==undefined},isUpdateHidden:function(t,e){if(p(t)){return t.annotations.UI?.UpdateHidden??e?.annotations.UI?.UpdateHidden}},getDraftRoot:function(t){return p(t)?t.annotations.Common?.DraftRoot:undefined},getDraftNode:function(t){return p(t)?t.annotations.Common?.DraftNode:undefined},getStickySession:function(t){return p(t)?t.annotations.Session?.StickySessionSupported:undefined},getDeleteHidden:function(t,e){if(p(t)){return t.annotations.UI?.DeleteHidden??e.annotations.UI?.DeleteHidden}},getAbsolutePathFromListBinding(t){const e=t.getModel().getMetaModel();let n;const o=t.getRootBinding();if(t===o){n=e.getMetaPath(t.getPath())}else{const i=o?.getPath();const a=t.getPath();n=e.getMetaPath(`${i}/${a}`)}return n},enhanceODataModel(e,i){e.virtualPropertyBindingRegistry=new Array;const s=e.setMessages;const c=new l({});c.setDefaultBindingMode(g.OneWay);const u=c.setProperty;const h=c.getProperty;c.getProperty=function(t,n){const[o,i]=t.split("@$ui5.fe.");if(n&&n.isTransient()!==true&&i==="@Common/ExternalID"){const t=n.getObject();if(t){const t=new r(m(e.getMetaModel()),e.getMetaModel().getMetaPath(n.getPath()),e.getMetaModel().getMetaPath(n.getPath()));const i=t.getMetaPathForPath(t.getPath()+"/"+o)?.getTarget().annotations.Common?.ExternalID;if(f(i)){return n.getObject(i.path)}else{return n.getObject(o)}}else{return undefined}}else if(n&&i==="contextPath"){return n.getPath()}return h.apply(this,[t,n])};c.setProperty=function(n,o,i,a){let s=n;if(i){s=i.getPath(n)}const c=()=>{this.refresh()};const[d,g]=n.split("@$ui5.fe.");if(i&&g==="@Common/ExternalID"){i.setProperty(d,o);const n=new r(m(e.getMetaModel()),e.getMetaModel().getMetaPath(i.getPath()),e.getMetaModel().getMetaPath(i.getPath()));const a=n.getMetaPathForPath(n.getPath()+"/"+d)?.getTarget().annotations.Common?.ExternalID;if(f(a)){const e=a.path;const o=[e.substring(0,e.lastIndexOf("/"))];const r=n.getMetaPathForPath(n.getPath()+"/"+e)?.getTarget().annotations.Common?.Text;if(f(r)){const t=r.path;if(t.includes("/")){o.push(t)}}i.requestSideEffects(o).then(c).catch(e=>{t.error(e)})}}const l=s.split("/");let h="";for(let t=0;t<l.length-1;t++){if(t>0){h+="/"}h+=l[t];if(this.getObject(h)===undefined){this.setProperty(h,{})}}return u.apply(this,[n,o,i,a])};function p(t,e){for(const n in e){const o=e?.[n];const i=o?.isA?.("sap.ui.model.odata.v4.Context");if(typeof o==="object"&&!i){e[n]=p(t,e[n]);if(e[n]&&Object.keys(e[n]).length===0){delete e[n]}}for(const o of t){if(n.endsWith(o)){delete e[n]}}}return e}e._localAnnotationModel=c;e.getLocalAnnotationModel=function(){return this._localAnnotationModel};e.setMessages=function(t){const e=p(["@$ui5.fe.messageType","@$ui5.fe.messageText"],this._localAnnotationModel.getData());this._localAnnotationModel.setData(e);for(const e in t){this._localAnnotationModel.setProperty(`${e}@$ui5.fe.messageType`,t[e][0].getType());this._localAnnotationModel.setProperty(`${e}@$ui5.fe.messageText`,t[e][0].getMessage())}s.apply(this,[t])};const y=e.bindProperty.bind(e);e.bindProperty=function(s,g,l){const u=i.getEnvironmentCapabilities()?.getCapabilities?.().DisableInputAssistance;const h=M.setUpRecommendationLocalModelBinding(this,y,s,g,u);if(h){return h}if(s.endsWith("@$ui5.fe.@Common/ExternalID")&&g){const n=s.split("@$ui5.fe.")[0];const o=y(n,g);const i=new r(m(e.getMetaModel()),e.getMetaModel().getMetaPath(g.getPath()),e.getMetaModel().getMetaPath(g.getPath()));const a=i.getMetaPathForPath(i.getPath()+"/"+n)?.getTarget().annotations.Common?.ExternalID;if(f(a)){const t=y(a.path,g);e.virtualPropertyBindingRegistry.push(t);const n=i.getMetaPathForPath(t.getContext()?.getPath()+"/"+a.path)?.getTarget().annotations.Common?.Text;if(f(n)){const t=y(n.path,g);e.virtualPropertyBindingRegistry.push(t)}}const c=this._localAnnotationModel.bindProperty(s,g);o.attachChange(()=>{c.refresh()});o.requestValue().then(()=>{c.refresh();return}).catch(e=>{t.error(e)});return c}if(s.includes("@$ui5.fe.")){const t=this._localAnnotationModel.bindProperty(s,g);if(s.endsWith("@$ui5.fe.@Common/ExternalID")){return t}t.updateRequired=function(t){return t&&t===e};if(s.includes("@$ui5.fe.virtual.")){const{expression:e,viewId:i}=a.getVirtualBindingExpression(s,a.convertTypes(this.getMetaModel()));const r=i?d.getElementById(i):undefined;const l=new o({any:P(e),bindBackProperty:s},r?.getController()??n.getFormatterContext());const u=t.destroy.bind(t);t.destroy=()=>{l?.destroy();return u()};const f=t.setContext;if(f){t.setContext=e=>{l?.setBindingContext(e);return f.bind(t)(e)}}l.setModel(this);const h=l.getBindingInfo("any")?.binding;const p=h?.checkUpdate;if(p){l.getBindingInfo("any").binding.checkUpdate=t=>{const e=l.getBindingContext()?.getObject()!==undefined;const n=l.getBindBackProperty();const o=e?c.getProperty(l.getBindingContext().getPath(n)):undefined;return p.bind(h)(t||n&&e&&h.getExternalValue()!==o)}}l.setBindingContext(g)}return t}return y(s,g,l)};const b=e.destroy.bind(e);e.destroy=function(){for(const t of e.virtualPropertyBindingRegistry){t.destroy()}this._localAnnotationModel.destroy();return b.apply(this)}},async evaluateVirtualExpression(t,e){const o=new s;const{expression:r,viewId:c}=a.getVirtualBindingExpression(t,a.convertTypes(e.getModel().getMetaModel()));const g=c?d.getElementById(c):undefined;const l=new i({valueChanged:function(t){o.resolve(t.getParameter("value"));t.getSource().destroy()},propertyBinding:P(r)},g?.getController()??n.getFormatterContext());l.setBindingContext(e);l.setModel(e.getModel());return o.promise},fetchTextFromMetaModel(e,n,o){let i=e!==undefined?e:"";if(e?.startsWith("{metaModel>")){const a=e.substring(11,e.length-1);try{if(n){i=n.getEntityTypeAnnotation(a).annotation?.toString()??""}else{i=o?.getObject(a)}}catch(e){t.info(`Unable to retrieve text from meta model using path ${a}`)}}return i},getMessagesPath:function(t,e){const n=t.getMetaContext(e);const o=y(n);const i=o.targetEntityType.annotations.Common?.Messages;return f(i)?i.path:undefined},setUpRecommendationLocalModelBinding:function(e,n,o,i,a){if(o.includes("ui5.fe.recommendations")){const r=e.getLocalAnnotationModel().bindProperty(o,i);const s=t=>{const e=r.setContext;if(e){r.setContext=n=>{t?.setContext(n);e.bind(t)(n);return e.bind(r)(n)}}};if(i){const{recommendationComplexProperty:c,isRecommendedProperty:d}=M.validateRecommendationBindingPath(i,o);if(c&&d&&!a){const o=e.virtualPropertyBindingRegistry.some(t=>i===t.getContext()&&c===t.getPath());if(!o){const o=n(c,i);o.setType(new u,"any");o.setBindingMode(g.OneWay);e.virtualPropertyBindingRegistry.push(o);o.attachChange(t=>{const e=t.getSource();const n=t.getSource().getContext();if(n){const t=e.getValue();M.setRecommendationsOnLocalAnnotationModel(t,n);r.refresh()}});o.requestValue().catch(e=>{t.error("Recommendations could not be resolved",e)});s(o)}}}r.updateRequired=function(t){return this.getContext()?t&&t===e:t&&this.getModel()===t};return r}},validateRecommendationBindingPath:function(t,e){const n=t.getModel().getMetaModel();const o=n.getMetaPath(t.getPath());const i=n.getMetaContext(o);const a=y(i).targetEntityType;const r=a?.annotations?.UI?.Recommendations?.path;const s=e.split("@$ui5.fe.recommendations")[0];const c=a.entityProperties.some(t=>{if(t.name===r){return t?.targetType?.properties.some(t=>s===t.name)}});return{recommendationComplexProperty:r,isRecommendedProperty:c}},setRecommendationsOnLocalAnnotationModel:function(t,e){if(t){const n=e.getModel().getLocalAnnotationModel();const o={};const i=n.getProperty("/rejectedRecommendations")||{};for(const e in t){const n=t[e];const i=e;const a=i+"@$ui5.fe.recommendations.placeholderValue";const r=i+"@$ui5.fe.recommendations.placeholderDescription";const s=i+"@$ui5.fe.recommendations.typeAheadValues";o[s]=[];for(const t of n){if(t.RecommendedFieldIsSuggestion){o[a]=t.RecommendedFieldValue;o[r]=t.RecommendedFieldDescription}if(t.RecommendedFieldValue){o[s].push(t.RecommendedFieldValue)}}if(!n||!n.length){o[a]=null;o[r]=""}}o["recommendationContext"]=e;if(!this._compareRecommendations(o,i[e.getPath()]||{})){Object.keys(o).forEach(t=>{const i=e.getPath(t);n.setProperty(i,o[t],e,false)})}}},_compareRecommendations:function(t,e){const n=Object.keys(t).filter(t=>t!=="recommendationContext");const o=Object.keys(e).filter(t=>t!=="recommendationContext");if(n.length!==o.length){return false}for(const i of n){if(!o.includes(i)){return false}if(i.includes("ui5.fe.recommendations.typeAheadValues")){const n=t[i];const o=e[i];if(!Array.isArray(n)||!Array.isArray(o)||n.length!==o.length||n.some((t,e)=>t!==o[e])){return false}}else if(t[i]!==e[i]){return false}}return true},getAlternateAndSecondaryKeys:(t,e)=>{const n=[];const o=t=>{t?.annotations?.Core?.AlternateKeys?.forEach(t=>{t.Key.forEach(t=>{n.push(t.Name.value)})})};const i=t=>{t?.annotations?.Common?.SecondaryKey?.forEach(t=>{if(!n.includes(t.value)){n.push(t.value)}})};o(e);if(!n.length){o(t)}i(t);return n}};return M},false);
//# sourceMappingURL=ModelHelper.js.map