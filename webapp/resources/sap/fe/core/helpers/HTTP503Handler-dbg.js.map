{"version":3,"names":["handler","createDialog","settings","Dialog","_handleDelayBusy","delayInMs","rootControl","BusyLocker","lock","Promise","resolve","setTimeout","unlock","undefined","_handleDelayProgressBar","error","resourceModel","promiseKeeper","PromiseKeeper","dialogTextRemaining","Text","dialogProgress","ProgressIndicator","displayOnly","percentValue","showValue","content","VBox","items","text","getText","message","addItem","replaceAll","updateContent","remainingTime","retryAfter","getTime","Date","now","progress","setPercentValue","remainingInSeconds","Math","ceil","remainingMinutes","floor","remainingSeconds","setText","progressAnimationTimer","setInterval","clearInterval","dialog","close","onCancel","reject","type","title","endButton","Button","press","state","open","promise","handle503Delay"],"sourceRoot":".","sources":["HTTP503Handler.ts"],"sourcesContent":["import type ResourceModel from \"sap/fe/core/ResourceModel\";\nimport BusyLocker from \"sap/fe/core/controllerextensions/BusyLocker\";\nimport PromiseKeeper from \"sap/fe/core/helpers/PromiseKeeper\";\nimport Button from \"sap/m/Button\";\nimport Dialog, { type $DialogSettings } from \"sap/m/Dialog\";\nimport ProgressIndicator from \"sap/m/ProgressIndicator\";\nimport Text from \"sap/m/Text\";\nimport VBox from \"sap/m/VBox\";\nimport type Control from \"sap/ui/core/Control\";\n\nconst handler = {\n\t/**\n\t * Creates a dialog from settings (exported for test purposes).\n\t * @param settings\n\t * @returns The dialog\n\t */\n\tcreateDialog(settings: $DialogSettings): Dialog {\n\t\treturn new Dialog(settings);\n\t},\n\n\t/**\n\t * Displays a busy indicator for a given amount of time.\n\t * @param delayInMs\n\t * @param rootControl\n\t * @returns A promise that resolves after the given amount of time.\n\t */\n\tasync _handleDelayBusy(delayInMs: number, rootControl: Control): Promise<undefined> {\n\t\tBusyLocker.lock(rootControl);\n\t\treturn new Promise<undefined>((resolve) => {\n\t\t\tsetTimeout(() => {\n\t\t\t\tBusyLocker.unlock(rootControl);\n\t\t\t\tresolve(undefined);\n\t\t\t}, delayInMs);\n\t\t});\n\t},\n\n\t/**\n\t * Displays a dialog with a progress bar and a text for a given amount of time.\n\t * @param delayInMs\n\t * @param error\n\t * @param error.retryAfter\n\t * @param resourceModel\n\t * @returns A promise that resolves after the given amount of time, or rejected if the user clicks Cancel.\n\t */\n\tasync _handleDelayProgressBar(\n\t\tdelayInMs: number,\n\t\terror: Error & { retryAfter?: Date },\n\t\tresourceModel: ResourceModel\n\t): Promise<undefined> {\n\t\tconst promiseKeeper = new PromiseKeeper<undefined>();\n\t\tconst dialogTextRemaining = new Text();\n\t\tconst dialogProgress = new ProgressIndicator({ displayOnly: true, percentValue: 0, showValue: false });\n\n\t\tconst content = new VBox({ items: [new Text({ text: resourceModel.getText(\"C_MESSAGE_HANDLING_SAPFE_503_TITLE\") })] });\n\t\tif (error.message) {\n\t\t\tcontent.addItem(new Text({ text: error.message.replaceAll(/[\\n\\r]/g, \" \") }));\n\t\t}\n\t\tcontent.addItem(dialogTextRemaining);\n\t\tcontent.addItem(dialogProgress);\n\n\t\tfunction updateContent(): boolean {\n\t\t\tconst remainingTime = error.retryAfter!.getTime() - Date.now();\n\t\t\tif (remainingTime <= 0) {\n\t\t\t\treturn false;\n\t\t\t} else {\n\t\t\t\tconst progress = 100 - (remainingTime / delayInMs) * 100;\n\t\t\t\tdialogProgress.setPercentValue(progress);\n\t\t\t\tconst remainingInSeconds = Math.ceil(remainingTime / 1000);\n\t\t\t\tconst remainingMinutes = Math.floor(remainingInSeconds / 60);\n\t\t\t\tconst remainingSeconds = remainingInSeconds % 60;\n\t\t\t\tif (remainingMinutes > 0) {\n\t\t\t\t\tdialogTextRemaining.setText(\n\t\t\t\t\t\tresourceModel.getText(\"C_UNAVAILABLE_SERVER_MESSAGE_MINUTES_SECONDS\", [remainingMinutes, remainingSeconds])\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\tdialogTextRemaining.setText(resourceModel.getText(\"C_UNAVAILABLE_SERVER_MESSAGE_SECONDS\", [remainingSeconds]));\n\t\t\t\t}\n\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\tconst progressAnimationTimer = setInterval(() => {\n\t\t\tif (!updateContent()) {\n\t\t\t\tclearInterval(progressAnimationTimer);\n\t\t\t\tdialog.close();\n\t\t\t\tpromiseKeeper.resolve(undefined);\n\t\t\t}\n\t\t}, 100);\n\n\t\tconst onCancel = (): void => {\n\t\t\tclearInterval(progressAnimationTimer);\n\t\t\tdialog.close();\n\t\t\tdelete error.retryAfter; // We can ignore the expected date, as it was already displayed in the progress dialog\n\t\t\tpromiseKeeper.reject(error);\n\t\t};\n\n\t\tconst dialog = this.createDialog({\n\t\t\ttype: \"Message\",\n\t\t\ttitle: resourceModel.getText(\"WARNING\"),\n\t\t\tcontent: [content],\n\t\t\tendButton: new Button({ text: resourceModel.getText(\"C_COMMON_DIALOG_CANCEL\"), press: onCancel }),\n\t\t\tstate: \"Warning\"\n\t\t});\n\t\tupdateContent();\n\t\tdialog.open();\n\n\t\treturn promiseKeeper.promise;\n\t},\n\n\t/**\n\t * Handles an HTTP 503 error with a delay.\n\t * @param error\n\t * @param error.retryAfter\n\t * @param rootControl\n\t * @param resourceModel\n\t * @returns A promise that resolves after the delay, or rejected if the user clicks Cancel.\n\t */\n\tasync handle503Delay(error: Error & { retryAfter?: Date }, rootControl: Control, resourceModel: ResourceModel): Promise<undefined> {\n\t\tif (error.retryAfter === undefined) {\n\t\t\t// No retry-after parameter -> rethrow error\n\t\t\treturn Promise.reject(error);\n\t\t}\n\n\t\tconst delayInMs = error.retryAfter.getTime() - Date.now();\n\t\tif (delayInMs < 5000) {\n\t\t\t// Less than 5 seconds -> show busy indicator\n\t\t\treturn this._handleDelayBusy(delayInMs, rootControl);\n\t\t} else if (delayInMs < 600000) {\n\t\t\t// Between 5s and 10min -> show progress bar\n\t\t\treturn this._handleDelayProgressBar(delayInMs, error as Error & { retryAfter: Date }, resourceModel);\n\t\t} else {\n\t\t\t// More than 10 minutes or undefined --> standard error\n\t\t\treturn Promise.reject(error);\n\t\t}\n\t}\n};\n\nexport default handler;\n"],"mappings":"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","ignoreList":[],"file":"HTTP503Handler-dbg.js"}