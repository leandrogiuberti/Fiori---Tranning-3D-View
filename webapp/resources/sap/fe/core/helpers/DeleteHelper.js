/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/controllerextensions/editFlow/draft","sap/m/CheckBox","sap/m/Text","sap/m/MessageToast","sap/ui/core/message/Message","sap/ui/core/message/MessageType","sap/ui/core/Messaging"],function(e,t,n,o,s,i,l,a){"use strict";var E=function(e){e["deletableContexts"]="deletableContexts";e["draftsWithDeletableActive"]="draftsWithDeletableActive";e["unSavedContexts"]="unSavedContexts";e["draftsWithNonDeletableActive"]="draftsWithNonDeletableActive";e["draftsToDeleteBeforeActive"]="draftsToDeleteBeforeActive";return e}(E||{});var r=function(e){e["CHECKBOX"]="checkBox";e["TEXT"]="text";return e}(r||{});function c(e,t,n,o){const s=[...n];o.forEach(e=>{const t=s.indexOf(e);if(t!==-1){s.splice(t,1)}});e.setProperty(t,[]);return s}function _(e,t){let n=e.getProperty("selectedContexts")||[];if(t.type===E.deletableContexts){n=c(e,E.deletableContexts,n,e.getProperty(E.deletableContexts)||[]);const t=e.getProperty(E.draftsWithDeletableActive)||[];const o=t.map(e=>e.draft);n=c(e,E.draftsWithDeletableActive,n,o)}else{const o=e.getProperty(t.type)||[];n=c(e,t.type,n,o)}e.setProperty("selectedContexts",n);e.setProperty("numberOfSelectedContexts",n.length)}function T(e,t,n,o,i){const{internalModelContext:l,entitySetName:a}=e;if(l){if(l.getProperty("deleteEnabled")!=undefined){t.forEach(e=>{if(e.selected){_(l,e)}})}l.setProperty("deleteEnabled",t.some(e=>!e.selected))}const E=e.parentControl?.getMetadata().getName()==="sap.ui.mdc.MultiValueField";const r=!e.parentControl||!E;if(r&&e.silentMode!==true){const e=n.length===1?"C_TRANSACTION_HELPER_DELETE_TOAST_SINGULAR":"C_TRANSACTION_HELPER_DELETE_TOAST_PLURAL";s.show(o.getText(e,undefined,a))}if(e.parentControl&&!E){y.setFocusAfterDelete(e.parentControl,n.length,i)}if(n?.length){n.forEach(e=>{const t=e.getPath();if(t&&e.getModel()){const n=e.getModel().getLocalAnnotationModel();const o=n.getObject(t);if(o&&typeof o==="object"){for(const e of Object.keys(o)){if(e.includes("ui5.fe.recommendations")){delete o[e]}}n.setProperty(t,o)}}})}}async function f(e,t,n){const o=e.getRowBinding?.()?.getCount();const s=(o??0)+t;let i;if(n!==-1&&o!==undefined&&o>0){if(n===s-1){i=o-1}else{i=n-t+1}await e.focusRow(i,false)}else{e.focus()}}function C(e){const t=e.getObject()["DraftAdministrativeData"];return t&&t["InProcessByUser"]||""}function d(e,t,n){let o="";if(t===1&&n.length===1){const t=C(n[0]);o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_SINGLE_OBJECT_LOCKED",[t])}else if(n.length==1){const s=C(n[0]);o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_ONE_OBJECT_LOCKED",[t,s])}else if(n.length>1){o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED",[n.length,t])}return o}function A(e,t,n){let o="";if(n===t){if(t===1){o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_ONLY_DRAFT_OF_NON_DELETABLE_ACTIVE")}else{o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_ONLY_DRAFTS_OF_NON_DELETABLE_ACTIVE")}}else if(t===1){o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_DRAFT_OF_NON_DELETABLE_ACTIVE")}else{o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_DRAFTS_OF_NON_DELETABLE_ACTIVE")}return o}function N(e){const t=e.getObject()["DraftAdministrativeData"];let n="";if(t){n=t["LastChangedByUserDescription"]||t["LastChangedByUser"]||""}return n}function g(e,t,n,o){let s="",i="",l=false;if(t===1&&n.length===1){const t=N(n[0]);s=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_CHANGES",[t]);l=true}else if(t===n.length){s=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_CHANGES_MULTIPLE_OBJECTS");l=true}else if(o===n.length){if(n.length===1){const t=N(n[0]);s=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_SINGULAR",[t])}else{s=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_PLURAL")}l=true}else if(o>n.length){if(n.length===1){const t=N(n[0]);i=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_SINGULAR",[t])}else{i=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_PLURAL")}}return{infoTxt:s,optionTxt:i,optionWithoutTxt:l}}function D(e,t,n){const{numberOfSelectedContexts:s,entitySetName:i,lockedContexts:l=[],draftsWithNonDeletableActive:a=[]}=e;const E=s-(l.length+t-a.length);let r="";if(E>0&&(t===0||a.length===t)){if(l.length>0){if(E===1){r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_ALL_REMAINING_NON_DELETABLE_SINGULAR")}else{r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_ALL_REMAINING_NON_DELETABLE_PLURAL")}}else if(E===1){r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_SINGLE_AND_ONE_OBJECT_NON_DELETABLE",undefined,i)}else{r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_MULTIPLE_AND_ALL_OBJECT_NON_DELETABLE",undefined,i)}}else if(E===1){r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_ONE_OBJECT_NON_DELETABLE",[s],i)}else if(E>1){r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_NON_DELETABLE",[E,s],i)}return r?new o({text:r}):undefined}function O(e,t){return t.reduce((e,t)=>t.selected&&t.type!==E.draftsToDeleteBeforeActive?e.concat(t.contexts):e,e)}function u(e){const t=[];return e.reduce((e,t)=>t.selected&&t.type===E.draftsToDeleteBeforeActive?e.concat(t.contexts):e,t)}function L(e,t,n,s,i,l){let{numberOfSelectedContexts:a,draftsWithDeletableActive:c,unSavedContexts:_,lockedContexts:T,draftsWithNonDeletableActive:f}=e;c??=[];_??=[];T??=[];f??=[];a??=0;let C="";if(c.length>0){const e=[];c.forEach(n=>{e.push(n.draft);t.push(n.siblingInfo.targetContext)});if(e.length>0){l.push({type:E.draftsToDeleteBeforeActive,contexts:e,selected:true})}}if(T.length>0){C=y.getLockedObjectsText(s,a,T)||"";i.push(new o({text:C}))}const d=a!=n-f.length+T.length;const A=d&&y.getNonDeletableText(e,n,s);if(A){i.push(A)}if(_.length>0){const e=y.getUnsavedContextsText(s,a,_,n)||{};if(e.infoTxt){i.push(new o({text:e.infoTxt}))}if(e.optionTxt||e.optionWithoutTxt){l.push({type:E.unSavedContexts,contexts:_,text:e.optionTxt,selected:true,control:r.CHECKBOX})}}if(f.length>0){const e=y.getNonDeletableActivesOfDraftsText(s,f.length,n)||"";if(e){l.push({type:E.draftsWithNonDeletableActive,contexts:f,text:e,selected:true,control:n>0?r.CHECKBOX:r.TEXT})}}}function I(e,t){if(e.length===1){const n=e[0];if(n.text){const e=new o;e.setText(n.text);t.push(e)}}else if(e.length>1){e.forEach(e=>{if(e.control==="text"&&e.text){const n=new o;n.setText(e.text);t.push(n)}});e.forEach(e=>{if(e.control==="checkBox"&&e.text){t.push(new n({text:e.text,selected:true,select:function(t){const n=t.getSource();const o=n.getSelected();e.selected=o}}))}})}}function x(e,t){const{draftsWithDeletableActive:n}=e;const o=n?.find(e=>e.siblingInfo.targetContext===t);return o?.draft?o.draft:t}function R(e,t,n){let{numberOfSelectedContexts:o,lockedContexts:s,draftsWithNonDeletableActive:i,unSavedContexts:l}=e;const{entitySetName:a,parentControl:c,description:_}=e;i??=[];l??=[];s??=[];i??=[];o??=0;const T=t.length+i.length+l.length;const f=o-(s.length+T-i.length);const C=[];if(o===1&&o===t.length){const o=c;const s=o&&o.getParent().getIdentifierColumn();let i;if(s){const o=_&&_.path;const l=x(e,t[0]).getObject();const E=s?l[s]:undefined;const r=o&&l[o];if(E){if(r&&_&&s!==_.path){i=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO",[E,r],a)}else{i=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_ONLY",[E],a)}}else{i=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",undefined,a)}}else{i=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",undefined,a)}C.push({type:E.deletableContexts,contexts:t,text:i,selected:true,control:r.TEXT})}else if(l.length!==T&&o>0&&(t.length>0||l.length>0&&i.length>0)){if(o>t.length&&f+s.length>0){let e="";if(T===1){e=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR_NON_DELETABLE",undefined,a)}else{e=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL_NON_DELETABLE",undefined,a)}C.unshift({type:E.deletableContexts,contexts:t,text:e,selected:true,control:r.TEXT})}else{const e=T===1?n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",undefined,a):n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL",undefined,a);C.push({type:E.deletableContexts,contexts:t,text:e,selected:true,control:r.TEXT})}}return C}async function h(n,o,s,i){const l=[];await Promise.allSettled(n.map(async function(n){try{return await t.deleteDraft(n,o,s,i)}catch(t){e.error(`FE : core : DeleteHelper : Error while discarding draft with path : ${n.getPath()}`);l.push(t)}}));return l}function p(e){const t=[...e];t.forEach((e,n)=>{if(e===undefined){return}for(let o=n+1;o<t.length;o++){const n=t[o];if(n&&e.isAncestorOf(n)){t[o]?.setSelected(false);t[o]=undefined}}});return t.filter(e=>e!==undefined)}async function S(e,n,o,s,i,l,a){const E=o.registerToHoldMessages();let r=[];try{r=y.getConfirmedDeletableContext([],e);const c=r[r.length-1].getIndex()??-1;const _=u(e);const{beforeDeleteCallBack:T}=n;if(T){await T({contexts:r})}if(r.length){const E=r.length===1?true:false;const T=await h(_,o,i,E);let f=r;if(a==="Tree"){f=p(r)}await Promise.all(f.map(async function(e){if(!l||n.draftsWithDeletableActive?.find(t=>t.siblingInfo.targetContext===e)||a==="Analytical"){e.resetChanges();return e.getModel().delete(e.getCanonicalPath())}else{return t.deleteDraft(e,o,i,E)}}));y.afterDeleteProcess(n,e,r,s,c);if(T.length>0){throw Error(`FE : core : DeleteHelper : Errors on draft delete : ${T}`)}}o.removeHoldKey(E)}catch(e){if(r.length>1){y.addGenericDeleteFailureMessage(s)}await o.showMessages({unHoldKey:E});throw e}}function b(e){a.addMessages(new i({message:e.getText("C_COMMON_DELETE_CHANGESET_FAILURE_MULTIPLE_ERRORS_TEXT"),type:l.Error,target:undefined,persistent:true,code:"FE_CUSTOM_MESSAGE_CHANGESET_ALL_FAILED",description:e.getText("C_COMMON_DELETE_CHANGESET_FAILURE_MULTIPLE_ERRORS_DETAILS_TEXT"),technicalDetails:{fe:{changeSetPreTextForSingleError:e.getText("C_COMMON_DELETE_CHANGESET_FAILURE_SINGLE_ERROR_TEXT")}}}))}async function v(e,n,o){try{if(!e.isActive&&e.hasActive){const s=await t.computeSiblingInformation(e.context,e.context);e.siblingInfo=s;e.siblingDeletable=n?await(s?.targetContext?.requestProperty(n)):o}else if(e.isActive&&e.hasDraft){const s=await t.computeSiblingInformation(e.context,e.context);if(s?.targetContext){const t=["IsActiveEntity","HasActiveEntity"];if(n){t.push(n)}await s.targetContext.requestProperty(t);e.locked=false;e.hasDraft=false;e.isActive=false;e.hasActive=true;e.siblingInfo={targetContext:e.context,pathMapping:[]};e.context=s.targetContext;e.siblingDeletable=e.deletable;e.deletable=n?s.targetContext.getProperty(n):o}}}catch(e){}}async function P(e){const t=!!e?.getObject()?.["@$ui5.context.isTransient"];const n=e?.isInactive();const o=n||!n&&t?undefined:e.getModel().getMetaModel().getMetaContext(e.getCanonicalPath());const s=o?.getProperty("@Org.OData.Capabilities.V1.DeleteRestrictions/Deletable/$Path");const i=!s&&o?.getProperty("@Org.OData.Capabilities.V1.DeleteRestrictions/Deletable")!==false;const l=s?e.getProperty(s):i;const a={context:e,isDraftRoot:!!o?.getProperty("@com.sap.vocabularies.Common.v1.DraftRoot"),isDraftNode:!!o?.getProperty("@com.sap.vocabularies.Common.v1.DraftNode"),isActive:true,hasActive:false,hasDraft:false,locked:false,deletable:l,siblingInfo:undefined,siblingDeletable:false,isInactiveContext:!!e.isInactive()};if(!e.isInactive()&&a.isDraftRoot){const t=e.getObject();a.locked=!!t.DraftAdministrativeData?.InProcessByUser;a.hasDraft=t.HasDraftEntity;a.isActive=t.IsActiveEntity;a.hasActive=t.HasActiveEntity;await v(a,s,i)}return a}async function H(e,t){let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;const o=await Promise.all(t.map(P));const s=[{key:"draftsWithDeletableActive",value:o.filter(e=>!e.isInactiveContext&&e.isDraftRoot&&!e.isActive&&e.hasActive&&e.siblingDeletable)},{key:"draftsWithNonDeletableActive",value:o.filter(e=>!e.isInactiveContext&&e.isDraftRoot&&!e.isActive&&e.hasActive&&!e.siblingDeletable)},{key:"lockedContexts",value:o.filter(e=>!e.isInactiveContext&&e.isDraftRoot&&e.isActive&&e.hasDraft&&e.locked)},{key:"unSavedContexts",value:o.filter(e=>!e.isInactiveContext&&e.isDraftRoot&&e.isActive&&e.hasDraft&&!e.locked)},{key:"deletableContexts",value:o.filter(e=>e.isInactiveContext||!e.isDraftRoot&&!e.isDraftNode&&e.deletable||e.isDraftRoot&&e.isActive&&!e.hasDraft&&e.deletable||e.isDraftRoot&&!e.isActive&&!e.hasActive||e.isDraftNode&&e.deletable)}];const i=!n?"":"contextmenu/";for(const{key:t,value:n}of s){e.setProperty(i+t,n.map(e=>t==="draftsWithDeletableActive"?{draft:e.context,siblingInfo:e.siblingInfo}:e.context))}}const y={getNonDeletableText:D,deleteConfirmHandler:S,getOptionsForDeletableTexts:R,updateContentForDeleteDialog:I,updateDraftOptionsForDeletableTexts:L,getConfirmedDeletableContext:O,getLockedObjectsText:d,getUnsavedContextsText:g,getNonDeletableActivesOfDraftsText:A,afterDeleteProcess:T,updateDeleteInfoForSelectedContexts:H,DeleteOptionTypes:E,DeleteDialogContentControl:r,setFocusAfterDelete:f,getContextInfos:P,addGenericDeleteFailureMessage:b,removeDescendantContexts:p};return y},false);
//# sourceMappingURL=DeleteHelper.js.map