/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/model/Filter","sap/ui/model/FilterOperator","../converters/MetaModelConverter","./ModelHelper","./SemanticKeyHelper"],function(e,t,n,a,s){"use strict";var i=n.getInvolvedDataModelObjects;const r={_getKeysFromStartupParams:function(e,t){let n=true;const a=e.map(e=>{if(t?.[e]&&t[e].length===1){return{name:e,value:t[e][0]}}else{n=false;return{name:e,value:""}}});return n?a:undefined},_createFilterFromKeys:function(n,s,i){const r=a.isFilteringCaseSensitive(i);let o=false;const c=n.map(n=>{if(n.name==="IsActiveEntity"){o=true}return new e({path:n.name,operator:t.EQ,value1:n.value,caseSensitive:r})});if(s&&!o){const t=new e({filters:[new e("IsActiveEntity","EQ",false),new e("SiblingEntity/IsActiveEntity","EQ",null)],and:false});c.push(t)}return new e(c,true)},_sanitizeKeys:function(e,t){e.forEach(e=>{const n=t[e.name].$Type;switch(n){case"Edm.Boolean":if(e.value!=="true"&&e.value!=="false"){e.value=e.value.trim().length?"true":"false"}break;case"Edm.Guid":{const t=/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i;const n=/[0-9a-f]{32}/i;const a=t.exec(e.value);const s=n.exec(e.value);if(a){e.value=a[0]}else if(s){e.value=s[0].replace(/^([0-9a-f]{8})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{12})$/i,"$1-$2-$3-$4-$5")}break}default:}})},_requestObjectsFromParameters:async function(e,t){const n=e.map(async e=>{const n=t.getMetaModel().getObject(`${e.contextPath}/`);if(e.technicalKeys){this._sanitizeKeys(e.technicalKeys,n);const a=`${e.contextPath}(${s.getPathContent(e.technicalKeys,n)})`;const i=t.bindContext(a).getBoundContext();return Promise.resolve([i])}else{const a=e.semanticKeys??[];this._sanitizeKeys(a,n);const s=this._createFilterFromKeys(a,e.draftMode,t.getMetaModel());const i=t.bindList(e.contextPath,undefined,undefined,s,{$select:a.map(e=>e.name).join(",")});return i.requestContexts(0,2)}});return Promise.all(n)},_getRightMostTargetName(e,t){if(Array.isArray(e.target)){const n=[...e.target].reverse();return n.find(e=>{const n=t?.targets?.[e];return n?.name&&["sap.fe.templates.ListReport","sap.fe.templates.ObjectPage","sap.fe.core.fpm"].includes(n.name)})}else{return e.target}},_getReachablePageInfoFromRoute:function(e,t,n,a){let s=e.pattern.replace(":?query:","");s=s.replace(/\/$/,"");if(!s||!s.endsWith(")")){return undefined}s=s.replace(/\(\{[^}]*\}\)/g,"(#)");const r=this._getRightMostTargetName(e,t);if(!r){return undefined}const o=t?.targets?.[r];const c=s.split("/");const l=c.length-1;if(l!==0&&o?.options?.settings?.allowDeepLinking!==true){return undefined}let u="";if(o?.options?.settings?.entitySet){u=`/${o.options.settings.entitySet}`}else if(o?.options?.settings?.contextPath){const e=a.createBindingContext(o.options.settings.contextPath);const t=i(e);if(t.targetEntitySet){u=`/${t.targetEntitySet.name}`}}if(!u){return undefined}const f=u&&a.getObject(`/$EntityContainer${u}/`);if(!f){return undefined}let g=a.getObject(`/$EntityContainer${u}/@com.sap.vocabularies.Common.v1.SemanticKey`)?.map(e=>e.$PropertyPath);const p=f["$Key"];if(l===0&&g&&g.length===p.length&&g.every(e=>p.includes(e))){g=undefined}const m=g?this._getKeysFromStartupParams(g,n):undefined;const d=!m&&l===0?this._getKeysFromStartupParams(p,n):undefined;if(m===undefined&&d===undefined){return undefined}const h=a.getObject(`/$EntityContainer${u}@com.sap.vocabularies.Common.v1.DraftRoot`)||a.getObject(`/$EntityContainer${u}@com.sap.vocabularies.Common.v1.DraftNode`)?true:false;return{pattern:s,contextPath:u,draftMode:h,technicalKeys:d,semanticKeys:m,target:r,targetResolutionValue:o?.options?.settings?.targetResolutionValue,pageLevel:l}},_getReachablePages:function(e,t,n){const a=e?.routes??[];const s={};a.forEach(a=>{const i=this._getReachablePageInfoFromRoute(a,e,t,n);if(i){if(!s[i.pageLevel]){s[i.pageLevel]=[]}s[i.pageLevel].push(i)}});const i=[];let r=0;while(s[r]){i.push(s[r]);r++}return i},_getStartupPagesFromStartupParams:function(e,t,n,a){const s=a&&t&&t[a]&&t[a][0];const i=this._getReachablePages(e,t,n);if(i.length===0){return[]}let r=[];const o=[];function c(e){const t=i[e];const n=o.length?o[o.length-1]:undefined;if(t){t.forEach(function(t){if(!n||t.pattern.indexOf(n.pattern)===0){o.push(t);c(e+1);o.pop()}})}if(o.length>r.length){const e=o.slice(-1)[0];if(s){if(e.targetResolutionValue===s){r=o.slice()}}else{r=o.slice()}}}c(0);return r},_getDeepLinkObject:function(e,t){if(t.length===1){return{context:t[0]}}else if(t.length>1){let n=e[e.length-1].pattern;t.forEach(function(e){n=n.replace("(#)",`(${e.getPath().split("(")[1]}`)});return{hash:n}}else{return{}}},getDeepLinkStartupHash:async function(e,t,n,a){await n.getMetaModel().requestObject("/$EntityContainer/");const s=this._getStartupPagesFromStartupParams(e,t,n.getMetaModel(),a);const i=await this._requestObjectsFromParameters(s,n);if(i.length){const e=[];i.forEach(function(t){if(t.length===1){e.push(t[0])}});return e.length===i.length?this._getDeepLinkObject(s,e):{}}else{return{}}},getCreateStartupHash:async function(e,t,n,a){return a.requestObject(`${t}@`).then(s=>{let i="";let r=true;if(s["@com.sap.vocabularies.Common.v1.DraftRoot"]&&s["@com.sap.vocabularies.Common.v1.DraftRoot"]["NewAction"]){i=`${t}@com.sap.vocabularies.Common.v1.DraftRoot/NewAction@Org.OData.Core.V1.OperationAvailable`}else if(s["@com.sap.vocabularies.Session.v1.StickySessionSupported"]&&s["@com.sap.vocabularies.Session.v1.StickySessionSupported"]["NewAction"]){i=`${t}@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction@Org.OData.Core.V1.OperationAvailable`}if(i){const e=a.getObject(i);if(e===false){r=false}}else{const e=s["@Org.OData.Capabilities.V1.InsertRestrictions"];if(e&&e.Insertable===false){r=false}}if(r){return this.getDefaultCreateHash(e,t,n)}else{return""}})},getDefaultCreateHash:function(e,t,n){let a=e&&e.preferredMode?e.preferredMode[0]:"create";let s="";a=a.includes(":")&&a.length>a.indexOf(":")+1?a.substring(0,a.indexOf(":")):"create";s=`${t.substring(1)}(...)?i-action=${a}`;if(n.getRouteInfoByHash(s)){return s}else{throw new Error(`No route match for creating a new ${t.substring(1)}`)}},verifyEditAnnotations:async function(e,t){const n=await t.requestObject(`${e}@`);const a=n?.["@com.sap.vocabularies.UI.v1.UpdateHidden"];let s=true;if(n?.["@com.sap.vocabularies.Common.v1.DraftRoot"]?.["EditAction"]){s=t.getObject(`${e}@com.sap.vocabularies.Common.v1.DraftRoot/EditAction@Org.OData.Core.V1.OperationAvailable`)}return s!==false&&a!==true}};return r},false);
//# sourceMappingURL=AppStartupHelper.js.map