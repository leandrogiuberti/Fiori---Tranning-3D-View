/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/i18n/Localization","sap/fe/core/services/valueHelpService/HistoryOptOutProvider","sap/ui/core/EventBus","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory"],function(t,e,i,a,s,n){"use strict";var r={};function o(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,c(t,e)}function c(t,e){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},c(t,e)}const l="@AppLanguage";let p=function(s){function n(){return s.apply(this,arguments)||this}r.ValueHelpHistoryService=n;o(n,s);var c=n.prototype;c.init=function t(){};c.initialize=async function e(){const a=this.getContext(),s=a.scopeObject;try{const[t,e]=await Promise.all([s.getService("environmentCapabilities"),s.getService("shellServices")]);this.shellServices=e;this.appId=s.getManifestEntry("sap.app").id||"unknownAppId";const a=t.getCapabilities().UShell,n=e.getShellConfig()?.apps?.inputFieldHistory?.enabled;if(a&&n){this.historyOptOutProvider=new i(this)}}catch(e){t.error("Cannot retrieve EnvironmentCapabilities or ShellServices",e instanceof Error?e.message:String(e))}return this};c.registerShellHook=async function t(){if(this.historyOptOutProvider){await this.historyOptOutProvider.createOptOutUserProfileEntry();a.getInstance().subscribeOnce("shell","userActionsMenuCompLoaded",async()=>{await this.historyOptOutProvider.createOptOutUserProfileEntry()})}};c.getShellExtensionService=function t(){return this.shellServices.getExtensionService()};c.getPersonalizer=async function t(e,i){const a={container:e,item:i},s={};return this.shellServices.getPersonalizer(a,s,undefined)};c.getGlobalPersonalizer=async function t(){if(!this.globalPersonalizer){const t="sapui5.history.";const e=t+"HistorySettings";const i=t+"settings";this.globalPersonalizer=await this.getPersonalizer(e,i)}return this.globalPersonalizer};c.getGlobalDefaultData=function t(){return{historyEnabled:true,suggestionsEnabled:false,apps:{}}};c.getGlobalHistoryData=async function t(){if(!this.globalHistoryData){const t=await this.getGlobalPersonalizer();const e=await t.getPersData();this.globalHistoryData=e?{...e}:this.getGlobalDefaultData()}return this.globalHistoryData};c.getHistoryEnabled=async function t(){const e=await this.getGlobalHistoryData();return e.historyEnabled};c.setHistoryEnabled=async function t(e){const i=await this.getGlobalHistoryData();i.historyEnabled=e;const a=await this.getGlobalPersonalizer();a.setPersData(i)};n.createAppContainerId=function t(){const e="xxxxxxxx.xxxx.4xxx.yxxx.xxxxxxxxxxxx".replace(/[xy]/g,function(t){let e=Math.random()*16|0;if(t==="y"){e=e&3|8}return e.toString(16)});return"ui5."+e};c.addAppToGlobalHistory=async function t(e,i){const a=n.createAppContainerId();e.apps[i]=a;const s=await this.getGlobalPersonalizer();s.setPersData(e);return a};c.getAppPersonalizer=async function t(){if(!this.appPersonalizer){const t=await this.getGlobalHistoryData(),e=t.apps,i=e[this.appId]||await this.addAppToGlobalHistory(t,this.appId),a="sapui5.history.appData";this.appPersonalizer=await this.getPersonalizer(i,a)}return this.appPersonalizer};c.getAppDefaultData=function t(){const e={};e[n.appDataKey]={};return e};c.getAppHistoryData=async function t(){if(!this.appHistoryData){const t=await this.getAppPersonalizer(),e=await(t.getPersData?.());this.appHistoryData=e?{...e}:this.getAppDefaultData()}return this.appHistoryData};c.getFieldDataFromService=async function t(i){const a=await this.getAppHistoryData(),s=a[n.appDataKey],r=s[i];const o=e.getLanguage();return r?.filter(t=>t[l]===o)||[]};c.setFieldDataWithService=async function t(e,i){const a=await this.getAppHistoryData(),s=a[n.appDataKey],r=await this.getAppPersonalizer();s[e]=i;return r.setPersData(a)};n.getDistinct=function t(e){const i={},a=[];for(const t of e){const e=Object.values(t).join();if(!i[e]){a.push(t);i[e]=true}}return a};c.deleteHistoryForAllApps=async function t(){const e=this.shellServices,i=await this.getGlobalHistoryData(),a=[],s=i.apps;for(const t of Object.keys(s)){a.push(e.deletePersonalizationContainer(s[t],undefined))}this.appHistoryData=undefined;await Promise.all(a)};c.getFieldData=async function t(e){const i=Boolean(this.historyOptOutProvider),a=await this.getHistoryEnabled();if(i&&a){const t=await this.getFieldDataFromService(e);return t.map(t=>Object.entries(t).filter(t=>{let[e,i]=t;return!e.startsWith("@")}).reduce((t,e)=>{let[i,a]=e;return{...t,[i]:a}},{}))}return[]};c.setFieldData=async function t(i,a){const s=Boolean(this.historyOptOutProvider),r=await this.getHistoryEnabled();if(s&&r){const t=e.getLanguage();for(const e of a){e[l]=t}const s=await this.getFieldDataFromService(i),r=n.getDistinct(a.reverse().concat(s)).slice(0,n.maxHistoryItems);return this.setFieldDataWithService(i,r)}};return n}(s);p.appDataKey="sapui5.history";r.ValueHelpHistoryService=p;p.maxHistoryItems=5;let u=function(t){function e(){return t.apply(this,arguments)||this}r=e;o(e,t);var i=e.prototype;i.createInstance=async function t(e){this.instance=new p(e);return this.instance.initialize()};i.getInstance=function t(){return this.instance};return e}(n);r=u;return r},false);
//# sourceMappingURL=ValueHelpHistoryServiceFactory.js.map