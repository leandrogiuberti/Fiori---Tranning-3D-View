/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/i18n/Localization","sap/fe/base/BindingToolkit","sap/fe/core/CommonUtils","sap/fe/core/TemplateModel","sap/fe/core/converters/ManifestSettings","sap/fe/core/converters/ManifestWrapper","sap/fe/core/converters/MetaModelConverter","sap/fe/core/definition/FEDefinition","sap/fe/core/helpers/LoaderUtils","sap/fe/core/helpers/ModelHelper","sap/fe/core/manifestMerger/ChangePageConfiguration","sap/ui/Device","sap/ui/VersionInfo","sap/ui/core/Core","sap/ui/core/mvc/View","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/model/json/JSONModel","../helpers/DynamicAnnotationPathHelper"],function(e,t,n,o,i,r,a,s,c,l,g,u,p,d,f,h,v,m,C,y,w){"use strict";var b={};var M=w.resolveDynamicExpression;var V=u.applyPageConfigurationChanges;var S=l.requireDependencies;var P=c.DefinitionContext;var I=s.registerVirtualProperty;var x=r.TemplateType;var D=n.resolveBindingString;function T(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,N(e,t)}function N(e,t){return N=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},N(e,t)}let O=function(n){function r(){return n.apply(this,arguments)||this}b.TemplatedViewService=r;T(r,n);var s=r.prototype;s.init=function e(){const n=[];const i=this.getContext();const r=i.scopeObject;const a=o.getAppComponent(r);const s=a.getViewPreloaderService();const c=a.getMetaModel();this.pageId=a.getLocalId(r.getId());const l=`${a.getMetadata().getComponentName()}::${this.pageId}`;const g=r.getEnhanceI18n()||[];let u;this.oFactory=i.factory;if(g){u=a.getMetadata().getComponentName();for(let e=0;e<g.length;e++){const t=a.getModel(g[e]);if(t&&t.isA("sap.ui.model.resource.ResourceModel")){g[e]=t}else{g[e]=`${u}.${g[e].replace(".properties","")}`}}}const p=`${a.getMetadata().getName()}_${l}_${t.getLanguageTag()}`;n.push(C.get("sap.fe.core.services.ResourceModelService").createInstance({scopeType:"component",scopeObject:r,settings:{bundles:["sap.fe.core.messagebundle","sap.fe.macros.messagebundle","sap.fe.templates.messagebundle"],enhanceI18n:g,modelName:"sap.fe.i18n"}}).then(e=>{this.oResourceModelService=e;return e.getResourceModel()}));n.push(C.get("sap.fe.core.services.CacheHandlerService").createInstance({settings:{metaModel:c,appComponent:a,component:r}}).then(async e=>{await s.isCacheReady();this.oCacheHandlerService=e;return e.validateCacheKey(p,r,a.getEnvironmentCapabilities())}));n.push(d.load().then(function(e){let t="";if(!e.libraries){t=f?.buildinfo?.buildtime??"<NOVALUE>"}else{e.libraries.forEach(function(e){t+=e.buildTimestamp})}return t}).catch(function(){return"<NOVALUE>"}));this.initPromise=Promise.all(n).then(async e=>{const t=e[0];const n=e[1];const[o,i]=await S(["sap/fe/core/converters/TemplateConverter","sap/fe/core/converters/MetaModelConverter"]);return this.createView(t,l,n,o,i)}).then(function(e){const t=C.get("sap.fe.core.services.CacheHandlerService").getInstance(c);t.invalidateIfNeeded(e,p,r,a.getEnvironmentCapabilities());return})};s.refreshView=async function t(n){const o=n.getRootControl();if(o){o.destroy()}else if(this.oView){this.oView.destroy()}return this.createView(this.resourceModel,this.stableId,"",this.TemplateConverter,this.MetaModelConverter).then(function(){n.getUIArea().invalidate();return}).catch(function(t){n.getUIArea().invalidate();e.error(t)})};s._getViewSettings=function e(t,n,o,i,r,a,s){let c=n.viewType||o.getViewType()||"XML";if(c!=="XML"){c=undefined}return{type:c,preprocessors:{xml:t,controls:{}},id:i.stableId,viewName:n.viewName||o.getViewName?.(),viewData:i,cache:{keys:[r],additionalData:{getAdditionalCacheData:()=>a.getData(),setAdditionalCacheData:e=>{a.setData(e)}}},models:{"sap.fe.i18n":s},height:"100%"}};s._createErrorPage=async function t(n,o,i,r,a){e.error(n.message,n);o.viewName=i;if(o.preprocessors){o.preprocessors.xml.models["error"]=new y(n)}return r.runAsOwner(async()=>h.create(o).then(e=>{this.oView=e;this.oView.setModel(new y(this.oView),"$view");r.setAggregation("rootControl",this.oView);r.getAppComponent().getRootControl().getController().getPlaceholder().hideRootPlaceholder();return a}))};s.createView=async function t(n,r,s,c,l){this.resourceModel=n;this.stableId=r;this.TemplateConverter=c;this.MetaModelConverter=l;const u=this.getContext();const d=u.settings;const f=d.converterType;const v=u.scopeObject;const m=o.getAppComponent(v);let C=m.getRoutingService().getTargetInformationFor(v)?.options?.settings?.fullContextPath??"";if(!C){C=v.getContextPath()??""}const w=m.getMetaModel();const b=m.getManifest();const V=new y(p).setDefaultBindingMode("OneWay");const S=new y(b);let I,D,T;try{const t=await m.getService("routingService");const o=t.getTargetInformationFor(v);const u=b["sap.app"]&&b["sap.app"].crossNavigation&&b["sap.app"].crossNavigation.outbounds||{};const N=v.getNavigation()||{};const O=l.convertTypes(w,m.getEnvironmentCapabilities().getCapabilities());this._enhanceNavigationConfig(N,u,O,r);const F=new P(O);F.addApplicationManifest(b);T={appComponent:m,navigation:N,viewLevel:o?.viewLevel,stableId:r,contentDensities:b["sap.ui5"]?.contentDensities,resourceModel:n,fullContextPath:C,isDesktop:p.system.desktop,isPhone:p.system.phone,converterType:x.FreeStylePage};if(v.getViewData){Object.assign(T,v.getViewData());T=E.setPageConfigurationChanges(b,T,m,this.pageId)}T.isShareButtonVisibleForMyInbox=E.getShareButtonVisibilityForMyInbox(m);const _=m.getShellServices();T.converterType=f;T.shellContentDensity=_.getContentDensity();const j=b["sap.fe"];T.sapFeManifestConfiguration=b["sap.fe"];T.retrieveTextFromValueList=j?.form?j?.form?.retrieveTextFromValueList:undefined;D=new y(T);if(T.controlConfiguration){for(const e in T.controlConfiguration){if(e.includes("[")){const t=M(e,w);T.controlConfiguration[t]=T.controlConfiguration[e]}}}I=new i(()=>{try{const t=m.getDiagnostics();const n=t.getIssues().length;const o=c.convertPage(f,w,T,new a(T,m),t,C,m.getEnvironmentCapabilities().getCapabilities(),v);if(o&&v._getControllerName()){o.controllerName=v._getControllerName()}const i=t.getIssues();const r=i.slice(n);if(r.length>0){e.warning("Some issues have been detected in your project, please check the UI5 support assistant rule for sap.fe.core")}return o}catch(t){e.error(t,t);return{}}},w);const A=C.split("/");const $=this._getFullPathToEntitySet(A,w);const R={bindingContexts:{entitySet:$?w.createBindingContext($):null,fullContextPath:C?w.createBindingContext(C):null,contextPath:C?w.createBindingContext(C):null,converterContext:I.createBindingContext("/",undefined,{noResolve:true}),viewData:T?D.createBindingContext("/"):null},models:{entitySet:w,fullContextPath:w,contextPath:w,"sap.fe.i18n":n,metaModel:w,device:V,manifest:S,converterContext:I,viewData:D},fullContextPath:C,getConvertedMetadata:()=>O,getDefinitionContext(){return F},getDefinitionForPage(){let e=C;if(e.endsWith("/")){e=e.substring(0,e.length-1)}return F.getPageFor(e)},appComponent:m,viewId:r},B=this._getViewSettings(R,d,v,T,s,I,n);v.setModel(I,"_pageModel");v.setPreprocessorContext(R);return v.runAsOwner(async()=>h.create(B).then(e=>{this.oView=e;const t=new y(this.oView);g.enhanceViewJSONModel(t);this.oView.setModel(t,"$view");this.oView.setModel(D,"viewData");v.setAggregation("rootControl",this.oView);return s}).catch(async e=>this._createErrorPage(e,B,d.errorViewName||"sap.fe.core.services.view.TemplatingErrorPage",v,s)).catch(t=>e.error(t.message,t)))}catch(t){e.error(t.message,t);throw new Error(`Error while creating view : ${t}`)}};s._enhanceNavigationConfig=function e(t,n,o,i){Object.keys(t).forEach(function(e){const r=t[e];let a;if(r.detail&&r.detail.outbound&&n[r.detail.outbound]){a=n[r.detail.outbound];r.detail.outboundDetail={semanticObject:a.semanticObject,action:a.action,parameters:a.parameters}}if(r.detail.availability){I(o,"routeNavigable-"+r.detail.route,()=>D(r.detail.availability),i)}if(r.create&&r.create.outbound&&n[r.create.outbound]){a=n[r.create.outbound];r.create.outboundDetail={semanticObject:a.semanticObject,action:a.action,parameters:a.parameters}}})};s._getFullPathToEntitySet=function e(t,n){return t.reduce(function(e,t){if(t===""){return e}if(e===""){e=`/${t}`}else{const o=n.getObject(`${e}/$NavigationPropertyBinding/${t}`);if(o&&Object.keys(o).length>0){e+="/$NavigationPropertyBinding"}e+=`/${t}`}return e},"")};s.getView=function e(){return this.oView};s.getInterface=function e(){return this};s.exit=function e(){if(this.oResourceModelService){this.oResourceModelService.destroy()}if(this.oCacheHandlerService){this.oCacheHandlerService.destroy()}this.oFactory.removeGlobalInstance()};return r}(v);b.TemplatedViewService=O;let E=function(e){function t(){var t;for(var n=arguments.length,o=new Array(n),i=0;i<n;i++){o[i]=arguments[i]}t=e.call(this,...o)||this;t._oInstanceRegistry={};return t}b.TemplatedViewServiceFactory=t;T(t,e);var n=t.prototype;n.createInstance=async function e(n){t.iCreatingViews++;const o=new O(Object.assign({factory:this},n));return o.initPromise.then(function(){t.iCreatingViews--;return o})};n.removeGlobalInstance=function e(){this._oInstanceRegistry={}};t.getShareButtonVisibilityForMyInbox=function e(t){const n=t.getComponentData();if(n!==undefined&&n.feEnvironment){return n.feEnvironment.getShareControlVisibility()}return undefined};t.getNumberOfViewsInCreationState=function e(){return t.iCreatingViews};t.setPageConfigurationChanges=function e(t,n,o,i){const r=t?.["sap.ui5"]?.routing?.targets??{};let a="";for(const e in r){if(r[e].id===i){a=e;break}}if(a===""){a=i}const s=t?.["sap.ui5"]?.routing?.targets?.[a]?.options?.settings||{};return V(s,n,o,i)};return t}(m);b.TemplatedViewServiceFactory=E;return b},false);
//# sourceMappingURL=TemplatedViewServiceFactory.js.map