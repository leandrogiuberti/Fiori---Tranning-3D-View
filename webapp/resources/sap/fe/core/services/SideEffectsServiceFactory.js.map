{"version":3,"file":"SideEffectsServiceFactory.js","names":["SideEffectsService","_Service","apply","this","arguments","_exports","_inheritsLoose","_proto","prototype","init","context","getContext","appComponent","scopeObject","sideEffectsRegistry","oData","entities","actions","boundActions","unBoundActions","control","recommendationRegistry","roles","targetCallbacks","initializeWebSocketConnection","model","getModel","url","getWebSocketBaseUrl","channel","getWebSocketChannelUrl","ChannelType","SideEffectsEvents","webSocket","createWebSocket","attachMessage","onSideEffectsEventReceived","bind","webSocketStatus","WEBSOCKET_STATUS","CONNECTED","showConnectionLostDialog","CLOSED","ERROR","includes","resourceModel","getResourceModel","lostOfConnectionText","getText","MessageBox","warning","Action","OK","emphasizedAction","attachError","attachClose","evt","getParameter","async","event","message","serverAction","sideEffectEventName","sideEffectSource","metaPath","getMetaModel","getMetaContext","dataModel","MetaModelConverter","getInvolvedDataModelObjects","relevantSideEffects","getSideEffectWhereEventIsSource","targetEntityType","fullyQualifiedName","length","relevantPages","pages","getRootViewController","getVisibleViews","page","pageController","getController","isA","_sideEffects","isDataPathRelevant","push","sideEffectsControllerExtension","onlyRecommendations","isOnlyRecommendations","interactionType","getSideEffectsInteractionType","confirmDataRefresh","error","notifyDataRefresh","requestSideEffectsForEvent","recommendationPath","annotations","UI","Recommendations","path","sideEffect","annotation","entity","qualifier","targetProperties","targetEntities","undefined","interactionTypeDefinition","getManifestEntry","app","sideEffectsEventsInteractionType","events","default","addControlSideEffects","entityType","sourceControlId","controlSideEffect","entityControlSideEffects","executeAction","triggerAction","options","action","bindContext","executionOptions","groupId","getBinding","getUpdateGroupId","submitBatch","execute","getConvertedMetaModel","convertTypes","capabilities","getEntityTypeFromContext","metaModel","getMetaPath","getPath","getObject","getODataEntitySideEffects","entityTypeName","isControlSideEffects","sideEffects","getGlobalODataEntitySideEffects","entitySideEffects","globalSideEffects","key","sourceEntities","sourceProperties","sourceEvents","getODataActionSideEffects","actionName","getODataSideEffectsFromContextEvent","sideEffectsInfo","map","initialize","sideEffectSources","properties","environmentCapabilitiesService","getService","requestObject","getCapabilities","convertedMetaModel","containerName","entityContainer","containerRegexPattern","RegExp","entityTypeRegexPattern","entityTypes","forEach","mapFieldAnnotations","retrieveODataEntitySideEffects","mapSideEffectSources","isBound","sourceEntityType","retrieveODataActionsSideEffects","Object","keys","sourcesToSideEffectMappings","source","addRecommendationRoles","sourceName","hasOwnProperty","input","output","entityProperties","property","commonAnno","Common","RecommendationRole","roleType","valueOf","name","getRecommendationsMapping","checkIfFieldIsRecommendationRelevant","field","getBindingContext","propertyName","data","sourcePath","split","pop","metaContext","targetDataModelObject","targetObject","targetEntityTypeName","isEntitySet","isNavigationProperty","targetType","recommendationRolesForEntity","getRecommendationOutputFields","removeControlSideEffects","controlId","sEntityType","requestSideEffects","pathExpressions","logRequest","requestSideEffectsForODataAction","promises","triggerActions","Promise","all","resolve","requestSideEffectsForNavigationProperty","navigationProperty","ignoreTriggerActions","baseEntityType","navigationPath","sideEffectsTargets","filter","annotationName","some","navigation","$NavigationPropertyPath","propertyPath","startsWith","replace","sAnnotationName","concat","sideEffectsTargetDefinition","removeDuplicateTargets","catch","Log","getControlEntitySideEffects","getSideEffectWhereEntityIsSource","eventName","computeFieldGroupIds","sourceProperty","entityFieldGroupIds","sideEffectInfo","getFieldGroupIdForSideEffect","getSideEffectWherePropertyIsSource","registerTargetCallback","target","callback","deregisterTargetCallback","getRegisteredCallback","addTextProperties","setOfProperties","Set","setOfEntities","dataModelPropertyPath","getDataModelPropertiesFromAPath","associatedTextPath","getAssociatedTextPropertyPath","addTextProperty","Array","from","dataModelTextPath","enhanceDataModelPath","relativeNavigation","targetEntitySet","getTargetNavigationPath","targetPath","getTargetObjectPath","isAssociatedTextListedInSideEffectTargets","isPropertyAssociatedTextOnDifferentEntitySet","add","isProperty","has","navigationProperties","convertSideEffects","bindingParameter","TriggerAction","newSideEffects","convertSideEffectsFormat","removeBindingParameter","formatProperties","reduce","isPropertyPathExpression","value","formatEntities","targetEntity","SourceProperties","SourceEntities","SourceEvents","TargetProperties","TargetEntities","dataModelObjectPaths","propertyRelativePath","testEntityTypeName","match","testEntityType","resolvePath","entitySet","entitySets","find","relatedEntitySet","singletons","singleton","entitySetContext","createBindingContext","dataModelEntitySet","dataModelObjectPath","isComplexType","isEntityType","entityProperty","destroy","getSideEffectsFromSource","bindingAlias","isSourceEntityType","commonAnnotation","parameters","parameter","type","getSideEffectsAnnotationFromSource","sideEffectAnno","isSideEffectsAnnotation","$Type","targetPaths","paths","debug","bindingParameterName","replaceBindingParameter","targetProperty","targetEntitiesPaths","uniqueTargetedEntitiesPath","uniqueTargetProperties","uniqueTargetedEntities","entityPath","oDataSideEffect","sideEffectsSources","sideEffectDefinition","mapSideEffectSourceEntities","mapSideEffectSourceProperties","mapSideEffectSourceEvents","sourceEntity","$target","hasUniqueSourceProperty","sourceEvent","toString","isImmediate","sideEffectWithQualifier","getInterface","Service","SideEffectsServiceFactory","_ServiceFactory","_proto2","createInstance","oServiceContext","SideEffectsServiceService","ServiceFactory"],"sources":["./SideEffectsServiceFactory.ts"],"sourcesContent":["import type {\n\tAction,\n\tConvertedMetadata,\n\tEntitySet,\n\tEntityType,\n\tNavigationProperty,\n\tNavigationPropertyPath,\n\tProperty,\n\tPropertyPath\n} from \"@sap-ux/vocabularies-types\";\nimport type * as Edm from \"@sap-ux/vocabularies-types/Edm\";\nimport type { PathAnnotationExpression } from \"@sap-ux/vocabularies-types/Edm\";\nimport type { SideEffectsType as CommonSideEffectsType } from \"@sap-ux/vocabularies-types/vocabularies/Common\";\nimport { CommonAnnotationTypes } from \"@sap-ux/vocabularies-types/vocabularies/Common\";\nimport type { PropertyAnnotations_Common } from \"@sap-ux/vocabularies-types/vocabularies/Common_Edm\";\nimport Log from \"sap/base/Log\";\nimport type PageController from \"sap/fe/core/PageController\";\nimport type {\n\tSideEffectsEventsInteractionManifestSetting,\n\tSideEffectsEventsInteractionType\n} from \"sap/fe/core/converters/ManifestSettings\";\nimport * as MetaModelConverter from \"sap/fe/core/converters/MetaModelConverter\";\nimport { convertTypes, getInvolvedDataModelObjects } from \"sap/fe/core/converters/MetaModelConverter\";\nimport { getResourceModel } from \"sap/fe/core/helpers/ResourceModelHelper\";\nimport {\n\tisComplexType,\n\tisEntitySet,\n\tisEntityType,\n\tisNavigationProperty,\n\tisProperty,\n\tisPropertyPathExpression\n} from \"sap/fe/core/helpers/TypeGuards\";\nimport { ChannelType, WEBSOCKET_STATUS, createWebSocket, getWebSocketBaseUrl, getWebSocketChannelUrl } from \"sap/fe/core/helpers/WebSocket\";\nimport { getAssociatedTextPropertyPath } from \"sap/fe/core/templating/PropertyHelper\";\nimport MessageBox from \"sap/m/MessageBox\";\nimport type Event from \"sap/ui/base/Event\";\nimport type Control from \"sap/ui/core/Control\";\nimport Service from \"sap/ui/core/service/Service\";\nimport ServiceFactory from \"sap/ui/core/service/ServiceFactory\";\nimport type SapPcpWebSocket from \"sap/ui/core/ws/SapPcpWebSocket\";\nimport type { WebSocket$CloseEvent, WebSocket$MessageEvent } from \"sap/ui/core/ws/WebSocket\";\nimport type { default as Context } from \"sap/ui/model/odata/v4/Context\";\nimport type ODataMetaModel from \"sap/ui/model/odata/v4/ODataMetaModel\";\nimport type ODataModel from \"sap/ui/model/odata/v4/ODataModel\";\nimport type { ServiceContext } from \"types/metamodel_types\";\nimport type AppComponent from \"../AppComponent\";\nimport type { DataModelObjectPath } from \"../templating/DataModelPathHelper\";\nimport { enhanceDataModelPath, getTargetNavigationPath, getTargetObjectPath } from \"../templating/DataModelPathHelper\";\nimport type { EnvironmentCapabilities, EnvironmentCapabilitiesService } from \"./EnvironmentServiceFactory\";\n\nexport type PropertyAnnotationsWithRecommendation = PropertyAnnotations_Common & {\n\tRecommendationRole?: string;\n};\n\ntype SideEffectsSettings = {};\n\nexport type SideEffectsEntityType = {\n\t$NavigationPropertyPath: string;\n};\nexport type SideEffectsTarget = SideEffectsEntityType | string;\n\nexport type SideEffectsTargetType = {\n\ttargetProperties: string[];\n\ttargetEntities: SideEffectsEntityType[];\n};\n\ntype BaseSideEffectsType = {\n\tsourceProperties?: string[];\n\tsourceEntities?: SideEffectsEntityType[];\n\tsourceEvents?: string[];\n\tfullyQualifiedName: string;\n} & SideEffectsTargetType;\n\nexport type ODataSideEffectsType = BaseSideEffectsType & {\n\ttriggerAction?: string;\n};\n\nexport type ActionSideEffectsType = {\n\tpathExpressions?: SideEffectsTarget[];\n\ttriggerActions?: string[];\n};\n\nexport type ControlSideEffectsType = Partial<BaseSideEffectsType> & {\n\tfullyQualifiedName: string;\n\tsourceProperties: string[];\n\tsourceControlId: string;\n};\n\nexport type SideEffectsType = ControlSideEffectsType | ODataSideEffectsType;\n\n//TODO fix this type in the ux vocabularies\n//TODO: Source Events are still experimental, remove once public\ntype CommonSideEffectTypeWithQualifier = CommonSideEffectsType & { qualifier?: string; SourceEvents?: Edm.String[] };\n\nexport type SideEffectInfoForSource = { entity: string; qualifier?: string; hasUniqueSourceProperty?: boolean };\n\ntype SideEffectsOriginRegistry = {\n\toData: {\n\t\tentities: {\n\t\t\t[entity: string]: Record<string, ODataSideEffectsType>;\n\t\t};\n\t\tactions: {\n\t\t\tboundActions: {\n\t\t\t\t[entity: string]: Record<string, ActionSideEffectsType>;\n\t\t\t};\n\t\t\tunBoundActions: {\n\t\t\t\t[action: string]: ActionSideEffectsType;\n\t\t\t};\n\t\t};\n\t};\n\tcontrol: {\n\t\t[entity: string]: Record<string, ControlSideEffectsType>;\n\t};\n};\n\ntype RecommendationsRoles = {\n\tinput: string[];\n\toutput: string[];\n\trequired?: string[];\n};\n\nexport type RecommendationsRegistry = {\n\troles: Record<string, RecommendationsRoles>;\n};\n\ntype WebSocketMessage = {\n\tserverAction: \"RaiseSideEffect\";\n\tsideEffectEventName: string;\n\tsideEffectSource: string;\n};\n\nexport class SideEffectsService extends Service<SideEffectsSettings> {\n\tappComponent!: AppComponent;\n\n\tprivate sideEffectsRegistry!: SideEffectsOriginRegistry;\n\n\tprivate recommendationRegistry!: RecommendationsRegistry;\n\n\tprivate capabilities!: EnvironmentCapabilities | undefined;\n\n\tprivate sourcesToSideEffectMappings!: {\n\t\tentities: Record<string, SideEffectInfoForSource[]>;\n\t\tproperties: Record<string, SideEffectInfoForSource[]>;\n\t\tevents: Record<string, SideEffectInfoForSource[]>;\n\t};\n\n\t// Callback methods to be called whenever a side effect target is hit\n\tprivate targetCallbacks!: Record<string, Function>;\n\n\t// WebSocket connection to retrieve SideEffects events\n\tprivate webSocket?: SapPcpWebSocket;\n\n\tprivate containerName?: string;\n\n\tprivate containerRegexPattern!: RegExp;\n\n\tprivate entityTypeRegexPattern!: RegExp;\n\n\tprivate webSocketStatus!: WEBSOCKET_STATUS;\n\t// Interaction type for SideEffects events\n\tprivate interactionTypeDefinition?: SideEffectsEventsInteractionManifestSetting;\n\n\t// !: means that we know it will be assigned before usage\n\tinit(): void {\n\t\tconst context = this.getContext();\n\t\tthis.appComponent = context?.scopeObject as AppComponent;\n\t\tthis.sideEffectsRegistry = {\n\t\t\toData: {\n\t\t\t\tentities: {},\n\t\t\t\tactions: {\n\t\t\t\t\tboundActions: {},\n\t\t\t\t\tunBoundActions: {}\n\t\t\t\t}\n\t\t\t},\n\t\t\tcontrol: {}\n\t\t};\n\n\t\tthis.recommendationRegistry = {\n\t\t\troles: {}\n\t\t};\n\t\tthis.targetCallbacks = {};\n\t}\n\n\t/**\n\t * Connects to a given WebSocket connection to retrieve SideEffects events.\n\t *\n\t */\n\tinitializeWebSocketConnection(): void {\n\t\tconst model = this.appComponent.getModel();\n\t\tconst url = getWebSocketBaseUrl(model);\n\t\tconst channel = getWebSocketChannelUrl(ChannelType.SideEffectsEvents, model);\n\n\t\tif (url && channel) {\n\t\t\tthis.webSocket = createWebSocket(ChannelType.SideEffectsEvents, model);\n\t\t\tthis.webSocket.attachMessage(this.onSideEffectsEventReceived.bind(this));\n\t\t\tthis.webSocketStatus = WEBSOCKET_STATUS.CONNECTED;\n\n\t\t\tconst showConnectionLostDialog = (): void => {\n\t\t\t\tif ([WEBSOCKET_STATUS.CLOSED, WEBSOCKET_STATUS.ERROR].includes(this.webSocketStatus)) {\n\t\t\t\t\tconst resourceModel = getResourceModel(this.appComponent);\n\t\t\t\t\tconst lostOfConnectionText = resourceModel.getText(\"C_SIDEEFFECT_CONNECTION_LOST\");\n\n\t\t\t\t\tMessageBox.warning(lostOfConnectionText, {\n\t\t\t\t\t\tactions: [MessageBox.Action.OK],\n\t\t\t\t\t\temphasizedAction: MessageBox.Action.OK\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tthis.webSocket.attachError(() => {\n\t\t\t\tthis.webSocketStatus = WEBSOCKET_STATUS.ERROR;\n\t\t\t\tshowConnectionLostDialog();\n\t\t\t});\n\n\t\t\tthis.webSocket.attachClose((evt: WebSocket$CloseEvent) => {\n\t\t\t\tif (this.webSocketStatus === WEBSOCKET_STATUS.ERROR) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthis.webSocketStatus = WEBSOCKET_STATUS.CLOSED;\n\t\t\t\t// RFC 6455 defines the status codes when closing an established connection :  https://datatracker.ietf.org/doc/html/rfc6455#section-7.4\n\t\t\t\t// status code 1000 means normal closure\n\t\t\t\tif ((evt.getParameter(\"code\") as number | undefined) !== 1000) {\n\t\t\t\t\tshowConnectionLostDialog();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * This method is called whenever the connected WebSocket sends a message.\n\t * @param event The event with the relevant sideEffect information\n\t */\n\tasync onSideEffectsEventReceived(event: WebSocket$MessageEvent & Event<{ pcpFields?: WebSocketMessage }>): Promise<void> {\n\t\tconst message = event.getParameter(\"pcpFields\");\n\n\t\tif (message?.serverAction !== \"RaiseSideEffect\" || !message.sideEffectEventName || !message.sideEffectSource) {\n\t\t\t// message is not relevant\n\t\t\treturn;\n\t\t}\n\n\t\tconst metaPath = this.getMetaModel().getMetaContext(message.sideEffectSource);\n\t\tconst dataModel = MetaModelConverter.getInvolvedDataModelObjects(metaPath);\n\t\tconst relevantSideEffects = this.getSideEffectWhereEventIsSource(\n\t\t\tdataModel.targetEntityType.fullyQualifiedName,\n\t\t\tmessage.sideEffectEventName\n\t\t);\n\n\t\tif (relevantSideEffects.length === 0) {\n\t\t\t// no side effect for this source\n\t\t\treturn;\n\t\t}\n\n\t\tconst relevantPages: PageController[] = [];\n\t\tconst pages = this.appComponent.getRootViewController().getVisibleViews();\n\t\tfor (const page of pages) {\n\t\t\tconst pageController = page.getController();\n\t\t\tif (\n\t\t\t\tpageController.isA<PageController>(\"sap.fe.core.PageController\") &&\n\t\t\t\tpageController._sideEffects.isDataPathRelevant(message.sideEffectSource, message.sideEffectEventName)\n\t\t\t) {\n\t\t\t\trelevantPages.push(pageController);\n\t\t\t}\n\t\t}\n\n\t\tif (relevantPages.length === 0) {\n\t\t\t// no relevant page found for this source\n\t\t\treturn;\n\t\t}\n\n\t\t// we ask the user to confirm the refresh or notify the user, we use the most specific page\n\t\tconst sideEffectsControllerExtension = relevantPages[relevantPages.length - 1]._sideEffects;\n\t\tconst onlyRecommendations = this.isOnlyRecommendations(dataModel, relevantSideEffects);\n\t\tconst interactionType = this.getSideEffectsInteractionType(message.sideEffectEventName, onlyRecommendations);\n\n\t\tswitch (interactionType) {\n\t\t\tcase \"Confirmation\":\n\t\t\t\ttry {\n\t\t\t\t\tawait sideEffectsControllerExtension.confirmDataRefresh();\n\t\t\t\t} catch (error) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase \"Notification\":\n\t\t\t\tsideEffectsControllerExtension.notifyDataRefresh();\n\t\t\t\tbreak;\n\t\t\tcase \"None\":\n\t\t\t\tbreak;\n\t\t}\n\n\t\t// now refresh the pages, forward this task to the side effects controller extensions to allow overriding per page (i.e. LR)\n\t\tfor (const page of relevantPages) {\n\t\t\tawait page._sideEffects.requestSideEffectsForEvent(message.sideEffectEventName, message.sideEffectSource);\n\t\t}\n\t}\n\n\t/**\n\t * Check if only recommendations are defined for a specific event.\n\t * @param dataModel The data model object path\n\t * @param relevantSideEffects The relevant side effects for the source\n\t * @returns True if only recommendations are defined for the event\n\t */\n\tisOnlyRecommendations(dataModel: DataModelObjectPath<unknown>, relevantSideEffects: SideEffectInfoForSource[]): boolean {\n\t\tconst recommendationPath = (\n\t\t\tdataModel.targetEntityType.annotations.UI?.Recommendations as PathAnnotationExpression<string> | undefined\n\t\t)?.path;\n\t\tfor (const sideEffect of relevantSideEffects) {\n\t\t\tconst annotation =\n\t\t\t\tthis.sideEffectsRegistry.oData.entities[dataModel.targetEntityType.fullyQualifiedName]?.[\n\t\t\t\t\t`${sideEffect.entity}@com.sap.vocabularies.Common.v1.SideEffects#${sideEffect.qualifier}`\n\t\t\t\t];\n\t\t\t// check if the side effect is only a recommendation\n\t\t\tif (\n\t\t\t\tannotation?.targetProperties.length === 1 &&\n\t\t\t\tannotation?.targetEntities.length === 0 &&\n\t\t\t\tannotation?.targetProperties[0] === recommendationPath\n\t\t\t) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Retrieve the side effects interaction type from the manifest.\n\t *  @param event The side effects event name\n\t *  @param onlyRecommendations Indicator if only recommendations are shown\n\t * @returns The side effects interaction type\n\t */\n\tgetSideEffectsInteractionType(event: string, onlyRecommendations = false): SideEffectsEventsInteractionType {\n\t\tif (!this.interactionTypeDefinition) {\n\t\t\tthis.interactionTypeDefinition = this.appComponent.getManifestEntry(\"sap.fe\")?.app?.sideEffectsEventsInteractionType;\n\t\t}\n\t\tif (onlyRecommendations) {\n\t\t\t// In case of only recommendations, we do not show any notification\n\t\t\treturn \"None\";\n\t\t}\n\n\t\tif (typeof this.interactionTypeDefinition === \"string\") {\n\t\t\t// a global interaction type is defined\n\t\t\treturn this.interactionTypeDefinition;\n\t\t}\n\n\t\tif (event && this.interactionTypeDefinition?.events?.[event]) {\n\t\t\t// an interaction type is defined for the event\n\t\t\treturn this.interactionTypeDefinition.events[event];\n\t\t}\n\n\t\tif (this.interactionTypeDefinition?.default) {\n\t\t\t// a default interaction type is defined for the event\n\t\t\treturn this.interactionTypeDefinition.default;\n\t\t}\n\n\t\treturn \"Notification\";\n\t}\n\n\t/**\n\t * Adds a SideEffects control\n\t * SideEffects definition is added by a control to keep data up to date\n\t * These SideEffects get limited scope compared with SideEffects coming from an OData service:\n\t * - Only one SideEffects definition can be defined for the combination entity type - control Id\n\t * - Only SideEffects source properties are recognized and used to trigger SideEffects\n\t *\n\t * Ensure the sourceControlId matches the associated SAPUI5 control ID.\n\t * @param entityType Name of the entity type\n\t * @param sideEffect SideEffects definition\n\t */\n\tpublic addControlSideEffects(entityType: string, sideEffect: Omit<ControlSideEffectsType, \"fullyQualifiedName\">): void {\n\t\tif (sideEffect.sourceControlId) {\n\t\t\tconst controlSideEffect: ControlSideEffectsType = {\n\t\t\t\t...sideEffect,\n\t\t\t\tfullyQualifiedName: `${entityType}/SideEffectsForControl/${sideEffect.sourceControlId}`\n\t\t\t};\n\t\t\tconst entityControlSideEffects = this.sideEffectsRegistry.control[entityType] || {};\n\t\t\tentityControlSideEffects[controlSideEffect.sourceControlId] = controlSideEffect;\n\t\t\tthis.sideEffectsRegistry.control[entityType] = entityControlSideEffects;\n\t\t}\n\t}\n\n\t/**\n\t * Executes SideEffects action.\n\t * @param triggerAction Name of the action\n\t * @param context Context\n\t * @param options Options for action execution\n\t * @param options.groupId The group ID to be used for the request\n\t * @param options.submitBatch If true, the $batch is submitted right after adding the action to it. Default is true.\n\t * @returns A promise that is resolved without data or with a return value context when the action call succeeds\n\t */\n\tpublic async executeAction(\n\t\ttriggerAction: string,\n\t\tcontext: Context,\n\t\toptions?: {\n\t\t\tgroupId?: string;\n\t\t\tsubmitBatch?: boolean;\n\t\t}\n\t): Promise<void> {\n\t\tconst action = context.getModel().bindContext(`${triggerAction}(...)`, context);\n\t\tconst executionOptions = options ?? {};\n\t\tconst groupId = executionOptions.groupId || context.getBinding().getUpdateGroupId();\n\t\t// the triggerAction is executed in same $batch but different changeset\n\t\tif (executionOptions.submitBatch != false) {\n\t\t\tcontext.getModel().submitBatch(groupId);\n\t\t}\n\t\tawait action.execute(groupId, true);\n\t}\n\n\t/**\n\t * Gets converted OData metaModel.\n\t * @returns Converted OData metaModel\n\t */\n\tpublic getConvertedMetaModel(): ConvertedMetadata {\n\t\treturn convertTypes(this.getMetaModel(), this.capabilities);\n\t}\n\n\t/**\n\t * Gets the entity type of a context.\n\t * @param context Context\n\t * @returns Entity Type\n\t */\n\tpublic getEntityTypeFromContext(context: Context): string | undefined {\n\t\tconst metaModel = context.getModel().getMetaModel(),\n\t\t\tmetaPath = metaModel.getMetaPath(context.getPath()),\n\t\t\tentityType = metaModel.getObject(metaPath)[\"$Type\"];\n\t\treturn entityType;\n\t}\n\n\t/**\n\t * Gets the SideEffects that come from an OData service.\n\t * @param entityTypeName Name of the entity type\n\t * @returns SideEffects dictionary\n\t */\n\tpublic getODataEntitySideEffects(entityTypeName: string): Record<string, ODataSideEffectsType> {\n\t\treturn this.sideEffectsRegistry.oData.entities[entityTypeName] || {};\n\t}\n\n\t/**\n\t * Is a SideEffects generated by a control.\n\t * @param sideEffects The SideEffects\n\t * @returns True if the SideEffects is generated by a control, otherwise false\n\t */\n\tpublic isControlSideEffects(sideEffects: SideEffectsType): sideEffects is ControlSideEffectsType {\n\t\treturn !!(sideEffects as ControlSideEffectsType).sourceControlId;\n\t}\n\n\t/**\n\t * Gets the global SideEffects that come from an OData service.\n\t * @param entityTypeName Name of the entity type\n\t * @returns Global SideEffects\n\t */\n\tpublic getGlobalODataEntitySideEffects(entityTypeName: string): ODataSideEffectsType[] {\n\t\tconst entitySideEffects = this.getODataEntitySideEffects(entityTypeName);\n\t\tconst globalSideEffects: ODataSideEffectsType[] = [];\n\t\tfor (const key in entitySideEffects) {\n\t\t\tconst sideEffects = entitySideEffects[key];\n\t\t\tif (!sideEffects.sourceEntities && !sideEffects.sourceProperties && !sideEffects.sourceEvents) {\n\t\t\t\tglobalSideEffects.push(sideEffects);\n\t\t\t}\n\t\t}\n\t\treturn globalSideEffects;\n\t}\n\n\t/**\n\t * Gets the SideEffects that come from an OData service.\n\t * @param actionName Name of the action\n\t * @param context Context\n\t * @returns SideEffects definition\n\t */\n\tpublic getODataActionSideEffects(actionName: string, context?: Context): ActionSideEffectsType | undefined {\n\t\tif (context) {\n\t\t\tconst entityType = this.getEntityTypeFromContext(context);\n\t\t\tif (entityType) {\n\t\t\t\treturn this.sideEffectsRegistry.oData.actions.boundActions[entityType]?.[actionName];\n\t\t\t}\n\t\t} else {\n\t\t\treturn this.sideEffectsRegistry.oData.actions.unBoundActions?.[actionName];\n\t\t}\n\t\treturn undefined;\n\t}\n\n\t/**\n\t * Gets the SideEffects for the context and the event.\n\t * @param context The context of the SideEffects\n\t * @param event The SideEffects of the event\n\t * @returns An array containing the SideEffects matching with the context and the event\n\t */\n\tpublic getODataSideEffectsFromContextEvent(context: Context, event: string): ODataSideEffectsType[] {\n\t\tconst metaPath = context.getModel().getMetaModel().getMetaContext(context.getPath());\n\t\tconst dataModel = getInvolvedDataModelObjects(metaPath);\n\t\tconst sideEffectsInfo = this.getSideEffectWhereEventIsSource(dataModel.targetEntityType.fullyQualifiedName, event);\n\t\treturn sideEffectsInfo.map(\n\t\t\t(sideEffect) =>\n\t\t\t\tthis.sideEffectsRegistry.oData.entities[dataModel.targetEntityType.fullyQualifiedName]?.[\n\t\t\t\t\t`${sideEffect.entity}@com.sap.vocabularies.Common.v1.SideEffects#${sideEffect.qualifier}`\n\t\t\t\t]\n\t\t);\n\t}\n\n\t/**\n\t * Generates the dictionary for the SideEffects.\n\t *  @returns Promise resolving with the SideEffects service once data has been written\n\t */\n\tasync initialize(): Promise<this> {\n\t\tconst sideEffectSources: {\n\t\t\tentities: Record<string, SideEffectInfoForSource[]>;\n\t\t\tproperties: Record<string, SideEffectInfoForSource[]>;\n\t\t\tevents: Record<string, SideEffectInfoForSource[]>;\n\t\t} = {\n\t\t\tentities: {},\n\t\t\tproperties: {},\n\t\t\tevents: {}\n\t\t};\n\t\tconst environmentCapabilitiesService = (await this.appComponent.getService(\n\t\t\t\"environmentCapabilities\"\n\t\t)) as EnvironmentCapabilitiesService;\n\t\tconst model = this.appComponent.getModel();\n\t\tif (model?.isA?.<ODataModel>(\"sap.ui.model.odata.v4.ODataModel\")) {\n\t\t\t// We need to wait for the MetaModel to be requested\n\t\t\tawait model.getMetaModel().requestObject(\"/$EntityContainer/\");\n\t\t\tthis.capabilities = environmentCapabilitiesService.getCapabilities();\n\n\t\t\tconst convertedMetaModel = this.getConvertedMetaModel();\n\t\t\tthis.containerName = convertedMetaModel.entityContainer.fullyQualifiedName;\n\t\t\tthis.containerRegexPattern = new RegExp(`^\\\\/${this.containerName}\\\\/[^/]+\\\\/(.+)?$`);\n\t\t\tthis.entityTypeRegexPattern = new RegExp(`^/${this.containerName}/([^/]+)`);\n\t\t\tconvertedMetaModel.entityTypes.forEach((entityType: EntityType) => {\n\t\t\t\tthis.mapFieldAnnotations(entityType);\n\t\t\t\tthis.sideEffectsRegistry.oData.entities[entityType.fullyQualifiedName] = this.retrieveODataEntitySideEffects(entityType);\n\t\t\t\tthis.mapSideEffectSources(entityType, sideEffectSources);\n\t\t\t});\n\t\t\tconvertedMetaModel.actions.forEach((action: Action) => {\n\t\t\t\tif (action.isBound) {\n\t\t\t\t\tthis.sideEffectsRegistry.oData.actions.boundActions[action.sourceEntityType!.fullyQualifiedName] = {\n\t\t\t\t\t\t...this.sideEffectsRegistry.oData.actions.boundActions[action.sourceEntityType!.fullyQualifiedName],\n\t\t\t\t\t\t...this.retrieveODataActionsSideEffects(action)\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tthis.sideEffectsRegistry.oData.actions.unBoundActions = {\n\t\t\t\t\t\t...this.sideEffectsRegistry.oData.actions.unBoundActions,\n\t\t\t\t\t\t...this.retrieveODataActionsSideEffects(action)\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t});\n\t\t\tif (Object.keys(sideEffectSources.events).length > 0) {\n\t\t\t\tthis.initializeWebSocketConnection();\n\t\t\t}\n\t\t}\n\t\tthis.sourcesToSideEffectMappings = sideEffectSources;\n\t\treturn this;\n\t}\n\n\tprivate mapFieldAnnotations(source: EntityType): void {\n\t\tconst addRecommendationRoles = (sourceName: string): void => {\n\t\t\tif (!this.recommendationRegistry.roles.hasOwnProperty(`${sourceName}`)) {\n\t\t\t\tthis.recommendationRegistry.roles[`${sourceName}`] = {\n\t\t\t\t\tinput: [],\n\t\t\t\t\toutput: []\n\t\t\t\t};\n\t\t\t}\n\t\t};\n\t\tsource.entityProperties.forEach((property) => {\n\t\t\tconst commonAnno = property.annotations.Common as PropertyAnnotationsWithRecommendation;\n\t\t\tif (commonAnno?.RecommendationRole) {\n\t\t\t\tconst roleType = commonAnno.RecommendationRole;\n\t\t\t\tif (roleType.valueOf().includes(\"Input\")) {\n\t\t\t\t\taddRecommendationRoles(`${source.name}`);\n\t\t\t\t\tthis.recommendationRegistry.roles[`${source.name}`].input.push(property.name);\n\t\t\t\t}\n\t\t\t\tif (roleType.valueOf().includes(\"Output\")) {\n\t\t\t\t\taddRecommendationRoles(`${source.name}`);\n\t\t\t\t\tthis.recommendationRegistry.roles[`${source.name}`].output.push(property.name);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tpublic getRecommendationsMapping(): RecommendationsRegistry {\n\t\treturn this.recommendationRegistry;\n\t}\n\n\t/**\n\t * This function will return true if field is part of Recommendation's input mapping and from the same entity.\n\t * Otherwise return false.\n\t * @param field\n\t * @returns True if field is has recommendation role - Input annotation\n\t */\n\tpublic checkIfFieldIsRecommendationRelevant(field: Control): boolean {\n\t\tconst context = field.getBindingContext();\n\t\tconst propertyName = field.data().sourcePath.split(\"/\").pop();\n\t\tif (context) {\n\t\t\tconst metaModel = context?.getModel().getMetaModel();\n\t\t\tconst metaContext = (metaModel as ODataMetaModel)?.getMetaContext(context.getPath());\n\t\t\tconst targetDataModelObject = MetaModelConverter.getInvolvedDataModelObjects<EntitySet | NavigationProperty>(metaContext)\n\t\t\t\t.targetObject!;\n\t\t\tlet targetEntityTypeName;\n\t\t\tif (isEntitySet(targetDataModelObject)) {\n\t\t\t\ttargetEntityTypeName = targetDataModelObject.entityType?.name;\n\t\t\t} else if (isNavigationProperty(targetDataModelObject)) {\n\t\t\t\ttargetEntityTypeName = targetDataModelObject.targetType?.name;\n\t\t\t}\n\t\t\tconst recommendationRolesForEntity = targetEntityTypeName && this.recommendationRegistry.roles[targetEntityTypeName];\n\t\t\tif (recommendationRolesForEntity && recommendationRolesForEntity?.input?.includes(propertyName)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Method returns the properties in a specific entity type which are marked as RecommendationRole Output.\n\t * @param entityTypeName Entity type for which recommendation Output fields needs to be figured\n\t * @returns Array of property names which are marked RecommendationRole Output\n\t */\n\tpublic getRecommendationOutputFields(entityTypeName: string): string[] {\n\t\t//TODO: We have to consider 1:1 navigation properties as well.\n\t\tconst recommendationRolesForEntity = this.recommendationRegistry.roles[entityTypeName];\n\t\tif (recommendationRolesForEntity?.output?.length > 0) {\n\t\t\treturn recommendationRolesForEntity.output;\n\t\t}\n\n\t\treturn [];\n\t}\n\n\t/**\n\t * Removes all SideEffects related to a control.\n\t * @param controlId Control Id\n\t */\n\tpublic removeControlSideEffects(controlId: string): void {\n\t\tObject.keys(this.sideEffectsRegistry.control).forEach((sEntityType) => {\n\t\t\tif (this.sideEffectsRegistry.control[sEntityType][controlId]) {\n\t\t\t\tdelete this.sideEffectsRegistry.control[sEntityType][controlId];\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Requests the SideEffects on a specific context.\n\t * @param pathExpressions Targets of SideEffects to be executed\n\t * @param context Context where SideEffects need to be executed\n\t * @param groupId The group ID to be used for the request\n\t * @returns Promise on SideEffects request\n\t */\n\tpublic async requestSideEffects(pathExpressions: SideEffectsTarget[], context: Context, groupId?: string): Promise<void> {\n\t\tif (pathExpressions.length) {\n\t\t\tthis.logRequest(pathExpressions, context);\n\t\t\tawait context.requestSideEffects(pathExpressions, groupId);\n\t\t}\n\t}\n\n\t/**\n\t * Requests the SideEffects for an OData action.\n\t * @param sideEffects SideEffects definition\n\t * @param context Context where SideEffects need to be executed\n\t * @returns Promise on SideEffects requests and action execution\n\t */\n\tpublic async requestSideEffectsForODataAction(sideEffects: ActionSideEffectsType, context: Context): Promise<(void | undefined)[]> {\n\t\tlet promises: Promise<void | undefined>[];\n\n\t\tif (sideEffects.triggerActions?.length) {\n\t\t\tpromises = sideEffects.triggerActions.map(async (actionName): Promise<void> => {\n\t\t\t\treturn this.executeAction(actionName, context);\n\t\t\t});\n\t\t} else {\n\t\t\tpromises = [];\n\t\t}\n\n\t\tif (sideEffects.pathExpressions?.length) {\n\t\t\tpromises.push(this.requestSideEffects(sideEffects.pathExpressions, context));\n\t\t}\n\n\t\treturn promises.length ? Promise.all(promises) : Promise.resolve([]);\n\t}\n\n\t/**\n\t * Requests the SideEffects for a navigation property on a specific context.\n\t * @param navigationProperty Navigation property\n\t * @param context Context where SideEffects need to be executed\n\t * @param groupId Batch group for the query\n\t * @param ignoreTriggerActions If true, we do not trigger actions defined in the side effect\n\t * @returns SideEffects request on SAPUI5 context\n\t */\n\tpublic async requestSideEffectsForNavigationProperty(\n\t\tnavigationProperty: string,\n\t\tcontext: Context,\n\t\tgroupId?: string,\n\t\tignoreTriggerActions = false\n\t): Promise<void | undefined> {\n\t\tconst baseEntityType = this.getEntityTypeFromContext(context);\n\t\tif (baseEntityType) {\n\t\t\tconst navigationPath = `${navigationProperty}/`;\n\t\t\tconst entitySideEffects = this.getODataEntitySideEffects(baseEntityType);\n\t\t\tlet targetProperties: string[] = [];\n\t\t\tlet targetEntities: SideEffectsEntityType[] = [];\n\t\t\tlet sideEffectsTargets: SideEffectsTarget[] = [];\n\t\t\tObject.keys(entitySideEffects)\n\t\t\t\t.filter(\n\t\t\t\t\t// Keep relevant SideEffects\n\t\t\t\t\t// 1. SourceEntities match OR\n\t\t\t\t\t// 2. Only 1 SourceProperties and match\n\t\t\t\t\t(annotationName) => {\n\t\t\t\t\t\tconst sideEffects: ODataSideEffectsType = entitySideEffects[annotationName];\n\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t(sideEffects.sourceEntities || []).some(\n\t\t\t\t\t\t\t\t(navigation) => navigation.$NavigationPropertyPath === navigationProperty\n\t\t\t\t\t\t\t) ||\n\t\t\t\t\t\t\t(sideEffects.sourceProperties?.length === 1 &&\n\t\t\t\t\t\t\t\tsideEffects.sourceProperties.some(\n\t\t\t\t\t\t\t\t\t(propertyPath) =>\n\t\t\t\t\t\t\t\t\t\tpropertyPath.startsWith(navigationPath) && !propertyPath.replace(navigationPath, \"\").includes(\"/\")\n\t\t\t\t\t\t\t\t))\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t)\n\t\t\t\t.forEach((sAnnotationName) => {\n\t\t\t\t\tconst sideEffects = entitySideEffects[sAnnotationName];\n\t\t\t\t\tif (sideEffects.triggerAction && !ignoreTriggerActions) {\n\t\t\t\t\t\tthis.executeAction(sideEffects.triggerAction, context, { groupId });\n\t\t\t\t\t}\n\t\t\t\t\ttargetProperties = targetProperties.concat(sideEffects.targetProperties);\n\t\t\t\t\ttargetEntities = targetEntities.concat(sideEffects.targetEntities);\n\t\t\t\t});\n\t\t\t// Remove duplicate targets\n\t\t\tconst sideEffectsTargetDefinition = this.removeDuplicateTargets({\n\t\t\t\ttargetProperties: targetProperties,\n\t\t\t\ttargetEntities: targetEntities\n\t\t\t});\n\t\t\tsideEffectsTargets = [...sideEffectsTargetDefinition.targetProperties, ...sideEffectsTargetDefinition.targetEntities];\n\t\t\tif (sideEffectsTargets.length) {\n\t\t\t\treturn this.requestSideEffects(sideEffectsTargets, context, groupId).catch((error) =>\n\t\t\t\t\tLog.error(`SideEffects - Error while processing SideEffects for Navigation Property ${navigationProperty}`, error)\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * Gets the SideEffects that come from controls.\n\t * @param entityTypeName Entity type Name\n\t * @returns SideEffects dictionary\n\t */\n\tpublic getControlEntitySideEffects(entityTypeName: string): Record<string, ControlSideEffectsType> {\n\t\treturn this.sideEffectsRegistry.control[entityTypeName] || {};\n\t}\n\n\t/**\n\t * Gets SideEffects' qualifier and owner entity where this entity is used as source.\n\t * @param entityTypeName Entity type fully qualified name\n\t * @returns Array of sideEffects info\n\t */\n\tpublic getSideEffectWhereEntityIsSource(entityTypeName: string): SideEffectInfoForSource[] {\n\t\treturn this.sourcesToSideEffectMappings.entities[entityTypeName] || [];\n\t}\n\n\t/**\n\t * Gets SideEffects' qualifiers where this event is used as source.\n\t * @param entityTypeName Entity type fully qualified\n\t * @param eventName Side Effect event name\n\t * @returns Array of sideEffects info\n\t */\n\tpublic getSideEffectWhereEventIsSource(entityTypeName: string, eventName: string): SideEffectInfoForSource[] {\n\t\treturn this.sourcesToSideEffectMappings.events[eventName]?.filter((event) => event.entity === entityTypeName) || [];\n\t}\n\n\t/**\n\t * Requests the SideEffects for a sideEffect event on a specific context.\n\t * @param event SideEffects event which should be\n\t * @param context Context where SideEffects need to be executed\n\t * @param groupId The group ID to be used for the request\n\t * @returns Promise on SideEffects request\n\t */\n\tasync requestSideEffectsForEvent(event: string, context: Context, groupId?: string): Promise<undefined> {\n\t\tconst sideEffects = this.getODataSideEffectsFromContextEvent(context, event);\n\t\tlet targetProperties: string[] = [];\n\t\tlet targetEntities: SideEffectsEntityType[] = [];\n\n\t\tsideEffects.forEach((sideEffect) => {\n\t\t\ttargetProperties = targetProperties.concat(sideEffect.targetProperties);\n\t\t\ttargetEntities = targetEntities.concat(sideEffect.targetEntities);\n\t\t});\n\n\t\tconst sideEffectsTargetDefinition = this.removeDuplicateTargets({\n\t\t\ttargetProperties: targetProperties,\n\t\t\ttargetEntities: targetEntities\n\t\t});\n\t\tconst sideEffectsTargets = [...sideEffectsTargetDefinition.targetProperties, ...sideEffectsTargetDefinition.targetEntities];\n\t\tif (sideEffectsTargets.length) {\n\t\t\ttry {\n\t\t\t\tawait this.requestSideEffects(sideEffectsTargets, context, groupId);\n\t\t\t} catch (error) {\n\t\t\t\tLog.error(`SideEffects - Error while processing SideEffects for Event ${event}`, error as string);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Common method to get the field groupIds for a source entity and a source property.\n\t * @param sourceEntityType\n\t * @param sourceProperty\n\t * @returns A collection of fieldGroupIds\n\t */\n\tpublic computeFieldGroupIds(sourceEntityType: string, sourceProperty: string): string[] {\n\t\tconst entityFieldGroupIds = this.getSideEffectWhereEntityIsSource(sourceEntityType).map((sideEffectInfo) =>\n\t\t\tthis.getFieldGroupIdForSideEffect(sideEffectInfo, true)\n\t\t);\n\t\treturn entityFieldGroupIds.concat(\n\t\t\tthis.getSideEffectWherePropertyIsSource(sourceProperty).map((sideEffectInfo) =>\n\t\t\t\tthis.getFieldGroupIdForSideEffect(sideEffectInfo)\n\t\t\t)\n\t\t);\n\t}\n\n\t/**\n\t * Gets SideEffects' qualifier and owner entity where this property is used as source.\n\t * @param propertyName Property fully qualified name\n\t * @returns Array of sideEffects info\n\t */\n\tpublic getSideEffectWherePropertyIsSource(propertyName: string): SideEffectInfoForSource[] {\n\t\treturn this.sourcesToSideEffectMappings.properties[propertyName] || [];\n\t}\n\n\t// check if can define whether callbacks are async. Otherwise comment\n\t// only one callback for one target\n\tpublic registerTargetCallback(target: string, callback: Function): void {\n\t\tthis.targetCallbacks[target] = callback;\n\t}\n\n\tpublic deregisterTargetCallback(target: string): void {\n\t\tdelete this.targetCallbacks[target];\n\t}\n\n\t// pass parameter\n\tpublic getRegisteredCallback(target: string): Function | undefined {\n\t\treturn this.targetCallbacks[target];\n\t}\n\n\t/**\n\t * Returns updated side effects definition with all text related properties.\n\t * @param sideEffectsTargets The targets of the side effect\n\t * @param entityType Name of the entity where the side effect is registered\n\t * @returns Updated side effects' targets with added text properties or entities\n\t */\n\tprivate addTextProperties(sideEffectsTargets: SideEffectsTargetType, entityType?: EntityType): SideEffectsTargetType {\n\t\tconst setOfProperties = new Set(sideEffectsTargets.targetProperties);\n\t\tconst setOfEntities = new Set(sideEffectsTargets.targetEntities.map((target) => target.$NavigationPropertyPath));\n\t\t// Generate all paths related to the text properties and not already covered by the SideEffects\n\t\tfor (const propertyPath of sideEffectsTargets.targetProperties) {\n\t\t\tfor (const dataModelPropertyPath of this.getDataModelPropertiesFromAPath(propertyPath, entityType)) {\n\t\t\t\tconst associatedTextPath = getAssociatedTextPropertyPath(dataModelPropertyPath.targetObject);\n\t\t\t\tif (associatedTextPath) {\n\t\t\t\t\tthis.addTextProperty(dataModelPropertyPath, propertyPath, associatedTextPath, setOfProperties, setOfEntities);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn {\n\t\t\ttargetProperties: Array.from(setOfProperties),\n\t\t\ttargetEntities: Array.from(setOfEntities).map((navigation) => {\n\t\t\t\treturn { $NavigationPropertyPath: navigation };\n\t\t\t})\n\t\t};\n\t}\n\n\t/**\n\t * Adds text related property to the side effects targets\n\t * If the property has an associated text then this text needs to be added if it's not already reflected in the side effects definition:\n\t * - as targetProperties if the property and its associated text are on the same entitySet\n\t * - as targetEntities if they are defined on different entitySets.\n\t * @param dataModelPropertyPath The model object path of the property\n\t * @param propertyPath The property path\n\t * @param associatedTextPath The associated text property path\n\t * @param setOfProperties Set of existing sideEffect's target properties\n\t * @param setOfEntities Set of existing sideEffect's target entities\n\t */\n\tprivate addTextProperty(\n\t\tdataModelPropertyPath: DataModelObjectPath<Property>,\n\t\tpropertyPath: string,\n\t\tassociatedTextPath: string,\n\t\tsetOfProperties: Set<string>,\n\t\tsetOfEntities: Set<string>\n\t): void {\n\t\tconst dataModelTextPath = enhanceDataModelPath<Property>(dataModelPropertyPath, associatedTextPath);\n\t\tconst relativeNavigation =\n\t\t\tpropertyPath.startsWith(\"/\") &&\n\t\t\tdataModelTextPath.targetEntitySet &&\n\t\t\tdataModelTextPath.targetEntitySet.name !== dataModelPropertyPath.targetEntitySet?.name\n\t\t\t\t? `/${dataModelTextPath.targetEntitySet?.fullyQualifiedName}`\n\t\t\t\t: getTargetNavigationPath(dataModelTextPath, true);\n\t\tconst targetPath = propertyPath.startsWith(\"/\")\n\t\t\t? `/${dataModelTextPath.targetEntitySet?.fullyQualifiedName}/${dataModelTextPath.targetObject!.name}`\n\t\t\t: getTargetObjectPath(dataModelTextPath, true);\n\t\tif (\n\t\t\tthis.isAssociatedTextListedInSideEffectTargets(\n\t\t\t\tdataModelTextPath,\n\t\t\t\trelativeNavigation,\n\t\t\t\ttargetPath,\n\t\t\t\tsetOfProperties,\n\t\t\t\tsetOfEntities\n\t\t\t)\n\t\t) {\n\t\t\tif (this.isPropertyAssociatedTextOnDifferentEntitySet(dataModelPropertyPath, dataModelTextPath)) {\n\t\t\t\tsetOfEntities.add(relativeNavigation);\n\t\t\t} else {\n\t\t\t\tsetOfProperties.add(targetPath);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Checks if the associated text property needs to be added if it's not already reflected in the side effects definition:\n\t * - as targetProperties if the property and its associated text are on the same entitySet\n\t * - as targetEntities if they are defined on different entitySets.\n\t * @param dataModelTextPath The model object path of the associated text\n\t * @param relativeNavigation The navigation to the text property\n\t * @param targetPath The associated text property path\n\t * @param setOfProperties Set of existing sideEffect's target properties\n\t * @param setOfEntities Set of existing sideEffect's target entities\n\t * @returns Updated side effects' targets with added text property or entity\n\t */\n\tprivate isAssociatedTextListedInSideEffectTargets(\n\t\tdataModelTextPath: DataModelObjectPath<Property>,\n\t\trelativeNavigation: string,\n\t\ttargetPath: string,\n\t\tsetOfProperties: Set<string>,\n\t\tsetOfEntities: Set<string>\n\t): boolean {\n\t\treturn (\n\t\t\tisProperty(dataModelTextPath.targetObject) &&\n\t\t\t!setOfProperties.has(targetPath) && // the property is already listed\n\t\t\t!setOfProperties.has(`${relativeNavigation}${dataModelTextPath.navigationProperties.length ? \"/\" : \"\"}*`) && // the property is already listed thanks to the \"*\"\n\t\t\t!setOfEntities.has(`${relativeNavigation}`) // the property is not part of a TargetEntities\n\t\t);\n\t}\n\n\t/**\n\t * Checks if the property and its associated text property are on different entitySet.\n\t * @param dataModelPropertyPath The model object path of the property\n\t * @param dataModelTextPath The model object path of the associated text property\n\t * @returns True if the entitySet is different\n\t */\n\tprivate isPropertyAssociatedTextOnDifferentEntitySet(\n\t\tdataModelPropertyPath: DataModelObjectPath<Property>,\n\t\tdataModelTextPath: DataModelObjectPath<Property>\n\t): boolean {\n\t\treturn (\n\t\t\tdataModelPropertyPath.targetEntitySet !== dataModelTextPath.targetEntitySet &&\n\t\t\t!!dataModelTextPath.navigationProperties &&\n\t\t\t!!dataModelTextPath.targetEntityType\n\t\t);\n\t}\n\n\t/**\n\t * Converts the SideEffects to expected format\n\t * - Set TriggerAction as string\n\t * - Converts SideEffects targets to expected format\n\t * - Removes binding parameter from SideEffects targets properties\n\t * - Adds the text properties\n\t * - Replaces TargetProperties having reference to Source Properties for a SideEffects.\n\t * @param sideEffects SideEffects definition\n\t * @param entityType Entity type\n\t * @param bindingParameter Name of the binding parameter\n\t * @returns SideEffects definition\n\t */\n\tprivate convertSideEffects(\n\t\tsideEffects: CommonSideEffectsType,\n\t\tentityType?: EntityType,\n\t\tbindingParameter?: string\n\t): ODataSideEffectsType {\n\t\tconst triggerAction = sideEffects.TriggerAction as string;\n\t\tconst newSideEffects = this.convertSideEffectsFormat(sideEffects);\n\t\tlet sideEffectsTargets = { targetProperties: newSideEffects.targetProperties, targetEntities: newSideEffects.targetEntities };\n\t\tsideEffectsTargets = this.removeBindingParameter(sideEffectsTargets, bindingParameter);\n\t\tsideEffectsTargets = this.addTextProperties(sideEffectsTargets, entityType);\n\t\tsideEffectsTargets = this.removeDuplicateTargets(sideEffectsTargets);\n\t\treturn {\n\t\t\t...newSideEffects,\n\t\t\t...{ targetEntities: sideEffectsTargets.targetEntities, targetProperties: sideEffectsTargets.targetProperties, triggerAction }\n\t\t};\n\t}\n\n\t/**\n\t * Converts the SideEffects targets (TargetEntities and TargetProperties) to expected format\n\t * - TargetProperties as array of string\n\t * - TargetEntities as array of object with property $NavigationPropertyPath.\n\t * @param sideEffects SideEffects definition\n\t * @returns Converted SideEffects\n\t */\n\tprivate convertSideEffectsFormat(sideEffects: CommonSideEffectsType): ODataSideEffectsType {\n\t\tconst formatProperties = (properties?: (string | PropertyPath)[]): string[] | undefined => {\n\t\t\treturn properties\n\t\t\t\t? properties.reduce((targetProperties: string[], target) => {\n\t\t\t\t\t\tlet path = \"\";\n\t\t\t\t\t\tif (isPropertyPathExpression(target)) {\n\t\t\t\t\t\t\tpath = target.value;\n\t\t\t\t\t\t} else if (typeof target === \"string\") {\n\t\t\t\t\t\t\tpath = target;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (path) {\n\t\t\t\t\t\t\ttargetProperties.push(path);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tLog.error(\n\t\t\t\t\t\t\t\t`SideEffects - Error while processing TargetProperties for SideEffects ${sideEffects.fullyQualifiedName}`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn targetProperties;\n\t\t\t\t  }, [])\n\t\t\t\t: properties;\n\t\t};\n\t\tconst formatEntities = (entities?: NavigationPropertyPath[]): { $NavigationPropertyPath: string }[] | undefined => {\n\t\t\treturn entities\n\t\t\t\t? entities.map((targetEntity) => {\n\t\t\t\t\t\treturn { $NavigationPropertyPath: targetEntity.value };\n\t\t\t\t  })\n\t\t\t\t: entities;\n\t\t};\n\n\t\t// TODO: SourceEvents are still experimental, remove once public\n\t\ttype CommonSideEffectTypeWithSourceEvents = CommonSideEffectsType & { SourceEvents?: Edm.String[] };\n\n\t\treturn {\n\t\t\tfullyQualifiedName: sideEffects.fullyQualifiedName,\n\t\t\tsourceProperties: formatProperties(sideEffects.SourceProperties),\n\t\t\tsourceEntities: formatEntities(sideEffects.SourceEntities),\n\t\t\tsourceEvents: (sideEffects as CommonSideEffectTypeWithSourceEvents).SourceEvents as string[],\n\t\t\ttargetProperties: formatProperties(sideEffects.TargetProperties as (string | PropertyPath)[]) ?? [],\n\t\t\ttargetEntities: formatEntities(sideEffects.TargetEntities) ?? []\n\t\t};\n\t}\n\n\t/**\n\t * Gets all dataModelObjectPath related to properties listed by a path\n\t *\n\t * The path can be:\n\t * - a path targeting a property on a complexType or an EntityType\n\t * - a path with a star targeting all properties on a complexType or an EntityType.\n\t * - absolute.\n\t * @param propertyPath The path to analyze\n\t * @param entityType Entity type\n\t * @returns Array of dataModelObjectPath representing the properties\n\t */\n\tprivate getDataModelPropertiesFromAPath(propertyPath: string, entityType?: EntityType): DataModelObjectPath<Property>[] {\n\t\tlet dataModelObjectPaths: DataModelObjectPath<Property>[] = [];\n\t\tconst convertedMetaModel = this.getConvertedMetaModel();\n\n\t\tlet propertyRelativePath: string | undefined, testEntityTypeName: string | undefined, match: RegExpMatchArray | null;\n\t\tif (propertyPath.startsWith(`/${this.containerName}/`)) {\n\t\t\tmatch = propertyPath.match(this.containerRegexPattern);\n\t\t\tpropertyRelativePath = match ? match[1] : undefined;\n\t\t}\n\t\tif (!entityType) {\n\t\t\tmatch = propertyPath.match(this.entityTypeRegexPattern);\n\t\t\ttestEntityTypeName = match ? match[1] : undefined;\n\t\t}\n\t\tconst testEntityType =\n\t\t\tentityType ??\n\t\t\t((testEntityTypeName ? convertedMetaModel.resolvePath(`/${testEntityTypeName}/`).target : undefined) as EntityType | undefined);\n\t\tconst entitySet =\n\t\t\tconvertedMetaModel.entitySets.find((relatedEntitySet) => relatedEntitySet.entityType === testEntityType) ??\n\t\t\tconvertedMetaModel.singletons.find((singleton) => singleton.entityType === testEntityType);\n\t\tif (entitySet) {\n\t\t\tconst metaModel = this.getMetaModel(),\n\t\t\t\tentitySetContext = metaModel.createBindingContext(`/${entitySet.name}`);\n\t\t\tif (entitySetContext) {\n\t\t\t\tconst dataModelEntitySet = getInvolvedDataModelObjects(entitySetContext);\n\t\t\t\tconst dataModelObjectPath = enhanceDataModelPath<Property | EntityType>(\n\t\t\t\t\t\tdataModelEntitySet,\n\t\t\t\t\t\t(propertyRelativePath || propertyPath).replace(\"*\", \"\") || \"/\"\n\t\t\t\t\t), // \"*\" is replaced by \"/\" to target the current EntityType\n\t\t\t\t\ttargetObject = dataModelObjectPath.targetObject;\n\t\t\t\tif (isProperty(targetObject)) {\n\t\t\t\t\tif (isComplexType(targetObject.targetType)) {\n\t\t\t\t\t\tdataModelObjectPaths = dataModelObjectPaths.concat(\n\t\t\t\t\t\t\ttargetObject.targetType.properties.map((property) =>\n\t\t\t\t\t\t\t\tenhanceDataModelPath<Property>(dataModelObjectPath, property.name)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdataModelObjectPaths.push(dataModelObjectPath as DataModelObjectPath<Property>);\n\t\t\t\t\t}\n\t\t\t\t} else if (isEntityType(targetObject)) {\n\t\t\t\t\tdataModelObjectPaths = dataModelObjectPaths.concat(\n\t\t\t\t\t\tdataModelObjectPath.targetEntityType.entityProperties.map((entityProperty) => {\n\t\t\t\t\t\t\treturn enhanceDataModelPath<Property>(dataModelObjectPath, entityProperty.name);\n\t\t\t\t\t\t})\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tentitySetContext.destroy();\n\t\t\t}\n\t\t}\n\t\treturn dataModelObjectPaths.filter((dataModelObjectPath) => dataModelObjectPath.targetObject);\n\t}\n\n\t/**\n\t * Gets the Odata metamodel.\n\t * @returns The OData metamodel\n\t */\n\tprivate getMetaModel(): ODataMetaModel {\n\t\treturn this.appComponent.getModel().getMetaModel();\n\t}\n\n\t/**\n\t * Gets the SideEffects related to an entity type or action that come from an OData Service\n\t * Internal routine to get, from converted oData metaModel, SideEffects related to a specific entity type or action\n\t * and to convert these SideEffects with expected format.\n\t * @param source Entity type or action\n\t * @returns Array of SideEffects\n\t */\n\tprivate getSideEffectsFromSource(source: EntityType | Action): ODataSideEffectsType[] {\n\t\tlet bindingAlias = \"\";\n\t\tconst isSourceEntityType = isEntityType(source);\n\t\tconst entityType: EntityType | undefined = isSourceEntityType ? source : source.sourceEntityType;\n\t\tconst commonAnnotation = source.annotations?.Common as undefined | unknown as Record<string, CommonAnnotationTypes>;\n\t\tif (commonAnnotation) {\n\t\t\tif (entityType && !isSourceEntityType) {\n\t\t\t\tconst bindingParameter = source.parameters?.find((parameter) => parameter.type === entityType.fullyQualifiedName);\n\t\t\t\tbindingAlias = bindingParameter?.fullyQualifiedName.split(\"/\")[1] ?? \"\";\n\t\t\t}\n\t\t\treturn this.getSideEffectsAnnotationFromSource(source).map((sideEffectAnno) =>\n\t\t\t\tthis.convertSideEffects(sideEffectAnno, entityType, bindingAlias)\n\t\t\t);\n\t\t}\n\t\treturn [];\n\t}\n\n\t/**\n\t * Gets the SideEffects related to an entity type or action that come from an OData Service\n\t * Internal routine to get, from converted oData metaModel, SideEffects related to a specific entity type or action.\n\t * @param source Entity type or action\n\t * @returns Array of SideEffects\n\t */\n\tprivate getSideEffectsAnnotationFromSource(source: EntityType | Action): CommonSideEffectTypeWithQualifier[] {\n\t\tconst sideEffects: CommonSideEffectsType[] = [];\n\t\tconst commonAnnotation = source.annotations?.Common as undefined | unknown as Record<string, CommonSideEffectTypeWithQualifier>;\n\t\tfor (const key in commonAnnotation) {\n\t\t\tconst annotation = commonAnnotation[key];\n\t\t\tif (this.isSideEffectsAnnotation(annotation)) {\n\t\t\t\tsideEffects.push(annotation);\n\t\t\t}\n\t\t}\n\t\treturn sideEffects;\n\t}\n\n\t/**\n\t * Checks if the annotation is a SideEffects annotation.\n\t * @param annotation Annotation\n\t * @returns Boolean\n\t */\n\tprivate isSideEffectsAnnotation(annotation: unknown): annotation is CommonSideEffectsType {\n\t\treturn (annotation as CommonSideEffectsType)?.$Type === CommonAnnotationTypes.SideEffectsType;\n\t}\n\n\t/**\n\t * Logs the SideEffects request.\n\t * @param pathExpressions SideEffects targets\n\t * @param context Context\n\t */\n\tprivate logRequest(pathExpressions: SideEffectsTarget[], context: Context): void {\n\t\tconst targetPaths = pathExpressions.reduce(function (paths, target) {\n\t\t\treturn `${paths}\\n\\t\\t${(target as SideEffectsEntityType).$NavigationPropertyPath || target || \"\"}`;\n\t\t}, \"\");\n\t\tLog.debug(`SideEffects - Request:\\n\\tContext path : ${context.getPath()}\\n\\tProperty paths :${targetPaths}`);\n\t}\n\n\t/**\n\t * Removes the name of the binding parameter on the SideEffects targets.\n\t * @param sideEffectsTargets SideEffects Targets\n\t * @param bindingParameterName Name of binding parameter\n\t * @returns SideEffects definition\n\t */\n\tprivate removeBindingParameter(sideEffectsTargets: SideEffectsTargetType, bindingParameterName?: string): SideEffectsTargetType {\n\t\tif (bindingParameterName) {\n\t\t\tconst replaceBindingParameter = function (value: string): string {\n\t\t\t\treturn value.replace(new RegExp(`^${bindingParameterName}/?`), \"\");\n\t\t\t};\n\t\t\treturn {\n\t\t\t\ttargetProperties: sideEffectsTargets.targetProperties.map((targetProperty) => replaceBindingParameter(targetProperty)),\n\t\t\t\ttargetEntities: sideEffectsTargets.targetEntities.map((targetEntity) => {\n\t\t\t\t\treturn { $NavigationPropertyPath: replaceBindingParameter(targetEntity.$NavigationPropertyPath) };\n\t\t\t\t})\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\ttargetProperties: sideEffectsTargets.targetProperties,\n\t\t\ttargetEntities: sideEffectsTargets.targetEntities\n\t\t};\n\t}\n\n\t/**\n\t * Remove duplicates in SideEffects targets.\n\t * @param sideEffectsTargets SideEffects Targets\n\t * @returns SideEffects targets without duplicates\n\t */\n\tprivate removeDuplicateTargets(sideEffectsTargets: SideEffectsTargetType): SideEffectsTargetType {\n\t\tconst targetEntitiesPaths = sideEffectsTargets.targetEntities.map((targetEntity) => targetEntity.$NavigationPropertyPath);\n\t\tconst uniqueTargetedEntitiesPath = new Set<string>(targetEntitiesPaths);\n\t\tconst uniqueTargetProperties = new Set<string>(sideEffectsTargets.targetProperties);\n\n\t\tconst uniqueTargetedEntities = Array.from(uniqueTargetedEntitiesPath).map((entityPath) => {\n\t\t\treturn {\n\t\t\t\t$NavigationPropertyPath: entityPath\n\t\t\t};\n\t\t});\n\n\t\treturn { targetProperties: Array.from(uniqueTargetProperties), targetEntities: uniqueTargetedEntities };\n\t}\n\n\t/**\n\t * Gets SideEffects action type that come from an OData Service\n\t * Internal routine to get, from converted oData metaModel, SideEffects on actions\n\t * related to a specific entity type and to convert these SideEffects with\n\t * expected format.\n\t * @param action Action\n\t * @returns Entity type SideEffects dictionary\n\t */\n\tprivate retrieveODataActionsSideEffects(action: Action): Record<string, ActionSideEffectsType> {\n\t\tconst sideEffects: Record<string, ActionSideEffectsType> = {};\n\t\tconst triggerActions = new Set<string>();\n\t\tlet targetProperties: string[] = [];\n\t\tlet targetEntities: SideEffectsEntityType[] = [];\n\n\t\tthis.getSideEffectsFromSource(action).forEach((oDataSideEffect) => {\n\t\t\tconst triggerAction = oDataSideEffect.triggerAction;\n\t\t\ttargetProperties = targetProperties.concat(oDataSideEffect.targetProperties);\n\t\t\ttargetEntities = targetEntities.concat(oDataSideEffect.targetEntities);\n\t\t\tif (triggerAction) {\n\t\t\t\ttriggerActions.add(triggerAction);\n\t\t\t}\n\t\t});\n\t\tconst sideEffectsTargets = this.removeDuplicateTargets({ targetProperties, targetEntities });\n\t\tconst actionName = action.isBound ? action.fullyQualifiedName.match(/^[^(]+/)?.[0] : action.name;\n\t\tsideEffects[actionName!] = {\n\t\t\tpathExpressions: [...sideEffectsTargets.targetProperties, ...sideEffectsTargets.targetEntities],\n\t\t\ttriggerActions: Array.from(triggerActions)\n\t\t};\n\t\treturn sideEffects;\n\t}\n\n\t/**\n\t * Gets SideEffects entity type that come from an OData Service\n\t * Internal routine to get, from converted oData metaModel, SideEffects\n\t * related to a specific entity type and to convert these SideEffects with\n\t * expected format.\n\t * @param entityType Entity type\n\t * @returns Entity type SideEffects dictionary\n\t */\n\tprivate retrieveODataEntitySideEffects(entityType: EntityType): Record<string, ODataSideEffectsType> {\n\t\tconst entitySideEffects: Record<string, ODataSideEffectsType> = {};\n\t\tthis.getSideEffectsFromSource(entityType).forEach((sideEffects) => {\n\t\t\tentitySideEffects[sideEffects.fullyQualifiedName] = sideEffects;\n\t\t});\n\t\treturn entitySideEffects;\n\t}\n\n\t/**\n\t * Defines a map for the Sources of sideEffect on the entity to track where those sources are used in SideEffects annotation.\n\t * @param entityType The entityType we look for side Effects annotation\n\t * @param sideEffectsSources The mapping object in construction\n\t * @param sideEffectsSources.entities\n\t * @param sideEffectsSources.properties\n\t * @param sideEffectsSources.events\n\t */\n\tprivate mapSideEffectSources(\n\t\tentityType: EntityType,\n\t\tsideEffectsSources: {\n\t\t\tentities: Record<string, SideEffectInfoForSource[]>;\n\t\t\tproperties: Record<string, SideEffectInfoForSource[]>;\n\t\t\tevents: Record<string, SideEffectInfoForSource[]>;\n\t\t}\n\t): void {\n\t\tfor (const sideEffectDefinition of this.getSideEffectsAnnotationFromSource(entityType)) {\n\t\t\tthis.mapSideEffectSourceEntities(entityType, sideEffectsSources, sideEffectDefinition);\n\t\t\tthis.mapSideEffectSourceProperties(entityType, sideEffectsSources, sideEffectDefinition);\n\t\t\tthis.mapSideEffectSourceEvents(entityType, sideEffectsSources, sideEffectDefinition);\n\t\t}\n\t}\n\n\t/**\n\t * Fills the map for the Sources of sideEffect with source entities.\n\t * @param entityType The entityType we look for side Effects annotation\n\t * @param sideEffectsSources The mapping object in construction\n\t * @param sideEffectsSources.entities\n\t * @param sideEffectsSources.properties\n\t * @param sideEffectsSources.events\n\t * @param sideEffectDefinition The side effect definition to be evaluated\n\t */\n\tprivate mapSideEffectSourceEntities(\n\t\tentityType: EntityType,\n\t\tsideEffectsSources: {\n\t\t\tentities: Record<string, SideEffectInfoForSource[]>;\n\t\t\tproperties: Record<string, SideEffectInfoForSource[]>;\n\t\t\tevents: Record<string, SideEffectInfoForSource[]>;\n\t\t},\n\t\tsideEffectDefinition: CommonSideEffectTypeWithQualifier\n\t): void {\n\t\tfor (const sourceEntity of sideEffectDefinition.SourceEntities ?? []) {\n\t\t\tconst targetEntityType = sourceEntity.value ? sourceEntity.$target?.targetType : entityType;\n\t\t\tif (targetEntityType) {\n\t\t\t\tif (!sideEffectsSources.entities[targetEntityType.fullyQualifiedName]) {\n\t\t\t\t\tsideEffectsSources.entities[targetEntityType.fullyQualifiedName] = [];\n\t\t\t\t}\n\t\t\t\tsideEffectsSources.entities[targetEntityType.fullyQualifiedName].push({\n\t\t\t\t\tentity: entityType.fullyQualifiedName,\n\t\t\t\t\tqualifier: sideEffectDefinition.qualifier\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Fills the map for the Sources of sideEffect with source properties.\n\t * @param entityType The entityType we look for side Effects annotation\n\t * @param sideEffectsSources The mapping object in construction\n\t * @param sideEffectsSources.entities\n\t * @param sideEffectsSources.properties\n\t * @param sideEffectsSources.events\n\t * @param sideEffectDefinition The side effect definition to be evaluated\n\t */\n\tprivate mapSideEffectSourceProperties(\n\t\tentityType: EntityType,\n\t\tsideEffectsSources: {\n\t\t\tentities: Record<string, SideEffectInfoForSource[]>;\n\t\t\tproperties: Record<string, SideEffectInfoForSource[]>;\n\t\t\tevents: Record<string, SideEffectInfoForSource[]>;\n\t\t},\n\t\tsideEffectDefinition: CommonSideEffectTypeWithQualifier\n\t): void {\n\t\tconst hasUniqueSourceProperty = sideEffectDefinition.SourceProperties?.length === 1;\n\t\tfor (const sourceProperty of sideEffectDefinition.SourceProperties ?? []) {\n\t\t\tif (sourceProperty.$target) {\n\t\t\t\tif (!sideEffectsSources.properties[sourceProperty.$target.fullyQualifiedName]) {\n\t\t\t\t\tsideEffectsSources.properties[sourceProperty.$target.fullyQualifiedName] = [];\n\t\t\t\t}\n\t\t\t\tsideEffectsSources.properties[sourceProperty.$target.fullyQualifiedName].push({\n\t\t\t\t\tentity: entityType.fullyQualifiedName,\n\t\t\t\t\tqualifier: sideEffectDefinition.qualifier,\n\t\t\t\t\thasUniqueSourceProperty\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Fills the map for the Sources of sideEffect with source events.\n\t * @param entityType The entityType we look for side Effects annotation\n\t * @param sideEffectsSources The mapping object in construction\n\t * @param sideEffectsSources.entities\n\t * @param sideEffectsSources.properties\n\t * @param sideEffectsSources.events\n\t * @param sideEffectDefinition The side effect definition to be evaluated\n\t */\n\tprivate mapSideEffectSourceEvents(\n\t\tentityType: EntityType,\n\t\tsideEffectsSources: {\n\t\t\tentities: Record<string, SideEffectInfoForSource[]>;\n\t\t\tproperties: Record<string, SideEffectInfoForSource[]>;\n\t\t\tevents: Record<string, SideEffectInfoForSource[]>;\n\t\t},\n\t\tsideEffectDefinition: CommonSideEffectTypeWithQualifier\n\t): void {\n\t\tfor (const sourceEvent of sideEffectDefinition.SourceEvents ?? []) {\n\t\t\tif (!sideEffectsSources.events[sourceEvent.toString()]) {\n\t\t\t\tsideEffectsSources.events[sourceEvent.toString()] = [];\n\t\t\t}\n\t\t\tsideEffectsSources.events[sourceEvent.toString()].push({\n\t\t\t\tentity: entityType.fullyQualifiedName,\n\t\t\t\tqualifier: sideEffectDefinition.qualifier\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Get the fieldGroupId based on the stored information on th side effect.\n\t * @param sideEffectInfo\n\t * @param isImmediate\n\t * @returns A string for the fieldGroupId.\n\t */\n\tprivate getFieldGroupIdForSideEffect(sideEffectInfo: SideEffectInfoForSource, isImmediate = false): string {\n\t\tconst sideEffectWithQualifier = sideEffectInfo.qualifier\n\t\t\t? `${sideEffectInfo.entity}#${sideEffectInfo.qualifier}`\n\t\t\t: sideEffectInfo.entity;\n\t\treturn isImmediate || sideEffectInfo.hasUniqueSourceProperty === true\n\t\t\t? `${sideEffectWithQualifier}$$ImmediateRequest`\n\t\t\t: sideEffectWithQualifier;\n\t}\n\n\tgetInterface(): SideEffectsService {\n\t\treturn this;\n\t}\n}\n\nclass SideEffectsServiceFactory extends ServiceFactory<SideEffectsSettings> {\n\tasync createInstance(oServiceContext: ServiceContext<SideEffectsSettings>): Promise<SideEffectsService> {\n\t\tconst SideEffectsServiceService = new SideEffectsService(oServiceContext);\n\t\treturn SideEffectsServiceService.initialize();\n\t}\n}\n\nexport default SideEffectsServiceFactory;\n"],"mappings":";;;;8jCA2FA,IAwCaA,EAAkB,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAC,MAAAC,KAAAC,YAAAD,IAAA,CAAAE,EAAAL,qBAAAM,EAAAN,EAAAC,GAAA,IAAAM,EAAAP,EAAAQ,UA+B9BD,EACAE,KAAA,SAAAA,IACC,MAAMC,EAAUP,KAAKQ,aACrBR,KAAKS,aAAeF,GAASG,YAC7BV,KAAKW,oBAAsB,CAC1BC,MAAO,CACNC,SAAU,CAAC,EACXC,QAAS,CACRC,aAAc,CAAC,EACfC,eAAgB,CAAC,IAGnBC,QAAS,CAAC,GAGXjB,KAAKkB,uBAAyB,CAC7BC,MAAO,CAAC,GAETnB,KAAKoB,gBAAkB,CAAC,CACzB,EAEAhB,EAIAiB,8BAAA,SAAAA,IACC,MAAMC,EAAQtB,KAAKS,aAAac,WAChC,MAAMC,EAAMC,EAAoBH,GAChC,MAAMI,EAAUC,EAAuBC,EAAYC,kBAAmBP,GAEtE,GAAIE,GAAOE,EAAS,CACnB1B,KAAK8B,UAAYC,EAAgBH,EAAYC,kBAAmBP,GAChEtB,KAAK8B,UAAUE,cAAchC,KAAKiC,2BAA2BC,KAAKlC,OAClEA,KAAKmC,gBAAkBC,EAAiBC,UAExC,MAAMC,EAA2BA,KAChC,GAAI,CAACF,EAAiBG,OAAQH,EAAiBI,OAAOC,SAASzC,KAAKmC,iBAAkB,CACrF,MAAMO,EAAgBC,EAAiB3C,KAAKS,cAC5C,MAAMmC,EAAuBF,EAAcG,QAAQ,gCAEnDC,EAAWC,QAAQH,EAAsB,CACxC9B,QAAS,CAACgC,EAAWE,OAAOC,IAC5BC,iBAAkBJ,EAAWE,OAAOC,IAEtC,GAGDjD,KAAK8B,UAAUqB,YAAY,KAC1BnD,KAAKmC,gBAAkBC,EAAiBI,MACxCF,MAGDtC,KAAK8B,UAAUsB,YAAaC,IAC3B,GAAIrD,KAAKmC,kBAAoBC,EAAiBI,MAAO,CACpD,MACD,CACAxC,KAAKmC,gBAAkBC,EAAiBG,OAGxC,GAAKc,EAAIC,aAAa,UAAmC,IAAM,CAC9DhB,GACD,GAEF,CACD,EAEAlC,EAIM6B,2BAANsB,eAAMtB,EAA2BuB,GAChC,MAAMC,EAAUD,EAAMF,aAAa,aAEnC,GAAIG,GAASC,eAAiB,oBAAsBD,EAAQE,sBAAwBF,EAAQG,iBAAkB,CAE7G,MACD,CAEA,MAAMC,EAAW7D,KAAK8D,eAAeC,eAAeN,EAAQG,kBAC5D,MAAMI,EAAYC,EAAmBC,4BAA4BL,GACjE,MAAMM,EAAsBnE,KAAKoE,gCAChCJ,EAAUK,iBAAiBC,mBAC3Bb,EAAQE,qBAGT,GAAIQ,EAAoBI,SAAW,EAAG,CAErC,MACD,CAEA,MAAMC,EAAkC,GACxC,MAAMC,EAAQzE,KAAKS,aAAaiE,wBAAwBC,kBACxD,IAAK,MAAMC,KAAQH,EAAO,CACzB,MAAMI,EAAiBD,EAAKE,gBAC5B,GACCD,EAAeE,IAAoB,+BACnCF,EAAeG,aAAaC,mBAAmBxB,EAAQG,iBAAkBH,EAAQE,qBAChF,CACDa,EAAcU,KAAKL,EACpB,CACD,CAEA,GAAIL,EAAcD,SAAW,EAAG,CAE/B,MACD,CAGA,MAAMY,EAAiCX,EAAcA,EAAcD,OAAS,GAAGS,aAC/E,MAAMI,EAAsBpF,KAAKqF,sBAAsBrB,EAAWG,GAClE,MAAMmB,EAAkBtF,KAAKuF,8BAA8B9B,EAAQE,oBAAqByB,GAExF,OAAQE,GACP,IAAK,eACJ,UACOH,EAA+BK,oBACtC,CAAE,MAAOC,GACR,MACD,CACA,MACD,IAAK,eACJN,EAA+BO,oBAC/B,MACD,IAAK,OACJ,MAIF,IAAK,MAAMd,KAAQJ,EAAe,OAC3BI,EAAKI,aAAaW,2BAA2BlC,EAAQE,oBAAqBF,EAAQG,iBACzF,CACD,EAEAxD,EAMAiF,sBAAA,SAAAA,EAAsBrB,EAAyCG,GAC9D,MAAMyB,EACL5B,EAAUK,iBAAiBwB,YAAYC,IAAIC,iBACzCC,KACH,IAAK,MAAMC,KAAc9B,EAAqB,CAC7C,MAAM+B,EACLlG,KAAKW,oBAAoBC,MAAMC,SAASmD,EAAUK,iBAAiBC,sBAClE,GAAG2B,EAAWE,qDAAqDF,EAAWG,aAGhF,GACCF,GAAYG,iBAAiB9B,SAAW,GACxC2B,GAAYI,eAAe/B,SAAW,GACtC2B,GAAYG,iBAAiB,KAAOT,EACnC,CACD,OAAO,IACR,CACD,CACA,OAAO,KACR,EAEAxF,EAMAmF,8BAAA,SAAAA,EAA8B/B,GAA8E,IAA/D4B,EAAmBnF,UAAAsE,OAAA,GAAAtE,UAAA,KAAAsG,UAAAtG,UAAA,GAAG,MAClE,IAAKD,KAAKwG,0BAA2B,CACpCxG,KAAKwG,0BAA4BxG,KAAKS,aAAagG,iBAAiB,WAAWC,KAAKC,gCACrF,CACA,GAAIvB,EAAqB,CAExB,MAAO,MACR,CAEA,UAAWpF,KAAKwG,4BAA8B,SAAU,CAEvD,OAAOxG,KAAKwG,yBACb,CAEA,GAAIhD,GAASxD,KAAKwG,2BAA2BI,SAASpD,GAAQ,CAE7D,OAAOxD,KAAKwG,0BAA0BI,OAAOpD,EAC9C,CAEA,GAAIxD,KAAKwG,2BAA2BK,QAAS,CAE5C,OAAO7G,KAAKwG,0BAA0BK,OACvC,CAEA,MAAO,cACR,EAEAzG,EAWO0G,sBAAP,SAAOA,EAAsBC,EAAoBd,GAChD,GAAIA,EAAWe,gBAAiB,CAC/B,MAAMC,EAA4C,IAC9ChB,EACH3B,mBAAoB,GAAGyC,2BAAoCd,EAAWe,mBAEvE,MAAME,EAA2BlH,KAAKW,oBAAoBM,QAAQ8F,IAAe,CAAC,EAClFG,EAAyBD,EAAkBD,iBAAmBC,EAC9DjH,KAAKW,oBAAoBM,QAAQ8F,GAAcG,CAChD,CACD,EAEA9G,EASa+G,cAAb5D,eAAa4D,EACZC,EACA7G,EACA8G,GAKA,MAAMC,EAAS/G,EAAQgB,WAAWgG,YAAY,GAAGH,SAAsB7G,GACvE,MAAMiH,EAAmBH,GAAW,CAAC,EACrC,MAAMI,EAAUD,EAAiBC,SAAWlH,EAAQmH,aAAaC,mBAEjE,GAAIH,EAAiBI,aAAe,MAAO,CAC1CrH,EAAQgB,WAAWqG,YAAYH,EAChC,OACMH,EAAOO,QAAQJ,EAAS,KAC/B,EAEArH,EAIO0H,sBAAP,SAAOA,IACN,OAAOC,EAAa/H,KAAK8D,eAAgB9D,KAAKgI,aAC/C,EAEA5H,EAKO6H,yBAAP,SAAOA,EAAyB1H,GAC/B,MAAM2H,EAAY3H,EAAQgB,WAAWuC,eACpCD,EAAWqE,EAAUC,YAAY5H,EAAQ6H,WACzCrB,EAAamB,EAAUG,UAAUxE,GAAU,SAC5C,OAAOkD,CACR,EAEA3G,EAKOkI,0BAAP,SAAOA,EAA0BC,GAChC,OAAOvI,KAAKW,oBAAoBC,MAAMC,SAAS0H,IAAmB,CAAC,CACpE,EAEAnI,EAKOoI,qBAAP,SAAOA,EAAqBC,GAC3B,QAAUA,EAAuCzB,eAClD,EAEA5G,EAKOsI,gCAAP,SAAOA,EAAgCH,GACtC,MAAMI,EAAoB3I,KAAKsI,0BAA0BC,GACzD,MAAMK,EAA4C,GAClD,IAAK,MAAMC,KAAOF,EAAmB,CACpC,MAAMF,EAAcE,EAAkBE,GACtC,IAAKJ,EAAYK,iBAAmBL,EAAYM,mBAAqBN,EAAYO,aAAc,CAC9FJ,EAAkB1D,KAAKuD,EACxB,CACD,CACA,OAAOG,CACR,EAEAxI,EAMO6I,0BAAP,SAAOA,EAA0BC,EAAoB3I,GACpD,GAAIA,EAAS,CACZ,MAAMwG,EAAa/G,KAAKiI,yBAAyB1H,GACjD,GAAIwG,EAAY,CACf,OAAO/G,KAAKW,oBAAoBC,MAAME,QAAQC,aAAagG,KAAcmC,EAC1E,CACD,KAAO,CACN,OAAOlJ,KAAKW,oBAAoBC,MAAME,QAAQE,iBAAiBkI,EAChE,CACA,OAAO3C,SACR,EAEAnG,EAMO+I,oCAAP,SAAOA,EAAoC5I,EAAkBiD,GAC5D,MAAMK,EAAWtD,EAAQgB,WAAWuC,eAAeC,eAAexD,EAAQ6H,WAC1E,MAAMpE,EAAYE,EAA4BL,GAC9C,MAAMuF,EAAkBpJ,KAAKoE,gCAAgCJ,EAAUK,iBAAiBC,mBAAoBd,GAC5G,OAAO4F,EAAgBC,IACrBpD,GACAjG,KAAKW,oBAAoBC,MAAMC,SAASmD,EAAUK,iBAAiBC,sBAClE,GAAG2B,EAAWE,qDAAqDF,EAAWG,aAGlF,EAEAhG,EAIMkJ,WAAN/F,eAAM+F,IACL,MAAMC,EAIF,CACH1I,SAAU,CAAC,EACX2I,WAAY,CAAC,EACb5C,OAAQ,CAAC,GAEV,MAAM6C,QAAwCzJ,KAAKS,aAAaiJ,WAC/D,2BAED,MAAMpI,EAAQtB,KAAKS,aAAac,WAChC,GAAID,GAAOyD,MAAkB,oCAAqC,OAE3DzD,EAAMwC,eAAe6F,cAAc,sBACzC3J,KAAKgI,aAAeyB,EAA+BG,kBAEnD,MAAMC,EAAqB7J,KAAK8H,wBAChC9H,KAAK8J,cAAgBD,EAAmBE,gBAAgBzF,mBACxDtE,KAAKgK,sBAAwB,IAAIC,OAAO,OAAOjK,KAAK8J,kCACpD9J,KAAKkK,uBAAyB,IAAID,OAAO,KAAKjK,KAAK8J,yBACnDD,EAAmBM,YAAYC,QAASrD,IACvC/G,KAAKqK,oBAAoBtD,GACzB/G,KAAKW,oBAAoBC,MAAMC,SAASkG,EAAWzC,oBAAsBtE,KAAKsK,+BAA+BvD,GAC7G/G,KAAKuK,qBAAqBxD,EAAYwC,KAEvCM,EAAmB/I,QAAQsJ,QAAS9C,IACnC,GAAIA,EAAOkD,QAAS,CACnBxK,KAAKW,oBAAoBC,MAAME,QAAQC,aAAauG,EAAOmD,iBAAkBnG,oBAAsB,IAC/FtE,KAAKW,oBAAoBC,MAAME,QAAQC,aAAauG,EAAOmD,iBAAkBnG,uBAC7EtE,KAAK0K,gCAAgCpD,GAE1C,KAAO,CACNtH,KAAKW,oBAAoBC,MAAME,QAAQE,eAAiB,IACpDhB,KAAKW,oBAAoBC,MAAME,QAAQE,kBACvChB,KAAK0K,gCAAgCpD,GAE1C,IAED,GAAIqD,OAAOC,KAAKrB,EAAkB3C,QAAQrC,OAAS,EAAG,CACrDvE,KAAKqB,+BACN,CACD,CACArB,KAAK6K,4BAA8BtB,EACnC,OAAOvJ,IACR,EAACI,EAEOiK,oBAAR,SAAQA,EAAoBS,GAC3B,MAAMC,EAA0BC,IAC/B,IAAKhL,KAAKkB,uBAAuBC,MAAM8J,eAAe,GAAGD,KAAe,CACvEhL,KAAKkB,uBAAuBC,MAAM,GAAG6J,KAAgB,CACpDE,MAAO,GACPC,OAAQ,GAEV,GAEDL,EAAOM,iBAAiBhB,QAASiB,IAChC,MAAMC,EAAaD,EAASxF,YAAY0F,OACxC,GAAID,GAAYE,mBAAoB,CACnC,MAAMC,EAAWH,EAAWE,mBAC5B,GAAIC,EAASC,UAAUjJ,SAAS,SAAU,CACzCsI,EAAuB,GAAGD,EAAOa,QACjC3L,KAAKkB,uBAAuBC,MAAM,GAAG2J,EAAOa,QAAQT,MAAMhG,KAAKmG,EAASM,KACzE,CACA,GAAIF,EAASC,UAAUjJ,SAAS,UAAW,CAC1CsI,EAAuB,GAAGD,EAAOa,QACjC3L,KAAKkB,uBAAuBC,MAAM,GAAG2J,EAAOa,QAAQR,OAAOjG,KAAKmG,EAASM,KAC1E,CACD,GAEF,EAACvL,EAEMwL,0BAAP,SAAOA,IACN,OAAO5L,KAAKkB,sBACb,EAEAd,EAMOyL,qCAAP,SAAOA,EAAqCC,GAC3C,MAAMvL,EAAUuL,EAAMC,oBACtB,MAAMC,EAAeF,EAAMG,OAAOC,WAAWC,MAAM,KAAKC,MACxD,GAAI7L,EAAS,CACZ,MAAM2H,EAAY3H,GAASgB,WAAWuC,eACtC,MAAMuI,EAAenE,GAA8BnE,eAAexD,EAAQ6H,WAC1E,MAAMkE,EAAwBrI,EAAmBC,4BAA4DmI,GAC3GE,aACF,IAAIC,EACJ,GAAIC,EAAYH,GAAwB,CACvCE,EAAuBF,EAAsBvF,YAAY4E,IAC1D,MAAO,GAAIe,EAAqBJ,GAAwB,CACvDE,EAAuBF,EAAsBK,YAAYhB,IAC1D,CACA,MAAMiB,EAA+BJ,GAAwBxM,KAAKkB,uBAAuBC,MAAMqL,GAC/F,GAAII,GAAgCA,GAA8B1B,OAAOzI,SAASuJ,GAAe,CAChG,OAAO,IACR,CACD,CACA,OAAO,KACR,EAEA5L,EAKOyM,8BAAP,SAAOA,EAA8BtE,GAEpC,MAAMqE,EAA+B5M,KAAKkB,uBAAuBC,MAAMoH,GACvE,GAAIqE,GAA8BzB,QAAQ5G,OAAS,EAAG,CACrD,OAAOqI,EAA6BzB,MACrC,CAEA,MAAO,EACR,EAEA/K,EAIO0M,yBAAP,SAAOA,EAAyBC,GAC/BpC,OAAOC,KAAK5K,KAAKW,oBAAoBM,SAASmJ,QAAS4C,IACtD,GAAIhN,KAAKW,oBAAoBM,QAAQ+L,GAAaD,GAAY,QACtD/M,KAAKW,oBAAoBM,QAAQ+L,GAAaD,EACtD,GAEF,EAEA3M,EAOa6M,mBAAb1J,eAAa0J,EAAmBC,EAAsC3M,EAAkBkH,GACvF,GAAIyF,EAAgB3I,OAAQ,CAC3BvE,KAAKmN,WAAWD,EAAiB3M,SAC3BA,EAAQ0M,mBAAmBC,EAAiBzF,EACnD,CACD,EAEArH,EAMagN,iCAAb7J,eAAa6J,EAAiC3E,EAAoClI,GACjF,IAAI8M,EAEJ,GAAI5E,EAAY6E,gBAAgB/I,OAAQ,CACvC8I,EAAW5E,EAAY6E,eAAejE,IAAI9F,SAClCvD,KAAKmH,cAAc+B,EAAY3I,GAExC,KAAO,CACN8M,EAAW,EACZ,CAEA,GAAI5E,EAAYyE,iBAAiB3I,OAAQ,CACxC8I,EAASnI,KAAKlF,KAAKiN,mBAAmBxE,EAAYyE,gBAAiB3M,GACpE,CAEA,OAAO8M,EAAS9I,OAASgJ,QAAQC,IAAIH,GAAYE,QAAQE,QAAQ,GAClE,EAEArN,EAQasN,wCAAbnK,eAAamK,EACZC,EACApN,EACAkH,GAE4B,IAD5BmG,EAAoB3N,UAAAsE,OAAA,GAAAtE,UAAA,KAAAsG,UAAAtG,UAAA,GAAG,MAEvB,MAAM4N,EAAiB7N,KAAKiI,yBAAyB1H,GACrD,GAAIsN,EAAgB,CACnB,MAAMC,EAAiB,GAAGH,KAC1B,MAAMhF,EAAoB3I,KAAKsI,0BAA0BuF,GACzD,IAAIxH,EAA6B,GACjC,IAAIC,EAA0C,GAC9C,IAAIyH,EAA0C,GAC9CpD,OAAOC,KAAKjC,GACVqF,OAICC,IACA,MAAMxF,EAAoCE,EAAkBsF,GAC5D,OACExF,EAAYK,gBAAkB,IAAIoF,KACjCC,GAAeA,EAAWC,0BAA4BT,IAEvDlF,EAAYM,kBAAkBxE,SAAW,GACzCkE,EAAYM,iBAAiBmF,KAC3BG,GACAA,EAAaC,WAAWR,KAAoBO,EAAaE,QAAQT,EAAgB,IAAIrL,SAAS,QAKnG2H,QAASoE,IACT,MAAM/F,EAAcE,EAAkB6F,GACtC,GAAI/F,EAAYrB,gBAAkBwG,EAAsB,CACvD5N,KAAKmH,cAAcsB,EAAYrB,cAAe7G,EAAS,CAAEkH,WAC1D,CACApB,EAAmBA,EAAiBoI,OAAOhG,EAAYpC,kBACvDC,EAAiBA,EAAemI,OAAOhG,EAAYnC,kBAGrD,MAAMoI,EAA8B1O,KAAK2O,uBAAuB,CAC/DtI,iBAAkBA,EAClBC,eAAgBA,IAEjByH,EAAqB,IAAIW,EAA4BrI,oBAAqBqI,EAA4BpI,gBACtG,GAAIyH,EAAmBxJ,OAAQ,CAC9B,OAAOvE,KAAKiN,mBAAmBc,EAAoBxN,EAASkH,GAASmH,MAAOnJ,GAC3EoJ,EAAIpJ,MAAM,4EAA4EkI,IAAsBlI,GAE9G,CACD,CACA,OAAO8H,QAAQE,SAChB,EAEArN,EAKO0O,4BAAP,SAAOA,EAA4BvG,GAClC,OAAOvI,KAAKW,oBAAoBM,QAAQsH,IAAmB,CAAC,CAC7D,EAEAnI,EAKO2O,iCAAP,SAAOA,EAAiCxG,GACvC,OAAOvI,KAAK6K,4BAA4BhK,SAAS0H,IAAmB,EACrE,EAEAnI,EAMOgE,gCAAP,SAAOA,EAAgCmE,EAAwByG,GAC9D,OAAOhP,KAAK6K,4BAA4BjE,OAAOoI,IAAYhB,OAAQxK,GAAUA,EAAM2C,SAAWoC,IAAmB,EAClH,EAEAnI,EAOMuF,2BAANpC,eAAMoC,EAA2BnC,EAAejD,EAAkBkH,GACjE,MAAMgB,EAAczI,KAAKmJ,oCAAoC5I,EAASiD,GACtE,IAAI6C,EAA6B,GACjC,IAAIC,EAA0C,GAE9CmC,EAAY2B,QAASnE,IACpBI,EAAmBA,EAAiBoI,OAAOxI,EAAWI,kBACtDC,EAAiBA,EAAemI,OAAOxI,EAAWK,kBAGnD,MAAMoI,EAA8B1O,KAAK2O,uBAAuB,CAC/DtI,iBAAkBA,EAClBC,eAAgBA,IAEjB,MAAMyH,EAAqB,IAAIW,EAA4BrI,oBAAqBqI,EAA4BpI,gBAC5G,GAAIyH,EAAmBxJ,OAAQ,CAC9B,UACOvE,KAAKiN,mBAAmBc,EAAoBxN,EAASkH,EAC5D,CAAE,MAAOhC,GACRoJ,EAAIpJ,MAAM,8DAA8DjC,IAASiC,EAClF,CACD,CACD,EAEArF,EAMO6O,qBAAP,SAAOA,EAAqBxE,EAA0ByE,GACrD,MAAMC,EAAsBnP,KAAK+O,iCAAiCtE,GAAkBpB,IAAK+F,GACxFpP,KAAKqP,6BAA6BD,EAAgB,OAEnD,OAAOD,EAAoBV,OAC1BzO,KAAKsP,mCAAmCJ,GAAgB7F,IAAK+F,GAC5DpP,KAAKqP,6BAA6BD,IAGrC,EAEAhP,EAKOkP,mCAAP,SAAOA,EAAmCtD,GACzC,OAAOhM,KAAK6K,4BAA4BrB,WAAWwC,IAAiB,EACrE,EAGA5L,EACOmP,uBAAP,SAAOA,EAAuBC,EAAgBC,GAC7CzP,KAAKoB,gBAAgBoO,GAAUC,CAChC,EAACrP,EAEMsP,yBAAP,SAAOA,EAAyBF,UACxBxP,KAAKoB,gBAAgBoO,EAC7B,EAEApP,EACOuP,sBAAP,SAAOA,EAAsBH,GAC5B,OAAOxP,KAAKoB,gBAAgBoO,EAC7B,EAEApP,EAMQwP,kBAAR,SAAQA,EAAkB7B,EAA2ChH,GACpE,MAAM8I,EAAkB,IAAIC,IAAI/B,EAAmB1H,kBACnD,MAAM0J,EAAgB,IAAID,IAAI/B,EAAmBzH,eAAe+C,IAAKmG,GAAWA,EAAOpB,0BAEvF,IAAK,MAAMC,KAAgBN,EAAmB1H,iBAAkB,CAC/D,IAAK,MAAM2J,KAAyBhQ,KAAKiQ,gCAAgC5B,EAActH,GAAa,CACnG,MAAMmJ,EAAqBC,EAA8BH,EAAsBzD,cAC/E,GAAI2D,EAAoB,CACvBlQ,KAAKoQ,gBAAgBJ,EAAuB3B,EAAc6B,EAAoBL,EAAiBE,EAChG,CACD,CACD,CACA,MAAO,CACN1J,iBAAkBgK,MAAMC,KAAKT,GAC7BvJ,eAAgB+J,MAAMC,KAAKP,GAAe1G,IAAK8E,IACvC,CAAEC,wBAAyBD,KAGrC,EAEA/N,EAWQgQ,gBAAR,SAAQA,EACPJ,EACA3B,EACA6B,EACAL,EACAE,GAEA,MAAMQ,EAAoBC,EAA+BR,EAAuBE,GAChF,MAAMO,EACLpC,EAAaC,WAAW,MACxBiC,EAAkBG,iBAClBH,EAAkBG,gBAAgB/E,OAASqE,EAAsBU,iBAAiB/E,KAC/E,IAAI4E,EAAkBG,iBAAiBpM,qBACvCqM,EAAwBJ,EAAmB,MAC/C,MAAMK,EAAavC,EAAaC,WAAW,KACxC,IAAIiC,EAAkBG,iBAAiBpM,sBAAsBiM,EAAkBhE,aAAcZ,OAC7FkF,EAAoBN,EAAmB,MAC1C,GACCvQ,KAAK8Q,0CACJP,EACAE,EACAG,EACAf,EACAE,GAEA,CACD,GAAI/P,KAAK+Q,6CAA6Cf,EAAuBO,GAAoB,CAChGR,EAAciB,IAAIP,EACnB,KAAO,CACNZ,EAAgBmB,IAAIJ,EACrB,CACD,CACD,EAEAxQ,EAWQ0Q,0CAAR,SAAQA,EACPP,EACAE,EACAG,EACAf,EACAE,GAEA,OACCkB,EAAWV,EAAkBhE,gBAC5BsD,EAAgBqB,IAAIN,KACpBf,EAAgBqB,IAAI,GAAGT,IAAqBF,EAAkBY,qBAAqB5M,OAAS,IAAM,SAClGwL,EAAcmB,IAAI,GAAGT,IAExB,EAEArQ,EAMQ2Q,6CAAR,SAAQA,EACPf,EACAO,GAEA,OACCP,EAAsBU,kBAAoBH,EAAkBG,mBAC1DH,EAAkBY,wBAClBZ,EAAkBlM,gBAEtB,EAEAjE,EAYQgR,mBAAR,SAAQA,EACP3I,EACA1B,EACAsK,GAEA,MAAMjK,EAAgBqB,EAAY6I,cAClC,MAAMC,EAAiBvR,KAAKwR,yBAAyB/I,GACrD,IAAIsF,EAAqB,CAAE1H,iBAAkBkL,EAAelL,iBAAkBC,eAAgBiL,EAAejL,gBAC7GyH,EAAqB/N,KAAKyR,uBAAuB1D,EAAoBsD,GACrEtD,EAAqB/N,KAAK4P,kBAAkB7B,EAAoBhH,GAChEgH,EAAqB/N,KAAK2O,uBAAuBZ,GACjD,MAAO,IACHwD,KACA,CAAEjL,eAAgByH,EAAmBzH,eAAgBD,iBAAkB0H,EAAmB1H,iBAAkBe,iBAEjH,EAEAhH,EAOQoR,yBAAR,SAAQA,EAAyB/I,GAChC,MAAMiJ,EAAoBlI,GAClBA,EACJA,EAAWmI,OAAO,CAACtL,EAA4BmJ,KAC/C,IAAIxJ,EAAO,GACX,GAAI4L,EAAyBpC,GAAS,CACrCxJ,EAAOwJ,EAAOqC,KACf,MAAO,UAAWrC,IAAW,SAAU,CACtCxJ,EAAOwJ,CACR,CACA,GAAIxJ,EAAM,CACTK,EAAiBnB,KAAKc,EACvB,KAAO,CACN6I,EAAIpJ,MACH,yEAAyEgD,EAAYnE,qBAEvF,CACA,OAAO+B,GACJ,IACHmD,EAEJ,MAAMsI,EAAkBjR,GAChBA,EACJA,EAASwI,IAAK0I,IACP,CAAE3D,wBAAyB2D,EAAaF,SAE/ChR,EAMJ,MAAO,CACNyD,mBAAoBmE,EAAYnE,mBAChCyE,iBAAkB2I,EAAiBjJ,EAAYuJ,kBAC/ClJ,eAAgBgJ,EAAerJ,EAAYwJ,gBAC3CjJ,aAAeP,EAAqDyJ,aACpE7L,iBAAkBqL,EAAiBjJ,EAAY0J,mBAAkD,GACjG7L,eAAgBwL,EAAerJ,EAAY2J,iBAAmB,GAEhE,EAEAhS,EAWQ6P,gCAAR,SAAQA,EAAgC5B,EAAsBtH,GAC7D,IAAIsL,EAAwD,GAC5D,MAAMxI,EAAqB7J,KAAK8H,wBAEhC,IAAIwK,EAA0CC,EAAwCC,EACtF,GAAInE,EAAaC,WAAW,IAAItO,KAAK8J,kBAAmB,CACvD0I,EAAQnE,EAAamE,MAAMxS,KAAKgK,uBAChCsI,EAAuBE,EAAQA,EAAM,GAAKjM,SAC3C,CACA,IAAKQ,EAAY,CAChByL,EAAQnE,EAAamE,MAAMxS,KAAKkK,wBAChCqI,EAAqBC,EAAQA,EAAM,GAAKjM,SACzC,CACA,MAAMkM,EACL1L,IACEwL,EAAqB1I,EAAmB6I,YAAY,IAAIH,MAAuB/C,OAASjJ,WAC3F,MAAMoM,EACL9I,EAAmB+I,WAAWC,KAAMC,GAAqBA,EAAiB/L,aAAe0L,IACzF5I,EAAmBkJ,WAAWF,KAAMG,GAAcA,EAAUjM,aAAe0L,GAC5E,GAAIE,EAAW,CACd,MAAMzK,EAAYlI,KAAK8D,eACtBmP,EAAmB/K,EAAUgL,qBAAqB,IAAIP,EAAUhH,QACjE,GAAIsH,EAAkB,CACrB,MAAME,EAAqBjP,EAA4B+O,GACvD,MAAMG,EAAsB5C,EAC1B2C,GACCb,GAAwBjE,GAAcE,QAAQ,IAAK,KAAO,KAE5DhC,EAAe6G,EAAoB7G,aACpC,GAAI0E,EAAW1E,GAAe,CAC7B,GAAI8G,EAAc9G,EAAaI,YAAa,CAC3C0F,EAAuBA,EAAqB5D,OAC3ClC,EAAaI,WAAWnD,WAAWH,IAAKgC,GACvCmF,EAA+B4C,EAAqB/H,EAASM,OAGhE,KAAO,CACN0G,EAAqBnN,KAAKkO,EAC3B,CACD,MAAO,GAAIE,EAAa/G,GAAe,CACtC8F,EAAuBA,EAAqB5D,OAC3C2E,EAAoB/O,iBAAiB+G,iBAAiB/B,IAAKkK,GACnD/C,EAA+B4C,EAAqBG,EAAe5H,OAG7E,CACAsH,EAAiBO,SAClB,CACD,CACA,OAAOnB,EAAqBrE,OAAQoF,GAAwBA,EAAoB7G,aACjF,EAEAnM,EAIQ0D,aAAR,SAAQA,IACP,OAAO9D,KAAKS,aAAac,WAAWuC,cACrC,EAEA1D,EAOQqT,yBAAR,SAAQA,EAAyB3I,GAChC,IAAI4I,EAAe,GACnB,MAAMC,EAAqBL,EAAaxI,GACxC,MAAM/D,EAAqC4M,EAAqB7I,EAASA,EAAOL,iBAChF,MAAMmJ,EAAmB9I,EAAOjF,aAAa0F,OAC7C,GAAIqI,EAAkB,CACrB,GAAI7M,IAAe4M,EAAoB,CACtC,MAAMtC,EAAmBvG,EAAO+I,YAAYhB,KAAMiB,GAAcA,EAAUC,OAAShN,EAAWzC,oBAC9FoP,EAAerC,GAAkB/M,mBAAmB6H,MAAM,KAAK,IAAM,EACtE,CACA,OAAOnM,KAAKgU,mCAAmClJ,GAAQzB,IAAK4K,GAC3DjU,KAAKoR,mBAAmB6C,EAAgBlN,EAAY2M,GAEtD,CACA,MAAO,EACR,EAEAtT,EAMQ4T,mCAAR,SAAQA,EAAmClJ,GAC1C,MAAMrC,EAAuC,GAC7C,MAAMmL,EAAmB9I,EAAOjF,aAAa0F,OAC7C,IAAK,MAAM1C,KAAO+K,EAAkB,CACnC,MAAM1N,EAAa0N,EAAiB/K,GACpC,GAAI7I,KAAKkU,wBAAwBhO,GAAa,CAC7CuC,EAAYvD,KAAKgB,EAClB,CACD,CACA,OAAOuC,CACR,EAEArI,EAKQ8T,wBAAR,SAAQA,EAAwBhO,GAC/B,OAAQA,GAAsCiO,QAAK,gDACpD,EAEA/T,EAKQ+M,WAAR,SAAQA,EAAWD,EAAsC3M,GACxD,MAAM6T,EAAclH,EAAgByE,OAAO,SAAU0C,EAAO7E,GAC3D,MAAO,GAAG6E,UAAe7E,EAAiCpB,yBAA2BoB,GAAU,IAChG,EAAG,IACHX,EAAIyF,MAAM,4CAA4C/T,EAAQ6H,gCAAgCgM,IAC/F,EAEAhU,EAMQqR,uBAAR,SAAQA,EAAuB1D,EAA2CwG,GACzE,GAAIA,EAAsB,CACzB,MAAMC,EAA0B,SAAU3C,GACzC,OAAOA,EAAMtD,QAAQ,IAAItE,OAAO,IAAIsK,OAA2B,GAChE,EACA,MAAO,CACNlO,iBAAkB0H,EAAmB1H,iBAAiBgD,IAAKoL,GAAmBD,EAAwBC,IACtGnO,eAAgByH,EAAmBzH,eAAe+C,IAAK0I,IAC/C,CAAE3D,wBAAyBoG,EAAwBzC,EAAa3D,4BAG1E,CACA,MAAO,CACN/H,iBAAkB0H,EAAmB1H,iBACrCC,eAAgByH,EAAmBzH,eAErC,EAEAlG,EAKQuO,uBAAR,SAAQA,EAAuBZ,GAC9B,MAAM2G,EAAsB3G,EAAmBzH,eAAe+C,IAAK0I,GAAiBA,EAAa3D,yBACjG,MAAMuG,EAA6B,IAAI7E,IAAY4E,GACnD,MAAME,EAAyB,IAAI9E,IAAY/B,EAAmB1H,kBAElE,MAAMwO,EAAyBxE,MAAMC,KAAKqE,GAA4BtL,IAAKyL,IACnE,CACN1G,wBAAyB0G,KAI3B,MAAO,CAAEzO,iBAAkBgK,MAAMC,KAAKsE,GAAyBtO,eAAgBuO,EAChF,EAEAzU,EAQQsK,gCAAR,SAAQA,EAAgCpD,GACvC,MAAMmB,EAAqD,CAAC,EAC5D,MAAM6E,EAAiB,IAAIwC,IAC3B,IAAIzJ,EAA6B,GACjC,IAAIC,EAA0C,GAE9CtG,KAAKyT,yBAAyBnM,GAAQ8C,QAAS2K,IAC9C,MAAM3N,EAAgB2N,EAAgB3N,cACtCf,EAAmBA,EAAiBoI,OAAOsG,EAAgB1O,kBAC3DC,EAAiBA,EAAemI,OAAOsG,EAAgBzO,gBACvD,GAAIc,EAAe,CAClBkG,EAAe0D,IAAI5J,EACpB,IAED,MAAM2G,EAAqB/N,KAAK2O,uBAAuB,CAAEtI,mBAAkBC,mBAC3E,MAAM4C,EAAa5B,EAAOkD,QAAUlD,EAAOhD,mBAAmBkO,MAAM,YAAY,GAAKlL,EAAOqE,KAC5FlD,EAAYS,GAAe,CAC1BgE,gBAAiB,IAAIa,EAAmB1H,oBAAqB0H,EAAmBzH,gBAChFgH,eAAgB+C,MAAMC,KAAKhD,IAE5B,OAAO7E,CACR,EAEArI,EAQQkK,+BAAR,SAAQA,EAA+BvD,GACtC,MAAM4B,EAA0D,CAAC,EACjE3I,KAAKyT,yBAAyB1M,GAAYqD,QAAS3B,IAClDE,EAAkBF,EAAYnE,oBAAsBmE,IAErD,OAAOE,CACR,EAEAvI,EAQQmK,qBAAR,SAAQA,EACPxD,EACAiO,GAMA,IAAK,MAAMC,KAAwBjV,KAAKgU,mCAAmCjN,GAAa,CACvF/G,KAAKkV,4BAA4BnO,EAAYiO,EAAoBC,GACjEjV,KAAKmV,8BAA8BpO,EAAYiO,EAAoBC,GACnEjV,KAAKoV,0BAA0BrO,EAAYiO,EAAoBC,EAChE,CACD,EAEA7U,EASQ8U,4BAAR,SAAQA,EACPnO,EACAiO,EAKAC,GAEA,IAAK,MAAMI,KAAgBJ,EAAqBhD,gBAAkB,GAAI,CACrE,MAAM5N,EAAmBgR,EAAaxD,MAAQwD,EAAaC,SAAS3I,WAAa5F,EACjF,GAAI1C,EAAkB,CACrB,IAAK2Q,EAAmBnU,SAASwD,EAAiBC,oBAAqB,CACtE0Q,EAAmBnU,SAASwD,EAAiBC,oBAAsB,EACpE,CACA0Q,EAAmBnU,SAASwD,EAAiBC,oBAAoBY,KAAK,CACrEiB,OAAQY,EAAWzC,mBACnB8B,UAAW6O,EAAqB7O,WAElC,CACD,CACD,EAEAhG,EASQ+U,8BAAR,SAAQA,EACPpO,EACAiO,EAKAC,GAEA,MAAMM,EAA0BN,EAAqBjD,kBAAkBzN,SAAW,EAClF,IAAK,MAAM2K,KAAkB+F,EAAqBjD,kBAAoB,GAAI,CACzE,GAAI9C,EAAeoG,QAAS,CAC3B,IAAKN,EAAmBxL,WAAW0F,EAAeoG,QAAQhR,oBAAqB,CAC9E0Q,EAAmBxL,WAAW0F,EAAeoG,QAAQhR,oBAAsB,EAC5E,CACA0Q,EAAmBxL,WAAW0F,EAAeoG,QAAQhR,oBAAoBY,KAAK,CAC7EiB,OAAQY,EAAWzC,mBACnB8B,UAAW6O,EAAqB7O,UAChCmP,2BAEF,CACD,CACD,EAEAnV,EASQgV,0BAAR,SAAQA,EACPrO,EACAiO,EAKAC,GAEA,IAAK,MAAMO,KAAeP,EAAqB/C,cAAgB,GAAI,CAClE,IAAK8C,EAAmBpO,OAAO4O,EAAYC,YAAa,CACvDT,EAAmBpO,OAAO4O,EAAYC,YAAc,EACrD,CACAT,EAAmBpO,OAAO4O,EAAYC,YAAYvQ,KAAK,CACtDiB,OAAQY,EAAWzC,mBACnB8B,UAAW6O,EAAqB7O,WAElC,CACD,EAEAhG,EAMQiP,6BAAR,SAAQA,EAA6BD,GAAsE,IAA7BsG,EAAWzV,UAAAsE,OAAA,GAAAtE,UAAA,KAAAsG,UAAAtG,UAAA,GAAG,MAC3F,MAAM0V,EAA0BvG,EAAehJ,UAC5C,GAAGgJ,EAAejJ,UAAUiJ,EAAehJ,YAC3CgJ,EAAejJ,OAClB,OAAOuP,GAAetG,EAAemG,0BAA4B,KAC9D,GAAGI,sBACHA,CACJ,EAACvV,EAEDwV,aAAA,SAAAA,IACC,OAAO5V,IACR,EAAC,OAAAH,CAAA,CAruC6B,CAASgW,GAAO3V,EAAAL,qBAAA,IAwuCzCiW,EAAyB,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAhW,MAAAC,KAAAC,YAAAD,IAAA,CAAAG,EAAA2V,EAAAC,GAAA,IAAAC,EAAAF,EAAAzV,UAAA2V,EACxBC,eAAN1S,eAAM0S,EAAeC,GACpB,MAAMC,EAA4B,IAAItW,EAAmBqW,GACzD,OAAOC,EAA0B7M,YAClC,EAAC,OAAAwM,CAAA,CAJ6B,CAASM,GAAc,OAOvCN,CAAyB","ignoreList":[]}