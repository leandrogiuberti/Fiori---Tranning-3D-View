/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/helpers/WebSocket","sap/fe/core/templating/PropertyHelper","sap/m/MessageBox","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","../templating/DataModelPathHelper"],function(t,e,i,n,r,o,s,a,c,f){"use strict";var u={};var l=f.getTargetObjectPath;var g=f.getTargetNavigationPath;var p=f.enhanceDataModelPath;var d=o.getAssociatedTextPropertyPath;var h=r.getWebSocketChannelUrl;var E=r.getWebSocketBaseUrl;var y=r.createWebSocket;var m=r.WEBSOCKET_STATUS;var S=r.ChannelType;var v=n.isPropertyPathExpression;var P=n.isProperty;var T=n.isNavigationProperty;var C=n.isEntityType;var R=n.isEntitySet;var b=n.isComplexType;var N=i.getResourceModel;var M=e.getInvolvedDataModelObjects;var O=e.convertTypes;function $(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,D(t,e)}function D(t,e){return D=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},D(t,e)}let A=function(i){function n(){return i.apply(this,arguments)||this}u.SideEffectsService=n;$(n,i);var r=n.prototype;r.init=function t(){const e=this.getContext();this.appComponent=e?.scopeObject;this.sideEffectsRegistry={oData:{entities:{},actions:{boundActions:{},unBoundActions:{}}},control:{}};this.recommendationRegistry={roles:{}};this.targetCallbacks={}};r.initializeWebSocketConnection=function t(){const e=this.appComponent.getModel();const i=E(e);const n=h(S.SideEffectsEvents,e);if(i&&n){this.webSocket=y(S.SideEffectsEvents,e);this.webSocket.attachMessage(this.onSideEffectsEventReceived.bind(this));this.webSocketStatus=m.CONNECTED;const t=()=>{if([m.CLOSED,m.ERROR].includes(this.webSocketStatus)){const t=N(this.appComponent);const e=t.getText("C_SIDEEFFECT_CONNECTION_LOST");s.warning(e,{actions:[s.Action.OK],emphasizedAction:s.Action.OK})}};this.webSocket.attachError(()=>{this.webSocketStatus=m.ERROR;t()});this.webSocket.attachClose(e=>{if(this.webSocketStatus===m.ERROR){return}this.webSocketStatus=m.CLOSED;if(e.getParameter("code")!==1e3){t()}})}};r.onSideEffectsEventReceived=async function t(i){const n=i.getParameter("pcpFields");if(n?.serverAction!=="RaiseSideEffect"||!n.sideEffectEventName||!n.sideEffectSource){return}const r=this.getMetaModel().getMetaContext(n.sideEffectSource);const o=e.getInvolvedDataModelObjects(r);const s=this.getSideEffectWhereEventIsSource(o.targetEntityType.fullyQualifiedName,n.sideEffectEventName);if(s.length===0){return}const a=[];const c=this.appComponent.getRootViewController().getVisibleViews();for(const t of c){const e=t.getController();if(e.isA("sap.fe.core.PageController")&&e._sideEffects.isDataPathRelevant(n.sideEffectSource,n.sideEffectEventName)){a.push(e)}}if(a.length===0){return}const f=a[a.length-1]._sideEffects;const u=this.isOnlyRecommendations(o,s);const l=this.getSideEffectsInteractionType(n.sideEffectEventName,u);switch(l){case"Confirmation":try{await f.confirmDataRefresh()}catch(t){return}break;case"Notification":f.notifyDataRefresh();break;case"None":break}for(const t of a){await t._sideEffects.requestSideEffectsForEvent(n.sideEffectEventName,n.sideEffectSource)}};r.isOnlyRecommendations=function t(e,i){const n=e.targetEntityType.annotations.UI?.Recommendations?.path;for(const t of i){const i=this.sideEffectsRegistry.oData.entities[e.targetEntityType.fullyQualifiedName]?.[`${t.entity}@com.sap.vocabularies.Common.v1.SideEffects#${t.qualifier}`];if(i?.targetProperties.length===1&&i?.targetEntities.length===0&&i?.targetProperties[0]===n){return true}}return false};r.getSideEffectsInteractionType=function t(e){let i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!this.interactionTypeDefinition){this.interactionTypeDefinition=this.appComponent.getManifestEntry("sap.fe")?.app?.sideEffectsEventsInteractionType}if(i){return"None"}if(typeof this.interactionTypeDefinition==="string"){return this.interactionTypeDefinition}if(e&&this.interactionTypeDefinition?.events?.[e]){return this.interactionTypeDefinition.events[e]}if(this.interactionTypeDefinition?.default){return this.interactionTypeDefinition.default}return"Notification"};r.addControlSideEffects=function t(e,i){if(i.sourceControlId){const t={...i,fullyQualifiedName:`${e}/SideEffectsForControl/${i.sourceControlId}`};const n=this.sideEffectsRegistry.control[e]||{};n[t.sourceControlId]=t;this.sideEffectsRegistry.control[e]=n}};r.executeAction=async function t(e,i,n){const r=i.getModel().bindContext(`${e}(...)`,i);const o=n??{};const s=o.groupId||i.getBinding().getUpdateGroupId();if(o.submitBatch!=false){i.getModel().submitBatch(s)}await r.execute(s,true)};r.getConvertedMetaModel=function t(){return O(this.getMetaModel(),this.capabilities)};r.getEntityTypeFromContext=function t(e){const i=e.getModel().getMetaModel(),n=i.getMetaPath(e.getPath()),r=i.getObject(n)["$Type"];return r};r.getODataEntitySideEffects=function t(e){return this.sideEffectsRegistry.oData.entities[e]||{}};r.isControlSideEffects=function t(e){return!!e.sourceControlId};r.getGlobalODataEntitySideEffects=function t(e){const i=this.getODataEntitySideEffects(e);const n=[];for(const t in i){const e=i[t];if(!e.sourceEntities&&!e.sourceProperties&&!e.sourceEvents){n.push(e)}}return n};r.getODataActionSideEffects=function t(e,i){if(i){const t=this.getEntityTypeFromContext(i);if(t){return this.sideEffectsRegistry.oData.actions.boundActions[t]?.[e]}}else{return this.sideEffectsRegistry.oData.actions.unBoundActions?.[e]}return undefined};r.getODataSideEffectsFromContextEvent=function t(e,i){const n=e.getModel().getMetaModel().getMetaContext(e.getPath());const r=M(n);const o=this.getSideEffectWhereEventIsSource(r.targetEntityType.fullyQualifiedName,i);return o.map(t=>this.sideEffectsRegistry.oData.entities[r.targetEntityType.fullyQualifiedName]?.[`${t.entity}@com.sap.vocabularies.Common.v1.SideEffects#${t.qualifier}`])};r.initialize=async function t(){const e={entities:{},properties:{},events:{}};const i=await this.appComponent.getService("environmentCapabilities");const n=this.appComponent.getModel();if(n?.isA?.("sap.ui.model.odata.v4.ODataModel")){await n.getMetaModel().requestObject("/$EntityContainer/");this.capabilities=i.getCapabilities();const t=this.getConvertedMetaModel();this.containerName=t.entityContainer.fullyQualifiedName;this.containerRegexPattern=new RegExp(`^\\/${this.containerName}\\/[^/]+\\/(.+)?$`);this.entityTypeRegexPattern=new RegExp(`^/${this.containerName}/([^/]+)`);t.entityTypes.forEach(t=>{this.mapFieldAnnotations(t);this.sideEffectsRegistry.oData.entities[t.fullyQualifiedName]=this.retrieveODataEntitySideEffects(t);this.mapSideEffectSources(t,e)});t.actions.forEach(t=>{if(t.isBound){this.sideEffectsRegistry.oData.actions.boundActions[t.sourceEntityType.fullyQualifiedName]={...this.sideEffectsRegistry.oData.actions.boundActions[t.sourceEntityType.fullyQualifiedName],...this.retrieveODataActionsSideEffects(t)}}else{this.sideEffectsRegistry.oData.actions.unBoundActions={...this.sideEffectsRegistry.oData.actions.unBoundActions,...this.retrieveODataActionsSideEffects(t)}}});if(Object.keys(e.events).length>0){this.initializeWebSocketConnection()}}this.sourcesToSideEffectMappings=e;return this};r.mapFieldAnnotations=function t(e){const i=t=>{if(!this.recommendationRegistry.roles.hasOwnProperty(`${t}`)){this.recommendationRegistry.roles[`${t}`]={input:[],output:[]}}};e.entityProperties.forEach(t=>{const n=t.annotations.Common;if(n?.RecommendationRole){const r=n.RecommendationRole;if(r.valueOf().includes("Input")){i(`${e.name}`);this.recommendationRegistry.roles[`${e.name}`].input.push(t.name)}if(r.valueOf().includes("Output")){i(`${e.name}`);this.recommendationRegistry.roles[`${e.name}`].output.push(t.name)}}})};r.getRecommendationsMapping=function t(){return this.recommendationRegistry};r.checkIfFieldIsRecommendationRelevant=function t(i){const n=i.getBindingContext();const r=i.data().sourcePath.split("/").pop();if(n){const t=n?.getModel().getMetaModel();const i=t?.getMetaContext(n.getPath());const o=e.getInvolvedDataModelObjects(i).targetObject;let s;if(R(o)){s=o.entityType?.name}else if(T(o)){s=o.targetType?.name}const a=s&&this.recommendationRegistry.roles[s];if(a&&a?.input?.includes(r)){return true}}return false};r.getRecommendationOutputFields=function t(e){const i=this.recommendationRegistry.roles[e];if(i?.output?.length>0){return i.output}return[]};r.removeControlSideEffects=function t(e){Object.keys(this.sideEffectsRegistry.control).forEach(t=>{if(this.sideEffectsRegistry.control[t][e]){delete this.sideEffectsRegistry.control[t][e]}})};r.requestSideEffects=async function t(e,i,n){if(e.length){this.logRequest(e,i);await i.requestSideEffects(e,n)}};r.requestSideEffectsForODataAction=async function t(e,i){let n;if(e.triggerActions?.length){n=e.triggerActions.map(async t=>this.executeAction(t,i))}else{n=[]}if(e.pathExpressions?.length){n.push(this.requestSideEffects(e.pathExpressions,i))}return n.length?Promise.all(n):Promise.resolve([])};r.requestSideEffectsForNavigationProperty=async function e(i,n,r){let o=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;const s=this.getEntityTypeFromContext(n);if(s){const e=`${i}/`;const a=this.getODataEntitySideEffects(s);let c=[];let f=[];let u=[];Object.keys(a).filter(t=>{const n=a[t];return(n.sourceEntities||[]).some(t=>t.$NavigationPropertyPath===i)||n.sourceProperties?.length===1&&n.sourceProperties.some(t=>t.startsWith(e)&&!t.replace(e,"").includes("/"))}).forEach(t=>{const e=a[t];if(e.triggerAction&&!o){this.executeAction(e.triggerAction,n,{groupId:r})}c=c.concat(e.targetProperties);f=f.concat(e.targetEntities)});const l=this.removeDuplicateTargets({targetProperties:c,targetEntities:f});u=[...l.targetProperties,...l.targetEntities];if(u.length){return this.requestSideEffects(u,n,r).catch(e=>t.error(`SideEffects - Error while processing SideEffects for Navigation Property ${i}`,e))}}return Promise.resolve()};r.getControlEntitySideEffects=function t(e){return this.sideEffectsRegistry.control[e]||{}};r.getSideEffectWhereEntityIsSource=function t(e){return this.sourcesToSideEffectMappings.entities[e]||[]};r.getSideEffectWhereEventIsSource=function t(e,i){return this.sourcesToSideEffectMappings.events[i]?.filter(t=>t.entity===e)||[]};r.requestSideEffectsForEvent=async function e(i,n,r){const o=this.getODataSideEffectsFromContextEvent(n,i);let s=[];let a=[];o.forEach(t=>{s=s.concat(t.targetProperties);a=a.concat(t.targetEntities)});const c=this.removeDuplicateTargets({targetProperties:s,targetEntities:a});const f=[...c.targetProperties,...c.targetEntities];if(f.length){try{await this.requestSideEffects(f,n,r)}catch(e){t.error(`SideEffects - Error while processing SideEffects for Event ${i}`,e)}}};r.computeFieldGroupIds=function t(e,i){const n=this.getSideEffectWhereEntityIsSource(e).map(t=>this.getFieldGroupIdForSideEffect(t,true));return n.concat(this.getSideEffectWherePropertyIsSource(i).map(t=>this.getFieldGroupIdForSideEffect(t)))};r.getSideEffectWherePropertyIsSource=function t(e){return this.sourcesToSideEffectMappings.properties[e]||[]};r.registerTargetCallback=function t(e,i){this.targetCallbacks[e]=i};r.deregisterTargetCallback=function t(e){delete this.targetCallbacks[e]};r.getRegisteredCallback=function t(e){return this.targetCallbacks[e]};r.addTextProperties=function t(e,i){const n=new Set(e.targetProperties);const r=new Set(e.targetEntities.map(t=>t.$NavigationPropertyPath));for(const t of e.targetProperties){for(const e of this.getDataModelPropertiesFromAPath(t,i)){const i=d(e.targetObject);if(i){this.addTextProperty(e,t,i,n,r)}}}return{targetProperties:Array.from(n),targetEntities:Array.from(r).map(t=>({$NavigationPropertyPath:t}))}};r.addTextProperty=function t(e,i,n,r,o){const s=p(e,n);const a=i.startsWith("/")&&s.targetEntitySet&&s.targetEntitySet.name!==e.targetEntitySet?.name?`/${s.targetEntitySet?.fullyQualifiedName}`:g(s,true);const c=i.startsWith("/")?`/${s.targetEntitySet?.fullyQualifiedName}/${s.targetObject.name}`:l(s,true);if(this.isAssociatedTextListedInSideEffectTargets(s,a,c,r,o)){if(this.isPropertyAssociatedTextOnDifferentEntitySet(e,s)){o.add(a)}else{r.add(c)}}};r.isAssociatedTextListedInSideEffectTargets=function t(e,i,n,r,o){return P(e.targetObject)&&!r.has(n)&&!r.has(`${i}${e.navigationProperties.length?"/":""}*`)&&!o.has(`${i}`)};r.isPropertyAssociatedTextOnDifferentEntitySet=function t(e,i){return e.targetEntitySet!==i.targetEntitySet&&!!i.navigationProperties&&!!i.targetEntityType};r.convertSideEffects=function t(e,i,n){const r=e.TriggerAction;const o=this.convertSideEffectsFormat(e);let s={targetProperties:o.targetProperties,targetEntities:o.targetEntities};s=this.removeBindingParameter(s,n);s=this.addTextProperties(s,i);s=this.removeDuplicateTargets(s);return{...o,...{targetEntities:s.targetEntities,targetProperties:s.targetProperties,triggerAction:r}}};r.convertSideEffectsFormat=function e(i){const n=e=>e?e.reduce((e,n)=>{let r="";if(v(n)){r=n.value}else if(typeof n==="string"){r=n}if(r){e.push(r)}else{t.error(`SideEffects - Error while processing TargetProperties for SideEffects ${i.fullyQualifiedName}`)}return e},[]):e;const r=t=>t?t.map(t=>({$NavigationPropertyPath:t.value})):t;return{fullyQualifiedName:i.fullyQualifiedName,sourceProperties:n(i.SourceProperties),sourceEntities:r(i.SourceEntities),sourceEvents:i.SourceEvents,targetProperties:n(i.TargetProperties)??[],targetEntities:r(i.TargetEntities)??[]}};r.getDataModelPropertiesFromAPath=function t(e,i){let n=[];const r=this.getConvertedMetaModel();let o,s,a;if(e.startsWith(`/${this.containerName}/`)){a=e.match(this.containerRegexPattern);o=a?a[1]:undefined}if(!i){a=e.match(this.entityTypeRegexPattern);s=a?a[1]:undefined}const c=i??(s?r.resolvePath(`/${s}/`).target:undefined);const f=r.entitySets.find(t=>t.entityType===c)??r.singletons.find(t=>t.entityType===c);if(f){const t=this.getMetaModel(),i=t.createBindingContext(`/${f.name}`);if(i){const t=M(i);const r=p(t,(o||e).replace("*","")||"/"),s=r.targetObject;if(P(s)){if(b(s.targetType)){n=n.concat(s.targetType.properties.map(t=>p(r,t.name)))}else{n.push(r)}}else if(C(s)){n=n.concat(r.targetEntityType.entityProperties.map(t=>p(r,t.name)))}i.destroy()}}return n.filter(t=>t.targetObject)};r.getMetaModel=function t(){return this.appComponent.getModel().getMetaModel()};r.getSideEffectsFromSource=function t(e){let i="";const n=C(e);const r=n?e:e.sourceEntityType;const o=e.annotations?.Common;if(o){if(r&&!n){const t=e.parameters?.find(t=>t.type===r.fullyQualifiedName);i=t?.fullyQualifiedName.split("/")[1]??""}return this.getSideEffectsAnnotationFromSource(e).map(t=>this.convertSideEffects(t,r,i))}return[]};r.getSideEffectsAnnotationFromSource=function t(e){const i=[];const n=e.annotations?.Common;for(const t in n){const e=n[t];if(this.isSideEffectsAnnotation(e)){i.push(e)}}return i};r.isSideEffectsAnnotation=function t(e){return e?.$Type==="com.sap.vocabularies.Common.v1.SideEffectsType"};r.logRequest=function e(i,n){const r=i.reduce(function(t,e){return`${t}\n\t\t${e.$NavigationPropertyPath||e||""}`},"");t.debug(`SideEffects - Request:\n\tContext path : ${n.getPath()}\n\tProperty paths :${r}`)};r.removeBindingParameter=function t(e,i){if(i){const t=function(t){return t.replace(new RegExp(`^${i}/?`),"")};return{targetProperties:e.targetProperties.map(e=>t(e)),targetEntities:e.targetEntities.map(e=>({$NavigationPropertyPath:t(e.$NavigationPropertyPath)}))}}return{targetProperties:e.targetProperties,targetEntities:e.targetEntities}};r.removeDuplicateTargets=function t(e){const i=e.targetEntities.map(t=>t.$NavigationPropertyPath);const n=new Set(i);const r=new Set(e.targetProperties);const o=Array.from(n).map(t=>({$NavigationPropertyPath:t}));return{targetProperties:Array.from(r),targetEntities:o}};r.retrieveODataActionsSideEffects=function t(e){const i={};const n=new Set;let r=[];let o=[];this.getSideEffectsFromSource(e).forEach(t=>{const e=t.triggerAction;r=r.concat(t.targetProperties);o=o.concat(t.targetEntities);if(e){n.add(e)}});const s=this.removeDuplicateTargets({targetProperties:r,targetEntities:o});const a=e.isBound?e.fullyQualifiedName.match(/^[^(]+/)?.[0]:e.name;i[a]={pathExpressions:[...s.targetProperties,...s.targetEntities],triggerActions:Array.from(n)};return i};r.retrieveODataEntitySideEffects=function t(e){const i={};this.getSideEffectsFromSource(e).forEach(t=>{i[t.fullyQualifiedName]=t});return i};r.mapSideEffectSources=function t(e,i){for(const t of this.getSideEffectsAnnotationFromSource(e)){this.mapSideEffectSourceEntities(e,i,t);this.mapSideEffectSourceProperties(e,i,t);this.mapSideEffectSourceEvents(e,i,t)}};r.mapSideEffectSourceEntities=function t(e,i,n){for(const t of n.SourceEntities??[]){const r=t.value?t.$target?.targetType:e;if(r){if(!i.entities[r.fullyQualifiedName]){i.entities[r.fullyQualifiedName]=[]}i.entities[r.fullyQualifiedName].push({entity:e.fullyQualifiedName,qualifier:n.qualifier})}}};r.mapSideEffectSourceProperties=function t(e,i,n){const r=n.SourceProperties?.length===1;for(const t of n.SourceProperties??[]){if(t.$target){if(!i.properties[t.$target.fullyQualifiedName]){i.properties[t.$target.fullyQualifiedName]=[]}i.properties[t.$target.fullyQualifiedName].push({entity:e.fullyQualifiedName,qualifier:n.qualifier,hasUniqueSourceProperty:r})}}};r.mapSideEffectSourceEvents=function t(e,i,n){for(const t of n.SourceEvents??[]){if(!i.events[t.toString()]){i.events[t.toString()]=[]}i.events[t.toString()].push({entity:e.fullyQualifiedName,qualifier:n.qualifier})}};r.getFieldGroupIdForSideEffect=function t(e){let i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;const n=e.qualifier?`${e.entity}#${e.qualifier}`:e.entity;return i||e.hasUniqueSourceProperty===true?`${n}$$ImmediateRequest`:n};r.getInterface=function t(){return this};return n}(a);u.SideEffectsService=A;let x=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;i.createInstance=async function t(e){const i=new A(e);return i.initialize()};return e}(c);return x},false);
//# sourceMappingURL=SideEffectsServiceFactory.js.map