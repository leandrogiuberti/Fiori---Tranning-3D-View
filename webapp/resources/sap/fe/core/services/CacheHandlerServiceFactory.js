/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/strings/hash","sap/ui/core/cache/CacheManager","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/thirdparty/jquery"],function(e,t,n,i,jQuery){"use strict";var s={};function o(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,a(e,t)}function a(e,t){return a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},a(e,t)}async function r(e,t,n){return new Promise(function(i){jQuery.ajax(e,{method:"GET"}).done(function(s,o,a){n[e]=a.getResponseHeader("ETag")||a.getResponseHeader("Last-Modified");i(t===n[e])}).fail(function(){n[e]="";i(false)})})}let c=function(n){function i(){return n.apply(this,arguments)||this}s.CacheHandlerService=i;o(i,n);var a=i.prototype;a.init=function e(){const t=this.getContext();this.oFactory=t.factory;const n=t.settings;if(!n.metaModel){throw new Error("a `metaModel` property is expected when instantiating the CacheHandlerService")}this.oMetaModel=n.metaModel;this.oAppComponent=n.appComponent;this.oComponent=n.component;this.initPromise=this.oMetaModel.fetchEntityContainer().then(()=>this);this.mCacheNeedsInvalidate={}};a.exit=function e(){this.oFactory.removeGlobalInstance(this.oMetaModel)};a.validateCacheKey=async function e(n,i,s){let o=true;let a;try{const e=await t.get(n);const c=this.getETags(i,s);a=JSON.stringify(c);if(e){const t={};const n=JSON.parse(e.cachedETags);const i=await Promise.all(Object.keys(n).map(async function(e){if(n[e]){if(c[e]){t[e]=c[e];return n[e]===c[e]}else{return r(e,n[e],t)}}else{t[e]=c[e];return n[e]===c[e]}}));o=i.includes(false);if(Object.keys(t).some(function(e){return!t[e]})){a=null}else{a=o?JSON.stringify(t):e.viewCacheKey;a??=JSON.stringify(t)}}else if(Object.keys(c).some(function(e){return!c[e]})){a=null}}catch(e){o=true;a=null}this.mCacheNeedsInvalidate[n]=o;return a};a.invalidateIfNeeded=async function e(n,i,s,o){const a=JSON.stringify(this.getETags(s,o));if(this.mCacheNeedsInvalidate[i]||n&&n!==a){const e={};e.cachedETags=a;e.viewCacheKey=n;return t.set(i,e)}else{return Promise.resolve()}};a.getETags=function t(n,i){const s=this.oMetaModel.getETags();Object.keys(s).forEach(function(e){const t=s[e];if(t!==null&&t instanceof Date){s[e]=s[e].toISOString()}});const o=this.oAppComponent.getManifest();const a=e(JSON.stringify({sapApp:o["sap.app"],viewData:n.getViewData()}));s["manifest"]=a;const r=i.getCapabilities();if(r){s["toggles"]=e(JSON.stringify(r))}return s};a.getInterface=function e(){return this};return i}(n);s.CacheHandlerService=c;let u=function(e){function t(){var t;for(var n=arguments.length,i=new Array(n),s=0;s<n;s++){i[s]=arguments[s]}t=e.call(this,...i)||this;t._oInstanceRegistry={};return t}o(t,e);var n=t.prototype;n.createInstance=async function e(t){const n=t.settings.metaModel.getId();let i=this._oInstanceRegistry[n];if(!i){this._oInstanceRegistry[n]=i=new c(Object.assign({factory:this,scopeObject:null,scopeType:"service"},t))}return i.initPromise.then(()=>this._oInstanceRegistry[n]).catch(e=>{this._oInstanceRegistry[n]=null;throw e})};n.getInstance=function e(t){return this._oInstanceRegistry[t.getId()]};n.removeGlobalInstance=function e(t){this._oInstanceRegistry[t.getId()]=null};return t}(i);return u},false);
//# sourceMappingURL=CacheHandlerServiceFactory.js.map