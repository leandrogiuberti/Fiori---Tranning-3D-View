/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/ActivityBase","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ModelHelper","sap/m/InstanceManager","sap/m/MessageBox","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory"],function(t,e,n,o,i,s,r,c,a,l){"use strict";var u={};var d=o.getActivityKeyFromPath;var g=o.CollaborationUtils;var f=o.Activity;var p=n.isCollaborationConnected;var h=n.initializeCollaboration;var C=n.endCollaboration;var y=n.broadcastCollaborationMessage;function P(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,A(t,e)}function A(t,e){return A=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},A(t,e)}const v="/collaboration/myActivities";const m="/collaboration/activeUsers";const M="/collaboration/activities";const b="/collaboration/asyncMsgQueue";const x="/collaboration/retainedMessages";const k="/collaboration/asyncMsgTimerId";const O="$auto.sync";const D=500;let F=function(n){function o(){return n.apply(this,arguments)||this}u.CollaborativeDraftService=o;P(o,n);var a=o.prototype;a.checkPathForLock=function t(e,n){const o=e.getProperty(v);if(!o){return false}else{return o.includes(n)}};a.setLock=function t(e,n){const o=e.getProperty(v)??[];if(!o.includes(n)){o.push(n)}e.setProperty(v,o)};a.removeLock=function t(e,n){const o=e.getProperty(v);if(!o||n===undefined){return false}const i=Array.isArray(n)?n:[n];const s=o.filter(t=>!i.includes(t));e.setProperty(v,s);return s.length!==o.length};a.getLockedProperties=function t(e){const n=e.getProperty(v);if(!n){return undefined}else{return n.join("|")}};a.updateLocksForContextPath=function t(e,n,o){if(!this.isConnected(e)){return}const i=e.getModel("internal");const s=i.getProperty(b);s.forEach(t=>{if(t.path.startsWith(n)){t.path=t.path.replace(n,o)}});const r=i.getProperty(v);if(r){const t=[];const s=[];r.forEach(e=>{if(e.startsWith(n)){const i=e.replace(n,o);t.push(i)}else{s.push(e)}});i.setProperty(v,s);if(t.length!==0){this.send(e,{action:f.Lock,content:t})}}};a.resetAsyncMessagesTimer=function t(e){let n=e.getProperty(k);if(n!==undefined){clearTimeout(n)}n=setTimeout(()=>{const t=e.getProperty(b);const n=[];const o=e.getProperty(x)??[];if(!t){return}t.forEach(t=>{if(o.includes(t.path)){n.push(t)}else{this.doSend(e,t.action,t.path)}});e.setProperty(b,n);e.setProperty(k,undefined);if(n.length){this.resetAsyncMessagesTimer(e)}},D);e.setProperty(k,n)};a.retainAsyncMessages=function t(e,n){const o=e.getModel("internal");const i=Array.isArray(n)?n:[n];const s=o.getProperty(x);i.forEach(t=>{if(!s.includes(t)){s.push(t)}})};a.releaseAsyncMessages=function t(e,n){const o=e.getModel("internal");const i=o.getProperty(x);const s=Array.isArray(n)?n:[n];o.setProperty(x,i.filter(t=>!s.includes(t)))};a.isConnected=function t(e){const n=e.getModel("internal");return p(n)};a.send=function t(e,n){if(this.isConnected(e)){const t=e.getModel("internal");if(n.action===f.Lock||n.action===f.Unlock){this.doSendAsync(t,n.action,n.content)}else{this.doSend(t,n.action,n.content,n.triggeredActionName,n.refreshListBinding,n.actionRequestedProperties)}}};a.doSend=function t(e,n,o,i,s,r){const c=(Array.isArray(o)?o.join("|"):o)??"";const a=r?.join("|");if(n===f.Lock){const t=(Array.isArray(o)?o[0]:o)??"";if(this.checkPathForLock(e,t)){return}else{this.setLock(e,t)}}else if(n===f.Unlock){const t=this.removeLock(e,o);if(!t){return}}y(n,c,e,i,s,a)};a.doSendAsync=function t(e,n,o){if(o===undefined){return}const i=e.getProperty(b);const s=Array.isArray(o)?o:[o];const r=i.filter(t=>!s.includes(t.path));s.forEach(t=>{r.push({path:t,action:n})});e.setProperty(b,r);this.resetAsyncMessagesTimer(e)};a.isCollaborationEnabled=function t(e){const n=e?.getBindingContext&&e.getBindingContext();return!!(n&&s.isCollaborationDraftSupported(n.getModel().getMetaModel()))};a.connect=async function t(n,o){const i=o.getModel("internal");const s=g.getMe(e.getAppComponent(o));if(!s){return}const r=await n.requestProperty("DraftAdministrativeData/DraftUUID");if(!r){return}const c=h(s,r,i,t=>{this.messageReceive(t,o)},o);if(c){i.setProperty(v,[]);i.setProperty(b,[]);i.setProperty(x,[])}};a.disconnect=function t(e){const n=e.getModel("internal");C(n)};a.userJoinDraft=function t(e,n,o,i,s){if(e.findIndex(t=>t.id===o.id)===-1){e.unshift(o);n.setProperty(m,e)}if(i.userAction===f.Join){y(f.JoinEcho,this.getLockedProperties(n),n)}if(i.userAction===f.JoinEcho){if(i.clientContent){i.userAction=f.LockEcho;this.messageReceive(i,s)}}};a.userLeaveDraft=function t(e,n,o){e=e.filter(t=>t.id!==o.id||t.me);n.setProperty(m,e);const i=n.getProperty(M)||{};const s=function(t){if(Array.isArray(t)){return t.filter(t=>t.id!==o.id)}else{for(const e in t){t[e]=s(t[e])}return t}};s(i);n.setProperty(M,i)};a.messageReceive=function t(e,n){const o=n.getModel("internal");const i=o.getProperty(m);let s;let r;const c=this.calculateMetaPath(n,e.clientContent);e.userAction=e.userAction||e.clientAction;const a={id:e.userID,name:e.userDescription,initials:g.formatInitials(e.userDescription),color:g.getUserColor(e.userID,i,[])};let l=a;switch(e.userAction){case f.Join:case f.JoinEcho:this.userJoinDraft(i,o,a,e,n);break;case f.Leave:this.userLeaveDraft(i,o,a);break;case f.Change:this.updateOnChange(n,e);break;case f.Create:this.updateOnCreate(n,e);break;case f.Delete:this.updateOnDelete(n,e);break;case f.Activate:this.draftClosedByOtherUser(n,e.clientContent,g.getText("C_COLLABORATIONDRAFT_ACTIVATE",a.name));break;case f.Discard:this.draftClosedByOtherUser(n,e.clientContent,g.getText("C_COLLABORATIONDRAFT_DISCARD",a.name));break;case f.Action:this.updateOnAction(n,e);break;case f.Lock:case f.LockEcho:l=a;l.key=d(e.clientContent);let t="";const u=c.split("/");for(let e=1;e<u.length-1;e++){t+=`/${u[e]}`;if(!o.getProperty(M+t)){o.setProperty(M+t,{})}}s=o.getProperty(M+c);s=s?.slice?s.slice():[];s.push(l);o.setProperty(M+c,s);if(e.userAction===f.LockEcho&&this.checkPathForLock(o,e.clientContent)){this.doSend(o,f.Unlock,e.clientContent)}break;case f.Unlock:s=o.getProperty(M+c);r=d(e.clientContent);o.setProperty(M+c,s?.filter(t=>t.key!==r));break}};a.draftClosedByOtherUser=function e(n,o,i){this.disconnect(n);c.information(i,{onClose:async()=>{try{await n.getBindingContext().getBinding().resetChanges();if(r.hasOpenDialog()){r.closeAllDialogs(()=>{})}this.navigate(o,n);return}catch(e){t.error("Pending Changes could not be reset - still navigating to active instance");this.navigate(o,n)}}})};a.updateOnChange=function t(e,n){const o=n.clientContent.split("|");const i=this.getCurrentPage(e);const s=i.getBindingContext();const r=o.map(async t=>this.applyUpdatesForChange(e,t));i.getController().editFlow.updateDocument(s,Promise.all(r))};a.applyUpdatesForChange=async function e(n,o){const s=n.getModel().getMetaModel();const r=s.getMetaContext(o);const c=i.getInvolvedDataModelObjects(r);const a=o.substring(0,o.lastIndexOf("/"));const l=this.findContextForUpdate(n,a);const u=a.substring(0,a.lastIndexOf("("));const d=u.substring(0,u.lastIndexOf("/"));const f=d?this.findContextForUpdate(n,d):undefined;if(!l&&!f){return}try{const t=[];const e=g.getAppComponent(n).getSideEffectsService();if(l){const n=s.getMetaPath(l.getPath());const i=s.getMetaPath(o).replace(n,"").slice(1);t.push(e.requestSideEffects([i],l,O))}const i=e.computeFieldGroupIds(c.targetEntityType.fullyQualifiedName,c.targetObject.fullyQualifiedName);if(i.length){const e=n.getController();const o=e._sideEffects.getSideEffectsMapForFieldGroups(i,l||f);Object.keys(o).forEach(n=>{const i=o[n];t.push(e._sideEffects.requestSideEffects(i.sideEffects,i.context,O,undefined,true))})}await Promise.all(t)}catch(e){t.error("Failed to update data after change:"+e);throw e}};a.updateOnDelete=function t(e,n){const o=this.getCurrentPage(e);const i=o.getBindingContext();const s=i.getPath();const r=n.clientContent.split("|");const a=r.find(t=>s.startsWith(t));if(a){c.information(g.getText("C_COLLABORATIONDRAFT_DELETE",n.userDescription),{onClose:()=>{const t=i.getModel().getKeepAliveContext(a);t.setKeepAlive(false);const n=this.applyUpdatesForCollection(e,r[0]);o.getController().editFlow.updateDocument(o.getBindingContext(),n);o.getController()._routing.navigateBackFromContext(t)}})}else{const t=this.applyUpdatesForCollection(e,r[0]);o.getController().editFlow.updateDocument(o.getBindingContext(),t)}};a.updateOnCreate=function t(e,n){const o=this.getCurrentPage(e);const i=n.clientContent.split("|");const s=this.applyUpdatesForCollection(e,i[0]);o.getController().editFlow.updateDocument(o.getBindingContext(),s)};a.applyUpdatesForCollection=async function e(n,o){const i=g.getAppComponent(n);const s=o.substring(0,o.lastIndexOf("/"));const r=this.findContextForUpdate(n,s);if(r){try{const t=[];const e=r.getModel().getMetaModel();const n=e.getMetaPath(o);const s=e.getMetaPath(r.getPath());const c=n.replace(`${s}/`,"");const a=i.getSideEffectsService();t.push(a.requestSideEffects([c],r,O));t.push(a.requestSideEffectsForNavigationProperty(c,r,O,true));await Promise.all(t)}catch(e){t.error("Failed to update data after collection update:"+e)}}};a.updateOnAction=function t(e,n){const o=this.getCurrentPage(e);const i=n.clientContent.split("|");const s=n.clientTriggeredActionName||"";const r=n.clientRequestedProperties?.split("|");const c=n.clientRefreshListBinding==="true";let a=[];if(c){a.push(this.applyUpdatesForCollection(e,i[0]))}else{a=i.map(async t=>this.requestUpdateForAction(e,t,s,r))}o.getController().editFlow.updateDocument(o.getBindingContext(),Promise.all(a))};a.requestUpdateForAction=async function t(e,n,o,s){const r=this.findContextForUpdate(e,n);if(!r){return}const c=g.getAppComponent(e);const a=c.getSideEffectsService();const l=a.getODataActionSideEffects(o,r);const u=[];if(l){if(l.pathExpressions?.length){u.push(a.requestSideEffects(l.pathExpressions,r,O))}}if(s&&s.length>0){const t=e.getModel().getMetaModel();const o=this.calculateMetaPath(e,n);const c=i.getInvolvedDataModelObjects(t.getContext(o));const l=c.targetEntityType.entityProperties.map(t=>t.name).filter(t=>s.includes(t));if(l.length>0){u.push(a.requestSideEffects(l,r,O))}}await Promise.all(u)};a.findContextForUpdate=function t(e,n){if(!n){return undefined}const o=[];while(!n.endsWith(")")){o.unshift(n);n=n.substring(0,n.lastIndexOf("/"))}o.unshift(n);const i=n.substring(0,n.lastIndexOf("("));let s;let r=this.getCurrentPage(e).getBindingContext();while(r&&!s){if(o.includes(r.getPath())){s=r}r=r.getBinding()?.getContext()}if(s){return s}const c=this.getCurrentPage(e).getBindingContext().getModel();const a=c.getAllBindings().find(t=>{const e=t.isRelative()?t.getResolvedPath():t.getPath();return t.isA("sap.ui.model.odata.v4.ODataListBinding")&&e===i});s=a?.getAllCurrentContexts().find(t=>o.includes(t.getPath()));return s};a.navigate=function t(e,n){const o=this.getCurrentPage(n);const i=n.getModel().bindContext(e).getBoundContext();if(o.getController().editFlow.getCreationMode()){o.getController()._routing.navigateBackFromContext(i)}else{o.getController()._routing.navigateToContext(i,{recreateContext:true})}};a.getCurrentPage=function t(n){const o=g.getAppComponent(n);return e.getCurrentPageView(o)};a.calculateMetaPath=function t(e,n){let o="";if(n){const t=n.split("|")[0];o=e.getModel().getMetaModel().getMetaPath(t)}return o};a.init=function t(){this.initPromise=Promise.resolve(this)};return o}(a);u.CollaborativeDraftService=F;let E=function(t){function e(){return t.apply(this,arguments)||this}u=e;P(e,t);var n=e.prototype;n.createInstance=async function t(e){const n=new F(e);return n.initPromise};return e}(l);u=E;return u},false);
//# sourceMappingURL=collaborativeDraftServiceFactory.js.map