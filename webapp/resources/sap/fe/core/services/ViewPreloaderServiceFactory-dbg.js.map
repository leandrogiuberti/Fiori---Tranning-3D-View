{"version":3,"names":["ViewPreloaderService","_Service","_this","_len","arguments","length","args","Array","_key","call","newViews","_exports","_inheritsLoose","_proto","prototype","init","initPromise","Promise","resolve","appComponent","getContext","scopeObject","setCache","routeConfig","routeArguments","bindingPattern","pattern","path","RoutingHelpler","buildBindingPath","isCacheReady","targetConfig","target","isArray","forEach","targetName","model","getModel","setCurrentCacheEntryByTargetName","currentCacheentry","viewPreloaderCache","getCurrentCacheEntry","visitedContextPath","startsWith","push","manifestContent","getManifest","shouldRefreshView","pageLevelRequestPromises","preloadConfigurationProperties","map","sPath","record","value","requestPropertyOrSingleton","values","aResults","all","reduce","acc","curr","key","Object","keys","viewShouldbeRefreshed","setCacheReady","propOrSingletonPath","pageBindingPath","isSingleton","__","entity","property","exec","contextPath","bindingProperty","getAllBindings","find","binding","getPath","getValue","bindProperty","requestValue","isReady","cacheReady","getCacheEntryByTargetName","cacheEntry","addEntryToCache","Service","ViewPreloaderServiceFactory","_ServiceFactory","apply","_proto2","createInstance","oServiceContext","instance","getInstance","ServiceFactory"],"sourceRoot":".","sources":["ViewPreloaderServiceFactory.ts"],"sourcesContent":["import type { Route } from \"@ui5/manifest/types/manifest\";\nimport type { PageLevelCache } from \"sap/fe/base/ViewPreloaderCache\";\nimport { viewPreloaderCache } from \"sap/fe/base/ViewPreloaderCache\";\nimport Service from \"sap/ui/core/service/Service\";\nimport ServiceFactory from \"sap/ui/core/service/ServiceFactory\";\nimport type ODataPropertyBinding from \"sap/ui/model/odata/ODataPropertyBinding\";\nimport type ODataModel from \"sap/ui/model/odata/v4/ODataModel\";\nimport type { ServiceContext } from \"types/metamodel_types\";\nimport type AppComponent from \"../AppComponent\";\nimport RoutingHelpler from \"../helpers/RoutingHelper\";\n\nexport class ViewPreloaderService extends Service<{}> {\n\tinitPromise!: Promise<ViewPreloaderService>;\n\n\tprivate appComponent!: AppComponent;\n\n\tprivate cacheReady: Promise<void[]> | undefined;\n\n\tinit(): void {\n\t\tthis.initPromise = new Promise((resolve) => {\n\t\t\tthis.appComponent = this.getContext().scopeObject as AppComponent;\n\t\t\tresolve(this);\n\t\t});\n\t}\n\n\t/**\n\t * Sets the cache for the current route.\n\t * @param routeConfig The route configuration.\n\t * @param routeArguments The route arguments.\n\t * @param appComponent\n\t */\n\tsetCache(routeConfig: Route, routeArguments: Record<string, string | object>, appComponent: AppComponent): void {\n\t\tconst bindingPattern = routeConfig.pattern as string;\n\t\tconst { path } = RoutingHelpler.buildBindingPath(routeArguments, bindingPattern, {});\n\t\tconst isCacheReady: Promise<void>[] = [];\n\t\tlet targetConfig = routeConfig.target as string | string[];\n\t\ttargetConfig = Array.isArray(targetConfig) ? targetConfig : [targetConfig];\n\n\t\ttargetConfig.forEach((targetName: string) => {\n\t\t\tconst model = appComponent.getModel();\n\n\t\t\tthis.setCurrentCacheEntryByTargetName(targetName);\n\t\t\tconst currentCacheentry = viewPreloaderCache.getCurrentCacheEntry();\n\n\t\t\tif (currentCacheentry.visitedContextPath?.startsWith(path)) {\n\t\t\t\tisCacheReady.push(Promise.resolve());\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tisCacheReady.push(\n\t\t\t\tnew Promise<void>(async (resolve) => {\n\t\t\t\t\tconst manifestContent = appComponent.getManifest();\n\t\t\t\t\tlet shouldRefreshView = false;\n\t\t\t\t\tconst pageLevelRequestPromises =\n\t\t\t\t\t\tmanifestContent[\"sap.ui5\"][\"routing\"]?.[\"targets\"]?.[targetName]?.[\"options\"]?.[\n\t\t\t\t\t\t\t\"settings\"\n\t\t\t\t\t\t]?.preloadConfigurationProperties?.map(async (sPath: string) => {\n\t\t\t\t\t\t\tconst record = {} as Record<string, unknown>;\n\t\t\t\t\t\t\tconst value = await this.requestPropertyOrSingleton(sPath, model, path);\n\t\t\t\t\t\t\tshouldRefreshView = currentCacheentry.values?.[sPath] !== value ? true : shouldRefreshView;\n\t\t\t\t\t\t\trecord[sPath] = value;\n\t\t\t\t\t\t\treturn record;\n\t\t\t\t\t\t}) ?? [];\n\n\t\t\t\t\t// all promises are resolved and the results are merged into a single object\n\t\t\t\t\tconst aResults = (await Promise.all(pageLevelRequestPromises)).reduce(\n\t\t\t\t\t\t(acc, curr) => {\n\t\t\t\t\t\t\tconst key = Object.keys(curr)[0];\n\t\t\t\t\t\t\tacc[key] = curr[key];\n\t\t\t\t\t\t\treturn acc;\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{} as Record<string, unknown>\n\t\t\t\t\t);\n\n\t\t\t\t\tshouldRefreshView = !currentCacheentry.visitedContextPath ? false : shouldRefreshView; //if first page loading, the refreshing of the view is not needed\n\t\t\t\t\tcurrentCacheentry.visitedContextPath = path;\n\t\t\t\t\tcurrentCacheentry.values = aResults;\n\t\t\t\t\tcurrentCacheentry.viewShouldbeRefreshed = shouldRefreshView;\n\t\t\t\t\tresolve();\n\t\t\t\t})\n\t\t\t);\n\t\t});\n\t\tthis.setCacheReady(Promise.all(isCacheReady));\n\t}\n\n\t/**\n\t * Requests a property or singleton value from the model.\n\t * If the property is not bound, it binds it and requests its value.\n\t * @param propOrSingletonPath The path to the property or singleton.\n\t * @param model The OData model.\n\t * @param pageBindingPath The binding path of the page.\n\t * @returns The value of the property or singleton.\n\t */\n\tasync requestPropertyOrSingleton(propOrSingletonPath: string, model: ODataModel, pageBindingPath: string): Promise<unknown> {\n\t\tconst isSingleton = propOrSingletonPath.startsWith(\"/\"); // if starts with /, it is a singletonasync\n\t\tconst [__, entity, property] = [...(/(?:(.*)\\/){0,1}([^/]*)/.exec(propOrSingletonPath) as string[])];\n\t\t// eg: /Products/ID -> entity: Products, property: ID\n\t\t// eg: status -> entity: undefined, property: status\n\n\t\tconst contextPath = isSingleton ? entity : pageBindingPath;\n\t\tlet value: unknown;\n\n\t\t// we check first if the property is already bound in order to use its cached value\n\t\t// otherwise we bind the property and request its value\n\t\tconst bindingProperty = model\n\t\t\t.getAllBindings()\n\t\t\t.find((binding) => binding.getContext()?.getPath() === contextPath && binding.getPath() === property) as\n\t\t\t| ODataPropertyBinding\n\t\t\t| undefined;\n\t\tvalue = bindingProperty?.getValue();\n\t\tif (!value) {\n\t\t\tvalue = await model.bindProperty(`${contextPath}/${property}`).requestValue();\n\t\t}\n\n\t\treturn value;\n\t}\n\n\tprivate newViews: Promise<void>[] = [];\n\n\t/**\n\t *  Sets the cache ready state.\n\t * @param isReady\n\t */\n\tsetCacheReady(isReady: Promise<void[]>): void {\n\t\tthis.cacheReady = isReady;\n\t}\n\n\t/**\n\t * Returns the cache ready state.\n\t * @returns The cache ready state.\n\t */\n\tasync isCacheReady(): Promise<boolean> {\n\t\tawait this.cacheReady;\n\t\treturn true;\n\t}\n\n\t/**\n\t * Returns the current cache entry for the app component.\n\t * @returns  The current cache entry for the app component.\n\t */\n\tgetCurrentCacheEntry(): PageLevelCache {\n\t\treturn viewPreloaderCache.getCurrentCacheEntry();\n\t}\n\n\t/**\n\t *Returns the full cache object, which contains all application level caches.\n\t * @param targetName\n\t * @returns The full cache object for the app component.\n\t */\n\tgetCacheEntryByTargetName(targetName: string): PageLevelCache | undefined {\n\t\treturn viewPreloaderCache.getCacheEntryByTargetName(targetName, this.appComponent);\n\t}\n\n\t/**\n\t * Sets the current cache entry by the target name.\n\t * If the target name does not exist, it creates a new cache entry and adds it to the full cache.\n\t * @param targetName\n\t */\n\tsetCurrentCacheEntryByTargetName(targetName: string): void {\n\t\tconst cacheEntry = this.getCacheEntryByTargetName(targetName) ?? { values: {} };\n\t\tviewPreloaderCache.addEntryToCache(cacheEntry, targetName, this.appComponent);\n\t}\n}\n\nexport class ViewPreloaderServiceFactory extends ServiceFactory<{}> {\n\tprivate instance!: ViewPreloaderService;\n\n\tasync createInstance(oServiceContext: ServiceContext<{}>): Promise<ViewPreloaderService> {\n\t\tthis.instance = new ViewPreloaderService(oServiceContext);\n\t\treturn this.instance.initPromise;\n\t}\n\n\tgetInstance(): ViewPreloaderService {\n\t\treturn this.instance;\n\t}\n}\n"],"mappings":"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","ignoreList":[],"file":"ViewPreloaderServiceFactory-dbg.js"}