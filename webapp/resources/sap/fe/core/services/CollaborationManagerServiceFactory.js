/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Lib","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory"],function(e,t,r,i){"use strict";function s(e){return new Promise((t,r)=>{sap.ui.require([e],r=>{if(!(r&&r.__esModule)){r=r===null||!(typeof r==="object"&&e.endsWith("/library"))?{default:r}:r;Object.defineProperty(r,"__esModule",{value:true})}t(r)},e=>{r(e)})})}var n={};function a(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,o(e,t)}function o(e,t){return o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},o(e,t)}let c=function(r){function i(){var e;for(var t=arguments.length,i=new Array(t),s=0;s<t;s++){i[s]=arguments[s]}e=r.call(this,...i)||this;e.__implements__sap_insights_ICardProvider=true;e.registered=false;e.sharedCardsPerView={};return e}n.CollaborationManagerService=i;a(i,r);var o=i.prototype;o.init=function e(){this.initPromise=new Promise(e=>{this.appComponent=this.getContext().scopeObject;e(this)})};o.getCardsChannel=async function e(){const{default:t}=await s("sap/insights/CardHelper");const r=await t.getServiceAsync("UIService");return r.getCardsChannel()};o.connect=async function t(r,i){try{const e=await this.getCardsChannel();if(e.isEnabled()){this.onRetrieveAvailableCards=i;this.channel=e;this.id=r;this.consumers={};this.sharedCards=[];if(this.registered!==true){await this.registerProvider()}this.updateConsumers()}}catch(t){e.debug("Collaboration Manager connection failed",t)}return this};o.onConsumerConnected=async function e(t){if(!this.consumers[t]){this.consumers[t]=true;await(this.onRetrieveAvailableCards?.());this.shareAvailableCards(t)}return Promise.resolve(Object.keys(this.consumers).length)};o.onConsumerDisconnected=async function e(t){if(this.consumers[t]){delete this.consumers[t]}return Promise.resolve(Object.keys(this.consumers).length)};o.onCardRequested=function e(t,r){const i=Object.values(this.sharedCardsPerView).flat().find(e=>e?.id===r);i?.callback?.(i.card);return i};o.onViewUpdate=async function e(t){if(this.registered!==t){if(t){await this.registerProvider();this.updateConsumers()}else{await this.unregisterProvider()}}else if(this.registered){this.updateConsumers()}};o.registerProvider=async function e(){if(this.channel){await this.channel.registerProvider(this.id,this);this.registered=true}};o.unregisterProvider=async function e(){if(this.channel){await this.channel.unregister(this.id);this.registered=false;this.consumers={};this.sharedCards=[];this.onRetrieveAvailableCards=undefined}};o.updateConsumers=function e(){this.shareAvailableCards()};o.shareAvailableCards=function e(){let t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"*";let r=this.sharedCards;const i=this.appComponent.getRootViewController();if(i.isFclEnabled()){const e=i.getRightmostView().getId();r=this.sharedCardsPerView[e]}this?.channel?.publishAvailableCards(this.id,r,t)};o.addCardsToCollaborationManager=function e(t,r,i){this.sharedCards=[];for(const[e,i]of Object.entries(t)){this.sharedCards.push({id:e,title:i.title,parentAppId:r,callback:i.callback,card:i.card})}this.sharedCardsPerView[i]=this.sharedCards};o.getDesignTimeCard=async function r(i){var s=this;return new Promise((r,n)=>{t.load({name:"sap/cards/ap/common"}).then(()=>{sap.ui.require(["sap/cards/ap/common/services/RetrieveCard"],async function(){for(var t=arguments.length,n=new Array(t),a=0;a<t;a++){n[a]=arguments[a]}const o=n[0];let c;const h=s.appComponent;try{c=await o.getObjectPageCardManifestForPreview(h,{cardType:i})}catch(t){e.error(t)}r(c)});return}).catch(function(t){e.error(t);n()})})};o.publishCard=function e(t){this.channel.publishCard(this.id,{id:t["sap.app"].id,descriptorContent:t},"*")};return i}(r);n.CollaborationManagerService=c;let h=function(e){function t(){return e.apply(this,arguments)||this}n=t;a(t,e);var r=t.prototype;r.createInstance=async function e(t){this.instance=new c(t);return this.instance.initPromise};r.getInstance=function e(){return this.instance};r.shareAvailableCards=function e(){this.instance.shareAvailableCards()};return t}(i);h.serviceClass=c;n=h;return n},false);
//# sourceMappingURL=CollaborationManagerServiceFactory.js.map