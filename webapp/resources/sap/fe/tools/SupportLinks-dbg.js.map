{"version":3,"names":["FE","window","opener","$fe","supportLinkTimeout","supportLinksModel","supportLinkFunction","getMetaPath","_element","element","isA","viewData","getViewData","contextPath","entitySet","mainPropertyRelativePath","annotatedActionIdentifier","getCustomData","find","data","getKey","getValue","split","pop","metaPath","getParent","loadSupportLinks","model","supportModel","odataModel","getModel","setProperty","serviceRoot","getServiceUrl","startsWith","url","URL","pathname","useBackendUrl","URLSearchParams","location","search","get","proxy","backendUrl","protocol","replace","hostname","port","metaModel","getMetaModel","supportLinkAnnotations","getObject","resolvedUrl","Url","supportLinkServiceUrl","ODataModel","serviceUrl","requestObject","error","FunctionImport","functionCall","bindContext","cacheToken","join","cachedRequests","getProperty","setParameter","execute","links","getBoundContext","value","link","_exports","loadSupportLinksForElement","debounce","func","delay","_len","arguments","length","args","Array","_key","undefined","clearTimeout","setTimeout","debouncedGetSupportLinks"],"sourceRoot":".","sources":["SupportLinks.ts"],"sourcesContent":["import type { ViewData } from \"sap/fe/core/services/TemplatedViewServiceFactory\";\nimport type Field from \"sap/fe/macros/Field\";\nimport type TableAPI from \"sap/fe/macros/table/TableAPI\";\nimport type Button from \"sap/m/Button\";\nimport type ManagedObject from \"sap/ui/base/ManagedObject\";\nimport type UI5Element from \"sap/ui/core/Element\";\nimport type View from \"sap/ui/core/mvc/View\";\nimport ODataModel from \"sap/ui/model/odata/v4/ODataModel\";\n\n// @ts-ignore\nconst FE = window?.opener?.$fe ?? window?.$fe;\n\nlet supportLinkTimeout: number | undefined;\nlet supportLinksModel: ODataModel | undefined;\nlet supportLinkFunction: string | undefined;\nconst getMetaPath = function (_element: UI5Element): string | undefined {\n\tlet element: UI5Element | null | ManagedObject = _element;\n\twhile (element) {\n\t\tif (element.isA<View>(\"sap.ui.core.mvc.View\")) {\n\t\t\tconst viewData = element.getViewData() as ViewData | undefined;\n\t\t\treturn viewData?.contextPath || \"/\" + viewData?.entitySet;\n\t\t} else if (element.isA<Field>(\"sap.fe.macros.Field\")) {\n\t\t\treturn element.contextPath + \"/\" + element.mainPropertyRelativePath;\n\t\t} else if (element.isA<Button>(\"sap.m.Button\")) {\n\t\t\t// That's just an ugly POC to get the action name, we need to find a better way\n\t\t\tconst annotatedActionIdentifier = element\n\t\t\t\t.getCustomData()\n\t\t\t\t?.find((data) => data.getKey() === \"annotatedActionIdentifier\")\n\t\t\t\t?.getValue();\n\t\t\tif (annotatedActionIdentifier) {\n\t\t\t\treturn annotatedActionIdentifier.split(\"::\")[1].split(\".\").pop();\n\t\t\t}\n\t\t} else if (element.isA<TableAPI>(\"sap.fe.macros.table.TableAPI\")) {\n\t\t\treturn element.metaPath.split(\"/@\")[0];\n\t\t}\n\t\telement = element.getParent();\n\t}\n\treturn;\n};\n\nexport const loadSupportLinks = async function (element: UI5Element): Promise<void> {\n\tconst model = FE.supportModel;\n\tconst odataModel = element.getModel() as ODataModel | undefined;\n\tif (!odataModel) {\n\t\treturn;\n\t}\n\tmodel.setProperty(\"/supportLinksStateText\", \"Loading...\");\n\tlet serviceRoot = odataModel.getServiceUrl();\n\n\tif (!serviceRoot.startsWith(\"/\")) {\n\t\t// in a local scenario, the service URL also contains the host and port, we need to remove it\n\t\tconst url = new URL(serviceRoot);\n\t\tserviceRoot = url.pathname;\n\t}\n\n\t// create model to read the service\n\tif (!supportLinksModel) {\n\t\tconst useBackendUrl = new URLSearchParams(window.location.search).get(\"useBackendUrl\");\n\t\tlet proxy = \"\";\n\t\tif (useBackendUrl) {\n\t\t\tconst backendUrl = new URL(useBackendUrl);\n\t\t\tproxy = `/databinding/proxy/${backendUrl.protocol.replace(\":\", \"\")}/${backendUrl.hostname}:${backendUrl.port}`;\n\t\t}\n\n\t\tconst metaModel = odataModel.getMetaModel();\n\t\t// annotations not yet finalized / merged\n\t\ttype SupportLinkAnnotations = {\n\t\t\tFunctionImport: string;\n\t\t\tUrl: string;\n\t\t};\n\n\t\tconst supportLinkAnnotations = metaModel.getObject(\"/@com.sap.vocabularies.Support.v1.TechnicalInfoLinks\") as\n\t\t\t| SupportLinkAnnotations\n\t\t\t| undefined;\n\t\tif (!supportLinkAnnotations) {\n\t\t\tmodel.setProperty(\"/supportLinksStateText\", \"Service links not implemented for this application\");\n\t\t\treturn;\n\t\t}\n\n\t\tconst resolvedUrl = new URL(supportLinkAnnotations.Url, `http://dummy${serviceRoot}`).pathname;\n\t\tconst supportLinkServiceUrl = resolvedUrl.replace(/\\/\\$metadata$/, \"/\");\n\t\tsupportLinksModel = new ODataModel({ serviceUrl: `${proxy}${supportLinkServiceUrl}` });\n\n\t\ttry {\n\t\t\tawait supportLinksModel.getMetaModel().requestObject(\"/\");\n\t\t} catch (error) {\n\t\t\tmodel.setProperty(\"/supportLinksStateText\", \"System/Application does not provide service implementation information\");\n\t\t\treturn;\n\t\t}\n\n\t\tsupportLinkFunction = supportLinkAnnotations.FunctionImport;\n\t}\n\n\tif (!supportLinkFunction) {\n\t\treturn;\n\t}\n\n\tconst metaPath = getMetaPath(element);\n\n\tif (metaPath) {\n\t\tconst functionCall = supportLinksModel.bindContext(`/${supportLinkFunction}(...)`);\n\t\tconst cacheToken = metaPath.split(\"/\").join(\"_\");\n\t\tconst cachedRequests = model.getProperty(\"/cachedSupportLinks/\" + cacheToken);\n\n\t\tif (cachedRequests) {\n\t\t\tmodel.setProperty(\"/supportLinks\", cachedRequests);\n\t\t} else {\n\t\t\t// finally call the service\n\t\t\tfunctionCall.setParameter(\"ServiceRoot\", serviceRoot);\n\t\t\tfunctionCall.setParameter(\"EdmPath\", metaPath.replace(/^\\//, \"\")); // without leading slash\n\t\t\ttry {\n\t\t\t\tawait functionCall.execute(\"$auto\");\n\t\t\t\tconst links = functionCall.getBoundContext().getObject().value;\n\t\t\t\tfor (const link of links) {\n\t\t\t\t\tif (link.Url?.startsWith(\"../\")) {\n\t\t\t\t\t\t// relative URL, we need to resolve it\n\t\t\t\t\t\tlink.Url = new URL(link.Url, `http://dummy${supportLinksModel.getServiceUrl()}`).pathname;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tmodel.setProperty(\"/supportLinks\", links);\n\t\t\t\tmodel.setProperty(\"/cachedSupportLinks/\" + cacheToken, links);\n\t\t\t} catch (error) {\n\t\t\t\tmodel.setProperty(\"/supportLinks\", []);\n\t\t\t\tmodel.setProperty(\"/supportLinksStateText\", \"Failed to load service implementation links\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n\tmodel.setProperty(\"/supportLinksStateText\", \"No service implementation links were found\");\n};\n\nexport const loadSupportLinksForElement = function (element: UI5Element): void {\n\t// debounce the call and only request if the user stays on a control for a while\n\tconst debounce = (func: Function, delay: number) => {\n\t\treturn function (...args: any[]) {\n\t\t\tif (supportLinkTimeout !== undefined) {\n\t\t\t\tclearTimeout(supportLinkTimeout);\n\t\t\t}\n\t\t\tsupportLinkTimeout = window.setTimeout(() => {\n\t\t\t\tfunc(...args);\n\t\t\t}, delay);\n\t\t};\n\t};\n\tconst debouncedGetSupportLinks = debounce(loadSupportLinks, 500);\n\tdebouncedGetSupportLinks(element);\n};\n"],"mappings":"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","ignoreList":[],"file":"SupportLinks-dbg.js"}