{"version":3,"file":"SupportLinks.js","names":["FE","window","opener","$fe","supportLinkTimeout","supportLinksModel","supportLinkFunction","getMetaPath","_element","element","isA","viewData","getViewData","contextPath","entitySet","mainPropertyRelativePath","annotatedActionIdentifier","getCustomData","find","data","getKey","getValue","split","pop","metaPath","getParent","loadSupportLinks","async","model","supportModel","odataModel","getModel","setProperty","serviceRoot","getServiceUrl","startsWith","url","URL","pathname","useBackendUrl","URLSearchParams","location","search","get","proxy","backendUrl","protocol","replace","hostname","port","metaModel","getMetaModel","supportLinkAnnotations","getObject","resolvedUrl","Url","supportLinkServiceUrl","ODataModel","serviceUrl","requestObject","error","FunctionImport","functionCall","bindContext","cacheToken","join","cachedRequests","getProperty","setParameter","execute","links","getBoundContext","value","link","_exports","loadSupportLinksForElement","debounce","func","delay","_len","arguments","length","args","Array","_key","undefined","clearTimeout","setTimeout","debouncedGetSupportLinks"],"sources":["./SupportLinks.ts"],"sourcesContent":["import type { ViewData } from \"sap/fe/core/services/TemplatedViewServiceFactory\";\nimport type Field from \"sap/fe/macros/Field\";\nimport type TableAPI from \"sap/fe/macros/table/TableAPI\";\nimport type Button from \"sap/m/Button\";\nimport type ManagedObject from \"sap/ui/base/ManagedObject\";\nimport type UI5Element from \"sap/ui/core/Element\";\nimport type View from \"sap/ui/core/mvc/View\";\nimport ODataModel from \"sap/ui/model/odata/v4/ODataModel\";\n\n// @ts-ignore\nconst FE = window?.opener?.$fe ?? window?.$fe;\n\nlet supportLinkTimeout: number | undefined;\nlet supportLinksModel: ODataModel | undefined;\nlet supportLinkFunction: string | undefined;\nconst getMetaPath = function (_element: UI5Element): string | undefined {\n\tlet element: UI5Element | null | ManagedObject = _element;\n\twhile (element) {\n\t\tif (element.isA<View>(\"sap.ui.core.mvc.View\")) {\n\t\t\tconst viewData = element.getViewData() as ViewData | undefined;\n\t\t\treturn viewData?.contextPath || \"/\" + viewData?.entitySet;\n\t\t} else if (element.isA<Field>(\"sap.fe.macros.Field\")) {\n\t\t\treturn element.contextPath + \"/\" + element.mainPropertyRelativePath;\n\t\t} else if (element.isA<Button>(\"sap.m.Button\")) {\n\t\t\t// That's just an ugly POC to get the action name, we need to find a better way\n\t\t\tconst annotatedActionIdentifier = element\n\t\t\t\t.getCustomData()\n\t\t\t\t?.find((data) => data.getKey() === \"annotatedActionIdentifier\")\n\t\t\t\t?.getValue();\n\t\t\tif (annotatedActionIdentifier) {\n\t\t\t\treturn annotatedActionIdentifier.split(\"::\")[1].split(\".\").pop();\n\t\t\t}\n\t\t} else if (element.isA<TableAPI>(\"sap.fe.macros.table.TableAPI\")) {\n\t\t\treturn element.metaPath.split(\"/@\")[0];\n\t\t}\n\t\telement = element.getParent();\n\t}\n\treturn;\n};\n\nexport const loadSupportLinks = async function (element: UI5Element): Promise<void> {\n\tconst model = FE.supportModel;\n\tconst odataModel = element.getModel() as ODataModel | undefined;\n\tif (!odataModel) {\n\t\treturn;\n\t}\n\tmodel.setProperty(\"/supportLinksStateText\", \"Loading...\");\n\tlet serviceRoot = odataModel.getServiceUrl();\n\n\tif (!serviceRoot.startsWith(\"/\")) {\n\t\t// in a local scenario, the service URL also contains the host and port, we need to remove it\n\t\tconst url = new URL(serviceRoot);\n\t\tserviceRoot = url.pathname;\n\t}\n\n\t// create model to read the service\n\tif (!supportLinksModel) {\n\t\tconst useBackendUrl = new URLSearchParams(window.location.search).get(\"useBackendUrl\");\n\t\tlet proxy = \"\";\n\t\tif (useBackendUrl) {\n\t\t\tconst backendUrl = new URL(useBackendUrl);\n\t\t\tproxy = `/databinding/proxy/${backendUrl.protocol.replace(\":\", \"\")}/${backendUrl.hostname}:${backendUrl.port}`;\n\t\t}\n\n\t\tconst metaModel = odataModel.getMetaModel();\n\t\t// annotations not yet finalized / merged\n\t\ttype SupportLinkAnnotations = {\n\t\t\tFunctionImport: string;\n\t\t\tUrl: string;\n\t\t};\n\n\t\tconst supportLinkAnnotations = metaModel.getObject(\"/@com.sap.vocabularies.Support.v1.TechnicalInfoLinks\") as\n\t\t\t| SupportLinkAnnotations\n\t\t\t| undefined;\n\t\tif (!supportLinkAnnotations) {\n\t\t\tmodel.setProperty(\"/supportLinksStateText\", \"Service links not implemented for this application\");\n\t\t\treturn;\n\t\t}\n\n\t\tconst resolvedUrl = new URL(supportLinkAnnotations.Url, `http://dummy${serviceRoot}`).pathname;\n\t\tconst supportLinkServiceUrl = resolvedUrl.replace(/\\/\\$metadata$/, \"/\");\n\t\tsupportLinksModel = new ODataModel({ serviceUrl: `${proxy}${supportLinkServiceUrl}` });\n\n\t\ttry {\n\t\t\tawait supportLinksModel.getMetaModel().requestObject(\"/\");\n\t\t} catch (error) {\n\t\t\tmodel.setProperty(\"/supportLinksStateText\", \"System/Application does not provide service implementation information\");\n\t\t\treturn;\n\t\t}\n\n\t\tsupportLinkFunction = supportLinkAnnotations.FunctionImport;\n\t}\n\n\tif (!supportLinkFunction) {\n\t\treturn;\n\t}\n\n\tconst metaPath = getMetaPath(element);\n\n\tif (metaPath) {\n\t\tconst functionCall = supportLinksModel.bindContext(`/${supportLinkFunction}(...)`);\n\t\tconst cacheToken = metaPath.split(\"/\").join(\"_\");\n\t\tconst cachedRequests = model.getProperty(\"/cachedSupportLinks/\" + cacheToken);\n\n\t\tif (cachedRequests) {\n\t\t\tmodel.setProperty(\"/supportLinks\", cachedRequests);\n\t\t} else {\n\t\t\t// finally call the service\n\t\t\tfunctionCall.setParameter(\"ServiceRoot\", serviceRoot);\n\t\t\tfunctionCall.setParameter(\"EdmPath\", metaPath.replace(/^\\//, \"\")); // without leading slash\n\t\t\ttry {\n\t\t\t\tawait functionCall.execute(\"$auto\");\n\t\t\t\tconst links = functionCall.getBoundContext().getObject().value;\n\t\t\t\tfor (const link of links) {\n\t\t\t\t\tif (link.Url?.startsWith(\"../\")) {\n\t\t\t\t\t\t// relative URL, we need to resolve it\n\t\t\t\t\t\tlink.Url = new URL(link.Url, `http://dummy${supportLinksModel.getServiceUrl()}`).pathname;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tmodel.setProperty(\"/supportLinks\", links);\n\t\t\t\tmodel.setProperty(\"/cachedSupportLinks/\" + cacheToken, links);\n\t\t\t} catch (error) {\n\t\t\t\tmodel.setProperty(\"/supportLinks\", []);\n\t\t\t\tmodel.setProperty(\"/supportLinksStateText\", \"Failed to load service implementation links\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n\tmodel.setProperty(\"/supportLinksStateText\", \"No service implementation links were found\");\n};\n\nexport const loadSupportLinksForElement = function (element: UI5Element): void {\n\t// debounce the call and only request if the user stays on a control for a while\n\tconst debounce = (func: Function, delay: number) => {\n\t\treturn function (...args: any[]) {\n\t\t\tif (supportLinkTimeout !== undefined) {\n\t\t\t\tclearTimeout(supportLinkTimeout);\n\t\t\t}\n\t\t\tsupportLinkTimeout = window.setTimeout(() => {\n\t\t\t\tfunc(...args);\n\t\t\t}, delay);\n\t\t};\n\t};\n\tconst debouncedGetSupportLinks = debounce(loadSupportLinks, 500);\n\tdebouncedGetSupportLinks(element);\n};\n"],"mappings":"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","ignoreList":[]}