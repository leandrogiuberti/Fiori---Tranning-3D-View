/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/base/BindingToolkit","sap/fe/base/ClassSupport","sap/fe/core/buildingBlocks/BuildingBlock","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/formatters/CollaborationFormatter","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/PromiseKeeper","sap/fe/core/helpers/TypeGuards","sap/fe/macros/CommonHelper","sap/m/Avatar","sap/m/Button","sap/m/Dialog","sap/m/HBox","sap/m/Label","sap/m/MessageStrip","sap/m/MessageToast","sap/m/ObjectStatus","sap/m/ResponsivePopover","sap/m/Text","sap/m/VBox","sap/ui/core/Lib","sap/ui/core/library","sap/ui/mdc/Field","sap/ui/mdc/ValueHelp","sap/ui/mdc/valuehelp/Dialog","sap/ui/mdc/valuehelp/Popover","sap/ui/mdc/valuehelp/content/MTable","sap/fe/base/jsx-runtime/jsx","sap/fe/base/jsx-runtime/jsxs","sap/fe/base/jsx-runtime/Fragment"],function(e,t,a,n,i,r,s,o,l,c,d,u,g,p,h,T,m,I,f,C,b,D,O,A,U,v,_,N,S,y){"use strict";var x,R,L,E,B,P,M;function w(e){return new Promise((t,a)=>{sap.ui.require([e],a=>{if(!(a&&a.__esModule)){a=a===null||!(typeof a==="object"&&e.endsWith("/library"))?{default:a}:a;Object.defineProperty(a,"__esModule",{value:true})}t(a)},e=>{a(e)})})}var F={};var V=D.ValueState;var j=o.isPathAnnotationExpression;var H=o.isAnnotationOfType;var G=n.shareObject;var k=n.UserStatus;var z=n.UserEditingState;var W=n.CollaborationUtils;var $=t.property;var q=t.defineUI5Class;var Y=e.getExpressionFromAnnotation;var X=e.formatResult;var K=e.compileExpression;function Q(e,t,a,n){a&&Object.defineProperty(e,t,{enumerable:a.enumerable,configurable:a.configurable,writable:a.writable,value:a.initializer?a.initializer.call(n):void 0})}function J(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,Z(e,t)}function Z(e,t){return Z=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Z(e,t)}function ee(e,t,a,n,i){var r={};return Object.keys(n).forEach(function(e){r[e]=n[e]}),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=a.slice().reverse().reduce(function(a,n){return n(e,t,a)||a},r),i&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(i):void 0,r.initializer=void 0),void 0===r.initializer?(Object.defineProperty(e,t,r),null):r}function te(e,t){throw Error("Decorating class property failed. Please ensure that transform-class-properties is enabled and runs after the decorators transform.")}const ae="Users";const ne="UserID";let ie=(x=q("sap.fe.templates.ObjectPage.components.CollaborationDraft"),R=$({type:"string",required:true}),L=$({type:"string"}),x(E=(B=function(e){function t(t,a){var n;n=e.call(this,t,a)||this;Q(n,"contextPath",P,n);Q(n,"id",M,n);n.showCollaborationUserDetails=e=>{const t=e.getSource();if(!n.userDetailsPopover){n.userDetailsPopover=n.getUserDetailsPopover()}n.userDetailsPopover?.setBindingContext(t.getBindingContext("internal"),"internal");n.userDetailsPopover?.openBy(t)};n.manageCollaboration=()=>{if(!n.manageDialog){n.manageDialog=n.getManageDialog()}n.readInvitedUsers();n.manageDialog?.open()};n.formatUserStatus=e=>{switch(e){case k.CurrentlyEditing:return n.getTranslatedText("C_COLLABORATIONDRAFT_USER_CURRENTLY_EDITING");case k.ChangesMade:return n.getTranslatedText("C_COLLABORATIONDRAFT_USER_CHANGES_MADE");case k.NoChangesMade:return n.getTranslatedText("C_COLLABORATIONDRAFT_USER_NO_CHANGES_MADE");case k.NotYetInvited:default:return n.getTranslatedText("C_COLLABORATIONDRAFT_USER_NOT_YET_INVITED")}};n.addUserFieldChanged=async e=>{const t=e.getSource();return e.getParameter("promise")?.then(function(e){const a=t.getBindingContext("internal");const n=a.getProperty("invitedUsers")||[];const i={id:a?.getProperty("UserID"),name:a?.getProperty("UserDescription")};if(n.findIndex(t=>t.id===e)>-1){t.setValueState("Error");t.setValueStateText(this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_USER_ERROR"))}else if(!(n.findIndex(e=>e.id===i.id)>-1||i.id===i.name&&i.id==="")){this.addUser(t,n,i);t.setValueState("None");t.setValueStateText("")}}.bind(n)).catch(function(){t.setValueState("Warning");t.setValueStateText(this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_USER_NOT_FOUND"))}.bind(n))};n.inviteUser=async e=>{const t=[],a=[];const i=e.getSource();const r=i.getBindingContext();const s=(n.manageDialogUserTable?.getBinding("rows")).getContexts();s.forEach(function(e){t.push({UserID:e.getProperty("id"),UserAccessRole:"O"});if(e.getProperty("status")===k.NotYetInvited){a.push(e.getProperty("id"))}});try{const e=await Promise.all([G(r,t),n.requestInvitedUsersInDraft()]);const i=[];e[1].forEach(e=>{if(a.includes(e.getProperty("UserID"))){i.push(e)}});const s=n.getPageController().messageHandler;await s.showMessageDialog();switch(i.length){case 0:T.show(n.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_SUCCESS_TOAST_NO_USER",[n.getSharedItemName(r)]));break;case 1:T.show(n.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_SUCCESS_TOAST",[n.getSharedItemName(r)]));break;default:T.show(n.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_SUCCESS_TOAST_PLURAL",[i.length.toString(),n.getSharedItemName(r)]))}}catch{T.show(n.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_FAILED_TOAST"))}n.closeManageDialog()};n.readInvitedUsers=async()=>{const e=n.getBindingContext("internal");try{const t=await n.requestInvitedUsersInDraft();const a=[];const i=n.getModel("internal")?.getProperty("/collaboration/activeUsers")||[];const r=W.getMe(n.getAppComponent());let s;if(t.length>0){t.forEach(e=>{const t=e.getObject();const n=r?.id===t.UserID;const o=i.find(e=>e.id===t.UserID);let l=t.UserDescription||t.UserID;const c=W.formatInitials(l);l=n?`${W.getText("C_COLLABORATIONDRAFT_ME",l)}`:l;if(o){s=k.CurrentlyEditing}else if(t.UserEditingState===z.InProgress){s=k.ChangesMade}else{s=k.NoChangesMade}const d={id:t.UserID,name:l,status:s,color:W.getUserColor(t.UserID,i,a),initials:c,me:n};a.push(d)})}else{a.push(r)}e.setProperty("collaboration/UserID","");e.setProperty("collaboration/UserDescription","");e.setProperty("collaboration/invitedUsers",a)}catch(e){T.show(n.getTranslatedText("C_COLLABORATIONDRAFT_READING_USER_FAILED"))}};n.closeManageDialog=()=>{n.manageDialog?.close();n.manageDialog?.destroy();delete n.manageDialog};return n}F=t;J(t,e);var a=t.prototype;a.onMetadataAvailable=async function e(a){this._controlLoaded=new s;if(t.GridTableControl===undefined){await b.load({name:"sap.ui.table"});const{default:e}=await w("sap/ui/table/Table");t.GridTableControl=e;const{default:a}=await w("sap/ui/table/Column");t.GridTableColumnControl=a}this.contextObject=this.getDataModelObjectPath(this.contextPath);this.content=this.createContent();this._controlLoaded.resolve()};a.getUserDetailsPopover=function e(){const t=N(I,{showHeader:false,class:"sapUiContentPadding",placement:"Bottom",children:S(g,{children:[N(c,{initials:"{internal>initials}",displaySize:"S",backgroundColor:"{internal>color}"}),S(C,{children:[N(p,{class:"sapUiMediumMarginBegin",text:"{internal>name}"}),N(p,{class:"sapUiMediumMarginBegin",text:"{internal>id}"})]})]})});this.addDependent(t);return t};a.getManageDialog=function e(){const t=N(u,{title:this.getInvitationDialogTitleExpBinding(),horizontalScrolling:"False",verticalScrolling:"False",contentWidth:"35em",stretch:l.isDesktop()?"false":"true",children:{beginButton:N(d,{text:this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_DIALOG_CONFIRMATION"),press:this.inviteUser,type:"Emphasized",enabled:{parts:[{path:"internal>invitedUsers/length"},{path:"internal>invitedUsers"}],formatter:this.formatInviteButton}}),endButton:N(d,{text:this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_DIALOG_CANCEL"),press:this.closeManageDialog}),content:S(C,{class:"sapUiSmallMargin",children:[N(C,{width:"100%",children:N(h,{text:this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_MESSAGESTRIP"),type:"Information",showIcon:true,showCloseButton:false,class:"sapUiMediumMarginBottom"})}),N(p,{text:this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_INPUT_LABEL"),required:true}),this.getManageDialogAddUserSection(),this.getManageDialogUserTable()]})}});this.addDependent(t);t.bindElement({model:"internal",path:"collaboration"});return t};a.getManageDialogUserTableColumns=function e(){return S(y,{children:[N(t.GridTableColumnControl,{width:l.isDesktop()?"10%":"3em",children:{template:N(g,{alignItems:"Center",justifyContent:"SpaceBetween",children:N(c,{displaySize:"XS",backgroundColor:"{internal>color}",initials:"{internal>initials}"})})}}),N(t.GridTableColumnControl,{width:l.isDesktop()?"35%":"6em",children:{label:N(f,{text:this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_TABLE_USER_COLUMN")}),template:N(f,{text:"{internal>name}"})}}),N(t.GridTableColumnControl,{width:l.isDesktop()?"46%":"9em",children:{label:N(f,{text:this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_TABLE_USER_STATUS_COLUMN")}),template:N(m,{state:{path:"internal>status",formatter:this.formatUserStatusColor},text:{path:"internal>status",formatter:this.formatUserStatus}})}}),N(t.GridTableColumnControl,{width:l.isDesktop()?"8%":"3em",children:{template:N(g,{children:N(d,{icon:"sap-icon://decline",type:"Transparent",press:this.removeUser,visible:"{= !!${internal>transient} }"})})}})]})};a.getManageDialogUserTable=function e(){this.manageDialogUserTable=N(t.GridTableControl,{width:"100%",rows:{path:"internal>invitedUsers"},visibleRowCount:l.isDesktop()?"5":"3",visibleRowCountMode:"Fixed",selectionMode:"None",children:{columns:this.getManageDialogUserTableColumns()}});return this.manageDialogUserTable};a.getManageDialogAddUserSection=function e(){return N(g,{class:"sapUiMediumMarginBottom",width:"100%",children:N(O,{value:"{internal>UserID}",additionalValue:"{internal>UserDescription}",display:"DescriptionValue",width:"20em",required:true,valueHelp:"userValueHelp",placeholder:this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_INPUT_PLACEHOLDER"),change:this.addUserFieldChanged,children:{dependents:N(A,{id:"userValueHelp",delegate:this.getValueHelpDelegate(),validateInput:true,children:{typeahead:N(v,{children:N(_,{caseSensitive:"true",useAsValueHelp:"false"})}),dialog:N(U,{})}})}})})};a.formatUserStatusColor=function e(t){switch(t){case k.CurrentlyEditing:return V.Success;case k.ChangesMade:return V.Warning;case k.NoChangesMade:case k.NotYetInvited:default:return V.Information}};a.formatInviteButton=function e(t,a){if(!t){return false}return!!a?.some(e=>e.status===0)};a.addUser=function e(t,a,n){const i=t.getBindingContext("internal");const r=t.getModel("internal").getProperty("/collaboration/activeUsers");n.name=n.name||n.id;n.initials=W.formatInitials(n.name);n.color=W.getUserColor(n.id,r,a);n.transient=true;n.status=k.NotYetInvited;a.push(n);i.setProperty("invitedUsers",a);i.setProperty("UserID","");i.setProperty("UserDescription","")};a.removeUser=function e(t){const a=t.getSource();const n=a?.getBindingContext("pageInternal");const i=a?.getBindingContext("internal")?.getProperty("id");let r=n?.getProperty("collaboration/invitedUsers");r=r.filter(e=>e.id!==i);n?.setProperty("collaboration/invitedUsers",r)};a.requestInvitedUsersInDraft=async function e(){const t=this.getModel();const a={$select:"UserID,UserDescription,UserEditingState",$$groupId:"$auto.Workers"};const n=t?.bindList(`${this.getBindingContext()?.getPath()}/DraftAdministrativeData/DraftAdministrativeUser`,undefined,[],[],a);return n.requestContexts(0,100)};a.getSharedItemName=function e(t){const a=this.contextObject?.targetEntityType.annotations.UI?.HeaderInfo;let n="";const i=a?.Title;if(i&&H(i,["com.sap.vocabularies.UI.v1.DataField","com.sap.vocabularies.UI.v1.DataFieldWithAction","com.sap.vocabularies.UI.v1.DataFieldWithActionGroup","com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath","com.sap.vocabularies.UI.v1.DataFieldWithIntentBasedNavigation","com.sap.vocabularies.UI.v1.DataFieldWithUrl","com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath"])){n=j(i.Value)?t.getProperty(i.Value.path):i.Value}return n||a?.TypeName||""};a.getValueHelpDelegate=function e(){const t=(this.contextObject?.targetEntitySet.annotations.Common).DraftRoot.ShareAction.toString();const a=this.contextObject?.targetEntityType.resolvePath(t);const n=a.parameters.find(e=>e.name===ae);return{name:"sap/fe/macros/valuehelp/ValueHelpDelegate",payload:{propertyPath:`/${n.type}/${ne}`,qualifiers:{},valueHelpQualifier:"",isActionParameterDialog:true}}};a.getInvitationDialogTitleExpBinding=function e(){const t=this.contextObject?.targetEntityType.annotations.UI?.HeaderInfo;const a=Y(t?.Title?.Value,[],"");const n=["C_COLLABORATIONDRAFT_INVITATION_DIALOG",t?.TypeName.toString(),a];const r=X(n,i.getFormattedText);return K(r)};a.getInviteButton=function e(){if(this.contextObject?.targetEntitySet?.annotations.Common?.DraftRoot?.ShareAction){return N(g,{visible:"{ui>/isEditable}",alignItems:"Center",justifyContent:"Start",children:N(c,{backgroundColor:"TileIcon",src:"sap-icon://add-employee",displaySize:"XS",press:this.manageCollaboration})})}else{return N(g,{})}};a.createContent=function e(){if(this._getOwner()?.getMetaModel()&&r.isCollaborationDraftSupported(this._getOwner().getMetaModel())){return S(g,{children:[N(g,{items:{path:"internal>/collaboration/activeUsers"},class:"sapUiTinyMarginBegin",visible:"{= ${ui>/isEditable} && ${internal>/collaboration/connected} }",alignItems:"Center",justifyContent:"Start",children:N(c,{initials:"{internal>initials}",displaySize:"XS",backgroundColor:"{internal>color}",press:this.showCollaborationUserDetails})}),this.getInviteButton()]})}};return t}(a),P=ee(B.prototype,"contextPath",[R],{configurable:true,enumerable:true,writable:true,initializer:null}),M=ee(B.prototype,"id",[L],{configurable:true,enumerable:true,writable:true,initializer:null}),B))||E);F=ie;return F},false);
//# sourceMappingURL=CollaborationDraft.js.map