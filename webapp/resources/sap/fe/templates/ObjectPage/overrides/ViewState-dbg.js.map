{"version":3,"names":["VariantManagement","CoreLibrary","opControlHandlers","retrieve","oOPLayout","selectedSection","getSelectedSection","apply","opLayout","controlState","opSectionToSelect","getSections","find","section","getId","getVisible","controller","getView","getController","pageReady","waitPageReady","then","setSelectedSection","undefined","catch","err","message","Error","String","Log","error","refreshBinding","oBindingContext","getBindingContext","oBinding","getBinding","sMetaPath","ModelHelper","getMetaPathForContext","sStrategy","KeepAliveHelper","getControlRefreshStrategyForContextPath","oModel","getModel","oMetaModel","getMetaModel","oNavigationProperties","CommonUtils","getContextPathProperties","$kind","aNavPropertiesToRequest","Object","keys","reduce","aPrev","sNavProp","$isCollection","push","$NavigationPropertyPath","aProperties","$PropertyPath","sGroupId","getGroupId","requestSideEffects","concat","refresh","info","ViewStateExtensionOverride","_getObjectPageLayout","view","_getObjectPageLayoutControl","_getOPStateHandler","control","viewOP","call","_getOPRefreshHandler","adaptControlStateHandler","controlStateHandlers","opStateHandler","adaptBindingRefreshHandler","controlRefreshHandlers","applyInitialStateOnly","adaptStateControls","aStateControls","oView","base","oViewData","getViewData","variantManagement","Control","Page","None","byId","adaptBindingRefreshControls","aControls","sRefreshStrategy","getViewRefreshInfo","oController","aControlsToRefresh","oObjectPageControl","aViewControls","_findTables","getControlsForRefresh","aPrevControls","oControl","includes"],"sourceRoot":".","sources":["ViewState.ts"],"sourcesContent":["import Log from \"sap/base/Log\";\nimport CommonUtils from \"sap/fe/core/CommonUtils\";\nimport type ViewState from \"sap/fe/core/controllerextensions/ViewState\";\nimport { type ControlStateHandler } from \"sap/fe/core/controllerextensions/ViewState\";\nimport KeepAliveHelper from \"sap/fe/core/helpers/KeepAliveHelper\";\nimport ModelHelper from \"sap/fe/core/helpers/ModelHelper\";\nimport CoreLibrary from \"sap/fe/core/library\";\nimport type ObjectPageController from \"sap/fe/templates/ObjectPage/ObjectPageController.controller\";\nimport type ManagedObject from \"sap/ui/base/ManagedObject\";\nimport type Control from \"sap/ui/core/Control\";\nimport type ODataV4Context from \"sap/ui/model/odata/v4/Context\";\nimport type ObjectPageLayout from \"sap/uxap/ObjectPageLayout\";\nimport type ObjectPageSection from \"sap/uxap/ObjectPageSection\";\nimport type { MetaModelNavProperty } from \"types/metamodel_types\";\n\nconst VariantManagement = CoreLibrary.VariantManagement;\nexport type ObjectPageState = { selectedSection: string | null };\n\nconst opControlHandlers = {\n\tretrieve: function (oOPLayout: ObjectPageLayout): ObjectPageState {\n\t\treturn {\n\t\t\tselectedSection: oOPLayout.getSelectedSection()\n\t\t};\n\t},\n\tapply: function (this: ViewState, opLayout: ObjectPageLayout, controlState?: { selectedSection: string | null }): void {\n\t\tconst selectedSection = controlState?.selectedSection;\n\t\tif (selectedSection) {\n\t\t\tconst opSectionToSelect = opLayout.getSections().find((section: ObjectPageSection) => section.getId() === selectedSection);\n\t\t\tif (opSectionToSelect?.getVisible() === false) {\n\t\t\t\tconst controller = this.getView().getController() as ObjectPageController;\n\t\t\t\tcontroller.pageReady\n\t\t\t\t\t.waitPageReady()\n\t\t\t\t\t.then(function (): void {\n\t\t\t\t\t\topLayout.setSelectedSection(selectedSection);\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t})\n\t\t\t\t\t.catch((err: unknown): void => {\n\t\t\t\t\t\tconst message = err instanceof Error ? err.message : String(err);\n\t\t\t\t\t\tLog.error(`FE V4 : OP : ViewState : ObjectPageLayout state couldn't be applied : ${message}`);\n\t\t\t\t\t});\n\t\t\t} else {\n\t\t\t\topLayout.setSelectedSection(selectedSection);\n\t\t\t}\n\t\t}\n\t},\n\trefreshBinding: function (oOPLayout: ObjectPageLayout): void {\n\t\tconst oBindingContext = oOPLayout.getBindingContext() as ODataV4Context | undefined;\n\t\tconst oBinding = oBindingContext && oBindingContext.getBinding();\n\t\tif (oBinding) {\n\t\t\tconst sMetaPath = ModelHelper.getMetaPathForContext(oBindingContext);\n\t\t\tconst sStrategy = KeepAliveHelper.getControlRefreshStrategyForContextPath(oOPLayout, sMetaPath);\n\t\t\tif (sStrategy === \"self\") {\n\t\t\t\t// Refresh main context and 1-1 navigation properties or OP\n\t\t\t\tconst oModel = oBindingContext.getModel(),\n\t\t\t\t\toMetaModel = oModel.getMetaModel(),\n\t\t\t\t\toNavigationProperties: Record<string, MetaModelNavProperty> =\n\t\t\t\t\t\t(CommonUtils.getContextPathProperties(oMetaModel, sMetaPath, {\n\t\t\t\t\t\t\t$kind: \"NavigationProperty\"\n\t\t\t\t\t\t}) as Record<string, MetaModelNavProperty>) || {},\n\t\t\t\t\taNavPropertiesToRequest = Object.keys(oNavigationProperties).reduce(function (\n\t\t\t\t\t\taPrev: { $NavigationPropertyPath: string }[],\n\t\t\t\t\t\tsNavProp: string\n\t\t\t\t\t) {\n\t\t\t\t\t\tif (oNavigationProperties[sNavProp].$isCollection !== true) {\n\t\t\t\t\t\t\taPrev.push({ $NavigationPropertyPath: sNavProp });\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn aPrev;\n\t\t\t\t\t}, []),\n\t\t\t\t\taProperties: ({ $NavigationPropertyPath: string } | { $PropertyPath: string })[] = [{ $PropertyPath: \"*\" }],\n\t\t\t\t\tsGroupId = oBinding.getGroupId();\n\n\t\t\t\toBindingContext.requestSideEffects(aProperties.concat(aNavPropertiesToRequest), sGroupId);\n\t\t\t} else if (sStrategy === \"includingDependents\") {\n\t\t\t\t// Complete refresh\n\t\t\t\toBinding.refresh();\n\t\t\t}\n\t\t} else {\n\t\t\tLog.info(`ObjectPage: ${oOPLayout.getId()} was not refreshed. No binding found!`);\n\t\t}\n\t}\n};\n\nconst ViewStateExtensionOverride = {\n\t_getObjectPageLayout: function (this: ViewState): ObjectPageLayout {\n\t\tconst view = this.getView();\n\t\tconst controller = view.getController() as ObjectPageController;\n\t\treturn controller._getObjectPageLayoutControl();\n\t},\n\n\t/**\n\t * Get the state handler for ObjectPageLayout in view.\n\t * @param control The control for state interaction\n\t * @returns State handler\n\t */\n\t_getOPStateHandler: function (\n\t\tthis: ViewState,\n\t\tcontrol: ManagedObject\n\t): ControlStateHandler<ObjectPageLayout, ObjectPageState> | undefined {\n\t\tconst viewOP = ViewStateExtensionOverride._getObjectPageLayout.call(this);\n\t\tif (viewOP === control) {\n\t\t\treturn {\n\t\t\t\tretrieve: opControlHandlers.retrieve,\n\t\t\t\tapply: opControlHandlers.apply\n\t\t\t};\n\t\t}\n\t},\n\n\t/**\n\t * Get the refresh handler for ObjectPageLayout in view.\n\t * @param control The control being refreshed\n\t * @returns Refresh handler\n\t */\n\t_getOPRefreshHandler: function (\n\t\tthis: ViewState,\n\t\tcontrol: ManagedObject\n\t): ControlStateHandler<ObjectPageLayout, ObjectPageState> | undefined {\n\t\tconst viewOP = ViewStateExtensionOverride._getObjectPageLayout.call(this);\n\t\tif (viewOP === control) {\n\t\t\treturn {\n\t\t\t\trefreshBinding: opControlHandlers.refreshBinding\n\t\t\t};\n\t\t}\n\t},\n\n\t/**\n\t * Pass the state handlers of object page view according to the control in concern.\n\t * @param control The control for state interaction\n\t * @param controlStateHandlers State handlers\n\t */\n\tadaptControlStateHandler: function (\n\t\tthis: ViewState,\n\t\tcontrol: ManagedObject,\n\t\tcontrolStateHandlers: ControlStateHandler<ObjectPageLayout, ObjectPageState>[]\n\t): void {\n\t\tconst opStateHandler = ViewStateExtensionOverride._getOPStateHandler.call(this, control);\n\t\tif (opStateHandler) {\n\t\t\tcontrolStateHandlers.push(opStateHandler);\n\t\t}\n\t},\n\n\t/**\n\t * Pass the refresh handlers of object page view according to the control being refreshed.\n\t * @param control The control being refreshed\n\t * @param controlRefreshHandlers Refresh handlers\n\t */\n\tadaptBindingRefreshHandler: function (\n\t\tthis: ViewState,\n\t\tcontrol: ManagedObject,\n\t\tcontrolRefreshHandlers: ControlStateHandler<ObjectPageLayout, ObjectPageState>\n\t): void {\n\t\tconst opStateHandler = ViewStateExtensionOverride._getOPRefreshHandler.call(this, control);\n\t\tif (opStateHandler) {\n\t\t    controlRefreshHandlers.refreshBinding = opStateHandler.refreshBinding;\n\t\t}\n\t},\n\n\tapplyInitialStateOnly: function (): boolean {\n\t\treturn false;\n\t},\n\tadaptStateControls: function (this: ViewState, aStateControls: Control[]): void {\n\t\tconst oView = this.base.getView(),\n\t\t\toViewData = oView.getViewData();\n\t\tswitch (oViewData.variantManagement) {\n\t\t\tcase VariantManagement.Control:\n\t\t\t\tbreak;\n\t\t\tcase VariantManagement.Page:\n\t\t\tcase VariantManagement.None:\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`unhandled variant setting: ${oViewData.variantManagement}`);\n\t\t}\n\n\t\taStateControls.push(oView.byId(\"fe::ObjectPage\") as Control);\n\t},\n\tadaptBindingRefreshControls: function (this: ViewState, aControls: Control[]): Control[] {\n\t\tconst oView = this.base.getView(),\n\t\t\tsRefreshStrategy = KeepAliveHelper.getViewRefreshInfo(oView),\n\t\t\toController = oView.getController();\n\t\tlet aControlsToRefresh: Control[] = [];\n\n\t\tif (sRefreshStrategy) {\n\t\t\tconst oObjectPageControl = (oController as ObjectPageController)._getObjectPageLayoutControl();\n\t\t\taControlsToRefresh.push(oObjectPageControl);\n\t\t}\n\t\tif (sRefreshStrategy !== \"includingDependents\") {\n\t\t\tconst aViewControls = (oController as ObjectPageController)._findTables();\n\t\t\taControlsToRefresh = aControlsToRefresh.concat(KeepAliveHelper.getControlsForRefresh(oView, aViewControls) || []);\n\t\t}\n\t\treturn aControlsToRefresh.reduce(function (aPrevControls, oControl) {\n\t\t\tif (!aPrevControls.includes(oControl)) {\n\t\t\t\taPrevControls.push(oControl);\n\t\t\t}\n\t\t\treturn aPrevControls;\n\t\t}, aControls);\n\t}\n};\n\nexport default ViewStateExtensionOverride;\n"],"mappings":"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","ignoreList":[],"file":"ViewState-dbg.js"}