/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/SemanticKeyHelper","sap/fe/templates/ObjectPage/card/Generator","sap/ui/core/routing/HashChanger","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,n,i,o,s,r,a,c,l){"use strict";var g=i.Placement;var f=n.convertTypes;const u="facetIdentifier";const d="adaptive";let p;function h(e,t){const n=Object.keys(e);const i=n.filter(function(t){const n=e[t];return n!==undefined}).map(function(t){const n=e[t];return new c(t,l.EQ,n)});if(t){const e=new c({filters:[new c("SiblingEntity/IsActiveEntity",l.EQ,true)],and:false});i.push(e)}return new c(i,true)}async function b(e,t,n){const i=e.getView().getBindingContext().getModel().bindList(`/${t}`,undefined,undefined,n,{$$groupId:"$auto.Heroes"});return i.requestContexts(0,2).then(function(e){if(e&&e.length){return e[0].getPath()}return""})}function m(e,t,n){const i=[];const s=[];let r=e.getModel().getMetaModel().getMetaPath(e.getPath());if(r.indexOf("/")===0){r=r.substring(1)}const c=r.split("/");const l=a.getInstance().getHash().split("?")[0];const g=l.split("/");const f={};const u=[];g.forEach(function(t){const n=t.substring(t.indexOf("(")+1,t.length-1).split(",");const i={};const s=t.split("(")[0];f[s]={};u.push(s);f[s]["bIsActiveEntityDefined"]=o.isDraftSupported(e.getModel().getMetaModel(),e.getPath())?true:false;for(const o of n){const n=o.split("=");let s=n[1];let r=n[0];if(!o.includes("=")){const i=e.getModel().getMetaModel();const o=i.getObject(`/${u.join("/")}/$Type/$Key`);s=n[0];r=o[0];f[t.split("(")[0]]["bIsActiveEntityDefined"]=false}if(r!=="IsActiveEntity"){if(s.indexOf("'")===0&&s.lastIndexOf("'")===s.length-1){s=decodeURIComponent(s.substring(1,s.length-1))}i[r]=s}}f[s].mKeyValues=i});let d=n;c.forEach(function(t){const i={};const o=d.$NavigationPropertyBinding&&d.$NavigationPropertyBinding[t];if(o){i.pageEntityName=d.$NavigationPropertyBinding[t];d=e.getModel().getMetaModel().getObject(`/${o}`)||n}else{i.pageEntityName=t}i.mKeyValues=f[t]?.mKeyValues;i.bIsActiveEntityDefined=f[t]?.bIsActiveEntityDefined;s.push(i)});s.forEach(function(e){const n=h(e.mKeyValues,!!e.bIsActiveEntityDefined);i.push(b(t,e.pageEntityName,n))});return i}async function y(t,n){const i=a.getInstance().getHash().split("?")[0];let o=i&&i.substring(0,i.indexOf("("));if(o.indexOf("/")===0){o=o.substring(1)}const s=t.getModel().getMetaModel().getObject(`/${o}`);const r=t;const c=m(t,n,s);if(c.length>0){return Promise.all(c).then(function(e){const t=[];let n=s;if(e[0]?.indexOf("/")===0){t.push(e[0].substring(1))}else{t.push(e[0])}for(let i=1;i<e.length;i++){let o=e[i];let a="";let c=o&&o.substring(0,o.indexOf("("));if(c?.indexOf("/")===0){c=c.substring(1)}if(o?.indexOf("/")===0){o=o.substring(1)}a=Object.keys(n.$NavigationPropertyBinding)[Object.values(n.$NavigationPropertyBinding).indexOf(c)];if(a){t.push(o?.replace(c,a));n=r.getModel().getMetaModel().getObject(`/${c}`)||s}else{t.push(o)}}return t}).catch(function(t){e.info("Failed to retrieve one or more active context path's",t);return[]})}else{return Promise.resolve([])}}async function w(e,t){let n,i;const r=a.getInstance().getHash().split("?")[0];if(e){const t=e.getModel();const n=t.getMetaModel();p=o.isStickySessionSupported(n);let a=r&&r.substring(0,r.indexOf("("));if(a.indexOf("/")===0){a=a.substring(1)}i=s.getSemanticKeys(n,a)}const c=t.getView().getViewData();if(e&&!p&&(c.viewLevel===1&&!i||c.viewLevel>=2)){n=y(e,t);return n}else{return Promise.resolve([])}}function v(e,t,n){let i;const o=a.getInstance().getHash();const s=a.getInstance().hrefForAppSpecificHash?a.getInstance().hrefForAppSpecificHash(""):"";if(e&&!t&&n){i=s+n.join("/")}else{i=o?s+o:window.location.hash}return window.location.origin+window.location.pathname+window.location.search+i}async function I(){const t=sap.ui.require("sap/ushell/Container");if(t){return t.getFLPUrlAsync(true).then(function(e){return e}).catch(function(t){e.error("Could not retrieve cFLP URL for the sharing dialog (dialog will not be opened)",t)})}else{return Promise.resolve(document.URL)}}function M(t,n,i){let o;const s=a.getInstance().getHash();const r=a.getInstance().hrefForAppSpecificHash?a.getInstance().hrefForAppSpecificHash(""):"";if(t&&!n&&i){o=r+i.join("/")}else{o=s?r+s:window.location.hash}const c=sap.ui.require("sap/ushell/Container");if(c&&c.runningInIframe&&c.runningInIframe()){c.getFLPUrl(true).then(function(e){return e.substring(0,e.indexOf("#"))+o}).catch(function(t){e.error("Could not retrieve cFLP URL for the sharing dialog (dialog will not be opened)",t)})}else{return Promise.resolve(window.location.origin+window.location.pathname+o)}}function P(e,t){const n="_fe_ms_teams";const i=e.getModel();const o=e.getModel().oRequestor;const s=t.map(e=>e.replace(".","/"));e.requestSideEffects(s,n);const r=o.mBatchQueue?.[n]?.splice(1);if(r&&r.length>0){const e=r.reduce((e,t)=>t.url.length>e.length?t.url:e,"");r.forEach(t=>{delete t.$owner;t.url=e});const t=o.mergeGetRequests(r)[0];const s=O(i.getServiceUrl());delete o.mBatchQueue[n];return`${s}${t.url}`}}function C(e){const t=e.getHeaderTitle();const n=t.getActions();return n.reduce((e,t)=>{if(t?.isA?.("sap.m.Button")){e.push(t)}else if(t?.isA?.("sap.m.MenuButton")){const n=t.getMenu();const i=n.getItems();e=[...e,...i]}return e},[])}function O(e){const t=new RegExp("^(?:[a-z]+:)?//","i");if(t.test(e)){return e}return`${window.location.origin}${e}`}const x={adaptShareMetadata:async function(n){const i=this.base.getView().getBindingContext();const o=t.getIsEditable(this.base.getView());try{const e=this.base.getAppComponent().getManifest();const t=e?.["sap.app"]?.id;const s=e?.["sap.app"]?.title;const r=await w(i,this.base.getView().getController());const a=await this.base.getView().getController()._getPageTitleInformation();const c=await Promise.all([M(o,p,r),v(o,p,r),I()]);let l=a.title;const g=a.subtitle?a.subtitle.toString():"";if(g){l=`${l} - ${g}`}n.tile={title:a.title,subtitle:g};n.email.title=l;n.title=l;n.jam.url=c[0];n.url=c[1];n.email.url=c[2];const f=this.base?.getView()?.getModel("shareInfo");const u=await this.getTeamsUrl(n.url);if(f){f.setProperty("/collaborationInfo/url",u);f.setProperty("/collaborationInfo/appTitle",s);f.setProperty("/collaborationInfo/subTitle",g);f.setProperty("/collaborationInfo/appId",t)}}catch(t){e.error(t)}return n},getCardDefinition:async function(){let t;const n=this.base.getView();const i=this.base.getView().getBindingContext();const o=i?.getModel();const s=o?.getMetaModel();const a=n.getController();const c=a.getAppComponent();t=await c.getCollaborationManagerService().getDesignTimeCard(d);if(!t&&o&&s&&i){const e=O(o.getServiceUrl());const n=f(s);const c=i.getPath();const l=`${e}${c.substring(1)}`;const g=`${s.getMetaPath(i.getPath())}/`;const u=a.getAppComponent().getShellServices();const d={contextPath:g,bindingContextPath:c};const p={headerFacets:x.getHeaderFacetsConfig(a),actions:x.getActionsConfig(a),webUrl:l,serviceURI:e,objectTitle:await u.getTitle(),appUrl:this.base.getView().getModel("shareInfo")?.getProperty("/collaborationInfo/url"),contextInfo:d};const h=new r(n,p);const b=h.getPathsToQuery();const m=P(i,b);t=h.getCardDefinition(m)}else if(!t){e.error("FE V4 : Share Object Page controller extension : Card was not created")}return t},getActionsConfig:function(e){const t=e.getView().getViewData().content?.header?.actions||{};const n=e._getObjectPageLayoutControl();const i=C(n);const o=i.reduce((e,n)=>{const i=n.data("annotatedActionIdentifier");if(i){e[i]={title:n.getText()};if(t[i]){e[i].isVisible=this.getActionVisibilityViaManifest(t[i])}}return e},{});Object.keys(t).forEach(e=>{if(e.startsWith("DataFieldForAction")&&!o[e]){const n=this.getActionVisibilityViaManifest(t[e]);if(n!==undefined){o[e]={isVisible:n}}}});return o},getActionVisibilityViaManifest:function(e){let t=typeof e.visible==="boolean"?e.visible:undefined;if(typeof e.visible==="string"){t=e.visible==="true"?true:false}if(t!==false){if(e.enabled===false||typeof e.enabled==="string"&&e.enabled!=="true"){t=false}}return t},getHeaderFacetsConfig:function(e){const t=e._getObjectPageLayoutControl().getHeaderContent()[0]?.getItems();const n=t?.reduce((e,t)=>{const n=t.data(u);if(n&&t.isA("sap.fe.templates.ObjectPage.controls.StashableHBox")){const i=x._getFacetLabelsInfo(t);const o={isVisible:t.isBound("visible")?undefined:t.getVisible(),title:t.getTitle(),position:{placement:g.After,anchor:Object.keys(e).pop()||""},formElementsConfig:i};e[n]=o;return e}return e},{});return n},_getFacetLabelsInfo(e){const t=e.getFormLabels();return t.reduce((e,t)=>{const n=t.data("labelIdentifier");const i=t.getText();if(n){e[n]={labelText:i.endsWith(":")?i.substring(0,i.length-1):i}}return e},{})}};return x},false);
//# sourceMappingURL=Share.js.map