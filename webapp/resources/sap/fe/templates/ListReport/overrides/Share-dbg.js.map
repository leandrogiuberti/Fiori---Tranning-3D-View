{"version":3,"names":["getCountUrl","oController","oTable","_getTable","tableAPI","getParent","downloadUrl","getDownloadUrlWithFilters","splitUrl","split","baseUrl","supportedParams","length","urlParams","forEach","urlParam","urlParamParts","push","join","getShareEmailUrl","oUShellContainer","sap","ui","require","getFLPUrlAsync","then","fLPUrl","catch","sError","Log","error","Promise","resolve","document","URL","getSaveAsTileServiceUrl","controller","oFilterBar","_getFilterBarControl","getJamUrl","sHash","HashChanger","getInstance","getHash","sBasePath","hrefForAppSpecificHash","jamUrl","window","location","hash","ushellContainer","runningInIframe","getFLPUrl","sUrl","substring","indexOf","origin","pathname","getUrlForSaveAsTile","view","shareMetadata","appComponent","CommonUtils","getAppComponent","routerProxy","getRouterProxy","rootViewController","getRootViewController","basePath","getAppSpecificHash","saveAsTileAppState","getAppStateHandler","createAppState","replaceHash","skipMerge","newKey","appStateKey","tile","url","setAppStateInHash","syncTableDataWithGoClick","filterBar","getView","getBindingContext","getProperty","table","binding","getRowBinding","getBinding","attachEventOnce","triggerSearch","err","shareInfoModel","getModel","setProperty","message","Error","String","getSaveAsTileMetadata","getController","manifestConfiguration","getManifest","uIManifest","icon","icons","appManifest","title","queryUrl","ShareOverride","adaptShareMetadata","base","jam","teamsUrl","getTeamsUrl","email"],"sourceRoot":".","sources":["Share.ts"],"sourcesContent":["import Log from \"sap/base/Log\";\nimport type { AppDataInfo } from \"sap/fe/core/AppStateHandler\";\nimport CommonUtils from \"sap/fe/core/CommonUtils\";\nimport type Share from \"sap/fe/core/controllerextensions/Share\";\nimport type { ShareMetadata } from \"sap/fe/core/controllerextensions/Share\";\nimport type { InternalModelContext } from \"sap/fe/core/helpers/ModelHelper\";\nimport type FilterBar from \"sap/fe/macros/controls/FilterBar\";\nimport type TableAPI from \"sap/fe/macros/table/TableAPI\";\nimport type Controller from \"sap/ui/core/mvc/Controller\";\nimport type View from \"sap/ui/core/mvc/View\";\nimport HashChanger from \"sap/ui/core/routing/HashChanger\";\nimport type JSONModel from \"sap/ui/model/json/JSONModel\";\nimport type ListReportController from \"../ListReportController.controller\";\n\nasync function getCountUrl(oController: ListReportController): Promise<string> {\n\tconst oTable = oController._getTable?.();\n\tif (!oTable) {\n\t\treturn \"\";\n\t}\n\tconst tableAPI = oTable.getParent() as TableAPI;\n\tconst downloadUrl = await tableAPI.getDownloadUrlWithFilters();\n\tconst splitUrl = downloadUrl.split(\"?\");\n\tconst baseUrl = `${splitUrl[0]}/$count?`;\n\t// getDownloadUrl() returns url with $select, $expand which is not supported when /$count is used to get the record count. only $apply, $search, $filter is supported\n\t// ?$count=true returns count in a format which is not supported by FLP yet.\n\t// currently supported format for v4 is ../count.. only (where tile preview will still not work)\n\tconst supportedParams: string[] = [];\n\tif (splitUrl.length > 1) {\n\t\tconst urlParams = splitUrl[1];\n\t\turlParams.split(\"&\").forEach(function (urlParam: string) {\n\t\t\tconst urlParamParts = urlParam.split(\"=\");\n\t\t\tswitch (urlParamParts[0]) {\n\t\t\t\tcase \"$apply\":\n\t\t\t\tcase \"$search\":\n\t\t\t\tcase \"$filter\":\n\t\t\t\t\tsupportedParams.push(urlParam);\n\t\t\t}\n\t\t});\n\t}\n\treturn baseUrl + supportedParams.join(\"&\");\n}\n\nasync function getShareEmailUrl(): Promise<string> {\n\tconst oUShellContainer = sap.ui.require(\"sap/ushell/Container\");\n\tif (oUShellContainer) {\n\t\treturn oUShellContainer\n\t\t\t.getFLPUrlAsync(true)\n\t\t\t.then(function (fLPUrl: string) {\n\t\t\t\treturn fLPUrl;\n\t\t\t})\n\t\t\t.catch(function (sError: unknown) {\n\t\t\t\tLog.error(\"Could not retrieve cFLP URL for the sharing dialog (dialog will not be opened)\", sError as string);\n\t\t\t});\n\t} else {\n\t\treturn Promise.resolve(document.URL);\n\t}\n}\n\nasync function getSaveAsTileServiceUrl(controller: Controller): Promise<string> {\n\tconst oFilterBar = (controller as ListReportController)._getFilterBarControl();\n\tif (oFilterBar) {\n\t\treturn getCountUrl(controller as ListReportController);\n\t}\n\treturn \"\";\n}\n\nfunction getJamUrl(): string | undefined {\n\tconst sHash = HashChanger.getInstance().getHash();\n\tconst sBasePath = HashChanger.getInstance().hrefForAppSpecificHash ? HashChanger.getInstance().hrefForAppSpecificHash?.(\"\") : \"\";\n\tconst jamUrl = sHash ? sBasePath + sHash : window.location.hash;\n\t// in case we are in cFLP scenario, the application is running\n\t// inside an iframe, and there for we need to get the cFLP URL\n\t// and not 'document.URL' that represents the iframe URL\n\tconst ushellContainer = sap.ui.require(\"sap/ushell/Container\");\n\tif (ushellContainer && ushellContainer.runningInIframe && ushellContainer.runningInIframe()) {\n\t\tushellContainer\n\t\t\t.getFLPUrl(true)\n\t\t\t.then(function (sUrl: string) {\n\t\t\t\treturn sUrl.substring(0, sUrl.indexOf(\"#\")) + jamUrl;\n\t\t\t})\n\t\t\t.catch(function (sError: unknown) {\n\t\t\t\tLog.error(\"Could not retrieve cFLP URL for the sharing dialog (dialog will not be opened)\", sError as string);\n\t\t\t});\n\t} else {\n\t\treturn window.location.origin + window.location.pathname + jamUrl;\n\t}\n}\n\n/**\n * Get the tile URL for save as tile action.\n * @param view View connected to this controller.\n * @param shareMetadata Object containing the share metadata.\n */\nasync function getUrlForSaveAsTile(view: View, shareMetadata: ShareMetadata): Promise<void> {\n\tconst appComponent = CommonUtils.getAppComponent(view),\n\t\trouterProxy = appComponent.getRouterProxy(),\n\t\thash = routerProxy.getHash(),\n\t\trootViewController = appComponent.getRootViewController(),\n\t\tbasePath = rootViewController.getAppSpecificHash(),\n\t\tsaveAsTileAppState: AppDataInfo | void = await appComponent\n\t\t\t.getAppStateHandler()\n\t\t\t.createAppState({ replaceHash: false, skipMerge: true });\n\tconst newKey = saveAsTileAppState?.appStateKey;\n\tif (newKey && basePath) {\n\t\tshareMetadata.tile.url = basePath + routerProxy.setAppStateInHash(hash, newKey);\n\t}\n}\n\n/**\n * Trigger search and listen to dataReceived the event to sync data to the table.\n * @param controller The list report controller\n * @returns The async promise\n */\nasync function syncTableDataWithGoClick(controller: ListReportController): Promise<void> {\n\tconst filterBar = controller._getFilterBarControl() as FilterBar;\n\ttry {\n\t\t// programattically trigger search\n\t\t// trigger go only if go is not clicked\n\t\tif ((controller.getView().getBindingContext(\"internal\") as InternalModelContext).getProperty(\"hasPendingFilters\")) {\n\t\t\treturn await new Promise(function (resolve) {\n\t\t\t\tconst table = controller._getTable?.();\n\t\t\t\tif (!table) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst binding = table.getRowBinding() || table.getBinding(\"items\");\n\t\t\t\tbinding.attachEventOnce(\"dataReceived\", function () {\n\t\t\t\t\tresolve();\n\t\t\t\t});\n\t\t\t\tfilterBar.triggerSearch();\n\t\t\t});\n\t\t}\n\t} catch (err: unknown) {\n\t\tconst shareInfoModel = controller.getView()?.getModel(\"shareInfo\") as JSONModel | undefined;\n\t\tif (shareInfoModel) {\n\t\t\tshareInfoModel.setProperty(\"/saveAsTileClicked\", false);\n\t\t}\n\t\tconst message = err instanceof Error ? err.message : String(err);\n\t\tLog.error(`FE : Save as tile - data sync failed : Share : ${message}`);\n\t}\n}\n\n/**\n * Update the share meta data when save as tile action is clicked.\n * @param view View connected to this controller\n * @param shareMetadata Object containing the share metadata.\n * @returns The async promise\n */\nasync function getSaveAsTileMetadata(view: View, shareMetadata: ShareMetadata): Promise<void> {\n\tconst shareInfoModel = view.getModel(\"shareInfo\") as JSONModel | undefined;\n\tif (shareInfoModel && shareInfoModel.getProperty(\"/saveAsTileClicked\")) {\n\t\tawait syncTableDataWithGoClick(view.getController() as ListReportController);\n\t\tawait getUrlForSaveAsTile(view, shareMetadata);\n\t\tconst appComponent = CommonUtils.getAppComponent(view);\n\t\tconst manifestConfiguration = appComponent.getManifest();\n\t\tconst uIManifest = manifestConfiguration[\"sap.ui\"];\n\t\tconst icon = (uIManifest && uIManifest.icons && uIManifest.icons.icon) || \"\";\n\t\tconst appManifest = manifestConfiguration[\"sap.app\"];\n\t\tconst title = (appManifest && appManifest.title) || \"\";\n\t\tshareMetadata.tile.icon = icon;\n\t\tshareMetadata.tile.title = title;\n\t\tshareMetadata.tile.queryUrl = await getSaveAsTileServiceUrl(view.getController() as ListReportController);\n\t}\n}\n\nconst ShareOverride = {\n\tadaptShareMetadata: async function (this: Share, shareMetadata: ShareMetadata): Promise<ShareMetadata | undefined> {\n\t\ttry {\n\t\t\tawait getSaveAsTileMetadata(this.base.getView(), shareMetadata);\n\t\t\tconst jamUrl: string | undefined = getJamUrl();\n\t\t\t// TODO: check if there is any semantic date used before adding serviceURL as BLI:FIORITECHP1-18023\n\t\t\tshareMetadata.title = document.title;\n\t\t\tif (jamUrl) {\n\t\t\t\tshareMetadata.jam.url = jamUrl;\n\t\t\t}\n\t\t\t// MS Teams collaboration does not want to allow further changes to the URL\n\t\t\t// so update colloborationInfo model at LR override to ignore further extension changes at multiple levels\n\t\t\tconst shareInfoModel = this.base?.getView()?.getModel(\"shareInfo\") as JSONModel | undefined;\n\t\t\tconst teamsUrl = await this.getTeamsUrl(shareMetadata.url);\n\t\t\tif (shareInfoModel) {\n\t\t\t\tshareInfoModel.setProperty(\"/collaborationInfo/url\", teamsUrl);\n\t\t\t\tshareInfoModel.setProperty(\"/collaborationInfo/appTitle\", shareMetadata.title);\n\t\t\t}\n\t\t\tconst fLPUrl = await getShareEmailUrl();\n\t\t\tshareMetadata.email.url = fLPUrl;\n\t\t} catch (error: unknown) {\n\t\t\tLog.error(error as string);\n\t\t}\n\t\treturn shareMetadata;\n\t}\n};\n\nexport default ShareOverride;\n"],"mappings":"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","ignoreList":[],"file":"Share-dbg.js"}