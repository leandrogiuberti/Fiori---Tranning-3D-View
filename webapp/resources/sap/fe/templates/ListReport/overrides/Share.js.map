{"version":3,"file":"Share.js","names":["async","getCountUrl","oController","oTable","_getTable","tableAPI","getParent","downloadUrl","getDownloadUrlWithFilters","splitUrl","split","baseUrl","supportedParams","length","urlParams","forEach","urlParam","urlParamParts","push","join","getShareEmailUrl","oUShellContainer","sap","ui","require","getFLPUrlAsync","then","fLPUrl","catch","sError","Log","error","Promise","resolve","document","URL","getSaveAsTileServiceUrl","controller","oFilterBar","_getFilterBarControl","getJamUrl","sHash","HashChanger","getInstance","getHash","sBasePath","hrefForAppSpecificHash","jamUrl","window","location","hash","ushellContainer","runningInIframe","getFLPUrl","sUrl","substring","indexOf","origin","pathname","getUrlForSaveAsTile","view","shareMetadata","appComponent","CommonUtils","getAppComponent","routerProxy","getRouterProxy","rootViewController","getRootViewController","basePath","getAppSpecificHash","saveAsTileAppState","getAppStateHandler","createAppState","replaceHash","skipMerge","newKey","appStateKey","tile","url","setAppStateInHash","syncTableDataWithGoClick","filterBar","getView","getBindingContext","getProperty","table","binding","getRowBinding","getBinding","attachEventOnce","triggerSearch","err","shareInfoModel","getModel","setProperty","message","Error","String","getSaveAsTileMetadata","getController","manifestConfiguration","getManifest","uIManifest","icon","icons","appManifest","title","queryUrl","ShareOverride","adaptShareMetadata","this","base","jam","teamsUrl","getTeamsUrl","email"],"sources":["./Share.ts"],"sourcesContent":["import Log from \"sap/base/Log\";\nimport type { AppDataInfo } from \"sap/fe/core/AppStateHandler\";\nimport CommonUtils from \"sap/fe/core/CommonUtils\";\nimport type Share from \"sap/fe/core/controllerextensions/Share\";\nimport type { ShareMetadata } from \"sap/fe/core/controllerextensions/Share\";\nimport type { InternalModelContext } from \"sap/fe/core/helpers/ModelHelper\";\nimport type FilterBar from \"sap/fe/macros/controls/FilterBar\";\nimport type TableAPI from \"sap/fe/macros/table/TableAPI\";\nimport type Controller from \"sap/ui/core/mvc/Controller\";\nimport type View from \"sap/ui/core/mvc/View\";\nimport HashChanger from \"sap/ui/core/routing/HashChanger\";\nimport type JSONModel from \"sap/ui/model/json/JSONModel\";\nimport type ListReportController from \"../ListReportController.controller\";\n\nasync function getCountUrl(oController: ListReportController): Promise<string> {\n\tconst oTable = oController._getTable?.();\n\tif (!oTable) {\n\t\treturn \"\";\n\t}\n\tconst tableAPI = oTable.getParent() as TableAPI;\n\tconst downloadUrl = await tableAPI.getDownloadUrlWithFilters();\n\tconst splitUrl = downloadUrl.split(\"?\");\n\tconst baseUrl = `${splitUrl[0]}/$count?`;\n\t// getDownloadUrl() returns url with $select, $expand which is not supported when /$count is used to get the record count. only $apply, $search, $filter is supported\n\t// ?$count=true returns count in a format which is not supported by FLP yet.\n\t// currently supported format for v4 is ../count.. only (where tile preview will still not work)\n\tconst supportedParams: string[] = [];\n\tif (splitUrl.length > 1) {\n\t\tconst urlParams = splitUrl[1];\n\t\turlParams.split(\"&\").forEach(function (urlParam: string) {\n\t\t\tconst urlParamParts = urlParam.split(\"=\");\n\t\t\tswitch (urlParamParts[0]) {\n\t\t\t\tcase \"$apply\":\n\t\t\t\tcase \"$search\":\n\t\t\t\tcase \"$filter\":\n\t\t\t\t\tsupportedParams.push(urlParam);\n\t\t\t}\n\t\t});\n\t}\n\treturn baseUrl + supportedParams.join(\"&\");\n}\n\nasync function getShareEmailUrl(): Promise<string> {\n\tconst oUShellContainer = sap.ui.require(\"sap/ushell/Container\");\n\tif (oUShellContainer) {\n\t\treturn oUShellContainer\n\t\t\t.getFLPUrlAsync(true)\n\t\t\t.then(function (fLPUrl: string) {\n\t\t\t\treturn fLPUrl;\n\t\t\t})\n\t\t\t.catch(function (sError: unknown) {\n\t\t\t\tLog.error(\"Could not retrieve cFLP URL for the sharing dialog (dialog will not be opened)\", sError as string);\n\t\t\t});\n\t} else {\n\t\treturn Promise.resolve(document.URL);\n\t}\n}\n\nasync function getSaveAsTileServiceUrl(controller: Controller): Promise<string> {\n\tconst oFilterBar = (controller as ListReportController)._getFilterBarControl();\n\tif (oFilterBar) {\n\t\treturn getCountUrl(controller as ListReportController);\n\t}\n\treturn \"\";\n}\n\nfunction getJamUrl(): string | undefined {\n\tconst sHash = HashChanger.getInstance().getHash();\n\tconst sBasePath = HashChanger.getInstance().hrefForAppSpecificHash ? HashChanger.getInstance().hrefForAppSpecificHash?.(\"\") : \"\";\n\tconst jamUrl = sHash ? sBasePath + sHash : window.location.hash;\n\t// in case we are in cFLP scenario, the application is running\n\t// inside an iframe, and there for we need to get the cFLP URL\n\t// and not 'document.URL' that represents the iframe URL\n\tconst ushellContainer = sap.ui.require(\"sap/ushell/Container\");\n\tif (ushellContainer && ushellContainer.runningInIframe && ushellContainer.runningInIframe()) {\n\t\tushellContainer\n\t\t\t.getFLPUrl(true)\n\t\t\t.then(function (sUrl: string) {\n\t\t\t\treturn sUrl.substring(0, sUrl.indexOf(\"#\")) + jamUrl;\n\t\t\t})\n\t\t\t.catch(function (sError: unknown) {\n\t\t\t\tLog.error(\"Could not retrieve cFLP URL for the sharing dialog (dialog will not be opened)\", sError as string);\n\t\t\t});\n\t} else {\n\t\treturn window.location.origin + window.location.pathname + jamUrl;\n\t}\n}\n\n/**\n * Get the tile URL for save as tile action.\n * @param view View connected to this controller.\n * @param shareMetadata Object containing the share metadata.\n */\nasync function getUrlForSaveAsTile(view: View, shareMetadata: ShareMetadata): Promise<void> {\n\tconst appComponent = CommonUtils.getAppComponent(view),\n\t\trouterProxy = appComponent.getRouterProxy(),\n\t\thash = routerProxy.getHash(),\n\t\trootViewController = appComponent.getRootViewController(),\n\t\tbasePath = rootViewController.getAppSpecificHash(),\n\t\tsaveAsTileAppState: AppDataInfo | void = await appComponent\n\t\t\t.getAppStateHandler()\n\t\t\t.createAppState({ replaceHash: false, skipMerge: true });\n\tconst newKey = saveAsTileAppState?.appStateKey;\n\tif (newKey && basePath) {\n\t\tshareMetadata.tile.url = basePath + routerProxy.setAppStateInHash(hash, newKey);\n\t}\n}\n\n/**\n * Trigger search and listen to dataReceived the event to sync data to the table.\n * @param controller The list report controller\n * @returns The async promise\n */\nasync function syncTableDataWithGoClick(controller: ListReportController): Promise<void> {\n\tconst filterBar = controller._getFilterBarControl() as FilterBar;\n\ttry {\n\t\t// programattically trigger search\n\t\t// trigger go only if go is not clicked\n\t\tif ((controller.getView().getBindingContext(\"internal\") as InternalModelContext).getProperty(\"hasPendingFilters\")) {\n\t\t\treturn await new Promise(function (resolve) {\n\t\t\t\tconst table = controller._getTable?.();\n\t\t\t\tif (!table) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst binding = table.getRowBinding() || table.getBinding(\"items\");\n\t\t\t\tbinding.attachEventOnce(\"dataReceived\", function () {\n\t\t\t\t\tresolve();\n\t\t\t\t});\n\t\t\t\tfilterBar.triggerSearch();\n\t\t\t});\n\t\t}\n\t} catch (err: unknown) {\n\t\tconst shareInfoModel = controller.getView()?.getModel(\"shareInfo\") as JSONModel | undefined;\n\t\tif (shareInfoModel) {\n\t\t\tshareInfoModel.setProperty(\"/saveAsTileClicked\", false);\n\t\t}\n\t\tconst message = err instanceof Error ? err.message : String(err);\n\t\tLog.error(`FE : Save as tile - data sync failed : Share : ${message}`);\n\t}\n}\n\n/**\n * Update the share meta data when save as tile action is clicked.\n * @param view View connected to this controller\n * @param shareMetadata Object containing the share metadata.\n * @returns The async promise\n */\nasync function getSaveAsTileMetadata(view: View, shareMetadata: ShareMetadata): Promise<void> {\n\tconst shareInfoModel = view.getModel(\"shareInfo\") as JSONModel | undefined;\n\tif (shareInfoModel && shareInfoModel.getProperty(\"/saveAsTileClicked\")) {\n\t\tawait syncTableDataWithGoClick(view.getController() as ListReportController);\n\t\tawait getUrlForSaveAsTile(view, shareMetadata);\n\t\tconst appComponent = CommonUtils.getAppComponent(view);\n\t\tconst manifestConfiguration = appComponent.getManifest();\n\t\tconst uIManifest = manifestConfiguration[\"sap.ui\"];\n\t\tconst icon = (uIManifest && uIManifest.icons && uIManifest.icons.icon) || \"\";\n\t\tconst appManifest = manifestConfiguration[\"sap.app\"];\n\t\tconst title = (appManifest && appManifest.title) || \"\";\n\t\tshareMetadata.tile.icon = icon;\n\t\tshareMetadata.tile.title = title;\n\t\tshareMetadata.tile.queryUrl = await getSaveAsTileServiceUrl(view.getController() as ListReportController);\n\t}\n}\n\nconst ShareOverride = {\n\tadaptShareMetadata: async function (this: Share, shareMetadata: ShareMetadata): Promise<ShareMetadata | undefined> {\n\t\ttry {\n\t\t\tawait getSaveAsTileMetadata(this.base.getView(), shareMetadata);\n\t\t\tconst jamUrl: string | undefined = getJamUrl();\n\t\t\t// TODO: check if there is any semantic date used before adding serviceURL as BLI:FIORITECHP1-18023\n\t\t\tshareMetadata.title = document.title;\n\t\t\tif (jamUrl) {\n\t\t\t\tshareMetadata.jam.url = jamUrl;\n\t\t\t}\n\t\t\t// MS Teams collaboration does not want to allow further changes to the URL\n\t\t\t// so update colloborationInfo model at LR override to ignore further extension changes at multiple levels\n\t\t\tconst shareInfoModel = this.base?.getView()?.getModel(\"shareInfo\") as JSONModel | undefined;\n\t\t\tconst teamsUrl = await this.getTeamsUrl(shareMetadata.url);\n\t\t\tif (shareInfoModel) {\n\t\t\t\tshareInfoModel.setProperty(\"/collaborationInfo/url\", teamsUrl);\n\t\t\t\tshareInfoModel.setProperty(\"/collaborationInfo/appTitle\", shareMetadata.title);\n\t\t\t}\n\t\t\tconst fLPUrl = await getShareEmailUrl();\n\t\t\tshareMetadata.email.url = fLPUrl;\n\t\t} catch (error: unknown) {\n\t\t\tLog.error(error as string);\n\t\t}\n\t\treturn shareMetadata;\n\t}\n};\n\nexport default ShareOverride;\n"],"mappings":"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","ignoreList":[]}