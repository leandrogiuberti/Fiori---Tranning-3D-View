/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/converters/MetaModelConverter","sap/ui/core/Component","sap/ui/core/Element","sap/ui/mdc/field/FieldBaseDelegate","sap/ui/mdc/odata/v4/TypeMap","sap/ui/mdc/p13n/StateUtil","sap/ui/model/Filter","../CommonHelper","../valuehelp/ValueHelpDelegate"],function(e,t,n,r,a,o,i,s,l,u,c){"use strict";var p=n.getInvolvedDataModelObjects;return Object.assign({},o,{apiVersion:2,initializeTypeFromBinding:function(e,t,n){const r={};if(t&&t.isA(["sap.ui.model.odata.type.Unit","sap.ui.model.odata.type.Currency"])&&Array.isArray(n)&&n.length>2&&n[2]!==undefined){t.formatValue(n,"string");r.bTypeInitialized=true;r.mCustomUnits=n[2]}return r},initializeInternalUnitType:function(e,t,n){if(n?.mCustomUnits!==undefined){t.formatValue([null,null,n.mCustomUnits],"string")}},enhanceValueForUnit:function(e,t,n){if(n?.bTypeInitialized===true&&t.length===2){t.push(n.mCustomUnits);return t}return undefined},getDefaultValueHelpDelegate:function(e){return{name:"sap/ui/mdc/odata/v4/ValueHelpDelegate",payload:{}}},getTypeMap:function(e){return i},_getValueListParameter:function(e,t){return e.Parameters.filter(function(e){if(e.LocalDataProperty){return e.LocalDataProperty.$PropertyPath===t}else{return false}})},_getFilter:function(e,t,n,r,o,i,s,u){let c=[];const p=e.Parameters.filter(function(e){return e.$Type==="com.sap.vocabularies.Common.v1.ValueListParameterIn"||e.$Type==="com.sap.vocabularies.Common.v1.ValueListParameterInOut"||e.LocalDataProperty?.$PropertyPath===t&&e.ValueListProperty===n});for(const e of p){let n;if(e.LocalDataProperty?.$PropertyPath===t){n=r}else if(o?.isActionParameterDialog===true){const t=`APD_::${e.LocalDataProperty?.$PropertyPath}`;const r=a.getElementById(t);n=r?.getValue()}else if(i!==undefined){const t=e.ValueListProperty;const r=i?.[0];n=t&&r?.[t]}else if(s){const t=e.LocalDataProperty?.$PropertyPath;n=s.getObject(t)}if(!n&&u){const t=u?.[e.ValueListProperty];if(t?.length===1&&t[0]?.operator==="EQ"){n=t[0]?.values[0]}}if(n!==null&&n!==undefined){c.push(new l({path:e.ValueListProperty,operator:"EQ",value1:n}))}}if(i?.[0]){c=c.concat(this._getRemainingKeyValueFilters(i[0],e))}return c},_getRemainingKeyValueFilters(e,t){const{$model:n,CollectionPath:r,Parameters:a}=t;const o=n.getMetaModel().getMetaContext(`/${r}`);const i=p(o).targetEntityType;const s=a.reduce((e,t)=>{if(t.LocalDataProperty?.$PropertyPath){e.push(t.LocalDataProperty.$PropertyPath)}return e},[]);const c=i.keys.reduce((t,n)=>{let{name:r}=n;if(!s.includes(r)&&e.hasOwnProperty(r)){t.push(r)}return t},[]);if(c.length>0){return c.reduce((t,a)=>{const o=n.getMetaModel().getMetaContext(`/${r}/${a}`);if(u.isPropertyFilterable(o,undefined,true)){t.push(new l({path:a,operator:"EQ",value1:e[a]}))}return t},[])}return[]},getItemForValue:async function(e,t,n){if(n.value===""){return}if(n.checkDescription){const e=t.getTypeahead();const r=t.getPayload();const a=e.getSelectedContent();const o=a&&a.getId();await c.retrieveContent(t,e,o);const i=r.maxLength;const s=n.value?.toString().length||0;const l=r.valueHelpDescriptionPath;if(l===""){n.checkDescription=false}else if(i!==undefined&&s>i){return}}return o.getItemForValue(e,t,n)},_getFilterBar:function(e){let t;if(e?.isA("sap.ui.mdc.FilterField")){while(e){if(e?.isA("sap.fe.macros.filterBar.FilterBarAPI")){t=e;break}e=e?.getParent()}if(t?.getContent()?.isA("sap.fe.macros.controls.FilterBar")){return t.getContent()}}return undefined},getDescription:async function(n,a,i,u,c,p,f,d,g,m,h,P){let y=n?.getPayload();if(!y&&m?.getDisplay().includes("Description")){y={retrieveTextFromValueList:true}}if(y?.retrieveTextFromValueList===true||y?.isFilterField===true){const f=a.getModel();const d=r.getOwnerComponentFor(a);if(!f&&!d){return o.getDescription(n,a,i,u,c,p,undefined,undefined,g,m,h,P)}const y=f?f.getMetaModel():t.getAppComponent(a).getModel().getMetaModel();const $=a.getPayload();const v=g?.[$.valueHelpQualifier];const C=$.propertyPath;const b=$?.propertyDescriptionPath;let D;try{const r=await y.requestValueListInfo(C,true,p);const o=this._getFilterBar(n);let u;if(o){const e=await s.retrieveExternalState(o);u=e.filter}const c=y.getObject(`${C}@sapui.name`);const f=r[Object.keys(r)[0]];const d=this._getValueListParameter(f,c);const g=d?.[0]?.ValueListProperty;if(!g){throw Error(`Inconsistent value help annotation for ${c}`)}const m=f.$model;const h=m.getMetaModel().getObject(`/${f.CollectionPath}/${g}@com.sap.vocabularies.Common.v1.Text`);if(h&&h.$Path){D=h.$Path;const e=this._getFilter(f,c,g,i,$,v,p,u);const t=m.bindList(`/${f.CollectionPath}`,undefined,undefined,e,{$select:D});const n=await t.requestContexts(0,2);return n.length?n[0].getObject(D):undefined}else if(p!==undefined&&b){const n=b.lastIndexOf("/");const r=n>0?b.substring(0,n):b;const o=t.getAppComponent(a).getSideEffectsService();await o.requestSideEffects([r],p);e.warning(`RequestSideEffects is triggered because the text annotation for ${g} is not defined at the CollectionPath of the value help`);return undefined}else{const t=y?.getObject(`${$.propertyPath}@com.sap.vocabularies.Common.v1.ExternalID`)?.$Path;if(t){const e=$.propertyPath.replace(c,t);const n=y.getObject(`${e}@sapui.name`);const r=y?.getObject(`${e}@com.sap.vocabularies.Common.v1.Text`)?.$Path;const a=[];a.push(new l({path:n,operator:"EQ",value1:i}));const o=m.bindList(`/${f.CollectionPath}`,undefined,undefined,a,{$select:`${n},${r}`});const s=await o.requestContexts(0,2);if(s.length){return s[0].getObject(r)}}e.error(`Text Annotation for ${g} is not defined`);return undefined}}catch(t){const n=t?t.status:undefined;const r=t instanceof Error?t.message:String(t);const a=n===404?`Metadata not found (${n}) for value help of property ${C}`:r;e.error(a)}}return undefined}})},false);
//# sourceMappingURL=FieldBaseDelegate.js.map