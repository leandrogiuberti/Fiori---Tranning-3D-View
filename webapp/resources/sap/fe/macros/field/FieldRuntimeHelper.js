/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/m/IllustratedMessage","sap/m/IllustratedMessageSize","sap/m/IllustratedMessageType","sap/m/Label","sap/m/MessageBox","sap/m/ResponsivePopover","sap/m/library","sap/ui/Device","sap/ui/core/Element","sap/ui/core/IconPool","sap/ui/util/openWindow","../controls/FieldWrapper","../internal/helpers/Upload"],function(e,t,n,o,a,i,s,r,l,c,g,d,p,f,u,m,h,C,P,v){"use strict";var y=v.showTypeMismatchDialog;var S=v.showFileSizeExceedDialog;var F=v.setHeaderFields;var x=v.displayMessageForFailedUpload;var E=s.getResourceModel;var T=n.getActivityKeyFromPath;var D=n.Activity;const B={uploadPromises:{},creatingInactiveRow:false,fetchRecommendations:function(e,n){const o=t.getTargetView(e);const a=e.getBindingContext();let s;const r=a?.getBinding();if(r.isA("sap.ui.model.odata.v4.ODataListBinding")){s=a}else{s=o.getBindingContext()}const l=B.getExtensionController(n);const c=e.isA("sap.ui.mdc.Field")&&e.getValueHelp();const g=i.getMetaPathForContext(e.getBindingContext());const d=e.data("sourcePath").replace(g,"");const p=`${e.getBindingContext()?.getPath()}${d}`;const f=e.isA("sap.ui.mdc.Field")&&e.getValue();l.recommendations.updateTelemetryDataBasedOnUserSelection(p,f);if(c&&c.includes("::TableValueHelp::")){const t=c.substring(0,c.indexOf("::TableValueHelp::"));const n=o.byId(t);const a=n?.getParent()?.getIdentifierColumn();l.recommendations.fetchAndApplyRecommendationsOnFieldChange(e,{context:s,contextIdentifier:a})}else{l.recommendations.fetchAndApplyRecommendationsOnFieldChange(e,{context:s})}},getExtensionController:function(e){return e.isA("sap.fe.core.ExtensionAPI")?e._controller:e},getFieldStateOnChange:function(e){let t=e.getSource(),n;const o=function(e){return e&&e.getDataState()?e.getDataState().getInvalidValue()===undefined:true};if(t.isA("sap.fe.macros.field.Field")){t=t.getContent()}if(t.isA("sap.fe.macros.Field")){t=t.getContent()}if(t.isA(P.getMetadata().getName())&&t.getEditMode()==="Editable"){t=t.getContentEdit()[0]}if(t.isA("sap.ui.mdc.Field")){let a=e.getParameter("valid")||e.getParameter("isValid");if(a===undefined){if(t.getMaxConditions()===1){const e=t.getBindingInfo("value");a=o(e&&e.binding)}if(t.getValue()===""&&!t.getProperty("required")){a=true}}n={fieldValue:t.getValue(),validity:!!a}}else{const e=t.getBinding("uploadUrl")||t.getBinding("value")||t.getBinding("selected");n={fieldValue:e&&e.getValue(),validity:o(e)}}return{field:t,state:n}},pressLink:async function(e){const t=e.getSource();let n=t.isA("sap.m.ObjectIdentifier")?t.findElements(false,e=>e.isA("sap.m.Link"))[0]:t;if(t?.isA("sap.fe.macros.controls.TextLink")){n=t.getContent()}if(t.getDependents()&&t.getDependents().length>0&&n.getProperty("text")!==""){const e=t.getDependents()[0];if(e&&e.isA("sap.ui.mdc.Link")){await B.openLink(e,n)}}return n},openLink:async function(n,o){try{const i=await n.getTriggerHref();if(!i){try{await n._useDelegateItems();const e=await n.retrieveLinkItems();if(e?.length===0&&n.getPayload().hasQuickViewFacets==="false"){const e=B.createPopoverWithNoTargets(n);n.addDependent(e);e.openBy(o)}else{await n.open(o)}}catch(t){e.error(`Cannot retrieve the QuickView Popover dialog: ${t}`)}}else{const n=t.getTargetView(o);const s=t.getAppComponent(n);const r=s.getShellServices();const l=r.parseShellHash(i);const c={target:{semanticObject:l.semanticObject,action:l.action},params:l.params};a.storeControlRefreshStrategyForHash(n,l);if(t.isStickyEditMode(o)!==true){await r.navigate(c,s)}else{try{const e=await r.hrefForExternal(c,s);C(e)}catch(t){e.error(`Error while retireving hrefForExternal : ${t}`)}}}}catch(t){e.error(`Error triggering link Href: ${t}`)}},createPopoverWithNoTargets:function(e){const t=e.getId();const n={title:E(e).getText("M_ILLUSTRATEDMESSAGE_TITLE"),description:E(e).getText("M_ILLUSTRATEDMESSAGE_DESCRIPTION"),enableFormattedText:true,illustrationSize:l.ExtraSmall,illustrationType:c.NoData};const o=new r(`${t}-illustratedmessage`,n);const a={horizontalScrolling:false,showHeader:u.system.phone,placement:f.PlacementType.Auto,content:[o],afterClose:function(e){if(e.getSource()){e.getSource().destroy()}}};return new p(`${t}-popover`,a)},handleTypeMissmatch:function(e){const t=e.getSource();const n=e.getParameter("mimeType");const o=t.getMimeType();if(n){y(t,n,o)}},handleFileSizeExceed:function(e){const t=e.getSource();S(t,t.getMaximumFileSize().toFixed(3))},handleUploadComplete:function(e,n,o,a){const i=Number(e.getParameter("status")),s=e.getSource(),r=s.getParent(),l=r.getParent();r.setUIBusy(false);const c=s.getBindingContext();if(i===0||i>=400){const t=e.getParameter("responseRaw")||e.getParameter("response");x(s,t);B.uploadPromises[s.getId()].reject()}else{const t=e.getParameter("headers")?.etag;if(t){c?.setProperty("@odata.etag",t,null)}if(n?.path){c?.setProperty(n.path,s.getValue())}r.avatar?.refreshAvatarCacheBusting();B._callSideEffectsForStream(e,r,a);this.uploadPromises[s.getId()].resolve();l?.fireEvent("change",e)}delete this.uploadPromises[s.getId()];const g=a.collaborativeDraft?.isConnected();if(!g||!c){return}const d=[`${c.getPath()}/${o}`];if(n?.path){d.push(`${c.getPath()}/${n.path}`)}let p=c.getBinding();if(!p.isA("sap.ui.model.odata.v4.ODataListBinding")){const e=t.getTargetView(s);p=e.getBindingContext().getBinding()}if(p.hasPendingChanges()){p.attachEventOnce("patchCompleted",()=>{a.collaborativeDraft.send({action:D.Change,content:d});a.collaborativeDraft.send({action:D.Unlock,content:d})})}else{a.collaborativeDraft.send({action:D.Change,content:d});a.collaborativeDraft.send({action:D.Unlock,content:d})}},removeStream:function(e,n,o,a){const i=e.getSource();const s=i.getParent();const r=s.getBindingContext();const l=s.getParent();r.setProperty(o,null);r.setProperty(o,undefined,null);B._callSideEffectsForStream(e,s,a);const c=a.collaborativeDraft?.isConnected();if(c){let e=r.getBinding();if(!e.isA("sap.ui.model.odata.v4.ODataListBinding")){const n=t.getTargetView(i);e=n.getBindingContext().getBinding()}const s=[`${r.getPath()}/${o}`];if(n?.path){s.push(`${r.getPath()}/${n.path}`)}a.collaborativeDraft.send({action:D.Lock,content:s});e.attachEventOnce("patchCompleted",function(){a.collaborativeDraft.send({action:D.Change,content:s});a.collaborativeDraft.send({action:D.Unlock,content:s})})}l?.fireEvent("change",e)},_callSideEffectsForStream:function(e,t,n){const o=B.getExtensionController(n);if(t&&t.getBindingContext().isTransient()){return}if(t){e.oSource=t}o._sideEffects.handleFieldChange(e,B.getFieldStateOnChange(e).state["validity"])},uploadStream:function(e,t){const n=t.getSource(),o=B.getExtensionController(e),a=n.getParent(),i=a.getUploadUrl();if(i!==""){a.setUIBusy(true);n.setUploadUrl(i);const e=t.getParameter("files");const s=e&&e[0].type;F(n,s);const r=new Promise((e,t)=>{this.uploadPromises=this.uploadPromises||{};this.uploadPromises[n.getId()]={resolve:e,reject:t};n.upload()});o.editFlow.syncTask(r)}else{d.error(E(e).getText("M_FIELD_FILEUPLOADER_ABORTED_TEXT"))}},handleOpenUploader:function(e){const t=e.getSource();B._sendCollaborationMessageForFileUploader(t,D.Lock)},_sendCollaborationMessageForFileUploader(e,n){const o=t.getTargetView(e);const a=o.getController().collaborativeDraft;if(a.isConnected()){const t=e.getParent()?.getProperty("propertyPath");const o=`${e.getBindingContext()?.getPath()}/${t}`;a.send({action:n,content:o})}},handleCloseUploader:function(e){const t=e.getSource();B._sendCollaborationMessageForFileUploader(t,D.Unlock)},openExternalLink:function(e){const t=e.getSource();if(t.data("url")&&t.getProperty("text")!==""){C(t.data("url"),"_self")}},getIconForMimeType:function(e){return h.getIconForMimeType(e)},onDataFieldWithNavigationPath:async function(n,a,s){if(a._routing){const e=n.getBindingContext();const r=t.getTargetView(n),l=e.getModel().getMetaModel();const c=r.getViewData();const g=i.getDraftRootPath(e)??e.getPath();let d=await a._routing.getHashForNavigation(e,s);const p=()=>{a.getAppComponent().getRouterProxy().navToHash(d,true,false,false,!i.isStickySessionSupported(e.getModel().getMetaModel()))};if(!d?.startsWith("/")){d=`/${d}`}const f=d.startsWith(g);if(c.converterType==="ObjectPage"&&!i.isStickySessionSupported(l)&&!f){o.processDataLossOrDraftDiscardConfirmation(p,Function.prototype,e,r.getController(),true,o.NavigationType.ForwardNavigation)}else{p()}}else{e.error("FieldRuntime: No routing listener controller extension found. Internal navigation aborted.","sap.fe.macros.field.FieldRuntime","onDataFieldWithNavigationPath")}},showCollaborationEditUser:function(e,t){const n=s.getResourceModel(t);let o=m.getElementById(`manageCollaborationDraft--editUser`);if(!o){o=new p("manageCollaborationDraft--editUser",{showHeader:false,placement:"Bottom"});o.addStyleClass("sapUiContentPadding");t.addDependent(o)}const a=e.getBinding("initials")?.getBindings().find(e=>e?.getPath()?.startsWith("/collaboration/activities")).getPath();const i=e.getBindingContext("internal")?.getObject(a);let r;if(i&&i.length>0){r=i.find(t=>t.key===T(e.getBindingContext().getPath()))}o.destroyContent();o.addContent(new g({text:n.getText("C_COLLABORATIONAVATAR_USER_EDIT_FIELD",[`${r?.name}`])}));o.openBy(e)}};return B},false);
//# sourceMappingURL=FieldRuntimeHelper.js.map