/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/converters/ConverterContext","sap/fe/core/converters/ManifestWrapper","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ModelHelper","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/DisplayModeFormatter","sap/fe/macros/CommonHelper","sap/fe/macros/DelegateUtil","sap/fe/macros/filterBar/SemanticDateOperators","sap/ui/core/Element","sap/ui/mdc/condition/Condition","sap/ui/mdc/condition/ConditionConverter","sap/ui/mdc/enums/ConditionValidated","sap/ui/mdc/odata/v4/TypeMap","sap/ui/mdc/p13n/StateUtil","sap/ui/mdc/util/FilterUtil","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/odata/v4/ODataUtils","../filterBar/DraftEditState"],function(t,e,n,i,r,a,o,s,l,c,f,d,u,p,g,h,y,m,F,C,P,b,S,T,v){"use strict";var O=f.ODATA_TYPE_MAPPING;var D=c.getContextRelativeTargetObjectPath;var E=s.getAllCustomAggregates;var M=function(t){t["hiddenFilter"]="hiddenFilter";t["required"]="required";t["path"]="path";t["tooltip"]="tooltip";t["visible"]="visible";t["maxConditions"]="maxConditions";t["formatOptions"]="formatOptions";t["constraints"]="constraints";t["group"]="group";t["groupLabel"]="groupLabel";t["caseSensitive"]="caseSensitive";return t}(M||{});const A=/[+*]/g;const _={getFilter:function(t){const e=_.getFilterInfo(t).filters;return e?.length?new b(e,false):undefined},getFilterField:function(t,e,n){return o.getFilterField(t,e,n)},buildProperyInfo:function(t,e){let n;const i={};const r=e.getConverterContextFor(t.annotationPath);const a=r.getDataModelObjectPath().targetObject;const s=o.fetchTypeConfig(a);n=o.fetchPropertyInfo(e,t,s);i[t.key]=s;n=o.assignDataTypeToPropertyInfo(n,e,[],i);return n},createConverterContext:function(t,o,s,l){const c=u.getCustomData(t,"entityType"),f=o||c;const d=t.isA?n.getTargetView(t):null;const p=s||t.getModel().getMetaModel();const g=l||d&&n.getAppComponent(d);const h=a.getInvolvedDataModelObjects(p.createBindingContext(f));let y;if(t.isA&&!t.isA("sap.ui.mdc.valuehelp.FilterBar")){y=d&&d.getViewData()||{}}return i.createConverterContextForMacro(h.startingEntitySet.name,p,g?.getDiagnostics(),e,h.contextLocation,new r(y??{}))},getConvertedFilterFields:function(t,e,n,i,r,a,o){const s=this._getFilterMetaModel(t,i);const l=u.getCustomData(t,"entityType");const c=u.getCustomData(t,"annotationPath"),f=e||l;const d=this._getFieldsForTable(t,e);const p=this.createConverterContext(t,e,i??s,r);return this._getSelectionFields(t,e,l,f,d,s,p,n,a,o,c)},getBindingPathForParameters:function(t,n,i,r){const a=[];i=_.setTypeConfigToProperties(i);for(const o of r){if(n[o]&&n[o].length>0){const r=e({},n[o][0]);const s=P.getPropertyByKey(i,o);const l=s.typeConfig||F.getTypeConfig(s.dataType,s.formatOptions,s.constraints);const c=y.toType(r,l,t.getTypeMap());const f=O[l.className];a.push(`${o}=${encodeURIComponent(T.formatLiteral(c.values[0],f))}`)}}const o=t.data("entityType");const s=o.substring(0,o.length-1);const l=s.slice(0,s.lastIndexOf("/"));const c=s.substring(s.lastIndexOf("/")+1);return`${l}(${a.toString()})/${c}`},getEditStateIsHideDraft:function(t){let e=false;if(t&&t.$editState){const n=t.$editState.find(function(t){return t.operator==="DRAFT_EDIT_STATE"});if(n&&(n.values.includes("ALL_HIDING_DRAFTS")||n.values.includes("SAVED_ONLY"))){e=true}}return e},getFilterInfo:function(t,e,n){let i=e&&e.ignoredProperties||[];const r=e&&e.targetControl,a=r?r.data("entityType"):undefined;const o={};let s=t,l,c=[],f,d=e&&e.propertiesMetadata;if(typeof t==="string"){s=g.getElementById(t)}if(s){l=this._getSearchField(s,i);const t=this._getFilterConditions(e,n,s);let r;if(s.isA("sap.ui.mdc.FilterBar")){r=this.getFilterPropertyInfo(s)}else{r=s.getPropertyInfoSet?s.getPropertyInfoSet():null}r=this._getFilterPropertiesMetadata(r,s);if(e&&e.targetControl&&e.targetControl.isA("sap.ui.mdc.Chart")){Object.keys(t).forEach(function(e){if(e==="$editState"){delete t["$editState"]}})}let u=s.data("parameters")||[];u=typeof u==="string"?JSON.parse(u):u;if(u&&u.length>0){f=_.getBindingPathForParameters(s,t,r,u);if(Object.keys(t).length){Object.keys(t).forEach(e=>{u.forEach(n=>{if(e===n){const i=t[e][0].values;o[n]=i[0]}})})}}if(t){if(a&&s.data("entityType")&&s.data("entityType")!==a){const t=s.getModel().getMetaModel();const e=s.getControlDelegate?.().fetchPropertiesForEntity(a,t,s);d=e;const n=this._getIgnoredProperties(r,e);if(n.length>0){i=i.concat(n)}}else if(!d&&r){d=r}c=this.getEditStateAndFilter({oIFilter:s,mConditions:t,aPropertiesMetadata:d,aIgnoreProperties:i,aParameters:u})}}return{parameters:o,filters:c,search:l||undefined,bindingPath:f}},getEditStateAndFilter:function(t){let{oIFilter:e,mConditions:i,aPropertiesMetadata:r,aIgnoreProperties:a,aParameters:o}=t;const s=P.getFilterInfo(e,i,_.setTypeConfigToProperties(r),a.concat(o)).filters;const l=r?.filter(t=>t.name==="$editState");let c;if(!a.includes("$editState")&&l&&l.length>0){if(i.hasOwnProperty("$editState")){const t=i["$editState"];c=v.getFilterForEditState(t?.[0]?.values?.[0])}else{c=v.getFilterForEditState("")}}else{const t=n.getTargetView(e);const i=n.getAppComponent(t);const r=i.getEnvironmentCapabilities()?.getCapabilities()?.HiddenDraft?.enabled;if(r&&e.hasOwnProperty("disableDraftEditStateFilter")&&e.getProperty("disableDraftEditStateFilter")){c=v.getFilterForEditState("ALL")}}let f=s?[s]:[];if(e.isA("sap.ui.mdc.FilterBar")){this._transformDateTimeOffsetFilters(f,i,e)}if(c){const t=this.hasEditStateFilterRecursively(f);if(t){f=this.exchangeEditStateFilterRecursively(c,f)}else{f=[new b({filters:[...f,c],and:true})]}}return f},_transformDateTimeOffsetFilters:function(t,e,n){if(!t||!Array.isArray(t)||!e){return}let i=t;const r=t[0];if(r?.aFilters&&r.aFilters.length>0){i=r.aFilters}const a=n.getPropertyHelper();if(!a){return}const o=new Set;Object.keys(e).forEach(function(t){if(e[t]&&e[t].length>0){const e=a.getProperty(t);const n=(e?.dataType?.includes("DateTimeOffset")??false)||(e?.typeConfig?.typeInstance?.getName().includes("DateTimeOffset")??false);const i=e?.constraints?.precision??e?.typeConfig?.typeInstance?.constraints?.precision;if(n&&i===7){o.add(t)}}});this._transformDateTimeOffSetFilterValueRecursively(i,o)},_transformDateTimeOffSetFilterValueRecursively:function(e,n){for(let i=0;i<e.length;i++){const r=e[i];const a=r;if(a.aFilters&&a.aFilters.length>0){this._transformDateTimeOffSetFilterValueRecursively(a.aFilters,n);continue}const o=r.getPath();const s=r.getOperator();const l=r.getValue1();if(s===undefined){t.warning("FilterUtils._transformDateTimeOffsetFilters: Filter operator is undefined, skipping filter transformation",`filterPath: ${o}, filterValue1: ${l}`);continue}if(s==="EQ"&&l!==undefined&&l!==null){if(o&&n.has(o)){const t=this._transformDateTimeOffSetFilterValue(r);if(t){e[i]=t}}}else if(s==="Any"){const a=r.getCondition();if(!a){continue}const s=a;if(s.aFilters&&s.aFilters.length>0){let a=false;for(let e=0;e<s.aFilters.length;e++){const i=s.aFilters[e];const r=i;if(r.aFilters&&r.aFilters.length>0){this._transformDateTimeOffSetFilterValueRecursively(r.aFilters,n);continue}const l=i.getPath();const c=i.getOperator();const f=i.getValue1();if(c===undefined){t.warning("FilterUtils._transformDateTimeOffsetFilters: Filter operator is undefined, skipping filter transformation",`filterPath: ${l}, filterValue1: ${f}`);continue}if(c==="EQ"&&f!==undefined&&f!==null){const t=Array.from(n).find(function(t){const e=t.split("/");if(e.length===2){const t=e[0].replace("*","");const n=e[1];return o===t&&Boolean(l?.endsWith(n))}return false});if(t){const t=this._transformDateTimeOffSetFilterValue(i);if(t){s.aFilters[e]=t;a=true}}}}if(a){e[i]=new b({path:o,operator:"Any",variable:r.getVariable(),condition:new b({filters:s.aFilters,and:s.bAnd??true})})}}else{const s=a.getPath();const l=a.getOperator();const c=a.getValue1();if(l===undefined){t.warning("FilterUtils._transformDateTimeOffsetFilters: Filter operator is undefined, skipping filter transformation",`filterPath: ${s}, filterValue1: ${c}`);continue}if(l==="EQ"&&c!==undefined&&c!==null){const t=Array.from(n).find(function(t){const e=t.split("/");if(e.length===2){const t=e[0].replace("*","");const n=e[1];return o===t&&Boolean(s?.endsWith(n))}return false});if(t){const t=this._transformDateTimeOffSetFilterValue(a);if(t){e[i]=new b({path:o,operator:"Any",variable:r.getVariable(),condition:t})}}}}}}},_transformDateTimeOffSetFilterValue:function(t){const e=t.getValue1()?.toString();if(!e){return null}const n=e.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})(?:\.(\d{0,7}))?([+-]\d{2}:\d{2}|Z)$/);if(n){const e=n[1];const i=n[3];const r=`${e}.0000000${i}`;const a=`${e}.9990000${i}`;return new b({path:t.getPath(),operator:S.BT,value1:r,value2:a})}return null},hasEditStateFilterRecursively:function(t){return t.some(t=>{if(t.getPath()==="$editState"){return true}else if(t.getFilters()!==undefined){return this.hasEditStateFilterRecursively(t.getFilters())}else{return false}})},exchangeEditStateFilterRecursively:function(t,e){return e.map(e=>{if(e.getPath()==="$editState"){return t}else if(e.getFilters()!==undefined){e=new b({filters:this.exchangeEditStateFilterRecursively(t,e.getFilters()),and:e.isAnd()});return e}return e})},setTypeConfigToProperties:function(t){if(t&&t.length){t.forEach(function(t){if(t.typeConfig&&t.typeConfig.typeInstance&&t.typeConfig.typeInstance.getConstraints instanceof Function){return}if(t.path==="$editState"){t.typeConfig=F.getTypeConfig("sap.ui.model.odata.type.String",{},{})}else if(t.path==="$search"){t.typeConfig=F.getTypeConfig("sap.ui.model.odata.type.String",{},{})}else if(t.dataType||t.typeConfig&&t.typeConfig.className){t.typeConfig=F.getTypeConfig(t.dataType||t.typeConfig?.className,t.formatOptions,t.constraints)}})}return t},getNotApplicableFilters:function(t,e){const n=e.data("entityType"),i=t.data("entityType"),r=t.getModel().getMetaModel(),a=r.getObject(i),o=[],s=t.getConditions(),l=n===i,c=e.isA("sap.ui.mdc.Chart"),f=!c&&e.getParent().getTableDefinition().enableAnalytics,p=!c&&e.getParent().getTableDefinition().control.type==="TreeTable",g=c?d.parseCustomData(u.getCustomData(e,"applySupported")).enableSearch:!(f||p)||e.getParent().getTableDefinition().enableBasicSearch;if(s&&(!l||f||c||p)){const i=l?[]:t.getControlDelegate().fetchPropertiesForEntity(n,r,t),d=i.reduce(function(t,e){t[e.name]=e;return t},{}),u={};const g=e.getModel().getMetaModel().getObject(e.data("targetCollectionPath")+"/");if(e.isA("sap.ui.mdc.Chart")){const t=e.getModel().getMetaModel().getObject(`${e.data("targetCollectionPath")}@`),n=E(t);Object.keys(n).forEach(function(t){if(!u[t]){const e=n[t];u[t]=e}})}for(const t in s){const e=s[t];let n=true;if(g[t]&&a[t]){n=g[t]["$Type"]===a[t]["$Type"]}if(Array.isArray(e)&&e.length>0&&((!d[t]||d[t].isCustomFilter&&d[t].annotationPath==undefined||d[t]&&!n)&&(!l||t==="$editState"&&(c||p||f))||u[t])){o.push(t.replace(/[+|*]/g,""))}}}if(!g&&t.getSearch()){o.push("$search")}return o},async _getValueListInfo(t,e){const n=t.getModel()?.getMetaModel();if(!n){return undefined}const i=t.data("entityType")??"";const r=await n.requestValueListInfo(i+e,true).catch(()=>null);return r?.[""]},getFilterPropertyInfo(t){let e=t.data("feFilterInfo");if(typeof e==="string"){e=JSON.parse(e)}return e||[]},_getConditionValidated:async function(e,n,i){if(!e){return m.NotValidated}try{const t=e.Parameters.filter(t=>["com.sap.vocabularies.Common.v1.ValueListParameterInOut".valueOf(),"com.sap.vocabularies.Common.v1.ValueListParameterOut".valueOf()].includes(t.$Type)).filter(t=>t.LocalDataProperty?.$PropertyPath===n).map(t=>t.ValueListProperty);const r=t[0]??n;const a=new b({path:r,operator:S.EQ,value1:i});const o=e.$model.bindList(`/${e.CollectionPath}`,undefined,undefined,a,{$select:r});const s=(await o.requestContexts()).length>0;if(s){return m.Validated}else{return m.NotValidated}}catch(e){t.error("FilterUtils: Error while retrieving ConditionValidated",e);return m.NotValidated}},async _clearFilterValue(t,e){const n=await C.retrieveExternalState(t);if(n.filter[e]){n.filter[e].forEach(t=>{t.filtered=false});await C.applyExternalState(t,{filter:{[e]:n.filter[e]}})}},setFilterValues:async function(t,e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++){i[r-2]=arguments[r]}await this._setFilterValues(t,false,e,...i)},addFilterValues:async function(t,e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++){i[r-2]=arguments[r]}await this._setFilterValues(t,true,e,...i)},getPropertyPathFromConditionPath(t){return t.replace(A,"")},getFilterBarForAdaptationControl(t){while(t&&!t.isA("sap.ui.mdc.FilterBar")){t=t.getParent()}return t},getDataModelObjectPathForProperty(t,e){const n=u.getCustomData(t,"entityType");const i=t.getModel()?.getMetaModel();return a.getInvolvedDataModelObjects(i.createBindingContext(`${n}${e}`),i.createBindingContext(`${n}`))},_setFilterValues:async function(e,n,i){for(var r=arguments.length,a=new Array(r>3?r-3:0),o=3;o<r;o++){a[o-3]=arguments[o]}let s=a?.[0];let l=a?.[1];if(!e){return}if(a.length===2&&(l===undefined||l===null||l==="")&&s&&Object.keys(S).includes(s)){t.warning(`An empty filter value cannot be applied with the ${s} operator`);return}if(l===undefined&&!p.getSemanticDateOperations().includes(s||"")){l=s??[];s=undefined}if(!s){s=S.EQ}const c=["string","number","boolean"];if(l!==undefined&&(!Array.isArray(l)&&!c.includes(typeof l)||Array.isArray(l)&&l.length>0&&!c.includes(typeof l[0]))){throw new Error("FilterUtils.js#_setFilterValues: Filter value not supported; only primitive values or an array thereof can be used.")}let f;if(l!==undefined){f=Array.isArray(l)?l:[l]}const d={};if(i){const t=_.getPropertyPathFromConditionPath(i);const n=_.getFilterBarForAdaptationControl(e)??e;const r=_.getDataModelObjectPathForProperty(n,t);const a=r?.targetObject?.name??t;i=(r?D(r,false,true):undefined)??i;const o=await this._getValueListInfo(n,t);if(f&&f.length){if(s===S.BT){d[i]=[h.createCondition(s,f,null,null,m.NotValidated)]}else{d[i]=await Promise.all(f.map(async t=>{const e=s===S.EQ?await this._getConditionValidated(o,a,t):m.NotValidated;return h.createCondition(s,[t],null,null,e)}))}}else if(p.getSemanticDateOperations().includes(s||"")){d[i]=[h.createCondition(s,[],null,null,m.NotValidated)]}}if(!n){await this._clearFilterValue(e,i)}if(d[i]){await C.applyExternalState(e,{filter:d})}},conditionToModelPath:function(t){return t.replace(/\//g,"\\")},_getFilterMetaModel:function(t,e){return e||t.getModel().getMetaModel()},_getEntitySetPath:function(t){return t&&l.getEntitySetPath(t)},_getFieldsForTable:function(t,e){const i=[];if(e){const e=n.getTargetView(t);const r=e&&e.getController()&&e.getController()._getControls&&e.getController()._getControls("table");if(r){r.forEach(function(t){i.push(t.getParent().getTableDefinition())})}return i}return[]},_getSelectionFields:function(t,e,n,i,r,s,l,c,f,d,u){const p=o.getSelectionFields(l,r,u,c,d);let g=p.selectionFields;const h=t.data?this.getFilterPropertyInfo(t):JSON.parse(p.sPropertyInfo.replace(/\\\{/g,"{").replace(/\\\}/g,"}"));if((f?f.getControlType(t)==="sap.ui.mdc.FilterBar":t.isA("sap.ui.mdc.FilterBar"))&&e!==n){const t=a.getInvolvedDataModelObjects(s.createBindingContext(i));const e=l.getConverterContextFor(n);const r=e.getEntityTypeAnnotation("@com.sap.vocabularies.UI.v1.SelectionFields").annotation||[];const c={};g.forEach(function(t){c[t.conditionPath]=true});r.forEach(function(e){const n=e.value;if(!c[n]){const e=o.getFilterField(n,l,t.startingEntitySet.entityType);if(e){g.push(e)}}})}if(g){const t=[];g.forEach(function(e){t.push(e.key)});g=this._getSelectionFieldsFromPropertyInfos(t,g,h)}return g},_getSelectionFieldsFromPropertyInfos:function(t,e,n){n.forEach(function(n){if(n.name==="$search"||n.name==="$editState"||n.key===undefined){return}const i=e[t.indexOf(n.key)];if(t.includes(n.key)&&i.annotationPath){n.group=i.group;n.groupLabel=i.groupLabel;n.settings=i.settings;n.visualFilter=i.visualFilter;n.label=n.label?n.label:i.label;n.annotationPath=n.annotationPath??i.annotationPath;e[t.indexOf(n.key)]=n}if(!t.includes(n.key)&&!n.annotationPath){e.push(n)}});return e},_getSearchField:function(t,e){return t.getSearch&&!e.includes("search")?t.getSearch():null},_getFilterConditions:function(t,e,n){const i=e||n.getConditions();if(t&&t.targetControl&&t.targetControl.isA("sap.ui.mdc.Chart")){Object.keys(i).forEach(function(t){if(t==="$editState"){delete i["$editState"]}})}return i},_getFilterPropertiesMetadata:function(t,e){if(!(t&&t.length)){if(e.getPropertyInfo){t=e.getPropertyInfo()}else{t=null}}return t},_getIgnoredProperties:function(t,e){const n=[];t.forEach(function(t){const i=t.name;const r=e.find(t=>t.name===i);if(r&&(!t.isCustomFilter&&t.dataType!==r.dataType||t.isCustomFilter&&r.annotationPath===undefined)){n.push(i)}});return n},getFilters:function(t){if(!t||typeof t.isInitialized!=="function"||!t.isInitialized()){return}const{parameters:e,filters:n,search:i}=this.getFilterInfo(t);return{parameters:e,filters:n,search:i}},formatPropertyInfo:function(t){if(typeof t==="string"){let e=t.replace(/\\\{/g,"{");e=e.replace(/\\\}/g,"}");let n=JSON.parse(e);n=this._formatPropertyInfo(n);let i=JSON.stringify(n);i=i.replace(/\{/g,"\\{");i=i.replace(/\}/g,"\\}");return i}else{return this._formatPropertyInfo(t)}},_formatPropertyInfo:function(t){return t.map(t=>{const e={key:t.key||t.name,dataType:"",label:""};for(const n in M){if(t.hasOwnProperty(n)){switch(n){case"hiddenFilter":e.hiddenFilter=t.hiddenFilter;break;case"required":e.required=t.required;break;case"path":e.path=t.path;break;case"tooltip":e.tooltip=t.tooltip;break;case"visible":e.visible=t.visible;break;case"maxConditions":e.maxConditions=t.maxConditions;break;case"formatOptions":e.formatOptions=t.formatOptions;break;case"constraints":e.constraints=t.constraints;break;case"group":e.group=t.group;break;case"groupLabel":e.groupLabel=t.groupLabel;break;case"caseSensitive":e.caseSensitive=t.caseSensitive}}}if(t.dataType){e.dataType=t.dataType}else{throw new Error(`Missing mandatory property dataType for filter-bar filter field: ${t}`)}if(t.label){e.label=t.label}return e})}};return _},false);
//# sourceMappingURL=FilterUtils.js.map