/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/base/BindingToolkit","sap/fe/base/ClassSupport","sap/fe/core/helpers/BindingHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/UIFormatters","sap/fe/macros/field/FieldHelper","sap/fe/macros/field/FieldTemplating","sap/ui/core/CustomData","sap/ui/mdc/MultiValueField","sap/ui/mdc/field/MultiValueFieldItem","sap/fe/core/buildingBlocks/BuildingBlock","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controls/FormElementWrapper","sap/fe/core/formatters/CollaborationFormatter","sap/fe/core/helpers/ModelHelper","sap/fe/core/templating/FieldControlHelper","sap/fe/macros/field/FieldRuntime","sap/fe/macros/multivaluefield/FormatOptions","sap/fe/macros/multivaluefield/MultiValueFieldRuntime","sap/m/Avatar","sap/m/HBox","sap/ui/base/Event","sap/ui/core/Element","./ValueHelp","./field/FieldRuntimeHelper","sap/fe/base/jsx-runtime/jsx"],function(t,e,i,a,o,n,r,l,s,d,c,u,h,p,f,g,b,m,y,v,P,M,C,x,E,I,O,F){"use strict";var D,_,w,B,z,S,V,j,A,L,R,H,T,$,G,k,q,U,N,Q,W,J,K,X,Y;var Z={};var tt=m.isRequiredExpression;var et=m.isReadOnlyExpression;var it=p.CollaborationFieldGroupPrefix;var at=s.getVisibleExpression;var ot=s.getValueBinding;var nt=r.getDisplayMode;var rt=r.getCollaborationExpression;var lt=n.isPathInsertable;var st=n.isPathDeletable;var dt=n.getTargetObjectPath;var ct=n.getRelativePaths;var ut=n.getContextRelativeTargetObjectPath;var ht=n.enhanceDataModelPath;var pt=o.isPropertyPathExpression;var ft=o.isProperty;var gt=o.isPathAnnotationExpression;var bt=o.isMultipleNavigationProperty;var mt=i.UI;var yt=e.property;var vt=e.implementInterface;var Pt=e.defineUI5Class;var Mt=e.association;var Ct=e.aggregation;var xt=t.or;var Et=t.not;var It=t.isConstant;var Ot=t.ifElse;var Ft=t.getExpressionFromAnnotation;var Dt=t.equal;var _t=t.constant;var wt=t.compileExpression;var Bt=t.and;function zt(t,e,i,a){i&&Object.defineProperty(t,e,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(a):void 0})}function St(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,Vt(t,e)}function Vt(t,e){return Vt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Vt(t,e)}function jt(t,e,i,a,o){var n={};return Object.keys(a).forEach(function(t){n[t]=a[t]}),n.enumerable=!!n.enumerable,n.configurable=!!n.configurable,("value"in n||n.initializer)&&(n.writable=!0),n=i.slice().reverse().reduce(function(i,a){return a(t,e,i)||i},n),o&&void 0!==n.initializer&&(n.value=n.initializer?n.initializer.call(o):void 0,n.initializer=void 0),void 0===n.initializer?(Object.defineProperty(t,e,n),null):n}function At(t,e){throw Error("Decorating class property failed. Please ensure that transform-class-properties is enabled and runs after the decorators transform.")}let Lt=(D=Pt("sap.fe.macros.MultiValueField"),_=vt("sap.ui.core.IFormContent"),w=yt({type:"string"}),B=Mt({type:"string"}),z=Mt({type:"string"}),S=yt({type:"string",required:true}),V=yt({type:"boolean",required:false}),j=yt({type:"string"}),A=yt({type:"any",isBindingInfo:true}),L=Ct({type:"sap.fe.macros.multivaluefield.FormatOptions",multiple:false,defaultClass:v}),R=yt({type:"boolean"}),H=yt({type:"boolean"}),D(T=($=function(t){function e(e,i){var a;if(typeof e!=="string"){e._isInEditMode=wt(mt.IsEditable)}a=t.call(this,e,i)||this;zt(a,"__implements__sap_ui_core_IFormContent",G,a);zt(a,"id",k,a);zt(a,"idPrefix",q,a);zt(a,"vhIdPrefix",U,a);zt(a,"metaPath",N,a);zt(a,"readOnly",Q,a);zt(a,"contextPath",W,a);zt(a,"items",J,a);zt(a,"formatOptions",K,a);zt(a,"_isInEditMode",X,a);zt(a,"useParentBindingCache",Y,a);return a}Z=e;St(e,t);var i=e.prototype;i._overrideValue=function t(e,i,a,o){if(this.items){const t=this.items.model??this.items.modelName;e={path:`${t}>${this.items.path}`};const n=i.targetObject;const r=`{${t}>${n.name}}`;if(gt(n.annotations.Common?.Text)){a=`{${t}>${n.annotations.Common?.Text?.path}}`}else{a=r}o=r}return{description:a,collectionBinding:e,key:o}};i._getMultiInputSettings=function t(i,a){const o=e._getPathStructure(i);let{collectionPath:n}=o;const r=o.itemDataModelObjectPath;if(this.metaPath.startsWith("/")&&this.items){n=`/${i.contextLocation?.startingEntitySet.name}`}const l=this.useParentBindingCache?{path:n,templateShareable:false}:{path:n,parameters:{$$ownRequest:true},templateShareable:false};const s=i.targetObject;const d=pt(s)?s.$target:s;const c=d?.annotations.Common?.Text;const u=ct(i);const h=c?wt(Ft(c,u)):ot(r,a??{},true);const p=ot(r,a??{},true);let f=false;if(ct(r).length>0){f=true}return{displayOnly:f,...this._overrideValue(l,r,h,p)}};e._getPathStructure=function t(e){let i="";const a=e.contextLocation?.targetEntitySet?e.contextLocation.targetEntitySet:e.startingEntitySet;const o=[];const n=e.contextLocation?.navigationProperties||[];for(const t of e.navigationProperties){if(e.contextLocation===undefined||!e.contextLocation.navigationProperties.some(e=>e.fullyQualifiedName===t.fullyQualifiedName)){o.push(t.name);n.push(t);if(a.navigationPropertyBinding.hasOwnProperty(t.name)){if(bt(t)){break}}}}i=`${o.join("/")}`;const r=Object.assign({},e);if(r.contextLocation){r.contextLocation.navigationProperties=n}return{collectionPath:i,itemDataModelObjectPath:r}};i.computeFieldGroupIds=function t(e){if(!e){return""}const i=e.getSideEffectsService();const a=i.computeFieldGroupIds(this.dataModelPath.targetEntityType.fullyQualifiedName,this.dataModelPath.targetObject.fullyQualifiedName);if(this.collaborationEnabled){const t=`${it}${this.dataSourcePath}`;a.push(t)}this.fieldGroupIds=a.length?a.join(","):undefined;const o=a.join(",");return o===""?undefined:o};i.initialize=function t(e){const i=this._getOwner();this.contextPath=this.contextPath??i?.preprocessorContext?.fullContextPath;const a=i?.getMetaModel();const o=a?.createBindingContext(e.getPath());const n=e?.getTarget();if(ft(n)&&n.annotations.UI?.DataFieldDefault!==undefined){this.enhancedMetaPath=a?.createBindingContext(`@${"com.sap.vocabularies.UI.v1.DataFieldDefault"}`,o)}else{this.enhancedMetaPath=o}const r=this.getDataModelObjectForMetaPath(this.enhancedMetaPath.getPath(),this.contextPath);this.convertedDataField=r.targetObject;this.dataModelPath=ht(r,this.convertedDataField.Value.path);this.dataSourcePath=dt(this.dataModelPath);this.property=this.dataModelPath.targetObject;let l=lt(this.dataModelPath);const s=st(this.dataModelPath,{ignoreTargetCollection:true,authorizeUnresolvable:true});const d=st(this.dataModelPath);let c=Ot(s._type==="Unresolvable",xt(Et(It(d)),d),d);if(this.items){l=c=_t(!this.readOnly)}else{this.visible=at(this.dataModelPath,this.formatOptions)}this.insertableAndDeletable=Bt(l,c);this.collaborationExpression=_t(false);this.computeCollaborationProperties();const u=this.isPropertyInitial("readOnly")?undefined:this.readOnly;if(this.formatOptions?.displayOnly===true||u===true){this.editMode="Display"}else if(this.readOnly===false){this.editMode=wt(Ot(Bt(l,c),Ot(this.collaborationExpression,_t("ReadOnly"),_t("Editable")),_t("Display")))}else{this.editMode=wt(Ot(Bt(l,c,mt.IsEditable,Et(Dt(true,et(this.convertedDataField)))),Ot(this.collaborationExpression,_t("ReadOnly"),_t("Editable")),_t("Display")))}this.displayMode=nt(this.dataModelPath);const h=ht(this.getDataModelObjectForMetaPath(this.enhancedMetaPath.getPath(),this.contextPath),this.convertedDataField.Value.path);this.item=this._getMultiInputSettings(h,this.formatOptions);if(this.item.displayOnly){this.editMode="Display"}this.collection=this.item.collectionBinding;const p=this.getAppComponent();this.fieldGroupIds=this.computeFieldGroupIds(p)};i.onMetadataAvailable=function t(){if(!this.content){this.content=this.createContent()}};i.isCollaborationDraftSupported=function t(){const e=this._getOwner();const i=e?.getMetaModel();return b.isCollaborationDraftSupported(i)};i.computeCollaborationProperties=function t(){if(this.isCollaborationDraftSupported()&&this.editMode!=="Display"){this.collaborationEnabled=true;this.collaborationExpression=r.getCollaborationExpression(this.dataModelPath,g.hasCollaborationActivity);this.collaborationInitialsExpression=wt(rt(this.dataModelPath,g.getCollaborationActivityInitials));this.collaborationColorExpression=wt(rt(this.dataModelPath,g.getCollaborationActivityColor))}};i.getRequired=function t(){return this.getMultiValueField().getRequired()};i.getItems=function t(){return this.getMultiValueField().getItems()};i.createContent=function t(){const e=this.getMetaPathObject(this.metaPath,this.contextPath);if(e){this.initialize(e);if(this.id){this.vhIdPrefix=a.generate([this.getId(),this.vhIdPrefix??"FieldValueHelp"])}else if(!this.vhIdPrefix){this.vhIdPrefix=this.createId("FieldValueHelp")}const t=this._getOwner()?.getRootController();const i=t.getView();const o=this._getOwner()?.getMetaModel();const n=o?.createBindingContext(e.getPath());const r=o?.createBindingContext(e.getContextPath());if(!n||!r){return}const s=this.collection;const h=this.getAppComponent()?.getManifestEntry("sap.fe")?.macros?.multiValueField?.itemsSizeLimit;if(h!==undefined){s.length=h}const p=l.computeLabelText(this.convertedDataField.Value,{context:n});const g=I.getValueHelpForMetaPath(this.getPageController(),ut(this.dataModelPath),this.contextPath??this.getOwnerContextPath(),this._getOwner()?.getMetaModel());let b;if(g&&g.getContent()){b=g.getContent().getId()}const m=F(c,{id:this.createId("_mvf"),delegate:{name:"sap/fe/macros/multivaluefield/MultiValueFieldDelegate"},items:s,display:this.displayMode,width:"100%",editMode:this.editMode,valueHelp:b,ariaLabelledBy:this.ariaLabelledBy?this.ariaLabelledBy:[],showEmptyIndicator:this.formatOptions?.showEmptyIndicator,label:p,required:wt(Bt(mt.IsEditable,tt(this.convertedDataField))),change:P.handleChange.bind(P,t),fieldGroupIds:this.fieldGroupIds,validateFieldGroup:y.onValidateFieldGroup,children:{items:F(u,{description:this.item.description},this.item.key),customData:F(d,{value:this.insertableAndDeletable},"insertableAndDeletable")}});let v=null;if(this.collaborationEnabled){const e=F(M,{visible:this.collaborationExpression,initials:this.collaborationInitialsExpression,displaySize:"Custom",customDisplaySize:"1.5rem",customFontSize:"0.8rem",backgroundColor:this.collaborationColorExpression,press:()=>{O.showCollaborationEditUser(e,i)}});v=F(f,{children:F(C,{width:"100%",renderType:"Bare",alignItems:"End",children:{items:[m,e]}})});m?.addEventDelegate({onfocusin:e=>{const i=e.srcControl.getParent();t.collaborativeDraft?.handleContentFocusIn(i);if(a?.getDomRef()){a.attachEventOnce("closed",()=>{i?.focus()})}},onfocusout:e=>{let i=e.srcControl.getParent();if(i?.isA("sap.m.Tokenizer")){i=i.getParent()?.getParent()}const a=new x("",i,{fieldGroupIds:i.getFieldGroupIds()});t.collaborativeDraft.handleContentFocusOut(a)}},this);const a=E.getElementById(m.getValueHelp());a?.attachOpened(e=>{const i=e.getSource().getControl();t.collaborativeDraft.handleContentFocusIn(i)})}m.addCustomData(new d({key:"forwardedItemsBinding",value:this.items}));return this.collaborationEnabled?v:m}};i.setReadOnly=function e(i){t.prototype.setProperty.call(this,"readOnly",i);this.updateEditMode()};i.set_isInEditMode=function e(i){t.prototype.setProperty.call(this,"_isInEditMode",i);this.updateEditMode()};i.getMultiValueField=function t(){if(this.isCollaborationDraftSupported()){return this.content.content.getItems()[0]}else{return this.content}};i.updateEditMode=function t(){if(!this.content){return}const e=this.getMultiValueField();const i=e.data("insertableAndDeletable");if(this.readOnly===true||!i){this.editMode="Display";e.setEditMode("Display")}else if(this.readOnly===false&&i){if(this._isInEditMode){this.editMode="Editable";e.setEditMode("Editable")}else{this.editMode="Display";e.setEditMode("Display")}}};i.onBeforeRendering=function t(){if(this.content){const t=this.getMultiValueField();const e=this.getAriaLabelledBy();for(const i of e){const e=t.getAriaLabelledBy();if(!e.includes(i)){t.addAriaLabelledBy(i)}}}};return e}(h),G=jt($.prototype,"__implements__sap_ui_core_IFormContent",[_],{configurable:true,enumerable:true,writable:true,initializer:function(){return true}}),k=jt($.prototype,"id",[w],{configurable:true,enumerable:true,writable:true,initializer:null}),q=jt($.prototype,"idPrefix",[B],{configurable:true,enumerable:true,writable:true,initializer:null}),U=jt($.prototype,"vhIdPrefix",[z],{configurable:true,enumerable:true,writable:true,initializer:null}),N=jt($.prototype,"metaPath",[S],{configurable:true,enumerable:true,writable:true,initializer:null}),Q=jt($.prototype,"readOnly",[V],{configurable:true,enumerable:true,writable:true,initializer:null}),W=jt($.prototype,"contextPath",[j],{configurable:true,enumerable:true,writable:true,initializer:null}),J=jt($.prototype,"items",[A],{configurable:true,enumerable:true,writable:true,initializer:null}),K=jt($.prototype,"formatOptions",[L],{configurable:true,enumerable:true,writable:true,initializer:null}),X=jt($.prototype,"_isInEditMode",[R],{configurable:true,enumerable:true,writable:true,initializer:function(){return false}}),Y=jt($.prototype,"useParentBindingCache",[H],{configurable:true,enumerable:true,writable:true,initializer:function(){return false}}),$))||T);Z=Lt;return Z},false);
//# sourceMappingURL=MultiValueField.js.map