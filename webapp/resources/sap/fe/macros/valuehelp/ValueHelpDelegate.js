/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/ObjectPath","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/TypeGuards","sap/fe/macros/filter/FilterUtils","sap/fe/macros/internal/valuehelp/ValueListHelper","sap/m/inputUtils/highlightDOMElements","sap/ui/core/message/MessageType","sap/ui/mdc/ValueHelpDelegate","sap/ui/mdc/condition/Condition","sap/ui/mdc/enums/ConditionValidated","sap/ui/mdc/enums/RequestShowContainerReason","sap/ui/mdc/odata/v4/TypeMap","sap/ui/mdc/p13n/StateUtil","sap/ui/model/FilterType","../internal/valuehelp/AdditionalValueHelper"],function(t,e,n,i,a,o,s,r,l,c,u,d,f,g,p,h,y,m){"use strict";var P=m.additionalValueHelper;var C=m.AdditionalValueGroupKey;var v=o.isPathAnnotationExpression;var V=a.convertTypes;var F=i.Activity;const _="sap.fe.macros.controls.FilterBar";const D="@com.sap.vocabularies.Common.v1.IsDigitSequence";return Object.assign({},u,{apiVersion:2,updateBindingDonePromises:new WeakMap,isSearchSupported:function(t,e,n){return!!e.data("searchSupported")},updateBindingInfo:function(t,e,i){u.updateBindingInfo(t,e,i);if(e.data("searchSupported")){const t=e.getFilterValue();const a=n.normalizeSearchTerm(t);if(i.parameters){i.parameters.$search=a||undefined}}},_getValueHelpHistoryService(t){const e=n.getAppComponent(n.getTargetView(t));return e.getValueHelpHistoryService()},checkConditionsEqual(t,e){if(t.operator!==e.operator){return false}const n=t.values??[];const i=e.values??[];if(n.length!==i.length){return false}const a=[...n].sort((t,e)=>String(t).localeCompare(String(e)));const o=[...i].sort((t,e)=>String(t).localeCompare(String(e)));return a.every((t,e)=>t===o[e])},_getHistoryData:async function(e,n){if(e.history?.enabled&&e.isPotentiallySensitive!==true){const i=this._getValueHelpHistoryService(n);try{const t=await i.getFieldData(e.propertyPath+"/"+e.valueHelpQualifier);e.history.data=t;return t}catch(e){t.error(e instanceof Error?e.message:String(e))}}return[]},_setHistoryData:async function(e,n,i){if(e.history?.enabled&&e.isPotentiallySensitive!==true&&n.length){const a=this._getValueListPropertyFromPayloadQualifier(e);if(a){const a=[];for(const t of n){if(e.isUnitValueHelp||t.validated===f.Validated){const e=this._getConditionPayloadList(t)?.[0];if(e){a.push(this.convertConditionPayloadToNestedObject(e))}}}if(a.length){const n=this._getValueHelpHistoryService(i);try{await n.setFieldData(e.propertyPath+"/"+e.valueHelpQualifier,a)}catch(e){t.error(e instanceof Error?e.message:String(e))}}}}},convertConditionPayloadToNestedObject:function(t){const n={};for(const i in t){e.set(i.split("/"),t[i],n)}return n},_isEmptyDigitSequence:function(t,e){let n=false;if(e){n=typeof t==="string"?t.split("").every(t=>t==="0")??t==="":t===null||t===undefined||t===0}return n},updateBinding:async function(t,e,n,i){if(!e.isA("sap.ui.model.odata.v4.ODataListBinding")){return}const a=t.getPayload();if(i.isTypeahead()){let t;const o=new Promise(function(e){t=e});const s=this.updateBindingDonePromises.get(e);this.updateBindingDonePromises.set(e,s?s.then(async()=>o):o);const r=this._getValueListPropertyFromPayloadQualifier(a);const l=i.getControl();const c=l.isA("sap.ui.mdc.FilterField")||l.isA("sap.ui.mdc.MultiValueField");const u=!c&&l.getValue();const d=[];const f=l.getModel().getMetaModel().getObject(`${a.propertyPath}${D}`)??false;if(!u||l.hasPendingUserInput()||this._isEmptyDigitSequence(u,f)){const t=this.getRelevantRecommendations(i,a);if(t.length){d.push({propertyPath:r,values:t,groupKey:C.recommendation})}}const g=i.getTable();const p=g.getCustomData().filter(t=>t.getKey()==="sorters");let h=[];if(p.length)h=p[0].getValue().sorters;await this._updateBindingWithTransientContexts(a,e,n,d,r,l,h,g);if(t){t()}}else{this._updateBinding(e,n)}},executeFilter:async function(t,e,n){e.getContexts(0,n);await this.checkListBindingPending(t,e,n);return e},checkListBindingPending:async function(t,e,n){let i=false;if(e&&this.updateBindingDonePromises.has(e)){await this.updateBindingDonePromises.get(e)}if(e&&!e.isSuspended()){try{const t=await e.requestContexts(0,n);i=t.length===0}catch(t){if(t&&t?.canceled){return i}throw t}}return i},getTypeMap:function(t){return p},retrieveContent:async function(t,e,n){const i=t.getPayload();return r.showValueList(i,e,n)},_getConditionPayloadList:function(t){const e=t.payload||{},n=Object.keys(e),i=n.length?e[n[0]]:[];return i},_getValueListPropertyFromPayloadQualifier:function(t){const e=t.qualifiers[t.valueHelpQualifier]?.vhParameters||[];const n=t.qualifiers[t.valueHelpQualifier]?.vhKeys||[];const i=t.valueHelpKeyPath;let a=[...n];const o=[];if(e.length>0){e.forEach(function(t){o.push(t.helpPath)});a=n.filter(t=>!o.includes(t))}return i&&a.includes(i)?i:""},_onConditionPropagationToFilterBar:async function(e,n,i,a,o){try{const t=await h.retrieveExternalState(o);const r=t.items;const l=s.getFilterPropertyInfo(i);const c=i.getModel()?.getMetaModel();for(const e of n){const n=this._findFilterBarPropertyByAnnotationPath(e,a.propertyPath,c,l);if(n&&r?.find(t=>t.name===n.name)){const e=n.conditionPath;t.filter[e]?.forEach(t=>{t.filtered=false})}}for(const i of e){const e=this._getConditionPayloadList(i);for(const i of n){const n=this._findFilterBarPropertyByAnnotationPath(i,a.propertyPath,c,l);if(n&&r?.find(t=>t.name===n.name)){for(const a of e){const e=d.createCondition("EQ",[a[i.helpPath]],null,null,f.Validated);const o=n.conditionPath;const s=t.filter[o]?.find(t=>{delete t.filtered;if(this.checkConditionsEqual(t,e)){return true}t.filtered=false;return false});if(!s){t.filter[o]||=[];t.filter[o].push(e)}}}}}h.applyExternalState(i,t)}catch(e){const n=e instanceof Error?e.message:String(e);t.error(`ValueHelpDelegate: ${n}`)}},_findFilterBarPropertyByAnnotationPath:function(t,e,n,i){const a=`/${e.split("/")[1]}`;const o=t.source.split("conditions/").pop()||"";const s=e.lastIndexOf("/");const r=s>0?`${e.substring(0,s)}/${o}`:o;const l=n?.getReducedPath(r,a);return i.find(t=>t.annotationPath===l)},_onConditionPropagationToBindingContext:function(e,n,i,a){const o=i.getModel().getMetaModel();for(const s of e){const e=this._getConditionPayloadList(s),r=e.length===1?e[0]:undefined;if(e.length>1){t.warning("ValueHelpDelegate: ParameterOut in multi-value-field not supported")}if(r){this._onConditionPropagationUpdateProperty(o,r,n,i,a)}}},_onConditionPropagationUpdateProperty:function(t,e,i,a,o){const s=V(t);const r=t.getMetaContext(a.getPath()).getPath();const l=a.isTransient()!==true&&!a.isInactive();const c=[];for(const t of i){this._updatePropertyViaOutParameter(s,r,e,t,a,l);c.push(t.source)}const u=n.getTargetView(o);const d=u.getController().collaborativeDraft;if(d.isConnected()&&c.length>0){let t;if(a.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")){t=a.getBinding()}else{t=u.getBindingContext().getBinding()}t.attachEventOnce("patchCompleted",()=>{d.send({action:F.Change,content:c.map(t=>a.getPath()+"/"+t)})})}},_updatePropertyViaOutParameter:function(t,e,n,i,a,o){const s=`${e}/${i.source}`;const r=t.resolvePath(s).target;const l=r?.annotations?.Common?.FieldControl;const c=v(l)?a.getProperty(l.path)===1:false;if(c&&o){const t=i.source.lastIndexOf("/");const e=t>0?i.source.substring(0,t):i.source;a.requestSideEffects([e])}else{const t=a.getProperty(i.source);const e=n[i.helpPath];if(t!==e){a.setProperty(i.source,null);a.setProperty(i.source,n[i.helpPath])}}const u=v(r?.annotations?.Common?.Text)?r?.annotations?.Common?.Text.path:undefined;if(u!==undefined&&o){const t=u.lastIndexOf("/");const e=t>0?u.substring(0,t):u;a.requestSideEffects([e])}},getFilterConditions:function(t,e,n){if(this.getInitialFilterConditions){return this.getInitialFilterConditions(t,e,n&&n.control||e&&e.getControl())}return{}},onConditionPropagation:async function(t,e,n){const i=t.getPayload();if(e!=="ControlChange"||i.isDefineConditionValueHelp){return}const a=i.qualifiers[i.valueHelpQualifier];const o=a?.vhParameters!==undefined?r.getOutParameters(a.vhParameters):[],s=t.getControl(),l=s.getParent();let c=s.getConditions();if(!i.isValueListWithFixedValues){this._setHistoryData(i,c,s)}c=c.filter(function(t){const e=t.payload||{};return e[i.valueHelpQualifier]});const u=s.getParent();if(u.isA(_)&&o.length&&c.length){await this._onConditionPropagationToFilterBar(c,o,l,i,u)}else{const e=s.getBindingContext();if(e){const n=s.getModel().getMetaModel();const a=n?.getObject(`${i.propertyPath}@sapui.name`);const r=c.length>0?c[0]:{};const l=r?.payload?Object.keys(r.payload):[];l.forEach(t=>{const n=r.payload;const i=n?.[t]?.[0]||{};const o=Object.keys(i);const s=o.find(t=>t.includes("@$ui5.fe.@Common/ExternalID"));if(s){const t=i[s];e.setProperty(a,t)}});this._onConditionPropagationToBindingContext(c,o,e,t)}}},_createInitialFilterCondition:function(e,n){let i;if(e===undefined){t.error("ValueHelpDelegate: value of the property could not be requested")}else if((e===""||e===null)&&n){i=d.createCondition("Empty",[],null,null,f.Validated)}else if(e!==undefined&&e!==""&&e!==null){i=d.createCondition("EQ",[e],null,null,f.Validated)}return i},_getInitialFilterConditionsFromBinding:async function(e,n,i,a){const o=n.getBindingContext();if(!o){t.error("ValueHelpDelegate: No BindingContext");return e}const s=n.getModel()?.getMetaModel();const r=s.getMetaPath(o.getPath());let l=i.map(t=>t.source);let u=false;const d=a.propertyPath.split("/").pop();let f;let g;if(o.getBinding().getPath()!=="$Parameter"){f=a.propertyPath.replace(`/${d}`,"");g=s.getObject(f)}if(n.isA("sap.ui.mdc.MultiValueField")&&g&&g.$Partner===undefined){t.error(`ValueHelpDelegate: Because of missing partner definition, the filter value for ValueListParameterIn property can not requested.`);u=true}else if(g&&g.$kind==="NavigationProperty"&&g.$Partner!==undefined){l=this._buildPropertiesToRequest(l,r,s,a.propertyPath)}if(!u){const t=o.isTransient()===true&&!o.isInactive()&&o.getUpdateGroupId()?.startsWith("$auto");let n=[];n=(o.getMessages()??[]).filter(t=>t.getType()===c.Error);if(t&&!n?.length){await(o?.created())}const a=await o.requestProperty(l);for(let t=0;t<i.length;t++){const n=i[t];const o=this._createInitialFilterCondition(a[t],n.initialValueIsSignificant);if(o){e[n.helpPath]=[o]}}}return e},_buildPropertiesToRequest:function(t,e,n,i){let a=n.createBindingContext(e);const o=i.slice(e.length).split("/").slice(1,-1).map(t=>{a=n.createBindingContext(t,a);return{part:t,partner:a.getObject().$Partner}});return t.map(t=>{const e=t.split("/");const n=e.findIndex((t,e)=>o[-e]?.partner!==t);return o.slice(0,-n).map(t=>t.part).concat(e.slice(n)).join("/")})},_getInitialFilterConditionsFromFilterBar:async function(t,e,n,i){const a=e.getParent();const o=s.getFilterPropertyInfo(a);const r=await h.retrieveExternalState(a);const l=a.getModel().getMetaModel();for(const e of n){const n=this._findFilterBarPropertyByAnnotationPath(e,i.propertyPath,l,o);const a=n?n.conditionPath:e.source.split("conditions/").pop();const s=this._getConditionsFromInParameter(a,r);if(s){t[e.helpPath]=s}}return t},_getConditionsFromInParameter:function(t,e){const n=Object.keys(e.filter).find(e=>e===t);return n&&e.filter[n]},_partitionInParameters:function(t){const e={constant:[],binding:[],filter:[]};for(const n of t){if(n.constantValue!==undefined){e.constant.push(n)}else if(n.source.indexOf("$filter")===0){e.filter.push(n)}else{e.binding.push(n)}}return e},_tableAfterRenderDelegate:{onAfterRendering:function(t){const e=t.srcControl,n=e.$().find("tbody .sapMText"),i=e.getParent();l(n,i.getFilterValue(),true)}},getInitialFilterConditions:async function(e,n,i){if(n?.isA("sap.ui.mdc.valuehelp.content.MTable")){const t=n.getTable();t?.removeEventDelegate(this._tableAfterRenderDelegate);t?.addEventDelegate(this._tableAfterRenderDelegate,this)}const a=e.getPayload();const o={};if(!i){t.error("ValueHelpDelegate: Control undefined");return o}const s=a.qualifiers[a.valueHelpQualifier];const l=s?.vhParameters!==undefined?r.getInParameters(s.vhParameters):[];const c=this._partitionInParameters(l);const u=i.getBindingContext();for(const t of c.constant){const e=this._createInitialFilterCondition(t.constantValue,u?t.initialValueIsSignificant:false);if(e){o[t.helpPath]=[e]}}if(c.binding.length){await this._getInitialFilterConditionsFromBinding(o,i,c.binding,a)}if(c.filter.length){await this._getInitialFilterConditionsFromFilterBar(o,i,c.filter,a)}return o},createConditionPayload:function(t,e,n,i){const a=t.getPayload();const o=a.qualifiers[a.valueHelpQualifier],s={},r={};const l=e.getControl();const c=l?.isA("sap.ui.mdc.MultiValueField");if(a.externalIdPath&&a.valueHelpKeyPath){const t=a.valueHelpKeyPath;const e=o.vhKeys&&i.getObject(o.vhKeys[0]||t);s[a.propertyPath+"@$ui5.fe.@Common/ExternalID"]=e;r[a.valueHelpQualifier]=[s]}else if(!o.vhProperties||c){return undefined}o.vhProperties?.forEach(function(t){const e=i.getObject(t);if(e!=null){s[t]=e?.length===0?"":e}else{s[t]=null}});if(Object.keys(s).length){r[a.valueHelpQualifier]=[s]}return r},modifySelectionBehaviour:function(t,e,n){const i=n.conditions;const a=e.getConditions();if(e?.getParent()?.isQuickSelectActive?.()&&!i.length&&a.length){n.conditions=a}return n},findConditionsForContext:function(t,e,n,i){const a=t.getPayload();i=i.filter(t=>t.validated===f.Validated);const o=a.qualifiers[a.valueHelpQualifier]?.vhKeys||[];const s=e.getKeyPath();const r=a.valueHelpQualifier||"";const l=(t,e)=>{const i=t?.[r]?.[0]||{};if(o.length===1||a?.useMultiValueField||!t){return n?.getObject(s)===e}else{const t=Object.keys(n.getObject());return o.every(function(e){return!t.includes(e)||n?.getObject(e)===i[e]})}};const c=i.find(function(t){const e=t.payload;if(n?.getObject(s)===e?.[r]?.[0]?.[s]){return l(e,e?.[r]?.[0]?.[s])}else if(n?.getObject(s)===t?.values[0]){return l(e,t?.values[0])}});return c?[c]:[]},_updateBindingWithTransientContexts:async function(e,n,i,a,o,s,r,l){try{await this._updateBindingAttributes(n,i,r);const{recommendationValuesContextData:c,recentValuesContextData:u,othersValuesContextData:d}=await this._getRelevantAdditionalValueContextData(a,n,i,e,o,s,r,l);if(c.length===0&&u.length===0){n.sort()}if(e?.history?.enabled){e.history.hasRelevantData=u.length!==0}try{await n.resetChanges()}catch(e){t.debug(`Error while clearing the list binding: ${e}`)}P.createTransientContextsForAdditionalValueContextData(c,u,d,n)}catch(t){}},_updateBindingAttributes:async function(t,e,n){const i=t.getRootBinding()||t;if(!i.isSuspended()){i.suspend()}P.sortAndFilterListBinding(t,n);if(e.parameters){t.changeParameters(e.parameters)}await P.resumeValueListBindingAndResetChanges(t)},_getRelevantAdditionalValueContextData:async function(t,e,n,i,a,o,s,r){let{recommendationValuesContextData:l,othersValuesContextData:c}=await P.requestForAdditionalValueContextData(t,e,n,i,s,r);const u=i.qualifiers[i.valueHelpQualifier].vhKeys||[];l=P.getRelevantRecommendationValuesContextData(l,t[0]?.values,a);let d=[];if(!i.isValueListWithFixedValues){d=await this._getHistoryData(i,o);d=P.getRelevantRecentValuesContextData(c,d,u,n.parameters.$search?.replaceAll('"',""),n)}c=P.getRelevantOthersValuesContextData(l,d,c,u);return{recommendationValuesContextData:l,recentValuesContextData:d,othersValuesContextData:c}},_updateBinding:function(t,e){const n=t.getRootBinding()||t;if(!n.isSuspended()){n.suspend()}if(e.parameters){t.changeParameters(e.parameters)}t.filter(e.filters,y.Application);t.sort(e.sorter);if(n.isSuspended()){n.resume();n.resetChanges()}},_checkIfAdditionalValuesExists:async function(t,e){let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;if(e.isDefineConditionValueHelp){return false}const i=n?this.getRelevantRecommendations(t,e):[];if(i?.length>0){return true}if(e.history?.enabled){if(e.history.hasRelevantData!==undefined){return e.history.hasRelevantData}const n=await this._getHistoryData(e,t.getControl());if(n.length){return true}}return false},getRelevantRecommendations(t,e){let n=[];const i=t.getControl().isA("sap.ui.mdc.FilterField")||t.getControl().isA("sap.ui.mdc.MultiValueField");if(!i){const i=t.getModel();const a=i.getLocalAnnotationModel&&i.getLocalAnnotationModel();if(a){const e=t.getControl().getBindingContext()?.getPath();const i=t.getControl().getBinding("value")?.getPath();n=a.getObject(`${e}/${i}@$ui5.fe.recommendations.typeAheadValues`)??[]}if(!n.length){const i=t.getModel("internal").getProperty("/recommendationsData")||{};const a=t.getBindingContext();n=P.getRelevantRecommendations(i,a,e.propertyPath,t.getControl().getBinding("value")?.getPath())||[]}}return n},typeAheadForFilterableContent:async function(t,e){let n=true;const i=e?.getContent()[0];const a=t?.getFilterValue();const o=i.getControl();const s=t.getPayload();if(o.isA("sap.ui.mdc.FilterField")||o.isA("sap.ui.mdc.MultiValueField")){if(!a){n=await this._checkIfAdditionalValuesExists(i,s,false)}}else{const t=o.getValue();const e=o.getAdditionalValue();if(t||e){const e=o.getModel().getMetaModel().getObject(`${s.propertyPath}${D}`)??false;if(o.hasPendingUserInput()||this._isEmptyDigitSequence(t,e)){n=a!==""||await this._checkIfAdditionalValuesExists(i,s)}else{n=await this._checkIfAdditionalValuesExists(i,s,false)}}else if(!a){n=await this._checkIfAdditionalValuesExists(i,s)}}return n},conditionForRequestShowContainer:async function(e,n){try{const t=e.getControl();if(t&&t?.isA("sap.ui.mdc.FilterField")){const e=t.getContent()?.getId();const n=e?e.includes("VisualFilter"):false;if(n){return false}}const i=n?.getContent()[0];let a;const o=function(t){a=t?.getParent();if(a&&a.isA("sap.m.Dialog")){return a}else if(a===undefined||a===null){return undefined}return o(a)};a=o(n);if(a&&a.data("fe_InitialTypeAheadFocusDone")===null&&n.getControl().getDomRef()?.getElementsByTagName("input")[0].id===a.getInitialFocus()){a.data("fe_InitialTypeAheadFocusDone",true);return false}else{const t=e.getPayload();t.history=t.history||{};t.history.hasRelevantData=undefined;t.history.enabled=t.history.enabled??r.checkHistoryEnabled(e,t);return await this._checkIfAdditionalValuesExists(i,t)}}catch(e){t.error(e)}},requestShowContainer:async function(t,e,n){if([g.Tab,g.Tap].includes(n)){return this.conditionForRequestShowContainer(t,e)}else if([g.Typing,g.Filter].includes(n)){return this.typeAheadForFilterableContent(t,e)}return g.ValueHelpRequest===n}})},false);
//# sourceMappingURL=ValueHelpDelegate.js.map