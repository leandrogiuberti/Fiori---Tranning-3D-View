/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/base/HookSupport","sap/fe/controls/inlineEdit/InlineEditIndicator","sap/fe/core/controls/CommandExecution","sap/ui/core/Popup","sap/ui/dom/findTabbable"],function(t,i,e,n,o){"use strict";var s,d;var l={};var r=t.controllerExtensionHandler;function a(t,i,e,n,o){var s={};return Object.keys(n).forEach(function(t){s[t]=n[t]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=e.slice().reverse().reduce(function(e,n){return n(t,i,e)||e},s),o&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(o):void 0,s.initializer=void 0),void 0===s.initializer?(Object.defineProperty(t,i,s),null):s}var c=function(t){t["Add"]="Add";t["Remove"]="Remove";return t}(c||{});let u=(s=r("inlineEditFlow","inlineEditStart"),d=function(){function t(){this.inlineEditState="Closed";this._isInlineEditSource=false}l=t;var s=t.prototype;s.setupMixin=function t(o){const s=o.prototype.onBeforeRendering;const d=o.prototype.onMetadataAvailable;const l=o.prototype.destroy;o.prototype.onBeforeRendering=function(){s?.call(this);if(this.inlineEditEnabled){this.addAriaAttributes()}};o.prototype.onMetadataAvailable=function(){d?.call(this);if(this.inlineEditEnabled){const t=this.getPageController()?.inlineEditFlow.isPropertyConsideredForInlineEdit(this.getInlineEditPropertyName()??"");if(!t){this.unbindProperty("hasInlineEdit");this.hasInlineEdit=undefined;return}this._inlineEditIndicator=new i({visible:true,pressEdit:this.triggerInlineEdit.bind(this)});this._inlineEditFieldGroupId="InlineEdit";this._inlineEditIndicator.attachEvent("mouseout",t=>{this.closeInlineEditPopupMouseEvent(t.getParameter("relatedTarget"))});this._inlineEditIndicator.editButton.attachBrowserEvent("blur",t=>{if(!this.getDomRef()?.contains(t.relatedTarget)){this.closeInlineEditPopupNoEditMode()}});this._inlineEditIndicator.attachEvent("pressTab",()=>{this.pressTabKey()});this._inlineEditIndicator.attachEvent("pressShiftTab",()=>{this.pressShiftAndTabKey(this.getContent().getContentEdit()[0])});this._inlineEditIndicatorPopup=new n(this._inlineEditIndicator,false,false,false);const o=this.triggerInlineEditSave.bind(this);const s=this.triggerInlineEditDiscard.bind(this);this._inlineEditIndicator.addDependent(new e({execute:o,enabled:true,visible:true,command:"Save"}));this._inlineEditIndicator.addDependent(new e({execute:s,enabled:true,visible:true,command:"Cancel"}));this._inlineEditIndicatorPopup.setFollowOf(()=>{this.popupBehaviour()});this.attachBrowserEvent("dblclick",this.triggerInlineEdit.bind(this));this.attachBrowserEvent("mouseover",this.openInlineEditPopup.bind(this));this.attachBrowserEvent("mouseout",t=>{this.closeInlineEditPopupMouseEvent(t.relatedTarget)});this.attachBrowserEvent("focus",t=>{this.focusEvent(t,this.getContent().contentDisplay?.getDomRef())});this.attachBrowserEvent("keydown",t=>{this.keydownEvent(t,this.getContent().contentDisplay?.getDomRef())});this.attachEvent("validateFieldGroup",t=>{const i=t.getParameter("fieldGroupIds");i?.forEach(t=>{if(t==="InlineEdit"){this.getPageController()?.inlineEditFlow.delayedCallToSave()}})});this.attachBrowserEvent("focusin",t=>{if(this.inlineEditState==="Editable"&&!this._inlineEditIndicatorPopup.isOpen()){this.openInlineEditPopupForFocus(t);this.setInlineEditFocus()}})}};o.prototype.onDestroy=function(){this._inlineEditIndicator?.destroy();this._inlineEditIndicatorPopup?.destroy();l?.call(this)}};s.addAriaAttributes=function t(){if(this._inlineEditIndicator){this._inlineEditIndicator.removeAllEditButtonAriaDescribedBy();this.getLabelControls().forEach(t=>{this._inlineEditIndicator?.addEditButtonAriaDescribedBy(t)});this._inlineEditIndicator.addEditButtonAriaDescribedBy(this.getIdForLabel())}};s.getDomRefOfField=function t(){const i=this.getContent();if(i?.contentEdit?.length>0&&i?.contentEdit[0]?.getDomRef()){return i.contentEdit[0].getDomRef()}else if(i?.contentDisplay&&i.contentDisplay.getDomRef()){return i.contentDisplay.getDomRef()}else if(i?.isA("sap.fe.macros.controls.FileWrapper")){return i.fileUploader.getDomRef()}return null};s.popupBehaviour=function t(){const i=this.getDomRefOfField();if(i){const t=this.getOverlappingElement(i);if(t!==i&&!i.contains(t)){this._inlineEditIndicatorPopup?.close();if(this.inlineEditState==="Editable"){const t=setInterval(()=>{this.popupIntervallHandler(i,t)},200)}}else{this._inlineEditIndicatorPopup?.setPosition(n.Dock.EndTop,n.Dock.EndBottom,this._source,"0 -4")}}};s.getOverlappingElement=function t(i){return document.elementFromPoint(i.getBoundingClientRect().x+i.getBoundingClientRect().width/2,i.getBoundingClientRect().y+.66*i.getBoundingClientRect().height)};s.popupIntervallHandler=function t(i,e){const o=this.getOverlappingElement(i);if(o===i||i.contains(o)){this._inlineEditIndicatorPopup?.open(0,n.Dock.EndTop,n.Dock.EndBottom,this);clearInterval(e)}};s.focusHandlingInlineEdit=function t(i,e){const n=o(this.getDomRef(),{skipChild:true,forward:e});n?.element.focus();this._inlineEditIndicatorPopup?.close();if(i){if(this._isInlineEditSource){this.triggerInlineEditSave()}}};s.focusMeasureField=function t(){const i=o(this.getDomRef(),{skipChild:false,forward:true});const e=o(i.element,{skipChild:true,forward:true});e?.element?.focus()};s.focusHandlingMeasureField=function t(i){const e=o(document.activeElement,{skipChild:true,forward:i});if(this.getDomRef()?.contains(e.element)){e.element?.focus()}else if(i){this._inlineEditIndicator?.getSaveButton().focus()}else{e.element?.focus()}};s.inlineEditKeydown=function t(i,e){if(i.key==="Escape"){i.preventDefault();this.triggerInlineEditDiscard()}else if(i.key==="Tab"&&!i.shiftKey){i.preventDefault();this.pressTabKeyOnField(e,i)}else if(i.key==="Tab"&&i.shiftKey){i.preventDefault();this.pressShiftTabKeyOnField(e)}};s.pressTabKey=function t(){if(this._inlineEditIndicator){switch(document.activeElement){case document.getElementById(this._inlineEditIndicator?.getEditButton().getId()):this.focusHandlingInlineEdit(false,true);break;case document.getElementById(this._inlineEditIndicator?.getSaveButton().getId()):this._inlineEditIndicator?.getDiscardButton().focus();break;case document.getElementById(this._inlineEditIndicator?.getDiscardButton().getId()):this.focusHandlingInlineEdit(true,true);break;default:}}};s.pressShiftAndTabKey=function t(i){if(this._inlineEditIndicator){switch(document.activeElement){case document.getElementById(this._inlineEditIndicator?.getEditButton().getId()):this.focusHandlingInlineEdit(false,false);break;case document.getElementById(this._inlineEditIndicator?.getSaveButton().getId()):if(this.checkForMeasureField()){this.focusMeasureField()}else{i.focus()}break;case document.getElementById(this._inlineEditIndicator?.getDiscardButton().getId()):this._inlineEditIndicator?.getSaveButton().focus();break;default:}}};s.pressTabKeyOnField=function t(i,e){if(document.activeElement===i){this.openInlineEditPopup(e);this._inlineEditIndicator?.getEditButton().focus()}else if(!this.checkForMeasureField()){this._inlineEditIndicator?.getSaveButton().focus()}else{this.focusHandlingMeasureField(true)}};s.pressShiftTabKeyOnField=function t(i){if(document.activeElement===i){this.focusHandlingInlineEdit(true,false)}else if(!this.checkForMeasureField()){this.focusHandlingInlineEdit(true,false)}else{this.focusHandlingMeasureField(false)}};s.focusEvent=function t(i,e){if(this.hasInlineEdit){i.preventDefault();if(this.checkForSemanticObject()){e.focus()}else{this.openInlineEditPopup(i);this._inlineEditIndicator?.getEditButton().focus()}}};s.keydownEvent=function t(i,e){if((this.inlineEditState==="Editable"||document.activeElement===e&&this.checkForSemanticObject())&&this.hasInlineEdit){this.inlineEditKeydown(i,e)}};s.toggleInlineEditFieldGroupId=function t(i){const e=i===c.Add;const n=new Set(this.getFieldGroupIds());if(e){n.add("InlineEdit")}else{n.delete("InlineEdit")}this.setFieldGroupIds(Array.from(n));const o=this.content?.findAggregatedObjects(true,t=>t.isA("sap.ui.core.Control"))??[];for(const t of o){const i=new Set(t.getFieldGroupIds());if(e){i.add("InlineEdit")}else{i.delete("InlineEdit")}t.setFieldGroupIds(Array.from(i))}};s.openInlineEditPopup=function t(i){if(this.hasInlineEdit&&this.inlineEditState!=="Editable"&&this.editMode==="Display"&&!this.readOnly){this._inlineEditIndicatorPopup?.open(0,n.Dock.EndTop,n.Dock.EndBottom,i.currentTarget);this._source=i.currentTarget;this._inlineEditIndicator?.setWidth(i.currentTarget?.getBoundingClientRect().width)}};s.closeInlineEditPopupMouseEvent=function t(i){if(i&&!this._inlineEditIndicator?.getDomRef()?.contains(i)&&!this.getDomRef()?.contains(i)){this.closeInlineEditPopupNoEditMode()}};s.checkForMeasureField=function t(){const i=this.getInlineEditProperty();return!!i?.annotations.Measures};s.checkForSemanticObject=function t(){const i=this.getInlineEditProperty();return!!i?.annotations.Common?.SemanticObject};s.closeInlineEditPopupNoEditMode=function t(){if(!this._inlineEditIndicator?.getEditMode()){this._inlineEditIndicatorPopup?.close()}};s.closeInlineEditPopupEditMode=function t(){if(this._inlineEditIndicator?.getEditMode()){this._inlineEditIndicatorPopup?.close();this._isInlineEditSource=false}};s.openInlineEditPopupForFocus=function t(i){this._inlineEditIndicator?.setEditMode(true);this._inlineEditIndicatorPopup?.open(0,n.Dock.EndTop,n.Dock.EndBottom,i.currentTarget||this._source,"0 -4");this._isInlineEditSource=true};s.setInlineEditFocus=function t(){this.getPageController()?.inlineEditFlow.focusHandling(this)};s.triggerInlineEdit=function t(){if(!this.inlineEditEnabled||this.editMode!=="Display"||this.readOnly||!this.hasInlineEdit){return}this._isInlineEditSource=true;this._inlineEditIndicator?.setEditMode(true);this._inlineEditIndicatorPopup?.setPosition(n.Dock.EndTop,n.Dock.EndBottom,this._source,"0 -4");const i=this.getBindingContext()?.getCanonicalPath()??"";const e=this.getInlineEditPropertyName();if(e){this.getPageController()?.inlineEditFlow.startInlineEdit(e,i,this)}};s.triggerInlineEditDiscard=async function t(){if(this.hasPendingUserInput()){await new Promise(t=>{setTimeout(t,200)})}this.getPageController()?.inlineEditFlow.inlineEditDiscard()};s.triggerInlineEditSave=async function t(){if(this.hasPendingUserInput()){await new Promise(t=>{setTimeout(t,200)})}return this.getPageController()?.inlineEditFlow.inlineEditSave()};s.inlineEditStart=function t(i,e,n){if(this.hasInlineEdit){const t=this.getBindingContext()?.getCanonicalPath()??"";const o=this.getInlineEditPropertyName()??"";if(!e.includes(o)||n!==t){return}this.toggleInlineEditFieldGroupId(c.Add);const s=this.getModel("ui");const d=`/${this.getId()}`;s.setProperty(d,{isEditable:true});this.bindElement({path:d,model:"ui"});if(this._isInlineEditSource){setTimeout(()=>{this.getContent()?.getContentEdit()[0]?.focus();this.invalidate()},200)}if(e.includes(o)){this.inlineEditState="Editable"}if(!i.includes(this)){i.push(this)}}};s.resetIndicatorPopup=function t(){this._inlineEditIndicatorPopup?.close();this._inlineEditIndicator?.setEditMode(false);this._isInlineEditSource=false};s.inlineEditEnd=function t(i){if(this.inlineEditState==="Editable"){if(i){this.refreshDescriptionIfNeeded()}this.toggleInlineEditFieldGroupId(c.Remove);this.unbindElement("ui");this.inlineEditState="Closed";this.resetIndicatorPopup()}};s.refreshDescriptionIfNeeded=function t(){if(this.isA("sap.fe.macros.Field")){const t=this.content?.isA("sap.fe.macros.controls.FieldWrapper")?this.content.getContentEdit()[0]:null;if(t&&t.isA("sap.ui.mdc.Field")){const i=t.getBinding("additionalValue")?.getPath();if(i){this.getBindingContext()?.requestSideEffects([i],"$auto")}}}};return t}(),a(d.prototype,"inlineEditStart",[s],Object.getOwnPropertyDescriptor(d.prototype,"inlineEditStart"),d.prototype),d);l=u;return l},false);
//# sourceMappingURL=InlineEdit.js.map