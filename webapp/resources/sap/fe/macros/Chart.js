/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/base/ClassSupport","sap/fe/base/HookSupport","sap/fe/core/CommonUtils","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/StableIdHelper","sap/fe/macros/chart/Action","sap/fe/macros/chart/ChartRuntime","sap/fe/macros/chart/ChartUtils","sap/fe/macros/filter/FilterUtils","sap/fe/navigation/PresentationVariant","sap/ui/core/library","sap/ui/mdc/p13n/StateUtil","sap/ui/model/Filter","./MacroAPI","./chart/MdcChartTemplate","./chart/adapter/ChartPvToStateUtils","./insights/AnalyticalInsightsHelper","./insights/CommonInsightsHelper","./insights/InsightsService","./mdc/adapter/StateHelper"],function(t,e,n,r,a,i,o,s,l,c,u,p,g,h,f,d,y,C,b,m,v,S){"use strict";var P,w,_,A,I,V,M,D,x,z,T,E,O,j,U,k,R,H,F,K,N,B,L,$,q,W,G,J,Q,X,Y,Z,tt,et,nt,rt,at,it,ot,st,lt,ct,ut,pt,gt,ht,ft,dt,yt,Ct;function bt(t){return new Promise((e,n)=>{sap.ui.require([t],n=>{if(!(n&&n.__esModule)){n=n===null||!(typeof n==="object"&&t.endsWith("/library"))?{default:n}:n;Object.defineProperty(n,"__esModule",{value:true})}e(n)},t=>{n(t)})})}var mt={};var vt=v.showInsightsCardPreview;var St=v.showCollaborationManagerCardPreview;var Pt=v.getCardManifest;var wt=m.showGenericErrorMessage;var _t=m.hasInsightActionEnabled;var At=b.createChartCardParams;var It=y.getMdcChartTemplate;var Vt=g.TitleLevel;var Mt=o.generate;var Dt=i.getInvolvedDataModelObjects;var xt=r.controllerExtensionHandler;var zt=n.xmlEventHandler;var Tt=n.property;var Et=n.implementInterface;var Ot=n.event;var jt=n.defineUI5Class;var Ut=n.association;var kt=n.aggregation;function Rt(t,e,n,r){n&&Object.defineProperty(t,e,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(r):void 0})}function Ht(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,Ft(t,e)}function Ft(t,e){return Ft=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Ft(t,e)}function Kt(t,e,n,r,a){var i={};return Object.keys(r).forEach(function(t){i[t]=r[t]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=n.slice().reverse().reduce(function(n,r){return r(t,e,n)||n},i),a&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(a):void 0,i.initializer=void 0),void 0===i.initializer?(Object.defineProperty(t,e,i),null):i}function Nt(t,e){throw Error("Decorating class property failed. Please ensure that transform-class-properties is enabled and runs after the decorators transform.")}let Bt=(P=jt("sap.fe.macros.Chart",{returnTypes:["sap.fe.macros.MacroAPI"]}),w=Et("sap.fe.core.controllerextensions.viewState.IViewStateContributor"),_=Et("sap.fe.macros.controls.section.ISingleSectionContributor"),A=Tt({type:"string"}),I=Tt({type:"string",required:true,expectedTypes:["EntitySet","EntityType","Singleton","NavigationProperty"],expectedAnnotations:["com.sap.vocabularies.UI.v1.Chart","com.sap.vocabularies.UI.v1.PresentationVariant","com.sap.vocabularies.UI.v1.SelectionPresentationVariant"]}),V=Tt({type:"string",required:true,expectedTypes:["EntitySet","EntityType","Singleton","NavigationProperty"],expectedAnnotations:[]}),M=Tt({type:"string"}),D=Tt({type:"boolean",defaultValue:true}),x=Tt({type:"string",defaultValue:"Multiple",allowedValues:["None","Single","Multiple"]}),z=Tt({type:"string",allowedValues:["Control"]}),T=Tt({type:"string",defaultValue:true}),E=Tt({type:"string"}),O=Tt({type:"object"}),j=Tt({type:"boolean"}),U=Tt({type:"string"}),k=Ut({type:"sap.ui.core.Control"}),R=kt({type:"sap.ui.core.LayoutData"}),H=kt({type:"sap.fe.macros.chart.Action",altTypes:["sap.fe.macros.chart.ActionGroup"],multiple:true,defaultClass:s}),F=Ot(),K=Ot(),N=Ot(),B=Ot(),L=Ot(),$=zt(),q=zt(),W=xt("collaborationManager","collectAvailableCards"),P(G=(J=function(n){function r(t,e){var r;if(t?._applyIdToContent){t.id=Mt([t.id,"::Chart"])}r=n.call(this,t,e)||this;Rt(r,"__implements__sap_fe_core_controllerextensions_viewState_IViewStateContributor",Q,r);Rt(r,"__implements__sap_fe_macros_controls_section_ISingleSectionContributor",X,r);Rt(r,"id",Y,r);Rt(r,"metaPath",Z,r);Rt(r,"contextPath",tt,r);Rt(r,"header",et,r);Rt(r,"headerVisible",nt,r);Rt(r,"selectionMode",rt,r);Rt(r,"variantManagement",at,r);Rt(r,"personalization",it,r);Rt(r,"headerLevel",ot,r);Rt(r,"chartDelegate",st,r);Rt(r,"_applyIdToContent",lt,r);Rt(r,"noDataText",ct,r);r.prevDrillStack=[];r.initialControlState={};r.chartActions=[];r._commandActions=[];Rt(r,"filterBar",ut,r);Rt(r,"layoutData",pt,r);Rt(r,"actions",gt,r);Rt(r,"selectionChange",ht,r);Rt(r,"internalDataRequested",ft,r);Rt(r,"variantSelected",dt,r);Rt(r,"variantSaved",yt,r);Rt(r,"segmentedButtonPressed",Ct,r);return r}mt=r;Ht(r,n);var i=r.prototype;i.getSectionContentRole=function t(){return"consumer"};i.sendDataToConsumer=function t(e){this.content?.setHeader(e.title);this.content?.setHeaderStyle("H4");this.content?.setHeaderLevel(e.titleLevel)};i.getSelectedContexts=function t(){return this.content?.getBindingContext("internal")?.getProperty("selectedContexts")||[]};i.isA=function t(e){const r="sap.fe.macros.chart.ChartAPI";if(Array.isArray(e)&&e.includes(r)||e===r)return true;return n.prototype.isA.call(this,e)};i.onMetadataAvailable=function t(){if(!this.content){this.content=this.createContent()}};i.onAfterRendering=function t(e){const r=this.getPageController()?.getView();const a=r?.getBindingContext("internal");const i=this.getContent();const o=a?.getProperty("controls/showMessageStrip")||{};const s=i.data("entitySet"),l=`${s}Chart`,c=r?.getBindingContext();o[l]=i.data("draftSupported")==="true"&&!!c&&!c.getObject("IsActiveEntity");a.setProperty("controls/showMessageStrip",o);this.attachStateChangeHandler();n.prototype.onAfterRendering.call(this,e)};i.attachStateChangeHandler=function t(){h.detachStateChange(this.stateChangeHandler);h.attachStateChange(this.stateChangeHandler)};i.stateChangeHandler=function t(e){const n=e.getParameter("control");if(n.isA("sap.ui.mdc.Chart")){const t=n.getParent();if(t?.handleStateChange){t.handleStateChange()}}};i.refreshNotApplicableFields=function t(e){const n=this.getContent();return u.getNotApplicableFilters(e,n)};i.handleSelectionChange=function t(n){const r=n.getParameter("data");const a=n.getParameter("name")==="selectData";l.fnUpdateChart(n);this.fireEvent("selectionChange",e({},{data:r,selected:a}))};i.onInternalDataRequested=function t(){this.fireEvent("internalDataRequested")};i.collectAvailableCards=async function t(e){const n=this.content.getActions();if(_t(n,this.content.getFilter())){const t=await this.getCardManifestChart();if(Object.keys(t).length>0){e.push({card:t,title:this.getChartControl().getHeader(),callback:this.onAddCardToCollaborationManagerCallback.bind(this)})}}};i.hasSelections=function e(){const n=this.content;if(n){try{const t=n.getControlDelegate()?.getInnerChart(n);if(t){const e=c.getDimensionsFromDrillStack(t);const r=e.length>this.prevDrillStack.length;const a=e.length<this.prevDrillStack.length;const i=e.toString()===this.prevDrillStack.toString();let o;if(a&&e.length===1){o=c.getChartSelections(n,true)}else{o=c.getChartSelections(n)}if(r||a){this.prevDrillStack=e;return o.length>0}else if(i){return o.length>0}}}catch(e){t.error(`Error while checking for selections in Chart: ${e}`)}}return false};i.onAddCardToInsightsPressed=async function e(){try{const t=await At(this);if(t){vt(t);return}}catch(e){wt(this.content);t.error(e)}};i.getCardManifestChart=async function t(){const e=await At(this);return Pt(e)};i.onAddCardToCollaborationManagerCallback=async function e(n){try{if(n){await St(n,this.getPageController()?.collaborationManager.getService());return}}catch(e){wt(this.content);t.error(e)}};i.getFilter=function t(){const e=c.getAllFilterInfo(this.content);if(e.filters.length){e.filters.forEach(t=>{if(t.getPath()){t.sPath=this.getChartPropertiesWithoutPrefixes(t.getPath())}});return new f({filters:e.filters,and:true})}return undefined};i.getChartControl=function t(){return this.content};i.getPropertyDataModel=function t(e){const n=this.content.data("targetCollectionPath");const r=this.content.getModel().getMetaModel();const a=r.createBindingContext(`${n}/${e}`);return Dt(a)};i.getChartPropertiesWithoutPrefixes=function t(e){if(e&&e.includes("fe_groupable")){e=this.getInternalChartNameFromPropertyNameAndKind(e,"groupable")}else if(e&&e.includes("fe_aggregatable")){e=this.getInternalChartNameFromPropertyNameAndKind(e,"aggregatable")}return e};i.getInternalChartNameFromPropertyNameAndKind=function t(e,n){return e.replace("_fe_"+n+"_","")};i._convertStateUtilToPresentationVariant=function t(e){const n=e.sorters?.map(t=>({Property:this.getChartPropertiesWithoutPrefixes(t.name),Descending:t.descending}));const r=e.supplementaryConfig?.properties?.chartType;const a=r?r.charAt(0).toUpperCase()+r.slice(1):undefined;const i="com.sap.vocabularies.UI.v1.ChartType/"+a;const o=[],s=[],l=[],c=[];(e.items??[]).forEach(t=>{t.name=this.getChartPropertiesWithoutPrefixes(t.name);const e=t.role?.length?t.role.substring(0,1).toUpperCase()+t.role?.substring(1,t.role.length):undefined;if(t.role==="category"||t.role==="series"||t.role==="category2"){o.push(t.name);l.push({Dimension:t.name,Role:`com.sap.vocabularies.UI.v1.ChartDimensionRoleType/${e}`})}else{s.push(t.name);c.push({Measure:t.name,Role:"com.sap.vocabularies.UI.v1.ChartDimensionRoleType/"+e})}});const u={Content:{ChartType:i,DimensionAttributes:l,Dimensions:o,MeasureAttributes:c,Measures:s},Type:"Chart"};const g=new p;g.setChartVisualization(u);g.setProperties({SortOrder:n??[]});return g};i.getPresentationVariant=async function e(){try{const t=await h.retrieveExternalState(this.content);return this._convertStateUtilToPresentationVariant(t)}catch(e){const n=this.getId();const r=e instanceof Error?e.message:String(e);t.error(`Chart Building Block (${n}) - get presentation variant failed : ${r}`);throw Error(r)}};i.setPresentationVariant=async function e(n){try{const t=this.content;const e=await this.getPresentationVariant();const r=await(t.getControlDelegate()?.fetchProperties(t));const a=C.convertPvToStateUtilPv(n,e,r);await h.applyExternalState(t,a)}catch(e){const n=e instanceof Error?e.message:String(e);t.error(`FE: Chart Building Block setPresentationVariant API failed with error: ${n}`);throw Error(n)}};i.getCurrentVariantKey=function t(){return this.content.getVariant().getCurrentVariantKey()};i.setCurrentVariantKey=function t(e){const n=this.content.getVariant();n.setCurrentVariantKey(e)};i.getSelectionVariant=async function t(){return S.getSelectionVariant(this.content)};i.setSelectionVariant=async function t(e){let n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;return S.setSelectionVariantToMdcControl(this.getContent(),e,n)};i.getControlState=function t(e){const n=this.initialControlState;if(e){return{fullState:e,initialState:n}}return e};i.setInitialState=async function e(){try{const t=await h.retrieveExternalState(this.content);this.initialControlState=t}catch(e){t.error(e)}};i.retrieveState=async function t(){const e={};e.innerChart=this.getControlState(await h.retrieveExternalState(this.content));const n=this.content.getVariant()?.getId();if(n){const t=this.content.getVariant();if(!e.variantManagement){e.variantManagement={variantId:t?.getCurrentVariantKey()}}else{e.variantManagement.variantId=t?.getCurrentVariantKey()}}return e};i.applyLegacyState=async function t(e,n,r){const a=this.content;const i=a.getVariant();const o=e(a);const s=i?e(i):null;const l={};if(o){l.innerChart={...l.innerChart,...o,fullState:{...l.innerChart?.fullState,...o.fullState},initialState:{...l.innerChart?.initialState,...o.initialState}}}if(s?.variantId){l.variantManagement={...l.variantManagement,variantId:s.variantId.toString()}}if(l&&Object.keys(l).length>0){await this.applyState(l,n,r)}};i.handleVariantIdPassedViaURLParams=async function t(){const e=this.getStartupParameters();const n=e?.["sap-ui-fe-chart-variant-id"]?.[0];const r=a.getTargetView(this);const i=r.getViewData();const o=i.variantManagement;const s=this.getContent()?.getVariant();if(s&&n&&o==="Control"){const t=s.getVariants().find(t=>t.getKey()===n);const e=(await bt("sap/ui/fl/apply/api/ControlVariantApplyAPI")).default;return e.activateVariant({element:s,variantReference:t?.getKey()})}};i.getStartupParameters=function t(){const e=this.getPageController();const n=e?.getAppComponent();const r=n?.getComponentData();return r?.startupParameters};i.applyNavigationParameters=async function e(n){try{if(n.applyVariantFromURLParams??false){await this.handleVariantIdPassedViaURLParams()}}catch(e){t.error(`Error trying to apply navigation parameters to ${this.getMetadata().getName()} control with ID: ${this.getId()}`,e)}return Promise.resolve()};i.applyState=async function e(n,r,a){if(!n)return;const i=n.variantManagement?.variantId;const o=this.content?.getVariant();if(i!==undefined&&i!==o.getCurrentVariantKey()){const e=this.content?.getVariant();const n=e?.getVariants();const r=n?.some(t=>t.getKey()===i)?i:e?.getStandardVariantKey;try{const t=(await bt("sap/ui/fl/apply/api/ControlVariantApplyAPI")).default;await t.activateVariant({element:e,variantReference:r});await this.setInitialState()}catch(e){t.error(e);await this.setInitialState()}}else{await this.setInitialState()}const s=n.innerChart;let l;if(s){if(a&&s.initialState){l=await h.diffState(this.content,s.initialState,s.fullState)}else{l=s.fullState}await h.applyExternalState(this.content,l)}};i.handleStateChange=function t(){this.getPageController()?.getExtensionAPI().updateAppState()};i._createContent=function t(){const e=this._getOwner();if(e?.isA("sap.fe.core.TemplateComponent")){this.content.setFilter("");this.content.destroy();this.content=this.createContent()}};i.setProperty=function t(e,r,a){if(!this._applyingSettings&&r!==undefined&&Object.keys(this.getMetadata().getProperties()).includes(e)){n.prototype.setProperty.call(this,e,r,true);this._createContent()}else{n.prototype.setProperty.call(this,e,r,a)}return this};i.removeAggregation=function t(e,r,a){let i;if(!this._applyingSettings&&r!==undefined&&Object.keys(this.getMetadata().getAggregations()).includes(e)){i=n.prototype.removeAggregation.call(this,e,r,a);this._createContent()}else{i=n.prototype.removeAggregation.call(this,e,r,a)}return i};i.addAggregation=function t(e,r,a){if(!this._applyingSettings&&Object.keys(this.getMetadata().getAggregations()).includes(e)){n.prototype.addAggregation.call(this,e,r,a);this._createContent()}else{n.prototype.addAggregation.call(this,e,r,a)}return this};i.insertAggregation=function t(e,r,a,i){if(!this._applyingSettings&&Object.keys(this.getMetadata().getAggregations()).includes(e)){n.prototype.insertAggregation.call(this,e,r,a,i);this._createContent()}else{n.prototype.insertAggregation.call(this,e,r,a,i)}return this};i.createContent=function t(){if(this.contextPath){this._resolvedContextPath=this.contextPath.endsWith("/")?this.contextPath:this.contextPath+"/"}return It(this,this._getOwner()?.getRootController()?.getView().getViewData()??this._getOwner()?.getViewData(),this.getAppComponent()?.getDiagnostics()??{},this.getDataModelObjectForMetaPath(this.metaPath,this._resolvedContextPath))};return r}(d),Q=Kt(J.prototype,"__implements__sap_fe_core_controllerextensions_viewState_IViewStateContributor",[w],{configurable:true,enumerable:true,writable:true,initializer:function(){return true}}),X=Kt(J.prototype,"__implements__sap_fe_macros_controls_section_ISingleSectionContributor",[_],{configurable:true,enumerable:true,writable:true,initializer:function(){return true}}),Y=Kt(J.prototype,"id",[A],{configurable:true,enumerable:true,writable:true,initializer:null}),Z=Kt(J.prototype,"metaPath",[I],{configurable:true,enumerable:true,writable:true,initializer:null}),tt=Kt(J.prototype,"contextPath",[V],{configurable:true,enumerable:true,writable:true,initializer:null}),et=Kt(J.prototype,"header",[M],{configurable:true,enumerable:true,writable:true,initializer:null}),nt=Kt(J.prototype,"headerVisible",[D],{configurable:true,enumerable:true,writable:true,initializer:null}),rt=Kt(J.prototype,"selectionMode",[x],{configurable:true,enumerable:true,writable:true,initializer:null}),at=Kt(J.prototype,"variantManagement",[z],{configurable:true,enumerable:true,writable:true,initializer:null}),it=Kt(J.prototype,"personalization",[T],{configurable:true,enumerable:true,writable:true,initializer:null}),ot=Kt(J.prototype,"headerLevel",[E],{configurable:true,enumerable:true,writable:true,initializer:function(){return Vt.Auto}}),st=Kt(J.prototype,"chartDelegate",[O],{configurable:true,enumerable:true,writable:true,initializer:null}),lt=Kt(J.prototype,"_applyIdToContent",[j],{configurable:true,enumerable:true,writable:true,initializer:function(){return false}}),ct=Kt(J.prototype,"noDataText",[U],{configurable:true,enumerable:true,writable:true,initializer:null}),ut=Kt(J.prototype,"filterBar",[k],{configurable:true,enumerable:true,writable:true,initializer:null}),pt=Kt(J.prototype,"layoutData",[R],{configurable:true,enumerable:true,writable:true,initializer:null}),gt=Kt(J.prototype,"actions",[H],{configurable:true,enumerable:true,writable:true,initializer:null}),ht=Kt(J.prototype,"selectionChange",[F],{configurable:true,enumerable:true,writable:true,initializer:null}),ft=Kt(J.prototype,"internalDataRequested",[K],{configurable:true,enumerable:true,writable:true,initializer:null}),dt=Kt(J.prototype,"variantSelected",[N],{configurable:true,enumerable:true,writable:true,initializer:null}),yt=Kt(J.prototype,"variantSaved",[B],{configurable:true,enumerable:true,writable:true,initializer:null}),Ct=Kt(J.prototype,"segmentedButtonPressed",[L],{configurable:true,enumerable:true,writable:true,initializer:null}),Kt(J.prototype,"handleSelectionChange",[$],Object.getOwnPropertyDescriptor(J.prototype,"handleSelectionChange"),J.prototype),Kt(J.prototype,"onInternalDataRequested",[q],Object.getOwnPropertyDescriptor(J.prototype,"onInternalDataRequested"),J.prototype),Kt(J.prototype,"collectAvailableCards",[W],Object.getOwnPropertyDescriptor(J.prototype,"collectAvailableCards"),J.prototype),J))||G);mt=Bt;return mt},false);
//# sourceMappingURL=Chart.js.map