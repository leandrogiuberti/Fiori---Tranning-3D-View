/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/i18n/Localization","sap/fe/base/BindingToolkit","sap/fe/base/ClassSupport","sap/fe/controls/easyFilter/EasyFilterBarContainer","sap/fe/core/buildingBlocks/BuildingBlock","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/PropertyHelper","sap/fe/macros/ai/EasyFilterDataFetcher","sap/fe/macros/filter/FilterUtils","sap/fe/macros/filterBar/DraftEditState","sap/fe/macros/internal/valuehelp/ValueListHelper","sap/ui/core/Element","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ui/model/odata/type/Date","sap/ui/model/odata/type/DateTimeOffset","sap/ui/model/odata/type/TimeOfDay","sap/fe/base/jsx-runtime/jsx"],function(e,t,r,n,a,i,o,s,l,c,u,p,d,f,h,g,y,m,b,v,F,P){"use strict";var w,S,V,E,T,B,C,M,x,L,O,k,_,D,I;var $={};var H=p.unresolvedResult;var A=p.resolveTokenValue;var j=p.mapValueListToCodeList;var z=p.generateSelectParameter;var Q=u.hasValueHelpWithFixedValues;var N=c.isPathFilterable;var R=l.isProperty;var U=l.isPathAnnotationExpression;var W=l.isNavigationProperty;var q=l.isEntityType;var K=l.isComplexType;var G=n.property;var J=n.implementInterface;var X=n.defineUI5Class;var Y=n.association;var Z=n.aggregation;var ee=r.isConstant;function te(e,t,r,n){r&&Object.defineProperty(e,t,{enumerable:r.enumerable,configurable:r.configurable,writable:r.writable,value:r.initializer?r.initializer.call(n):void 0})}function re(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,ne(e,t)}function ne(e,t){return ne=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},ne(e,t)}function ae(e,t,r,n,a){var i={};return Object.keys(n).forEach(function(e){i[e]=n[e]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=r.slice().reverse().reduce(function(r,n){return n(e,t,r)||r},i),a&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(a):void 0,i.initializer=void 0),void 0===i.initializer?(Object.defineProperty(e,t,i),null):i}function ie(e,t){throw Error("Decorating class property failed. Please ensure that transform-class-properties is enabled and runs after the decorators transform.")}let oe=(w=X("sap.fe.macros.EasyFilterBar"),S=J("sap.fe.core.controllerextensions.viewState.IViewStateContributor"),V=Y({type:"sap.fe.macros.filterBar.FilterBarAPI"}),E=Y({type:"sap.fe.macros.contentSwitcher.ContentSwitcher"}),T=G({type:"string"}),B=G({type:"string"}),C=Z({type:"sap.fe.controls.easyFilter.EasyFilterBarContainer"}),w(M=(x=function(r){function n(t,n){var a;a=r.call(this,t,n)||this;te(a,"__implements__sap_fe_core_controllerextensions_viewState_IViewStateContributor",L,a);te(a,"filterBar",O,a);te(a,"contentSwitcher",k,a);te(a,"contentSwitcherKey",_,a);te(a,"contextPath",D,a);te(a,"content",I,a);a.getAppComponent()?.getEnvironmentCapabilities().prepareFeature("MagicFiltering").then(()=>{a.easyFilterPath="ux/eng/fioriai/reuse/easyfilter/EasyFilter";a.content?.setEasyFilterLib(a.easyFilterPath);return}).catch(t=>{e.debug("Error while loading EasyFilter",t);return undefined});return a}$=n;re(n,r);var i=n.prototype;i.applyLegacyState=async function e(t,r,n,a){if(r?.selectionVariant){const e=r.selectionVariant.getSelectOptionsPropertyNames();this.filterBarMetadata.forEach(t=>{if(e.includes(t.name)){t.defaultValue=r.selectionVariant.getSelectOption(t.name)?.reduce((e,t)=>{if(t.Sign==="I"){if(t.Option===y.BT||t.Option===y.NB){if(t.High!==null&&t.High!==undefined){e.push({operator:t.Option,selectedValues:[t.Low,t.High]})}}else{e.push({operator:t.Option,selectedValues:[t.Low]})}}else{e.push({operator:y.NE,selectedValues:[t.Low]})}return e},[])}});this.content?.resetState(false)}return Promise.resolve(undefined)};i.applyState=function e(t,r){return undefined};i.retrieveState=function e(){return{}};i.getApplicationId=function e(){return this.getAppComponent()?.getManifestEntry("sap.app").id??"<unknownID>"};i.onMetadataAvailable=function e(){this.filterBarMetadata=this.prepareFilterBarMetadata();this.recommendedQueries=this.getAppComponent()?.getManifestEntry("sap.fe")?.macros?.easyFilter?.recommendedQueries??[];this.content=this.createContent();this.content.filterBarMetadata=this.filterBarMetadata};i.getUnitForProperty=function e(t,r){const n=t.annotations.Measures?.ISOCurrency??t.annotations.Measures?.Unit;return U(n)?`${r}/${n.path}`:undefined};i.getDefaultValueForFilterField=function e(t,r){let n;if(r.hasOwnProperty(t.name)){n=[{operator:y.EQ,selectedValues:r[t.name]}]}else if(t.isParameter&&r.hasOwnProperty(t.name.substring(2))){n=[{operator:y.EQ,selectedValues:r[t.name.substring(2)]}]}return n};i.getEditStateFilterMetadata=function e(t){const r=new m({isDraftCollaborative:s.isCollaborationDraftSupported(t)}).createBindingContext("/");const n=f.getEditStatesContext(r).getObject("/").map(e=>({value:e.id,description:e.display}));return{name:"$editState",label:this.getTranslatedText("FILTERBAR_EDITING_STATUS"),dataType:"Edm.String",filterable:true,codeList:n,type:"MenuWithSingleSelect"}};i.getTokenType=function e(t,r){if(Q(t)){return r==="SingleValue"?"MenuWithSingleSelect":"MenuWithCheckBox"}switch(t.type){case"Edm.Date":return"Calendar";case"Edm.TimeOfDay":return"Time";default:return"ValueHelp"}};i.getLabel=function e(t){const r=t.annotations.Common?.Label?.toString();const n=q(t)?t.annotations.UI?.HeaderInfo?.TypeName?.valueOf():undefined;const a=n||r;if(this.isComplexProperty(t)||W(t)){return a||this.getLabel(t.targetType)}return a};i.isScalarProperty=function e(t){return R(t)&&!K(t.targetType)};i.isComplexProperty=function e(t){return R(t)&&K(t.targetType)};i.prepareFilterBarMetadata=function e(){const r=this._getOwner();const n=r.preprocessorContext?.getDefinitionForPage();if(!n){return[]}const a=n.getFilterBarDefinition({});const i=n.getMetaPath();const o=i.getClosestEntitySet();let l=o.annotations.Capabilities?.FilterRestrictions?.FilterExpressionRestrictions??[];for(const e in o.navigationPropertyBinding){if(o.navigationPropertyBinding[e]?._type==="EntitySet"){const t=o.navigationPropertyBinding[e];const r=t.annotations.Capabilities?.FilterRestrictions?.FilterExpressionRestrictions??[];const n=[...l];l=[...l,...r.filter(e=>!n.includes(e))]}}const c=r.preprocessorContext?.models.metaModel;const u=(e,t)=>Q(e)?async()=>this.getCodeListForProperty(t):undefined;const p=a.getFilterFields().filter(e=>!e.getTarget()?.annotations?.UI?.HiddenFilter?.valueOf());const d=r.getAppComponent().getComponentData()?.startupParameters??{};const f=1;const h=[...o.entityType.entityProperties,...o.entityType.navigationProperties].map(e=>[e]);const g=[];const y=new Set;const m=e=>{const r=e.map(e=>this.getLabel(e)||`[${e.name}]`);return t.getRTL()?r.slice().reverse().join(" - "):r.join(" - ")};while(h.length>0){const e=h.shift();const t=e.filter(W).length;const r=e[e.length-1];if(r.annotations.UI?.Hidden?.valueOf()===true){continue}const n=[`/${o.name}`,...e.slice(0,-1).map(e=>e.name)].reduce((e,t)=>`${e}/${t}`);const a=`${n}/${r.name}`;if(this.isScalarProperty(r)){const t=r.annotations.Common?.Text;if(U(t)){y.add(`${n}/${t.path}`)}const i=p.find(e=>e.getTarget()===r);const o=l.find(e=>e.Property?.$target===r);const s=N(this.getDataModelObjectPath(a));const c=ee(s)?s.value:true;const f=o?.AllowedExpressions;const h=u(r,a);const b={name:a,label:m(e),dataType:r.type,required:i?.required,defaultValue:i?this.getDefaultValueForFilterField(i,d):undefined,filterable:i?c:undefined,hiddenFilter:!i,filterRestriction:i?f:undefined,codeList:h,type:this.getTokenType(r,o?.AllowedExpressions?.toString()||"MultiRangeOrSearchExpression"),unit:this.getUnitForProperty(r,n)};g.push(b)}else if(this.isComplexProperty(r)){r.targetType.properties.forEach(t=>{h.push([...e,t])});if(t<f){r.targetType.navigationProperties.forEach(t=>{h.push([...e,t])})}}else if(W(r)){if(r.isCollection&&!p.some(e=>e.annotationPath?.startsWith(a))){continue}r.targetType.entityProperties.forEach(t=>{h.push([...e,t])});if(t<f){r.targetType.navigationProperties.forEach(t=>{h.push([...e,t])})}}}if(s.isMetaPathDraftSupported(n.getMetaPath())){g.push(this.getEditStateFilterMetadata(c))}return g.filter(e=>!e.hiddenFilter||!y.has(e.name))};i.getCodeListForProperty=async function e(t){const r=await this.getValueList(t);if(!r){return[]}const n=r.valueListInfo;const a=n.$model.bindList(`/${n.CollectionPath}`,undefined,undefined,undefined,{$select:z(r)});const i=await a.requestContexts();const o=i.map(j(r));const s=this.filterBarMetadata.find(e=>e.name===t);if(s){s.codeList=o}return o};i.resolveTokenValuesForField=async function e(t,r){const n=this.filterBarMetadata.find(e=>{let{name:r}=e;return r===t});let a;if(!n){return H(r)}const i=await this.getValueList(n.name);if(i&&h.isValueListSearchable(n.name,i)){const e=await Promise.all(r.map(async e=>A(i,e)));a=e.flat()}else{a=H(r)}if(n.maxLength!==undefined){const e=a.map(e=>{if(e.operator===y.BT||e.operator===y.NB){const[t,r]=e.selectedValues;if(String(t.value).length<=n.maxLength&&String(r.value).length<=n.maxLength){return e}else{return null}}else{const t=e.selectedValues.filter(e=>String(e.value).length<=n.maxLength);if(t.length>0){return{...e,selectedValues:t}}else{return null}}}).filter(e=>e!==null);return e}return a};i.getValueList=async function e(t){const r=this.getMetaModel();const n=await h.getValueListInfo(undefined,t,undefined,r);return n[0]};i.onTokensChanged=async function e(t){const r=g.getElementById(this.filterBar);const n=r.getParent();const a=t.getParameter("tokens");const i=a.some(e=>e.key==="$editState");await n._clearFilterValuesWithOptions(r,{clearEditFilter:i});this.formateDataTypes(a);for(const e of a){if(e.key==="$editState"){for(const t of e.keySpecificSelectedValues){await d.addFilterValues(n.content,e.key,"DRAFT_EDIT_STATE",t.selectedValues)}}else{const t=this.filterBarMetadata.find(t=>t.name===e.key);for(const r of e.keySpecificSelectedValues){const{operator:e,selectedValues:a}=r;await d.addFilterValues(n.content,t.name,e,a)}}}await n.triggerSearch()};i.formateDataTypes=function e(t){const r=new b,n=new v(undefined,{V4:true}),a=new F;t.forEach(e=>{const t=this.filterBarMetadata.find(t=>t.name===e.key)?.dataType;e.keySpecificSelectedValues.forEach(e=>{let i;switch(t){case"Edm.Date":i=r;break;case"Edm.TimeOfDay":i=a;break;case"Edm.DateTimeOffset":i=n;break;default:return}e.selectedValues.forEach((t,r)=>{e.selectedValues[r]=i.parseValue(t,"object")})})})};i.showValueHelpForKey=async function e(t){const r=this.filterBarMetadata.find(e=>e.name===t);const n=g.getElementById(this.filterBar);const a=n.getParent();await a.showFilterField(r.name);return a.openValueHelpForFilterField(r.name)};i.onBeforeQueryProcessing=function e(){const t=this.getModel("ui");o.lock(t)};i.onAfterQueryProcessing=function e(){const t=this.getModel("ui");o.unlock(t)};i.onClearFilters=async function e(){const t=g.getElementById(this.filterBar);const r=t.getParent();await r._clearFilterValuesWithOptions(t);await r.triggerSearch()};i.onQueryChanged=function e(){const t=g.getElementById(this.filterBar);t.fireFiltersChanged({conditionsBased:true})};i.handleShowValueHelp=async function t(r){const n=r.getParameter("key");const a=r.getParameter("resolve");const i=r.getParameter("reject");try{const t=await this.showValueHelpForKey(n);const r=t.map(async t=>{const r=t.operator;if(t.validated==="NotValidated"){const e=r===y.BT||r===y.NB?{operator:r,selectedValues:[t.values[0],t.values[1]]}:{operator:r,selectedValues:[t.values[0]]};return this.resolveTokenValuesForField(n,[e])}else if(r!==y.BT&&r!==y.NB){const[e,n]=t.values;return Promise.resolve([{operator:r,selectedValues:[{value:e,description:n??e}]}])}else{e.warning(`Unexpected condition for field ${n}: operator ${r} with values ${t.values}.`);return Promise.resolve([])}});const i=await Promise.all(r);a(i.flat())}catch(e){i(e instanceof Error?e:new Error(String(e)))}};i.createContent=function e(){return P(a,{contextPath:this.getOwnerContextPath(),appId:this.getApplicationId(),filterBarMetadata:this.filterBarMetadata,easyFilterLib:this.easyFilterPath,showValueHelp:this.handleShowValueHelp.bind(this),dataFetcher:this.resolveTokenValuesForField.bind(this),recommendedValues:this.recommendedQueries,queryChanged:this.onQueryChanged.bind(this),tokensChanged:this.onTokensChanged.bind(this),beforeQueryProcessing:this.onBeforeQueryProcessing.bind(this),afterQueryProcessing:this.onAfterQueryProcessing.bind(this),clearFilters:this.onClearFilters.bind(this)})};return n}(i),L=ae(x.prototype,"__implements__sap_fe_core_controllerextensions_viewState_IViewStateContributor",[S],{configurable:true,enumerable:true,writable:true,initializer:null}),O=ae(x.prototype,"filterBar",[V],{configurable:true,enumerable:true,writable:true,initializer:null}),k=ae(x.prototype,"contentSwitcher",[E],{configurable:true,enumerable:true,writable:true,initializer:null}),_=ae(x.prototype,"contentSwitcherKey",[T],{configurable:true,enumerable:true,writable:true,initializer:null}),D=ae(x.prototype,"contextPath",[B],{configurable:true,enumerable:true,writable:true,initializer:null}),I=ae(x.prototype,"content",[C],{configurable:true,enumerable:true,writable:true,initializer:null}),x))||M);$=oe;return $},false);
//# sourceMappingURL=EasyFilterBar.js.map