/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/base/jsx-runtime/jsx","sap/fe/core/CommonUtils","sap/fe/core/TemplateModel","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/converters/helpers/Key","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/templating/PropertyFormatters","sap/fe/core/type/EDM","sap/fe/macros/CommonHelper","sap/fe/macros/DelegateUtil","sap/fe/macros/field/FieldHelper","sap/fe/macros/filter/FilterUtils","sap/fe/macros/internal/valuehelp/ValueHelpTemplating","sap/fe/macros/mdc/adapter/StateHelper","sap/ui/mdc/FilterBarDelegate","sap/ui/mdc/odata/v4/TypeMap","sap/ui/model/json/JSONModel"],function(e,t,n,o,i,r,a,s,l,c,f,d,u,p,g,m,h,y,P,v,C,F,x){"use strict";var M=P.getValueHelpTemplate;var b=p.getModelType;var I=u.hasValueHelp;var w=d.generate;var A=f.getResourceModel;var D=f.getLocalizedText;var S=l.isPropertyFilterable;var T=s.KeyHelper;var E=a.sortPropertyInfosByGroupLabel;var $=a.processSelectionFields;var B=r.getInvolvedDataModelObjects;const L=Object.assign({},C);L.apiVersion=2;const V="$editState",_="$search",O="FilterFieldValueHelp",H="sap_fe_FilterBarDelegate_propertyInfoMap";async function N(e,t,n){const o=new x({id:e,isDraftCollaborative:c.isCollaborationDraftSupported(t)}),i={bindingContexts:{this:o.createBindingContext("/")},models:{this:o}};return m.templateControlFragment("sap.fe.macros.filterBar.DraftEditState",i,undefined,n).finally(function(){o.destroy()})}L._templateCustomFilter=async function(e,t,n,r,a){const s=await m.getCustomDataWithModifier(e,"entityType",a);if(n.annotationPath!==undefined){const e=r.getContext(n.annotationPath),t=B(e),o=t.targetObject?.annotations.Common?.DocumentationRef?.toString();n.documentRefText=o}const l=new x({id:t}),c=new i(n,r),f={bindingContexts:{contextPath:r.createBindingContext(s),this:l.createBindingContext("/"),item:c.createBindingContext("/")},models:{contextPath:r,this:l,item:c}},d=o.getTargetView(e),u=d?d.getController():undefined,p={controller:u?u:undefined,view:d};return m.templateControlFragment("sap.fe.macros.filter.CustomFilter",f,p,a).finally(function(){l.destroy();c.destroy()})};function U(e){return y.getPropertyPathFromConditionPath(e)}L._findSelectionField=function(e,t){return e.find(function(e){return(e.conditionPath===t||e.conditionPath.replaceAll(/\*/g,"")===t)&&e.availability!=="Hidden"})};function j(e,t,n){return n?w([e,t,n]):w([e,t])}async function R(o,i){const r={idPrefix:i.sVhIdPrefix,conditionModel:"$filters",navigationPrefix:i.sNavigationPrefix?`/${i.sNavigationPrefix}`:"",filterFieldValueHelp:true,useSemanticDateRange:i.bUseSemanticDateRange,metaPath:o.bindingContexts.metaPath,contextPath:o.bindingContexts.contextPath,useMultiValueField:false,requiresValidation:false,collaborationEnabled:false,requestGroupId:undefined};const a=new x(r);const s=t({},o,{bindingContexts:{this:a.createBindingContext("/")},models:{this:r}});const l=h.valueHelpPropertyForFilterField(o.bindingContexts.metaPath);if(o.isXML){let t=n.renderAsXML(()=>M(o.bindingContexts.metaPath.getModel().createBindingContext(l),r));if(t){if(o.isXML){t=`<root>${t}</root>`}const n=(new DOMParser).parseFromString(t,"text/xml");return Promise.resolve(m.templateControlFragment(n.firstElementChild,s,{isXML:o.isXML})).then(async function(e){if(e){const t="dependents";if(Array.isArray(e)){e.forEach(function(e){if(i.oModifier){i.oModifier.insertAggregation(i.oControl,t,e,0)}else{i.oControl.insertAggregation(t,e,0,false)}})}else if(i.oModifier){return i.oModifier.insertAggregation(i.oControl,t,e,0,i.view)}else{i.oControl.insertAggregation(t,e,0,false);return}}return}).catch(function(t){e.error("Error while evaluating DelegateUtil.isValueHelpRequired",t)}).finally(function(){a.destroy()})}}else{const e=M(o.bindingContexts.metaPath.getModel().createBindingContext(l),r);if(e){const t="dependents";if(Array.isArray(e)){e.forEach(function(e){if(i.oModifier){i.oModifier.insertAggregation(i.oControl,t,e,0)}else{i.oControl.insertAggregation(t,e,0,false)}})}else if(i.oModifier){i.oModifier.insertAggregation(i.oControl,t,e,0)}else{i.oControl.insertAggregation(t,e,0,false)}}}}async function k(t,n,o){try{const e=await Promise.resolve(n.getAggregation(t,"dependents"));let i;if(e&&e.length>1){for(i=0;i<=e.length;i++){const t=e[i];if(t&&t.isA("sap.ui.mdc.FilterField")){const e=t.getPropertyKey(),n=t.getId();if(o===e&&n.indexOf("CustomFilterField")){return t}}}}}catch(t){e.error("Filter Cannot be added",t)}}async function X(e,n,o,r){const a=new x({idPrefix:n.sIdPrefix,vhIdPrefix:n.sVhIdPrefix,propertyPath:n.sPropertyName,navigationPrefix:n.sNavigationPrefix?`/${n.sNavigationPrefix}`:"",useSemanticDateRange:n.bUseSemanticDateRange,settings:n.oSettings,visualFilter:n.visualFilter,editMode:`{internal>/${o}/filterFields/${n.sPropertyName}/editMode}`,label:n.label});try{const o=n.oMetaModel;const s=new i(n.visualFilter,o);const l=t({},e,{bindingContexts:{this:a.createBindingContext("/"),visualFilter:s.createBindingContext("/")},models:{this:a,visualFilter:s,metaModel:o,converterContext:r}});return await m.templateControlFragment("sap.fe.macros.internal.filterField.FilterFieldTemplate",l,{isXML:!!e.isXML})}finally{a.destroy()}}async function W(t,n,o,i){try{const e=T.getSelectionFieldKeyFromPath(i);i=i.replace("*","");if(n&&!n.modifier){throw"FilterBar Delegate method called without modifier."}const r=await n.modifier.getProperty(t,"delegate");const a=await n.modifier.getProperty(t,"propertyInfo");if(a){const s=a.some(function(t){return t.key===e||t.name===e});if(!s){const e=r.payload.entityTypePath;const s=y.createConverterContext(t,e,o,n.appComponent);const l=s.getEntityType();const c=y.getFilterField(i,s,l);const f=y.buildProperyInfo(c,s);await K(a,n,f,t)}}}catch(n){e.warning(`${t.getId()} : ${n}`)}}async function K(e,t,n,o){let i=await m.getCustomDataWithModifier(o,"feFilterInfo",t.modifier);if(i&&i.length>0){const e=JSON.parse(i);e.push(n);i=JSON.stringify(e);i=i.replace(/\{/g,"\\{");i=i.replace(/\}/g,"\\}");const r=await m.retrieveCustomDataNode(o,"feFilterInfo",t.modifier);r[0].setAttribute("value",i);t.modifier.insertAggregation(o,"customData",r[0],0)}e.push(n);const r=y.formatPropertyInfo(e);t.modifier.setProperty(o,"propertyInfo",r)}L.addItem=async function(e,t,n){if(!n){return L._addP13nItem(t,e)}const o=n.modifier;const i=n&&n.appComponent&&n.appComponent.getModel();const r=i&&i.getMetaModel();if(!r){return Promise.resolve(null)}const a=o&&o.targets==="xmlTree";if(a){await W(e,n,r,t)}return L._addFlexItem(t,e,r,o,n.appComponent,n.view)};L.removeItem=async function(e,t,n){let o=true;const i=n.modifier;const r=i&&i.targets==="xmlTree";if(r){const o=n&&n.appComponent&&n.appComponent.getModel();const i=o&&o.getMetaModel();if(!i){return Promise.resolve(null)}const r=await n.modifier.getProperty(t,"propertyKey");await W(e,n,i,r)}if(typeof t!=="string"&&t.isA&&t.isA("sap.ui.mdc.FilterField")){if(t.data("isSlot")==="true"&&n){i.insertAggregation(e,"dependents",t);o=false}}return Promise.resolve(o)};L.addCondition=async function(e,t,n){const o=n.modifier;const i=o&&o.targets==="xmlTree";if(i){const o=n&&n.appComponent&&n.appComponent.getModel();const i=o&&o.getMetaModel();if(!i){return Promise.resolve(null)}await W(e,n,i,t)}return Promise.resolve()};L.removeCondition=async function(e,t,n){const o=n.modifier;const i=o&&o.targets==="xmlTree";if(i){const i=await m.getCustomDataWithModifier(e,"sap_fe_FilterBarDelegate_propertyInfoMap",o);if(!i){const o=n&&n.appComponent&&n.appComponent.getModel();const i=o&&o.getMetaModel();if(!i){return Promise.resolve(null)}await W(e,n,i,t)}}return Promise.resolve()};L.clearFilters=async function(e){const t=e.getParent();return v.clearFilterValues(t)};L._addP13nItem=async function(t,n){return m.fetchModel(n).then(async function(e){return L._addFlexItem(t,n,e.getMetaModel(),undefined)}).catch(function(t){e.error("Model could not be resolved",t);return null})};L.fetchPropertiesForEntity=function(e,t,n){const i=t.getObject(e);const r=n.isA("sap.ui.mdc.valuehelp.FilterBar")?true:undefined;if(!n||!i){return[]}const a=y.createConverterContext(n,e);const s=c.getEntitySetPath(e);const l=y.getConvertedFilterFields(n,e,r,t,o.getAppComponent(n));let f=[];l.forEach(function(e){const n=e.annotationPath;if(n&&!e.template){const o=a.getConvertedTypes().resolvePath(n).target;const i=g.getLocationForPropertyPath(t,n);const r=n.replace(`${i}/`,"");const s=a.getEntityType();const l=s.annotations?.UI?.SelectionFields;const c=s.annotations?.UI?.FilterFacets;if(o&&L._isFilterAdaptable(e,o,l,c)&&S(t,i,U(r),true)){f.push(e)}}else{f.push(e)}});const d=[];const u=$(f,a);const p=[];u.forEach(function(e){if(e.key){p.push(e.key)}});f=f.filter(function(e){return p.includes(e.key)});const h=o.getFilterRestrictionsByPath(s,t),P=h.FilterAllowedExpressions;u.forEach(function(e,n){const i=f[n];if(!i||!i.conditionPath){return}const r=U(i.conditionPath);e=Object.assign(e,{group:i.group,groupLabel:i.groupLabel,path:i.conditionPath,tooltip:null,removeFromAppState:false,hasValueHelp:false});if(i.annotationPath){const n=i.annotationPath;const o=t.getObject(n),r=t.getObject(`${n}@`),a=t.createBindingContext(n);const s=r["@com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]||r["@com.sap.vocabularies.UI.v1.ExcludeFromNavigationContext"]||r["@com.sap.vocabularies.Analytics.v1.Measure"];const l=g.getLocationForPropertyPath(t,i.annotationPath);const c=n.replace(`${l}/`,"");let f;let d;if(a&&S(t,l,U(c),true)){f=r["@com.sap.vocabularies.Common.v1.FilterDefaultValue"];if(f){d=f[`$${b(o.$Type)}`]}e=Object.assign(e,{tooltip:r["@com.sap.vocabularies.Common.v1.QuickInfo"]||undefined,removeFromAppState:s,hasValueHelp:I(a.getObject(),{context:a}),defaultFilterConditions:d?[{fieldPath:i.conditionPath,operator:"EQ",values:[d]}]:undefined})}}if(e){if(P[r]&&P[r].length>0){e.filterExpression=o.getSpecificAllowedExpression(P[r])}else{e.filterExpression="auto"}e=Object.assign(e,{visible:i.availability==="Default"})}u[n]=e});u.forEach(function(e){e.key=e.name;if(e.path==="$editState"){e.label=A(n).getText("FILTERBAR_EDITING_STATUS")}e.typeConfig=F.getTypeConfig(e.dataType,e.formatOptions,e.constraints);e.label=D(e.label,n)||"";if(e.isParameter){d.push(e.name)}});f=u;m.setCustomData(n,"parameters",d);return f};function q(e,t){if(e.isA("sap.fe.macros.table.TableAPI")){const n=e.getMetaPath().split("#")[0].split("/");switch(n[n.length-1]){case`@${"com.sap.vocabularies.UI.v1.SelectionPresentationVariant"}`:case`@${"com.sap.vocabularies.UI.v1.PresentationVariant"}`:return t.getObject(e.getMetaPath()).Visualizations?.find(e=>e.$AnnotationPath.includes(`@${"com.sap.vocabularies.UI.v1.LineItem"}`)).$AnnotationPath;case`@${"com.sap.vocabularies.UI.v1.LineItem"}`:const n=e.getMetaPath().split("/");return n[n.length-1]}}return undefined}L._isFilterAdaptable=function(e,t,n,o){let i;const r=n?L._isFilterInSelectionFields(n,e):false;if(o){i=o.some(function(t){const n=t.Target?.$target;return n?.Data.some(function(t){if(t.Value.path===e.key){return true}return false})})}else{i=false}return r||i||!t.annotations?.UI?.AdaptationHidden};L._isFilterInSelectionFields=function(e,t){const n=t.key?.indexOf("::")>0?t.key?.replace("::","/"):t.key;return e.some(function(e){if(e.value===n){return true}return false})};L._addFlexItem=async function(e,t,n,i,r,a){const s=i?i.getId(t):t.getId(),l=i?"":"Adaptation",f=y.getConvertedFilterFields(t,undefined,undefined,n,r,i,i?undefined:q(t.getParent(),n)),d=L._findSelectionField(f,e),u=U(e),p=!!i&&i.targets==="xmlTree";if(e===V){return N(j(s,`${l}FilterField`),n,i)}else if(e===_){return Promise.resolve(null)}else if(d?.template){return L._templateCustomFilter(t,j(s,`${l}`),d,n,i)}if(d?.type==="Slot"&&i){return k(t,i,u)}const h=g.getNavigationPath(u);let P;let v;let C;let F;let x;return Promise.resolve().then(async function(){if(d?.isParameter){const e=d.annotationPath;return e.substring(0,e.lastIndexOf("/")+1)}return m.getCustomDataWithModifier(t,"entityType",i)}).then(async function(e){P=e;return m.getCustomDataWithModifier(t,"useSemanticDateRange",i)}).then(async function(e){v=e;const o=n.createBindingContext(P+u);let r=i?i.getId(t):t.getId();if(r.endsWith("-content")){r=r.substring(0,r.lastIndexOf("-content"))}C={bindingContexts:{contextPath:n.createBindingContext(P),property:o},models:{contextPath:n,property:n},isXML:p};F=`/${c.getEntitySetPath(P).split("/").filter(c.filterOutNavPropBinding).join("/")}`;x={metaPath:o.getPath(),sPropertyName:u,sBindingPath:F,sValueHelpType:l+O,oControl:t,oMetaModel:n,oModifier:i,sIdPrefix:j(r,`${l}FilterField`,h),sVhIdPrefix:j(r,l+O),sNavigationPrefix:h,bUseSemanticDateRange:v,oSettings:d?.settings??{},visualFilter:d?.visualFilter,view:a,label:d?.label};return m.doesValueHelpExist(x)}).then(async function(e){if(!e){return R({bindingContexts:{contextPath:n.createBindingContext(P),metaPath:C.bindingContexts.property},models:{contextPath:n,metaPath:n},isXML:p},x)}return}).then(async function(){return m.getCustomDataWithModifier(t,"localId",i)}).then(async function(e){let n;if(x.visualFilter){n=o.getTargetView(t).getController()._getPageModel()}return X(C,x,e,n)})};function G(e){if(e instanceof window.Element){return null}return m.getCustomData(e,H)}function J(e,t){if(e instanceof window.Element){return}m.setCustomData(e,H,t)}function z(e,t,n){let o=G(n);let i;if(!o){o=L.fetchPropertiesForEntity(e,t,n);o.forEach(function(e){i=null;if(e.groupLabel){i=D(e.groupLabel,n);e.groupLabel=i===null?e.groupLabel:i}});E(o);J(n,o)}return o}L.fetchProperties=async function(e){const t=await L.fetchFilterProperties(e);m.setCustomData(e,"feFilterInfo",t);if(t.length>0){return y.formatPropertyInfo(t)}else{return[]}};L.fetchFilterProperties=async function(e){const t=m.getCustomData(e,"entityType");return m.fetchModel(e).then(function(n){if(!n){return[]}return z(t,n.getMetaModel(),e)})};L.getTypeMap=function(){return F};return L},false);
//# sourceMappingURL=FilterBarDelegate.js.map