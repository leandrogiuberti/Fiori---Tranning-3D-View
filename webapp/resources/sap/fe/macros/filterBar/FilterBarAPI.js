/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/base/ClassSupport","sap/fe/base/HookSupport","sap/fe/core/CommonUtils","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/PromiseKeeper","sap/fe/core/library","sap/fe/core/templating/DataModelPathHelper","sap/fe/macros/MacroAPI","sap/fe/macros/filter/FilterUtils","sap/fe/macros/filterBar/SemanticDateOperators","sap/fe/macros/mdc/adapter/StateHelper","sap/fe/navigation/SelectionVariant","sap/fe/navigation/library","sap/ui/core/Element","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/mdc/enums/FieldEditMode","sap/ui/mdc/p13n/StateUtil","sap/ui/thirdparty/jquery","./mixin/FilterBarAPIStateHandler"],function(t,e,n,r,a,i,o,l,s,c,u,f,d,g,p,h,y,m,b,jQuery,S){"use strict";var V,F,C,P,v,w,_,I,E,A,O,M,B,D,x,T,z,j,k,R,K,N,H,L,$,q,U,J,W,G,Q,X,Y,Z;var tt=p.NavType;var et=s.getContextRelativeTargetObjectPath;var nt=l.InitialLoadMode;var rt=i.getInvolvedDataModelObjects;var at=r.controllerExtensionHandler;var it=n.xmlEventHandler;var ot=n.property;var lt=n.mixin;var st=n.event;var ct=n.defineUI5Class;var ut=n.aggregation;function ft(t,e,n,r){n&&Object.defineProperty(t,e,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(r):void 0})}function dt(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,gt(t,e)}function gt(t,e){return gt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},gt(t,e)}function pt(t,e){throw Error("Decorating class property failed. Please ensure that transform-class-properties is enabled and runs after the decorators transform.")}function ht(t,e,n,r,a){var i={};return Object.keys(r).forEach(function(t){i[t]=r[t]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=n.slice().reverse().reduce(function(n,r){return r(t,e,n)||n},i),a&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(a):void 0,i.initializer=void 0),void 0===i.initializer?(Object.defineProperty(t,e,i),null):i}let yt=function(){function t(t){this.countFilterActions=0;this.countVariantFilters=0;this.filterBarAPI=t}var e=t.prototype;e.onFiltersChanged=function t(e){if(e==="Variant"){this.countVariantFilters++}else{this.countFilterActions++}};e.onSearch=function t(e,n){const r=this.getFilterNamesFromConditions(n);this.filterBarAPI.getPageController()?.telemetry.storeAction({type:"FE.FilterBarSearch",parameters:{countFilterActions:this.countFilterActions,countFilters:Object.keys(n).length,countVariantFilters:this.countVariantFilters,variantLayer:this.filterBarAPI.getVariant()?.layer??"None",autoLoad:e.reason==="Variant",searchUsed:n.$search?!!Object.keys(n.$search).length:false,filterNames:r}});this.countFilterActions=0;this.countVariantFilters=0};e.getFilterNamesFromConditions=function t(e){let n="";Object.keys(e).forEach(t=>{if(t!="$search"){n+=t+";"}});return n};return t}();var mt=function(t){t["Control"]="Control";t["Page"]="Page";t["None"]="None";return t}(mt||{});const bt="DisplayCurrency";const St="P_DisplayCurrency";let Vt=(V=ct("sap.fe.macros.filterBar.FilterBarAPI",{returnTypes:["sap.ui.core.Control"]}),F=lt(S),C=at("viewState","retrieveAdditionalStates"),P=at("viewState","applyAdditionalStates"),v=ot({type:"string"}),w=ot({type:"string",expectedAnnotations:["com.sap.vocabularies.UI.v1.SelectionFields"],expectedTypes:["EntitySet","EntityType"]}),_=ot({type:"string",expectedTypes:["EntitySet","EntityType","NavigationProperty"]}),I=ot({type:"boolean",defaultValue:false}),E=ot({type:"boolean",defaultValue:true}),A=ot({type:"boolean",defaultValue:true}),O=ot({type:"boolean",defaultValue:false}),M=ut({type:"sap.fe.macros.filterBar.FilterField",multiple:true}),B=st(),D=st(),x=st(),T=st(),z=st(),j=it(),k=it(),V(R=F(R=(K=function(n){function r(t,e){var r;r=n.call(this,t,e)||this;r.initialControlState={};r._initialStatePromise=new o;r._bSearchTriggered=false;r._hasPendingFilters=true;ft(r,"id",N,r);ft(r,"metaPath",H,r);ft(r,"contextPath",L,r);ft(r,"liveMode",$,r);ft(r,"visible",q,r);ft(r,"showMessages",U,r);ft(r,"showClearButton",J,r);ft(r,"filterFields",W,r);ft(r,"search",G,r);ft(r,"internalSearch",Q,r);ft(r,"filterChanged",X,r);ft(r,"afterClear",Y,r);ft(r,"internalFilterChanged",Z,r);r.telemetry=new yt(r);r.attachStateChangeHandler();return r}dt(r,n);var i=r.prototype;i.retrieveAdditionalStates=function t(e){e[this.getId()]={dataLoaded:!this._hasPendingFilters}};i.applyAdditionalStates=function t(e){const n=e[this.getId()];let r;if(typeof n==="object"&&n!==null){r=n.dataLoaded}else{r=undefined}const a="dataLoaded"in e&&typeof e.dataLoaded==="boolean"?e.dataLoaded:undefined;if(a===true||r===true){this.triggerSearch()}if(a===false||r===false){this.content._bSearchTriggered=false}};i.waitForInitialState=async function t(){return this._initialStatePromise.promise};i.getControlState=function t(e){const n=this.initialControlState;if(e){return{fullState:e,initialState:n}}return e};i.isSearchTriggeredByInitialLoad=function t(e){const n=this.getPageController(),r=n.getView(),a=r.getViewData();let t=false,i;if(a.variantManagement===mt.Control){i=n._getFilterBarVariantControl()}else{i=r.byId("fe::PageVariantManagement")}const o=i?.getCurrentVariantKey();if(e===tt.xAppState){return true}else if(i&&a.initialLoad!==nt.Enabled){if(n._shouldAutoTriggerSearch(this._getFilterBarVM(r))){t=true}}else if(i&&a.initialLoad===nt.Enabled&&n._getApplyAutomaticallyOnVariant(i,o)){t=true}return t};i._applySelectionVariant=async function t(e,n,r){const a=this.getContent();const{selectionVariant:i,selectionVariantDefaults:o,requiresStandardVariant:l=false}=n;if(!a||!i){return Promise.resolve()}const s=this._getFilterBarVM(e);const c=await this._activateVariantAndDetermineApplyAppState(s,l,r);if(c){this._addDefaultDisplayCurrencyToSV(e,i,o);const t=o?o.getSelectOptionsPropertyNames().length>0:false;const n=s&&s.getDefaultVariantKey()===s.getStandardVariantKey();const l=t&&(n||!s);const c=a.getParent();let u=i;if(r||l){u=await this._getAdjustedSV(i,l)}return c.setSelectionVariant(u,true)}};i._enableFilterBar=function t(e,n){const r=e.getParent();const a=()=>{this._bSearchTriggered=!n};if(e.getSuspendSelection()){r.attachEventOnce("search",a);e.enableRequests(true)}else{a()}};i._getAdjustedSV=async function t(e,n){let r=new g(e.toJSONObject());const a=await this.getSelectionVariant();const i=a?.getSelectOptionsPropertyNames()||[];if(i.length>0){r=i.reduce((t,e)=>{const r=t.getSelectOption(e);if(n&&!r?.length||!n){const n=a.getSelectOption(e);t.massAddSelectOption(e,n||[])}return t},r)}return r};i._preventInitialSearch=function t(e){if(!e){return true}const n=e.getVariants();const r=n.find(function(t){return t.getKey()===e.getCurrentVariantKey()});return!r.executeOnSelect};i._addDefaultDisplayCurrencyToSV=function t(e,n,r){if(!r||r?.isEmpty()){return}const a=e.getViewData(),i=e.getModel()?.getMetaModel(),o=a.contextPath||`/${a.entitySet}`,l=i.getMetaContext(o),s=rt(l);const c=this.getDisplayCurrencyPropertyName(s);const u=this._checkIfDisplayCurrencyIsRequired(s);if(!u){return}const f=n.getSelectOption(c)||[],d=r.getSelectOption(c)||[],g=d.length>0,p=f.length===0;if(p&&g){const t=d[0],e=t["Sign"],r=t["Option"],a=t["Low"],i=t["High"];n.addSelectOption(c,e,r,a,i)}};i.isParameterized=function t(e){return!!e.startingEntitySet.entityType?.annotations?.Common?.ResultContext};i.getDisplayCurrencyPropertyName=function t(e){return this.isParameterized(e)?St:bt};i._checkIfDisplayCurrencyIsRequired=function t(e){let n=false;if(this.isParameterized(e)){n=e.startingEntitySet.entityType.entityProperties.some(t=>t.name===St)}else{const t=e.startingEntitySet._type==="EntitySet"?e.startingEntitySet:undefined,r=t?.annotations.Capabilities?.FilterRestrictions?.RequiredProperties??[];n=r.some(t=>t.value===bt)}return n};i._activateVariantAndDetermineApplyAppState=async function t(e,n,r){if(e&&!r){let t=n?e.getStandardVariantKey():e.getDefaultVariantKey();if(t===null){t=e.getId()}await y.activateVariant({element:e,variantReference:t});return n||e.getDefaultVariantKey()===e.getStandardVariantKey()}return true};i._getFilterBarVM=function t(e){let n;const r=e.getViewData();switch(r.variantManagement){case mt.Page:n=e.byId("fe::PageVariantManagement");break;case mt.Control:n=e.getController()._getFilterBarVariantControl();break;case mt.None:default:break}return n};i.handleVariantIdPassedViaURLParams=async function t(e){const n=e["sap-ui-fe-variant-id"],r=e["sap-ui-fe-filterbar-variant-id"],a=e["sap-ui-fe-table-variant-id"],i=e["sap-ui-fe-chart-variant-id"];let o;if(n||r||a||i){o={sPageVariantId:n&&n[0],sFilterBarVariantId:r&&r[0],sTableVariantId:a&&a[0],sChartVariantId:i&&i[0]}}return this._handleControlVariantId(o)};i._handleControlVariantId=async function t(e){let n;const r=this.getPageController()?.getView(),a=[];const i=r.getViewData().variantManagement;if(e&&e.sPageVariantId&&i==="Page"){n=r.byId("fe::PageVariantManagement");this._handlePageVariantId(e,n,a)}else if(e&&i==="Control"){if(e.sFilterBarVariantId){n=r.getController()._getFilterBarVariantControl();this._handleFilterBarVariantControlId(e,n,a)}}return Promise.all(a)};i._handlePageVariantId=function t(e,n,r){n.getVariants()?.forEach(t=>{this._findAndPushVariantToPromise(t,e.sPageVariantId,n,r,true)})};i._handleFilterBarVariantControlId=function t(e,n,r){if(n){n.getVariants().forEach(t=>{this._findAndPushVariantToPromise(t,e.sFilterBarVariantId,n,r,true)})}};i._findAndPushVariantToPromise=function t(e,n,r,a,i){if(e.key===n){a.push(this._applyControlVariant(r,n,i))}};i._applyControlVariant=async function t(e,n){let r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;const a=this._checkIfVariantIdIsAvailable(e,n)?n:e.getStandardVariantKey();const i=y.activateVariant({element:e,variantReference:a});return i.then(function(){return r})};i._checkIfVariantIdIsAvailable=function t(e,n){const r=e.getVariants();let a=false;r.forEach(function(t){if(t.getKey()===n){a=true}});return a};i.attachStateChangeHandler=function t(){b.detachStateChange(this.stateChangeHandler);b.attachStateChange(this.stateChangeHandler)};i.stateChangeHandler=function t(e){const n=e.getParameter("control");if(n.isA("sap.ui.mdc.FilterBar")){const t=n.getParent();if(t?.handleStateChange){t.handleStateChange()}}};i.handleSearch=function t(n){const r=n.getSource();const a=n.getParameters();if(r){const t=r.getFilterConditions()??{};const n=this._prepareEventParameters(r);this.telemetry?.onSearch(a,t);this.fireEvent("internalSearch",e({conditions:t},a));this.fireEvent("search",e({reason:a.reason},n));this._hasPendingFilters=false;if(!this.liveMode){this.getPageController()?.getExtensionAPI().updateAppState()}}};i.handleFilterChanged=function t(n){const r=n.getSource();const a=n.getParameters();if(r){const t=r.getFilterConditions();const n=this._prepareEventParameters(r);this.telemetry?.onFiltersChanged(this._getFilterBarReason(r));this.fireEvent("internalFilterChanged",e({conditions:t},a));this.fireEvent("filterChanged",n);if(a?.conditionsBased){this._hasPendingFilters=true}}};i._getFilterBarReason=function t(e){return e?._sReason??""};i._prepareEventParameters=function t(e){const{parameters:n,filters:r,search:a}=u.getFilters(e)||{};return{parameters:n,filters:r,search:a}};i.setFilterValues=async function t(e,n,r){if(arguments.length===2){r=n;return u.setFilterValues(this.content,e,r)}return u.setFilterValues(this.content,e,n,r)};i.getActiveFiltersText=function t(){return this.content?.getAssignedFiltersText()?.filtersText||""};i.getFilters=function t(){return u.getFilters(this.content)||{}};i.triggerSearch=async function e(){const n=this.content;try{if(n){await n.waitForInitialization();return await n.triggerSearch()}}catch(e){const n=e instanceof Error?e.message:String(e);t.error(`FE : Buildingblock : FilterBar : ${n}`);throw Error(n)}};i.isSemanticDateFilterApplied=function t(){return f.hasSemanticDateOperations(this.content.getConditions(),false)};i.getSelectionVariant=async function t(){const e=await d.getSelectionVariant(this.getContent());const n=this.getPageController();if(n!==undefined){const t=n?.getView(),r=a.getAppComponent(t),i=r?.getNavigationService(),o=this.getDataModelObjectForMetaPath(this.metaPath);if(o?.targetEntitySet?.name){const n=o?.targetEntitySet?.name&&i?.constructContextUrl(o?.targetEntitySet?.name,t.getModel());e.setFilterContextUrl(n)}}return e};i.getMandatoryFilterPropertyNames=function t(){return this.content.getPropertyInfoSet().filter(function(t){return t.required}).map(function(t){return t.conditionPath})};i.getParameters=function t(){const e=this.content;const n=e.data("parameters");if(n){return Array.isArray(n)?n:JSON.parse(n)}return[]};i.getVariant=function e(){let n;try{const t=this.getModel("$FlexVariants");const e=this.content.getVariantBackreference();if(t&&e){n=t.getVariant(t.getCurrentVariantReference(e))}}catch(e){t.debug("Couldn't fetch variant ",e)}return n};i.setFilterFieldVisible=async function t(e,n){await b.applyExternalState(this.content,{items:[{name:e,visible:n}]})};i.getFilterFieldVisible=async function t(e){const n=await b.retrieveExternalState(this.content);return!!n.items.find(t=>t.name===e)};i.getVariantManagement=function t(){const e=this.content.getVariantBackreference();if(e){return h.getElementById(e)}else{throw new Error(`Variant back reference not defined on the filter bar ${this.id}`)}};i.setVariantBackReference=function t(e){const n=this.getContent();const r=n?.getLiveMode?.();if(!r){this.content.setVariantBackreference(e)}};i.getCurrentVariantKey=function t(){return this.getVariantManagement().getCurrentVariantKey()};i.setCurrentVariantKey=function t(e){const n=this.getVariantManagement();n.setCurrentVariantKey(e)};i.setFilterFieldEnabled=function t(e,n){this.getModel("internal").setData({[this.content.data("localId")]:{filterFields:{[e]:{editMode:n?m.Editable:m.Disabled}}}},true)};i.getFilterFieldEnabled=function t(e){return this.getModel("internal").getProperty(`/${this.content.data("localId")}/filterFields/${e}/editMode`)===m.Disabled?false:true};i.convertSelectionVariantToStateFilters=async function t(e,n){return d.convertSelectionVariantToStateFilters(this.content,e,n,this.content?.getModel())};i._clearFilterValuesWithOptions=async function t(e,n){await d._clearFilterValuesWithOptions(e,n)};i.setSelectionVariant=async function e(n){let r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;const a=this.getContent();const i=a&&a?.getLiveMode?.();let o;if(i){a.enableRequests(false)}try{o=await d.setSelectionVariantToMdcControl(this.getContent(),n,r);return o?.applyStateResult}catch(e){const n=e instanceof Error?e.message:String(e);t.error(`FE : Buildingblock : FilterBar : ${n}`);throw Error(n)}finally{if(i){a.enableRequests(true,o?.diffState)}}};i.handleStateChange=function t(){this.getPageController()?.getExtensionAPI().updateAppState()};i.getConditionPath=function t(e){const n=u.getDataModelObjectPathForProperty(this.content,e);return(n?et(n,false,true):undefined)??e};i.showFilterField=async function t(e){const n=await b.retrieveExternalState(this.content);const r=this.getConditionPath(e);const a=!!n.items.find(t=>t.name===r);if(!a){n.items.push({name:r})}await b.applyExternalState(this.content,n)};i.openValueHelpForFilterField=async function t(e,n){const r=this.getConditionPath(e);return new Promise((t,a)=>{const i=this.content.getFilterItems().find(t=>t.getPropertyKey()===r);const o=h.getElementById(i?.getValueHelp());if(!o||!i){a(new Error(`ValueHelp for filter field ${e} not found`));return}o.attachEventOnce("closed",()=>{t(o.getConditions())});i._oFocusInfo={targetInfo:{silent:true}};i.onfocusin?.(new jQuery.Event("focusin"));setTimeout(()=>{i.getAggregation("_content")[0].fireValueHelpRequest({fromKeyboard:true,_userInputValue:n})},200)})};i.getCollapsedFiltersText=function t(){return this.content?.getAssignedFiltersText()?.filtersText};return r}(c),ht(K.prototype,"retrieveAdditionalStates",[C],Object.getOwnPropertyDescriptor(K.prototype,"retrieveAdditionalStates"),K.prototype),ht(K.prototype,"applyAdditionalStates",[P],Object.getOwnPropertyDescriptor(K.prototype,"applyAdditionalStates"),K.prototype),N=ht(K.prototype,"id",[v],{configurable:true,enumerable:true,writable:true,initializer:null}),H=ht(K.prototype,"metaPath",[w],{configurable:true,enumerable:true,writable:true,initializer:null}),L=ht(K.prototype,"contextPath",[_],{configurable:true,enumerable:true,writable:true,initializer:null}),$=ht(K.prototype,"liveMode",[I],{configurable:true,enumerable:true,writable:true,initializer:null}),q=ht(K.prototype,"visible",[E],{configurable:true,enumerable:true,writable:true,initializer:null}),U=ht(K.prototype,"showMessages",[A],{configurable:true,enumerable:true,writable:true,initializer:null}),J=ht(K.prototype,"showClearButton",[O],{configurable:true,enumerable:true,writable:true,initializer:null}),W=ht(K.prototype,"filterFields",[M],{configurable:true,enumerable:true,writable:true,initializer:null}),G=ht(K.prototype,"search",[B],{configurable:true,enumerable:true,writable:true,initializer:null}),Q=ht(K.prototype,"internalSearch",[D],{configurable:true,enumerable:true,writable:true,initializer:null}),X=ht(K.prototype,"filterChanged",[x],{configurable:true,enumerable:true,writable:true,initializer:null}),Y=ht(K.prototype,"afterClear",[T],{configurable:true,enumerable:true,writable:true,initializer:null}),Z=ht(K.prototype,"internalFilterChanged",[z],{configurable:true,enumerable:true,writable:true,initializer:null}),ht(K.prototype,"handleSearch",[j],Object.getOwnPropertyDescriptor(K.prototype,"handleSearch"),K.prototype),ht(K.prototype,"handleFilterChanged",[k],Object.getOwnPropertyDescriptor(K.prototype,"handleFilterChanged"),K.prototype),K))||R)||R);return Vt},false);
//# sourceMappingURL=FilterBarAPI.js.map