/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/BindingToolkit","sap/fe/core/templating/DataModelPathHelper","sap/fe/macros/CommonHelper","sap/m/library","sap/ui/core/format/NumberFormat","../field/FieldTemplating","sap/fe/core/converters/MetaModelConverter","sap/fe/core/formatters/ValueFormatter","sap/fe/core/templating/CriticalityFormatters","sap/fe/base/jsx-runtime/jsx"],function(e,t,a,r,i,n,o,s,l,u,c){"use strict";function h(e){return new Promise((t,a)=>{sap.ui.require([e],a=>{if(!(a&&a.__esModule)){a=a===null||!(typeof a==="object"&&e.endsWith("/library"))?{default:a}:a;Object.defineProperty(a,"__esModule",{value:true})}t(a)},e=>{a(e)})})}var g=u.buildExpressionForCriticalityColorMicroChart;var d=o.getValueBinding;var f=i.ValueColor;var m=a.enhanceDataModelPath;var p=t.pathInModel;var C=t.getExpressionFromAnnotation;var y=t.formatWithTypeInformation;var M=t.formatResult;var V=t.constant;var v=t.compileExpression;const b={getThresholdColor:function(e,t){const a=t.context.getPath();if(a.includes("DeviationRange")){return f.Error}else if(a.includes("ToleranceRange")){return f.Critical}return f.Neutral},getMeasurePropertyPaths:function(t,a,i,n){const o=[];if(!a){e.warning("FE:Macro:MicroChart : Couldn't find annotations for the DataPoint.");return undefined}for(const s in t.Measures){const l=r.getMeasureAttributeIndex(s,t,n),u=l>-1&&t.MeasureAttributes&&t.MeasureAttributes[l];let c;if(n){c=u&&u?.DataPoint?.$target||undefined}else{c=u&&a&&a[u.DataPoint?.$AnnotationPath]}const h=n?c?.Value.path:c?.Value.$Path;if(h){o.push(h)}else{e.warning(`FE:Macro:MicroChart : Couldn't find DataPoint(Value) measure for the measureAttribute ${i} MicroChart.`)}}return n?o:o.join(",")},getHiddenPathExpression:function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++){t[a]=arguments[a]}if(!t[0]&&!t[1]){return true}if(t[0]===true||t[1]===true){return false}const r=[];[].forEach.call(t,function(e){if(e&&e.$Path){r.push("%{"+e.$Path+"}")}});return r.length?"{= "+r.join(" || ")+" === true ? false : true }":false},isNotAlwaysHidden:function(e,t,a,r,i){if(r===true){this.logError(e,t)}if(i===true){this.logError(e,a)}if(r===undefined&&i===undefined){return true}else{return(!r||r.$Path)&&r!==undefined||(!i||i.$Path)&&i!==undefined?true:false}},logError:function(t,a){e.error(`Measure Property ${a?.$Path} is hidden for the ${t} Micro Chart`)},formatDecimal:function(e,t,a,r){if(e){const r=[],i=["style: 'short'"];const n=typeof a==="number"?a:t&&t?.$Scale||1;if(t.$Nullable!=undefined){r.push("nullable: "+t.$Nullable)}if(t.$Precision!=undefined){i.push("precision: "+(t.$Precision?t.$Precision:"1"))}r.push("scale: "+(n==="variable"?"'"+n+"'":n));return"{ path: '"+e+"'"+", type: 'sap.ui.model.odata.type.Decimal', constraints: { "+r.join(",")+" }, formatOptions: { "+i.join(",")+" } }"}else if(r){const e=typeof a==="number"?a:1;return n.getFloatInstance({style:"short",preserveDecimals:true,decimals:e}).format(r)}},getSelectParameters:function(e,t,a,r,i,n){const o=[],s=[];const l=n?{}:[];if(t){t.forEach(e=>{s.push(`${e.Property}${e.Descending?" desc":""}`)})}if(r){o.push(r)}else if(a){const e=["ImprovementDirection","DeviationRangeLowValue","ToleranceRangeLowValue","AcceptanceRangeLowValue","AcceptanceRangeHighValue","ToleranceRangeHighValue","DeviationRangeHighValue"];Object.keys(a).forEach(t=>{if(e.includes(t)&&a[t].path){o.push(a[t].path)}})}i?.forEach(e=>{if(e){o.push(e)}});if(n){if(e){l.$$groupId=e}if(o.length){l.$select=o}if(s.length){l.$orderby=s}return l}else{if(e){l.push(`$$groupId : '${e}'`)}if(o.length){l.push(`$select : '${o.join(",")}'`)}if(s.length){l.push(`$orderby : '${s.join(",")}'`)}return l.join(",")}},getDataPointQualifiersForMeasures:function(t,a,r,i){const n=[],o=t.MeasureAttributes,s=function(t){let s;if(a){o?.forEach(function(e){let r,o;if(i){r=e.Measure?.value;o=t.value;if(r==o){n.push(e?.DataPoint?.$target?.qualifier)}}else{r=e.Measure?.$PropertyPath;o=t.$PropertyPath;if(r===o&&e.DataPoint?.$AnnotationPath){const t=e?.DataPoint?.$AnnotationPath;if(a[t]){s=t?.split("#")[1];if(s){n.push(s)}}}}})}if(s===undefined){e.warning(`FE:Macro:MicroChart : Couldn't find DataPoint(Value) measure for the measureAttribute for ${r} MicroChart.`)}};if(!a){e.warning(`FE:Macro:MicroChart : Couldn't find annotations for the DataPoint ${r} MicroChart.`)}t.Measures?.forEach(s);return i?n:n.join(",")},logWarning:function(t,a){for(const r in a){if(!a[r]){e.warning(`${r} parameter is missing for the ${t} Micro Chart`)}}},getDisplayValueForMicroChart:function(e,t,a,r){const i=e.ValueFormat&&e.ValueFormat.NumberOfFractionalDigits;if(t){return b.formatDecimal(t["$Path"],a,i)}return b.formatDecimal(e.Value["$Path"],r,i)},shouldRenderMicroChart:function(e){const t=["UI.ChartType/Area","UI.ChartType/Column","UI.ChartType/Bar"],a=e.ChartType,r=e.MeasureAttributes[0].DataPoint?.$target,i=r?.Value,n=i?.annotations?.UI?.Hidden,o=e?.Dimensions&&e?.Dimensions[0],s=t.includes(a)?i&&o:i;if(a==="UI.ChartType/Pie"){const e=r&&r.MaximumValue;const t=e?.annotations?.UI?.Hidden;return i&&e&&b.isNotAlwaysHidden(a,i,e,n,t)}return s&&b.isNotAlwaysHidden(a,i,n)},shouldMicroChartRender:function(e,t,a,r,i){const n=["Area","Column","Comparison"],o=t&&t.Value,s=a&&a["com.sap.vocabularies.UI.v1.Hidden"],l=r&&r.Dimensions&&r.Dimensions[0],u=n.includes(e)?o&&l:o;if(e==="Harvey"){const e=t&&t.MaximumValue,a=i&&i["com.sap.vocabularies.UI.v1.Hidden"];return o&&e&&b.isNotAlwaysHidden("Bullet",o,e,s,a)}return u&&b.isNotAlwaysHidden(e,o,undefined,s)},getDataPointQualifiersForMicroChart:function(e){if(!e.includes("com.sap.vocabularies.UI.v1.DataPoint")){return undefined}return e.split("#")[1]??""},getColorPaletteForMicroChart:function(e){return e.Criticality?undefined:"sapUiChartPaletteQualitativeHue1, sapUiChartPaletteQualitativeHue2, sapUiChartPaletteQualitativeHue3,          sapUiChartPaletteQualitativeHue4, sapUiChartPaletteQualitativeHue5, sapUiChartPaletteQualitativeHue6, sapUiChartPaletteQualitativeHue7,          sapUiChartPaletteQualitativeHue8, sapUiChartPaletteQualitativeHue9, sapUiChartPaletteQualitativeHue10, sapUiChartPaletteQualitativeHue11"},getMeasureScaleForMicroChart:function(e){if(e.ValueFormat&&e.ValueFormat.NumberOfFractionalDigits){return e.ValueFormat.NumberOfFractionalDigits.valueOf()}if(e.Value&&e.Value["$Path"]&&e.Value["$Path"]["$Scale"]){return e.Value["$Path"]["$Scale"]}return 1},getBindingExpressionForMicrochart:function(e,t,a,r,i,n){const o=["UI.ChartType/Bullet","UI.ChartType/Pie","UI.ChartType/Donut","Radial","Bullet","Harvey"];if(!e||o.includes(e)){const o=r["$isCollection"]||r["$kind"]==="EntitySet";const s=o?"":i;let l=b.getUOMPathForMicrochart(a.showOnlyChart,t);let u="";switch(e){case"Radial":case"UI.ChartType/Donut":l="";break;case"Harvey":case"UI.ChartType/Pie":u=n?.targetObject?.Criticality?n.targetObject?.Criticality?.path:"";break}const c=b.getSelectParameters(a.batchGroupId,undefined,undefined,u,[l]);return`{ path: '${s}'`+`, parameters : {${c}} }`}else{return a.batchGroupId?"{path:'', parameters : { $$groupId: '"+a.batchGroupId+"'} }":""}},getUOMPathForMicrochart:function(e,t,a){const r=["UI.ChartType/Bullet","UI.ChartType/Pie","UI.ChartType/Area","UI.ChartType/Column","UI.ChartType/Line","UI.ChartType/Bar"];if(!a||a&&r.includes(a)){return t&&!e?t.targetObject?.annotations?.Measures?.ISOCurrency?.path||t.targetObject?.annotations?.Measures?.Unit?.path||"":""}else{return undefined}},getAggregationForMicrochart:function(e,t,a,r,i,n,o,s,l){let u=t["$kind"]==="EntitySet"?"/":"";u=u+r;const c="";let h;let g=a.targetObject?.Criticality?a.targetObject?.Criticality?.path:"";const d=b.getUOMPathForMicrochart(false,n);let f="";let m="";if(i?.targetObject){i=i.targetObject}if(i?.$target?.annotations?.Common?.Text){m=i?.$target?.annotations?.Common?.Text?.path}else if(i){m=i?.value}switch(e){case"Points":case"UI.ChartType/Area":h=a?.targetObject?.CriticalityCalculation;f=a?.targetObject?.TargetValue?.path;g="";break;case"Columns":case"UI.ChartType/Column":h=a?.targetObject?.CriticalityCalculation;break;case"LinePoints":case"UI.ChartType/Line":g="";break;case"Bars":case"UI.ChartType/BarStacked":m="";break}const p=b.getSelectParameters(c,o,h,g,[d,f,m,s||""],l);if(l){return{path:u,parameters:p}}return`{path:'${u}'`+`, parameters : {${p}} }`},getCurrencyOrUnit:function(e){if(e[`@${"Org.OData.Measures.V1.ISOCurrency"}`]){return e[`@${"Org.OData.Measures.V1.ISOCurrency"}`].$Path||e[`@${"Org.OData.Measures.V1.ISOCurrency"}`]}if(e[`@${"Org.OData.Measures.V1.Unit"}`]){return e[`@${"Org.OData.Measures.V1.Unit"}`].$Path||e[`@${"Org.OData.Measures.V1.Unit"}`]}return""},getCalendarPattern:function(e,t,a){if(a){return b.checkPatternForRuntimeInstance(t,e)}else{return b.checkPatternForTemplateTimeInstance(t,e)}},checkPatternForRuntimeInstance:function(e,t){return e.Common?.IsCalendarYear&&"yyyy"||e.Common?.IsCalendarQuarter&&"Q"||e.Common?.IsCalendarMonth&&"MM"||e.Common?.IsCalendarWeek&&"ww"||e.Common?.IsCalendarDate&&"yyyyMMdd"||e.Common?.IsCalendarYearMonth&&"yyyyMM"||t==="Edm.Date"&&"yyyy-MM-dd"||undefined},checkPatternForTemplateTimeInstance:function(e,t){return e[`@${"com.sap.vocabularies.Common.v1.IsCalendarYear"}`]&&"yyyy"||e[`@${"com.sap.vocabularies.Common.v1.IsCalendarQuarter"}`]&&"Q"||e[`@${"com.sap.vocabularies.Common.v1.IsCalendarMonth"}`]&&"MM"||e[`@${"com.sap.vocabularies.Common.v1.IsCalendarWeek"}`]&&"ww"||e[`@${"com.sap.vocabularies.Common.v1.IsCalendarDate"}`]&&"yyyyMMdd"||e[`@${"com.sap.vocabularies.Common.v1.IsCalendarYearMonth"}`]&&"yyyyMM"||t==="Edm.Date"&&"yyyy-MM-dd"||undefined},getX:function(e,t,a){const r=a&&b.getCalendarPattern(t,a);if(r&&["Edm.Date","Edm.String"].some(e=>e===t)){return v(M([p(e),V(r),V(e)],"._formatters.ValueFormatter#formatStringDimension"))}},getExpressionWithType(e,t){if(e&&e.$target){const a=y(e.$target,C(e));a.formatOptions={...a.formatOptions,...t};return v(a)}},calculateColorBinding(e,t,a){let i;if(e.Criticality||!e.Criticality&&!e.CriticalityCalculation){i=a}else if(e.CriticalityCalculation){const a=e.CriticalityCalculation;const n=a?.ImprovementDirection;const o=a?.DeviationRangeLowValue?v(C(a?.DeviationRangeLowValue)):0;const s=a?.ToleranceRangeLowValue?v(C(a?.ToleranceRangeLowValue)):0;const l=a?.AcceptanceRangeLowValue?v(C(a?.AcceptanceRangeLowValue)):0;const u=a?.AcceptanceRangeHighValue&&v(C(a?.AcceptanceRangeHighValue));const c=a?.ToleranceRangeHighValue&&v(C(a?.ToleranceRangeHighValue));const h=a?.DeviationRangeHighValue&&v(C(a?.DeviationRangeHighValue));i=r.getCriticalityCalculationBinding(n,t,o,s,l,u,c,h)}return i},async getBulletMicroChartAggregations(e,t){const a=(await h("sap/suite/ui/microchart/BulletMicroChartData")).default;const r=v(C(e.Value));const i=[];const n=this.calculateColorBinding(e,r,t);if(e.CriticalityCalculation){const t=e.CriticalityCalculation;const r=t?.ImprovementDirection;if(!r.includes("Minimize")&&t?.DeviationRangeLowValue){i.push(c(a,{value:v(C(t?.DeviationRangeLowValue)),color:"Error"}))}if(!r.includes("Minimize")&&t?.ToleranceRangeLowValue){i.push(c(a,{value:v(C(t?.ToleranceRangeLowValue)),color:"Critical"}))}if(!r.includes("Maximize")&&t?.ToleranceRangeHighValue){i.push(c(a,{value:v(C(t?.ToleranceRangeHighValue)),color:"Critical"}))}if(!r.includes("Maximize")&&t?.DeviationRangeHighValue){i.push(c(a,{value:v(C(t?.DeviationRangeHighValue)),color:"Error"}))}}const o=c(a,{value:r,color:n});return{actual:o,thresholds:i}},async getStackMicroChartAggregations(e,t,a){const r=(await h("sap/suite/ui/microchart/StackedBarMicroChartBar")).default;const i=this.getExpressionWithType(e.Value);const n=a;const o=t?.targetObject?.annotations?.Common?.Text?this.getExpressionWithType(t?.targetObject?.annotations?.Common?.Text):undefined;return{bars:c(r,{value:i,displayValue:o,valueColor:n})}},async getHarveyMicroChartAggregations(e,t){const a=(await h("sap/suite/ui/microchart/HarveyBallMicroChartItem")).default;const r=this.getExpressionWithType(e.Value,{style:"short"});const i=this.getExpressionWithType(e.Value);const n=t;return{items:c(a,{formattedLabel:true,fractionLabel:r,fraction:i,color:n})}},async getComparisonMicroChartAggregations(e,t,a){const r=(await h("sap/suite/ui/microchart/ComparisonMicroChartData")).default;const i=v(C(e.Value));const n=this.getExpressionWithType(e.Value,{style:"short"});const o=a.Dimensions[0].$target?.annotations.Common?.Text;const s=o?v(C(o)):v(p(a.Dimensions[0].value));return c(r,{value:i,color:t,title:s,displayValue:n})},async getColumnMicroChartAggregations(e,t,a){const r=(await h("sap/suite/ui/microchart/ColumnMicroChartData")).default;const i=(await h("sap/suite/ui/microchart/ColumnMicroChartLabel")).default;const n={};const o=v(C(e.Value));const s=this.calculateColorBinding(e,o,t);n.columns=c(r,{value:o,color:s});if(!a){n.leftBottomLabel=c(i,{});n.leftTopLabel=c(i,{});n.rightBottomLabel=c(i,{});n.rightTopLabel=c(i,{})}return n},async getLineMicroChartAggragations(e,t,a){const r=(await h("sap/suite/ui/microchart/LineMicroChartLine")).default;const i=(await h("sap/suite/ui/microchart/LineMicroChartPoint")).default;const n=m(e,t.Dimensions[0].value);const o=t.Measures;const s=[];for(let l=0;l<o.length;l++){const o=m(e,t?.MeasureAttributes[l]?.DataPoint?.value);const u=m(e,t.Measures[l].value);const h=b.getAggregationForMicrochart("LinePoints",a?.getObject(),o,a?.getObject("@sapui.name"),t.Dimensions[0],u,e?.targetObject?.SortOrder,undefined,true);const g=this.getXData(n,e);const d=v(C(o.targetObject?.Value));s.push(c(r,{points:h,children:{points:c(i,{x:g,y:d})}}))}return{lines:s}},getXData(e,t){let a;const r=e?.targetObject?.type;const i=e.targetObject?.annotations;if(r==="Edm.Date"||e.targetObject?.type==="Edm.String"&&b.getCalendarPattern(r,e.targetObject?.annotations,true)){const t=e?.targetObject?.name;const n=i&&b.getCalendarPattern(r,i,true);if(n&&["Edm.Date","Edm.String"].some(e=>e===r)){a=v(M([p(t),n,t],l.formatStringDimension))}}else{e.contextLocation=t;a=d(e,{})}return a},async getAreaMicroChartAggregations(e,t,a,r){const i=(await h("sap/suite/ui/microchart/AreaMicroChartItem")).default;const n=(await h("sap/suite/ui/microchart/AreaMicroChartPoint")).default;const o=(await h("sap/suite/ui/microchart/AreaMicroChartLabel")).default;const l=e?.MeasureAttributes[0]?.DataPoint?.$target;const u=m(t,e.Measures[0].value);const g=m(t,e.Dimensions[0].value);const d=m(t,e?.MeasureAttributes[0]?.DataPoint?.value);const f=s.getInvolvedDataModelObjects(a);const p=(r,o,s)=>{let l;if(s){l=b.getAggregationForMicrochart("Points",a?.getObject(),d,a?.getObject("@sapui.name"),e.Dimensions[0],u,t?.targetObject?.SortOrder,"",true)}else{l={path:(f.targetObject?._type==="EntitySet"?"/":"")+f.targetObject?.name}}return c(i,{color:o,points:l,children:{points:c(n,{x:M,y:v(C(r))})}})};const y={};const M=this.getXData(g,t);y.chart=p(l.Value,undefined,true);y.target=p(l.TargetValue);if(!r){y.firstXLabel=c(o,{});y.firstYLabel=c(o,{});y.lastXLabel=c(o,{});y.lastYLabel=c(o,{})}const V=d?.targetObject?.CriticalityCalculation?.ImprovementDirection;if(V==="UI.ImprovementDirectionType/Minimize"){y.minThreshold=p(l?.CriticalityCalculation?.ToleranceRangeHighValue,"Good");y.maxThreshold=p(l?.CriticalityCalculation?.DeviationRangeHighValue,"Error")}else if(V==="UI.ImprovementDirectionType/Maximize"){y.minThreshold=p(l?.CriticalityCalculation?.DeviationRangeLowValue,"Error");y.maxThreshold=p(l?.CriticalityCalculation?.ToleranceRangeLowValue,"Good")}else if(V==="UI.ImprovementDirectionType/Target"){y.minThreshold=p(l?.CriticalityCalculation?.DeviationRangeLowValue,"Error");y.maxThreshold=p(l?.CriticalityCalculation?.DeviationRangeHighValue,"Error");y.innerMinThreshold=p(l?.CriticalityCalculation?.ToleranceRangeLowValue,"Good");y.innerMaxThreshold=p(l?.CriticalityCalculation?.ToleranceRangeHighValue,"Good")}return y},getBulletMicroChartProperties(e,t){e.targetValue=t.TargetValue?v(C(t.TargetValue)):undefined;e.forecastValue=t.ForecastValue?v(C(t.ForecastValue)):undefined;e.maxValue=t.MaximumValue?v(V(t.MaximumValue?.valueOf())):undefined;e.minValue=t.MinimumValue?v(V(t.MinimumValue?.valueOf())):undefined;e.actualValueLabel=t.Value?b.getExpressionWithType(t.Value,{style:"short"}):undefined;e.targetValueLabel=t.TargetValue?b.getExpressionWithType(t.TargetValue,{style:"short"}):undefined;e.showDeltaValue=t.Visualization&&t.Visualization==="UI.VisualizationType/DeltaBulletChart";e.mode=e.showDeltaValue?"Delta":undefined;return e},getRadialMicroChartProperties(e,t){e.total=t.TargetValue?v(C(t.TargetValue)):100;const a=v(C(t.Value));e.fraction=a;e.percentage=!t.TargetValue?a:undefined;const r=t.Criticality?g(t):undefined;e.valueColor=b.calculateColorBinding(t,a,r);return e},getHarveyMicroChartProperties(e,t){e.formattedLabel=true;e.totalLabel=b.getExpressionWithType(t.MaximumValue,{style:"short"});e.total=b.getExpressionWithType(t.MaximumValue);e.colorPalette=b.getColorPaletteForMicroChart(t);return e}};return b},false);
//# sourceMappingURL=MicroChartHelper.js.map