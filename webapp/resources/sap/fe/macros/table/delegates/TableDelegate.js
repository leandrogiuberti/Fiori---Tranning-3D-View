/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/base/util/deepExtend","sap/fe/base/BindingToolkit","sap/fe/base/jsx-runtime/jsx","sap/fe/core/ActionRuntime","sap/fe/core/CommonUtils","sap/fe/core/converters/MetaModelConverter","sap/fe/core/controllerextensions/cards/CollaborationManager","sap/fe/core/converters/controls/Common/table/Columns","sap/fe/core/formatters/ValueFormatter","sap/fe/core/helpers/DeleteHelper","sap/fe/core/helpers/ExcelFormatHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/PromiseKeeper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/SizeHelper","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/type/EDM","sap/fe/macros/CollectionBindingInfo","sap/fe/macros/CommonHelper","sap/fe/macros/DelegateUtil","sap/fe/macros/filterBar/FilterBarDelegate","sap/fe/macros/table/MdcTableTemplate","sap/fe/macros/table/TableHelper","sap/fe/macros/table/TableRuntime","sap/fe/macros/table/TableSizeHelper","sap/fe/macros/table/Utils","sap/m/IllustratedMessage","sap/m/IllustratedMessageType","sap/ui/core/Element","sap/ui/core/Fragment","sap/ui/core/util/XMLPreprocessor","sap/ui/mdc/odata/v4/TableDelegate","sap/ui/mdc/odata/v4/TypeMap","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/model/json/JSONModel","../TableEventHandlerProvider"],function(e,t,n,i,a,o,r,s,l,c,p,d,u,f,g,h,m,y,b,P,T,C,I,v,_,A,D,E,S,F,x,M,O,B,R,w,L,N,U){"use strict";var k=v.getSlotColumn;var $=v.getComputedColumn;var H=v.getColumnTemplate;var V=b.isTypeFilterable;var W=y.isPathFilterable;var j=h.getResourceModel;var G=h.getLocalizedText;var K=c.ColumnType;var q=s.getInvolvedDataModelObjects;var X=i.isConstant;const z="/semanticKeyHasDraftIndicator";const Q="searchFired";const J="columnAdded";const Y="previousSorters";return Object.assign({},B,{apiVersion:2,_computeVisualSettingsForFieldGroup:function(e,t,i){if(t.key.indexOf("DataFieldForAnnotation::FieldGroup::")===0){const a=e.getColumns().find(e=>e.getPropertyKey()===t.key);const o=a?a.data("showDataFieldsLabel")==="true":false;const r=e.getModel().getMetaModel();const s=q(r.getContext(t.annotationPath));const l=s.convertedTypes;const c=s.targetObject;const p=c.Target.$target;const d=[];p.Data.forEach(function(e){let t;switch(e.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":t=D.getWidthForDataFieldForAnnotation(e,false,i,l,o);break;case"com.sap.vocabularies.UI.v1.DataField":t=D.getWidthForDataField(e,o,i,l,false);break;case"com.sap.vocabularies.UI.v1.DataFieldForAction":t={labelWidth:0,propertyWidth:m.getButtonWidth(e.Label?.toString())};break;default:}if(t){d.push(t.labelWidth+t.propertyWidth)}});const u=d.reduce(function(e,t){return Math.max(e,t)},0);t.visualSettings=n(t.visualSettings,{widthCalculation:{verticalArrangement:true,minWidth:Math.ceil(u)}})}},_computeVisualSettingsForPropertyWithValueHelp:function(e,t){const i=this._getTableAPI(e);if(!t.propertyInfos){const a=e.getModel().getMetaModel();if(t.annotationPath&&a){const e=a.getObject(`${t.annotationPath}@`);if(e&&e["@com.sap.vocabularies.Common.v1.ValueList"]){t.visualSettings=n(t.visualSettings||{},{widthCalculation:{gap:i.getProperty("readOnly")?0:4}})}}}},_computeVisualSettingsForPropertyWithUnit:function(e,t,i,a,o){const r=e?this._getTableAPI(e):null;const s=a||o;if(s){t.visualSettings=n(t.visualSettings,{widthCalculation:{gap:Math.ceil(m.getButtonWidth(s))}})}if(i){t.visualSettings=n(t.visualSettings,{widthCalculation:{gap:r&&r.getReadOnly()?0:6}})}},_computeLabel:function(e,t){if(e.label){const n=t[e.label];const i=n?.some(t=>t.text===e.path&&t?.mode==="Description");if(n?.length>1&&e.path?.includes("/")&&e.additionalLabels&&!i&&!(e?.mode==="Description"&&e.filterable)){e.label=e.label+" ("+e.additionalLabels.join(" / ")+")"}delete e.additionalLabels}},_updatePropertyInfo:function(e,t){const n={};const i=e.getP13nMode();t.forEach(e=>{if(!e.propertyInfos&&e.label){if(i?.includes("Sort")&&e.sortable||i?.includes("Filter")&&e.filterable||i?.includes("Group")&&e.groupable){n[e.label]=n[e.label]!==undefined?n[e.label].concat([e]):[e]}}});t.forEach(i=>{this._computeVisualSettingsForFieldGroup(e,i,t);this._computeVisualSettingsForPropertyWithValueHelp(e,i);this._computeLabel(i,n)});t.push({key:"$editState",path:"$editState",groupLabel:"",group:"",label:"",dataType:"sap.ui.model.odata.type.String",visible:false,groupable:false,sortable:false,filterable:false});return t},_getTableAPI(e){let t=e.getParent();if(!t){t=x.getElementById(e.getId()+"::Table")}return t},getColumnsFor:function(e){const t=this._getTableAPI(e);return t.getTableDefinition().columns},fetchExportCapabilities:async function(t){const n={XLSX:{}};let i;return C.fetchModel(t).then(function(e){i=e;return i.getMetaModel().getObject("/$EntityContainer@Org.OData.Capabilities.V1.SupportedFormats")}).then(function(e){const t=(e||[]).map(e=>e.toLowerCase());if(t.includes("application/pdf")){return i.getMetaModel().getObject("/$EntityContainer@com.sap.vocabularies.PDF.v1.Features")}return undefined}).then(function(e){if(e){n["PDF"]=Object.assign({},e)}return}).catch(function(t){e.error(`An error occurs while computing export capabilities: ${t}`)}).then(function(){return n})},_isFilterableNavigationProperty:function(e,t){const n=W(t);return!e.relativePath.includes("/")||(e.isPartOfLineItem===true||e.isPartOfCustomColumn===true)&&!(X(n)&&n.value===false)},_fetchPropertyInfo:function(e,t,n,i){const a=t.annotationPath,o=e.getObject(a),r=e.createBindingContext(a),s=t.typeConfig?.className&&t.typeConfig.className?.indexOf("Edm.")!==0,l=T.isPropertyFilterable(r,o),c=C.getCustomData(n,"enableAnalytics")==="true",p=G(t.label??"",i??n),d=G(t.tooltip??"",i??n),u=this._getTypeConfig(t,s),f={name:t.name,key:t.name,annotationPath:a,groupLabel:t.groupLabel,group:t.group,label:p,tooltip:d,dataType:u.className,typeConfig:u,formatOptions:t.typeConfig?.baseType==="Edm.DateTimeOffset"?{style:"medium/short"}:t.typeConfig?.formatOptions,constraints:t.typeConfig?.constraints,visible:t.availability!=="Hidden"&&!s,exportSettings:this._setPropertyInfoExportSettings(t.exportSettings,t),unit:t.unit,type:K.Annotation,relativePath:t.relativePath};if(f.exportSettings?.template){f.clipboardSettings={template:f.exportSettings.template}}if(t.visualSettings&&Object.keys(t.visualSettings).length>0){f.visualSettings=t.visualSettings}if(t.exportDataPointTargetValue){f.exportDataPointTargetValue=t.exportDataPointTargetValue}if(t.propertyInfos?.length){f.propertyInfos=t.propertyInfos}else{const a=q(e.getContext(t.annotationPath),e.getContext(C.getCustomData(n,"metaPath")));f.path=t.relativePath;f.sortable=t.sortable;if(c){this._updateAnalyticalPropertyInfoAttributes(f,t)}f.filterable=t.filterable!==false&&!!l&&this._isFilterableNavigationProperty(t,a);f.isKey=t.isKey;f.groupable=t.isGroupable;if(t.textArrangement){this._setTextArrangementInfo(f,t,n)}if(f.isKey){f.extension={technicallyGroupable:true}}f.caseSensitive=t.caseSensitive;if(t.additionalLabels){f.additionalLabels=t.additionalLabels.map(e=>G(e,i||n))}}this._computeVisualSettingsForPropertyWithUnit(n,f,t.unit,t.unitText,t.timezoneText);return f},_setPropertyInfoExportSettings:function(e,t){const n=this._getExportFormat(t.typeConfig?.className);if(n&&e){e.format=n}return e},_getTypeConfig(e,t){let n=R.getTypeConfig("sap.ui.model.odata.type.String");if(e.typeConfig?.className&&V(e.typeConfig.className)){n=R.getTypeConfig(e.typeConfig.className,e.typeConfig.formatOptions,e.typeConfig.constraints)}else if(e.typeConfig?.className&&!t){n=R.getTypeConfig(e.typeConfig.className)}return n},_setTextArrangementInfo:function(e,t,n){const i=this.getColumnsFor(n).find(function(e){return e.name===t.textArrangement?.textProperty});if(i){e.mode=t.textArrangement.mode;e.valueProperty=t.relativePath;e.descriptionProperty=i.relativePath}e.text=t.textArrangement?.textProperty},_updateAnalyticalPropertyInfoAttributes(e,t){if(t.aggregatable){e.aggregatable=t.aggregatable}if(t.extension){e.extension=t.extension}},_fetchComputedPropertyInfo:function(e,t){const n=G(e.label,t);const i={key:e.name,label:n.toString(),dataType:"sap.ui.model.odata.type.String",visible:e.availability!=="Hidden",filterable:false,sortable:false,groupable:false,exportSettings:e.exportSettings,clipboardSettings:e.clipboardSettings};if(e.propertyInfos!==undefined&&e.propertyInfos.length>0){i.propertyInfos=e.propertyInfos}return i},_fetchCustomPropertyInfo:function(e,t,n){let i;if(e.header){if(e.header.startsWith("{metaModel>")){i=f.fetchTextFromMetaModel(e.header,undefined,t.getModel().getMetaModel())}else{i=G(e.header,n)}}const a={key:e.name,groupLabel:undefined,group:undefined,label:i??"",dataType:"sap.ui.model.odata.type.String",visible:e.availability!=="Hidden",exportSettings:e.exportSettings,visualSettings:e.visualSettings};if(e.propertyInfos&&e.propertyInfos.length){a.propertyInfos=e.propertyInfos}else{a.path=e.name;a.sortable=false;a.filterable=false}return a},_bColumnHasPropertyWithDraftIndicator:function(e){return!!(e.formatOptions&&e.formatOptions.hasDraftIndicator||e.formatOptions&&e.formatOptions.fieldGroupDraftIndicatorPropertyPath)},_updateDraftIndicatorModel:function(e,t){const n=e.getColumns();const i=e.getBindingContext("internal");const a=i&&i.getPath();if(n&&i){for(const e in n){if(this._bColumnHasPropertyWithDraftIndicator(t)&&t.name===n[e].getPropertyKey()){if(i.getProperty(a+z)===undefined){i.setProperty(a+z,t.name);break}}}}},_fetchPropertiesForEntity:async function(t,n,i,a){const o=f.getEntitySetPath(n);let s=[];const l=r.getFilterRestrictionsByPath(o,i).NonFilterableProperties;return Promise.resolve(this.getColumnsFor(t)).then(e=>{if(e){let n;e.forEach(e=>{this._updateDraftIndicatorModel(t,e);switch(e.type){case"Annotation":n=this._fetchPropertyInfo(i,e,t,a);if(n&&!l.includes(n.name)){n.maxConditions=C.isMultiValue(n)?-1:1}break;case"Computed":n=this._fetchComputedPropertyInfo(e,t);break;case"Slot":case"Default":n=this._fetchCustomPropertyInfo(e,t,a);break;default:throw new Error(`unhandled switch case ${e.type}`)}s.push(n)})}return}).then(()=>{s=this._updatePropertyInfo(t,s);const e=this._getTableAPI(t);e.setEnhancedFetchedPropertyInfos(s);s=e.getPropertyInfos();return}).catch(function(t){e.error(`An error occurs while updating fetched properties: ${t}`)}).then(function(){return s})},_getCachedOrFetchPropertiesForEntity:async function(e,t,n,i){const a=this._getTableAPI(e);const o=a.getCachedPropertyInfos();if(o.length){return Promise.resolve(o)}return this._fetchPropertiesForEntity(e,t,n,i).then(function(e){a.setCachedPropertyInfos(e);return e})},setNoDataInformation:function(e,t){const n=e.getNoData();if(typeof n!="string"&&n?.isA("sap.m.IllustratedMessage")){const e=n;e.setTitle(t.title);e.setDescription(t.description);e.setIllustrationType(t.illustrationType);e.setIllustrationSize(t.illustrationSize)}else{const n=new S({...t});e.setNoData(n)}},setTableNoDataIllustratedMessage:function(e,t){const n=E.getAllFilterInfo(e);const i=j(e);const a=t.path?.startsWith("/")?t.path.substring(1):t.path;let o;const s=function(){if(e.data("hiddenFilters")||e.getQuickFilter()){return{title:i.getText("T_ILLUSTRATED_MESSAGE_TITLE_NOSEARCHRESULTS"),description:i.getText("M_TABLE_AND_CHART_NO_DATA_TEXT_MULTI_VIEW",undefined,a),illustrationType:F.NoSearchResults}}return{title:i.getText("T_ILLUSTRATED_MESSAGE_TITLE_NOSEARCHRESULTS"),description:i.getText("T_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER",undefined,a),illustrationType:F.NoSearchResults}};const l=e.getFilter();const c=n.search||n.filters?.length;if(l&&!/BasicSearch$/.test(l)){if(c){o=s()}else{o={title:i.getText("T_ILLUSTRATED_MESSAGE_TITLE_NOSEARCHRESULTS"),description:i.getText("T_TABLE_AND_CHART_NO_DATA_TEXT",undefined,a),illustrationType:F.NoSearchResults}}}else if(c){o=s()}else{o={title:i.getText("T_ILLUSTRATED_MESSAGE_TITLE_NODATA"),description:i.getText("M_TABLE_AND_CHART_NO_FILTERS_NO_DATA_TEXT",undefined,a),illustrationType:F.NoData}}if(r.getTargetView(e).getViewData().liveMode){if(c){o=s()}else{o={title:i.getText("T_ILLUSTRATED_MESSAGE_TITLE_NOSEARCHRESULTS"),description:i.getText("M_TABLE_AND_CHART_NO_FILTERS_NO_DATA_TEXT"),illustrationType:F.NoSearchResults}}}const p=this._getTableAPI(e);o.illustrationSize=p.getNoDataMessageMode();if(o.illustrationSize==="text"){const t=e.getNoData();if(typeof t==="string"&&t===o.description){return}e.setNoData(o.description)}else{this.setNoDataInformation(e,o)}},handleTableDataRequested:function(e,t){const n=e&&e.getRowBinding(),i=t&&t.getProperty("dataRequestedAttached");if(t&&!i){n.attachDataRequested(()=>{if(!t.getProperty("dataRequestedTimeoutSet")){t.setProperty("dataRequestedTimeoutSet",true);setTimeout(()=>{t.setProperty("dataRequestedTimeoutSet",false);const n=e?e.getParent():null;if(n){n.tableDefaultsPromise=n.getTableDefaults(e)??Promise.resolve({})}},0)}});t.setProperty("dataRequestedAttached",true)}},handleTableDataReceived:function(e,t){const n=e&&e.getRowBinding(),i=t&&t.getProperty("dataReceivedAttached");if(t&&!i){n.attachDataReceived(()=>{if(!t.getProperty("dataReceivedTimeoutSet")){t.setProperty("dataReceivedTimeoutSet",true);setTimeout(async()=>{t.setProperty("dataReceivedTimeoutSet",false);t.setProperty("selectedContexts",[]);const n=e.getSelectedContexts();t.setProperty("selectedContexts",n);t.setProperty("numberOfSelectedContexts",n.length);const i=this._getTableAPI(e);const a=JSON.parse(i.tableDefinition.operationAvailableMap);o.setActionEnablement(t,a,n,"table");d.updateDeleteInfoForSelectedContexts(t,n);if(i){const t=await(i.tableDefaultsPromise?.catch(()=>undefined));await i.setUpEmptyRows(e,false,t)}this._updateAvailableCards(e)},0)}});t.setProperty("dataReceivedAttached",true)}},setOptimisticBatchPromiseForModel:function(e,t){const n=e.getAppComponent().getModel();if(n){t.setOptimisticBatchEnablerPromise(new g);this.setOptimisticBatchForModel(e,n,t)}},enableOptimisticBatchMode:function(e,t){const n=t&&E.isFilterEligibleForOptimisticBatch(t,e._getFilterBarControl());const i=this._getTableAPI(t);i.getOptimisticBatchEnablerPromise()?.resolve(!n)},setOptimisticBatchForModel:function(e,t,n){const i=e.getAppComponent().getShellServices().isFlpOptimisticBatchPluginLoaded();if(t.getOptimisticBatchEnabler()===null&&!n.isOptimisticBatchDisabled()&&i){const e=n.getOptimisticBatchEnablerPromise();t.setOptimisticBatchEnabler(function(){return e?.promise})}},rebind:async function(t,n){const i=this._getTableAPI(t);const a=i?.getProperty("bindingSuspended");i?.setProperty("outDatedBinding",a);if(!a){A.clearSelection(t);B.rebind.apply(this,[t,n]);E.onTableBound(t);return E.whenBound(t).then(e=>{this.handleTableDataRequested(e,e.getBindingContext("internal"));this.handleTableDataReceived(e,e.getBindingContext("internal"));return}).catch(function(t){e.error("Error while waiting for the table to be bound",t)})}return Promise.resolve()},fetchProperties:async function(e){return C.fetchModel(e).then(async t=>{const n=r.getAppComponent(e);return this._getCachedOrFetchPropertiesForEntity(e,C.getCustomData(e,"entityType")??"",t.getMetaModel(),n)}).then(t=>{e.getBindingContext("internal")?.setProperty("tablePropertiesAvailable",true);return t})},preInit:async function(e){return B.preInit.apply(this,[e]).then(()=>{const t=e.getCreationRow();if(t){t.setBindingContext(null)}return})},updateBindingInfo:function(t,n){const i=t.getBindingContext("internal");const a=this._getTableAPI(t);const o=t.getQuickFilter();const r=new P(n);i?.setProperty("isInsightsEnabled",true);B.updateBindingInfo.apply(this,[t,n]);try{this._handleSortersOnCurrenciesOrUoM(t,n);this._internalUpdateBindingInfo(t,n);this.setTableNoDataIllustratedMessage(t,n);this._handleRecommendationOutputFields(t,n);this._handleFiltersForExternalID(t,n);a?.fireEvent("beforeRebindTable",{collectionBindingInfo:r,quickFilterKey:o?.getSelectedKey()});const e=r.getAttachedEvents();const i=t.getBindingContext();if(t.getCreationRow()?.getBindingContext()===null&&n.path&&i){_.enableFastCreationRow(t.getCreationRow(),n.path,i,t.getModel(),Promise.resolve())}a.setAttachEvents(e)}catch(t){e.error("Error while updating the binding info",t)}},_handleSortersOnCurrenciesOrUoM:function(e,t){const n=t.sorter;const i=[];if(n?.length){const a=this._getTableAPI(e);const o=a.getCachedPropertyInfos();for(const e of n){const t=o?.find(t=>t.path===e.getPath());if(t?.unit){const e=o?.find(e=>e.key===t?.unit);const a=e?.path&&n.some(t=>t.getPath()===e.path);if(!a&&e?.sortable!==false&&e?.path){i.push(new L(e.path,false))}}i.push(e)}t.sorter=i}},_handleFiltersForExternalID:function(e,t){const n=e.getModel()?.getMetaModel();const i=t.path+"/";const a=t.filters?.getFilters();if(a!==undefined){E.updateFiltersForExternalID(n,a,i)}},_handleRecommendationOutputFields:function(e,t){const n=this._getTableAPI(e);const i=n?.getPageController();if(i?.recommendations.isRecommendationEnabled()){const e=i.getAppComponent();const a=n.getTableDefinition();const o=e.getSideEffectsService().getRecommendationOutputFields(a.annotation.entityTypeName);if(o&&o.length>0&&t.parameters){t.parameters.$select=t.parameters?.$select?.concat(",",o.join())}}},_updateAvailableCards:async function(e){const t=this._getTableAPI(e);if(t.getPageController().getView().getViewData()?.converterType==="ListReport"){const e=t?.getPageController()?.getAppComponent();const n=[];await t.collectAvailableCards(n);const i=new l;const a=i.updateCards(n);const o=e.getId();e.getCollaborationManagerService().addCardsToCollaborationManager(a,o,t.getPageController().getView().getId());e.getCollaborationManagerService().shareAvailableCards()}},getInResultPropertyKeys:function(e){const t=this._getTableAPI(e);if(t.tableDefinition.control.analyticalConfiguration?.aggregationOnLeafLevel){const n=this.checkAllKeysAreRequested(t);const i=e.getBindingContext("internal");i?.setProperty("isNodeLevelNavigable",t.overrideRowPress?true:n);return Object.keys(t.tableDefinition.requestAtLeast).filter(e=>!n?t.tableDefinition.requestAtLeast[e].some(e=>e!=="restriction"&&e!=="semanticKey"):true)}return Object.keys(t.tableDefinition.requestAtLeast??{})},checkAllKeysAreRequested:function(e){const t=e.getContent();const n=e.getTableDefinition().columns;const i=n.filter(e=>e.isKey&&e.relativePath&&e.relativePath!=="IsActiveEntity").map(e=>e.relativePath);const a=t.getColumns().map(t=>e.getTableDefinition().columns.find(e=>e.name===t.getPropertyKey()));const o=new Set;function r(e){if(e.relativePath&&e.propertyInfos===undefined){o.add(e.relativePath)}e.extension?.additionalProperties?.forEach(e=>{const t=n.find(t=>t.name===e);if(t?.relativePath){o.add(t.relativePath)}})}a.forEach(e=>{if(!e){return}r(e);e.propertyInfos?.forEach(e=>{const t=n.find(t=>t.name===e);if(t){r(t)}})});return i.every(e=>e&&o.has(e))},getSearchQuery:function(e){const t=e.getAggregation?.();if(t?.search!==undefined){return t.search}return e.getQueryOptionsFromParameters().$search},updateBinding:function(n,i,a){const o=this._getTableAPI(n);const s=o?.getProperty("bindingSuspended");if(!s){if(i.parameters?.$$getKeepAliveContext===true){const e=C.getCustomData(n,"targetCollectionPath")??"";const t=n.getModel("internal");const a=t?.getObject("/keptAliveLists")??{};if(!a[e]){a[e]=n.getId();t?.setProperty("/keptAliveLists",a)}else if(a[e]!==n.getId()){delete i.parameters.$$getKeepAliveContext}}let s=false;const l=r.getTargetView(n);const c=n.getBindingContext("internal");const p="pendingManualBindingUpdate";const d=c?.getProperty(p);const u=JSON.stringify(i.sorter??[]);if(a){const e=l?.getViewData();const n=a.getFilters("Application");const o=c?.getProperty(Y)??"[]";const r=(i.filters===null&&n.length===0||t(i.filters,n[0]))&&u===o&&i.path===a.getPath()&&this.getSearchQuery(a)===i?.parameters?.$search;const p=!!e.views;s=r&&(c?.getProperty(Q)||c?.getProperty(J)||p)&&!d}if(o.getTableDefinition().enableAnalytics!==true){n.setAggregateConditions();if(o.getTableDefinition().control.type==="GridTable"||o.getTableDefinition().control.type==="TreeTable"){n.setGroupConditions()}}B.updateBinding.apply(this,[n,i,a]);o.setTableBindingInfo(i);o.setDownloadUrl();n.fireEvent("bindingUpdated");if(s&&n.getFilter()&&a){a.requestRefresh(a.getGroupId()).finally(()=>{c?.setProperty(p,false)}).catch(function(t){e.error("Error while refreshing the table",t)});c?.setProperty(p,true)}c?.setProperty(Q,false);c?.setProperty(J,false);c?.setProperty(Y,u);if(o.getTableDefinition().control.type==="TreeTable"){c?.setProperty("pastableContexts",[])}const f=o.storedEvents??[];f.forEach(e=>{let{eventId:t,callback:i,listener:a,data:o}=e;n.getRowBinding()?.attachEvent(t,o,i,a)})}o?.setProperty("outDatedBinding",s)},_computeRowBindingInfoFromTemplate:function(e){const t=this._getTableAPI(e);const n=t.getTableTemplateBindingInfo();const i=e.getBindingContext();let a=false;if(i===undefined&&e.getBindingContext("ui")?.getProperty("isEditable")===false&&e.getModel("viewData")?.getProperty("/isInlineEditEnabled")){a=true}else if(i?.getBinding().getUpdateGroupId()==r.INLINEEDIT_UPDATEGROUPID){a=true}if(a){n.parameters??={};n.parameters.$$updateGroupId=r.INLINEEDIT_UPDATEGROUPID}return n},_internalUpdateBindingInfo:function(e,t){const n=e.getBindingContext("internal");Object.assign(t,this._computeRowBindingInfoFromTemplate(e));if(e.getRowBinding()){t.suspended=false}if(n){n.setProperty("dataReceivedAttached",false)}let i;const a=E.getAllFilterInfo(e);if(a.filters.length>0){i=new w({filters:a.filters,and:true})}if(a.bindingPath){t.path=a.bindingPath}const o=e.getDataStateIndicator();if(o&&o.isFiltering()){if(t.filters.length>0){i=new w({filters:t.filters.concat(a.filters),and:true});this.updateBindingInfoWithSearchQuery(t,a,i)}}else{this.updateBindingInfoWithSearchQuery(t,a,i)}this.addFilterOnActiveEntities(e,t)},updateBindingInfoWithSearchQuery:function(e,t,n){e.filters=n;e.parameters??={};if(t.search){e.parameters.$search=r.normalizeSearchTerm(t.search)}else{e.parameters.$search=undefined}},addFilterOnActiveEntities:function(e,t){const n=e.getPayload();if(n?.filterOnActiveEntities===true){const e=new w({path:"IsActiveEntity",operator:"EQ",value1:true});if(t.filters){t.filters=new w({filters:[e,t.filters],and:true})}else{t.filters=e}}},_templateSlotColumnFragment:async function(t,n,i,o){const r=(new DOMParser).parseFromString(a.renderAsXML(()=>k(o,t,false)),"text/xml");if(!r){return Promise.resolve(null)}const s=r.getElementsByTagName("slot")[0];if(t.template){if(s){const e=(new DOMParser).parseFromString(t.template,"text/xml");if(e.firstElementChild&&e.firstElementChild.nodeName!=="html"){s.replaceWith(e.firstElementChild)}else{s.remove()}}}else{e.error(`Please provide content inside this Building Block Column: ${t.header}`);return Promise.resolve(null)}const l=await O.process(r.firstElementChild,{models:{}},n.getController().getOwnerComponent().getPreprocessorContext());if(i?.targets!=="jsControlTree"){return l.firstElementChild}return M.load({type:"XML",definition:l,controller:n.getController()})},_getExportFormat:function(e){switch(e){case"Edm.Date":return u.getExcelDatefromJSDate();case"Edm.DateTimeOffset":return u.getExcelDateTimefromJSDateTime();case"Edm.TimeOfDay":return u.getExcelTimefromJSTime();default:return undefined}},_getVHRelevantFields:function(e,t,n){let i=[],a=e.getObject(t);if(a.$kind&&a.$kind==="Property"){a=e.getObject(`${t}@com.sap.vocabularies.UI.v1.DataFieldDefault`);t=`${t}@com.sap.vocabularies.UI.v1.DataFieldDefault`}switch(a.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":if(e.getObject(`${t}/Target/$AnnotationPath`).includes("com.sap.vocabularies.UI.v1.FieldGroup")){e.getObject(`${t}/Target/$AnnotationPath/Data`).forEach((n,a)=>{i=i.concat(this._getVHRelevantFields(e,`${t}/Target/$AnnotationPath/Data/${a}`))})}break;case"com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath":case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":case"com.sap.vocabularies.UI.v1.DataField":case"com.sap.vocabularies.UI.v1.DataFieldWithIntentBasedNavigation":case"com.sap.vocabularies.UI.v1.DataFieldWithAction":i.push(e.getObject(`${t}/Value/$Path`));break;case"com.sap.vocabularies.UI.v1.DataFieldForAction":case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":break;default:if(n&&t.indexOf(n)===0){i.push(t.substring(n.length+1));break}i.push(T.getNavigationPath(t,true));break}return i},_setDraftIndicatorOnVisibleColumn:function(e,t,n){const i=e.getBindingContext("internal");if(!i){return}const a=i.getPath();const o=t.filter(e=>this._bColumnHasPropertyWithDraftIndicator(e));const r=e.getColumns();let s,l,c,p;for(const e in r){l=r[e].getPropertyKey();for(const e in o){p=o[e].name;if(l===p){c=true;break}if(n&&n.name===p){s=n.name}}if(c){i.setProperty(a+z,l);break}}if(!c&&s){i.setProperty(a+z,s)}},removeItem:async function(e,t,n){let i=true;if(!t){return Promise.resolve(i)}const a=n.modifier;const o=await a.getProperty(t,"dataProperty");if(o&&o.includes&&o.includes("InlineXML")){a.insertAggregation(e,"dependents",t);i=false}if(e.isA&&a.targets==="jsControlTree"){this._setDraftIndicatorStatus(a,e,this.getColumnsFor(e))}return Promise.resolve(i)},_getMetaModel:function(e){return e.appComponent&&e.appComponent.getModel().getMetaModel()},_setDraftIndicatorStatus:function(e,t,n,i){if(e.targets==="jsControlTree"){this._setDraftIndicatorOnVisibleColumn(t,n,i)}},_getGroupId:function(e){return e||undefined},_insertAggregation:async function(e,t,n){if(e){return t.insertAggregation(n,"dependents",e,0)}return},addItem:async function(t,n,i){const o=this._getMetaModel(i),s=i.modifier,l=s.getId(t),c=t.isA?this.getColumnsFor(t):null,p=this._getTableAPI(t);if(!c){return Promise.resolve(null)}const d=c.find(function(e){return e.name===n});if(!d){e.error(`${n} not found while adding column`);return Promise.resolve(null)}if(d.availability==="Hidden"){e.warning(`Column for ${n} not added because it's hidden`);return Promise.resolve(null)}const u=t.getBindingContext("internal");u?.setProperty(J,true);this._setDraftIndicatorStatus(s,t,c,d);const f=await C.getCustomDataWithModifier(t,"metaPath",s);const g=o.createBindingContext(f);const h=i.view||r.getTargetView(t)||(i.appComponent?r.getCurrentPageView(i.appComponent):undefined);if(d.type==="Default"){e.error("Custom columns defined in the manifest are not supported when using a table building block.");throw new Error("Custom columns defined in the manifest are not supported when using a table building block.")}if(d.type==="Slot"){return this._templateSlotColumnFragment(d,h,s,l)}if(d.type==="Computed"){const e=this._getTableAPI(t).getTableDefinition().enableAnalytics;return $(l,d,g,e)}if(!o){return Promise.resolve(null)}let m=p.getEnhancedFetchedPropertyInfos();if(!m.length){await this.fetchProperties(t);m=p.getEnhancedFetchedPropertyInfos()}const y=m.find(function(e){return e.name===n});const b=o.createBindingContext(y.annotationPath);const P=async(e,r)=>{let c;let u;let h;return Promise.all([C.getCustomDataWithModifier(t,"displayModePropertyBinding",s),C.getCustomDataWithModifier(t,"tableType",s),C.getCustomDataWithModifier(t,"creationMode",s)]).then(async e=>{c=e[0];u=e[1];h=e[2];if(c!==undefined&&typeof c!=="boolean"){c=c==="true"}const t=new N({enableAutoColumnWidth:p.getTableDefinition().control.enableAutoColumnWidth,readOnly:c,tableType:u,id:l,navigationPropertyPath:n,columnInfo:d,collection:o.createBindingContext(f),creationMode:{name:h},widthIncludingColumnHeader:p.getTableDefinition().control.widthIncludingColumnHeader}),m={bindingContexts:{entitySet:g,collection:g,dataField:b,this:t.createBindingContext("/"),column:t.createBindingContext("/columnInfo")},models:{this:t,entitySet:o,collection:o,dataField:o,metaModel:o,column:t},appComponent:i.appComponent};const y=q(o.createBindingContext(p.tableDefinition.annotation.collection));const P=new U(p,{collectionEntity:y.targetObject,metaModel:o},p);const T=(new DOMParser).parseFromString(a.renderAsXML(()=>H(l,p,d,o.createBindingContext(f),P)??""),"text/xml");return C.templateControlFragment(T.firstElementChild,m,{view:r},s).finally(function(){t.destroy()})})};return P(y,h)},getFilterDelegate:function(){return Object.assign({apiVersion:2},I,{addItem:async function(e,t){if(t.indexOf("Property::")===0){t=t.replace("Property::","")}return I.addItem(e,t)}})},getTypeMap:function(){return R},formatGroupHeader(e,t,n){const i=this._getTableAPI(e).getEnhancedFetchedPropertyInfos();const a=i?.find(e=>e.name===n);const o=R.getTypeConfig(a?.dataType).baseType;const s=o==="DateTime"||o==="Date"||o==="Boolean"||o==="Numeric";let l;if(!t){l=j(r.getTargetView(e)).getText("M_TABLE_GROUP_HEADER_TITLE_VALUE");return j(e).getText("M_TABLE_GROUP_HEADER_TITLE",[a?.label,l])}if(a?.mode){switch(a.mode){case"Description":l=a.descriptionProperty?t.getProperty(a.descriptionProperty,s):null;break;case"DescriptionValue":l=p.formatWithBrackets(a.descriptionProperty?t.getProperty(a.descriptionProperty,s):null,a.valueProperty?t.getProperty(a.valueProperty,s):null);break;case"ValueDescription":l=p.formatWithBrackets(a.valueProperty?t.getProperty(a.valueProperty,s):null,a.descriptionProperty?t.getProperty(a.descriptionProperty,s):null);break;default:break}}else{l=a?.path?t.getProperty(a.path,s):null}if(l===null||l===""){l=j(r.getTargetView(e)).getText("M_TABLE_GROUP_HEADER_TITLE_VALUE")}return j(e).getText("M_TABLE_GROUP_HEADER_TITLE",[a?.label,l])}})},false);
//# sourceMappingURL=TableDelegate.js.map