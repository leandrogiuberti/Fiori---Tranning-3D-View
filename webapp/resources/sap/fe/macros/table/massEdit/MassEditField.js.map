{"version":3,"file":"MassEditField.js","names":["MassEditField","properties","context","this","isValid","select","createSelect","field","createField","_exports","_proto","prototype","getControls","controls","push","getFieldValues","selectedKey","getSelectedKey","selectedItem","selectItems","find","item","key","values","propertyValue","propertyUnitValue","bindingValue","getBindingContext","getProperty","propertyInfo","relativePath","getParent","getVisible","SpecificSelectKeys","ClearFieldValueKey","getFormattedValue","ReplaceKey","unitOrCurrencyValue","unitOrCurrencyPropertyPath","undefined","selectOptions","text","newValue","newPropertyValue","KeepKey","inputType","isReadOnlyOnContext","readOnlyInfo","readOnlyExpression","isReadOnly","isConstant","compileConstant","anyObject","Any","anyBoolean","compileExpression","setModel","getModel","setBindingContext","getBinding","getExternalValue","destroy","value","emptyValue","_jsx","Field","contextPath","metaPath","id","ID","generate","editMode","FieldEditMode","Editable","visible","change","handleFieldChange","bind","event","FieldRuntimeHelper","getFieldStateOnChange","state","isFieldValid","Select","items","map","selectItem","Item","required","isFieldRequired","handleSelectionChange","width","ariaLabelledBy","getSelectedItem","bindingContext","getKey","selectedValue","setVisible","includes","setSelectedKey","uniPropertyPath","setProperty","descriptionPath"],"sources":["./MassEditField.tsx"],"sourcesContent":["import type { PrimitiveType } from \"sap/fe/base/BindingToolkit\";\nimport { compileConstant, compileExpression, isConstant } from \"sap/fe/base/BindingToolkit\";\nimport Any from \"sap/fe/core/controls/Any\";\nimport * as ID from \"sap/fe/core/helpers/StableIdHelper\";\nimport Field from \"sap/fe/macros/Field\";\nimport type { MassFieldProperties } from \"sap/fe/macros/table/massEdit/library\";\nimport { SpecificSelectKeys } from \"sap/fe/macros/table/massEdit/library\";\nimport Select from \"sap/m/Select\";\nimport type UI5Event from \"sap/ui/base/Event\";\nimport type Control from \"sap/ui/core/Control\";\nimport Item from \"sap/ui/core/Item\";\nimport type FormElement from \"sap/ui/layout/form/FormElement\";\nimport type { Field$ChangeEvent } from \"sap/ui/mdc/Field\";\nimport FieldEditMode from \"sap/ui/mdc/enums/FieldEditMode\";\nimport type BaseContext from \"sap/ui/model/Context\";\nimport type PropertyBinding from \"sap/ui/model/PropertyBinding\";\nimport type Context from \"sap/ui/model/odata/v4/Context\";\nimport FieldRuntimeHelper from \"../../field/FieldRuntimeHelper\";\n\nexport default class MassEditField {\n\tprivate readonly select: Select;\n\n\tprivate readonly field: Field | undefined;\n\n\tprivate isValid = true;\n\n\t/**\n\t * Constructor of the MassEdit field.\n\t * @param properties The field properties\n\t * @param context Defines the Odata metamodel context used in the current MassEdit dialog\n\t */\n\tconstructor(\n\t\tpublic readonly properties: MassFieldProperties,\n\t\tprivate readonly context: BaseContext\n\t) {\n\t\tthis.context = context;\n\t\tthis.select = this.createSelect();\n\t\tthis.field = this.createField();\n\t}\n\n\t/**\n\t * Gets the inner controls.\n\t * @returns The controls\n\t */\n\tgetControls(): Control[] {\n\t\tconst controls: Control[] = [this.select];\n\t\tif (this.field) {\n\t\t\tcontrols.push(this.field);\n\t\t}\n\t\treturn controls;\n\t}\n\n\t/**\n\t * Gets the property and unit values of the mass edit field.\n\t * @returns The values\n\t */\n\tgetFieldValues(): Record<string, PrimitiveType> {\n\t\tconst selectedKey = this.select.getSelectedKey();\n\t\tconst selectedItem = this.properties.selectItems.find((item) => selectedKey === item.key);\n\t\tconst values: Record<string, PrimitiveType> = {};\n\t\tlet propertyValue: PrimitiveType = \"\";\n\t\tlet propertyUnitValue = \"\";\n\t\tconst bindingValue = this.field?.getBindingContext()?.getProperty(this.properties.propertyInfo.relativePath);\n\n\t\tif (!(this.select.getParent() as FormElement | undefined)?.getVisible() || !selectedItem) {\n\t\t\treturn {};\n\t\t}\n\t\tswitch (selectedItem.key) {\n\t\t\tcase SpecificSelectKeys.ClearFieldValueKey:\n\t\t\t\tpropertyValue = this.getFormattedValue(bindingValue);\n\t\t\t\tbreak;\n\t\t\tcase SpecificSelectKeys.ReplaceKey:\n\t\t\t\tif (this.field) {\n\t\t\t\t\t/**\n\t\t\t\t\t * If the value on the field comes from an existing entry into the select\n\t\t\t\t\t * the value to use is not the one into the bindingContext since it could contain the description\n\t\t\t\t\t * so FE has to retrieve the value from the select option.\n\t\t\t\t\t */\n\t\t\t\t\tconst unitOrCurrencyValue = this.properties.propertyInfo.unitOrCurrencyPropertyPath\n\t\t\t\t\t\t? this.field.getBindingContext()?.getProperty(this.properties.propertyInfo.unitOrCurrencyPropertyPath)\n\t\t\t\t\t\t: undefined;\n\t\t\t\t\tconst selectOptions = this.properties.selectItems.find(\n\t\t\t\t\t\t(item) =>\n\t\t\t\t\t\t\t(this.properties.propertyInfo.unitOrCurrencyPropertyPath &&\n\t\t\t\t\t\t\t\titem.propertyValue === bindingValue &&\n\t\t\t\t\t\t\t\titem.unitOrCurrencyValue === unitOrCurrencyValue) ||\n\t\t\t\t\t\t\t(!this.properties.propertyInfo.unitOrCurrencyPropertyPath && item.text === bindingValue)\n\t\t\t\t\t);\n\t\t\t\t\tconst newValue = selectOptions?.propertyValue ?? bindingValue;\n\t\t\t\t\tconst newPropertyValue = selectOptions?.unitOrCurrencyValue ?? unitOrCurrencyValue;\n\t\t\t\t\tif (newValue === null && newPropertyValue === null) {\n\t\t\t\t\t\treturn {}; // If the Field is empty we don't want to update the value\n\t\t\t\t\t}\n\t\t\t\t\tpropertyValue = this.getFormattedValue(newValue);\n\t\t\t\t\tpropertyUnitValue = newPropertyValue;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase SpecificSelectKeys.KeepKey:\n\t\t\t\treturn {};\n\t\t\tdefault:\n\t\t\t\tif (this.properties.inputType === \"CheckBox\") {\n\t\t\t\t\tpropertyValue = this.getFormattedValue(selectedItem.key);\n\t\t\t\t} else {\n\t\t\t\t\treturn {};\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t}\n\t\tvalues[this.properties.propertyInfo.relativePath] = propertyValue;\n\t\tif (this.properties.propertyInfo.unitOrCurrencyPropertyPath) {\n\t\t\tvalues[this.properties.propertyInfo.unitOrCurrencyPropertyPath] = propertyUnitValue;\n\t\t}\n\t\treturn values;\n\t}\n\n\t/**\n\t * Checks if the targeted property is read only on the specified context.\n\t * @param context The row context\n\t * @returns True if the field is readonly on this context, false otherwise.\n\t */\n\tpublic isReadOnlyOnContext(context: Context): boolean {\n\t\tconst readOnlyInfo = this.properties.readOnlyExpression;\n\t\tlet isReadOnly = false;\n\t\tif (isConstant(readOnlyInfo)) {\n\t\t\tisReadOnly = compileConstant(readOnlyInfo, false, undefined, true) as boolean;\n\t\t} else {\n\t\t\t// We evaluate the value of the expression via a UI5 managed object instance.\n\t\t\tconst anyObject = new Any({ anyBoolean: compileExpression(readOnlyInfo) });\n\t\t\tanyObject.setModel(context.getModel());\n\t\t\tanyObject.setBindingContext(context);\n\t\t\tisReadOnly = (anyObject.getBinding(\"anyBoolean\") as PropertyBinding)?.getExternalValue();\n\t\t\tanyObject.destroy();\n\t\t}\n\t\treturn isReadOnly;\n\t}\n\n\t/**\n\t * Gets the formatted value.\n\t * @param value The raw value\n\t * @returns The formatted value.\n\t */\n\tprivate getFormattedValue(value?: PrimitiveType): PrimitiveType {\n\t\tif (this.properties.inputType === \"CheckBox\") {\n\t\t\treturn value === \"true\";\n\t\t}\n\t\treturn value ?? this.properties.propertyInfo.emptyValue;\n\t}\n\n\t/**\n\t * Create the inner field.\n\t * @returns The field if needed, undefined otherwise.\n\t */\n\tprivate createField(): Field | undefined {\n\t\tif (this.properties.inputType !== \"CheckBox\") {\n\t\t\treturn (\n\t\t\t\t<Field\n\t\t\t\t\tcontextPath={this.context as unknown as string}\n\t\t\t\t\tmetaPath={this.properties.propertyInfo.relativePath as unknown as string}\n\t\t\t\t\tid={ID.generate([\"MED_\", this.properties.propertyInfo.key, \"_Field\"])}\n\t\t\t\t\teditMode={FieldEditMode.Editable}\n\t\t\t\t\tvisible={false}\n\t\t\t\t\tchange={this.handleFieldChange.bind(this)}\n\t\t\t\t/>\n\t\t\t);\n\t\t}\n\t}\n\n\tprivate handleFieldChange(event: Field$ChangeEvent): void {\n\t\tthis.isValid = !!FieldRuntimeHelper.getFieldStateOnChange(event as Field$ChangeEvent & UI5Event<{ isValid: boolean }>).state[\n\t\t\t\"validity\"\n\t\t];\n\t}\n\n\tpublic isFieldValid(): boolean {\n\t\treturn this.isValid;\n\t}\n\n\t/**\n\t * Create the inner select.\n\t * @returns The select.\n\t */\n\tprivate createSelect(): Select {\n\t\treturn (\n\t\t\t<Select\n\t\t\t\tid={ID.generate([\"MED_\", this.properties.propertyInfo.key])}\n\t\t\t\titems={this.properties.selectItems.map((selectItem) => (\n\t\t\t\t\t<Item key={selectItem.key} text={selectItem.text} />\n\t\t\t\t))}\n\t\t\t\trequired={this.properties.isFieldRequired}\n\t\t\t\tchange={this.handleSelectionChange.bind(this)}\n\t\t\t\twidth=\"100%\"\n\t\t\t\tariaLabelledBy={[ID.generate([\"MED_\", this.properties.propertyInfo.key, \"Label\"])]}\n\t\t\t/>\n\t\t);\n\t}\n\n\t/**\n\t * Manages the selection change through the drop down.\n\t */\n\tprivate handleSelectionChange(): void {\n\t\tconst selectedItem = this.select.getSelectedItem();\n\t\tif (this.field && selectedItem) {\n\t\t\tthis.isValid = true;\n\t\t\tconst bindingContext = this.field.getBindingContext();\n\t\t\tconst key = selectedItem.getKey();\n\t\t\tlet selectedValue;\n\t\t\tthis.field.setVisible(\n\t\t\t\t![SpecificSelectKeys.KeepKey, SpecificSelectKeys.ClearFieldValueKey].includes(selectedItem.getKey() as SpecificSelectKeys)\n\t\t\t);\n\n\t\t\tif (!(key in SpecificSelectKeys)) {\n\t\t\t\tselectedValue = this.properties.selectItems.find((item) => item.key === key);\n\t\t\t\tthis.select.setSelectedKey(SpecificSelectKeys.ReplaceKey);\n\t\t\t}\n\t\t\t/**\n\t\t\t * Sets the value on the field.\n\t\t\t * This value has to include the description if needed.\n\t\t\t */\n\t\t\tif (bindingContext) {\n\t\t\t\tconst uniPropertyPath = this.properties.propertyInfo.unitOrCurrencyPropertyPath;\n\t\t\t\tbindingContext.setProperty(\n\t\t\t\t\tthis.properties.propertyInfo.relativePath,\n\t\t\t\t\tthis.properties.descriptionPath ? selectedValue?.text : selectedValue?.propertyValue\n\t\t\t\t);\n\t\t\t\tif (uniPropertyPath) {\n\t\t\t\t\tbindingContext.setProperty(uniPropertyPath, selectedValue?.unitOrCurrencyValue);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n"],"mappings":"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","ignoreList":[]}