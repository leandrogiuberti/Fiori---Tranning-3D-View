/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/converters/ManifestSettings","sap/fe/core/helpers/PromiseKeeper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/library","sap/m/Button","sap/m/Dialog","sap/m/Label","sap/m/MessageBox","sap/m/MessageStrip","sap/m/MessageToast","sap/ui/core/Fragment","sap/ui/core/Lib","sap/ui/core/util/XMLPreprocessor","sap/ui/layout/form/Form","sap/ui/layout/form/FormContainer","sap/ui/layout/form/FormElement","sap/ui/layout/form/ResponsiveGridLayout","sap/ui/model/json/JSONModel","./MassEditField","./MassEditSideEffects","sap/fe/base/jsx-runtime/jsx","sap/fe/base/jsx-runtime/Fragment","sap/fe/base/jsx-runtime/jsxs"],function(e,t,s,i,n,o,r,a,l,d,c,h,g,u,p,f,m,M,C,E,x,b,S,w,_,y,T){"use strict";var P={};var O=i.OperationGroupingMode;let v=function(){function i(e){this.requiredDataPromise=new n;this.updatedProperties=new Set;this.dialog=undefined;this.table=e.table;this.contexts=e.contexts;this.isAdaptation=t.getAppComponent(this.table).isAdaptationMode();this.fieldProperties=e.fieldProperties;this.view=t.getTargetView(this.table);this.transientListBinding=this.generateListBinding();this.bindingContext=this.transientListBinding.create({},true);this.resourceModel=o.getResourceModel(this.table);this.contextsOnError=[];this.fieldControls=[]}P=i;var v=i.prototype;v.generateListBinding=function e(){const t=this.table.getRowBinding();const s=this.table.getModel().bindList(t.getPath(),t.getContext(),[],[],{$$updateGroupId:"submitLater"});s.refreshInternal=()=>{};return s};v.create=async function e(){if(!this.dialog){const e=f.getResourceBundleFor("sap.fe.core");const t=this.view.getViewData().converterType==="ListReport"?this.resourceModel.getText("C_MASS_EDIT_SAVE_BUTTON_TEXT"):e.getText("C_COMMON_DIALOG_OK");const s=await this.createContent();const i=_(d,{"dt:designtime":"sap/fe/macros/table/massEdit/designtime/MassEdit.designtime",id:r.generate([this.table.getId(),"MED_","Dialog"]),contentWidth:"27rem",class:"sapUiContentPadding",horizontalScrolling:"false",title:this.resourceModel.getText("C_MASS_EDIT_DIALOG_TITLE",[this.contexts.length.toString()]),content:s,escapeHandler:this.onClose.bind(this),beforeOpen:this.beforeOpen.bind(this),beginButton:_(l,{text:t,type:"Emphasized",press:this.onApply.bind(this)}),endButton:_(l,{text:e.getText("C_COMMON_OBJECT_PAGE_CANCEL"),press:this.onClose.bind(this)})});this.dialog=i;i.setModel(new b({isEditable:true}),"ui");i.bindElement({path:"/",model:"ui"});return i}return this.dialog};v.beforeOpen=function e(t){const s=t.getSource();s.setModel(this.table.getModel());s.setBindingContext(this.bindingContext);this.table.addDependent(s)};v.onClose=function e(){this.transientListBinding.destroy();if(this.dialog){this.dialog.close();this.dialog.destroy()}};v.getRequiredDataPromise=function e(){return this.requiredDataPromise};v.manageMessage=async function e(){const i=f.getResourceBundleFor("sap.fe.core");const n=this.view.getController();const o=a.DraftStatus;const r=this.view.getBindingContext("internal");r?.setProperty("getBoundMessagesForMassEdit",true);await n.messageHandler.showMessages({onBeforeShowMessage:(e,i)=>{i.fnGetMessageSubtitle=s.setMessageSubtitle.bind({},this.table,this.contexts);if(!this.contextsOnError.length){if(this.updatedProperties.size>0){n.editFlow.setDraftStatus(o.Saved);if(this.view.getViewData().converterType==="ListReport"){u.show(this.resourceModel.getText("C_MASS_EDIT_SUCCESS_TOAST"))}else{u.show(this.resourceModel.getText("C_OBJECT_PAGE_MASS_EDIT_SUCCESS_TOAST"))}}else{u.show(this.resourceModel.getText("C_MASS_EDIT_NO_CHANGE"))}}else if(this.contextsOnError.length<this.contexts.length){n.editFlow.setDraftStatus(o.Saved)}else if(this.contextsOnError.length===this.contexts.length){n.editFlow.setDraftStatus(o.Clear)}if(t.getIsEditable(n)&&!e.some(e=>!e.getTargets())){i.showMessageBox=false;i.showMessageDialog=false}return i}});if(!!this.contextsOnError.length&&this.contextsOnError.length<this.contexts.length){const e=i.getText("C_COMMON_DIALOG_OK");h.success(this.resourceModel.getText("C_MASS_EDIT_CHANGES_WITH_ERROR",[this.contexts.length-this.contextsOnError.length,this.contexts.length]),{actions:[e],emphasizedAction:e})}r?.setProperty("getBoundMessagesForMassEdit",false)};v.saveChanges=async function t(s){const i=this.table.getParent().getTableDefinition().control.massEdit;const n=i.operationGroupingMode===O.Isolated;const o="$auto.Isolated";const r=new w(this);const a=[];const l=this.table.getModel();if(n){l.setContinueOnError(o)}this.contexts.forEach(t=>{const i=[];const d=[];for(const{control:r,values:l}of s.fieldControlReference){let s=false;if(!r.isReadOnlyOnContext(t)){const c=n?o:"$auto";for(const n in l){if(t.getProperty(n)!==l[n]){s=true;a.push(t.setProperty(n,l[n],c).then(()=>this.updatedProperties.add(n)).catch(s=>{this.contextsOnError.push(t);e.error("Mass Edit: Something went wrong in updating entries.",s)}));i.push({propertyPath:n,groupId:c})}}if(s){d.push({control:r,groupId:c})}}}a.push(...i.map(async e=>r.executeImmediateSideEffects(t,e.propertyPath,e.groupId)));a.push(...d.map(async e=>r.refreshDescription(e.control,t,e.groupId)));if(n){l.submitBatch(o)}});await Promise.allSettled(a);if(this.updatedProperties.size){r.executeDeferredSideEffects(new Set(["genericField",...Array.from(this.updatedProperties)]))}};v.getFieldValuesInfos=function e(){const t={values:{},fieldControlReference:[]};for(const e of this.fieldControls){const s=e.getFieldValues();t.values={...t.values,...s};t.fieldControlReference.push({control:e,values:s})}return t};v.applyChanges=async function t(){await this.requiredDataPromise.promise;this.view.getBindingContext("internal")?.setProperty("skipPatchHandlers",true);const s=this.getFieldValuesInfos();let i=false;try{i=await this.view.getController().editFlow.customMassEditSave({aContexts:this.contexts,oUpdateData:s.values})}catch(t){e.error("Mass Edit: Something went wrong in updating entries.",t)}if(!i){await this.saveChanges(s)}this.view.getBindingContext("internal")?.setProperty("skipPatchHandlers",false);return i};v.onApply=async function e(){if(this.fieldControls.some(e=>!e.isFieldValid())){return}if(!this.isAdaptation){s.removeBoundTransitionMessages();s.removeUnboundTransitionMessages();const e=await this.applyChanges();if(!e){this.manageMessage()}}this.onClose()};v.createContent=async function e(){const t=await this.createCustomContainer();return T(y,{children:[this.getAdaptationMessage(),_(M,{children:{layout:_(x,{labelSpanM:"12",labelSpanL:"12",labelSpanXL:"12"}),formContainers:T(y,{children:[t,_(C,{children:{formElements:this.createFormElements()}})]})}})]})};v.getAdaptationMessage=function e(){if(this.isAdaptation){return _(g,{text:this.resourceModel.getText("C_MASS_EDIT_ADAPTATION_MODE")})}return undefined};v.createCustomContainer=async function e(){const t=this.table.getParent().getTableDefinition().control.massEdit;if(t.customFragment){if(t.fromInline===true){if(typeof t.customFragment==="string"){const e=await m.process((new DOMParser).parseFromString(t.customFragment,"text/xml").firstElementChild,{models:{}},this.view.getController().getOwnerComponent().getPreprocessorContext());return await p.load({type:"XML",definition:e,controller:this.view.getController()})}else{return t.customFragment.clone()}}return await this.view.getController().getExtensionAPI().loadFragment({id:"customMassEdit",name:t.customFragment,contextPath:this.transientListBinding.getModel().getMetaModel().getMetaPath(this.transientListBinding.getResolvedPath())})}return undefined};v.createFormElements=function e(){return this.fieldProperties.map(this.createFormElement.bind(this))};v.createFormElement=function e(t){return _(E,{visible:t.visible,children:{label:_(c,{text:t.label,id:r.generate(["MED_",t.propertyInfo.key,"Label"])}),fields:this.createFields(t)}})};v.createFields=function e(t){const s=this.table.getModel().getMetaModel();const i=s.createBindingContext(s.getMetaPath(this.bindingContext.getPath()));const n=new S(t,i);this.fieldControls.push(n);return n.getControls()};return i}();P=v;return P},false);
//# sourceMappingURL=MassEditDialog.js.map