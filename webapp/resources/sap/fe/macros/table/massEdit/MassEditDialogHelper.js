/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/fe/base/BindingToolkit","sap/fe/core/CommonUtils","sap/fe/core/controls/Any","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/annotations/DataField","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/DisplayModeFormatter","sap/fe/core/templating/FieldControlHelper","sap/fe/core/templating/PropertyHelper","sap/fe/core/templating/UIFormatters","sap/fe/macros/field/FieldTemplating","sap/m/MessageBox","sap/ui/core/Component","sap/ui/core/Lib","sap/ui/mdc/enums/FieldEditMode","sap/ui/model/BindingMode","./MassEditDialog","./library","sap/fe/base/jsx-runtime/jsx"],function(e,t,i,n,s,o,a,r,l,d,c,g,p,u,f,h,y,m,x,E,T,C,M,b){"use strict";var P={};var _=M.SpecificSelectKeys;var A=h.setEditStyleProperties;var I=h.getTextBinding;var D=f.isVisible;var S=f.isMultiValueField;var F=f.getRequiredExpression;var v=f.getEditMode;var O=u.hasValueHelp;var B=u.getAssociatedUnitPropertyPath;var R=u.getAssociatedUnitProperty;var w=u.getAssociatedTextPropertyPath;var L=u.getAssociatedCurrencyPropertyPath;var V=p.isReadOnlyExpression;var N=g.getDisplayMode;var k=c.getRelativePaths;var U=c.getContextRelativeTargetObjectPath;var z=c.enhanceDataModelPath;var j=d.isProperty;var H=a.isDataFieldTypes;var G=o.getInvolvedDataModelObjects;var q=o.convertMetaModelContext;var K=i.pathInModel;var $=i.getExpressionFromAnnotation;var W=i.formatWithTypeInformation;var X=i.constant;var Y=i.compileExpression;let Q=function(){function i(e){this.maxAnalyzedRows=30;this.analyzedContexts=[];this.fieldProperties=[];const t=e.table.getParent().getTableDefinition().annotation.collection,i=e.table.getModel().getMetaModel();this.table=e.table;this.manifestSettings=this.table.getParent().getTableDefinition().control.massEdit;this.onContextMenu=e.onContextMenu;this.onDialogClose=e.onClose;this.view=n.getTargetView(this.table);this.contexts=this.fetchContextsForEdit();this.degradedMode=this.contexts.length>this.maxAnalyzedRows;this.analyzedContexts=this.degradedMode?this.contexts.slice(0,this.maxAnalyzedRows):this.contexts;this.isAdaptation=n.getAppComponent(this.table).isAdaptationMode();this.headerInfo=G(i.getContext(t)).targetEntityType.annotations.UI?.HeaderInfo}P=i;var o=i.prototype;o.open=async function t(){try{const t=m.getOwnerComponentFor(this.view);const i=this.table.getBindingContext("internal"),n=!this.onContextMenu?"numberOfSelectedContexts":"contextmenu/numberOfSelectedContexts",s=i.getProperty(n)||0;this.fieldProperties=await this.getFieldsPropertiesFromInfo(this.getFieldsInfo());if(!this.isAdaptation){if(!this.fieldProperties.some(e=>e.visible)){this.noFieldInformation();return}if(this.contexts.length!==s){this.contexts=await this.confirmSelection(this.contexts,s);if(!this.contexts.length){this.onDialogClose?.();return}}}await t.runAsOwner(async()=>{this.massEditDialog=new C({table:this.table,contexts:this.contexts,fieldProperties:this.fieldProperties});const t=await this.massEditDialog.create();t.attachBeforeClose(()=>{this.onDialogClose?.()});t.open();const i=this.massEditDialog.getRequiredDataPromise();try{await this.getDataAfterOpeningDialog(this.fieldProperties);i.resolve()}catch(t){e.error("Mass Edit: Something went wrong in mass edit dialog to get required data.",t);i.reject()}})}catch(t){e.error("Mass Edit: Something went wrong in mass edit dialog creation.",t)}};o.noFieldInformation=function e(){const t=this.table.getParent().getTableDefinition().control.massEdit.visibleFields;const i=x.getResourceBundleFor("sap.fe.macros");let n="",s;if(t.length>0){n=i.getText("C_MASS_EDIT_NO_EDITABLE_FIELDS_WITH_MANIFEST",[this.getResourceText(this.headerInfo?.TypeName)??i.getText("C_MASS_EDIT_DIALOG_DEFAULT_TYPENAME")]);s=`<ul>\n\t\t\t${this.fieldProperties.reduce((e,i)=>{if(t.includes(i.propertyInfo.relativePath)){e.push(`<li>${i.label}</li>`)}return e},[]).join("")} </ul>`}else{n=i.getText("C_MASS_EDIT_NO_EDITABLE_FIELDS_DEFAULT")}y.information(n,{details:s,onClose:()=>{this.onDialogClose?.()}})};o.confirmSelection=async function t(i,n){const s=l.getResourceModel(this.table);const o=x.getResourceBundleFor("sap.fe.core");const a=i.length;return new Promise(t=>{try{const e=this.table.getParent();const l=s.getText("C_MASS_EDIT_CONFIRM_BUTTON_TEXT"),d=o.getText("C_COMMON_OBJECT_PAGE_CANCEL"),c=this.table.getModel().getMetaModel(),g=this.getResourceText(this.headerInfo?.TypeName)??s.getText("C_MASS_EDIT_DIALOG_DEFAULT_TYPENAME"),p=this.getResourceText(this.headerInfo?.TypeNamePlural)??s.getText("C_MASS_EDIT_DIALOG_DEFAULT_TYPENAME_PLURAL"),u=r.isDraftSupported(c,this.table.data("targetCollectionPath"))&&e.readOnly?this.getMessageDetailForNonEditable(g,p):"";y.warning(s.getText("C_MASS_EDIT_CONFIRM_MESSAGE",[n-a,n,a,p]),{details:u,actions:[l,d],emphasizedAction:l,onClose:function(e){t(e===l?i:[])}})}catch(t){e.error(t)}})};o.getResourceText=function e(t){if(!t){return undefined}return n.getTranslatedTextFromExpBindingString(Y($(t)),this.view)?.toLocaleLowerCase()};o.getMessageDetailForNonEditable=function e(t,i){const n=x.getResourceBundleFor("sap.fe.macros");return`<p><strong>${n.getText("C_MASS_EDIT_CONFIRM_MESSAGE_DETAIL_HEADER")}</strong></p>\n\n\t\t\t<p>${n.getText("C_MASS_EDIT_CONFIRM_MESSAGE_DETAIL_REASON",[i])}</p>\n\n\t\t\t<ul>\n\t\t\t\t<li>${n.getText("C_MASS_EDIT_CONFIRM_MESSAGE_DETAIL_REASON_DRAFT",[t])}</li>\n\t\t\t\t<li>${n.getText("C_MASS_EDIT_CONFIRM_MESSAGE_DETAIL_REASON_NON_EDITABLE",[t])}</li>\n\t\t\t</ul>`};o.getEntityFieldsInfo=function e(){const t=this.table.getParent();const i=t.getTableDefinition().columns;const n=new Set(i.reduce((e,t)=>{if(t.type==="Annotation"){e.push(t.name)}return e},[]));return this.transformPathsToInfo(n)};o.getFieldsInfo=function e(){const t=this.manifestSettings.visibleFields.length>0?new Set(this.manifestSettings.visibleFields):new Set(this.table.getColumns().map(e=>e.getPropertyKey()));if(this.manifestSettings.ignoredFields.length>0){for(const e of this.manifestSettings.ignoredFields){t.delete(e)}}return this.transformPathsToInfo(t)};o.transformPathsToInfo=function e(t){return Array.from(t).reduce((e,t)=>{const i=this.getFieldInfo(t);if(i){e.push(i)}return e},[])};o.getFieldInfo=function e(t){const i=this.table.getParent().getTableDefinition().columns;const n=this.table.getModel().getMetaModel();const s=n.getMetaPath(this.table.data("metaPath"));const o=G(n.getContext(s));const a=i.find(e=>e.name===t&&e.type==="Annotation");if(a){const e=a.annotationPath;if(e&&t){const i=z(o,t);const s=q(n.getContext(e));const r=this.getCompliantProperty(i,s);if(r&&o.targetEntityType.entityProperties.includes(r))return{key:a.key,propertyDataModel:i,targetProperty:r,label:a.label??a.key,convertedAnnotation:s}}}return undefined};o.getCompliantProperty=function e(t,i){const n=t.targetObject;let s;if(j(n)){s=n;if(n.annotations.UI?.IsImageURL){return}}else if(H(i)&&!i.hasOwnProperty("Action")){s=i.Value.$target}else{return}const o=R(s);if(S(t)||O(s)&&s.annotations?.Common?.ValueListRelevantQualifiers||o&&O(o)&&o.annotations?.Common?.ValueListRelevantQualifiers){return}return s};o.isHiddenForContexts=function e(t){if(t==="true"){return false}else if(t==="false"){return true}const i=b(s,{anyBoolean:t});i.setModel(this.analyzedContexts[0].getModel());const n=!this.analyzedContexts.find(e=>{i.setBindingContext(e);return i.getBinding("anyBoolean").getExternalValue()});i.destroy();return n};o.fetchContextsForEdit=function e(){const t=this.table.getBindingContext("internal"),i=!this.onContextMenu?"updatableContexts":"contextmenu/updatableContexts";return t?.getProperty(i)??[]};o.getFieldProperties=function e(){return t(this.fieldProperties)};o.getFieldsPropertiesFromInfo=async function e(t){const i=[];for(const e of t){const{targetProperty:t,propertyDataModel:n,convertedAnnotation:s}=e;const o=U(n);if(o){const a=B(t)||L(t);const r=this.getInputType(s,n);if(r&&n.targetObject){const l=k(n);const d={visibilityBindings:{isVisible:Y(D(s)),editMode:v(t,n,false,false,s,X(true))},visible:true,label:e.label||t.annotations.Common?.Label||o,isFieldRequired:F(t,s,true,false,{},n),descriptionPath:w(n.targetObject),textBinding:{expression:I(n,{displayMode:N(t,n)}),type:t.type==="Edm.DateTimeOffset"||t?.annotations?.Common?.IsTimezone?"anyText":"any"},readOnlyExpression:V(t,l),inputType:r,propertyInfo:{clearable:this.isPropertyClearable(t),emptyValue:this.getEmptyValueForProperty(t,o),key:e.key,relativePath:o,unitOrCurrencyPropertyPath:a},selectItems:[]};i.push(d)}}}await this.getDataForOpeningDialog(i);await Promise.all(i.map(async e=>{e.visible=this.manifestSettings.visibleFields.length===0?this.isFieldVisible(e):true;const t=!this.isAdaptation?await this.getRuntimeSelection(e):[];e.selectItems=[...this.getDefaultSelectOptions(e),...t]}));return i};o.generateFieldsProperties=async function e(){return this.getFieldsPropertiesFromInfo(this.getFieldsInfo())};o.generateEntityFieldsProperties=async function e(){return this.getFieldsPropertiesFromInfo(this.getEntityFieldsInfo())};o.getDataAfterOpeningDialog=async function e(t){if(this.degradedMode){const e=this.contexts.slice(this.maxAnalyzedRows,this.contexts.length);const i=[].concat(...t.map(t=>[{expression:Y(t.readOnlyExpression),contexts:this.contexts},{expression:Y(K(t.propertyInfo.relativePath)),contexts:e,type:t.textBinding.type},{expression:Y(K(t.propertyInfo.unitOrCurrencyPropertyPath)),contexts:e}]));await this.getMissingData(i)}};o.getDataForOpeningDialog=async function e(t){const i=[].concat(t.reduce((e,t)=>{e=e.concat([{expression:t.textBinding.expression,type:t.textBinding.type},{expression:Y(K(t.propertyInfo.relativePath)),type:t.textBinding.type},{expression:Y(K(t.propertyInfo.unitOrCurrencyPropertyPath))}]);if(!this.manifestSettings.visibleFields.length){e=e.concat([{expression:t.visibilityBindings.isVisible},{expression:t.visibilityBindings.editMode}])}if(!this.degradedMode){e.push({expression:Y(t.readOnlyExpression)})}return e},[]));await this.getMissingData(i)};o.getMissingData=async function e(t){if(this.isAdaptation){return}if(this.view.getViewData().converterType==="ObjectPage"){const e=this.table.getColumns().map(e=>e.getPropertyKey());if(this.manifestSettings.visibleFields.every(t=>e.includes(t))){return}}const i=[];const n=[];const o=this.contexts[0].getModel();for(const e of t.filter(e=>e.expression?.startsWith("{"))){const t={};const a=e.contexts??this.analyzedContexts;const r=e.type??"any";t[r]=e.expression;for(const e of a){const a=b(s,{...t});a.setModel(o);a.setBindingContext(e);n.push(a);i.push(async()=>{const e=a.getBinding(r);if(e){e.setBindingMode(T.OneTime);if(e.isA("sap.ui.model.CompositeBinding")){await Promise.all(e.getBindings().map(e=>e.requestValue?.()))}else{await(e.requestValue?.())}}})}}await Promise.all(i.map(async e=>e()));for(const e of n){e.destroy()}};o.getEmptyValueForProperty=function e(t,i){if(t.nullable!==false){return null}else{const e=this.contexts[0];const n=b(s,{any:Y(W(t,K(i)))});n.setModel(e.getModel());n.setBindingContext(e);const o=n.getBindingInfo("any").binding.getType().parseValue("","string");n.destroy();return o}};o.isPropertyClearable=function e(t){if(t.nullable!==false){return true}else{return!["Edm.DateTime","Edm.DateTimeOffset","Edm.TimeOfDay","Edm.Time","Edm.Date","Edm.DateTimeWithTimezone"].includes(t.type)}};o.getRuntimeSelection=async function e(t){const i=new Set;const n=[];if(t.inputType==="CheckBox"){return[]}const o=b(s,{anyText:t.textBinding.expression});o.setModel(this.contexts[0].getModel());for(const e of this.analyzedContexts){o.setBindingContext(e);const s=o.getBinding("anyText");if(s?.isA("sap.ui.model.CompositeBinding")){s.setBindingMode(T.OneTime);await Promise.all(s.getBindings().map(e=>e.requestValue?.()))}const a=o.getBinding("anyText")?.getExternalValue();if(a&&!i.has(a)){i.add(a);n.push({text:a,key:a,unitOrCurrencyValue:t.propertyInfo.unitOrCurrencyPropertyPath?e.getObject(t.propertyInfo.unitOrCurrencyPropertyPath):"",propertyValue:e.getObject(t.propertyInfo.relativePath)})}}o.destroy();return n};o.getDefaultSelectOptions=function e(t){const i=x.getResourceBundleFor("sap.fe.macros");const n={text:i.getText("C_MASS_EDIT_COMBOBOX_KEEP_VALUES"),key:_.KeepKey};const s=[];s.push(n);if(t.inputType==="CheckBox"){s.push({text:i.getText("yes"),key:"true"},{text:i.getText("no"),key:"false"})}else{s.push({text:i.getText("C_MASS_EDIT_COMBOBOX_REPLACE_VALUES"),key:_.ReplaceKey});if(t.isFieldRequired!=="true"&&t.propertyInfo.clearable){s.push({text:i.getText("C_MASS_EDIT_COMBOBOX_CLEAR_VALUES"),key:_.ClearFieldValueKey})}}return s};o.getFieldEditable=function e(t){if(t===E.Editable){return true}else if(Object.keys(E).includes(t)){return false}else if(t){const e=b(s,{any:t});const i=this.analyzedContexts[0].getModel();e.setModel(i);const n=this.analyzedContexts.some(t=>{e.setBindingContext(t);return e.getBinding("any").getExternalValue()===E.Editable});e.destroy();return n}else{return true}};o.getInputType=function e(t,i){const n={};A(n,t,i,true);return n?.editStyle};o.isFieldVisible=function e(t){if(this.isAdaptation||this.manifestSettings.visibleFields.length&&this.degradedMode){const e=Object.keys(E).includes(t.visibilityBindings.editMode);const i=!e||e&&t.visibilityBindings.editMode===E.Editable;return i&&t.visibilityBindings.isVisible!=="false"}return this.getFieldEditable(t.visibilityBindings.editMode)&&!this.isHiddenForContexts(t.visibilityBindings.isVisible)};return i}();P=Q;return P},false);
//# sourceMappingURL=MassEditDialogHelper.js.map