/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controllerextensions/editFlow/TransactionHelper","sap/fe/core/converters/ManifestSettings","sap/fe/core/converters/MetaModelConverter","sap/ui/core/Lib","sap/ui/core/Messaging","sap/ui/core/message/Message","sap/ui/core/message/MessageType"],function(e,t,n,i,o,s,a,r,c,l){"use strict";var g={};var d=s.getInvolvedDataModelObjects;var f=o.CreationMode;var u=n.Activity;let h=function(){function n(){}g=n;var o=n.prototype;o.setupMixin=function e(t){};o._onFieldLiveChange=function e(t){const n=t.getSource(),i=n.getBindingContext(),o=i.getBinding();if(i.isInactive()){const e=this?.getContent();this?.createEmptyRows(o,e,true)}};o._handleCreateActivate=async function n(i){const o=i.getParameter("context");this.createEmptyRows(i.getSource(),this.getContent(),true);if(!this.validateEmptyRow(o)){i.preventDefault();return}try{const n=o.getPath(),i=t.getTargetView(this),s=i.getController(),a=s.editFlow;try{await(o.created()??Promise.resolve());await a.onAfterCreate({context:o})}catch(t){e.warning(`Failed to activate context ${o.getPath()}`);return}const r=o.getPath();const c=i.getController().collaborativeDraft;c.send({action:u.Create,content:r});c.updateLocksForContextPath(n,o.getPath())}catch(t){e.error("Failed to activate new row -",t)}};o.getDefaultValuesFunction=function e(t){const n=t.getModel();const i=n.getMetaModel();const o=i.getMetaContext(t.getResolvedPath());const s=d(o);const a=s.targetObject.annotations.Common?.DefaultValuesFunction;const r=s.targetEntitySet?.annotations.Common?.DefaultValuesFunction;return a??r};o.setEmptyRowsEnabled=function n(i){this.setProperty("emptyRowsEnabled",i);const o=this.getContent().data().navigationPath,s=t.getAppComponent(this.getContent());if(i){const e=this.getContent().getRowBinding();const t=e?.getResolvedPath()?this.getDefaultValuesFunction(e):undefined;if(t){s.getSideEffectsService().registerTargetCallback(o,this.updateEmptyRows.bind(this))}}else{s.getSideEffectsService().deregisterTargetCallback(o)}if(this.tableDefaultsPromise){this.tableDefaultsPromise.then(e=>{this.setUpEmptyRows(this.getContent(),false,e);return e}).catch(t=>{e.error("Error while setting up empty rows:",t)})}else{this.setUpEmptyRows(this.getContent())}};o.updateEmptyRows=async function e(){const t=this.getContent();const n=t.getRowBinding();const i=n.getHeaderContext();if(n&&n.isResolved()&&n.isLengthFinal()&&i){const e=i.getPath();this._deleteEmptyRows(n,e);await this.createEmptyRows(n,t)}return};o._validateAndRetrieveBinding=async function e(t){if(this.getTableDefinition().control?.creationMode!==f.InlineCreationRows){return undefined}const n=t.getModel("ui");if(!n){return undefined}if(n.getProperty("/isEditablePending")){const e=n.bindProperty("/isEditablePending");await new Promise(t=>{const n=()=>{e.detachChange(n);e.destroy();t()};e.attachChange(n)})}const i=t.getRowBinding();if(!i){return undefined}return i};o.getTableDefaults=async function e(n){const o=await this._validateAndRetrieveBinding(n);if(!o)return undefined;const s=t.getAppComponent(t.getTargetView(n));return s?i.getDataFromDefaultValueFunction(o,s):undefined};o.setUpEmptyRows=async function e(n){let i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;let o=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};const s=await this._validateAndRetrieveBinding(n);if(!s){return}const a=s.getHeaderContext();if(s&&s.isResolved()&&s.isLengthFinal()&&a){const e=a.getPath();if(!this.emptyRowsEnabled){this.removeEmptyRowsMessages();return this._deleteEmptyRows(s,e)}if(!t.getIsEditable(n)){return}if(this.getTableDefinition().control?.inlineCreationRowsHiddenInEditMode&&!n.getBindingContext("pageInternal")?.getProperty("createMode")&&!i){return}const r=s.getAllCurrentContexts().find(function(t){return t.isInactive()&&t.getPath().startsWith(e)});if(!r){this.removeEmptyRowsMessages();await this.createEmptyRows(s,n,false,undefined,false,o)}}};o._deleteEmptyRows=function e(t,n){for(const e of t.getAllCurrentContexts()){if(e.isInactive()&&e.getPath().startsWith(n)){e.delete()}}};o.getInactiveContextNumber=function e(t){return t.getAllCurrentContexts().filter(e=>e.isInactive()).length};o.validateEmptyRow=function e(t){const n=this.getTableDefinition().annotation.requiredProperties;if(n?.length){this.removeEmptyRowsMessages(t);const e=n.filter(e=>!t.getObject(e));if(e.length){const n=a.getResourceBundleFor("sap.fe.macros");const i=[];let o;for(const s of e){let e;const a=this.getTableDefinition().columns.find(e=>e.relativePath===s||e.propertyInfos&&e.propertyInfos.includes(s));if(!a){e=n.getText("M_TABLE_EMPTYROW_MANDATORY",[s])}else{o=this.getContent().getColumns().find(e=>e.getPropertyKey()===a.name);e=n.getText(o?"M_TABLE_EMPTYROW_MANDATORY":"M_TABLE_EMPTYROW_MANDATORY_HIDDEN",[o?.getHeader()||a.label])}i.push(new c({message:e,processor:this.getModel(),type:l.Error,technical:false,persistent:true,technicalDetails:{tableId:this.getContent().getId(),emptyRowMessage:true,missingColumn:o?undefined:s},target:`${t?.getPath()}/${s}`}))}r.addMessages(i);return false}}return true};o.removeEmptyRowsMessages=function e(t){r.removeMessages(r.getMessageModel().getData().filter(e=>{const n=e.getTechnicalDetails()||{};const i=Array.isArray(t)?t.some(t=>e.getTargets().some(e=>e.startsWith(t.getPath()))):!t||e.getTargets().some(e=>e.startsWith(t.getPath()));return i&&n.emptyRowMessage&&n.tableId===this.getContent().getId()}))};o.createEmptyRows=async function n(i,o){let s=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;let a=arguments.length>3?arguments[3]:undefined;let r=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;let c=arguments.length>5?arguments[5]:undefined;const l=a??(this.getTableDefinition().control?.inlineCreationRowCount||1);if(this.creatingEmptyRows||this.getInactiveContextNumber(i)>l){return}const g=Array.from({length:l},()=>({})),d=o.data("tableType")!=="ResponsiveTable",f=true,u=t.getTargetView(o),h=u.getController(),p=h.editFlow,m=t.getAppComponent(o);this.creatingEmptyRows=true;try{const e=s?[{}]:g;const t=await p.createMultipleDocuments(i,e,s||r?true:d,false,h.editFlow.onBeforeCreate,f,undefined,c);m.getSideEffectsService().requestSideEffectsForNavigationProperty(i.getPath(),u.getBindingContext());t?.forEach(async function(e){try{await e.created()}catch(e){if(!e.canceled){throw e}}});return t}catch(t){e.error(t)}finally{this.creatingEmptyRows=false}};return n}();g=h;return g},false);
//# sourceMappingURL=EmptyRowsHandler.js.map