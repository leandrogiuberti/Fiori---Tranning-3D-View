/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/util/JSTokenizer","sap/fe/base/BindingToolkit","sap/fe/core/CommonUtils","sap/fe/core/helpers/StableIdHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/CriticalityFormatters","sap/fe/macros/CommonHelper","sap/fe/macros/controls/filterbar/utils/VisualFilterUtils","sap/fe/macros/filter/FilterFieldHelper","sap/fe/macros/filterBar/FilterHelper","sap/m/library","sap/ui/core/Lib","sap/ui/core/format/NumberFormat","sap/ui/mdc/condition/ConditionConverter","sap/ui/mdc/odata/v4/TypeMap","sap/ui/model/Filter","sap/ui/model/odata/v4/ODataUtils","../field/FieldTemplating","../formatters/VisualFilterFormatter"],function(e,t,a,r,n,i,o,s,l,c,u,g,f,p,m,d,h,y,C){"use strict";var M=y.getTextBinding;var v=c.getFiltersConditionsFromSelectionVariant;var T=l.formatOptions;var P=l.constraints;var b=i.buildExpressionForCriticalityColorMicroChart;var F=n.isSingleton;var $=n.isPathAnnotationExpression;var E=n.isNavigationProperty;var D=n.isEntitySet;var I=r.generate;var O=t.pathInModel;var V=t.formatResult;var A=t.constant;var U=t.compileExpression;const S={getChartDisplayedValue:function(e,t,a){const r=I([a]);return"{parts:[{path:'"+e+"',type:'sap.ui.model.odata.type.Decimal', constraints:{'nullable':false}}"+(t&&t.ScaleFactor?",{value:'"+t.ScaleFactor.valueOf()+"'}":",{path:'internal>scalefactorNumber/"+r+"'}")+(t&&t.NumberOfFractionalDigits?",{value:'"+t.NumberOfFractionalDigits+"'}":",{value:'0'}")+",{path:'internal>currency/"+r+"'}"+",{path:'"+e+"',type:'sap.ui.model.odata.type.String', constraints:{'nullable':false}}"+"], formatter:'sap.fe.macros.visualfilters.VisualFilterRuntime.scaleVisualFilterValue'}"},getChartValue:function(e){return"{path:'"+e+"',type:'sap.ui.model.odata.type.Decimal', constraints:{'nullable':false}}"},_getCollectionName:function(e,t,a){const r=e?.targetObject;if(E(r)){return a?t:r.name}else if(D(r)){return"/"+r.name}else{return r.name}},_getBindingPathForParameters:function(t,r,n,i,o){const l=[];const c=s.convertFilterCondions(t);const u=a.getParameterInfo(r,n).parameterProperties;if(u){for(const t in i){const a=i[t];const n=u[a];const s=o.split("/")[1];const g=r?.createBindingContext(`/${s}/${a}`);let f;if(g){f=m.getTypeConfig(n.$Type,e.parseJS(T(n,{context:g})||"{}"),e.parseJS(P(n,{context:g})||"{}"))}const d=c[a];const y=d?d[0]:undefined;if(y){const e=p.toType(y,f,m);const t=n.$Type;let r=encodeURIComponent(h.formatLiteral(e.values[0],t));l.push(`${a}=${r}`)}}}const g=n.slice(0,n.lastIndexOf("/"));const f=n.substring(n.lastIndexOf("/")+1);return`${g}(${l.toString()})/${f}`},_getUOMAggregationExpression:function(e,t,a,r){let n,i;const o=a&&$(a)&&a.path;if(e){if(t){n=o?{unit:o}:{};i={}}else{n={};i=o?{[o]:{}}:{}}}else if(r&&r.AggregatableProperty&&r.AggregatableProperty.value&&r.AggregationMethod){n={name:r.AggregatableProperty.value,with:r.AggregationMethod};i=o?{[o]:{}}:{}}return{aggregationExpression:n,UOMExpression:i}},getAggregationBinding:function(e,t,a,r,n,i,o,l,c,u,g,f,p,m,h){const y=o;const C=f;const M=a;const T=e.Dimensions[0].value;const P=[];let b;let F=this._getCollectionName(t,a,g);const $=S.getUoM(e,t,undefined,l,c);if(p){P.push(new d({operator:"EQ",value1:"true",value2:null,path:"IsActiveEntity"}))}if(y){b=v(M,h,y,s.getCustomConditions.bind(s));for(const e in b){const t=b[e];t.forEach(function(e){if(!e.isParameter){P.push(new d({operator:e.operator,value1:e.value1,value2:e.value2,path:e.path}))}})}}if(C!==`${F}/`&&g&&g.length&&b){const e=this._getBindingPathForParameters(b,h,F,g,M);F=e}const E=this._getUOMAggregationExpression(l,u,$,c);const D=E.aggregationExpression;const I=E.UOMExpression;const O=r?{additionally:[r.path]}:{};const V={...this.getSortOrder(e,n,i,m),$$aggregation:{aggregate:{[m]:D},group:{[T]:{...O},...I}}};return{path:F,templateShareable:true,suspended:true,filters:P,parameters:V,...S.getMaxItems(e)}},_getOrderExpressionFromMeasure:function(e,t){let a;if(e&&e.length){if(e[0].DynamicProperty){a=e[0].DynamicProperty.$target?.Name}else{a=e[0].Property?.value}if(a===t){return{$orderby:t+(e[0].Descending?" desc":"")}}return{$orderby:t+" desc"}}return{$orderby:t+" desc"}},getSortOrder:function(e,t,a,r){if(e.ChartType==="UI.ChartType/Donut"||e.ChartType==="UI.ChartType/Bar"){return this._getOrderExpressionFromMeasure(a,r)}else if(t==="Edm.Date"||t==="Edm.Time"||t==="Edm.DateTimeOffset"){return{$orderby:e.Dimensions[0].value}}else if(a&&a.length&&a[0].Property?.$target?.path===e.Dimensions[0].value){return{$orderby:a[0].Property?.$target?.name+(a[0].Descending?"desc'":"'")}}else{return{$orderby:e.Dimensions[0].$target?.name}}},getMaxItems:function(e){if(e.ChartType==="UI.ChartType/Bar"){return{startIndex:0,length:3}}else if(e.ChartType==="UI.ChartType/Line"){return{startIndex:0,length:6}}else{return""}},getColorBinding:function(e,t){const a=t?.$target?.annotations?.UI?.ValueCriticality;if(e?.Criticality){return b(e)}else if(e?.CriticalityCalculation){const t=e.CriticalityCalculation.ImprovementDirection;const a=e.Value;const r=e.CriticalityCalculation.DeviationRangeLowValue.valueOf();const n=e.CriticalityCalculation.ToleranceRangeLowValue.valueOf();const i=e.CriticalityCalculation.AcceptanceRangeLowValue.valueOf();const s=e.CriticalityCalculation.AcceptanceRangeHighValue.valueOf();const l=e.CriticalityCalculation.ToleranceRangeHighValue.valueOf();const c=e.CriticalityCalculation.DeviationRangeHighValue.valueOf();return o.getCriticalityCalculationBinding(t,a,r,n,i,s,l,c)}else if(a&&a.length){return S.getValueCriticality(t.value,a)}else{return undefined}},getValueCriticality:function(e,t){let a;const r=[];if(t&&t.length>0){t.forEach(function(t){if(t.Value&&t.Criticality){const a="${"+e+"} === '"+t.Value+"' ? '"+S._getCriticalityFromEnum(t.Criticality)+"'";r.push(a)}});a=r.length>0&&r.join(" : ")+" : undefined"}return a?"{= "+a+" }":undefined},_getCriticalityFromEnum:function(e){const t=u.ValueColor;let a;if(e==="UI.CriticalityType/Negative"){a=t.Error}else if(e==="UI.CriticalityType/Positive"){a=t.Good}else if(e==="UI.CriticalityType/Critical"){a=t.Critical}else{a=t.Neutral}return a},getScaleUoMTitle:function(e,t,a,r,n,i,o){const s=e?.MeasureAttributes?e.MeasureAttributes[0]?.DataPoint?.$target?.ValueFormat?.ScaleFactor?.valueOf():undefined;const l=I([a]);const c=f.getIntegerInstance({style:"short",showScale:false,shortRefNumber:s});let u=c.getScale();let g=S.getUoM(e,t,undefined,r,n);const p=$(g)?O("uom/"+l,"internal"):A(g);const m=u?A(u):O("scalefactor/"+l,"internal");if(!i){i="|"}i=" "+i+" ";return U(V([i,p,m],C.formatScaleAndUOM),o)??""},getMeasureDimensionTitle:function(e,t,a){let r;let n;if(t){n=e?.Measures[0]?.$target?.name}if(e?.DynamicMeasures&&e.DynamicMeasures.length>0){n=e.DynamicMeasures[0]?.$target?.AggregatableProperty?.value}else if(!t&&e?.Measures&&e?.Measures.length>0){n=e.Measures[0]?.$target?.name}const i=e?.Dimensions[0]?.value;let o=e?.Dimensions[0]?.$target?.annotations?.Common?.Label;if(!t&&a){r=a.annotations&&a.annotations.Common&&a.annotations.Common.Label;if(r===undefined){r=e?.Measures?.[0]?.$target?.annotations?.Common?.Label}}else{r=e?.Measures?.[0]?.$target?.annotations?.Common?.Label}if(r===undefined){r=n}if(o===undefined){o=i}return g.getResourceBundleFor("sap.fe.macros").getText("M_INTERACTIVE_CHART_HELPER_VISUALFILTER_MEASURE_DIMENSION_TITLE",[r,o])},getToolTip:function(e,t,a,r,n,i){const s=e&&e["ChartType"];let l=S.getMeasureDimensionTitle(e,r,n);l=o.escapeSingleQuotes(l);if(i===false&&s==="UI.ChartType/Line"){return`{= '${l}'}`}const c=g.getResourceBundleFor("sap.fe.macros")?.getText("M_INTERACTIVE_CHART_HELPER_VISUALFILTER_TOOLTIP_SEPERATOR");const u=I([a]);const f=S.getScaleUoMTitle(e,t,u,r,n,c,true);return"{= '"+l+(f?"' + "+f:"'")+"}"},_getUOM:function(e,t,a,r,n){const i={};const o=a?.targetObject;if(e&&t&&$(e)){i[t]={$Path:e.path};return r&&e.path?i:e}else if(n){const a=D(o)||F(o)?o.entityType.entityProperties:o?.targetType?.entityProperties;const s=a?.find(e=>e.name==n);if(s?.annotations?.Measures&&t){e=s?.annotations?.Measures[t];i[t]={$Path:e?.path}}return e&&r&&$(e)&&e.path?i:e}},getUoM:function(e,t,a,r,n){let i={};if(r){i=e?.Measures[0]}if(e?.DynamicMeasures&&e.DynamicMeasures.length>0){i=e.DynamicMeasures[0]?.$target?.AggregatableProperty?.$target?.annotations?.Measures}else if(!r&&e?.Measures&&e.Measures.length>0){i=e.Measures[0]}const o=i?.ISOCurrency;const s=i?.Unit;let l;if(!r&&n){l=n.AggregatableProperty&&n.AggregatableProperty.value}else{l=i?.value}return this._getUOM(o,"ISOCurrency",t,a,l)||this._getUOM(s,"Unit",t,a,l)},getScaleFactor:function(e){if(e&&e.ScaleFactor){return e.ScaleFactor.valueOf()}return undefined},getUoMVisiblity:function(e,t){const a=e&&e["ChartType"];if(t){return false}else if(!(a==="UI.ChartType/Bar"||a==="UI.ChartType/Line")){return false}else{return true}},getInParameterFiltersBinding:function(e){if(e.length>0){const t=[];let a="";e.forEach(function(e){if(e.localDataProperty){t.push(`{path:'$filters>/conditions/${e.localDataProperty}'}`)}});if(t.length>0){a=t.join();return`{parts:[${a}], formatter:'sap.fe.macros.visualfilters.VisualFilterRuntime.getFiltersFromConditions'}`}else{return undefined}}else{return undefined}},getfilterCountBinding:function(e){const t=e?.Dimensions[0]?.$target?.name;return"{path:'$filters>/conditions/"+t+"', formatter:'sap.fe.macros.visualfilters.VisualFilterRuntime.getFilterCounts'}"},getInteractiveChartProperties:function(e){const t=e.chartAnnotation;const a={};if(e.chartMeasure&&t?.Dimensions&&t.Dimensions[0]){const r=I([e.metaPath]);a.showErrorExpression="{= ${internal>"+r+"/showError}}";a.errorMessageExpression="{= ${internal>"+r+"/errorMessage}}";a.errorMessageTitleExpression="{= ${internal>"+r+"/errorMessageTitle}}";let n;if(t?.MeasureAttributes&&t?.MeasureAttributes[0]){n=t?.MeasureAttributes[0]?.DataPoint?t?.MeasureAttributes[0].DataPoint.$target:t?.MeasureAttributes[0]}const i=t?.Dimensions[0];const s=o.getParameters(e.contextPath,e.getMetaModel());const l=i?.$target?.annotations?.Common?.Text;a.aggregationBinding=S.getAggregationBinding(t,e.collection,e.contextPath,l,i.$target?.type,e?.sortOrder,e.selectionVariant,e.customAggregate,e.aggregateProperties,e.UoMHasCustomAggregate,s,e.filterBarEntityType,e.draftSupported,e.chartMeasure,e.getMetaModel());a.scalefactor=S.getScaleFactor(n?.ValueFormat);a.uom=S.getUoM(t,e.collection,true,e.customAggregate,e.aggregateProperties);a.inParameters=e.inParameters;const c=o.parseCustomData(e.inParameters);a.inParameterFilters=e.inParameters?S.getInParameterFiltersBinding(c):undefined;a.selectionVariant=e.selectionVariant?e.selectionVariant:undefined;a.stringifiedParameters=s;const u=e.getMetaModel()?.createBindingContext(e.contextPath+"/@"+i.fullyQualifiedName.split("@")[1]);if(u){const t=e.getDataModelObjectForMetaPath(u.getPath(),e.contextPath);a.chartLabel=M(t,{})}a.measure=S.getChartValue(e.chartMeasure);a.displayedValue=S.getChartDisplayedValue(e.chartMeasure,n?.ValueFormat,e.metaPath);a.color=S.getColorBinding(n,i)}return a}};return S},false);
//# sourceMappingURL=InteractiveChartHelper.js.map