{"version":3,"file":"CollaborativeDraftHandler.js","names":["CollaborativeDraftHandler","_dec","defineUI5Class","_dec2","property","type","_dec3","_dec4","event","_dec5","defaultValue","_dec6","_class","_class2","_BuildingBlock","idOrSettings","settings","_this","call","this","_initializerDefineProperty","_descriptor","_descriptor2","_descriptor3","_descriptor4","_descriptor5","_exports","_inheritsLoose","_proto","prototype","getFullMetaPath","metaPath","startsWith","contextPath","endsWith","onMetadataAvailable","owner","_getOwner","ModelHelper","isCollaborationDraftSupported","getAppComponent","getModel","getMetaModel","getOwnerContextPath","fullMetaPath","objectPath","getDataModelObjectPath","isProperty","targetObject","Error","keysBindingParts","targetEntityType","keys","map","key","path","name","targetType","bindingInfo","parts","formatter","CollaborationFormatters","getCollaborationInfo","bindProperty","content","showAvatar","createCollaborationAvatar","setLockInfo","lockInfo","fireEvent","isLocked","undefined","lockingUserID","id","lockingUserName","lockingUserInitials","initials","lockingUserColor","color","collaborationExpression","UIFormatters","getCollaborationExpression","hasCollaborationActivity","collaborationHasActivityExpression","compileExpression","collaborationInitialsExpression","getCollaborationActivityInitials","collaborationColorExpression","getCollaborationActivityColor","_jsx","Avatar","visible","displaySize","customDisplaySize","customFontSize","backgroundColor","press","evt","onAvatarPress","children","dependents","EventDelegateHook","stopTapPropagation","avatar","getSource","block","getParent","view","getPageController","getView","resourceModel","ResourceModelHelper","getResourceModel","popover","UI5Element","getElementById","ResponsivePopover","showHeader","placement","addStyleClass","addDependent","destroyContent","addContent","Label","text","getText","openBy","BuildingBlock","_applyDecoratedDescriptor","configurable","enumerable","writable","initializer"],"sources":["./CollaborativeDraftHandler.tsx"],"sourcesContent":["import { type Property } from \"@sap-ux/vocabularies-types\";\nimport { compileExpression } from \"sap/fe/base/BindingToolkit\";\nimport { defineUI5Class, event, property, type PropertiesOf } from \"sap/fe/base/ClassSupport\";\nimport EventDelegateHook from \"sap/fe/base/EventDelegateHook\";\nimport BuildingBlock from \"sap/fe/core/buildingBlocks/BuildingBlock\";\nimport { type UserActivity } from \"sap/fe/core/controllerextensions/collaboration/CollaborationCommon\";\nimport * as CollaborationFormatters from \"sap/fe/core/formatters/CollaborationFormatter\";\nimport ModelHelper from \"sap/fe/core/helpers/ModelHelper\";\nimport ResourceModelHelper from \"sap/fe/core/helpers/ResourceModelHelper\";\nimport { isProperty } from \"sap/fe/core/helpers/TypeGuards\";\nimport { type DataModelObjectPath } from \"sap/fe/core/templating/DataModelPathHelper\";\nimport * as UIFormatters from \"sap/fe/core/templating/UIFormatters\";\nimport Avatar, { type Avatar$PressEvent } from \"sap/m/Avatar\";\nimport Label from \"sap/m/Label\";\nimport ResponsivePopover from \"sap/m/ResponsivePopover\";\nimport type UI5Event from \"sap/ui/base/Event\";\nimport UI5Element from \"sap/ui/core/Element\";\nimport type { EventHandler } from \"types/extension_types\";\n\n/**\n * A BuildingBlock to watch the lock status of a property and to react on changes.\n * @public\n * @ui5-experimental-since 1.141.0\n * @since 1.141.0\n */\n@defineUI5Class(\"sap.fe.macros.CollaborativeDraftHandler\")\nexport default class CollaborativeDraftHandler extends BuildingBlock<Avatar> {\n\t/**\n\t * Defines the path of the context used in the current page or block.\n\t * This setting is defined by the framework, and can be overwritten.\n\t * @public\n\t * @ui5-experimental-since 1.141.0\n\t * @since 1.141.0\n\t */\n\t@property({ type: \"string\" })\n\tcontextPath!: string;\n\n\t/**\n\t * Defines the relative path of the property in the metamodel, based on the current contextPath.\n\t * @public\n\t * @ui5-experimental-since 1.141.0\n\t * @since 1.141.0\n\t */\n\t@property({ type: \"string\" })\n\tmetaPath!: string;\n\n\t/**\n\t * Event fired when the lock status changes.\n\t *\n\t * Parameters:<BR>\n\t * - isLocked : true if the property is locked, false otherwise<BR>\n\t * - lockingUserID: the ID of the user locking the property (undefined if not locked)<BR>\n\t * - lockingUserName: the name of the user locking the property (undefined if not locked)<BR>\n\t * - lockingUserInitials: the initials of the user locking the property (undefined if not locked)<BR>\n\t * - lockingUserColor: the color associated to the user locking the property (undefined if not locked)<BR>\n\t * @public\n\t * @ui5-experimental-since 1.141.0\n\t * @since 1.141.0\n\t */\n\t@event()\n\tlockChange?: EventHandler<\n\t\tUI5Event<\n\t\t\t{\n\t\t\t\tisLocked: boolean;\n\t\t\t\tlockingUserID?: string;\n\t\t\t\tlockingUserName?: string;\n\t\t\t\tlockingUserInitials?: string;\n\t\t\t\tlockingUserColor?: string;\n\t\t\t},\n\t\t\tCollaborativeDraftHandler\n\t\t>\n\t>;\n\n\t/**\n\t * If set to true, the standard Avatar control is displayed to indicate the lock status.\n\t * If set to false, nothing is displayed.\n\t * @public\n\t * @ui5-experimental-since 1.141.0\n\t * @since 1.141.0\n\t */\n\t@property({ type: \"boolean\", defaultValue: false })\n\tshowAvatar = false;\n\n\t/**\n\t * Internal property to receive the lock data\n\t */\n\t@property({ type: \"object\" })\n\tlockInfo?: UserActivity;\n\n\tconstructor(idOrSettings: string | PropertiesOf<CollaborativeDraftHandler>, settings?: PropertiesOf<CollaborativeDraftHandler>) {\n\t\tsuper(idOrSettings, settings);\n\t}\n\n\tprivate getFullMetaPath(): string {\n\t\tif (this.metaPath.startsWith(\"/\")) {\n\t\t\treturn this.metaPath;\n\t\t} else if (this.contextPath.endsWith(\"/\")) {\n\t\t\treturn `${this.contextPath}${this.metaPath}`;\n\t\t} else {\n\t\t\treturn `${this.contextPath}/${this.metaPath}`;\n\t\t}\n\t}\n\n\tonMetadataAvailable(): void {\n\t\tconst owner = this._getOwner();\n\t\tif (!owner) {\n\t\t\treturn;\n\t\t}\n\t\tif (!ModelHelper.isCollaborationDraftSupported(owner.getAppComponent().getModel().getMetaModel())) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.contextPath ??= this.getOwnerContextPath() as string;\n\t\tconst fullMetaPath = this.getFullMetaPath();\n\t\tconst objectPath = this.getDataModelObjectPath<Property>(fullMetaPath);\n\t\tif (!objectPath || !isProperty(objectPath.targetObject)) {\n\t\t\tthrow new Error(`CollaborativeDraftHandler: the provided metaPath '${fullMetaPath}' does not point to a valid property`);\n\t\t}\n\n\t\t// Bind the lockInfo property to the corresponding lockInfo in the internal model\n\t\tconst keysBindingParts = objectPath.targetEntityType.keys.map((key) => {\n\t\t\treturn { path: key.name, targetType: \"any\" };\n\t\t});\n\t\tconst bindingInfo = {\n\t\t\tparts: [{ path: `internal>/collaboration/activities${fullMetaPath}`, targetType: \"any\" }, ...keysBindingParts],\n\t\t\tformatter: CollaborationFormatters.getCollaborationInfo\n\t\t};\n\n\t\tthis.bindProperty(\"lockInfo\", bindingInfo);\n\n\t\tif (!this.content && this.showAvatar) {\n\t\t\tthis.content = this.createCollaborationAvatar(objectPath);\n\t\t}\n\t}\n\n\t/**\n\t * Update the lockInfo property and fire the lockChange event if there is a change.\n\t * @param lockInfo\n\t */\n\tsetLockInfo(lockInfo: object | undefined): void {\n\t\tif (this.lockInfo !== lockInfo) {\n\t\t\tthis.lockInfo = lockInfo as UserActivity | undefined;\n\t\t\tthis.fireEvent(\"lockChange\", {\n\t\t\t\tisLocked: this.lockInfo !== undefined,\n\t\t\t\tlockingUserID: this.lockInfo?.id,\n\t\t\t\tlockingUserName: this.lockInfo?.name,\n\t\t\t\tlockingUserInitials: this.lockInfo?.initials,\n\t\t\t\tlockingUserColor: this.lockInfo?.color\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Creates the content of the block (Avatar).\n\t * @param objectPath\n\t * @returns The Avatar control\n\t */\n\tcreateCollaborationAvatar(objectPath: DataModelObjectPath<Property>): Avatar {\n\t\tconst collaborationExpression = UIFormatters.getCollaborationExpression(\n\t\t\tobjectPath,\n\t\t\tCollaborationFormatters.hasCollaborationActivity\n\t\t);\n\t\tconst collaborationHasActivityExpression = compileExpression(collaborationExpression);\n\t\tconst collaborationInitialsExpression = compileExpression(\n\t\t\tUIFormatters.getCollaborationExpression(objectPath, CollaborationFormatters.getCollaborationActivityInitials)\n\t\t);\n\t\tconst collaborationColorExpression = compileExpression(\n\t\t\tUIFormatters.getCollaborationExpression(objectPath, CollaborationFormatters.getCollaborationActivityColor)\n\t\t);\n\n\t\treturn (\n\t\t\t<Avatar\n\t\t\t\tvisible={collaborationHasActivityExpression}\n\t\t\t\tinitials={collaborationInitialsExpression}\n\t\t\t\tdisplaySize=\"Custom\"\n\t\t\t\tcustomDisplaySize=\"1.5rem\"\n\t\t\t\tcustomFontSize=\"0.8rem\"\n\t\t\t\tbackgroundColor={collaborationColorExpression}\n\t\t\t\tpress={(evt: Avatar$PressEvent): void => {\n\t\t\t\t\tthis.onAvatarPress(evt);\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t{{\n\t\t\t\t\tdependents: <EventDelegateHook stopTapPropagation={true} />\n\t\t\t\t}}\n\t\t\t</Avatar>\n\t\t);\n\t}\n\n\t/**\n\t * Event handler for the press event of the Avatar.\n\t * @param evt\n\t */\n\tonAvatarPress(evt: Avatar$PressEvent): void {\n\t\tconst avatar = evt.getSource();\n\t\tconst block = avatar.getParent() as CollaborativeDraftHandler;\n\t\tconst view = this.getPageController().getView();\n\t\tconst resourceModel = ResourceModelHelper.getResourceModel(view);\n\t\tlet popover = UI5Element.getElementById(`manageCollaborationDraft--editUser`) as ResponsivePopover | undefined;\n\n\t\tif (!popover) {\n\t\t\tpopover = new ResponsivePopover(\"manageCollaborationDraft--editUser\", {\n\t\t\t\tshowHeader: false,\n\t\t\t\tplacement: \"Bottom\"\n\t\t\t});\n\t\t\tpopover.addStyleClass(\"sapUiContentPadding\");\n\t\t\tview.addDependent(popover);\n\t\t}\n\n\t\tpopover.destroyContent();\n\t\tpopover.addContent(\n\t\t\tnew Label({\n\t\t\t\ttext: resourceModel.getText(\"C_COLLABORATIONAVATAR_USER_EDIT_FIELD\", [`${block.lockInfo?.name}`])\n\t\t\t})\n\t\t);\n\t\tpopover.openBy(avatar);\n\t}\n}\n"],"mappings":";;;;kkDAmBA,IAOqBA,GAAyBC,EAD7CC,EAAe,2CAA0CC,EASxDC,EAAS,CAAEC,KAAM,WAAWC,EAS5BF,EAAS,CAAEC,KAAM,WAAWE,EAgB5BC,IAAOC,EAqBPL,EAAS,CAAEC,KAAM,UAAWK,aAAc,QAAQC,EAMlDP,EAAS,CAAEC,KAAM,WAAWJ,EAAAW,GAAAC,EAAA,SAAAC,GAG7B,SAAAd,EAAYe,EAAgEC,GAAoD,IAAAC,EAC/HA,EAAAH,EAAAI,KAAAC,KAAMJ,EAAcC,IAASG,KA/D9BC,EAAAH,EAAA,cAAAI,EAAAJ,GAUAG,EAAAH,EAAA,WAAAK,EAAAL,GASAG,EAAAH,EAAA,aAAAM,EAAAN,GA2BAG,EAAAH,EAAA,aAAAO,EAAAP,GAUAG,EAAAH,EAAA,WAAAQ,EAAAR,GAAA,OAAAA,CAQA,CAACS,EAAA1B,EAAA2B,EAAA3B,EAAAc,GAAA,IAAAc,EAAA5B,EAAA6B,UAAAD,EAEOE,gBAAR,SAAQA,IACP,GAAIX,KAAKY,SAASC,WAAW,KAAM,CAClC,OAAOb,KAAKY,QACb,MAAO,GAAIZ,KAAKc,YAAYC,SAAS,KAAM,CAC1C,MAAO,GAAGf,KAAKc,cAAcd,KAAKY,UACnC,KAAO,CACN,MAAO,GAAGZ,KAAKc,eAAed,KAAKY,UACpC,CACD,EAACH,EAEDO,oBAAA,SAAAA,IACC,MAAMC,EAAQjB,KAAKkB,YACnB,IAAKD,EAAO,CACX,MACD,CACA,IAAKE,EAAYC,8BAA8BH,EAAMI,kBAAkBC,WAAWC,gBAAiB,CAClG,MACD,CAEAvB,KAAKc,cAAgBd,KAAKwB,sBAC1B,MAAMC,EAAezB,KAAKW,kBAC1B,MAAMe,EAAa1B,KAAK2B,uBAAiCF,GACzD,IAAKC,IAAeE,EAAWF,EAAWG,cAAe,CACxD,MAAM,IAAIC,MAAM,qDAAqDL,wCACtE,CAGA,MAAMM,EAAmBL,EAAWM,iBAAiBC,KAAKC,IAAKC,IACvD,CAAEC,KAAMD,EAAIE,KAAMC,WAAY,SAEtC,MAAMC,EAAc,CACnBC,MAAO,CAAC,CAAEJ,KAAM,qCAAqCX,IAAgBa,WAAY,UAAYP,GAC7FU,UAAWC,EAAwBC,sBAGpC3C,KAAK4C,aAAa,WAAYL,GAE9B,IAAKvC,KAAK6C,SAAW7C,KAAK8C,WAAY,CACrC9C,KAAK6C,QAAU7C,KAAK+C,0BAA0BrB,EAC/C,CACD,EAEAjB,EAIAuC,YAAA,SAAAA,EAAYC,GACX,GAAIjD,KAAKiD,WAAaA,EAAU,CAC/BjD,KAAKiD,SAAWA,EAChBjD,KAAKkD,UAAU,aAAc,CAC5BC,SAAUnD,KAAKiD,WAAaG,UAC5BC,cAAerD,KAAKiD,UAAUK,GAC9BC,gBAAiBvD,KAAKiD,UAAUZ,KAChCmB,oBAAqBxD,KAAKiD,UAAUQ,SACpCC,iBAAkB1D,KAAKiD,UAAUU,OAEnC,CACD,EAEAlD,EAKAsC,0BAAA,SAAAA,EAA0BrB,GACzB,MAAMkC,EAA0BC,EAAaC,2BAC5CpC,EACAgB,EAAwBqB,0BAEzB,MAAMC,EAAqCC,EAAkBL,GAC7D,MAAMM,EAAkCD,EACvCJ,EAAaC,2BAA2BpC,EAAYgB,EAAwByB,mCAE7E,MAAMC,EAA+BH,EACpCJ,EAAaC,2BAA2BpC,EAAYgB,EAAwB2B,gCAG7E,OACCC,EAACC,EAAM,CACNC,QAASR,EACTP,SAAUS,EACVO,YAAY,SACZC,kBAAkB,SAClBC,eAAe,SACfC,gBAAiBR,EACjBS,MAAQC,IACP9E,KAAK+E,cAAcD,IAClBE,SAED,CACAC,WAAYX,EAACY,EAAiB,CAACC,mBAAoB,SAIvD,EAEA1E,EAIAsE,cAAA,SAAAA,EAAcD,GACb,MAAMM,EAASN,EAAIO,YACnB,MAAMC,EAAQF,EAAOG,YACrB,MAAMC,EAAOxF,KAAKyF,oBAAoBC,UACtC,MAAMC,EAAgBC,EAAoBC,iBAAiBL,GAC3D,IAAIM,EAAUC,EAAWC,eAAe,sCAExC,IAAKF,EAAS,CACbA,EAAU,IAAIG,EAAkB,qCAAsC,CACrEC,WAAY,MACZC,UAAW,WAEZL,EAAQM,cAAc,uBACtBZ,EAAKa,aAAaP,EACnB,CAEAA,EAAQQ,iBACRR,EAAQS,WACP,IAAIC,EAAM,CACTC,KAAMd,EAAce,QAAQ,wCAAyC,CAAC,GAAGpB,EAAMrC,UAAUZ,YAG3FyD,EAAQa,OAAOvB,EAChB,EAAC,OAAAvG,CAAA,CAlI4B,CA5DyB+H,GAAa1G,EAAA2G,EAAAnH,EAAAgB,UAAA,eAAA1B,GAAA,CAAA8H,aAAA,KAAAC,WAAA,KAAAC,SAAA,KAAAC,YAAA,OAAA9G,EAAA0G,EAAAnH,EAAAgB,UAAA,YAAAvB,GAAA,CAAA2H,aAAA,KAAAC,WAAA,KAAAC,SAAA,KAAAC,YAAA,OAAA7G,EAAAyG,EAAAnH,EAAAgB,UAAA,cAAAtB,GAAA,CAAA0H,aAAA,KAAAC,WAAA,KAAAC,SAAA,KAAAC,YAAA,OAAA5G,EAAAwG,EAAAnH,EAAAgB,UAAA,cAAApB,GAAA,CAAAwH,aAAA,KAAAC,WAAA,KAAAC,SAAA,KAAAC,YAAA,kBAuDtD,KAAK,IAAA3G,EAAAuG,EAAAnH,EAAAgB,UAAA,YAAAlB,GAAA,CAAAsH,aAAA,KAAAC,WAAA,KAAAC,SAAA,KAAAC,YAAA,OAAAvH,KAAAD,GAAAc,EAAA1B,EAAA,OAAA0B,CAAA","ignoreList":[]}