/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/fe/core/templating/PropertyHelper","sap/fe/macros/filterBar/DraftEditState","sap/fe/macros/mdc/adapter/SelectionVariantToStateFilters","sap/fe/macros/mdc/adapter/StateFilterToSelectionVariant","sap/fe/navigation/SelectionVariant","sap/ui/mdc/p13n/StateUtil"],function(t,e,a,r,i,n,o,s){"use strict";const l={async getSelectionVariant(e){try{const t=await s.retrieveExternalState(e);const a=t.filter;let r=[];if(e?.getParent()?.isA("sap.fe.macros.filterBar.FilterBarAPI")&&e.getParent().getParameters!==undefined){r=e.getParent().getParameters()}const i=n.getSelectionVariantFromConditions(a,e.getPropertyHelper(),r);if(e?.isA("sap.ui.mdc.Chart")){const t=new o;const e=i._getSelectOptions();for(const a in e){t.massAddSelectOption(a.split("_fe_groupable_")[1],e[a])}return t}else{return i}}catch(a){const r=e?.getId();const i=a instanceof Error?a.message:String(a);t.error(`Building Block (${r}) - get selection variant failed : ${i}`);throw Error(i)}},async convertSelectionVariantToStateFilters(t,e,a,r){const n=await this._getSupportedFilterFields(t);if(!n.length){throw new Error("No valid metadata properties present for filter bar")}const o=this._getControlInfoForConversion(t);const s=r?.getMetaModel();const l=JSON.parse(JSON.stringify(n));const c=this._updatePropertyInfoToSupportSV(t,l);const p=i.getStateFiltersFromSV(e,o,c??l,a,s);return p},_getControlInfoForConversion(t){const e=t.getModel()?.getMetaModel(),a=t.data("entityType");if(t.isA("sap.fe.macros.controls.FilterBar")){const r=t.data("useSemanticDateRange")==="true"||t.data("useSemanticDateRange")===true,i=t.getModel("viewData"),n=i.getData(),o=n?.controlConfiguration,s=o?.["@com.sap.vocabularies.UI.v1.SelectionFields"],l=s?.filterFields;return{metaModel:e,contextPath:a,useSemanticDateRange:r,filterFieldsConfig:l,selectionFieldsConfigs:s}}else{return{metaModel:e,contextPath:a}}},async _getSupportedFilterFields(t){if(t.isA("sap.ui.mdc.Filterbar")){await t.waitForInitialization();return t.getControlDelegate().fetchFilterProperties(t)}else if(t.isA("sap.fe.macros.controls.FilterBar")){return t.getControlDelegate().fetchFilterProperties(t)}else{await t.awaitControlDelegate()}return t.getControlDelegate().fetchProperties(t)},async clearFilterValues(t){await this._clearFilterValuesWithOptions(t.content);t.fireEvent("afterClear")},async _clearFilterValuesWithOptions(t,a){if(!t){return}const i=await s.retrieveExternalState(t);let n="",o,l,c,p;if(t.isA("sap.ui.mdc.FilterBar")){n="$editState";l=r.ALL.id;o=e(i.filter[n]?.[0]);c=o?.values[0]===l;p=a&&Object.keys(a).length>0&&a.clearEditFilter}for(const t of Object.keys(i.filter)){if(!p&&t===n&&c){continue}for(const e of i.filter[t]){e.filtered=false}}await s.applyExternalState(t,{filter:i.filter});if(t.isA("sap.ui.mdc.FilterBar")){if(!p&&o&&!c){o.values=[l];await s.applyExternalState(t,{filter:{[n]:[o]}})}t.cleanUpAllFilterFieldsInErrorState()}},_updatePropertyInfoToSupportSV(t,e){if(t.isA("sap.ui.mdc.FilterBar")){return e}e.forEach(e=>{if(t.isA("sap.ui.mdc.Table")){e["conditionPath"]=e.name;e["annotationPath"]=e.metadataPath?e.metadataPath:"";e["hasValueHelp"]=a.hasValueHelp(t.getPropertyHelper().getProperty(e.name));e["dataType"]=e?.typeConfig?.className}else if(t.isA("sap.ui.mdc.Chart")){if(e.path){e["name"]=e.path;e["conditionPath"]=e.path;const r=t.getParent()?.getPropertyDataModel(e.path)?.targetObject;e["hasValueHelp"]=r?a.hasValueHelp(r):false;e["dataType"]=e?.typeConfig?.className||e.dataType}}});return e},async setSelectionVariantToMdcControl(e,a){let r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;try{const n=await s.retrieveExternalState(e);if(!n.filter){t.error(`FE : setSelectionVariant API cannot be applied on : ${e?.getId()}`);return}const o=await this.convertSelectionVariantToStateFilters(e,a,r,e?.getModel());await this.clearFilterValues(e?.getParent());const l=await this._getSupportedFilterFields(e);const c=i.getStateToApply(l,o);if(e?.isA("sap.ui.mdc.Chart")){this.convertConditionsForChart(c)}const p=await s.diffState(e,n,c);const f=await s.applyExternalState(e,c);return{diffState:p,applyStateResult:f}}catch(a){const r=e?.getId();const i=a instanceof Error?a.message:String(a);t.error(`FE : BuildingBlock (${r}) - set selection variant failed  : ${i}`);throw Error(i)}},convertConditionsForChart(t){for(const e in t.filter){delete Object.assign(t.filter,{["_fe_groupable_"+e]:t.filter[e]})[e]}t.items.forEach(t=>{t.name="_fe_groupable_"+t.name})}};return l},false);
//# sourceMappingURL=StateHelper.js.map