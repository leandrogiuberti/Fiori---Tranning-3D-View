/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/chart/TimeUnitType","sap/fe/core/CommonUtils","sap/fe/core/formatters/ValueFormatter","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/macros/CommonHelper","sap/fe/macros/DelegateUtil","sap/fe/macros/chart/ChartHelper","sap/fe/macros/chart/ChartUtils","sap/fe/macros/filter/FilterUtils","sap/m/IllustratedMessageSize","sap/m/IllustratedMessageType","sap/ui/core/Element","sap/ui/core/Lib","sap/ui/mdc/enums/ChartItemRoleType","sap/ui/mdc/odata/v4/util/DelegateUtil","sap/ui/mdc/odata/v4/vizChart/ChartDelegate","sap/ui/model/Filter","sap/ui/model/FilterOperator","../filterBar/FilterBarDelegate"],function(e,t,a,r,n,s,o,i,l,c,u,g,f,p,d,m,h,y,b,T,C,P,_){"use strict";var I=s.isMultiValueFilterExpression;var D=s.getSortRestrictionsInfo;var A=s.getFilterableData;const O=Object.assign({},T);T.apiVersion=2;O._loadChart=async function(){await h.load({name:"sap.chart"});return T._loadChart()};O._handleProperty=function(t,a,n,s,i,c,u,g){const f=l.parseCustomData(a.data("applySupported"));const p=D(n);const d=t.getModel();const m=a.data("entityType");const h=o.getEntitySetPath(m);const y=r.getFilterRestrictionsByPath(h,d);const b={};A(b,y.NonFilterableProperties,Object.keys(y.FilterAllowedExpressions));const T=t.getModel().getObject(t.getPath());const C=t.getModel().getObject(`${t.getPath()}@sapui.name`);const P=a.getP13nMode();$(a,P);if(T&&T.$kind==="Property"){if(T.$isCollection){return}const r=d.getObject(`${t.getPath()}@`);const n=d.getObject("@sapui.name",d.getMetaContext(t.getPath()));const o=f&&f.GroupableProperties;const m=f&&f.AggregatableProperties;let h=o?M(o,n):false;let _=m?M(m,n):false;const I=Object.keys(i);if(!o||o&&!o.length){h=r["@Org.OData.Aggregation.V1.Groupable"]}if(!m||m&&!m.length){_=r["@Org.OData.Aggregation.V1.Aggregatable"]}if(I.includes(C)){_=true}if(!h&&!_){return}const D=l.isPropertyFilterable(t);if(_){const e=O._createPropertyInfosForAggregatable(a,C,r,y,p,s,i,T.$Type);e.forEach(function(e){if(!g.includes(e.path)){c.push(e)}});if(P&&P.includes("Filter")){const e=Object.keys(s);const t=o?.map(e=>e.$PropertyPath);if(e.includes(C)&&!t?.includes(C)&&!g.includes(C)){c=v(c,C,r,I.includes(C)?false:E(C,D,b),y,false,a,u,T,false,true,undefined,true)}}}if(h){const t=C||"",n=r["@"+"com.sap.vocabularies.Common.v1.Text"]?r["@"+"com.sap.vocabularies.Common.v1.Text"].$Path:null;let s=false;if(t&&t.includes("/")){e.error(`$expand is not yet supported. Property: ${t} from an association cannot be used`);return}if(n&&n.indexOf("/")>-1){e.error(`$expand is not yet supported. Text Property: ${n} from an association cannot be used`);s=true}c=v(c,C,r,E(C,D,b)?I.includes(C)&&g.includes(C)||!g.includes(C):false,y,O._getSortable(a,p.propertyInfo[C],false),a,u,T,!I.includes(C)||I.includes(C)&&g.includes(C)?true:false,false,s)}}};function S(e,t,a){const r=[];for(const n in e){const e=t.createBindingContext(`${a}/${n}`);const s=t.getObject(`${e?.getPath()}@`);const o=s?.["@Org.OData.Measures.V1.ISOCurrency"]?.$Path||s?.["@Org.OData.Measures.V1.Unit"]?.$Path;if(o&&!r.includes(o)){r.push(o)}}return r}function v(e,t,a,r,n,s,o,i,l,c,u,g,f){let p=y.category;const d=o.data("chartDimensionKeyAndRole");if(Array.isArray(d)){d.forEach(e=>{if(e[t]){p=e[t].split("/").pop()?.toLowerCase()||p}})}const m={name:"_fe_groupable_"+t,label:a["@com.sap.vocabularies.Common.v1.Label"]?.toString()||t,sortable:s,filterable:r,groupable:c,aggregatable:u,maxConditions:I(n["FilterAllowedExpressions"]?.[t]?.[0])?-1:1,path:t,role:p,criticality:i,dataType:l.$Type,visible:f?!f:true,textProperty:!g&&a["@com.sap.vocabularies.Common.v1.Text"]?a["@com.sap.vocabularies.Common.v1.Text"].$Path:null,textFormatter:a["@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement"]};const h=O._getTimeType(l,a);if(h)m.timeUnitType=h;if(l.$Type==="Edm.DateTimeOffset"||l.$Type==="Edm.TimeOfDay"){switch(l.$Type){case"Edm.DateTimeOffset":m.formatOptions={style:"medium/short"};break;case"Edm.TimeOfDay":m.formatOptions={style:"short"};break;default:break}}e.push(m);return e}function E(e,t,a){if(t===false){return false}else if(typeof t==="string"){return true}else{return a?.[e]?.filterable??true}}O._getTimeType=function(e,t){switch(e.$Type){case"Edm.Date":return a.Date;case"Edm.String":if(t["@"+"com.sap.vocabularies.Common.v1.IsFiscalYear"]){return a.fiscalyear}else if(t["@"+"com.sap.vocabularies.Common.v1.IsFiscalYearPeriod"]){return a.fiscalyearperiod}else if(t["@"+"com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]){return a.yearmonth}else if(t["@"+"com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]){return a.yearquarter}else if(t["@"+"com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]){return a.yearweek}else if(t["@"+"com.sap.vocabularies.Common.v1.IsCalendarDate"]){return a.yearmonthday}break;default:return undefined}};function $(e,t){const a=e?.getModel()?.getMetaModel()?.getObject(`${e.data("targetCollectionPath")}@Org.OData.Capabilities.V1.FilterRestrictions`)?.Filterable;if(a!==undefined&&!a){t=t.filter(e=>e!=="Filter");e.setP13nMode(t)}}function M(e,t){if(e.length){for(const a of e){if(a?.$PropertyPath===t||a?.Property?.$PropertyPath===t){return true}}}}O.formatText=function(e,t){const a=this.typeConfig?.typeInstance?.formatValue(e,"string")||e;if(t){const e=this.textFormatter;if(!e||e.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextFirst"){return n.formatWithBrackets(t,a)}if(e.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextLast"){return n.formatWithBrackets(a,t)}}return t||a};O._updateIllustratedMessage=function(e,t){const a=e.getNoData();a.setTitle(t.title);a.setDescription(t.description);a.setIllustrationType(t.illustrationType||d.NoData);a.setIllustrationSize(t.illustrationSize||p.Auto)};O.setChartNoDataIllustratedMessage=function(e,t){const a=i.getResourceModel(e);let n={};const s=r.getTargetView(e).getViewData().converterType;const o=g.getAllFilterInfo(e);const l=t.path.startsWith("/")?t.path.substr(1):t.path;const c=function(){if(e.data("multiViews")==="true"){return{title:a.getText("T_ILLUSTRATED_MESSAGE_TITLE_NOSEARCHRESULTS",undefined,l),description:a.getText("M_TABLE_AND_CHART_NO_DATA_TEXT_MULTI_VIEW",undefined,l),illustrationType:d.NoSearchResults}}return{title:a.getText("T_ILLUSTRATED_MESSAGE_TITLE_NOSEARCHRESULTS",undefined,l),description:a.getText("T_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER",undefined,l),illustrationType:d.NoSearchResults,illustrationSize:s==="ObjectPage"?p.Small:p.Auto}};if(e.getFilter()&&s!=="ObjectPage"){if(o.search||o.filters?.length){n=c()}}else if(o.search||o.filters?.length){n=c()}else{n={title:a.getText("T_ILLUSTRATED_MESSAGE_TITLE_NODATA",undefined,l),description:a.getText("M_TABLE_AND_CHART_NO_FILTERS_NO_DATA_TEXT",undefined,l),illustrationType:d.NoData,illustrationSize:p.Small}}O._updateIllustratedMessage(e,n)};O.updateBindingInfo=function(e,t){const a=e.getBindingContext("internal");a.setProperty("isInsightsEnabled",true);O.setChartNoDataIllustratedMessage(e,t);const n=m.getElementById(e.getFilter());const s=e.getConditions();if(!t){t={}}if(!t.parameters){t.parameters={}}if(n){const a=f.getFilterInfo(n,{});const s=l.parseCustomData(e.data("applySupported"));if(s&&s.enableSearch&&a.search){t.parameters.$search=r.normalizeSearchTerm(a.search)}else if(t.parameters.$search){delete t.parameters.$search}}const o=s?b.getParametersInfo(n,s):null;if(o){t.path=o}const i=g.getAllFilterInfo(e);if(i.bindingPath){t.path=i.bindingPath}if(t.path&&e.getBindingContext()){t.path=u.getCollectionName(t.path)}if(i.filters){i.filters.forEach(t=>{if(t.getPath()){t.sPath=e.getParent().getChartPropertiesWithoutPrefixes(t.getPath())}})}t.events??={};t.events.dataRequested=e.getParent().onInternalDataRequested.bind(e.getParent());t.filters=i.filters.length>0?new C({filters:i.filters,and:true}):undefined;t.sorter=this.getSorters(e);O._checkAndAddDraftFilter(e,t)};O.fetchProperties=async function(e){const t=this._getModel(e);let a;if(!t){a=new Promise(t=>{e.attachModelContextChange({resolver:t},F,this)}).then(t=>this._createPropertyInfos(e,t))}else{a=this._createPropertyInfos(e,t)}return a.then(function(t){if(e.data){e.data("$mdcChartPropertyInfo",t);c.setCachedProperties(e,t)}return t})};function F(e,t){const a=e.getSource();const r=this._getModel(a);if(r){a.detachModelContextChange(F);t.resolver(r)}}O._createPropertyInfos=async function(e,t){const a=`/${e.data("entitySet")}`;const r=t.getMetaModel();const n=await Promise.all([r.requestObject(`${a}/`),r.requestObject(`${a}@`)]);const s=[];const o=n[0];const i=n[1];const c=l.parseCustomData(e.data("customAgg"));x(c,e);let g;for(const e in i){if(e.startsWith("@Org.OData.Aggregation.V1.CustomAggregate")){g=e.replace("@Org.OData.Aggregation.V1.CustomAggregate#","");const t=g.split("@");if(t.length==2&&t[1]=="com.sap.vocabularies.Common.v1.Label"){c[t[0]]=i[e]}}}const f=l.parseCustomData(e.data("transAgg"));const p={};for(const e in f){const t=f[e].propertyPath;p[t]=p[t]||{};p[t][f[e].aggregationMethod]={name:f[e].name,label:f[e].label}}const d=S(o,r,a);for(const t in o){if(t.indexOf("$")!==0){const n=u.fetchCriticality(r,r.createBindingContext(`${a}/${t}`));O._handleProperty(r.getMetaContext(`${a}/${t}`),e,i,p,c,s,n,d)}}return s};function x(t,a){const r=[],n=[];if(t&&Object.keys(t).length>=1){const t=a.getItems();for(const e in t){if(t[e].getType()==="groupable"){r.push(O.getInternalChartNameFromPropertyNameAndKind(t[e].getPropertyKey(),"groupable"))}else if(t[e].getType()==="aggregatable"){n.push(O.getInternalChartNameFromPropertyNameAndKind(t[e].getPropertyKey(),"aggregatable"))}}if(n.filter(function(e){return r.includes(e)}).length>=1){e.error("Dimension and Measure has the sameProperty Configured")}}}O._createPropertyInfosForAggregatable=function(e,a,r,n,s,o,i,l){const c=[];if(Object.keys(o).includes(a)){for(const e in o[a]){c.push({name:"_fe_aggregatable_"+o[a][e].name,label:o[a][e].label||`${r["@com.sap.vocabularies.Common.v1.Label"]} (${e})`||`${a} (${e})`,sortable:s.propertyInfo[a]?s.propertyInfo[a].sortable:true,filterable:false,groupable:false,aggregatable:true,path:a,dataType:l,aggregationMethod:e,maxConditions:I(n["FilterAllowedExpressions"]?.[a]?.[0])?-1:1,role:y.axis1,datapoint:null,unitPath:r["@Org.OData.Measures.V1.ISOCurrency"]?.$Path||r["@Org.OData.Measures.V1.Unit"]?.$Path})}}if(Object.keys(i).includes(a)){for(const e in i){if(e===a){const a=t({},i[e],{name:"_fe_aggregatable_"+e,groupable:false,aggregatable:true,filterable:false,role:y.axis1,path:e,dataType:l,datapoint:null,unitPath:r["@Org.OData.Measures.V1.ISOCurrency"]?.$Path||r["@Org.OData.Measures.V1.Unit"]?.$Path});c.push(a);break}}}return c};O.rebind=function(e,t){const a=t.parameters.$search;if(a){delete t.parameters.$search}T.rebind(e,t);if(a){const t=e.getControlDelegate().getInnerChart(e),r=t&&t.getBinding("data");r.suspend();r.setAggregation({search:a});const n={onBeforeRendering:function(){r.resume();t.removeEventDelegate(n)}};t.addEventDelegate(n)}e.fireEvent("bindingUpdated")};O._setChart=function(e,t){const a=e.getParent();t.setVizProperties(e.data("vizProperties"));t.detachSelectData(a.handleSelectionChange.bind(a));t.detachDeselectData(a.handleSelectionChange.bind(a));t.detachDrilledUp(a.handleSelectionChange.bind(a));t.attachSelectData(a.handleSelectionChange.bind(a));t.attachDeselectData(a.handleSelectionChange.bind(a));t.attachDrilledUp(a.handleSelectionChange.bind(a));t.setSelectionMode(e.getPayload().selectionMode.toUpperCase());T._setChart(e,t)};O._getBindingInfo=function(e){if(this._getBindingInfoFromState(e)){return this._getBindingInfoFromState(e)}const a=e.getDelegate().payload;const r=t({},a.parameters,{entitySet:e.data("entitySet")});return{path:a.chartContextPath,events:{dataRequested:e.getParent().onInternalDataRequested.bind(e.getParent())},parameters:r}};O.removeItemFromInnerChart=function(e,t){T.removeItemFromInnerChart.call(this,e,t);if(t.getType()==="groupable"){const t=this.getInnerChart(e);t.fireDeselectData()}};O._getSortable=function(e,t,a){if(a){if(e.data("draftSupported").toString()==="true"){return false}else{return t?t.sortable:true}}return t?t.sortable:true};O._checkAndAddDraftFilter=function(e,t){if(e.data("draftSupported").toString()==="true"){if(!t){t={}}if(!t.filters){t.filters=[];t.filters.push(new C("IsActiveEntity",P.EQ,true))}else{t.filters?.aFilters?.push(new C("IsActiveEntity",P.EQ,true))}}};O.getInternalChartNameFromPropertyNameAndKind=function(e,t){return e.replace("_fe_"+t+"_","")};O.getPropertyFromNameAndKind=function(e,t,a){return a.getPropertyHelper().getProperty("_fe_"+t+"_"+e)};O.getFilterDelegate=function(){return Object.assign({apiVersion:2},_,{addItem:async function(e,t){const a=O.getInternalChartNameFromPropertyNameAndKind(t,"groupable");return _.addItem(e,a).then(e=>{e?.bindProperty("conditions",{path:"$filters>/conditions/"+t});e?.setPropertyKey(t);return e})}})};return O},false);
//# sourceMappingURL=ChartDelegate.js.map