/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/fe/core/CommonUtils","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/controls/Common/table/Columns","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ModelHelper","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/DisplayModeFormatter","sap/fe/core/templating/PropertyHelper","sap/fe/core/type/EDM","sap/fe/macros/CommonHelper","sap/fe/macros/DelegateUtil","sap/fe/macros/internal/valuehelp/TableDelegateHelper","sap/ui/core/Element","sap/ui/mdc/odata/v4/TableDelegate","sap/ui/mdc/odata/v4/TypeMap","sap/ui/mdc/odata/v4/util/DelegateUtil","sap/ui/mdc/util/FilterUtil","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter"],function(e,t,a,n,o,r,s,i,c,p,l,f,g,d,u,y,h,m,b,P,C,v){"use strict";var I=d.isSortableProperty;var M=d.isFilterableProperty;var T=d.getPath;var $=l.isTypeFilterable;var O=p.getLabel;var S=p.getAssociatedUnitPropertyPath;var D=p.getAssociatedTimezonePropertyPath;var E=p.getAssociatedTextPropertyPath;var F=p.getAssociatedCurrencyPropertyPath;var x=c.getDisplayMode;var B=i.getTargetObjectPath;var j=i.enhanceDataModelPath;var w=r.isMultiValueFilterExpression;var N=r.getSortRestrictionsInfo;var k=r.getFilterRestrictionsInfo;var A=o.getTypeConfig;var _=n.getInvolvedDataModelObjects;const R=Object.assign({},y);R.fetchProperties=async function(e){const t=await this._getModel(e);const a=await this._createPropertyInfos(e,t);R.createInternalBindingContext(e);R.setSortConditions(e,a);g.setCachedProperties(e,a);e.getBindingContext("internal").setProperty("tablePropertiesAvailable",true);return a};R.setSortConditions=function(e,t){const a=e.data("sortConditions");const n=f.parseCustomData(a);if(n?.sorters){n.sorters.forEach(e=>{const a=R.convertPropertyPathToInfoName(e.name,t);if(a&&a!==e.name){e.name=a}});e.setSortConditions({...n})}};R.convertPropertyPathToInfoName=function(e,t){const a=t.find(t=>!t.propertyInfos&&t.path===e);return a?.key??e};R.createInternalBindingContext=function(e){let t=e;while(t&&!t.isA("sap.ui.mdc.valuehelp.Dialog")){t=t.getParent()}const a=e.getModel("internal");if(t&&a){const n=t.getBindingContext("internal");let o;if(n){o=n.getPath()+`::VHDialog::${t.getId()}::table`}else{o=`/buildingblocks/${e.getId()}`;a.setProperty("/buildingblocks",{...a.getProperty("/buildingblocks")})}const r=a.bindContext(o).getBoundContext();e.setBindingContext(r,"internal")}};function U(e){const t=q(e);const a={};if(t?.targetObject){const n=t.targetObject;const o=B(t,true);const r=e.targetObject;const s=B(e,true);const i=r.annotations?.Common?.Text,c=i?.annotations?.UI?.TextArrangement?.toString(),p=i&&c&&x(r);if(p==="Description"){a[o]=n}else if(p&&p!=="Value"||!i){a[s]=r;a[o]=n}}return a}R._createPropertyInfos=async function(e,t){const a=e.getDelegate().payload;const n=[];const o=`/${a.collectionName}`;const r=t.getMetaModel();return r.requestObject(`${o}@`).then(function(t){const a=N(t);const i=t["@Org.OData.Capabilities.V1.FilterRestrictions"];const c=k(i);const p=t["@Org.OData.Capabilities.V1.FilterFunctions"];const l=s.isFilteringCaseSensitive(r,p);const f=g.getCustomData(e,"columns");const d={};const u=_(e.getModel().getMetaModel().getContext(o));f.customData.forEach(function(t){let o=$(t.$Type)?e.getTypeMap().getTypeConfig(t.$Type):h.getTypeConfig("sap.ui.model.odata.type.String");const r={key:t.path,label:t.label};const s=j(u,t.path);const i=s.targetObject;if(i){const e=B(s,true);if($(i.type)){const e=A(i);o=h.getTypeConfig(e.type??"sap.ui.model.odata.type.String",e.formatOptions,e.constraints)??o}const n=U(s);const p=Object.keys(n);if(p.length){r.propertyInfos=p;p.forEach(e=>{d[e]=n[e]});if(!p.find(e=>n[e]===i)){d[e]=i}}else{r.path=t.path;r.dataType=o.className;r.constraints=t.constraints;r.formatOptions=t.formatOptions;r.sortable=I(a,t);r.filterable=M(c,t);r.maxConditions=V(c,t);r.caseSensitive=l}}else{r.path=t.path;r.caseSensitive=l;r.dataType=o.className}n.push(r)});const y=H(d,n,a,c,l);return n.concat(y)})};R.updateBindingInfo=function(e,t){y.updateBindingInfo.apply(this,[e,t]);const n=e.getDelegate().payload;if(n){t.path=t?.path||n.collectionPath||`/${n.collectionName}`}t.parameters=t.parameters||{};const o=u.getElementById(e.getFilter()),r=e.isFilteringEnabled();let i;let c,p;const l=[];const f=g.getCachedProperties(e);if(r){i=e.getConditions();c=b.getFilterInfo(e,i,f,[]);if(c.filters){l.push(c.filters)}}const d=!!n?.hierarchyQualifier;if(d){t.parameters.$$aggregation={hierarchyQualifier:n.hierarchyQualifier,expandTo:n.initialExpansionLevel}}if(o){i=o.getConditions();if(i){const a=m.getParameterNames(o);R._updatePropertyInfo(f,e,i,n);p=b.getFilterInfo(o,i,f,a);if(p.filters){l.push(p.filters)}const r=m.getParametersInfo(o,i);if(r){t.path=r}}if(!d){t.parameters.$search=a.normalizeSearchTerm(o.getSearch())||undefined}else if(o.getSearch()){if(!t.parameters.$$aggregation){t.parameters.$$aggregation={}}t.parameters.$$aggregation.search=a.normalizeSearchTerm(o.getSearch());t.parameters.$$aggregation.expandTo=Number.MAX_SAFE_INTEGER}}t.parameters.$$sharedRequest=false;this._applyDefaultSorting(t,e.getDelegate().payload);t.parameters.$select=f?.reduce(function(e,t){if(t.path&&!t.path.includes("/")){e=e?`${e},${t.path}`:t.path}return e},"");t.parameters.$count=true;if(t.path&&s.isDraftSupported(e.getModel()?.getMetaModel(),t.path)){l.push(new P("IsActiveEntity",C.EQ,true))}t.filters=new P(l,true)};R.getTypeMap=function(){return h};R._getModel=async function(e){const t=e.getDelegate().payload;let a=e.getModel(t.model);if(!a){await new Promise(t=>{e.attachEventOnce("modelContextChange",t)});a=e.getModel(t.model)}return a};R._applyDefaultSorting=function(e,t){if(e.parameters&&e.parameters.$search==undefined&&e.parameters.$$aggregation?.search==undefined&&e.sorter&&e.sorter.length==0){const a=t?t.defaultSortPropertyName:undefined;if(a){e.sorter.push(new v(a,false))}}};R._updatePropertyInfo=function(e,t,a,n){const o=Object.keys(a),r=t.getModel().getMetaModel();o.forEach(function(a){const o=r.getObject(`/${n.collectionName}/${a}`)?.$Type??"Edm.String";const s=t.getTypeMap().getTypeConfig(o);e.forEach((t,n)=>{if(t.path===a){e[n].typeConfig=s}});if(e.findIndex(function(e){return e.path===a})===-1){const t={key:a,label:a,path:a,dataType:s.typeInstance.baseType,formatOptions:s.typeInstance?.oFormatOptions,constraints:s.typeInstance?.oConstraints};e.push(t)}})};R.updateBinding=function(a,n,o){let r=false;const s=a.getBindingContext("internal");const i="pendingManualBindingUpdate";const c="lastSearch";const p="lastFilter";const l=s?.getProperty(i);const f=s?.getProperty(c);const g=s?.getProperty(p);let d=a.getRowBinding();y.updateBinding.apply(R,[a,n,o]);if(!d){d=a.getRowBinding()}if(d){r=s?t(n.filters,g)&&n.parameters?.$search===f&&!l:true}s?.setProperty(c,n.parameters?.$search);s?.setProperty(p,n.filters);if(r&&a.getFilter()){s?.setProperty(i,true);d.requestRefresh(d.getGroupId()).finally(function(){s?.setProperty(i,false)}).catch(function(t){e.error("Error while refreshing a filterBar VH table",t)})}a.fireEvent("bindingUpdated")};function H(e,t,a,n,o){const r={},s=[];Object.keys(e).forEach(i=>{const c=e[i],p=t.find(e=>e.path===i);if(!p){const e=`Property::${i}`;r[i]=e;const t=A(c);const p=h.getTypeConfig(t.type??"sap.ui.model.odata.type.String",t.formatOptions,t.constraints);const l={key:e,label:O(c),path:i,sortable:I(a,c),filterable:M(n,c),dataType:p.className,formatOptions:$(c.type)?t.formatOptions:undefined,constraints:$(c.type)?t.constraints:undefined,caseSensitive:o};l.maxConditions=V(n,l);s.push(l)}});t.forEach(e=>{if(e.propertyInfos){e.propertyInfos=e.propertyInfos?.map(e=>r[e]??e)}});return s}function V(e,t){const a=T(t);return a&&e.propertyInfo?.hasOwnProperty(a)&&w(e.propertyInfo[a])?-1:1}function q(e){const t=e.targetObject;const a=t&&(E(t)||F(t)||S(t)||D(t));if(!a){return undefined}const n=j(e,a);const o=n.targetObject;if(!o){return undefined}return n}return R},false);
//# sourceMappingURL=TableDelegate.js.map