{"version":3,"file":"CollaborationAPI.js","names":["CollaborationAPI","_lastReceivedMessages","_rootPath","_oModel","undefined","_lockedPropertyPath","_internalModel","_receivedLocks","enterDraft","oContext","userID","userName","webSocketBaseURL","getModel","getMetaModel","getObject","Log","error","sDraftUUID","getProperty","this","JSONModel","model","initializeCollaboration","id","name","initialName","_onMessageReceived","bind","getPath","checkReceived","message","resetHistory","arguments","length","found","some","receivedMessage","userAction","clientContent","leaveDraft","endCollaboration","destroy","lockField","sPropertyPath","unlockField","broadcastCollaborationMessage","Activity","Lock","updatePropertyValue","value","oContextBinding","bindContext","$$patchWithoutSideEffects","$$groupId","$$updateGroupId","oPropertyBinding","bindProperty","getBoundContext","requestValue","then","setValue","attachEventOnce","Change","catch","err","Unlock","discardDraft","draftContext","_getDraftContext","requestProperty","draft","deleteDraft","MessageHandler","AppComponent","Discard","replace","deleteObject","objectPath","objectContext","_getObjectContext","delete","Delete","checkLockedByOther","includes","path","clientAction","push","Join","JoinEcho","split","filter","lock"],"sources":["./CollaborationAPI.ts"],"sourcesContent":["import Log from \"sap/base/Log\";\nimport AppComponent from \"sap/fe/core/AppComponent\";\nimport type { FEView } from \"sap/fe/core/BaseController\";\nimport MessageHandler from \"sap/fe/core/controllerextensions/MessageHandler\";\nimport {\n\tbroadcastCollaborationMessage,\n\tendCollaboration,\n\tinitializeCollaboration\n} from \"sap/fe/core/controllerextensions/collaboration/ActivityBase\";\nimport type { Message } from \"sap/fe/core/controllerextensions/collaboration/CollaborationCommon\";\nimport { Activity } from \"sap/fe/core/controllerextensions/collaboration/CollaborationCommon\";\nimport draft from \"sap/fe/core/controllerextensions/editFlow/draft\";\nimport JSONModel from \"sap/ui/model/json/JSONModel\";\nimport type Context from \"sap/ui/model/odata/v4/Context\";\nimport type ODataModel from \"sap/ui/model/odata/v4/ODataModel\";\n\nconst CollaborationAPI = {\n\t_lastReceivedMessages: [] as Message[],\n\t_rootPath: \"\",\n\t_oModel: undefined as ODataModel | undefined,\n\t_lockedPropertyPath: \"\",\n\t_internalModel: undefined as JSONModel | undefined,\n\t_receivedLocks: [] as string[],\n\n\t/**\n\t * Open an existing collaborative draft with a new user, and creates a 'ghost client' for this user.\n\t * @param oContext The context of the collaborative draft\n\t * @param userID The ID of the user\n\t * @param userName The name of the user\n\t */\n\tenterDraft: function (oContext: Context, userID: string, userName: string) {\n\t\tconst webSocketBaseURL: string = oContext.getModel().getMetaModel().getObject(\"/@com.sap.vocabularies.Common.v1.WebSocketBaseURL\");\n\n\t\tif (!webSocketBaseURL) {\n\t\t\tLog.error(\"Cannot find WebSocketBaseURL annotation\");\n\t\t\treturn;\n\t\t}\n\n\t\tconst sDraftUUID: string = oContext.getProperty(\"DraftAdministrativeData/DraftUUID\");\n\t\tthis._internalModel = new JSONModel({});\n\t\tconst model = oContext.getModel();\n\n\t\tinitializeCollaboration(\n\t\t\t{\n\t\t\t\tid: userID,\n\t\t\t\tname: userName,\n\t\t\t\tinitialName: userName\n\t\t\t},\n\t\t\tsDraftUUID,\n\t\t\tthis._internalModel,\n\t\t\tthis._onMessageReceived.bind(this),\n\t\t\t{\n\t\t\t\tgetModel: function () {\n\t\t\t\t\treturn model;\n\t\t\t\t}\n\t\t\t} as FEView,\n\t\t\ttrue\n\t\t);\n\n\t\tthis._rootPath = oContext.getPath();\n\t\tthis._oModel = model;\n\t},\n\n\t/**\n\t * Checks if the ghost client has received a given message.\n\t * @param message The message content to be looked for\n\t * @param resetHistory If true, reset history of received messages\n\t * @returns True if a previously received message matches the content\n\t */\n\tcheckReceived: function (message: Partial<Message>, resetHistory = true): boolean {\n\t\tif (this._lastReceivedMessages.length === 0) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst found = this._lastReceivedMessages.some((receivedMessage) => {\n\t\t\treturn (\n\t\t\t\t(!message.userID || message.userID === receivedMessage.userID) &&\n\t\t\t\t(!message.userAction || message.userAction === receivedMessage.userAction) &&\n\t\t\t\t(!message.clientContent || message.clientContent === receivedMessage.clientContent)\n\t\t\t);\n\t\t});\n\n\t\tif (resetHistory) {\n\t\t\tthis._lastReceivedMessages = []; // by default, reset history to avoid finding the same message twice\n\t\t}\n\n\t\treturn found;\n\t},\n\n\t/**\n\t * Closes the ghost client and removes the user from the collaborative draft.\n\t */\n\tleaveDraft: function () {\n\t\tif (this._internalModel) {\n\t\t\tendCollaboration(this._internalModel);\n\t\t\tthis._internalModel.destroy();\n\t\t\tthis._internalModel = undefined;\n\t\t}\n\t},\n\n\t/**\n\t * Simulates that the user starts typing in an input (live change).\n\t * @param sPropertyPath The path of the property being modified\n\t */\n\tlockField: function (sPropertyPath: string) {\n\t\tif (this._internalModel) {\n\t\t\tif (this._lockedPropertyPath) {\n\t\t\t\t// Unlock previous property path\n\t\t\t\tthis.unlockField();\n\t\t\t}\n\t\t\tthis._lockedPropertyPath = sPropertyPath;\n\t\t\tbroadcastCollaborationMessage(Activity.Lock, `${this._rootPath}/${sPropertyPath}`, this._internalModel);\n\t\t}\n\t},\n\n\t/**\n\t * Simulates that the user has modified a property.\n\t * @param sPropertyPath The path of the property being modified\n\t * @param value The new value of the property being modified\n\t */\n\tupdatePropertyValue: function (sPropertyPath: string, value: any) {\n\t\tif (this._internalModel) {\n\t\t\tif (this._lockedPropertyPath !== sPropertyPath) {\n\t\t\t\tthis.lockField(sPropertyPath);\n\t\t\t}\n\n\t\t\tconst oContextBinding = this._oModel!.bindContext(this._rootPath, undefined, {\n\t\t\t\t$$patchWithoutSideEffects: true,\n\t\t\t\t$$groupId: \"$auto\",\n\t\t\t\t$$updateGroupId: \"$auto\"\n\t\t\t});\n\n\t\t\tconst oPropertyBinding = this._oModel!.bindProperty(sPropertyPath, oContextBinding.getBoundContext());\n\n\t\t\toPropertyBinding\n\t\t\t\t.requestValue()\n\t\t\t\t.then(() => {\n\t\t\t\t\toPropertyBinding.setValue(value);\n\t\t\t\t\toContextBinding.attachEventOnce(\"patchCompleted\", () => {\n\t\t\t\t\t\tbroadcastCollaborationMessage(Activity.Change, `${this._rootPath}/${sPropertyPath}`, this._internalModel!);\n\t\t\t\t\t\tthis.unlockField();\n\t\t\t\t\t\tthis._lockedPropertyPath = \"\";\n\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch(function (err) {\n\t\t\t\t\tLog.error(err);\n\t\t\t\t});\n\t\t}\n\t},\n\n\t/**\n\t * Simulates that the user unlocked a field (to be called after lockField).\n\t */\n\tunlockField: function () {\n\t\tif (this._lockedPropertyPath) {\n\t\t\tbroadcastCollaborationMessage(Activity.Unlock, `${this._rootPath}/${this._lockedPropertyPath}`, this._internalModel!);\n\t\t\tthis._lockedPropertyPath = \"\";\n\t\t}\n\t},\n\n\t/**\n\t * Simulates that the user has discarded the draft.\n\t */\n\tdiscardDraft: function () {\n\t\tif (this._internalModel) {\n\t\t\tconst draftContext = this._getDraftContext();\n\n\t\t\tdraftContext\n\t\t\t\t.requestProperty(\"IsActiveEntity\")\n\t\t\t\t.then(() => {\n\t\t\t\t\tdraft.deleteDraft(draftContext, new MessageHandler(), new AppComponent());\n\t\t\t\t})\n\t\t\t\t.then(() => {\n\t\t\t\t\tbroadcastCollaborationMessage(\n\t\t\t\t\t\tActivity.Discard,\n\t\t\t\t\t\tthis._rootPath.replace(\"IsActiveEntity=false\", \"IsActiveEntity=true\"),\n\t\t\t\t\t\tthis._internalModel!\n\t\t\t\t\t);\n\t\t\t\t\tthis._internalModel!.destroy();\n\t\t\t\t\tthis._internalModel = undefined;\n\t\t\t\t})\n\t\t\t\t.catch(function (err: any) {\n\t\t\t\t\tLog.error(err);\n\t\t\t\t});\n\t\t}\n\t},\n\n\t/**\n\t * Simulates that the user has deleted an object (child of draft root).\n\t * @param objectPath The path of the object to delete\n\t */\n\tdeleteObject: function (objectPath: string) {\n\t\tif (this._internalModel) {\n\t\t\tconst objectContext = this._getObjectContext(objectPath);\n\n\t\t\tobjectContext\n\t\t\t\t.requestProperty(\"IsActiveEntity\")\n\t\t\t\t.then(() => {\n\t\t\t\t\tobjectContext.delete();\n\t\t\t\t\tbroadcastCollaborationMessage(Activity.Delete, objectPath, this._internalModel!);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tLog.error(err);\n\t\t\t\t});\n\t\t}\n\t},\n\n\t/**\n\t * Checks if a property has been locked by another user.\n\t * @param objectPath\n\t * @returns True if locked\n\t */\n\tcheckLockedByOther: function (objectPath: string): boolean {\n\t\treturn this._receivedLocks.includes(objectPath);\n\t},\n\n\t// /////////////////////////////\n\t// Private methods\n\n\t_getDraftContext: function (): any {\n\t\treturn this._getObjectContext(this._rootPath);\n\t},\n\n\t_getObjectContext: function (path: string): Context {\n\t\treturn this._oModel!.bindContext(path, undefined, {\n\t\t\t$$patchWithoutSideEffects: true,\n\t\t\t$$groupId: \"$auto\",\n\t\t\t$$updateGroupId: \"$auto\"\n\t\t}).getBoundContext();\n\t},\n\n\t/**\n\t * Callback of the ghost client when receiving a message on the web socket.\n\t * @param message\n\t */\n\t_onMessageReceived: function (message: Message) {\n\t\tmessage.userAction = message.userAction || message.clientAction;\n\t\tif (!message.clientContent) {\n\t\t\tmessage.clientContent = \"\";\n\t\t}\n\t\tthis._lastReceivedMessages.push(message);\n\n\t\tswitch (message.userAction) {\n\t\t\tcase Activity.Join:\n\t\t\t\tbroadcastCollaborationMessage(\n\t\t\t\t\tActivity.JoinEcho,\n\t\t\t\t\tthis._lockedPropertyPath ? `${this._rootPath}/${this._lockedPropertyPath}` : undefined,\n\t\t\t\t\tthis._internalModel!\n\t\t\t\t);\n\t\t\t\tbreak;\n\n\t\t\tcase Activity.JoinEcho:\n\t\t\tcase Activity.Lock:\n\t\t\t\tthis._receivedLocks.push(...message.clientContent.split(\"|\"));\n\t\t\t\tbreak;\n\n\t\t\tcase Activity.Unlock:\n\t\t\t\tthis._receivedLocks = this._receivedLocks.filter((lock) => {\n\t\t\t\t\treturn !message.clientContent.split(\"|\").includes(lock);\n\t\t\t\t});\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t// Nothing\n\t\t}\n\t}\n};\n\nexport default CollaborationAPI;\n"],"mappings":"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","ignoreList":[]}