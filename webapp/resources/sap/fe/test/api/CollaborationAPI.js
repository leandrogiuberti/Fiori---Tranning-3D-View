/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/AppComponent","sap/fe/core/controllerextensions/MessageHandler","sap/fe/core/controllerextensions/collaboration/ActivityBase","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controllerextensions/editFlow/draft","sap/ui/model/json/JSONModel"],function(e,t,o,n,i,s,r){"use strict";var a=i.Activity;var c=n.initializeCollaboration;var l=n.endCollaboration;var d=n.broadcastCollaborationMessage;const h={_lastReceivedMessages:[],_rootPath:"",_oModel:undefined,_lockedPropertyPath:"",_internalModel:undefined,_receivedLocks:[],enterDraft:function(t,o,n){const i=t.getModel().getMetaModel().getObject("/@com.sap.vocabularies.Common.v1.WebSocketBaseURL");if(!i){e.error("Cannot find WebSocketBaseURL annotation");return}const s=t.getProperty("DraftAdministrativeData/DraftUUID");this._internalModel=new r({});const a=t.getModel();c({id:o,name:n,initialName:n},s,this._internalModel,this._onMessageReceived.bind(this),{getModel:function(){return a}},true);this._rootPath=t.getPath();this._oModel=a},checkReceived:function(e){let t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;if(this._lastReceivedMessages.length===0){return false}const o=this._lastReceivedMessages.some(t=>(!e.userID||e.userID===t.userID)&&(!e.userAction||e.userAction===t.userAction)&&(!e.clientContent||e.clientContent===t.clientContent));if(t){this._lastReceivedMessages=[]}return o},leaveDraft:function(){if(this._internalModel){l(this._internalModel);this._internalModel.destroy();this._internalModel=undefined}},lockField:function(e){if(this._internalModel){if(this._lockedPropertyPath){this.unlockField()}this._lockedPropertyPath=e;d(a.Lock,`${this._rootPath}/${e}`,this._internalModel)}},updatePropertyValue:function(t,o){if(this._internalModel){if(this._lockedPropertyPath!==t){this.lockField(t)}const n=this._oModel.bindContext(this._rootPath,undefined,{$$patchWithoutSideEffects:true,$$groupId:"$auto",$$updateGroupId:"$auto"});const i=this._oModel.bindProperty(t,n.getBoundContext());i.requestValue().then(()=>{i.setValue(o);n.attachEventOnce("patchCompleted",()=>{d(a.Change,`${this._rootPath}/${t}`,this._internalModel);this.unlockField();this._lockedPropertyPath=""})}).catch(function(t){e.error(t)})}},unlockField:function(){if(this._lockedPropertyPath){d(a.Unlock,`${this._rootPath}/${this._lockedPropertyPath}`,this._internalModel);this._lockedPropertyPath=""}},discardDraft:function(){if(this._internalModel){const n=this._getDraftContext();n.requestProperty("IsActiveEntity").then(()=>{s.deleteDraft(n,new o,new t)}).then(()=>{d(a.Discard,this._rootPath.replace("IsActiveEntity=false","IsActiveEntity=true"),this._internalModel);this._internalModel.destroy();this._internalModel=undefined}).catch(function(t){e.error(t)})}},deleteObject:function(t){if(this._internalModel){const o=this._getObjectContext(t);o.requestProperty("IsActiveEntity").then(()=>{o.delete();d(a.Delete,t,this._internalModel)}).catch(t=>{e.error(t)})}},checkLockedByOther:function(e){return this._receivedLocks.includes(e)},_getDraftContext:function(){return this._getObjectContext(this._rootPath)},_getObjectContext:function(e){return this._oModel.bindContext(e,undefined,{$$patchWithoutSideEffects:true,$$groupId:"$auto",$$updateGroupId:"$auto"}).getBoundContext()},_onMessageReceived:function(e){e.userAction=e.userAction||e.clientAction;if(!e.clientContent){e.clientContent=""}this._lastReceivedMessages.push(e);switch(e.userAction){case a.Join:d(a.JoinEcho,this._lockedPropertyPath?`${this._rootPath}/${this._lockedPropertyPath}`:undefined,this._internalModel);break;case a.JoinEcho:case a.Lock:this._receivedLocks.push(...e.clientContent.split("|"));break;case a.Unlock:this._receivedLocks=this._receivedLocks.filter(t=>!e.clientContent.split("|").includes(t));break;default:}}};return h},false);
//# sourceMappingURL=CollaborationAPI.js.map