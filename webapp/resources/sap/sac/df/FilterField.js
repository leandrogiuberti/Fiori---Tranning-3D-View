/*!
 * SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
 */
sap.ui.define("sap/sac/df/FilterField",["sap/ui/mdc/FilterField","sap/ui/core/Element","sap/ui/mdc/field/FieldBase","sap/ui/mdc/field/FieldBaseRenderer","sap/ui/mdc/enums/FieldDisplay","sap/base/util/merge","sap/base/util/deepEqual","sap/sac/df/model/MemberFilter","sap/sac/df/utils/ResourceBundle","sap/sac/df/filter/TypeMap","sap/ui/mdc/condition/Condition","sap/ui/base/ManagedObjectObserver","sap/ui/mdc/enums/ConditionValidated","sap/ui/mdc/ValueHelp","sap/sac/df/filter/ValueHelp","sap/ui/mdc/valuehelp/content/FixedListItem","sap/ui/mdc/valuehelp/Popover","sap/ui/core/date/UI5Date","sap/ui/core/library","sap/sac/df/firefly/library","sap/sac/df/thirdparty/lodash","sap/sac/df/types/DisplayType","sap/ui/mdc/field/ConditionType","sap/ui/model/FilterOperator","sap/ui/mdc/condition/FilterOperatorUtil"],function(e,t,i,s,a,n,r,o,l,u,h,p,c,d,g,f,_,m,b,y,F,M,V,O,C){"use strict";const P=b.ValueState;const T=b.format.DateFormat;const v=e.extend("sap.sac.df.FilterField",{metadata:{library:"sap.sac.df",designtime:"sap/ui/mdc/designtime/field/FilterField.designtime",properties:{metaPath:{type:"string"}}},renderer:s,init:function(){e.prototype.init.apply(this,arguments);this._oObserver.observe(this,{properties:["operators","propertyKey","additionalDataType"],aggregations:["_content","filterItems","dependents"]});this.attachEvent("_onValueHelpRequest",null,this._onValueHelpRequest.bind(this));this.attachEvent("press",null,this._onValueHelpRequest.bind(this));this.setDelegate({name:"sap/sac/df/filter/delegate/FieldBaseDelegate"})},setMetaPath:function(e){e=e.replace("&gt;",">");this.setProperty("metaPath",e);i.prototype.setProperty.call(this,"metaPath",e);if(!this.getPropertyKey()){this.setProperty("propertyKey",e.split("/").pop());i.prototype.setProperty.call(this,"propertyKey",e.split("/").pop())}this._initialise()},_initialise:function(){if(!this._initialized){if(this._getMetaObject()){this._setupFilterFieldFromMetaPath()}else{if(this._isVariableGroup()){this._getMultiDimModel()&&this._getMultiDimModel().attachEventOnce("variableGroupsAdded",null,this._setupFilterFieldFromMetaPath.bind(this))}else{this._getMultiDimModel()&&this._getMultiDimModel().attachEventOnce("dataProviderAdded",null,this._setupFilterFieldFromMetaPath.bind(this))}}}},onAfterRendering:function(){this._initialise()},_setupFilterFieldFromMetaPath:function(){this._setMetaObjectPath(this.getMetaPath().split(">")[1]);this._setupFilterField()},_getMultiDimModel:function(){return this.getMetaPath()&&this.getMetaPath().split(">")&&this.getModel(this.getMetaPath().split(">")[0])},_getMetaObjectType:function(){return this._getMetaObject()&&this._getMetaObject().getMetadata().getName()},_isVariableGroup:function(){return this._getMetaObjectType()==="sap.sac.df.model.VariableGroup"},_isDate:function(){const e=this._getValueType();return e.includes("Date")||e.includes("Time")},_getValueType:function(){let e=this._getMetaObject();if(this._isVariableGroup()){e=this._getMetaObject().MergedVariable}if(e.ValueType==="Date"&&this._isDimension()){return"String"}return e&&e.ValueType?e.ValueType:"String"},_isVariable:function(){return this._getMetaObjectType()==="sap.sac.df.model.Variable"},_isDimension:function(){return this._getMetaObjectType()==="sap.sac.df.model.Dimension"},_setMetaObjectPath:function(e){return this._metaObjectPath=e},_getMetaObjectPath:function(){return this._metaObjectPath},_getMetaObject:function(){return this.getMetaPath()&&this.getMetaPath().split(">")&&this._getMultiDimModel()&&this._getMultiDimModel().getProperty(this.getMetaPath().split(">")[1])},_setupFilterField:function(){this.setBlocked(true);let e=this._getMetaObject();if(!e||this._initialized){return}this._initialized=true;let t=this.getMetaPath();if(this._isVariableGroup()){e=this._getMetaObject().MergedVariable;t=t+"/MergedVariable"}const i=this._isDate();const s=i&&e.SupportsMultipleValues?"String":this._getValueType();const a=this._getMetaObjectType()==="Dimension"||e.SupportsMultipleValues;const n=this._getMetaObjectType()==="Dimension"||e.Mandatory;const r=u.getFormatOptions(s);this.setProperty("dataType",u.getDataTypeClassName(s));this.setProperty("dataTypeFormatOptions",r?r:null);if(!this._isDimension()){this.setAssociation("valueHelp",this._supportsValueHelp()?null:"DEFAULT")}this.setProperty("label",e.Description);this.setProperty("required",!!n);this.bindProperty("valueState",{parts:[{path:t+"/Mandatory"},{path:t+"/MemberFilter"}],formatter:this._getValueState.bind(this)});this.setProperty("maxConditions",this._isDimension()||a?-1:1);this.setProperty("operators",i&&!a?["EQ"]:[]);this.setProperty("defaultOperator","EQ");this.awaitControlDelegate().then(()=>{this.bindProperty("display",{path:t+"/FilterDisplayType",formatter:this._getDisplay.bind(this)});this.bindProperty("conditions",{path:t+"/MemberFilter",formatter:this._setConditions.bind(this)})});this._observeContent();this.setBlocked(false)},_observeContent:function(){this._getObserver().observe(this,{aggregations:["_content"]})},_addValueHelpAssociation:function(){if(!this.getAssociation("valueHelp")){this.setAssociation("valueHelp",new g(this.getId()+"--ValueHelp"))}},_getValueState:function(e,t){return this._getLiveMode()&&e&&t&&t.length===0?P.Error:P.None},_supportsValueHelp:function(){let e=this._getMetaObject();if(this._isVariableGroup()){e=this._getMetaObject().MergedVariable}return this._getMetaObjectType()==="Dimension"?true:e.SupportsValueHelp},_getConditionForMemberFilter:function(e){const t=this._isDate()?e.InternalKey:e.Key;let i=new V(this.getFormatOptions());let s="";let a="";const n=this._getMDCFilterOperatorFromModelOperator(e.Operator);switch(e.Operator){case O.EQ:return h.createItemCondition(t[0],e.Text[0],null,null,e);case O.BT:case O.NB:s=i.formatValue(h.createItemCondition(t[0],e.Text[0]),"string");a=i.formatValue(h.createItemCondition(t[1],e.Text[1]),"string");return h.createCondition(n,[s,a],null,null,c.Validated,e);default:s=i.formatValue(h.createItemCondition(t[0],e.Text[0]),"string");return h.createCondition(n,[s],null,null,c.Validated,e)}},_getMDCFilterOperatorFromModelOperator:function(e){let t=F.filter(C._mOperators,t=>t.filterOperator===e);if(t.length>1){t=F.find(C._mOperators,t=>t.filterOperator===e&&t.exclude===false)}return t&&t.name},_getDisplay:function(e){let t=this.getDisplay();let i=this._getMetaObject();if(this._isVariableGroup()){i=this._getMetaObject().MergedVariable}const s=i.MemberFilter&&i.MemberFilter.length>0&&i.MemberFilter[0]&&i.MemberFilter[0].Text!==i.MemberFilter[0].Key;if(!this._isDimension()&&!this._supportsValueHelp()||this._isDate()){t=a.Value}else{if(e){switch(i.FilterDisplayType){case M.Text:t=a.Description;break;case M.Key:t=this.getMaxConditions()===1&&s?a.Description:a.Value;break;case M.KeyText:t=a.ValueDescription;break;case M.TextKey:t=a.DescriptionValue;break}}}this._observeContent();return t},_setConditionsForFilterField:function(e){const t=[];e.forEach(function(e){t.push(this._getConditionForMemberFilter(e))}.bind(this));this.setConditions(t);return t},_setConditionsForFilterBar:function(e){const t=[];e.forEach(function(e){t.push(this._getConditionForMemberFilter(e))}.bind(this));this._getFilterBar()._getConditionModel().setProperty("/conditions/"+this.getPropertyKey(),t);return t},_setConditions:function(e){if(e&&e.length>0){const t=this._getFilterBar();if(t){return t._adaptFiltersDialogIsOpen?this._setConditionsForFilterField(e):this._setConditionsForFilterBar(e)}else{return this._setConditionsForFilterField(e)}}},getFilterFieldId:function(e){return this.getId()+"::FilterField::"+e.replace(/[^0-9A-Z_.:-]/gi,"")},observeChanges:function(t){e.prototype.observeChanges.apply(this,arguments);if(t.name==="_content"){this._onFieldChange(t.object,true)}if(t.name==="filterItems"){this._onFieldChange(t.child,false)}},_onFieldChange:function(e,t){const i=e.getAggregation("_content")&&e.getAggregation("_content")[0];if(i){const s=i.mEventRegistry;let a;while(s.change&&s.change.length){a=s.change[0];i.detachChange(a.fFunction,a.oListener)}while(s.tokenUpdate&&s.tokenUpdate.length){a=s.tokenUpdate[0];i.detachTokenUpdate(a.fFunction,a.oListener)}while(s.valueHelpRequest&&s.valueHelpRequest.length){a=s.valueHelpRequest[0];i.detachValueHelpRequest(a.fFunction,a.oListener)}if(i.attachValueHelpRequest){i.attachValueHelpRequest(null,this._onValueHelpRequest,this)}if(i.attachChange){i.attachChange(null,this._onChange,this)}if(i.attachTokenUpdate){i.attachTokenUpdate(null,this._onTokenUpdate,this)}if(t){this._getObserver().unobserve(e,{aggregations:["_content"]})}}},_getObserver:function(){if(!this._oObserver){this._oObserver=new p(this.observeChanges.bind(this))}return this._oObserver},_onTokenUpdate:function(e){const t=this;const i=this._getMetaObject();if(e.getParameter("type")==="removed"){const s=e.getParameter("removedTokens")[0];const a=this.getConditions()[e.getSource().indexOfToken(s)];const n=a.payload;if(n&&n.InternalKey.length>0){this._setBusy(true);return Promise.resolve(i.removeMemberFilter(n)).then(function(){e.getSource().setValue(null);t._setBusy(false);t._filterChanged()}).catch(function(){t._setBusy(false)})}}},_onChange:function(e){const t=this;let i=e.getParameter("newValue");let s=null;let a=[];const n=this._getMetaObject();let r=this._getMetaObject();if(this._isVariableGroup()){r=this._getMetaObject().MergedVariable}this._setBusy(true);this.setValueState(P.None);if(!this._supportsValueHelp()){i=null}if(!i){a=this.getConditions().filter(e=>e.validated==="NotValidated");if(a.length>0){i=a[0].values[0];s=a[0].operator}}if(i){return Promise.resolve(t._isSearchSupported()?t._validateValue(r,i):[new o([i])]).then(function(e){if(e){if(e.length>1){return t._openTypeAheadPopover(e)}if(s){e[0].Operator=s}return t.getMaxConditions()===1?n.setMemberFilter(e):n.addMemberFilter(e[0])}else{t.setValueState(P.Error);t.setValueStateText(l.getText("FILTERBAR_VALUEHELP_VALUE_NOT_EXIST",[i]))}}).then(function(){t._setBusy(false);t.setValueStateText();t._filterChanged()}).catch(function(){t._setBusy(false)})}else{if(r.MemberFilter.length>0){return Promise.resolve(n.setMemberFilter(null)).then(function(){t._setBusy(false);t._filterChanged()}).catch(function(){t._setBusy(false)})}else{t.setConditions([]);t._setBusy(false)}}},_onValueHelpRequest:function(){const e=this;const t=this._getMetaObject();return t.openValueHelpDialog(this._sFilterValue).then(function(t){if(t){e._filterChanged()}})},_setBusy:function(e){if(this.getParent().isA("sap.ui.mdc.FilterBar")){this.getParent().setBusy(e)}else{this.setBusy(e)}},_isSearchSupported:function(){let e=this._getMetaObject();if(this._isVariableGroup()){e=this._getMetaObject().MergedVariable}return this._isDimension()||!this._isDate()&&e.SupportsValueHelp&&e.IsFilterable},_getLiveMode:function(){return this._getFilterBar()?this._getFilterBar().getLiveMode():true},_getFilterBar:function(){const e=this.getParent();let i;if(e){if(e.isA("sap.ui.mdc.FilterBar")){i=e}else if(e.isA("sap.ui.mdc.filterbar.p13n.AdaptationFilterBar")){i=t.getElementById(e.getAssociation("adaptationControl"))}}return i},_filterChanged:function(){if(this._getFilterBar()){this._getFilterBar()._filterChanged(this)}},_openTypeAheadPopover:function(e){const i=this;const s=new V(this.getFormatOptions());let a=t.getElementById(i.getId()+"--ValueHelp");return Promise.resolve(i._addValueHelpAssociation()).then(function(){a=t.getElementById(i.getId()+"--ValueHelp");a.connect(i);return a.initControlDelegate()}).then(function(){const t=a.getTypeahead();const n=t.getContent()[0];F.forEach(e,function(e){n.insertItem(new f({key:e.InternalKey[0],text:s.formatValue(h.createItemCondition(e.Key[0],e.Text[0],null,null,e))}))});i._setBusy(false);return t.open(null,true)})},_formatDate:function(e){return T.getDateTimeWithTimezoneInstance({showTimezone:false,showTime:false}).format(m.getInstance(e))},_validateValue:function(e,t){return e.searchMember(t,true,true,true,10).then(function(e){if(!e||e.length===0){return Promise.resolve()}return e})}});return v});
//# sourceMappingURL=FilterField.js.map