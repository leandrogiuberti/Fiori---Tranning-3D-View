/*
 * SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
 */
sap.ui.define("sap/sac/df/controls/MultiDimControlBase",["sap/ui/core/Control","sap/ui/thirdparty/jquery","sap/ui/model/json/JSONModel","sap/base/Log","sap/sac/df/model/MultiDimModel","sap/ui/core/UIArea","sap/sac/df/firefly/library","sap/sac/df/utils/MetaPathHelper","sap/sac/df/types/DataSourceType"],function(t,jQuery,e,i,o,n,r,a,s){const u=t.extend("sap.sac.df.controls.MultiDimControlBase",{metadata:{library:"sap.sac.df",abstract:true,properties:{metaPath:{type:"string"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"}},aggregations:{layoutData:{type:"sap.ui.core.LayoutData",multiple:false}}},init:function(){this._bRunProgramInProgress=false;this._oPluginContainer=jQuery(`<div id="${this._getPluginContainerId()}"/>`)},renderer:{apiVersion:2,render:function t(e,o){i.info("DF: Start - MultiDimControlBase - render");e.openStart("div",o).class("sapUiZenMultiDimControlBase").style("height",o.getHeight()).style("width",o.getWidth()).style("border","0.03125rem solid var(--sapIllus_Layering1, #a9b4be)").style("box-sizing","border-box").style("position","relative").openEnd();if(!o._getPluginConfig()){e.openStart("div",o).openEnd().text(" No plugin configuration found ").close("div")}e.close("div");i.info("DF: End - MultiDimControlBase - render")}},onAfterRendering:async function(){i.info("DF: Start - MultiDimControlBase - onAfterRendering");if(t.prototype.onAfterRendering){t.prototype.onAfterRendering.apply(this,arguments)}const e=this.$();this._oPluginContainer.appendTo(e);if(this._getPluginConfig()&&!this._bRunProgramInProgress){if(!this.oHorizonProgram){this._bRunProgramInProgress=true;this.setBusy(true);try{await this._runProgram()}catch(t){i.error("DF: MultiDimControlBase - "+t.message)}finally{this._bRunProgramInProgress=false;this.setBusy(false)}}else{this.refresh()}}i.info("DF: End - MultiDimControlBase - onAfterRendering")},exit:function(){if(this.oHorizonProgram){this.oHorizonProgram.terminate();delete this.oHorizonProgram}if(this.oHorizonRunner){this.oHorizonRunner.releaseObject();delete this.oHorizonRunner}this._unregisterOnDataProviderChange();this.oDataProvider=null;delete this._oPluginContainer;delete this._oPluginConfig;t.prototype.exit.apply(this,arguments)},refresh:function(){if(this.oHorizonProgram){const t=this._getDataProvider();if(t){this.oHorizonProgram.postNotificationWithName(r.DfOuDataProviderComponentPlugin.NOTIFICATION_COMPONENT_PLUGIN_REFRESH,t._FFDataProvider)}this._applyPropertiesToPlugin()}},_getMultiDimModelName:function(){return a.getMultiDimModelName(this.getMetaPath())},_getMultiDimModel:function(){return this._getMultiDimModelName()&&this.getModel(this._getMultiDimModelName())||this.getModel("om")},_getDataProviderName:function(){return this.getMetaPath()&&this.getMetaPath().includes("/DataProviders")?a.getDataProviderName(this.getMetaPath()):this.getMetaPath()},_getDataProvider:function(){return this._getMultiDimModel()&&this._getDataProviderName()&&this._getMultiDimModel().getDataProvider(this._getDataProviderName())},_getVisualizationName:function(){return a.getVisualizationName(this.getMetaPath())},_getVisualization:function(){return this._getVisualizationName()&&this._getDataProvider().getVisualization(this._getVisualizationName())},setMetaPath:function(t){t=t&&t.replace("&gt;",">");this.setProperty("metaPath",t);if(t){if(this._getDataProvider()){this._updateDataProviderInstance(this._getDataProviderName())}else{this.setBusy(true);this._updateDataProviderInstance(null);return Promise.resolve(this._setupModel()).then(()=>{this.setBusy(false)})}}else{this._updateDataProviderInstance(null)}},_updatePluginConfig:function(t,e,o){if(t){const n=this._getPluginConfig();const a=n.getListByKey("plugins");if(a?.size()===1){const i=a.getElementAt(0);const n=i.getObjectByKeyExt(r.HuHorizonConstants.PARAM_CONFIG,{});n[t]=e;i.put(r.HuHorizonConstants.PARAM_CONFIG,n);if(!o){this._reloadPlugin()}}else{i.info("DF: MultiDimControlBase - Cannot update plugin config.")}}},_getPluginConfig:function(){if(!this._oPluginConfig){const t=this.getPluginConfigName();const e=r.HorizonPluginConfigProvider.getInstance().getConfig(t);this._oPluginConfig=r.PrUtils.deserialize(e)}if(this.getPluginConfigName()==="WidgetDesigner"){let t=this._oPluginConfig.getStructureByKey("plugins").getStructureAt(0).getStructureByKey("config");if(this.getWidgetId()){t.putString("widgetId",this.getWidgetId())}if(this._getMultiDimModel()?._SystemSettings?.systemLandscape?.masterSystem){t.putString("systemName",this._getMultiDimModel()?._SystemSettings.systemLandscape.masterSystem)}}return this._oPluginConfig},_reloadPlugin:function(){if(this.oHorizonProgram){this.oHorizonProgram._getController().addStatusChangedListener(t=>{if(t===r.HuMainControllerStatus.READY){this._applyPropertiesToPlugin();this._setActiveDataProviderToPlugin(this._getDataProviderName())}});this.oHorizonProgram.reloadWithConfiguration(this._getPluginConfig())}},_getPluginContainerId:function(){return this.getId()+"--pluginContainer"},_setupModel:async function(){if(this.getMetaPath()||this.getPluginConfigName()==="WidgetDesigner"){await this._initModel();const t=this._getMultiDimModel();return t&&t.getSession()}},_initModel:function(){const t=this._getMultiDimModel();if(t){const e=t=>{const e=t.getParameter("dataProviderName");i.info(`DF: MultiDimControlBase - DataProvider changed '${e}'`);if(e===this._getDataProviderName()){this._updateDataProviderInstance(e)}};t.attachEvent("dataProviderAdded",null,e,this);t.attachEvent("dataProviderUpdated",null,e,this);t.attachEvent("dataProviderRemoved",null,e,this);if(this.getMetaPath()&&!this.getMetaPath().includes("/DataProviders")){return t.loaded().then(t=>t.addDataProvider(this.getMetaPath(),this.getMetaPath(),null,null,null,s.Insight))}else{return t.loaded()}}},_updateDataProviderInstance:function(t){if(this.oHorizonProgram){if(t){const e=this._getMultiDimModel();if(e){const i=e.getDataProvider(t);const o=i?._FFDataProvider;if(o!=null&&o!==this.oDataProvider){const e=r.OuDataProviderCPParam.createForGetDataProvider(t);this.oHorizonProgram.executeActionById(`${r.OuDataProviderCommandPlugin.PLUGIN_NAME}.${r.OuDataProviderCPConstants.CMD_GET_DATA_PROVIDER_BY_NAME}`,e).onThen(e=>{if(e){this._setActiveDataProvider(t,e)}}).onCatch(()=>{const e=r.OuDataProviderCPParam.createForRegisterExistingDataProvider(t,o);this.oHorizonProgram.executeActionById(`${r.OuDataProviderCommandPlugin.PLUGIN_NAME}.${r.OuDataProviderCPConstants.CMD_REGISTER_EXISTING_DATA_PROVIDER}`,e).onThen(()=>{this._setActiveDataProvider(t,o)})})}}}else{this._setActiveDataProvider(t,null)}}},_setActiveDataProvider:function(t,e){if(e!==this.oDataProvider){this._setActiveDataProviderToPlugin(t).onThen(function(){this.oDataProvider=e;const t=this._getMultiDimModel().getApplication().getProcess().getDataProviderPool();if(e){t&&t.addDataProvider(e)}}.bind(this))}},_setActiveDataProviderToPlugin:function(t){const e=r.OuDataProviderCPParam.createForGetDataProvider(t);return this.oHorizonProgram.executeActionById(`${r.OuDataProviderCommandPlugin.PLUGIN_NAME}.${r.OuDataProviderCPConstants.CMD_SET_ACTIVE_DATA_PROVIDER}`,e)},_registerOnDataProviderChange:function(){if(this.oDataProvider){this._sUpdateListenerId=this.oDataProvider.getEventing().getEmitterForModelChanges().getListener().addConsumer(function(t){if(t.hasAnyComponentChanged()){this._getMultiDimModel().checkUpdate()}}.bind(this))}},_unregisterOnDataProviderChange:function(){if(this.oDataProvider&&this._sUpdateListenerId){this.oDataProvider.getEventing().getEmitterForModelChanges().getListener().removeConsumerByUuid(this._sUpdateListenerId);this._sUpdateListenerId=null}},_runProgram:async function(){const t=await this._setupModel();return new Promise((e,o)=>{if(!t){o(new Error("Parent process not found"))}else{this.oHorizonRunner=r.ProgramRunner.createRunner(t,"Horizon");this.oHorizonRunner.setNativeAnchorId(this._getPluginContainerId());this.oHorizonRunner.setConfigStructure(this._getPluginConfig());return this.oHorizonRunner.runProgram().onThen(t=>{this.oHorizonProgram=t;this._applyPropertiesToPlugin();i.info("DF: MultiDimControlBase - Horizon program started");this._applyContextMenuConfiguration();this._updateDataProviderInstance(this._getDataProviderName());this._bRunProgramInProgress=false;e()}).onCatch(t=>{o(new Error("Horizon program failed to start: "+t))})}})},_applyContextMenuConfiguration:function(){if(this._getMultiDimModel()?.Configuration&&this._getMultiDimModel()?.Configuration?.getContextMenuConfiguration()){const t=r.PrUtils.deserialize(this._getMultiDimModel()?.Configuration?.getContextMenuConfiguration());this.oHorizonProgram.executeActionById(`${r.AuMenuEngineCommandPlugin.PLUGIN_NAME}.${r.AuMenuEngineCommandPlugin.LOAD_BASE_CONFIGURATION}`,t)}},_applyPropertiesToPlugin:function(){}});return u});
//# sourceMappingURL=MultiDimControlBase.js.map