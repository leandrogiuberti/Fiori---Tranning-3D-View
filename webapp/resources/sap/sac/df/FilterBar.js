/* SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
   */
sap.ui.define("sap/sac/df/FilterBar",["sap/ui/mdc/FilterBar","sap/sac/df/FilterField","sap/ui/mdc/enums/FieldDisplay","sap/ui/fl/variants/VariantManager","sap/ui/base/ManagedObjectObserver","sap/ui/mdc/enums/FilterBarValidationStatus","sap/ui/mdc/util/FilterUtil","sap/ui/core/library","sap/sac/df/thirdparty/lodash","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/write/_internal/flexState/FlexObjectManager","sap/sac/df/filter/PropertyHelper","sap/ui/fl/apply/api/ControlVariantApplyAPI"],function(e,t,i,a,r,s,n,l,o,d,h,u,p){const{ValueState:c}=l;const g=e.extend("sap.sac.df.FilterBar",{metadata:{library:"sap.sac.df",properties:{metaPath:{type:"string"}}},renderer:"sap.ui.mdc.FilterBarRenderer",init:function(){if(e.prototype.init){e.prototype.init.apply(this,arguments)}this._getObserver().observe(this,{aggregations:["dependents"]});this.setP13nMode(["Item","Value"]);this.setDelegate({name:"sap/sac/df/filter/delegate/FilterBarDelegate"});this._aChangedVariables=[]},_applyFailedChanges:function(){let e=this._getView().getController().getOwnerComponent();const t=this.getId().split(this._getView().getController().getOwnerComponent().getId()+"---").pop();return Promise.resolve(this._loadFlex()).then(i=>{if(i){i.getVariantModel(e).then(i=>{const r=i.getData()&&Object.keys(i.getData())[0];this._onVariantApplied=function(){};p.attachVariantApplied({selector:e,vmControlId:r,callback:this._onVariantApplied,callAfterInitialVariant:true});if(r&&i.getVariantManagementReference(r).variantManagementReference!==""){let e=i.getVariant(i.getCurrentControlVariantIds()[0]).controlChanges;let s=e.filter(e=>e.getApplyState()===d.ApplyState.APPLY_FAILED&&e.getProperty("selector").id===t);o.forEach(s,e=>{e.setApplyState(d.ApplyState.INITIAL);e.setState(d.LifecycleState.DIRTY)});h.deleteFlexObjects({reference:i.sFlexReference,flexObjects:s});h.removeDirtyFlexObjects({reference:i.sFlexReference,flexObjects:s});if(s){return a.eraseDirtyChangesOnVariant(r,r,this).then(()=>a.addAndApplyChangesOnVariant(s,this))}}})}})},onAfterRendering:function(){if(this.getFilterItems().length===0){this._setPaths();if(!o.isEmpty(this._getMetaObject())){return this._setupFilterBar()}else{if(this._isVariableGroup()){this._getMultiDimModel().attachEventOnce("variableGroupsAdded",null,this._setupFilterBar.bind(this))}else{this._getMultiDimModel().attachEventOnce("dataProviderAdded",null,this._setupFilterBar.bind(this))}}}},getFilterConditions:function(){return this._getConditionModel().getData().conditions},_setPaths:function(){this._metaObjectPath=this.getMetaPath().split(">")[1]},_getMetaObjectType:function(){if(this.getMetaPath().includes("/VariableGroups")){return"sap.sac.df.model.VariableGroup"}else if(this.getMetaPath().includes("/Variables")){return"sap.sac.df.model.Variable"}else if(this.getMetaPath().includes("/Dimensions")){return"sap.sac.df.model.Dimension"}},_isVariableGroup:function(){return this._getMetaObjectType()==="sap.sac.df.model.VariableGroup"},_getMetaObjectPath:function(){return this._metaObjectPath},_getMultiDimModel:function(){return this.getModel(this._getMultiDimModelName())},_getMultiDimModelName:function(){return this.getMetaPath().split(">")[0]},_getMetaObject:function(){return this._getMultiDimModel()&&this._getMultiDimModel().getProperty(this._metaObjectPath)},_setupFilterBar:function(){o.forEach(this._getMetaObject(),e=>{if(this._isStandardVariant()&&this._isVisibleInFilterBar(e)){const t=this.createFilterField(e.Name);this.addFilterItem(t);t.setModel(this._getMultiDimModel(),this._getMultiDimModelName());t._setupFilterFieldFromMetaPath()}else{this._setConditions(e.getMemberFilter(),e,this)}return this.finalizePropertyHelper()});return this._applyFailedChanges()},_isVisibleInFilterBar:function(e){return this._isVariableGroup()?!o.isUndefined(e.VisibleInFilterBar)&&e.VisibleInFilterBar:this.getFieldGroupIds().length>0?this.getFieldGroupIds().includes(e.Name):true},_isStandardVariant:function(){return this._getAssignedVariantManagement()?this._getAssignedVariantManagement()._oVM.getStandardVariantKey()===this._getAssignedVariantManagement()._oVM.getSelectedKey():true},_setConditions:function(e,t){var i=[];if(e&&e.length>0){o.forEach(e,function(e){return i.push({operator:e.Operator,validated:"Validated",values:e.InternalKey})});this._getConditionModel().setProperty("/conditions/"+t.Name,i)}return i},createFilterField:function(e){return new t(this.getFilterFieldId(e),{metaPath:this.getMetaPath()+"/"+e,propertyKey:e,delegate:{name:"sap/sac/df/filter/delegate/FieldBaseDelegate"}})},getFilterFieldId:function(e){return this.getId()+"::FilterField::"+e.replace(/[^0-9A-Z_.:-]/gi,"")},_getObserver:function(){if(!this._oObserver){this._oObserver=new r(this._observeChanges.bind(this))}return this._oObserver},_observeChanges:function(t){e.prototype._observeChanges.apply(this,arguments);if(t.name==="dependents"&&t.mutation==="insert"&&t.child&&t.child.isA("sap.m.p13n.Popup")){this._onOpenAdaptFilterDialog(t.child)}},_onOpenAdaptFilterDialog:function(e){const t=this;this._adaptFiltersDialogIsOpen=true;this._oVariablesBeforeOpeningAdaptFilters={};o.forEach(this._getMetaObject(),function(e){const i=t._isVariableGroup()?[].concat(e.MergedVariable.MemberFilter):[].concat(e.MemberFilter);this._oVariablesBeforeOpeningAdaptFilters[e.Name]={Name:e.Name,MemberFilter:i}}.bind(this));this.retrieveInbuiltFilter().then(function(e){t._adaptFilters=e});const i=function(e){if(e.getParameters().reason==="Cancel"){o.forEach(o.uniq(this._aChangedVariables),e=>{const t=this._oVariablesBeforeOpeningAdaptFilters[e];const i=t.MemberFilter?t.MemberFilter:[];o.forEach(i,e=>{e.UniqueID=null});const a=o.find(this._getMetaObject(),function(t){return t.Name===e});a&&a.setMemberFilter(i)});t._adaptFiltersDialogIsOpen=false}this._aChangedVariables=[];this._oVariablesBeforeOpeningAdaptFilters=undefined};e.attachClose(null,i,this)},_filterChanged:function(e){this._aChangedVariables.push(e.getPropertyKey());this.fireFiltersChanged({conditionsBased:true,filtersTextExpanded:this._getAssignedFiltersExpandedText(),filtersText:this._getAssignedFiltersCollapsedText()})},_checkRequiredFields:function(){let e=s.NoError;const t=this._getRequiredFieldNamesWithoutValues();t.forEach(t=>{const i=this._getFilterField(t);if(i){if(i.getValueState()===c.None){i.setValueState(c.Error);i.setValueStateText(this._getRequiredFilterFieldValueText(i))}}e=s.RequiredHasNoValue});return e},_getRequiredFieldNamesWithoutValues:function(){const e=[];if(this._getRequiredPropertyNames){this._getRequiredPropertyNames().forEach(t=>{let i=this._getFilterField(t);let a=i&&i._getMetaObject&&i._getMetaObject();if(a){var r=a.MergedVariable?a.MergedVariable:a;const i=r&&r.MemberFilter;if(!i||i.length===0){e.push(t)}}})}return e}});return g});
//# sourceMappingURL=FilterBar.js.map