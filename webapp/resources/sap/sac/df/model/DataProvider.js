/*!
 * SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
 */
sap.ui.define("sap/sac/df/model/DataProvider",["sap/ui/base/Object","sap/base/Log","sap/ui/model/Model","sap/ui/model/json/JSONModel","sap/ui/core/format/DateFormat","sap/sac/df/types/SystemType","sap/sac/df/types/Axis","sap/sac/df/types/DimensionType","sap/sac/df/types/DisplayType","sap/sac/df/types/ComparisonOperator","sap/sac/df/utils/SyncActionHelper","sap/sac/df/utils/ListHelper","sap/sac/df/utils/ResourceBundle","sap/sac/df/thirdparty/lodash","sap/sac/df/firefly/library","sap/sac/df/model/internal/Capability","sap/sac/df/model/Dimension","sap/sac/df/model/Variable","sap/sac/df/model/Measure","sap/sac/df/model/DataSourceInfo","sap/sac/df/model/Visualization","sap/sac/df/types/VisualizationType","sap/sac/df/utils/MetaPathHelper","sap/sac/df/model/Scenario","sap/sac/df/types/DataSourceType"],function(e,t,r,a,i,n,o,s,u,l,c,g,d,f,m,p,h,y,v,_,M,D,F,P,S){"use strict";const E="TableDefinition";var V=a.extend("sap.sac.df.model.DataProvider",{constructor:function(e,t){Object.assign(this,Object.getPrototypeOf(this));r.call(this);var a=this;a._Model=e;a.Name=t;a.Messages=[];a.Variables={};a.Dimensions={};a.Visualizations={};a._VariableDisplayType={};a._metadataCacheEnabled=e._metadataCacheEnabled;this._getModel=function(){return a._Model};this._getQueryManager=function(){return this._FFDataProvider.m_queryManager};this._getQueryModel=function(){return this._getQueryManager().getQueryModel()};this._addMessagesToModel=function(e){if(e&&e.getMessages&&e.getMessages()&&e.getMessages().length){this._Model._addMessages(i(e))}};function i(e){const t=Array.isArray(e.getMessages())?e.getMessages():g.arrayFromList(e.getMessages());return t.map(function(e){var t=e.getSeverity().getName();if(t==="Info"){t="Information"}return{Text:e.getText(),Severity:t,Code:e.getCode(),MessageClass:e.getMessageClass(),LongTextUri:e.getMessageClass()?["/sap/opu/odata/iwbep/message_text;o=LOCAL/T100_longtexts(MSGID='",encodeURIComponent(e.getMessageClass()),"',MSGNO='",encodeURIComponent(e.getCode()),",',MESSAGE_V1='',MESSAGE_V2='',MESSAGE_V3='',MESSAGE_V4='')/$value"].join(""):null}})}a._callUpdateDimensionData=function(){p()};a.resetToMetaData=function(){var e=this;return Promise.resolve().then(function(){e.variableChanged=true;e._executeModelOperation(function(){e._getQueryModel().queueEventing();e._getQueryManager().getConvenienceCommands().resetToDefaultState(true);e._getQueryModel().resumeEventing()},true)})};a.invalidateMetaData=function(){const e=a._getQueryManager().getDataSource().getCacheKeyName2();a._getQueryManager().getOlapSystemContainer().getCubeContainer(e).releaseAllQueryMetadata()};a.destroy=function(){return new Promise((e,t)=>{if(m.XObjectExt.isValidObject(a._FFDataProvider)){a._Model.getApplication().getDataProviderManager().releaseDataProvider(a.Name).onThen(()=>{a._FFDataProvider=null;delete a._FFDataProvider;e()}).onCatch(e=>{t(e)})}else{e()}})};a._invalidateState=function(){a._Model.setMessages([]);a._getQueryManager().invalidateState();a._getQueryManager().getResultsetContainer(true)};a._triggerDataProviderPropertyUpdate=function(e){if(!e){a._invalidateState();a._FFDataProvider.getEventing().notifyExternalModelChange(null)}};a.isValid=function(){var e=a._getQueryManager().getResultSetSyncState();return e!==m.SyncState.OUT_OF_SYNC&&e!==m.SyncState.IN_SYNC_WITH_ERROR};function o(){u();l();p();a._getQueryModel().stopEventing();s();P();V();b();a._getQueryModel().resumeEventing()}function s(){g.arrayFromList(a._getQueryModel().getVisualizationManager().getVisualizationDefinitions()).filter(function(e){const t=a.getVisualization(e.getName());if(t){t._registerVizFilledConsumer()}else{const t=D.Grid;const r=new M(a,e.getName(),t);a.setProperty(F.PathTo.Visualizations+"/"+e.getName(),r)}})}function u(){a.DataSourceInfo=new _(a)}function l(){var e=g.arrayFromList(a._getQueryModel().getVariables()).filter(function(e){return e.isInputEnabled()});a.Variables=f.reduce(e,function(e,t){var r=new y(a,t);if(r.Name){e[r.Name]=r}return e},{})}function p(){a._getQueryModel().stopEventing();a.Dimensions=f.reduce(g.arrayFromList(a._getQueryModel().getDimensions()),function(e,t){var r=new h(a,t);if(r.Name){e[r.Name]=r}return e},{});a._getQueryModel().resumeEventing()}function P(){var e=a.getMeasureStructureDimension();var t=e&&e.Members||[];a.Measures=f.reduce(t,function(t,r){t[r.Name]=new v(a,r,e._FFDimension.getAllStructureMembers().getByKey(r.Key));return t},{})}function V(){var e=a._getQueryModel();a.Conditions=f.map(e.getConditionManager()?g.arrayFromList(e.getConditionManager()):[],function(e){return{Name:e.getName(),Description:e.getText(),StatusText:d.getText(e.isActive()?"ACTIVE":"INACTIVE"),active:e.isActive()}})}function b(){var e=a._getQueryModel();a.Exceptions=f.map(e.getExceptionManager()?g.arrayFromList(e.getExceptionManager()):[],function(e){return{Name:e.getName(),Description:e.getText(),StatusText:d.getText(e.isActive()?"ACTIVE":"INACTIVE"),active:e.isActive()}})}a._reinitIfNeededPromise=function(){const e=this;if(e._reinitPromise){return e._reinitPromise}e._reinitPromise=e._getQueryManager().isReinitNeeded()?new Promise(function(t,r){e._getQueryManager().reInitVariablesAfterSubmit(m.SyncType.NON_BLOCKING,{onVariableProcessorExecuted:e=>e.hasErrors()?r(c.reject(e.getErrors())):t()})}):Promise.resolve();return e._reinitPromise.then(function(){e._reinitPromise=null})};a._executeModelOperation=function(e,t){if(e){e()}a._triggerDataProviderPropertyUpdate();if(t){o()}else{p()}};a._transferVariablesIfNeededPromise=function(){const e=this;if(e.variableChanged&&e._getQueryManager().getSystemType().getName()===n.BW){return new Promise(function(t,r){e._getQueryManager().transferVariables(m.SyncType.NON_BLOCKING,{onVariableProcessorExecuted:function(e){if(e.hasErrors()){r(c.reject(e.getErrors()))}else t()}})})}};this._createFFDPFromParam=function(e,t,r,i,n,o,s,u){const l=e&&e.match(/^.*:\[.*\]\[.*\]\[.*\]/)?e:[n||"query",":","[",i?i:"","]","[",i||r?r:"","]","[",e,"]"].join("");const c=m.QFactory.createDataSourceWithFqn(l);c.setSystemName(t||a._Model.getApplication().getSystemLandscape().getMasterSystemName());const g=m.OlapDataProviderConfiguration.createConfig(a._Model.getApplication(),c);g.setMetadataCacheEnabled(a._metadataCacheEnabled);g.setDataProviderName(this.Name);if(s){g.setSemanticInfo(m.PrUtils.deserialize(JSON.stringify(s)).asStructure())}if(u){const e=m.OlapDataProviderMetadataConfiguration.create();if(u.Cache){e.setMetadataCacheEnabled(true)}if(u.Lightweight){e.setLightWeightMetadataEnabled(true)}if(u.RequiredDimensions){e.setRequiredDimensions(m.PrUtils.asListOfString(u.RequiredDimensions))}g.setMetadataConfiguration(e)}if(this._Model.getConfiguration()?.ImplicitVariableHandling===true){g.getHooks().getFinalizeVariablesRegister().addFunction(e=>{const t=m.AuVariableManager.create(null,()=>{});t.m_stopOnCancel=true;t.setDataProvider(e);return t.openInitialVariableDialogPromiseIfPossible()})}if(!o){o={};o[E]={type:D.Grid.Name,isActive:true}}this._addVisualizationsToConfig(g,o);g.getStartConnection().setStartWithAutoFetch(false);return g};this._createFFDPConfigFromConfig=function(e){const t=e.DataSource.Name;const r=e.DataSource.SystemName;const a=e.DataSource.Package;const i=e.DataSource.Schema;const n=e.DataSource.Type;const o=e.Visualizations;const s=e.SemanticInfo;const u=e.Metadata;return this._createFFDPFromParam(t,r,a,i,n,o,s,u)};this._createFFDataProvider=function(e,r,i,n,s,u){let l="";if(s===S.Insight){l=m.OlapDataProviderFactory.createDataProviderFromFile(a._Model.getApplication().getProcess(),t,"/analyticalwidgets/"+e,null);l.then(e=>{e.getActions().getVisualizationActions().getOrCreateDefaultTableDefinition();return e})}else{const t=typeof e==="string"?this._createFFDPFromParam(e,r,i,n,s,u):this._createFFDPConfigFromConfig(e);l=a._Model.getApplication().getDataProviderManager().createDataProvider(t)}return Promise.resolve(l).then(e=>{a._FFDataProvider=a._Model.getApplication().getDataProviderManager().getDataProvider(this.Name)||e;a._setupVisualizations(u);a._registerEventHandlers()}).then(()=>{a._getQueryManager().attachBeforeQueryExecutionListener({onBeforeQueryExecuted:function(){a._Model.propagateVariableGroupValues(a.Name);if(a.variableChanged&&a._getQueryManager().getModelCapabilities().supportsAutoVariableSubmit()&&a._getQueryManager().getVariableProcessorState()!==m.VariableProcessorState.PROCESSING_UPDATE_VALUES){a._getQueryManager().setVariableProcessorState(m.VariableProcessorState.PROCESSING_AUTO_SUBMIT);a.variableChanged=false}},isEqualTo:m.XObject.prototype.isEqualTo});a._getQueryManager().attachQueryExecutedListener({onQueryExecuted:function(e){a._getQueryManager().stopEventing();m.XCollectionUtils.forEach(a._getQueryManager().getDimensionMemberVariables(),function(e){if(e.isInputEnabled()){e.setWinControlInAutoSubmit(true)}}.bind(this));a._getQueryManager().resumeEventing();a._addMessagesToModel(e);if(e.hasErrors()){a._Model.checkUpdate();a._Model.fireRequestFailed({infoObject:a.Name})}else{o()}},isEqualTo:function(e){return this===e}},"UI5GridViz")}).then(()=>{o()}).then(()=>{a._Model.getGridStylingTemplateRegistry().setVizVariables(a)}).then(()=>a).catch(e=>Promise.reject(e))};this._setupVisualizations=function(e){if(e){f.forEach(e,(e,t)=>{a.setProperty(F.PathTo.Visualizations+"/"+t,new M(a,t,D[e.type]))})}};this._addVisualizationsToConfig=function(e,t){let r=m.PrFactory.createList();f.forEach(t,(e,t)=>{this._addVisualization(r,t,e)});return e.getStartConnection().setVisualizations(r)};this._addVisualization=function(e,t,r){let a=e.addNewStructure();const i=D[r.type];a.putString(m.OlapDataProviderConfiguration.VIZ_NAME,t);i.VisualizationType&&a.putString(m.OlapDataProviderConfiguration.VIZ_TYPE,i.VisualizationType.getName());i.ProtocolBindingType&&a.putString(m.OlapDataProviderConfiguration.VIZ_PROTOCOL,i.ProtocolBindingType.getName());i.ChartType&&a.putString(m.OlapDataProviderConfiguration.VIZ_CHART_TYPE,i.ChartType.getName());r.isActive&&a.putBoolean(m.OlapDataProviderConfiguration.VIZ_ACTIVE,r.isActive)};this._registerEventHandlers=function(){if(m.notNull(this._FFDataProvider)){this._FFDataProvider.getEventing().getListenerForModelChanges().addConsumer(()=>this._onDataProviderDataProviderModelChange(this._FFDataProvider));this._FFDataProvider.getEventing().getListenerForResultDataFetch().addConsumer(e=>{this._onDataFetch(e)})}};this._onDataProviderDataProviderModelChange=function(){this._invalidateState();this._Model.fireDataProviderUpdated({dataProviderName:this.Name})};this._onDataFetch=function(e){if(e.getStep()===m.OlapDataProviderResultDataFetchStep.QUERY_EXECUTED){this._onResultSetChange()}};this._onResultSetChange=function(){this._callUpdateDimensionData();this._Model.checkUpdate();this._Model.fireRequestCompleted({infoObject:this.Name})}}});V.prototype.addVisualization=function(e,t){let r=this;return Promise.resolve(r.removeVisualization(e)).then(function(){const a=new M(r,e,t);r.setProperty(F.PathTo.Visualizations+"/"+e,a);return a._createFFVisualization()}).then(function(){r.fireVisualizationAdded({visualizationName:e});r._Model.fireDataProviderUpdated({dataProviderName:r.Name});return r.getVisualization(e)}).catch(function(e){r._addMessagesToModel();return Promise.reject(e)})};V.prototype.removeVisualization=function(e){let t=this;if(this.getVisualization(e)){return Promise.resolve(t.getVisualization(e)._removeFFVisualization()).then(function(){t.setProperty(F.PathTo.Visualizations+"/"+e,null);t.fireDataProviderRemoved({visualizationName:e})}).catch(function(e){t._addMessagesToModel();return Promise.reject(e)})}};V.prototype.getVisualizations=function(){return this.getProperty(F.PathTo.Visualizations)};V.prototype.getVisualization=function(e){return this.getProperty(F.PathTo.Visualizations+"/"+e)};V.prototype.getGridVisualization=function(){return this.getProperty(F.PathTo.Visualizations+"/"+E)};V.prototype.supportsCapability=function(e){if(e===p.SupportsDocuments){var t=this._getQueryModel().getDocumentsInfo();return!!t&&t.getSupportsDocuments()!==m.DocumentsSupportType.NONE}throw new Error("Unhandled capability : "+e)};V.prototype.setProperty=function(e,t){return this._Model.setProperty(F.PathTo.DataProviders+"/"+this.Name+e,t)};V.prototype.getProperty=function(e){return this._Model.getProperty(F.PathTo.DataProviders+"/"+this.Name+e)};V.prototype.setAutoFetchEnabled=function(e){this._FFDataProvider?.getResulting().setAutoFetchActive(e);if(this.getAutoFetchEnabled()!==e){this.setProperty("/AutoFetchEnabled",e);this._Model.fireEvent("dataProviderUpdated",{dataProviderName:this.Name})}};V.prototype.getAutoFetchEnabled=function(){return this.getProperty("/AutoFetchEnabled")};V.prototype.deserialize=function(e,t,r){var a=this;var i=t==="INA_REPOSITORY_DELTA"?m.QModelFormat.INA_REPOSITORY_DELTA:m.QModelFormat.INA_REPOSITORY;return Promise.resolve().then(function(){a.variableChanged=true;a._executeModelOperation(function(){a._getQueryModel().deserializeExt(i,e)},r||true)})};V.prototype.serialize=function(e){var t=e==="INA_REPOSITORY_DELTA"?m.QModelFormat.INA_REPOSITORY_DELTA:m.QModelFormat.INA_REPOSITORY;return this._getQueryModel().serializeToContentExt(t,null).getString()};V.prototype.createScenario=function(e,t){return Promise.resolve(new P(this,e,t)._cloneDataProvider())};V.prototype.getScalingFactor=function(e,t){var r=this.getMeasureStructureDimension();if(!r){throw new Error("No measure Structure")}var a=t?this.getStructureDimension():null;var i=g.arrayFromList(r._FFDimension.getAllStructureMembers());var n=r._FFDimension.getDisplayKeyField();var o=function(){var t=f.find(i,function(t){var r=t.getFieldValue(n);var a=r?r.getString():t.getName();return a===e});if(!t){throw new Error("Member "+e+" not found in structure: "+r.Name)}return t}();if(!a){return r.getScalingFactor(e)}else{var s=g.arrayFromList(a._FFDimension.getAllStructureMembers());var u=a._FFDimension.getDisplayKeyField();var l=function(){var r=f.find(s,function(e){var r=e.getFieldValue(u);var a=r?r.getString():e.getName();return a===t});if(!r){throw new Error("Member "+e+" not found in structure: "+a.Name)}return r}();var c=g.arrayFromIter(this._getQueryModel().getQueryDataCells().getIterator());var d=f.find(c,function(e){return e.hasMemberReference(o)&&e.hasMemberReference(l)});if(!d){throw new Error("Invalid Query Cell")}return d.getScalingFactor()}};V.prototype.setScalingFactor=function(e,t,r){var a=this;this._executeModelOperation(function(){var i=a.getMeasureStructureDimension();if(!i){throw new Error("No measure Structure")}var n=r?a.getStructureDimension():null;var o=g.arrayFromList(i._FFDimension.getAllStructureMembers());var s=i._FFDimension.getDisplayKeyField();var u=function(){var e=f.find(o,function(e){var r=e.getFieldValue(s);var a=r?r.getString():e.getName();return a===t});if(!e){throw new Error("Member "+t+" not found in structure: "+i.Name)}return e}();if(!n){i.setScalingFactor(t,e);return a}else{var l=g.arrayFromList(n._FFDimension.getAllStructureMembers());s=n._FFDimension.getDisplayKeyField();var c=function(){var e=f.find(l,function(e){var t=e.getFieldValue(s);var a=t?t.getString():e.getName();return a===r});if(!e){throw new Error("Member "+r+" not found in structure: "+n.Name)}return e}();var d=g.arrayFromIter(a._getQueryModel().getQueryDataCells().getIterator());d=f.filter(d,function(e){return e.hasMemberReference(u)&&e.hasMemberReference(c)});if(!d||d.length<1){throw new Error("Invalid Query Cell")}return f.forEach(d,function(t){t.setScalingFactor(e)})}})};V.prototype.setDecimalPlaces=function(e,t,r){var a=this;this._executeModelOperation(function(){var i=a.getMeasureStructureDimension();if(!i){throw new Error("No measure Structure")}var n=r?a.getStructureDimension():null;var o=g.arrayFromList(i._FFDimension.getAllStructureMembers());var s=i._FFDimension.getDisplayKeyField();var u=function(){var e=f.find(o,function(e){var r=e.getFieldValue(s);var a=r?r.getString():e.getName();return a===t});if(!e){throw new Error("Member "+t+" not found in structure: "+i.Name)}return e}();if(!n){i.setDecimalPlaces(t,e);return a}else{var l=g.arrayFromList(n._FFDimension.getAllStructureMembers());s=n._FFDimension.getDisplayKeyField();var c=function(){var e=f.find(l,function(e){var t=e.getFieldValue(s);var a=t?t.getString():e.getName();return a===r});if(!e){throw new Error("Member "+r+" not found in structure: "+n.Name)}return e}();var d=g.arrayFromIter(a._getQueryModel().getQueryDataCells().getIterator());d=f.filter(d,function(e){return e.hasMemberReference(u)&&e.hasMemberReference(c)});if(!d||d.length<1){throw new Error("Invalid Query Cell")}return f.forEach(d,function(t){t.setDecimalPlaces(e)})}})};V.prototype.getDecimalPlaces=function(e,t){var r=this.getMeasureStructureDimension();if(!r){throw new Error("No measure Structure")}var a=t?this.getStructureDimension():null;var i=g.arrayFromList(r._FFDimension.getAllStructureMembers());var n=r._FFDimension.getDisplayKeyField();var o=function(){var t=f.find(i,function(t){var r=t.getFieldValue(n);var a=r?r.getString():t.getName();return a===e});if(!t){throw new Error("Member "+e+" not found in structure: "+r.Name)}return t}();if(!a){return r.getDecimalPlaces(e)}else{var s=g.arrayFromList(a._FFDimension.getAllStructureMembers());var u=a._FFDimension.getDisplayKeyField();var l=function(){var e=f.find(s,function(e){var r=e.getFieldValue(u);var a=r?r.getString():e.getName();return a===t});if(!e){throw new Error("Member "+t+" not found in oMmeasureStructure: "+a.Name)}return e}();var c=g.arrayFromIter(this._getQueryModel().getQueryDataCells().getIterator());var d=f.find(c,function(e){return e.hasMemberReference(o)&&e.hasMemberReference(l)});if(!d){throw new Error("Invalid Query Cell")}return d.getDecimalPlaces()}};V.prototype.exportData=function(e){var t=this;return new Promise(function(r,a){var i=this.getVisualization(E)._getFFVisualization();e.addOverwriteTextsToQm(t._getQueryModel().getVisualizationManager().getApplicationSettings());var n=m.DataExportHelper.create(t._getQueryManager(),i,a,r);if(e.getDisplayDialog()){n.showExportDialog(e.getType(),e.getFileName(),r)}else{var o=e.getFireflyConfig();n.exportData(o)}}.bind(this))};V.prototype.getVariable=function(e){return this.getVariables()[e]};V.prototype.getVariables=function(){return this.getProperty(F.PathTo.Variables)};V.prototype.getDimension=function(e){return this.getDimensions()[e]};V.prototype.getDimensions=function(){return this.getProperty(F.PathTo.Dimensions)};V.prototype.getMeasure=function(e){return this.getMeasures()[e]};V.prototype.getMeasures=function(){return this.getProperty(F.PathTo.Measures)};V.prototype.getDataSourceInfo=function(){return this.getProperty(F.PathTo.DataSourceInfo)};V.prototype.fireDataUpdated=function(e){this.fireEvent("dataUpdated",e);this._Model.fireEvent("dataLoaded",{dataProviderName:this.Name})};V.prototype.fireVisualizationAdded=function(e){this.fireEvent("visualizationAdded",e)};V.prototype.fireVisualizationRemoved=function(e){this.fireEvent("visualizationRemoved",e)};V.prototype.getMeasureStructureDimension=function(){return this.getDimension(s.MeasureStructure)};V.prototype.getStructureDimension=function(){return this.getDimension(s.StructureDimension)};V.M_PROPERTIES={Dimensions:"Dimensions",Variables:"Variables",Measures:"Measures",Visualizations:"Visualizations",DataSourceInfo:"DataSourceInfo",AutoFetchEnabled:"AutoFetchEnabled"};V.M_EVENTS={dataUpdated:"dataUpdated",visualizationAdded:"visualizationAdded",visualizationRemoved:"visualizationRemoved"};return V});
//# sourceMappingURL=DataProvider.js.map