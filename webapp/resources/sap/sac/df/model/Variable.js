/*!
* SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
*/
sap.ui.define("sap/sac/df/model/Variable",["sap/ui/base/Object","sap/sac/df/model/MemberFilter","sap/sac/df/thirdparty/lodash","sap/sac/df/firefly/library","sap/sac/df/utils/SyncActionHelper","sap/sac/df/utils/ListHelper","sap/m/MessageBox","sap/sac/df/utils/ResourceBundle","sap/ui/model/FilterOperator","sap/sac/df/types/DisplayType"],function(e,t,i,r,a,l,s,n,o,F){"use strict";const p=e.extend("sap.sac.df.model.Variable",{constructor:function(e,a){Object.assign(this,Object.getPrototypeOf(this));const s=this;this._DataProvider=e;this._FFVariable=a;this._createMemberFilter=function(){this.MemberFilter=[];this.MemberFilter=this._FFVariable.getMemberFilter?u(this._FFVariable.getMemberFilter()):g(this._FFVariable)};this._createFilterDisplayType=function(){if(this._DataProvider._VariableDisplayType&&this._DataProvider._VariableDisplayType[this.Name]){this.FilterDisplayType=this._DataProvider._VariableDisplayType[this.Name]}else{this.FilterDisplayType=this._getDisplayType(this.DisplayType)}};this._getSupportedOperators=function(){if(this._FFVariable&&this._FFVariable.getDimension&&this._FFVariable.getDimension()){const e=this._FFVariable.getFilterCapability();if(e){const a=l.arrayFromList(e.getSupportedComparisonOperators(r.SetSign.INCLUDING));if(a){return i.map(a,function(e){if(e&&e.getName()){return t.getUI5OperatorFromFFOperator({Sign:"INCLUDING",Operator:e.getName()})}})}}}return["EQ"]};this._getDisplayType=function(e){switch(e){case r.FilterDisplayInfo.ID:return F.Key;case r.FilterDisplayInfo.DESCRIPTION:return F.Text;case r.FilterDisplayInfo.ID_AND_DESCRIPTION:return F.KeyText;case r.FilterDisplayInfo.DESCRIPTION_AND_ID:return F.TextKey}};this._createFFSelection=function(e){let r=i.clone(this._FFVariable.getMemberFilter());if(!this.SupportsMultipleValues){r=null}return t._condenseDimensionMemberFilter(e,r,this._FFVariable.getDimension())};Object.assign(this,{Name:this._FFVariable.getNameExternal()||this._FFVariable.getName(),Dimension:this._FFVariable.getDimension&&this._FFVariable.getDimension()&&(this._FFVariable.getDimension().getExternalName()||this._FFVariable.getDimension().getName()),ValueType:this._FFVariable.getValueType().getName(),VariableType:this._FFVariable.getVariableType().getName(),Description:this._FFVariable.getText(),Mandatory:this._FFVariable.isMandatory(),SupportsMultipleValues:this._FFVariable.supportsMultipleValues(),TechName:this._FFVariable.getName(),InputEnabled:this._FFVariable.isInputEnabled(),IsFilterable:this._FFVariable.getDimension&&this._FFVariable.getDimension()&&this._FFVariable.getDimension().getKeyField().isFilterable(),Position:this._FFVariable.getVariableOrder(),SupportsValueHelp:this._FFVariable.supportsValueHelp&&this._FFVariable.supportsValueHelp(),DataProviderName:this._DataProvider.Name,DisplayType:this._FFVariable.getDimension&&this._FFVariable.getDimension()&&r.FilterDisplayInfo.getDimensionDisplayInfo(this._FFVariable.getDimension()),FilterDisplayType:null,MemberFilter:[],SupportedOperators:s._getSupportedOperators().filter(e=>e!=null)});s._createMemberFilter();s._createFilterDisplayType()}});function u(e){return i.map(l.arrayFromList(e),i=>t._createFromFFFilter(i,e))}function g(e){const i=e.getValueByString();if(!e.getValue()||!i){return[]}return[new t([i],[i],[i])]}p.prototype._transferMemberFilterFromAnotherVariable=function(e){const t=this._FFVariable;if(!h(t,e._FFVariable)){this._DataProvider._getQueryModel().stopEventing();t.getVariableType().isTypeOf(r.VariableType.DIMENSION_MEMBER_VARIABLE)?t.setMemberFilter(i.clone(e._FFVariable.getMemberFilter())):t.setValueByStringExt(i.clone(e.getValueByString()),true);this._DataProvider._getQueryModel().resumeEventing();this._createMemberFilter();this._DataProvider.variableChanged=true;this._DataProvider._triggerDataProviderPropertyUpdate(true)}};function h(e,t){if(e.getVariableType().isTypeOf(r.VariableType.DIMENSION_MEMBER_VARIABLE)){return e.getMemberFilter().serializeToString(r.QModelFormat.INA_REPOSITORY)==t.getMemberFilter().serializeToString(r.QModelFormat.INA_REPOSITORY)}else return e.getValueByString()==t.getValueByString()}p.prototype._applyMemberFilter=function(e){if(!this._FFVariable&&!this._FFVariable.isInputEnabled()){throw new Error("Variable is not input enabled")}this._DataProvider._getQueryModel().queueEventing();const t=this._createFFSelection(e);return this._DataProvider._reinitIfNeededPromise().then(()=>{this._FFVariable.getVariableType().isTypeOf(r.VariableType.DIMENSION_MEMBER_VARIABLE)?r.FilterDialogValueUtils.updateVariableFilter(this._FFVariable,t):i.forEach(e,e=>{this._FFVariable.setValueByStringExt(e.InternalKey[0],true)})}).then(()=>{this._DataProvider._getQueryModel().resumeEventing();this._createMemberFilter();this._DataProvider.variableChanged=true;this._DataProvider._triggerDataProviderPropertyUpdate()})};p.prototype.transformValueHelpNode=function(e,i,r){const a=e.getDimensionMember();const s=new t([i?a.getFieldValue(e.getDimension().getHierarchyDisplayKeyField()).getString():a.getFieldValue(e.getDimension().getDisplayKeyField()).getString()],[a.getFieldValue(e.getDimension().getKeyField()).getString()],[a.getText()]);if(i){const t=e.getChildren();if(t&&t.hasElements()){const e=l.arrayFromList(t).map(e=>this.transformValueHelpNode(e,i,r)).filter(e=>e!==null);if(e.length!==0){s.Children=e}}}if(r&&!s.Children){if(!s.Key.includes(r)&&!s.Text.includes(r)){return null}}return s};p.prototype.searchMember=function(e,i,a,l,s,n){if(a===undefined){a=true}if(l===undefined){l=true}if(s===undefined){n=false;s=1}const o=this._FFVariable;if(!o){return Promise.reject(new Error("Variable "+this.Name+" is not known"))}const F=r.XList.create();const p=r.XList.create();const u=o.getDimension();const g=u.getTextField();if(g){p.add(g);if(a){F.add(g)}}if(u.getDisplayKeyField()&&l){F.add(u.getDisplayKeyField())}return this._DataProvider._reinitIfNeededPromise().then(()=>this._DataProvider._transferVariablesIfNeededPromise()).then(()=>r.QFactory.createVariableValueHelpWizard(o).withReadMode(r.QMemberReadMode.BOOKED).withPaging(0,s).withMainKeyAndTextFields().searchPromise(e,l,a,n,i).then(a=>{const l=o.getVariableType();const s=l!=null&&l.isTypeOf(r.VariableType.HIERARCHY_NODE_VARIABLE)?o.getHierarchyName():null;this._createMemberFilter();return t.createFromFFValueHelpNode(a,s,!i?e:null)}).onCatch(e=>{this._DataProvider._addMessagesToModel(e)}))};p.prototype.getMemberFilter=function(){return this.MemberFilter};p.prototype.setMemberFilter=function(e){return this._applyMemberFilter(e)};p.prototype.addMemberFilterByKey=function(e){return this.addMemberFilter(new t([e]))};p.prototype.setMemberFilterByKey=function(e){return this.setMemberFilter([new t([e])])};p.prototype.removeMemberFilterByKey=function(e){let t=i.filter(i.clone(this.getMemberFilter()),t=>t.InternalKey.includes(e));t=t&&t[0];return this.removeMemberFilter(t)};p.prototype.addMemberFilter=function(e){let t=i.clone(this.getMemberFilter())||[];t.push(e);return this.setMemberFilter(t)};p.prototype.removeMemberFilter=function(e){const t=i.filter(i.clone(this.getMemberFilter()),t=>e.UniqueID!==t.UniqueID);return this._applyMemberFilter(t)};p.prototype.clearMemberFilter=function(){return this._applyMemberFilter([])};p.prototype.openValueHelpDialog=function(e){let t;if(!this.SupportsValueHelp){throw new Error("No Value help for variable "+this.Name)}this._DataProvider._getQueryModel().queueEventing();this._DataProvider._FFDataProvider.getEventing().setEventingPaused(true);return this._DataProvider._reinitIfNeededPromise().then(()=>this._DataProvider._transferVariablesIfNeededPromise()).then(()=>new Promise(i=>{const a=r.FilterDialogProgramRunnerFactory.createForVariableFilter(this._DataProvider._Model.getApplication().getProcess(),this._DataProvider._getQueryManager(),this._FFVariable,n.getText("SELECTOR",[this.Description]));if(e){a.setStringArgument(r.FilterDialog.ARG_SEARCH_VALUE,e)}a.getProgramStartData().putXObject(r.FilterDialog.PRG_DATA_DEFAULT_SELECTION,r.FilterDialogValueFactory.createSelectionFromVariable(this._FFVariable));a.getProgramStartData().putXObject(r.FilterDialog.PRG_DATA_LISTENER_CLOSE,{onFilterDialogOk:function(e){i(e)},onFilterDialogCancel:function(){i(null)}});a.getProgramStartData().putXObject(r.FilterDialog.PRG_DATA_LISTENER_BEFORE_FILTER_CHANGE,{onBeforeChange:function(e){t=e.getDisplayInfo()}});a.runProgram()})).then(e=>{this._DataProvider._getQueryModel().resumeEventing();this._DataProvider._FFDataProvider.getEventing().setEventingPaused(false);let i=this._FFVariable.getMemberFilter();if(t){this.FilterDisplayType=this._getDisplayType(t);this._DataProvider._VariableDisplayType[this.Name]=this.FilterDisplayType;if(i){i.getUiSettings(r.QContextType.SELECTOR).setDisplayInfo(t)}}if(e){this._createMemberFilter();this._DataProvider.variableChanged=true;this._DataProvider._triggerDataProviderPropertyUpdate()}return!!e})};return p});
//# sourceMappingURL=Variable.js.map