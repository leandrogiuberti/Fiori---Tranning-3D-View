/*! SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
   */
sap.ui.define("sap/sac/df/model/visualization/Grid",["sap/ui/base/Object","sap/sac/df/thirdparty/lodash","sap/sac/df/firefly/library","sap/sac/df/utils/SyncActionHelper","sap/sac/df/model/MemberFilter","sap/sac/df/types/DimensionType","sap/sac/df/types/Axis","sap/sac/df/utils/ListHelper","sap/sac/df/model/visualization/Documents"],function(e,t,i,r,s,o,n,a,l){"use strict";var u=e.extend("sap.sac.df.model.visualization.Grid",{constructor:function(e){Object.assign(this,Object.getPrototypeOf(this));this._Visualization=e;this._DataProvider=e._DataProvider;this.Documents=new l(this._DataProvider);Object.assign(this);this._getMemberByKey=function(e,i){const r=t.find(e.getStructureMembers(),function(e){return e&&e.Key===i});return r&&r.Name};this._getVisibleMembers=function(e){const t=i.XHashMapByString.create();const r=e._FFDimension;const s=[];return Promise.resolve().then(()=>{let e=this._DataProvider._getQueryModel();let r=i.QueryDesignerUtils.getStructureDimensions(e);let s=i.XStream.of(r).map(e=>e.getMemberManager().getMemberResult().onThen(i=>{t.put(e.getName(),i)})).collect(i.XPromiseList.toPromiseList());let o=i.XPromise.all(s);return o}).then(()=>{const e=t.getByKey(r.getName()).getAllNodes();if(!i.XCollectionUtils.hasElements(e)){return null}let s=this._DataProvider._getQueryManager().getConvenienceCommands();let o=s.getVisibleMembers(r,e);if(r.getDimensionType()===i.DimensionType.ACCOUNT){return i.XStream.of(e).filter(e=>o.contains(e.getName())&&e.getDimensionMember().getResultVisibility()!==i.ResultVisibility.HIDDEN).collect(i.XStreamCollector.toListOfNameObject())}else{let t=s.getMembersInResultSetOrder(r);return i.XStream.of(t).filter(e=>o.contains(e.getName())&&e.getResultVisibility()!==i.ResultVisibility.HIDDEN).map(t=>e.getByKey(t.getName())).collect(i.XStreamCollector.toListOfNameObject())}}).then(t=>{if(t){a.arrayFromList(t).forEach(t=>{s.push(this._getMemberByKey(e,t.getName()))})}return s})}.bind(this);this._createAxesLayout=function(){let e=[];let i=[];const r=this._DataProvider.getMeasureStructureDimension();const s=this._DataProvider.getStructureDimension();return Promise.resolve().then(()=>{if(r){return this._getVisibleMembers(r).then(t=>{e=t})}}).then(()=>{if(s){return this._getVisibleMembers(s).then(e=>{i=e})}}).then(()=>({Columns:t.map(t.sortBy(t.filter(this._DataProvider.Dimensions,{Axis:n.Columns}),"Position"),e=>e.Name),Rows:t.map(t.sortBy(t.filter(this._DataProvider.Dimensions,{Axis:n.Rows}),"Position"),e=>e.Name),MeasureStructureMembers:e,StructureMembers:i}))};this._onVisualizationFilled=function(){return Promise.resolve(this._Visualization._getFFVisualization()).then(e=>{if(e.getProtocolBindingType()===i.ProtocolBindingType.SAC_TABLE_GRID){let t=e.getActiveTableContainer();if(i.notNull(t)){const e=t.getGridCollector();if(i.notNull(e)&&e.isValid()){let e=t.getVisualizationData();if(e){return this._createAxesLayout()}}else{this._DataProvider._addMessagesToModel(t.getData());this._DataProvider._Model.checkUpdate();this._DataProvider._Model.fireRequestFailed({infoObject:this._DataProvider.Name})}}}}).then(e=>{try{this.AxesLayout=e;this._DataProvider._Model.checkUpdate();this._DataProvider.fireDataUpdated()}catch(e){}})}}});u.prototype.getVisualizationData=function(){let e=this._Visualization._getFFVisualization().getActiveTableContainer();if(i.notNull(e)){const t=e.getGridCollector();if(i.notNull(t)&&e.getVisualizationData()&&t.isValid()){let t=e.getVisualizationData();if(t){try{return i.PivotTableExport.create(t,e)._export().convertToNative()}catch(e){}}}}};u.prototype.getCellContext=function(e,n){var a=this;var l=i.PivotTableCellContextProvider.create(a._DataProvider._getQueryManager());var u=i.RsCellIndexInfo.create();let c=this._Visualization._getFFVisualization().getActiveTableContainer();const m=c.getColumnTupleIndex(n);const d=c.getRowTupleIndex(e);if(m===-1&&d===-1){return Promise.resolve("Cell could not be found!")}u.initialize(d,m);let g;return r.syncActionToPromise(l.getCellContext,l,u).then(e=>{g=e?e.convertToNative():null;t.forEach(g,function(e){e.SelectionVariant=s.createSelectionVariantFromFFMemberFilter(e.Name,e.Filter);e.Filter=s.createFromFFMemberFilter(e.Filter);e.MemberFilter=e.Filter});g.Context=t.clone(g)}).then(()=>this.getVisualizationData()).then(r=>{g.Cell=r.Cells.filter(t=>t.Row===e&&t.Column===n);const s=[];const a=[];const l=t.uniq(t.map(t.filter(r.Cells,e=>e.CellType===i.PivotTableExportConstants.CT_DIM_MEMBER_COL&&e.Column===n),e=>{if(e.Dimension===o.MeasureStructure){s.push(e.Member)}if(e.Dimension===o.StructureDimension){a.push(e.Member)}return e.Dimension}));const u=t.uniq(t.map(t.filter(r.Cells,t=>t.CellType===i.PivotTableExportConstants.CT_DIM_MEMBER_ROW&&t.Row===e),e=>{if(e.Dimension===o.MeasureStructure){s.push(e.Member)}if(e.Dimension===o.StructureDimension){a.push(e.Member)}return e.Dimension}));g.Layout={Columns:l,Rows:u,MeasureStructureMembers:s,StructureMembers:a};return g}).catch(e=>{a._DataProvider._addMessagesToModel(e.getMessages?e:[]);return Promise.reject(e)})};u.prototype.getActiveTemplate=function(){return this._DataProvider._getQueryManager().getConvenienceCommands().getLinkedTableDefinitionName(this._Visualization.Name,i.OlapVisualizationConstants.TABLE_TEMPLATE_LINK)};u.prototype.setActiveTemplate=function(e){this._DataProvider._getQueryManager().getConvenienceCommands().putLinkedTableDefinitionName(this._Visualization.Name,i.OlapVisualizationConstants.TABLE_TEMPLATE_LINK,e);return this};u.prototype.setAxesLayout=function(e){this._DataProvider._getQueryManager().stopEventing();t.forEach(t.map(this._DataProvider.Dimensions,"Name"),e=>{this._DataProvider._getQueryModel().getAxis(i.AxisType.FREE).add(this._DataProvider._getQueryModel().getDimensionByName(this._DataProvider.getDimension(e).TechName))});t.forEach(e[n.Rows],e=>{this._DataProvider.getDimension(e).toRows()});t.forEach(e[n.Columns],e=>{this._DataProvider.getDimension(e).toColumns()});const r=function(e){const t=e._FFDimension.isStructure();const r=e._FFDimension.isHierarchyActive();const s=i.QueryDesignerUtils.supportsMemberSort(e._FFDimension);return s&&t&&!r};const o=function(e,o){var n=[];let a=i.XList.create();t.forEach(o,t=>{var i=e.getStructureMember(t);if(i){var r=new s([i.Key],[i.Name],[i.Description]);n.push(r)}a.add(i.TechName)});e.setMemberFilter(n);if(r(e)){let t=e._DataProvider._getQueryModel().getSortingManager();t.removeDimensionSorting(e._FFDimension);t.removeFieldSorting(e._FFDimension.getKeyField());t.applyCustomSort(e._FFDimension,e._FFDimension.getKeyField(),a,i.XSortDirection.ASCENDING,i.CustomSortPosition.TOP,true)}};if(this._DataProvider.getMeasureStructureDimension()&&e.MeasureStructureMembers){if(e.MeasureStructureMembers.length>0){o(this._DataProvider.getMeasureStructureDimension(),e.MeasureStructureMembers)}else if(e.MeasureStructureMembers===[]){this._DataProvider.getMeasureStructureDimension().clearMemberFilter()}}if(this._DataProvider.getStructureDimension()&&e.StructureMembers){if(e.StructureMembers.length>0){o(this._DataProvider.getStructureDimension(),e.StructureMembers)}else if(e.StructureMembers===[]){this._DataProvider.getStructureDimension().clearMemberFilter()}}this._DataProvider._FFDataProvider.getEventing().notifyExternalModelChange(null);this._DataProvider._getQueryManager().resumeEventing();this._DataProvider._executeModelOperation();return this};u.prototype.getAxesLayout=function(){return this.AxesLayout};u.M_PROPERTIES={Documents:"Documents",AxesLayout:"AxesLayout"};return u});
//# sourceMappingURL=Grid.js.map