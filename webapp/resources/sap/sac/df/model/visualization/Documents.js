/*!
* SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
*/
sap.ui.define("sap/sac/df/model/visualization/Documents",["sap/ui/base/Object","sap/sac/df/firefly/library","sap/sac/df/utils/ResourceBundle","sap/sac/df/utils/ListHelper","sap/sac/df/utils/SyncActionHelper","sap/sac/df/types/DocumentsSupportType"],function(e,t,r,o,n,s){"use strict";var i=e.extend("sap.sac.df.model.visualization.Documents",{constructor:function(e){Object.assign(this,Object.getPrototypeOf(this));this._DataProvider=e;this.ActiveDocumentsDirectory=this._getDocumentsInfo().getActiveDocumentsDirectory();this.DocumentsSupportType=this.getDocumentsSupportType();this.IsBasedOnCDSView=this._getDocumentsInfo().isBasedOnCDSView();this._extractProperties=e=>{if(e){var t=e.getContent();let o=e.getProperties();var r=e.getTimeStamp();return{version:e.getVersion(),owner:e.getOwner(),timestamp:r?r.toString():null,content:t?t.getStringContentExt():null,properties:o&&o.convertToNative()}}return null};this._updateDocument=(e,r,o)=>{if(!e){throw new Error("Cannot update document without document ID")}var s=this._getDocumentsInfo();if(s&&this.supportsWrite()){var i=s.getOrCreateDocumentsStoreService(false);if(o){i.addToPutListWithProperties(e,t.XContent.createStringContent(t.ContentType.TEXT_PLAIN,r),t.PrUtils.deserialize(JSON.stringify(o)))}else{i.addToPutList(e,t.XContent.createStringContent(t.ContentType.TEXT_PLAIN,r))}return n.syncActionToPromise(i.performRequests,i,[null,null]).then(()=>{var t=i.getContentForFile(e);return Promise.resolve(t?t.getStringContentExt()===r:t===r)}).catch(e=>{this._DataProvider._Model._addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})}else{throw new Error("No 'ReadWrite' document support. Unable to update document.")}};this._retrieveDocuments=(e,t)=>{if(!e||e.length===0){throw new Error("Cannot retrieve document without document ID")}var r=this._getDocumentsInfo();if(r){var o=r.getSupportsDocuments();if(o&&o.getName()!=="None"){var s=r.getOrCreateDocumentsStoreService(!t);e.forEach(e=>{s.addToFetchList(e)});return n.syncActionToPromise(s.performRequests,s,[null,null]).then(()=>{var r=[];e.forEach(e=>{var o=[];var n=!t?s.getDocumentVersionsForFile(e):s.getDocumentVersionForFileAndVersion(e,t);if(n){n.forEach(e=>{var t=this._extractProperties(e);if(t){o.push(t)}})}r.push({documentId:e,versions:o})});return Promise.resolve(e.length===1?r[0]:r)}).catch(e=>{this._DataProvider._Model._addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})}else{throw new Error("No document support. Unable to retrieve document.")}}}}});i.prototype._executeDocumentIDAction=function(e,r,o){const s=this._DataProvider;var i=s._getQueryManager().getResultsetContainer().getDocumentIdManager();var u=t.RsCellIndexInfo.create();u.initialize(e,r);return n.syncActionToPromise(i[o],i,u).then(e=>{s._FFDataProvider.getEventing().notifyExternalVisualizationChange(null);s._addMessagesToModel(e);return e}).catch(e=>{s._Model._addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})};i.prototype.createDocumentId=function(e,t){return this._executeDocumentIDAction(e,t,"createCellDocumentId").then(e=>e.getData().getCellDocumentId())};i.prototype._getDocumentsInfo=function(){return this._DataProvider._getQueryManager().getQueryModel().getDocumentsInfo()};i.prototype.getDocumentId=function(e,t){return this._executeDocumentIDAction(e,t,"getCellDocumentId").then(e=>e.getData().getCellDocumentId())};i.prototype.deleteDocumentId=function(e,t){return this._executeDocumentIDAction(e,t,"deleteCellDocumentId").then(e=>e.getData().isCellDocumentIdDeleted())};i.prototype.createDocument=function(e,t,r){if(!e){throw new Error("Cannot create document without document ID")}try{return this._updateDocument(e,t,r)}catch(e){return Promise.reject(e)}};i.prototype.createAndRetrieveDocument=function(e,r,o){return new Promise((s,i)=>{if(!e){i("Cannot create document without document ID");return}try{const u=this._getDocumentsInfo();if(u&&this.supportsWrite()){const c=u.getOrCreateDocumentsStoreService(true);if(o){c.addToPutListWithProperties(e,t.XContent.createStringContent(t.ContentType.TEXT_PLAIN,r),t.PrUtils.deserialize(JSON.stringify(o)))}else{c.addToPutList(e,t.XContent.createStringContent(t.ContentType.TEXT_PLAIN,r))}c.addToFetchList(e);n.syncActionToPromise(c.performRequests,c,[null,null]).then(()=>{const t=c.getContentForFile(e);if(t?t.getStringContentExt()===r:t===r){const t=[];const r=c.getDocumentVersionsForFile(e);if(r){r.forEach(e=>{const r=this._extractProperties(e);if(r){t.push(r)}})}s({documentId:e,versions:t})}else{i("Failed to create document with specified content.")}}).catch(e=>{this._DataProvider._Model._addMessages(e.getMessages?e.getMessages():[]);i(e)})}else{i("No 'ReadWrite' document support. Unable to create document.")}}catch(e){i(e)}})};i.prototype.retrieveDocument=function(e,t){return this._retrieveDocuments([e],t)};i.prototype.retrieveMultipleDocuments=function(e){return this._retrieveDocuments(e)};i.prototype.deleteDocument=function(e){if(!e){throw new Error("Cannot delete document without document ID")}var t=this._getDocumentsInfo();if(t&&this.supportsDelete()){var r=t.getOrCreateDocumentsStoreService(false);r.addToDeleteList(e);return n.syncActionToPromise(r.performRequests,r,[null,null]).then(()=>{r.evictAllDocuments();return Promise.resolve(true)}).catch(e=>{this._DataProvider._Model._addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})}else{throw new Error("No 'ReadWrite' document support. Unable to delete document.")}};i.prototype.getDocumentsSupportType=function(){var e=this._DataProvider._getQueryModel().getModelCapabilities().supportsCellDocumentId();if(e){var r=this._getDocumentsInfo().getSupportsDocuments();if(r){switch(r){case t.DocumentsSupportType.READ_WRITE:return s.ReadWrite;case t.DocumentsSupportType.READ_CREATE_CHANGE:return s.ReadCreateChange;case t.DocumentsSupportType.READ:return s.Read;case t.DocumentsSupportType.NONE:return s.None}}}return s.None};i.prototype.supportsRead=function(){return this.getDocumentsSupportType()===s.ReadWrite||this.getDocumentsSupportType()===s.ReadCreateChange||this.getDocumentsSupportType()===s.Read};i.prototype.supportsWrite=function(){return this.getDocumentsSupportType()===s.ReadWrite||this.getDocumentsSupportType()===s.ReadCreateChange};i.prototype.supportsDelete=function(){return this.getDocumentsSupportType()===s.ReadWrite};return i});
//# sourceMappingURL=Documents.js.map