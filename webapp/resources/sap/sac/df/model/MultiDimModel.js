/*
 * SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
 */
sap.ui.define("sap/sac/df/model/MultiDimModel",["sap/base/i18n/Formatting","sap/base/i18n/Localization","sap/ui/model/Model","sap/ui/model/json/JSONModel","sap/base/Log","sap/sac/df/utils/SyncActionHelper","sap/sac/df/types/SystemType","sap/sac/df/utils/ListHelper","sap/sac/df/model/internal/_DFKernel","sap/sac/df/model/internal/SystemLandscape","sap/sac/df/model/DataProvider","sap/sac/df/model/VariableGroup","sap/sac/df/model/Configuration","sap/sac/df/model/internal/ConfigurationMapping","sap/sac/df/utils/ResourceBundle","sap/ui/core/Configuration","sap/ui/model/BindingMode","sap/sac/df/utils/ConfigLoader","sap/sac/df/utils/MetaPathHelper","sap/sac/df/types/VisualizationType","sap/sac/df/model/extensions/contextMenu/ContextMenuProviderRegistry","sap/sac/df/model/extensions/styling/GridStylingTemplateRegistry","sap/sac/df/thirdparty/lodash","sap/sac/df/firefly/library"],function(e,t,r,a,i,o,n,s,d,u,l,p,c,g,f,h,P,m,v,y,D,S,C,A){"use strict";var M=a.extend("sap.sac.df.model.MultiDimModel",{constructor:function(e){Object.assign(this,Object.getPrototypeOf(this));r.call(this);var t=this;this.VariableGroupMapping={};this.ModelPointer=null;this._metadataCacheEnabled=e&&e.metadataCacheEnabled||false;const a=e&&e.composableServicePath||"composable-service/vfs/analyticalwidgets/";if(e&&e.systemLandscape&&e.masterSystem){e.systemLandscape.masterSystem=e.masterSystem}if(e&&!e.systemLandscape){e.systemLandscape=u;e.systemLandscape.systemType=n.BW}this._SystemSettings={systemLandscape:e&&e.systemLandscape,clientIdentifier:e&&e.clientIdentifier,keepAliveInterval:e&&e.keepAliveInterval,composableServicePath:a,composableServiceLocal:e&&e.composableServiceLocal};this._Configuration=e&&e.Configuration||{};this._Kernel=new d(t);this.initCompletedPromise=this._getUserProfile().then(e=>this._Kernel.init({systemSettings:this._SystemSettings,userProfile:e})).then(function(e){t.kernelProgram=e;t._setupSharedDataSpace();A.XLocalizationCenter.setExternalAdapter(f);A.XLocalizationCenter.getCenter().setProductive(true)}).then(function(){t._StylingProviderRegistry={Grid:new S(t)};t._ContextMenuProviderRegistry=new D(t);t.setData({DataProviders:{},VariableGroups:{},Messages:[],Configuration:{}});t.checkUpdate()}).then(function(){return e.Configuration?e.Configuration:e.ConfigurationURI&&m.loadConfigFromFile(e.ConfigurationURI)}).then(function(e){if(e){return A.CoConfigurationUtils.writeConfigurationForNameAndLayer(t.getApplication().getProcess(),"FeatureConfiguration",A.PrUtils.deserialize(JSON.stringify(e)).asStructure(),A.CoConfigurationLayer.PLATFORM)}}).then(function(){return t.onAfterInitCompleted&&t.onAfterInitCompleted()});t._openSettingDialog=function(){return new Promise(e=>{let t=A.SuSettingsDialog.createRunnerForConfiguration(this.getApplication().getProcess(),"FeatureConfiguration",()=>{A.CoConfigurationUtils.getResolvedConfigurationForName(this.getApplication().getProcess(),"FeatureConfiguration").onThen(t=>{this._Configuration=t.getConfigurationStructure().convertToNative();e(this._Configuration)})});t.setBooleanArgument(A.SuSettingsDialog.PARAM_USER_MODE,true);t.setStringArgument(A.SuSettingsDialog.PARAM_CONFIGURATION_NAMES,"FeatureConfiguration");return t.runProgram()})};t._setupSharedDataSpace=function(){var e=this.getSession();if(e){var t=e.getSharedDataSpace(A.OuDataProviderCommandPlugin.DEFAULT_SHARED_SPACE_NAME);if(!t){e.createSharedDataSpace(A.OuDataProviderCommandPlugin.DEFAULT_SHARED_SPACE_NAME)}}};t._addMessages=function(e){this.setMessages(C.map(C.groupBy(C.concat(this.getMessages(),e),"Text"),e=>e[0]));return this.checkUpdate()};var i=this.initCompletedPromise.then(()=>{if(this._Configuration){this.Configuration=new c(this,this._Configuration);return this.Configuration.applyConfiguration()}}).then(()=>{var r=[];const a=e&&e.DataProviders||[];C.forEach(a,(e,a)=>{var i=this.addDataProvider(a,e.dataSourceName,e.systemName,e.packageName,e.schemaName,e.dataSourceType,e.startWithAutoFetch,e?.Visualizations);r.push(e.synchronize?i.then(()=>t.getDataProvider(a).synchronize()):i)});return Promise.all(r).then(()=>t).catch(function(e){t._addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})});t.metadataLoaded=()=>i;t.loaded=t.metadataLoaded;t.annotationsLoaded=t.metadataLoaded;t.attachMetadataFailed=C.constant(null);t.fireMetadataFailed=C.constant(null);t.dataLoaded=C.constant(null);t.attachPropertyChange(function(e){if(e.getParameter("path").includes("/AutoFetchEnabled")){t.getDataProvider(e.getParameter("path").split(v.PathTo.DataProviders+"/")[1].split("/AutoFetchEnabled")[0]).setAutoFetchEnabled(e.getParameter("value"))}})},_getUserProfile:function(){const r=new a({defaults:{dateFormat:"MM/DD/YYYY",groupingSeparator:".",decimalSeparator:",",timeFormat:"24hrs"},header:{language:"EN"}});r.setProperty("/header/language",t.getLanguage());const i=e.getCustomLocaleData();if(i&&i["dateFormats-medium"]){r.setProperty("/defaults/dateFormat",i["dateFormats-medium"])}const o=e.getNumberSymbol("decimal");if(o){r.setProperty("/defaults/decimalSeparator",o)}const n=e.getNumberSymbol("group");if(n){r.setProperty("/defaults/groupingSeparator",n)}if(o&&n){r.setProperty("/defaults/groupingSeparator",n)}let s;const d=sap.ui.require("sap/ushell/Container");if(d&&d.getServiceAsync){s=d.getServiceAsync("UserInfo")}else{s=Promise.resolve(null)}return s.then(e=>{if(e){r.setProperty("/username",e.getId());r.setProperty("/header/mail",e.getEmail());r.setProperty("/header/firstName",e.getFirstName());r.setProperty("/header/lastName",e.getLastName());r.setProperty("/header/fullName",e.getFullName())}return JSON.stringify(r.getData())})},getSession:function(){if(!this.kernelProgram){i.error("Kernel not initialized");return null}return this.getApplication().getSession()},getApplication:function(){return this._Kernel.getApplication()},getStylingProvider:function(){return this._StylingProvider},getWidgets:function(){const e=[];A.OuAnalyticalWidgetUtils.getWidgetListFromWidgetCatalog(this.getApplication().getProcess(),"/analyticalwidgets").onThen(t=>{A.XCollectionUtils.forEach(t,t=>{e.push({ID:t.getName(),Name:t.getDisplayName(),Description:t.getDescription(),Type:t.getWidgetTypeString(),Datasource:t.getDataSourceName(),FQN:t.getDataSourceFQN()})})});return e},getModelPointer:function(){return this.getProperty("/ModelPointer")},setModelPointer:function(e){return this.setProperty("/ModelPointer",e)},_updateVariableGroups:function(e){C.forEach(this.getVariableGroups(),function(t){t.updateVariableGroup(e)})}});M.prototype.fireDataProviderUpdated=function(e){this.fireEvent("dataProviderUpdated",e);return M};M.prototype.addDataProvider=function(e,t,r,a,i,o,n,s){var d=this;let u=true;if(typeof t==="string"){u=C.isUndefined(n)?true:n}else{u=C.isUndefined(t?.SetupProperties?.AutoFetch)?true:t?.SetupProperties?.AutoFetch}return d.initCompletedPromise.then(d.removeDataProvider(e)).then(function(){const n=new l(d,e);d.setProperty(v.PathTo.DataProviders+"/"+e,n);return n._createFFDataProvider(t,r,a,i,o,s)}).then(function(t){if(t){t._FFDataProvider?.getResulting().setAutoFetchActive(u);d.setProperty(v.PathTo.DataProviders+"/"+e+"/AutoFetchEnabled",u);d._updateVariableGroups(true);d.fireDataProviderAdded({dataProviderName:e})}return t}).then(function(e){return e}).catch(function(e){d._addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})};M.prototype.fireDataProviderAdded=function(e){this.fireEvent("dataProviderAdded",e);return M};M.prototype.fireDataProviderRemoved=function(e){this.fireEvent("dataProviderRemoved",e);return M};M.prototype.fireVariableGroupsAdded=function(e){this.fireEvent("variableGroupsAdded",e);return M};M.prototype.getDataProvider=function(e){return this.getProperty(v.PathTo.DataProviders+"/"+e)};M.prototype.getDataProviders=function(){return this.getProperty(v.PathTo.DataProviders)};M.prototype.removeDataProvider=function(e){var t=this;var r=this.getDataProvider(e);this.setProperty(v.PathTo.DataProviders+"/"+e,null);if(r){return r.destroy&&r.destroy().then(function(){t._updateVariableGroups();t.fireDataProviderRemoved({dataProviderName:e})}).catch(function(e){return Promise.resolve(e)})}else{return Promise.resolve()}};M.prototype.getVariableGroups=function(){return this.getProperty(v.PathTo.VariableGroups)};M.prototype.getVariableGroup=function(e){return this.getProperty(v.PathTo.VariableGroups+"/"+e)};M.prototype.createVariableGroup=function(e,t,r){return new p(this,e,t,r)};M.prototype.setVariableGroups=function(e){C.forEach(e,e=>{this.setProperty(v.PathTo.VariableGroups+"/"+e.Name,e)});this.fireVariableGroupsAdded();return Promise.resolve(e)};M.prototype.propagateVariableGroupValues=function(e){var t=this;var r=[];var a=this.getDataProvider(e);const i=this.getVariableGroups();const o=i.length>0&&i[0].MergedVariable.DataProviderName;if(o!==e){C.forEach(i,function(r){var i=t.VariableGroupMapping[r.Name];C.forEach(i,function(t){if(t.DataProviderName===e){a.getVariable(t.Name)._transferMemberFilterFromAnotherVariable(r.MergedVariable)}})});this.checkUpdate()}return Promise.all(r)};M.prototype.setMessages=function(e){return this.setProperty(v.PathTo.Messages,e)};M.prototype.getMessages=function(){return this.getProperty(v.PathTo.Messages)};M.prototype.getConfiguration=function(){return this.getProperty(v.PathTo.Configuration)};M.prototype.logoff=function(){return this.destroy()};M.prototype.destroy=function(){return Promise.all(C.invokeMap(this.getDataProviders(),"destroy")).then(()=>this._Kernel.destroy()).then(()=>{a.prototype.destroy.apply(this,arguments)})};M.prototype.resetModel=function(){if(!this.bSkipDeserialization){var e=this;var t=[];C.forEach(this.getDataProviders(),function(e){t.push(e.resetToMetaData())});return Promise.all(t).then(function(){e._updateVariableGroups()})}};M.prototype.serialize=function(e){return{AssignedFilters:this.getProperty("/AssignedFilters"),DataProviders:C.reduce(this.getDataProviders(),function(t,r){t[r.Name]=r.serialize(e);return t},{})}};M.prototype.deserialize=function(e,t){if(!this.bSkipDeserialization){var r=this;var a=this.getDataProviders();this.setProperty(v.PathTo.DataProviders,a||{});return this.initCompletedPromise.then(function(){var i=[];r.setProperty("/AssignedFilters",e.AssignedFilters);C.forEach(e.DataProviders,function(o,n){let s=a[n];if(s&&s._FFDataProvider){i.push(s.deserialize(o,t))}else{r.attachEvent("dataProviderAdded",null,function(a){const i=e.DataProviders[a.getParameter("dataProviderName")];if(i){return Promise.resolve(r.getDataProvider(a.getParameter("dataProviderName")).deserialize(i,t))}})}});return Promise.all(i)}).then(function(){r._updateVariableGroups();return r.checkUpdate()})}};M.prototype.skipDeserialization=function(e){this.bSkipDeserialization=e};M.prototype.getGridStylingTemplateRegistry=function(){return this._StylingProviderRegistry.Grid};M.prototype.getContextMenuProviderRegistry=function(){return this._ContextMenuProviderRegistry};M.M_EVENTS={variableGroupsAdded:"variableGroupsAdded",dataProviderAdded:"dataProviderAdded",dataProviderUpdated:"dataProviderUpdated",dataProviderRemoved:"dataProviderRemoved",loaded:"loaded",dataLoaded:"dataLoaded"};M.M_PROPERTIES={DataProviders:"DataProviders",VariableGroups:"VariableGroups",Messages:"Messages",Configuration:"Configuration",ModelPointer:"ModelPointer"};return M});
//# sourceMappingURL=MultiDimModel.js.map