/*
 * SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
 */
sap.ui.define("sap/sac/df/model/extensions/contextMenu/ContextMenuProvider",["sap/ui/base/Object","sap/base/Log","sap/sac/df/firefly/library","sap/sac/df/utils/ListHelper"],function(t,e,n,o){"use strict";const i="Gds.Qb.Table.ContextMenu";const r="Gds.Qb.Table.Toolbar";const s={Grid:i,Toolbar:r};const c=t.extend("sap.sac.df.model.extensions.contextMenu.ContextMenuProvider",{actionExecution:{},constructor:function(t){this._Model=t;this.actions={}},isActionVisible:function(t,e){return true},isActionEnabled:function(t,e){return true},onActionTriggered:function(t,e){const n=this.actions[t]||c.actionExecution[t];if(n&&(!n.builtin||n.Type==="Submenu")){switch(e.getUiContext()){case i:n.triggerAction(t,this.convertTableContextMenuContext(e));break;case r:n.triggerAction(t,this.convertTableToolbarContextMenuContext(e));break}}},fireOnClickEvent:function(){},provideMenuConfig:function(t,o,u){c.actionExecution={};const a=n.PrFactory.createStructure();const l=[];if(Object.keys(this.actions).length>0){const e=a.putNewList("MenuExtensions");const n=e.addNewStructure();const o=n.putNewList("Extension");let u=null;switch(t.getUiContext()){case i:u=this.convertTableContextMenuContext(t);n.putNewList("UiContext").addString(i);break;case r:u=this.convertTableToolbarContextMenuContext(t);n.putNewList("UiContext").addString(r);break}Object.keys(this.actions).forEach(e=>{const n=this.actions[e];const r=n.context&&s[n.context]?s[n.context]:i;if(r===t.getUiContext()){const a=o.addNewStructure();const d=a.putNewList("Items");const f=d.addNewStructure();function g(t,e){return n.isActionVisible(t,u).then(t=>{e.putBoolean("Visible",t)})}function p(t,e){return n.isActionEnabled(t,u).then(t=>{e.putBoolean("Enabled",t)})}function x(t,e,o){return n.getActionDescription(t,u).then(i=>{if(i.InsertAfter){if(o){return Promise.reject(`Action ${t} is nested. InsertAfter is not allowed `)}a.putString("Operation","InsertAfter");a.putString("Reference",i.InsertAfter)}else if(i.InsertBefore){if(o){return Promise.reject(`Action ${t} is nested. InsertBefore is not allowed `)}a.putString("Operation","InsertBefore");a.putString("Reference",i.InsertBefore)}else if(!o){a.putString("Operation","AppendInto");a.putString("Reference","$Root")}if(!i.builtin){e.putString("Text",i.Text);if(i.Icon){e.putString("Icon",i.Icon)}}if(i.Type==="Submenu"){e.putString("Type","Submenu");if(i.OverflowIfMoreThanNItems){e.putString("OverflowIfMoreThanNItems",i.OverflowIfMoreThanNItems)}const t=i.NestedActions;const n=e.putNewList("Items");const o=[];t.forEach(t=>{const e=n.addNewStructure();o.push(x(t,e,true));o.push(p(t,e));o.push(g(t,e))});return o}else{e.putString("Action",t);c.actionExecution[t]=n}})}if(n.getActionDescription){l.push(x(e,f,false))}else{f.putString("Action",e);a.putString("Operation","AppendInto");a.putString("Reference","$Root")}if(!n.builtin){l.push(p(e,f));l.push(g(e,f))}}})}Promise.all(l).then(function(){if(e.isLoggable()){e.debug(n.PrUtils.serialize(a))}o.onDynamicMenuConfigProvided(t,"contextMenuProvider",a,u)}).catch(i=>{e.error("Failed to provide custom context menu",i,"ContextMenuProvider");o.onDynamicMenuConfigProvided(t,"contextMenuProvider",n.PrFactory.createStructure(),u)})},registerAction:function(t,e){this.actions[t]=e},unregisterAction:function(t){delete this.actions[t]},isReleaseLocked:function(){return true},convertCellClickContext:function(t,e){const n={DataProvider:e,Grid:{SelectedCells:[],SelectedDataCells:[]}};const o=parseInt(t.getParameters().getByKey("column"));const i=parseInt(t.getParameters().getByKey("row"));if(o>=0&&i>=0){n.Grid.SelectedCells.push({rowIndex:i,columnIndex:o});this._setSelectedDataCells(n,i,o)}return n},convertTableToolbarContextMenuContext:function(){const t={Context:"Toolbar",DataProvider:Object.values(this._Model?.getDataProviders())[0]};return t},convertTableContextMenuContext:function(t){const e=this._getDataProvider(t);var n=this;const i={Context:"Grid",DataProvider:e&&e.Name,Grid:{SelectedCells:[],SelectedDataCells:[]}};let r=o.arrayFromList(o.arrayFromList(t.getSubContexts("Selected.Cells"))[0].getSubContexts());r.forEach(function(t){const e=t.getCustomObject().getFirstObject().getInteger();const o=t.getCustomObject().getSecondObject().getInteger();if(e>=0&&o>=0){i.Grid.SelectedCells.push({rowIndex:o,columnIndex:e});n._setSelectedDataCells(i,o,e)}});return i},_setSelectedDataCells:function(t,e,n){if(n&&e){const o=this._Model.getDataProvider(t.DataProvider);const i=o.getGridVisualization()._getFFVisualization().getActiveTableContainer();const r=i.getColumnTupleIndex(n);const s=i.getRowTupleIndex(e);const c=i.getDocumentId(n,e);if(r>=0&&s>=0){t.Grid.SelectedDataCells.push({rowIndex:s,columnIndex:r,documentId:c})}}},_getDataProvider:function(t){let e=t.getSingleSubContext("Olap.DataProvider")?.getCustomObject();return e&&this._Model.getDataProvider(e.getName())}});return c});
//# sourceMappingURL=ContextMenuProvider.js.map