/*!
* SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
*/
sap.ui.define("sap/sac/df/model/Dimension",["sap/ui/base/Object","sap/sac/df/model/MemberFilter","sap/sac/df/thirdparty/lodash","sap/sac/df/firefly/library","sap/sac/df/utils/ResourceBundle","sap/sac/df/utils/ListHelper","sap/sac/df/types/DisplayType","sap/sac/df/utils/SyncActionHelper","sap/sac/df/types/DimensionType"],function(e,t,i,r,n,s,o,a,l){"use strict";const c=e.extend("sap.sac.df.model.Dimension",{constructor:function(e,n){Object.assign(this,Object.getPrototypeOf(this));const a=this;this._DataProvider=e;this._FFDimension=n;const c=this._FFDimension.getAxisType();if(c!==r.AxisType.COLUMNS&&c!==r.AxisType.ROWS&&c!==r.AxisType.FREE){return null}const u=this._FFDimension.getAxis();const m=this._FFDimension.isMeasureStructure();const F=this._FFDimension.isStructure();if(!this._FFDimension.getExternalName()||this._FFDimension.getExternalName().trim()===""){this._FFDimension.getExternalName=this._FFDimension.getName}this._createMemberFilter=function(){this.MemberFilter=[];if(this._FFDimension.isStructure()||this._FFDimension.isMeasureStructure()){this.MemberFilter=this._createMemberFilterForStructures()}else{this.MemberFilter=i.map(this._FFDimension.getFilter()&&s.arrayFromList(this._FFDimension.getFilter()),e=>t._createFromFFFilter(e,this._FFDimension.getFilter()))}};this._getDisplayType=function(e){switch(e){case r.FilterDisplayInfo.ID:return o.Key;case r.FilterDisplayInfo.DESCRIPTION:return o.Text;case r.FilterDisplayInfo.ID_AND_DESCRIPTION:return o.KeyText;case r.FilterDisplayInfo.DESCRIPTION_AND_ID:return o.TextKey}};this._createMemberFilterForStructures=function(){const e=this._FFDimension.getFilter()&&s.arrayFromList(this._FFDimension.getFilter());if(e){return i.map(e,e=>{const r=i.find(a.getStructureMembers(),t=>t.Key===e.getLow().getString());const n=e.getSetSign().getName?e.getSetSign().getName():e.getSetSign();const s=e.getComparisonOperator().getName();const o=t.getUI5OperatorFromFFOperator({Sign:n,Operator:s});return this._createMemberFilterFromStructureMember(r,o)})}};this._createMemberFilterFromStructureMember=function(e,i){return new t([e.Key],[e.Name],[e.Description],i)};if(m){h(this);this.Members=p(this._FFDimension)}else if(F&&!m){y(this);this.Members=p(this._FFDimension)}const g=!!this._FFDimension.getFilter();Object.assign(this,{Name:this._FFDimension.getExternalName(),TechName:this._FFDimension.getName(),Description:this._FFDimension.getText(),Axis:u.getName(),Type:this._FFDimension.getDimensionType().getName(),HierarchyActive:this._FFDimension.isHierarchyActive(),HasFilter:g,SortDirection:d(this._FFDimension),Position:u.getDimensionIndex(this._FFDimension.getName()),LastPosition:u.getDimensionCount()-1,IsStructure:this._FFDimension.isStructure(),IsMeasureStructure:this._FFDimension.isMeasureStructure(),ValueType:f(this._FFDimension),DisplayType:r.FilterDisplayInfo.getDimensionDisplayInfo(this._FFDimension),FilterDisplayType:null,SemanticObject:this._FFDimension.getSemanticObject(),MemberFilter:[],SupportedOperators:D(a._FFDimension).filter(e=>e!=null)});a._createMemberFilter();if(this._FFDimension.getFilter()&&this.FilterDisplayType!==this._FFDimension.getFilter().getUiSettings(r.QContextType.SELECTOR).getDisplayInfo()){this.FilterDisplayType=this._getDisplayType(this._FFDimension.getFilter().getUiSettings(r.QContextType.SELECTOR).getDisplayInfo())}else{this.FilterDisplayType=this._getDisplayType(this.DisplayType)}function D(e){if(e&&e.getFilterCapabilities()){let n=e.getFlatKeyField();if(!!n&&e.getFilterCapabilities().getFilterCapabilitiesByField(n)){const o=s.arrayFromList(e.getFilterCapabilities().getFilterCapabilitiesByField(n).getSupportedComparisonOperators(r.SetSign.INCLUDING));if(o){return i.map(o,function(e){if(e&&e.getName()){return t.getUI5OperatorFromFFOperator({Sign:"INCLUDING",Operator:e.getName()})}})}}}return["EQ"]}function p(e){const t=e.getDisplayKeyField();return i.map(s.arrayFromList(e.getAllStructureMembers()),function(i){return _(i,e,t)})}function h(e){e._FFDimension.getExternalName=i.constant(l.MeasureStructure);e.addMemberFilterByKey=function(e){const i=this.getStructureMember(e);if(i){const e=new t([i.Key],[i.Name],[i.Description]);return new Promise(t=>{this.addMemberFilter(e);t()})}};e.removeMemberFilterByKey=function(e){const i=this.getStructureMember(e);if(i){const e=new t([i.Key],[i.Name],[i.Description]);return new Promise(t=>{this.removeMemberFilter(e);t()})}};e.setMemberFilterByKey=function(e){const i=this.getStructureMember(e);if(i){const e=new t([i.Key],[i.Name],[i.Description]);const r=[e];return new Promise(e=>{this.setMemberFilter(r);e()})}};e.getStructureMembers=function(){return e.Members};e.getStructureMember=function(t){return i.find(e.getStructureMembers(),function(e){return e&&e.Name===t})};e.setScalingFactor=function(t,i){return e._DataProvider.getMeasure(t).setScalingFactor(i)};e.getScalingFactor=function(t){return e._DataProvider.getMeasure(t).getScalingFactor()};e.setDecimalPlaces=function(t,i){return e._DataProvider.getMeasure(t).setDecimalPlaces(i)};e.getDecimalPlaces=function(t){return e._DataProvider.getMeasure(t).getDecimalPlaces()}}function y(e){e._FFDimension.getExternalName=i.constant(l.StructureDimension);e.addMemberFilterByKey=function(e){const i=this.getStructureMember(e);if(i){const e=new t([i.Key],[i.Name],[i.Description]);return new Promise(t=>{this.addMemberFilter(e);t()})}};e.removeMemberFilterByKey=function(e){const i=this.getStructureMember(e);if(i){const e=new t([i.Key],[i.Name],[i.Description]);return new Promise(t=>{this.removeMemberFilter(e);t()})}};e.setMemberFilterByKey=function(e){const i=this.getStructureMember(e);if(i){const e=new t([i.Key],[i.Name],[i.Description]);const r=[e];return new Promise(e=>{this.setMemberFilter(r);e()})}};e.getStructureMembers=function(){return e.Members};e.getStructureMember=function(t){return i.find(e.getStructureMembers(),function(e){return e.Name===t})};e.setScalingFactor=function(){};e.getScalingFactor=function(){};e.setDecimalPlaces=function(){};e.getDecimalPlaces=function(){}}function _(e,t,i){return{Key:e.getFieldValue(t.getKeyField()).getValue().getString(),Name:e.getFieldValue(i)?e.getFieldValue(i).getValue().getString():e.getName(),TechName:e.getName(),Description:e.getText(),SemanticObject:e.getSemanticObject()}}function d(e){const t=a._DataProvider._getQueryModel().getSortingManager();if(t.supportsDimensionSorting(e,null)&&e.hasSorting()){return e.getResultSetSorting().getDirection().getName()}else{return null}}function f(e){let t=r.XValueType.STRING;const i=e.getFlatKeyField();if(i&&(i.getValueType().isNumber()||r.QFilterUtil.supportsDateRangeFilter(i))){t=i.getValueType()}return t.getName()}}});c.prototype.searchMember=function(e,i,n,s,o,a){const l=this;if(n===undefined){n=true}if(s===undefined){s=true}if(o===undefined){a=false;o=1}const c=this._FFDimension;const u=r.XList.create();const m=r.XList.create();const F=c.getDimension();const g=F.getTextField();if(g){m.add(g);if(n){u.add(g)}}if(F.getDisplayKeyField()&&s){u.add(F.getDisplayKeyField())}return r.QFactory.createDimensionValueHelpWizard(c).withReadMode(r.QMemberReadMode.BOOKED).withPaging(0,o).withMainKeyAndTextFields().searchPromise(e,s,n,a,i).then(function(r){const n=c.getHierarchyName();return t.createFromFFValueHelpNode(r,n,!i?e:null)}).onCatch(function(e){l._DataProvider.addMessages(e)})};c.prototype.toRows=function(){this._DataProvider._executeModelOperation(()=>{this._DataProvider._FFDataProvider.getActions().getAxisActions().moveDimensionToAxis(this.TechName,r.AxisType.ROWS)});return this};c.prototype.toColumns=function(){this._DataProvider._executeModelOperation(()=>{this._DataProvider._FFDataProvider.getActions().getAxisActions().moveDimensionToAxis(this.TechName,r.AxisType.COLUMNS)});return this};c.prototype.moveUp=function(){this._DataProvider._executeModelOperation(()=>{const e=this._FFDimension.getAxis();const t=e.getDimensionIndex(this._FFDimension.getName())-1;e.insert(t,this._FFDimension)});return this};c.prototype.moveDown=function(){this._DataProvider._executeModelOperation(()=>{const e=this._FFDimension.getAxis();const t=e.getDimensionIndex(this._FFDimension.getName())+1;e.insert(t,this._FFDimension)});return this};c.prototype.getMemberFilter=function(){return this.MemberFilter};c.prototype._applyMemberFilter=function(e){const n=t._condenseDimensionMemberFilter(e,i.clone(this._FFDimension.getFilter()),this._FFDimension);this._DataProvider._getQueryModel().queueEventing();r.QFilterUtil.clearSelectionsInContainerByDimension(this.TechName,this._DataProvider._getQueryModel().getFilter().getDynamicFilter());r.FilterDialogValueUtils.updateDynamicFilter(this._FFDimension,n);this._DataProvider._getQueryModel().resumeEventing();this._createMemberFilter();this._DataProvider._triggerDataProviderPropertyUpdate()};c.prototype.setMemberFilter=function(e){return this._applyMemberFilter(e)};c.prototype.removeMemberFilter=function(e){const t=i.filter(i.clone(this.getMemberFilter()),function(t){return!i.isEqual(e.InternalKey,t.InternalKey)});if(t.length>0){return new Promise(e=>{this._applyMemberFilter(t);e()})}else{return new Promise(e=>{this.clearMemberFilter();e()})}};c.prototype.clearMemberFilter=function(){return new Promise(e=>{this._applyMemberFilter([]);e()})};c.prototype.addMemberFilterByKey=function(e){const i=new t([e]);return new Promise(e=>{this.addMemberFilter(i);e()})};c.prototype.setMemberFilterByKey=function(e){const i=[new t([e])];return new Promise(e=>{this.setMemberFilter(i);e()})};c.prototype.removeMemberFilterByKey=function(e){return new Promise(i=>{this.removeMemberFilter(new t([e]));i()})};c.prototype.addMemberFilter=function(e){let t=i.clone(this.getMemberFilter())||[];t.push(e);return new Promise(e=>{this.setMemberFilter(t);e()})};c.prototype.sort=function(e,t,i,n){this._DataProvider._executeModelOperation(()=>{const s=this._DataProvider._getQueryModel().getDimensionByName(this.TechName);if(this.IsStructure){const t=this._DataProvider._getQueryManager().getConvenienceCommands();t.clearSort(null,null);const s=i&&this._DataProvider.getMeasureStructureDimension().getStructureMember(i).TechName;const o=n&&this._DataProvider.getStructureDimension().getStructureMember(n).TechName;if(i){n?t.sortByQueryDataCell(s,o,r.XSortDirection[e],this._FFDimension.getAxis().getType()):t.sortByMeasure(s,r.XSortDirection[e])}}else{s.getResultSetSorting().setDirection(r.XSortDirection[e]);if(t){s.getResultSetSorting().setSortType(r.SortType[t])}}});return this};c.prototype.removeDrilldown=function(){this._DataProvider._executeModelOperation(()=>{this._DataProvider._getQueryModel().getAxis(r.AxisType.FREE).add(this._FFDimension)});return this};c.prototype.setDisplayHierarchy=function(e,t,i){this._DataProvider._executeModelOperation(()=>{if(t){this._FFDimension.setHierarchyName(t);if(i){this._FFDimension.setHierarchyVersion(i)}}this._FFDimension.setHierarchyActive(e)});return this};c.prototype.setHierarchyDrillLevel=function(e){this._DataProvider._executeModelOperation(()=>{this._DataProvider._FFDataProvider.getActions().getHierarchyActions().setDrillLevel(this.TechName,e)});return this};c.prototype.readHierarchy=function(e){const t=this;const s=this._DataProvider._getQueryManager().getValueHelpProvider();const o=this._FFDimension.getInitialDrillLevel();this._FFDimension.setSelectorInitialDrillLevel(e);const l=new Promise((e,i)=>{s.processValueHelp(t._FFDimension,r.SyncType.NON_BLOCKING,{onValuehelpExecuted:function(t){return t.hasErrors()?i(a.reject(t.getErrors())):e(t.getData())}},null,null)});return l.then(e=>{function r(e){if(!e){return{}}const t=e.getChildren();return{Name:e.getName(),Text:e.getDimensionMember().getText()||e.getDimensionMember(e.getDimension().getHierarchyDisplayKeyField()).getValue().getString(),hierNodes:t?i.map(t.getListFromImplementation(),r):null}}t._FFDimension.setSelectorInitialDrillLevel(o);const s=i.filter(e.getListFromImplementation(),e=>!e.getParentNode());return s.length===1?r(s[0]):{Name:"$Root",Text:n.getText("ARTIFICIAL_ROOT"),hierNodes:i.map(s,r)}})};c.prototype.setDimensionDisplay=function(e){this._DataProvider._executeModelOperation(()=>{const t=this._FFDimension.getDisplayKeyField()||this._FFDimension.getKeyField();const r=this._FFDimension.getTextField();const n=this._FFDimension.getResultSetFields();const a=i.filter(s.arrayFromList(n).map(e=>e),e=>e!==this._FFDimension.getKeyField()&&e!==this._FFDimension.getTextField()&&e!==this._FFDimension.getDisplayKeyField());n.clear();switch(e){case o.Key:n.add(t);break;case o.Text:n.add(r);break;case o.KeyText:n.add(t);n.add(r);break;case o.TextKey:n.add(r);n.add(t);break}i.forEach(a,e=>{n.add(e)})});return this};c.prototype.openPropertyDialog=function(){const e=this;return new Promise(function(t){const i=r.ProgramRunner.createRunner(e._DataProvider._Model.getApplication().getProcess(),r.OuDimensionDialog2.DEFAULT_PROGRAM_NAME);i.setStringArgument(r.OuDimensionDialog2.PARAM_DIMENSION_NAME,e.TechName);const n=r.ProgramStartData.create();n.putXObject(r.DfOuDialogProgram.PRG_DATA_QUERY_MANAGER,e._DataProvider._getQueryManager());n.putXObject(r.DfOuDialogProgram.PRG_DATA_OK_PROCEDURE,{execute:function(){t(true)}});n.putXObject(r.DfOuDialogProgram.PRG_DATA_CANCEL_PROCEDURE,{execute:function(){t(false)}});i.setProgramStartData(n);return i.runProgram()}).then(function(t){if(t){e._DataProvider._executeModelOperation()}})};c.prototype.openValueHelpDialog=function(e){let t=this;let i;if(!this._DataProvider._getQueryModel().getFilter().getDynamicFilter().isCartesianProduct()){throw new Error("Filter to complex")}return Promise.resolve().then(()=>new Promise(t=>{const s=r.FilterDialogProgramRunnerFactory.createForDimensionFilter(this._DataProvider._Model.getApplication().getProcess(),this._DataProvider._getQueryManager(),this._FFDimension.getName(),n.getText("SELECTOR",[this.Description]));if(e){s.setStringArgument(r.FilterDialog.ARG_SEARCH_VALUE,e)}s.getProgramStartData().putXObject(r.FilterDialog.PRG_DATA_DEFAULT_SELECTION,r.FilterDialogValueFactory.createSelectionFromFilter(this._FFDimension,this._FFDimension.getFilter()));s.getProgramStartData().putXObject(r.FilterDialog.PRG_DATA_LISTENER_CLOSE,{onFilterDialogOk:function(e){t(e)},onFilterDialogCancel:function(){t(null)}});s.getProgramStartData().putXObject(r.FilterDialog.PRG_DATA_LISTENER_BEFORE_FILTER_CHANGE,{onBeforeChange:function(e){i=e.getDisplayInfo()}});s.runProgram()})).then(e=>{let n=t._FFDimension.getFilter();if(i){this.FilterDisplayType=this._getDisplayType(i);if(n){n.getUiSettings(r.QContextType.SELECTOR).setDisplayInfo(i)}}if(e){this._createMemberFilter();this._DataProvider._triggerDataProviderPropertyUpdate()}return!!e})};return c});
//# sourceMappingURL=Dimension.js.map